created virtual environment CPython3.10.2.final.0-64 in 4771ms
  creator CPython3Posix(dest=/localscratch/nike.35632568.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==22.3.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages (22.3.1)
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pip-23.0+computecanada-py3-none-any.whl
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 22.3.1
    Uninstalling pip-22.3.1:
      Successfully uninstalled pip-22.3.1
Successfully installed pip-23.0+computecanada
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.117616814261       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344729        1
[INPUT] 0    0    [1    /1   ]  7331.80217347        1
[INPUT] 0    0    [1    /1   ]  18377.1612185        1
[INPUT] 0    0    [1    /1   ]  1238.97777271        1
[INPUT] 0    0    [1    /1   ]  298.19001594         1
[INPUT] 0    0    [1    /1   ]  88.430468748         1
[INPUT] 0    0    [1    /1   ]  30.6766811731        1
[INPUT] 0    0    [1    /1   ]  4.68345183319        1
[INPUT] 0    0    [1    /1   ]  0.391016069798       1
[INPUT] 1    0    [1    /1   ]  8.59887874794        1
[INPUT] 1    0    [1    /1   ]  0.491051094612       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.11761681426064924, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032462, 1.0]], [0, [294042.0356516231, 1.0]], [0, [147021.01782581155, 1.0]], [0, [73510.50797603294, 1.0]], [0, [36755.23447294975, 1.0]], [0, [7331.802173469562, 1.0]], [0, [18377.16121851008, 1.0]], [0, [1238.9777727143498, 1.0]], [0, [298.1900159401028, 1.0]], [0, [88.4304687480197, 1.0]], [0, [30.676681173089506, 1.0]], [0, [4.683451833188093, 1.0]], [0, [0.39101606979807535, 1.0]], [1, [8.598878747938661, 1.0]], [1, [0.4910510946122354, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.11761681]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782581]
bas 5, expnt(s) = [73510.50797603]
bas 6, expnt(s) = [36755.23447295]
bas 7, expnt(s) = [7331.80217347]
bas 8, expnt(s) = [18377.16121851]
bas 9, expnt(s) = [1238.97777271]
bas 10, expnt(s) = [298.19001594]
bas 11, expnt(s) = [88.43046875]
bas 12, expnt(s) = [30.67668117]
bas 13, expnt(s) = [4.68345183]
bas 14, expnt(s) = [0.39101607]
bas 15, expnt(s) = [8.59887875]
bas 16, expnt(s) = [0.49105109]
CPU time:         1.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e-01 5.07419418e-01 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180217e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609565e+02
 2.98190016e+02 1.81294591e+02 8.84304687e+01 7.28561923e+01
 3.06766812e+01 3.29322424e+01 4.68345183e+00 8.04339817e+00
 3.91016070e-01 1.24928343e+00 8.59887875e+00 4.29572700e+01
 4.91051095e-01 1.19920311e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.327872465998176
cond(S) = 12522.397246743094
E1 = -688.6149226221195  E_coul = 184.54341220305562
init E= -504.071510419064
    CPU time for initialize scf      4.73 sec, wall time      0.53 sec
  HOMO = -0.690012669665346  LUMO = 0.134423106069614
  mo_energy =
[-1.21721227e+02 -1.33285864e+01 -7.65369679e+00 -7.65369679e+00
 -7.65369679e+00 -1.65467135e+00 -6.90012670e-01 -6.90012670e-01
 -6.90012670e-01  1.34423106e-01  5.81803648e+01  4.34033681e+02
  2.20187767e+03  1.13822503e+04  4.09766717e+04  1.09833147e+05
  2.54034506e+05  5.48465749e+05  1.15241461e+06  2.43019825e+06
  5.37493401e+06]
E1 = -706.5788307933816  E_coul = 198.82901549536555
cycle= 1 E= -507.749815298016  delta_E= -3.68  |g|= 0.377  |ddm|= 0.529
    CPU time for cycle= 1      0.27 sec, wall time      0.28 sec
diis-norm(errvec)=0.565953
diis-c [-0.32030234  1.        ]
  HOMO = -0.238250040594357  LUMO = 0.398664489844478
  mo_energy =
[-1.20306365e+02 -1.22806503e+01 -6.66439019e+00 -6.66439019e+00
 -6.66439019e+00 -1.16901551e+00 -2.38250041e-01 -2.38250041e-01
 -2.38250041e-01  3.98664490e-01  5.94873994e+01  4.35435952e+02
  2.20320857e+03  1.13834467e+04  4.09777931e+04  1.09834228e+05
  2.54035560e+05  5.48466782e+05  1.15241563e+06  2.43019926e+06
  5.37493501e+06]
E1 = -706.1175711231749  E_coul = 198.3595293577456
cycle= 2 E= -507.758041765429  delta_E= -0.00823  |g|= 0.0254  |ddm|= 0.376
    CPU time for cycle= 2      0.09 sec, wall time      0.09 sec
diis-norm(errvec)=0.020986
diis-c [-4.40053671e-04 -1.06253763e-03  1.00106254e+00]
  HOMO = -0.250802909200391  LUMO = 0.397739121792103
  mo_energy =
[-1.20359105e+02 -1.23129173e+01 -6.69929380e+00 -6.69929380e+00
 -6.69929380e+00 -1.17729129e+00 -2.50802909e-01 -2.50802909e-01
 -2.50802909e-01  3.97739122e-01  5.94486784e+01  4.35382698e+02
  2.20314574e+03  1.13833774e+04  4.09777216e+04  1.09834156e+05
  2.54035487e+05  5.48466709e+05  1.15241556e+06  2.43019918e+06
  5.37493494e+06]
E1 = -706.0409038669445  E_coul = 198.2826342574274
cycle= 3 E= -507.758269609517  delta_E= -0.000228  |g|= 0.0043  |ddm|= 0.064
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00345431
diis-c [-1.52134412e-06 -1.97614652e-04 -1.81585202e-01  1.18178282e+00]
  HOMO = -0.253514717330113  LUMO = 0.397377313614249
  mo_energy =
[-1.20367497e+02 -1.23194916e+01 -6.70612025e+00 -6.70612025e+00
 -6.70612025e+00 -1.17896705e+00 -2.53514717e-01 -2.53514717e-01
 -2.53514717e-01  3.97377314e-01  5.94414114e+01  4.35374317e+02
  2.20313680e+03  1.13833681e+04  4.09777122e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.025202308832  E_coul = 198.26692562384804
cycle= 4 E= -507.758276684984  delta_E= -7.08e-06  |g|= 0.000101  |ddm|= 0.013
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.71537e-05
diis-c [-7.36909546e-11 -7.45273746e-06  6.77084256e-03 -6.24171972e-02
  1.05565381e+00]
  HOMO = -0.253581687240604  LUMO = 0.397362434999401
  mo_energy =
[-1.20367644e+02 -1.23196452e+01 -6.70627203e+00 -6.70627203e+00
 -6.70627203e+00 -1.17900380e+00 -2.53581687e-01 -2.53581687e-01
 -2.53581687e-01  3.97362435e-01  5.94412565e+01  4.35374170e+02
  2.20313666e+03  1.13833680e+04  4.09777121e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.0248503257127  E_coul = 198.2665736372114
cycle= 5 E= -507.758276688501  delta_E= -3.52e-09  |g|= 1.97e-07  |ddm|= 0.000296
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.70575e-07
diis-c [-2.88061453e-15  1.49585369e-07 -8.34490119e-05  7.11409735e-04
 -9.90522243e-03  1.00927711e+00]
  HOMO = -0.253581455068119  LUMO = 0.397362622289336
  mo_energy =
[-1.20367644e+02 -1.23196447e+01 -6.70627157e+00 -6.70627157e+00
 -6.70627157e+00 -1.17900379e+00 -2.53581455e-01 -2.53581455e-01
 -2.53581455e-01  3.97362622e-01  5.94412570e+01  4.35374170e+02
  2.20313666e+03  1.13833680e+04  4.09777121e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.0248506115396  E_coul = 198.2665739230378
cycle= 6 E= -507.758276688502  delta_E= -5.12e-13  |g|= 5.58e-09  |ddm|= 2.6e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.0248506115396  E_coul = 198.2665739230378
  HOMO = -0.253581454880492  LUMO = 0.397362619541485
  mo_energy =
[-1.20367644e+02 -1.23196448e+01 -6.70627157e+00 -6.70627157e+00
 -6.70627157e+00 -1.17900379e+00 -2.53581455e-01 -2.53581455e-01
 -2.53581455e-01  3.97362620e-01  5.94412570e+01  4.35374170e+02
  2.20313666e+03  1.13833680e+04  4.09777121e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.0248506293317  E_coul = 198.26657394083003
Extra cycle  E= -507.758276688502  delta_E= 1.14e-13  |g|= 1.6e-09  |ddm|= 1.46e-08
    CPU time for scf_cycle      5.16 sec, wall time      0.97 sec
exp = [1.17616814e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180217e+03
 1.83771612e+04 1.23897777e+03 2.98190016e+02 8.84304687e+01
 3.06766812e+01 4.68345183e+00 3.91016070e-01 8.59887875e+00
 4.91051095e-01]
E = -507.75827668850167
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.117616814261       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344729        1
[INPUT] 0    0    [1    /1   ]  7331.80217347        1
[INPUT] 0    0    [1    /1   ]  18377.1612185        1
[INPUT] 0    0    [1    /1   ]  1238.97777271        1
[INPUT] 0    0    [1    /1   ]  298.19001594         1
[INPUT] 0    0    [1    /1   ]  88.430468748         1
[INPUT] 0    0    [1    /1   ]  30.6766811731        1
[INPUT] 0    0    [1    /1   ]  4.68345183319        1
[INPUT] 0    0    [1    /1   ]  0.391016069798       1
[INPUT] 1    0    [1    /1   ]  8.59887874794        1
[INPUT] 1    0    [1    /1   ]  0.491051094612       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.11761681426064924, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032462, 1.0]], [0, [294042.0356516231, 1.0]], [0, [147021.01782581155, 1.0]], [0, [73510.50797603294, 1.0]], [0, [36755.23447294975, 1.0]], [0, [7331.802173469562, 1.0]], [0, [18377.16121851008, 1.0]], [0, [1238.9777727143498, 1.0]], [0, [298.1900159401028, 1.0]], [0, [88.4304687480197, 1.0]], [0, [30.676681173089506, 1.0]], [0, [4.683451833188093, 1.0]], [0, [0.39101606979807535, 1.0]], [1, [8.598878747938661, 1.0]], [1, [0.4910510946122354, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.11761681]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782581]
bas 5, expnt(s) = [73510.50797603]
bas 6, expnt(s) = [36755.23447295]
bas 7, expnt(s) = [7331.80217347]
bas 8, expnt(s) = [18377.16121851]
bas 9, expnt(s) = [1238.97777271]
bas 10, expnt(s) = [298.19001594]
bas 11, expnt(s) = [88.43046875]
bas 12, expnt(s) = [30.67668117]
bas 13, expnt(s) = [4.68345183]
bas 14, expnt(s) = [0.39101607]
bas 15, expnt(s) = [8.59887875]
bas 16, expnt(s) = [0.49105109]
CPU time:         6.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.17616814e-01 5.07419418e-01 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180217e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609565e+02
 2.98190016e+02 1.81294591e+02 8.84304687e+01 7.28561923e+01
 3.06766812e+01 3.29322424e+01 4.68345183e+00 8.04339817e+00
 3.91016070e-01 1.24928343e+00 8.59887875e+00 4.29572700e+01
 4.91051095e-01 1.19920311e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.327872465998176
cond(S) = 12522.397246743094
E1 = -688.6149226221195  E_coul = 184.54341220305562
init E= -504.071510419064
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.690012669665346  LUMO = 0.134423106069614
  mo_energy =
[-1.21721227e+02 -1.33285864e+01 -7.65369679e+00 -7.65369679e+00
 -7.65369679e+00 -1.65467135e+00 -6.90012670e-01 -6.90012670e-01
 -6.90012670e-01  1.34423106e-01  5.81803648e+01  4.34033681e+02
  2.20187767e+03  1.13822503e+04  4.09766717e+04  1.09833147e+05
  2.54034506e+05  5.48465749e+05  1.15241461e+06  2.43019825e+06
  5.37493401e+06]
E1 = -706.5788307933816  E_coul = 198.82901549536555
cycle= 1 E= -507.749815298016  delta_E= -3.68  |g|= 0.377  |ddm|= 0.529
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.565953
diis-c [-0.32030234  1.        ]
  HOMO = -0.238250040594357  LUMO = 0.398664489844478
  mo_energy =
[-1.20306365e+02 -1.22806503e+01 -6.66439019e+00 -6.66439019e+00
 -6.66439019e+00 -1.16901551e+00 -2.38250041e-01 -2.38250041e-01
 -2.38250041e-01  3.98664490e-01  5.94873994e+01  4.35435952e+02
  2.20320857e+03  1.13834467e+04  4.09777931e+04  1.09834228e+05
  2.54035560e+05  5.48466782e+05  1.15241563e+06  2.43019926e+06
  5.37493501e+06]
E1 = -706.1175711231749  E_coul = 198.3595293577456
cycle= 2 E= -507.758041765429  delta_E= -0.00823  |g|= 0.0254  |ddm|= 0.376
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.020986
diis-c [-4.40053671e-04 -1.06253763e-03  1.00106254e+00]
  HOMO = -0.250802909200391  LUMO = 0.397739121792103
  mo_energy =
[-1.20359105e+02 -1.23129173e+01 -6.69929380e+00 -6.69929380e+00
 -6.69929380e+00 -1.17729129e+00 -2.50802909e-01 -2.50802909e-01
 -2.50802909e-01  3.97739122e-01  5.94486784e+01  4.35382698e+02
  2.20314574e+03  1.13833774e+04  4.09777216e+04  1.09834156e+05
  2.54035487e+05  5.48466709e+05  1.15241556e+06  2.43019918e+06
  5.37493494e+06]
E1 = -706.0409038669445  E_coul = 198.2826342574274
cycle= 3 E= -507.758269609517  delta_E= -0.000228  |g|= 0.0043  |ddm|= 0.064
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.00345431
diis-c [-1.52134412e-06 -1.97614652e-04 -1.81585202e-01  1.18178282e+00]
  HOMO = -0.253514717330113  LUMO = 0.397377313614249
  mo_energy =
[-1.20367497e+02 -1.23194916e+01 -6.70612025e+00 -6.70612025e+00
 -6.70612025e+00 -1.17896705e+00 -2.53514717e-01 -2.53514717e-01
 -2.53514717e-01  3.97377314e-01  5.94414114e+01  4.35374317e+02
  2.20313680e+03  1.13833681e+04  4.09777122e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.025202308832  E_coul = 198.26692562384804
cycle= 4 E= -507.758276684984  delta_E= -7.08e-06  |g|= 0.000101  |ddm|= 0.013
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.71537e-05
diis-c [-7.36909546e-11 -7.45273746e-06  6.77084256e-03 -6.24171972e-02
  1.05565381e+00]
  HOMO = -0.253581687240604  LUMO = 0.397362434999401
  mo_energy =
[-1.20367644e+02 -1.23196452e+01 -6.70627203e+00 -6.70627203e+00
 -6.70627203e+00 -1.17900380e+00 -2.53581687e-01 -2.53581687e-01
 -2.53581687e-01  3.97362435e-01  5.94412565e+01  4.35374170e+02
  2.20313666e+03  1.13833680e+04  4.09777121e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.0248503257127  E_coul = 198.2665736372114
cycle= 5 E= -507.758276688501  delta_E= -3.52e-09  |g|= 1.97e-07  |ddm|= 0.000296
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.70575e-07
diis-c [-2.88061453e-15  1.49585369e-07 -8.34490119e-05  7.11409735e-04
 -9.90522243e-03  1.00927711e+00]
  HOMO = -0.253581455068119  LUMO = 0.397362622289336
  mo_energy =
[-1.20367644e+02 -1.23196447e+01 -6.70627157e+00 -6.70627157e+00
 -6.70627157e+00 -1.17900379e+00 -2.53581455e-01 -2.53581455e-01
 -2.53581455e-01  3.97362622e-01  5.94412570e+01  4.35374170e+02
  2.20313666e+03  1.13833680e+04  4.09777121e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.0248506115396  E_coul = 198.2665739230378
cycle= 6 E= -507.758276688502  delta_E= -5.12e-13  |g|= 5.58e-09  |ddm|= 2.6e-07
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.0248506115396  E_coul = 198.2665739230378
  HOMO = -0.253581454880492  LUMO = 0.397362619541485
  mo_energy =
[-1.20367644e+02 -1.23196448e+01 -6.70627157e+00 -6.70627157e+00
 -6.70627157e+00 -1.17900379e+00 -2.53581455e-01 -2.53581455e-01
 -2.53581455e-01  3.97362620e-01  5.94412570e+01  4.35374170e+02
  2.20313666e+03  1.13833680e+04  4.09777121e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.0248506293317  E_coul = 198.26657394083003
Extra cycle  E= -507.758276688502  delta_E= 1.14e-13  |g|= 1.6e-09  |ddm|= 1.46e-08
    CPU time for scf_cycle      5.04 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12522.397246743094
E1 = -706.0248506293317  E_coul = 198.26657394083003
init E= -507.758276688502
    CPU time for initialize scf     10.27 sec, wall time      0.85 sec
  HOMO = -0.253581454344942  LUMO = 0.397362619880598
  mo_energy =
[-1.20367644e+02 -1.23196447e+01 -6.70627157e+00 -6.70627157e+00
 -6.70627157e+00 -1.17900379e+00 -2.53581454e-01 -2.53581454e-01
 -2.53581454e-01  3.97362620e-01  5.94412570e+01  4.35374170e+02
  2.20313666e+03  1.13833680e+04  4.09777121e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.0248506320847  E_coul = 198.2665739435835
cycle= 1 E= -507.758276688501  delta_E= 3.98e-13  |g|= 2.1e-09  |ddm|= 2.22e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.0248506320847  E_coul = 198.2665739435835
  HOMO = -0.253581454265641  LUMO = 0.397362619618948
  mo_energy =
[-1.20367644e+02 -1.23196447e+01 -6.70627156e+00 -6.70627156e+00
 -6.70627156e+00 -1.17900379e+00 -2.53581454e-01 -2.53581454e-01
 -2.53581454e-01  3.97362620e-01  5.94412570e+01  4.35374170e+02
  2.20313666e+03  1.13833680e+04  4.09777121e+04  1.09834146e+05
  2.54035477e+05  5.48466700e+05  1.15241555e+06  2.43019917e+06
  5.37493493e+06]
E1 = -706.0248506333404  E_coul = 198.2665739448391
Extra cycle  E= -507.758276688501  delta_E=    0  |g|= 1.3e-09  |ddm|= 1.07e-09
    CPU time for scf_cycle     11.33 sec, wall time      1.79 sec
exp = [1.17616814e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180217e+03
 1.83771612e+04 1.23897777e+03 2.98190016e+02 8.84304687e+01
 3.06766812e+01 4.68345183e+00 3.91016070e-01 8.59887875e+00
 4.91051095e-01]
grad_E = [-1.15174902e-01 -1.89165545e-11  4.16114882e-10  1.39835571e-09
  8.20865921e-09  2.70537518e-08  1.64749761e-07  9.02504803e-06
  4.08234344e-07  3.97771486e-06 -1.04513466e-05  9.18130985e-05
 -2.00625748e-04 -3.58752346e-02 -3.81238525e-01 -5.21915347e-03
 -8.26553225e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232791715984       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344728        1
[INPUT] 0    0    [1    /1   ]  7331.80216444        1
[INPUT] 0    0    [1    /1   ]  18377.1612181        1
[INPUT] 0    0    [1    /1   ]  1238.97776874        1
[INPUT] 0    0    [1    /1   ]  298.190026391        1
[INPUT] 0    0    [1    /1   ]  88.4303769349        1
[INPUT] 0    0    [1    /1   ]  30.6768817988        1
[INPUT] 0    0    [1    /1   ]  4.71932706776        1
[INPUT] 0    0    [1    /1   ]  0.772254594462       1
[INPUT] 1    0    [1    /1   ]  8.60409790141        1
[INPUT] 1    0    [1    /1   ]  0.573706417066       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.23279171598399023, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032457, 1.0]], [0, [294042.0356516217, 1.0]], [0, [147021.01782580334, 1.0]], [0, [73510.50797600589, 1.0]], [0, [36755.234472785, 1.0]], [0, [7331.802164444514, 1.0]], [0, [18377.161218101843, 1.0]], [0, [1238.977768736635, 1.0]], [0, [298.1900263914494, 1.0]], [0, [88.43037693492118, 1.0]], [0, [30.676881798837506, 1.0]], [0, [4.719327067761783, 1.0]], [0, [0.7722545944615202, 1.0]], [1, [8.604097901411718, 1.0]], [1, [0.5737064170655554, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23279172]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.0178258]
bas 5, expnt(s) = [73510.50797601]
bas 6, expnt(s) = [36755.23447278]
bas 7, expnt(s) = [7331.80216444]
bas 8, expnt(s) = [18377.1612181]
bas 9, expnt(s) = [1238.97776874]
bas 10, expnt(s) = [298.19002639]
bas 11, expnt(s) = [88.43037693]
bas 12, expnt(s) = [30.6768818]
bas 13, expnt(s) = [4.71932707]
bas 14, expnt(s) = [0.77225459]
bas 15, expnt(s) = [8.6040979]
bas 16, expnt(s) = [0.57370642]
CPU time:        28.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32791716e-01 8.46721652e-01 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180216e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609564e+02
 2.98190026e+02 1.81294596e+02 8.84303769e+01 7.28561355e+01
 3.06768818e+01 3.29324040e+01 4.71932707e+00 8.08956338e+00
 7.72254594e-01 2.08130343e+00 8.60409790e+00 4.29898641e+01
 5.73706417e-01 1.45662087e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.175282808031685
cond(S) = 12522.975331174808
E1 = -691.1558239532494  E_coul = 186.95317154996874
init E= -504.202652403281
    CPU time for initialize scf      4.55 sec, wall time      0.35 sec
  HOMO = -0.583765777089564  LUMO = 0.870331240879822
  mo_energy =
[-1.21503717e+02 -1.31362708e+01 -7.50901810e+00 -7.50901810e+00
 -7.50901810e+00 -1.60038063e+00 -5.83765777e-01 -5.83765777e-01
 -5.83765777e-01  8.70331241e-01  6.06522539e+01  4.35953057e+02
  2.20349504e+03  1.13836423e+04  4.09779654e+04  1.09834392e+05
  2.54035718e+05  5.48466932e+05  1.15241577e+06  2.43019938e+06
  5.37493511e+06]
E1 = -710.9585709900119  E_coul = 203.31155333357466
cycle= 1 E= -507.647017656437  delta_E= -3.44  |g|= 0.495  |ddm|= 0.428
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.593428
diis-c [-0.35215635  1.        ]
  HOMO = -0.0247512569142334  LUMO = 1.40706041626852
  mo_energy =
[-1.19940126e+02 -1.19584759e+01 -6.39397793e+00 -6.39397793e+00
 -6.39397793e+00 -1.02597403e+00 -2.47512569e-02 -2.47512569e-02
 -2.47512569e-02  1.40706042e+00  6.20905810e+01  4.37502071e+02
  2.20497512e+03  1.13849882e+04  4.09792363e+04  1.09835623e+05
  2.54036921e+05  5.48468115e+05  1.15241694e+06  2.43020054e+06
  5.37493626e+06]
E1 = -709.6948931894528  E_coul = 202.0189032918832
cycle= 2 E= -507.67598989757  delta_E= -0.029  |g|= 0.041  |ddm|= 0.565
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0301864
diis-c [-9.11147313e-04  4.50672139e-04  9.99549328e-01]
  HOMO = -0.0598257133839124  LUMO = 1.39348257033732
  mo_energy =
[-1.20078622e+02 -1.20496404e+01 -6.49132458e+00 -6.49132458e+00
 -6.49132458e+00 -1.04670420e+00 -5.98257134e-02 -5.98257134e-02
 -5.98257134e-02  1.39348257e+00  6.19808141e+01  4.37362869e+02
  2.20481771e+03  1.13848189e+04  4.09790631e+04  1.09835448e+05
  2.54036746e+05  5.48467939e+05  1.15241676e+06  2.43020036e+06
  5.37493609e+06]
E1 = -709.5553592304123  E_coul = 201.8789973170075
cycle= 3 E= -507.676361913405  delta_E= -0.000372  |g|= 0.0048  |ddm|= 0.0625
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00353931
diis-c [-1.29584468e-06 -2.71327492e-04 -1.24636640e-01  1.12490797e+00]
  HOMO = -0.0643677653758449  LUMO = 1.39138592191759
  mo_energy =
[-1.20094083e+02 -1.20611967e+01 -6.50336180e+00 -6.50336180e+00
 -6.50336180e+00 -1.04913263e+00 -6.43677654e-02 -6.43677654e-02
 -6.43677654e-02  1.39138592e+00  6.19676550e+01  4.37347433e+02
  2.20480113e+03  1.13848016e+04  4.09790456e+04  1.09835431e+05
  2.54036728e+05  5.48467921e+05  1.15241674e+06  2.43020034e+06
  5.37493607e+06]
E1 = -709.5372428817345  E_coul = 201.86087576110444
cycle= 4 E= -507.67636712063  delta_E= -5.21e-06  |g|= 5.19e-05  |ddm|= 0.00815
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.51882e-05
diis-c [-7.57350111e-11 -5.12843532e-06  5.58412609e-03 -5.37775132e-02
  1.04819852e+00]
  HOMO = -0.0643880548056603  LUMO = 1.39137084203145
  mo_energy =
[-1.20094076e+02 -1.20612389e+01 -6.50339256e+00 -6.50339256e+00
 -6.50339256e+00 -1.04913912e+00 -6.43880548e-02 -6.43880548e-02
 -6.43880548e-02  1.39137084e+00  6.19676366e+01  4.37347440e+02
  2.20480116e+03  1.13848017e+04  4.09790456e+04  1.09835431e+05
  2.54036728e+05  5.48467921e+05  1.15241674e+06  2.43020034e+06
  5.37493607e+06]
E1 = -709.5371580893612  E_coul = 201.86079096850813
cycle= 5 E= -507.676367120853  delta_E= -2.23e-10  |g|= 6.08e-07  |ddm|= 4.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -709.5371580893612  E_coul = 201.86079096850813
  HOMO = -0.0643876376463813  LUMO = 1.39137123693211
  mo_energy =
[-1.20094074e+02 -1.20612378e+01 -6.50339139e+00 -6.50339139e+00
 -6.50339139e+00 -1.04913906e+00 -6.43876376e-02 -6.43876376e-02
 -6.43876376e-02  1.39137124e+00  6.19676379e+01  4.37347442e+02
  2.20480116e+03  1.13848017e+04  4.09790456e+04  1.09835431e+05
  2.54036728e+05  5.48467921e+05  1.15241674e+06  2.43020034e+06
  5.37493607e+06]
E1 = -709.5371596918286  E_coul = 201.86079257097532
Extra cycle  E= -507.676367120853  delta_E= -1.71e-13  |g|= 5.27e-08  |ddm|= 7.38e-07
    CPU time for scf_cycle      4.63 sec, wall time      0.41 sec
exp = [2.32791716e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180216e+03
 1.83771612e+04 1.23897777e+03 2.98190026e+02 8.84303769e+01
 3.06768818e+01 4.71932707e+00 7.72254594e-01 8.60409790e+00
 5.73706417e-01]
E = -507.6763671208533
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.156235030218       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344729        1
[INPUT] 0    0    [1    /1   ]  7331.80217044        1
[INPUT] 0    0    [1    /1   ]  18377.1612184        1
[INPUT] 0    0    [1    /1   ]  1238.97777138        1
[INPUT] 0    0    [1    /1   ]  298.190019444        1
[INPUT] 0    0    [1    /1   ]  88.430437963         1
[INPUT] 0    0    [1    /1   ]  30.676748443         1
[INPUT] 0    0    [1    /1   ]  4.69548082158        1
[INPUT] 0    0    [1    /1   ]  0.51884558349        1
[INPUT] 1    0    [1    /1   ]  8.60062873333        1
[INPUT] 1    0    [1    /1   ]  0.518765475478       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.15623503021826876, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032461, 1.0]], [0, [294042.03565162263, 1.0]], [0, [147021.01782580878, 1.0]], [0, [73510.50797602387, 1.0]], [0, [36755.23447289451, 1.0]], [0, [7331.802170443458, 1.0]], [0, [18377.161218373196, 1.0]], [0, [1238.9777713806195, 1.0]], [0, [298.1900194444458, 1.0]], [0, [88.43043796303085, 1.0]], [0, [30.6767484430272, 1.0]], [0, [4.695480821583716, 1.0]], [0, [0.5188455834900632, 1.0]], [1, [8.600628733334114, 1.0]], [1, [0.5187654754780981, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.15623503]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782581]
bas 5, expnt(s) = [73510.50797602]
bas 6, expnt(s) = [36755.23447289]
bas 7, expnt(s) = [7331.80217044]
bas 8, expnt(s) = [18377.16121837]
bas 9, expnt(s) = [1238.97777138]
bas 10, expnt(s) = [298.19001944]
bas 11, expnt(s) = [88.43043796]
bas 12, expnt(s) = [30.67674844]
bas 13, expnt(s) = [4.69548082]
bas 14, expnt(s) = [0.51884558]
bas 15, expnt(s) = [8.60062873]
bas 16, expnt(s) = [0.51876548]
CPU time:        32.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.56235030e-01 6.27839790e-01 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180217e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609565e+02
 2.98190019e+02 1.81294593e+02 8.84304380e+01 7.28561732e+01
 3.06767484e+01 3.29322966e+01 4.69548082e+00 8.05888721e+00
 5.18845583e-01 1.54452029e+00 8.60062873e+00 4.29681983e+01
 5.18765475e-01 1.28439387e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.289430080543273
cond(S) = 12522.57725590891
E1 = -690.1610417065363  E_coul = 185.9067136207451
init E= -504.254328085791
    CPU time for initialize scf      4.41 sec, wall time      0.33 sec
  HOMO = -0.641215645347323  LUMO = 0.319360597045052
  mo_energy =
[-1.21603696e+02 -1.32233944e+01 -7.56093311e+00 -7.56093311e+00
 -7.56093311e+00 -1.63239210e+00 -6.41215645e-01 -6.41215645e-01
 -6.41215645e-01  3.19360597e-01  5.90342031e+01  4.34699836e+02
  2.20244585e+03  1.13827458e+04  4.09771354e+04  1.09833595e+05
  2.54034943e+05  5.48466177e+05  1.15241503e+06  2.43019866e+06
  5.37493441e+06]
E1 = -708.6868072917931  E_coul = 200.9393415008835
cycle= 1 E= -507.74746579091  delta_E= -3.49  |g|= 0.415  |ddm|= 0.449
    CPU time for cycle= 1      0.21 sec, wall time      0.02 sec
diis-norm(errvec)=0.578509
diis-c [-0.3346725  1.       ]
  HOMO = -0.156036560491459  LUMO = 0.667329322940298
  mo_energy =
[-1.20126352e+02 -1.21296108e+01 -6.52565784e+00 -6.52565784e+00
 -6.52565784e+00 -1.11059312e+00 -1.56036560e-01 -1.56036560e-01
 -1.56036560e-01  6.67329323e-01  6.03894696e+01  4.36164005e+02
  2.20384324e+03  1.13840112e+04  4.09783268e+04  1.09834747e+05
  2.54036068e+05  5.48467281e+05  1.15241612e+06  2.43019974e+06
  5.37493549e+06]
E1 = -707.8137662111368  E_coul = 200.04893172842864
cycle= 2 E= -507.764834482708  delta_E= -0.0174  |g|= 0.0349  |ddm|=  0.5
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0274091
diis-c [-7.50522591e-04 -1.48685092e-03  1.00148685e+00]
  HOMO = -0.180830905866375  LUMO = 0.662888370212693
  mo_energy =
[-1.20220216e+02 -1.21921348e+01 -6.59233966e+00 -6.59233966e+00
 -6.59233966e+00 -1.12691775e+00 -1.80830906e-01 -1.80830906e-01
 -1.80830906e-01  6.62888370e-01  6.03157625e+01  4.36069549e+02
  2.20373567e+03  1.13838950e+04  4.09782076e+04  1.09834626e+05
  2.54035947e+05  5.48467160e+05  1.15241600e+06  2.43019962e+06
  5.37493536e+06]
E1 = -707.6834489396066  E_coul = 199.91823453043904
cycle= 3 E= -507.765214409168  delta_E= -0.00038  |g|= 0.00516  |ddm|= 0.0716
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0040118
diis-c [-1.39641780e-06 -2.30531051e-04 -1.62304035e-01  1.16253457e+00]
  HOMO = -0.185324254038265  LUMO = 0.661771717986808
  mo_energy =
[-1.20234324e+02 -1.22031054e+01 -6.60372753e+00 -6.60372753e+00
 -6.60372753e+00 -1.12963832e+00 -1.85324254e-01 -1.85324254e-01
 -1.85324254e-01  6.61771718e-01  6.03035471e+01  4.36055457e+02
  2.20372065e+03  1.13838794e+04  4.09781918e+04  1.09834610e+05
  2.54035931e+05  5.48467144e+05  1.15241598e+06  2.43019960e+06
  5.37493535e+06]
E1 = -707.6609751148706  E_coul = 199.89575208929628
cycle= 4 E= -507.765223025574  delta_E= -8.62e-06  |g|= 5.86e-05  |ddm|= 0.0123
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.82583e-05
diis-c [-6.98084992e-11 -6.99971191e-06  6.18076027e-03 -5.10715987e-02
  1.04489784e+00]
  HOMO = -0.18536933353312  LUMO = 0.661752131202826
  mo_energy =
[-1.20234399e+02 -1.22032064e+01 -6.60382240e+00 -6.60382240e+00
 -6.60382240e+00 -1.12965885e+00 -1.85369334e-01 -1.85369334e-01
 -1.85369334e-01  6.61752131e-01  6.03034554e+01  4.36055382e+02
  2.20372058e+03  1.13838793e+04  4.09781918e+04  1.09834610e+05
  2.54035931e+05  5.48467144e+05  1.15241598e+06  2.43019960e+06
  5.37493535e+06]
E1 = -707.6607780117741  E_coul = 199.8955549854613
cycle= 5 E= -507.765223026313  delta_E= -7.39e-10  |g|= 3.4e-07  |ddm|= 0.00011
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -707.6607780117741  E_coul = 199.8955549854613
  HOMO = -0.185368949544702  LUMO = 0.661752477756129
  mo_energy =
[-1.20234398e+02 -1.22032055e+01 -6.60382148e+00 -6.60382148e+00
 -6.60382148e+00 -1.12965883e+00 -1.85368950e-01 -1.85368950e-01
 -1.85368950e-01  6.61752478e-01  6.03034563e+01  4.36055383e+02
  2.20372058e+03  1.13838793e+04  4.09781918e+04  1.09834610e+05
  2.54035931e+05  5.48467144e+05  1.15241598e+06  2.43019960e+06
  5.37493535e+06]
E1 = -707.6607788781603  E_coul = 199.89555585184726
Extra cycle  E= -507.765223026313  delta_E= -2.27e-13  |g|= 3.46e-08  |ddm|= 4.9e-07
    CPU time for scf_cycle      4.68 sec, wall time      0.41 sec
exp = [1.56235030e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180217e+03
 1.83771612e+04 1.23897777e+03 2.98190019e+02 8.84304380e+01
 3.06767484e+01 4.69548082e+00 5.18845583e-01 8.60062873e+00
 5.18765475e-01]
E = -507.76522302631304
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.156235030218       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344729        1
[INPUT] 0    0    [1    /1   ]  7331.80217044        1
[INPUT] 0    0    [1    /1   ]  18377.1612184        1
[INPUT] 0    0    [1    /1   ]  1238.97777138        1
[INPUT] 0    0    [1    /1   ]  298.190019444        1
[INPUT] 0    0    [1    /1   ]  88.430437963         1
[INPUT] 0    0    [1    /1   ]  30.676748443         1
[INPUT] 0    0    [1    /1   ]  4.69548082158        1
[INPUT] 0    0    [1    /1   ]  0.51884558349        1
[INPUT] 1    0    [1    /1   ]  8.60062873333        1
[INPUT] 1    0    [1    /1   ]  0.518765475478       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.15623503021826876, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032461, 1.0]], [0, [294042.03565162263, 1.0]], [0, [147021.01782580878, 1.0]], [0, [73510.50797602387, 1.0]], [0, [36755.23447289451, 1.0]], [0, [7331.802170443458, 1.0]], [0, [18377.161218373196, 1.0]], [0, [1238.9777713806195, 1.0]], [0, [298.1900194444458, 1.0]], [0, [88.43043796303085, 1.0]], [0, [30.6767484430272, 1.0]], [0, [4.695480821583716, 1.0]], [0, [0.5188455834900632, 1.0]], [1, [8.600628733334114, 1.0]], [1, [0.5187654754780981, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.15623503]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782581]
bas 5, expnt(s) = [73510.50797602]
bas 6, expnt(s) = [36755.23447289]
bas 7, expnt(s) = [7331.80217044]
bas 8, expnt(s) = [18377.16121837]
bas 9, expnt(s) = [1238.97777138]
bas 10, expnt(s) = [298.19001944]
bas 11, expnt(s) = [88.43043796]
bas 12, expnt(s) = [30.67674844]
bas 13, expnt(s) = [4.69548082]
bas 14, expnt(s) = [0.51884558]
bas 15, expnt(s) = [8.60062873]
bas 16, expnt(s) = [0.51876548]
CPU time:        37.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.56235030e-01 6.27839790e-01 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180217e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609565e+02
 2.98190019e+02 1.81294593e+02 8.84304380e+01 7.28561732e+01
 3.06767484e+01 3.29322966e+01 4.69548082e+00 8.05888721e+00
 5.18845583e-01 1.54452029e+00 8.60062873e+00 4.29681983e+01
 5.18765475e-01 1.28439387e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.289430080543273
cond(S) = 12522.57725590891
E1 = -690.1610417065363  E_coul = 185.9067136207451
init E= -504.254328085791
    CPU time for initialize scf      4.53 sec, wall time      0.34 sec
  HOMO = -0.641215645347323  LUMO = 0.319360597045052
  mo_energy =
[-1.21603696e+02 -1.32233944e+01 -7.56093311e+00 -7.56093311e+00
 -7.56093311e+00 -1.63239210e+00 -6.41215645e-01 -6.41215645e-01
 -6.41215645e-01  3.19360597e-01  5.90342031e+01  4.34699836e+02
  2.20244585e+03  1.13827458e+04  4.09771354e+04  1.09833595e+05
  2.54034943e+05  5.48466177e+05  1.15241503e+06  2.43019866e+06
  5.37493441e+06]
E1 = -708.6868072917931  E_coul = 200.9393415008835
cycle= 1 E= -507.74746579091  delta_E= -3.49  |g|= 0.415  |ddm|= 0.449
    CPU time for cycle= 1      0.20 sec, wall time      0.02 sec
diis-norm(errvec)=0.578509
diis-c [-0.3346725  1.       ]
  HOMO = -0.156036560491459  LUMO = 0.667329322940298
  mo_energy =
[-1.20126352e+02 -1.21296108e+01 -6.52565784e+00 -6.52565784e+00
 -6.52565784e+00 -1.11059312e+00 -1.56036560e-01 -1.56036560e-01
 -1.56036560e-01  6.67329323e-01  6.03894696e+01  4.36164005e+02
  2.20384324e+03  1.13840112e+04  4.09783268e+04  1.09834747e+05
  2.54036068e+05  5.48467281e+05  1.15241612e+06  2.43019974e+06
  5.37493549e+06]
E1 = -707.8137662111368  E_coul = 200.04893172842864
cycle= 2 E= -507.764834482708  delta_E= -0.0174  |g|= 0.0349  |ddm|=  0.5
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0274091
diis-c [-7.50522591e-04 -1.48685092e-03  1.00148685e+00]
  HOMO = -0.180830905866375  LUMO = 0.662888370212693
  mo_energy =
[-1.20220216e+02 -1.21921348e+01 -6.59233966e+00 -6.59233966e+00
 -6.59233966e+00 -1.12691775e+00 -1.80830906e-01 -1.80830906e-01
 -1.80830906e-01  6.62888370e-01  6.03157625e+01  4.36069549e+02
  2.20373567e+03  1.13838950e+04  4.09782076e+04  1.09834626e+05
  2.54035947e+05  5.48467160e+05  1.15241600e+06  2.43019962e+06
  5.37493536e+06]
E1 = -707.6834489396066  E_coul = 199.91823453043904
cycle= 3 E= -507.765214409168  delta_E= -0.00038  |g|= 0.00516  |ddm|= 0.0716
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0040118
diis-c [-1.39641780e-06 -2.30531051e-04 -1.62304035e-01  1.16253457e+00]
  HOMO = -0.185324254038265  LUMO = 0.661771717986808
  mo_energy =
[-1.20234324e+02 -1.22031054e+01 -6.60372753e+00 -6.60372753e+00
 -6.60372753e+00 -1.12963832e+00 -1.85324254e-01 -1.85324254e-01
 -1.85324254e-01  6.61771718e-01  6.03035471e+01  4.36055457e+02
  2.20372065e+03  1.13838794e+04  4.09781918e+04  1.09834610e+05
  2.54035931e+05  5.48467144e+05  1.15241598e+06  2.43019960e+06
  5.37493535e+06]
E1 = -707.6609751148706  E_coul = 199.89575208929628
cycle= 4 E= -507.765223025574  delta_E= -8.62e-06  |g|= 5.86e-05  |ddm|= 0.0123
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.82583e-05
diis-c [-6.98084992e-11 -6.99971191e-06  6.18076027e-03 -5.10715987e-02
  1.04489784e+00]
  HOMO = -0.18536933353312  LUMO = 0.661752131202826
  mo_energy =
[-1.20234399e+02 -1.22032064e+01 -6.60382240e+00 -6.60382240e+00
 -6.60382240e+00 -1.12965885e+00 -1.85369334e-01 -1.85369334e-01
 -1.85369334e-01  6.61752131e-01  6.03034554e+01  4.36055382e+02
  2.20372058e+03  1.13838793e+04  4.09781918e+04  1.09834610e+05
  2.54035931e+05  5.48467144e+05  1.15241598e+06  2.43019960e+06
  5.37493535e+06]
E1 = -707.6607780117741  E_coul = 199.8955549854613
cycle= 5 E= -507.765223026313  delta_E= -7.39e-10  |g|= 3.4e-07  |ddm|= 0.00011
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -707.6607780117741  E_coul = 199.8955549854613
  HOMO = -0.185368949544702  LUMO = 0.661752477756129
  mo_energy =
[-1.20234398e+02 -1.22032055e+01 -6.60382148e+00 -6.60382148e+00
 -6.60382148e+00 -1.12965883e+00 -1.85368950e-01 -1.85368950e-01
 -1.85368950e-01  6.61752478e-01  6.03034563e+01  4.36055383e+02
  2.20372058e+03  1.13838793e+04  4.09781918e+04  1.09834610e+05
  2.54035931e+05  5.48467144e+05  1.15241598e+06  2.43019960e+06
  5.37493535e+06]
E1 = -707.6607788781603  E_coul = 199.89555585184726
Extra cycle  E= -507.765223026313  delta_E= -2.27e-13  |g|= 3.46e-08  |ddm|= 4.9e-07
    CPU time for scf_cycle      4.80 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12522.57725590891
E1 = -707.6607788781603  E_coul = 199.89555585184726
init E= -507.765223026313
    CPU time for initialize scf     10.14 sec, wall time      0.68 sec
  HOMO = -0.185368923431591  LUMO = 0.661752484515751
  mo_energy =
[-1.20234398e+02 -1.22032054e+01 -6.60382142e+00 -6.60382142e+00
 -6.60382142e+00 -1.12965881e+00 -1.85368923e-01 -1.85368923e-01
 -1.85368923e-01  6.61752485e-01  6.03034564e+01  4.36055383e+02
  2.20372058e+03  1.13838793e+04  4.09781918e+04  1.09834610e+05
  2.54035931e+05  5.48467144e+05  1.15241598e+06  2.43019960e+06
  5.37493535e+06]
E1 = -707.6607790057411  E_coul = 199.89555597942837
cycle= 1 E= -507.765223026313  delta_E= 2.84e-13  |g|= 5.29e-09  |ddm|= 6.98e-08
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -707.6607790057411  E_coul = 199.89555597942837
  HOMO = -0.185368919587853  LUMO = 0.661752484778356
  mo_energy =
[-1.20234398e+02 -1.22032054e+01 -6.60382141e+00 -6.60382141e+00
 -6.60382141e+00 -1.12965881e+00 -1.85368920e-01 -1.85368920e-01
 -1.85368920e-01  6.61752485e-01  6.03034564e+01  4.36055383e+02
  2.20372058e+03  1.13838793e+04  4.09781918e+04  1.09834610e+05
  2.54035931e+05  5.48467144e+05  1.15241598e+06  2.43019960e+06
  5.37493535e+06]
E1 = -707.6607790287457  E_coul = 199.89555600243273
Extra cycle  E= -507.765223026313  delta_E= -1.71e-13  |g|= 1.3e-09  |ddm|= 1.25e-08
    CPU time for scf_cycle     10.33 sec, wall time      0.75 sec
exp = [1.56235030e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180217e+03
 1.83771612e+04 1.23897777e+03 2.98190019e+02 8.84304380e+01
 3.06767484e+01 4.69548082e+00 5.18845583e-01 8.60062873e+00
 5.18765475e-01]
grad_E = [-3.37873611e-01 -1.89731607e-11  4.15733764e-10  1.39690446e-09
  8.20142552e-09  2.70263740e-08  1.64605513e-07  9.01625736e-06
  4.07764866e-07  4.67836174e-06 -2.21853912e-05  1.93134237e-04
 -5.15264053e-04 -5.37340751e-02  8.88460542e-02 -3.09092710e-02
  9.54424555e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.755111889004       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.5079759        1
[INPUT] 0    0    [1    /1   ]  36755.2344723        1
[INPUT] 0    0    [1    /1   ]  7331.80213572        1
[INPUT] 0    0    [1    /1   ]  18377.1612168        1
[INPUT] 0    0    [1    /1   ]  1238.97775559        1
[INPUT] 0    0    [1    /1   ]  298.190067864        1
[INPUT] 0    0    [1    /1   ]  88.4300138402        1
[INPUT] 0    0    [1    /1   ]  30.6777404025        1
[INPUT] 0    0    [1    /1   ]  4.84600981067        1
[INPUT] 0    0    [1    /1   ]  1.65714014354        1
[INPUT] 1    0    [1    /1   ]  8.6386725426         1
[INPUT] 1    0    [1    /1   ]  0.111738490073       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.7551118890038064, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032444, 1.0]], [0, [294042.0356516173, 1.0]], [0, [147021.0178257772, 1.0]], [0, [73510.5079759198, 1.0]], [0, [36755.23447226068, 1.0]], [0, [7331.8021357224525, 1.0]], [0, [18377.161216802695, 1.0]], [0, [1238.9777555850599, 1.0]], [0, [298.19006786364446, 1.0]], [0, [88.43001384020525, 1.0]], [0, [30.677740402538355, 1.0]], [0, [4.84600981066702, 1.0]], [0, [1.6571401435353168, 1.0]], [1, [8.63867254259658, 1.0]], [1, [0.11173849007305575, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.75511189]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130324]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782578]
bas 5, expnt(s) = [73510.50797592]
bas 6, expnt(s) = [36755.23447226]
bas 7, expnt(s) = [7331.80213572]
bas 8, expnt(s) = [18377.1612168]
bas 9, expnt(s) = [1238.97775559]
bas 10, expnt(s) = [298.19006786]
bas 11, expnt(s) = [88.43001384]
bas 12, expnt(s) = [30.6777404]
bas 13, expnt(s) = [4.84600981]
bas 14, expnt(s) = [1.65714014]
bas 15, expnt(s) = [8.63867254]
bas 16, expnt(s) = [0.11173849]
CPU time:        55.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.55111889e-01 2.04655540e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180214e+03 2.00181102e+03
 1.83771612e+04 3.98771253e+03 1.23897776e+03 5.27609560e+02
 2.98190068e+02 1.81294615e+02 8.84300138e+01 7.28559112e+01
 3.06777404e+01 3.29330953e+01 4.84600981e+00 8.25188641e+00
 1.65714014e+00 3.69006871e+00 8.63867254e+00 4.32059101e+01
 1.11738490e-01 1.88468117e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 14.206763982089758
cond(S) = 12525.177757162495
E1 = -636.5724836736823  E_coul = 142.62345619183907
init E= -493.949027481843
    CPU time for initialize scf      4.78 sec, wall time      0.33 sec
  HOMO = -1.43439926385219  LUMO = 1.84267636362285
  mo_energy =
[-1.24934385e+02 -1.65314119e+01 -1.06636450e+01 -1.06636450e+01
 -1.06636450e+01 -3.94492591e+00 -1.43439926e+00 -1.43439926e+00
 -1.43439926e+00  1.84267636e+00  6.41114948e+01  4.37957590e+02
  2.20456063e+03  1.13839898e+04  4.09779976e+04  1.09834270e+05
  2.54035488e+05  5.48466609e+05  1.15241536e+06  2.43019888e+06
  5.37493453e+06]
E1 = -677.010418402354  E_coul = 173.06249564013106
cycle= 1 E= -503.947922762223  delta_E=  -10  |g|= 0.405  |ddm|= 6.44
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.579182
diis-c [-0.3354514  1.       ]
  HOMO = -0.505486073621321  LUMO = 3.63339250526185
  mo_energy =
[-1.22196650e+02 -1.42349042e+01 -8.37778467e+00 -8.37778467e+00
 -8.37778467e+00 -2.36347257e+00 -5.05486074e-01 -5.05486074e-01
 -5.05486074e-01  3.63339251e+00  6.66935242e+01  4.40678167e+02
  2.20723480e+03  1.13865412e+04  4.09804779e+04  1.09836712e+05
  2.54037903e+05  5.48469005e+05  1.15241774e+06  2.43020125e+06
  5.37493689e+06]
E1 = -676.670199634339  E_coul = 172.71774669335383
cycle= 2 E= -503.952452940985  delta_E= -0.00453  |g|= 0.0179  |ddm|= 0.45
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0129912
diis-c [-1.59262280e-04  5.29719418e-03  9.94702806e-01]
  HOMO = -0.50601536894473  LUMO = 3.62752547495082
  mo_energy =
[-1.22251042e+02 -1.42586741e+01 -8.40711696e+00 -8.40711696e+00
 -8.40711696e+00 -2.36733668e+00 -5.06015369e-01 -5.06015369e-01
 -5.06015369e-01  3.62752547e+00  6.66576110e+01  4.40623143e+02
  2.20716658e+03  1.13864642e+04  4.09803980e+04  1.09836631e+05
  2.54037821e+05  5.48468922e+05  1.15241766e+06  2.43020117e+06
  5.37493681e+06]
E1 = -676.6471055214798  E_coul = 172.6946295376233
cycle= 3 E= -503.952475983857  delta_E= -2.3e-05  |g|= 0.00143  |ddm|= 0.0378
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000742321
diis-c [-1.08851124e-07  2.52737018e-04 -5.01840787e-02  1.04993134e+00]
  HOMO = -0.506063979096518  LUMO = 3.62700676656281
  mo_energy =
[-1.22254656e+02 -1.42606455e+01 -8.40943068e+00 -8.40943068e+00
 -8.40943068e+00 -2.36767105e+00 -5.06063979e-01 -5.06063979e-01
 -5.06063979e-01  3.62700677e+00  6.66549401e+01  4.40619541e+02
  2.20716248e+03  1.13864598e+04  4.09803935e+04  1.09836627e+05
  2.54037817e+05  5.48468918e+05  1.15241765e+06  2.43020117e+06
  5.37493681e+06]
E1 = -676.6451086849885  E_coul = 172.6926325243596
cycle= 4 E= -503.952476160629  delta_E= -1.77e-07  |g|= 6.38e-05  |ddm|= 0.00353
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.04496e-05
diis-c [-2.27392465e-11 -3.12421193e-06  4.13990343e-03 -9.48096923e-02
  1.09067291e+00]
  HOMO = -0.506066222961386  LUMO = 3.62698437129521
  mo_energy =
[-1.22254782e+02 -1.42607290e+01 -8.40952322e+00 -8.40952322e+00
 -8.40952322e+00 -2.36768622e+00 -5.06066223e-01 -5.06066223e-01
 -5.06066223e-01  3.62698437e+00  6.66548395e+01  4.40619417e+02
  2.20716234e+03  1.13864596e+04  4.09803933e+04  1.09836626e+05
  2.54037816e+05  5.48468918e+05  1.15241765e+06  2.43020117e+06
  5.37493680e+06]
E1 = -676.6450222318269  E_coul = 172.69254607083698
cycle= 5 E= -503.95247616099  delta_E= -3.61e-10  |g|= 2.67e-07  |ddm|= 0.000166
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -676.6450222318269  E_coul = 172.69254607083698
  HOMO = -0.506066223675627  LUMO = 3.62698438260363
  mo_energy =
[-1.22254782e+02 -1.42607290e+01 -8.40952319e+00 -8.40952319e+00
 -8.40952319e+00 -2.36768623e+00 -5.06066224e-01 -5.06066224e-01
 -5.06066224e-01  3.62698438e+00  6.66548395e+01  4.40619417e+02
  2.20716234e+03  1.13864596e+04  4.09803933e+04  1.09836626e+05
  2.54037816e+05  5.48468918e+05  1.15241765e+06  2.43020117e+06
  5.37493680e+06]
E1 = -676.6450222423555  E_coul = 172.692546081365
Extra cycle  E= -503.95247616099  delta_E= -5.68e-13  |g|= 1.19e-08  |ddm|= 1.13e-07
    CPU time for scf_cycle      5.03 sec, wall time      0.40 sec
exp = [7.55111889e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180214e+03
 1.83771612e+04 1.23897776e+03 2.98190068e+02 8.84300138e+01
 3.06777404e+01 4.84600981e+00 1.65714014e+00 8.63867254e+00
 1.11738490e-01]
E = -503.9524761609905
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.216122716097       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344728        1
[INPUT] 0    0    [1    /1   ]  7331.80216697        1
[INPUT] 0    0    [1    /1   ]  18377.1612182        1
[INPUT] 0    0    [1    /1   ]  1238.9777698         1
[INPUT] 0    0    [1    /1   ]  298.190024286        1
[INPUT] 0    0    [1    /1   ]  88.4303955507        1
[INPUT] 0    0    [1    /1   ]  30.676847639         1
[INPUT] 0    0    [1    /1   ]  4.71053372049        1
[INPUT] 0    0    [1    /1   ]  0.632675039495       1
[INPUT] 1    0    [1    /1   ]  8.60443311426        1
[INPUT] 1    0    [1    /1   ]  0.478062776938       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.21612271609682254, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.071303246, 1.0]], [0, [294042.0356516221, 1.0]], [0, [147021.0178258056, 1.0]], [0, [73510.50797601347, 1.0]], [0, [36755.23447283113, 1.0]], [0, [7331.802166971357, 1.0]], [0, [18377.161218216144, 1.0]], [0, [1238.9777698010635, 1.0]], [0, [298.19002428636566, 1.0]], [0, [88.4303955507483, 1.0]], [0, [30.676847638978316, 1.0]], [0, [4.710533720492046, 1.0]], [0, [0.6326750394945886, 1.0]], [1, [8.604433114260361, 1.0]], [1, [0.4780627769375939, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21612272]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782581]
bas 5, expnt(s) = [73510.50797601]
bas 6, expnt(s) = [36755.23447283]
bas 7, expnt(s) = [7331.80216697]
bas 8, expnt(s) = [18377.16121822]
bas 9, expnt(s) = [1238.9777698]
bas 10, expnt(s) = [298.19002429]
bas 11, expnt(s) = [88.43039555]
bas 12, expnt(s) = [30.67684764]
bas 13, expnt(s) = [4.71053372]
bas 14, expnt(s) = [0.63267504]
bas 15, expnt(s) = [8.60443311]
bas 16, expnt(s) = [0.47806278]
CPU time:        60.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.16122716e-01 8.00830005e-01 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180217e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609565e+02
 2.98190024e+02 1.81294595e+02 8.84303956e+01 7.28561470e+01
 3.06768476e+01 3.29323765e+01 4.71053372e+00 8.07825600e+00
 6.32675039e-01 1.79225809e+00 8.60443311e+00 4.29919576e+01
 4.78062777e-01 1.15968638e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.347053817216445
cond(S) = 12522.786568578475
E1 = -688.7256066096325  E_coul = 184.61878241521046
init E= -504.106824194422
    CPU time for initialize scf      4.69 sec, wall time      0.33 sec
  HOMO = -0.691526380127917  LUMO = 0.611510211281799
  mo_energy =
[-1.21715296e+02 -1.33384639e+01 -7.63769557e+00 -7.63769557e+00
 -7.63769557e+00 -1.66516872e+00 -6.91526380e-01 -6.91526380e-01
 -6.91526380e-01  6.11510211e-01  5.97237121e+01  4.35191710e+02
  2.20283040e+03  1.13830505e+04  4.09774053e+04  1.09833848e+05
  2.54035184e+05  5.48466408e+05  1.15241525e+06  2.43019887e+06
  5.37493462e+06]
E1 = -706.638002936951  E_coul = 198.86940651864694
cycle= 1 E= -507.768596418304  delta_E= -3.66  |g|= 0.429  |ddm|= 0.45
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.572861
diis-c [-0.32816935  1.        ]
  HOMO = -0.251881735895702  LUMO = 1.00177811345248
  mo_energy =
[-1.20291795e+02 -1.22930287e+01 -6.64681348e+00 -6.64681348e+00
 -6.64681348e+00 -1.17678037e+00 -2.51881736e-01 -2.51881736e-01
 -2.51881736e-01  1.00177811e+00  6.10262027e+01  4.36601673e+02
  2.20417298e+03  1.13842607e+04  4.09785413e+04  1.09834944e+05
  2.54036253e+05  5.48467456e+05  1.15241629e+06  2.43019989e+06
  5.37493563e+06]
E1 = -705.6904851730874  E_coul = 197.90369173321628
cycle= 2 E= -507.786793439871  delta_E= -0.0182  |g|= 0.0342  |ddm|= 0.491
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0243488
diis-c [-5.91610197e-04  1.95334548e-03  9.98046655e-01]
  HOMO = -0.276137687834883  LUMO = 0.994079901222434
  mo_energy =
[-1.20396333e+02 -1.23613445e+01 -6.72046993e+00 -6.72046993e+00
 -6.72046993e+00 -1.19323337e+00 -2.76137688e-01 -2.76137688e-01
 -2.76137688e-01  9.94079901e-01  6.09443118e+01  4.36496522e+02
  2.20405324e+03  1.13841313e+04  4.09784087e+04  1.09834810e+05
  2.54036119e+05  5.48467321e+05  1.15241615e+06  2.43019976e+06
  5.37493550e+06]
E1 = -705.5728327824738  E_coul = 197.78574889396958
cycle= 3 E= -507.787083888504  delta_E= -0.00029  |g|= 0.00447  |ddm|= 0.0599
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.00313426
diis-c [-1.09690648e-06 -2.34056470e-04 -1.38151474e-01  1.13838553e+00]
  HOMO = -0.279807777450365  LUMO = 0.992668141843958
  mo_energy =
[-1.20409630e+02 -1.23713784e+01 -6.73099483e+00 -6.73099483e+00
 -6.73099483e+00 -1.19553053e+00 -2.79807777e-01 -2.79807777e-01
 -2.79807777e-01  9.92668142e-01  6.09329695e+01  4.36483243e+02
  2.20403898e+03  1.13841165e+04  4.09783937e+04  1.09834795e+05
  2.54036103e+05  5.48467306e+05  1.15241614e+06  2.43019974e+06
  5.37493548e+06]
E1 = -705.5553886532839  E_coul = 197.76829962307232
cycle= 4 E= -507.787089030212  delta_E= -5.14e-06  |g|= 5.9e-05  |ddm|= 0.00887
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.48224e-05
diis-c [-6.16172655e-11 -6.11149916e-06  5.85422072e-03 -5.54166884e-02
  1.04956858e+00]
  HOMO = -0.279844476631625  LUMO = 0.992648927198465
  mo_energy =
[-1.20409695e+02 -1.23714693e+01 -6.73107927e+00 -6.73107927e+00
 -6.73107927e+00 -1.19554926e+00 -2.79844477e-01 -2.79844477e-01
 -2.79844477e-01  9.92648927e-01  6.09328901e+01  4.36483177e+02
  2.20403893e+03  1.13841164e+04  4.09783936e+04  1.09834795e+05
  2.54036103e+05  5.48467306e+05  1.15241614e+06  2.43019974e+06
  5.37493548e+06]
E1 = -705.5552198695012  E_coul = 197.76813083871505
cycle= 5 E= -507.787089030786  delta_E= -5.75e-10  |g|= 4.82e-07  |ddm|= 8.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -705.5552198695012  E_coul = 197.76813083871505
  HOMO = -0.279844135274638  LUMO = 0.992649227248707
  mo_energy =
[-1.20409694e+02 -1.23714684e+01 -6.73107828e+00 -6.73107828e+00
 -6.73107828e+00 -1.19554918e+00 -2.79844135e-01 -2.79844135e-01
 -2.79844135e-01  9.92649227e-01  6.09328912e+01  4.36483178e+02
  2.20403893e+03  1.13841164e+04  4.09783936e+04  1.09834795e+05
  2.54036103e+05  5.48467306e+05  1.15241614e+06  2.43019974e+06
  5.37493548e+06]
E1 = -705.5552211873638  E_coul = 197.7681321565773
Extra cycle  E= -507.787089030787  delta_E= -3.41e-13  |g|= 4.86e-08  |ddm|= 6.91e-07
    CPU time for scf_cycle      4.96 sec, wall time      0.40 sec
exp = [2.16122716e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180217e+03
 1.83771612e+04 1.23897777e+03 2.98190024e+02 8.84303956e+01
 3.06768476e+01 4.71053372e+00 6.32675039e-01 8.60443311e+00
 4.78062777e-01]
E = -507.78708903078655
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.216122716097       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344728        1
[INPUT] 0    0    [1    /1   ]  7331.80216697        1
[INPUT] 0    0    [1    /1   ]  18377.1612182        1
[INPUT] 0    0    [1    /1   ]  1238.9777698         1
[INPUT] 0    0    [1    /1   ]  298.190024286        1
[INPUT] 0    0    [1    /1   ]  88.4303955507        1
[INPUT] 0    0    [1    /1   ]  30.676847639         1
[INPUT] 0    0    [1    /1   ]  4.71053372049        1
[INPUT] 0    0    [1    /1   ]  0.632675039495       1
[INPUT] 1    0    [1    /1   ]  8.60443311426        1
[INPUT] 1    0    [1    /1   ]  0.478062776938       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.21612271609682254, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.071303246, 1.0]], [0, [294042.0356516221, 1.0]], [0, [147021.0178258056, 1.0]], [0, [73510.50797601347, 1.0]], [0, [36755.23447283113, 1.0]], [0, [7331.802166971357, 1.0]], [0, [18377.161218216144, 1.0]], [0, [1238.9777698010635, 1.0]], [0, [298.19002428636566, 1.0]], [0, [88.4303955507483, 1.0]], [0, [30.676847638978316, 1.0]], [0, [4.710533720492046, 1.0]], [0, [0.6326750394945886, 1.0]], [1, [8.604433114260361, 1.0]], [1, [0.4780627769375939, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21612272]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782581]
bas 5, expnt(s) = [73510.50797601]
bas 6, expnt(s) = [36755.23447283]
bas 7, expnt(s) = [7331.80216697]
bas 8, expnt(s) = [18377.16121822]
bas 9, expnt(s) = [1238.9777698]
bas 10, expnt(s) = [298.19002429]
bas 11, expnt(s) = [88.43039555]
bas 12, expnt(s) = [30.67684764]
bas 13, expnt(s) = [4.71053372]
bas 14, expnt(s) = [0.63267504]
bas 15, expnt(s) = [8.60443311]
bas 16, expnt(s) = [0.47806278]
CPU time:        65.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.16122716e-01 8.00830005e-01 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180217e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609565e+02
 2.98190024e+02 1.81294595e+02 8.84303956e+01 7.28561470e+01
 3.06768476e+01 3.29323765e+01 4.71053372e+00 8.07825600e+00
 6.32675039e-01 1.79225809e+00 8.60443311e+00 4.29919576e+01
 4.78062777e-01 1.15968638e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.347053817216445
cond(S) = 12522.786568578475
E1 = -688.7256066096325  E_coul = 184.61878241521046
init E= -504.106824194422
    CPU time for initialize scf      4.60 sec, wall time      0.32 sec
  HOMO = -0.691526380127917  LUMO = 0.611510211281799
  mo_energy =
[-1.21715296e+02 -1.33384639e+01 -7.63769557e+00 -7.63769557e+00
 -7.63769557e+00 -1.66516872e+00 -6.91526380e-01 -6.91526380e-01
 -6.91526380e-01  6.11510211e-01  5.97237121e+01  4.35191710e+02
  2.20283040e+03  1.13830505e+04  4.09774053e+04  1.09833848e+05
  2.54035184e+05  5.48466408e+05  1.15241525e+06  2.43019887e+06
  5.37493462e+06]
E1 = -706.638002936951  E_coul = 198.86940651864694
cycle= 1 E= -507.768596418304  delta_E= -3.66  |g|= 0.429  |ddm|= 0.45
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.572861
diis-c [-0.32816935  1.        ]
  HOMO = -0.251881735895702  LUMO = 1.00177811345248
  mo_energy =
[-1.20291795e+02 -1.22930287e+01 -6.64681348e+00 -6.64681348e+00
 -6.64681348e+00 -1.17678037e+00 -2.51881736e-01 -2.51881736e-01
 -2.51881736e-01  1.00177811e+00  6.10262027e+01  4.36601673e+02
  2.20417298e+03  1.13842607e+04  4.09785413e+04  1.09834944e+05
  2.54036253e+05  5.48467456e+05  1.15241629e+06  2.43019989e+06
  5.37493563e+06]
E1 = -705.6904851730874  E_coul = 197.90369173321628
cycle= 2 E= -507.786793439871  delta_E= -0.0182  |g|= 0.0342  |ddm|= 0.491
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0243488
diis-c [-5.91610197e-04  1.95334548e-03  9.98046655e-01]
  HOMO = -0.276137687834883  LUMO = 0.994079901222434
  mo_energy =
[-1.20396333e+02 -1.23613445e+01 -6.72046993e+00 -6.72046993e+00
 -6.72046993e+00 -1.19323337e+00 -2.76137688e-01 -2.76137688e-01
 -2.76137688e-01  9.94079901e-01  6.09443118e+01  4.36496522e+02
  2.20405324e+03  1.13841313e+04  4.09784087e+04  1.09834810e+05
  2.54036119e+05  5.48467321e+05  1.15241615e+06  2.43019976e+06
  5.37493550e+06]
E1 = -705.5728327824738  E_coul = 197.78574889396958
cycle= 3 E= -507.787083888504  delta_E= -0.00029  |g|= 0.00447  |ddm|= 0.0599
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.00313426
diis-c [-1.09690648e-06 -2.34056470e-04 -1.38151474e-01  1.13838553e+00]
  HOMO = -0.279807777450365  LUMO = 0.992668141843958
  mo_energy =
[-1.20409630e+02 -1.23713784e+01 -6.73099483e+00 -6.73099483e+00
 -6.73099483e+00 -1.19553053e+00 -2.79807777e-01 -2.79807777e-01
 -2.79807777e-01  9.92668142e-01  6.09329695e+01  4.36483243e+02
  2.20403898e+03  1.13841165e+04  4.09783937e+04  1.09834795e+05
  2.54036103e+05  5.48467306e+05  1.15241614e+06  2.43019974e+06
  5.37493548e+06]
E1 = -705.5553886532839  E_coul = 197.76829962307232
cycle= 4 E= -507.787089030212  delta_E= -5.14e-06  |g|= 5.9e-05  |ddm|= 0.00887
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.48224e-05
diis-c [-6.16172655e-11 -6.11149916e-06  5.85422072e-03 -5.54166884e-02
  1.04956858e+00]
  HOMO = -0.279844476631625  LUMO = 0.992648927198465
  mo_energy =
[-1.20409695e+02 -1.23714693e+01 -6.73107927e+00 -6.73107927e+00
 -6.73107927e+00 -1.19554926e+00 -2.79844477e-01 -2.79844477e-01
 -2.79844477e-01  9.92648927e-01  6.09328901e+01  4.36483177e+02
  2.20403893e+03  1.13841164e+04  4.09783936e+04  1.09834795e+05
  2.54036103e+05  5.48467306e+05  1.15241614e+06  2.43019974e+06
  5.37493548e+06]
E1 = -705.5552198695012  E_coul = 197.76813083871505
cycle= 5 E= -507.787089030786  delta_E= -5.75e-10  |g|= 4.82e-07  |ddm|= 8.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -705.5552198695012  E_coul = 197.76813083871505
  HOMO = -0.279844135274638  LUMO = 0.992649227248707
  mo_energy =
[-1.20409694e+02 -1.23714684e+01 -6.73107828e+00 -6.73107828e+00
 -6.73107828e+00 -1.19554918e+00 -2.79844135e-01 -2.79844135e-01
 -2.79844135e-01  9.92649227e-01  6.09328912e+01  4.36483178e+02
  2.20403893e+03  1.13841164e+04  4.09783936e+04  1.09834795e+05
  2.54036103e+05  5.48467306e+05  1.15241614e+06  2.43019974e+06
  5.37493548e+06]
E1 = -705.5552211873638  E_coul = 197.7681321565773
Extra cycle  E= -507.787089030787  delta_E= -3.41e-13  |g|= 4.86e-08  |ddm|= 6.91e-07
    CPU time for scf_cycle      4.87 sec, wall time      0.39 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12522.786568578475
E1 = -705.5552211873638  E_coul = 197.7681321565773
init E= -507.787089030787
    CPU time for initialize scf     10.28 sec, wall time      0.69 sec
  HOMO = -0.279844100001464  LUMO = 0.992649241399354
  mo_energy =
[-1.20409694e+02 -1.23714683e+01 -6.73107818e+00 -6.73107818e+00
 -6.73107818e+00 -1.19554916e+00 -2.79844100e-01 -2.79844100e-01
 -2.79844100e-01  9.92649241e-01  6.09328913e+01  4.36483178e+02
  2.20403893e+03  1.13841164e+04  4.09783936e+04  1.09834795e+05
  2.54036103e+05  5.48467306e+05  1.15241614e+06  2.43019974e+06
  5.37493548e+06]
E1 = -705.5552213542869  E_coul = 197.76813232349977
cycle= 1 E= -507.787089030787  delta_E= -5.68e-13  |g|= 6.46e-09  |ddm|= 8.53e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -705.5552213542869  E_coul = 197.76813232349977
  HOMO = -0.279844095471968  LUMO = 0.992649242818967
  mo_energy =
[-1.20409694e+02 -1.23714683e+01 -6.73107817e+00 -6.73107817e+00
 -6.73107817e+00 -1.19554916e+00 -2.79844095e-01 -2.79844095e-01
 -2.79844095e-01  9.92649243e-01  6.09328913e+01  4.36483178e+02
  2.20403893e+03  1.13841164e+04  4.09783936e+04  1.09834795e+05
  2.54036103e+05  5.48467306e+05  1.15241614e+06  2.43019974e+06
  5.37493548e+06]
E1 = -705.5552213738252  E_coul = 197.76813234303876
Extra cycle  E= -507.787089030786  delta_E= 6.25e-13  |g|= 1.79e-09  |ddm|= 9.99e-09
    CPU time for scf_cycle     10.34 sec, wall time      0.76 sec
exp = [2.16122716e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180217e+03
 1.83771612e+04 1.23897777e+03 2.98190024e+02 8.84303956e+01
 3.06768476e+01 4.71053372e+00 6.32675039e-01 8.60443311e+00
 4.78062777e-01]
grad_E = [-3.57376147e-01 -1.90319723e-11  4.15196247e-10  1.39490889e-09
  8.19114398e-09  2.69885632e-08  1.64400120e-07  9.00391574e-06
  4.07132314e-07  5.49436390e-06 -3.56470731e-05  3.14888980e-04
 -8.73625196e-04 -8.57483217e-02  7.01751401e-02  1.02519542e-02
 -5.26101607e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.877663262564       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.5079759        1
[INPUT] 0    0    [1    /1   ]  36755.2344724        1
[INPUT] 0    0    [1    /1   ]  7331.80214243        1
[INPUT] 0    0    [1    /1   ]  18377.1612171        1
[INPUT] 0    0    [1    /1   ]  1238.97775721        1
[INPUT] 0    0    [1    /1   ]  298.190082027        1
[INPUT] 0    0    [1    /1   ]  88.4298878486        1
[INPUT] 0    0    [1    /1   ]  30.6781768673        1
[INPUT] 0    0    [1    /1   ]  4.86292361964        1
[INPUT] 0    0    [1    /1   ]  0.988575937611       1
[INPUT] 1    0    [1    /1   ]  8.62054710194        1
[INPUT] 1    0    [1    /1   ]  0.466570129866       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.8776632625635582, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032448, 1.0]], [0, [294042.0356516183, 1.0]], [0, [147021.0178257833, 1.0]], [0, [73510.5079759399, 1.0]], [0, [36755.23447238305, 1.0]], [0, [7331.802142427518, 1.0]], [0, [18377.161217106113, 1.0]], [0, [1238.9777572133648, 1.0]], [0, [298.19008202661803, 1.0]], [0, [88.42988784859286, 1.0]], [0, [30.678176867339598, 1.0]], [0, [4.8629236196449686, 1.0]], [0, [0.9885759376112533, 1.0]], [1, [8.620547101936657, 1.0]], [1, [0.4665701298661714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.87766326]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130324]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782578]
bas 5, expnt(s) = [73510.50797594]
bas 6, expnt(s) = [36755.23447238]
bas 7, expnt(s) = [7331.80214243]
bas 8, expnt(s) = [18377.16121711]
bas 9, expnt(s) = [1238.97775721]
bas 10, expnt(s) = [298.19008203]
bas 11, expnt(s) = [88.42988785]
bas 12, expnt(s) = [30.67817687]
bas 13, expnt(s) = [4.86292362]
bas 14, expnt(s) = [0.98857594]
bas 15, expnt(s) = [8.6205471]
bas 16, expnt(s) = [0.46657013]
CPU time:        83.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.77663263e-01 2.29092549e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180214e+03 2.00181102e+03
 1.83771612e+04 3.98771253e+03 1.23897776e+03 5.27609561e+02
 2.98190082e+02 1.81294622e+02 8.84298878e+01 7.28558333e+01
 3.06781769e+01 3.29334467e+01 4.86292362e+00 8.27347789e+00
 9.88575938e-01 2.50479709e+00 8.62054710e+00 4.30926229e+01
 4.66570130e-01 1.12494310e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.251872234639528
cond(S) = 12524.533956287163
E1 = -685.9994942786391  E_coul = 183.33700097145282
init E= -502.662493307186
    CPU time for initialize scf      4.44 sec, wall time      0.31 sec
  HOMO = -0.729470964446336  LUMO = 3.36054858766105
  mo_energy =
[-1.21825400e+02 -1.34604693e+01 -7.73836576e+00 -7.73836576e+00
 -7.73836576e+00 -1.58657891e+00 -7.29470964e-01 -7.29470964e-01
 -7.29470964e-01  3.36054859e+00  6.47742397e+01  4.39129471e+02
  2.20606663e+03  1.13857519e+04  4.09798722e+04  1.09836200e+05
  2.54037456e+05  5.48468610e+05  1.15241739e+06  2.43020094e+06
  5.37493662e+06]
E1 = -707.2415491913823  E_coul = 199.68913726629683
cycle= 1 E= -507.552411925085  delta_E= -4.89  |g|= 0.415  |ddm|=  110
    CPU time for cycle= 1      0.20 sec, wall time      0.02 sec
diis-norm(errvec)=0.559619
diis-c [-0.31317315  1.        ]
  HOMO = -0.222343358326567  LUMO = 4.07492342622004
  mo_energy =
[-1.20232304e+02 -1.22571145e+01 -6.58275038e+00 -6.58275038e+00
 -6.58275038e+00 -1.02980649e+00 -2.22343358e-01 -2.22343358e-01
 -2.22343358e-01  4.07492343e+00  6.62434527e+01  4.40706049e+02
  2.20757758e+03  1.13871288e+04  4.09811744e+04  1.09837462e+05
  2.54038691e+05  5.48469825e+05  1.15241859e+06  2.43020213e+06
  5.37493781e+06]
E1 = -706.8145544075323  E_coul = 199.25596647424592
cycle= 2 E= -507.558587933286  delta_E= -0.00618  |g|= 0.0214  |ddm|= 18.6
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0125001
diis-c [-1.40714027e-04  6.99593395e-03  9.93004066e-01]
  HOMO = -0.229110730790997  LUMO = 4.06835102989189
  mo_energy =
[-1.20293155e+02 -1.22857055e+01 -6.61638510e+00 -6.61638510e+00
 -6.61638510e+00 -1.03446449e+00 -2.29110731e-01 -2.29110731e-01
 -2.29110731e-01  4.06835103e+00  6.62018029e+01  4.40644568e+02
  2.20750275e+03  1.13870452e+04  4.09810877e+04  1.09837374e+05
  2.54038602e+05  5.48469736e+05  1.15241850e+06  2.43020204e+06
  5.37493772e+06]
E1 = -706.7814680524751  E_coul = 199.22283863088046
cycle= 3 E= -507.558629421595  delta_E= -4.15e-05  |g|= 0.00198  |ddm|= 1.76
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00077078
diis-c [-1.40396635e-07  3.89165763e-04 -4.88673990e-02  1.04847823e+00]
  HOMO = -0.229783026904351  LUMO = 4.06768358742919
  mo_energy =
[-1.20297776e+02 -1.22883885e+01 -6.61939571e+00 -6.61939571e+00
 -6.61939571e+00 -1.03491386e+00 -2.29783027e-01 -2.29783027e-01
 -2.29783027e-01  4.06768359e+00  6.61982833e+01  4.40639959e+02
  2.20749756e+03  1.13870396e+04  4.09810821e+04  1.09837369e+05
  2.54038597e+05  5.48469730e+05  1.15241849e+06  2.43020204e+06
  5.37493771e+06]
E1 = -706.7782077404313  E_coul = 199.2195779094988
cycle= 4 E= -507.558629830932  delta_E= -4.09e-07  |g|= 0.000114  |ddm|= 0.186
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.23431e-05
diis-c [-3.52664530e-11 -3.13561528e-06  4.90976731e-03 -1.12367899e-01
  1.10746127e+00]
  HOMO = -0.229822567243773  LUMO = 4.06764510009401
  mo_energy =
[-1.20297999e+02 -1.22885396e+01 -6.61955803e+00 -6.61955803e+00
 -6.61955803e+00 -1.03494045e+00 -2.29822567e-01 -2.29822567e-01
 -2.29822567e-01  4.06764510e+00  6.61981023e+01  4.40639736e+02
  2.20749732e+03  1.13870394e+04  4.09810818e+04  1.09837368e+05
  2.54038596e+05  5.48469730e+05  1.15241849e+06  2.43020204e+06
  5.37493771e+06]
E1 = -706.7780192166979  E_coul = 199.21938938439177
cycle= 5 E= -507.558629832306  delta_E= -1.37e-09  |g|= 3.5e-07  |ddm|= 0.0113
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.92937e-07
diis-c [-1.19314158e-14  8.95689117e-08 -1.09773417e-04  2.42034046e-03
 -2.51587141e-02  1.02284806e+00]
  HOMO = -0.229822571522369  LUMO = 4.06764512044179
  mo_energy =
[-1.20297999e+02 -1.22885396e+01 -6.61955798e+00 -6.61955798e+00
 -6.61955798e+00 -1.03494046e+00 -2.29822572e-01 -2.29822572e-01
 -2.29822572e-01  4.06764512e+00  6.61981024e+01  4.40639736e+02
  2.20749732e+03  1.13870394e+04  4.09810818e+04  1.09837368e+05
  2.54038596e+05  5.48469730e+05  1.15241849e+06  2.43020204e+06
  5.37493771e+06]
E1 = -706.7780192435247  E_coul = 199.21938941121817
cycle= 6 E= -507.558629832307  delta_E= -3.98e-13  |g|= 2.04e-08  |ddm|= 2.76e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.7780192435247  E_coul = 199.21938941121817
  HOMO = -0.229822564917532  LUMO = 4.06764512868674
  mo_energy =
[-1.20297999e+02 -1.22885396e+01 -6.61955794e+00 -6.61955794e+00
 -6.61955794e+00 -1.03494046e+00 -2.29822565e-01 -2.29822565e-01
 -2.29822565e-01  4.06764513e+00  6.61981025e+01  4.40639736e+02
  2.20749732e+03  1.13870394e+04  4.09810818e+04  1.09837368e+05
  2.54038596e+05  5.48469730e+05  1.15241849e+06  2.43020204e+06
  5.37493771e+06]
E1 = -706.7780192770445  E_coul = 199.21938944474044
Extra cycle  E= -507.558629832304  delta_E= 2.5e-12  |g|= 1.69e-09  |ddm|= 1.82e-06
    CPU time for scf_cycle      4.72 sec, wall time      0.40 sec
exp = [8.77663263e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180214e+03
 1.83771612e+04 1.23897776e+03 2.98190082e+02 8.84298878e+01
 3.06781769e+01 4.86292362e+00 9.88575938e-01 8.62054710e+00
 4.66570130e-01]
E = -507.558629832304
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.377747191979       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344727        1
[INPUT] 0    0    [1    /1   ]  7331.80216097        1
[INPUT] 0    0    [1    /1   ]  18377.1612179        1
[INPUT] 0    0    [1    /1   ]  1238.97776673        1
[INPUT] 0    0    [1    /1   ]  298.190038393        1
[INPUT] 0    0    [1    /1   ]  88.4302715113        1
[INPUT] 0    0    [1    /1   ]  30.6771723898        1
[INPUT] 0    0    [1    /1   ]  4.74776490415        1
[INPUT] 0    0    [1    /1   ]  0.719627073548       1
[INPUT] 1    0    [1    /1   ]  8.60837000796        1
[INPUT] 1    0    [1    /1   ]  0.475254947441       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3777471919785305, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032457, 1.0]], [0, [294042.0356516212, 1.0]], [0, [147021.01782580017, 1.0]], [0, [73510.5079759955, 1.0]], [0, [36755.234472721655, 1.0]], [0, [7331.802160974922, 1.0]], [0, [18377.161217944948, 1.0]], [0, [1238.977766725696, 1.0]], [0, [298.19003839319265, 1.0]], [0, [88.4302715113448, 1.0]], [0, [30.67717238980178, 1.0]], [0, [4.747764904146329, 1.0]], [0, [0.7196270735477689, 1.0]], [1, [8.608370007964695, 1.0]], [1, [0.4752549474412268, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.37774719]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.0178258]
bas 5, expnt(s) = [73510.507976]
bas 6, expnt(s) = [36755.23447272]
bas 7, expnt(s) = [7331.80216097]
bas 8, expnt(s) = [18377.16121794]
bas 9, expnt(s) = [1238.97776673]
bas 10, expnt(s) = [298.19003839]
bas 11, expnt(s) = [88.43027151]
bas 12, expnt(s) = [30.67717239]
bas 13, expnt(s) = [4.7477649]
bas 14, expnt(s) = [0.71962707]
bas 15, expnt(s) = [8.60837001]
bas 16, expnt(s) = [0.47525495]
CPU time:        88.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.77747192e-01 1.21735139e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180216e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609564e+02
 2.98190038e+02 1.81294602e+02 8.84302715e+01 7.28560704e+01
 3.06771724e+01 3.29326379e+01 4.74776490e+00 8.12609562e+00
 7.19627074e-01 1.97399317e+00 8.60837001e+00 4.30165474e+01
 4.75254947e-01 1.15117858e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.346825547418224
cond(S) = 12523.144204869433
E1 = -688.3110517628897  E_coul = 184.24873831312948
init E= -504.06231344976
    CPU time for initialize scf      4.79 sec, wall time      0.34 sec
  HOMO = -0.697952883773925  LUMO = 1.26281323426934
  mo_energy =
[-1.21751908e+02 -1.33784853e+01 -7.67018820e+00 -7.67018820e+00
 -7.67018820e+00 -1.67101308e+00 -6.97952884e-01 -6.97952884e-01
 -6.97952884e-01  1.26281323e+00  6.09158527e+01  4.36100643e+02
  2.20357312e+03  1.13836682e+04  4.09779684e+04  1.09834384e+05
  2.54035702e+05  5.48466909e+05  1.15241574e+06  2.43019934e+06
  5.37493507e+06]
E1 = -706.4430221175871  E_coul = 198.65183410841573
cycle= 1 E= -507.791188009171  delta_E= -3.73  |g|= 0.436  |ddm|= 0.951
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.554235
diis-c [-0.30717689  1.        ]
  HOMO = -0.254623125853275  LUMO = 1.74368181252797
  mo_energy =
[-1.20321578e+02 -1.23180024e+01 -6.66403404e+00 -6.66403404e+00
 -6.66403404e+00 -1.18061039e+00 -2.54623126e-01 -2.54623126e-01
 -2.54623126e-01  1.74368181e+00  6.22313629e+01  4.37516441e+02
  2.20491796e+03  1.13848777e+04  4.09791027e+04  1.09835478e+05
  2.54036768e+05  5.48467956e+05  1.15241677e+06  2.43020036e+06
  5.37493609e+06]
E1 = -705.6553209754687  E_coul = 197.8497794510466
cycle= 2 E= -507.805541524422  delta_E= -0.0144  |g|= 0.0312  |ddm|= 0.698
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0169633
diis-c [-2.69509579e-04  7.65119527e-03  9.92348805e-01]
  HOMO = -0.272281033931954  LUMO = 1.73477742884558
  mo_energy =
[-1.20414471e+02 -1.23740357e+01 -6.72574644e+00 -6.72574644e+00
 -6.72574644e+00 -1.19229571e+00 -2.72281034e-01 -2.72281034e-01
 -2.72281034e-01  1.73477743e+00  6.21609648e+01  4.37422921e+02
  2.20480974e+03  1.13847598e+04  4.09789815e+04  1.09835356e+05
  2.54036645e+05  5.48467832e+05  1.15241665e+06  2.43020024e+06
  5.37493596e+06]
E1 = -705.5722135111032  E_coul = 197.76649566484767
cycle= 3 E= -507.805717846256  delta_E= -0.000176  |g|= 0.00381  |ddm|= 0.0824
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.00189211
diis-c [-7.90628917e-07 -4.95838992e-05 -1.09771956e-01  1.10982154e+00]
  HOMO = -0.274650413981703  LUMO = 1.73344783535745
  mo_energy =
[-1.20424742e+02 -1.23812977e+01 -6.73348510e+00 -6.73348510e+00
 -6.73348510e+00 -1.19376034e+00 -2.74650414e-01 -2.74650414e-01
 -2.74650414e-01  1.73344784e+00  6.21524702e+01  4.37412664e+02
  2.20479857e+03  1.13847481e+04  4.09789696e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.561020913531  E_coul = 197.755300298136
cycle= 4 E= -507.805720615395  delta_E= -2.77e-06  |g|= 0.00011  |ddm|= 0.0114
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.55413e-05
diis-c [-5.60063873e-11 -5.76975984e-06  5.94587235e-03 -7.75586257e-02
  1.07161852e+00]
  HOMO = -0.274713236034562  LUMO = 1.73341050865886
  mo_energy =
[-1.20424944e+02 -1.23814803e+01 -6.73366819e+00 -6.73366819e+00
 -6.73366819e+00 -1.19379727e+00 -2.74713236e-01 -2.74713236e-01
 -2.74713236e-01  1.73341051e+00  6.21522822e+01  4.37412463e+02
  2.20479836e+03  1.13847479e+04  4.09789694e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.560723574353  E_coul = 197.75500295688343
cycle= 5 E= -507.80572061747  delta_E= -2.07e-09  |g|= 6.91e-07  |ddm|= 0.00031
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.56489e-07
diis-c [-1.49080748e-14  1.12049282e-07 -1.21138426e-04  1.59539319e-03
 -1.93282254e-02  1.01785386e+00]
  HOMO = -0.274712868906963  LUMO = 1.73341081113795
  mo_energy =
[-1.20424943e+02 -1.23814792e+01 -6.73366693e+00 -6.73366693e+00
 -6.73366693e+00 -1.19379712e+00 -2.74712869e-01 -2.74712869e-01
 -2.74712869e-01  1.73341081e+00  6.21522836e+01  4.37412464e+02
  2.20479837e+03  1.13847479e+04  4.09789694e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.5607253224869  E_coul = 197.7550047050168
cycle= 6 E= -507.80572061747  delta_E= -5.12e-13  |g|= 2.15e-08  |ddm|= 1.77e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -705.5607253224869  E_coul = 197.7550047050168
  HOMO = -0.274712857422989  LUMO = 1.73341081493384
  mo_energy =
[-1.20424942e+02 -1.23814791e+01 -6.73366689e+00 -6.73366689e+00
 -6.73366689e+00 -1.19379711e+00 -2.74712857e-01 -2.74712857e-01
 -2.74712857e-01  1.73341081e+00  6.21522836e+01  4.37412464e+02
  2.20479837e+03  1.13847479e+04  4.09789694e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.5607253767324  E_coul = 197.7550047592629
Extra cycle  E= -507.80572061747  delta_E= 5.12e-13  |g|= 2.31e-09  |ddm|= 5.37e-08
    CPU time for scf_cycle      5.06 sec, wall time      0.42 sec
exp = [3.77747192e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180216e+03
 1.83771612e+04 1.23897777e+03 2.98190038e+02 8.84302715e+01
 3.06771724e+01 4.74776490e+00 7.19627074e-01 8.60837001e+00
 4.75254947e-01]
E = -507.80572061746955
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.377747191979       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344727        1
[INPUT] 0    0    [1    /1   ]  7331.80216097        1
[INPUT] 0    0    [1    /1   ]  18377.1612179        1
[INPUT] 0    0    [1    /1   ]  1238.97776673        1
[INPUT] 0    0    [1    /1   ]  298.190038393        1
[INPUT] 0    0    [1    /1   ]  88.4302715113        1
[INPUT] 0    0    [1    /1   ]  30.6771723898        1
[INPUT] 0    0    [1    /1   ]  4.74776490415        1
[INPUT] 0    0    [1    /1   ]  0.719627073548       1
[INPUT] 1    0    [1    /1   ]  8.60837000796        1
[INPUT] 1    0    [1    /1   ]  0.475254947441       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3777471919785305, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032457, 1.0]], [0, [294042.0356516212, 1.0]], [0, [147021.01782580017, 1.0]], [0, [73510.5079759955, 1.0]], [0, [36755.234472721655, 1.0]], [0, [7331.802160974922, 1.0]], [0, [18377.161217944948, 1.0]], [0, [1238.977766725696, 1.0]], [0, [298.19003839319265, 1.0]], [0, [88.4302715113448, 1.0]], [0, [30.67717238980178, 1.0]], [0, [4.747764904146329, 1.0]], [0, [0.7196270735477689, 1.0]], [1, [8.608370007964695, 1.0]], [1, [0.4752549474412268, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.37774719]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.0178258]
bas 5, expnt(s) = [73510.507976]
bas 6, expnt(s) = [36755.23447272]
bas 7, expnt(s) = [7331.80216097]
bas 8, expnt(s) = [18377.16121794]
bas 9, expnt(s) = [1238.97776673]
bas 10, expnt(s) = [298.19003839]
bas 11, expnt(s) = [88.43027151]
bas 12, expnt(s) = [30.67717239]
bas 13, expnt(s) = [4.7477649]
bas 14, expnt(s) = [0.71962707]
bas 15, expnt(s) = [8.60837001]
bas 16, expnt(s) = [0.47525495]
CPU time:        93.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.77747192e-01 1.21735139e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180216e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897777e+03 5.27609564e+02
 2.98190038e+02 1.81294602e+02 8.84302715e+01 7.28560704e+01
 3.06771724e+01 3.29326379e+01 4.74776490e+00 8.12609562e+00
 7.19627074e-01 1.97399317e+00 8.60837001e+00 4.30165474e+01
 4.75254947e-01 1.15117858e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.346825547418224
cond(S) = 12523.144204869433
E1 = -688.3110517628897  E_coul = 184.24873831312948
init E= -504.06231344976
    CPU time for initialize scf      4.76 sec, wall time      0.33 sec
  HOMO = -0.697952883773925  LUMO = 1.26281323426934
  mo_energy =
[-1.21751908e+02 -1.33784853e+01 -7.67018820e+00 -7.67018820e+00
 -7.67018820e+00 -1.67101308e+00 -6.97952884e-01 -6.97952884e-01
 -6.97952884e-01  1.26281323e+00  6.09158527e+01  4.36100643e+02
  2.20357312e+03  1.13836682e+04  4.09779684e+04  1.09834384e+05
  2.54035702e+05  5.48466909e+05  1.15241574e+06  2.43019934e+06
  5.37493507e+06]
E1 = -706.4430221175871  E_coul = 198.65183410841573
cycle= 1 E= -507.791188009171  delta_E= -3.73  |g|= 0.436  |ddm|= 0.951
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.554235
diis-c [-0.30717689  1.        ]
  HOMO = -0.254623125853275  LUMO = 1.74368181252797
  mo_energy =
[-1.20321578e+02 -1.23180024e+01 -6.66403404e+00 -6.66403404e+00
 -6.66403404e+00 -1.18061039e+00 -2.54623126e-01 -2.54623126e-01
 -2.54623126e-01  1.74368181e+00  6.22313629e+01  4.37516441e+02
  2.20491796e+03  1.13848777e+04  4.09791027e+04  1.09835478e+05
  2.54036768e+05  5.48467956e+05  1.15241677e+06  2.43020036e+06
  5.37493609e+06]
E1 = -705.6553209754687  E_coul = 197.8497794510466
cycle= 2 E= -507.805541524422  delta_E= -0.0144  |g|= 0.0312  |ddm|= 0.698
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0169633
diis-c [-2.69509579e-04  7.65119527e-03  9.92348805e-01]
  HOMO = -0.272281033931954  LUMO = 1.73477742884558
  mo_energy =
[-1.20414471e+02 -1.23740357e+01 -6.72574644e+00 -6.72574644e+00
 -6.72574644e+00 -1.19229571e+00 -2.72281034e-01 -2.72281034e-01
 -2.72281034e-01  1.73477743e+00  6.21609648e+01  4.37422921e+02
  2.20480974e+03  1.13847598e+04  4.09789815e+04  1.09835356e+05
  2.54036645e+05  5.48467832e+05  1.15241665e+06  2.43020024e+06
  5.37493596e+06]
E1 = -705.5722135111032  E_coul = 197.76649566484767
cycle= 3 E= -507.805717846256  delta_E= -0.000176  |g|= 0.00381  |ddm|= 0.0824
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.00189211
diis-c [-7.90628917e-07 -4.95838992e-05 -1.09771956e-01  1.10982154e+00]
  HOMO = -0.274650413981703  LUMO = 1.73344783535745
  mo_energy =
[-1.20424742e+02 -1.23812977e+01 -6.73348510e+00 -6.73348510e+00
 -6.73348510e+00 -1.19376034e+00 -2.74650414e-01 -2.74650414e-01
 -2.74650414e-01  1.73344784e+00  6.21524702e+01  4.37412664e+02
  2.20479857e+03  1.13847481e+04  4.09789696e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.561020913531  E_coul = 197.755300298136
cycle= 4 E= -507.805720615395  delta_E= -2.77e-06  |g|= 0.00011  |ddm|= 0.0114
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.55413e-05
diis-c [-5.60063873e-11 -5.76975984e-06  5.94587235e-03 -7.75586257e-02
  1.07161852e+00]
  HOMO = -0.274713236034562  LUMO = 1.73341050865886
  mo_energy =
[-1.20424944e+02 -1.23814803e+01 -6.73366819e+00 -6.73366819e+00
 -6.73366819e+00 -1.19379727e+00 -2.74713236e-01 -2.74713236e-01
 -2.74713236e-01  1.73341051e+00  6.21522822e+01  4.37412463e+02
  2.20479836e+03  1.13847479e+04  4.09789694e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.560723574353  E_coul = 197.75500295688343
cycle= 5 E= -507.80572061747  delta_E= -2.07e-09  |g|= 6.91e-07  |ddm|= 0.00031
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.56489e-07
diis-c [-1.49080748e-14  1.12049282e-07 -1.21138426e-04  1.59539319e-03
 -1.93282254e-02  1.01785386e+00]
  HOMO = -0.274712868906963  LUMO = 1.73341081113795
  mo_energy =
[-1.20424943e+02 -1.23814792e+01 -6.73366693e+00 -6.73366693e+00
 -6.73366693e+00 -1.19379712e+00 -2.74712869e-01 -2.74712869e-01
 -2.74712869e-01  1.73341081e+00  6.21522836e+01  4.37412464e+02
  2.20479837e+03  1.13847479e+04  4.09789694e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.5607253224869  E_coul = 197.7550047050168
cycle= 6 E= -507.80572061747  delta_E= -5.12e-13  |g|= 2.15e-08  |ddm|= 1.77e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -705.5607253224869  E_coul = 197.7550047050168
  HOMO = -0.274712857422989  LUMO = 1.73341081493384
  mo_energy =
[-1.20424942e+02 -1.23814791e+01 -6.73366689e+00 -6.73366689e+00
 -6.73366689e+00 -1.19379711e+00 -2.74712857e-01 -2.74712857e-01
 -2.74712857e-01  1.73341081e+00  6.21522836e+01  4.37412464e+02
  2.20479837e+03  1.13847479e+04  4.09789694e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.5607253767324  E_coul = 197.7550047592629
Extra cycle  E= -507.80572061747  delta_E= 5.12e-13  |g|= 2.31e-09  |ddm|= 5.37e-08
    CPU time for scf_cycle      5.04 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12523.144204869433
E1 = -705.5607253767324  E_coul = 197.7550047592629
init E= -507.80572061747
    CPU time for initialize scf     10.17 sec, wall time      0.68 sec
  HOMO = -0.274712856152726  LUMO = 1.73341081508758
  mo_energy =
[-1.20424942e+02 -1.23814791e+01 -6.73366688e+00 -6.73366688e+00
 -6.73366688e+00 -1.19379711e+00 -2.74712856e-01 -2.74712856e-01
 -2.74712856e-01  1.73341082e+00  6.21522836e+01  4.37412464e+02
  2.20479837e+03  1.13847479e+04  4.09789694e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.560725382778  E_coul = 197.75500476530823
cycle= 1 E= -507.80572061747  delta_E= -1.71e-13  |g|= 8.85e-10  |ddm|= 6.11e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -705.560725382778  E_coul = 197.75500476530823
  HOMO = -0.274712856004835  LUMO = 1.7334108157761
  mo_energy =
[-1.20424942e+02 -1.23814791e+01 -6.73366688e+00 -6.73366688e+00
 -6.73366688e+00 -1.19379711e+00 -2.74712856e-01 -2.74712856e-01
 -2.74712856e-01  1.73341082e+00  6.21522836e+01  4.37412464e+02
  2.20479837e+03  1.13847479e+04  4.09789694e+04  1.09835344e+05
  2.54036633e+05  5.48467820e+05  1.15241663e+06  2.43020023e+06
  5.37493595e+06]
E1 = -705.5607253834916  E_coul = 197.75500476602184
Extra cycle  E= -507.80572061747  delta_E=    0  |g|= 8.64e-10  |ddm|= 7.06e-10
    CPU time for scf_cycle     10.36 sec, wall time      0.75 sec
exp = [3.77747192e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180216e+03
 1.83771612e+04 1.23897777e+03 2.98190038e+02 8.84302715e+01
 3.06771724e+01 4.74776490e+00 7.19627074e-01 8.60837001e+00
 4.75254947e-01]
grad_E = [ 1.15441958e-01 -1.90997260e-11  4.14430061e-10  1.39209016e-09
  8.17642024e-09  2.69349727e-08  1.64106155e-07  8.98682163e-06
  4.06241517e-07  6.38818091e-06 -5.13229451e-05  4.40867222e-04
 -1.37065550e-03 -1.36117963e-01 -4.23131055e-02  1.30400134e-02
 -6.33209637e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.362909954271       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344726        1
[INPUT] 0    0    [1    /1   ]  7331.80215188        1
[INPUT] 0    0    [1    /1   ]  18377.1612175        1
[INPUT] 0    0    [1    /1   ]  1238.97776067        1
[INPUT] 0    0    [1    /1   ]  298.190083501        1
[INPUT] 0    0    [1    /1   ]  88.4298844785        1
[INPUT] 0    0    [1    /1   ]  30.6783625568        1
[INPUT] 0    0    [1    /1   ]  4.86593436832        1
[INPUT] 0    0    [1    /1   ]  0.695977183357       1
[INPUT] 1    0    [1    /1   ]  8.61231889485        1
[INPUT] 1    0    [1    /1   ]  0.488729371039       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3629099542712716, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032453, 1.0]], [0, [294042.0356516198, 1.0]], [0, [147021.0178257919, 1.0]], [0, [73510.50797596824, 1.0]], [0, [36755.23447255558, 1.0]], [0, [7331.80215187969, 1.0]], [0, [18377.16121753376, 1.0]], [0, [1238.9777606672676, 1.0]], [0, [298.1900835014848, 1.0]], [0, [88.42988447846365, 1.0]], [0, [30.678362556838508, 1.0]], [0, [4.865934368322947, 1.0]], [0, [0.6959771833571411, 1.0]], [1, [8.612318894851922, 1.0]], [1, [0.48872937103934416, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.36290995]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782579]
bas 5, expnt(s) = [73510.50797597]
bas 6, expnt(s) = [36755.23447256]
bas 7, expnt(s) = [7331.80215188]
bas 8, expnt(s) = [18377.16121753]
bas 9, expnt(s) = [1238.97776067]
bas 10, expnt(s) = [298.1900835]
bas 11, expnt(s) = [88.42988448]
bas 12, expnt(s) = [30.67836256]
bas 13, expnt(s) = [4.86593437]
bas 14, expnt(s) = [0.69597718]
bas 15, expnt(s) = [8.61231889]
bas 16, expnt(s) = [0.48872937]
CPU time:       111.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.62909954e-01 1.18131083e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180215e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897776e+03 5.27609562e+02
 2.98190084e+02 1.81294622e+02 8.84298845e+01 7.28558312e+01
 3.06783626e+01 3.29335962e+01 4.86593437e+00 8.27731932e+00
 6.95977183e-01 1.92513538e+00 8.61231889e+00 4.30412148e+01
 4.88729371e-01 1.19211991e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.332253750193175
cond(S) = 12523.22149893393
E1 = -689.0598450135767  E_coul = 184.81899870343415
init E= -504.240846310143
    CPU time for initialize scf      4.85 sec, wall time      0.34 sec
  HOMO = -0.681279406709384  LUMO = 1.19915870105641
  mo_energy =
[-1.21696911e+02 -1.33385699e+01 -7.63206695e+00 -7.63206695e+00
 -7.63206695e+00 -1.65734326e+00 -6.81279407e-01 -6.81279407e-01
 -6.81279407e-01  1.19915870e+00  6.13088818e+01  4.36490270e+02
  2.20391415e+03  1.13839647e+04  4.09782449e+04  1.09834651e+05
  2.54035962e+05  5.48467163e+05  1.15241599e+06  2.43019958e+06
  5.37493531e+06]
E1 = -707.2908690538676  E_coul = 199.48408545837455
cycle= 1 E= -507.806783595493  delta_E= -3.57  |g|= 0.434  |ddm|= 0.822
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
diis-norm(errvec)=0.556371
diis-c [-0.30954854  1.        ]
  HOMO = -0.225591100549428  LUMO = 1.68181571085792
  mo_energy =
[-1.20234681e+02 -1.22633187e+01 -6.61153923e+00 -6.61153923e+00
 -6.61153923e+00 -1.15901444e+00 -2.25591101e-01 -2.25591101e-01
 -2.25591101e-01  1.68181571e+00  6.26441293e+01  4.37938494e+02
  2.20529721e+03  1.13852166e+04  4.09794229e+04  1.09835789e+05
  2.54037073e+05  5.48468254e+05  1.15241706e+06  2.43020065e+06
  5.37493637e+06]
E1 = -706.4544550115733  E_coul = 198.63203702847957
cycle= 2 E= -507.822417983094  delta_E= -0.0156  |g|= 0.0323  |ddm|= 0.703
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0176116
diis-c [-2.90524604e-04  7.90685110e-03  9.92093149e-01]
  HOMO = -0.244902951930567  LUMO = 1.67254538354409
  mo_energy =
[-1.20332160e+02 -1.23228758e+01 -6.67686107e+00 -6.67686107e+00
 -6.67686107e+00 -1.17157428e+00 -2.44902952e-01 -2.44902952e-01
 -2.44902952e-01  1.67254538e+00  6.25695947e+01  4.37840378e+02
  2.20518406e+03  1.13850935e+04  4.09792965e+04  1.09835662e+05
  2.54036944e+05  5.48468125e+05  1.15241693e+06  2.43020052e+06
  5.37493624e+06]
E1 = -706.3653568945869  E_coul = 198.54274339299158
cycle= 3 E= -507.822613501595  delta_E= -0.000196  |g|= 0.00399  |ddm|= 0.0832
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00202555
diis-c [-8.06510723e-07 -1.26193017e-04 -1.16036670e-01  1.11616286e+00]
  HOMO = -0.24752713313835  LUMO = 1.67113301836795
  mo_energy =
[-1.20343172e+02 -1.23307090e+01 -6.68518391e+00 -6.68518391e+00
 -6.68518391e+00 -1.17316367e+00 -2.47527133e-01 -2.47527133e-01
 -2.47527133e-01  1.67113302e+00  6.25604480e+01  4.37829380e+02
  2.20517210e+03  1.13850810e+04  4.09792838e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.3531903593375  E_coul = 198.5305737392497
cycle= 4 E= -507.822616620088  delta_E= -3.12e-06  |g|= 9.8e-05  |ddm|= 0.0116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.18017e-05
diis-c [-5.77304984e-11 -5.90758332e-06  6.10104269e-03 -7.30873336e-02
  1.06699220e+00]
  HOMO = -0.247583068935363  LUMO = 1.67110041664387
  mo_energy =
[-1.20343334e+02 -1.23308658e+01 -6.68533834e+00 -6.68533834e+00
 -6.68533834e+00 -1.17319529e+00 -2.47583069e-01 -2.47583069e-01
 -2.47583069e-01  1.67110042e+00  6.25602921e+01  4.37829218e+02
  2.20517193e+03  1.13850808e+04  4.09792836e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.3529291907381  E_coul = 198.53031256906007
cycle= 5 E= -507.822616621678  delta_E= -1.59e-09  |g|= 6.87e-07  |ddm|= 0.000256
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.62862e-07
diis-c [-1.46133592e-14  1.18407693e-07 -1.23191946e-04  1.49953791e-03
 -1.89731420e-02  1.01759668e+00]
  HOMO = -0.247582676830391  LUMO = 1.67110073984794
  mo_energy =
[-1.20343332e+02 -1.23308647e+01 -6.68533703e+00 -6.68533703e+00
 -6.68533703e+00 -1.17319514e+00 -2.47582677e-01 -2.47582677e-01
 -2.47582677e-01  1.67110074e+00  6.25602936e+01  4.37829220e+02
  2.20517194e+03  1.13850808e+04  4.09792836e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.352931007282  E_coul = 198.53031438560365
cycle= 6 E= -507.822616621678  delta_E= -2.84e-13  |g|= 2.12e-08  |ddm|= 1.73e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.352931007282  E_coul = 198.53031438560365
  HOMO = -0.247582664825423  LUMO = 1.67110074232393
  mo_energy =
[-1.20343332e+02 -1.23308646e+01 -6.68533699e+00 -6.68533699e+00
 -6.68533699e+00 -1.17319513e+00 -2.47582665e-01 -2.47582665e-01
 -2.47582665e-01  1.67110074e+00  6.25602936e+01  4.37829220e+02
  2.20517194e+03  1.13850808e+04  4.09792836e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.352931062953  E_coul = 198.53031444127444
Extra cycle  E= -507.822616621679  delta_E= -2.27e-13  |g|= 2.6e-09  |ddm|= 5.2e-08
    CPU time for scf_cycle      5.05 sec, wall time      0.43 sec
exp = [3.62909954e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180215e+03
 1.83771612e+04 1.23897776e+03 2.98190084e+02 8.84298845e+01
 3.06783626e+01 4.86593437e+00 6.95977183e-01 8.61231889e+00
 4.88729371e-01]
E = -507.82261662167855
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.362909954271       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.507976         1
[INPUT] 0    0    [1    /1   ]  36755.2344726        1
[INPUT] 0    0    [1    /1   ]  7331.80215188        1
[INPUT] 0    0    [1    /1   ]  18377.1612175        1
[INPUT] 0    0    [1    /1   ]  1238.97776067        1
[INPUT] 0    0    [1    /1   ]  298.190083501        1
[INPUT] 0    0    [1    /1   ]  88.4298844785        1
[INPUT] 0    0    [1    /1   ]  30.6783625568        1
[INPUT] 0    0    [1    /1   ]  4.86593436832        1
[INPUT] 0    0    [1    /1   ]  0.695977183357       1
[INPUT] 1    0    [1    /1   ]  8.61231889485        1
[INPUT] 1    0    [1    /1   ]  0.488729371039       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3629099542712716, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032453, 1.0]], [0, [294042.0356516198, 1.0]], [0, [147021.0178257919, 1.0]], [0, [73510.50797596824, 1.0]], [0, [36755.23447255558, 1.0]], [0, [7331.80215187969, 1.0]], [0, [18377.16121753376, 1.0]], [0, [1238.9777606672676, 1.0]], [0, [298.1900835014848, 1.0]], [0, [88.42988447846365, 1.0]], [0, [30.678362556838508, 1.0]], [0, [4.865934368322947, 1.0]], [0, [0.6959771833571411, 1.0]], [1, [8.612318894851922, 1.0]], [1, [0.48872937103934416, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.36290995]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130325]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782579]
bas 5, expnt(s) = [73510.50797597]
bas 6, expnt(s) = [36755.23447256]
bas 7, expnt(s) = [7331.80215188]
bas 8, expnt(s) = [18377.16121753]
bas 9, expnt(s) = [1238.97776067]
bas 10, expnt(s) = [298.1900835]
bas 11, expnt(s) = [88.42988448]
bas 12, expnt(s) = [30.67836256]
bas 13, expnt(s) = [4.86593437]
bas 14, expnt(s) = [0.69597718]
bas 15, expnt(s) = [8.61231889]
bas 16, expnt(s) = [0.48872937]
CPU time:       116.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.62909954e-01 1.18131083e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180215e+03 2.00181103e+03
 1.83771612e+04 3.98771253e+03 1.23897776e+03 5.27609562e+02
 2.98190084e+02 1.81294622e+02 8.84298845e+01 7.28558312e+01
 3.06783626e+01 3.29335962e+01 4.86593437e+00 8.27731932e+00
 6.95977183e-01 1.92513538e+00 8.61231889e+00 4.30412148e+01
 4.88729371e-01 1.19211991e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.332253750193175
cond(S) = 12523.22149893393
E1 = -689.0598450135767  E_coul = 184.81899870343415
init E= -504.240846310143
    CPU time for initialize scf      4.60 sec, wall time      0.32 sec
  HOMO = -0.681279406709384  LUMO = 1.19915870105641
  mo_energy =
[-1.21696911e+02 -1.33385699e+01 -7.63206695e+00 -7.63206695e+00
 -7.63206695e+00 -1.65734326e+00 -6.81279407e-01 -6.81279407e-01
 -6.81279407e-01  1.19915870e+00  6.13088818e+01  4.36490270e+02
  2.20391415e+03  1.13839647e+04  4.09782449e+04  1.09834651e+05
  2.54035962e+05  5.48467163e+05  1.15241599e+06  2.43019958e+06
  5.37493531e+06]
E1 = -707.2908690538676  E_coul = 199.48408545837455
cycle= 1 E= -507.806783595493  delta_E= -3.57  |g|= 0.434  |ddm|= 0.822
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.556371
diis-c [-0.30954854  1.        ]
  HOMO = -0.225591100549428  LUMO = 1.68181571085792
  mo_energy =
[-1.20234681e+02 -1.22633187e+01 -6.61153923e+00 -6.61153923e+00
 -6.61153923e+00 -1.15901444e+00 -2.25591101e-01 -2.25591101e-01
 -2.25591101e-01  1.68181571e+00  6.26441293e+01  4.37938494e+02
  2.20529721e+03  1.13852166e+04  4.09794229e+04  1.09835789e+05
  2.54037073e+05  5.48468254e+05  1.15241706e+06  2.43020065e+06
  5.37493637e+06]
E1 = -706.4544550115733  E_coul = 198.63203702847957
cycle= 2 E= -507.822417983094  delta_E= -0.0156  |g|= 0.0323  |ddm|= 0.703
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0176116
diis-c [-2.90524604e-04  7.90685110e-03  9.92093149e-01]
  HOMO = -0.244902951930567  LUMO = 1.67254538354409
  mo_energy =
[-1.20332160e+02 -1.23228758e+01 -6.67686107e+00 -6.67686107e+00
 -6.67686107e+00 -1.17157428e+00 -2.44902952e-01 -2.44902952e-01
 -2.44902952e-01  1.67254538e+00  6.25695947e+01  4.37840378e+02
  2.20518406e+03  1.13850935e+04  4.09792965e+04  1.09835662e+05
  2.54036944e+05  5.48468125e+05  1.15241693e+06  2.43020052e+06
  5.37493624e+06]
E1 = -706.3653568945869  E_coul = 198.54274339299158
cycle= 3 E= -507.822613501595  delta_E= -0.000196  |g|= 0.00399  |ddm|= 0.0832
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00202555
diis-c [-8.06510723e-07 -1.26193017e-04 -1.16036670e-01  1.11616286e+00]
  HOMO = -0.24752713313835  LUMO = 1.67113301836795
  mo_energy =
[-1.20343172e+02 -1.23307090e+01 -6.68518391e+00 -6.68518391e+00
 -6.68518391e+00 -1.17316367e+00 -2.47527133e-01 -2.47527133e-01
 -2.47527133e-01  1.67113302e+00  6.25604480e+01  4.37829380e+02
  2.20517210e+03  1.13850810e+04  4.09792838e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.3531903593375  E_coul = 198.5305737392497
cycle= 4 E= -507.822616620088  delta_E= -3.12e-06  |g|= 9.8e-05  |ddm|= 0.0116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.18017e-05
diis-c [-5.77304984e-11 -5.90758332e-06  6.10104269e-03 -7.30873336e-02
  1.06699220e+00]
  HOMO = -0.247583068935363  LUMO = 1.67110041664387
  mo_energy =
[-1.20343334e+02 -1.23308658e+01 -6.68533834e+00 -6.68533834e+00
 -6.68533834e+00 -1.17319529e+00 -2.47583069e-01 -2.47583069e-01
 -2.47583069e-01  1.67110042e+00  6.25602921e+01  4.37829218e+02
  2.20517193e+03  1.13850808e+04  4.09792836e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.3529291907381  E_coul = 198.53031256906007
cycle= 5 E= -507.822616621678  delta_E= -1.59e-09  |g|= 6.87e-07  |ddm|= 0.000256
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.62862e-07
diis-c [-1.46133592e-14  1.18407693e-07 -1.23191946e-04  1.49953791e-03
 -1.89731420e-02  1.01759668e+00]
  HOMO = -0.247582676830391  LUMO = 1.67110073984794
  mo_energy =
[-1.20343332e+02 -1.23308647e+01 -6.68533703e+00 -6.68533703e+00
 -6.68533703e+00 -1.17319514e+00 -2.47582677e-01 -2.47582677e-01
 -2.47582677e-01  1.67110074e+00  6.25602936e+01  4.37829220e+02
  2.20517194e+03  1.13850808e+04  4.09792836e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.352931007282  E_coul = 198.53031438560365
cycle= 6 E= -507.822616621678  delta_E= -2.84e-13  |g|= 2.12e-08  |ddm|= 1.73e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.352931007282  E_coul = 198.53031438560365
  HOMO = -0.247582664825423  LUMO = 1.67110074232393
  mo_energy =
[-1.20343332e+02 -1.23308646e+01 -6.68533699e+00 -6.68533699e+00
 -6.68533699e+00 -1.17319513e+00 -2.47582665e-01 -2.47582665e-01
 -2.47582665e-01  1.67110074e+00  6.25602936e+01  4.37829220e+02
  2.20517194e+03  1.13850808e+04  4.09792836e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.352931062953  E_coul = 198.53031444127444
Extra cycle  E= -507.822616621679  delta_E= -2.27e-13  |g|= 2.6e-09  |ddm|= 5.2e-08
    CPU time for scf_cycle      4.88 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12523.22149893393
E1 = -706.352931062953  E_coul = 198.53031444127444
init E= -507.822616621679
    CPU time for initialize scf     10.23 sec, wall time      0.72 sec
  HOMO = -0.247582663486664  LUMO = 1.67110074296734
  mo_energy =
[-1.20343332e+02 -1.23308646e+01 -6.68533698e+00 -6.68533698e+00
 -6.68533698e+00 -1.17319513e+00 -2.47582663e-01 -2.47582663e-01
 -2.47582663e-01  1.67110074e+00  6.25602936e+01  4.37829220e+02
  2.20517194e+03  1.13850808e+04  4.09792836e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.3529310688849  E_coul = 198.53031444720665
cycle= 1 E= -507.822616621678  delta_E= 2.84e-13  |g|= 7.41e-10  |ddm|= 5.65e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.3529310688849  E_coul = 198.53031444720665
  HOMO = -0.247582663337189  LUMO = 1.67110074390435
  mo_energy =
[-1.20343332e+02 -1.23308646e+01 -6.68533698e+00 -6.68533698e+00
 -6.68533698e+00 -1.17319513e+00 -2.47582663e-01 -2.47582663e-01
 -2.47582663e-01  1.67110074e+00  6.25602936e+01  4.37829220e+02
  2.20517194e+03  1.13850808e+04  4.09792836e+04  1.09835649e+05
  2.54036931e+05  5.48468112e+05  1.15241692e+06  2.43020051e+06
  5.37493623e+06]
E1 = -706.3529310695708  E_coul = 198.53031444789238
Extra cycle  E= -507.822616621678  delta_E= -1.71e-13  |g|= 9.5e-10  |ddm|= 6.39e-10
    CPU time for scf_cycle     10.43 sec, wall time      0.79 sec
exp = [3.62909954e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180215e+03
 1.83771612e+04 1.23897776e+03 2.98190084e+02 8.84298845e+01
 3.06783626e+01 4.86593437e+00 6.95977183e-01 8.61231889e+00
 4.88729371e-01]
grad_E = [ 4.54197065e-02 -1.90016718e-11  4.15678555e-10  1.39654052e-09
  8.20039555e-09  2.70192328e-08  1.64588829e-07  9.01848314e-06
  4.07576507e-07  3.86595032e-06 -1.72948535e-05 -3.28890325e-05
 -9.06247964e-04 -6.53910572e-02 -7.15241785e-02  6.86677658e-03
 -1.36504035e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.388159889749       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.5079759        1
[INPUT] 0    0    [1    /1   ]  36755.2344722        1
[INPUT] 0    0    [1    /1   ]  7331.80213215        1
[INPUT] 0    0    [1    /1   ]  18377.1612166        1
[INPUT] 0    0    [1    /1   ]  1238.97775105        1
[INPUT] 0    0    [1    /1   ]  298.190135018        1
[INPUT] 0    0    [1    /1   ]  88.4297148227        1
[INPUT] 0    0    [1    /1   ]  30.6803820106        1
[INPUT] 0    0    [1    /1   ]  5.02939503303        1
[INPUT] 0    0    [1    /1   ]  0.755540382199       1
[INPUT] 1    0    [1    /1   ]  8.61048830555        1
[INPUT] 1    0    [1    /1   ]  0.489650296065       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3881598897488544, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032443, 1.0]], [0, [294042.03565161675, 1.0]], [0, [147021.01782577398, 1.0]], [0, [73510.50797590913, 1.0]], [0, [36755.234472195494, 1.0]], [0, [7331.802132151924, 1.0]], [0, [18377.161216642067, 1.0]], [0, [1238.9777510458857, 1.0]], [0, [298.1901350184979, 1.0]], [0, [88.42971482269613, 1.0]], [0, [30.680382010574707, 1.0]], [0, [5.029395033029855, 1.0]], [0, [0.7555403821991673, 1.0]], [1, [8.61048830554881, 1.0]], [1, [0.4896502960652028, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.38815989]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130324]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782577]
bas 5, expnt(s) = [73510.50797591]
bas 6, expnt(s) = [36755.2344722]
bas 7, expnt(s) = [7331.80213215]
bas 8, expnt(s) = [18377.16121664]
bas 9, expnt(s) = [1238.97775105]
bas 10, expnt(s) = [298.19013502]
bas 11, expnt(s) = [88.42971482]
bas 12, expnt(s) = [30.68038201]
bas 13, expnt(s) = [5.02939503]
bas 14, expnt(s) = [0.75554038]
bas 15, expnt(s) = [8.61048831]
bas 16, expnt(s) = [0.4896503]
CPU time:       134.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.88159890e-01 1.24243311e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180213e+03 2.00181102e+03
 1.83771612e+04 3.98771253e+03 1.23897775e+03 5.27609559e+02
 2.98190135e+02 1.81294646e+02 8.84297148e+01 7.28557264e+01
 3.06803820e+01 3.29352221e+01 5.02939503e+00 8.48499979e+00
 7.55540382e-01 2.04742634e+00 8.61048831e+00 4.30297793e+01
 4.89650296e-01 1.19492850e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32868400143062
cond(S) = 12523.50742387608
E1 = -689.1852652717733  E_coul = 184.86881893250015
init E= -504.316446339273
    CPU time for initialize scf      4.56 sec, wall time      0.34 sec
  HOMO = -0.68036461785561  LUMO = 1.40801124344215
  mo_energy =
[-1.21691474e+02 -1.33431174e+01 -7.62796767e+00 -7.62796767e+00
 -7.62796767e+00 -1.65548090e+00 -6.80364618e-01 -6.80364618e-01
 -6.80364618e-01  1.40801124e+00  6.23889230e+01  4.37423272e+02
  2.20469827e+03  1.13846258e+04  4.09788514e+04  1.09835230e+05
  2.54036523e+05  5.48467708e+05  1.15241652e+06  2.43020010e+06
  5.37493581e+06]
E1 = -707.4872682436193  E_coul = 199.67077306289823
cycle= 1 E= -507.816495180721  delta_E= -3.5  |g|= 0.434  |ddm|= 0.853
    CPU time for cycle= 1      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.557926
diis-c [-0.31128158  1.        ]
  HOMO = -0.222279253637197  LUMO = 1.92065780355049
  mo_energy =
[-1.20204691e+02 -1.22595274e+01 -6.59803423e+00 -6.59803423e+00
 -6.59803423e+00 -1.15477596e+00 -2.22279254e-01 -2.22279254e-01
 -2.22279254e-01  1.92065780e+00  6.37368746e+01  4.38896315e+02
  2.20611192e+03  1.13859123e+04  4.09800653e+04  1.09836405e+05
  2.54037670e+05  5.48468836e+05  1.15241763e+06  2.43020120e+06
  5.37493690e+06]
E1 = -706.6535996417721  E_coul = 198.8215176391439
cycle= 2 E= -507.832082002628  delta_E= -0.0156  |g|= 0.0319  |ddm|= 0.739
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0175815
diis-c [-2.84616720e-04  8.79614733e-03  9.91203853e-01]
  HOMO = -0.240878948430089  LUMO = 1.91048345088676
  mo_energy =
[-1.20303387e+02 -1.23187567e+01 -6.66334836e+00 -6.66334836e+00
 -6.66334836e+00 -1.16679237e+00 -2.40878948e-01 -2.40878948e-01
 -2.40878948e-01  1.91048345e+00  6.36615951e+01  4.38796968e+02
  2.20599708e+03  1.13857873e+04  4.09799369e+04  1.09836276e+05
  2.54037540e+05  5.48468705e+05  1.15241750e+06  2.43020107e+06
  5.37493677e+06]
E1 = -706.5701925677712  E_coul = 198.73793611230496
cycle= 3 E= -507.832256455466  delta_E= -0.000174  |g|= 0.00378  |ddm|= 0.0832
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00197098
diis-c [-7.75977076e-07 -1.23503551e-04 -1.12664529e-01  1.11278803e+00]
  HOMO = -0.243279078843573  LUMO = 1.90903838772996
  mo_energy =
[-1.20313987e+02 -1.23261490e+01 -6.67123931e+00 -6.67123931e+00
 -6.67123931e+00 -1.16823776e+00 -2.43279079e-01 -2.43279079e-01
 -2.43279079e-01  1.90903839e+00  6.36528506e+01  4.38786382e+02
  2.20598552e+03  1.13857752e+04  4.09799246e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.559322190935  E_coul = 198.72706316199282
cycle= 4 E= -507.832259028942  delta_E= -2.57e-06  |g|= 8.72e-05  |ddm|= 0.0111
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.90103e-05
diis-c [-5.53050777e-11 -5.47408453e-06  6.13134624e-03 -7.28133574e-02
  1.06668749e+00]
  HOMO = -0.243323747696403  LUMO = 1.90900977754713
  mo_energy =
[-1.20314110e+02 -1.23262761e+01 -6.67136234e+00 -6.67136234e+00
 -6.67136234e+00 -1.16826281e+00 -2.43323748e-01 -2.43323748e-01
 -2.43323748e-01  1.90900978e+00  6.36527289e+01  4.38786260e+02
  2.20598540e+03  1.13857750e+04  4.09799244e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.559117356729  E_coul = 198.72685832669882
cycle= 5 E= -507.83225903003  delta_E= -1.09e-09  |g|= 6.22e-07  |ddm|= 0.00022
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.45418e-07
diis-c [-1.54697324e-14  1.14337634e-07 -1.27440123e-04  1.53572918e-03
 -1.99199991e-02  1.01851160e+00]
  HOMO = -0.243323422733239  LUMO = 1.90901006998786
  mo_energy =
[-1.20314108e+02 -1.23262751e+01 -6.67136121e+00 -6.67136121e+00
 -6.67136121e+00 -1.16826269e+00 -2.43323423e-01 -2.43323423e-01
 -2.43323423e-01  1.90901007e+00  6.36527302e+01  4.38786261e+02
  2.20598540e+03  1.13857750e+04  4.09799244e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.5591188650284  E_coul = 198.72685983499798
cycle= 6 E= -507.83225903003  delta_E= -2.27e-13  |g|= 2e-08  |ddm|= 1.53e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.5591188650284  E_coul = 198.72685983499798
  HOMO = -0.243323411477733  LUMO = 1.90901007484167
  mo_energy =
[-1.20314108e+02 -1.23262750e+01 -6.67136117e+00 -6.67136117e+00
 -6.67136117e+00 -1.16826268e+00 -2.43323411e-01 -2.43323411e-01
 -2.43323411e-01  1.90901007e+00  6.36527302e+01  4.38786261e+02
  2.20598540e+03  1.13857750e+04  4.09799244e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.5591189150141  E_coul = 198.72685988498378
Extra cycle  E= -507.83225903003  delta_E= 1.14e-13  |g|= 2.36e-09  |ddm|= 4.95e-08
    CPU time for scf_cycle      4.66 sec, wall time      0.42 sec
exp = [3.88159890e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180213e+03
 1.83771612e+04 1.23897775e+03 2.98190135e+02 8.84297148e+01
 3.06803820e+01 5.02939503e+00 7.55540382e-01 8.61048831e+00
 4.89650296e-01]
E = -507.8322590300303
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.388159889749       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.5079759        1
[INPUT] 0    0    [1    /1   ]  36755.2344722        1
[INPUT] 0    0    [1    /1   ]  7331.80213215        1
[INPUT] 0    0    [1    /1   ]  18377.1612166        1
[INPUT] 0    0    [1    /1   ]  1238.97775105        1
[INPUT] 0    0    [1    /1   ]  298.190135018        1
[INPUT] 0    0    [1    /1   ]  88.4297148227        1
[INPUT] 0    0    [1    /1   ]  30.6803820106        1
[INPUT] 0    0    [1    /1   ]  5.02939503303        1
[INPUT] 0    0    [1    /1   ]  0.755540382199       1
[INPUT] 1    0    [1    /1   ]  8.61048830555        1
[INPUT] 1    0    [1    /1   ]  0.489650296065       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3881598897488544, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.0713032443, 1.0]], [0, [294042.03565161675, 1.0]], [0, [147021.01782577398, 1.0]], [0, [73510.50797590913, 1.0]], [0, [36755.234472195494, 1.0]], [0, [7331.802132151924, 1.0]], [0, [18377.161216642067, 1.0]], [0, [1238.9777510458857, 1.0]], [0, [298.1901350184979, 1.0]], [0, [88.42971482269613, 1.0]], [0, [30.680382010574707, 1.0]], [0, [5.029395033029855, 1.0]], [0, [0.7555403821991673, 1.0]], [1, [8.61048830554881, 1.0]], [1, [0.4896502960652028, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.38815989]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130324]
bas 3, expnt(s) = [294042.03565162]
bas 4, expnt(s) = [147021.01782577]
bas 5, expnt(s) = [73510.50797591]
bas 6, expnt(s) = [36755.2344722]
bas 7, expnt(s) = [7331.80213215]
bas 8, expnt(s) = [18377.16121664]
bas 9, expnt(s) = [1238.97775105]
bas 10, expnt(s) = [298.19013502]
bas 11, expnt(s) = [88.42971482]
bas 12, expnt(s) = [30.68038201]
bas 13, expnt(s) = [5.02939503]
bas 14, expnt(s) = [0.75554038]
bas 15, expnt(s) = [8.61048831]
bas 16, expnt(s) = [0.4896503]
CPU time:       139.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.88159890e-01 1.24243311e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180213e+03 2.00181102e+03
 1.83771612e+04 3.98771253e+03 1.23897775e+03 5.27609559e+02
 2.98190135e+02 1.81294646e+02 8.84297148e+01 7.28557264e+01
 3.06803820e+01 3.29352221e+01 5.02939503e+00 8.48499979e+00
 7.55540382e-01 2.04742634e+00 8.61048831e+00 4.30297793e+01
 4.89650296e-01 1.19492850e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32868400143062
cond(S) = 12523.50742387608
E1 = -689.1852652717733  E_coul = 184.86881893250015
init E= -504.316446339273
    CPU time for initialize scf      4.61 sec, wall time      0.34 sec
  HOMO = -0.68036461785561  LUMO = 1.40801124344215
  mo_energy =
[-1.21691474e+02 -1.33431174e+01 -7.62796767e+00 -7.62796767e+00
 -7.62796767e+00 -1.65548090e+00 -6.80364618e-01 -6.80364618e-01
 -6.80364618e-01  1.40801124e+00  6.23889230e+01  4.37423272e+02
  2.20469827e+03  1.13846258e+04  4.09788514e+04  1.09835230e+05
  2.54036523e+05  5.48467708e+05  1.15241652e+06  2.43020010e+06
  5.37493581e+06]
E1 = -707.4872682436193  E_coul = 199.67077306289823
cycle= 1 E= -507.816495180721  delta_E= -3.5  |g|= 0.434  |ddm|= 0.853
    CPU time for cycle= 1      0.19 sec, wall time      0.02 sec
diis-norm(errvec)=0.557926
diis-c [-0.31128158  1.        ]
  HOMO = -0.222279253637197  LUMO = 1.92065780355049
  mo_energy =
[-1.20204691e+02 -1.22595274e+01 -6.59803423e+00 -6.59803423e+00
 -6.59803423e+00 -1.15477596e+00 -2.22279254e-01 -2.22279254e-01
 -2.22279254e-01  1.92065780e+00  6.37368746e+01  4.38896315e+02
  2.20611192e+03  1.13859123e+04  4.09800653e+04  1.09836405e+05
  2.54037670e+05  5.48468836e+05  1.15241763e+06  2.43020120e+06
  5.37493690e+06]
E1 = -706.6535996417721  E_coul = 198.8215176391439
cycle= 2 E= -507.832082002628  delta_E= -0.0156  |g|= 0.0319  |ddm|= 0.739
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0175815
diis-c [-2.84616720e-04  8.79614733e-03  9.91203853e-01]
  HOMO = -0.240878948430089  LUMO = 1.91048345088676
  mo_energy =
[-1.20303387e+02 -1.23187567e+01 -6.66334836e+00 -6.66334836e+00
 -6.66334836e+00 -1.16679237e+00 -2.40878948e-01 -2.40878948e-01
 -2.40878948e-01  1.91048345e+00  6.36615951e+01  4.38796968e+02
  2.20599708e+03  1.13857873e+04  4.09799369e+04  1.09836276e+05
  2.54037540e+05  5.48468705e+05  1.15241750e+06  2.43020107e+06
  5.37493677e+06]
E1 = -706.5701925677712  E_coul = 198.73793611230496
cycle= 3 E= -507.832256455466  delta_E= -0.000174  |g|= 0.00378  |ddm|= 0.0832
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00197098
diis-c [-7.75977076e-07 -1.23503551e-04 -1.12664529e-01  1.11278803e+00]
  HOMO = -0.243279078843573  LUMO = 1.90903838772996
  mo_energy =
[-1.20313987e+02 -1.23261490e+01 -6.67123931e+00 -6.67123931e+00
 -6.67123931e+00 -1.16823776e+00 -2.43279079e-01 -2.43279079e-01
 -2.43279079e-01  1.90903839e+00  6.36528506e+01  4.38786382e+02
  2.20598552e+03  1.13857752e+04  4.09799246e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.559322190935  E_coul = 198.72706316199282
cycle= 4 E= -507.832259028942  delta_E= -2.57e-06  |g|= 8.72e-05  |ddm|= 0.0111
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.90103e-05
diis-c [-5.53050777e-11 -5.47408453e-06  6.13134624e-03 -7.28133574e-02
  1.06668749e+00]
  HOMO = -0.243323747696403  LUMO = 1.90900977754713
  mo_energy =
[-1.20314110e+02 -1.23262761e+01 -6.67136234e+00 -6.67136234e+00
 -6.67136234e+00 -1.16826281e+00 -2.43323748e-01 -2.43323748e-01
 -2.43323748e-01  1.90900978e+00  6.36527289e+01  4.38786260e+02
  2.20598540e+03  1.13857750e+04  4.09799244e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.559117356729  E_coul = 198.72685832669882
cycle= 5 E= -507.83225903003  delta_E= -1.09e-09  |g|= 6.22e-07  |ddm|= 0.00022
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.45418e-07
diis-c [-1.54697324e-14  1.14337634e-07 -1.27440123e-04  1.53572918e-03
 -1.99199991e-02  1.01851160e+00]
  HOMO = -0.243323422733239  LUMO = 1.90901006998786
  mo_energy =
[-1.20314108e+02 -1.23262751e+01 -6.67136121e+00 -6.67136121e+00
 -6.67136121e+00 -1.16826269e+00 -2.43323423e-01 -2.43323423e-01
 -2.43323423e-01  1.90901007e+00  6.36527302e+01  4.38786261e+02
  2.20598540e+03  1.13857750e+04  4.09799244e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.5591188650284  E_coul = 198.72685983499798
cycle= 6 E= -507.83225903003  delta_E= -2.27e-13  |g|= 2e-08  |ddm|= 1.53e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -706.5591188650284  E_coul = 198.72685983499798
  HOMO = -0.243323411477733  LUMO = 1.90901007484167
  mo_energy =
[-1.20314108e+02 -1.23262750e+01 -6.67136117e+00 -6.67136117e+00
 -6.67136117e+00 -1.16826268e+00 -2.43323411e-01 -2.43323411e-01
 -2.43323411e-01  1.90901007e+00  6.36527302e+01  4.38786261e+02
  2.20598540e+03  1.13857750e+04  4.09799244e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.5591189150141  E_coul = 198.72685988498378
Extra cycle  E= -507.83225903003  delta_E= 1.14e-13  |g|= 2.36e-09  |ddm|= 4.95e-08
    CPU time for scf_cycle      4.88 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12523.50742387608
E1 = -706.5591189150141  E_coul = 198.72685988498378
init E= -507.83225903003
    CPU time for initialize scf      9.58 sec, wall time      0.67 sec
  HOMO = -0.243323410314676  LUMO = 1.90901007639904
  mo_energy =
[-1.20314108e+02 -1.23262750e+01 -6.67136116e+00 -6.67136116e+00
 -6.67136116e+00 -1.16826268e+00 -2.43323410e-01 -2.43323410e-01
 -2.43323410e-01  1.90901008e+00  6.36527302e+01  4.38786261e+02
  2.20598540e+03  1.13857750e+04  4.09799244e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.5591189202997  E_coul = 198.72685989026942
cycle= 1 E= -507.83225903003  delta_E=    0  |g|= 1.15e-09  |ddm|= 5.35e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.5591189202997  E_coul = 198.72685989026942
  HOMO = -0.24332341018667  LUMO = 1.90901007572612
  mo_energy =
[-1.20314108e+02 -1.23262750e+01 -6.67136116e+00 -6.67136116e+00
 -6.67136116e+00 -1.16826268e+00 -2.43323410e-01 -2.43323410e-01
 -2.43323410e-01  1.90901008e+00  6.36527302e+01  4.38786261e+02
  2.20598540e+03  1.13857750e+04  4.09799244e+04  1.09836263e+05
  2.54037527e+05  5.48468692e+05  1.15241749e+06  2.43020106e+06
  5.37493676e+06]
E1 = -706.5591189209186  E_coul = 198.7268598908885
Extra cycle  E= -507.83225903003  delta_E= 1.14e-13  |g|= 1.1e-09  |ddm|= 6.45e-10
    CPU time for scf_cycle      9.78 sec, wall time      0.74 sec
exp = [3.88159890e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180213e+03
 1.83771612e+04 1.23897775e+03 2.98190135e+02 8.84297148e+01
 3.06803820e+01 5.02939503e+00 7.55540382e-01 8.61048831e+00
 4.89650296e-01]
grad_E = [ 5.47496202e-02 -1.89179704e-11  4.16828136e-10  1.40060975e-09
  8.22248920e-09  2.70962779e-08  1.65034156e-07  9.04804854e-06
  4.08785457e-07  1.46502922e-06  1.44629232e-05 -4.99993464e-04
 -4.90792794e-04 -9.53035249e-03 -9.00679090e-02  7.62221130e-03
 -9.85057978e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.409053525452       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.5079758        1
[INPUT] 0    0    [1    /1   ]  36755.2344717        1
[INPUT] 0    0    [1    /1   ]  7331.80210505        1
[INPUT] 0    0    [1    /1   ]  18377.1612154        1
[INPUT] 0    0    [1    /1   ]  1238.97774207        1
[INPUT] 0    0    [1    /1   ]  298.190150581        1
[INPUT] 0    0    [1    /1   ]  88.430312445         1
[INPUT] 0    0    [1    /1   ]  30.6824884154        1
[INPUT] 0    0    [1    /1   ]  5.15737228958        1
[INPUT] 0    0    [1    /1   ]  0.844163124921       1
[INPUT] 1    0    [1    /1   ]  8.60344867253        1
[INPUT] 1    0    [1    /1   ]  0.488334542805       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.40905352545236534, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.071303243, 1.0]], [0, [294042.03565161256, 1.0]], [0, [147021.01782574932, 1.0]], [0, [73510.50797582795, 1.0]], [0, [36755.234471700955, 1.0]], [0, [7331.8021050485995, 1.0]], [0, [18377.161215417254, 1.0]], [0, [1238.9777420740943, 1.0]], [0, [298.1901505812971, 1.0]], [0, [88.43031244500709, 1.0]], [0, [30.68248841539815, 1.0]], [0, [5.1573722895809935, 1.0]], [0, [0.844163124921261, 1.0]], [1, [8.603448672525564, 1.0]], [1, [0.48833454280517885, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.40905353]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130324]
bas 3, expnt(s) = [294042.03565161]
bas 4, expnt(s) = [147021.01782575]
bas 5, expnt(s) = [73510.50797583]
bas 6, expnt(s) = [36755.2344717]
bas 7, expnt(s) = [7331.80210505]
bas 8, expnt(s) = [18377.16121542]
bas 9, expnt(s) = [1238.97774207]
bas 10, expnt(s) = [298.19015058]
bas 11, expnt(s) = [88.43031245]
bas 12, expnt(s) = [30.68248842]
bas 13, expnt(s) = [5.15737229]
bas 14, expnt(s) = [0.84416312]
bas 15, expnt(s) = [8.60344867]
bas 16, expnt(s) = [0.48833454]
CPU time:       156.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.09053525e-01 1.29226068e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180211e+03 2.00181102e+03
 1.83771612e+04 3.98771253e+03 1.23897774e+03 5.27609556e+02
 2.98190151e+02 1.81294653e+02 8.84303124e+01 7.28560957e+01
 3.06824884e+01 3.29369180e+01 5.15737229e+00 8.64642117e+00
 8.44163125e-01 2.22502455e+00 8.60344867e+00 4.29858093e+01
 4.88334543e-01 1.19091619e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.328052228618805
cond(S) = 12523.790658962034
E1 = -689.1442073137943  E_coul = 184.80298267148615
init E= -504.341224642308
    CPU time for initialize scf      4.53 sec, wall time      0.34 sec
  HOMO = -0.6817006301821  LUMO = 1.66809470531471
  mo_energy =
[-1.21700713e+02 -1.33547448e+01 -7.63208816e+00 -7.63208816e+00
 -7.63208816e+00 -1.65521076e+00 -6.81700630e-01 -6.81700630e-01
 -6.81700630e-01  1.66809471e+00  6.34132456e+01  4.38295623e+02
  2.20542857e+03  1.13852392e+04  4.09794130e+04  1.09835767e+05
  2.54037041e+05  5.48468211e+05  1.15241700e+06  2.43020057e+06
  5.37493627e+06]
E1 = -707.4719191952514  E_coul = 199.6487387134358
cycle= 1 E= -507.823180481816  delta_E= -3.48  |g|= 0.436  |ddm|= 0.833
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.560707
diis-c [-0.31439215  1.        ]
  HOMO = -0.224177402094177  LUMO = 2.2116286806248
  mo_energy =
[-1.20202778e+02 -1.22684693e+01 -6.59869283e+00 -6.59869283e+00
 -6.59869283e+00 -1.15426795e+00 -2.24177402e-01 -2.24177402e-01
 -2.24177402e-01  2.21162868e+00  6.47659559e+01  4.39779832e+02
  2.20685653e+03  1.13865423e+04  4.09806441e+04  1.09836959e+05
  2.54038206e+05  5.48469356e+05  1.15241814e+06  2.43020169e+06
  5.37493738e+06]
E1 = -706.6591336313734  E_coul = 198.82082542818702
cycle= 2 E= -507.838308203186  delta_E= -0.0151  |g|= 0.0311  |ddm|= 0.701
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0177245
diis-c [-2.87392688e-04  9.14669204e-03  9.90853308e-01]
  HOMO = -0.241565716051911  LUMO = 2.2007017120488
  mo_energy =
[-1.20300981e+02 -1.23260403e+01 -6.66261514e+00 -6.66261514e+00
 -6.66261514e+00 -1.16545150e+00 -2.41565716e-01 -2.41565716e-01
 -2.41565716e-01  2.20070171e+00  6.46914713e+01  4.39680968e+02
  2.20674182e+03  1.13864171e+04  4.09805155e+04  1.09836829e+05
  2.54038076e+05  5.48469225e+05  1.15241800e+06  2.43020156e+06
  5.37493725e+06]
E1 = -706.5830908944715  E_coul = 198.74463275720962
cycle= 3 E= -507.838458137262  delta_E= -0.00015  |g|= 0.00352  |ddm|= 0.074
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00191406
diis-c [-7.58600574e-07 -9.10307697e-05 -1.07343998e-01  1.10743503e+00]
  HOMO = -0.243678369199802  LUMO = 2.19926653926129
  mo_energy =
[-1.20310890e+02 -1.23327960e+01 -6.66986794e+00 -6.66986794e+00
 -6.66986794e+00 -1.16672039e+00 -2.43678369e-01 -2.43678369e-01
 -2.43678369e-01  2.19926654e+00  6.46833626e+01  4.39671073e+02
  2.20673098e+03  1.13864057e+04  4.09805039e+04  1.09836817e+05
  2.54038064e+05  5.48469213e+05  1.15241799e+06  2.43020155e+06
  5.37493724e+06]
E1 = -706.5737289916598  E_coul = 198.7352688406155
cycle= 4 E= -507.838460151044  delta_E= -2.01e-06  |g|= 7.96e-05  |ddm|= 0.00938
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.79034e-05
diis-c [-5.18017101e-11 -4.87855710e-06  6.04430121e-03 -7.32921600e-02
  1.06725274e+00]
  HOMO = -0.243714849791602  LUMO = 2.19924090131773
  mo_energy =
[-1.20310987e+02 -1.23329021e+01 -6.66996926e+00 -6.66996926e+00
 -6.66996926e+00 -1.16674092e+00 -2.43714850e-01 -2.43714850e-01
 -2.43714850e-01  2.19924090e+00  6.46832643e+01  4.39670976e+02
  2.20673088e+03  1.13864056e+04  4.09805038e+04  1.09836817e+05
  2.54038064e+05  5.48469213e+05  1.15241799e+06  2.43020155e+06
  5.37493724e+06]
E1 = -706.5735652946212  E_coul = 198.73510514278652
cycle= 5 E= -507.838460151835  delta_E= -7.9e-10  |g|= 5.27e-07  |ddm|= 0.000176
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5735652946212  E_coul = 198.73510514278652
  HOMO = -0.243714628672552  LUMO = 2.19924113150804
  mo_energy =
[-1.20310986e+02 -1.23329013e+01 -6.66996844e+00 -6.66996844e+00
 -6.66996844e+00 -1.16674084e+00 -2.43714629e-01 -2.43714629e-01
 -2.43714629e-01  2.19924113e+00  6.46832652e+01  4.39670977e+02
  2.20673088e+03  1.13864056e+04  4.09805038e+04  1.09836817e+05
  2.54038064e+05  5.48469213e+05  1.15241799e+06  2.43020155e+06
  5.37493724e+06]
E1 = -706.5735663334226  E_coul = 198.73510618158815
Extra cycle  E= -507.838460151834  delta_E= 1.71e-13  |g|= 4.25e-08  |ddm|= 1.01e-06
    CPU time for scf_cycle      4.75 sec, wall time      0.41 sec
exp = [4.09053525e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180211e+03
 1.83771612e+04 1.23897774e+03 2.98190151e+02 8.84303124e+01
 3.06824884e+01 5.15737229e+00 8.44163125e-01 8.60344867e+00
 4.88334543e-01]
E = -507.83846015183445
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.409053525452       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.5079758        1
[INPUT] 0    0    [1    /1   ]  36755.2344717        1
[INPUT] 0    0    [1    /1   ]  7331.80210505        1
[INPUT] 0    0    [1    /1   ]  18377.1612154        1
[INPUT] 0    0    [1    /1   ]  1238.97774207        1
[INPUT] 0    0    [1    /1   ]  298.190150581        1
[INPUT] 0    0    [1    /1   ]  88.430312445         1
[INPUT] 0    0    [1    /1   ]  30.6824884154        1
[INPUT] 0    0    [1    /1   ]  5.15737228958        1
[INPUT] 0    0    [1    /1   ]  0.844163124921       1
[INPUT] 1    0    [1    /1   ]  8.60344867253        1
[INPUT] 1    0    [1    /1   ]  0.488334542805       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.40905352545236534, 1.0]], [0, [1176168.1426064924, 1.0]], [0, [588084.071303243, 1.0]], [0, [294042.03565161256, 1.0]], [0, [147021.01782574932, 1.0]], [0, [73510.50797582795, 1.0]], [0, [36755.234471700955, 1.0]], [0, [7331.8021050485995, 1.0]], [0, [18377.161215417254, 1.0]], [0, [1238.9777420740943, 1.0]], [0, [298.1901505812971, 1.0]], [0, [88.43031244500709, 1.0]], [0, [30.68248841539815, 1.0]], [0, [5.1573722895809935, 1.0]], [0, [0.844163124921261, 1.0]], [1, [8.603448672525564, 1.0]], [1, [0.48833454280517885, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.40905353]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130324]
bas 3, expnt(s) = [294042.03565161]
bas 4, expnt(s) = [147021.01782575]
bas 5, expnt(s) = [73510.50797583]
bas 6, expnt(s) = [36755.2344717]
bas 7, expnt(s) = [7331.80210505]
bas 8, expnt(s) = [18377.16121542]
bas 9, expnt(s) = [1238.97774207]
bas 10, expnt(s) = [298.19015058]
bas 11, expnt(s) = [88.43031245]
bas 12, expnt(s) = [30.68248842]
bas 13, expnt(s) = [5.15737229]
bas 14, expnt(s) = [0.84416312]
bas 15, expnt(s) = [8.60344867]
bas 16, expnt(s) = [0.48833454]
CPU time:       161.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.09053525e-01 1.29226068e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180211e+03 2.00181102e+03
 1.83771612e+04 3.98771253e+03 1.23897774e+03 5.27609556e+02
 2.98190151e+02 1.81294653e+02 8.84303124e+01 7.28560957e+01
 3.06824884e+01 3.29369180e+01 5.15737229e+00 8.64642117e+00
 8.44163125e-01 2.22502455e+00 8.60344867e+00 4.29858093e+01
 4.88334543e-01 1.19091619e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.328052228618805
cond(S) = 12523.790658962034
E1 = -689.1442073137943  E_coul = 184.80298267148615
init E= -504.341224642308
    CPU time for initialize scf      4.60 sec, wall time      0.35 sec
  HOMO = -0.6817006301821  LUMO = 1.66809470531471
  mo_energy =
[-1.21700713e+02 -1.33547448e+01 -7.63208816e+00 -7.63208816e+00
 -7.63208816e+00 -1.65521076e+00 -6.81700630e-01 -6.81700630e-01
 -6.81700630e-01  1.66809471e+00  6.34132456e+01  4.38295623e+02
  2.20542857e+03  1.13852392e+04  4.09794130e+04  1.09835767e+05
  2.54037041e+05  5.48468211e+05  1.15241700e+06  2.43020057e+06
  5.37493627e+06]
E1 = -707.4719191952514  E_coul = 199.6487387134358
cycle= 1 E= -507.823180481816  delta_E= -3.48  |g|= 0.436  |ddm|= 0.833
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.560707
diis-c [-0.31439215  1.        ]
  HOMO = -0.224177402094177  LUMO = 2.2116286806248
  mo_energy =
[-1.20202778e+02 -1.22684693e+01 -6.59869283e+00 -6.59869283e+00
 -6.59869283e+00 -1.15426795e+00 -2.24177402e-01 -2.24177402e-01
 -2.24177402e-01  2.21162868e+00  6.47659559e+01  4.39779832e+02
  2.20685653e+03  1.13865423e+04  4.09806441e+04  1.09836959e+05
  2.54038206e+05  5.48469356e+05  1.15241814e+06  2.43020169e+06
  5.37493738e+06]
E1 = -706.6591336313734  E_coul = 198.82082542818702
cycle= 2 E= -507.838308203186  delta_E= -0.0151  |g|= 0.0311  |ddm|= 0.701
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0177245
diis-c [-2.87392688e-04  9.14669204e-03  9.90853308e-01]
  HOMO = -0.241565716051911  LUMO = 2.2007017120488
  mo_energy =
[-1.20300981e+02 -1.23260403e+01 -6.66261514e+00 -6.66261514e+00
 -6.66261514e+00 -1.16545150e+00 -2.41565716e-01 -2.41565716e-01
 -2.41565716e-01  2.20070171e+00  6.46914713e+01  4.39680968e+02
  2.20674182e+03  1.13864171e+04  4.09805155e+04  1.09836829e+05
  2.54038076e+05  5.48469225e+05  1.15241800e+06  2.43020156e+06
  5.37493725e+06]
E1 = -706.5830908944715  E_coul = 198.74463275720962
cycle= 3 E= -507.838458137262  delta_E= -0.00015  |g|= 0.00352  |ddm|= 0.074
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00191406
diis-c [-7.58600574e-07 -9.10307697e-05 -1.07343998e-01  1.10743503e+00]
  HOMO = -0.243678369199802  LUMO = 2.19926653926129
  mo_energy =
[-1.20310890e+02 -1.23327960e+01 -6.66986794e+00 -6.66986794e+00
 -6.66986794e+00 -1.16672039e+00 -2.43678369e-01 -2.43678369e-01
 -2.43678369e-01  2.19926654e+00  6.46833626e+01  4.39671073e+02
  2.20673098e+03  1.13864057e+04  4.09805039e+04  1.09836817e+05
  2.54038064e+05  5.48469213e+05  1.15241799e+06  2.43020155e+06
  5.37493724e+06]
E1 = -706.5737289916598  E_coul = 198.7352688406155
cycle= 4 E= -507.838460151044  delta_E= -2.01e-06  |g|= 7.96e-05  |ddm|= 0.00938
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.79034e-05
diis-c [-5.18017101e-11 -4.87855710e-06  6.04430121e-03 -7.32921600e-02
  1.06725274e+00]
  HOMO = -0.243714849791602  LUMO = 2.19924090131773
  mo_energy =
[-1.20310987e+02 -1.23329021e+01 -6.66996926e+00 -6.66996926e+00
 -6.66996926e+00 -1.16674092e+00 -2.43714850e-01 -2.43714850e-01
 -2.43714850e-01  2.19924090e+00  6.46832643e+01  4.39670976e+02
  2.20673088e+03  1.13864056e+04  4.09805038e+04  1.09836817e+05
  2.54038064e+05  5.48469213e+05  1.15241799e+06  2.43020155e+06
  5.37493724e+06]
E1 = -706.5735652946212  E_coul = 198.73510514278652
cycle= 5 E= -507.838460151835  delta_E= -7.9e-10  |g|= 5.27e-07  |ddm|= 0.000176
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5735652946212  E_coul = 198.73510514278652
  HOMO = -0.243714628672552  LUMO = 2.19924113150804
  mo_energy =
[-1.20310986e+02 -1.23329013e+01 -6.66996844e+00 -6.66996844e+00
 -6.66996844e+00 -1.16674084e+00 -2.43714629e-01 -2.43714629e-01
 -2.43714629e-01  2.19924113e+00  6.46832652e+01  4.39670977e+02
  2.20673088e+03  1.13864056e+04  4.09805038e+04  1.09836817e+05
  2.54038064e+05  5.48469213e+05  1.15241799e+06  2.43020155e+06
  5.37493724e+06]
E1 = -706.5735663334226  E_coul = 198.73510618158815
Extra cycle  E= -507.838460151834  delta_E= 1.71e-13  |g|= 4.25e-08  |ddm|= 1.01e-06
    CPU time for scf_cycle      4.87 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12523.790658962034
E1 = -706.5735663334226  E_coul = 198.73510618158815
init E= -507.838460151834
    CPU time for initialize scf     10.11 sec, wall time      0.68 sec
  HOMO = -0.243714605367889  LUMO = 2.1992411479553
  mo_energy =
[-1.20310986e+02 -1.23329013e+01 -6.66996835e+00 -6.66996835e+00
 -6.66996835e+00 -1.16674083e+00 -2.43714605e-01 -2.43714605e-01
 -2.43714605e-01  2.19924115e+00  6.46832653e+01  4.39670977e+02
  2.20673088e+03  1.13864056e+04  4.09805038e+04  1.09836817e+05
  2.54038064e+05  5.48469213e+05  1.15241799e+06  2.43020155e+06
  5.37493724e+06]
E1 = -706.5735664369539  E_coul = 198.7351062851195
cycle= 1 E= -507.838460151834  delta_E= 5.68e-14  |g|= 4.49e-09  |ddm|= 1.03e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
E1 = -706.5735664369539  E_coul = 198.7351062851195
  HOMO = -0.243714602953904  LUMO = 2.19924114963115
  mo_energy =
[-1.20310986e+02 -1.23329013e+01 -6.66996835e+00 -6.66996835e+00
 -6.66996835e+00 -1.16674083e+00 -2.43714603e-01 -2.43714603e-01
 -2.43714603e-01  2.19924115e+00  6.46832653e+01  4.39670977e+02
  2.20673088e+03  1.13864056e+04  4.09805038e+04  1.09836817e+05
  2.54038064e+05  5.48469213e+05  1.15241799e+06  2.43020155e+06
  5.37493724e+06]
E1 = -706.5735664476332  E_coul = 198.7351062957983
Extra cycle  E= -507.838460151835  delta_E= -5.12e-13  |g|= 1.02e-09  |ddm|= 1.08e-08
    CPU time for scf_cycle     10.20 sec, wall time      0.75 sec
exp = [4.09053525e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180211e+03
 1.83771612e+04 1.23897774e+03 2.98190151e+02 8.84303124e+01
 3.06824884e+01 5.15737229e+00 8.44163125e-01 8.60344867e+00
 4.88334543e-01]
grad_E = [ 8.99588979e-02 -1.88716803e-11  4.17462216e-10  1.40284872e-09
  8.23467180e-09  2.71386449e-08  1.65279909e-07  9.06455819e-06
  4.09447339e-07  7.67261741e-08  3.27534179e-05 -7.77398058e-04
 -2.44232008e-04  1.49703688e-02 -9.53523835e-02  4.44172643e-03
 -1.37499190e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:25:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.417183100634       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.5079756        1
[INPUT] 0    0    [1    /1   ]  36755.2344705        1
[INPUT] 0    0    [1    /1   ]  7331.80204096        1
[INPUT] 0    0    [1    /1   ]  18377.1612125        1
[INPUT] 0    0    [1    /1   ]  1238.9777256         1
[INPUT] 0    0    [1    /1   ]  298.190125681        1
[INPUT] 0    0    [1    /1   ]  88.4326652804        1
[INPUT] 0    0    [1    /1   ]  30.6866947846        1
[INPUT] 0    0    [1    /1   ]  5.36634648813        1
[INPUT] 0    0    [1    /1   ]  1.03182426708        1
[INPUT] 1    0    [1    /1   ]  8.5925158076         1
[INPUT] 1    0    [1    /1   ]  0.486883884064       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.4171831006342886, 1.0]], [0, [1176168.1426064926, 1.0]], [0, [588084.0713032401, 1.0]], [0, [294042.03565160267, 1.0]], [0, [147021.01782569106, 1.0]], [0, [73510.50797563599, 1.0]], [0, [36755.234470531774, 1.0]], [0, [7331.802040961459, 1.0]], [0, [18377.161212521423, 1.0]], [0, [1238.9777256006735, 1.0]], [0, [298.190125681431, 1.0]], [0, [88.43266528038285, 1.0]], [0, [30.68669478462246, 1.0]], [0, [5.366346488131412, 1.0]], [0, [1.0318242670802056, 1.0]], [1, [8.592515807603343, 1.0]], [1, [0.48688388406399297, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.4171831]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130324]
bas 3, expnt(s) = [294042.0356516]
bas 4, expnt(s) = [147021.01782569]
bas 5, expnt(s) = [73510.50797564]
bas 6, expnt(s) = [36755.23447053]
bas 7, expnt(s) = [7331.80204096]
bas 8, expnt(s) = [18377.16121252]
bas 9, expnt(s) = [1238.9777256]
bas 10, expnt(s) = [298.19012568]
bas 11, expnt(s) = [88.43266528]
bas 12, expnt(s) = [30.68669478]
bas 13, expnt(s) = [5.36634649]
bas 14, expnt(s) = [1.03182427]
bas 15, expnt(s) = [8.59251581]
bas 16, expnt(s) = [0.48688388]
CPU time:       179.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.17183101e-01 1.31147512e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180204e+03 2.00181100e+03
 1.83771612e+04 3.98771253e+03 1.23897773e+03 5.27609550e+02
 2.98190126e+02 1.81294641e+02 8.84326653e+01 7.28575495e+01
 3.06866948e+01 3.29403045e+01 5.36634649e+00 8.90787383e+00
 1.03182427e+00 2.58654077e+00 8.59251581e+00 4.29175397e+01
 4.86883884e-01 1.18649563e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32860144988442
cond(S) = 12524.281490577569
E1 = -689.106995165785  E_coul = 184.73931418657676
init E= -504.367680979208
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.682392521668944  LUMO = 2.11901238069345
  mo_energy =
[-1.21712244e+02 -1.33684368e+01 -7.63573450e+00 -7.63573450e+00
 -7.63573450e+00 -1.65400251e+00 -6.82392522e-01 -6.82392522e-01
 -6.82392522e-01  2.11901238e+00  6.51678153e+01  4.39806007e+02
  2.20669751e+03  1.13863066e+04  4.09803906e+04  1.09836700e+05
  2.54037944e+05  5.48469087e+05  1.15241786e+06  2.43020140e+06
  5.37493707e+06]
E1 = -707.3782584574211  E_coul = 199.54293473263857
cycle= 1 E= -507.835323724783  delta_E= -3.47  |g|= 0.441  |ddm|= 0.642
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.569486
diis-c [-0.32431461  1.        ]
  HOMO = -0.228301150144893  LUMO = 2.70870635208737
  mo_energy =
[-1.20209487e+02 -1.22861732e+01 -6.60559574e+00 -6.60559574e+00
 -6.60559574e+00 -1.15558104e+00 -2.28301150e-01 -2.28301150e-01
 -2.28301150e-01  2.70870635e+00  6.65183171e+01  4.41294947e+02
  2.20813357e+03  1.13876201e+04  4.09816329e+04  1.09837904e+05
  2.54039120e+05  5.48470244e+05  1.15241900e+06  2.43020253e+06
  5.37493819e+06]
E1 = -706.5937075234032  E_coul = 198.74374901320752
cycle= 2 E= -507.849958510196  delta_E= -0.0146  |g|= 0.0299  |ddm|= 0.55
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0185196
diis-c [-3.17650503e-04  8.76347384e-03  9.91236526e-01]
  HOMO = -0.24406973174999  LUMO = 2.69655658240501
  mo_energy =
[-1.20307310e+02 -1.23414960e+01 -6.66767482e+00 -6.66767482e+00
 -6.66767482e+00 -1.16561186e+00 -2.44069732e-01 -2.44069732e-01
 -2.44069732e-01  2.69655658e+00  6.64447082e+01  4.41196449e+02
  2.20801867e+03  1.13874944e+04  4.09815036e+04  1.09837773e+05
  2.54038989e+05  5.48470112e+05  1.15241887e+06  2.43020240e+06
  5.37493806e+06]
E1 = -706.527734769752  E_coul = 198.67765737292672
cycle= 3 E= -507.850077396825  delta_E= -0.000119  |g|= 0.0031  |ddm|= 0.052
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.00185804
diis-c [-7.23793029e-07 -3.56511223e-05 -9.83303212e-02  1.09836597e+00]
  HOMO = -0.245793298653527  LUMO = 2.69515386720651
  mo_energy =
[-1.20316164e+02 -1.23473248e+01 -6.67398982e+00 -6.67398982e+00
 -6.67398982e+00 -1.16663771e+00 -2.45793299e-01 -2.45793299e-01
 -2.45793299e-01  2.69515387e+00  6.64375449e+01  4.41187610e+02
  2.20800893e+03  1.13874841e+04  4.09814932e+04  1.09837763e+05
  2.54038979e+05  5.48470102e+05  1.15241886e+06  2.43020239e+06
  5.37493805e+06]
E1 = -706.5204085159032  E_coul = 198.6703297747185
cycle= 4 E= -507.850078741185  delta_E= -1.34e-06  |g|= 6.83e-05  |ddm|= 0.00598
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.58352e-05
diis-c [-4.50820959e-11 -4.06364270e-06  5.74786941e-03 -7.31905546e-02
  1.06744675e+00]
  HOMO = -0.245819651918926  LUMO = 2.6951327280651
  mo_energy =
[-1.20316229e+02 -1.23474036e+01 -6.67406317e+00 -6.67406317e+00
 -6.67406317e+00 -1.16665258e+00 -2.45819652e-01 -2.45819652e-01
 -2.45819652e-01  2.69513273e+00  6.64374764e+01  4.41187546e+02
  2.20800887e+03  1.13874841e+04  4.09814931e+04  1.09837763e+05
  2.54038978e+05  5.48470102e+05  1.15241886e+06  2.43020239e+06
  5.37493805e+06]
E1 = -706.5202960150732  E_coul = 198.67021727341617
cycle= 5 E= -507.850078741657  delta_E= -4.72e-10  |g|= 3.8e-07  |ddm|= 0.000103
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5202960150732  E_coul = 198.67021727341617
  HOMO = -0.245819542373068  LUMO = 2.69513287421518
  mo_energy =
[-1.20316228e+02 -1.23474032e+01 -6.67406271e+00 -6.67406271e+00
 -6.67406271e+00 -1.16665255e+00 -2.45819542e-01 -2.45819542e-01
 -2.45819542e-01  2.69513287e+00  6.64374770e+01  4.41187546e+02
  2.20800887e+03  1.13874841e+04  4.09814931e+04  1.09837763e+05
  2.54038978e+05  5.48470102e+05  1.15241886e+06  2.43020239e+06
  5.37493805e+06]
E1 = -706.5202965511533  E_coul = 198.6702178094963
Extra cycle  E= -507.850078741657  delta_E= 1.14e-13  |g|= 2.23e-08  |ddm|= 4.15e-07
    CPU time for scf_cycle      5.04 sec, wall time      0.40 sec
exp = [4.17183101e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180204e+03
 1.83771612e+04 1.23897773e+03 2.98190126e+02 8.84326653e+01
 3.06866948e+01 5.36634649e+00 1.03182427e+00 8.59251581e+00
 4.86883884e-01]
E = -507.85007874165694
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.417183100634       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017826        1
[INPUT] 0    0    [1    /1   ]  73510.5079756        1
[INPUT] 0    0    [1    /1   ]  36755.2344705        1
[INPUT] 0    0    [1    /1   ]  7331.80204096        1
[INPUT] 0    0    [1    /1   ]  18377.1612125        1
[INPUT] 0    0    [1    /1   ]  1238.9777256         1
[INPUT] 0    0    [1    /1   ]  298.190125681        1
[INPUT] 0    0    [1    /1   ]  88.4326652804        1
[INPUT] 0    0    [1    /1   ]  30.6866947846        1
[INPUT] 0    0    [1    /1   ]  5.36634648813        1
[INPUT] 0    0    [1    /1   ]  1.03182426708        1
[INPUT] 1    0    [1    /1   ]  8.5925158076         1
[INPUT] 1    0    [1    /1   ]  0.486883884064       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.4171831006342886, 1.0]], [0, [1176168.1426064926, 1.0]], [0, [588084.0713032401, 1.0]], [0, [294042.03565160267, 1.0]], [0, [147021.01782569106, 1.0]], [0, [73510.50797563599, 1.0]], [0, [36755.234470531774, 1.0]], [0, [7331.802040961459, 1.0]], [0, [18377.161212521423, 1.0]], [0, [1238.9777256006735, 1.0]], [0, [298.190125681431, 1.0]], [0, [88.43266528038285, 1.0]], [0, [30.68669478462246, 1.0]], [0, [5.366346488131412, 1.0]], [0, [1.0318242670802056, 1.0]], [1, [8.592515807603343, 1.0]], [1, [0.48688388406399297, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.4171831]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130324]
bas 3, expnt(s) = [294042.0356516]
bas 4, expnt(s) = [147021.01782569]
bas 5, expnt(s) = [73510.50797564]
bas 6, expnt(s) = [36755.23447053]
bas 7, expnt(s) = [7331.80204096]
bas 8, expnt(s) = [18377.16121252]
bas 9, expnt(s) = [1238.9777256]
bas 10, expnt(s) = [298.19012568]
bas 11, expnt(s) = [88.43266528]
bas 12, expnt(s) = [30.68669478]
bas 13, expnt(s) = [5.36634649]
bas 14, expnt(s) = [1.03182427]
bas 15, expnt(s) = [8.59251581]
bas 16, expnt(s) = [0.48688388]
CPU time:       184.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.17183101e-01 1.31147512e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180204e+03 2.00181100e+03
 1.83771612e+04 3.98771253e+03 1.23897773e+03 5.27609550e+02
 2.98190126e+02 1.81294641e+02 8.84326653e+01 7.28575495e+01
 3.06866948e+01 3.29403045e+01 5.36634649e+00 8.90787383e+00
 1.03182427e+00 2.58654077e+00 8.59251581e+00 4.29175397e+01
 4.86883884e-01 1.18649563e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32860144988442
cond(S) = 12524.281490577569
E1 = -689.106995165785  E_coul = 184.73931418657676
init E= -504.367680979208
    CPU time for initialize scf      4.80 sec, wall time      0.34 sec
  HOMO = -0.682392521668944  LUMO = 2.11901238069345
  mo_energy =
[-1.21712244e+02 -1.33684368e+01 -7.63573450e+00 -7.63573450e+00
 -7.63573450e+00 -1.65400251e+00 -6.82392522e-01 -6.82392522e-01
 -6.82392522e-01  2.11901238e+00  6.51678153e+01  4.39806007e+02
  2.20669751e+03  1.13863066e+04  4.09803906e+04  1.09836700e+05
  2.54037944e+05  5.48469087e+05  1.15241786e+06  2.43020140e+06
  5.37493707e+06]
E1 = -707.3782584574211  E_coul = 199.54293473263857
cycle= 1 E= -507.835323724783  delta_E= -3.47  |g|= 0.441  |ddm|= 0.642
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.569486
diis-c [-0.32431461  1.        ]
  HOMO = -0.228301150144893  LUMO = 2.70870635208737
  mo_energy =
[-1.20209487e+02 -1.22861732e+01 -6.60559574e+00 -6.60559574e+00
 -6.60559574e+00 -1.15558104e+00 -2.28301150e-01 -2.28301150e-01
 -2.28301150e-01  2.70870635e+00  6.65183171e+01  4.41294947e+02
  2.20813357e+03  1.13876201e+04  4.09816329e+04  1.09837904e+05
  2.54039120e+05  5.48470244e+05  1.15241900e+06  2.43020253e+06
  5.37493819e+06]
E1 = -706.5937075234032  E_coul = 198.74374901320752
cycle= 2 E= -507.849958510196  delta_E= -0.0146  |g|= 0.0299  |ddm|= 0.55
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0185196
diis-c [-3.17650503e-04  8.76347384e-03  9.91236526e-01]
  HOMO = -0.24406973174999  LUMO = 2.69655658240501
  mo_energy =
[-1.20307310e+02 -1.23414960e+01 -6.66767482e+00 -6.66767482e+00
 -6.66767482e+00 -1.16561186e+00 -2.44069732e-01 -2.44069732e-01
 -2.44069732e-01  2.69655658e+00  6.64447082e+01  4.41196449e+02
  2.20801867e+03  1.13874944e+04  4.09815036e+04  1.09837773e+05
  2.54038989e+05  5.48470112e+05  1.15241887e+06  2.43020240e+06
  5.37493806e+06]
E1 = -706.527734769752  E_coul = 198.67765737292672
cycle= 3 E= -507.850077396825  delta_E= -0.000119  |g|= 0.0031  |ddm|= 0.052
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.00185804
diis-c [-7.23793029e-07 -3.56511223e-05 -9.83303212e-02  1.09836597e+00]
  HOMO = -0.245793298653527  LUMO = 2.69515386720651
  mo_energy =
[-1.20316164e+02 -1.23473248e+01 -6.67398982e+00 -6.67398982e+00
 -6.67398982e+00 -1.16663771e+00 -2.45793299e-01 -2.45793299e-01
 -2.45793299e-01  2.69515387e+00  6.64375449e+01  4.41187610e+02
  2.20800893e+03  1.13874841e+04  4.09814932e+04  1.09837763e+05
  2.54038979e+05  5.48470102e+05  1.15241886e+06  2.43020239e+06
  5.37493805e+06]
E1 = -706.5204085159032  E_coul = 198.6703297747185
cycle= 4 E= -507.850078741185  delta_E= -1.34e-06  |g|= 6.83e-05  |ddm|= 0.00598
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.58352e-05
diis-c [-4.50820959e-11 -4.06364270e-06  5.74786941e-03 -7.31905546e-02
  1.06744675e+00]
  HOMO = -0.245819651918926  LUMO = 2.6951327280651
  mo_energy =
[-1.20316229e+02 -1.23474036e+01 -6.67406317e+00 -6.67406317e+00
 -6.67406317e+00 -1.16665258e+00 -2.45819652e-01 -2.45819652e-01
 -2.45819652e-01  2.69513273e+00  6.64374764e+01  4.41187546e+02
  2.20800887e+03  1.13874841e+04  4.09814931e+04  1.09837763e+05
  2.54038978e+05  5.48470102e+05  1.15241886e+06  2.43020239e+06
  5.37493805e+06]
E1 = -706.5202960150732  E_coul = 198.67021727341617
cycle= 5 E= -507.850078741657  delta_E= -4.72e-10  |g|= 3.8e-07  |ddm|= 0.000103
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5202960150732  E_coul = 198.67021727341617
  HOMO = -0.245819542373068  LUMO = 2.69513287421518
  mo_energy =
[-1.20316228e+02 -1.23474032e+01 -6.67406271e+00 -6.67406271e+00
 -6.67406271e+00 -1.16665255e+00 -2.45819542e-01 -2.45819542e-01
 -2.45819542e-01  2.69513287e+00  6.64374770e+01  4.41187546e+02
  2.20800887e+03  1.13874841e+04  4.09814931e+04  1.09837763e+05
  2.54038978e+05  5.48470102e+05  1.15241886e+06  2.43020239e+06
  5.37493805e+06]
E1 = -706.5202965511533  E_coul = 198.6702178094963
Extra cycle  E= -507.850078741657  delta_E= 1.14e-13  |g|= 2.23e-08  |ddm|= 4.15e-07
    CPU time for scf_cycle      5.07 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12524.281490577569
E1 = -706.5202965511533  E_coul = 198.6702178094963
init E= -507.850078741657
    CPU time for initialize scf      9.87 sec, wall time      0.69 sec
  HOMO = -0.245819531499428  LUMO = 2.69513288345893
  mo_energy =
[-1.20316228e+02 -1.23474032e+01 -6.67406266e+00 -6.67406266e+00
 -6.67406266e+00 -1.16665254e+00 -2.45819531e-01 -2.45819531e-01
 -2.45819531e-01  2.69513288e+00  6.64374770e+01  4.41187547e+02
  2.20800887e+03  1.13874841e+04  4.09814931e+04  1.09837763e+05
  2.54038978e+05  5.48470102e+05  1.15241886e+06  2.43020239e+06
  5.37493805e+06]
E1 = -706.5202965978347  E_coul = 198.6702178561772
cycle= 1 E= -507.850078741657  delta_E= -5.12e-13  |g|= 2.04e-09  |ddm|= 3.67e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.5202965978347  E_coul = 198.6702178561772
  HOMO = -0.245819530499817  LUMO = 2.69513288592188
  mo_energy =
[-1.20316228e+02 -1.23474032e+01 -6.67406266e+00 -6.67406266e+00
 -6.67406266e+00 -1.16665254e+00 -2.45819530e-01 -2.45819530e-01
 -2.45819530e-01  2.69513289e+00  6.64374771e+01  4.41187547e+02
  2.20800887e+03  1.13874841e+04  4.09814931e+04  1.09837763e+05
  2.54038978e+05  5.48470102e+05  1.15241886e+06  2.43020239e+06
  5.37493805e+06]
E1 = -706.520296602124  E_coul = 198.67021786046692
Extra cycle  E= -507.850078741657  delta_E= 3.98e-13  |g|= 6.94e-10  |ddm|= 3.48e-09
    CPU time for scf_cycle      9.94 sec, wall time      0.76 sec
exp = [4.17183101e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180204e+03
 1.83771612e+04 1.23897773e+03 2.98190126e+02 8.84326653e+01
 3.06866948e+01 5.36634649e+00 1.03182427e+00 8.59251581e+00
 4.86883884e-01]
grad_E = [ 1.09976739e-01 -1.88069760e-11  4.18256027e-10  1.40566681e-09
  8.24989705e-09  2.71919113e-08  1.65586977e-07  9.08529636e-06
  4.10284291e-07 -1.73517876e-06  5.71409326e-05 -1.14305897e-03
  1.35038116e-04  3.95876926e-02 -1.02536100e-01 -2.17457760e-03
 -1.84243003e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.406179369869       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.507975         1
[INPUT] 0    0    [1    /1   ]  36755.2344666        1
[INPUT] 0    0    [1    /1   ]  7331.80182535        1
[INPUT] 0    0    [1    /1   ]  18377.1612028        1
[INPUT] 0    0    [1    /1   ]  1238.97767807        1
[INPUT] 0    0    [1    /1   ]  298.18993719         1
[INPUT] 0    0    [1    /1   ]  88.4421611988        1
[INPUT] 0    0    [1    /1   ]  30.6993334527        1
[INPUT] 0    0    [1    /1   ]  5.94452125521        1
[INPUT] 0    0    [1    /1   ]  1.64544199568        1
[INPUT] 1    0    [1    /1   ]  8.57789757601        1
[INPUT] 1    0    [1    /1   ]  0.485099215585       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.40617936986914394, 1.0]], [0, [1176168.142606493, 1.0]], [0, [588084.0713032302, 1.0]], [0, [294042.0356515693, 1.0]], [0, [147021.0178254951, 1.0]], [0, [73510.50797499022, 1.0]], [0, [36755.23446659853, 1.0]], [0, [7331.8018253488835, 1.0]], [0, [18377.161202779247, 1.0]], [0, [1238.9776780737045, 1.0]], [0, [298.18993719030436, 1.0]], [0, [88.44216119876651, 1.0]], [0, [30.69933345271645, 1.0]], [0, [5.944521255209642, 1.0]], [0, [1.6454419956826674, 1.0]], [1, [8.577897576014102, 1.0]], [1, [0.48509921558490343, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.40617937]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130323]
bas 3, expnt(s) = [294042.03565157]
bas 4, expnt(s) = [147021.0178255]
bas 5, expnt(s) = [73510.50797499]
bas 6, expnt(s) = [36755.2344666]
bas 7, expnt(s) = [7331.80182535]
bas 8, expnt(s) = [18377.16120278]
bas 9, expnt(s) = [1238.97767807]
bas 10, expnt(s) = [298.18993719]
bas 11, expnt(s) = [88.4421612]
bas 12, expnt(s) = [30.69933345]
bas 13, expnt(s) = [5.94452126]
bas 14, expnt(s) = [1.645442]
bas 15, expnt(s) = [8.57789758]
bas 16, expnt(s) = [0.48509922]
CPU time:       201.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.06179370e-01 1.28544477e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180183e+03 2.00181096e+03
 1.83771612e+04 3.98771253e+03 1.23897768e+03 5.27609535e+02
 2.98189937e+02 1.81294555e+02 8.84421612e+01 7.28634170e+01
 3.06993335e+01 3.29504791e+01 5.94452126e+00 9.61839675e+00
 1.64544200e+00 3.67051461e+00 8.57789758e+00 4.28262909e+01
 4.85099216e-01 1.18106176e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33295739443189
cond(S) = 12525.779174540832
E1 = -689.0264819146021  E_coul = 184.63560159921363
init E= -504.390880315388
    CPU time for initialize scf      4.58 sec, wall time      0.34 sec
  HOMO = -0.683144567211433  LUMO = 3.59366228988204
  mo_energy =
[-1.21731354e+02 -1.33950185e+01 -7.64252104e+00 -7.64252104e+00
 -7.64252104e+00 -1.64863830e+00 -6.83144567e-01 -6.83144567e-01
 -6.83144567e-01  3.59366229e+00  7.02890102e+01  4.44319031e+02
  2.21050884e+03  1.13895185e+04  4.09833343e+04  1.09839512e+05
  2.54040663e+05  5.48471727e+05  1.15242042e+06  2.43020389e+06
  5.37493948e+06]
E1 = -706.9115697015781  E_coul = 199.03922260804327
cycle= 1 E= -507.872347093535  delta_E= -3.48  |g|= 0.455  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.590725
diis-c [-0.34895584  1.        ]
  HOMO = -0.241877474868888  LUMO = 4.28789207067801
  mo_energy =
[-1.20258779e+02 -1.23433990e+01 -6.64347790e+00 -6.64347790e+00
 -6.64347790e+00 -1.16421953e+00 -2.41877475e-01 -2.41877475e-01
 -2.41877475e-01  4.28789207e+00  7.16070339e+01  4.45776941e+02
  2.21191456e+03  1.13908021e+04  4.09845469e+04  1.09840686e+05
  2.54041810e+05  5.48472855e+05  1.15242153e+06  2.43020500e+06
  5.37494058e+06]
E1 = -706.2454624399451  E_coul = 198.3605170539972
cycle= 2 E= -507.884945385948  delta_E= -0.0126  |g|= 0.0265  |ddm|= 0.346
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0187277
diis-c [-3.35218978e-04  6.62569423e-03  9.93374306e-01]
  HOMO = -0.253368048239051  LUMO = 4.27419319563867
  mo_energy =
[-1.20348985e+02 -1.23895157e+01 -6.69674506e+00 -6.69674506e+00
 -6.69674506e+00 -1.17115140e+00 -2.53368048e-01 -2.53368048e-01
 -2.53368048e-01  4.27419320e+00  7.15407498e+01  4.45686058e+02
  2.21180680e+03  1.13906833e+04  4.09844244e+04  1.09840562e+05
  2.54041685e+05  5.48472729e+05  1.15242141e+06  2.43020487e+06
  5.37494045e+06]
E1 = -706.2019588526741  E_coul = 198.31695074906872
cycle= 3 E= -507.885008103605  delta_E= -6.27e-05  |g|= 0.00214  |ddm|= 0.0253
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00143261
diis-c [-4.04022397e-07  8.79902055e-05 -7.30488404e-02  1.07296085e+00]
  HOMO = -0.254323887161164  LUMO = 4.27304029302104
  mo_energy =
[-1.20355178e+02 -1.23932008e+01 -6.70084799e+00 -6.70084799e+00
 -6.70084799e+00 -1.17169431e+00 -2.54323887e-01 -2.54323887e-01
 -2.54323887e-01  4.27304029e+00  7.15358895e+01  4.45679884e+02
  2.21179990e+03  1.13906760e+04  4.09844170e+04  1.09840555e+05
  2.54041678e+05  5.48472722e+05  1.15242140e+06  2.43020486e+06
  5.37494045e+06]
E1 = -706.198308049968  E_coul = 198.31329950466966
cycle= 4 E= -507.885008545298  delta_E= -4.42e-07  |g|= 4.96e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.26485e-05
diis-c [-2.74815260e-11 -3.30336005e-06  4.69292179e-03 -7.48323031e-02
  1.07014268e+00]
  HOMO = -0.254339081507874  LUMO = 4.2730239812535
  mo_energy =
[-1.20355222e+02 -1.23932517e+01 -6.70089580e+00 -6.70089580e+00
 -6.70089580e+00 -1.17170290e+00 -2.54339082e-01 -2.54339082e-01
 -2.54339082e-01  4.27302398e+00  7.15358442e+01  4.45679840e+02
  2.21179985e+03  1.13906760e+04  4.09844169e+04  1.09840555e+05
  2.54041678e+05  5.48472722e+05  1.15242140e+06  2.43020486e+06
  5.37494045e+06]
E1 = -706.1982533117844  E_coul = 198.31324476630292
cycle= 5 E= -507.885008545481  delta_E= -1.83e-10  |g|= 2.12e-07  |ddm|= 4.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.1982533117844  E_coul = 198.31324476630292
  HOMO = -0.254339100008189  LUMO = 4.27302398411811
  mo_energy =
[-1.20355222e+02 -1.23932518e+01 -6.70089584e+00 -6.70089584e+00
 -6.70089584e+00 -1.17170292e+00 -2.54339100e-01 -2.54339100e-01
 -2.54339100e-01  4.27302398e+00  7.15358442e+01  4.45679840e+02
  2.21179985e+03  1.13906760e+04  4.09844169e+04  1.09840555e+05
  2.54041678e+05  5.48472722e+05  1.15242140e+06  2.43020486e+06
  5.37494045e+06]
E1 = -706.198253287277  E_coul = 198.31324474179513
Extra cycle  E= -507.885008545482  delta_E= -3.98e-13  |g|= 1.02e-08  |ddm|= 5.15e-08
    CPU time for scf_cycle      4.67 sec, wall time      0.42 sec
exp = [4.06179370e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180183e+03
 1.83771612e+04 1.23897768e+03 2.98189937e+02 8.84421612e+01
 3.06993335e+01 5.94452126e+00 1.64544200e+00 8.57789758e+00
 4.85099216e-01]
E = -507.88500854548187
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.406179369869       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.507975         1
[INPUT] 0    0    [1    /1   ]  36755.2344666        1
[INPUT] 0    0    [1    /1   ]  7331.80182535        1
[INPUT] 0    0    [1    /1   ]  18377.1612028        1
[INPUT] 0    0    [1    /1   ]  1238.97767807        1
[INPUT] 0    0    [1    /1   ]  298.18993719         1
[INPUT] 0    0    [1    /1   ]  88.4421611988        1
[INPUT] 0    0    [1    /1   ]  30.6993334527        1
[INPUT] 0    0    [1    /1   ]  5.94452125521        1
[INPUT] 0    0    [1    /1   ]  1.64544199568        1
[INPUT] 1    0    [1    /1   ]  8.57789757601        1
[INPUT] 1    0    [1    /1   ]  0.485099215585       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.40617936986914394, 1.0]], [0, [1176168.142606493, 1.0]], [0, [588084.0713032302, 1.0]], [0, [294042.0356515693, 1.0]], [0, [147021.0178254951, 1.0]], [0, [73510.50797499022, 1.0]], [0, [36755.23446659853, 1.0]], [0, [7331.8018253488835, 1.0]], [0, [18377.161202779247, 1.0]], [0, [1238.9776780737045, 1.0]], [0, [298.18993719030436, 1.0]], [0, [88.44216119876651, 1.0]], [0, [30.69933345271645, 1.0]], [0, [5.944521255209642, 1.0]], [0, [1.6454419956826674, 1.0]], [1, [8.577897576014102, 1.0]], [1, [0.48509921558490343, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.40617937]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130323]
bas 3, expnt(s) = [294042.03565157]
bas 4, expnt(s) = [147021.0178255]
bas 5, expnt(s) = [73510.50797499]
bas 6, expnt(s) = [36755.2344666]
bas 7, expnt(s) = [7331.80182535]
bas 8, expnt(s) = [18377.16120278]
bas 9, expnt(s) = [1238.97767807]
bas 10, expnt(s) = [298.18993719]
bas 11, expnt(s) = [88.4421612]
bas 12, expnt(s) = [30.69933345]
bas 13, expnt(s) = [5.94452126]
bas 14, expnt(s) = [1.645442]
bas 15, expnt(s) = [8.57789758]
bas 16, expnt(s) = [0.48509922]
CPU time:       206.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.06179370e-01 1.28544477e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180183e+03 2.00181096e+03
 1.83771612e+04 3.98771253e+03 1.23897768e+03 5.27609535e+02
 2.98189937e+02 1.81294555e+02 8.84421612e+01 7.28634170e+01
 3.06993335e+01 3.29504791e+01 5.94452126e+00 9.61839675e+00
 1.64544200e+00 3.67051461e+00 8.57789758e+00 4.28262909e+01
 4.85099216e-01 1.18106176e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33295739443189
cond(S) = 12525.779174540832
E1 = -689.0264819146021  E_coul = 184.63560159921363
init E= -504.390880315388
    CPU time for initialize scf      4.64 sec, wall time      0.35 sec
  HOMO = -0.683144567211433  LUMO = 3.59366228988204
  mo_energy =
[-1.21731354e+02 -1.33950185e+01 -7.64252104e+00 -7.64252104e+00
 -7.64252104e+00 -1.64863830e+00 -6.83144567e-01 -6.83144567e-01
 -6.83144567e-01  3.59366229e+00  7.02890102e+01  4.44319031e+02
  2.21050884e+03  1.13895185e+04  4.09833343e+04  1.09839512e+05
  2.54040663e+05  5.48471727e+05  1.15242042e+06  2.43020389e+06
  5.37493948e+06]
E1 = -706.9115697015781  E_coul = 199.03922260804327
cycle= 1 E= -507.872347093535  delta_E= -3.48  |g|= 0.455  |ddm|= 0.37
    CPU time for cycle= 1      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.590725
diis-c [-0.34895584  1.        ]
  HOMO = -0.241877474868888  LUMO = 4.28789207067801
  mo_energy =
[-1.20258779e+02 -1.23433990e+01 -6.64347790e+00 -6.64347790e+00
 -6.64347790e+00 -1.16421953e+00 -2.41877475e-01 -2.41877475e-01
 -2.41877475e-01  4.28789207e+00  7.16070339e+01  4.45776941e+02
  2.21191456e+03  1.13908021e+04  4.09845469e+04  1.09840686e+05
  2.54041810e+05  5.48472855e+05  1.15242153e+06  2.43020500e+06
  5.37494058e+06]
E1 = -706.2454624399451  E_coul = 198.3605170539972
cycle= 2 E= -507.884945385948  delta_E= -0.0126  |g|= 0.0265  |ddm|= 0.346
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0187277
diis-c [-3.35218978e-04  6.62569423e-03  9.93374306e-01]
  HOMO = -0.253368048239051  LUMO = 4.27419319563867
  mo_energy =
[-1.20348985e+02 -1.23895157e+01 -6.69674506e+00 -6.69674506e+00
 -6.69674506e+00 -1.17115140e+00 -2.53368048e-01 -2.53368048e-01
 -2.53368048e-01  4.27419320e+00  7.15407498e+01  4.45686058e+02
  2.21180680e+03  1.13906833e+04  4.09844244e+04  1.09840562e+05
  2.54041685e+05  5.48472729e+05  1.15242141e+06  2.43020487e+06
  5.37494045e+06]
E1 = -706.2019588526741  E_coul = 198.31695074906872
cycle= 3 E= -507.885008103605  delta_E= -6.27e-05  |g|= 0.00214  |ddm|= 0.0253
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00143261
diis-c [-4.04022397e-07  8.79902055e-05 -7.30488404e-02  1.07296085e+00]
  HOMO = -0.254323887161164  LUMO = 4.27304029302104
  mo_energy =
[-1.20355178e+02 -1.23932008e+01 -6.70084799e+00 -6.70084799e+00
 -6.70084799e+00 -1.17169431e+00 -2.54323887e-01 -2.54323887e-01
 -2.54323887e-01  4.27304029e+00  7.15358895e+01  4.45679884e+02
  2.21179990e+03  1.13906760e+04  4.09844170e+04  1.09840555e+05
  2.54041678e+05  5.48472722e+05  1.15242140e+06  2.43020486e+06
  5.37494045e+06]
E1 = -706.198308049968  E_coul = 198.31329950466966
cycle= 4 E= -507.885008545298  delta_E= -4.42e-07  |g|= 4.96e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.26485e-05
diis-c [-2.74815260e-11 -3.30336005e-06  4.69292179e-03 -7.48323031e-02
  1.07014268e+00]
  HOMO = -0.254339081507874  LUMO = 4.2730239812535
  mo_energy =
[-1.20355222e+02 -1.23932517e+01 -6.70089580e+00 -6.70089580e+00
 -6.70089580e+00 -1.17170290e+00 -2.54339082e-01 -2.54339082e-01
 -2.54339082e-01  4.27302398e+00  7.15358442e+01  4.45679840e+02
  2.21179985e+03  1.13906760e+04  4.09844169e+04  1.09840555e+05
  2.54041678e+05  5.48472722e+05  1.15242140e+06  2.43020486e+06
  5.37494045e+06]
E1 = -706.1982533117844  E_coul = 198.31324476630292
cycle= 5 E= -507.885008545481  delta_E= -1.83e-10  |g|= 2.12e-07  |ddm|= 4.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.1982533117844  E_coul = 198.31324476630292
  HOMO = -0.254339100008189  LUMO = 4.27302398411811
  mo_energy =
[-1.20355222e+02 -1.23932518e+01 -6.70089584e+00 -6.70089584e+00
 -6.70089584e+00 -1.17170292e+00 -2.54339100e-01 -2.54339100e-01
 -2.54339100e-01  4.27302398e+00  7.15358442e+01  4.45679840e+02
  2.21179985e+03  1.13906760e+04  4.09844169e+04  1.09840555e+05
  2.54041678e+05  5.48472722e+05  1.15242140e+06  2.43020486e+06
  5.37494045e+06]
E1 = -706.198253287277  E_coul = 198.31324474179513
Extra cycle  E= -507.885008545482  delta_E= -3.98e-13  |g|= 1.02e-08  |ddm|= 5.15e-08
    CPU time for scf_cycle      4.74 sec, wall time      0.43 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12525.779174540832
E1 = -706.198253287277  E_coul = 198.31324474179513
init E= -507.885008545482
    CPU time for initialize scf      9.97 sec, wall time      0.72 sec
  HOMO = -0.254339101287117  LUMO = 4.27302398475628
  mo_energy =
[-1.20355222e+02 -1.23932518e+01 -6.70089584e+00 -6.70089584e+00
 -6.70089584e+00 -1.17170292e+00 -2.54339101e-01 -2.54339101e-01
 -2.54339101e-01  4.27302398e+00  7.15358442e+01  4.45679840e+02
  2.21179985e+03  1.13906760e+04  4.09844169e+04  1.09840555e+05
  2.54041678e+05  5.48472722e+05  1.15242140e+06  2.43020486e+06
  5.37494045e+06]
E1 = -706.198253283406  E_coul = 198.3132447379243
cycle= 1 E= -507.885008545482  delta_E= 1.71e-13  |g|= 1.11e-09  |ddm|= 4.37e-09
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
E1 = -706.198253283406  E_coul = 198.3132447379243
  HOMO = -0.254339101417365  LUMO = 4.27302398460722
  mo_energy =
[-1.20355222e+02 -1.23932518e+01 -6.70089584e+00 -6.70089584e+00
 -6.70089584e+00 -1.17170292e+00 -2.54339101e-01 -2.54339101e-01
 -2.54339101e-01  4.27302398e+00  7.15358442e+01  4.45679840e+02
  2.21179985e+03  1.13906760e+04  4.09844169e+04  1.09840555e+05
  2.54041678e+05  5.48472722e+05  1.15242140e+06  2.43020486e+06
  5.37494045e+06]
E1 = -706.1982532829636  E_coul = 198.3132447374819
Extra cycle  E= -507.885008545482  delta_E=    0  |g|= 5.29e-10  |ddm|= 3.78e-10
    CPU time for scf_cycle     10.05 sec, wall time      0.79 sec
exp = [4.06179370e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180183e+03
 1.83771612e+04 1.23897768e+03 2.98189937e+02 8.84421612e+01
 3.06993335e+01 5.94452126e+00 1.64544200e+00 8.57789758e+00
 4.85099216e-01]
grad_E = [ 2.97706218e-02 -1.87340335e-11  4.18979276e-10  1.40822044e-09
  8.26368910e-09  2.72398703e-08  1.65866545e-07  9.10589447e-06
  4.11024271e-07 -4.02062265e-06  8.75665438e-05 -1.64784471e-03
  6.08338829e-04  4.14140438e-02 -8.96549772e-02 -1.40532248e-02
 -2.70436693e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.44691139467        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079725        1
[INPUT] 0    0    [1    /1   ]  36755.2344515        1
[INPUT] 0    0    [1    /1   ]  7331.80099682        1
[INPUT] 0    0    [1    /1   ]  18377.1611653        1
[INPUT] 0    0    [1    /1   ]  1238.97750743        1
[INPUT] 0    0    [1    /1   ]  298.189053833        1
[INPUT] 0    0    [1    /1   ]  88.4812325752        1
[INPUT] 0    0    [1    /1   ]  30.7454654211        1
[INPUT] 0    0    [1    /1   ]  8.12159006243        1
[INPUT] 0    0    [1    /1   ]  4.02214747973        1
[INPUT] 1    0    [1    /1   ]  8.59047511538        1
[INPUT] 1    0    [1    /1   ]  0.490431734021       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.44691139467009283, 1.0]], [0, [1176168.1426064947, 1.0]], [0, [588084.0713031921, 1.0]], [0, [294042.035651441, 1.0]], [0, [147021.0178247421, 1.0]], [0, [73510.50797250881, 1.0]], [0, [36755.23445148489, 1.0]], [0, [7331.80099682154, 1.0]], [0, [18377.161165344234, 1.0]], [0, [1238.9775074282472, 1.0]], [0, [298.1890538329798, 1.0]], [0, [88.4812325752003, 1.0]], [0, [30.745465421122397, 1.0]], [0, [8.121590062433352, 1.0]], [0, [4.02214747973073, 1.0]], [1, [8.590475115383779, 1.0]], [1, [0.49043173402066, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.44691139]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130319]
bas 3, expnt(s) = [294042.03565144]
bas 4, expnt(s) = [147021.01782474]
bas 5, expnt(s) = [73510.50797251]
bas 6, expnt(s) = [36755.23445148]
bas 7, expnt(s) = [7331.80099682]
bas 8, expnt(s) = [18377.16116534]
bas 9, expnt(s) = [1238.97750743]
bas 10, expnt(s) = [298.18905383]
bas 11, expnt(s) = [88.48123258]
bas 12, expnt(s) = [30.74546542]
bas 13, expnt(s) = [8.12159006]
bas 14, expnt(s) = [4.02214748]
bas 15, expnt(s) = [8.59047512]
bas 16, expnt(s) = [0.49043173]
CPU time:       224.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.46911395e-01 1.38095999e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180100e+03 2.00181079e+03
 1.83771612e+04 3.98771252e+03 1.23897751e+03 5.27609481e+02
 2.98189054e+02 1.81294153e+02 8.84812326e+01 7.28875575e+01
 3.07454654e+01 3.29876082e+01 8.12159006e+00 1.21547442e+01
 4.02214748e+00 7.17560489e+00 8.59047512e+00 4.29047991e+01
 4.90431734e-01 1.19731272e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.312302872444718
cond(S) = 12532.484022311899
E1 = -689.1649891884189  E_coul = 185.09176337178152
init E= -504.073225816637
    CPU time for initialize scf      4.37 sec, wall time      0.33 sec
  HOMO = -0.666509790401447  LUMO = 11.2581551314411
  mo_energy =
[-1.21694384e+02 -1.33406057e+01 -7.61201703e+00 -7.61201703e+00
 -7.61201703e+00 -1.64662853e+00 -6.66509790e-01 -6.66509790e-01
 -6.66509790e-01  1.12581551e+01  8.96720290e+01  4.62618813e+02
  2.22617758e+03  1.14027767e+04  4.09955010e+04  1.09851141e+05
  2.54051913e+05  5.48482653e+05  1.15243104e+06  2.43021421e+06
  5.37494949e+06]
E1 = -707.9771340362839  E_coul = 200.13924646434225
cycle= 1 E= -507.837887571942  delta_E= -3.76  |g|= 0.407  |ddm|= 1.03
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.585642
diis-c [-0.34297697  1.        ]
  HOMO = -0.208941386538806  LUMO = 12.2318790294487
  mo_energy =
[-1.20151334e+02 -1.22461396e+01 -6.56324055e+00 -6.56324055e+00
 -6.56324055e+00 -1.13732986e+00 -2.08941387e-01 -2.08941387e-01
 -2.08941387e-01  1.22318790e+01  9.10606083e+01  4.64142274e+02
  2.22765799e+03  1.14041364e+04  4.09967901e+04  1.09852391e+05
  2.54053137e+05  5.48483857e+05  1.15243223e+06  2.43021539e+06
  5.37495066e+06]
E1 = -707.7117200785837  E_coul = 199.8696109820408
cycle= 2 E= -507.842109096543  delta_E= -0.00422  |g|= 0.0154  |ddm|= 0.202
    CPU time for cycle= 2      0.08 sec, wall time      0.01 sec
diis-norm(errvec)=0.0135989
diis-c [-1.80153749e-04  3.71862400e-03  9.96281376e-01]
  HOMO = -0.211999376779346  LUMO = 12.2236477478679
  mo_energy =
[-1.20196851e+02 -1.22625621e+01 -6.58379353e+00 -6.58379353e+00
 -6.58379353e+00 -1.13895951e+00 -2.11999377e-01 -2.11999377e-01
 -2.11999377e-01  1.22236477e+01  9.10303587e+01  4.64096219e+02
  2.22759926e+03  1.14040693e+04  4.09967201e+04  1.09852320e+05
  2.54053066e+05  5.48483785e+05  1.15243216e+06  2.43021532e+06
  5.37495059e+06]
E1 = -707.7011846026076  E_coul = 199.85906834196714
cycle= 3 E= -507.84211626064  delta_E= -7.16e-06  |g|= 0.000696  |ddm|= 0.0087
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000628573
diis-c [-5.15176430e-09  4.53153022e-05 -4.78057026e-02  1.04776039e+00]
  HOMO = -0.212143431454596  LUMO = 12.2232630452943
  mo_energy =
[-1.20198772e+02 -1.22633234e+01 -6.58473680e+00 -6.58473680e+00
 -6.58473680e+00 -1.13903358e+00 -2.12143431e-01 -2.12143431e-01
 -2.12143431e-01  1.22232630e+01  9.10290172e+01  4.64094313e+02
  2.22759700e+03  1.14040668e+04  4.09967176e+04  1.09852318e+05
  2.54053063e+05  5.48483782e+05  1.15243216e+06  2.43021532e+06
  5.37495059e+06]
E1 = -707.7006892591388  E_coul = 199.85857298336134
cycle= 4 E= -507.842116275777  delta_E= -1.51e-08  |g|= 2.4e-06  |ddm|= 0.000423
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.43684e-06
diis-c [-1.50112676e-12 -1.47995862e-06  1.23937513e-03 -2.51396212e-02
  1.02390173e+00]
  HOMO = -0.212143662703809  LUMO = 12.2232627672482
  mo_energy =
[-1.20198770e+02 -1.22633242e+01 -6.58473731e+00 -6.58473731e+00
 -6.58473731e+00 -1.13903373e+00 -2.12143663e-01 -2.12143663e-01
 -2.12143663e-01  1.22232628e+01  9.10290173e+01  4.64094315e+02
  2.22759701e+03  1.14040668e+04  4.09967176e+04  1.09852318e+05
  2.54053063e+05  5.48483782e+05  1.15243216e+06  2.43021532e+06
  5.37495059e+06]
E1 = -707.7006889504726  E_coul = 199.8585726746951
cycle= 5 E= -507.842116275777  delta_E=    0  |g|= 8.57e-08  |ddm|= 8.91e-07
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -707.7006889504726  E_coul = 199.8585726746951
  HOMO = -0.212143679772428  LUMO = 12.2232627305793
  mo_energy =
[-1.20198771e+02 -1.22633243e+01 -6.58473740e+00 -6.58473740e+00
 -6.58473740e+00 -1.13903374e+00 -2.12143680e-01 -2.12143680e-01
 -2.12143680e-01  1.22232627e+01  9.10290172e+01  4.64094315e+02
  2.22759701e+03  1.14040668e+04  4.09967176e+04  1.09852318e+05
  2.54053063e+05  5.48483782e+05  1.15243216e+06  2.43021532e+06
  5.37495059e+06]
E1 = -707.7006889048096  E_coul = 199.85857262903232
Extra cycle  E= -507.842116275777  delta_E= 2.27e-13  |g|= 4.05e-09  |ddm|= 5.11e-08
    CPU time for scf_cycle      4.64 sec, wall time      0.40 sec
exp = [4.46911395e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180100e+03
 1.83771612e+04 1.23897751e+03 2.98189054e+02 8.84812326e+01
 3.07454654e+01 8.12159006e+00 4.02214748e+00 8.59047512e+00
 4.90431734e-01]
E = -507.84211627577724
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.421291205971       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079741        1
[INPUT] 0    0    [1    /1   ]  36755.234461         1
[INPUT] 0    0    [1    /1   ]  7331.80151796        1
[INPUT] 0    0    [1    /1   ]  18377.1611889        1
[INPUT] 0    0    [1    /1   ]  1238.97761476        1
[INPUT] 0    0    [1    /1   ]  298.189609459        1
[INPUT] 0    0    [1    /1   ]  88.4566569239        1
[INPUT] 0    0    [1    /1   ]  30.7164487017        1
[INPUT] 0    0    [1    /1   ]  6.75222740677        1
[INPUT] 0    0    [1    /1   ]  2.52721460367        1
[INPUT] 1    0    [1    /1   ]  8.58256392183        1
[INPUT] 1    0    [1    /1   ]  0.487077613295       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.42129120597107356, 1.0]], [0, [1176168.1426064938, 1.0]], [0, [588084.071303216, 1.0]], [0, [294042.0356515217, 1.0]], [0, [147021.01782521573, 1.0]], [0, [73510.50797406961, 1.0]], [0, [36755.234460991276, 1.0]], [0, [7331.801517960054, 1.0]], [0, [18377.161188890623, 1.0]], [0, [1238.977614763172, 1.0]], [0, [298.1896094592089, 1.0]], [0, [88.4566569239319, 1.0]], [0, [30.71644870168865, 1.0]], [0, [6.752227406773747, 1.0]], [0, [2.5272146036737855, 1.0]], [1, [8.582563921830422, 1.0]], [1, [0.4870776132954389, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.42129121]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130322]
bas 3, expnt(s) = [294042.03565152]
bas 4, expnt(s) = [147021.01782522]
bas 5, expnt(s) = [73510.50797407]
bas 6, expnt(s) = [36755.23446099]
bas 7, expnt(s) = [7331.80151796]
bas 8, expnt(s) = [18377.16118889]
bas 9, expnt(s) = [1238.97761476]
bas 10, expnt(s) = [298.18960946]
bas 11, expnt(s) = [88.45665692]
bas 12, expnt(s) = [30.7164487]
bas 13, expnt(s) = [6.75222741]
bas 14, expnt(s) = [2.5272146]
bas 15, expnt(s) = [8.58256392]
bas 16, expnt(s) = [0.48707761]
CPU time:       228.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.21291206e-01 1.32114906e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180152e+03 2.00181090e+03
 1.83771612e+04 3.98771253e+03 1.23897761e+03 5.27609515e+02
 2.98189609e+02 1.81294406e+02 8.84566569e+01 7.28723736e+01
 3.07164487e+01 3.29642559e+01 6.75222741e+00 1.05827934e+01
 2.52721460e+00 5.06403404e+00 8.58256392e+00 4.28554146e+01
 4.87077613e-01 1.18708578e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32886264192357
cond(S) = 12528.122429695908
E1 = -689.2179953323173  E_coul = 184.7473131010457
init E= -504.470682231272
    CPU time for initialize scf      4.52 sec, wall time      0.34 sec
  HOMO = -0.676876888006286  LUMO = 6.22610592382188
  mo_energy =
[-1.21725208e+02 -1.33998569e+01 -7.63706329e+00 -7.63706329e+00
 -7.63706329e+00 -1.64704094e+00 -6.76876888e-01 -6.76876888e-01
 -6.76876888e-01  6.22610592e+00  7.76065672e+01  4.51011579e+02
  2.21620251e+03  1.13943290e+04  4.09877473e+04  1.09843729e+05
  2.54044743e+05  5.48475689e+05  1.15242427e+06  2.43020763e+06
  5.37494311e+06]
E1 = -707.0380837988308  E_coul = 199.12934795913273
cycle= 1 E= -507.908735839698  delta_E= -3.44  |g|= 0.445  |ddm|= 0.374
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593014
diis-c [-0.35166503  1.        ]
  HOMO = -0.234901717917384  LUMO = 7.03993654307394
  mo_energy =
[-1.20258670e+02 -1.23497174e+01 -6.63980589e+00 -6.63980589e+00
 -6.63980589e+00 -1.16115089e+00 -2.34901718e-01 -2.34901718e-01
 -2.34901718e-01  7.03993654e+00  7.89241014e+01  4.52461498e+02
  2.21759846e+03  1.13956006e+04  4.09889470e+04  1.09844890e+05
  2.54045877e+05  5.48476803e+05  1.15242537e+06  2.43020872e+06
  5.37494419e+06]
E1 = -706.5762290530606  E_coul = 198.65914145354893
cycle= 2 E= -507.917087599512  delta_E= -0.00835  |g|= 0.0214  |ddm|= 0.256
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0164877
diis-c [-2.63753894e-04  4.77549101e-03  9.95224509e-01]
  HOMO = -0.241494375040286  LUMO = 7.02816779943358
  mo_energy =
[-1.20328367e+02 -1.23803168e+01 -6.67660571e+00 -6.67660571e+00
 -6.67660571e+00 -1.16487655e+00 -2.41494375e-01 -2.41494375e-01
 -2.41494375e-01  7.02816780e+00  7.88749685e+01  4.52391175e+02
  2.21751270e+03  1.13955047e+04  4.09888478e+04  1.09844790e+05
  2.54045775e+05  5.48476701e+05  1.15242527e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.5526742688741  E_coul = 198.63556196495324
cycle= 3 E= -507.917112303921  delta_E= -2.47e-05  |g|= 0.00128  |ddm|= 0.0146
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000907518
diis-c [-7.83747292e-08  9.32302668e-05 -5.46334087e-02  1.05454018e+00]
  HOMO = -0.241910156185162  LUMO = 7.02743747664309
  mo_energy =
[-1.20332063e+02 -1.23821769e+01 -6.67877474e+00 -6.67877474e+00
 -6.67877474e+00 -1.16510134e+00 -2.41910156e-01 -2.41910156e-01
 -2.41910156e-01  7.02743748e+00  7.88722053e+01  4.52387497e+02
  2.21750849e+03  1.13955002e+04  4.09888432e+04  1.09844785e+05
  2.54045771e+05  5.48476696e+05  1.15242526e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.551206732967  E_coul = 198.63409433046
cycle= 4 E= -507.917112402507  delta_E= -9.86e-08  |g|= 2.21e-05  |ddm|= 0.000972
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.70953e-05
diis-c [-1.24266913e-11 -2.81681664e-06  3.42849763e-03 -6.65918784e-02
  1.06316620e+00]
  HOMO = -0.24191546378639  LUMO = 7.02742989077069
  mo_energy =
[-1.20332084e+02 -1.23821972e+01 -6.67879453e+00 -6.67879453e+00
 -6.67879453e+00 -1.16510435e+00 -2.41915464e-01 -2.41915464e-01
 -2.41915464e-01  7.02742989e+00  7.88721854e+01  4.52387476e+02
  2.21750847e+03  1.13955002e+04  4.09888431e+04  1.09844785e+05
  2.54045771e+05  5.48476696e+05  1.15242526e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.5511909934487  E_coul = 198.63407859091478
cycle= 5 E= -507.917112402534  delta_E= -2.69e-11  |g|= 1.8e-07  |ddm|= 1.42e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5511909934487  E_coul = 198.63407859091478
  HOMO = -0.241915507175506  LUMO = 7.02742983037798
  mo_energy =
[-1.20332084e+02 -1.23821974e+01 -6.67879472e+00 -6.67879472e+00
 -6.67879472e+00 -1.16510437e+00 -2.41915507e-01 -2.41915507e-01
 -2.41915507e-01  7.02742983e+00  7.88721852e+01  4.52387476e+02
  2.21750847e+03  1.13955002e+04  4.09888431e+04  1.09844785e+05
  2.54045771e+05  5.48476696e+05  1.15242526e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.5511908636208  E_coul = 198.63407846108743
Extra cycle  E= -507.917112402533  delta_E= 5.12e-13  |g|= 1.1e-08  |ddm|= 1.05e-07
    CPU time for scf_cycle      4.73 sec, wall time      0.41 sec
exp = [4.21291206e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180152e+03
 1.83771612e+04 1.23897761e+03 2.98189609e+02 8.84566569e+01
 3.07164487e+01 6.75222741e+00 2.52721460e+00 8.58256392e+00
 4.87077613e-01]
E = -507.9171124025334
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.421291205971       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079741        1
[INPUT] 0    0    [1    /1   ]  36755.234461         1
[INPUT] 0    0    [1    /1   ]  7331.80151796        1
[INPUT] 0    0    [1    /1   ]  18377.1611889        1
[INPUT] 0    0    [1    /1   ]  1238.97761476        1
[INPUT] 0    0    [1    /1   ]  298.189609459        1
[INPUT] 0    0    [1    /1   ]  88.4566569239        1
[INPUT] 0    0    [1    /1   ]  30.7164487017        1
[INPUT] 0    0    [1    /1   ]  6.75222740677        1
[INPUT] 0    0    [1    /1   ]  2.52721460367        1
[INPUT] 1    0    [1    /1   ]  8.58256392183        1
[INPUT] 1    0    [1    /1   ]  0.487077613295       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.42129120597107356, 1.0]], [0, [1176168.1426064938, 1.0]], [0, [588084.071303216, 1.0]], [0, [294042.0356515217, 1.0]], [0, [147021.01782521573, 1.0]], [0, [73510.50797406961, 1.0]], [0, [36755.234460991276, 1.0]], [0, [7331.801517960054, 1.0]], [0, [18377.161188890623, 1.0]], [0, [1238.977614763172, 1.0]], [0, [298.1896094592089, 1.0]], [0, [88.4566569239319, 1.0]], [0, [30.71644870168865, 1.0]], [0, [6.752227406773747, 1.0]], [0, [2.5272146036737855, 1.0]], [1, [8.582563921830422, 1.0]], [1, [0.4870776132954389, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.42129121]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130322]
bas 3, expnt(s) = [294042.03565152]
bas 4, expnt(s) = [147021.01782522]
bas 5, expnt(s) = [73510.50797407]
bas 6, expnt(s) = [36755.23446099]
bas 7, expnt(s) = [7331.80151796]
bas 8, expnt(s) = [18377.16118889]
bas 9, expnt(s) = [1238.97761476]
bas 10, expnt(s) = [298.18960946]
bas 11, expnt(s) = [88.45665692]
bas 12, expnt(s) = [30.7164487]
bas 13, expnt(s) = [6.75222741]
bas 14, expnt(s) = [2.5272146]
bas 15, expnt(s) = [8.58256392]
bas 16, expnt(s) = [0.48707761]
CPU time:       233.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.21291206e-01 1.32114906e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180152e+03 2.00181090e+03
 1.83771612e+04 3.98771253e+03 1.23897761e+03 5.27609515e+02
 2.98189609e+02 1.81294406e+02 8.84566569e+01 7.28723736e+01
 3.07164487e+01 3.29642559e+01 6.75222741e+00 1.05827934e+01
 2.52721460e+00 5.06403404e+00 8.58256392e+00 4.28554146e+01
 4.87077613e-01 1.18708578e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32886264192357
cond(S) = 12528.122429695908
E1 = -689.2179953323173  E_coul = 184.7473131010457
init E= -504.470682231272
    CPU time for initialize scf      4.38 sec, wall time      0.35 sec
  HOMO = -0.676876888006286  LUMO = 6.22610592382188
  mo_energy =
[-1.21725208e+02 -1.33998569e+01 -7.63706329e+00 -7.63706329e+00
 -7.63706329e+00 -1.64704094e+00 -6.76876888e-01 -6.76876888e-01
 -6.76876888e-01  6.22610592e+00  7.76065672e+01  4.51011579e+02
  2.21620251e+03  1.13943290e+04  4.09877473e+04  1.09843729e+05
  2.54044743e+05  5.48475689e+05  1.15242427e+06  2.43020763e+06
  5.37494311e+06]
E1 = -707.0380837988308  E_coul = 199.12934795913273
cycle= 1 E= -507.908735839698  delta_E= -3.44  |g|= 0.445  |ddm|= 0.374
    CPU time for cycle= 1      0.08 sec, wall time      0.01 sec
diis-norm(errvec)=0.593014
diis-c [-0.35166503  1.        ]
  HOMO = -0.234901717917384  LUMO = 7.03993654307394
  mo_energy =
[-1.20258670e+02 -1.23497174e+01 -6.63980589e+00 -6.63980589e+00
 -6.63980589e+00 -1.16115089e+00 -2.34901718e-01 -2.34901718e-01
 -2.34901718e-01  7.03993654e+00  7.89241014e+01  4.52461498e+02
  2.21759846e+03  1.13956006e+04  4.09889470e+04  1.09844890e+05
  2.54045877e+05  5.48476803e+05  1.15242537e+06  2.43020872e+06
  5.37494419e+06]
E1 = -706.5762290530606  E_coul = 198.65914145354893
cycle= 2 E= -507.917087599512  delta_E= -0.00835  |g|= 0.0214  |ddm|= 0.256
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0164877
diis-c [-2.63753894e-04  4.77549101e-03  9.95224509e-01]
  HOMO = -0.241494375040286  LUMO = 7.02816779943358
  mo_energy =
[-1.20328367e+02 -1.23803168e+01 -6.67660571e+00 -6.67660571e+00
 -6.67660571e+00 -1.16487655e+00 -2.41494375e-01 -2.41494375e-01
 -2.41494375e-01  7.02816780e+00  7.88749685e+01  4.52391175e+02
  2.21751270e+03  1.13955047e+04  4.09888478e+04  1.09844790e+05
  2.54045775e+05  5.48476701e+05  1.15242527e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.5526742688741  E_coul = 198.63556196495324
cycle= 3 E= -507.917112303921  delta_E= -2.47e-05  |g|= 0.00128  |ddm|= 0.0146
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000907518
diis-c [-7.83747292e-08  9.32302668e-05 -5.46334087e-02  1.05454018e+00]
  HOMO = -0.241910156185162  LUMO = 7.02743747664309
  mo_energy =
[-1.20332063e+02 -1.23821769e+01 -6.67877474e+00 -6.67877474e+00
 -6.67877474e+00 -1.16510134e+00 -2.41910156e-01 -2.41910156e-01
 -2.41910156e-01  7.02743748e+00  7.88722053e+01  4.52387497e+02
  2.21750849e+03  1.13955002e+04  4.09888432e+04  1.09844785e+05
  2.54045771e+05  5.48476696e+05  1.15242526e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.551206732967  E_coul = 198.63409433046
cycle= 4 E= -507.917112402507  delta_E= -9.86e-08  |g|= 2.21e-05  |ddm|= 0.000972
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.70953e-05
diis-c [-1.24266913e-11 -2.81681664e-06  3.42849763e-03 -6.65918784e-02
  1.06316620e+00]
  HOMO = -0.24191546378639  LUMO = 7.02742989077069
  mo_energy =
[-1.20332084e+02 -1.23821972e+01 -6.67879453e+00 -6.67879453e+00
 -6.67879453e+00 -1.16510435e+00 -2.41915464e-01 -2.41915464e-01
 -2.41915464e-01  7.02742989e+00  7.88721854e+01  4.52387476e+02
  2.21750847e+03  1.13955002e+04  4.09888431e+04  1.09844785e+05
  2.54045771e+05  5.48476696e+05  1.15242526e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.5511909934487  E_coul = 198.63407859091478
cycle= 5 E= -507.917112402534  delta_E= -2.69e-11  |g|= 1.8e-07  |ddm|= 1.42e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5511909934487  E_coul = 198.63407859091478
  HOMO = -0.241915507175506  LUMO = 7.02742983037798
  mo_energy =
[-1.20332084e+02 -1.23821974e+01 -6.67879472e+00 -6.67879472e+00
 -6.67879472e+00 -1.16510437e+00 -2.41915507e-01 -2.41915507e-01
 -2.41915507e-01  7.02742983e+00  7.88721852e+01  4.52387476e+02
  2.21750847e+03  1.13955002e+04  4.09888431e+04  1.09844785e+05
  2.54045771e+05  5.48476696e+05  1.15242526e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.5511908636208  E_coul = 198.63407846108743
Extra cycle  E= -507.917112402533  delta_E= 5.12e-13  |g|= 1.1e-08  |ddm|= 1.05e-07
    CPU time for scf_cycle      4.52 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12528.122429695908
E1 = -706.5511908636208  E_coul = 198.63407846108743
init E= -507.917112402533
    CPU time for initialize scf      8.98 sec, wall time      0.69 sec
  HOMO = -0.241915509779465  LUMO = 7.02742982573425
  mo_energy =
[-1.20332084e+02 -1.23821974e+01 -6.67879474e+00 -6.67879474e+00
 -6.67879474e+00 -1.16510437e+00 -2.41915510e-01 -2.41915510e-01
 -2.41915510e-01  7.02742983e+00  7.88721852e+01  4.52387476e+02
  2.21750847e+03  1.13955002e+04  4.09888431e+04  1.09844785e+05
  2.54045771e+05  5.48476696e+05  1.15242526e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.5511908557659  E_coul = 198.63407845323258
cycle= 1 E= -507.917112402533  delta_E= 1.14e-13  |g|= 9.34e-10  |ddm|= 6.77e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.5511908557659  E_coul = 198.63407845323258
  HOMO = -0.241915509945479  LUMO = 7.027429823389
  mo_energy =
[-1.20332084e+02 -1.23821974e+01 -6.67879474e+00 -6.67879474e+00
 -6.67879474e+00 -1.16510437e+00 -2.41915510e-01 -2.41915510e-01
 -2.41915510e-01  7.02742982e+00  7.88721852e+01  4.52387476e+02
  2.21750847e+03  1.13955002e+04  4.09888431e+04  1.09844785e+05
  2.54045771e+05  5.48476696e+05  1.15242526e+06  2.43020862e+06
  5.37494409e+06]
E1 = -706.5511908552173  E_coul = 198.63407845268347
Extra cycle  E= -507.917112402534  delta_E= -5.68e-13  |g|= 1.32e-09  |ddm|= 4.9e-10
    CPU time for scf_cycle      9.18 sec, wall time      0.76 sec
exp = [4.21291206e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180152e+03
 1.83771612e+04 1.23897761e+03 2.98189609e+02 8.84566569e+01
 3.07164487e+01 6.75222741e+00 2.52721460e+00 8.58256392e+00
 4.87077613e-01]
grad_E = [ 2.48228559e-01 -1.89352833e-11  4.17587973e-10  1.40287405e-09
  8.23722696e-09  2.71387118e-08  1.65340863e-07  9.07596091e-06
  4.09263774e-07 -2.17886969e-06  5.36754163e-05 -1.48693274e-03
 -4.36981424e-04 -1.05164459e-03 -1.67931058e-02 -1.21263849e-02
 -1.61115730e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.341579442491       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.507973         1
[INPUT] 0    0    [1    /1   ]  36755.2344545        1
[INPUT] 0    0    [1    /1   ]  7331.80116023        1
[INPUT] 0    0    [1    /1   ]  18377.1611727        1
[INPUT] 0    0    [1    /1   ]  1238.97754598        1
[INPUT] 0    0    [1    /1   ]  298.189176328        1
[INPUT] 0    0    [1    /1   ]  88.4748432368        1
[INPUT] 0    0    [1    /1   ]  30.7364113176        1
[INPUT] 0    0    [1    /1   ]  7.65882123878        1
[INPUT] 0    0    [1    /1   ]  3.45306624994        1
[INPUT] 1    0    [1    /1   ]  8.59906096943        1
[INPUT] 1    0    [1    /1   ]  0.493937922588       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3415794424914528, 1.0]], [0, [1176168.1426064945, 1.0]], [0, [588084.0713031995, 1.0]], [0, [294042.03565146634, 1.0]], [0, [147021.01782489062, 1.0]], [0, [73510.50797299827, 1.0]], [0, [36755.234454465906, 1.0]], [0, [7331.801160225329, 1.0]], [0, [18377.16117272831, 1.0]], [0, [1238.9775459774035, 1.0]], [0, [298.18917632809644, 1.0]], [0, [88.47484323680717, 1.0]], [0, [30.7364113175974, 1.0]], [0, [7.658821238778103, 1.0]], [0, [3.453066249938107, 1.0]], [1, [8.599060969432873, 1.0]], [1, [0.4939379225877992, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.34157944]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.0713032]
bas 3, expnt(s) = [294042.03565147]
bas 4, expnt(s) = [147021.01782489]
bas 5, expnt(s) = [73510.507973]
bas 6, expnt(s) = [36755.23445447]
bas 7, expnt(s) = [7331.80116023]
bas 8, expnt(s) = [18377.16117273]
bas 9, expnt(s) = [1238.97754598]
bas 10, expnt(s) = [298.18917633]
bas 11, expnt(s) = [88.47484324]
bas 12, expnt(s) = [30.73641132]
bas 13, expnt(s) = [7.65882124]
bas 14, expnt(s) = [3.45306625]
bas 15, expnt(s) = [8.59906097]
bas 16, expnt(s) = [0.49393792]
CPU time:       249.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.41579442e-01 1.12884371e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180116e+03 2.00181082e+03
 1.83771612e+04 3.98771253e+03 1.23897755e+03 5.27609493e+02
 2.98189176e+02 1.81294209e+02 8.84748432e+01 7.28836100e+01
 3.07364113e+01 3.29803222e+01 7.65882124e+00 1.16315201e+01
 3.45306625e+00 6.39983397e+00 8.59906097e+00 4.29584079e+01
 4.93937923e-01 1.20802203e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.320584735376855
cond(S) = 12530.6423847667
E1 = -688.5189421410365  E_coul = 184.40593655746503
init E= -504.113005583572
    CPU time for initialize scf      4.70 sec, wall time      0.35 sec
  HOMO = -0.694824637871123  LUMO = 8.79811824976739
  mo_energy =
[-1.21739032e+02 -1.34121955e+01 -7.66561611e+00 -7.66561611e+00
 -7.66561611e+00 -1.62964830e+00 -6.94824638e-01 -6.94824638e-01
 -6.94824638e-01  8.79811825e+00  8.49337035e+01  4.58071704e+02
  2.22226832e+03  1.13994614e+04  4.09924554e+04  1.09848228e+05
  2.54049094e+05  5.48479914e+05  1.15242838e+06  2.43021162e+06
  5.37494698e+06]
E1 = -706.2156912317818  E_coul = 198.33332366845005
cycle= 1 E= -507.882367563332  delta_E= -3.77  |g|= 0.453  |ddm|= 0.618
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.588836
diis-c [-0.34672786  1.        ]
  HOMO = -0.257280980358836  LUMO = 9.68981010183129
  mo_energy =
[-1.20322522e+02 -1.23970946e+01 -6.70543086e+00 -6.70543086e+00
 -6.70543086e+00 -1.17011331e+00 -2.57280980e-01 -2.57280980e-01
 -2.57280980e-01  9.68981010e+00  8.62147877e+01  4.59470311e+02
  2.22360736e+03  1.14006716e+04  4.09935923e+04  1.09849326e+05
  2.54050164e+05  5.48480964e+05  1.15242941e+06  2.43021265e+06
  5.37494800e+06]
E1 = -705.8527378377759  E_coul = 197.96338992301193
cycle= 2 E= -507.889347914764  delta_E= -0.00698  |g|= 0.0189  |ddm|= 0.226
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156021
diis-c [-2.39659389e-04  3.28591426e-03  9.96714086e-01]
  HOMO = -0.262139134463733  LUMO = 9.67888898537126
  mo_energy =
[-1.20380446e+02 -1.24206244e+01 -6.73414998e+00 -6.73414998e+00
 -6.73414998e+00 -1.17244002e+00 -2.62139134e-01 -2.62139134e-01
 -2.62139134e-01  9.67888899e+00  8.61746824e+01  4.59411830e+02
  2.22353480e+03  1.14005897e+04  4.09935073e+04  1.09849239e+05
  2.54050078e+05  5.48480877e+05  1.15242933e+06  2.43021256e+06
  5.37494791e+06]
E1 = -705.8372929800306  E_coul = 197.94793103641533
cycle= 3 E= -507.889361943615  delta_E= -1.4e-05  |g|= 0.00091  |ddm|= 0.0104
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000742668
diis-c [-1.44977265e-08  4.23947536e-05 -4.90932695e-02  1.04905087e+00]
  HOMO = -0.26238280857394  LUMO = 9.67834830038706
  mo_energy =
[-1.20383008e+02 -1.24217779e+01 -6.73553373e+00 -6.73553373e+00
 -6.73553373e+00 -1.17255099e+00 -2.62382809e-01 -2.62382809e-01
 -2.62382809e-01  9.67834830e+00  8.61728195e+01  4.59409286e+02
  2.22353184e+03  1.14005865e+04  4.09935041e+04  1.09849236e+05
  2.54050074e+05  5.48480874e+05  1.15242932e+06  2.43021256e+06
  5.37494791e+06]
E1 = -705.8365229497421  E_coul = 197.9471609715238
cycle= 4 E= -507.889361978218  delta_E= -3.46e-08  |g|= 6.29e-06  |ddm|= 0.000546
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.50988e-06
diis-c [-4.81762684e-12 -2.13777782e-06  2.15431181e-03 -4.39720833e-02
  1.04181991e+00]
  HOMO = -0.262383748691237  LUMO = 9.67834707818697
  mo_energy =
[-1.20383008e+02 -1.24217812e+01 -6.73553627e+00 -6.73553627e+00
 -6.73553627e+00 -1.17255148e+00 -2.62383749e-01 -2.62383749e-01
 -2.62383749e-01  9.67834708e+00  8.61728181e+01  4.59409287e+02
  2.22353185e+03  1.14005865e+04  4.09935041e+04  1.09849236e+05
  2.54050074e+05  5.48480874e+05  1.15242932e+06  2.43021256e+06
  5.37494791e+06]
E1 = -705.8365213350564  E_coul = 197.94715935683638
cycle= 5 E= -507.88936197822  delta_E= -1.76e-12  |g|= 1.38e-07  |ddm|= 2.7e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -705.8365213350564  E_coul = 197.94715935683638
  HOMO = -0.262383780923961  LUMO = 9.67834702000211
  mo_energy =
[-1.20383008e+02 -1.24217813e+01 -6.73553642e+00 -6.73553642e+00
 -6.73553642e+00 -1.17255150e+00 -2.62383781e-01 -2.62383781e-01
 -2.62383781e-01  9.67834702e+00  8.61728179e+01  4.59409286e+02
  2.22353185e+03  1.14005865e+04  4.09935041e+04  1.09849236e+05
  2.54050074e+05  5.48480874e+05  1.15242932e+06  2.43021256e+06
  5.37494791e+06]
E1 = -705.8365212538218  E_coul = 197.94715927560185
Extra cycle  E= -507.88936197822  delta_E= 5.68e-14  |g|= 7.1e-09  |ddm|= 7.56e-08
    CPU time for scf_cycle      4.78 sec, wall time      0.43 sec
exp = [3.41579442e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180116e+03
 1.83771612e+04 1.23897755e+03 2.98189176e+02 8.84748432e+01
 3.07364113e+01 7.65882124e+00 3.45306625e+00 8.59906097e+00
 4.93937923e-01]
E = -507.88936197822
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.398352174118       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079738        1
[INPUT] 0    0    [1    /1   ]  36755.2344591        1
[INPUT] 0    0    [1    /1   ]  7331.80141501        1
[INPUT] 0    0    [1    /1   ]  18377.1611842        1
[INPUT] 0    0    [1    /1   ]  1238.97759497        1
[INPUT] 0    0    [1    /1   ]  298.189484815        1
[INPUT] 0    0    [1    /1   ]  88.4618904854        1
[INPUT] 0    0    [1    /1   ]  30.7221934383        1
[INPUT] 0    0    [1    /1   ]  7.01312220927        1
[INPUT] 0    0    [1    /1   ]  2.79365131863        1
[INPUT] 1    0    [1    /1   ]  8.58731135538        1
[INPUT] 1    0    [1    /1   ]  0.489051837005       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3983521741181835, 1.0]], [0, [1176168.142606494, 1.0]], [0, [588084.0713032113, 1.0]], [0, [294042.03565150575, 1.0]], [0, [147021.01782512217, 1.0]], [0, [73510.5079737613, 1.0]], [0, [36755.23445911344, 1.0]], [0, [7331.8014150130375, 1.0]], [0, [18377.161184239518, 1.0]], [0, [1238.9775949683653, 1.0]], [0, [298.1894848150165, 1.0]], [0, [88.46189048535523, 1.0]], [0, [30.72219343825209, 1.0]], [0, [7.013122209274238, 1.0]], [0, [2.79365131862788, 1.0]], [1, [8.58731135538241, 1.0]], [1, [0.4890518370048211, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39835217]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130321]
bas 3, expnt(s) = [294042.03565151]
bas 4, expnt(s) = [147021.01782512]
bas 5, expnt(s) = [73510.50797376]
bas 6, expnt(s) = [36755.23445911]
bas 7, expnt(s) = [7331.80141501]
bas 8, expnt(s) = [18377.16118424]
bas 9, expnt(s) = [1238.97759497]
bas 10, expnt(s) = [298.18948482]
bas 11, expnt(s) = [88.46189049]
bas 12, expnt(s) = [30.72219344]
bas 13, expnt(s) = [7.01312221]
bas 14, expnt(s) = [2.79365132]
bas 15, expnt(s) = [8.58731136]
bas 16, expnt(s) = [0.48905184]
CPU time:       254.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.98352174e-01 1.26682148e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180142e+03 2.00181088e+03
 1.83771612e+04 3.98771253e+03 1.23897759e+03 5.27609509e+02
 2.98189485e+02 1.81294349e+02 8.84618905e+01 7.28756072e+01
 3.07221934e+01 3.29688796e+01 7.01312221e+00 1.08880117e+01
 2.79365132e+00 5.45939068e+00 8.58731136e+00 4.28850484e+01
 4.89051837e-01 1.19310320e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.330383849604193
cond(S) = 12528.830085077016
E1 = -689.1793858950879  E_coul = 184.73718242532894
init E= -504.442203469759
    CPU time for initialize scf      4.93 sec, wall time      0.35 sec
  HOMO = -0.678335357256056  LUMO = 6.94707171653434
  mo_energy =
[-1.21722830e+02 -1.34002847e+01 -7.63880632e+00 -7.63880632e+00
 -7.63880632e+00 -1.64432911e+00 -6.78335357e-01 -6.78335357e-01
 -6.78335357e-01  6.94707172e+00  7.97383361e+01  4.53037753e+02
  2.21793934e+03  1.13957987e+04  4.09890959e+04  1.09845018e+05
  2.54045990e+05  5.48476900e+05  1.15242545e+06  2.43020878e+06
  5.37494422e+06]
E1 = -706.8485252436135  E_coul = 198.9329172198474
cycle= 1 E= -507.915608023766  delta_E= -3.47  |g|= 0.448  |ddm|= 0.354
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.5924
diis-c [-0.35093819  1.        ]
  HOMO = -0.239967890600614  LUMO = 7.78278006705097
  mo_energy =
[-1.20275452e+02 -1.23641501e+01 -6.65636313e+00 -6.65636313e+00
 -6.65636313e+00 -1.16653482e+00 -2.39967891e-01 -2.39967891e-01
 -2.39967891e-01  7.78278007e+00  8.10407271e+01  4.54468103e+02
  2.21931387e+03  1.13970475e+04  4.09902724e+04  1.09846156e+05
  2.54047100e+05  5.48477990e+05  1.15242652e+06  2.43020984e+06
  5.37494528e+06]
E1 = -706.4162403677797  E_coul = 198.49268605099797
cycle= 2 E= -507.923554316782  delta_E= -0.00795  |g|= 0.0206  |ddm|= 0.244
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0162937
diis-c [-2.58969482e-04  4.29224010e-03  9.95707760e-01]
  HOMO = -0.245993346097638  LUMO = 7.77114681774999
  mo_energy =
[-1.20341864e+02 -1.23925891e+01 -6.69075648e+00 -6.69075648e+00
 -6.69075648e+00 -1.16979570e+00 -2.45993346e-01 -2.45993346e-01
 -2.45993346e-01  7.77114682e+00  8.09941584e+01  4.54401084e+02
  2.21923173e+03  1.13969554e+04  4.09901770e+04  1.09846059e+05
  2.54047003e+05  5.48477892e+05  1.15242643e+06  2.43020975e+06
  5.37494518e+06]
E1 = -706.3954264770058  E_coul = 198.47185132982364
cycle= 3 E= -507.923575147182  delta_E= -2.08e-05  |g|= 0.00116  |ddm|= 0.013
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000850929
diis-c [-4.95033280e-08  7.41438412e-05 -5.26450709e-02  1.05257093e+00]
  HOMO = -0.246347559884581  LUMO = 7.77047482141187
  mo_energy =
[-1.20345188e+02 -1.23942061e+01 -6.69265908e+00 -6.69265908e+00
 -6.69265908e+00 -1.16997900e+00 -2.46347560e-01 -2.46347560e-01
 -2.46347560e-01  7.77047482e+00  8.09916941e+01  4.54397778e+02
  2.21922794e+03  1.13969513e+04  4.09901728e+04  1.09846055e+05
  2.54046998e+05  5.48477888e+05  1.15242642e+06  2.43020974e+06
  5.37494518e+06]
E1 = -706.3942186971711  E_coul = 198.47064347834723
cycle= 4 E= -507.923575218824  delta_E= -7.16e-08  |g|= 1.61e-05  |ddm|= 0.000807
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.26371e-05
diis-c [-9.89284832e-12 -2.62410378e-06  3.08756639e-03 -6.10970422e-02
  1.05801210e+00]
  HOMO = -0.246351077005809  LUMO = 7.7704696693193
  mo_energy =
[-1.20345200e+02 -1.23942195e+01 -6.69267183e+00 -6.69267183e+00
 -6.69267183e+00 -1.16998094e+00 -2.46351077e-01 -2.46351077e-01
 -2.46351077e-01  7.77046967e+00  8.09916819e+01  4.54397766e+02
  2.21922793e+03  1.13969513e+04  4.09901728e+04  1.09846055e+05
  2.54046998e+05  5.48477888e+05  1.15242642e+06  2.43020974e+06
  5.37494518e+06]
E1 = -706.3942092591457  E_coul = 198.47063404030806
cycle= 5 E= -507.923575218838  delta_E= -1.38e-11  |g|= 1.73e-07  |ddm|= 9.35e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.3942092591457  E_coul = 198.47063404030806
  HOMO = -0.246351119511342  LUMO = 7.77046960062473
  mo_energy =
[-1.20345201e+02 -1.23942197e+01 -6.69267202e+00 -6.69267202e+00
 -6.69267202e+00 -1.16998096e+00 -2.46351120e-01 -2.46351120e-01
 -2.46351120e-01  7.77046960e+00  8.09916816e+01  4.54397766e+02
  2.21922793e+03  1.13969513e+04  4.09901728e+04  1.09846055e+05
  2.54046998e+05  5.48477888e+05  1.15242642e+06  2.43020974e+06
  5.37494518e+06]
E1 = -706.3942091364619  E_coul = 198.47063391762453
Extra cycle  E= -507.923575218837  delta_E= 2.84e-13  |g|= 1.02e-08  |ddm|= 1e-07
    CPU time for scf_cycle      5.01 sec, wall time      0.42 sec
exp = [3.98352174e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180142e+03
 1.83771612e+04 1.23897759e+03 2.98189485e+02 8.84618905e+01
 3.07221934e+01 7.01312221e+00 2.79365132e+00 8.58731136e+00
 4.89051837e-01]
E = -507.92357521883736
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.398352174118       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035652        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079738        1
[INPUT] 0    0    [1    /1   ]  36755.2344591        1
[INPUT] 0    0    [1    /1   ]  7331.80141501        1
[INPUT] 0    0    [1    /1   ]  18377.1611842        1
[INPUT] 0    0    [1    /1   ]  1238.97759497        1
[INPUT] 0    0    [1    /1   ]  298.189484815        1
[INPUT] 0    0    [1    /1   ]  88.4618904854        1
[INPUT] 0    0    [1    /1   ]  30.7221934383        1
[INPUT] 0    0    [1    /1   ]  7.01312220927        1
[INPUT] 0    0    [1    /1   ]  2.79365131863        1
[INPUT] 1    0    [1    /1   ]  8.58731135538        1
[INPUT] 1    0    [1    /1   ]  0.489051837005       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3983521741181835, 1.0]], [0, [1176168.142606494, 1.0]], [0, [588084.0713032113, 1.0]], [0, [294042.03565150575, 1.0]], [0, [147021.01782512217, 1.0]], [0, [73510.5079737613, 1.0]], [0, [36755.23445911344, 1.0]], [0, [7331.8014150130375, 1.0]], [0, [18377.161184239518, 1.0]], [0, [1238.9775949683653, 1.0]], [0, [298.1894848150165, 1.0]], [0, [88.46189048535523, 1.0]], [0, [30.72219343825209, 1.0]], [0, [7.013122209274238, 1.0]], [0, [2.79365131862788, 1.0]], [1, [8.58731135538241, 1.0]], [1, [0.4890518370048211, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39835217]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130321]
bas 3, expnt(s) = [294042.03565151]
bas 4, expnt(s) = [147021.01782512]
bas 5, expnt(s) = [73510.50797376]
bas 6, expnt(s) = [36755.23445911]
bas 7, expnt(s) = [7331.80141501]
bas 8, expnt(s) = [18377.16118424]
bas 9, expnt(s) = [1238.97759497]
bas 10, expnt(s) = [298.18948482]
bas 11, expnt(s) = [88.46189049]
bas 12, expnt(s) = [30.72219344]
bas 13, expnt(s) = [7.01312221]
bas 14, expnt(s) = [2.79365132]
bas 15, expnt(s) = [8.58731136]
bas 16, expnt(s) = [0.48905184]
CPU time:       259.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.98352174e-01 1.26682148e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180142e+03 2.00181088e+03
 1.83771612e+04 3.98771253e+03 1.23897759e+03 5.27609509e+02
 2.98189485e+02 1.81294349e+02 8.84618905e+01 7.28756072e+01
 3.07221934e+01 3.29688796e+01 7.01312221e+00 1.08880117e+01
 2.79365132e+00 5.45939068e+00 8.58731136e+00 4.28850484e+01
 4.89051837e-01 1.19310320e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.330383849604193
cond(S) = 12528.830085077016
E1 = -689.1793858950879  E_coul = 184.73718242532894
init E= -504.442203469759
    CPU time for initialize scf      4.46 sec, wall time      0.33 sec
  HOMO = -0.678335357256056  LUMO = 6.94707171653434
  mo_energy =
[-1.21722830e+02 -1.34002847e+01 -7.63880632e+00 -7.63880632e+00
 -7.63880632e+00 -1.64432911e+00 -6.78335357e-01 -6.78335357e-01
 -6.78335357e-01  6.94707172e+00  7.97383361e+01  4.53037753e+02
  2.21793934e+03  1.13957987e+04  4.09890959e+04  1.09845018e+05
  2.54045990e+05  5.48476900e+05  1.15242545e+06  2.43020878e+06
  5.37494422e+06]
E1 = -706.8485252436135  E_coul = 198.9329172198474
cycle= 1 E= -507.915608023766  delta_E= -3.47  |g|= 0.448  |ddm|= 0.354
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.5924
diis-c [-0.35093819  1.        ]
  HOMO = -0.239967890600614  LUMO = 7.78278006705097
  mo_energy =
[-1.20275452e+02 -1.23641501e+01 -6.65636313e+00 -6.65636313e+00
 -6.65636313e+00 -1.16653482e+00 -2.39967891e-01 -2.39967891e-01
 -2.39967891e-01  7.78278007e+00  8.10407271e+01  4.54468103e+02
  2.21931387e+03  1.13970475e+04  4.09902724e+04  1.09846156e+05
  2.54047100e+05  5.48477990e+05  1.15242652e+06  2.43020984e+06
  5.37494528e+06]
E1 = -706.4162403677797  E_coul = 198.49268605099797
cycle= 2 E= -507.923554316782  delta_E= -0.00795  |g|= 0.0206  |ddm|= 0.244
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0162937
diis-c [-2.58969482e-04  4.29224010e-03  9.95707760e-01]
  HOMO = -0.245993346097638  LUMO = 7.77114681774999
  mo_energy =
[-1.20341864e+02 -1.23925891e+01 -6.69075648e+00 -6.69075648e+00
 -6.69075648e+00 -1.16979570e+00 -2.45993346e-01 -2.45993346e-01
 -2.45993346e-01  7.77114682e+00  8.09941584e+01  4.54401084e+02
  2.21923173e+03  1.13969554e+04  4.09901770e+04  1.09846059e+05
  2.54047003e+05  5.48477892e+05  1.15242643e+06  2.43020975e+06
  5.37494518e+06]
E1 = -706.3954264770058  E_coul = 198.47185132982364
cycle= 3 E= -507.923575147182  delta_E= -2.08e-05  |g|= 0.00116  |ddm|= 0.013
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000850929
diis-c [-4.95033280e-08  7.41438412e-05 -5.26450709e-02  1.05257093e+00]
  HOMO = -0.246347559884581  LUMO = 7.77047482141187
  mo_energy =
[-1.20345188e+02 -1.23942061e+01 -6.69265908e+00 -6.69265908e+00
 -6.69265908e+00 -1.16997900e+00 -2.46347560e-01 -2.46347560e-01
 -2.46347560e-01  7.77047482e+00  8.09916941e+01  4.54397778e+02
  2.21922794e+03  1.13969513e+04  4.09901728e+04  1.09846055e+05
  2.54046998e+05  5.48477888e+05  1.15242642e+06  2.43020974e+06
  5.37494518e+06]
E1 = -706.3942186971711  E_coul = 198.47064347834723
cycle= 4 E= -507.923575218824  delta_E= -7.16e-08  |g|= 1.61e-05  |ddm|= 0.000807
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.26371e-05
diis-c [-9.89284832e-12 -2.62410378e-06  3.08756639e-03 -6.10970422e-02
  1.05801210e+00]
  HOMO = -0.246351077005809  LUMO = 7.7704696693193
  mo_energy =
[-1.20345200e+02 -1.23942195e+01 -6.69267183e+00 -6.69267183e+00
 -6.69267183e+00 -1.16998094e+00 -2.46351077e-01 -2.46351077e-01
 -2.46351077e-01  7.77046967e+00  8.09916819e+01  4.54397766e+02
  2.21922793e+03  1.13969513e+04  4.09901728e+04  1.09846055e+05
  2.54046998e+05  5.48477888e+05  1.15242642e+06  2.43020974e+06
  5.37494518e+06]
E1 = -706.3942092591457  E_coul = 198.47063404030806
cycle= 5 E= -507.923575218838  delta_E= -1.38e-11  |g|= 1.73e-07  |ddm|= 9.35e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.3942092591457  E_coul = 198.47063404030806
  HOMO = -0.246351119511342  LUMO = 7.77046960062473
  mo_energy =
[-1.20345201e+02 -1.23942197e+01 -6.69267202e+00 -6.69267202e+00
 -6.69267202e+00 -1.16998096e+00 -2.46351120e-01 -2.46351120e-01
 -2.46351120e-01  7.77046960e+00  8.09916816e+01  4.54397766e+02
  2.21922793e+03  1.13969513e+04  4.09901728e+04  1.09846055e+05
  2.54046998e+05  5.48477888e+05  1.15242642e+06  2.43020974e+06
  5.37494518e+06]
E1 = -706.3942091364619  E_coul = 198.47063391762453
Extra cycle  E= -507.923575218837  delta_E= 2.84e-13  |g|= 1.02e-08  |ddm|= 1e-07
    CPU time for scf_cycle      4.73 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12528.830085077016
E1 = -706.3942091364619  E_coul = 198.47063391762453
init E= -507.923575218837
    CPU time for initialize scf      9.85 sec, wall time      0.69 sec
  HOMO = -0.246351121895406  LUMO = 7.77046959718914
  mo_energy =
[-1.20345201e+02 -1.23942197e+01 -6.69267203e+00 -6.69267203e+00
 -6.69267203e+00 -1.16998097e+00 -2.46351122e-01 -2.46351122e-01
 -2.46351122e-01  7.77046960e+00  8.09916816e+01  4.54397766e+02
  2.21922793e+03  1.13969513e+04  4.09901728e+04  1.09846055e+05
  2.54046998e+05  5.48477888e+05  1.15242642e+06  2.43020974e+06
  5.37494518e+06]
E1 = -706.3942091296324  E_coul = 198.47063391079504
cycle= 1 E= -507.923575218837  delta_E= 5.68e-14  |g|= 8.83e-10  |ddm|= 5.99e-09
    CPU time for cycle= 1      0.08 sec, wall time      0.01 sec
E1 = -706.3942091296324  E_coul = 198.47063391079504
  HOMO = -0.246351122036167  LUMO = 7.7704695969001
  mo_energy =
[-1.20345201e+02 -1.23942197e+01 -6.69267203e+00 -6.69267203e+00
 -6.69267203e+00 -1.16998097e+00 -2.46351122e-01 -2.46351122e-01
 -2.46351122e-01  7.77046960e+00  8.09916816e+01  4.54397766e+02
  2.21922793e+03  1.13969513e+04  4.09901728e+04  1.09846055e+05
  2.54046998e+05  5.48477888e+05  1.15242642e+06  2.43020974e+06
  5.37494518e+06]
E1 = -706.3942091292284  E_coul = 198.4706339103911
Extra cycle  E= -507.923575218837  delta_E= -5.68e-14  |g|= 7.21e-10  |ddm|= 3.58e-10
    CPU time for scf_cycle     10.00 sec, wall time      0.76 sec
exp = [3.98352174e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180142e+03
 1.83771612e+04 1.23897759e+03 2.98189485e+02 8.84618905e+01
 3.07221934e+01 7.01312221e+00 2.79365132e+00 8.58731136e+00
 4.89051837e-01]
grad_E = [ 1.71699812e-02 -1.90234028e-11  4.16875155e-10  1.40019163e-09
  8.22362416e-09  2.70879221e-08  1.65069687e-07  9.05996708e-06
  4.08400698e-07 -1.14203355e-06  3.61812035e-05 -1.36092505e-03
 -8.70458956e-04 -7.79957315e-03  4.03071007e-03 -1.09991160e-02
 -1.28812045e-01]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396407488329       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079736        1
[INPUT] 0    0    [1    /1   ]  36755.2344583        1
[INPUT] 0    0    [1    /1   ]  7331.801372          1
[INPUT] 0    0    [1    /1   ]  18377.1611823        1
[INPUT] 0    0    [1    /1   ]  1238.97758907        1
[INPUT] 0    0    [1    /1   ]  298.189414838        1
[INPUT] 0    0    [1    /1   ]  88.4648843189        1
[INPUT] 0    0    [1    /1   ]  30.7250926618        1
[INPUT] 0    0    [1    /1   ]  7.10927296847        1
[INPUT] 0    0    [1    /1   ]  2.87688159273        1
[INPUT] 1    0    [1    /1   ]  8.60142144224        1
[INPUT] 1    0    [1    /1   ]  0.492913135355       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3964074883289166, 1.0]], [0, [1176168.142606494, 1.0]], [0, [588084.0713032093, 1.0]], [0, [294042.0356514991, 1.0]], [0, [147021.01782508308, 1.0]], [0, [73510.50797363253, 1.0]], [0, [36755.234458329025, 1.0]], [0, [7331.801372000181, 1.0]], [0, [18377.161182297135, 1.0]], [0, [1238.9775890719486, 1.0]], [0, [298.1894148382855, 1.0]], [0, [88.46488431894957, 1.0]], [0, [30.72509266181139, 1.0]], [0, [7.109272968469024, 1.0]], [0, [2.8768815927295246, 1.0]], [1, [8.601421442240955, 1.0]], [1, [0.4929131353545029, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39640749]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130321]
bas 3, expnt(s) = [294042.0356515]
bas 4, expnt(s) = [147021.01782508]
bas 5, expnt(s) = [73510.50797363]
bas 6, expnt(s) = [36755.23445833]
bas 7, expnt(s) = [7331.801372]
bas 8, expnt(s) = [18377.1611823]
bas 9, expnt(s) = [1238.97758907]
bas 10, expnt(s) = [298.18941484]
bas 11, expnt(s) = [88.46488432]
bas 12, expnt(s) = [30.72509266]
bas 13, expnt(s) = [7.10927297]
bas 14, expnt(s) = [2.87688159]
bas 15, expnt(s) = [8.60142144]
bas 16, expnt(s) = [0.49291314]
CPU time:       277.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96407488e-01 1.26218034e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180137e+03 2.00181087e+03
 1.83771612e+04 3.98771253e+03 1.23897759e+03 5.27609507e+02
 2.98189415e+02 1.81294317e+02 8.84648843e+01 7.28774570e+01
 3.07250927e+01 3.29712130e+01 7.10927297e+00 1.09997779e+01
 2.87688159e+00 5.58092922e+00 8.60142144e+00 4.29731487e+01
 4.92913135e-01 1.20488995e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32558197069202
cond(S) = 12529.085539685855
E1 = -689.3632440647187  E_coul = 184.91467166159526
init E= -504.448572403123
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.674216826146835  LUMO = 7.22799490215762
  mo_energy =
[-1.21699759e+02 -1.33854231e+01 -7.62768254e+00 -7.62768254e+00
 -7.62768254e+00 -1.64063027e+00 -6.74216826e-01 -6.74216826e-01
 -6.74216826e-01  7.22799490e+00  8.05018981e+01  4.53778394e+02
  2.21858145e+03  1.13963463e+04  4.09896004e+04  1.09845501e+05
  2.54046458e+05  5.48477355e+05  1.15242589e+06  2.43020921e+06
  5.37494464e+06]
E1 = -707.0899391513129  E_coul = 199.1735528115236
cycle= 1 E= -507.916386339789  delta_E= -3.47  |g|= 0.449  |ddm|= 0.36
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.592333
diis-c [-0.35085821  1.        ]
  HOMO = -0.232010979903007  LUMO = 8.07642034787311
  mo_energy =
[-1.20248120e+02 -1.23455178e+01 -6.64159863e+00 -6.64159863e+00
 -6.64159863e+00 -1.16064376e+00 -2.32010980e-01 -2.32010980e-01
 -2.32010980e-01  8.07642035e+00  8.18089089e+01  4.55212792e+02
  2.21995982e+03  1.13975987e+04  4.09907803e+04  1.09846642e+05
  2.54047572e+05  5.48478449e+05  1.15242697e+06  2.43021028e+06
  5.37494570e+06]
E1 = -706.6690237764516  E_coul = 198.74488886603632
cycle= 2 E= -507.924134910415  delta_E= -0.00775  |g|= 0.0203  |ddm|= 0.24
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0162083
diis-c [-2.56552569e-04  4.17302178e-03  9.95826978e-01]
  HOMO = -0.237852218390458  LUMO = 8.06492458497209
  mo_energy =
[-1.20313255e+02 -1.23730876e+01 -6.67502956e+00 -6.67502956e+00
 -6.67502956e+00 -1.16374958e+00 -2.37852218e-01 -2.37852218e-01
 -2.37852218e-01  8.06492458e+00  8.17633642e+01  4.55147053e+02
  2.21987907e+03  1.13975080e+04  4.09906864e+04  1.09846547e+05
  2.54047476e+05  5.48478352e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6491279984323  E_coul = 198.72497357672725
cycle= 3 E= -507.924154421705  delta_E= -1.95e-05  |g|= 0.00111  |ddm|= 0.0125
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000832904
diis-c [-4.18461468e-08  6.96600300e-05 -5.20231870e-02  1.05195353e+00]
  HOMO = -0.238187986216787  LUMO = 8.06427513951195
  mo_energy =
[-1.20316457e+02 -1.23746227e+01 -6.67684286e+00 -6.67684286e+00
 -6.67684286e+00 -1.16392040e+00 -2.38187986e-01 -2.38187986e-01
 -2.38187986e-01  8.06427514e+00  8.17609989e+01  4.55143869e+02
  2.21987540e+03  1.13975041e+04  4.09906823e+04  1.09846543e+05
  2.54047472e+05  5.48478348e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6479988945007  E_coul = 198.72384440884537
cycle= 4 E= -507.924154485655  delta_E= -6.4e-08  |g|= 1.44e-05  |ddm|= 0.00076
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.13298e-05
diis-c [-9.14910639e-12 -2.54582875e-06  2.96878656e-03 -5.91246960e-02
  1.05615846e+00]
  HOMO = -0.238191035495154  LUMO = 8.06427066353439
  mo_energy =
[-1.20316467e+02 -1.23746342e+01 -6.67685378e+00 -6.67685378e+00
 -6.67685378e+00 -1.16392207e+00 -2.38191035e-01 -2.38191035e-01
 -2.38191035e-01  8.06427066e+00  8.17609886e+01  4.55143860e+02
  2.21987539e+03  1.13975041e+04  4.09906823e+04  1.09846543e+05
  2.54047472e+05  5.48478348e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6479910042183  E_coul = 198.7238365185532
cycle= 5 E= -507.924154485665  delta_E= -9.78e-12  |g|= 1.7e-07  |ddm|= 8.11e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6479910042183  E_coul = 198.7238365185532
  HOMO = -0.238191077423368  LUMO = 8.0642705975179
  mo_energy =
[-1.20316467e+02 -1.23746344e+01 -6.67685397e+00 -6.67685397e+00
 -6.67685397e+00 -1.16392209e+00 -2.38191077e-01 -2.38191077e-01
 -2.38191077e-01  8.06427060e+00  8.17609884e+01  4.55143859e+02
  2.21987539e+03  1.13975041e+04  4.09906823e+04  1.09846543e+05
  2.54047472e+05  5.48478348e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6479908850695  E_coul = 198.723836399404
Extra cycle  E= -507.924154485665  delta_E= -3.41e-13  |g|= 9.87e-09  |ddm|= 9.84e-08
    CPU time for scf_cycle      5.02 sec, wall time      0.40 sec
exp = [3.96407488e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180137e+03
 1.83771612e+04 1.23897759e+03 2.98189415e+02 8.84648843e+01
 3.07250927e+01 7.10927297e+00 2.87688159e+00 8.60142144e+00
 4.92913135e-01]
E = -507.92415448566544
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396407488329       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079736        1
[INPUT] 0    0    [1    /1   ]  36755.2344583        1
[INPUT] 0    0    [1    /1   ]  7331.801372          1
[INPUT] 0    0    [1    /1   ]  18377.1611823        1
[INPUT] 0    0    [1    /1   ]  1238.97758907        1
[INPUT] 0    0    [1    /1   ]  298.189414838        1
[INPUT] 0    0    [1    /1   ]  88.4648843189        1
[INPUT] 0    0    [1    /1   ]  30.7250926618        1
[INPUT] 0    0    [1    /1   ]  7.10927296847        1
[INPUT] 0    0    [1    /1   ]  2.87688159273        1
[INPUT] 1    0    [1    /1   ]  8.60142144224        1
[INPUT] 1    0    [1    /1   ]  0.492913135355       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3964074883289166, 1.0]], [0, [1176168.142606494, 1.0]], [0, [588084.0713032093, 1.0]], [0, [294042.0356514991, 1.0]], [0, [147021.01782508308, 1.0]], [0, [73510.50797363253, 1.0]], [0, [36755.234458329025, 1.0]], [0, [7331.801372000181, 1.0]], [0, [18377.161182297135, 1.0]], [0, [1238.9775890719486, 1.0]], [0, [298.1894148382855, 1.0]], [0, [88.46488431894957, 1.0]], [0, [30.72509266181139, 1.0]], [0, [7.109272968469024, 1.0]], [0, [2.8768815927295246, 1.0]], [1, [8.601421442240955, 1.0]], [1, [0.4929131353545029, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39640749]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130321]
bas 3, expnt(s) = [294042.0356515]
bas 4, expnt(s) = [147021.01782508]
bas 5, expnt(s) = [73510.50797363]
bas 6, expnt(s) = [36755.23445833]
bas 7, expnt(s) = [7331.801372]
bas 8, expnt(s) = [18377.1611823]
bas 9, expnt(s) = [1238.97758907]
bas 10, expnt(s) = [298.18941484]
bas 11, expnt(s) = [88.46488432]
bas 12, expnt(s) = [30.72509266]
bas 13, expnt(s) = [7.10927297]
bas 14, expnt(s) = [2.87688159]
bas 15, expnt(s) = [8.60142144]
bas 16, expnt(s) = [0.49291314]
CPU time:       282.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96407488e-01 1.26218034e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180137e+03 2.00181087e+03
 1.83771612e+04 3.98771253e+03 1.23897759e+03 5.27609507e+02
 2.98189415e+02 1.81294317e+02 8.84648843e+01 7.28774570e+01
 3.07250927e+01 3.29712130e+01 7.10927297e+00 1.09997779e+01
 2.87688159e+00 5.58092922e+00 8.60142144e+00 4.29731487e+01
 4.92913135e-01 1.20488995e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32558197069202
cond(S) = 12529.085539685855
E1 = -689.3632440647187  E_coul = 184.91467166159526
init E= -504.448572403123
    CPU time for initialize scf      4.61 sec, wall time      0.32 sec
  HOMO = -0.674216826146835  LUMO = 7.22799490215762
  mo_energy =
[-1.21699759e+02 -1.33854231e+01 -7.62768254e+00 -7.62768254e+00
 -7.62768254e+00 -1.64063027e+00 -6.74216826e-01 -6.74216826e-01
 -6.74216826e-01  7.22799490e+00  8.05018981e+01  4.53778394e+02
  2.21858145e+03  1.13963463e+04  4.09896004e+04  1.09845501e+05
  2.54046458e+05  5.48477355e+05  1.15242589e+06  2.43020921e+06
  5.37494464e+06]
E1 = -707.0899391513129  E_coul = 199.1735528115236
cycle= 1 E= -507.916386339789  delta_E= -3.47  |g|= 0.449  |ddm|= 0.36
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.592333
diis-c [-0.35085821  1.        ]
  HOMO = -0.232010979903007  LUMO = 8.07642034787311
  mo_energy =
[-1.20248120e+02 -1.23455178e+01 -6.64159863e+00 -6.64159863e+00
 -6.64159863e+00 -1.16064376e+00 -2.32010980e-01 -2.32010980e-01
 -2.32010980e-01  8.07642035e+00  8.18089089e+01  4.55212792e+02
  2.21995982e+03  1.13975987e+04  4.09907803e+04  1.09846642e+05
  2.54047572e+05  5.48478449e+05  1.15242697e+06  2.43021028e+06
  5.37494570e+06]
E1 = -706.6690237764516  E_coul = 198.74488886603632
cycle= 2 E= -507.924134910415  delta_E= -0.00775  |g|= 0.0203  |ddm|= 0.24
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0162083
diis-c [-2.56552569e-04  4.17302178e-03  9.95826978e-01]
  HOMO = -0.237852218390458  LUMO = 8.06492458497209
  mo_energy =
[-1.20313255e+02 -1.23730876e+01 -6.67502956e+00 -6.67502956e+00
 -6.67502956e+00 -1.16374958e+00 -2.37852218e-01 -2.37852218e-01
 -2.37852218e-01  8.06492458e+00  8.17633642e+01  4.55147053e+02
  2.21987907e+03  1.13975080e+04  4.09906864e+04  1.09846547e+05
  2.54047476e+05  5.48478352e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6491279984323  E_coul = 198.72497357672725
cycle= 3 E= -507.924154421705  delta_E= -1.95e-05  |g|= 0.00111  |ddm|= 0.0125
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000832904
diis-c [-4.18461468e-08  6.96600300e-05 -5.20231870e-02  1.05195353e+00]
  HOMO = -0.238187986216787  LUMO = 8.06427513951195
  mo_energy =
[-1.20316457e+02 -1.23746227e+01 -6.67684286e+00 -6.67684286e+00
 -6.67684286e+00 -1.16392040e+00 -2.38187986e-01 -2.38187986e-01
 -2.38187986e-01  8.06427514e+00  8.17609989e+01  4.55143869e+02
  2.21987540e+03  1.13975041e+04  4.09906823e+04  1.09846543e+05
  2.54047472e+05  5.48478348e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6479988945007  E_coul = 198.72384440884537
cycle= 4 E= -507.924154485655  delta_E= -6.4e-08  |g|= 1.44e-05  |ddm|= 0.00076
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.13298e-05
diis-c [-9.14910639e-12 -2.54582875e-06  2.96878656e-03 -5.91246960e-02
  1.05615846e+00]
  HOMO = -0.238191035495154  LUMO = 8.06427066353439
  mo_energy =
[-1.20316467e+02 -1.23746342e+01 -6.67685378e+00 -6.67685378e+00
 -6.67685378e+00 -1.16392207e+00 -2.38191035e-01 -2.38191035e-01
 -2.38191035e-01  8.06427066e+00  8.17609886e+01  4.55143860e+02
  2.21987539e+03  1.13975041e+04  4.09906823e+04  1.09846543e+05
  2.54047472e+05  5.48478348e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6479910042183  E_coul = 198.7238365185532
cycle= 5 E= -507.924154485665  delta_E= -9.78e-12  |g|= 1.7e-07  |ddm|= 8.11e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6479910042183  E_coul = 198.7238365185532
  HOMO = -0.238191077423368  LUMO = 8.0642705975179
  mo_energy =
[-1.20316467e+02 -1.23746344e+01 -6.67685397e+00 -6.67685397e+00
 -6.67685397e+00 -1.16392209e+00 -2.38191077e-01 -2.38191077e-01
 -2.38191077e-01  8.06427060e+00  8.17609884e+01  4.55143859e+02
  2.21987539e+03  1.13975041e+04  4.09906823e+04  1.09846543e+05
  2.54047472e+05  5.48478348e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6479908850695  E_coul = 198.723836399404
Extra cycle  E= -507.924154485665  delta_E= -3.41e-13  |g|= 9.87e-09  |ddm|= 9.84e-08
    CPU time for scf_cycle      4.87 sec, wall time      0.39 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12529.085539685855
E1 = -706.6479908850695  E_coul = 198.723836399404
init E= -507.924154485665
    CPU time for initialize scf     10.58 sec, wall time      0.72 sec
  HOMO = -0.23819107972481  LUMO = 8.06427059175203
  mo_energy =
[-1.20316467e+02 -1.23746344e+01 -6.67685398e+00 -6.67685398e+00
 -6.67685398e+00 -1.16392209e+00 -2.38191080e-01 -2.38191080e-01
 -2.38191080e-01  8.06427059e+00  8.17609883e+01  4.55143859e+02
  2.21987539e+03  1.13975041e+04  4.09906823e+04  1.09846543e+05
  2.54047472e+05  5.48478348e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6479908786181  E_coul = 198.72383639295285
cycle= 1 E= -507.924154485665  delta_E= 2.27e-13  |g|= 1.17e-09  |ddm|= 5.72e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.6479908786181  E_coul = 198.72383639295285
  HOMO = -0.238191079856946  LUMO = 8.06427059099506
  mo_energy =
[-1.20316467e+02 -1.23746344e+01 -6.67685398e+00 -6.67685398e+00
 -6.67685398e+00 -1.16392210e+00 -2.38191080e-01 -2.38191080e-01
 -2.38191080e-01  8.06427059e+00  8.17609883e+01  4.55143859e+02
  2.21987539e+03  1.13975041e+04  4.09906823e+04  1.09846543e+05
  2.54047472e+05  5.48478348e+05  1.15242687e+06  2.43021018e+06
  5.37494560e+06]
E1 = -706.6479908782723  E_coul = 198.72383639260707
Extra cycle  E= -507.924154485665  delta_E=    0  |g|= 1.26e-09  |ddm|= 3.34e-10
    CPU time for scf_cycle     10.65 sec, wall time      0.80 sec
exp = [3.96407488e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180137e+03
 1.83771612e+04 1.23897759e+03 2.98189415e+02 8.84648843e+01
 3.07250927e+01 7.10927297e+00 2.87688159e+00 8.60142144e+00
 4.92913135e-01]
grad_E = [ 7.41674671e-03 -1.90534326e-11  4.16649996e-10  1.39933875e-09
  8.21933560e-09  2.70717899e-08  1.64984242e-07  9.05491958e-06
  4.08124783e-07 -8.00833147e-07  3.04813305e-05 -1.32154946e-03
 -1.00897422e-03 -9.60830162e-03  1.13138229e-02 -2.86839045e-03
 -3.87680551e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.394491719422       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079736        1
[INPUT] 0    0    [1    /1   ]  36755.2344583        1
[INPUT] 0    0    [1    /1   ]  7331.80136783        1
[INPUT] 0    0    [1    /1   ]  18377.1611821        1
[INPUT] 0    0    [1    /1   ]  1238.97759175        1
[INPUT] 0    0    [1    /1   ]  298.189380888        1
[INPUT] 0    0    [1    /1   ]  88.4662204198        1
[INPUT] 0    0    [1    /1   ]  30.7258619872        1
[INPUT] 0    0    [1    /1   ]  7.09810854887        1
[INPUT] 0    0    [1    /1   ]  2.85051620188        1
[INPUT] 1    0    [1    /1   ]  8.60725850008        1
[INPUT] 1    0    [1    /1   ]  0.494090549147       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3944917194218767, 1.0]], [0, [1176168.142606494, 1.0]], [0, [588084.071303209, 1.0]], [0, [294042.0356514985, 1.0]], [0, [147021.0178250793, 1.0]], [0, [73510.5079736201, 1.0]], [0, [36755.23445825318, 1.0]], [0, [7331.801367828972, 1.0]], [0, [18377.161182109885, 1.0]], [0, [1238.97759174649, 1.0]], [0, [298.189380888475, 1.0]], [0, [88.46622041979282, 1.0]], [0, [30.725861987156268, 1.0]], [0, [7.09810854887327, 1.0]], [0, [2.850516201879587, 1.0]], [1, [8.60725850008373, 1.0]], [1, [0.49409054914727046, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39449172]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130321]
bas 3, expnt(s) = [294042.0356515]
bas 4, expnt(s) = [147021.01782508]
bas 5, expnt(s) = [73510.50797362]
bas 6, expnt(s) = [36755.23445825]
bas 7, expnt(s) = [7331.80136783]
bas 8, expnt(s) = [18377.16118211]
bas 9, expnt(s) = [1238.97759175]
bas 10, expnt(s) = [298.18938089]
bas 11, expnt(s) = [88.46622042]
bas 12, expnt(s) = [30.72586199]
bas 13, expnt(s) = [7.09810855]
bas 14, expnt(s) = [2.8505162]
bas 15, expnt(s) = [8.6072585]
bas 16, expnt(s) = [0.49409055]
CPU time:       300.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.94491719e-01 1.25760265e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180137e+03 2.00181087e+03
 1.83771612e+04 3.98771253e+03 1.23897759e+03 5.27609508e+02
 2.98189381e+02 1.81294302e+02 8.84662204e+01 7.28782825e+01
 3.07258620e+01 3.29718322e+01 7.09810855e+00 1.09868198e+01
 2.85051620e+00 5.54252499e+00 8.60725850e+00 4.30096046e+01
 4.94090549e-01 1.20848865e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324209433604715
cond(S) = 12529.026815504638
E1 = -689.4167509691674  E_coul = 184.96841605248497
init E= -504.448334916682
    CPU time for initialize scf      4.78 sec, wall time      0.34 sec
  HOMO = -0.673371850361076  LUMO = 7.14758892661596
  mo_energy =
[-1.21691560e+02 -1.33812015e+01 -7.62425978e+00 -7.62425978e+00
 -7.62425978e+00 -1.63895647e+00 -6.73371850e-01 -6.73371850e-01
 -6.73371850e-01  7.14758893e+00  8.03415593e+01  4.53639291e+02
  2.21846763e+03  1.13962521e+04  4.09895148e+04  1.09845420e+05
  2.54046379e+05  5.48477279e+05  1.15242582e+06  2.43020914e+06
  5.37494457e+06]
E1 = -707.1455039196736  E_coul = 199.22913236972698
cycle= 1 E= -507.916371549947  delta_E= -3.47  |g|= 0.45  |ddm|= 0.36
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.592777
diis-c [-0.3513851  1.       ]
  HOMO = -0.230302224205913  LUMO = 7.99445043370716
  mo_energy =
[-1.20240462e+02 -1.23414603e+01 -6.63853126e+00 -6.63853126e+00
 -6.63853126e+00 -1.15895937e+00 -2.30302224e-01 -2.30302224e-01
 -2.30302224e-01  7.99445043e+00  8.16480852e+01  4.55073200e+02
  2.21984526e+03  1.13975036e+04  4.09906937e+04  1.09846560e+05
  2.54047492e+05  5.48478372e+05  1.15242690e+06  2.43021021e+06
  5.37494563e+06]
E1 = -706.7189110968037  E_coul = 198.79464473547122
cycle= 2 E= -507.924266361332  delta_E= -0.00789  |g|= 0.0205  |ddm|= 0.241
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0163115
diis-c [-2.59857780e-04  4.18739813e-03  9.95812602e-01]
  HOMO = -0.236266856799701  LUMO = 7.98283285136243
  mo_energy =
[-1.20306287e+02 -1.23694335e+01 -6.67242284e+00 -6.67242284e+00
 -6.67242284e+00 -1.16212039e+00 -2.36266857e-01 -2.36266857e-01
 -2.36266857e-01  7.98283285e+00  8.16019905e+01  4.55006767e+02
  2.21976373e+03  1.13974121e+04  4.09905990e+04  1.09846464e+05
  2.54047395e+05  5.48478275e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6986682458413  E_coul = 198.7743818219093
cycle= 3 E= -507.924286423932  delta_E= -2.01e-05  |g|= 0.00113  |ddm|= 0.0127
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000841627
diis-c [-4.42299009e-08  7.00354191e-05 -5.21873093e-02  1.05211727e+00]
  HOMO = -0.236611185319925  LUMO = 7.98217359546722
  mo_energy =
[-1.20309535e+02 -1.23709975e+01 -6.67426809e+00 -6.67426809e+00
 -6.67426809e+00 -1.16229491e+00 -2.36611185e-01 -2.36611185e-01
 -2.36611185e-01  7.98217360e+00  8.15995880e+01  4.55003538e+02
  2.21976002e+03  1.13974081e+04  4.09905949e+04  1.09846460e+05
  2.54047391e+05  5.48478271e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6975141421501  E_coul = 198.77322765175094
cycle= 4 E= -507.924286490399  delta_E= -6.65e-08  |g|= 1.49e-05  |ddm|= 0.000771
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.17276e-05
diis-c [-9.42209759e-12 -2.55778749e-06  3.00228863e-03 -5.96686656e-02
  1.05666893e+00]
  HOMO = -0.236614358242796  LUMO = 7.9821689743688
  mo_energy =
[-1.20309545e+02 -1.23710094e+01 -6.67427937e+00 -6.67427937e+00
 -6.67427937e+00 -1.16229664e+00 -2.36614358e-01 -2.36614358e-01
 -2.36614358e-01  7.98216897e+00  8.15995773e+01  4.55003528e+02
  2.21976001e+03  1.13974081e+04  4.09905949e+04  1.09846460e+05
  2.54047391e+05  5.48478271e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6975059269104  E_coul = 198.7732194365001
cycle= 5 E= -507.92428649041  delta_E= -1.11e-11  |g|= 1.71e-07  |ddm|= 8.36e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6975059269104  E_coul = 198.7732194365001
  HOMO = -0.236614400737518  LUMO = 7.98216890574072
  mo_energy =
[-1.20309545e+02 -1.23710096e+01 -6.67427956e+00 -6.67427956e+00
 -6.67427956e+00 -1.16229666e+00 -2.36614401e-01 -2.36614401e-01
 -2.36614401e-01  7.98216891e+00  8.15995771e+01  4.55003528e+02
  2.21976001e+03  1.13974081e+04  4.09905949e+04  1.09846460e+05
  2.54047391e+05  5.48478271e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6975058064032  E_coul = 198.77321931599332
Extra cycle  E= -507.92428649041  delta_E= 3.41e-13  |g|= 9.89e-09  |ddm|= 9.86e-08
    CPU time for scf_cycle      5.03 sec, wall time      0.41 sec
exp = [3.94491719e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180137e+03
 1.83771612e+04 1.23897759e+03 2.98189381e+02 8.84662204e+01
 3.07258620e+01 7.09810855e+00 2.85051620e+00 8.60725850e+00
 4.94090549e-01]
E = -507.92428649040994
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.394491719422       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079736        1
[INPUT] 0    0    [1    /1   ]  36755.2344583        1
[INPUT] 0    0    [1    /1   ]  7331.80136783        1
[INPUT] 0    0    [1    /1   ]  18377.1611821        1
[INPUT] 0    0    [1    /1   ]  1238.97759175        1
[INPUT] 0    0    [1    /1   ]  298.189380888        1
[INPUT] 0    0    [1    /1   ]  88.4662204198        1
[INPUT] 0    0    [1    /1   ]  30.7258619872        1
[INPUT] 0    0    [1    /1   ]  7.09810854887        1
[INPUT] 0    0    [1    /1   ]  2.85051620188        1
[INPUT] 1    0    [1    /1   ]  8.60725850008        1
[INPUT] 1    0    [1    /1   ]  0.494090549147       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3944917194218767, 1.0]], [0, [1176168.142606494, 1.0]], [0, [588084.071303209, 1.0]], [0, [294042.0356514985, 1.0]], [0, [147021.0178250793, 1.0]], [0, [73510.5079736201, 1.0]], [0, [36755.23445825318, 1.0]], [0, [7331.801367828972, 1.0]], [0, [18377.161182109885, 1.0]], [0, [1238.97759174649, 1.0]], [0, [298.189380888475, 1.0]], [0, [88.46622041979282, 1.0]], [0, [30.725861987156268, 1.0]], [0, [7.09810854887327, 1.0]], [0, [2.850516201879587, 1.0]], [1, [8.60725850008373, 1.0]], [1, [0.49409054914727046, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39449172]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130321]
bas 3, expnt(s) = [294042.0356515]
bas 4, expnt(s) = [147021.01782508]
bas 5, expnt(s) = [73510.50797362]
bas 6, expnt(s) = [36755.23445825]
bas 7, expnt(s) = [7331.80136783]
bas 8, expnt(s) = [18377.16118211]
bas 9, expnt(s) = [1238.97759175]
bas 10, expnt(s) = [298.18938089]
bas 11, expnt(s) = [88.46622042]
bas 12, expnt(s) = [30.72586199]
bas 13, expnt(s) = [7.09810855]
bas 14, expnt(s) = [2.8505162]
bas 15, expnt(s) = [8.6072585]
bas 16, expnt(s) = [0.49409055]
CPU time:       305.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.94491719e-01 1.25760265e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180137e+03 2.00181087e+03
 1.83771612e+04 3.98771253e+03 1.23897759e+03 5.27609508e+02
 2.98189381e+02 1.81294302e+02 8.84662204e+01 7.28782825e+01
 3.07258620e+01 3.29718322e+01 7.09810855e+00 1.09868198e+01
 2.85051620e+00 5.54252499e+00 8.60725850e+00 4.30096046e+01
 4.94090549e-01 1.20848865e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324209433604715
cond(S) = 12529.026815504638
E1 = -689.4167509691674  E_coul = 184.96841605248497
init E= -504.448334916682
    CPU time for initialize scf      4.83 sec, wall time      0.34 sec
  HOMO = -0.673371850361076  LUMO = 7.14758892661596
  mo_energy =
[-1.21691560e+02 -1.33812015e+01 -7.62425978e+00 -7.62425978e+00
 -7.62425978e+00 -1.63895647e+00 -6.73371850e-01 -6.73371850e-01
 -6.73371850e-01  7.14758893e+00  8.03415593e+01  4.53639291e+02
  2.21846763e+03  1.13962521e+04  4.09895148e+04  1.09845420e+05
  2.54046379e+05  5.48477279e+05  1.15242582e+06  2.43020914e+06
  5.37494457e+06]
E1 = -707.1455039196736  E_coul = 199.22913236972698
cycle= 1 E= -507.916371549947  delta_E= -3.47  |g|= 0.45  |ddm|= 0.36
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592777
diis-c [-0.3513851  1.       ]
  HOMO = -0.230302224205913  LUMO = 7.99445043370716
  mo_energy =
[-1.20240462e+02 -1.23414603e+01 -6.63853126e+00 -6.63853126e+00
 -6.63853126e+00 -1.15895937e+00 -2.30302224e-01 -2.30302224e-01
 -2.30302224e-01  7.99445043e+00  8.16480852e+01  4.55073200e+02
  2.21984526e+03  1.13975036e+04  4.09906937e+04  1.09846560e+05
  2.54047492e+05  5.48478372e+05  1.15242690e+06  2.43021021e+06
  5.37494563e+06]
E1 = -706.7189110968037  E_coul = 198.79464473547122
cycle= 2 E= -507.924266361332  delta_E= -0.00789  |g|= 0.0205  |ddm|= 0.241
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0163115
diis-c [-2.59857780e-04  4.18739813e-03  9.95812602e-01]
  HOMO = -0.236266856799701  LUMO = 7.98283285136243
  mo_energy =
[-1.20306287e+02 -1.23694335e+01 -6.67242284e+00 -6.67242284e+00
 -6.67242284e+00 -1.16212039e+00 -2.36266857e-01 -2.36266857e-01
 -2.36266857e-01  7.98283285e+00  8.16019905e+01  4.55006767e+02
  2.21976373e+03  1.13974121e+04  4.09905990e+04  1.09846464e+05
  2.54047395e+05  5.48478275e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6986682458413  E_coul = 198.7743818219093
cycle= 3 E= -507.924286423932  delta_E= -2.01e-05  |g|= 0.00113  |ddm|= 0.0127
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000841627
diis-c [-4.42299009e-08  7.00354191e-05 -5.21873093e-02  1.05211727e+00]
  HOMO = -0.236611185319925  LUMO = 7.98217359546722
  mo_energy =
[-1.20309535e+02 -1.23709975e+01 -6.67426809e+00 -6.67426809e+00
 -6.67426809e+00 -1.16229491e+00 -2.36611185e-01 -2.36611185e-01
 -2.36611185e-01  7.98217360e+00  8.15995880e+01  4.55003538e+02
  2.21976002e+03  1.13974081e+04  4.09905949e+04  1.09846460e+05
  2.54047391e+05  5.48478271e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6975141421501  E_coul = 198.77322765175094
cycle= 4 E= -507.924286490399  delta_E= -6.65e-08  |g|= 1.49e-05  |ddm|= 0.000771
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.17276e-05
diis-c [-9.42209759e-12 -2.55778749e-06  3.00228863e-03 -5.96686656e-02
  1.05666893e+00]
  HOMO = -0.236614358242796  LUMO = 7.9821689743688
  mo_energy =
[-1.20309545e+02 -1.23710094e+01 -6.67427937e+00 -6.67427937e+00
 -6.67427937e+00 -1.16229664e+00 -2.36614358e-01 -2.36614358e-01
 -2.36614358e-01  7.98216897e+00  8.15995773e+01  4.55003528e+02
  2.21976001e+03  1.13974081e+04  4.09905949e+04  1.09846460e+05
  2.54047391e+05  5.48478271e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6975059269104  E_coul = 198.7732194365001
cycle= 5 E= -507.92428649041  delta_E= -1.11e-11  |g|= 1.71e-07  |ddm|= 8.36e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6975059269104  E_coul = 198.7732194365001
  HOMO = -0.236614400737518  LUMO = 7.98216890574072
  mo_energy =
[-1.20309545e+02 -1.23710096e+01 -6.67427956e+00 -6.67427956e+00
 -6.67427956e+00 -1.16229666e+00 -2.36614401e-01 -2.36614401e-01
 -2.36614401e-01  7.98216891e+00  8.15995771e+01  4.55003528e+02
  2.21976001e+03  1.13974081e+04  4.09905949e+04  1.09846460e+05
  2.54047391e+05  5.48478271e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6975058064032  E_coul = 198.77321931599332
Extra cycle  E= -507.92428649041  delta_E= 3.41e-13  |g|= 9.89e-09  |ddm|= 9.86e-08
    CPU time for scf_cycle      5.09 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12529.026815504638
E1 = -706.6975058064032  E_coul = 198.77321931599332
init E= -507.92428649041
    CPU time for initialize scf     10.10 sec, wall time      0.68 sec
  HOMO = -0.236614403078511  LUMO = 7.98216890098312
  mo_energy =
[-1.20309545e+02 -1.23710096e+01 -6.67427957e+00 -6.67427957e+00
 -6.67427957e+00 -1.16229666e+00 -2.36614403e-01 -2.36614403e-01
 -2.36614403e-01  7.98216890e+00  8.15995771e+01  4.55003528e+02
  2.21976001e+03  1.13974081e+04  4.09905949e+04  1.09846460e+05
  2.54047391e+05  5.48478271e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6975057998509  E_coul = 198.77321930944063
cycle= 1 E= -507.92428649041  delta_E= -3.41e-13  |g|= 9.77e-10  |ddm|= 5.78e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6975057998509  E_coul = 198.77321930944063
  HOMO = -0.236614403213703  LUMO = 7.98216890257045
  mo_energy =
[-1.20309545e+02 -1.23710096e+01 -6.67427958e+00 -6.67427958e+00
 -6.67427958e+00 -1.16229666e+00 -2.36614403e-01 -2.36614403e-01
 -2.36614403e-01  7.98216890e+00  8.15995771e+01  4.55003528e+02
  2.21976001e+03  1.13974081e+04  4.09905949e+04  1.09846460e+05
  2.54047391e+05  5.48478271e+05  1.15242680e+06  2.43021011e+06
  5.37494553e+06]
E1 = -706.6975057994844  E_coul = 198.7732193090744
Extra cycle  E= -507.92428649041  delta_E= 3.41e-13  |g|= 1.21e-09  |ddm|= 3.6e-10
    CPU time for scf_cycle     10.27 sec, wall time      0.75 sec
exp = [3.94491719e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180137e+03
 1.83771612e+04 1.23897759e+03 2.98189381e+02 8.84662204e+01
 3.07258620e+01 7.09810855e+00 2.85051620e+00 8.60725850e+00
 4.94090549e-01]
grad_E = [-1.64940277e-02 -1.90351674e-11  4.16753864e-10  1.39974045e-09
  8.22129592e-09  2.70793427e-08  1.65023309e-07  9.05735060e-06
  4.08256084e-07 -1.02471000e-06  3.43095539e-05 -1.35622664e-03
 -9.09132439e-04 -8.26558229e-03  7.61833251e-03  6.13957774e-04
  3.14754350e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395187638593       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079736        1
[INPUT] 0    0    [1    /1   ]  36755.2344579        1
[INPUT] 0    0    [1    /1   ]  7331.80134689        1
[INPUT] 0    0    [1    /1   ]  18377.1611812        1
[INPUT] 0    0    [1    /1   ]  1238.97759362        1
[INPUT] 0    0    [1    /1   ]  298.18930594         1
[INPUT] 0    0    [1    /1   ]  88.4691911454        1
[INPUT] 0    0    [1    /1   ]  30.7279027015        1
[INPUT] 0    0    [1    /1   ]  7.11759782684        1
[INPUT] 0    0    [1    /1   ]  2.84978489196        1
[INPUT] 1    0    [1    /1   ]  8.61080088543        1
[INPUT] 1    0    [1    /1   ]  0.494535672736       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3951876385927529, 1.0]], [0, [1176168.142606494, 1.0]], [0, [588084.0713032081, 1.0]], [0, [294042.0356514952, 1.0]], [0, [147021.0178250603, 1.0]], [0, [73510.5079735575, 1.0]], [0, [36755.234457871666, 1.0]], [0, [7331.801346891269, 1.0]], [0, [18377.161181165957, 1.0]], [0, [1238.9775936209085, 1.0]], [0, [298.18930593959664, 1.0]], [0, [88.46919114543698, 1.0]], [0, [30.72790270150517, 1.0]], [0, [7.117597826837538, 1.0]], [0, [2.849784891963907, 1.0]], [1, [8.61080088542943, 1.0]], [1, [0.49453567273625715, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39518764]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130321]
bas 3, expnt(s) = [294042.0356515]
bas 4, expnt(s) = [147021.01782506]
bas 5, expnt(s) = [73510.50797356]
bas 6, expnt(s) = [36755.23445787]
bas 7, expnt(s) = [7331.80134689]
bas 8, expnt(s) = [18377.16118117]
bas 9, expnt(s) = [1238.97759362]
bas 10, expnt(s) = [298.18930594]
bas 11, expnt(s) = [88.46919115]
bas 12, expnt(s) = [30.7279027]
bas 13, expnt(s) = [7.11759783]
bas 14, expnt(s) = [2.84978489]
bas 15, expnt(s) = [8.61080089]
bas 16, expnt(s) = [0.49453567]
CPU time:       323.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95187639e-01 1.25926617e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180135e+03 2.00181086e+03
 1.83771612e+04 3.98771253e+03 1.23897759e+03 5.27609508e+02
 2.98189306e+02 1.81294268e+02 8.84691911e+01 7.28801179e+01
 3.07279027e+01 3.29734746e+01 7.11759783e+00 1.10094369e+01
 2.84978489e+00 5.54145849e+00 8.61080089e+00 4.30317320e+01
 4.94535673e-01 1.20984971e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.323518319645686
cond(S) = 12529.055862154286
E1 = -689.454282637705  E_coul = 185.00213349447378
init E= -504.452149143231
    CPU time for initialize scf      4.74 sec, wall time      0.33 sec
  HOMO = -0.672731115844437  LUMO = 7.16796346919072
  mo_energy =
[-1.21686697e+02 -1.33786509e+01 -7.62201162e+00 -7.62201162e+00
 -7.62201162e+00 -1.63849604e+00 -6.72731116e-01 -6.72731116e-01
 -6.72731116e-01  7.16796347e+00  8.04261335e+01  4.53736213e+02
  2.21855741e+03  1.13963299e+04  4.09895867e+04  1.09845489e+05
  2.54046446e+05  5.48477344e+05  1.15242588e+06  2.43020920e+06
  5.37494463e+06]
E1 = -707.1934000323454  E_coul = 199.27686713823488
cycle= 1 E= -507.916532894111  delta_E= -3.46  |g|= 0.45  |ddm|= 0.359
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.592897
diis-c [-0.35152738  1.        ]
  HOMO = -0.229034512381363  LUMO = 8.01610108867753
  mo_energy =
[-1.20234378e+02 -1.23380215e+01 -6.63538900e+00 -6.63538900e+00
 -6.63538900e+00 -1.15792071e+00 -2.29034512e-01 -2.29034512e-01
 -2.29034512e-01  8.01610109e+00  8.17337405e+01  4.55171335e+02
  2.21993630e+03  1.13975827e+04  4.09907670e+04  1.09846630e+05
  2.54047560e+05  5.48478438e+05  1.15242696e+06  2.43021027e+06
  5.37494569e+06]
E1 = -706.7673128133554  E_coul = 198.84289634882484
cycle= 2 E= -507.924416464531  delta_E= -0.00788  |g|= 0.0205  |ddm|= 0.241
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0163177
diis-c [-2.60048017e-04  4.19049918e-03  9.95809501e-01]
  HOMO = -0.234988830640868  LUMO = 8.00448697335142
  mo_energy =
[-1.20300171e+02 -1.23659424e+01 -6.66923563e+00 -6.66923563e+00
 -6.66923563e+00 -1.16107302e+00 -2.34988831e-01 -2.34988831e-01
 -2.34988831e-01  8.00448697e+00  8.16876731e+01  4.55104934e+02
  2.21985479e+03  1.13974912e+04  4.09906723e+04  1.09846534e+05
  2.54047464e+05  5.48478341e+05  1.15242686e+06  2.43021017e+06
  5.37494560e+06]
E1 = -706.7471273571136  E_coul = 198.82269093065756
cycle= 3 E= -507.924436426456  delta_E= -2e-05  |g|= 0.00113  |ddm|= 0.0126
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000841101
diis-c [-4.38875177e-08  6.98376589e-05 -5.21448301e-02  1.05207499e+00]
  HOMO = -0.235332013384281  LUMO = 8.00382904148353
  mo_energy =
[-1.20303413e+02 -1.23675011e+01 -6.67107567e+00 -6.67107567e+00
 -6.67107567e+00 -1.16124680e+00 -2.35332013e-01 -2.35332013e-01
 -2.35332013e-01  8.00382904e+00  8.16852756e+01  4.55101710e+02
  2.21985109e+03  1.13974873e+04  4.09906682e+04  1.09846530e+05
  2.54047459e+05  5.48478337e+05  1.15242686e+06  2.43021017e+06
  5.37494559e+06]
E1 = -706.7459783960844  E_coul = 198.82154190371176
cycle= 4 E= -507.924436492373  delta_E= -6.59e-08  |g|= 1.48e-05  |ddm|= 0.000766
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.16763e-05
diis-c [-9.40871727e-12 -2.54475049e-06  2.99843042e-03 -5.96113208e-02
  1.05661544e+00]
  HOMO = -0.235335156516275  LUMO = 8.00382446731385
  mo_energy =
[-1.20303423e+02 -1.23675130e+01 -6.67108683e+00 -6.67108683e+00
 -6.67108683e+00 -1.16124851e+00 -2.35335157e-01 -2.35335157e-01
 -2.35335157e-01  8.00382447e+00  8.16852650e+01  4.55101701e+02
  2.21985108e+03  1.13974872e+04  4.09906682e+04  1.09846530e+05
  2.54047459e+05  5.48478337e+05  1.15242686e+06  2.43021017e+06
  5.37494559e+06]
E1 = -706.7459702808395  E_coul = 198.8215337884564
cycle= 5 E= -507.924436492383  delta_E= -1.05e-11  |g|= 1.71e-07  |ddm|= 8.27e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7459702808395  E_coul = 198.8215337884564
  HOMO = -0.235335199086595  LUMO = 8.00382439781476
  mo_energy =
[-1.20303423e+02 -1.23675131e+01 -6.67108702e+00 -6.67108702e+00
 -6.67108702e+00 -1.16124854e+00 -2.35335199e-01 -2.35335199e-01
 -2.35335199e-01  8.00382440e+00  8.16852648e+01  4.55101700e+02
  2.21985108e+03  1.13974872e+04  4.09906682e+04  1.09846530e+05
  2.54047459e+05  5.48478337e+05  1.15242686e+06  2.43021017e+06
  5.37494559e+06]
E1 = -706.7459701600991  E_coul = 198.82153366771547
Extra cycle  E= -507.924436492384  delta_E= -5.12e-13  |g|= 9.91e-09  |ddm|= 9.85e-08
    CPU time for scf_cycle      4.94 sec, wall time      0.41 sec
exp = [3.95187639e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180135e+03
 1.83771612e+04 1.23897759e+03 2.98189306e+02 8.84691911e+01
 3.07279027e+01 7.11759783e+00 2.84978489e+00 8.61080089e+00
 4.94535673e-01]
E = -507.9244364923836
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395187638593       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079736        1
[INPUT] 0    0    [1    /1   ]  36755.2344579        1
[INPUT] 0    0    [1    /1   ]  7331.80134689        1
[INPUT] 0    0    [1    /1   ]  18377.1611812        1
[INPUT] 0    0    [1    /1   ]  1238.97759362        1
[INPUT] 0    0    [1    /1   ]  298.18930594         1
[INPUT] 0    0    [1    /1   ]  88.4691911454        1
[INPUT] 0    0    [1    /1   ]  30.7279027015        1
[INPUT] 0    0    [1    /1   ]  7.11759782684        1
[INPUT] 0    0    [1    /1   ]  2.84978489196        1
[INPUT] 1    0    [1    /1   ]  8.61080088543        1
[INPUT] 1    0    [1    /1   ]  0.494535672736       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3951876385927529, 1.0]], [0, [1176168.142606494, 1.0]], [0, [588084.0713032081, 1.0]], [0, [294042.0356514952, 1.0]], [0, [147021.0178250603, 1.0]], [0, [73510.5079735575, 1.0]], [0, [36755.234457871666, 1.0]], [0, [7331.801346891269, 1.0]], [0, [18377.161181165957, 1.0]], [0, [1238.9775936209085, 1.0]], [0, [298.18930593959664, 1.0]], [0, [88.46919114543698, 1.0]], [0, [30.72790270150517, 1.0]], [0, [7.117597826837538, 1.0]], [0, [2.849784891963907, 1.0]], [1, [8.61080088542943, 1.0]], [1, [0.49453567273625715, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39518764]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130321]
bas 3, expnt(s) = [294042.0356515]
bas 4, expnt(s) = [147021.01782506]
bas 5, expnt(s) = [73510.50797356]
bas 6, expnt(s) = [36755.23445787]
bas 7, expnt(s) = [7331.80134689]
bas 8, expnt(s) = [18377.16118117]
bas 9, expnt(s) = [1238.97759362]
bas 10, expnt(s) = [298.18930594]
bas 11, expnt(s) = [88.46919115]
bas 12, expnt(s) = [30.7279027]
bas 13, expnt(s) = [7.11759783]
bas 14, expnt(s) = [2.84978489]
bas 15, expnt(s) = [8.61080089]
bas 16, expnt(s) = [0.49453567]
CPU time:       328.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95187639e-01 1.25926617e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180135e+03 2.00181086e+03
 1.83771612e+04 3.98771253e+03 1.23897759e+03 5.27609508e+02
 2.98189306e+02 1.81294268e+02 8.84691911e+01 7.28801179e+01
 3.07279027e+01 3.29734746e+01 7.11759783e+00 1.10094369e+01
 2.84978489e+00 5.54145849e+00 8.61080089e+00 4.30317320e+01
 4.94535673e-01 1.20984971e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.323518319645686
cond(S) = 12529.055862154286
E1 = -689.454282637705  E_coul = 185.00213349447378
init E= -504.452149143231
    CPU time for initialize scf      4.58 sec, wall time      0.32 sec
  HOMO = -0.672731115844437  LUMO = 7.16796346919072
  mo_energy =
[-1.21686697e+02 -1.33786509e+01 -7.62201162e+00 -7.62201162e+00
 -7.62201162e+00 -1.63849604e+00 -6.72731116e-01 -6.72731116e-01
 -6.72731116e-01  7.16796347e+00  8.04261335e+01  4.53736213e+02
  2.21855741e+03  1.13963299e+04  4.09895867e+04  1.09845489e+05
  2.54046446e+05  5.48477344e+05  1.15242588e+06  2.43020920e+06
  5.37494463e+06]
E1 = -707.1934000323454  E_coul = 199.27686713823488
cycle= 1 E= -507.916532894111  delta_E= -3.46  |g|= 0.45  |ddm|= 0.359
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592897
diis-c [-0.35152738  1.        ]
  HOMO = -0.229034512381363  LUMO = 8.01610108867753
  mo_energy =
[-1.20234378e+02 -1.23380215e+01 -6.63538900e+00 -6.63538900e+00
 -6.63538900e+00 -1.15792071e+00 -2.29034512e-01 -2.29034512e-01
 -2.29034512e-01  8.01610109e+00  8.17337405e+01  4.55171335e+02
  2.21993630e+03  1.13975827e+04  4.09907670e+04  1.09846630e+05
  2.54047560e+05  5.48478438e+05  1.15242696e+06  2.43021027e+06
  5.37494569e+06]
E1 = -706.7673128133554  E_coul = 198.84289634882484
cycle= 2 E= -507.924416464531  delta_E= -0.00788  |g|= 0.0205  |ddm|= 0.241
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0163177
diis-c [-2.60048017e-04  4.19049918e-03  9.95809501e-01]
  HOMO = -0.234988830640868  LUMO = 8.00448697335142
  mo_energy =
[-1.20300171e+02 -1.23659424e+01 -6.66923563e+00 -6.66923563e+00
 -6.66923563e+00 -1.16107302e+00 -2.34988831e-01 -2.34988831e-01
 -2.34988831e-01  8.00448697e+00  8.16876731e+01  4.55104934e+02
  2.21985479e+03  1.13974912e+04  4.09906723e+04  1.09846534e+05
  2.54047464e+05  5.48478341e+05  1.15242686e+06  2.43021017e+06
  5.37494560e+06]
E1 = -706.7471273571136  E_coul = 198.82269093065756
cycle= 3 E= -507.924436426456  delta_E= -2e-05  |g|= 0.00113  |ddm|= 0.0126
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000841101
diis-c [-4.38875177e-08  6.98376589e-05 -5.21448301e-02  1.05207499e+00]
  HOMO = -0.235332013384281  LUMO = 8.00382904148353
  mo_energy =
[-1.20303413e+02 -1.23675011e+01 -6.67107567e+00 -6.67107567e+00
 -6.67107567e+00 -1.16124680e+00 -2.35332013e-01 -2.35332013e-01
 -2.35332013e-01  8.00382904e+00  8.16852756e+01  4.55101710e+02
  2.21985109e+03  1.13974873e+04  4.09906682e+04  1.09846530e+05
  2.54047459e+05  5.48478337e+05  1.15242686e+06  2.43021017e+06
  5.37494559e+06]
E1 = -706.7459783960844  E_coul = 198.82154190371176
cycle= 4 E= -507.924436492373  delta_E= -6.59e-08  |g|= 1.48e-05  |ddm|= 0.000766
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.16763e-05
diis-c [-9.40871727e-12 -2.54475049e-06  2.99843042e-03 -5.96113208e-02
  1.05661544e+00]
  HOMO = -0.235335156516275  LUMO = 8.00382446731385
  mo_energy =
[-1.20303423e+02 -1.23675130e+01 -6.67108683e+00 -6.67108683e+00
 -6.67108683e+00 -1.16124851e+00 -2.35335157e-01 -2.35335157e-01
 -2.35335157e-01  8.00382447e+00  8.16852650e+01  4.55101701e+02
  2.21985108e+03  1.13974872e+04  4.09906682e+04  1.09846530e+05
  2.54047459e+05  5.48478337e+05  1.15242686e+06  2.43021017e+06
  5.37494559e+06]
E1 = -706.7459702808395  E_coul = 198.8215337884564
cycle= 5 E= -507.924436492383  delta_E= -1.05e-11  |g|= 1.71e-07  |ddm|= 8.27e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7459702808395  E_coul = 198.8215337884564
  HOMO = -0.235335199086595  LUMO = 8.00382439781476
  mo_energy =
[-1.20303423e+02 -1.23675131e+01 -6.67108702e+00 -6.67108702e+00
 -6.67108702e+00 -1.16124854e+00 -2.35335199e-01 -2.35335199e-01
 -2.35335199e-01  8.00382440e+00  8.16852648e+01  4.55101700e+02
  2.21985108e+03  1.13974872e+04  4.09906682e+04  1.09846530e+05
  2.54047459e+05  5.48478337e+05  1.15242686e+06  2.43021017e+06
  5.37494559e+06]
E1 = -706.7459701600991  E_coul = 198.82153366771547
Extra cycle  E= -507.924436492384  delta_E= -5.12e-13  |g|= 9.91e-09  |ddm|= 9.85e-08
    CPU time for scf_cycle      4.84 sec, wall time      0.39 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12529.055862154286
E1 = -706.7459701600991  E_coul = 198.82153366771547
init E= -507.924436492384
    CPU time for initialize scf      9.08 sec, wall time      0.71 sec
  HOMO = -0.235335201426925  LUMO = 8.00382439328799
  mo_energy =
[-1.20303423e+02 -1.23675131e+01 -6.67108703e+00 -6.67108703e+00
 -6.67108703e+00 -1.16124854e+00 -2.35335201e-01 -2.35335201e-01
 -2.35335201e-01  8.00382439e+00  8.16852648e+01  4.55101700e+02
  2.21985108e+03  1.13974872e+04  4.09906682e+04  1.09846530e+05
  2.54047459e+05  5.48478337e+05  1.15242686e+06  2.43021017e+06
  5.37494559e+06]
E1 = -706.7459701534998  E_coul = 198.82153366111655
cycle= 1 E= -507.924436492383  delta_E= 3.41e-13  |g|= 1.06e-09  |ddm|= 5.78e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.7459701534998  E_coul = 198.82153366111655
  HOMO = -0.235335201562418  LUMO = 8.00382439344168
  mo_energy =
[-1.20303423e+02 -1.23675131e+01 -6.67108703e+00 -6.67108703e+00
 -6.67108703e+00 -1.16124854e+00 -2.35335202e-01 -2.35335202e-01
 -2.35335202e-01  8.00382439e+00  8.16852648e+01  4.55101700e+02
  2.21985108e+03  1.13974872e+04  4.09906682e+04  1.09846530e+05
  2.54047459e+05  5.48478337e+05  1.15242686e+06  2.43021017e+06
  5.37494559e+06]
E1 = -706.7459701531519  E_coul = 198.82153366076867
Extra cycle  E= -507.924436492383  delta_E=    0  |g|= 6.86e-10  |ddm|= 3.38e-10
    CPU time for scf_cycle      9.15 sec, wall time      0.78 sec
exp = [3.95187639e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180135e+03
 1.83771612e+04 1.23897759e+03 2.98189306e+02 8.84691911e+01
 3.07279027e+01 7.11759783e+00 2.84978489e+00 8.61080089e+00
 4.94535673e-01]
grad_E = [-7.75783243e-03 -1.90305466e-11  4.16789996e-10  1.39987460e-09
  8.22198362e-09  2.70818727e-08  1.65037094e-07  9.05824320e-06
  4.08298130e-07 -1.10672656e-06  3.58182765e-05 -1.37550761e-03
 -8.60240773e-04 -7.57773495e-03  6.37576013e-03  3.17158987e-03
  4.53207522e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397059283844       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079731        1
[INPUT] 0    0    [1    /1   ]  36755.2344549        1
[INPUT] 0    0    [1    /1   ]  7331.80118487        1
[INPUT] 0    0    [1    /1   ]  18377.1611739        1
[INPUT] 0    0    [1    /1   ]  1238.97760489        1
[INPUT] 0    0    [1    /1   ]  298.188750079        1
[INPUT] 0    0    [1    /1   ]  88.4911190725        1
[INPUT] 0    0    [1    /1   ]  30.7429721996        1
[INPUT] 0    0    [1    /1   ]  7.28714948182        1
[INPUT] 0    0    [1    /1   ]  2.88247517432        1
[INPUT] 1    0    [1    /1   ]  8.62136124879        1
[INPUT] 1    0    [1    /1   ]  0.495438724326       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3970592838442732, 1.0]], [0, [1176168.1426064942, 1.0]], [0, [588084.0713032007, 1.0]], [0, [294042.0356514702, 1.0]], [0, [147021.0178249132, 1.0]], [0, [73510.50797307298, 1.0]], [0, [36755.234454919235, 1.0]], [0, [7331.801184873448, 1.0]], [0, [18377.16117386054, 1.0]], [0, [1238.9776048873462, 1.0]], [0, [298.188750078981, 1.0]], [0, [88.49111907247816, 1.0]], [0, [30.742972199616823, 1.0]], [0, [7.287149481824434, 1.0]], [0, [2.8824751743185857, 1.0]], [1, [8.621361248791692, 1.0]], [1, [0.4954387243262066, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39705928]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.0713032]
bas 3, expnt(s) = [294042.03565147]
bas 4, expnt(s) = [147021.01782491]
bas 5, expnt(s) = [73510.50797307]
bas 6, expnt(s) = [36755.23445492]
bas 7, expnt(s) = [7331.80118487]
bas 8, expnt(s) = [18377.16117386]
bas 9, expnt(s) = [1238.97760489]
bas 10, expnt(s) = [298.18875008]
bas 11, expnt(s) = [88.49111907]
bas 12, expnt(s) = [30.7429722]
bas 13, expnt(s) = [7.28714948]
bas 14, expnt(s) = [2.88247517]
bas 15, expnt(s) = [8.62136125]
bas 16, expnt(s) = [0.49543872]
CPU time:       345.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97059284e-01 1.26373653e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180118e+03 2.00181083e+03
 1.83771612e+04 3.98771253e+03 1.23897760e+03 5.27609512e+02
 2.98188750e+02 1.81294014e+02 8.84911191e+01 7.28936655e+01
 3.07429722e+01 3.29856019e+01 7.28714948e+00 1.12055527e+01
 2.88247517e+00 5.58906559e+00 8.62136125e+00 4.30977102e+01
 4.95438724e-01 1.21261191e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.322000730755956
cond(S) = 12529.357801239887
E1 = -689.5471038269018  E_coul = 185.08530855928788
init E= -504.461795267614
    CPU time for initialize scf      4.19 sec, wall time      0.34 sec
  HOMO = -0.671462904553134  LUMO = 7.40689556197881
  mo_energy =
[-1.21673668e+02 -1.33727360e+01 -7.61640068e+00 -7.61640068e+00
 -7.61640068e+00 -1.63735750e+00 -6.71462905e-01 -6.71462905e-01
 -6.71462905e-01  7.40689556e+00  8.12859060e+01  4.54668669e+02
  2.21940087e+03  1.13970532e+04  4.09902524e+04  1.09846126e+05
  2.54047063e+05  5.48477943e+05  1.15242646e+06  2.43020977e+06
  5.37494518e+06]
E1 = -707.3025244658506  E_coul = 199.38504349406972
cycle= 1 E= -507.917480971781  delta_E= -3.46  |g|= 0.45  |ddm|= 0.356
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593193
diis-c [-0.35187832  1.        ]
  HOMO = -0.226525025899327  LUMO = 8.26388103752597
  mo_energy =
[-1.20218879e+02 -1.23306818e+01 -6.62835240e+00 -6.62835240e+00
 -6.62835240e+00 -1.15569975e+00 -2.26525026e-01 -2.26525026e-01
 -2.26525026e-01  8.26388104e+00  8.25958144e+01  4.56106204e+02
  2.22078240e+03  1.13983088e+04  4.09914355e+04  1.09847270e+05
  2.54048180e+05  5.48479040e+05  1.15242755e+06  2.43021084e+06
  5.37494625e+06]
E1 = -706.8852520207478  E_coul = 198.9600685648524
cycle= 2 E= -507.925183455895  delta_E= -0.0077  |g|= 0.0202  |ddm|= 0.234
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0162741
diis-c [-2.58720347e-04  4.15683922e-03  9.95843161e-01]
  HOMO = -0.23228696132855  LUMO = 8.25235607149493
  mo_energy =
[-1.20283791e+02 -1.23578877e+01 -6.66147109e+00 -6.66147109e+00
 -6.66147109e+00 -1.15872927e+00 -2.32286961e-01 -2.32286961e-01
 -2.32286961e-01  8.25235607e+00  8.25504324e+01  4.56040685e+02
  2.22070182e+03  1.13982183e+04  4.09913417e+04  1.09847175e+05
  2.54048084e+05  5.48478944e+05  1.15242745e+06  2.43021074e+06
  5.37494615e+06]
E1 = -706.8658411465593  E_coul = 198.9406389415711
cycle= 3 E= -507.925202204988  delta_E= -1.87e-05  |g|= 0.00109  |ddm|= 0.012
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000828587
diis-c [-3.87819799e-08  6.63901774e-05 -5.16518948e-02  1.05158550e+00]
  HOMO = -0.232612716700836  LUMO = 8.25171629169353
  mo_energy =
[-1.20286939e+02 -1.23593785e+01 -6.66323982e+00 -6.66323982e+00
 -6.66323982e+00 -1.15889322e+00 -2.32612717e-01 -2.32612717e-01
 -2.32612717e-01  8.25171629e+00  8.25481108e+01  4.56037555e+02
  2.22069822e+03  1.13982144e+04  4.09913378e+04  1.09847171e+05
  2.54048080e+05  5.48478940e+05  1.15242745e+06  2.43021074e+06
  5.37494614e+06]
E1 = -706.8647577419157  E_coul = 198.93955547750522
cycle= 4 E= -507.92520226441  delta_E= -5.94e-08  |g|= 1.35e-05  |ddm|= 0.000716
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.08198e-05
diis-c [-8.91990434e-12 -2.46846510e-06  2.92481422e-03 -5.83815977e-02
  1.05545925e+00]
  HOMO = -0.232615465090635  LUMO = 8.25171230281868
  mo_energy =
[-1.20286947e+02 -1.23593888e+01 -6.66324942e+00 -6.66324942e+00
 -6.66324942e+00 -1.15889471e+00 -2.32615465e-01 -2.32615465e-01
 -2.32615465e-01  8.25171230e+00  8.25481019e+01  4.56037548e+02
  2.22069821e+03  1.13982144e+04  4.09913377e+04  1.09847171e+05
  2.54048080e+05  5.48478940e+05  1.15242745e+06  2.43021074e+06
  5.37494614e+06]
E1 = -706.864750868622  E_coul = 198.9395486042035
cycle= 5 E= -507.925202264418  delta_E= -7.96e-12  |g|= 1.68e-07  |ddm|= 7.2e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.864750868622  E_coul = 198.9395486042035
  HOMO = -0.232615507268311  LUMO = 8.25171223210272
  mo_energy =
[-1.20286948e+02 -1.23593890e+01 -6.66324962e+00 -6.66324962e+00
 -6.66324962e+00 -1.15889474e+00 -2.32615507e-01 -2.32615507e-01
 -2.32615507e-01  8.25171223e+00  8.25481017e+01  4.56037547e+02
  2.22069821e+03  1.13982144e+04  4.09913377e+04  1.09847171e+05
  2.54048080e+05  5.48478940e+05  1.15242745e+06  2.43021074e+06
  5.37494614e+06]
E1 = -706.8647507488729  E_coul = 198.9395484844543
Extra cycle  E= -507.925202264419  delta_E= -1.71e-13  |g|= 9.59e-09  |ddm|= 9.59e-08
    CPU time for scf_cycle      4.42 sec, wall time      0.41 sec
exp = [3.97059284e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180118e+03
 1.83771612e+04 1.23897760e+03 2.98188750e+02 8.84911191e+01
 3.07429722e+01 7.28714948e+00 2.88247517e+00 8.62136125e+00
 4.95438724e-01]
E = -507.9252022644186
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397059283844       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079731        1
[INPUT] 0    0    [1    /1   ]  36755.2344549        1
[INPUT] 0    0    [1    /1   ]  7331.80118487        1
[INPUT] 0    0    [1    /1   ]  18377.1611739        1
[INPUT] 0    0    [1    /1   ]  1238.97760489        1
[INPUT] 0    0    [1    /1   ]  298.188750079        1
[INPUT] 0    0    [1    /1   ]  88.4911190725        1
[INPUT] 0    0    [1    /1   ]  30.7429721996        1
[INPUT] 0    0    [1    /1   ]  7.28714948182        1
[INPUT] 0    0    [1    /1   ]  2.88247517432        1
[INPUT] 1    0    [1    /1   ]  8.62136124879        1
[INPUT] 1    0    [1    /1   ]  0.495438724326       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3970592838442732, 1.0]], [0, [1176168.1426064942, 1.0]], [0, [588084.0713032007, 1.0]], [0, [294042.0356514702, 1.0]], [0, [147021.0178249132, 1.0]], [0, [73510.50797307298, 1.0]], [0, [36755.234454919235, 1.0]], [0, [7331.801184873448, 1.0]], [0, [18377.16117386054, 1.0]], [0, [1238.9776048873462, 1.0]], [0, [298.188750078981, 1.0]], [0, [88.49111907247816, 1.0]], [0, [30.742972199616823, 1.0]], [0, [7.287149481824434, 1.0]], [0, [2.8824751743185857, 1.0]], [1, [8.621361248791692, 1.0]], [1, [0.4954387243262066, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39705928]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.0713032]
bas 3, expnt(s) = [294042.03565147]
bas 4, expnt(s) = [147021.01782491]
bas 5, expnt(s) = [73510.50797307]
bas 6, expnt(s) = [36755.23445492]
bas 7, expnt(s) = [7331.80118487]
bas 8, expnt(s) = [18377.16117386]
bas 9, expnt(s) = [1238.97760489]
bas 10, expnt(s) = [298.18875008]
bas 11, expnt(s) = [88.49111907]
bas 12, expnt(s) = [30.7429722]
bas 13, expnt(s) = [7.28714948]
bas 14, expnt(s) = [2.88247517]
bas 15, expnt(s) = [8.62136125]
bas 16, expnt(s) = [0.49543872]
CPU time:       350.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97059284e-01 1.26373653e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180118e+03 2.00181083e+03
 1.83771612e+04 3.98771253e+03 1.23897760e+03 5.27609512e+02
 2.98188750e+02 1.81294014e+02 8.84911191e+01 7.28936655e+01
 3.07429722e+01 3.29856019e+01 7.28714948e+00 1.12055527e+01
 2.88247517e+00 5.58906559e+00 8.62136125e+00 4.30977102e+01
 4.95438724e-01 1.21261191e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.322000730755956
cond(S) = 12529.357801239887
E1 = -689.5471038269018  E_coul = 185.08530855928788
init E= -504.461795267614
    CPU time for initialize scf      4.17 sec, wall time      0.34 sec
  HOMO = -0.671462904553134  LUMO = 7.40689556197881
  mo_energy =
[-1.21673668e+02 -1.33727360e+01 -7.61640068e+00 -7.61640068e+00
 -7.61640068e+00 -1.63735750e+00 -6.71462905e-01 -6.71462905e-01
 -6.71462905e-01  7.40689556e+00  8.12859060e+01  4.54668669e+02
  2.21940087e+03  1.13970532e+04  4.09902524e+04  1.09846126e+05
  2.54047063e+05  5.48477943e+05  1.15242646e+06  2.43020977e+06
  5.37494518e+06]
E1 = -707.3025244658506  E_coul = 199.38504349406972
cycle= 1 E= -507.917480971781  delta_E= -3.46  |g|= 0.45  |ddm|= 0.356
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593193
diis-c [-0.35187832  1.        ]
  HOMO = -0.226525025899327  LUMO = 8.26388103752597
  mo_energy =
[-1.20218879e+02 -1.23306818e+01 -6.62835240e+00 -6.62835240e+00
 -6.62835240e+00 -1.15569975e+00 -2.26525026e-01 -2.26525026e-01
 -2.26525026e-01  8.26388104e+00  8.25958144e+01  4.56106204e+02
  2.22078240e+03  1.13983088e+04  4.09914355e+04  1.09847270e+05
  2.54048180e+05  5.48479040e+05  1.15242755e+06  2.43021084e+06
  5.37494625e+06]
E1 = -706.8852520207478  E_coul = 198.9600685648524
cycle= 2 E= -507.925183455895  delta_E= -0.0077  |g|= 0.0202  |ddm|= 0.234
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0162741
diis-c [-2.58720347e-04  4.15683922e-03  9.95843161e-01]
  HOMO = -0.23228696132855  LUMO = 8.25235607149493
  mo_energy =
[-1.20283791e+02 -1.23578877e+01 -6.66147109e+00 -6.66147109e+00
 -6.66147109e+00 -1.15872927e+00 -2.32286961e-01 -2.32286961e-01
 -2.32286961e-01  8.25235607e+00  8.25504324e+01  4.56040685e+02
  2.22070182e+03  1.13982183e+04  4.09913417e+04  1.09847175e+05
  2.54048084e+05  5.48478944e+05  1.15242745e+06  2.43021074e+06
  5.37494615e+06]
E1 = -706.8658411465593  E_coul = 198.9406389415711
cycle= 3 E= -507.925202204988  delta_E= -1.87e-05  |g|= 0.00109  |ddm|= 0.012
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000828587
diis-c [-3.87819799e-08  6.63901774e-05 -5.16518948e-02  1.05158550e+00]
  HOMO = -0.232612716700836  LUMO = 8.25171629169353
  mo_energy =
[-1.20286939e+02 -1.23593785e+01 -6.66323982e+00 -6.66323982e+00
 -6.66323982e+00 -1.15889322e+00 -2.32612717e-01 -2.32612717e-01
 -2.32612717e-01  8.25171629e+00  8.25481108e+01  4.56037555e+02
  2.22069822e+03  1.13982144e+04  4.09913378e+04  1.09847171e+05
  2.54048080e+05  5.48478940e+05  1.15242745e+06  2.43021074e+06
  5.37494614e+06]
E1 = -706.8647577419157  E_coul = 198.93955547750522
cycle= 4 E= -507.92520226441  delta_E= -5.94e-08  |g|= 1.35e-05  |ddm|= 0.000716
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.08198e-05
diis-c [-8.91990434e-12 -2.46846510e-06  2.92481422e-03 -5.83815977e-02
  1.05545925e+00]
  HOMO = -0.232615465090635  LUMO = 8.25171230281868
  mo_energy =
[-1.20286947e+02 -1.23593888e+01 -6.66324942e+00 -6.66324942e+00
 -6.66324942e+00 -1.15889471e+00 -2.32615465e-01 -2.32615465e-01
 -2.32615465e-01  8.25171230e+00  8.25481019e+01  4.56037548e+02
  2.22069821e+03  1.13982144e+04  4.09913377e+04  1.09847171e+05
  2.54048080e+05  5.48478940e+05  1.15242745e+06  2.43021074e+06
  5.37494614e+06]
E1 = -706.864750868622  E_coul = 198.9395486042035
cycle= 5 E= -507.925202264418  delta_E= -7.96e-12  |g|= 1.68e-07  |ddm|= 7.2e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.864750868622  E_coul = 198.9395486042035
  HOMO = -0.232615507268311  LUMO = 8.25171223210272
  mo_energy =
[-1.20286948e+02 -1.23593890e+01 -6.66324962e+00 -6.66324962e+00
 -6.66324962e+00 -1.15889474e+00 -2.32615507e-01 -2.32615507e-01
 -2.32615507e-01  8.25171223e+00  8.25481017e+01  4.56037547e+02
  2.22069821e+03  1.13982144e+04  4.09913377e+04  1.09847171e+05
  2.54048080e+05  5.48478940e+05  1.15242745e+06  2.43021074e+06
  5.37494614e+06]
E1 = -706.8647507488729  E_coul = 198.9395484844543
Extra cycle  E= -507.925202264419  delta_E= -1.71e-13  |g|= 9.59e-09  |ddm|= 9.59e-08
    CPU time for scf_cycle      4.41 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12529.357801239887
E1 = -706.8647507488729  E_coul = 198.9395484844543
init E= -507.925202264419
    CPU time for initialize scf      8.93 sec, wall time      0.69 sec
  HOMO = -0.232615509539481  LUMO = 8.25171222827042
  mo_energy =
[-1.20286948e+02 -1.23593890e+01 -6.66324963e+00 -6.66324963e+00
 -6.66324963e+00 -1.15889474e+00 -2.32615510e-01 -2.32615510e-01
 -2.32615510e-01  8.25171223e+00  8.25481016e+01  4.56037547e+02
  2.22069821e+03  1.13982144e+04  4.09913377e+04  1.09847171e+05
  2.54048080e+05  5.48478940e+05  1.15242745e+06  2.43021074e+06
  5.37494614e+06]
E1 = -706.8647507425841  E_coul = 198.93954847816553
cycle= 1 E= -507.925202264419  delta_E= 5.68e-14  |g|= 9.96e-10  |ddm|= 5.5e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.8647507425841  E_coul = 198.93954847816553
  HOMO = -0.232615509667693  LUMO = 8.2517122261887
  mo_energy =
[-1.20286948e+02 -1.23593890e+01 -6.66324963e+00 -6.66324963e+00
 -6.66324963e+00 -1.15889474e+00 -2.32615510e-01 -2.32615510e-01
 -2.32615510e-01  8.25171223e+00  8.25481016e+01  4.56037547e+02
  2.22069821e+03  1.13982144e+04  4.09913377e+04  1.09847171e+05
  2.54048080e+05  5.48478940e+05  1.15242745e+06  2.43021074e+06
  5.37494614e+06]
E1 = -706.8647507421896  E_coul = 198.93954847777078
Extra cycle  E= -507.925202264419  delta_E= -2.27e-13  |g|= 8.58e-10  |ddm|= 3.24e-10
    CPU time for scf_cycle      9.14 sec, wall time      0.76 sec
exp = [3.97059284e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180118e+03
 1.83771612e+04 1.23897760e+03 2.98188750e+02 8.84911191e+01
 3.07429722e+01 7.28714948e+00 2.88247517e+00 8.62136125e+00
 4.95438724e-01]
grad_E = [ 1.28478191e-02 -1.90205893e-11  4.16893641e-10  1.40024518e-09
  8.22396541e-09  2.70888612e-08  1.65077104e-07  9.06103514e-06
  4.08408670e-07 -1.40231526e-06  4.18915697e-05 -1.47335539e-03
 -6.12753913e-04 -4.07946231e-03  1.23980472e-03  1.12447268e-02
  6.99380437e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.398051368722       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079724        1
[INPUT] 0    0    [1    /1   ]  36755.2344509        1
[INPUT] 0    0    [1    /1   ]  7331.80096316        1
[INPUT] 0    0    [1    /1   ]  18377.1611639        1
[INPUT] 0    0    [1    /1   ]  1238.97761775        1
[INPUT] 0    0    [1    /1   ]  298.188006698        1
[INPUT] 0    0    [1    /1   ]  88.5203417851        1
[INPUT] 0    0    [1    /1   ]  30.7628483738        1
[INPUT] 0    0    [1    /1   ]  7.53236952469        1
[INPUT] 0    0    [1    /1   ]  2.958241631          1
[INPUT] 1    0    [1    /1   ]  8.62176527132        1
[INPUT] 1    0    [1    /1   ]  0.495125561924       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39805136872218205, 1.0]], [0, [1176168.1426064947, 1.0]], [0, [588084.0713031904, 1.0]], [0, [294042.0356514359, 1.0]], [0, [147021.01782471192, 1.0]], [0, [73510.5079724099, 1.0]], [0, [36755.2344508788, 1.0]], [0, [7331.800963160207, 1.0]], [0, [18377.161163862515, 1.0]], [0, [1238.9776177467097, 1.0]], [0, [298.1880066980253, 1.0]], [0, [88.52034178512211, 1.0]], [0, [30.76284837378161, 1.0]], [0, [7.532369524689773, 1.0]], [0, [2.958241630996812, 1.0]], [1, [8.621765271323325, 1.0]], [1, [0.49512556192405016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39805137]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130319]
bas 3, expnt(s) = [294042.03565144]
bas 4, expnt(s) = [147021.01782471]
bas 5, expnt(s) = [73510.50797241]
bas 6, expnt(s) = [36755.23445088]
bas 7, expnt(s) = [7331.80096316]
bas 8, expnt(s) = [18377.16116386]
bas 9, expnt(s) = [1238.97761775]
bas 10, expnt(s) = [298.1880067]
bas 11, expnt(s) = [88.52034179]
bas 12, expnt(s) = [30.76284837]
bas 13, expnt(s) = [7.53236952]
bas 14, expnt(s) = [2.95824163]
bas 15, expnt(s) = [8.62176527]
bas 16, expnt(s) = [0.49512556]
CPU time:       366.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.98051369e-01 1.26610396e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180096e+03 2.00181078e+03
 1.83771612e+04 3.98771252e+03 1.23897762e+03 5.27609516e+02
 2.98188007e+02 1.81293675e+02 8.85203418e+01 7.29117187e+01
 3.07628484e+01 3.30015952e+01 7.53236952e+00 1.14871882e+01
 2.95824163e+00 5.69888978e+00 8.62176527e+00 4.31002348e+01
 4.95125562e-01 1.21165388e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.322258064628215
cond(S) = 12529.836375362423
E1 = -689.5430940852984  E_coul = 185.07875837402477
init E= -504.464335711274
    CPU time for initialize scf      3.97 sec, wall time      0.32 sec
  HOMO = -0.67171859000225  LUMO = 7.81239897470203
  mo_energy =
[-1.21674109e+02 -1.33737581e+01 -7.61678593e+00 -7.61678593e+00
 -7.61678593e+00 -1.63759821e+00 -6.71718590e-01 -6.71718590e-01
 -6.71718590e-01  7.81239897e+00  8.26226181e+01  4.56091113e+02
  2.22067576e+03  1.13981418e+04  4.09912522e+04  1.09847081e+05
  2.54047987e+05  5.48478841e+05  1.15242734e+06  2.43021061e+06
  5.37494600e+06]
E1 = -707.2878391855492  E_coul = 199.36928953398382
cycle= 1 E= -507.918549651565  delta_E= -3.45  |g|= 0.449  |ddm|= 0.355
    CPU time for cycle= 1      0.18 sec, wall time      0.02 sec
diis-norm(errvec)=0.59307
diis-c [-0.35173193  1.        ]
  HOMO = -0.227151103117303  LUMO = 8.68132161396804
  mo_energy =
[-1.20219581e+02 -1.23324559e+01 -6.62949320e+00 -6.62949320e+00
 -6.62949320e+00 -1.15617677e+00 -2.27151103e-01 -2.27151103e-01
 -2.27151103e-01  8.68132161e+00  8.39326934e+01  4.57528287e+02
  2.22205717e+03  1.13993974e+04  4.09924355e+04  1.09848226e+05
  2.54049104e+05  5.48479938e+05  1.15242842e+06  2.43021169e+06
  5.37494707e+06]
E1 = -706.8868700602278  E_coul = 198.96095813746368
cycle= 2 E= -507.925911922764  delta_E= -0.00736  |g|= 0.0197  |ddm|= 0.224
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0161254
diis-c [-2.54166521e-04  4.06720747e-03  9.95932793e-01]
  HOMO = -0.232567662827542  LUMO = 8.67000060498783
  mo_energy =
[-1.20282702e+02 -1.23584173e+01 -6.66127652e+00 -6.66127652e+00
 -6.66127652e+00 -1.15900166e+00 -2.32567663e-01 -2.32567663e-01
 -2.32567663e-01  8.67000060e+00  8.38886912e+01  4.57464565e+02
  2.22197857e+03  1.13993090e+04  4.09923438e+04  1.09848133e+05
  2.54049011e+05  5.48479844e+05  1.15242833e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8687345645063  E_coul = 198.9428057863905
cycle= 3 E= -507.925928778116  delta_E= -1.69e-05  |g|= 0.00103  |ddm|= 0.0112
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000805402
diis-c [-3.08854601e-08  6.08775575e-05 -5.08988282e-02  1.05083795e+00]
  HOMO = -0.232864565877946  LUMO = 8.66939194041757
  mo_energy =
[-1.20285688e+02 -1.23597983e+01 -6.66292694e+00 -6.66292694e+00
 -6.66292694e+00 -1.15915001e+00 -2.32864566e-01 -2.32864566e-01
 -2.32864566e-01  8.66939194e+00  8.38865000e+01  4.57461597e+02
  2.22197514e+03  1.13993053e+04  4.09923400e+04  1.09848129e+05
  2.54049007e+05  5.48479840e+05  1.15242832e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8677534847632  E_coul = 198.94182465670002
cycle= 4 E= -507.925928828063  delta_E= -4.99e-08  |g|= 1.14e-05  |ddm|= 0.000644
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.37407e-06
diis-c [-8.00424445e-12 -2.36667155e-06  2.78059922e-03 -5.58588007e-02
  1.05308057e+00]
  HOMO = -0.232866723101841  LUMO = 8.66938882707467
  mo_energy =
[-1.20285693e+02 -1.23598064e+01 -6.66293426e+00 -6.66293426e+00
 -6.66293426e+00 -1.15915119e+00 -2.32866723e-01 -2.32866723e-01
 -2.32866723e-01  8.66938883e+00  8.38864936e+01  4.57461593e+02
  2.22197514e+03  1.13993053e+04  4.09923400e+04  1.09848129e+05
  2.54049007e+05  5.48479840e+05  1.15242832e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8677483866919  E_coul = 198.94181955862354
cycle= 5 E= -507.925928828068  delta_E= -5.23e-12  |g|= 1.62e-07  |ddm|= 5.67e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.8677483866919  E_coul = 198.94181955862354
  HOMO = -0.232866763734825  LUMO = 8.66938875563297
  mo_energy =
[-1.20285693e+02 -1.23598065e+01 -6.66293446e+00 -6.66293446e+00
 -6.66293446e+00 -1.15915121e+00 -2.32866764e-01 -2.32866764e-01
 -2.32866764e-01  8.66938876e+00  8.38864934e+01  4.57461592e+02
  2.22197514e+03  1.13993053e+04  4.09923400e+04  1.09848129e+05
  2.54049007e+05  5.48479840e+05  1.15242832e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8677482716749  E_coul = 198.94181944360645
Extra cycle  E= -507.925928828068  delta_E= -1.14e-13  |g|= 9.04e-09  |ddm|= 9.12e-08
    CPU time for scf_cycle      4.25 sec, wall time      0.39 sec
exp = [3.98051369e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180096e+03
 1.83771612e+04 1.23897762e+03 2.98188007e+02 8.85203418e+01
 3.07628484e+01 7.53236952e+00 2.95824163e+00 8.62176527e+00
 4.95125562e-01]
E = -507.9259288280685
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.398051368722       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017825        1
[INPUT] 0    0    [1    /1   ]  73510.5079724        1
[INPUT] 0    0    [1    /1   ]  36755.2344509        1
[INPUT] 0    0    [1    /1   ]  7331.80096316        1
[INPUT] 0    0    [1    /1   ]  18377.1611639        1
[INPUT] 0    0    [1    /1   ]  1238.97761775        1
[INPUT] 0    0    [1    /1   ]  298.188006698        1
[INPUT] 0    0    [1    /1   ]  88.5203417851        1
[INPUT] 0    0    [1    /1   ]  30.7628483738        1
[INPUT] 0    0    [1    /1   ]  7.53236952469        1
[INPUT] 0    0    [1    /1   ]  2.958241631          1
[INPUT] 1    0    [1    /1   ]  8.62176527132        1
[INPUT] 1    0    [1    /1   ]  0.495125561924       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39805136872218205, 1.0]], [0, [1176168.1426064947, 1.0]], [0, [588084.0713031904, 1.0]], [0, [294042.0356514359, 1.0]], [0, [147021.01782471192, 1.0]], [0, [73510.5079724099, 1.0]], [0, [36755.2344508788, 1.0]], [0, [7331.800963160207, 1.0]], [0, [18377.161163862515, 1.0]], [0, [1238.9776177467097, 1.0]], [0, [298.1880066980253, 1.0]], [0, [88.52034178512211, 1.0]], [0, [30.76284837378161, 1.0]], [0, [7.532369524689773, 1.0]], [0, [2.958241630996812, 1.0]], [1, [8.621765271323325, 1.0]], [1, [0.49512556192405016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39805137]
bas 1, expnt(s) = [1176168.14260649]
bas 2, expnt(s) = [588084.07130319]
bas 3, expnt(s) = [294042.03565144]
bas 4, expnt(s) = [147021.01782471]
bas 5, expnt(s) = [73510.50797241]
bas 6, expnt(s) = [36755.23445088]
bas 7, expnt(s) = [7331.80096316]
bas 8, expnt(s) = [18377.16116386]
bas 9, expnt(s) = [1238.97761775]
bas 10, expnt(s) = [298.1880067]
bas 11, expnt(s) = [88.52034179]
bas 12, expnt(s) = [30.76284837]
bas 13, expnt(s) = [7.53236952]
bas 14, expnt(s) = [2.95824163]
bas 15, expnt(s) = [8.62176527]
bas 16, expnt(s) = [0.49512556]
CPU time:       370.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.98051369e-01 1.26610396e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552345e+04 6.70663116e+03 7.33180096e+03 2.00181078e+03
 1.83771612e+04 3.98771252e+03 1.23897762e+03 5.27609516e+02
 2.98188007e+02 1.81293675e+02 8.85203418e+01 7.29117187e+01
 3.07628484e+01 3.30015952e+01 7.53236952e+00 1.14871882e+01
 2.95824163e+00 5.69888978e+00 8.62176527e+00 4.31002348e+01
 4.95125562e-01 1.21165388e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.322258064628215
cond(S) = 12529.836375362423
E1 = -689.5430940852984  E_coul = 185.07875837402477
init E= -504.464335711274
    CPU time for initialize scf      3.95 sec, wall time      0.34 sec
  HOMO = -0.67171859000225  LUMO = 7.81239897470203
  mo_energy =
[-1.21674109e+02 -1.33737581e+01 -7.61678593e+00 -7.61678593e+00
 -7.61678593e+00 -1.63759821e+00 -6.71718590e-01 -6.71718590e-01
 -6.71718590e-01  7.81239897e+00  8.26226181e+01  4.56091113e+02
  2.22067576e+03  1.13981418e+04  4.09912522e+04  1.09847081e+05
  2.54047987e+05  5.48478841e+05  1.15242734e+06  2.43021061e+06
  5.37494600e+06]
E1 = -707.2878391855492  E_coul = 199.36928953398382
cycle= 1 E= -507.918549651565  delta_E= -3.45  |g|= 0.449  |ddm|= 0.355
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.59307
diis-c [-0.35173193  1.        ]
  HOMO = -0.227151103117303  LUMO = 8.68132161396804
  mo_energy =
[-1.20219581e+02 -1.23324559e+01 -6.62949320e+00 -6.62949320e+00
 -6.62949320e+00 -1.15617677e+00 -2.27151103e-01 -2.27151103e-01
 -2.27151103e-01  8.68132161e+00  8.39326934e+01  4.57528287e+02
  2.22205717e+03  1.13993974e+04  4.09924355e+04  1.09848226e+05
  2.54049104e+05  5.48479938e+05  1.15242842e+06  2.43021169e+06
  5.37494707e+06]
E1 = -706.8868700602278  E_coul = 198.96095813746368
cycle= 2 E= -507.925911922764  delta_E= -0.00736  |g|= 0.0197  |ddm|= 0.224
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0161254
diis-c [-2.54166521e-04  4.06720747e-03  9.95932793e-01]
  HOMO = -0.232567662827542  LUMO = 8.67000060498783
  mo_energy =
[-1.20282702e+02 -1.23584173e+01 -6.66127652e+00 -6.66127652e+00
 -6.66127652e+00 -1.15900166e+00 -2.32567663e-01 -2.32567663e-01
 -2.32567663e-01  8.67000060e+00  8.38886912e+01  4.57464565e+02
  2.22197857e+03  1.13993090e+04  4.09923438e+04  1.09848133e+05
  2.54049011e+05  5.48479844e+05  1.15242833e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8687345645063  E_coul = 198.9428057863905
cycle= 3 E= -507.925928778116  delta_E= -1.69e-05  |g|= 0.00103  |ddm|= 0.0112
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000805402
diis-c [-3.08854601e-08  6.08775575e-05 -5.08988282e-02  1.05083795e+00]
  HOMO = -0.232864565877946  LUMO = 8.66939194041757
  mo_energy =
[-1.20285688e+02 -1.23597983e+01 -6.66292694e+00 -6.66292694e+00
 -6.66292694e+00 -1.15915001e+00 -2.32864566e-01 -2.32864566e-01
 -2.32864566e-01  8.66939194e+00  8.38865000e+01  4.57461597e+02
  2.22197514e+03  1.13993053e+04  4.09923400e+04  1.09848129e+05
  2.54049007e+05  5.48479840e+05  1.15242832e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8677534847632  E_coul = 198.94182465670002
cycle= 4 E= -507.925928828063  delta_E= -4.99e-08  |g|= 1.14e-05  |ddm|= 0.000644
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.37407e-06
diis-c [-8.00424445e-12 -2.36667155e-06  2.78059922e-03 -5.58588007e-02
  1.05308057e+00]
  HOMO = -0.232866723101841  LUMO = 8.66938882707467
  mo_energy =
[-1.20285693e+02 -1.23598064e+01 -6.66293426e+00 -6.66293426e+00
 -6.66293426e+00 -1.15915119e+00 -2.32866723e-01 -2.32866723e-01
 -2.32866723e-01  8.66938883e+00  8.38864936e+01  4.57461593e+02
  2.22197514e+03  1.13993053e+04  4.09923400e+04  1.09848129e+05
  2.54049007e+05  5.48479840e+05  1.15242832e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8677483866919  E_coul = 198.94181955862354
cycle= 5 E= -507.925928828068  delta_E= -5.23e-12  |g|= 1.62e-07  |ddm|= 5.67e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.8677483866919  E_coul = 198.94181955862354
  HOMO = -0.232866763734825  LUMO = 8.66938875563297
  mo_energy =
[-1.20285693e+02 -1.23598065e+01 -6.66293446e+00 -6.66293446e+00
 -6.66293446e+00 -1.15915121e+00 -2.32866764e-01 -2.32866764e-01
 -2.32866764e-01  8.66938876e+00  8.38864934e+01  4.57461592e+02
  2.22197514e+03  1.13993053e+04  4.09923400e+04  1.09848129e+05
  2.54049007e+05  5.48479840e+05  1.15242832e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8677482716749  E_coul = 198.94181944360645
Extra cycle  E= -507.925928828068  delta_E= -1.14e-13  |g|= 9.04e-09  |ddm|= 9.12e-08
    CPU time for scf_cycle      4.17 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12529.836375362423
E1 = -706.8677482716749  E_coul = 198.94181944360645
init E= -507.925928828068
    CPU time for initialize scf      8.43 sec, wall time      0.71 sec
  HOMO = -0.232866765854958  LUMO = 8.66938875435119
  mo_energy =
[-1.20285693e+02 -1.23598065e+01 -6.66293447e+00 -6.66293447e+00
 -6.66293447e+00 -1.15915121e+00 -2.32866766e-01 -2.32866766e-01
 -2.32866766e-01  8.66938875e+00  8.38864934e+01  4.57461592e+02
  2.22197514e+03  1.13993053e+04  4.09923400e+04  1.09848129e+05
  2.54049007e+05  5.48479840e+05  1.15242832e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8677482658892  E_coul = 198.94181943782053
cycle= 1 E= -507.925928828069  delta_E= -1.71e-13  |g|= 1.01e-09  |ddm|= 5.02e-09
    CPU time for cycle= 1      0.07 sec, wall time      0.01 sec
E1 = -706.8677482658892  E_coul = 198.94181943782053
  HOMO = -0.232866765970041  LUMO = 8.66938875206306
  mo_energy =
[-1.20285693e+02 -1.23598065e+01 -6.66293447e+00 -6.66293447e+00
 -6.66293447e+00 -1.15915121e+00 -2.32866766e-01 -2.32866766e-01
 -2.32866766e-01  8.66938875e+00  8.38864934e+01  4.57461592e+02
  2.22197514e+03  1.13993053e+04  4.09923400e+04  1.09848129e+05
  2.54049007e+05  5.48479840e+05  1.15242832e+06  2.43021159e+06
  5.37494697e+06]
E1 = -706.8677482655313  E_coul = 198.94181943746304
Extra cycle  E= -507.925928828068  delta_E= 3.98e-13  |g|= 5.75e-10  |ddm|= 3.04e-10
    CPU time for scf_cycle      8.56 sec, wall time      0.78 sec
exp = [3.98051369e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552345e+04 7.33180096e+03
 1.83771612e+04 1.23897762e+03 2.98188007e+02 8.85203418e+01
 3.07628484e+01 7.53236952e+00 2.95824163e+00 8.62176527e+00
 4.95125562e-01]
grad_E = [ 2.23335621e-02 -1.90365328e-11  4.16834789e-10  1.39999171e-09
  8.22286915e-09  2.70840870e-08  1.65055808e-07  9.06012290e-06
  4.08315718e-07 -1.40730085e-06  4.36970044e-05 -1.54540643e-03
 -4.26135081e-04 -1.68492126e-03 -6.87387683e-04  1.20895764e-02
  5.97452761e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397492134065       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079716        1
[INPUT] 0    0    [1    /1   ]  36755.234446         1
[INPUT] 0    0    [1    /1   ]  7331.80069507        1
[INPUT] 0    0    [1    /1   ]  18377.1611518        1
[INPUT] 0    0    [1    /1   ]  1238.97763287        1
[INPUT] 0    0    [1    /1   ]  298.187105052        1
[INPUT] 0    0    [1    /1   ]  88.5556964483        1
[INPUT] 0    0    [1    /1   ]  30.7862065157        1
[INPUT] 0    0    [1    /1   ]  7.82585330179        1
[INPUT] 0    0    [1    /1   ]  3.05872995255        1
[INPUT] 1    0    [1    /1   ]  8.61241403713        1
[INPUT] 1    0    [1    /1   ]  0.493861140586       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3974921340652613, 1.0]], [0, [1176168.1426064952, 1.0]], [0, [588084.0713031781, 1.0]], [0, [294042.03565139446, 1.0]], [0, [147021.01782446852, 1.0]], [0, [73510.50797160812, 1.0]], [0, [36755.23444599323, 1.0]], [0, [7331.800695072782, 1.0]], [0, [18377.16115177318, 1.0]], [0, [1238.9776328701382, 1.0]], [0, [298.1871050519788, 1.0]], [0, [88.55569644832165, 1.0]], [0, [30.786206515677684, 1.0]], [0, [7.825853301792041, 1.0]], [0, [3.0587299525484224, 1.0]], [1, [8.612414037129406, 1.0]], [1, [0.49386114058581077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39749213]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130318]
bas 3, expnt(s) = [294042.03565139]
bas 4, expnt(s) = [147021.01782447]
bas 5, expnt(s) = [73510.50797161]
bas 6, expnt(s) = [36755.23444599]
bas 7, expnt(s) = [7331.80069507]
bas 8, expnt(s) = [18377.16115177]
bas 9, expnt(s) = [1238.97763287]
bas 10, expnt(s) = [298.18710505]
bas 11, expnt(s) = [88.55569645]
bas 12, expnt(s) = [30.78620652]
bas 13, expnt(s) = [7.8258533]
bas 14, expnt(s) = [3.05872995]
bas 15, expnt(s) = [8.61241404]
bas 16, expnt(s) = [0.49386114]
CPU time:       386.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97492134e-01 1.26476963e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180070e+03 2.00181073e+03
 1.83771612e+04 3.98771252e+03 1.23897763e+03 5.27609521e+02
 2.98187105e+02 1.81293264e+02 8.85556964e+01 7.29335581e+01
 3.07862065e+01 3.30203869e+01 7.82585330e+00 1.18212609e+01
 3.05872995e+00 5.84347077e+00 8.61241404e+00 4.30418092e+01
 4.93861141e-01 1.20778731e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324008127325214
cond(S) = 12530.426849791023
E1 = -689.4487726391262  E_coul = 184.98938373355037
init E= -504.459388905576
    CPU time for initialize scf      3.94 sec, wall time      0.34 sec
  HOMO = -0.673346744171473  LUMO = 8.31873894890087
  mo_energy =
[-1.21687087e+02 -1.33810516e+01 -7.62276498e+00 -7.62276498e+00
 -7.62276498e+00 -1.63892866e+00 -6.73346744e-01 -6.73346744e-01
 -6.73346744e-01  8.31873895e+00  8.42381029e+01  4.57814931e+02
  2.22221994e+03  1.13994584e+04  4.09924606e+04  1.09848236e+05
  2.54049104e+05  5.48479924e+05  1.15242839e+06  2.43021164e+06
  5.37494699e+06]
E1 = -707.1577272920715  E_coul = 199.2382388505627
cycle= 1 E= -507.919488441509  delta_E= -3.46  |g|= 0.446  |ddm|= 0.357
    CPU time for cycle= 1      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.592676
diis-c [-0.35126441  1.        ]
  HOMO = -0.230545656568012  LUMO = 9.20036022726768
  mo_energy =
[-1.20235612e+02 -1.23425817e+01 -6.63835705e+00 -6.63835705e+00
 -6.63835705e+00 -1.15905029e+00 -2.30545657e-01 -2.30545657e-01
 -2.30545657e-01  9.20036023e+00  8.55461558e+01  4.59248938e+02
  2.22359841e+03  1.14007112e+04  4.09936410e+04  1.09849377e+05
  2.54050218e+05  5.48481019e+05  1.15242947e+06  2.43021271e+06
  5.37494806e+06]
E1 = -706.7764577399835  E_coul = 198.8500145059442
cycle= 2 E= -507.926443234039  delta_E= -0.00695  |g|= 0.0191  |ddm|= 0.213
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0159154
diis-c [-2.47805570e-04  3.94078015e-03  9.96059220e-01]
  HOMO = -0.235558823987338  LUMO = 9.18930413102389
  mo_energy =
[-1.20296469e+02 -1.23670795e+01 -6.66852963e+00 -6.66852963e+00
 -6.66852963e+00 -1.16164199e+00 -2.35558824e-01 -2.35558824e-01
 -2.35558824e-01  9.18930413e+00  8.55038780e+01  4.59187490e+02
  2.22352233e+03  1.14006255e+04  4.09935521e+04  1.09849287e+05
  2.54050127e+05  5.48480928e+05  1.15242938e+06  2.43021262e+06
  5.37494796e+06]
E1 = -706.7597651023398  E_coul = 198.83330704076624
cycle= 3 E= -507.926458061573  delta_E= -1.48e-05  |g|= 0.000959  |ddm|= 0.0102
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000778419
diis-c [-2.30932685e-08  5.46644780e-05 -5.00840535e-02  1.05002939e+00]
  HOMO = -0.235823677451323  LUMO = 9.18873155551753
  mo_energy =
[-1.20299264e+02 -1.23683377e+01 -6.67004562e+00 -6.67004562e+00
 -6.67004562e+00 -1.16177325e+00 -2.35823677e-01 -2.35823677e-01
 -2.35823677e-01  9.18873156e+00  8.55018379e+01  4.59184713e+02
  2.22351911e+03  1.14006220e+04  4.09935485e+04  1.09849283e+05
  2.54050123e+05  5.48480924e+05  1.15242937e+06  2.43021261e+06
  5.37494796e+06]
E1 = -706.7588945470989  E_coul = 198.832436444981
cycle= 4 E= -507.926458102118  delta_E= -4.05e-08  |g|= 9.17e-06  |ddm|= 0.000567
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.78124e-06
diis-c [-6.91336222e-12 -2.24094826e-06  2.58463130e-03 -5.22631318e-02
  1.04968074e+00]
  HOMO = -0.235825230584431  LUMO = 9.1887293756979
  mo_energy =
[-1.20299266e+02 -1.23683434e+01 -6.67005058e+00 -6.67005058e+00
 -6.67005058e+00 -1.16177410e+00 -2.35825231e-01 -2.35825231e-01
 -2.35825231e-01  9.18872938e+00  8.55018340e+01  4.59184711e+02
  2.22351911e+03  1.14006220e+04  4.09935485e+04  1.09849283e+05
  2.54050123e+05  5.48480924e+05  1.15242937e+06  2.43021261e+06
  5.37494796e+06]
E1 = -706.7588911891378  E_coul = 198.8324330870172
cycle= 5 E= -507.926458102121  delta_E= -2.73e-12  |g|= 1.55e-07  |ddm|= 4.14e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7588911891378  E_coul = 198.8324330870172
  HOMO = -0.235825268642185  LUMO = 9.18872930443347
  mo_energy =
[-1.20299267e+02 -1.23683436e+01 -6.67005077e+00 -6.67005077e+00
 -6.67005077e+00 -1.16177412e+00 -2.35825269e-01 -2.35825269e-01
 -2.35825269e-01  9.18872930e+00  8.55018338e+01  4.59184711e+02
  2.22351911e+03  1.14006220e+04  4.09935485e+04  1.09849283e+05
  2.54050123e+05  5.48480924e+05  1.15242937e+06  2.43021261e+06
  5.37494796e+06]
E1 = -706.758891082466  E_coul = 198.83243298034537
Extra cycle  E= -507.926458102121  delta_E=    0  |g|= 8.32e-09  |ddm|= 8.45e-08
    CPU time for scf_cycle      4.07 sec, wall time      0.41 sec
exp = [3.97492134e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180070e+03
 1.83771612e+04 1.23897763e+03 2.98187105e+02 8.85556964e+01
 3.07862065e+01 7.82585330e+00 3.05872995e+00 8.61241404e+00
 4.93861141e-01]
E = -507.9264581021206
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397492134065       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079716        1
[INPUT] 0    0    [1    /1   ]  36755.234446         1
[INPUT] 0    0    [1    /1   ]  7331.80069507        1
[INPUT] 0    0    [1    /1   ]  18377.1611518        1
[INPUT] 0    0    [1    /1   ]  1238.97763287        1
[INPUT] 0    0    [1    /1   ]  298.187105052        1
[INPUT] 0    0    [1    /1   ]  88.5556964483        1
[INPUT] 0    0    [1    /1   ]  30.7862065157        1
[INPUT] 0    0    [1    /1   ]  7.82585330179        1
[INPUT] 0    0    [1    /1   ]  3.05872995255        1
[INPUT] 1    0    [1    /1   ]  8.61241403713        1
[INPUT] 1    0    [1    /1   ]  0.493861140586       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3974921340652613, 1.0]], [0, [1176168.1426064952, 1.0]], [0, [588084.0713031781, 1.0]], [0, [294042.03565139446, 1.0]], [0, [147021.01782446852, 1.0]], [0, [73510.50797160812, 1.0]], [0, [36755.23444599323, 1.0]], [0, [7331.800695072782, 1.0]], [0, [18377.16115177318, 1.0]], [0, [1238.9776328701382, 1.0]], [0, [298.1871050519788, 1.0]], [0, [88.55569644832165, 1.0]], [0, [30.786206515677684, 1.0]], [0, [7.825853301792041, 1.0]], [0, [3.0587299525484224, 1.0]], [1, [8.612414037129406, 1.0]], [1, [0.49386114058581077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39749213]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130318]
bas 3, expnt(s) = [294042.03565139]
bas 4, expnt(s) = [147021.01782447]
bas 5, expnt(s) = [73510.50797161]
bas 6, expnt(s) = [36755.23444599]
bas 7, expnt(s) = [7331.80069507]
bas 8, expnt(s) = [18377.16115177]
bas 9, expnt(s) = [1238.97763287]
bas 10, expnt(s) = [298.18710505]
bas 11, expnt(s) = [88.55569645]
bas 12, expnt(s) = [30.78620652]
bas 13, expnt(s) = [7.8258533]
bas 14, expnt(s) = [3.05872995]
bas 15, expnt(s) = [8.61241404]
bas 16, expnt(s) = [0.49386114]
CPU time:       390.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97492134e-01 1.26476963e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180070e+03 2.00181073e+03
 1.83771612e+04 3.98771252e+03 1.23897763e+03 5.27609521e+02
 2.98187105e+02 1.81293264e+02 8.85556964e+01 7.29335581e+01
 3.07862065e+01 3.30203869e+01 7.82585330e+00 1.18212609e+01
 3.05872995e+00 5.84347077e+00 8.61241404e+00 4.30418092e+01
 4.93861141e-01 1.20778731e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324008127325214
cond(S) = 12530.426849791023
E1 = -689.4487726391262  E_coul = 184.98938373355037
init E= -504.459388905576
    CPU time for initialize scf      4.02 sec, wall time      0.35 sec
  HOMO = -0.673346744171473  LUMO = 8.31873894890087
  mo_energy =
[-1.21687087e+02 -1.33810516e+01 -7.62276498e+00 -7.62276498e+00
 -7.62276498e+00 -1.63892866e+00 -6.73346744e-01 -6.73346744e-01
 -6.73346744e-01  8.31873895e+00  8.42381029e+01  4.57814931e+02
  2.22221994e+03  1.13994584e+04  4.09924606e+04  1.09848236e+05
  2.54049104e+05  5.48479924e+05  1.15242839e+06  2.43021164e+06
  5.37494699e+06]
E1 = -707.1577272920715  E_coul = 199.2382388505627
cycle= 1 E= -507.919488441509  delta_E= -3.46  |g|= 0.446  |ddm|= 0.357
    CPU time for cycle= 1      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.592676
diis-c [-0.35126441  1.        ]
  HOMO = -0.230545656568012  LUMO = 9.20036022726768
  mo_energy =
[-1.20235612e+02 -1.23425817e+01 -6.63835705e+00 -6.63835705e+00
 -6.63835705e+00 -1.15905029e+00 -2.30545657e-01 -2.30545657e-01
 -2.30545657e-01  9.20036023e+00  8.55461558e+01  4.59248938e+02
  2.22359841e+03  1.14007112e+04  4.09936410e+04  1.09849377e+05
  2.54050218e+05  5.48481019e+05  1.15242947e+06  2.43021271e+06
  5.37494806e+06]
E1 = -706.7764577399835  E_coul = 198.8500145059442
cycle= 2 E= -507.926443234039  delta_E= -0.00695  |g|= 0.0191  |ddm|= 0.213
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0159154
diis-c [-2.47805570e-04  3.94078015e-03  9.96059220e-01]
  HOMO = -0.235558823987338  LUMO = 9.18930413102389
  mo_energy =
[-1.20296469e+02 -1.23670795e+01 -6.66852963e+00 -6.66852963e+00
 -6.66852963e+00 -1.16164199e+00 -2.35558824e-01 -2.35558824e-01
 -2.35558824e-01  9.18930413e+00  8.55038780e+01  4.59187490e+02
  2.22352233e+03  1.14006255e+04  4.09935521e+04  1.09849287e+05
  2.54050127e+05  5.48480928e+05  1.15242938e+06  2.43021262e+06
  5.37494796e+06]
E1 = -706.7597651023398  E_coul = 198.83330704076624
cycle= 3 E= -507.926458061573  delta_E= -1.48e-05  |g|= 0.000959  |ddm|= 0.0102
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000778419
diis-c [-2.30932685e-08  5.46644780e-05 -5.00840535e-02  1.05002939e+00]
  HOMO = -0.235823677451323  LUMO = 9.18873155551753
  mo_energy =
[-1.20299264e+02 -1.23683377e+01 -6.67004562e+00 -6.67004562e+00
 -6.67004562e+00 -1.16177325e+00 -2.35823677e-01 -2.35823677e-01
 -2.35823677e-01  9.18873156e+00  8.55018379e+01  4.59184713e+02
  2.22351911e+03  1.14006220e+04  4.09935485e+04  1.09849283e+05
  2.54050123e+05  5.48480924e+05  1.15242937e+06  2.43021261e+06
  5.37494796e+06]
E1 = -706.7588945470989  E_coul = 198.832436444981
cycle= 4 E= -507.926458102118  delta_E= -4.05e-08  |g|= 9.17e-06  |ddm|= 0.000567
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.78124e-06
diis-c [-6.91336222e-12 -2.24094826e-06  2.58463130e-03 -5.22631318e-02
  1.04968074e+00]
  HOMO = -0.235825230584431  LUMO = 9.1887293756979
  mo_energy =
[-1.20299266e+02 -1.23683434e+01 -6.67005058e+00 -6.67005058e+00
 -6.67005058e+00 -1.16177410e+00 -2.35825231e-01 -2.35825231e-01
 -2.35825231e-01  9.18872938e+00  8.55018340e+01  4.59184711e+02
  2.22351911e+03  1.14006220e+04  4.09935485e+04  1.09849283e+05
  2.54050123e+05  5.48480924e+05  1.15242937e+06  2.43021261e+06
  5.37494796e+06]
E1 = -706.7588911891378  E_coul = 198.8324330870172
cycle= 5 E= -507.926458102121  delta_E= -2.73e-12  |g|= 1.55e-07  |ddm|= 4.14e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7588911891378  E_coul = 198.8324330870172
  HOMO = -0.235825268642185  LUMO = 9.18872930443347
  mo_energy =
[-1.20299267e+02 -1.23683436e+01 -6.67005077e+00 -6.67005077e+00
 -6.67005077e+00 -1.16177412e+00 -2.35825269e-01 -2.35825269e-01
 -2.35825269e-01  9.18872930e+00  8.55018338e+01  4.59184711e+02
  2.22351911e+03  1.14006220e+04  4.09935485e+04  1.09849283e+05
  2.54050123e+05  5.48480924e+05  1.15242937e+06  2.43021261e+06
  5.37494796e+06]
E1 = -706.758891082466  E_coul = 198.83243298034537
Extra cycle  E= -507.926458102121  delta_E=    0  |g|= 8.32e-09  |ddm|= 8.45e-08
    CPU time for scf_cycle      4.15 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12530.426849791023
E1 = -706.758891082466  E_coul = 198.83243298034537
init E= -507.926458102121
    CPU time for initialize scf      8.19 sec, wall time      0.69 sec
  HOMO = -0.235825270556084  LUMO = 9.18872930174714
  mo_energy =
[-1.20299267e+02 -1.23683436e+01 -6.67005078e+00 -6.67005078e+00
 -6.67005078e+00 -1.16177412e+00 -2.35825271e-01 -2.35825271e-01
 -2.35825271e-01  9.18872930e+00  8.55018338e+01  4.59184711e+02
  2.22351911e+03  1.14006220e+04  4.09935485e+04  1.09849283e+05
  2.54050123e+05  5.48480924e+05  1.15242937e+06  2.43021261e+06
  5.37494796e+06]
E1 = -706.7588910772181  E_coul = 198.8324329750967
cycle= 1 E= -507.926458102121  delta_E= -7.96e-13  |g|= 1.15e-09  |ddm|= 4.49e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.7588910772181  E_coul = 198.8324329750967
  HOMO = -0.235825270656665  LUMO = 9.18872930150528
  mo_energy =
[-1.20299267e+02 -1.23683436e+01 -6.67005078e+00 -6.67005078e+00
 -6.67005078e+00 -1.16177412e+00 -2.35825271e-01 -2.35825271e-01
 -2.35825271e-01  9.18872930e+00  8.55018338e+01  4.59184711e+02
  2.22351911e+03  1.14006220e+04  4.09935485e+04  1.09849283e+05
  2.54050123e+05  5.48480924e+05  1.15242937e+06  2.43021261e+06
  5.37494796e+06]
E1 = -706.758891077003  E_coul = 198.83243297488204
Extra cycle  E= -507.926458102121  delta_E= 4.55e-13  |g|= 1.07e-09  |ddm|= 2.22e-10
    CPU time for scf_cycle      8.40 sec, wall time      0.76 sec
exp = [3.97492134e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180070e+03
 1.83771612e+04 1.23897763e+03 2.98187105e+02 8.85556964e+01
 3.07862065e+01 7.82585330e+00 3.05872995e+00 8.61241404e+00
 4.93861141e-01]
grad_E = [ 1.26523243e-02 -1.90789324e-11  4.16600021e-10  1.39906802e-09
  8.21843550e-09  2.70666731e-08  1.64967960e-07  9.05515028e-06
  4.08005996e-07 -1.09202591e-06  4.07369503e-05 -1.58289638e-03
 -3.16558329e-04 -4.67249061e-04  4.59135402e-04  5.72016877e-03
  2.24314138e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396743401781       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079713        1
[INPUT] 0    0    [1    /1   ]  36755.2344439        1
[INPUT] 0    0    [1    /1   ]  7331.80058169        1
[INPUT] 0    0    [1    /1   ]  18377.1611467        1
[INPUT] 0    0    [1    /1   ]  1238.97764103        1
[INPUT] 0    0    [1    /1   ]  298.186702394        1
[INPUT] 0    0    [1    /1   ]  88.5714657039        1
[INPUT] 0    0    [1    /1   ]  30.7956738901        1
[INPUT] 0    0    [1    /1   ]  7.93188246932        1
[INPUT] 0    0    [1    /1   ]  3.08653404451        1
[INPUT] 1    0    [1    /1   ]  8.60524987651        1
[INPUT] 1    0    [1    /1   ]  0.49308386584        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3967434017813443, 1.0]], [0, [1176168.1426064954, 1.0]], [0, [588084.0713031729, 1.0]], [0, [294042.03565137694, 1.0]], [0, [147021.01782436558, 1.0]], [0, [73510.50797126905, 1.0]], [0, [36755.23444392703, 1.0]], [0, [7331.800581686133, 1.0]], [0, [18377.161146660812, 1.0]], [0, [1238.9776410340398, 1.0]], [0, [298.18670239430554, 1.0]], [0, [88.57146570385513, 1.0]], [0, [30.79567389006745, 1.0]], [0, [7.931882469316405, 1.0]], [0, [3.0865340445127254, 1.0]], [1, [8.605249876510145, 1.0]], [1, [0.4930838658397867, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3967434]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130317]
bas 3, expnt(s) = [294042.03565138]
bas 4, expnt(s) = [147021.01782437]
bas 5, expnt(s) = [73510.50797127]
bas 6, expnt(s) = [36755.23444393]
bas 7, expnt(s) = [7331.80058169]
bas 8, expnt(s) = [18377.16114666]
bas 9, expnt(s) = [1238.97764103]
bas 10, expnt(s) = [298.18670239]
bas 11, expnt(s) = [88.5714657]
bas 12, expnt(s) = [30.79567389]
bas 13, expnt(s) = [7.93188247]
bas 14, expnt(s) = [3.08653404]
bas 15, expnt(s) = [8.60524988]
bas 16, expnt(s) = [0.49308387]
CPU time:       405.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96743402e-01 1.26298243e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180058e+03 2.00181070e+03
 1.83771611e+04 3.98771252e+03 1.23897764e+03 5.27609523e+02
 2.98186702e+02 1.81293080e+02 8.85714657e+01 7.29432984e+01
 3.07956739e+01 3.30280025e+01 7.93188247e+00 1.19411795e+01
 3.08653404e+00 5.88326388e+00 8.60524988e+00 4.29970589e+01
 4.93083866e-01 1.20541165e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325132988626223
cond(S) = 12530.629454909229
E1 = -689.3808613117199  E_coul = 184.92618925239665
init E= -504.454672059323
    CPU time for initialize scf      3.70 sec, wall time      0.35 sec
  HOMO = -0.674439567095351  LUMO = 8.47792401726732
  mo_energy =
[-1.21696469e+02 -1.33861446e+01 -7.62700741e+00 -7.62700741e+00
 -7.62700741e+00 -1.63962850e+00 -6.74439567e-01 -6.74439567e-01
 -6.74439567e-01  8.47792402e+00  8.47786132e+01  4.58409731e+02
  2.22275895e+03  1.13999184e+04  4.09928825e+04  1.09848639e+05
  2.54049493e+05  5.48480302e+05  1.15242876e+06  2.43021199e+06
  5.37494734e+06]
E1 = -707.0652108273492  E_coul = 199.1455331572209
cycle= 1 E= -507.919677670128  delta_E= -3.47  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
diis-norm(errvec)=0.592571
diis-c [-0.35114088  1.        ]
  HOMO = -0.23279201322764  LUMO = 9.3627482276655
  mo_energy =
[-1.20247433e+02 -1.23496657e+01 -6.64467764e+00 -6.64467764e+00
 -6.64467764e+00 -1.16083826e+00 -2.32792013e-01 -2.32792013e-01
 -2.32792013e-01  9.36274823e+00  8.60847342e+01  4.59841293e+02
  2.22413500e+03  1.14011689e+04  4.09940606e+04  1.09849778e+05
  2.54050605e+05  5.48481394e+05  1.15242983e+06  2.43021306e+06
  5.37494840e+06]
E1 = -706.6897021779607  E_coul = 198.7631856806847
cycle= 2 E= -507.926516497276  delta_E= -0.00684  |g|= 0.0189  |ddm|= 0.21
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158534
diis-c [-2.45947397e-04  3.90105761e-03  9.96098942e-01]
  HOMO = -0.237685040114303  LUMO = 9.35176223246533
  mo_energy =
[-1.20307623e+02 -1.23737399e+01 -6.67438183e+00 -6.67438183e+00
 -6.67438183e+00 -1.16336206e+00 -2.37685040e-01 -2.37685040e-01
 -2.37685040e-01  9.35176223e+00  8.60429515e+01  4.59780515e+02
  2.22405967e+03  1.14010839e+04  4.09939725e+04  1.09849688e+05
  2.54050515e+05  5.48481304e+05  1.15242974e+06  2.43021297e+06
  5.37494831e+06]
E1 = -706.6734317310094  E_coul = 198.7469009792951
cycle= 3 E= -507.926530751714  delta_E= -1.43e-05  |g|= 0.000939  |ddm|= 0.00995
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00077067
diis-c [-2.11090643e-08  5.27485645e-05 -4.98448308e-02  1.04979208e+00]
  HOMO = -0.237940526860885  LUMO = 9.35120005639825
  mo_energy =
[-1.20310362e+02 -1.23749624e+01 -6.67585861e+00 -6.67585861e+00
 -6.67585861e+00 -1.16348839e+00 -2.37940527e-01 -2.37940527e-01
 -2.37940527e-01  9.35120006e+00  8.60409555e+01  4.59777795e+02
  2.22405651e+03  1.14010805e+04  4.09939690e+04  1.09849685e+05
  2.54050511e+05  5.48481300e+05  1.15242974e+06  2.43021297e+06
  5.37494830e+06]
E1 = -706.6725929774137  E_coul = 198.74606218769804
cycle= 4 E= -507.926530789716  delta_E= -3.8e-08  |g|= 8.55e-06  |ddm|= 0.000544
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.34761e-06
diis-c [-6.59401268e-12 -2.20744282e-06  2.52274271e-03 -5.10925443e-02
  1.04857201e+00]
  HOMO = -0.237941911657775  LUMO = 9.3511981471342
  mo_energy =
[-1.20310363e+02 -1.23749675e+01 -6.67586290e+00 -6.67586290e+00
 -6.67586290e+00 -1.16348916e+00 -2.37941912e-01 -2.37941912e-01
 -2.37941912e-01  9.35119815e+00  8.60409524e+01  4.59777793e+02
  2.22405651e+03  1.14010805e+04  4.09939690e+04  1.09849685e+05
  2.54050511e+05  5.48481300e+05  1.15242974e+06  2.43021297e+06
  5.37494830e+06]
E1 = -706.6725900955543  E_coul = 198.74605930583593
cycle= 5 E= -507.926530789718  delta_E= -2.61e-12  |g|= 1.52e-07  |ddm|= 3.72e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6725900955543  E_coul = 198.74605930583593
  HOMO = -0.237941948808763  LUMO = 9.35119807750542
  mo_energy =
[-1.20310364e+02 -1.23749677e+01 -6.67586308e+00 -6.67586308e+00
 -6.67586308e+00 -1.16348918e+00 -2.37941949e-01 -2.37941949e-01
 -2.37941949e-01  9.35119808e+00  8.60409522e+01  4.59777793e+02
  2.22405651e+03  1.14010805e+04  4.09939690e+04  1.09849685e+05
  2.54050511e+05  5.48481300e+05  1.15242974e+06  2.43021297e+06
  5.37494830e+06]
E1 = -706.6725899917532  E_coul = 198.74605920203433
Extra cycle  E= -507.926530789719  delta_E= -5.68e-13  |g|= 8.08e-09  |ddm|= 8.21e-08
    CPU time for scf_cycle      3.92 sec, wall time      0.42 sec
exp = [3.96743402e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180058e+03
 1.83771611e+04 1.23897764e+03 2.98186702e+02 8.85714657e+01
 3.07956739e+01 7.93188247e+00 3.08653404e+00 8.60524988e+00
 4.93083866e-01]
E = -507.92653078971887
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396743401781       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079713        1
[INPUT] 0    0    [1    /1   ]  36755.2344439        1
[INPUT] 0    0    [1    /1   ]  7331.80058169        1
[INPUT] 0    0    [1    /1   ]  18377.1611467        1
[INPUT] 0    0    [1    /1   ]  1238.97764103        1
[INPUT] 0    0    [1    /1   ]  298.186702394        1
[INPUT] 0    0    [1    /1   ]  88.5714657039        1
[INPUT] 0    0    [1    /1   ]  30.7956738901        1
[INPUT] 0    0    [1    /1   ]  7.93188246932        1
[INPUT] 0    0    [1    /1   ]  3.08653404451        1
[INPUT] 1    0    [1    /1   ]  8.60524987651        1
[INPUT] 1    0    [1    /1   ]  0.49308386584        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3967434017813443, 1.0]], [0, [1176168.1426064954, 1.0]], [0, [588084.0713031729, 1.0]], [0, [294042.03565137694, 1.0]], [0, [147021.01782436558, 1.0]], [0, [73510.50797126905, 1.0]], [0, [36755.23444392703, 1.0]], [0, [7331.800581686133, 1.0]], [0, [18377.161146660812, 1.0]], [0, [1238.9776410340398, 1.0]], [0, [298.18670239430554, 1.0]], [0, [88.57146570385513, 1.0]], [0, [30.79567389006745, 1.0]], [0, [7.931882469316405, 1.0]], [0, [3.0865340445127254, 1.0]], [1, [8.605249876510145, 1.0]], [1, [0.4930838658397867, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3967434]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130317]
bas 3, expnt(s) = [294042.03565138]
bas 4, expnt(s) = [147021.01782437]
bas 5, expnt(s) = [73510.50797127]
bas 6, expnt(s) = [36755.23444393]
bas 7, expnt(s) = [7331.80058169]
bas 8, expnt(s) = [18377.16114666]
bas 9, expnt(s) = [1238.97764103]
bas 10, expnt(s) = [298.18670239]
bas 11, expnt(s) = [88.5714657]
bas 12, expnt(s) = [30.79567389]
bas 13, expnt(s) = [7.93188247]
bas 14, expnt(s) = [3.08653404]
bas 15, expnt(s) = [8.60524988]
bas 16, expnt(s) = [0.49308387]
CPU time:       409.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96743402e-01 1.26298243e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180058e+03 2.00181070e+03
 1.83771611e+04 3.98771252e+03 1.23897764e+03 5.27609523e+02
 2.98186702e+02 1.81293080e+02 8.85714657e+01 7.29432984e+01
 3.07956739e+01 3.30280025e+01 7.93188247e+00 1.19411795e+01
 3.08653404e+00 5.88326388e+00 8.60524988e+00 4.29970589e+01
 4.93083866e-01 1.20541165e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325132988626223
cond(S) = 12530.629454909229
E1 = -689.3808613117199  E_coul = 184.92618925239665
init E= -504.454672059323
    CPU time for initialize scf      3.87 sec, wall time      0.34 sec
  HOMO = -0.674439567095351  LUMO = 8.47792401726732
  mo_energy =
[-1.21696469e+02 -1.33861446e+01 -7.62700741e+00 -7.62700741e+00
 -7.62700741e+00 -1.63962850e+00 -6.74439567e-01 -6.74439567e-01
 -6.74439567e-01  8.47792402e+00  8.47786132e+01  4.58409731e+02
  2.22275895e+03  1.13999184e+04  4.09928825e+04  1.09848639e+05
  2.54049493e+05  5.48480302e+05  1.15242876e+06  2.43021199e+06
  5.37494734e+06]
E1 = -707.0652108273492  E_coul = 199.1455331572209
cycle= 1 E= -507.919677670128  delta_E= -3.47  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.592571
diis-c [-0.35114088  1.        ]
  HOMO = -0.23279201322764  LUMO = 9.3627482276655
  mo_energy =
[-1.20247433e+02 -1.23496657e+01 -6.64467764e+00 -6.64467764e+00
 -6.64467764e+00 -1.16083826e+00 -2.32792013e-01 -2.32792013e-01
 -2.32792013e-01  9.36274823e+00  8.60847342e+01  4.59841293e+02
  2.22413500e+03  1.14011689e+04  4.09940606e+04  1.09849778e+05
  2.54050605e+05  5.48481394e+05  1.15242983e+06  2.43021306e+06
  5.37494840e+06]
E1 = -706.6897021779607  E_coul = 198.7631856806847
cycle= 2 E= -507.926516497276  delta_E= -0.00684  |g|= 0.0189  |ddm|= 0.21
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158534
diis-c [-2.45947397e-04  3.90105761e-03  9.96098942e-01]
  HOMO = -0.237685040114303  LUMO = 9.35176223246533
  mo_energy =
[-1.20307623e+02 -1.23737399e+01 -6.67438183e+00 -6.67438183e+00
 -6.67438183e+00 -1.16336206e+00 -2.37685040e-01 -2.37685040e-01
 -2.37685040e-01  9.35176223e+00  8.60429515e+01  4.59780515e+02
  2.22405967e+03  1.14010839e+04  4.09939725e+04  1.09849688e+05
  2.54050515e+05  5.48481304e+05  1.15242974e+06  2.43021297e+06
  5.37494831e+06]
E1 = -706.6734317310094  E_coul = 198.7469009792951
cycle= 3 E= -507.926530751714  delta_E= -1.43e-05  |g|= 0.000939  |ddm|= 0.00995
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00077067
diis-c [-2.11090643e-08  5.27485645e-05 -4.98448308e-02  1.04979208e+00]
  HOMO = -0.237940526860885  LUMO = 9.35120005639825
  mo_energy =
[-1.20310362e+02 -1.23749624e+01 -6.67585861e+00 -6.67585861e+00
 -6.67585861e+00 -1.16348839e+00 -2.37940527e-01 -2.37940527e-01
 -2.37940527e-01  9.35120006e+00  8.60409555e+01  4.59777795e+02
  2.22405651e+03  1.14010805e+04  4.09939690e+04  1.09849685e+05
  2.54050511e+05  5.48481300e+05  1.15242974e+06  2.43021297e+06
  5.37494830e+06]
E1 = -706.6725929774137  E_coul = 198.74606218769804
cycle= 4 E= -507.926530789716  delta_E= -3.8e-08  |g|= 8.55e-06  |ddm|= 0.000544
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.34761e-06
diis-c [-6.59401268e-12 -2.20744282e-06  2.52274271e-03 -5.10925443e-02
  1.04857201e+00]
  HOMO = -0.237941911657775  LUMO = 9.3511981471342
  mo_energy =
[-1.20310363e+02 -1.23749675e+01 -6.67586290e+00 -6.67586290e+00
 -6.67586290e+00 -1.16348916e+00 -2.37941912e-01 -2.37941912e-01
 -2.37941912e-01  9.35119815e+00  8.60409524e+01  4.59777793e+02
  2.22405651e+03  1.14010805e+04  4.09939690e+04  1.09849685e+05
  2.54050511e+05  5.48481300e+05  1.15242974e+06  2.43021297e+06
  5.37494830e+06]
E1 = -706.6725900955543  E_coul = 198.74605930583593
cycle= 5 E= -507.926530789718  delta_E= -2.61e-12  |g|= 1.52e-07  |ddm|= 3.72e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6725900955543  E_coul = 198.74605930583593
  HOMO = -0.237941948808763  LUMO = 9.35119807750542
  mo_energy =
[-1.20310364e+02 -1.23749677e+01 -6.67586308e+00 -6.67586308e+00
 -6.67586308e+00 -1.16348918e+00 -2.37941949e-01 -2.37941949e-01
 -2.37941949e-01  9.35119808e+00  8.60409522e+01  4.59777793e+02
  2.22405651e+03  1.14010805e+04  4.09939690e+04  1.09849685e+05
  2.54050511e+05  5.48481300e+05  1.15242974e+06  2.43021297e+06
  5.37494830e+06]
E1 = -706.6725899917532  E_coul = 198.74605920203433
Extra cycle  E= -507.926530789719  delta_E= -5.68e-13  |g|= 8.08e-09  |ddm|= 8.21e-08
    CPU time for scf_cycle      4.11 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12530.629454909229
E1 = -706.6725899917532  E_coul = 198.74605920203433
init E= -507.926530789719
    CPU time for initialize scf      8.50 sec, wall time      0.68 sec
  HOMO = -0.237941950655449  LUMO = 9.35119807278577
  mo_energy =
[-1.20310364e+02 -1.23749677e+01 -6.67586309e+00 -6.67586309e+00
 -6.67586309e+00 -1.16348918e+00 -2.37941951e-01 -2.37941951e-01
 -2.37941951e-01  9.35119807e+00  8.60409521e+01  4.59777793e+02
  2.22405651e+03  1.14010805e+04  4.09939690e+04  1.09849685e+05
  2.54050511e+05  5.48481300e+05  1.15242974e+06  2.43021297e+06
  5.37494830e+06]
E1 = -706.6725899868158  E_coul = 198.7460591970974
cycle= 1 E= -507.926530789718  delta_E= 5.12e-13  |g|= 1.1e-09  |ddm|= 4.27e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6725899868158  E_coul = 198.7460591970974
  HOMO = -0.237941950750307  LUMO = 9.35119807364813
  mo_energy =
[-1.20310364e+02 -1.23749677e+01 -6.67586309e+00 -6.67586309e+00
 -6.67586309e+00 -1.16348918e+00 -2.37941951e-01 -2.37941951e-01
 -2.37941951e-01  9.35119807e+00  8.60409521e+01  4.59777793e+02
  2.22405651e+03  1.14010805e+04  4.09939690e+04  1.09849685e+05
  2.54050511e+05  5.48481300e+05  1.15242974e+06  2.43021297e+06
  5.37494830e+06]
E1 = -706.6725899865315  E_coul = 198.74605919681304
Extra cycle  E= -507.926530789719  delta_E= -1.71e-13  |g|= 1.32e-09  |ddm|= 2.18e-10
    CPU time for scf_cycle      8.71 sec, wall time      0.75 sec
exp = [3.96743402e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180058e+03
 1.83771611e+04 1.23897764e+03 2.98186702e+02 8.85714657e+01
 3.07956739e+01 7.93188247e+00 3.08653404e+00 8.60524988e+00
 4.93083866e-01]
grad_E = [ 2.08951762e-04 -1.90949775e-11  4.16510092e-10  1.39871501e-09
  8.21673664e-09  2.70600182e-08  1.64934287e-07  9.05323891e-06
  4.07887944e-07 -9.73143984e-07  3.98809461e-05 -1.60174189e-03
 -2.48816831e-04  2.72617001e-04 -4.47436703e-04  4.80695047e-04
 -9.53927382e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396704198323       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079712        1
[INPUT] 0    0    [1    /1   ]  36755.2344434        1
[INPUT] 0    0    [1    /1   ]  7331.80055235        1
[INPUT] 0    0    [1    /1   ]  18377.1611453        1
[INPUT] 0    0    [1    /1   ]  1238.97764309        1
[INPUT] 0    0    [1    /1   ]  298.186594087        1
[INPUT] 0    0    [1    /1   ]  88.5757719993        1
[INPUT] 0    0    [1    /1   ]  30.7975955738        1
[INPUT] 0    0    [1    /1   ]  7.95290037315        1
[INPUT] 0    0    [1    /1   ]  3.09450181767        1
[INPUT] 1    0    [1    /1   ]  8.60440664797        1
[INPUT] 1    0    [1    /1   ]  0.493052097745       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39670419832250153, 1.0]], [0, [1176168.1426064954, 1.0]], [0, [588084.0713031715, 1.0]], [0, [294042.0356513724, 1.0]], [0, [147021.01782433895, 1.0]], [0, [73510.50797118133, 1.0]], [0, [36755.234443392495, 1.0]], [0, [7331.800552351495, 1.0]], [0, [18377.161145338367, 1.0]], [0, [1238.9776430941351, 1.0]], [0, [298.18659408728286, 1.0]], [0, [88.57577199932214, 1.0]], [0, [30.797595573759892, 1.0]], [0, [7.952900373148174, 1.0]], [0, [3.0945018176652734, 1.0]], [1, [8.604406647974837, 1.0]], [1, [0.49305209774503383, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3967042]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130317]
bas 3, expnt(s) = [294042.03565137]
bas 4, expnt(s) = [147021.01782434]
bas 5, expnt(s) = [73510.50797118]
bas 6, expnt(s) = [36755.23444339]
bas 7, expnt(s) = [7331.80055235]
bas 8, expnt(s) = [18377.16114534]
bas 9, expnt(s) = [1238.97764309]
bas 10, expnt(s) = [298.18659409]
bas 11, expnt(s) = [88.575772]
bas 12, expnt(s) = [30.79759557]
bas 13, expnt(s) = [7.95290037]
bas 14, expnt(s) = [3.09450182]
bas 15, expnt(s) = [8.60440665]
bas 16, expnt(s) = [0.4930521]
CPU time:       425.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96704198e-01 1.26288883e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180055e+03 2.00181070e+03
 1.83771611e+04 3.98771252e+03 1.23897764e+03 5.27609524e+02
 2.98186594e+02 1.81293031e+02 8.85757720e+01 7.29459583e+01
 3.07975956e+01 3.30295482e+01 7.95290037e+00 1.19649030e+01
 3.09450182e+00 5.89465078e+00 8.60440665e+00 4.29917924e+01
 4.93052098e-01 1.20531457e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325177874216866
cond(S) = 12530.674991180424
E1 = -689.3754789629622  E_coul = 184.9209432765159
init E= -504.454535686446
    CPU time for initialize scf      4.17 sec, wall time      0.34 sec
  HOMO = -0.674479005519576  LUMO = 8.51692978632459
  mo_energy =
[-1.21697402e+02 -1.33865394e+01 -7.62737482e+00 -7.62737482e+00
 -7.62737482e+00 -1.63969850e+00 -6.74479006e-01 -6.74479006e-01
 -6.74479006e-01  8.51692979e+00  8.48981527e+01  4.58541614e+02
  2.22287958e+03  1.14000218e+04  4.09929774e+04  1.09848729e+05
  2.54049581e+05  5.48480387e+05  1.15242884e+06  2.43021207e+06
  5.37494742e+06]
E1 = -707.0587466756424  E_coul = 199.13903478572942
cycle= 1 E= -507.919711889913  delta_E= -3.47  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.592538
diis-c [-0.35110149  1.        ]
  HOMO = -0.232884049865285  LUMO = 9.40275401813972
  mo_energy =
[-1.20248451e+02 -1.23501431e+01 -6.64513244e+00 -6.64513244e+00
 -6.64513244e+00 -1.16095427e+00 -2.32884050e-01 -2.32884050e-01
 -2.32884050e-01  9.40275402e+00  8.62042695e+01  4.59973081e+02
  2.22425557e+03  1.14012721e+04  4.09941554e+04  1.09849868e+05
  2.54050692e+05  5.48481479e+05  1.15242992e+06  2.43021314e+06
  5.37494848e+06]
E1 = -706.684689480914  E_coul = 198.75816884916017
cycle= 2 E= -507.926520631754  delta_E= -0.00681  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158363
diis-c [-2.45434071e-04  3.89142880e-03  9.96108571e-01]
  HOMO = -0.237749322254438  LUMO = 9.39178975905481
  mo_energy =
[-1.20308469e+02 -1.23741110e+01 -6.67471708e+00 -6.67471708e+00
 -6.67471708e+00 -1.16346187e+00 -2.37749322e-01 -2.37749322e-01
 -2.37749322e-01  9.39178976e+00  8.61626180e+01  4.59912476e+02
  2.22418042e+03  1.14011874e+04  4.09940675e+04  1.09849779e+05
  2.54050603e+05  5.48481389e+05  1.15242983e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6685186687746  E_coul = 198.74198391627075
cycle= 3 E= -507.926534752504  delta_E= -1.41e-05  |g|= 0.000934  |ddm|= 0.00989
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000768766
diis-c [-2.06403789e-08  5.23577504e-05 -4.97906099e-02  1.04973825e+00]
  HOMO = -0.238002689404378  LUMO = 9.39123016338194
  mo_energy =
[-1.20311194e+02 -1.23753251e+01 -6.67618452e+00 -6.67618452e+00
 -6.67618452e+00 -1.16358706e+00 -2.38002689e-01 -2.38002689e-01
 -2.38002689e-01  9.39123016e+00  8.61606325e+01  4.59909769e+02
  2.22417728e+03  1.14011840e+04  4.09940640e+04  1.09849776e+05
  2.54050599e+05  5.48481386e+05  1.15242982e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6676871927397  E_coul = 198.74115240280716
cycle= 4 E= -507.926534789932  delta_E= -3.74e-08  |g|= 8.4e-06  |ddm|= 0.000539
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.24043e-06
diis-c [-6.51287782e-12 -2.19451133e-06  2.50634631e-03 -5.07821958e-02
  1.04827804e+00]
  HOMO = -0.238004037502829  LUMO = 9.39122831435829
  mo_energy =
[-1.20311195e+02 -1.23753301e+01 -6.67618866e+00 -6.67618866e+00
 -6.67618866e+00 -1.16358781e+00 -2.38004038e-01 -2.38004038e-01
 -2.38004038e-01  9.39122831e+00  8.61606296e+01  4.59909768e+02
  2.22417728e+03  1.14011840e+04  4.09940640e+04  1.09849776e+05
  2.54050599e+05  5.48481386e+05  1.15242982e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6676844122047  E_coul = 198.74114962226994
cycle= 5 E= -507.926534789935  delta_E= -2.27e-12  |g|= 1.51e-07  |ddm|= 3.62e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6676844122047  E_coul = 198.74114962226994
  HOMO = -0.238004074427407  LUMO = 9.39122824398204
  mo_energy =
[-1.20311196e+02 -1.23753302e+01 -6.67618884e+00 -6.67618884e+00
 -6.67618884e+00 -1.16358783e+00 -2.38004074e-01 -2.38004074e-01
 -2.38004074e-01  9.39122824e+00  8.61606294e+01  4.59909768e+02
  2.22417728e+03  1.14011840e+04  4.09940640e+04  1.09849776e+05
  2.54050599e+05  5.48481386e+05  1.15242982e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6676843091993  E_coul = 198.74114951926407
Extra cycle  E= -507.926534789935  delta_E= -5.12e-13  |g|= 8.12e-09  |ddm|= 8.15e-08
    CPU time for scf_cycle      4.41 sec, wall time      0.41 sec
exp = [3.96704198e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180055e+03
 1.83771611e+04 1.23897764e+03 2.98186594e+02 8.85757720e+01
 3.07975956e+01 7.95290037e+00 3.09450182e+00 8.60440665e+00
 4.93052098e-01]
E = -507.92653478993526
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396704198323       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079712        1
[INPUT] 0    0    [1    /1   ]  36755.2344434        1
[INPUT] 0    0    [1    /1   ]  7331.80055235        1
[INPUT] 0    0    [1    /1   ]  18377.1611453        1
[INPUT] 0    0    [1    /1   ]  1238.97764309        1
[INPUT] 0    0    [1    /1   ]  298.186594087        1
[INPUT] 0    0    [1    /1   ]  88.5757719993        1
[INPUT] 0    0    [1    /1   ]  30.7975955738        1
[INPUT] 0    0    [1    /1   ]  7.95290037315        1
[INPUT] 0    0    [1    /1   ]  3.09450181767        1
[INPUT] 1    0    [1    /1   ]  8.60440664797        1
[INPUT] 1    0    [1    /1   ]  0.493052097745       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39670419832250153, 1.0]], [0, [1176168.1426064954, 1.0]], [0, [588084.0713031715, 1.0]], [0, [294042.0356513724, 1.0]], [0, [147021.01782433895, 1.0]], [0, [73510.50797118133, 1.0]], [0, [36755.234443392495, 1.0]], [0, [7331.800552351495, 1.0]], [0, [18377.161145338367, 1.0]], [0, [1238.9776430941351, 1.0]], [0, [298.18659408728286, 1.0]], [0, [88.57577199932214, 1.0]], [0, [30.797595573759892, 1.0]], [0, [7.952900373148174, 1.0]], [0, [3.0945018176652734, 1.0]], [1, [8.604406647974837, 1.0]], [1, [0.49305209774503383, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3967042]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130317]
bas 3, expnt(s) = [294042.03565137]
bas 4, expnt(s) = [147021.01782434]
bas 5, expnt(s) = [73510.50797118]
bas 6, expnt(s) = [36755.23444339]
bas 7, expnt(s) = [7331.80055235]
bas 8, expnt(s) = [18377.16114534]
bas 9, expnt(s) = [1238.97764309]
bas 10, expnt(s) = [298.18659409]
bas 11, expnt(s) = [88.575772]
bas 12, expnt(s) = [30.79759557]
bas 13, expnt(s) = [7.95290037]
bas 14, expnt(s) = [3.09450182]
bas 15, expnt(s) = [8.60440665]
bas 16, expnt(s) = [0.4930521]
CPU time:       429.81
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96704198e-01 1.26288883e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180055e+03 2.00181070e+03
 1.83771611e+04 3.98771252e+03 1.23897764e+03 5.27609524e+02
 2.98186594e+02 1.81293031e+02 8.85757720e+01 7.29459583e+01
 3.07975956e+01 3.30295482e+01 7.95290037e+00 1.19649030e+01
 3.09450182e+00 5.89465078e+00 8.60440665e+00 4.29917924e+01
 4.93052098e-01 1.20531457e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325177874216866
cond(S) = 12530.674991180424
E1 = -689.3754789629622  E_coul = 184.9209432765159
init E= -504.454535686446
    CPU time for initialize scf      4.02 sec, wall time      0.33 sec
  HOMO = -0.674479005519576  LUMO = 8.51692978632459
  mo_energy =
[-1.21697402e+02 -1.33865394e+01 -7.62737482e+00 -7.62737482e+00
 -7.62737482e+00 -1.63969850e+00 -6.74479006e-01 -6.74479006e-01
 -6.74479006e-01  8.51692979e+00  8.48981527e+01  4.58541614e+02
  2.22287958e+03  1.14000218e+04  4.09929774e+04  1.09848729e+05
  2.54049581e+05  5.48480387e+05  1.15242884e+06  2.43021207e+06
  5.37494742e+06]
E1 = -707.0587466756424  E_coul = 199.13903478572942
cycle= 1 E= -507.919711889913  delta_E= -3.47  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.592538
diis-c [-0.35110149  1.        ]
  HOMO = -0.232884049865285  LUMO = 9.40275401813972
  mo_energy =
[-1.20248451e+02 -1.23501431e+01 -6.64513244e+00 -6.64513244e+00
 -6.64513244e+00 -1.16095427e+00 -2.32884050e-01 -2.32884050e-01
 -2.32884050e-01  9.40275402e+00  8.62042695e+01  4.59973081e+02
  2.22425557e+03  1.14012721e+04  4.09941554e+04  1.09849868e+05
  2.54050692e+05  5.48481479e+05  1.15242992e+06  2.43021314e+06
  5.37494848e+06]
E1 = -706.684689480914  E_coul = 198.75816884916017
cycle= 2 E= -507.926520631754  delta_E= -0.00681  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.09 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158363
diis-c [-2.45434071e-04  3.89142880e-03  9.96108571e-01]
  HOMO = -0.237749322254438  LUMO = 9.39178975905481
  mo_energy =
[-1.20308469e+02 -1.23741110e+01 -6.67471708e+00 -6.67471708e+00
 -6.67471708e+00 -1.16346187e+00 -2.37749322e-01 -2.37749322e-01
 -2.37749322e-01  9.39178976e+00  8.61626180e+01  4.59912476e+02
  2.22418042e+03  1.14011874e+04  4.09940675e+04  1.09849779e+05
  2.54050603e+05  5.48481389e+05  1.15242983e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6685186687746  E_coul = 198.74198391627075
cycle= 3 E= -507.926534752504  delta_E= -1.41e-05  |g|= 0.000934  |ddm|= 0.00989
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000768766
diis-c [-2.06403789e-08  5.23577504e-05 -4.97906099e-02  1.04973825e+00]
  HOMO = -0.238002689404378  LUMO = 9.39123016338194
  mo_energy =
[-1.20311194e+02 -1.23753251e+01 -6.67618452e+00 -6.67618452e+00
 -6.67618452e+00 -1.16358706e+00 -2.38002689e-01 -2.38002689e-01
 -2.38002689e-01  9.39123016e+00  8.61606325e+01  4.59909769e+02
  2.22417728e+03  1.14011840e+04  4.09940640e+04  1.09849776e+05
  2.54050599e+05  5.48481386e+05  1.15242982e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6676871927397  E_coul = 198.74115240280716
cycle= 4 E= -507.926534789932  delta_E= -3.74e-08  |g|= 8.4e-06  |ddm|= 0.000539
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.24043e-06
diis-c [-6.51287782e-12 -2.19451133e-06  2.50634631e-03 -5.07821958e-02
  1.04827804e+00]
  HOMO = -0.238004037502829  LUMO = 9.39122831435829
  mo_energy =
[-1.20311195e+02 -1.23753301e+01 -6.67618866e+00 -6.67618866e+00
 -6.67618866e+00 -1.16358781e+00 -2.38004038e-01 -2.38004038e-01
 -2.38004038e-01  9.39122831e+00  8.61606296e+01  4.59909768e+02
  2.22417728e+03  1.14011840e+04  4.09940640e+04  1.09849776e+05
  2.54050599e+05  5.48481386e+05  1.15242982e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6676844122047  E_coul = 198.74114962226994
cycle= 5 E= -507.926534789935  delta_E= -2.27e-12  |g|= 1.51e-07  |ddm|= 3.62e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6676844122047  E_coul = 198.74114962226994
  HOMO = -0.238004074427407  LUMO = 9.39122824398204
  mo_energy =
[-1.20311196e+02 -1.23753302e+01 -6.67618884e+00 -6.67618884e+00
 -6.67618884e+00 -1.16358783e+00 -2.38004074e-01 -2.38004074e-01
 -2.38004074e-01  9.39122824e+00  8.61606294e+01  4.59909768e+02
  2.22417728e+03  1.14011840e+04  4.09940640e+04  1.09849776e+05
  2.54050599e+05  5.48481386e+05  1.15242982e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6676843091993  E_coul = 198.74114951926407
Extra cycle  E= -507.926534789935  delta_E= -5.12e-13  |g|= 8.12e-09  |ddm|= 8.15e-08
    CPU time for scf_cycle      4.30 sec, wall time      0.39 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12530.674991180424
E1 = -706.6676843091993  E_coul = 198.74114951926407
init E= -507.926534789935
    CPU time for initialize scf      9.14 sec, wall time      0.70 sec
  HOMO = -0.238004076257553  LUMO = 9.391228240917
  mo_energy =
[-1.20311196e+02 -1.23753302e+01 -6.67618885e+00 -6.67618885e+00
 -6.67618885e+00 -1.16358783e+00 -2.38004076e-01 -2.38004076e-01
 -2.38004076e-01  9.39122824e+00  8.61606293e+01  4.59909768e+02
  2.22417728e+03  1.14011840e+04  4.09940640e+04  1.09849776e+05
  2.54050599e+05  5.48481386e+05  1.15242982e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.6676843041927  E_coul = 198.7411495142573
cycle= 1 E= -507.926534789935  delta_E= -1.14e-13  |g|= 9.65e-10  |ddm|= 4.27e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.6676843041927  E_coul = 198.7411495142573
  HOMO = -0.23800407635239  LUMO = 9.39122824182153
  mo_energy =
[-1.20311196e+02 -1.23753302e+01 -6.67618885e+00 -6.67618885e+00
 -6.67618885e+00 -1.16358783e+00 -2.38004076e-01 -2.38004076e-01
 -2.38004076e-01  9.39122824e+00  8.61606293e+01  4.59909768e+02
  2.22417728e+03  1.14011840e+04  4.09940640e+04  1.09849776e+05
  2.54050599e+05  5.48481386e+05  1.15242982e+06  2.43021305e+06
  5.37494838e+06]
E1 = -706.667684304009  E_coul = 198.74114951407384
Extra cycle  E= -507.926534789935  delta_E= 2.84e-13  |g|= 1.15e-09  |ddm|= 2.1e-10
    CPU time for scf_cycle      9.21 sec, wall time      0.78 sec
exp = [3.96704198e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180055e+03
 1.83771611e+04 1.23897764e+03 2.98186594e+02 8.85757720e+01
 3.07975956e+01 7.95290037e+00 3.09450182e+00 8.60440665e+00
 4.93052098e-01]
grad_E = [-1.28586361e-04 -1.91040121e-11  4.16452993e-10  1.39849521e-09
  8.21565445e-09  2.70558718e-08  1.64912757e-07  9.05196456e-06
  4.07815936e-07 -8.81683639e-07  3.86726762e-05 -1.59853970e-03
 -2.52516858e-04  2.51124034e-04 -6.11403696e-05 -1.71076572e-04
 -1.15075565e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396649095206       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.507971         1
[INPUT] 0    0    [1    /1   ]  36755.2344425        1
[INPUT] 0    0    [1    /1   ]  7331.80050556        1
[INPUT] 0    0    [1    /1   ]  18377.1611432        1
[INPUT] 0    0    [1    /1   ]  1238.97764715        1
[INPUT] 0    0    [1    /1   ]  298.186408824        1
[INPUT] 0    0    [1    /1   ]  88.5832294763        1
[INPUT] 0    0    [1    /1   ]  30.8000682828        1
[INPUT] 0    0    [1    /1   ]  7.97232780054        1
[INPUT] 0    0    [1    /1   ]  3.10009954634        1
[INPUT] 1    0    [1    /1   ]  8.60347037109        1
[INPUT] 1    0    [1    /1   ]  0.493011084783       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.396649095205855, 1.0]], [0, [1176168.1426064954, 1.0]], [0, [588084.0713031694, 1.0]], [0, [294042.0356513652, 1.0]], [0, [147021.0178242965, 1.0]], [0, [73510.50797104144, 1.0]], [0, [36755.234442539964, 1.0]], [0, [7331.800505561429, 1.0]], [0, [18377.161143229576, 1.0]], [0, [1238.9776471452894, 1.0]], [0, [298.1864088240235, 1.0]], [0, [88.58322947629271, 1.0]], [0, [30.800068282780817, 1.0]], [0, [7.972327800540971, 1.0]], [0, [3.1000995463395467, 1.0]], [1, [8.603470371094684, 1.0]], [1, [0.4930110847832095, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3966491]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130317]
bas 3, expnt(s) = [294042.03565137]
bas 4, expnt(s) = [147021.0178243]
bas 5, expnt(s) = [73510.50797104]
bas 6, expnt(s) = [36755.23444254]
bas 7, expnt(s) = [7331.80050556]
bas 8, expnt(s) = [18377.16114323]
bas 9, expnt(s) = [1238.97764715]
bas 10, expnt(s) = [298.18640882]
bas 11, expnt(s) = [88.58322948]
bas 12, expnt(s) = [30.80006828]
bas 13, expnt(s) = [7.9723278]
bas 14, expnt(s) = [3.10009955]
bas 15, expnt(s) = [8.60347037]
bas 16, expnt(s) = [0.49301108]
CPU time:       446.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96649095e-01 1.26275726e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180051e+03 2.00181069e+03
 1.83771611e+04 3.98771252e+03 1.23897765e+03 5.27609525e+02
 2.98186409e+02 1.81292947e+02 8.85832295e+01 7.29505644e+01
 3.08000683e+01 3.30315371e+01 7.97232780e+00 1.19868173e+01
 3.10009955e+00 5.90264622e+00 8.60347037e+00 4.29859448e+01
 4.93011085e-01 1.20518925e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32523747310102
cond(S) = 12530.717400546311
E1 = -689.3691644661063  E_coul = 184.91485406138975
init E= -504.454310404717
    CPU time for initialize scf      4.58 sec, wall time      0.34 sec
  HOMO = -0.674537360387104  LUMO = 8.54834373900621
  mo_energy =
[-1.21698453e+02 -1.33870160e+01 -7.62779721e+00 -7.62779721e+00
 -7.62779721e+00 -1.63975039e+00 -6.74537360e-01 -6.74537360e-01
 -6.74537360e-01  8.54834374e+00  8.50030970e+01  4.58667507e+02
  2.22299998e+03  1.14001258e+04  4.09930730e+04  1.09848821e+05
  2.54049669e+05  5.48480473e+05  1.15242892e+06  2.43021215e+06
  5.37494749e+06]
E1 = -707.0504652312366  E_coul = 199.13072393881177
cycle= 1 E= -507.919741292425  delta_E= -3.47  |g|= 0.445  |ddm|= 0.359
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.592526
diis-c [-0.35108707  1.        ]
  HOMO = -0.233017488276699  LUMO = 9.43493828030447
  mo_energy =
[-1.20249687e+02 -1.23507727e+01 -6.64572124e+00 -6.64572124e+00
 -6.64572124e+00 -1.16108088e+00 -2.33017488e-01 -2.33017488e-01
 -2.33017488e-01  9.43493828e+00  8.63091103e+01  4.60098783e+02
  2.22437578e+03  1.14013760e+04  4.09942509e+04  1.09849960e+05
  2.54050781e+05  5.48481565e+05  1.15243000e+06  2.43021322e+06
  5.37494855e+06]
E1 = -706.6775212019099  E_coul = 198.75099384718217
cycle= 2 E= -507.926527354728  delta_E= -0.00679  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158243
diis-c [-2.45075003e-04  3.88414546e-03  9.96115855e-01]
  HOMO = -0.237860913991409  LUMO = 9.42398900401648
  mo_energy =
[-1.20309576e+02 -1.23746583e+01 -6.67521435e+00 -6.67521435e+00
 -6.67521435e+00 -1.16357571e+00 -2.37860914e-01 -2.37860914e-01
 -2.37860914e-01  9.42398900e+00  8.62675559e+01  4.60038309e+02
  2.22430078e+03  1.14012914e+04  4.09941632e+04  1.09849871e+05
  2.54050691e+05  5.48481475e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6614294944936  E_coul = 198.73488812530914
cycle= 3 E= -507.926541369185  delta_E= -1.4e-05  |g|= 0.00093  |ddm|= 0.00984
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000767315
diis-c [-2.02801562e-08  5.20215426e-05 -4.97462775e-02  1.04969426e+00]
  HOMO = -0.238112588754549  LUMO = 9.42343140839073
  mo_energy =
[-1.20312290e+02 -1.23758657e+01 -6.67667439e+00 -6.67667439e+00
 -6.67667439e+00 -1.16369999e+00 -2.38112589e-01 -2.38112589e-01
 -2.38112589e-01  9.42343141e+00  8.62655788e+01  4.60035612e+02
  2.22429765e+03  1.14012880e+04  4.09941597e+04  1.09849867e+05
  2.54050687e+05  5.48481471e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6606038622909  E_coul = 198.73406245613626
cycle= 4 E= -507.926541406155  delta_E= -3.7e-08  |g|= 8.29e-06  |ddm|= 0.000535
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.15955e-06
diis-c [-6.44960995e-12 -2.19422438e-06  2.49414745e-03 -5.05482564e-02
  1.04805630e+00]
  HOMO = -0.238113907068983  LUMO = 9.42342960539679
  mo_energy =
[-1.20312291e+02 -1.23758705e+01 -6.67667842e+00 -6.67667842e+00
 -6.67667842e+00 -1.16370073e+00 -2.38113907e-01 -2.38113907e-01
 -2.38113907e-01  9.42342961e+00  8.62655759e+01  4.60035612e+02
  2.22429766e+03  1.14012880e+04  4.09941597e+04  1.09849867e+05
  2.54050687e+05  5.48481471e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6606011646811  E_coul = 198.73405975852387
cycle= 5 E= -507.926541406157  delta_E= -2.56e-12  |g|= 1.51e-07  |ddm|= 3.55e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6606011646811  E_coul = 198.73405975852387
  HOMO = -0.238113943798579  LUMO = 9.42342953454606
  mo_energy =
[-1.20312292e+02 -1.23758707e+01 -6.67667860e+00 -6.67667860e+00
 -6.67667860e+00 -1.16370074e+00 -2.38113944e-01 -2.38113944e-01
 -2.38113944e-01  9.42342953e+00  8.62655757e+01  4.60035611e+02
  2.22429766e+03  1.14012880e+04  4.09941597e+04  1.09849867e+05
  2.54050687e+05  5.48481471e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6606010622277  E_coul = 198.7340596560703
Extra cycle  E= -507.926541406157  delta_E= -1.71e-13  |g|= 8.08e-09  |ddm|= 8.1e-08
    CPU time for scf_cycle      4.82 sec, wall time      0.42 sec
exp = [3.96649095e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180051e+03
 1.83771611e+04 1.23897765e+03 2.98186409e+02 8.85832295e+01
 3.08000683e+01 7.97232780e+00 3.10009955e+00 8.60347037e+00
 4.93011085e-01]
E = -507.9265414061574
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396649095206       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.507971         1
[INPUT] 0    0    [1    /1   ]  36755.2344425        1
[INPUT] 0    0    [1    /1   ]  7331.80050556        1
[INPUT] 0    0    [1    /1   ]  18377.1611432        1
[INPUT] 0    0    [1    /1   ]  1238.97764715        1
[INPUT] 0    0    [1    /1   ]  298.186408824        1
[INPUT] 0    0    [1    /1   ]  88.5832294763        1
[INPUT] 0    0    [1    /1   ]  30.8000682828        1
[INPUT] 0    0    [1    /1   ]  7.97232780054        1
[INPUT] 0    0    [1    /1   ]  3.10009954634        1
[INPUT] 1    0    [1    /1   ]  8.60347037109        1
[INPUT] 1    0    [1    /1   ]  0.493011084783       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.396649095205855, 1.0]], [0, [1176168.1426064954, 1.0]], [0, [588084.0713031694, 1.0]], [0, [294042.0356513652, 1.0]], [0, [147021.0178242965, 1.0]], [0, [73510.50797104144, 1.0]], [0, [36755.234442539964, 1.0]], [0, [7331.800505561429, 1.0]], [0, [18377.161143229576, 1.0]], [0, [1238.9776471452894, 1.0]], [0, [298.1864088240235, 1.0]], [0, [88.58322947629271, 1.0]], [0, [30.800068282780817, 1.0]], [0, [7.972327800540971, 1.0]], [0, [3.1000995463395467, 1.0]], [1, [8.603470371094684, 1.0]], [1, [0.4930110847832095, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3966491]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130317]
bas 3, expnt(s) = [294042.03565137]
bas 4, expnt(s) = [147021.0178243]
bas 5, expnt(s) = [73510.50797104]
bas 6, expnt(s) = [36755.23444254]
bas 7, expnt(s) = [7331.80050556]
bas 8, expnt(s) = [18377.16114323]
bas 9, expnt(s) = [1238.97764715]
bas 10, expnt(s) = [298.18640882]
bas 11, expnt(s) = [88.58322948]
bas 12, expnt(s) = [30.80006828]
bas 13, expnt(s) = [7.9723278]
bas 14, expnt(s) = [3.10009955]
bas 15, expnt(s) = [8.60347037]
bas 16, expnt(s) = [0.49301108]
CPU time:       450.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96649095e-01 1.26275726e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180051e+03 2.00181069e+03
 1.83771611e+04 3.98771252e+03 1.23897765e+03 5.27609525e+02
 2.98186409e+02 1.81292947e+02 8.85832295e+01 7.29505644e+01
 3.08000683e+01 3.30315371e+01 7.97232780e+00 1.19868173e+01
 3.10009955e+00 5.90264622e+00 8.60347037e+00 4.29859448e+01
 4.93011085e-01 1.20518925e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32523747310102
cond(S) = 12530.717400546311
E1 = -689.3691644661063  E_coul = 184.91485406138975
init E= -504.454310404717
    CPU time for initialize scf      4.35 sec, wall time      0.33 sec
  HOMO = -0.674537360387104  LUMO = 8.54834373900621
  mo_energy =
[-1.21698453e+02 -1.33870160e+01 -7.62779721e+00 -7.62779721e+00
 -7.62779721e+00 -1.63975039e+00 -6.74537360e-01 -6.74537360e-01
 -6.74537360e-01  8.54834374e+00  8.50030970e+01  4.58667507e+02
  2.22299998e+03  1.14001258e+04  4.09930730e+04  1.09848821e+05
  2.54049669e+05  5.48480473e+05  1.15242892e+06  2.43021215e+06
  5.37494749e+06]
E1 = -707.0504652312366  E_coul = 199.13072393881177
cycle= 1 E= -507.919741292425  delta_E= -3.47  |g|= 0.445  |ddm|= 0.359
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.592526
diis-c [-0.35108707  1.        ]
  HOMO = -0.233017488276699  LUMO = 9.43493828030447
  mo_energy =
[-1.20249687e+02 -1.23507727e+01 -6.64572124e+00 -6.64572124e+00
 -6.64572124e+00 -1.16108088e+00 -2.33017488e-01 -2.33017488e-01
 -2.33017488e-01  9.43493828e+00  8.63091103e+01  4.60098783e+02
  2.22437578e+03  1.14013760e+04  4.09942509e+04  1.09849960e+05
  2.54050781e+05  5.48481565e+05  1.15243000e+06  2.43021322e+06
  5.37494855e+06]
E1 = -706.6775212019099  E_coul = 198.75099384718217
cycle= 2 E= -507.926527354728  delta_E= -0.00679  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158243
diis-c [-2.45075003e-04  3.88414546e-03  9.96115855e-01]
  HOMO = -0.237860913991409  LUMO = 9.42398900401648
  mo_energy =
[-1.20309576e+02 -1.23746583e+01 -6.67521435e+00 -6.67521435e+00
 -6.67521435e+00 -1.16357571e+00 -2.37860914e-01 -2.37860914e-01
 -2.37860914e-01  9.42398900e+00  8.62675559e+01  4.60038309e+02
  2.22430078e+03  1.14012914e+04  4.09941632e+04  1.09849871e+05
  2.54050691e+05  5.48481475e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6614294944936  E_coul = 198.73488812530914
cycle= 3 E= -507.926541369185  delta_E= -1.4e-05  |g|= 0.00093  |ddm|= 0.00984
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000767315
diis-c [-2.02801562e-08  5.20215426e-05 -4.97462775e-02  1.04969426e+00]
  HOMO = -0.238112588754549  LUMO = 9.42343140839073
  mo_energy =
[-1.20312290e+02 -1.23758657e+01 -6.67667439e+00 -6.67667439e+00
 -6.67667439e+00 -1.16369999e+00 -2.38112589e-01 -2.38112589e-01
 -2.38112589e-01  9.42343141e+00  8.62655788e+01  4.60035612e+02
  2.22429765e+03  1.14012880e+04  4.09941597e+04  1.09849867e+05
  2.54050687e+05  5.48481471e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6606038622909  E_coul = 198.73406245613626
cycle= 4 E= -507.926541406155  delta_E= -3.7e-08  |g|= 8.29e-06  |ddm|= 0.000535
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.15955e-06
diis-c [-6.44960995e-12 -2.19422438e-06  2.49414745e-03 -5.05482564e-02
  1.04805630e+00]
  HOMO = -0.238113907068983  LUMO = 9.42342960539679
  mo_energy =
[-1.20312291e+02 -1.23758705e+01 -6.67667842e+00 -6.67667842e+00
 -6.67667842e+00 -1.16370073e+00 -2.38113907e-01 -2.38113907e-01
 -2.38113907e-01  9.42342961e+00  8.62655759e+01  4.60035612e+02
  2.22429766e+03  1.14012880e+04  4.09941597e+04  1.09849867e+05
  2.54050687e+05  5.48481471e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6606011646811  E_coul = 198.73405975852387
cycle= 5 E= -507.926541406157  delta_E= -2.56e-12  |g|= 1.51e-07  |ddm|= 3.55e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6606011646811  E_coul = 198.73405975852387
  HOMO = -0.238113943798579  LUMO = 9.42342953454606
  mo_energy =
[-1.20312292e+02 -1.23758707e+01 -6.67667860e+00 -6.67667860e+00
 -6.67667860e+00 -1.16370074e+00 -2.38113944e-01 -2.38113944e-01
 -2.38113944e-01  9.42342953e+00  8.62655757e+01  4.60035611e+02
  2.22429766e+03  1.14012880e+04  4.09941597e+04  1.09849867e+05
  2.54050687e+05  5.48481471e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6606010622277  E_coul = 198.7340596560703
Extra cycle  E= -507.926541406157  delta_E= -1.71e-13  |g|= 8.08e-09  |ddm|= 8.1e-08
    CPU time for scf_cycle      4.58 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12530.717400546311
E1 = -706.6606010622277  E_coul = 198.7340596560703
init E= -507.926541406157
    CPU time for initialize scf      9.51 sec, wall time      0.70 sec
  HOMO = -0.23811394561575  LUMO = 9.42342953231279
  mo_energy =
[-1.20312292e+02 -1.23758707e+01 -6.67667861e+00 -6.67667861e+00
 -6.67667861e+00 -1.16370075e+00 -2.38113946e-01 -2.38113946e-01
 -2.38113946e-01  9.42342953e+00  8.62655757e+01  4.60035611e+02
  2.22429766e+03  1.14012880e+04  4.09941597e+04  1.09849867e+05
  2.54050687e+05  5.48481471e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6606010573345  E_coul = 198.73405965117695
cycle= 1 E= -507.926541406158  delta_E= -1.14e-13  |g|= 1.32e-09  |ddm|= 4.23e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.6606010573345  E_coul = 198.73405965117695
  HOMO = -0.238113945709293  LUMO = 9.42342953426456
  mo_energy =
[-1.20312292e+02 -1.23758707e+01 -6.67667861e+00 -6.67667861e+00
 -6.67667861e+00 -1.16370075e+00 -2.38113946e-01 -2.38113946e-01
 -2.38113946e-01  9.42342953e+00  8.62655757e+01  4.60035611e+02
  2.22429766e+03  1.14012880e+04  4.09941597e+04  1.09849867e+05
  2.54050687e+05  5.48481471e+05  1.15242991e+06  2.43021313e+06
  5.37494846e+06]
E1 = -706.6606010571744  E_coul = 198.73405965101705
Extra cycle  E= -507.926541406157  delta_E= 1.71e-13  |g|= 1.01e-09  |ddm|= 2.09e-10
    CPU time for scf_cycle      9.59 sec, wall time      0.77 sec
exp = [3.96649095e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180051e+03
 1.83771611e+04 1.23897765e+03 2.98186409e+02 8.85832295e+01
 3.08000683e+01 7.97232780e+00 3.10009955e+00 8.60347037e+00
 4.93011085e-01]
grad_E = [-9.78145993e-04 -1.91187423e-11  4.16357726e-10  1.39812947e-09
  8.21384763e-09  2.70489702e-08  1.64876801e-07  9.04983473e-06
  4.07696413e-07 -7.30916204e-07  3.67399406e-05 -1.59414377e-03
 -2.51095408e-04  3.31797504e-04 -6.09377191e-05 -9.06876056e-04
 -1.80441382e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396554591723       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079705        1
[INPUT] 0    0    [1    /1   ]  36755.2344394        1
[INPUT] 0    0    [1    /1   ]  7331.80033109        1
[INPUT] 0    0    [1    /1   ]  18377.1611354        1
[INPUT] 0    0    [1    /1   ]  1238.97766268        1
[INPUT] 0    0    [1    /1   ]  298.185703368        1
[INPUT] 0    0    [1    /1   ]  88.6119780165        1
[INPUT] 0    0    [1    /1   ]  30.8079455892        1
[INPUT] 0    0    [1    /1   ]  8.02053886833        1
[INPUT] 0    0    [1    /1   ]  3.11424990339        1
[INPUT] 1    0    [1    /1   ]  8.60171484577        1
[INPUT] 1    0    [1    /1   ]  0.492963050183       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39655459172283053, 1.0]], [0, [1176168.1426064959, 1.0]], [0, [588084.0713031613, 1.0]], [0, [294042.0356513382, 1.0]], [0, [147021.01782413814, 1.0]], [0, [73510.50797051987, 1.0]], [0, [36755.23443936114, 1.0]], [0, [7331.800331090576, 1.0]], [0, [18377.16113536725, 1.0]], [0, [1238.977662679352, 1.0]], [0, [298.1857033682732, 1.0]], [0, [88.61197801653408, 1.0]], [0, [30.80794558923093, 1.0]], [0, [8.020538868334054, 1.0]], [0, [3.1142499033928446, 1.0]], [1, [8.601714845773907, 1.0]], [1, [0.49296305018315545, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39655459]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130316]
bas 3, expnt(s) = [294042.03565134]
bas 4, expnt(s) = [147021.01782414]
bas 5, expnt(s) = [73510.50797052]
bas 6, expnt(s) = [36755.23443936]
bas 7, expnt(s) = [7331.80033109]
bas 8, expnt(s) = [18377.16113537]
bas 9, expnt(s) = [1238.97766268]
bas 10, expnt(s) = [298.18570337]
bas 11, expnt(s) = [88.61197802]
bas 12, expnt(s) = [30.80794559]
bas 13, expnt(s) = [8.02053887]
bas 14, expnt(s) = [3.1142499]
bas 15, expnt(s) = [8.60171485]
bas 16, expnt(s) = [0.49296305]
CPU time:       467.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96554592e-01 1.26253161e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180033e+03 2.00181065e+03
 1.83771611e+04 3.98771252e+03 1.23897766e+03 5.27609530e+02
 2.98185703e+02 1.81292625e+02 8.86119780e+01 7.29683200e+01
 3.08079456e+01 3.30378729e+01 8.02053887e+00 1.20411422e+01
 3.11424990e+00 5.92284161e+00 8.60171485e+00 4.29749811e+01
 4.92963050e-01 1.20504247e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32530722395343
cond(S) = 12530.832707100892
E1 = -689.3585128616207  E_coul = 184.90429488421464
init E= -504.454217977406
    CPU time for initialize scf      4.60 sec, wall time      0.34 sec
  HOMO = -0.674611464123536  LUMO = 8.6276484138762
  mo_energy =
[-1.21700365e+02 -1.33878254e+01 -7.62854075e+00 -7.62854075e+00
 -7.62854075e+00 -1.63983333e+00 -6.74611464e-01 -6.74611464e-01
 -6.74611464e-01  8.62764841e+00  8.52720364e+01  4.59013439e+02
  2.22334339e+03  1.14004250e+04  4.09933484e+04  1.09849084e+05
  2.54049923e+05  5.48480720e+05  1.15242916e+06  2.43021239e+06
  5.37494772e+06]
E1 = -707.0363634123838  E_coul = 199.11654070717472
cycle= 1 E= -507.919822705209  delta_E= -3.47  |g|= 0.445  |ddm|= 0.359
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.592508
diis-c [-0.35106589  1.        ]
  HOMO = -0.233200821848966  LUMO = 9.5162584653236
  mo_energy =
[-1.20251903e+02 -1.23518367e+01 -6.64674687e+00 -6.64674687e+00
 -6.64674687e+00 -1.16128055e+00 -2.33200822e-01 -2.33200822e-01
 -2.33200822e-01  9.51625847e+00  8.65779569e+01  4.60444397e+02
  2.22471891e+03  1.14016749e+04  4.09945260e+04  1.09850222e+05
  2.54051035e+05  5.48481812e+05  1.15243024e+06  2.43021345e+06
  5.37494878e+06]
E1 = -706.6661938115914  E_coul = 198.73964162443923
cycle= 2 E= -507.926552187152  delta_E= -0.00673  |g|= 0.0187  |ddm|= 0.207
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157949
diis-c [-2.44193476e-04  3.86624783e-03  9.96133752e-01]
  HOMO = -0.237990514103533  LUMO = 9.50534724006529
  mo_energy =
[-1.20311467e+02 -1.23755167e+01 -6.67601140e+00 -6.67601140e+00
 -6.67601140e+00 -1.16374371e+00 -2.37990514e-01 -2.37990514e-01
 -2.37990514e-01  9.50534724e+00  8.65366443e+01  4.60384248e+02
  2.22464428e+03  1.14015907e+04  4.09944386e+04  1.09850134e+05
  2.54050946e+05  5.48481722e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.6502978515549  E_coul = 198.72373191187688
cycle= 3 E= -507.926565939678  delta_E= -1.38e-05  |g|= 0.000921  |ddm|= 0.00971
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000763748
diis-c [-1.93998256e-08  5.12141331e-05 -4.96367714e-02  1.04958556e+00]
  HOMO = -0.238238036258938  LUMO = 9.50479461225584
  mo_energy =
[-1.20314155e+02 -1.23767076e+01 -6.67745314e+00 -6.67745314e+00
 -6.67745314e+00 -1.16386575e+00 -2.38238036e-01 -2.38238036e-01
 -2.38238036e-01  9.50479461e+00  8.65346877e+01  4.60381578e+02
  2.22464118e+03  1.14015873e+04  4.09944352e+04  1.09850130e+05
  2.54050942e+05  5.48481719e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.6494865979616  E_coul = 198.72292062243216
cycle= 4 E= -507.926565975529  delta_E= -3.59e-08  |g|= 8e-06  |ddm|= 0.000525
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.95565e-06
diis-c [-6.29875980e-12 -2.16675001e-06  2.46140811e-03 -4.99240904e-02
  1.04746485e+00]
  HOMO = -0.238239282030767  LUMO = 9.50479293213518
  mo_energy =
[-1.20314156e+02 -1.23767121e+01 -6.67745688e+00 -6.67745688e+00
 -6.67745688e+00 -1.16386645e+00 -2.38239282e-01 -2.38239282e-01
 -2.38239282e-01  9.50479293e+00  8.65346852e+01  4.60381577e+02
  2.22464118e+03  1.14015873e+04  4.09944352e+04  1.09850130e+05
  2.54050942e+05  5.48481719e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.649484101114  E_coul = 198.72291812558188
cycle= 5 E= -507.926565975532  delta_E= -2.67e-12  |g|= 1.49e-07  |ddm|= 3.37e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.649484101114  E_coul = 198.72291812558188
  HOMO = -0.238239318322556  LUMO = 9.5047928622655
  mo_energy =
[-1.20314156e+02 -1.23767122e+01 -6.67745706e+00 -6.67745706e+00
 -6.67745706e+00 -1.16386647e+00 -2.38239318e-01 -2.38239318e-01
 -2.38239318e-01  9.50479286e+00  8.65346849e+01  4.60381577e+02
  2.22464118e+03  1.14015873e+04  4.09944352e+04  1.09850130e+05
  2.54050942e+05  5.48481719e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.6494840001297  E_coul = 198.72291802459742
Extra cycle  E= -507.926565975532  delta_E= -1.71e-13  |g|= 7.96e-09  |ddm|= 7.99e-08
    CPU time for scf_cycle      4.83 sec, wall time      0.42 sec
exp = [3.96554592e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180033e+03
 1.83771611e+04 1.23897766e+03 2.98185703e+02 8.86119780e+01
 3.08079456e+01 8.02053887e+00 3.11424990e+00 8.60171485e+00
 4.92963050e-01]
E = -507.9265659755323
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:26:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396554591723       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079705        1
[INPUT] 0    0    [1    /1   ]  36755.2344394        1
[INPUT] 0    0    [1    /1   ]  7331.80033109        1
[INPUT] 0    0    [1    /1   ]  18377.1611354        1
[INPUT] 0    0    [1    /1   ]  1238.97766268        1
[INPUT] 0    0    [1    /1   ]  298.185703368        1
[INPUT] 0    0    [1    /1   ]  88.6119780165        1
[INPUT] 0    0    [1    /1   ]  30.8079455892        1
[INPUT] 0    0    [1    /1   ]  8.02053886833        1
[INPUT] 0    0    [1    /1   ]  3.11424990339        1
[INPUT] 1    0    [1    /1   ]  8.60171484577        1
[INPUT] 1    0    [1    /1   ]  0.492963050183       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39655459172283053, 1.0]], [0, [1176168.1426064959, 1.0]], [0, [588084.0713031613, 1.0]], [0, [294042.0356513382, 1.0]], [0, [147021.01782413814, 1.0]], [0, [73510.50797051987, 1.0]], [0, [36755.23443936114, 1.0]], [0, [7331.800331090576, 1.0]], [0, [18377.16113536725, 1.0]], [0, [1238.977662679352, 1.0]], [0, [298.1857033682732, 1.0]], [0, [88.61197801653408, 1.0]], [0, [30.80794558923093, 1.0]], [0, [8.020538868334054, 1.0]], [0, [3.1142499033928446, 1.0]], [1, [8.601714845773907, 1.0]], [1, [0.49296305018315545, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39655459]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130316]
bas 3, expnt(s) = [294042.03565134]
bas 4, expnt(s) = [147021.01782414]
bas 5, expnt(s) = [73510.50797052]
bas 6, expnt(s) = [36755.23443936]
bas 7, expnt(s) = [7331.80033109]
bas 8, expnt(s) = [18377.16113537]
bas 9, expnt(s) = [1238.97766268]
bas 10, expnt(s) = [298.18570337]
bas 11, expnt(s) = [88.61197802]
bas 12, expnt(s) = [30.80794559]
bas 13, expnt(s) = [8.02053887]
bas 14, expnt(s) = [3.1142499]
bas 15, expnt(s) = [8.60171485]
bas 16, expnt(s) = [0.49296305]
CPU time:       472.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96554592e-01 1.26253161e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663116e+03 7.33180033e+03 2.00181065e+03
 1.83771611e+04 3.98771252e+03 1.23897766e+03 5.27609530e+02
 2.98185703e+02 1.81292625e+02 8.86119780e+01 7.29683200e+01
 3.08079456e+01 3.30378729e+01 8.02053887e+00 1.20411422e+01
 3.11424990e+00 5.92284161e+00 8.60171485e+00 4.29749811e+01
 4.92963050e-01 1.20504247e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32530722395343
cond(S) = 12530.832707100892
E1 = -689.3585128616207  E_coul = 184.90429488421464
init E= -504.454217977406
    CPU time for initialize scf      4.31 sec, wall time      0.32 sec
  HOMO = -0.674611464123536  LUMO = 8.6276484138762
  mo_energy =
[-1.21700365e+02 -1.33878254e+01 -7.62854075e+00 -7.62854075e+00
 -7.62854075e+00 -1.63983333e+00 -6.74611464e-01 -6.74611464e-01
 -6.74611464e-01  8.62764841e+00  8.52720364e+01  4.59013439e+02
  2.22334339e+03  1.14004250e+04  4.09933484e+04  1.09849084e+05
  2.54049923e+05  5.48480720e+05  1.15242916e+06  2.43021239e+06
  5.37494772e+06]
E1 = -707.0363634123838  E_coul = 199.11654070717472
cycle= 1 E= -507.919822705209  delta_E= -3.47  |g|= 0.445  |ddm|= 0.359
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.592508
diis-c [-0.35106589  1.        ]
  HOMO = -0.233200821848966  LUMO = 9.5162584653236
  mo_energy =
[-1.20251903e+02 -1.23518367e+01 -6.64674687e+00 -6.64674687e+00
 -6.64674687e+00 -1.16128055e+00 -2.33200822e-01 -2.33200822e-01
 -2.33200822e-01  9.51625847e+00  8.65779569e+01  4.60444397e+02
  2.22471891e+03  1.14016749e+04  4.09945260e+04  1.09850222e+05
  2.54051035e+05  5.48481812e+05  1.15243024e+06  2.43021345e+06
  5.37494878e+06]
E1 = -706.6661938115914  E_coul = 198.73964162443923
cycle= 2 E= -507.926552187152  delta_E= -0.00673  |g|= 0.0187  |ddm|= 0.207
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157949
diis-c [-2.44193476e-04  3.86624783e-03  9.96133752e-01]
  HOMO = -0.237990514103533  LUMO = 9.50534724006529
  mo_energy =
[-1.20311467e+02 -1.23755167e+01 -6.67601140e+00 -6.67601140e+00
 -6.67601140e+00 -1.16374371e+00 -2.37990514e-01 -2.37990514e-01
 -2.37990514e-01  9.50534724e+00  8.65366443e+01  4.60384248e+02
  2.22464428e+03  1.14015907e+04  4.09944386e+04  1.09850134e+05
  2.54050946e+05  5.48481722e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.6502978515549  E_coul = 198.72373191187688
cycle= 3 E= -507.926565939678  delta_E= -1.38e-05  |g|= 0.000921  |ddm|= 0.00971
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000763748
diis-c [-1.93998256e-08  5.12141331e-05 -4.96367714e-02  1.04958556e+00]
  HOMO = -0.238238036258938  LUMO = 9.50479461225584
  mo_energy =
[-1.20314155e+02 -1.23767076e+01 -6.67745314e+00 -6.67745314e+00
 -6.67745314e+00 -1.16386575e+00 -2.38238036e-01 -2.38238036e-01
 -2.38238036e-01  9.50479461e+00  8.65346877e+01  4.60381578e+02
  2.22464118e+03  1.14015873e+04  4.09944352e+04  1.09850130e+05
  2.54050942e+05  5.48481719e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.6494865979616  E_coul = 198.72292062243216
cycle= 4 E= -507.926565975529  delta_E= -3.59e-08  |g|= 8e-06  |ddm|= 0.000525
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.95565e-06
diis-c [-6.29875980e-12 -2.16675001e-06  2.46140811e-03 -4.99240904e-02
  1.04746485e+00]
  HOMO = -0.238239282030767  LUMO = 9.50479293213518
  mo_energy =
[-1.20314156e+02 -1.23767121e+01 -6.67745688e+00 -6.67745688e+00
 -6.67745688e+00 -1.16386645e+00 -2.38239282e-01 -2.38239282e-01
 -2.38239282e-01  9.50479293e+00  8.65346852e+01  4.60381577e+02
  2.22464118e+03  1.14015873e+04  4.09944352e+04  1.09850130e+05
  2.54050942e+05  5.48481719e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.649484101114  E_coul = 198.72291812558188
cycle= 5 E= -507.926565975532  delta_E= -2.67e-12  |g|= 1.49e-07  |ddm|= 3.37e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.649484101114  E_coul = 198.72291812558188
  HOMO = -0.238239318322556  LUMO = 9.5047928622655
  mo_energy =
[-1.20314156e+02 -1.23767122e+01 -6.67745706e+00 -6.67745706e+00
 -6.67745706e+00 -1.16386647e+00 -2.38239318e-01 -2.38239318e-01
 -2.38239318e-01  9.50479286e+00  8.65346849e+01  4.60381577e+02
  2.22464118e+03  1.14015873e+04  4.09944352e+04  1.09850130e+05
  2.54050942e+05  5.48481719e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.6494840001297  E_coul = 198.72291802459742
Extra cycle  E= -507.926565975532  delta_E= -1.71e-13  |g|= 7.96e-09  |ddm|= 7.99e-08
    CPU time for scf_cycle      4.57 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12530.832707100892
E1 = -706.6494840001297  E_coul = 198.72291802459742
init E= -507.926565975532
    CPU time for initialize scf      9.63 sec, wall time      0.69 sec
  HOMO = -0.238239320108006  LUMO = 9.50479285831658
  mo_energy =
[-1.20314156e+02 -1.23767122e+01 -6.67745707e+00 -6.67745707e+00
 -6.67745707e+00 -1.16386647e+00 -2.38239320e-01 -2.38239320e-01
 -2.38239320e-01  9.50479286e+00  8.65346849e+01  4.60381577e+02
  2.22464118e+03  1.14015873e+04  4.09944352e+04  1.09850130e+05
  2.54050942e+05  5.48481719e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.6494839954145  E_coul = 198.72291801988203
cycle= 1 E= -507.926565975532  delta_E= -1.14e-13  |g|= 9.49e-10  |ddm|= 4.12e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6494839954145  E_coul = 198.72291801988203
  HOMO = -0.238239320198852  LUMO = 9.50479285810462
  mo_energy =
[-1.20314156e+02 -1.23767122e+01 -6.67745707e+00 -6.67745707e+00
 -6.67745707e+00 -1.16386647e+00 -2.38239320e-01 -2.38239320e-01
 -2.38239320e-01  9.50479286e+00  8.65346849e+01  4.60381577e+02
  2.22464118e+03  1.14015873e+04  4.09944352e+04  1.09850130e+05
  2.54050942e+05  5.48481719e+05  1.15243015e+06  2.43021336e+06
  5.37494869e+06]
E1 = -706.6494839951554  E_coul = 198.72291801962322
Extra cycle  E= -507.926565975532  delta_E= 2.27e-13  |g|= 7.51e-10  |ddm|= 2.28e-10
    CPU time for scf_cycle      9.82 sec, wall time      0.76 sec
exp = [3.96554592e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33180033e+03
 1.83771611e+04 1.23897766e+03 2.98185703e+02 8.86119780e+01
 3.08079456e+01 8.02053887e+00 3.11424990e+00 8.60171485e+00
 4.92963050e-01]
grad_E = [-2.29530446e-03 -1.91802567e-11  4.15954357e-10  1.39658388e-09
  8.20619469e-09  2.70198016e-08  1.64724454e-07  9.04078291e-06
  4.07192325e-07 -8.56254377e-08  2.82652254e-05 -1.56823292e-03
 -2.65045066e-04  4.94017075e-04  5.40924664e-05 -2.30558186e-03
 -1.85562383e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396444980832       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079693        1
[INPUT] 0    0    [1    /1   ]  36755.2344321        1
[INPUT] 0    0    [1    /1   ]  7331.79993281        1
[INPUT] 0    0    [1    /1   ]  18377.1611174        1
[INPUT] 0    0    [1    /1   ]  1238.9776984         1
[INPUT] 0    0    [1    /1   ]  298.184076608        1
[INPUT] 0    0    [1    /1   ]  88.6791496311        1
[INPUT] 0    0    [1    /1   ]  30.8238659861        1
[INPUT] 0    0    [1    /1   ]  8.09050129507        1
[INPUT] 0    0    [1    /1   ]  3.13349776491        1
[INPUT] 1    0    [1    /1   ]  8.5995590353         1
[INPUT] 1    0    [1    /1   ]  0.492915904287       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39644498083165786, 1.0]], [0, [1176168.1426064968, 1.0]], [0, [588084.071303143, 1.0]], [0, [294042.0356512767, 1.0]], [0, [147021.01782377664, 1.0]], [0, [73510.50796932932, 1.0]], [0, [36755.23443210481, 1.0]], [0, [7331.799932814541, 1.0]], [0, [18377.16111742108, 1.0]], [0, [1238.977698401382, 1.0]], [0, [298.1840766082021, 1.0]], [0, [88.67914963106158, 1.0]], [0, [30.823865986063183, 1.0]], [0, [8.09050129507331, 1.0]], [0, [3.1334977649096696, 1.0]], [1, [8.599559035295941, 1.0]], [1, [0.49291590428673016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39644498]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130314]
bas 3, expnt(s) = [294042.03565128]
bas 4, expnt(s) = [147021.01782378]
bas 5, expnt(s) = [73510.50796933]
bas 6, expnt(s) = [36755.2344321]
bas 7, expnt(s) = [7331.79993281]
bas 8, expnt(s) = [18377.16111742]
bas 9, expnt(s) = [1238.9776984]
bas 10, expnt(s) = [298.18407661]
bas 11, expnt(s) = [88.67914963]
bas 12, expnt(s) = [30.82386599]
bas 13, expnt(s) = [8.0905013]
bas 14, expnt(s) = [3.13349776]
bas 15, expnt(s) = [8.59955904]
bas 16, expnt(s) = [0.4929159]
CPU time:       490.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96444981e-01 1.26226987e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663115e+03 7.33179993e+03 2.00181057e+03
 1.83771611e+04 3.98771252e+03 1.23897770e+03 5.27609542e+02
 2.98184077e+02 1.81291883e+02 8.86791496e+01 7.30098009e+01
 3.08238660e+01 3.30506766e+01 8.09050130e+00 1.21198319e+01
 3.13349776e+00 5.95027539e+00 8.59955904e+00 4.29615182e+01
 4.92915904e-01 1.20489841e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32537379170077
cond(S) = 12531.021794340686
E1 = -689.3461836930447  E_coul = 184.8916032438979
init E= -504.454580449147
    CPU time for initialize scf      4.41 sec, wall time      0.33 sec
  HOMO = -0.674691304899093  LUMO = 8.74022150800333
  mo_energy =
[-1.21702713e+02 -1.33887870e+01 -7.62943947e+00 -7.62943947e+00
 -7.62943947e+00 -1.63992045e+00 -6.74691305e-01 -6.74691305e-01
 -6.74691305e-01  8.74022151e+00  8.56739358e+01  4.59590208e+02
  2.22394537e+03  1.14009544e+04  4.09938363e+04  1.09849550e+05
  2.54050374e+05  5.48481158e+05  1.15242959e+06  2.43021280e+06
  5.37494812e+06]
E1 = -707.019215250614  E_coul = 199.09925882495367
cycle= 1 E= -507.91995642566  delta_E= -3.47  |g|= 0.444  |ddm|= 0.36
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.592515
diis-c [-0.35107373  1.        ]
  HOMO = -0.233405731178884  LUMO = 9.63169731027235
  mo_energy =
[-1.20254646e+02 -1.23531252e+01 -6.64801255e+00 -6.64801255e+00
 -6.64801255e+00 -1.16150867e+00 -2.33405731e-01 -2.33405731e-01
 -2.33405731e-01  9.63169731e+00  8.69798004e+01  4.61020755e+02
  2.22532054e+03  1.14022040e+04  4.09950136e+04  1.09850688e+05
  2.54051486e+05  5.48482249e+05  1.15243067e+06  2.43021387e+06
  5.37494918e+06]
E1 = -706.652879801732  E_coul = 198.72627190000068
cycle= 2 E= -507.926607901731  delta_E= -0.00665  |g|= 0.0186  |ddm|= 0.205
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157553
diis-c [-2.43009007e-04  3.84235246e-03  9.96157648e-01]
  HOMO = -0.238121402728178  LUMO = 9.62083807635432
  mo_energy =
[-1.20313762e+02 -1.23765203e+01 -6.67696096e+00 -6.67696096e+00
 -6.67696096e+00 -1.16392812e+00 -2.38121403e-01 -2.38121403e-01
 -2.38121403e-01  9.62083808e+00  8.69388174e+01  4.60961052e+02
  2.22524641e+03  1.14021204e+04  4.09949267e+04  1.09850600e+05
  2.54051397e+05  5.48482160e+05  1.15243058e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.637254045034  E_coul = 198.7106327500603
cycle= 3 E= -507.926621294974  delta_E= -1.34e-05  |g|= 0.000908  |ddm|= 0.00953
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000758897
diis-c [-1.82258196e-08  5.00993085e-05 -4.94853005e-02  1.04943520e+00]
  HOMO = -0.238363225620461  LUMO = 9.62029229548039
  mo_energy =
[-1.20316414e+02 -1.23776883e+01 -6.67837748e+00 -6.67837748e+00
 -6.67837748e+00 -1.16404708e+00 -2.38363226e-01 -2.38363226e-01
 -2.38363226e-01  9.62029230e+00  8.69368889e+01  4.60958418e+02
  2.22524335e+03  1.14021171e+04  4.09949234e+04  1.09850597e+05
  2.54051393e+05  5.48482157e+05  1.15243057e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.6364625219031  E_coul = 198.70984119259253
cycle= 4 E= -507.926621329311  delta_E= -3.43e-08  |g|= 7.62e-06  |ddm|= 0.000511
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.68027e-06
diis-c [-6.08008074e-12 -2.14611412e-06  2.41571374e-03 -4.90421174e-02
  1.04662855e+00]
  HOMO = -0.238364373109204  LUMO = 9.62029077661548
  mo_energy =
[-1.20316414e+02 -1.23776924e+01 -6.67838082e+00 -6.67838082e+00
 -6.67838082e+00 -1.16404772e+00 -2.38364373e-01 -2.38364373e-01
 -2.38364373e-01  9.62029078e+00  8.69368868e+01  4.60958418e+02
  2.22524335e+03  1.14021171e+04  4.09949234e+04  1.09850597e+05
  2.54051393e+05  5.48482157e+05  1.15243057e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.6364602950769  E_coul = 198.7098389657638
cycle= 5 E= -507.926621329313  delta_E= -2.5e-12  |g|= 1.47e-07  |ddm|= 3.12e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6364602950769  E_coul = 198.7098389657638
  HOMO = -0.238364408737077  LUMO = 9.62029070745962
  mo_energy =
[-1.20316415e+02 -1.23776926e+01 -6.67838099e+00 -6.67838099e+00
 -6.67838099e+00 -1.16404774e+00 -2.38364409e-01 -2.38364409e-01
 -2.38364409e-01  9.62029071e+00  8.69368866e+01  4.60958417e+02
  2.22524335e+03  1.14021171e+04  4.09949234e+04  1.09850597e+05
  2.54051393e+05  5.48482157e+05  1.15243057e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.636460196347  E_coul = 198.70983886703428
Extra cycle  E= -507.926621329313  delta_E= 3.41e-13  |g|= 7.74e-09  |ddm|= 7.82e-08
    CPU time for scf_cycle      4.66 sec, wall time      0.39 sec
exp = [3.96444981e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33179993e+03
 1.83771611e+04 1.23897770e+03 2.98184077e+02 8.86791496e+01
 3.08238660e+01 8.09050130e+00 3.13349776e+00 8.59955904e+00
 4.92915904e-01]
E = -507.92662132931275
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396444980832       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017824        1
[INPUT] 0    0    [1    /1   ]  73510.5079693        1
[INPUT] 0    0    [1    /1   ]  36755.2344321        1
[INPUT] 0    0    [1    /1   ]  7331.79993281        1
[INPUT] 0    0    [1    /1   ]  18377.1611174        1
[INPUT] 0    0    [1    /1   ]  1238.9776984         1
[INPUT] 0    0    [1    /1   ]  298.184076608        1
[INPUT] 0    0    [1    /1   ]  88.6791496311        1
[INPUT] 0    0    [1    /1   ]  30.8238659861        1
[INPUT] 0    0    [1    /1   ]  8.09050129507        1
[INPUT] 0    0    [1    /1   ]  3.13349776491        1
[INPUT] 1    0    [1    /1   ]  8.5995590353         1
[INPUT] 1    0    [1    /1   ]  0.492915904287       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39644498083165786, 1.0]], [0, [1176168.1426064968, 1.0]], [0, [588084.071303143, 1.0]], [0, [294042.0356512767, 1.0]], [0, [147021.01782377664, 1.0]], [0, [73510.50796932932, 1.0]], [0, [36755.23443210481, 1.0]], [0, [7331.799932814541, 1.0]], [0, [18377.16111742108, 1.0]], [0, [1238.977698401382, 1.0]], [0, [298.1840766082021, 1.0]], [0, [88.67914963106158, 1.0]], [0, [30.823865986063183, 1.0]], [0, [8.09050129507331, 1.0]], [0, [3.1334977649096696, 1.0]], [1, [8.599559035295941, 1.0]], [1, [0.49291590428673016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39644498]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130314]
bas 3, expnt(s) = [294042.03565128]
bas 4, expnt(s) = [147021.01782378]
bas 5, expnt(s) = [73510.50796933]
bas 6, expnt(s) = [36755.2344321]
bas 7, expnt(s) = [7331.79993281]
bas 8, expnt(s) = [18377.16111742]
bas 9, expnt(s) = [1238.9776984]
bas 10, expnt(s) = [298.18407661]
bas 11, expnt(s) = [88.67914963]
bas 12, expnt(s) = [30.82386599]
bas 13, expnt(s) = [8.0905013]
bas 14, expnt(s) = [3.13349776]
bas 15, expnt(s) = [8.59955904]
bas 16, expnt(s) = [0.4929159]
CPU time:       494.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96444981e-01 1.26226987e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663115e+03 7.33179993e+03 2.00181057e+03
 1.83771611e+04 3.98771252e+03 1.23897770e+03 5.27609542e+02
 2.98184077e+02 1.81291883e+02 8.86791496e+01 7.30098009e+01
 3.08238660e+01 3.30506766e+01 8.09050130e+00 1.21198319e+01
 3.13349776e+00 5.95027539e+00 8.59955904e+00 4.29615182e+01
 4.92915904e-01 1.20489841e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32537379170077
cond(S) = 12531.021794340686
E1 = -689.3461836930447  E_coul = 184.8916032438979
init E= -504.454580449147
    CPU time for initialize scf      4.84 sec, wall time      0.34 sec
  HOMO = -0.674691304899093  LUMO = 8.74022150800333
  mo_energy =
[-1.21702713e+02 -1.33887870e+01 -7.62943947e+00 -7.62943947e+00
 -7.62943947e+00 -1.63992045e+00 -6.74691305e-01 -6.74691305e-01
 -6.74691305e-01  8.74022151e+00  8.56739358e+01  4.59590208e+02
  2.22394537e+03  1.14009544e+04  4.09938363e+04  1.09849550e+05
  2.54050374e+05  5.48481158e+05  1.15242959e+06  2.43021280e+06
  5.37494812e+06]
E1 = -707.019215250614  E_coul = 199.09925882495367
cycle= 1 E= -507.91995642566  delta_E= -3.47  |g|= 0.444  |ddm|= 0.36
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.592515
diis-c [-0.35107373  1.        ]
  HOMO = -0.233405731178884  LUMO = 9.63169731027235
  mo_energy =
[-1.20254646e+02 -1.23531252e+01 -6.64801255e+00 -6.64801255e+00
 -6.64801255e+00 -1.16150867e+00 -2.33405731e-01 -2.33405731e-01
 -2.33405731e-01  9.63169731e+00  8.69798004e+01  4.61020755e+02
  2.22532054e+03  1.14022040e+04  4.09950136e+04  1.09850688e+05
  2.54051486e+05  5.48482249e+05  1.15243067e+06  2.43021387e+06
  5.37494918e+06]
E1 = -706.652879801732  E_coul = 198.72627190000068
cycle= 2 E= -507.926607901731  delta_E= -0.00665  |g|= 0.0186  |ddm|= 0.205
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157553
diis-c [-2.43009007e-04  3.84235246e-03  9.96157648e-01]
  HOMO = -0.238121402728178  LUMO = 9.62083807635432
  mo_energy =
[-1.20313762e+02 -1.23765203e+01 -6.67696096e+00 -6.67696096e+00
 -6.67696096e+00 -1.16392812e+00 -2.38121403e-01 -2.38121403e-01
 -2.38121403e-01  9.62083808e+00  8.69388174e+01  4.60961052e+02
  2.22524641e+03  1.14021204e+04  4.09949267e+04  1.09850600e+05
  2.54051397e+05  5.48482160e+05  1.15243058e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.637254045034  E_coul = 198.7106327500603
cycle= 3 E= -507.926621294974  delta_E= -1.34e-05  |g|= 0.000908  |ddm|= 0.00953
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000758897
diis-c [-1.82258196e-08  5.00993085e-05 -4.94853005e-02  1.04943520e+00]
  HOMO = -0.238363225620461  LUMO = 9.62029229548039
  mo_energy =
[-1.20316414e+02 -1.23776883e+01 -6.67837748e+00 -6.67837748e+00
 -6.67837748e+00 -1.16404708e+00 -2.38363226e-01 -2.38363226e-01
 -2.38363226e-01  9.62029230e+00  8.69368889e+01  4.60958418e+02
  2.22524335e+03  1.14021171e+04  4.09949234e+04  1.09850597e+05
  2.54051393e+05  5.48482157e+05  1.15243057e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.6364625219031  E_coul = 198.70984119259253
cycle= 4 E= -507.926621329311  delta_E= -3.43e-08  |g|= 7.62e-06  |ddm|= 0.000511
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.68027e-06
diis-c [-6.08008074e-12 -2.14611412e-06  2.41571374e-03 -4.90421174e-02
  1.04662855e+00]
  HOMO = -0.238364373109204  LUMO = 9.62029077661548
  mo_energy =
[-1.20316414e+02 -1.23776924e+01 -6.67838082e+00 -6.67838082e+00
 -6.67838082e+00 -1.16404772e+00 -2.38364373e-01 -2.38364373e-01
 -2.38364373e-01  9.62029078e+00  8.69368868e+01  4.60958418e+02
  2.22524335e+03  1.14021171e+04  4.09949234e+04  1.09850597e+05
  2.54051393e+05  5.48482157e+05  1.15243057e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.6364602950769  E_coul = 198.7098389657638
cycle= 5 E= -507.926621329313  delta_E= -2.5e-12  |g|= 1.47e-07  |ddm|= 3.12e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6364602950769  E_coul = 198.7098389657638
  HOMO = -0.238364408737077  LUMO = 9.62029070745962
  mo_energy =
[-1.20316415e+02 -1.23776926e+01 -6.67838099e+00 -6.67838099e+00
 -6.67838099e+00 -1.16404774e+00 -2.38364409e-01 -2.38364409e-01
 -2.38364409e-01  9.62029071e+00  8.69368866e+01  4.60958417e+02
  2.22524335e+03  1.14021171e+04  4.09949234e+04  1.09850597e+05
  2.54051393e+05  5.48482157e+05  1.15243057e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.636460196347  E_coul = 198.70983886703428
Extra cycle  E= -507.926621329313  delta_E= 3.41e-13  |g|= 7.74e-09  |ddm|= 7.82e-08
    CPU time for scf_cycle      5.10 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12531.021794340686
E1 = -706.636460196347  E_coul = 198.70983886703428
init E= -507.926621329313
    CPU time for initialize scf     10.22 sec, wall time      0.69 sec
  HOMO = -0.238364410477102  LUMO = 9.62029070434352
  mo_energy =
[-1.20316415e+02 -1.23776926e+01 -6.67838100e+00 -6.67838100e+00
 -6.67838100e+00 -1.16404774e+00 -2.38364410e-01 -2.38364410e-01
 -2.38364410e-01  9.62029070e+00  8.69368866e+01  4.60958417e+02
  2.22524335e+03  1.14021171e+04  4.09949234e+04  1.09850597e+05
  2.54051393e+05  5.48482157e+05  1.15243057e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.6364601917454  E_coul = 198.70983886243258
cycle= 1 E= -507.926621329313  delta_E= -1.14e-13  |g|= 9.01e-10  |ddm|= 4e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6364601917454  E_coul = 198.70983886243258
  HOMO = -0.238364410564846  LUMO = 9.62029070379818
  mo_energy =
[-1.20316415e+02 -1.23776926e+01 -6.67838100e+00 -6.67838100e+00
 -6.67838100e+00 -1.16404774e+00 -2.38364411e-01 -2.38364411e-01
 -2.38364411e-01  9.62029070e+00  8.69368866e+01  4.60958417e+02
  2.22524335e+03  1.14021171e+04  4.09949234e+04  1.09850597e+05
  2.54051393e+05  5.48482157e+05  1.15243057e+06  2.43021378e+06
  5.37494909e+06]
E1 = -706.6364601915537  E_coul = 198.70983886224076
Extra cycle  E= -507.926621329313  delta_E= -1.14e-13  |g|= 1.01e-09  |ddm|= 2.07e-10
    CPU time for scf_cycle     10.42 sec, wall time      0.75 sec
exp = [3.96444981e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33179993e+03
 1.83771611e+04 1.23897770e+03 2.98184077e+02 8.86791496e+01
 3.08238660e+01 8.09050130e+00 3.13349776e+00 8.59955904e+00
 4.92915904e-01]
grad_E = [-3.87132423e-03 -1.93289010e-11  4.14972263e-10  1.39282484e-09
  8.18755830e-09  2.69488571e-08  1.64353392e-07  9.01869691e-06
  4.05967734e-07  1.49429588e-06  7.35835713e-06 -1.49758307e-03
 -3.16783924e-04  7.55529917e-04  7.33333505e-05 -4.03668706e-03
 -1.48307469e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.39632696009        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017823        1
[INPUT] 0    0    [1    /1   ]  73510.5079665        1
[INPUT] 0    0    [1    /1   ]  36755.2344147        1
[INPUT] 0    0    [1    /1   ]  7331.79897502        1
[INPUT] 0    0    [1    /1   ]  18377.1610743        1
[INPUT] 0    0    [1    /1   ]  1238.97778273        1
[INPUT] 0    0    [1    /1   ]  298.180163759        1
[INPUT] 0    0    [1    /1   ]  88.8430334224        1
[INPUT] 0    0    [1    /1   ]  30.8588843826        1
[INPUT] 0    0    [1    /1   ]  8.19513859978        1
[INPUT] 0    0    [1    /1   ]  3.16059794643        1
[INPUT] 1    0    [1    /1   ]  8.59708792326        1
[INPUT] 1    0    [1    /1   ]  0.492887469407       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39632696008976587, 1.0]], [0, [1176168.142606499, 1.0]], [0, [588084.0713030989, 1.0]], [0, [294042.03565112874, 1.0]], [0, [147021.0178229073, 1.0]], [0, [73510.50796646636, 1.0]], [0, [36755.23441465466, 1.0]], [0, [7331.798975021591, 1.0]], [0, [18377.161074266194, 1.0]], [0, [1238.9777827323144, 1.0]], [0, [298.18016375880126, 1.0]], [0, [88.84303342241644, 1.0]], [0, [30.85888438263466, 1.0]], [0, [8.195138599782887, 1.0]], [0, [3.1605979464310794, 1.0]], [1, [8.597087923256884, 1.0]], [1, [0.49288746940666384, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39632696]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.0713031]
bas 3, expnt(s) = [294042.03565113]
bas 4, expnt(s) = [147021.01782291]
bas 5, expnt(s) = [73510.50796647]
bas 6, expnt(s) = [36755.23441465]
bas 7, expnt(s) = [7331.79897502]
bas 8, expnt(s) = [18377.16107427]
bas 9, expnt(s) = [1238.97778273]
bas 10, expnt(s) = [298.18016376]
bas 11, expnt(s) = [88.84303342]
bas 12, expnt(s) = [30.85888438]
bas 13, expnt(s) = [8.1951386]
bas 14, expnt(s) = [3.16059795]
bas 15, expnt(s) = [8.59708792]
bas 16, expnt(s) = [0.49288747]
CPU time:       513.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96326960e-01 1.26198803e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663115e+03 7.33179898e+03 2.00181038e+03
 1.83771611e+04 3.98771251e+03 1.23897778e+03 5.27609569e+02
 2.98180164e+02 1.81290099e+02 8.88430334e+01 7.31109721e+01
 3.08588844e+01 3.30788338e+01 8.19513860e+00 1.22372054e+01
 3.16059795e+00 5.98882971e+00 8.59708792e+00 4.29460873e+01
 4.92887469e-01 1.20481153e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32540956651806
cond(S) = 12531.361302402627
E1 = -689.3338642143028  E_coul = 184.87762672614622
init E= -504.456237488157
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.674758353013254  LUMO = 8.90587838819248
  mo_energy =
[-1.21705416e+02 -1.33898110e+01 -7.63044177e+00 -7.63044177e+00
 -7.63044177e+00 -1.63999903e+00 -6.74758353e-01 -6.74758353e-01
 -6.74758353e-01  8.90587839e+00  8.63107070e+01  4.60644599e+02
  2.22510867e+03  1.14019880e+04  4.09947900e+04  1.09850462e+05
  2.54051256e+05  5.48482014e+05  1.15243042e+06  2.43021361e+06
  5.37494890e+06]
E1 = -707.0001094852162  E_coul = 199.07991134828876
cycle= 1 E= -507.920198136927  delta_E= -3.46  |g|= 0.443  |ddm|= 0.36
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592585
diis-c [-0.35115699  1.        ]
  HOMO = -0.233594228842717  LUMO = 9.80158375994921
  mo_energy =
[-1.20257830e+02 -1.23545395e+01 -6.64946179e+00 -6.64946179e+00
 -6.64946179e+00 -1.16174002e+00 -2.33594229e-01 -2.33594229e-01
 -2.33594229e-01  9.80158376e+00  8.76166851e+01  4.62074648e+02
  2.22648344e+03  1.14032372e+04  4.09959669e+04  1.09851600e+05
  2.54052367e+05  5.48483105e+05  1.15243150e+06  2.43021468e+06
  5.37494996e+06]
E1 = -706.6392362461152  E_coul = 198.7124975637415
cycle= 2 E= -507.926738682374  delta_E= -0.00654  |g|= 0.0184  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157002
diis-c [-2.41361645e-04  3.81040431e-03  9.96189596e-01]
  HOMO = -0.238205228389459  LUMO = 9.79079819244781
  mo_energy =
[-1.20316307e+02 -1.23775275e+01 -6.67795930e+00 -6.67795930e+00
 -6.67795930e+00 -1.16409755e+00 -2.38205228e-01 -2.38205228e-01
 -2.38205228e-01  9.79079819e+00  8.75761630e+01  4.62015577e+02
  2.22641002e+03  1.14031543e+04  4.09958808e+04  1.09851513e+05
  2.54052279e+05  5.48483017e+05  1.15243141e+06  2.43021459e+06
  5.37494987e+06]
E1 = -706.6239930341924  E_coul = 198.69724146217192
cycle= 3 E= -507.92675157202  delta_E= -1.29e-05  |g|= 0.00089  |ddm|= 0.00927
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000752153
diis-c [-1.66413627e-08  4.85453178e-05 -4.92720265e-02  1.04922348e+00]
  HOMO = -0.238439054907729  LUMO = 9.79026209512225
  mo_energy =
[-1.20318909e+02 -1.23786632e+01 -6.67934014e+00 -6.67934014e+00
 -6.67934014e+00 -1.16421219e+00 -2.38439055e-01 -2.38439055e-01
 -2.38439055e-01  9.79026210e+00  8.75742740e+01  4.62012994e+02
  2.22640702e+03  1.14031510e+04  4.09958775e+04  1.09851509e+05
  2.54052276e+05  5.48483013e+05  1.15243140e+06  2.43021458e+06
  5.37494987e+06]
E1 = -706.6232291547  E_coul = 198.69647755042115
cycle= 4 E= -507.926751604279  delta_E= -3.23e-08  |g|= 7.08e-06  |ddm|= 0.000491
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.29617e-06
diis-c [-5.77776367e-12 -2.10468813e-06  2.34657591e-03 -4.76947151e-02
  1.04535024e+00]
  HOMO = -0.23844006731276  LUMO = 9.79026080178909
  mo_energy =
[-1.20318908e+02 -1.23786667e+01 -6.67934294e+00 -6.67934294e+00
 -6.67934294e+00 -1.16421276e+00 -2.38440067e-01 -2.38440067e-01
 -2.38440067e-01  9.79026080e+00  8.75742725e+01  4.62012994e+02
  2.22640702e+03  1.14031510e+04  4.09958775e+04  1.09851509e+05
  2.54052276e+05  5.48483013e+05  1.15243140e+06  2.43021458e+06
  5.37494987e+06]
E1 = -706.6232272943097  E_coul = 198.69647569002828
cycle= 5 E= -507.926751604281  delta_E= -2.61e-12  |g|= 1.45e-07  |ddm|= 2.78e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6232272943097  E_coul = 198.69647569002828
  HOMO = -0.238440101977154  LUMO = 9.79026073387303
  mo_energy =
[-1.20318909e+02 -1.23786669e+01 -6.67934311e+00 -6.67934311e+00
 -6.67934311e+00 -1.16421278e+00 -2.38440102e-01 -2.38440102e-01
 -2.38440102e-01  9.79026073e+00  8.75742723e+01  4.62012994e+02
  2.22640702e+03  1.14031510e+04  4.09958775e+04  1.09851509e+05
  2.54052276e+05  5.48483013e+05  1.15243140e+06  2.43021458e+06
  5.37494987e+06]
E1 = -706.6232271988254  E_coul = 198.69647559454458
Extra cycle  E= -507.926751604281  delta_E= 6.82e-13  |g|= 7.6e-09  |ddm|= 7.57e-08
    CPU time for scf_cycle      5.04 sec, wall time      0.41 sec
exp = [3.96326960e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33179898e+03
 1.83771611e+04 1.23897778e+03 2.98180164e+02 8.88430334e+01
 3.08588844e+01 8.19513860e+00 3.16059795e+00 8.59708792e+00
 4.92887469e-01]
E = -507.92675160428075
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.39632696009        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017823        1
[INPUT] 0    0    [1    /1   ]  73510.5079665        1
[INPUT] 0    0    [1    /1   ]  36755.2344147        1
[INPUT] 0    0    [1    /1   ]  7331.79897502        1
[INPUT] 0    0    [1    /1   ]  18377.1610743        1
[INPUT] 0    0    [1    /1   ]  1238.97778273        1
[INPUT] 0    0    [1    /1   ]  298.180163759        1
[INPUT] 0    0    [1    /1   ]  88.8430334224        1
[INPUT] 0    0    [1    /1   ]  30.8588843826        1
[INPUT] 0    0    [1    /1   ]  8.19513859978        1
[INPUT] 0    0    [1    /1   ]  3.16059794643        1
[INPUT] 1    0    [1    /1   ]  8.59708792326        1
[INPUT] 1    0    [1    /1   ]  0.492887469407       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39632696008976587, 1.0]], [0, [1176168.142606499, 1.0]], [0, [588084.0713030989, 1.0]], [0, [294042.03565112874, 1.0]], [0, [147021.0178229073, 1.0]], [0, [73510.50796646636, 1.0]], [0, [36755.23441465466, 1.0]], [0, [7331.798975021591, 1.0]], [0, [18377.161074266194, 1.0]], [0, [1238.9777827323144, 1.0]], [0, [298.18016375880126, 1.0]], [0, [88.84303342241644, 1.0]], [0, [30.85888438263466, 1.0]], [0, [8.195138599782887, 1.0]], [0, [3.1605979464310794, 1.0]], [1, [8.597087923256884, 1.0]], [1, [0.49288746940666384, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39632696]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.0713031]
bas 3, expnt(s) = [294042.03565113]
bas 4, expnt(s) = [147021.01782291]
bas 5, expnt(s) = [73510.50796647]
bas 6, expnt(s) = [36755.23441465]
bas 7, expnt(s) = [7331.79897502]
bas 8, expnt(s) = [18377.16107427]
bas 9, expnt(s) = [1238.97778273]
bas 10, expnt(s) = [298.18016376]
bas 11, expnt(s) = [88.84303342]
bas 12, expnt(s) = [30.85888438]
bas 13, expnt(s) = [8.1951386]
bas 14, expnt(s) = [3.16059795]
bas 15, expnt(s) = [8.59708792]
bas 16, expnt(s) = [0.49288747]
CPU time:       518.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96326960e-01 1.26198803e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663115e+03 7.33179898e+03 2.00181038e+03
 1.83771611e+04 3.98771251e+03 1.23897778e+03 5.27609569e+02
 2.98180164e+02 1.81290099e+02 8.88430334e+01 7.31109721e+01
 3.08588844e+01 3.30788338e+01 8.19513860e+00 1.22372054e+01
 3.16059795e+00 5.98882971e+00 8.59708792e+00 4.29460873e+01
 4.92887469e-01 1.20481153e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32540956651806
cond(S) = 12531.361302402627
E1 = -689.3338642143028  E_coul = 184.87762672614622
init E= -504.456237488157
    CPU time for initialize scf      4.61 sec, wall time      0.32 sec
  HOMO = -0.674758353013254  LUMO = 8.90587838819248
  mo_energy =
[-1.21705416e+02 -1.33898110e+01 -7.63044177e+00 -7.63044177e+00
 -7.63044177e+00 -1.63999903e+00 -6.74758353e-01 -6.74758353e-01
 -6.74758353e-01  8.90587839e+00  8.63107070e+01  4.60644599e+02
  2.22510867e+03  1.14019880e+04  4.09947900e+04  1.09850462e+05
  2.54051256e+05  5.48482014e+05  1.15243042e+06  2.43021361e+06
  5.37494890e+06]
E1 = -707.0001094852162  E_coul = 199.07991134828876
cycle= 1 E= -507.920198136927  delta_E= -3.46  |g|= 0.443  |ddm|= 0.36
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592585
diis-c [-0.35115699  1.        ]
  HOMO = -0.233594228842717  LUMO = 9.80158375994921
  mo_energy =
[-1.20257830e+02 -1.23545395e+01 -6.64946179e+00 -6.64946179e+00
 -6.64946179e+00 -1.16174002e+00 -2.33594229e-01 -2.33594229e-01
 -2.33594229e-01  9.80158376e+00  8.76166851e+01  4.62074648e+02
  2.22648344e+03  1.14032372e+04  4.09959669e+04  1.09851600e+05
  2.54052367e+05  5.48483105e+05  1.15243150e+06  2.43021468e+06
  5.37494996e+06]
E1 = -706.6392362461152  E_coul = 198.7124975637415
cycle= 2 E= -507.926738682374  delta_E= -0.00654  |g|= 0.0184  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157002
diis-c [-2.41361645e-04  3.81040431e-03  9.96189596e-01]
  HOMO = -0.238205228389459  LUMO = 9.79079819244781
  mo_energy =
[-1.20316307e+02 -1.23775275e+01 -6.67795930e+00 -6.67795930e+00
 -6.67795930e+00 -1.16409755e+00 -2.38205228e-01 -2.38205228e-01
 -2.38205228e-01  9.79079819e+00  8.75761630e+01  4.62015577e+02
  2.22641002e+03  1.14031543e+04  4.09958808e+04  1.09851513e+05
  2.54052279e+05  5.48483017e+05  1.15243141e+06  2.43021459e+06
  5.37494987e+06]
E1 = -706.6239930341924  E_coul = 198.69724146217192
cycle= 3 E= -507.92675157202  delta_E= -1.29e-05  |g|= 0.00089  |ddm|= 0.00927
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000752153
diis-c [-1.66413627e-08  4.85453178e-05 -4.92720265e-02  1.04922348e+00]
  HOMO = -0.238439054907729  LUMO = 9.79026209512225
  mo_energy =
[-1.20318909e+02 -1.23786632e+01 -6.67934014e+00 -6.67934014e+00
 -6.67934014e+00 -1.16421219e+00 -2.38439055e-01 -2.38439055e-01
 -2.38439055e-01  9.79026210e+00  8.75742740e+01  4.62012994e+02
  2.22640702e+03  1.14031510e+04  4.09958775e+04  1.09851509e+05
  2.54052276e+05  5.48483013e+05  1.15243140e+06  2.43021458e+06
  5.37494987e+06]
E1 = -706.6232291547  E_coul = 198.69647755042115
cycle= 4 E= -507.926751604279  delta_E= -3.23e-08  |g|= 7.08e-06  |ddm|= 0.000491
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.29617e-06
diis-c [-5.77776367e-12 -2.10468813e-06  2.34657591e-03 -4.76947151e-02
  1.04535024e+00]
  HOMO = -0.23844006731276  LUMO = 9.79026080178909
  mo_energy =
[-1.20318908e+02 -1.23786667e+01 -6.67934294e+00 -6.67934294e+00
 -6.67934294e+00 -1.16421276e+00 -2.38440067e-01 -2.38440067e-01
 -2.38440067e-01  9.79026080e+00  8.75742725e+01  4.62012994e+02
  2.22640702e+03  1.14031510e+04  4.09958775e+04  1.09851509e+05
  2.54052276e+05  5.48483013e+05  1.15243140e+06  2.43021458e+06
  5.37494987e+06]
E1 = -706.6232272943097  E_coul = 198.69647569002828
cycle= 5 E= -507.926751604281  delta_E= -2.61e-12  |g|= 1.45e-07  |ddm|= 2.78e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6232272943097  E_coul = 198.69647569002828
  HOMO = -0.238440101977154  LUMO = 9.79026073387303
  mo_energy =
[-1.20318909e+02 -1.23786669e+01 -6.67934311e+00 -6.67934311e+00
 -6.67934311e+00 -1.16421278e+00 -2.38440102e-01 -2.38440102e-01
 -2.38440102e-01  9.79026073e+00  8.75742723e+01  4.62012994e+02
  2.22640702e+03  1.14031510e+04  4.09958775e+04  1.09851509e+05
  2.54052276e+05  5.48483013e+05  1.15243140e+06  2.43021458e+06
  5.37494987e+06]
E1 = -706.6232271988254  E_coul = 198.69647559454458
Extra cycle  E= -507.926751604281  delta_E= 6.82e-13  |g|= 7.6e-09  |ddm|= 7.57e-08
    CPU time for scf_cycle      4.87 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12531.361302402627
E1 = -706.6232271988254  E_coul = 198.69647559454458
init E= -507.926751604281
    CPU time for initialize scf      2.95 sec, wall time      0.19 sec
  HOMO = -0.238440103650842  LUMO = 9.79026073129234
  mo_energy =
[-1.20318909e+02 -1.23786669e+01 -6.67934312e+00 -6.67934312e+00
 -6.67934312e+00 -1.16421278e+00 -2.38440104e-01 -2.38440104e-01
 -2.38440104e-01  9.79026073e+00  8.75742723e+01  4.62012994e+02
  2.22640702e+03  1.14031510e+04  4.09958775e+04  1.09851509e+05
  2.54052276e+05  5.48483013e+05  1.15243140e+06  2.43021458e+06
  5.37494987e+06]
E1 = -706.6232271943846  E_coul = 198.6964755901038
cycle= 1 E= -507.926751604281  delta_E= -1.14e-13  |g|= 1.3e-09  |ddm|= 3.86e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6232271943846  E_coul = 198.6964755901038
  HOMO = -0.238440103735037  LUMO = 9.7902607307223
  mo_energy =
[-1.20318909e+02 -1.23786669e+01 -6.67934312e+00 -6.67934312e+00
 -6.67934312e+00 -1.16421278e+00 -2.38440104e-01 -2.38440104e-01
 -2.38440104e-01  9.79026073e+00  8.75742723e+01  4.62012994e+02
  2.22640702e+03  1.14031510e+04  4.09958775e+04  1.09851509e+05
  2.54052276e+05  5.48483013e+05  1.15243140e+06  2.43021458e+06
  5.37494987e+06]
E1 = -706.6232271941751  E_coul = 198.69647558989433
Extra cycle  E= -507.926751604281  delta_E= 1.14e-13  |g|= 1.07e-09  |ddm|= 1.9e-10
    CPU time for scf_cycle      3.12 sec, wall time      0.26 sec
exp = [3.96326960e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33179898e+03
 1.83771611e+04 1.23897778e+03 2.98180164e+02 8.88430334e+01
 3.08588844e+01 8.19513860e+00 3.16059795e+00 8.59708792e+00
 4.92887469e-01]
grad_E = [-5.54150953e-03 -1.96985001e-11  4.12517551e-10  1.38343709e-09
  8.14097171e-09  2.67716798e-08  1.63425680e-07  8.96338411e-06
  4.02912390e-07  5.46577186e-06 -4.53087138e-05 -1.30884605e-03
 -4.78676116e-04  1.14012605e-03  2.22327720e-06 -6.04578279e-03
 -5.25217518e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396267065343       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017821        1
[INPUT] 0    0    [1    /1   ]  73510.5079608        1
[INPUT] 0    0    [1    /1   ]  36755.2343802        1
[INPUT] 0    0    [1    /1   ]  7331.79708511        1
[INPUT] 0    0    [1    /1   ]  18377.1609891        1
[INPUT] 0    0    [1    /1   ]  1238.97794254        1
[INPUT] 0    0    [1    /1   ]  298.172497846        1
[INPUT] 0    0    [1    /1   ]  89.1696663437        1
[INPUT] 0    0    [1    /1   ]  30.9233315465        1
[INPUT] 0    0    [1    /1   ]  8.30752952045        1
[INPUT] 0    0    [1    /1   ]  3.18634215021        1
[INPUT] 1    0    [1    /1   ]  8.5956002402         1
[INPUT] 1    0    [1    /1   ]  0.492911666502       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39626706534267714, 1.0]], [0, [1176168.1426065029, 1.0]], [0, [588084.071303012, 1.0]], [0, [294042.03565083677, 1.0]], [0, [147021.01782119196, 1.0]], [0, [73510.50796081737, 1.0]], [0, [36755.23438022245, 1.0]], [0, [7331.797085114114, 1.0]], [0, [18377.16098911826, 1.0]], [0, [1238.9779425431118, 1.0]], [0, [298.17249784603007, 1.0]], [0, [89.16966634365279, 1.0]], [0, [30.92333154649574, 1.0]], [0, [8.30752952045085, 1.0]], [0, [3.1863421502113467, 1.0]], [1, [8.595600240196966, 1.0]], [1, [0.49291166650158047, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39626707]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130301]
bas 3, expnt(s) = [294042.03565084]
bas 4, expnt(s) = [147021.01782119]
bas 5, expnt(s) = [73510.50796082]
bas 6, expnt(s) = [36755.23438022]
bas 7, expnt(s) = [7331.79708511]
bas 8, expnt(s) = [18377.16098912]
bas 9, expnt(s) = [1238.97794254]
bas 10, expnt(s) = [298.17249785]
bas 11, expnt(s) = [89.16966634]
bas 12, expnt(s) = [30.92333155]
bas 13, expnt(s) = [8.30752952]
bas 14, expnt(s) = [3.18634215]
bas 15, expnt(s) = [8.59560024]
bas 16, expnt(s) = [0.49291167]
CPU time:       528.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96267065e-01 1.26184499e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663115e+03 7.33179709e+03 2.00180999e+03
 1.83771610e+04 3.98771250e+03 1.23897794e+03 5.27609620e+02
 2.98172498e+02 1.81286603e+02 8.91696663e+01 7.33124748e+01
 3.09233315e+01 3.31306329e+01 8.30752952e+00 1.23628598e+01
 3.18634215e+00 6.02537846e+00 8.59560024e+00 4.29367980e+01
 4.92911667e-01 1.20488546e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325364464792795
cond(S) = 12531.861391330347
E1 = -689.3301211421109  E_coul = 184.86995377387274
init E= -504.460167368238
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67476597471836  LUMO = 9.07761791331071
  mo_energy =
[-1.21707109e+02 -1.33903132e+01 -7.63101618e+00 -7.63101618e+00
 -7.63101618e+00 -1.63999585e+00 -6.74765975e-01 -6.74765975e-01
 -6.74765975e-01  9.07761791e+00  8.70832346e+01  4.62234215e+02
  2.22698426e+03  1.14036736e+04  4.09963476e+04  1.09851951e+05
  2.54052697e+05  5.48483413e+05  1.15243178e+06  2.43021493e+06
  5.37495018e+06]
E1 = -706.988610395396  E_coul = 199.06805662255417
cycle= 1 E= -507.920553772842  delta_E= -3.46  |g|= 0.443  |ddm|= 0.361
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592781
diis-c [-0.35138983  1.        ]
  HOMO = -0.233650307747941  LUMO = 9.97774502778525
  mo_energy =
[-1.20259944e+02 -1.23553589e+01 -6.65041507e+00 -6.65041507e+00
 -6.65041507e+00 -1.16183301e+00 -2.33650308e-01 -2.33650308e-01
 -2.33650308e-01  9.97774503e+00  8.83896419e+01  4.63663840e+02
  2.22835874e+03  1.14049224e+04  4.09975241e+04  1.09853089e+05
  2.54053807e+05  5.48484504e+05  1.15243286e+06  2.43021600e+06
  5.37495124e+06]
E1 = -706.6331278997869  E_coul = 198.70614256073867
cycle= 2 E= -507.926985339048  delta_E= -0.00643  |g|= 0.0182  |ddm|= 0.198
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156491
diis-c [-2.39828558e-04  3.78421154e-03  9.96215788e-01]
  HOMO = -0.23815844701469  LUMO = 9.96702960819088
  mo_energy =
[-1.20317795e+02 -1.23779425e+01 -6.67846673e+00 -6.67846673e+00
 -6.67846673e+00 -1.16412944e+00 -2.38158447e-01 -2.38158447e-01
 -2.38158447e-01  9.96702961e+00  8.83495514e+01  4.63605382e+02
  2.22828602e+03  1.14048402e+04  4.09974388e+04  1.09853002e+05
  2.54053720e+05  5.48484416e+05  1.15243277e+06  2.43021591e+06
  5.37495116e+06]
E1 = -706.6182621321717  E_coul = 198.69126439514727
cycle= 3 E= -507.926997737024  delta_E= -1.24e-05  |g|= 0.000872  |ddm|= 0.00901
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000745756
diis-c [-1.51691837e-08  4.70121702e-05 -4.90639624e-02  1.04901695e+00]
  HOMO = -0.238384472649814  LUMO = 9.9665029491017
  mo_energy =
[-1.20320346e+02 -1.23790462e+01 -6.67981255e+00 -6.67981255e+00
 -6.67981255e+00 -1.16423986e+00 -2.38384473e-01 -2.38384473e-01
 -2.38384473e-01  9.96650295e+00  8.83477000e+01  4.63602847e+02
  2.22828307e+03  1.14048370e+04  4.09974355e+04  1.09852999e+05
  2.54053717e+05  5.48484413e+05  1.15243276e+06  2.43021591e+06
  5.37495115e+06]
E1 = -706.6175252181237  E_coul = 198.69052745081981
cycle= 4 E= -507.926997767304  delta_E= -3.03e-08  |g|= 6.57e-06  |ddm|= 0.000472
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.92521e-06
diis-c [-5.47333606e-12 -2.05779609e-06  2.27334369e-03 -4.62487054e-02
  1.04397742e+00]
  HOMO = -0.238385355811995  LUMO = 9.96650187569343
  mo_energy =
[-1.20320345e+02 -1.23790493e+01 -6.67981482e+00 -6.67981482e+00
 -6.67981482e+00 -1.16424036e+00 -2.38385356e-01 -2.38385356e-01
 -2.38385356e-01  9.96650188e+00  8.83476991e+01  4.63602849e+02
  2.22828307e+03  1.14048370e+04  4.09974355e+04  1.09852999e+05
  2.54053717e+05  5.48484413e+05  1.15243276e+06  2.43021591e+06
  5.37495115e+06]
E1 = -706.6175237036723  E_coul = 198.69052593636684
cycle= 5 E= -507.926997767305  delta_E= -1.59e-12  |g|= 1.42e-07  |ddm|= 2.46e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6175237036723  E_coul = 198.69052593636684
  HOMO = -0.238385389456512  LUMO = 9.9665018093201
  mo_energy =
[-1.20320345e+02 -1.23790495e+01 -6.67981499e+00 -6.67981499e+00
 -6.67981499e+00 -1.16424038e+00 -2.38385389e-01 -2.38385389e-01
 -2.38385389e-01  9.96650181e+00  8.83476989e+01  4.63602848e+02
  2.22828307e+03  1.14048370e+04  4.09974355e+04  1.09852999e+05
  2.54053717e+05  5.48484413e+05  1.15243276e+06  2.43021591e+06
  5.37495115e+06]
E1 = -706.61752361159  E_coul = 198.6905258442843
Extra cycle  E= -507.926997767306  delta_E= -1.71e-13  |g|= 7.38e-09  |ddm|= 7.31e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.96267065e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33179709e+03
 1.83771610e+04 1.23897794e+03 2.98172498e+02 8.91696663e+01
 3.09233315e+01 8.30752952e+00 3.18634215e+00 8.59560024e+00
 4.92911667e-01]
E = -507.92699776730564
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396267065343       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.035651        1
[INPUT] 0    0    [1    /1   ]  147021.017821        1
[INPUT] 0    0    [1    /1   ]  73510.5079608        1
[INPUT] 0    0    [1    /1   ]  36755.2343802        1
[INPUT] 0    0    [1    /1   ]  7331.79708511        1
[INPUT] 0    0    [1    /1   ]  18377.1609891        1
[INPUT] 0    0    [1    /1   ]  1238.97794254        1
[INPUT] 0    0    [1    /1   ]  298.172497846        1
[INPUT] 0    0    [1    /1   ]  89.1696663437        1
[INPUT] 0    0    [1    /1   ]  30.9233315465        1
[INPUT] 0    0    [1    /1   ]  8.30752952045        1
[INPUT] 0    0    [1    /1   ]  3.18634215021        1
[INPUT] 1    0    [1    /1   ]  8.5956002402         1
[INPUT] 1    0    [1    /1   ]  0.492911666502       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39626706534267714, 1.0]], [0, [1176168.1426065029, 1.0]], [0, [588084.071303012, 1.0]], [0, [294042.03565083677, 1.0]], [0, [147021.01782119196, 1.0]], [0, [73510.50796081737, 1.0]], [0, [36755.23438022245, 1.0]], [0, [7331.797085114114, 1.0]], [0, [18377.16098911826, 1.0]], [0, [1238.9779425431118, 1.0]], [0, [298.17249784603007, 1.0]], [0, [89.16966634365279, 1.0]], [0, [30.92333154649574, 1.0]], [0, [8.30752952045085, 1.0]], [0, [3.1863421502113467, 1.0]], [1, [8.595600240196966, 1.0]], [1, [0.49291166650158047, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39626707]
bas 1, expnt(s) = [1176168.1426065]
bas 2, expnt(s) = [588084.07130301]
bas 3, expnt(s) = [294042.03565084]
bas 4, expnt(s) = [147021.01782119]
bas 5, expnt(s) = [73510.50796082]
bas 6, expnt(s) = [36755.23438022]
bas 7, expnt(s) = [7331.79708511]
bas 8, expnt(s) = [18377.16098912]
bas 9, expnt(s) = [1238.97794254]
bas 10, expnt(s) = [298.17249785]
bas 11, expnt(s) = [89.16966634]
bas 12, expnt(s) = [30.92333155]
bas 13, expnt(s) = [8.30752952]
bas 14, expnt(s) = [3.18634215]
bas 15, expnt(s) = [8.59560024]
bas 16, expnt(s) = [0.49291167]
CPU time:       529.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96267065e-01 1.26184499e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552344e+04 6.70663115e+03 7.33179709e+03 2.00180999e+03
 1.83771610e+04 3.98771250e+03 1.23897794e+03 5.27609620e+02
 2.98172498e+02 1.81286603e+02 8.91696663e+01 7.33124748e+01
 3.09233315e+01 3.31306329e+01 8.30752952e+00 1.23628598e+01
 3.18634215e+00 6.02537846e+00 8.59560024e+00 4.29367980e+01
 4.92911667e-01 1.20488546e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325364464792795
cond(S) = 12531.861391330347
E1 = -689.3301211421109  E_coul = 184.86995377387274
init E= -504.460167368238
    CPU time for initialize scf      0.24 sec, wall time      0.03 sec
  HOMO = -0.67476597471836  LUMO = 9.07761791331071
  mo_energy =
[-1.21707109e+02 -1.33903132e+01 -7.63101618e+00 -7.63101618e+00
 -7.63101618e+00 -1.63999585e+00 -6.74765975e-01 -6.74765975e-01
 -6.74765975e-01  9.07761791e+00  8.70832346e+01  4.62234215e+02
  2.22698426e+03  1.14036736e+04  4.09963476e+04  1.09851951e+05
  2.54052697e+05  5.48483413e+05  1.15243178e+06  2.43021493e+06
  5.37495018e+06]
E1 = -706.988610395396  E_coul = 199.06805662255417
cycle= 1 E= -507.920553772842  delta_E= -3.46  |g|= 0.443  |ddm|= 0.361
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592781
diis-c [-0.35138983  1.        ]
  HOMO = -0.233650307747941  LUMO = 9.97774502778525
  mo_energy =
[-1.20259944e+02 -1.23553589e+01 -6.65041507e+00 -6.65041507e+00
 -6.65041507e+00 -1.16183301e+00 -2.33650308e-01 -2.33650308e-01
 -2.33650308e-01  9.97774503e+00  8.83896419e+01  4.63663840e+02
  2.22835874e+03  1.14049224e+04  4.09975241e+04  1.09853089e+05
  2.54053807e+05  5.48484504e+05  1.15243286e+06  2.43021600e+06
  5.37495124e+06]
E1 = -706.6331278997869  E_coul = 198.70614256073867
cycle= 2 E= -507.926985339048  delta_E= -0.00643  |g|= 0.0182  |ddm|= 0.198
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156491
diis-c [-2.39828558e-04  3.78421154e-03  9.96215788e-01]
  HOMO = -0.23815844701469  LUMO = 9.96702960819088
  mo_energy =
[-1.20317795e+02 -1.23779425e+01 -6.67846673e+00 -6.67846673e+00
 -6.67846673e+00 -1.16412944e+00 -2.38158447e-01 -2.38158447e-01
 -2.38158447e-01  9.96702961e+00  8.83495514e+01  4.63605382e+02
  2.22828602e+03  1.14048402e+04  4.09974388e+04  1.09853002e+05
  2.54053720e+05  5.48484416e+05  1.15243277e+06  2.43021591e+06
  5.37495116e+06]
E1 = -706.6182621321717  E_coul = 198.69126439514727
cycle= 3 E= -507.926997737024  delta_E= -1.24e-05  |g|= 0.000872  |ddm|= 0.00901
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000745756
diis-c [-1.51691837e-08  4.70121702e-05 -4.90639624e-02  1.04901695e+00]
  HOMO = -0.238384472649814  LUMO = 9.9665029491017
  mo_energy =
[-1.20320346e+02 -1.23790462e+01 -6.67981255e+00 -6.67981255e+00
 -6.67981255e+00 -1.16423986e+00 -2.38384473e-01 -2.38384473e-01
 -2.38384473e-01  9.96650295e+00  8.83477000e+01  4.63602847e+02
  2.22828307e+03  1.14048370e+04  4.09974355e+04  1.09852999e+05
  2.54053717e+05  5.48484413e+05  1.15243276e+06  2.43021591e+06
  5.37495115e+06]
E1 = -706.6175252181237  E_coul = 198.69052745081981
cycle= 4 E= -507.926997767304  delta_E= -3.03e-08  |g|= 6.57e-06  |ddm|= 0.000472
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.92521e-06
diis-c [-5.47333606e-12 -2.05779609e-06  2.27334369e-03 -4.62487054e-02
  1.04397742e+00]
  HOMO = -0.238385355811995  LUMO = 9.96650187569343
  mo_energy =
[-1.20320345e+02 -1.23790493e+01 -6.67981482e+00 -6.67981482e+00
 -6.67981482e+00 -1.16424036e+00 -2.38385356e-01 -2.38385356e-01
 -2.38385356e-01  9.96650188e+00  8.83476991e+01  4.63602849e+02
  2.22828307e+03  1.14048370e+04  4.09974355e+04  1.09852999e+05
  2.54053717e+05  5.48484413e+05  1.15243276e+06  2.43021591e+06
  5.37495115e+06]
E1 = -706.6175237036723  E_coul = 198.69052593636684
cycle= 5 E= -507.926997767305  delta_E= -1.59e-12  |g|= 1.42e-07  |ddm|= 2.46e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6175237036723  E_coul = 198.69052593636684
  HOMO = -0.238385389456512  LUMO = 9.9665018093201
  mo_energy =
[-1.20320345e+02 -1.23790495e+01 -6.67981499e+00 -6.67981499e+00
 -6.67981499e+00 -1.16424038e+00 -2.38385389e-01 -2.38385389e-01
 -2.38385389e-01  9.96650181e+00  8.83476989e+01  4.63602848e+02
  2.22828307e+03  1.14048370e+04  4.09974355e+04  1.09852999e+05
  2.54053717e+05  5.48484413e+05  1.15243276e+06  2.43021591e+06
  5.37495115e+06]
E1 = -706.61752361159  E_coul = 198.6905258442843
Extra cycle  E= -507.926997767306  delta_E= -1.71e-13  |g|= 7.38e-09  |ddm|= 7.31e-08
    CPU time for scf_cycle      0.50 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12531.861391330347
E1 = -706.61752361159  E_coul = 198.6905258442843
init E= -507.926997767306
    CPU time for initialize scf      5.15 sec, wall time      0.34 sec
  HOMO = -0.238385391063666  LUMO = 9.96650180623185
  mo_energy =
[-1.20320345e+02 -1.23790495e+01 -6.67981500e+00 -6.67981500e+00
 -6.67981500e+00 -1.16424038e+00 -2.38385391e-01 -2.38385391e-01
 -2.38385391e-01  9.96650181e+00  8.83476989e+01  4.63602848e+02
  2.22828307e+03  1.14048370e+04  4.09974355e+04  1.09852999e+05
  2.54053717e+05  5.48484413e+05  1.15243276e+06  2.43021591e+06
  5.37495115e+06]
E1 = -706.6175236073793  E_coul = 198.6905258400738
cycle= 1 E= -507.926997767306  delta_E= 1.14e-13  |g|= 1.45e-09  |ddm|= 3.65e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6175236073793  E_coul = 198.6905258400738
  HOMO = -0.238385391143011  LUMO = 9.96650180699916
  mo_energy =
[-1.20320345e+02 -1.23790495e+01 -6.67981500e+00 -6.67981500e+00
 -6.67981500e+00 -1.16424038e+00 -2.38385391e-01 -2.38385391e-01
 -2.38385391e-01  9.96650181e+00  8.83476989e+01  4.63602848e+02
  2.22828307e+03  1.14048370e+04  4.09974355e+04  1.09852999e+05
  2.54053717e+05  5.48484413e+05  1.15243276e+06  2.43021591e+06
  5.37495115e+06]
E1 = -706.6175236071933  E_coul = 198.6905258398881
Extra cycle  E= -507.926997767305  delta_E= 2.84e-13  |g|= 1.44e-09  |ddm|= 1.92e-10
    CPU time for scf_cycle      5.34 sec, wall time      0.41 sec
exp = [3.96267065e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552344e+04 7.33179709e+03
 1.83771610e+04 1.23897794e+03 2.98172498e+02 8.91696663e+01
 3.09233315e+01 8.30752952e+00 3.18634215e+00 8.59560024e+00
 4.92911667e-01]
grad_E = [-6.49885146e-03 -2.04376498e-11  4.07583503e-10  1.36458523e-09
  8.04732191e-09  2.64158906e-08  1.61560405e-07  8.85191658e-06
  3.96783957e-07  1.35079235e-05 -1.51428205e-04 -9.15618541e-04
 -8.48381932e-04  1.59379158e-03 -4.25508041e-04 -7.30635721e-03
  2.34466039e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396376489522       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017819        1
[INPUT] 0    0    [1    /1   ]  73510.5079525        1
[INPUT] 0    0    [1    /1   ]  36755.2343298        1
[INPUT] 0    0    [1    /1   ]  7331.79431501        1
[INPUT] 0    0    [1    /1   ]  18377.1608643        1
[INPUT] 0    0    [1    /1   ]  1238.97815912        1
[INPUT] 0    0    [1    /1   ]  298.161449211        1
[INPUT] 0    0    [1    /1   ]  89.6522474627        1
[INPUT] 0    0    [1    /1   ]  31.0119708107        1
[INPUT] 0    0    [1    /1   ]  8.34889154626        1
[INPUT] 0    0    [1    /1   ]  3.19073504958        1
[INPUT] 1    0    [1    /1   ]  8.59729026842        1
[INPUT] 1    0    [1    /1   ]  0.493033997622       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3963764895221236, 1.0]], [0, [1176168.1426065087, 1.0]], [0, [588084.0713028845, 1.0]], [0, [294042.0356504088, 1.0]], [0, [147021.0178186777, 1.0]], [0, [73510.5079525377, 1.0]], [0, [36755.23432975414, 1.0]], [0, [7331.794315014776, 1.0]], [0, [18377.16086432163, 1.0]], [0, [1238.9781591192066, 1.0]], [0, [298.1614492110307, 1.0]], [0, [89.65224746270465, 1.0]], [0, [31.011970810664867, 1.0]], [0, [8.34889154625884, 1.0]], [0, [3.190735049577405, 1.0]], [1, [8.597290268424393, 1.0]], [1, [0.49303399762196715, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39637649]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130288]
bas 3, expnt(s) = [294042.03565041]
bas 4, expnt(s) = [147021.01781868]
bas 5, expnt(s) = [73510.50795254]
bas 6, expnt(s) = [36755.23432975]
bas 7, expnt(s) = [7331.79431501]
bas 8, expnt(s) = [18377.16086432]
bas 9, expnt(s) = [1238.97815912]
bas 10, expnt(s) = [298.16144921]
bas 11, expnt(s) = [89.65224746]
bas 12, expnt(s) = [31.01197081]
bas 13, expnt(s) = [8.34889155]
bas 14, expnt(s) = [3.19073505]
bas 15, expnt(s) = [8.59729027]
bas 16, expnt(s) = [0.493034]
CPU time:       537.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96376490e-01 1.26210631e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552343e+04 6.70663114e+03 7.33179432e+03 2.00180942e+03
 1.83771609e+04 3.98771247e+03 1.23897816e+03 5.27609689e+02
 2.98161449e+02 1.81281565e+02 8.96522475e+01 7.36098462e+01
 3.10119708e+01 3.32018321e+01 8.34889155e+00 1.24089958e+01
 3.19073505e+00 6.03160762e+00 8.59729027e+00 4.29473508e+01
 4.93033998e-01 1.20525926e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325176917044494
cond(S) = 12532.37539619415
E1 = -689.3477034225969  E_coul = 184.88137451242153
init E= -504.466328910175
    CPU time for initialize scf      0.16 sec, wall time      0.03 sec
  HOMO = -0.674637959050811  LUMO = 9.13110663087193
  mo_energy =
[-1.21705394e+02 -1.33893610e+01 -7.63025929e+00 -7.63025929e+00
 -7.63025929e+00 -1.63980462e+00 -6.74637959e-01 -6.74637959e-01
 -6.74637959e-01  9.13110663e+00  8.75965967e+01  4.63930346e+02
  2.22919051e+03  1.14056867e+04  4.09982114e+04  1.09853734e+05
  2.54054421e+05  5.48485088e+05  1.15243341e+06  2.43021651e+06
  5.37495172e+06]
E1 = -707.001487781002  E_coul = 199.0805666206364
cycle= 1 E= -507.920921160366  delta_E= -3.45  |g|= 0.443  |ddm|= 0.361
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593088
diis-c [-0.35175381  1.        ]
  HOMO = -0.233385503857128  LUMO = 10.0328487237412
  mo_energy =
[-1.20258242e+02 -1.23543617e+01 -6.64964285e+00 -6.64964285e+00
 -6.64964285e+00 -1.16155873e+00 -2.33385504e-01 -2.33385504e-01
 -2.33385504e-01  1.00328487e+01  8.89038131e+01  4.65359992e+02
  2.23056512e+03  1.14069355e+04  4.09993878e+04  1.09854871e+05
  2.54055532e+05  5.48486178e+05  1.15243448e+06  2.43021758e+06
  5.37495278e+06]
E1 = -706.6473965736734  E_coul = 198.72007096500295
cycle= 2 E= -507.92732560867  delta_E= -0.0064  |g|= 0.0182  |ddm|= 0.197
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156442
diis-c [-2.39650795e-04  3.79114068e-03  9.96208859e-01]
  HOMO = -0.237866156730749  LUMO = 10.0221436879302
  mo_energy =
[-1.20315946e+02 -1.23768334e+01 -6.67757789e+00 -6.67757789e+00
 -6.67757789e+00 -1.16383783e+00 -2.37866157e-01 -2.37866157e-01
 -2.37866157e-01  1.00221437e+01  8.88637745e+01  4.65301654e+02
  2.23049255e+03  1.14068535e+04  4.09993027e+04  1.09854785e+05
  2.54055445e+05  5.48486091e+05  1.15243440e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.6326380063375  E_coul = 198.70530014138976
cycle= 3 E= -507.927337864948  delta_E= -1.23e-05  |g|= 0.000867  |ddm|= 0.00892
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000744505
diis-c [-1.47660228e-08  4.64924538e-05 -4.90124547e-02  1.04896596e+00]
  HOMO = -0.238090040836326  LUMO = 10.0216193250903
  mo_energy =
[-1.20318484e+02 -1.23779282e+01 -6.67891418e+00 -6.67891418e+00
 -6.67891418e+00 -1.16394704e+00 -2.38090041e-01 -2.38090041e-01
 -2.38090041e-01  1.00216193e+01  8.88619309e+01  4.65299131e+02
  2.23048962e+03  1.14068503e+04  4.09992994e+04  1.09854782e+05
  2.54055441e+05  5.48486087e+05  1.15243439e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.6319087576135  E_coul = 198.70457086294985
cycle= 4 E= -507.927337894664  delta_E= -2.97e-08  |g|= 6.42e-06  |ddm|= 0.000465
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.82098e-06
diis-c [-5.38620292e-12 -2.04600230e-06  2.25129419e-03 -4.57987321e-02
  1.04354948e+00]
  HOMO = -0.238090885135186  LUMO = 10.0216183227825
  mo_energy =
[-1.20318483e+02 -1.23779311e+01 -6.67891629e+00 -6.67891629e+00
 -6.67891629e+00 -1.16394752e+00 -2.38090885e-01 -2.38090885e-01
 -2.38090885e-01  1.00216183e+01  8.88619302e+01  4.65299133e+02
  2.23048962e+03  1.14068503e+04  4.09992995e+04  1.09854782e+05
  2.54055441e+05  5.48486087e+05  1.15243439e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.631907348065  E_coul = 198.70456945340018
cycle= 5 E= -507.927337894665  delta_E= -1.25e-12  |g|= 1.41e-07  |ddm|= 2.36e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.631907348065  E_coul = 198.70456945340018
  HOMO = -0.238090918475119  LUMO = 10.0216182564907
  mo_energy =
[-1.20318483e+02 -1.23779313e+01 -6.67891646e+00 -6.67891646e+00
 -6.67891646e+00 -1.16394754e+00 -2.38090918e-01 -2.38090918e-01
 -2.38090918e-01  1.00216183e+01  8.88619300e+01  4.65299133e+02
  2.23048962e+03  1.14068503e+04  4.09992995e+04  1.09854782e+05
  2.54055441e+05  5.48486087e+05  1.15243439e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.6319072571017  E_coul = 198.70456936243664
Extra cycle  E= -507.927337894665  delta_E= -1.71e-13  |g|= 7.34e-09  |ddm|= 7.21e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.96376490e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552343e+04 7.33179432e+03
 1.83771609e+04 1.23897816e+03 2.98161449e+02 8.96522475e+01
 3.10119708e+01 8.34889155e+00 3.19073505e+00 8.59729027e+00
 4.93033998e-01]
E = -507.9273378946651
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396376489522       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017819        1
[INPUT] 0    0    [1    /1   ]  73510.5079525        1
[INPUT] 0    0    [1    /1   ]  36755.2343298        1
[INPUT] 0    0    [1    /1   ]  7331.79431501        1
[INPUT] 0    0    [1    /1   ]  18377.1608643        1
[INPUT] 0    0    [1    /1   ]  1238.97815912        1
[INPUT] 0    0    [1    /1   ]  298.161449211        1
[INPUT] 0    0    [1    /1   ]  89.6522474627        1
[INPUT] 0    0    [1    /1   ]  31.0119708107        1
[INPUT] 0    0    [1    /1   ]  8.34889154626        1
[INPUT] 0    0    [1    /1   ]  3.19073504958        1
[INPUT] 1    0    [1    /1   ]  8.59729026842        1
[INPUT] 1    0    [1    /1   ]  0.493033997622       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3963764895221236, 1.0]], [0, [1176168.1426065087, 1.0]], [0, [588084.0713028845, 1.0]], [0, [294042.0356504088, 1.0]], [0, [147021.0178186777, 1.0]], [0, [73510.5079525377, 1.0]], [0, [36755.23432975414, 1.0]], [0, [7331.794315014776, 1.0]], [0, [18377.16086432163, 1.0]], [0, [1238.9781591192066, 1.0]], [0, [298.1614492110307, 1.0]], [0, [89.65224746270465, 1.0]], [0, [31.011970810664867, 1.0]], [0, [8.34889154625884, 1.0]], [0, [3.190735049577405, 1.0]], [1, [8.597290268424393, 1.0]], [1, [0.49303399762196715, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39637649]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130288]
bas 3, expnt(s) = [294042.03565041]
bas 4, expnt(s) = [147021.01781868]
bas 5, expnt(s) = [73510.50795254]
bas 6, expnt(s) = [36755.23432975]
bas 7, expnt(s) = [7331.79431501]
bas 8, expnt(s) = [18377.16086432]
bas 9, expnt(s) = [1238.97815912]
bas 10, expnt(s) = [298.16144921]
bas 11, expnt(s) = [89.65224746]
bas 12, expnt(s) = [31.01197081]
bas 13, expnt(s) = [8.34889155]
bas 14, expnt(s) = [3.19073505]
bas 15, expnt(s) = [8.59729027]
bas 16, expnt(s) = [0.493034]
CPU time:       538.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96376490e-01 1.26210631e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105080e+04 1.12791687e+04
 3.67552343e+04 6.70663114e+03 7.33179432e+03 2.00180942e+03
 1.83771609e+04 3.98771247e+03 1.23897816e+03 5.27609689e+02
 2.98161449e+02 1.81281565e+02 8.96522475e+01 7.36098462e+01
 3.10119708e+01 3.32018321e+01 8.34889155e+00 1.24089958e+01
 3.19073505e+00 6.03160762e+00 8.59729027e+00 4.29473508e+01
 4.93033998e-01 1.20525926e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325176917044494
cond(S) = 12532.37539619415
E1 = -689.3477034225969  E_coul = 184.88137451242153
init E= -504.466328910175
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674637959050811  LUMO = 9.13110663087193
  mo_energy =
[-1.21705394e+02 -1.33893610e+01 -7.63025929e+00 -7.63025929e+00
 -7.63025929e+00 -1.63980462e+00 -6.74637959e-01 -6.74637959e-01
 -6.74637959e-01  9.13110663e+00  8.75965967e+01  4.63930346e+02
  2.22919051e+03  1.14056867e+04  4.09982114e+04  1.09853734e+05
  2.54054421e+05  5.48485088e+05  1.15243341e+06  2.43021651e+06
  5.37495172e+06]
E1 = -707.001487781002  E_coul = 199.0805666206364
cycle= 1 E= -507.920921160366  delta_E= -3.45  |g|= 0.443  |ddm|= 0.361
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593088
diis-c [-0.35175381  1.        ]
  HOMO = -0.233385503857128  LUMO = 10.0328487237412
  mo_energy =
[-1.20258242e+02 -1.23543617e+01 -6.64964285e+00 -6.64964285e+00
 -6.64964285e+00 -1.16155873e+00 -2.33385504e-01 -2.33385504e-01
 -2.33385504e-01  1.00328487e+01  8.89038131e+01  4.65359992e+02
  2.23056512e+03  1.14069355e+04  4.09993878e+04  1.09854871e+05
  2.54055532e+05  5.48486178e+05  1.15243448e+06  2.43021758e+06
  5.37495278e+06]
E1 = -706.6473965736734  E_coul = 198.72007096500295
cycle= 2 E= -507.92732560867  delta_E= -0.0064  |g|= 0.0182  |ddm|= 0.197
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156442
diis-c [-2.39650795e-04  3.79114068e-03  9.96208859e-01]
  HOMO = -0.237866156730749  LUMO = 10.0221436879302
  mo_energy =
[-1.20315946e+02 -1.23768334e+01 -6.67757789e+00 -6.67757789e+00
 -6.67757789e+00 -1.16383783e+00 -2.37866157e-01 -2.37866157e-01
 -2.37866157e-01  1.00221437e+01  8.88637745e+01  4.65301654e+02
  2.23049255e+03  1.14068535e+04  4.09993027e+04  1.09854785e+05
  2.54055445e+05  5.48486091e+05  1.15243440e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.6326380063375  E_coul = 198.70530014138976
cycle= 3 E= -507.927337864948  delta_E= -1.23e-05  |g|= 0.000867  |ddm|= 0.00892
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000744505
diis-c [-1.47660228e-08  4.64924538e-05 -4.90124547e-02  1.04896596e+00]
  HOMO = -0.238090040836326  LUMO = 10.0216193250903
  mo_energy =
[-1.20318484e+02 -1.23779282e+01 -6.67891418e+00 -6.67891418e+00
 -6.67891418e+00 -1.16394704e+00 -2.38090041e-01 -2.38090041e-01
 -2.38090041e-01  1.00216193e+01  8.88619309e+01  4.65299131e+02
  2.23048962e+03  1.14068503e+04  4.09992994e+04  1.09854782e+05
  2.54055441e+05  5.48486087e+05  1.15243439e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.6319087576135  E_coul = 198.70457086294985
cycle= 4 E= -507.927337894664  delta_E= -2.97e-08  |g|= 6.42e-06  |ddm|= 0.000465
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.82098e-06
diis-c [-5.38620292e-12 -2.04600230e-06  2.25129419e-03 -4.57987321e-02
  1.04354948e+00]
  HOMO = -0.238090885135186  LUMO = 10.0216183227825
  mo_energy =
[-1.20318483e+02 -1.23779311e+01 -6.67891629e+00 -6.67891629e+00
 -6.67891629e+00 -1.16394752e+00 -2.38090885e-01 -2.38090885e-01
 -2.38090885e-01  1.00216183e+01  8.88619302e+01  4.65299133e+02
  2.23048962e+03  1.14068503e+04  4.09992995e+04  1.09854782e+05
  2.54055441e+05  5.48486087e+05  1.15243439e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.631907348065  E_coul = 198.70456945340018
cycle= 5 E= -507.927337894665  delta_E= -1.25e-12  |g|= 1.41e-07  |ddm|= 2.36e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.631907348065  E_coul = 198.70456945340018
  HOMO = -0.238090918475119  LUMO = 10.0216182564907
  mo_energy =
[-1.20318483e+02 -1.23779313e+01 -6.67891646e+00 -6.67891646e+00
 -6.67891646e+00 -1.16394754e+00 -2.38090918e-01 -2.38090918e-01
 -2.38090918e-01  1.00216183e+01  8.88619300e+01  4.65299133e+02
  2.23048962e+03  1.14068503e+04  4.09992995e+04  1.09854782e+05
  2.54055441e+05  5.48486087e+05  1.15243439e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.6319072571017  E_coul = 198.70456936243664
Extra cycle  E= -507.927337894665  delta_E= -1.71e-13  |g|= 7.34e-09  |ddm|= 7.21e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12532.37539619415
E1 = -706.6319072571017  E_coul = 198.70456936243664
init E= -507.927337894665
    CPU time for initialize scf      1.31 sec, wall time      0.08 sec
  HOMO = -0.238090920061579  LUMO = 10.0216182522558
  mo_energy =
[-1.20318483e+02 -1.23779313e+01 -6.67891646e+00 -6.67891646e+00
 -6.67891646e+00 -1.16394754e+00 -2.38090920e-01 -2.38090920e-01
 -2.38090920e-01  1.00216183e+01  8.88619300e+01  4.65299133e+02
  2.23048962e+03  1.14068503e+04  4.09992995e+04  1.09854782e+05
  2.54055441e+05  5.48486087e+05  1.15243439e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.6319072529293  E_coul = 198.70456935826402
cycle= 1 E= -507.927337894665  delta_E= -1.71e-13  |g|= 1.06e-09  |ddm|= 3.62e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6319072529293  E_coul = 198.70456935826402
  HOMO = -0.238090920140151  LUMO = 10.0216182535015
  mo_energy =
[-1.20318483e+02 -1.23779313e+01 -6.67891646e+00 -6.67891646e+00
 -6.67891646e+00 -1.16394754e+00 -2.38090920e-01 -2.38090920e-01
 -2.38090920e-01  1.00216183e+01  8.88619300e+01  4.65299133e+02
  2.23048962e+03  1.14068503e+04  4.09992995e+04  1.09854782e+05
  2.54055441e+05  5.48486087e+05  1.15243439e+06  2.43021749e+06
  5.37495269e+06]
E1 = -706.6319072527328  E_coul = 198.70456935806757
Extra cycle  E= -507.927337894665  delta_E=    0  |g|= 7.76e-10  |ddm|= 1.67e-10
    CPU time for scf_cycle      1.50 sec, wall time      0.15 sec
exp = [3.96376490e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105080e+04 3.67552343e+04 7.33179432e+03
 1.83771609e+04 1.23897816e+03 2.98161449e+02 8.96522475e+01
 3.10119708e+01 8.34889155e+00 3.19073505e+00 8.59729027e+00
 4.93033998e-01]
grad_E = [-5.33185194e-03 -2.15233566e-11  4.00291404e-10  1.33675881e-09
  7.90890083e-09  2.58907506e-08  1.58802656e-07  8.68656787e-06
  3.87752526e-07  2.55218094e-05 -3.08212259e-04 -3.19297820e-04
 -1.46305228e-03  1.90258783e-03 -1.32706486e-03 -6.06427704e-03
  5.12222860e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396665675474       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079451        1
[INPUT] 0    0    [1    /1   ]  36755.2342846        1
[INPUT] 0    0    [1    /1   ]  7331.79183784        1
[INPUT] 0    0    [1    /1   ]  18377.1607527        1
[INPUT] 0    0    [1    /1   ]  1238.97831774        1
[INPUT] 0    0    [1    /1   ]  298.151971213        1
[INPUT] 0    0    [1    /1   ]  90.0875180312        1
[INPUT] 0    0    [1    /1   ]  31.08498496          1
[INPUT] 0    0    [1    /1   ]  8.24274424787        1
[INPUT] 0    0    [1    /1   ]  3.16040545955        1
[INPUT] 1    0    [1    /1   ]  8.6022327367         1
[INPUT] 1    0    [1    /1   ]  0.493218590734       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39666567547427595, 1.0]], [0, [1176168.142606514, 1.0]], [0, [588084.0713027705, 1.0]], [0, [294042.0356500261, 1.0]], [0, [147021.01781642935, 1.0]], [0, [73510.50794513388, 1.0]], [0, [36755.23428462246, 1.0]], [0, [7331.79183784247, 1.0]], [0, [18377.160752732205, 1.0]], [0, [1238.9783177400018, 1.0]], [0, [298.1519712128743, 1.0]], [0, [90.08751803116536, 1.0]], [0, [31.08498496002573, 1.0]], [0, [8.242744247870633, 1.0]], [0, [3.1604054595465327, 1.0]], [1, [8.602232736701954, 1.0]], [1, [0.49321859073424695, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39666568]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130277]
bas 3, expnt(s) = [294042.03565003]
bas 4, expnt(s) = [147021.01781643]
bas 5, expnt(s) = [73510.50794513]
bas 6, expnt(s) = [36755.23428462]
bas 7, expnt(s) = [7331.79183784]
bas 8, expnt(s) = [18377.16075273]
bas 9, expnt(s) = [1238.97831774]
bas 10, expnt(s) = [298.15197121]
bas 11, expnt(s) = [90.08751803]
bas 12, expnt(s) = [31.08498496]
bas 13, expnt(s) = [8.24274425]
bas 14, expnt(s) = [3.16040546]
bas 15, expnt(s) = [8.60223274]
bas 16, expnt(s) = [0.49321859]
CPU time:       543.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96665675e-01 1.26279685e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179184e+03 2.00180891e+03
 1.83771608e+04 3.98771246e+03 1.23897832e+03 5.27609740e+02
 2.98151971e+02 1.81277243e+02 9.00875180e+01 7.38777212e+01
 3.10849850e+01 3.32604423e+01 8.24274425e+00 1.22904814e+01
 3.16040546e+00 5.98855616e+00 8.60223274e+00 4.29782154e+01
 4.93218591e-01 1.20582335e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324906415798775
cond(S) = 12532.587640265121
E1 = -689.3845302784192  E_coul = 184.9121537407179
init E= -504.472376537701
    CPU time for initialize scf      3.38 sec, wall time      0.24 sec
  HOMO = -0.674383424598871  LUMO = 8.95899202187972
  mo_energy =
[-1.21700109e+02 -1.33869770e+01 -7.62812461e+00 -7.62812461e+00
 -7.62812461e+00 -1.63950513e+00 -6.74383425e-01 -6.74383425e-01
 -6.74383425e-01  8.95899202e+00  8.73561863e+01  4.64728802e+02
  2.23054637e+03  1.14069664e+04  4.09994009e+04  1.09854872e+05
  2.54055523e+05  5.48486157e+05  1.15243445e+06  2.43021752e+06
  5.37495270e+06]
E1 = -707.041813056492  E_coul = 199.12070472177118
cycle= 1 E= -507.921108334721  delta_E= -3.45  |g|= 0.444  |ddm|= 0.359
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
diis-norm(errvec)=0.59331
diis-c [-0.35201688  1.        ]
  HOMO = -0.232798173213745  LUMO = 9.85681215855247
  mo_energy =
[-1.20252229e+02 -1.23513296e+01 -6.64681187e+00 -6.64681187e+00
 -6.64681187e+00 -1.16093801e+00 -2.32798173e-01 -2.32798173e-01
 -2.32798173e-01  9.85681216e+00  8.86643973e+01  4.66159242e+02
  2.23192181e+03  1.14082159e+04  4.10005780e+04  1.09856010e+05
  2.54056634e+05  5.48487248e+05  1.15243552e+06  2.43021859e+06
  5.37495376e+06]
E1 = -706.6820102364021  E_coul = 198.7543809023642
cycle= 2 E= -507.927629334038  delta_E= -0.00652  |g|= 0.0184  |ddm|=  0.2
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157096
diis-c [-2.41544878e-04  3.84702115e-03  9.96152979e-01]
  HOMO = -0.237386600455157  LUMO = 9.84602130723068
  mo_energy =
[-1.20310619e+02 -1.23742186e+01 -6.67521621e+00 -6.67521621e+00
 -6.67521621e+00 -1.16327937e+00 -2.37386600e-01 -2.37386600e-01
 -2.37386600e-01  9.84602131e+00  8.86237894e+01  4.66100189e+02
  2.23184847e+03  1.14081331e+04  4.10004920e+04  1.09855923e+05
  2.54056546e+05  5.48487160e+05  1.15243544e+06  2.43021850e+06
  5.37495367e+06]
E1 = -706.6668670710928  E_coul = 198.73922498656654
cycle= 3 E= -507.927642084526  delta_E= -1.28e-05  |g|= 0.000886  |ddm|= 0.00917
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000751934
diis-c [-1.62317296e-08  4.78475072e-05 -4.92459352e-02  1.04919809e+00]
  HOMO = -0.237618573004914  LUMO = 9.84548662706462
  mo_energy =
[-1.20313211e+02 -1.23753461e+01 -6.67658904e+00 -6.67658904e+00
 -6.67658904e+00 -1.16339289e+00 -2.37618573e-01 -2.37618573e-01
 -2.37618573e-01  9.84548663e+00  8.86219016e+01  4.66097612e+02
  2.23184548e+03  1.14081298e+04  4.10004887e+04  1.09855920e+05
  2.54056542e+05  5.48487156e+05  1.15243543e+06  2.43021850e+06
  5.37495366e+06]
E1 = -706.6661103657194  E_coul = 198.73846824949248
cycle= 4 E= -507.927642116227  delta_E= -3.17e-08  |g|= 6.93e-06  |ddm|= 0.000484
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.19266e-06
diis-c [-5.70376009e-12 -2.09320798e-06  2.32659445e-03 -4.72623859e-02
  1.04493788e+00]
  HOMO = -0.237619542594803  LUMO = 9.84548541167637
  mo_energy =
[-1.20313210e+02 -1.23753495e+01 -6.67659165e+00 -6.67659165e+00
 -6.67659165e+00 -1.16339343e+00 -2.37619543e-01 -2.37619543e-01
 -2.37619543e-01  9.84548541e+00  8.86219003e+01  4.66097613e+02
  2.23184548e+03  1.14081298e+04  4.10004887e+04  1.09855920e+05
  2.54056542e+05  5.48487156e+05  1.15243543e+06  2.43021850e+06
  5.37495366e+06]
E1 = -706.6661086257373  E_coul = 198.73846650950819
cycle= 5 E= -507.927642116229  delta_E= -2.16e-12  |g|= 1.44e-07  |ddm|= 2.67e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6661086257373  E_coul = 198.73846650950819
  HOMO = -0.23761957702336  LUMO = 9.84548534474777
  mo_energy =
[-1.20313210e+02 -1.23753497e+01 -6.67659182e+00 -6.67659182e+00
 -6.67659182e+00 -1.16339345e+00 -2.37619577e-01 -2.37619577e-01
 -2.37619577e-01  9.84548534e+00  8.86219001e+01  4.66097613e+02
  2.23184548e+03  1.14081298e+04  4.10004887e+04  1.09855920e+05
  2.54056542e+05  5.48487156e+05  1.15243543e+06  2.43021850e+06
  5.37495366e+06]
E1 = -706.6661085311327  E_coul = 198.73846641490408
Extra cycle  E= -507.927642116229  delta_E= 4.55e-13  |g|= 7.43e-09  |ddm|= 7.48e-08
    CPU time for scf_cycle      3.55 sec, wall time      0.31 sec
exp = [3.96665675e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179184e+03
 1.83771608e+04 1.23897832e+03 2.98151971e+02 9.00875180e+01
 3.10849850e+01 8.24274425e+00 3.16040546e+00 8.60223274e+00
 4.93218591e-01]
E = -507.92764211622864
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396665675474       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079451        1
[INPUT] 0    0    [1    /1   ]  36755.2342846        1
[INPUT] 0    0    [1    /1   ]  7331.79183784        1
[INPUT] 0    0    [1    /1   ]  18377.1607527        1
[INPUT] 0    0    [1    /1   ]  1238.97831774        1
[INPUT] 0    0    [1    /1   ]  298.151971213        1
[INPUT] 0    0    [1    /1   ]  90.0875180312        1
[INPUT] 0    0    [1    /1   ]  31.08498496          1
[INPUT] 0    0    [1    /1   ]  8.24274424787        1
[INPUT] 0    0    [1    /1   ]  3.16040545955        1
[INPUT] 1    0    [1    /1   ]  8.6022327367         1
[INPUT] 1    0    [1    /1   ]  0.493218590734       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39666567547427595, 1.0]], [0, [1176168.142606514, 1.0]], [0, [588084.0713027705, 1.0]], [0, [294042.0356500261, 1.0]], [0, [147021.01781642935, 1.0]], [0, [73510.50794513388, 1.0]], [0, [36755.23428462246, 1.0]], [0, [7331.79183784247, 1.0]], [0, [18377.160752732205, 1.0]], [0, [1238.9783177400018, 1.0]], [0, [298.1519712128743, 1.0]], [0, [90.08751803116536, 1.0]], [0, [31.08498496002573, 1.0]], [0, [8.242744247870633, 1.0]], [0, [3.1604054595465327, 1.0]], [1, [8.602232736701954, 1.0]], [1, [0.49321859073424695, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39666568]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130277]
bas 3, expnt(s) = [294042.03565003]
bas 4, expnt(s) = [147021.01781643]
bas 5, expnt(s) = [73510.50794513]
bas 6, expnt(s) = [36755.23428462]
bas 7, expnt(s) = [7331.79183784]
bas 8, expnt(s) = [18377.16075273]
bas 9, expnt(s) = [1238.97831774]
bas 10, expnt(s) = [298.15197121]
bas 11, expnt(s) = [90.08751803]
bas 12, expnt(s) = [31.08498496]
bas 13, expnt(s) = [8.24274425]
bas 14, expnt(s) = [3.16040546]
bas 15, expnt(s) = [8.60223274]
bas 16, expnt(s) = [0.49321859]
CPU time:       546.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96665675e-01 1.26279685e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179184e+03 2.00180891e+03
 1.83771608e+04 3.98771246e+03 1.23897832e+03 5.27609740e+02
 2.98151971e+02 1.81277243e+02 9.00875180e+01 7.38777212e+01
 3.10849850e+01 3.32604423e+01 8.24274425e+00 1.22904814e+01
 3.16040546e+00 5.98855616e+00 8.60223274e+00 4.29782154e+01
 4.93218591e-01 1.20582335e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324906415798775
cond(S) = 12532.587640265121
E1 = -689.3845302784192  E_coul = 184.9121537407179
init E= -504.472376537701
    CPU time for initialize scf      4.76 sec, wall time      0.33 sec
  HOMO = -0.674383424598871  LUMO = 8.95899202187972
  mo_energy =
[-1.21700109e+02 -1.33869770e+01 -7.62812461e+00 -7.62812461e+00
 -7.62812461e+00 -1.63950513e+00 -6.74383425e-01 -6.74383425e-01
 -6.74383425e-01  8.95899202e+00  8.73561863e+01  4.64728802e+02
  2.23054637e+03  1.14069664e+04  4.09994009e+04  1.09854872e+05
  2.54055523e+05  5.48486157e+05  1.15243445e+06  2.43021752e+06
  5.37495270e+06]
E1 = -707.041813056492  E_coul = 199.12070472177118
cycle= 1 E= -507.921108334721  delta_E= -3.45  |g|= 0.444  |ddm|= 0.359
    CPU time for cycle= 1      0.20 sec, wall time      0.02 sec
diis-norm(errvec)=0.59331
diis-c [-0.35201688  1.        ]
  HOMO = -0.232798173213745  LUMO = 9.85681215855247
  mo_energy =
[-1.20252229e+02 -1.23513296e+01 -6.64681187e+00 -6.64681187e+00
 -6.64681187e+00 -1.16093801e+00 -2.32798173e-01 -2.32798173e-01
 -2.32798173e-01  9.85681216e+00  8.86643973e+01  4.66159242e+02
  2.23192181e+03  1.14082159e+04  4.10005780e+04  1.09856010e+05
  2.54056634e+05  5.48487248e+05  1.15243552e+06  2.43021859e+06
  5.37495376e+06]
E1 = -706.6820102364021  E_coul = 198.7543809023642
cycle= 2 E= -507.927629334038  delta_E= -0.00652  |g|= 0.0184  |ddm|=  0.2
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157096
diis-c [-2.41544878e-04  3.84702115e-03  9.96152979e-01]
  HOMO = -0.237386600455157  LUMO = 9.84602130723068
  mo_energy =
[-1.20310619e+02 -1.23742186e+01 -6.67521621e+00 -6.67521621e+00
 -6.67521621e+00 -1.16327937e+00 -2.37386600e-01 -2.37386600e-01
 -2.37386600e-01  9.84602131e+00  8.86237894e+01  4.66100189e+02
  2.23184847e+03  1.14081331e+04  4.10004920e+04  1.09855923e+05
  2.54056546e+05  5.48487160e+05  1.15243544e+06  2.43021850e+06
  5.37495367e+06]
E1 = -706.6668670710928  E_coul = 198.73922498656654
cycle= 3 E= -507.927642084526  delta_E= -1.28e-05  |g|= 0.000886  |ddm|= 0.00917
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000751934
diis-c [-1.62317296e-08  4.78475072e-05 -4.92459352e-02  1.04919809e+00]
  HOMO = -0.237618573004914  LUMO = 9.84548662706462
  mo_energy =
[-1.20313211e+02 -1.23753461e+01 -6.67658904e+00 -6.67658904e+00
 -6.67658904e+00 -1.16339289e+00 -2.37618573e-01 -2.37618573e-01
 -2.37618573e-01  9.84548663e+00  8.86219016e+01  4.66097612e+02
  2.23184548e+03  1.14081298e+04  4.10004887e+04  1.09855920e+05
  2.54056542e+05  5.48487156e+05  1.15243543e+06  2.43021850e+06
  5.37495366e+06]
E1 = -706.6661103657194  E_coul = 198.73846824949248
cycle= 4 E= -507.927642116227  delta_E= -3.17e-08  |g|= 6.93e-06  |ddm|= 0.000484
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.19266e-06
diis-c [-5.70376009e-12 -2.09320798e-06  2.32659445e-03 -4.72623859e-02
  1.04493788e+00]
  HOMO = -0.237619542594803  LUMO = 9.84548541167637
  mo_energy =
[-1.20313210e+02 -1.23753495e+01 -6.67659165e+00 -6.67659165e+00
 -6.67659165e+00 -1.16339343e+00 -2.37619543e-01 -2.37619543e-01
 -2.37619543e-01  9.84548541e+00  8.86219003e+01  4.66097613e+02
  2.23184548e+03  1.14081298e+04  4.10004887e+04  1.09855920e+05
  2.54056542e+05  5.48487156e+05  1.15243543e+06  2.43021850e+06
  5.37495366e+06]
E1 = -706.6661086257373  E_coul = 198.73846650950819
cycle= 5 E= -507.927642116229  delta_E= -2.16e-12  |g|= 1.44e-07  |ddm|= 2.67e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6661086257373  E_coul = 198.73846650950819
  HOMO = -0.23761957702336  LUMO = 9.84548534474777
  mo_energy =
[-1.20313210e+02 -1.23753497e+01 -6.67659182e+00 -6.67659182e+00
 -6.67659182e+00 -1.16339345e+00 -2.37619577e-01 -2.37619577e-01
 -2.37619577e-01  9.84548534e+00  8.86219001e+01  4.66097613e+02
  2.23184548e+03  1.14081298e+04  4.10004887e+04  1.09855920e+05
  2.54056542e+05  5.48487156e+05  1.15243543e+06  2.43021850e+06
  5.37495366e+06]
E1 = -706.6661085311327  E_coul = 198.73846641490408
Extra cycle  E= -507.927642116229  delta_E= 4.55e-13  |g|= 7.43e-09  |ddm|= 7.48e-08
    CPU time for scf_cycle      5.03 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12532.587640265121
E1 = -706.6661085311327  E_coul = 198.73846641490408
init E= -507.927642116229
    CPU time for initialize scf     10.26 sec, wall time      0.69 sec
  HOMO = -0.237619578680556  LUMO = 9.84548534081195
  mo_energy =
[-1.20313210e+02 -1.23753497e+01 -6.67659183e+00 -6.67659183e+00
 -6.67659183e+00 -1.16339345e+00 -2.37619579e-01 -2.37619579e-01
 -2.37619579e-01  9.84548534e+00  8.86219001e+01  4.66097613e+02
  2.23184548e+03  1.14081298e+04  4.10004887e+04  1.09855920e+05
  2.54056542e+05  5.48487156e+05  1.15243543e+06  2.43021850e+06
  5.37495366e+06]
E1 = -706.6661085267397  E_coul = 198.73846641051122
cycle= 1 E= -507.927642116228  delta_E= 2.27e-13  |g|= 9.78e-10  |ddm|= 3.78e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6661085267397  E_coul = 198.73846641051122
  HOMO = -0.237619578763327  LUMO = 9.84548534168267
  mo_energy =
[-1.20313210e+02 -1.23753497e+01 -6.67659183e+00 -6.67659183e+00
 -6.67659183e+00 -1.16339345e+00 -2.37619579e-01 -2.37619579e-01
 -2.37619579e-01  9.84548534e+00  8.86219001e+01  4.66097613e+02
  2.23184548e+03  1.14081298e+04  4.10004887e+04  1.09855920e+05
  2.54056542e+05  5.48487156e+05  1.15243543e+06  2.43021850e+06
  5.37495366e+06]
E1 = -706.6661085265439  E_coul = 198.73846641031517
Extra cycle  E= -507.927642116229  delta_E= -3.41e-13  |g|= 9.86e-10  |ddm|= 1.79e-10
    CPU time for scf_cycle     10.45 sec, wall time      0.76 sec
exp = [3.96665675e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179184e+03
 1.83771608e+04 1.23897832e+03 2.98151971e+02 9.00875180e+01
 3.10849850e+01 8.24274425e+00 3.16040546e+00 8.60223274e+00
 4.93218591e-01]
grad_E = [-1.50654803e-03 -2.25051753e-11  3.93649583e-10  1.31145136e-09
  7.78280829e-09  2.54131775e-08  1.56289721e-07  8.53529223e-06
  3.79554277e-07  3.66131942e-05 -4.51526837e-04  2.49220033e-04
 -2.13437713e-03  1.60233119e-03 -1.63190903e-03 -2.20785479e-03
  7.07786762e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396897260492       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079422        1
[INPUT] 0    0    [1    /1   ]  36755.2342669        1
[INPUT] 0    0    [1    /1   ]  7331.79086348        1
[INPUT] 0    0    [1    /1   ]  18377.1607089        1
[INPUT] 0    0    [1    /1   ]  1238.97832274        1
[INPUT] 0    0    [1    /1   ]  298.148930798        1
[INPUT] 0    0    [1    /1   ]  90.2617776058        1
[INPUT] 0    0    [1    /1   ]  31.1081068105        1
[INPUT] 0    0    [1    /1   ]  8.04716547404        1
[INPUT] 0    0    [1    /1   ]  3.11175439248        1
[INPUT] 1    0    [1    /1   ]  8.60616792139        1
[INPUT] 1    0    [1    /1   ]  0.493283536835       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39689726049244806, 1.0]], [0, [1176168.1426065161, 1.0]], [0, [588084.0713027257, 1.0]], [0, [294042.0356498756, 1.0]], [0, [147021.01781554497, 1.0]], [0, [73510.50794222207, 1.0]], [0, [36755.234266869804, 1.0]], [0, [7331.79086347572, 1.0]], [0, [18377.160708853575, 1.0]], [0, [1238.9783227382645, 1.0]], [0, [298.14893079778614, 1.0]], [0, [90.26177760579064, 1.0]], [0, [31.108106810492956, 1.0]], [0, [8.047165474042481, 1.0]], [0, [3.1117543924831943, 1.0]], [1, [8.606167921390393, 1.0]], [1, [0.49328353683502174, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39689726]
bas 1, expnt(s) = [1176168.14260652]
bas 2, expnt(s) = [588084.07130273]
bas 3, expnt(s) = [294042.03564988]
bas 4, expnt(s) = [147021.01781554]
bas 5, expnt(s) = [73510.50794222]
bas 6, expnt(s) = [36755.23426687]
bas 7, expnt(s) = [7331.79086348]
bas 8, expnt(s) = [18377.16070885]
bas 9, expnt(s) = [1238.97832274]
bas 10, expnt(s) = [298.1489308]
bas 11, expnt(s) = [90.26177761]
bas 12, expnt(s) = [31.10810681]
bas 13, expnt(s) = [8.04716547]
bas 14, expnt(s) = [3.11175439]
bas 15, expnt(s) = [8.60616792]
bas 16, expnt(s) = [0.49328354]
CPU time:       564.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96897260e-01 1.26334975e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179086e+03 2.00180871e+03
 1.83771607e+04 3.98771245e+03 1.23897832e+03 5.27609741e+02
 2.98148931e+02 1.81275857e+02 9.02617776e+01 7.39848736e+01
 3.11081068e+01 3.32789956e+01 8.04716547e+00 1.20711104e+01
 3.11175439e+00 5.91928169e+00 8.60616792e+00 4.30027929e+01
 4.93283537e-01 1.20602183e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324820556297784
cond(S) = 12532.406829476797
E1 = -689.410917926318  E_coul = 184.93557412582177
init E= -504.475343800496
    CPU time for initialize scf      4.65 sec, wall time      0.33 sec
  HOMO = -0.674233289819614  LUMO = 8.65649644254989
  mo_energy =
[-1.21695955e+02 -1.33851686e+01 -7.62645163e+00 -7.62645163e+00
 -7.62645163e+00 -1.63940017e+00 -6.74233290e-01 -6.74233290e-01
 -6.74233290e-01  8.65649644e+00  8.65055412e+01  4.64273495e+02
  2.23041758e+03  1.14069104e+04  4.09993557e+04  1.09854830e+05
  2.54055482e+05  5.48486117e+05  1.15243441e+06  2.43021749e+06
  5.37495266e+06]
E1 = -707.0761704685034  E_coul = 199.15511222374673
cycle= 1 E= -507.921058244757  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593324
diis-c [-0.35203371  1.        ]
  HOMO = -0.232395413377008  LUMO = 9.54670741186088
  mo_energy =
[-1.20247142e+02 -1.23486965e+01 -6.64421919e+00 -6.64421919e+00
 -6.64421919e+00 -1.16050857e+00 -2.32395413e-01 -2.32395413e-01
 -2.32395413e-01  9.54670741e+00  8.78143516e+01  4.65704936e+02
  2.23179398e+03  1.14081607e+04  4.10005336e+04  1.09855969e+05
  2.54056593e+05  5.48487209e+05  1.15243549e+06  2.43021855e+06
  5.37495372e+06]
E1 = -706.7064884551568  E_coul = 198.77870954832431
cycle= 2 E= -507.927778906832  delta_E= -0.00672  |g|= 0.0187  |ddm|= 0.206
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158044
diis-c [-2.44320681e-04  3.92326433e-03  9.96076736e-01]
  HOMO = -0.23717469811026  LUMO = 9.53578417627215
  mo_energy =
[-1.20306679e+02 -1.23723240e+01 -6.67343729e+00 -6.67343729e+00
 -6.67343729e+00 -1.16296304e+00 -2.37174698e-01 -2.37174698e-01
 -2.37174698e-01  9.53578418e+00  8.77728541e+01  4.65644718e+02
  2.23171936e+03  1.14080765e+04  4.10004462e+04  1.09855880e+05
  2.54056504e+05  5.48487119e+05  1.15243540e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.690645936017  E_coul = 198.76285335501072
cycle= 3 E= -507.927792581006  delta_E= -1.37e-05  |g|= 0.000919  |ddm|= 0.00963
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000764392
diis-c [-1.91393106e-08  5.06066454e-05 -4.96620492e-02  1.04961144e+00]
  HOMO = -0.237421441659521  LUMO = 9.53523154486668
  mo_energy =
[-1.20309366e+02 -1.23735113e+01 -6.67487585e+00 -6.67487585e+00
 -6.67487585e+00 -1.16308455e+00 -2.37421442e-01 -2.37421442e-01
 -2.37421442e-01  9.53523154e+00  8.77708909e+01  4.65642046e+02
  2.23171626e+03  1.14080731e+04  4.10004428e+04  1.09855877e+05
  2.54056501e+05  5.48487116e+05  1.15243539e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.6898380828961  E_coul = 198.76204546632587
cycle= 4 E= -507.92779261657  delta_E= -3.56e-08  |g|= 7.91e-06  |ddm|= 0.00052
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.89096e-06
diis-c [-6.25257750e-12 -2.16666054e-06  2.45218191e-03 -4.96845211e-02
  1.04723451e+00]
  HOMO = -0.237422660015951  LUMO = 9.5352299133779
  mo_energy =
[-1.20309366e+02 -1.23735157e+01 -6.67487946e+00 -6.67487946e+00
 -6.67487946e+00 -1.16308523e+00 -2.37422660e-01 -2.37422660e-01
 -2.37422660e-01  9.53522991e+00  8.77708885e+01  4.65642046e+02
  2.23171627e+03  1.14080731e+04  4.10004428e+04  1.09855877e+05
  2.54056501e+05  5.48487116e+05  1.15243539e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.6898356661821  E_coul = 198.76204304960967
cycle= 5 E= -507.927792616572  delta_E= -2.16e-12  |g|= 1.49e-07  |ddm|= 3.29e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6898356661821  E_coul = 198.76204304960967
  HOMO = -0.237422696179096  LUMO = 9.53522984391078
  mo_energy =
[-1.20309367e+02 -1.23735158e+01 -6.67487964e+00 -6.67487964e+00
 -6.67487964e+00 -1.16308524e+00 -2.37422696e-01 -2.37422696e-01
 -2.37422696e-01  9.53522984e+00  8.77708883e+01  4.65642046e+02
  2.23171627e+03  1.14080731e+04  4.10004428e+04  1.09855877e+05
  2.54056501e+05  5.48487116e+05  1.15243539e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.6898355658307  E_coul = 198.7620429492582
Extra cycle  E= -507.927792616572  delta_E=    0  |g|= 7.93e-09  |ddm|= 7.92e-08
    CPU time for scf_cycle      4.90 sec, wall time      0.40 sec
exp = [3.96897260e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179086e+03
 1.83771607e+04 1.23897832e+03 2.98148931e+02 9.02617776e+01
 3.11081068e+01 8.04716547e+00 3.11175439e+00 8.60616792e+00
 4.93283537e-01]
E = -507.92779261657245
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396897260492       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079422        1
[INPUT] 0    0    [1    /1   ]  36755.2342669        1
[INPUT] 0    0    [1    /1   ]  7331.79086348        1
[INPUT] 0    0    [1    /1   ]  18377.1607089        1
[INPUT] 0    0    [1    /1   ]  1238.97832274        1
[INPUT] 0    0    [1    /1   ]  298.148930798        1
[INPUT] 0    0    [1    /1   ]  90.2617776058        1
[INPUT] 0    0    [1    /1   ]  31.1081068105        1
[INPUT] 0    0    [1    /1   ]  8.04716547404        1
[INPUT] 0    0    [1    /1   ]  3.11175439248        1
[INPUT] 1    0    [1    /1   ]  8.60616792139        1
[INPUT] 1    0    [1    /1   ]  0.493283536835       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39689726049244806, 1.0]], [0, [1176168.1426065161, 1.0]], [0, [588084.0713027257, 1.0]], [0, [294042.0356498756, 1.0]], [0, [147021.01781554497, 1.0]], [0, [73510.50794222207, 1.0]], [0, [36755.234266869804, 1.0]], [0, [7331.79086347572, 1.0]], [0, [18377.160708853575, 1.0]], [0, [1238.9783227382645, 1.0]], [0, [298.14893079778614, 1.0]], [0, [90.26177760579064, 1.0]], [0, [31.108106810492956, 1.0]], [0, [8.047165474042481, 1.0]], [0, [3.1117543924831943, 1.0]], [1, [8.606167921390393, 1.0]], [1, [0.49328353683502174, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39689726]
bas 1, expnt(s) = [1176168.14260652]
bas 2, expnt(s) = [588084.07130273]
bas 3, expnt(s) = [294042.03564988]
bas 4, expnt(s) = [147021.01781554]
bas 5, expnt(s) = [73510.50794222]
bas 6, expnt(s) = [36755.23426687]
bas 7, expnt(s) = [7331.79086348]
bas 8, expnt(s) = [18377.16070885]
bas 9, expnt(s) = [1238.97832274]
bas 10, expnt(s) = [298.1489308]
bas 11, expnt(s) = [90.26177761]
bas 12, expnt(s) = [31.10810681]
bas 13, expnt(s) = [8.04716547]
bas 14, expnt(s) = [3.11175439]
bas 15, expnt(s) = [8.60616792]
bas 16, expnt(s) = [0.49328354]
CPU time:       569.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96897260e-01 1.26334975e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179086e+03 2.00180871e+03
 1.83771607e+04 3.98771245e+03 1.23897832e+03 5.27609741e+02
 2.98148931e+02 1.81275857e+02 9.02617776e+01 7.39848736e+01
 3.11081068e+01 3.32789956e+01 8.04716547e+00 1.20711104e+01
 3.11175439e+00 5.91928169e+00 8.60616792e+00 4.30027929e+01
 4.93283537e-01 1.20602183e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324820556297784
cond(S) = 12532.406829476797
E1 = -689.410917926318  E_coul = 184.93557412582177
init E= -504.475343800496
    CPU time for initialize scf      4.81 sec, wall time      0.34 sec
  HOMO = -0.674233289819614  LUMO = 8.65649644254989
  mo_energy =
[-1.21695955e+02 -1.33851686e+01 -7.62645163e+00 -7.62645163e+00
 -7.62645163e+00 -1.63940017e+00 -6.74233290e-01 -6.74233290e-01
 -6.74233290e-01  8.65649644e+00  8.65055412e+01  4.64273495e+02
  2.23041758e+03  1.14069104e+04  4.09993557e+04  1.09854830e+05
  2.54055482e+05  5.48486117e+05  1.15243441e+06  2.43021749e+06
  5.37495266e+06]
E1 = -707.0761704685034  E_coul = 199.15511222374673
cycle= 1 E= -507.921058244757  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593324
diis-c [-0.35203371  1.        ]
  HOMO = -0.232395413377008  LUMO = 9.54670741186088
  mo_energy =
[-1.20247142e+02 -1.23486965e+01 -6.64421919e+00 -6.64421919e+00
 -6.64421919e+00 -1.16050857e+00 -2.32395413e-01 -2.32395413e-01
 -2.32395413e-01  9.54670741e+00  8.78143516e+01  4.65704936e+02
  2.23179398e+03  1.14081607e+04  4.10005336e+04  1.09855969e+05
  2.54056593e+05  5.48487209e+05  1.15243549e+06  2.43021855e+06
  5.37495372e+06]
E1 = -706.7064884551568  E_coul = 198.77870954832431
cycle= 2 E= -507.927778906832  delta_E= -0.00672  |g|= 0.0187  |ddm|= 0.206
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158044
diis-c [-2.44320681e-04  3.92326433e-03  9.96076736e-01]
  HOMO = -0.23717469811026  LUMO = 9.53578417627215
  mo_energy =
[-1.20306679e+02 -1.23723240e+01 -6.67343729e+00 -6.67343729e+00
 -6.67343729e+00 -1.16296304e+00 -2.37174698e-01 -2.37174698e-01
 -2.37174698e-01  9.53578418e+00  8.77728541e+01  4.65644718e+02
  2.23171936e+03  1.14080765e+04  4.10004462e+04  1.09855880e+05
  2.54056504e+05  5.48487119e+05  1.15243540e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.690645936017  E_coul = 198.76285335501072
cycle= 3 E= -507.927792581006  delta_E= -1.37e-05  |g|= 0.000919  |ddm|= 0.00963
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000764392
diis-c [-1.91393106e-08  5.06066454e-05 -4.96620492e-02  1.04961144e+00]
  HOMO = -0.237421441659521  LUMO = 9.53523154486668
  mo_energy =
[-1.20309366e+02 -1.23735113e+01 -6.67487585e+00 -6.67487585e+00
 -6.67487585e+00 -1.16308455e+00 -2.37421442e-01 -2.37421442e-01
 -2.37421442e-01  9.53523154e+00  8.77708909e+01  4.65642046e+02
  2.23171626e+03  1.14080731e+04  4.10004428e+04  1.09855877e+05
  2.54056501e+05  5.48487116e+05  1.15243539e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.6898380828961  E_coul = 198.76204546632587
cycle= 4 E= -507.92779261657  delta_E= -3.56e-08  |g|= 7.91e-06  |ddm|= 0.00052
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.89096e-06
diis-c [-6.25257750e-12 -2.16666054e-06  2.45218191e-03 -4.96845211e-02
  1.04723451e+00]
  HOMO = -0.237422660015951  LUMO = 9.5352299133779
  mo_energy =
[-1.20309366e+02 -1.23735157e+01 -6.67487946e+00 -6.67487946e+00
 -6.67487946e+00 -1.16308523e+00 -2.37422660e-01 -2.37422660e-01
 -2.37422660e-01  9.53522991e+00  8.77708885e+01  4.65642046e+02
  2.23171627e+03  1.14080731e+04  4.10004428e+04  1.09855877e+05
  2.54056501e+05  5.48487116e+05  1.15243539e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.6898356661821  E_coul = 198.76204304960967
cycle= 5 E= -507.927792616572  delta_E= -2.16e-12  |g|= 1.49e-07  |ddm|= 3.29e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6898356661821  E_coul = 198.76204304960967
  HOMO = -0.237422696179096  LUMO = 9.53522984391078
  mo_energy =
[-1.20309367e+02 -1.23735158e+01 -6.67487964e+00 -6.67487964e+00
 -6.67487964e+00 -1.16308524e+00 -2.37422696e-01 -2.37422696e-01
 -2.37422696e-01  9.53522984e+00  8.77708883e+01  4.65642046e+02
  2.23171627e+03  1.14080731e+04  4.10004428e+04  1.09855877e+05
  2.54056501e+05  5.48487116e+05  1.15243539e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.6898355658307  E_coul = 198.7620429492582
Extra cycle  E= -507.927792616572  delta_E=    0  |g|= 7.93e-09  |ddm|= 7.92e-08
    CPU time for scf_cycle      5.07 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12532.406829476797
E1 = -706.6898355658307  E_coul = 198.7620429492582
init E= -507.927792616572
    CPU time for initialize scf      9.67 sec, wall time      0.69 sec
  HOMO = -0.237422697954619  LUMO = 9.53522984107183
  mo_energy =
[-1.20309367e+02 -1.23735158e+01 -6.67487965e+00 -6.67487965e+00
 -6.67487965e+00 -1.16308525e+00 -2.37422698e-01 -2.37422698e-01
 -2.37422698e-01  9.53522984e+00  8.77708883e+01  4.65642046e+02
  2.23171627e+03  1.14080731e+04  4.10004428e+04  1.09855877e+05
  2.54056501e+05  5.48487116e+05  1.15243539e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.6898355612312  E_coul = 198.76204294465856
cycle= 1 E= -507.927792616573  delta_E= -2.27e-13  |g|= 1.4e-09  |ddm|= 4.07e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6898355612312  E_coul = 198.76204294465856
  HOMO = -0.237422698044219  LUMO = 9.53522984011893
  mo_energy =
[-1.20309367e+02 -1.23735158e+01 -6.67487965e+00 -6.67487965e+00
 -6.67487965e+00 -1.16308525e+00 -2.37422698e-01 -2.37422698e-01
 -2.37422698e-01  9.53522984e+00  8.77708883e+01  4.65642046e+02
  2.23171627e+03  1.14080731e+04  4.10004428e+04  1.09855877e+05
  2.54056501e+05  5.48487116e+05  1.15243539e+06  2.43021846e+06
  5.37495363e+06]
E1 = -706.6898355609865  E_coul = 198.76204294441374
Extra cycle  E= -507.927792616573  delta_E= -5.68e-14  |g|= 6.81e-10  |ddm|= 2.11e-10
    CPU time for scf_cycle      9.88 sec, wall time      0.76 sec
exp = [3.96897260e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179086e+03
 1.83771607e+04 1.23897832e+03 2.98148931e+02 9.02617776e+01
 3.11081068e+01 8.04716547e+00 3.11175439e+00 8.60616792e+00
 4.93283537e-01]
grad_E = [ 2.03845186e-03 -2.29217244e-11  3.90804815e-10  1.30063078e-09
  7.72879149e-09  2.52089910e-08  1.55212807e-07  8.47016974e-06
  3.76056533e-07  4.14466095e-05 -5.14519354e-04  5.29963338e-04
 -2.55079840e-03  5.97214132e-04 -6.01917239e-04  9.31855267e-04
  5.78309938e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396847873073       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079431        1
[INPUT] 0    0    [1    /1   ]  36755.2342723        1
[INPUT] 0    0    [1    /1   ]  7331.79116312        1
[INPUT] 0    0    [1    /1   ]  18377.1607224        1
[INPUT] 0    0    [1    /1   ]  1238.97823997        1
[INPUT] 0    0    [1    /1   ]  298.150871482        1
[INPUT] 0    0    [1    /1   ]  90.2095661672        1
[INPUT] 0    0    [1    /1   ]  31.0976708461        1
[INPUT] 0    0    [1    /1   ]  7.96749657698        1
[INPUT] 0    0    [1    /1   ]  3.09149962718        1
[INPUT] 1    0    [1    /1   ]  8.60595226935        1
[INPUT] 1    0    [1    /1   ]  0.493169021335       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3968478730728762, 1.0]], [0, [1176168.1426065154, 1.0]], [0, [588084.0713027394, 1.0]], [0, [294042.0356499219, 1.0]], [0, [147021.0178158169, 1.0]], [0, [73510.50794311798, 1.0]], [0, [36755.234272328096, 1.0]], [0, [7331.791163123386, 1.0]], [0, [18377.16072236397, 1.0]], [0, [1238.9782399728808, 1.0]], [0, [298.1508714824377, 1.0]], [0, [90.20956616719113, 1.0]], [0, [31.097670846140176, 1.0]], [0, [7.967496576981507, 1.0]], [0, [3.0914996271828303, 1.0]], [1, [8.605952269354928, 1.0]], [1, [0.49316902133454904, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39684787]
bas 1, expnt(s) = [1176168.14260652]
bas 2, expnt(s) = [588084.07130274]
bas 3, expnt(s) = [294042.03564992]
bas 4, expnt(s) = [147021.01781582]
bas 5, expnt(s) = [73510.50794312]
bas 6, expnt(s) = [36755.23427233]
bas 7, expnt(s) = [7331.79116312]
bas 8, expnt(s) = [18377.16072236]
bas 9, expnt(s) = [1238.97823997]
bas 10, expnt(s) = [298.15087148]
bas 11, expnt(s) = [90.20956617]
bas 12, expnt(s) = [31.09767085]
bas 13, expnt(s) = [7.96749658]
bas 14, expnt(s) = [3.09149963]
bas 15, expnt(s) = [8.60595227]
bas 16, expnt(s) = [0.49316902]
CPU time:       587.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96847873e-01 1.26323185e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179116e+03 2.00180878e+03
 1.83771607e+04 3.98771245e+03 1.23897824e+03 5.27609715e+02
 2.98150871e+02 1.81276742e+02 9.02095662e+01 7.39527741e+01
 3.10976708e+01 3.32706221e+01 7.96749658e+00 1.19813689e+01
 3.09149963e+00 5.89036115e+00 8.60595227e+00 4.30014459e+01
 4.93169021e-01 1.20567187e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324995326278223
cond(S) = 12532.21998696008
E1 = -689.4062242855107  E_coul = 184.9316404038199
init E= -504.474583881691
    CPU time for initialize scf      4.44 sec, wall time      0.33 sec
  HOMO = -0.674355619903816  LUMO = 8.53109104884633
  mo_energy =
[-1.21696415e+02 -1.33855017e+01 -7.62667695e+00 -7.62667695e+00
 -7.62667695e+00 -1.63950795e+00 -6.74355620e-01 -6.74355620e-01
 -6.74355620e-01  8.53109105e+00  8.60729225e+01  4.63709496e+02
  2.22985081e+03  1.14064150e+04  4.09988993e+04  1.09854393e+05
  2.54055060e+05  5.48485707e+05  1.15243401e+06  2.43021710e+06
  5.37495229e+06]
E1 = -707.0721171088499  E_coul = 199.1511191584314
cycle= 1 E= -507.920997950418  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593264
diis-c [-0.35196221  1.        ]
  HOMO = -0.232612507656464  LUMO = 9.41782861193168
  mo_energy =
[-1.20247597e+02 -1.23489863e+01 -6.64437377e+00 -6.64437377e+00
 -6.64437377e+00 -1.16065469e+00 -2.32612508e-01 -2.32612508e-01
 -2.32612508e-01  9.41782861e+00  8.73814688e+01  4.65140967e+02
  2.23122720e+03  1.14076652e+04  4.10000772e+04  1.09855532e+05
  2.54056171e+05  5.48486799e+05  1.15243509e+06  2.43021817e+06
  5.37495335e+06]
E1 = -706.6982845545156  E_coul = 198.77048202895517
cycle= 2 E= -507.92780252556  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158404
diis-c [-2.45383405e-04  3.95081451e-03  9.96049185e-01]
  HOMO = -0.237472178600996  LUMO = 9.40685134926205
  mo_energy =
[-1.20307608e+02 -1.23729281e+01 -6.67393477e+00 -6.67393477e+00
 -6.67393477e+00 -1.16315790e+00 -2.37472179e-01 -2.37472179e-01
 -2.37472179e-01  9.40685135e+00  8.73396155e+01  4.65080276e+02
  2.23115205e+03  1.14075805e+04  4.09999893e+04  1.09855443e+05
  2.54056081e+05  5.48486709e+05  1.15243500e+06  2.43021807e+06
  5.37495326e+06]
E1 = -706.682141244259  E_coul = 198.75432463870735
cycle= 3 E= -507.927816605552  delta_E= -1.41e-05  |g|= 0.000934  |ddm|= 0.00984
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000769569
diis-c [-2.04950302e-08  5.18451456e-05 -4.98387132e-02  1.04978687e+00]
  HOMO = -0.237725276366568  LUMO = 9.40629111856026
  mo_energy =
[-1.20310334e+02 -1.23741412e+01 -6.67540149e+00 -6.67540149e+00
 -6.67540149e+00 -1.16328289e+00 -2.37725276e-01 -2.37725276e-01
 -2.37725276e-01  9.40629112e+00  8.73376209e+01  4.65077564e+02
  2.23114891e+03  1.14075771e+04  4.09999858e+04  1.09855440e+05
  2.54056078e+05  5.48486705e+05  1.15243499e+06  2.43021807e+06
  5.37495325e+06]
E1 = -706.6813110334921  E_coul = 198.75349439062362
cycle= 4 E= -507.927816642868  delta_E= -3.73e-08  |g|= 8.35e-06  |ddm|= 0.000537
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.20327e-06
diis-c [-6.48039693e-12 -2.19906388e-06  2.50283830e-03 -5.06498661e-02
  1.04814923e+00]
  HOMO = -0.237726607855466  LUMO = 9.40628930021344
  mo_energy =
[-1.20310335e+02 -1.23741460e+01 -6.67540556e+00 -6.67540556e+00
 -6.67540556e+00 -1.16328363e+00 -2.37726608e-01 -2.37726608e-01
 -2.37726608e-01  9.40628930e+00  8.73376180e+01  4.65077563e+02
  2.23114891e+03  1.14075771e+04  4.09999858e+04  1.09855440e+05
  2.54056078e+05  5.48486705e+05  1.15243499e+06  2.43021807e+06
  5.37495325e+06]
E1 = -706.681308302844  E_coul = 198.753491659973
cycle= 5 E= -507.927816642871  delta_E= -2.44e-12  |g|= 1.51e-07  |ddm|= 3.57e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.681308302844  E_coul = 198.753491659973
  HOMO = -0.237726644671675  LUMO = 9.40628923083401
  mo_energy =
[-1.20310335e+02 -1.23741462e+01 -6.67540574e+00 -6.67540574e+00
 -6.67540574e+00 -1.16328365e+00 -2.37726645e-01 -2.37726645e-01
 -2.37726645e-01  9.40628923e+00  8.73376178e+01  4.65077563e+02
  2.23114891e+03  1.14075771e+04  4.09999858e+04  1.09855440e+05
  2.54056078e+05  5.48486705e+05  1.15243499e+06  2.43021807e+06
  5.37495325e+06]
E1 = -706.6813082002462  E_coul = 198.7534915573751
Extra cycle  E= -507.927816642871  delta_E= -1.71e-13  |g|= 8.01e-09  |ddm|= 8.1e-08
    CPU time for scf_cycle      4.71 sec, wall time      0.40 sec
exp = [3.96847873e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179116e+03
 1.83771607e+04 1.23897824e+03 2.98150871e+02 9.02095662e+01
 3.10976708e+01 7.96749658e+00 3.09149963e+00 8.60595227e+00
 4.93169021e-01]
E = -507.9278166428711
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396847873073       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079431        1
[INPUT] 0    0    [1    /1   ]  36755.2342723        1
[INPUT] 0    0    [1    /1   ]  7331.79116312        1
[INPUT] 0    0    [1    /1   ]  18377.1607224        1
[INPUT] 0    0    [1    /1   ]  1238.97823997        1
[INPUT] 0    0    [1    /1   ]  298.150871482        1
[INPUT] 0    0    [1    /1   ]  90.2095661672        1
[INPUT] 0    0    [1    /1   ]  31.0976708461        1
[INPUT] 0    0    [1    /1   ]  7.96749657698        1
[INPUT] 0    0    [1    /1   ]  3.09149962718        1
[INPUT] 1    0    [1    /1   ]  8.60595226935        1
[INPUT] 1    0    [1    /1   ]  0.493169021335       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3968478730728762, 1.0]], [0, [1176168.1426065154, 1.0]], [0, [588084.0713027394, 1.0]], [0, [294042.0356499219, 1.0]], [0, [147021.0178158169, 1.0]], [0, [73510.50794311798, 1.0]], [0, [36755.234272328096, 1.0]], [0, [7331.791163123386, 1.0]], [0, [18377.16072236397, 1.0]], [0, [1238.9782399728808, 1.0]], [0, [298.1508714824377, 1.0]], [0, [90.20956616719113, 1.0]], [0, [31.097670846140176, 1.0]], [0, [7.967496576981507, 1.0]], [0, [3.0914996271828303, 1.0]], [1, [8.605952269354928, 1.0]], [1, [0.49316902133454904, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39684787]
bas 1, expnt(s) = [1176168.14260652]
bas 2, expnt(s) = [588084.07130274]
bas 3, expnt(s) = [294042.03564992]
bas 4, expnt(s) = [147021.01781582]
bas 5, expnt(s) = [73510.50794312]
bas 6, expnt(s) = [36755.23427233]
bas 7, expnt(s) = [7331.79116312]
bas 8, expnt(s) = [18377.16072236]
bas 9, expnt(s) = [1238.97823997]
bas 10, expnt(s) = [298.15087148]
bas 11, expnt(s) = [90.20956617]
bas 12, expnt(s) = [31.09767085]
bas 13, expnt(s) = [7.96749658]
bas 14, expnt(s) = [3.09149963]
bas 15, expnt(s) = [8.60595227]
bas 16, expnt(s) = [0.49316902]
CPU time:       592.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96847873e-01 1.26323185e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179116e+03 2.00180878e+03
 1.83771607e+04 3.98771245e+03 1.23897824e+03 5.27609715e+02
 2.98150871e+02 1.81276742e+02 9.02095662e+01 7.39527741e+01
 3.10976708e+01 3.32706221e+01 7.96749658e+00 1.19813689e+01
 3.09149963e+00 5.89036115e+00 8.60595227e+00 4.30014459e+01
 4.93169021e-01 1.20567187e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324995326278223
cond(S) = 12532.21998696008
E1 = -689.4062242855107  E_coul = 184.9316404038199
init E= -504.474583881691
    CPU time for initialize scf      4.52 sec, wall time      0.34 sec
  HOMO = -0.674355619903816  LUMO = 8.53109104884633
  mo_energy =
[-1.21696415e+02 -1.33855017e+01 -7.62667695e+00 -7.62667695e+00
 -7.62667695e+00 -1.63950795e+00 -6.74355620e-01 -6.74355620e-01
 -6.74355620e-01  8.53109105e+00  8.60729225e+01  4.63709496e+02
  2.22985081e+03  1.14064150e+04  4.09988993e+04  1.09854393e+05
  2.54055060e+05  5.48485707e+05  1.15243401e+06  2.43021710e+06
  5.37495229e+06]
E1 = -707.0721171088499  E_coul = 199.1511191584314
cycle= 1 E= -507.920997950418  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593264
diis-c [-0.35196221  1.        ]
  HOMO = -0.232612507656464  LUMO = 9.41782861193168
  mo_energy =
[-1.20247597e+02 -1.23489863e+01 -6.64437377e+00 -6.64437377e+00
 -6.64437377e+00 -1.16065469e+00 -2.32612508e-01 -2.32612508e-01
 -2.32612508e-01  9.41782861e+00  8.73814688e+01  4.65140967e+02
  2.23122720e+03  1.14076652e+04  4.10000772e+04  1.09855532e+05
  2.54056171e+05  5.48486799e+05  1.15243509e+06  2.43021817e+06
  5.37495335e+06]
E1 = -706.6982845545156  E_coul = 198.77048202895517
cycle= 2 E= -507.92780252556  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158404
diis-c [-2.45383405e-04  3.95081451e-03  9.96049185e-01]
  HOMO = -0.237472178600996  LUMO = 9.40685134926205
  mo_energy =
[-1.20307608e+02 -1.23729281e+01 -6.67393477e+00 -6.67393477e+00
 -6.67393477e+00 -1.16315790e+00 -2.37472179e-01 -2.37472179e-01
 -2.37472179e-01  9.40685135e+00  8.73396155e+01  4.65080276e+02
  2.23115205e+03  1.14075805e+04  4.09999893e+04  1.09855443e+05
  2.54056081e+05  5.48486709e+05  1.15243500e+06  2.43021807e+06
  5.37495326e+06]
E1 = -706.682141244259  E_coul = 198.75432463870735
cycle= 3 E= -507.927816605552  delta_E= -1.41e-05  |g|= 0.000934  |ddm|= 0.00984
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000769569
diis-c [-2.04950302e-08  5.18451456e-05 -4.98387132e-02  1.04978687e+00]
  HOMO = -0.237725276366568  LUMO = 9.40629111856026
  mo_energy =
[-1.20310334e+02 -1.23741412e+01 -6.67540149e+00 -6.67540149e+00
 -6.67540149e+00 -1.16328289e+00 -2.37725276e-01 -2.37725276e-01
 -2.37725276e-01  9.40629112e+00  8.73376209e+01  4.65077564e+02
  2.23114891e+03  1.14075771e+04  4.09999858e+04  1.09855440e+05
  2.54056078e+05  5.48486705e+05  1.15243499e+06  2.43021807e+06
  5.37495325e+06]
E1 = -706.6813110334921  E_coul = 198.75349439062362
cycle= 4 E= -507.927816642868  delta_E= -3.73e-08  |g|= 8.35e-06  |ddm|= 0.000537
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.20327e-06
diis-c [-6.48039693e-12 -2.19906388e-06  2.50283830e-03 -5.06498661e-02
  1.04814923e+00]
  HOMO = -0.237726607855466  LUMO = 9.40628930021344
  mo_energy =
[-1.20310335e+02 -1.23741460e+01 -6.67540556e+00 -6.67540556e+00
 -6.67540556e+00 -1.16328363e+00 -2.37726608e-01 -2.37726608e-01
 -2.37726608e-01  9.40628930e+00  8.73376180e+01  4.65077563e+02
  2.23114891e+03  1.14075771e+04  4.09999858e+04  1.09855440e+05
  2.54056078e+05  5.48486705e+05  1.15243499e+06  2.43021807e+06
  5.37495325e+06]
E1 = -706.681308302844  E_coul = 198.753491659973
cycle= 5 E= -507.927816642871  delta_E= -2.44e-12  |g|= 1.51e-07  |ddm|= 3.57e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.681308302844  E_coul = 198.753491659973
  HOMO = -0.237726644671675  LUMO = 9.40628923083401
  mo_energy =
[-1.20310335e+02 -1.23741462e+01 -6.67540574e+00 -6.67540574e+00
 -6.67540574e+00 -1.16328365e+00 -2.37726645e-01 -2.37726645e-01
 -2.37726645e-01  9.40628923e+00  8.73376178e+01  4.65077563e+02
  2.23114891e+03  1.14075771e+04  4.09999858e+04  1.09855440e+05
  2.54056078e+05  5.48486705e+05  1.15243499e+06  2.43021807e+06
  5.37495325e+06]
E1 = -706.6813082002462  E_coul = 198.7534915573751
Extra cycle  E= -507.927816642871  delta_E= -1.71e-13  |g|= 8.01e-09  |ddm|= 8.1e-08
    CPU time for scf_cycle      4.79 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12532.21998696008
E1 = -706.6813082002462  E_coul = 198.7534915573751
init E= -507.927816642871
    CPU time for initialize scf      9.56 sec, wall time      0.71 sec
  HOMO = -0.237726646495486  LUMO = 9.40628922629128
  mo_energy =
[-1.20310336e+02 -1.23741462e+01 -6.67540575e+00 -6.67540575e+00
 -6.67540575e+00 -1.16328365e+00 -2.37726646e-01 -2.37726646e-01
 -2.37726646e-01  9.40628923e+00  8.73376178e+01  4.65077563e+02
  2.23114891e+03  1.14075771e+04  4.09999858e+04  1.09855440e+05
  2.54056078e+05  5.48486705e+05  1.15243499e+06  2.43021807e+06
  5.37495325e+06]
E1 = -706.6813081953603  E_coul = 198.753491552489
cycle= 1 E= -507.927816642871  delta_E= -2.27e-13  |g|= 9.42e-10  |ddm|= 4.22e-09
    CPU time for cycle= 1      0.03 sec, wall time      0.01 sec
E1 = -706.6813081953603  E_coul = 198.753491552489
  HOMO = -0.237726646589305  LUMO = 9.40628922766711
  mo_energy =
[-1.20310336e+02 -1.23741462e+01 -6.67540575e+00 -6.67540575e+00
 -6.67540575e+00 -1.16328365e+00 -2.37726647e-01 -2.37726647e-01
 -2.37726647e-01  9.40628923e+00  8.73376178e+01  4.65077563e+02
  2.23114891e+03  1.14075771e+04  4.09999858e+04  1.09855440e+05
  2.54056078e+05  5.48486705e+05  1.15243499e+06  2.43021807e+06
  5.37495325e+06]
E1 = -706.6813081951095  E_coul = 198.75349155223793
Extra cycle  E= -507.927816642872  delta_E= -2.27e-13  |g|= 1.03e-09  |ddm|= 2.17e-10
    CPU time for scf_cycle      9.65 sec, wall time      0.78 sec
exp = [3.96847873e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179116e+03
 1.83771607e+04 1.23897824e+03 2.98150871e+02 9.02095662e+01
 3.10976708e+01 7.96749658e+00 3.09149963e+00 8.60595227e+00
 4.93169021e-01]
grad_E = [ 1.26830339e-03 -2.28171992e-11  3.91504503e-10  1.30330030e-09
  7.74207108e-09  2.52593620e-08  1.55477399e-07  8.48606080e-06
  3.76922425e-07  4.02937443e-05 -5.00416932e-04  4.90138918e-04
 -2.53863247e-03  1.64582155e-04 -2.14996059e-04  8.29136021e-04
  1.55518584e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396768324683       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.507944         1
[INPUT] 0    0    [1    /1   ]  36755.2342774        1
[INPUT] 0    0    [1    /1   ]  7331.79144383        1
[INPUT] 0    0    [1    /1   ]  18377.160735         1
[INPUT] 0    0    [1    /1   ]  1238.97815109        1
[INPUT] 0    0    [1    /1   ]  298.152858847        1
[INPUT] 0    0    [1    /1   ]  90.1580141992        1
[INPUT] 0    0    [1    /1   ]  31.091581591         1
[INPUT] 0    0    [1    /1   ]  7.94798679619        1
[INPUT] 0    0    [1    /1   ]  3.0870325567         1
[INPUT] 1    0    [1    /1   ]  8.60519088547        1
[INPUT] 1    0    [1    /1   ]  0.493077265745       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39676832468275497, 1.0]], [0, [1176168.1426065147, 1.0]], [0, [588084.0713027524, 1.0]], [0, [294042.0356499653, 1.0]], [0, [147021.0178160716, 1.0]], [0, [73510.50794395717, 1.0]], [0, [36755.234277440824, 1.0]], [0, [7331.791443825218, 1.0]], [0, [18377.160735019377, 1.0]], [0, [1238.9781510874486, 1.0]], [0, [298.15285884735147, 1.0]], [0, [90.15801419918597, 1.0]], [0, [31.091581590981242, 1.0]], [0, [7.947986796190506, 1.0]], [0, [3.0870325566964225, 1.0]], [1, [8.6051908854693, 1.0]], [1, [0.4930772657454827, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39676832]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130275]
bas 3, expnt(s) = [294042.03564997]
bas 4, expnt(s) = [147021.01781607]
bas 5, expnt(s) = [73510.50794396]
bas 6, expnt(s) = [36755.23427744]
bas 7, expnt(s) = [7331.79144383]
bas 8, expnt(s) = [18377.16073502]
bas 9, expnt(s) = [1238.97815109]
bas 10, expnt(s) = [298.15285885]
bas 11, expnt(s) = [90.1580142]
bas 12, expnt(s) = [31.09158159]
bas 13, expnt(s) = [7.9479868]
bas 14, expnt(s) = [3.08703256]
bas 15, expnt(s) = [8.60519089]
bas 16, expnt(s) = [0.49307727]
CPU time:       609.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96768325e-01 1.26304193e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179144e+03 2.00180883e+03
 1.83771607e+04 3.98771245e+03 1.23897815e+03 5.27609686e+02
 2.98152859e+02 1.81277648e+02 9.01580142e+01 7.39210756e+01
 3.10915816e+01 3.32657359e+01 7.94798680e+00 1.19593583e+01
 3.08703256e+00 5.88397653e+00 8.60519089e+00 4.29966904e+01
 4.93077266e-01 1.20539148e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325132670373918
cond(S) = 12532.142419347285
E1 = -689.3987068454875  E_coul = 184.92506185417434
init E= -504.473644991313
    CPU time for initialize scf      4.24 sec, wall time      0.34 sec
  HOMO = -0.674470307652767  LUMO = 8.50104596383071
  mo_energy =
[-1.21697399e+02 -1.33860357e+01 -7.62710894e+00 -7.62710894e+00
 -7.62710894e+00 -1.63960279e+00 -6.74470308e-01 -6.74470308e-01
 -6.74470308e-01  8.50104596e+00  8.59475702e+01  4.63464680e+02
  2.22956330e+03  1.14061567e+04  4.09986606e+04  1.09854165e+05
  2.54054839e+05  5.48485493e+05  1.15243380e+06  2.43021690e+06
  5.37495209e+06]
E1 = -707.063535007726  E_coul = 199.14254528581768
cycle= 1 E= -507.920989721908  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593219
diis-c [-0.35190886  1.        ]
  HOMO = -0.232839293657881  LUMO = 9.38684494519817
  mo_energy =
[-1.20248736e+02 -1.23496382e+01 -6.64491996e+00 -6.64491996e+00
 -6.64491996e+00 -1.16083702e+00 -2.32839294e-01 -2.32839294e-01
 -2.32839294e-01  9.38684495e+00  8.72558654e+01  4.64896005e+02
  2.23093952e+03  1.14074068e+04  4.09998383e+04  1.09855304e+05
  2.54055950e+05  5.48486584e+05  1.15243488e+06  2.43021796e+06
  5.37495315e+06]
E1 = -706.6887409993388  E_coul = 198.76092731321285
cycle= 2 E= -507.927813686126  delta_E= -0.00682  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.08 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158467
diis-c [-2.45570030e-04  3.95645825e-03  9.96043542e-01]
  HOMO = -0.237717387515054  LUMO = 9.37585566990461
  mo_energy =
[-1.20308853e+02 -1.23736546e+01 -6.67456087e+00 -6.67456087e+00
 -6.67456087e+00 -1.16335181e+00 -2.37717388e-01 -2.37717388e-01
 -2.37717388e-01  9.37585567e+00  8.72139351e+01  4.64835209e+02
  2.23086426e+03  1.14073220e+04  4.09997502e+04  1.09855214e+05
  2.54055860e+05  5.48486494e+05  1.15243479e+06  2.43021787e+06
  5.37495306e+06]
E1 = -706.6725262901149  E_coul = 198.7446984262475
cycle= 3 E= -507.927827863867  delta_E= -1.42e-05  |g|= 0.000937  |ddm|= 0.00989
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000770712
diis-c [-2.08263698e-08  5.21486558e-05 -4.98813451e-02  1.04982920e+00]
  HOMO = -0.237971976465631  LUMO = 9.37529365388344
  mo_energy =
[-1.20311589e+02 -1.23748738e+01 -6.67603427e+00 -6.67603427e+00
 -6.67603427e+00 -1.16347764e+00 -2.37971976e-01 -2.37971976e-01
 -2.37971976e-01  9.37529365e+00  8.72119333e+01  4.64832488e+02
  2.23086111e+03  1.14073186e+04  4.09997467e+04  1.09855211e+05
  2.54055857e+05  5.48486490e+05  1.15243478e+06  2.43021787e+06
  5.37495305e+06]
E1 = -706.6716907145869  E_coul = 198.74386281297376
cycle= 4 E= -507.927827901613  delta_E= -3.77e-08  |g|= 8.46e-06  |ddm|= 0.00054
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.27799e-06
diis-c [-6.53202659e-12 -2.20316580e-06  2.51453301e-03 -5.08732659e-02
  1.04836094e+00]
  HOMO = -0.237973335563313  LUMO = 9.37529179213861
  mo_energy =
[-1.20311590e+02 -1.23748788e+01 -6.67603845e+00 -6.67603845e+00
 -6.67603845e+00 -1.16347839e+00 -2.37973336e-01 -2.37973336e-01
 -2.37973336e-01  9.37529179e+00  8.72119303e+01  4.64832487e+02
  2.23086111e+03  1.14073186e+04  4.09997467e+04  1.09855211e+05
  2.54055857e+05  5.48486490e+05  1.15243478e+06  2.43021787e+06
  5.37495305e+06]
E1 = -706.6716879064514  E_coul = 198.74386000483545
cycle= 5 E= -507.927827901616  delta_E= -2.79e-12  |g|= 1.51e-07  |ddm|= 3.64e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6716879064514  E_coul = 198.74386000483545
  HOMO = -0.237973372521677  LUMO = 9.37529172365832
  mo_energy =
[-1.20311591e+02 -1.23748789e+01 -6.67603863e+00 -6.67603863e+00
 -6.67603863e+00 -1.16347841e+00 -2.37973373e-01 -2.37973373e-01
 -2.37973373e-01  9.37529172e+00  8.72119301e+01  4.64832487e+02
  2.23086111e+03  1.14073186e+04  4.09997467e+04  1.09855211e+05
  2.54055857e+05  5.48486490e+05  1.15243478e+06  2.43021787e+06
  5.37495305e+06]
E1 = -706.6716878034568  E_coul = 198.74385990184106
Extra cycle  E= -507.927827901616  delta_E= 1.71e-13  |g|= 8.06e-09  |ddm|= 8.14e-08
    CPU time for scf_cycle      4.50 sec, wall time      0.41 sec
exp = [3.96768325e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179144e+03
 1.83771607e+04 1.23897815e+03 2.98152859e+02 9.01580142e+01
 3.10915816e+01 7.94798680e+00 3.08703256e+00 8.60519089e+00
 4.93077266e-01]
E = -507.9278279016158
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396768324683       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.507944         1
[INPUT] 0    0    [1    /1   ]  36755.2342774        1
[INPUT] 0    0    [1    /1   ]  7331.79144383        1
[INPUT] 0    0    [1    /1   ]  18377.160735         1
[INPUT] 0    0    [1    /1   ]  1238.97815109        1
[INPUT] 0    0    [1    /1   ]  298.152858847        1
[INPUT] 0    0    [1    /1   ]  90.1580141992        1
[INPUT] 0    0    [1    /1   ]  31.091581591         1
[INPUT] 0    0    [1    /1   ]  7.94798679619        1
[INPUT] 0    0    [1    /1   ]  3.0870325567         1
[INPUT] 1    0    [1    /1   ]  8.60519088547        1
[INPUT] 1    0    [1    /1   ]  0.493077265745       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39676832468275497, 1.0]], [0, [1176168.1426065147, 1.0]], [0, [588084.0713027524, 1.0]], [0, [294042.0356499653, 1.0]], [0, [147021.0178160716, 1.0]], [0, [73510.50794395717, 1.0]], [0, [36755.234277440824, 1.0]], [0, [7331.791443825218, 1.0]], [0, [18377.160735019377, 1.0]], [0, [1238.9781510874486, 1.0]], [0, [298.15285884735147, 1.0]], [0, [90.15801419918597, 1.0]], [0, [31.091581590981242, 1.0]], [0, [7.947986796190506, 1.0]], [0, [3.0870325566964225, 1.0]], [1, [8.6051908854693, 1.0]], [1, [0.4930772657454827, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39676832]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130275]
bas 3, expnt(s) = [294042.03564997]
bas 4, expnt(s) = [147021.01781607]
bas 5, expnt(s) = [73510.50794396]
bas 6, expnt(s) = [36755.23427744]
bas 7, expnt(s) = [7331.79144383]
bas 8, expnt(s) = [18377.16073502]
bas 9, expnt(s) = [1238.97815109]
bas 10, expnt(s) = [298.15285885]
bas 11, expnt(s) = [90.1580142]
bas 12, expnt(s) = [31.09158159]
bas 13, expnt(s) = [7.9479868]
bas 14, expnt(s) = [3.08703256]
bas 15, expnt(s) = [8.60519089]
bas 16, expnt(s) = [0.49307727]
CPU time:       614.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96768325e-01 1.26304193e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179144e+03 2.00180883e+03
 1.83771607e+04 3.98771245e+03 1.23897815e+03 5.27609686e+02
 2.98152859e+02 1.81277648e+02 9.01580142e+01 7.39210756e+01
 3.10915816e+01 3.32657359e+01 7.94798680e+00 1.19593583e+01
 3.08703256e+00 5.88397653e+00 8.60519089e+00 4.29966904e+01
 4.93077266e-01 1.20539148e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325132670373918
cond(S) = 12532.142419347285
E1 = -689.3987068454875  E_coul = 184.92506185417434
init E= -504.473644991313
    CPU time for initialize scf      4.13 sec, wall time      0.33 sec
  HOMO = -0.674470307652767  LUMO = 8.50104596383071
  mo_energy =
[-1.21697399e+02 -1.33860357e+01 -7.62710894e+00 -7.62710894e+00
 -7.62710894e+00 -1.63960279e+00 -6.74470308e-01 -6.74470308e-01
 -6.74470308e-01  8.50104596e+00  8.59475702e+01  4.63464680e+02
  2.22956330e+03  1.14061567e+04  4.09986606e+04  1.09854165e+05
  2.54054839e+05  5.48485493e+05  1.15243380e+06  2.43021690e+06
  5.37495209e+06]
E1 = -707.063535007726  E_coul = 199.14254528581768
cycle= 1 E= -507.920989721908  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593219
diis-c [-0.35190886  1.        ]
  HOMO = -0.232839293657881  LUMO = 9.38684494519817
  mo_energy =
[-1.20248736e+02 -1.23496382e+01 -6.64491996e+00 -6.64491996e+00
 -6.64491996e+00 -1.16083702e+00 -2.32839294e-01 -2.32839294e-01
 -2.32839294e-01  9.38684495e+00  8.72558654e+01  4.64896005e+02
  2.23093952e+03  1.14074068e+04  4.09998383e+04  1.09855304e+05
  2.54055950e+05  5.48486584e+05  1.15243488e+06  2.43021796e+06
  5.37495315e+06]
E1 = -706.6887409993388  E_coul = 198.76092731321285
cycle= 2 E= -507.927813686126  delta_E= -0.00682  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.09 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158467
diis-c [-2.45570030e-04  3.95645825e-03  9.96043542e-01]
  HOMO = -0.237717387515054  LUMO = 9.37585566990461
  mo_energy =
[-1.20308853e+02 -1.23736546e+01 -6.67456087e+00 -6.67456087e+00
 -6.67456087e+00 -1.16335181e+00 -2.37717388e-01 -2.37717388e-01
 -2.37717388e-01  9.37585567e+00  8.72139351e+01  4.64835209e+02
  2.23086426e+03  1.14073220e+04  4.09997502e+04  1.09855214e+05
  2.54055860e+05  5.48486494e+05  1.15243479e+06  2.43021787e+06
  5.37495306e+06]
E1 = -706.6725262901149  E_coul = 198.7446984262475
cycle= 3 E= -507.927827863867  delta_E= -1.42e-05  |g|= 0.000937  |ddm|= 0.00989
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000770712
diis-c [-2.08263698e-08  5.21486558e-05 -4.98813451e-02  1.04982920e+00]
  HOMO = -0.237971976465631  LUMO = 9.37529365388344
  mo_energy =
[-1.20311589e+02 -1.23748738e+01 -6.67603427e+00 -6.67603427e+00
 -6.67603427e+00 -1.16347764e+00 -2.37971976e-01 -2.37971976e-01
 -2.37971976e-01  9.37529365e+00  8.72119333e+01  4.64832488e+02
  2.23086111e+03  1.14073186e+04  4.09997467e+04  1.09855211e+05
  2.54055857e+05  5.48486490e+05  1.15243478e+06  2.43021787e+06
  5.37495305e+06]
E1 = -706.6716907145869  E_coul = 198.74386281297376
cycle= 4 E= -507.927827901613  delta_E= -3.77e-08  |g|= 8.46e-06  |ddm|= 0.00054
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.27799e-06
diis-c [-6.53202659e-12 -2.20316580e-06  2.51453301e-03 -5.08732659e-02
  1.04836094e+00]
  HOMO = -0.237973335563313  LUMO = 9.37529179213861
  mo_energy =
[-1.20311590e+02 -1.23748788e+01 -6.67603845e+00 -6.67603845e+00
 -6.67603845e+00 -1.16347839e+00 -2.37973336e-01 -2.37973336e-01
 -2.37973336e-01  9.37529179e+00  8.72119303e+01  4.64832487e+02
  2.23086111e+03  1.14073186e+04  4.09997467e+04  1.09855211e+05
  2.54055857e+05  5.48486490e+05  1.15243478e+06  2.43021787e+06
  5.37495305e+06]
E1 = -706.6716879064514  E_coul = 198.74386000483545
cycle= 5 E= -507.927827901616  delta_E= -2.79e-12  |g|= 1.51e-07  |ddm|= 3.64e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6716879064514  E_coul = 198.74386000483545
  HOMO = -0.237973372521677  LUMO = 9.37529172365832
  mo_energy =
[-1.20311591e+02 -1.23748789e+01 -6.67603863e+00 -6.67603863e+00
 -6.67603863e+00 -1.16347841e+00 -2.37973373e-01 -2.37973373e-01
 -2.37973373e-01  9.37529172e+00  8.72119301e+01  4.64832487e+02
  2.23086111e+03  1.14073186e+04  4.09997467e+04  1.09855211e+05
  2.54055857e+05  5.48486490e+05  1.15243478e+06  2.43021787e+06
  5.37495305e+06]
E1 = -706.6716878034568  E_coul = 198.74385990184106
Extra cycle  E= -507.927827901616  delta_E= 1.71e-13  |g|= 8.06e-09  |ddm|= 8.14e-08
    CPU time for scf_cycle      4.41 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12532.142419347285
E1 = -706.6716878034568  E_coul = 198.74385990184106
init E= -507.927827901616
    CPU time for initialize scf      9.23 sec, wall time      0.69 sec
  HOMO = -0.237973374355539  LUMO = 9.37529171818581
  mo_energy =
[-1.20311591e+02 -1.23748790e+01 -6.67603864e+00 -6.67603864e+00
 -6.67603864e+00 -1.16347841e+00 -2.37973374e-01 -2.37973374e-01
 -2.37973374e-01  9.37529172e+00  8.72119300e+01  4.64832487e+02
  2.23086111e+03  1.14073186e+04  4.09997467e+04  1.09855211e+05
  2.54055857e+05  5.48486490e+05  1.15243478e+06  2.43021787e+06
  5.37495305e+06]
E1 = -706.6716877984672  E_coul = 198.74385989685132
cycle= 1 E= -507.927827901616  delta_E= -1.71e-13  |g|= 1.02e-09  |ddm|= 4.26e-09
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
E1 = -706.6716877984672  E_coul = 198.74385989685132
  HOMO = -0.237973374450276  LUMO = 9.37529171832963
  mo_energy =
[-1.20311591e+02 -1.23748790e+01 -6.67603864e+00 -6.67603864e+00
 -6.67603864e+00 -1.16347841e+00 -2.37973374e-01 -2.37973374e-01
 -2.37973374e-01  9.37529172e+00  8.72119300e+01  4.64832487e+02
  2.23086111e+03  1.14073186e+04  4.09997467e+04  1.09855211e+05
  2.54055857e+05  5.48486490e+05  1.15243478e+06  2.43021787e+06
  5.37495305e+06]
E1 = -706.6716877982408  E_coul = 198.74385989662503
Extra cycle  E= -507.927827901616  delta_E= 2.27e-13  |g|= 1.21e-09  |ddm|= 2.27e-10
    CPU time for scf_cycle      9.30 sec, wall time      0.76 sec
exp = [3.96768325e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179144e+03
 1.83771607e+04 1.23897815e+03 2.98152859e+02 9.01580142e+01
 3.10915816e+01 7.94798680e+00 3.08703256e+00 8.60519089e+00
 4.93077266e-01]
grad_E = [ 7.96093428e-05 -2.26990193e-11  3.92303618e-10  1.30634453e-09
  7.75724132e-09  2.53168054e-08  1.55779753e-07  8.50428220e-06
  3.77908179e-07  3.89556069e-05 -4.83391188e-04  4.25920706e-04
 -2.46848099e-03  4.56930625e-05 -6.77943864e-05  2.76800743e-04
 -1.25117724e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396618936255       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079451        1
[INPUT] 0    0    [1    /1   ]  36755.2342842        1
[INPUT] 0    0    [1    /1   ]  7331.79181503        1
[INPUT] 0    0    [1    /1   ]  18377.1607518        1
[INPUT] 0    0    [1    /1   ]  1238.97789524        1
[INPUT] 0    0    [1    /1   ]  298.157292476        1
[INPUT] 0    0    [1    /1   ]  90.0830841663        1
[INPUT] 0    0    [1    /1   ]  31.0912645772        1
[INPUT] 0    0    [1    /1   ]  7.92419097119        1
[INPUT] 0    0    [1    /1   ]  3.08267183927        1
[INPUT] 1    0    [1    /1   ]  8.60358319124        1
[INPUT] 1    0    [1    /1   ]  0.492913247578       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39661893625519284, 1.0]], [0, [1176168.142606514, 1.0]], [0, [588084.0713027695, 1.0]], [0, [294042.0356500227, 1.0]], [0, [147021.0178164083, 1.0]], [0, [73510.50794506731, 1.0]], [0, [36755.23428419913, 1.0]], [0, [7331.791815034912, 1.0]], [0, [18377.16075177341, 1.0]], [0, [1238.9778952358631, 1.0]], [0, [298.15729247553867, 1.0]], [0, [90.08308416627936, 1.0]], [0, [31.0912645771534, 1.0]], [0, [7.9241909711856096, 1.0]], [0, [3.0826718392715033, 1.0]], [1, [8.603583191242551, 1.0]], [1, [0.4929132475784807, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39661894]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130277]
bas 3, expnt(s) = [294042.03565002]
bas 4, expnt(s) = [147021.01781641]
bas 5, expnt(s) = [73510.50794507]
bas 6, expnt(s) = [36755.2342842]
bas 7, expnt(s) = [7331.79181503]
bas 8, expnt(s) = [18377.16075177]
bas 9, expnt(s) = [1238.97789524]
bas 10, expnt(s) = [298.15729248]
bas 11, expnt(s) = [90.08308417]
bas 12, expnt(s) = [31.09126458]
bas 13, expnt(s) = [7.92419097]
bas 14, expnt(s) = [3.08267184]
bas 15, expnt(s) = [8.60358319]
bas 16, expnt(s) = [0.49291325]
CPU time:       630.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96618936e-01 1.26268525e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179182e+03 2.00180891e+03
 1.83771608e+04 3.98771246e+03 1.23897790e+03 5.27609605e+02
 2.98157292e+02 1.81279670e+02 9.00830842e+01 7.38749941e+01
 3.10912646e+01 3.32654815e+01 7.92419097e+00 1.19324940e+01
 3.08267184e+00 5.87774168e+00 8.60358319e+00 4.29866494e+01
 4.92913248e-01 1.20489029e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325376957022105
cond(S) = 12532.048202985876
E1 = -689.3839801203119  E_coul = 184.9120257294636
init E= -504.471954390848
    CPU time for initialize scf      4.55 sec, wall time      0.34 sec
  HOMO = -0.674676227265138  LUMO = 8.46702587504982
  mo_energy =
[-1.21699413e+02 -1.33870860e+01 -7.62797403e+00 -7.62797403e+00
 -7.62797403e+00 -1.63978462e+00 -6.74676227e-01 -6.74676227e-01
 -6.74676227e-01  8.46702588e+00  8.58066852e+01  4.63167020e+02
  2.22920335e+03  1.14058323e+04  4.09983606e+04  1.09853878e+05
  2.54054561e+05  5.48485223e+05  1.15243354e+06  2.43021664e+06
  5.37495184e+06]
E1 = -707.0466238879915  E_coul = 199.12562764786253
cycle= 1 E= -507.920996240129  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593139
diis-c [-0.35181371  1.        ]
  HOMO = -0.233252556947149  LUMO = 9.35167649094498
  mo_energy =
[-1.20251043e+02 -1.23509241e+01 -6.64601720e+00 -6.64601720e+00
 -6.64601720e+00 -1.16118414e+00 -2.33252557e-01 -2.33252557e-01
 -2.33252557e-01  9.35167649e+00  8.71145962e+01  4.64598066e+02
  2.23057926e+03  1.14070822e+04  4.09995380e+04  1.09855016e+05
  2.54055672e+05  5.48486314e+05  1.15243462e+06  2.43021771e+06
  5.37495290e+06]
E1 = -706.6708015583007  E_coul = 198.74296087590437
cycle= 2 E= -507.927840682396  delta_E= -0.00684  |g|= 0.0189  |ddm|= 0.21
    CPU time for cycle= 2      0.04 sec, wall time      0.02 sec
diis-norm(errvec)=0.0158502
diis-c [-2.45658601e-04  3.96411796e-03  9.96035882e-01]
  HOMO = -0.238150293924619  LUMO = 9.34067522454356
  mo_energy =
[-1.20311271e+02 -1.23750222e+01 -6.67574394e+00 -6.67574394e+00
 -6.67574394e+00 -1.16371177e+00 -2.38150294e-01 -2.38150294e-01
 -2.38150294e-01  9.34067522e+00  8.70725859e+01  4.64537163e+02
  2.23050389e+03  1.14069972e+04  4.09994498e+04  1.09854927e+05
  2.54055582e+05  5.48486224e+05  1.15243453e+06  2.43021762e+06
  5.37495281e+06]
E1 = -706.6545077851944  E_coul = 198.72665281554356
cycle= 3 E= -507.927854969651  delta_E= -1.43e-05  |g|= 0.000941  |ddm|= 0.00995
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000771866
diis-c [-2.11930793e-08  5.24826016e-05 -4.99324305e-02  1.04987995e+00]
  HOMO = -0.238406529889002  LUMO = 9.34011122995105
  mo_energy =
[-1.20314017e+02 -1.23762484e+01 -6.67722478e+00 -6.67722478e+00
 -6.67722478e+00 -1.16383854e+00 -2.38406530e-01 -2.38406530e-01
 -2.38406530e-01  9.34011123e+00  8.70705761e+01  4.64534432e+02
  2.23050072e+03  1.14069938e+04  4.09994463e+04  1.09854924e+05
  2.54055579e+05  5.48486220e+05  1.15243452e+06  2.43021761e+06
  5.37495281e+06]
E1 = -706.6536661532286  E_coul = 198.7258111453412
cycle= 4 E= -507.927855007887  delta_E= -3.82e-08  |g|= 8.58e-06  |ddm|= 0.000545
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.36148e-06
diis-c [-6.58654285e-12 -2.21517607e-06  2.52801038e-03 -5.11244331e-02
  1.04859864e+00]
  HOMO = -0.238407920314073  LUMO = 9.34010931601131
  mo_energy =
[-1.20314018e+02 -1.23762535e+01 -6.67722909e+00 -6.67722909e+00
 -6.67722909e+00 -1.16383931e+00 -2.38407920e-01 -2.38407920e-01
 -2.38407920e-01  9.34010932e+00  8.70705730e+01  4.64534431e+02
  2.23050072e+03  1.14069938e+04  4.09994463e+04  1.09854924e+05
  2.54055579e+05  5.48486220e+05  1.15243452e+06  2.43021761e+06
  5.37495281e+06]
E1 = -706.6536632564778  E_coul = 198.72580824858787
cycle= 5 E= -507.92785500789  delta_E= -2.44e-12  |g|= 1.52e-07  |ddm|= 3.72e-06
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -706.6536632564778  E_coul = 198.72580824858787
  HOMO = -0.238407957421475  LUMO = 9.34010924601093
  mo_energy =
[-1.20314019e+02 -1.23762537e+01 -6.67722927e+00 -6.67722927e+00
 -6.67722927e+00 -1.16383933e+00 -2.38407957e-01 -2.38407957e-01
 -2.38407957e-01  9.34010925e+00  8.70705728e+01  4.64534431e+02
  2.23050072e+03  1.14069938e+04  4.09994463e+04  1.09854924e+05
  2.54055579e+05  5.48486220e+05  1.15243452e+06  2.43021761e+06
  5.37495281e+06]
E1 = -706.6536631529169  E_coul = 198.72580814502703
Extra cycle  E= -507.92785500789  delta_E=    0  |g|= 8.08e-09  |ddm|= 8.19e-08
    CPU time for scf_cycle      4.82 sec, wall time      0.44 sec
exp = [3.96618936e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179182e+03
 1.83771608e+04 1.23897790e+03 2.98157292e+02 9.00830842e+01
 3.10912646e+01 7.92419097e+00 3.08267184e+00 8.60358319e+00
 4.92913248e-01]
E = -507.9278550078899
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396618936255       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079451        1
[INPUT] 0    0    [1    /1   ]  36755.2342842        1
[INPUT] 0    0    [1    /1   ]  7331.79181503        1
[INPUT] 0    0    [1    /1   ]  18377.1607518        1
[INPUT] 0    0    [1    /1   ]  1238.97789524        1
[INPUT] 0    0    [1    /1   ]  298.157292476        1
[INPUT] 0    0    [1    /1   ]  90.0830841663        1
[INPUT] 0    0    [1    /1   ]  31.0912645772        1
[INPUT] 0    0    [1    /1   ]  7.92419097119        1
[INPUT] 0    0    [1    /1   ]  3.08267183927        1
[INPUT] 1    0    [1    /1   ]  8.60358319124        1
[INPUT] 1    0    [1    /1   ]  0.492913247578       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39661893625519284, 1.0]], [0, [1176168.142606514, 1.0]], [0, [588084.0713027695, 1.0]], [0, [294042.0356500227, 1.0]], [0, [147021.0178164083, 1.0]], [0, [73510.50794506731, 1.0]], [0, [36755.23428419913, 1.0]], [0, [7331.791815034912, 1.0]], [0, [18377.16075177341, 1.0]], [0, [1238.9778952358631, 1.0]], [0, [298.15729247553867, 1.0]], [0, [90.08308416627936, 1.0]], [0, [31.0912645771534, 1.0]], [0, [7.9241909711856096, 1.0]], [0, [3.0826718392715033, 1.0]], [1, [8.603583191242551, 1.0]], [1, [0.4929132475784807, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39661894]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130277]
bas 3, expnt(s) = [294042.03565002]
bas 4, expnt(s) = [147021.01781641]
bas 5, expnt(s) = [73510.50794507]
bas 6, expnt(s) = [36755.2342842]
bas 7, expnt(s) = [7331.79181503]
bas 8, expnt(s) = [18377.16075177]
bas 9, expnt(s) = [1238.97789524]
bas 10, expnt(s) = [298.15729248]
bas 11, expnt(s) = [90.08308417]
bas 12, expnt(s) = [31.09126458]
bas 13, expnt(s) = [7.92419097]
bas 14, expnt(s) = [3.08267184]
bas 15, expnt(s) = [8.60358319]
bas 16, expnt(s) = [0.49291325]
CPU time:       635.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96618936e-01 1.26268525e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179182e+03 2.00180891e+03
 1.83771608e+04 3.98771246e+03 1.23897790e+03 5.27609605e+02
 2.98157292e+02 1.81279670e+02 9.00830842e+01 7.38749941e+01
 3.10912646e+01 3.32654815e+01 7.92419097e+00 1.19324940e+01
 3.08267184e+00 5.87774168e+00 8.60358319e+00 4.29866494e+01
 4.92913248e-01 1.20489029e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325376957022105
cond(S) = 12532.048202985876
E1 = -689.3839801203119  E_coul = 184.9120257294636
init E= -504.471954390848
    CPU time for initialize scf      4.16 sec, wall time      0.34 sec
  HOMO = -0.674676227265138  LUMO = 8.46702587504982
  mo_energy =
[-1.21699413e+02 -1.33870860e+01 -7.62797403e+00 -7.62797403e+00
 -7.62797403e+00 -1.63978462e+00 -6.74676227e-01 -6.74676227e-01
 -6.74676227e-01  8.46702588e+00  8.58066852e+01  4.63167020e+02
  2.22920335e+03  1.14058323e+04  4.09983606e+04  1.09853878e+05
  2.54054561e+05  5.48485223e+05  1.15243354e+06  2.43021664e+06
  5.37495184e+06]
E1 = -707.0466238879915  E_coul = 199.12562764786253
cycle= 1 E= -507.920996240129  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593139
diis-c [-0.35181371  1.        ]
  HOMO = -0.233252556947149  LUMO = 9.35167649094498
  mo_energy =
[-1.20251043e+02 -1.23509241e+01 -6.64601720e+00 -6.64601720e+00
 -6.64601720e+00 -1.16118414e+00 -2.33252557e-01 -2.33252557e-01
 -2.33252557e-01  9.35167649e+00  8.71145962e+01  4.64598066e+02
  2.23057926e+03  1.14070822e+04  4.09995380e+04  1.09855016e+05
  2.54055672e+05  5.48486314e+05  1.15243462e+06  2.43021771e+06
  5.37495290e+06]
E1 = -706.6708015583007  E_coul = 198.74296087590437
cycle= 2 E= -507.927840682396  delta_E= -0.00684  |g|= 0.0189  |ddm|= 0.21
    CPU time for cycle= 2      0.08 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158502
diis-c [-2.45658601e-04  3.96411796e-03  9.96035882e-01]
  HOMO = -0.238150293924619  LUMO = 9.34067522454356
  mo_energy =
[-1.20311271e+02 -1.23750222e+01 -6.67574394e+00 -6.67574394e+00
 -6.67574394e+00 -1.16371177e+00 -2.38150294e-01 -2.38150294e-01
 -2.38150294e-01  9.34067522e+00  8.70725859e+01  4.64537163e+02
  2.23050389e+03  1.14069972e+04  4.09994498e+04  1.09854927e+05
  2.54055582e+05  5.48486224e+05  1.15243453e+06  2.43021762e+06
  5.37495281e+06]
E1 = -706.6545077851944  E_coul = 198.72665281554356
cycle= 3 E= -507.927854969651  delta_E= -1.43e-05  |g|= 0.000941  |ddm|= 0.00995
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000771866
diis-c [-2.11930793e-08  5.24826016e-05 -4.99324305e-02  1.04987995e+00]
  HOMO = -0.238406529889002  LUMO = 9.34011122995105
  mo_energy =
[-1.20314017e+02 -1.23762484e+01 -6.67722478e+00 -6.67722478e+00
 -6.67722478e+00 -1.16383854e+00 -2.38406530e-01 -2.38406530e-01
 -2.38406530e-01  9.34011123e+00  8.70705761e+01  4.64534432e+02
  2.23050072e+03  1.14069938e+04  4.09994463e+04  1.09854924e+05
  2.54055579e+05  5.48486220e+05  1.15243452e+06  2.43021761e+06
  5.37495281e+06]
E1 = -706.6536661532286  E_coul = 198.7258111453412
cycle= 4 E= -507.927855007887  delta_E= -3.82e-08  |g|= 8.58e-06  |ddm|= 0.000545
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.36148e-06
diis-c [-6.58654285e-12 -2.21517607e-06  2.52801038e-03 -5.11244331e-02
  1.04859864e+00]
  HOMO = -0.238407920314073  LUMO = 9.34010931601131
  mo_energy =
[-1.20314018e+02 -1.23762535e+01 -6.67722909e+00 -6.67722909e+00
 -6.67722909e+00 -1.16383931e+00 -2.38407920e-01 -2.38407920e-01
 -2.38407920e-01  9.34010932e+00  8.70705730e+01  4.64534431e+02
  2.23050072e+03  1.14069938e+04  4.09994463e+04  1.09854924e+05
  2.54055579e+05  5.48486220e+05  1.15243452e+06  2.43021761e+06
  5.37495281e+06]
E1 = -706.6536632564778  E_coul = 198.72580824858787
cycle= 5 E= -507.92785500789  delta_E= -2.44e-12  |g|= 1.52e-07  |ddm|= 3.72e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6536632564778  E_coul = 198.72580824858787
  HOMO = -0.238407957421475  LUMO = 9.34010924601093
  mo_energy =
[-1.20314019e+02 -1.23762537e+01 -6.67722927e+00 -6.67722927e+00
 -6.67722927e+00 -1.16383933e+00 -2.38407957e-01 -2.38407957e-01
 -2.38407957e-01  9.34010925e+00  8.70705728e+01  4.64534431e+02
  2.23050072e+03  1.14069938e+04  4.09994463e+04  1.09854924e+05
  2.54055579e+05  5.48486220e+05  1.15243452e+06  2.43021761e+06
  5.37495281e+06]
E1 = -706.6536631529169  E_coul = 198.72580814502703
Extra cycle  E= -507.92785500789  delta_E=    0  |g|= 8.08e-09  |ddm|= 8.19e-08
    CPU time for scf_cycle      4.44 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12532.048202985876
E1 = -706.6536631529169  E_coul = 198.72580814502703
init E= -507.92785500789
    CPU time for initialize scf      9.51 sec, wall time      0.74 sec
  HOMO = -0.238407959266768  LUMO = 9.34010924248338
  mo_energy =
[-1.20314019e+02 -1.23762537e+01 -6.67722928e+00 -6.67722928e+00
 -6.67722928e+00 -1.16383933e+00 -2.38407959e-01 -2.38407959e-01
 -2.38407959e-01  9.34010924e+00  8.70705728e+01  4.64534431e+02
  2.23050072e+03  1.14069938e+04  4.09994463e+04  1.09854924e+05
  2.54055579e+05  5.48486220e+05  1.15243452e+06  2.43021761e+06
  5.37495281e+06]
E1 = -706.6536631479034  E_coul = 198.72580814001353
cycle= 1 E= -507.92785500789  delta_E=    0  |g|= 1.37e-09  |ddm|= 4.29e-09
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
E1 = -706.6536631479034  E_coul = 198.72580814001353
  HOMO = -0.238407959362418  LUMO = 9.34010924123201
  mo_energy =
[-1.20314019e+02 -1.23762537e+01 -6.67722928e+00 -6.67722928e+00
 -6.67722928e+00 -1.16383933e+00 -2.38407959e-01 -2.38407959e-01
 -2.38407959e-01  9.34010924e+00  8.70705728e+01  4.64534431e+02
  2.23050072e+03  1.14069938e+04  4.09994463e+04  1.09854924e+05
  2.54055579e+05  5.48486220e+05  1.15243452e+06  2.43021761e+06
  5.37495281e+06]
E1 = -706.6536631476876  E_coul = 198.7258081397978
Extra cycle  E= -507.92785500789  delta_E= 1.14e-13  |g|= 5.86e-10  |ddm|= 2.26e-10
    CPU time for scf_cycle      9.58 sec, wall time      0.80 sec
exp = [3.96618936e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179182e+03
 1.83771608e+04 1.23897790e+03 2.98157292e+02 9.00830842e+01
 3.10912646e+01 7.92419097e+00 3.08267184e+00 8.60358319e+00
 4.92913248e-01]
grad_E = [-2.07845936e-03 -2.25072705e-11  3.93600631e-10  1.31128569e-09
  7.78186404e-09  2.54100454e-08  1.56270494e-07  8.53385123e-06
  3.79508347e-07  3.67817195e-05 -4.55281813e-04  3.13666813e-04
 -2.33417994e-03 -1.40444484e-04  2.67717107e-04 -9.07272729e-04
 -5.96891483e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396391025486       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017817        1
[INPUT] 0    0    [1    /1   ]  73510.5079458        1
[INPUT] 0    0    [1    /1   ]  36755.2342884        1
[INPUT] 0    0    [1    /1   ]  7331.79204879        1
[INPUT] 0    0    [1    /1   ]  18377.1607624        1
[INPUT] 0    0    [1    /1   ]  1238.97728173        1
[INPUT] 0    0    [1    /1   ]  298.165981684        1
[INPUT] 0    0    [1    /1   ]  90.0146493116        1
[INPUT] 0    0    [1    /1   ]  31.1152050256        1
[INPUT] 0    0    [1    /1   ]  7.89399547182        1
[INPUT] 0    0    [1    /1   ]  3.07802832662        1
[INPUT] 1    0    [1    /1   ]  8.6010327549         1
[INPUT] 1    0    [1    /1   ]  0.492669911956       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3963910254856761, 1.0]], [0, [1176168.1426065136, 1.0]], [0, [588084.0713027802, 1.0]], [0, [294042.0356500589, 1.0]], [0, [147021.0178166199, 1.0]], [0, [73510.50794576756, 1.0]], [0, [36755.234288445405, 1.0]], [0, [7331.7920487929105, 1.0]], [0, [18377.160762383828, 1.0]], [0, [1238.9772817278845, 1.0]], [0, [298.16598168379755, 1.0]], [0, [90.0146493115997, 1.0]], [0, [31.115205025634225, 1.0]], [0, [7.893995471822494, 1.0]], [0, [3.0780283266154, 1.0]], [1, [8.601032754903667, 1.0]], [1, [0.4926699119558976, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39639103]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130278]
bas 3, expnt(s) = [294042.03565006]
bas 4, expnt(s) = [147021.01781662]
bas 5, expnt(s) = [73510.50794577]
bas 6, expnt(s) = [36755.23428845]
bas 7, expnt(s) = [7331.79204879]
bas 8, expnt(s) = [18377.16076238]
bas 9, expnt(s) = [1238.97728173]
bas 10, expnt(s) = [298.16598168]
bas 11, expnt(s) = [90.01464931]
bas 12, expnt(s) = [31.11520503]
bas 13, expnt(s) = [7.89399547]
bas 14, expnt(s) = [3.07802833]
bas 15, expnt(s) = [8.60103275]
bas 16, expnt(s) = [0.49266991]
CPU time:       652.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96391025e-01 1.26214103e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663114e+03 7.33179205e+03 2.00180896e+03
 1.83771608e+04 3.98771246e+03 1.23897728e+03 5.27609409e+02
 2.98165982e+02 1.81283632e+02 9.00146493e+01 7.38328988e+01
 3.11152050e+01 3.32846906e+01 7.89399547e+00 1.18983757e+01
 3.07802833e+00 5.87110008e+00 8.60103275e+00 4.29707214e+01
 4.92669912e-01 1.20414682e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325738076208182
cond(S) = 12531.975849308603
E1 = -689.361339309888  E_coul = 184.89182777838658
init E= -504.469511531501
    CPU time for initialize scf      4.63 sec, wall time      0.35 sec
  HOMO = -0.674982721655211  LUMO = 8.4267086236419
  mo_energy =
[-1.21702579e+02 -1.33887097e+01 -7.62931882e+00 -7.62931882e+00
 -7.62931882e+00 -1.64006155e+00 -6.74982722e-01 -6.74982722e-01
 -6.74982722e-01  8.42670862e+00  8.56838220e+01  4.62949104e+02
  2.22894355e+03  1.14056004e+04  4.09981461e+04  1.09853673e+05
  2.54054362e+05  5.48485030e+05  1.15243335e+06  2.43021646e+06
  5.37495167e+06]
E1 = -707.0205180667701  E_coul = 199.09948525981164
cycle= 1 E= -507.921032806958  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.593033
diis-c [-0.35168863  1.        ]
  HOMO = -0.233870523530998  LUMO = 9.30994171078028
  mo_energy =
[-1.20254653e+02 -1.23529121e+01 -6.64772397e+00 -6.64772397e+00
 -6.64772397e+00 -1.16171139e+00 -2.33870524e-01 -2.33870524e-01
 -2.33870524e-01  9.30994171e+00  8.69912932e+01  4.64379740e+02
  2.23031902e+03  1.14068498e+04  4.09993231e+04  1.09854811e+05
  2.54055473e+05  5.48486121e+05  1.15243443e+06  2.43021752e+06
  5.37495272e+06]
E1 = -706.6435164169709  E_coul = 198.71561590362924
cycle= 2 E= -507.927900513342  delta_E= -0.00687  |g|= 0.0189  |ddm|= 0.211
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158499
diis-c [-2.45612787e-04  3.97861292e-03  9.96021387e-01]
  HOMO = -0.23879067247954  LUMO = 9.29892674409263
  mo_energy =
[-1.20315006e+02 -1.23771056e+01 -6.67754921e+00 -6.67754921e+00
 -6.67754921e+00 -1.16425407e+00 -2.38790672e-01 -2.38790672e-01
 -2.38790672e-01  9.29892674e+00  8.69491850e+01  4.64318716e+02
  2.23024351e+03  1.14067647e+04  4.09992348e+04  1.09854721e+05
  2.54055383e+05  5.48486030e+05  1.15243434e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6271300216016  E_coul = 198.69921509159062
cycle= 3 E= -507.927914930011  delta_E= -1.44e-05  |g|= 0.000946  |ddm|= 0.01
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000773137
diis-c [-2.16167199e-08  5.28638334e-05 -5.00004002e-02  1.04994754e+00]
  HOMO = -0.239048857106974  LUMO = 9.29836035312488
  mo_energy =
[-1.20317764e+02 -1.23783402e+01 -6.67903895e+00 -6.67903895e+00
 -6.67903895e+00 -1.16438197e+00 -2.39048857e-01 -2.39048857e-01
 -2.39048857e-01  9.29836035e+00  8.69471654e+01  4.64315973e+02
  2.23024033e+03  1.14067613e+04  4.09992313e+04  1.09854718e+05
  2.54055379e+05  5.48486027e+05  1.15243433e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6262811234855  E_coul = 198.69836615464456
cycle= 4 E= -507.927914968841  delta_E= -3.88e-08  |g|= 8.72e-06  |ddm|= 0.000551
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.45689e-06
diis-c [-6.64189843e-12 -2.22428013e-06  2.54377246e-03 -5.14126526e-02
  1.04887110e+00]
  HOMO = -0.239050284727128  LUMO = 9.2983583776445
  mo_energy =
[-1.20317765e+02 -1.23783454e+01 -6.67904341e+00 -6.67904341e+00
 -6.67904341e+00 -1.16438276e+00 -2.39050285e-01 -2.39050285e-01
 -2.39050285e-01  9.29835838e+00  8.69471621e+01  4.64315972e+02
  2.23024033e+03  1.14067613e+04  4.09992313e+04  1.09854718e+05
  2.54055379e+05  5.48486027e+05  1.15243433e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6262781209518  E_coul = 198.69836315210833
cycle= 5 E= -507.927914968844  delta_E= -2.61e-12  |g|= 1.52e-07  |ddm|= 3.82e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6262781209518  E_coul = 198.69836315210833
  HOMO = -0.239050321999538  LUMO = 9.29835830735033
  mo_energy =
[-1.20317766e+02 -1.23783456e+01 -6.67904359e+00 -6.67904359e+00
 -6.67904359e+00 -1.16438278e+00 -2.39050322e-01 -2.39050322e-01
 -2.39050322e-01  9.29835831e+00  8.69471619e+01  4.64315971e+02
  2.23024033e+03  1.14067613e+04  4.09992313e+04  1.09854718e+05
  2.54055379e+05  5.48486027e+05  1.15243433e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6262780167999  E_coul = 198.6983630479559
Extra cycle  E= -507.927914968844  delta_E= -4.55e-13  |g|= 8.32e-09  |ddm|= 8.24e-08
    CPU time for scf_cycle      4.72 sec, wall time      0.42 sec
exp = [3.96391025e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179205e+03
 1.83771608e+04 1.23897728e+03 2.98165982e+02 9.00146493e+01
 3.11152050e+01 7.89399547e+00 3.07802833e+00 8.60103275e+00
 4.92669912e-01]
E = -507.927914968844
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396391025486       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017817        1
[INPUT] 0    0    [1    /1   ]  73510.5079458        1
[INPUT] 0    0    [1    /1   ]  36755.2342884        1
[INPUT] 0    0    [1    /1   ]  7331.79204879        1
[INPUT] 0    0    [1    /1   ]  18377.1607624        1
[INPUT] 0    0    [1    /1   ]  1238.97728173        1
[INPUT] 0    0    [1    /1   ]  298.165981684        1
[INPUT] 0    0    [1    /1   ]  90.0146493116        1
[INPUT] 0    0    [1    /1   ]  31.1152050256        1
[INPUT] 0    0    [1    /1   ]  7.89399547182        1
[INPUT] 0    0    [1    /1   ]  3.07802832662        1
[INPUT] 1    0    [1    /1   ]  8.6010327549         1
[INPUT] 1    0    [1    /1   ]  0.492669911956       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3963910254856761, 1.0]], [0, [1176168.1426065136, 1.0]], [0, [588084.0713027802, 1.0]], [0, [294042.0356500589, 1.0]], [0, [147021.0178166199, 1.0]], [0, [73510.50794576756, 1.0]], [0, [36755.234288445405, 1.0]], [0, [7331.7920487929105, 1.0]], [0, [18377.160762383828, 1.0]], [0, [1238.9772817278845, 1.0]], [0, [298.16598168379755, 1.0]], [0, [90.0146493115997, 1.0]], [0, [31.115205025634225, 1.0]], [0, [7.893995471822494, 1.0]], [0, [3.0780283266154, 1.0]], [1, [8.601032754903667, 1.0]], [1, [0.4926699119558976, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39639103]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130278]
bas 3, expnt(s) = [294042.03565006]
bas 4, expnt(s) = [147021.01781662]
bas 5, expnt(s) = [73510.50794577]
bas 6, expnt(s) = [36755.23428845]
bas 7, expnt(s) = [7331.79204879]
bas 8, expnt(s) = [18377.16076238]
bas 9, expnt(s) = [1238.97728173]
bas 10, expnt(s) = [298.16598168]
bas 11, expnt(s) = [90.01464931]
bas 12, expnt(s) = [31.11520503]
bas 13, expnt(s) = [7.89399547]
bas 14, expnt(s) = [3.07802833]
bas 15, expnt(s) = [8.60103275]
bas 16, expnt(s) = [0.49266991]
CPU time:       657.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96391025e-01 1.26214103e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663114e+03 7.33179205e+03 2.00180896e+03
 1.83771608e+04 3.98771246e+03 1.23897728e+03 5.27609409e+02
 2.98165982e+02 1.81283632e+02 9.00146493e+01 7.38328988e+01
 3.11152050e+01 3.32846906e+01 7.89399547e+00 1.18983757e+01
 3.07802833e+00 5.87110008e+00 8.60103275e+00 4.29707214e+01
 4.92669912e-01 1.20414682e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325738076208182
cond(S) = 12531.975849308603
E1 = -689.361339309888  E_coul = 184.89182777838658
init E= -504.469511531501
    CPU time for initialize scf      4.54 sec, wall time      0.34 sec
  HOMO = -0.674982721655211  LUMO = 8.4267086236419
  mo_energy =
[-1.21702579e+02 -1.33887097e+01 -7.62931882e+00 -7.62931882e+00
 -7.62931882e+00 -1.64006155e+00 -6.74982722e-01 -6.74982722e-01
 -6.74982722e-01  8.42670862e+00  8.56838220e+01  4.62949104e+02
  2.22894355e+03  1.14056004e+04  4.09981461e+04  1.09853673e+05
  2.54054362e+05  5.48485030e+05  1.15243335e+06  2.43021646e+06
  5.37495167e+06]
E1 = -707.0205180667701  E_coul = 199.09948525981164
cycle= 1 E= -507.921032806958  delta_E= -3.45  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593033
diis-c [-0.35168863  1.        ]
  HOMO = -0.233870523530998  LUMO = 9.30994171078028
  mo_energy =
[-1.20254653e+02 -1.23529121e+01 -6.64772397e+00 -6.64772397e+00
 -6.64772397e+00 -1.16171139e+00 -2.33870524e-01 -2.33870524e-01
 -2.33870524e-01  9.30994171e+00  8.69912932e+01  4.64379740e+02
  2.23031902e+03  1.14068498e+04  4.09993231e+04  1.09854811e+05
  2.54055473e+05  5.48486121e+05  1.15243443e+06  2.43021752e+06
  5.37495272e+06]
E1 = -706.6435164169709  E_coul = 198.71561590362924
cycle= 2 E= -507.927900513342  delta_E= -0.00687  |g|= 0.0189  |ddm|= 0.211
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158499
diis-c [-2.45612787e-04  3.97861292e-03  9.96021387e-01]
  HOMO = -0.23879067247954  LUMO = 9.29892674409263
  mo_energy =
[-1.20315006e+02 -1.23771056e+01 -6.67754921e+00 -6.67754921e+00
 -6.67754921e+00 -1.16425407e+00 -2.38790672e-01 -2.38790672e-01
 -2.38790672e-01  9.29892674e+00  8.69491850e+01  4.64318716e+02
  2.23024351e+03  1.14067647e+04  4.09992348e+04  1.09854721e+05
  2.54055383e+05  5.48486030e+05  1.15243434e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6271300216016  E_coul = 198.69921509159062
cycle= 3 E= -507.927914930011  delta_E= -1.44e-05  |g|= 0.000946  |ddm|= 0.01
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000773137
diis-c [-2.16167199e-08  5.28638334e-05 -5.00004002e-02  1.04994754e+00]
  HOMO = -0.239048857106974  LUMO = 9.29836035312488
  mo_energy =
[-1.20317764e+02 -1.23783402e+01 -6.67903895e+00 -6.67903895e+00
 -6.67903895e+00 -1.16438197e+00 -2.39048857e-01 -2.39048857e-01
 -2.39048857e-01  9.29836035e+00  8.69471654e+01  4.64315973e+02
  2.23024033e+03  1.14067613e+04  4.09992313e+04  1.09854718e+05
  2.54055379e+05  5.48486027e+05  1.15243433e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6262811234855  E_coul = 198.69836615464456
cycle= 4 E= -507.927914968841  delta_E= -3.88e-08  |g|= 8.72e-06  |ddm|= 0.000551
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.45689e-06
diis-c [-6.64189843e-12 -2.22428013e-06  2.54377246e-03 -5.14126526e-02
  1.04887110e+00]
  HOMO = -0.239050284727128  LUMO = 9.2983583776445
  mo_energy =
[-1.20317765e+02 -1.23783454e+01 -6.67904341e+00 -6.67904341e+00
 -6.67904341e+00 -1.16438276e+00 -2.39050285e-01 -2.39050285e-01
 -2.39050285e-01  9.29835838e+00  8.69471621e+01  4.64315972e+02
  2.23024033e+03  1.14067613e+04  4.09992313e+04  1.09854718e+05
  2.54055379e+05  5.48486027e+05  1.15243433e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6262781209518  E_coul = 198.69836315210833
cycle= 5 E= -507.927914968844  delta_E= -2.61e-12  |g|= 1.52e-07  |ddm|= 3.82e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6262781209518  E_coul = 198.69836315210833
  HOMO = -0.239050321999538  LUMO = 9.29835830735033
  mo_energy =
[-1.20317766e+02 -1.23783456e+01 -6.67904359e+00 -6.67904359e+00
 -6.67904359e+00 -1.16438278e+00 -2.39050322e-01 -2.39050322e-01
 -2.39050322e-01  9.29835831e+00  8.69471619e+01  4.64315971e+02
  2.23024033e+03  1.14067613e+04  4.09992313e+04  1.09854718e+05
  2.54055379e+05  5.48486027e+05  1.15243433e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6262780167999  E_coul = 198.6983630479559
Extra cycle  E= -507.927914968844  delta_E= -4.55e-13  |g|= 8.32e-09  |ddm|= 8.24e-08
    CPU time for scf_cycle      4.79 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12531.975849308603
E1 = -706.6262780167999  E_coul = 198.6983630479559
init E= -507.927914968844
    CPU time for initialize scf      9.49 sec, wall time      0.68 sec
  HOMO = -0.239050323858505  LUMO = 9.29835830559339
  mo_energy =
[-1.20317766e+02 -1.23783456e+01 -6.67904360e+00 -6.67904360e+00
 -6.67904360e+00 -1.16438278e+00 -2.39050324e-01 -2.39050324e-01
 -2.39050324e-01  9.29835831e+00  8.69471619e+01  4.64315971e+02
  2.23024033e+03  1.14067613e+04  4.09992313e+04  1.09854718e+05
  2.54055379e+05  5.48486027e+05  1.15243433e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6262780117761  E_coul = 198.69836304293224
cycle= 1 E= -507.927914968844  delta_E= 1.14e-13  |g|= 9.17e-10  |ddm|= 4.33e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6262780117761  E_coul = 198.69836304293224
  HOMO = -0.239050323954995  LUMO = 9.29835830300171
  mo_energy =
[-1.20317766e+02 -1.23783456e+01 -6.67904360e+00 -6.67904360e+00
 -6.67904360e+00 -1.16438278e+00 -2.39050324e-01 -2.39050324e-01
 -2.39050324e-01  9.29835830e+00  8.69471619e+01  4.64315971e+02
  2.23024033e+03  1.14067613e+04  4.09992313e+04  1.09854718e+05
  2.54055379e+05  5.48486027e+05  1.15243433e+06  2.43021743e+06
  5.37495263e+06]
E1 = -706.6262780115042  E_coul = 198.69836304266056
Extra cycle  E= -507.927914968844  delta_E= 2.84e-13  |g|= 5.88e-10  |ddm|= 2.51e-10
    CPU time for scf_cycle      9.69 sec, wall time      0.75 sec
exp = [3.96391025e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179205e+03
 1.83771608e+04 1.23897728e+03 2.98165982e+02 9.00146493e+01
 3.11152050e+01 7.89399547e+00 3.07802833e+00 8.60103275e+00
 4.92669912e-01]
grad_E = [-5.33680943e-03 -2.22770642e-11  3.95156924e-10  1.31721587e-09
  7.81140907e-09  2.55219511e-08  1.56859314e-07  8.56931292e-06
  3.81429413e-07  3.41693833e-05 -4.20514443e-04  1.62049318e-04
 -2.12923701e-03 -4.01978007e-04  7.87026525e-04 -2.79777123e-03
 -1.27868214e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396009240061       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079448        1
[INPUT] 0    0    [1    /1   ]  36755.2342826        1
[INPUT] 0    0    [1    /1   ]  7331.79172977        1
[INPUT] 0    0    [1    /1   ]  18377.1607482        1
[INPUT] 0    0    [1    /1   ]  1238.97563469        1
[INPUT] 0    0    [1    /1   ]  298.186504667        1
[INPUT] 0    0    [1    /1   ]  89.9915132391        1
[INPUT] 0    0    [1    /1   ]  31.2148577685        1
[INPUT] 0    0    [1    /1   ]  7.84864925077        1
[INPUT] 0    0    [1    /1   ]  3.07252015199        1
[INPUT] 1    0    [1    /1   ]  8.59670078723        1
[INPUT] 1    0    [1    /1   ]  0.492272511062       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39600924006051563, 1.0]], [0, [1176168.1426065145, 1.0]], [0, [588084.0713027655, 1.0]], [0, [294042.03565000993, 1.0]], [0, [147021.0178163287, 1.0]], [0, [73510.50794481838, 1.0]], [0, [36755.23428259779, 1.0]], [0, [7331.791729769376, 1.0]], [0, [18377.16074823321, 1.0]], [0, [1238.9756346867664, 1.0]], [0, [298.1865046669731, 1.0]], [0, [89.99151323906108, 1.0]], [0, [31.21485776848319, 1.0]], [0, [7.848649250768829, 1.0]], [0, [3.0725201519941514, 1.0]], [1, [8.596700787232948, 1.0]], [1, [0.492272511062484, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39600924]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130277]
bas 3, expnt(s) = [294042.03565001]
bas 4, expnt(s) = [147021.01781633]
bas 5, expnt(s) = [73510.50794482]
bas 6, expnt(s) = [36755.2342826]
bas 7, expnt(s) = [7331.79172977]
bas 8, expnt(s) = [18377.16074823]
bas 9, expnt(s) = [1238.97563469]
bas 10, expnt(s) = [298.18650467]
bas 11, expnt(s) = [89.99151324]
bas 12, expnt(s) = [31.21485777]
bas 13, expnt(s) = [7.84864925]
bas 14, expnt(s) = [3.07252015]
bas 15, expnt(s) = [8.59670079]
bas 16, expnt(s) = [0.49227251]
CPU time:       674.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96009240e-01 1.26122919e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179173e+03 2.00180889e+03
 1.83771607e+04 3.98771246e+03 1.23897563e+03 5.27608883e+02
 2.98186505e+02 1.81292990e+02 8.99915132e+01 7.38186656e+01
 3.12148578e+01 3.33646094e+01 7.84864925e+00 1.18470771e+01
 3.07252015e+00 5.86321850e+00 8.59670079e+00 4.29436700e+01
 4.92272511e-01 1.20293282e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32632460070362
cond(S) = 12531.996664627877
E1 = -689.3234742921633  E_coul = 184.85793423976662
init E= -504.465540052397
    CPU time for initialize scf      4.32 sec, wall time      0.32 sec
  HOMO = -0.675484997213758  LUMO = 8.3718715896309
  mo_energy =
[-1.21707952e+02 -1.33914352e+01 -7.63157824e+00 -7.63157824e+00
 -7.63157824e+00 -1.64052547e+00 -6.75484997e-01 -6.75484997e-01
 -6.75484997e-01  8.37187159e+00  8.56462430e+01  4.63061971e+02
  2.22910160e+03  1.14057524e+04  4.09982871e+04  1.09853807e+05
  2.54054492e+05  5.48485156e+05  1.15243347e+06  2.43021658e+06
  5.37495178e+06]
E1 = -706.9769660242333  E_coul = 199.05581170431142
cycle= 1 E= -507.921154319922  delta_E= -3.46  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.592893
diis-c [-0.35152219  1.        ]
  HOMO = -0.234883357593124  LUMO = 9.25312557308806
  mo_energy =
[-1.20260737e+02 -1.23562417e+01 -6.65058544e+00 -6.65058544e+00
 -6.65058544e+00 -1.16258698e+00 -2.34883358e-01 -2.34883358e-01
 -2.34883358e-01  9.25312557e+00  8.69533162e+01  4.64491986e+02
  2.23047638e+03  1.14070013e+04  4.09994636e+04  1.09854945e+05
  2.54055603e+05  5.48486247e+05  1.15243455e+06  2.43021764e+06
  5.37495284e+06]
E1 = -706.598404258014  E_coul = 198.6703518025206
cycle= 2 E= -507.928052455493  delta_E= -0.0069  |g|= 0.019  |ddm|= 0.212
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158411
diis-c [-2.45236375e-04  4.01354362e-03  9.95986456e-01]
  HOMO = -0.239832920222846  LUMO = 9.24209161536609
  mo_energy =
[-1.20321249e+02 -1.23805635e+01 -6.68054077e+00 -6.68054077e+00
 -6.68054077e+00 -1.16515001e+00 -2.39832920e-01 -2.39832920e-01
 -2.39832920e-01  9.24209162e+00  8.69110573e+01  4.64430802e+02
  2.23040071e+03  1.14069160e+04  4.09993751e+04  1.09854855e+05
  2.54055512e+05  5.48486156e+05  1.15243446e+06  2.43021755e+06
  5.37495275e+06]
E1 = -706.5818930053309  E_coul = 198.65382595714897
cycle= 3 E= -507.928067048182  delta_E= -1.46e-05  |g|= 0.000952  |ddm|= 0.0101
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000774727
diis-c [-2.21634751e-08  5.33433704e-05 -5.01116745e-02  1.05005833e+00]
  HOMO = -0.240093799260044  LUMO = 9.2415217558079
  mo_energy =
[-1.20324024e+02 -1.23818098e+01 -6.68204300e+00 -6.68204300e+00
 -6.68204300e+00 -1.16527949e+00 -2.40093799e-01 -2.40093799e-01
 -2.40093799e-01  9.24152176e+00  8.69090227e+01  4.64428041e+02
  2.23039751e+03  1.14069125e+04  4.09993716e+04  1.09854852e+05
  2.54055509e+05  5.48486152e+05  1.15243446e+06  2.43021755e+06
  5.37495274e+06]
E1 = -706.581033936842  E_coul = 198.65296684898766
cycle= 4 E= -507.928067087854  delta_E= -3.97e-08  |g|= 8.92e-06  |ddm|= 0.000558
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.58121e-06
diis-c [-6.70720740e-12 -2.23798981e-06  2.56585732e-03 -5.17968499e-02
  1.04923323e+00]
  HOMO = -0.240095277507821  LUMO = 9.24151969674059
  mo_energy =
[-1.20324026e+02 -1.23818152e+01 -6.68204767e+00 -6.68204767e+00
 -6.68204767e+00 -1.16528031e+00 -2.40095278e-01 -2.40095278e-01
 -2.40095278e-01  9.24151970e+00  8.69090192e+01  4.64428040e+02
  2.23039751e+03  1.14069125e+04  4.09993716e+04  1.09854852e+05
  2.54055509e+05  5.48486152e+05  1.15243446e+06  2.43021755e+06
  5.37495274e+06]
E1 = -706.5810307895233  E_coul = 198.65296370166638
cycle= 5 E= -507.928067087857  delta_E= -2.56e-12  |g|= 1.53e-07  |ddm|= 3.96e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5810307895233  E_coul = 198.65296370166638
  HOMO = -0.24009531500224  LUMO = 9.24151962542208
  mo_energy =
[-1.20324026e+02 -1.23818154e+01 -6.68204785e+00 -6.68204785e+00
 -6.68204785e+00 -1.16528033e+00 -2.40095315e-01 -2.40095315e-01
 -2.40095315e-01  9.24151963e+00  8.69090190e+01  4.64428040e+02
  2.23039751e+03  1.14069125e+04  4.09993716e+04  1.09854852e+05
  2.54055509e+05  5.48486152e+05  1.15243446e+06  2.43021755e+06
  5.37495274e+06]
E1 = -706.5810306844571  E_coul = 198.6529635966003
Extra cycle  E= -507.928067087857  delta_E= 1.14e-13  |g|= 8.25e-09  |ddm|= 8.32e-08
    CPU time for scf_cycle      4.59 sec, wall time      0.39 sec
exp = [3.96009240e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179173e+03
 1.83771607e+04 1.23897563e+03 2.98186505e+02 8.99915132e+01
 3.12148578e+01 7.84864925e+00 3.07252015e+00 8.59670079e+00
 4.92272511e-01]
E = -507.9280670878568
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396009240061       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017816        1
[INPUT] 0    0    [1    /1   ]  73510.5079448        1
[INPUT] 0    0    [1    /1   ]  36755.2342826        1
[INPUT] 0    0    [1    /1   ]  7331.79172977        1
[INPUT] 0    0    [1    /1   ]  18377.1607482        1
[INPUT] 0    0    [1    /1   ]  1238.97563469        1
[INPUT] 0    0    [1    /1   ]  298.186504667        1
[INPUT] 0    0    [1    /1   ]  89.9915132391        1
[INPUT] 0    0    [1    /1   ]  31.2148577685        1
[INPUT] 0    0    [1    /1   ]  7.84864925077        1
[INPUT] 0    0    [1    /1   ]  3.07252015199        1
[INPUT] 1    0    [1    /1   ]  8.59670078723        1
[INPUT] 1    0    [1    /1   ]  0.492272511062       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39600924006051563, 1.0]], [0, [1176168.1426065145, 1.0]], [0, [588084.0713027655, 1.0]], [0, [294042.03565000993, 1.0]], [0, [147021.0178163287, 1.0]], [0, [73510.50794481838, 1.0]], [0, [36755.23428259779, 1.0]], [0, [7331.791729769376, 1.0]], [0, [18377.16074823321, 1.0]], [0, [1238.9756346867664, 1.0]], [0, [298.1865046669731, 1.0]], [0, [89.99151323906108, 1.0]], [0, [31.21485776848319, 1.0]], [0, [7.848649250768829, 1.0]], [0, [3.0725201519941514, 1.0]], [1, [8.596700787232948, 1.0]], [1, [0.492272511062484, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39600924]
bas 1, expnt(s) = [1176168.14260651]
bas 2, expnt(s) = [588084.07130277]
bas 3, expnt(s) = [294042.03565001]
bas 4, expnt(s) = [147021.01781633]
bas 5, expnt(s) = [73510.50794482]
bas 6, expnt(s) = [36755.2342826]
bas 7, expnt(s) = [7331.79172977]
bas 8, expnt(s) = [18377.16074823]
bas 9, expnt(s) = [1238.97563469]
bas 10, expnt(s) = [298.18650467]
bas 11, expnt(s) = [89.99151324]
bas 12, expnt(s) = [31.21485777]
bas 13, expnt(s) = [7.84864925]
bas 14, expnt(s) = [3.07252015]
bas 15, expnt(s) = [8.59670079]
bas 16, expnt(s) = [0.49227251]
CPU time:       678.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96009240e-01 1.26122919e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552343e+04 6.70663113e+03 7.33179173e+03 2.00180889e+03
 1.83771607e+04 3.98771246e+03 1.23897563e+03 5.27608883e+02
 2.98186505e+02 1.81292990e+02 8.99915132e+01 7.38186656e+01
 3.12148578e+01 3.33646094e+01 7.84864925e+00 1.18470771e+01
 3.07252015e+00 5.86321850e+00 8.59670079e+00 4.29436700e+01
 4.92272511e-01 1.20293282e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32632460070362
cond(S) = 12531.996664627877
E1 = -689.3234742921633  E_coul = 184.85793423976662
init E= -504.465540052397
    CPU time for initialize scf      4.46 sec, wall time      0.33 sec
  HOMO = -0.675484997213758  LUMO = 8.3718715896309
  mo_energy =
[-1.21707952e+02 -1.33914352e+01 -7.63157824e+00 -7.63157824e+00
 -7.63157824e+00 -1.64052547e+00 -6.75484997e-01 -6.75484997e-01
 -6.75484997e-01  8.37187159e+00  8.56462430e+01  4.63061971e+02
  2.22910160e+03  1.14057524e+04  4.09982871e+04  1.09853807e+05
  2.54054492e+05  5.48485156e+05  1.15243347e+06  2.43021658e+06
  5.37495178e+06]
E1 = -706.9769660242333  E_coul = 199.05581170431142
cycle= 1 E= -507.921154319922  delta_E= -3.46  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.592893
diis-c [-0.35152219  1.        ]
  HOMO = -0.234883357593124  LUMO = 9.25312557308806
  mo_energy =
[-1.20260737e+02 -1.23562417e+01 -6.65058544e+00 -6.65058544e+00
 -6.65058544e+00 -1.16258698e+00 -2.34883358e-01 -2.34883358e-01
 -2.34883358e-01  9.25312557e+00  8.69533162e+01  4.64491986e+02
  2.23047638e+03  1.14070013e+04  4.09994636e+04  1.09854945e+05
  2.54055603e+05  5.48486247e+05  1.15243455e+06  2.43021764e+06
  5.37495284e+06]
E1 = -706.598404258014  E_coul = 198.6703518025206
cycle= 2 E= -507.928052455493  delta_E= -0.0069  |g|= 0.019  |ddm|= 0.212
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158411
diis-c [-2.45236375e-04  4.01354362e-03  9.95986456e-01]
  HOMO = -0.239832920222846  LUMO = 9.24209161536609
  mo_energy =
[-1.20321249e+02 -1.23805635e+01 -6.68054077e+00 -6.68054077e+00
 -6.68054077e+00 -1.16515001e+00 -2.39832920e-01 -2.39832920e-01
 -2.39832920e-01  9.24209162e+00  8.69110573e+01  4.64430802e+02
  2.23040071e+03  1.14069160e+04  4.09993751e+04  1.09854855e+05
  2.54055512e+05  5.48486156e+05  1.15243446e+06  2.43021755e+06
  5.37495275e+06]
E1 = -706.5818930053309  E_coul = 198.65382595714897
cycle= 3 E= -507.928067048182  delta_E= -1.46e-05  |g|= 0.000952  |ddm|= 0.0101
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000774727
diis-c [-2.21634751e-08  5.33433704e-05 -5.01116745e-02  1.05005833e+00]
  HOMO = -0.240093799260044  LUMO = 9.2415217558079
  mo_energy =
[-1.20324024e+02 -1.23818098e+01 -6.68204300e+00 -6.68204300e+00
 -6.68204300e+00 -1.16527949e+00 -2.40093799e-01 -2.40093799e-01
 -2.40093799e-01  9.24152176e+00  8.69090227e+01  4.64428041e+02
  2.23039751e+03  1.14069125e+04  4.09993716e+04  1.09854852e+05
  2.54055509e+05  5.48486152e+05  1.15243446e+06  2.43021755e+06
  5.37495274e+06]
E1 = -706.581033936842  E_coul = 198.65296684898766
cycle= 4 E= -507.928067087854  delta_E= -3.97e-08  |g|= 8.92e-06  |ddm|= 0.000558
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.58121e-06
diis-c [-6.70720740e-12 -2.23798981e-06  2.56585732e-03 -5.17968499e-02
  1.04923323e+00]
  HOMO = -0.240095277507821  LUMO = 9.24151969674059
  mo_energy =
[-1.20324026e+02 -1.23818152e+01 -6.68204767e+00 -6.68204767e+00
 -6.68204767e+00 -1.16528031e+00 -2.40095278e-01 -2.40095278e-01
 -2.40095278e-01  9.24151970e+00  8.69090192e+01  4.64428040e+02
  2.23039751e+03  1.14069125e+04  4.09993716e+04  1.09854852e+05
  2.54055509e+05  5.48486152e+05  1.15243446e+06  2.43021755e+06
  5.37495274e+06]
E1 = -706.5810307895233  E_coul = 198.65296370166638
cycle= 5 E= -507.928067087857  delta_E= -2.56e-12  |g|= 1.53e-07  |ddm|= 3.96e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5810307895233  E_coul = 198.65296370166638
  HOMO = -0.24009531500224  LUMO = 9.24151962542208
  mo_energy =
[-1.20324026e+02 -1.23818154e+01 -6.68204785e+00 -6.68204785e+00
 -6.68204785e+00 -1.16528033e+00 -2.40095315e-01 -2.40095315e-01
 -2.40095315e-01  9.24151963e+00  8.69090190e+01  4.64428040e+02
  2.23039751e+03  1.14069125e+04  4.09993716e+04  1.09854852e+05
  2.54055509e+05  5.48486152e+05  1.15243446e+06  2.43021755e+06
  5.37495274e+06]
E1 = -706.5810306844571  E_coul = 198.6529635966003
Extra cycle  E= -507.928067087857  delta_E= 1.14e-13  |g|= 8.25e-09  |ddm|= 8.32e-08
    CPU time for scf_cycle      4.72 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12531.996664627877
E1 = -706.5810306844571  E_coul = 198.6529635966003
init E= -507.928067087857
    CPU time for initialize scf      9.54 sec, wall time      0.68 sec
  HOMO = -0.240095316880116  LUMO = 9.24151962297904
  mo_energy =
[-1.20324026e+02 -1.23818154e+01 -6.68204786e+00 -6.68204786e+00
 -6.68204786e+00 -1.16528033e+00 -2.40095317e-01 -2.40095317e-01
 -2.40095317e-01  9.24151962e+00  8.69090190e+01  4.64428039e+02
  2.23039751e+03  1.14069125e+04  4.09993716e+04  1.09854852e+05
  2.54055509e+05  5.48486152e+05  1.15243446e+06  2.43021755e+06
  5.37495274e+06]
E1 = -706.5810306794192  E_coul = 198.65296359156224
cycle= 1 E= -507.928067087857  delta_E= -1.71e-13  |g|= 7.54e-10  |ddm|= 4.39e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.5810306794192  E_coul = 198.65296359156224
  HOMO = -0.240095316977676  LUMO = 9.24151962306224
  mo_energy =
[-1.20324026e+02 -1.23818154e+01 -6.68204786e+00 -6.68204786e+00
 -6.68204786e+00 -1.16528033e+00 -2.40095317e-01 -2.40095317e-01
 -2.40095317e-01  9.24151962e+00  8.69090190e+01  4.64428039e+02
  2.23039751e+03  1.14069125e+04  4.09993716e+04  1.09854852e+05
  2.54055509e+05  5.48486152e+05  1.15243446e+06  2.43021755e+06
  5.37495274e+06]
E1 = -706.5810306791238  E_coul = 198.6529635912666
Extra cycle  E= -507.928067087857  delta_E= -2.84e-13  |g|= 1.03e-09  |ddm|= 2.51e-10
    CPU time for scf_cycle      9.74 sec, wall time      0.75 sec
exp = [3.96009240e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552343e+04 7.33179173e+03
 1.83771607e+04 1.23897563e+03 2.98186505e+02 8.99915132e+01
 3.12148578e+01 7.84864925e+00 3.07252015e+00 8.59670079e+00
 4.92272511e-01]
grad_E = [-1.07310427e-02 -2.19922975e-11  3.97081032e-10  1.32454950e-09
  7.84793720e-09  2.56603462e-08  1.57587272e-07  8.61313901e-06
  3.83806110e-07  3.09205715e-05 -3.74636459e-04 -7.30141235e-05
 -1.74800536e-03 -8.21377335e-04  1.66236017e-03 -6.01644133e-03
 -2.37325996e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395516593117       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017815        1
[INPUT] 0    0    [1    /1   ]  73510.5079388        1
[INPUT] 0    0    [1    /1   ]  36755.234246         1
[INPUT] 0    0    [1    /1   ]  7331.78972697        1
[INPUT] 0    0    [1    /1   ]  18377.1606585        1
[INPUT] 0    0    [1    /1   ]  1238.97191045        1
[INPUT] 0    0    [1    /1   ]  298.229109246        1
[INPUT] 0    0    [1    /1   ]  90.1566417341        1
[INPUT] 0    0    [1    /1   ]  31.4879424292        1
[INPUT] 0    0    [1    /1   ]  7.796049079          1
[INPUT] 0    0    [1    /1   ]  3.06913031279        1
[INPUT] 1    0    [1    /1   ]  8.59107268753        1
[INPUT] 1    0    [1    /1   ]  0.491775485911       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39551659311744053, 1.0]], [0, [1176168.1426065192, 1.0]], [0, [588084.0713026733, 1.0]], [0, [294042.03564970125, 1.0]], [0, [147021.01781450713, 1.0]], [0, [73510.50793884219, 1.0]], [0, [36755.23424602666, 1.0]], [0, [7331.789726966349, 1.0]], [0, [18377.160658517823, 1.0]], [0, [1238.9719104525257, 1.0]], [0, [298.22910924588, 1.0]], [0, [90.15664173406604, 1.0]], [0, [31.487942429220503, 1.0]], [0, [7.796049078995507, 1.0]], [0, [3.0691303127855463, 1.0]], [1, [8.591072687534561, 1.0]], [1, [0.49177548591089437, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39551659]
bas 1, expnt(s) = [1176168.14260652]
bas 2, expnt(s) = [588084.07130267]
bas 3, expnt(s) = [294042.0356497]
bas 4, expnt(s) = [147021.01781451]
bas 5, expnt(s) = [73510.50793884]
bas 6, expnt(s) = [36755.23424603]
bas 7, expnt(s) = [7331.78972697]
bas 8, expnt(s) = [18377.16065852]
bas 9, expnt(s) = [1238.97191045]
bas 10, expnt(s) = [298.22910925]
bas 11, expnt(s) = [90.15664173]
bas 12, expnt(s) = [31.48794243]
bas 13, expnt(s) = [7.79604908]
bas 14, expnt(s) = [3.06913031]
bas 15, expnt(s) = [8.59107269]
bas 16, expnt(s) = [0.49177549]
CPU time:       696.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95516593e-01 1.26005225e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552342e+04 6.70663113e+03 7.33178973e+03 2.00180848e+03
 1.83771607e+04 3.98771244e+03 1.23897191e+03 5.27607693e+02
 2.98229109e+02 1.81312417e+02 9.01566417e+01 7.39202316e+01
 3.14879424e+01 3.35832897e+01 7.79604908e+00 1.17874794e+01
 3.06913031e+00 5.85836627e+00 8.59107269e+00 4.29085298e+01
 4.91775486e-01 1.20141483e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.327051766189086
cond(S) = 12532.336416860802
E1 = -689.2747812214222  E_coul = 184.81434322178154
init E= -504.460437999641
    CPU time for initialize scf      4.47 sec, wall time      0.34 sec
  HOMO = -0.676116728291384  LUMO = 8.32089703176463
  mo_energy =
[-1.21714956e+02 -1.33949580e+01 -7.63448542e+00 -7.63448542e+00
 -7.63448542e+00 -1.64112673e+00 -6.76116728e-01 -6.76116728e-01
 -6.76116728e-01  8.32089703e+00  8.59618399e+01  4.64266979e+02
  2.23062235e+03  1.14071499e+04  4.09995810e+04  1.09855045e+05
  2.54055689e+05  5.48486318e+05  1.15243460e+06  2.43021767e+06
  5.37495284e+06]
E1 = -706.9215106018376  E_coul = 199.0000571235981
cycle= 1 E= -507.921453478239  delta_E= -3.46  |g|= 0.445  |ddm|= 0.359
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592792
diis-c [-0.35140225  1.        ]
  HOMO = -0.236154325643703  LUMO = 9.20025631615703
  mo_energy =
[-1.20268555e+02 -1.23605277e+01 -6.65425311e+00 -6.65425311e+00
 -6.65425311e+00 -1.16370556e+00 -2.36154326e-01 -2.36154326e-01
 -2.36154326e-01  9.20025632e+00  8.72691852e+01  4.65696382e+02
  2.23199643e+03  1.14083982e+04  4.10007569e+04  1.09856182e+05
  2.54056799e+05  5.48487407e+05  1.15243568e+06  2.43021874e+06
  5.37495390e+06]
E1 = -706.5415800592839  E_coul = 198.61320247632813
cycle= 2 E= -507.928377582956  delta_E= -0.00692  |g|= 0.019  |ddm|= 0.213
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158122
diis-c [-2.44113611e-04  4.08657765e-03  9.95913422e-01]
  HOMO = -0.241128966358899  LUMO = 9.18920248974807
  mo_energy =
[-1.20329199e+02 -1.23849650e+01 -6.68432174e+00 -6.68432174e+00
 -6.68432174e+00 -1.16628709e+00 -2.41128966e-01 -2.41128966e-01
 -2.41128966e-01  9.18920249e+00  8.72267337e+01  4.65635053e+02
  2.23192062e+03  1.14083128e+04  4.10006683e+04  1.09856092e+05
  2.54056708e+05  5.48487316e+05  1.15243559e+06  2.43021865e+06
  5.37495381e+06]
E1 = -706.5249561567502  E_coul = 198.59656382016783
cycle= 3 E= -507.928392336582  delta_E= -1.48e-05  |g|= 0.000959  |ddm|= 0.0102
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000775879
diis-c [-2.25743196e-08  5.36570788e-05 -5.02626028e-02  1.05020895e+00]
  HOMO = -0.241392460734179  LUMO = 9.18862883936576
  mo_energy =
[-1.20331993e+02 -1.23862232e+01 -6.68583656e+00 -6.68583656e+00
 -6.68583656e+00 -1.16641814e+00 -2.41392461e-01 -2.41392461e-01
 -2.41392461e-01  9.18862884e+00  8.72246811e+01  4.65632273e+02
  2.23191741e+03  1.14083093e+04  4.10006648e+04  1.09856088e+05
  2.54056704e+05  5.48487313e+05  1.15243558e+06  2.43021864e+06
  5.37495381e+06]
E1 = -706.5240870266629  E_coul = 198.59569464956226
cycle= 4 E= -507.928392377101  delta_E= -4.05e-08  |g|= 9.1e-06  |ddm|= 0.000566
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.67861e-06
diis-c [-6.72643777e-12 -2.24980826e-06  2.58823421e-03 -5.21405348e-02
  1.04955455e+00]
  HOMO = -0.241393984568646  LUMO = 9.18862670621737
  mo_energy =
[-1.20331995e+02 -1.23862288e+01 -6.68584141e+00 -6.68584141e+00
 -6.68584141e+00 -1.16641898e+00 -2.41393985e-01 -2.41393985e-01
 -2.41393985e-01  9.18862671e+00  8.72246774e+01  4.65632271e+02
  2.23191741e+03  1.14083093e+04  4.10006648e+04  1.09856088e+05
  2.54056704e+05  5.48487313e+05  1.15243558e+06  2.43021864e+06
  5.37495381e+06]
E1 = -706.5240837485335  E_coul = 198.59569137143018
cycle= 5 E= -507.928392377103  delta_E= -2.67e-12  |g|= 1.54e-07  |ddm|= 4.08e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5240837485335  E_coul = 198.59569137143018
  HOMO = -0.241394022274652  LUMO = 9.18862663663271
  mo_energy =
[-1.20331996e+02 -1.23862290e+01 -6.68584159e+00 -6.68584159e+00
 -6.68584159e+00 -1.16641900e+00 -2.41394022e-01 -2.41394022e-01
 -2.41394022e-01  9.18862664e+00  8.72246772e+01  4.65632271e+02
  2.23191741e+03  1.14083093e+04  4.10006648e+04  1.09856088e+05
  2.54056704e+05  5.48487313e+05  1.15243558e+06  2.43021864e+06
  5.37495381e+06]
E1 = -706.5240836426537  E_coul = 198.59569126555047
Extra cycle  E= -507.928392377103  delta_E= 5.68e-14  |g|= 8.28e-09  |ddm|= 8.4e-08
    CPU time for scf_cycle      4.72 sec, wall time      0.41 sec
exp = [3.95516593e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552342e+04 7.33178973e+03
 1.83771607e+04 1.23897191e+03 2.98229109e+02 9.01566417e+01
 3.14879424e+01 7.79604908e+00 3.06913031e+00 8.59107269e+00
 4.91775486e-01]
E = -507.92839237710325
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395516593117       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071303        1
[INPUT] 0    0    [1    /1   ]  294042.03565         1
[INPUT] 0    0    [1    /1   ]  147021.017815        1
[INPUT] 0    0    [1    /1   ]  73510.5079388        1
[INPUT] 0    0    [1    /1   ]  36755.234246         1
[INPUT] 0    0    [1    /1   ]  7331.78972697        1
[INPUT] 0    0    [1    /1   ]  18377.1606585        1
[INPUT] 0    0    [1    /1   ]  1238.97191045        1
[INPUT] 0    0    [1    /1   ]  298.229109246        1
[INPUT] 0    0    [1    /1   ]  90.1566417341        1
[INPUT] 0    0    [1    /1   ]  31.4879424292        1
[INPUT] 0    0    [1    /1   ]  7.796049079          1
[INPUT] 0    0    [1    /1   ]  3.06913031279        1
[INPUT] 1    0    [1    /1   ]  8.59107268753        1
[INPUT] 1    0    [1    /1   ]  0.491775485911       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39551659311744053, 1.0]], [0, [1176168.1426065192, 1.0]], [0, [588084.0713026733, 1.0]], [0, [294042.03564970125, 1.0]], [0, [147021.01781450713, 1.0]], [0, [73510.50793884219, 1.0]], [0, [36755.23424602666, 1.0]], [0, [7331.789726966349, 1.0]], [0, [18377.160658517823, 1.0]], [0, [1238.9719104525257, 1.0]], [0, [298.22910924588, 1.0]], [0, [90.15664173406604, 1.0]], [0, [31.487942429220503, 1.0]], [0, [7.796049078995507, 1.0]], [0, [3.0691303127855463, 1.0]], [1, [8.591072687534561, 1.0]], [1, [0.49177548591089437, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39551659]
bas 1, expnt(s) = [1176168.14260652]
bas 2, expnt(s) = [588084.07130267]
bas 3, expnt(s) = [294042.0356497]
bas 4, expnt(s) = [147021.01781451]
bas 5, expnt(s) = [73510.50793884]
bas 6, expnt(s) = [36755.23424603]
bas 7, expnt(s) = [7331.78972697]
bas 8, expnt(s) = [18377.16065852]
bas 9, expnt(s) = [1238.97191045]
bas 10, expnt(s) = [298.22910925]
bas 11, expnt(s) = [90.15664173]
bas 12, expnt(s) = [31.48794243]
bas 13, expnt(s) = [7.79604908]
bas 14, expnt(s) = [3.06913031]
bas 15, expnt(s) = [8.59107269]
bas 16, expnt(s) = [0.49177549]
CPU time:       700.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95516593e-01 1.26005225e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552342e+04 6.70663113e+03 7.33178973e+03 2.00180848e+03
 1.83771607e+04 3.98771244e+03 1.23897191e+03 5.27607693e+02
 2.98229109e+02 1.81312417e+02 9.01566417e+01 7.39202316e+01
 3.14879424e+01 3.35832897e+01 7.79604908e+00 1.17874794e+01
 3.06913031e+00 5.85836627e+00 8.59107269e+00 4.29085298e+01
 4.91775486e-01 1.20141483e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.327051766189086
cond(S) = 12532.336416860802
E1 = -689.2747812214222  E_coul = 184.81434322178154
init E= -504.460437999641
    CPU time for initialize scf      4.70 sec, wall time      0.35 sec
  HOMO = -0.676116728291384  LUMO = 8.32089703176463
  mo_energy =
[-1.21714956e+02 -1.33949580e+01 -7.63448542e+00 -7.63448542e+00
 -7.63448542e+00 -1.64112673e+00 -6.76116728e-01 -6.76116728e-01
 -6.76116728e-01  8.32089703e+00  8.59618399e+01  4.64266979e+02
  2.23062235e+03  1.14071499e+04  4.09995810e+04  1.09855045e+05
  2.54055689e+05  5.48486318e+05  1.15243460e+06  2.43021767e+06
  5.37495284e+06]
E1 = -706.9215106018376  E_coul = 199.0000571235981
cycle= 1 E= -507.921453478239  delta_E= -3.46  |g|= 0.445  |ddm|= 0.359
    CPU time for cycle= 1      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.592792
diis-c [-0.35140225  1.        ]
  HOMO = -0.236154325643703  LUMO = 9.20025631615703
  mo_energy =
[-1.20268555e+02 -1.23605277e+01 -6.65425311e+00 -6.65425311e+00
 -6.65425311e+00 -1.16370556e+00 -2.36154326e-01 -2.36154326e-01
 -2.36154326e-01  9.20025632e+00  8.72691852e+01  4.65696382e+02
  2.23199643e+03  1.14083982e+04  4.10007569e+04  1.09856182e+05
  2.54056799e+05  5.48487407e+05  1.15243568e+06  2.43021874e+06
  5.37495390e+06]
E1 = -706.5415800592839  E_coul = 198.61320247632813
cycle= 2 E= -507.928377582956  delta_E= -0.00692  |g|= 0.019  |ddm|= 0.213
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0158122
diis-c [-2.44113611e-04  4.08657765e-03  9.95913422e-01]
  HOMO = -0.241128966358899  LUMO = 9.18920248974807
  mo_energy =
[-1.20329199e+02 -1.23849650e+01 -6.68432174e+00 -6.68432174e+00
 -6.68432174e+00 -1.16628709e+00 -2.41128966e-01 -2.41128966e-01
 -2.41128966e-01  9.18920249e+00  8.72267337e+01  4.65635053e+02
  2.23192062e+03  1.14083128e+04  4.10006683e+04  1.09856092e+05
  2.54056708e+05  5.48487316e+05  1.15243559e+06  2.43021865e+06
  5.37495381e+06]
E1 = -706.5249561567502  E_coul = 198.59656382016783
cycle= 3 E= -507.928392336582  delta_E= -1.48e-05  |g|= 0.000959  |ddm|= 0.0102
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000775879
diis-c [-2.25743196e-08  5.36570788e-05 -5.02626028e-02  1.05020895e+00]
  HOMO = -0.241392460734179  LUMO = 9.18862883936576
  mo_energy =
[-1.20331993e+02 -1.23862232e+01 -6.68583656e+00 -6.68583656e+00
 -6.68583656e+00 -1.16641814e+00 -2.41392461e-01 -2.41392461e-01
 -2.41392461e-01  9.18862884e+00  8.72246811e+01  4.65632273e+02
  2.23191741e+03  1.14083093e+04  4.10006648e+04  1.09856088e+05
  2.54056704e+05  5.48487313e+05  1.15243558e+06  2.43021864e+06
  5.37495381e+06]
E1 = -706.5240870266629  E_coul = 198.59569464956226
cycle= 4 E= -507.928392377101  delta_E= -4.05e-08  |g|= 9.1e-06  |ddm|= 0.000566
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.67861e-06
diis-c [-6.72643777e-12 -2.24980826e-06  2.58823421e-03 -5.21405348e-02
  1.04955455e+00]
  HOMO = -0.241393984568646  LUMO = 9.18862670621737
  mo_energy =
[-1.20331995e+02 -1.23862288e+01 -6.68584141e+00 -6.68584141e+00
 -6.68584141e+00 -1.16641898e+00 -2.41393985e-01 -2.41393985e-01
 -2.41393985e-01  9.18862671e+00  8.72246774e+01  4.65632271e+02
  2.23191741e+03  1.14083093e+04  4.10006648e+04  1.09856088e+05
  2.54056704e+05  5.48487313e+05  1.15243558e+06  2.43021864e+06
  5.37495381e+06]
E1 = -706.5240837485335  E_coul = 198.59569137143018
cycle= 5 E= -507.928392377103  delta_E= -2.67e-12  |g|= 1.54e-07  |ddm|= 4.08e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5240837485335  E_coul = 198.59569137143018
  HOMO = -0.241394022274652  LUMO = 9.18862663663271
  mo_energy =
[-1.20331996e+02 -1.23862290e+01 -6.68584159e+00 -6.68584159e+00
 -6.68584159e+00 -1.16641900e+00 -2.41394022e-01 -2.41394022e-01
 -2.41394022e-01  9.18862664e+00  8.72246772e+01  4.65632271e+02
  2.23191741e+03  1.14083093e+04  4.10006648e+04  1.09856088e+05
  2.54056704e+05  5.48487313e+05  1.15243558e+06  2.43021864e+06
  5.37495381e+06]
E1 = -706.5240836426537  E_coul = 198.59569126555047
Extra cycle  E= -507.928392377103  delta_E= 5.68e-14  |g|= 8.28e-09  |ddm|= 8.4e-08
    CPU time for scf_cycle      4.79 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12532.336416860802
E1 = -706.5240836426537  E_coul = 198.59569126555047
init E= -507.928392377103
    CPU time for initialize scf      9.60 sec, wall time      0.70 sec
  HOMO = -0.2413940241699  LUMO = 9.18862663250084
  mo_energy =
[-1.20331996e+02 -1.23862290e+01 -6.68584160e+00 -6.68584160e+00
 -6.68584160e+00 -1.16641900e+00 -2.41394024e-01 -2.41394024e-01
 -2.41394024e-01  9.18862663e+00  8.72246771e+01  4.65632271e+02
  2.23191741e+03  1.14083093e+04  4.10006648e+04  1.09856088e+05
  2.54056704e+05  5.48487313e+05  1.15243558e+06  2.43021864e+06
  5.37495381e+06]
E1 = -706.5240836375805  E_coul = 198.59569126047717
cycle= 1 E= -507.928392377103  delta_E= -5.68e-14  |g|= 8.59e-10  |ddm|= 4.45e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.02 sec
E1 = -706.5240836375805  E_coul = 198.59569126047717
  HOMO = -0.241394024268749  LUMO = 9.18862663204404
  mo_energy =
[-1.20331996e+02 -1.23862290e+01 -6.68584160e+00 -6.68584160e+00
 -6.68584160e+00 -1.16641900e+00 -2.41394024e-01 -2.41394024e-01
 -2.41394024e-01  9.18862663e+00  8.72246771e+01  4.65632271e+02
  2.23191741e+03  1.14083093e+04  4.10006648e+04  1.09856088e+05
  2.54056704e+05  5.48487313e+05  1.15243558e+06  2.43021864e+06
  5.37495381e+06]
E1 = -706.5240836372687  E_coul = 198.59569126016535
Extra cycle  E= -507.928392377103  delta_E= -5.68e-14  |g|= 8.13e-10  |ddm|= 2.41e-10
    CPU time for scf_cycle      9.80 sec, wall time      0.77 sec
exp = [3.95516593e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552342e+04 7.33178973e+03
 1.83771607e+04 1.23897191e+03 2.98229109e+02 9.01566417e+01
 3.14879424e+01 7.79604908e+00 3.06913031e+00 8.59107269e+00
 4.91775486e-01]
grad_E = [-1.75977315e-02 -2.17983460e-11  3.98394170e-10  1.32955490e-09
  7.87286903e-09  2.57548137e-08  1.58084155e-07  8.64310158e-06
  3.85428885e-07  2.86252006e-05 -3.34990171e-04 -3.70022796e-04
 -1.10797115e-03 -1.33108047e-03  2.76554997e-03 -1.01957377e-02
 -3.71692327e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395168202364       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035649        1
[INPUT] 0    0    [1    /1   ]  147021.01781         1
[INPUT] 0    0    [1    /1   ]  73510.5079231        1
[INPUT] 0    0    [1    /1   ]  36755.2341499        1
[INPUT] 0    0    [1    /1   ]  7331.78446121        1
[INPUT] 0    0    [1    /1   ]  18377.1604222        1
[INPUT] 0    0    [1    /1   ]  1238.96513678        1
[INPUT] 0    0    [1    /1   ]  298.301772831        1
[INPUT] 0    0    [1    /1   ]  90.7325198301        1
[INPUT] 0    0    [1    /1   ]  32.0446534631        1
[INPUT] 0    0    [1    /1   ]  7.76615786048        1
[INPUT] 0    0    [1    /1   ]  3.07447091333        1
[INPUT] 1    0    [1    /1   ]  8.58703900285        1
[INPUT] 1    0    [1    /1   ]  0.491451466622       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3951682023643212, 1.0]], [0, [1176168.142606531, 1.0]], [0, [588084.0713024308, 1.0]], [0, [294042.0356488891, 1.0]], [0, [147021.01780972077, 1.0]], [0, [73510.50792312172, 1.0]], [0, [36755.23414993784, 1.0]], [0, [7331.784461211384, 1.0]], [0, [18377.16042223771, 1.0]], [0, [1238.965136778396, 1.0]], [0, [298.3017728307774, 1.0]], [0, [90.7325198300998, 1.0]], [0, [32.04465346309017, 1.0]], [0, [7.766157860476583, 1.0]], [0, [3.0744709133338084, 1.0]], [1, [8.587039002853803, 1.0]], [1, [0.4914514666220746, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3951682]
bas 1, expnt(s) = [1176168.14260653]
bas 2, expnt(s) = [588084.07130243]
bas 3, expnt(s) = [294042.03564889]
bas 4, expnt(s) = [147021.01780972]
bas 5, expnt(s) = [73510.50792312]
bas 6, expnt(s) = [36755.23414994]
bas 7, expnt(s) = [7331.78446121]
bas 8, expnt(s) = [18377.16042224]
bas 9, expnt(s) = [1238.96513678]
bas 10, expnt(s) = [298.30177283]
bas 11, expnt(s) = [90.73251983]
bas 12, expnt(s) = [32.04465346]
bas 13, expnt(s) = [7.76615786]
bas 14, expnt(s) = [3.07447091]
bas 15, expnt(s) = [8.587039]
bas 16, expnt(s) = [0.49145147]
CPU time:       718.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95168202e-01 1.25921972e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552341e+04 6.70663112e+03 7.33178446e+03 2.00180740e+03
 1.83771604e+04 3.98771240e+03 1.23896514e+03 5.27605530e+02
 2.98301773e+02 1.81345549e+02 9.07325198e+01 7.42740753e+01
 3.20446535e+01 3.40276305e+01 7.76615786e+00 1.17535669e+01
 3.07447091e+00 5.86601023e+00 8.58703900e+00 4.28833483e+01
 4.91451467e-01 1.20042543e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32752000612791
cond(S) = 12533.329672660759
E1 = -689.2406049112915  E_coul = 184.78395800740182
init E= -504.45664690389
    CPU time for initialize scf      4.35 sec, wall time      0.33 sec
  HOMO = -0.676534061333649  LUMO = 8.32338633780846
  mo_energy =
[-1.21720002e+02 -1.33974792e+01 -7.63651359e+00 -7.63651359e+00
 -7.63651359e+00 -1.64156082e+00 -6.76534061e-01 -6.76534061e-01
 -6.76534061e-01  8.32338634e+00  8.70550160e+01  4.67667474e+02
  2.23487127e+03  1.14110364e+04  4.10031790e+04  1.09858485e+05
  2.54059017e+05  5.48489549e+05  1.15243774e+06  2.43022073e+06
  5.37495580e+06]
E1 = -706.8840920183425  E_coul = 198.96208100668284
cycle= 1 E= -507.92201101166  delta_E= -3.47  |g|= 0.445  |ddm|= 0.359
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.5929
diis-c [-0.3515309  1.       ]
  HOMO = -0.2369917994554  LUMO = 9.20274954589859
  mo_energy =
[-1.20273906e+02 -1.23635578e+01 -6.65678343e+00 -6.65678343e+00
 -6.65678343e+00 -1.16448428e+00 -2.36991799e-01 -2.36991799e-01
 -2.36991799e-01  9.20274955e+00  8.83644500e+01  4.69096941e+02
  2.23624534e+03  1.14122848e+04  4.10043551e+04  1.09859623e+05
  2.54060127e+05  5.48490639e+05  1.15243882e+06  2.43022179e+06
  5.37495686e+06]
E1 = -706.5044710751599  E_coul = 198.5755441193919
cycle= 2 E= -507.928926955768  delta_E= -0.00692  |g|= 0.019  |ddm|= 0.213
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157507
diis-c [-2.41809108e-04  4.20885734e-03  9.95791143e-01]
  HOMO = -0.241958159581285  LUMO = 9.19168890360003
  mo_energy =
[-1.20334499e+02 -1.23879773e+01 -6.68682350e+00 -6.68682350e+00
 -6.68682350e+00 -1.16706313e+00 -2.41958160e-01 -2.41958160e-01
 -2.41958160e-01  9.19168890e+00  8.83218411e+01  4.69035624e+02
  2.23616961e+03  1.14121995e+04  4.10042666e+04  1.09859533e+05
  2.54060036e+05  5.48490548e+05  1.15243873e+06  2.43022170e+06
  5.37495677e+06]
E1 = -706.4878663521225  E_coul = 198.5589246665537
cycle= 3 E= -507.928941685569  delta_E= -1.47e-05  |g|= 0.00096  |ddm|= 0.0102
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000774786
diis-c [-2.22149275e-08  5.32267709e-05 -5.03987075e-02  1.05034548e+00]
  HOMO = -0.242221794730022  LUMO = 9.19111375109455
  mo_energy =
[-1.20337298e+02 -1.23892374e+01 -6.68834042e+00 -6.68834042e+00
 -6.68834042e+00 -1.16719434e+00 -2.42221795e-01 -2.42221795e-01
 -2.42221795e-01  9.19111375e+00  8.83197767e+01  4.69032838e+02
  2.23616638e+03  1.14121960e+04  4.10042630e+04  1.09859529e+05
  2.54060033e+05  5.48490545e+05  1.15243872e+06  2.43022170e+06
  5.37495676e+06]
E1 = -706.486996273771  E_coul = 198.5580545475902
cycle= 4 E= -507.928941726181  delta_E= -4.06e-08  |g|= 9.07e-06  |ddm|= 0.000567
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.61433e-06
diis-c [-6.61297867e-12 -2.24095751e-06  2.59364999e-03 -5.21052126e-02
  1.04951380e+00]
  HOMO = -0.242223308626071  LUMO = 9.19111163738271
  mo_energy =
[-1.20337300e+02 -1.23892430e+01 -6.68834522e+00 -6.68834522e+00
 -6.68834522e+00 -1.16719517e+00 -2.42223309e-01 -2.42223309e-01
 -2.42223309e-01  9.19111164e+00  8.83197731e+01  4.69032836e+02
  2.23616638e+03  1.14121960e+04  4.10042630e+04  1.09859529e+05
  2.54060033e+05  5.48490545e+05  1.15243872e+06  2.43022170e+06
  5.37495676e+06]
E1 = -706.4869930257819  E_coul = 198.55805129959776
cycle= 5 E= -507.928941726184  delta_E= -3.35e-12  |g|= 1.54e-07  |ddm|= 4.06e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.4869930257819  E_coul = 198.55805129959776
  HOMO = -0.242223346366359  LUMO = 9.19111156503902
  mo_energy =
[-1.20337301e+02 -1.23892431e+01 -6.68834540e+00 -6.68834540e+00
 -6.68834540e+00 -1.16719519e+00 -2.42223346e-01 -2.42223346e-01
 -2.42223346e-01  9.19111157e+00  8.83197729e+01  4.69032836e+02
  2.23616638e+03  1.14121960e+04  4.10042630e+04  1.09859529e+05
  2.54060033e+05  5.48490545e+05  1.15243872e+06  2.43022170e+06
  5.37495676e+06]
E1 = -706.4869929196974  E_coul = 198.5580511935136
Extra cycle  E= -507.928941726184  delta_E= 3.41e-13  |g|= 8.36e-09  |ddm|= 8.42e-08
    CPU time for scf_cycle      4.62 sec, wall time      0.39 sec
exp = [3.95168202e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552341e+04 7.33178446e+03
 1.83771604e+04 1.23896514e+03 2.98301773e+02 9.07325198e+01
 3.20446535e+01 7.76615786e+00 3.07447091e+00 8.58703900e+00
 4.91451467e-01]
E = -507.9289417261838
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395168202364       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035649        1
[INPUT] 0    0    [1    /1   ]  147021.01781         1
[INPUT] 0    0    [1    /1   ]  73510.5079231        1
[INPUT] 0    0    [1    /1   ]  36755.2341499        1
[INPUT] 0    0    [1    /1   ]  7331.78446121        1
[INPUT] 0    0    [1    /1   ]  18377.1604222        1
[INPUT] 0    0    [1    /1   ]  1238.96513678        1
[INPUT] 0    0    [1    /1   ]  298.301772831        1
[INPUT] 0    0    [1    /1   ]  90.7325198301        1
[INPUT] 0    0    [1    /1   ]  32.0446534631        1
[INPUT] 0    0    [1    /1   ]  7.76615786048        1
[INPUT] 0    0    [1    /1   ]  3.07447091333        1
[INPUT] 1    0    [1    /1   ]  8.58703900285        1
[INPUT] 1    0    [1    /1   ]  0.491451466622       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3951682023643212, 1.0]], [0, [1176168.142606531, 1.0]], [0, [588084.0713024308, 1.0]], [0, [294042.0356488891, 1.0]], [0, [147021.01780972077, 1.0]], [0, [73510.50792312172, 1.0]], [0, [36755.23414993784, 1.0]], [0, [7331.784461211384, 1.0]], [0, [18377.16042223771, 1.0]], [0, [1238.965136778396, 1.0]], [0, [298.3017728307774, 1.0]], [0, [90.7325198300998, 1.0]], [0, [32.04465346309017, 1.0]], [0, [7.766157860476583, 1.0]], [0, [3.0744709133338084, 1.0]], [1, [8.587039002853803, 1.0]], [1, [0.4914514666220746, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3951682]
bas 1, expnt(s) = [1176168.14260653]
bas 2, expnt(s) = [588084.07130243]
bas 3, expnt(s) = [294042.03564889]
bas 4, expnt(s) = [147021.01780972]
bas 5, expnt(s) = [73510.50792312]
bas 6, expnt(s) = [36755.23414994]
bas 7, expnt(s) = [7331.78446121]
bas 8, expnt(s) = [18377.16042224]
bas 9, expnt(s) = [1238.96513678]
bas 10, expnt(s) = [298.30177283]
bas 11, expnt(s) = [90.73251983]
bas 12, expnt(s) = [32.04465346]
bas 13, expnt(s) = [7.76615786]
bas 14, expnt(s) = [3.07447091]
bas 15, expnt(s) = [8.587039]
bas 16, expnt(s) = [0.49145147]
CPU time:       722.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95168202e-01 1.25921972e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552341e+04 6.70663112e+03 7.33178446e+03 2.00180740e+03
 1.83771604e+04 3.98771240e+03 1.23896514e+03 5.27605530e+02
 2.98301773e+02 1.81345549e+02 9.07325198e+01 7.42740753e+01
 3.20446535e+01 3.40276305e+01 7.76615786e+00 1.17535669e+01
 3.07447091e+00 5.86601023e+00 8.58703900e+00 4.28833483e+01
 4.91451467e-01 1.20042543e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32752000612791
cond(S) = 12533.329672660759
E1 = -689.2406049112915  E_coul = 184.78395800740182
init E= -504.45664690389
    CPU time for initialize scf      4.11 sec, wall time      0.33 sec
  HOMO = -0.676534061333649  LUMO = 8.32338633780846
  mo_energy =
[-1.21720002e+02 -1.33974792e+01 -7.63651359e+00 -7.63651359e+00
 -7.63651359e+00 -1.64156082e+00 -6.76534061e-01 -6.76534061e-01
 -6.76534061e-01  8.32338634e+00  8.70550160e+01  4.67667474e+02
  2.23487127e+03  1.14110364e+04  4.10031790e+04  1.09858485e+05
  2.54059017e+05  5.48489549e+05  1.15243774e+06  2.43022073e+06
  5.37495580e+06]
E1 = -706.8840920183425  E_coul = 198.96208100668284
cycle= 1 E= -507.92201101166  delta_E= -3.47  |g|= 0.445  |ddm|= 0.359
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.5929
diis-c [-0.3515309  1.       ]
  HOMO = -0.2369917994554  LUMO = 9.20274954589859
  mo_energy =
[-1.20273906e+02 -1.23635578e+01 -6.65678343e+00 -6.65678343e+00
 -6.65678343e+00 -1.16448428e+00 -2.36991799e-01 -2.36991799e-01
 -2.36991799e-01  9.20274955e+00  8.83644500e+01  4.69096941e+02
  2.23624534e+03  1.14122848e+04  4.10043551e+04  1.09859623e+05
  2.54060127e+05  5.48490639e+05  1.15243882e+06  2.43022179e+06
  5.37495686e+06]
E1 = -706.5044710751599  E_coul = 198.5755441193919
cycle= 2 E= -507.928926955768  delta_E= -0.00692  |g|= 0.019  |ddm|= 0.213
    CPU time for cycle= 2      0.09 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157507
diis-c [-2.41809108e-04  4.20885734e-03  9.95791143e-01]
  HOMO = -0.241958159581285  LUMO = 9.19168890360003
  mo_energy =
[-1.20334499e+02 -1.23879773e+01 -6.68682350e+00 -6.68682350e+00
 -6.68682350e+00 -1.16706313e+00 -2.41958160e-01 -2.41958160e-01
 -2.41958160e-01  9.19168890e+00  8.83218411e+01  4.69035624e+02
  2.23616961e+03  1.14121995e+04  4.10042666e+04  1.09859533e+05
  2.54060036e+05  5.48490548e+05  1.15243873e+06  2.43022170e+06
  5.37495677e+06]
E1 = -706.4878663521225  E_coul = 198.5589246665537
cycle= 3 E= -507.928941685569  delta_E= -1.47e-05  |g|= 0.00096  |ddm|= 0.0102
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000774786
diis-c [-2.22149275e-08  5.32267709e-05 -5.03987075e-02  1.05034548e+00]
  HOMO = -0.242221794730022  LUMO = 9.19111375109455
  mo_energy =
[-1.20337298e+02 -1.23892374e+01 -6.68834042e+00 -6.68834042e+00
 -6.68834042e+00 -1.16719434e+00 -2.42221795e-01 -2.42221795e-01
 -2.42221795e-01  9.19111375e+00  8.83197767e+01  4.69032838e+02
  2.23616638e+03  1.14121960e+04  4.10042630e+04  1.09859529e+05
  2.54060033e+05  5.48490545e+05  1.15243872e+06  2.43022170e+06
  5.37495676e+06]
E1 = -706.486996273771  E_coul = 198.5580545475902
cycle= 4 E= -507.928941726181  delta_E= -4.06e-08  |g|= 9.07e-06  |ddm|= 0.000567
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.61433e-06
diis-c [-6.61297867e-12 -2.24095751e-06  2.59364999e-03 -5.21052126e-02
  1.04951380e+00]
  HOMO = -0.242223308626071  LUMO = 9.19111163738271
  mo_energy =
[-1.20337300e+02 -1.23892430e+01 -6.68834522e+00 -6.68834522e+00
 -6.68834522e+00 -1.16719517e+00 -2.42223309e-01 -2.42223309e-01
 -2.42223309e-01  9.19111164e+00  8.83197731e+01  4.69032836e+02
  2.23616638e+03  1.14121960e+04  4.10042630e+04  1.09859529e+05
  2.54060033e+05  5.48490545e+05  1.15243872e+06  2.43022170e+06
  5.37495676e+06]
E1 = -706.4869930257819  E_coul = 198.55805129959776
cycle= 5 E= -507.928941726184  delta_E= -3.35e-12  |g|= 1.54e-07  |ddm|= 4.06e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.4869930257819  E_coul = 198.55805129959776
  HOMO = -0.242223346366359  LUMO = 9.19111156503902
  mo_energy =
[-1.20337301e+02 -1.23892431e+01 -6.68834540e+00 -6.68834540e+00
 -6.68834540e+00 -1.16719519e+00 -2.42223346e-01 -2.42223346e-01
 -2.42223346e-01  9.19111157e+00  8.83197729e+01  4.69032836e+02
  2.23616638e+03  1.14121960e+04  4.10042630e+04  1.09859529e+05
  2.54060033e+05  5.48490545e+05  1.15243872e+06  2.43022170e+06
  5.37495676e+06]
E1 = -706.4869929196974  E_coul = 198.5580511935136
Extra cycle  E= -507.928941726184  delta_E= 3.41e-13  |g|= 8.36e-09  |ddm|= 8.42e-08
    CPU time for scf_cycle      4.38 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12533.329672660759
E1 = -706.4869929196974  E_coul = 198.5580511935136
init E= -507.928941726184
    CPU time for initialize scf      8.61 sec, wall time      0.68 sec
  HOMO = -0.242223348262987  LUMO = 9.19111156309412
  mo_energy =
[-1.20337301e+02 -1.23892431e+01 -6.68834541e+00 -6.68834541e+00
 -6.68834541e+00 -1.16719519e+00 -2.42223348e-01 -2.42223348e-01
 -2.42223348e-01  9.19111156e+00  8.83197729e+01  4.69032836e+02
  2.23616638e+03  1.14121960e+04  4.10042630e+04  1.09859529e+05
  2.54060033e+05  5.48490545e+05  1.15243872e+06  2.43022170e+06
  5.37495676e+06]
E1 = -706.4869929145825  E_coul = 198.55805118839834
cycle= 1 E= -507.928941726184  delta_E= -3.98e-13  |g|= 9.83e-10  |ddm|= 4.47e-09
    CPU time for cycle= 1      0.15 sec, wall time      0.02 sec
E1 = -706.4869929145825  E_coul = 198.55805118839834
  HOMO = -0.242223348362273  LUMO = 9.19111156378964
  mo_energy =
[-1.20337301e+02 -1.23892431e+01 -6.68834541e+00 -6.68834541e+00
 -6.68834541e+00 -1.16719519e+00 -2.42223348e-01 -2.42223348e-01
 -2.42223348e-01  9.19111156e+00  8.83197729e+01  4.69032836e+02
  2.23616638e+03  1.14121960e+04  4.10042630e+04  1.09859529e+05
  2.54060033e+05  5.48490545e+05  1.15243872e+06  2.43022170e+06
  5.37495676e+06]
E1 = -706.4869929142891  E_coul = 198.55805118810443
Extra cycle  E= -507.928941726185  delta_E= -5.12e-13  |g|= 9.61e-10  |ddm|= 2.38e-10
    CPU time for scf_cycle      8.83 sec, wall time      0.75 sec
exp = [3.95168202e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552341e+04 7.33178446e+03
 1.83771604e+04 1.23896514e+03 2.98301773e+02 9.07325198e+01
 3.20446535e+01 7.76615786e+00 3.07447091e+00 8.58703900e+00
 4.91451467e-01]
grad_E = [-2.22947549e-02 -2.19935739e-11  3.97090691e-10  1.32458167e-09
  7.84813336e-09  2.56609844e-08  1.57591429e-07  8.61370367e-06
  3.83816306e-07  3.05533065e-05 -3.40404723e-04 -6.20128390e-04
 -2.09638403e-04 -1.61637485e-03  3.45745249e-03 -1.31574424e-02
 -4.54342382e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395462210753       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035648        1
[INPUT] 0    0    [1    /1   ]  147021.017803        1
[INPUT] 0    0    [1    /1   ]  73510.5079007        1
[INPUT] 0    0    [1    /1   ]  36755.2340128        1
[INPUT] 0    0    [1    /1   ]  7331.77694218        1
[INPUT] 0    0    [1    /1   ]  18377.1600845        1
[INPUT] 0    0    [1    /1   ]  1238.95777805        1
[INPUT] 0    0    [1    /1   ]  298.375338867        1
[INPUT] 0    0    [1    /1   ]  91.6641322134        1
[INPUT] 0    0    [1    /1   ]  32.7143979976        1
[INPUT] 0    0    [1    /1   ]  7.7994070469         1
[INPUT] 0    0    [1    /1   ]  3.09099167026        1
[INPUT] 1    0    [1    /1   ]  8.59024748242        1
[INPUT] 1    0    [1    /1   ]  0.491793801353       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3954622107533029, 1.0]], [0, [1176168.1426065478, 1.0]], [0, [588084.0713020847, 1.0]], [0, [294042.03564772895, 1.0]], [0, [147021.01780288853, 1.0]], [0, [73510.50790066825, 1.0]], [0, [36755.23401278033, 1.0]], [0, [7331.776942177126, 1.0]], [0, [18377.160084543415, 1.0]], [0, [1238.9577780483144, 1.0]], [0, [298.3753388665644, 1.0]], [0, [91.66413221338175, 1.0]], [0, [32.71439799758183, 1.0]], [0, [7.79940704689659, 1.0]], [0, [3.0909916702589637, 1.0]], [1, [8.590247482421853, 1.0]], [1, [0.4917938013532543, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39546221]
bas 1, expnt(s) = [1176168.14260655]
bas 2, expnt(s) = [588084.07130208]
bas 3, expnt(s) = [294042.03564773]
bas 4, expnt(s) = [147021.01780289]
bas 5, expnt(s) = [73510.50790067]
bas 6, expnt(s) = [36755.23401278]
bas 7, expnt(s) = [7331.77694218]
bas 8, expnt(s) = [18377.16008454]
bas 9, expnt(s) = [1238.95777805]
bas 10, expnt(s) = [298.37533887]
bas 11, expnt(s) = [91.66413221]
bas 12, expnt(s) = [32.714398]
bas 13, expnt(s) = [7.79940705]
bas 14, expnt(s) = [3.09099167]
bas 15, expnt(s) = [8.59024748]
bas 16, expnt(s) = [0.4917938]
CPU time:       738.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95462211e-01 1.25992231e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552340e+04 6.70663110e+03 7.33177694e+03 2.00180586e+03
 1.83771601e+04 3.98771235e+03 1.23895778e+03 5.27603180e+02
 2.98375339e+02 1.81379090e+02 9.16641322e+01 7.48453111e+01
 3.27143980e+01 3.45596411e+01 7.79940705e+00 1.17912871e+01
 3.09099167e+00 5.88963526e+00 8.59024748e+00 4.29033780e+01
 4.91793801e-01 1.20147076e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.327019178277517
cond(S) = 12534.814414418386
E1 = -689.2700695533924  E_coul = 184.81084136688213
init E= -504.45922818651
    CPU time for initialize scf      3.82 sec, wall time      0.33 sec
  HOMO = -0.676098958724609  LUMO = 8.42173744607988
  mo_energy =
[-1.21716044e+02 -1.33954520e+01 -7.63472180e+00 -7.63472180e+00
 -7.63472180e+00 -1.64123849e+00 -6.76098959e-01 -6.76098959e-01
 -6.76098959e-01  8.42173745e+00  8.87856097e+01  4.72653849e+02
  2.24109659e+03  1.14167240e+04  4.10084449e+04  1.09863522e+05
  2.54063889e+05  5.48494280e+05  1.15244234e+06  2.43022519e+06
  5.37496013e+06]
E1 = -706.9212711568509  E_coul = 198.9986396827645
cycle= 1 E= -507.922631474086  delta_E= -3.46  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
diis-norm(errvec)=0.593334
diis-c [-0.35204549  1.        ]
  HOMO = -0.23611890326084  LUMO = 9.30471081728698
  mo_energy =
[-1.20268820e+02 -1.23609897e+01 -6.65443370e+00 -6.65443370e+00
 -6.65443370e+00 -1.16380785e+00 -2.36118903e-01 -2.36118903e-01
 -2.36118903e-01  9.30471082e+00  9.00991349e+01  4.74084838e+02
  2.24247219e+03  1.14179741e+04  4.10096226e+04  1.09864661e+05
  2.54065001e+05  5.48495372e+05  1.15244342e+06  2.43022626e+06
  5.37496119e+06]
E1 = -706.544685016805  E_coul = 198.61519980197517
cycle= 2 E= -507.92948521483  delta_E= -0.00685  |g|= 0.0189  |ddm|= 0.211
    CPU time for cycle= 2      0.10 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156804
diis-c [-2.39222413e-04  4.33005480e-03  9.95669945e-01]
  HOMO = -0.241024748909076  LUMO = 9.29367010992667
  mo_energy =
[-1.20329084e+02 -1.23851658e+01 -6.68421559e+00 -6.68421559e+00
 -6.68421559e+00 -1.16634817e+00 -2.41024749e-01 -2.41024749e-01
 -2.41024749e-01  9.29367011e+00  9.00565378e+01  4.74023793e+02
  2.24239682e+03  1.14178891e+04  4.10095345e+04  1.09864571e+05
  2.54064911e+05  5.48495281e+05  1.15244333e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5283205140041  E_coul = 198.5988209065322
cycle= 3 E= -507.929499607472  delta_E= -1.44e-05  |g|= 0.000951  |ddm|= 0.01
    CPU time for cycle= 3      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.000770662
diis-c [-2.07864063e-08  5.17549783e-05 -5.04046422e-02  1.05035289e+00]
  HOMO = -0.241284033744967  LUMO = 9.29309863577284
  mo_energy =
[-1.20331861e+02 -1.23864085e+01 -6.68571429e+00 -6.68571429e+00
 -6.68571429e+00 -1.16647689e+00 -2.41284034e-01 -2.41284034e-01
 -2.41284034e-01  9.29309864e+00  9.00544813e+01  4.74021025e+02
  2.24239362e+03  1.14178857e+04  4.10095309e+04  1.09864568e+05
  2.54064907e+05  5.48495278e+05  1.15244332e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5274665607263  E_coul = 198.59796691397483
cycle= 4 E= -507.929499646752  delta_E= -3.93e-08  |g|= 8.7e-06  |ddm|= 0.000555
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.31512e-06
diis-c [-6.35118146e-12 -2.20385696e-06  2.56475101e-03 -5.14216768e-02
  1.04885913e+00]
  HOMO = -0.241285446347681  LUMO = 9.29309669485679
  mo_energy =
[-1.20331863e+02 -1.23864137e+01 -6.68571866e+00 -6.68571866e+00
 -6.68571866e+00 -1.16647768e+00 -2.41285446e-01 -2.41285446e-01
 -2.41285446e-01  9.29309669e+00  9.00544782e+01  4.74021024e+02
  2.24239362e+03  1.14178857e+04  4.10095309e+04  1.09864568e+05
  2.54064907e+05  5.48495278e+05  1.15244332e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5274636064079  E_coul = 198.59796395965293
cycle= 5 E= -507.929499646755  delta_E= -3.41e-12  |g|= 1.53e-07  |ddm|= 3.81e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5274636064079  E_coul = 198.59796395965293
  HOMO = -0.241285483779017  LUMO = 9.29309662255029
  mo_energy =
[-1.20331863e+02 -1.23864138e+01 -6.68571885e+00 -6.68571885e+00
 -6.68571885e+00 -1.16647770e+00 -2.41285484e-01 -2.41285484e-01
 -2.41285484e-01  9.29309662e+00  9.00544780e+01  4.74021024e+02
  2.24239362e+03  1.14178857e+04  4.10095309e+04  1.09864568e+05
  2.54064907e+05  5.48495278e+05  1.15244332e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5274635015625  E_coul = 198.59796385480792
Extra cycle  E= -507.929499646755  delta_E= 3.98e-13  |g|= 8.22e-09  |ddm|= 8.31e-08
    CPU time for scf_cycle      4.10 sec, wall time      0.40 sec
exp = [3.95462211e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552340e+04 7.33177694e+03
 1.83771601e+04 1.23895778e+03 2.98375339e+02 9.16641322e+01
 3.27143980e+01 7.79940705e+00 3.09099167e+00 8.59024748e+00
 4.91793801e-01]
E = -507.92949964675455
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395462210753       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035648        1
[INPUT] 0    0    [1    /1   ]  147021.017803        1
[INPUT] 0    0    [1    /1   ]  73510.5079007        1
[INPUT] 0    0    [1    /1   ]  36755.2340128        1
[INPUT] 0    0    [1    /1   ]  7331.77694218        1
[INPUT] 0    0    [1    /1   ]  18377.1600845        1
[INPUT] 0    0    [1    /1   ]  1238.95777805        1
[INPUT] 0    0    [1    /1   ]  298.375338867        1
[INPUT] 0    0    [1    /1   ]  91.6641322134        1
[INPUT] 0    0    [1    /1   ]  32.7143979976        1
[INPUT] 0    0    [1    /1   ]  7.7994070469         1
[INPUT] 0    0    [1    /1   ]  3.09099167026        1
[INPUT] 1    0    [1    /1   ]  8.59024748242        1
[INPUT] 1    0    [1    /1   ]  0.491793801353       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3954622107533029, 1.0]], [0, [1176168.1426065478, 1.0]], [0, [588084.0713020847, 1.0]], [0, [294042.03564772895, 1.0]], [0, [147021.01780288853, 1.0]], [0, [73510.50790066825, 1.0]], [0, [36755.23401278033, 1.0]], [0, [7331.776942177126, 1.0]], [0, [18377.160084543415, 1.0]], [0, [1238.9577780483144, 1.0]], [0, [298.3753388665644, 1.0]], [0, [91.66413221338175, 1.0]], [0, [32.71439799758183, 1.0]], [0, [7.79940704689659, 1.0]], [0, [3.0909916702589637, 1.0]], [1, [8.590247482421853, 1.0]], [1, [0.4917938013532543, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39546221]
bas 1, expnt(s) = [1176168.14260655]
bas 2, expnt(s) = [588084.07130208]
bas 3, expnt(s) = [294042.03564773]
bas 4, expnt(s) = [147021.01780289]
bas 5, expnt(s) = [73510.50790067]
bas 6, expnt(s) = [36755.23401278]
bas 7, expnt(s) = [7331.77694218]
bas 8, expnt(s) = [18377.16008454]
bas 9, expnt(s) = [1238.95777805]
bas 10, expnt(s) = [298.37533887]
bas 11, expnt(s) = [91.66413221]
bas 12, expnt(s) = [32.714398]
bas 13, expnt(s) = [7.79940705]
bas 14, expnt(s) = [3.09099167]
bas 15, expnt(s) = [8.59024748]
bas 16, expnt(s) = [0.4917938]
CPU time:       742.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95462211e-01 1.25992231e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552340e+04 6.70663110e+03 7.33177694e+03 2.00180586e+03
 1.83771601e+04 3.98771235e+03 1.23895778e+03 5.27603180e+02
 2.98375339e+02 1.81379090e+02 9.16641322e+01 7.48453111e+01
 3.27143980e+01 3.45596411e+01 7.79940705e+00 1.17912871e+01
 3.09099167e+00 5.88963526e+00 8.59024748e+00 4.29033780e+01
 4.91793801e-01 1.20147076e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.327019178277517
cond(S) = 12534.814414418386
E1 = -689.2700695533924  E_coul = 184.81084136688213
init E= -504.45922818651
    CPU time for initialize scf      3.81 sec, wall time      0.33 sec
  HOMO = -0.676098958724609  LUMO = 8.42173744607988
  mo_energy =
[-1.21716044e+02 -1.33954520e+01 -7.63472180e+00 -7.63472180e+00
 -7.63472180e+00 -1.64123849e+00 -6.76098959e-01 -6.76098959e-01
 -6.76098959e-01  8.42173745e+00  8.87856097e+01  4.72653849e+02
  2.24109659e+03  1.14167240e+04  4.10084449e+04  1.09863522e+05
  2.54063889e+05  5.48494280e+05  1.15244234e+06  2.43022519e+06
  5.37496013e+06]
E1 = -706.9212711568509  E_coul = 198.9986396827645
cycle= 1 E= -507.922631474086  delta_E= -3.46  |g|= 0.445  |ddm|= 0.358
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
diis-norm(errvec)=0.593334
diis-c [-0.35204549  1.        ]
  HOMO = -0.23611890326084  LUMO = 9.30471081728698
  mo_energy =
[-1.20268820e+02 -1.23609897e+01 -6.65443370e+00 -6.65443370e+00
 -6.65443370e+00 -1.16380785e+00 -2.36118903e-01 -2.36118903e-01
 -2.36118903e-01  9.30471082e+00  9.00991349e+01  4.74084838e+02
  2.24247219e+03  1.14179741e+04  4.10096226e+04  1.09864661e+05
  2.54065001e+05  5.48495372e+05  1.15244342e+06  2.43022626e+06
  5.37496119e+06]
E1 = -706.544685016805  E_coul = 198.61519980197517
cycle= 2 E= -507.92948521483  delta_E= -0.00685  |g|= 0.0189  |ddm|= 0.211
    CPU time for cycle= 2      0.10 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156804
diis-c [-2.39222413e-04  4.33005480e-03  9.95669945e-01]
  HOMO = -0.241024748909076  LUMO = 9.29367010992667
  mo_energy =
[-1.20329084e+02 -1.23851658e+01 -6.68421559e+00 -6.68421559e+00
 -6.68421559e+00 -1.16634817e+00 -2.41024749e-01 -2.41024749e-01
 -2.41024749e-01  9.29367011e+00  9.00565378e+01  4.74023793e+02
  2.24239682e+03  1.14178891e+04  4.10095345e+04  1.09864571e+05
  2.54064911e+05  5.48495281e+05  1.15244333e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5283205140041  E_coul = 198.5988209065322
cycle= 3 E= -507.929499607472  delta_E= -1.44e-05  |g|= 0.000951  |ddm|= 0.01
    CPU time for cycle= 3      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.000770662
diis-c [-2.07864063e-08  5.17549783e-05 -5.04046422e-02  1.05035289e+00]
  HOMO = -0.241284033744967  LUMO = 9.29309863577284
  mo_energy =
[-1.20331861e+02 -1.23864085e+01 -6.68571429e+00 -6.68571429e+00
 -6.68571429e+00 -1.16647689e+00 -2.41284034e-01 -2.41284034e-01
 -2.41284034e-01  9.29309864e+00  9.00544813e+01  4.74021025e+02
  2.24239362e+03  1.14178857e+04  4.10095309e+04  1.09864568e+05
  2.54064907e+05  5.48495278e+05  1.15244332e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5274665607263  E_coul = 198.59796691397483
cycle= 4 E= -507.929499646752  delta_E= -3.93e-08  |g|= 8.7e-06  |ddm|= 0.000555
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.31512e-06
diis-c [-6.35118146e-12 -2.20385696e-06  2.56475101e-03 -5.14216768e-02
  1.04885913e+00]
  HOMO = -0.241285446347681  LUMO = 9.29309669485679
  mo_energy =
[-1.20331863e+02 -1.23864137e+01 -6.68571866e+00 -6.68571866e+00
 -6.68571866e+00 -1.16647768e+00 -2.41285446e-01 -2.41285446e-01
 -2.41285446e-01  9.29309669e+00  9.00544782e+01  4.74021024e+02
  2.24239362e+03  1.14178857e+04  4.10095309e+04  1.09864568e+05
  2.54064907e+05  5.48495278e+05  1.15244332e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5274636064079  E_coul = 198.59796395965293
cycle= 5 E= -507.929499646755  delta_E= -3.41e-12  |g|= 1.53e-07  |ddm|= 3.81e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5274636064079  E_coul = 198.59796395965293
  HOMO = -0.241285483779017  LUMO = 9.29309662255029
  mo_energy =
[-1.20331863e+02 -1.23864138e+01 -6.68571885e+00 -6.68571885e+00
 -6.68571885e+00 -1.16647770e+00 -2.41285484e-01 -2.41285484e-01
 -2.41285484e-01  9.29309662e+00  9.00544780e+01  4.74021024e+02
  2.24239362e+03  1.14178857e+04  4.10095309e+04  1.09864568e+05
  2.54064907e+05  5.48495278e+05  1.15244332e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5274635015625  E_coul = 198.59796385480792
Extra cycle  E= -507.929499646755  delta_E= 3.98e-13  |g|= 8.22e-09  |ddm|= 8.31e-08
    CPU time for scf_cycle      4.10 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12534.814414418386
E1 = -706.5274635015625  E_coul = 198.59796385480792
init E= -507.929499646755
    CPU time for initialize scf      9.02 sec, wall time      0.70 sec
  HOMO = -0.241285485645943  LUMO = 9.29309662126256
  mo_energy =
[-1.20331863e+02 -1.23864138e+01 -6.68571886e+00 -6.68571886e+00
 -6.68571886e+00 -1.16647770e+00 -2.41285486e-01 -2.41285486e-01
 -2.41285486e-01  9.29309662e+00  9.00544780e+01  4.74021024e+02
  2.24239362e+03  1.14178857e+04  4.10095309e+04  1.09864568e+05
  2.54064907e+05  5.48495278e+05  1.15244332e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5274634965485  E_coul = 198.597963849794
cycle= 1 E= -507.929499646754  delta_E= 5.68e-14  |g|= 1.13e-09  |ddm|= 4.35e-09
    CPU time for cycle= 1      0.04 sec, wall time      0.01 sec
E1 = -706.5274634965485  E_coul = 198.597963849794
  HOMO = -0.241285485742364  LUMO = 9.29309662099859
  mo_energy =
[-1.20331863e+02 -1.23864138e+01 -6.68571886e+00 -6.68571886e+00
 -6.68571886e+00 -1.16647770e+00 -2.41285486e-01 -2.41285486e-01
 -2.41285486e-01  9.29309662e+00  9.00544780e+01  4.74021024e+02
  2.24239362e+03  1.14178857e+04  4.10095309e+04  1.09864568e+05
  2.54064907e+05  5.48495278e+05  1.15244332e+06  2.43022617e+06
  5.37496110e+06]
E1 = -706.5274634962724  E_coul = 198.59796384951804
Extra cycle  E= -507.929499646754  delta_E= 1.14e-13  |g|= 8.22e-10  |ddm|= 2.38e-10
    CPU time for scf_cycle      9.11 sec, wall time      0.77 sec
exp = [3.95462211e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552340e+04 7.33177694e+03
 1.83771601e+04 1.23895778e+03 2.98375339e+02 9.16641322e+01
 3.27143980e+01 7.79940705e+00 3.09099167e+00 8.59024748e+00
 4.91793801e-01]
grad_E = [-1.77004864e-02 -2.27653592e-11  3.91891435e-10  1.30476436e-09
  7.74944169e-09  2.52870472e-08  1.55624840e-07  8.49562721e-06
  3.77395678e-07  3.89170208e-05 -4.23864646e-04 -6.00129976e-04
  4.83380478e-04 -1.20024359e-03  2.72381371e-03 -1.06729572e-02
 -3.51289626e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:27:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396221477321       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017798        1
[INPUT] 0    0    [1    /1   ]  73510.5078852        1
[INPUT] 0    0    [1    /1   ]  36755.2339183        1
[INPUT] 0    0    [1    /1   ]  7331.77176111        1
[INPUT] 0    0    [1    /1   ]  18377.1598516        1
[INPUT] 0    0    [1    /1   ]  1238.95444683        1
[INPUT] 0    0    [1    /1   ]  298.403285422        1
[INPUT] 0    0    [1    /1   ]  92.3896775888        1
[INPUT] 0    0    [1    /1   ]  33.0788729737        1
[INPUT] 0    0    [1    /1   ]  7.85734899402        1
[INPUT] 0    0    [1    /1   ]  3.10324157251        1
[INPUT] 1    0    [1    /1   ]  8.59895906087        1
[INPUT] 1    0    [1    /1   ]  0.492595960108       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39622147732073215, 1.0]], [0, [1176168.1426065592, 1.0]], [0, [588084.0713018463, 1.0]], [0, [294042.03564692923, 1.0]], [0, [147021.01779818238, 1.0]], [0, [73510.50788519195, 1.0]], [0, [36755.233918307415, 1.0]], [0, [7331.771761111923, 1.0]], [0, [18377.159851621847, 1.0]], [0, [1238.9544468326524, 1.0]], [0, [298.40328542226695, 1.0]], [0, [92.38967758877673, 1.0]], [0, [33.07887297370694, 1.0]], [0, [7.85734899401528, 1.0]], [0, [3.1032415725132148, 1.0]], [1, [8.598959060871973, 1.0]], [1, [0.49259596010762063, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39622148]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130185]
bas 3, expnt(s) = [294042.03564693]
bas 4, expnt(s) = [147021.01779818]
bas 5, expnt(s) = [73510.50788519]
bas 6, expnt(s) = [36755.23391831]
bas 7, expnt(s) = [7331.77176111]
bas 8, expnt(s) = [18377.15985162]
bas 9, expnt(s) = [1238.95444683]
bas 10, expnt(s) = [298.40328542]
bas 11, expnt(s) = [92.38967759]
bas 12, expnt(s) = [33.07887297]
bas 13, expnt(s) = [7.85734899]
bas 14, expnt(s) = [3.10324157]
bas 15, expnt(s) = [8.59895906]
bas 16, expnt(s) = [0.49259596]
CPU time:       758.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96221477e-01 1.26173611e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177176e+03 2.00180480e+03
 1.83771599e+04 3.98771231e+03 1.23895445e+03 5.27602116e+02
 2.98403285e+02 1.81391831e+02 9.23896776e+01 7.52891879e+01
 3.30788730e+01 3.48480156e+01 7.85734899e+00 1.18569246e+01
 3.10324157e+00 5.90713250e+00 8.59895906e+00 4.29577716e+01
 4.92595960e-01 1.20392089e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325844044144713
cond(S) = 12535.847234544139
E1 = -689.3467446812415  E_coul = 184.87981324431973
init E= -504.466931436922
    CPU time for initialize scf      4.64 sec, wall time      0.33 sec
  HOMO = -0.675068335076274  LUMO = 8.52665052802351
  mo_energy =
[-1.21705349e+02 -1.33899932e+01 -7.63010888e+00 -7.63010888e+00
 -7.63010888e+00 -1.64035843e+00 -6.75068335e-01 -6.75068335e-01
 -6.75068335e-01  8.52665053e+00  8.99920647e+01  4.76071014e+02
  2.24540226e+03  1.14206596e+04  4.10120896e+04  1.09867009e+05
  2.54067262e+05  5.48497555e+05  1.15244553e+06  2.43022829e+06
  5.37496313e+06]
E1 = -707.0124756336198  E_coul = 199.08950528125038
cycle= 1 E= -507.922970352369  delta_E= -3.46  |g|= 0.445  |ddm|= 0.357
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593818
diis-c [-0.35262003  1.        ]
  HOMO = -0.234036242744501  LUMO = 9.41383321641049
  mo_energy =
[-1.20256228e+02 -1.23541967e+01 -6.64846490e+00 -6.64846490e+00
 -6.64846490e+00 -1.16205780e+00 -2.34036243e-01 -2.34036243e-01
 -2.34036243e-01  9.41383322e+00  9.13091848e+01  4.77504068e+02
  2.24677995e+03  1.14219117e+04  4.10132694e+04  1.09868149e+05
  2.54068376e+05  5.48498649e+05  1.15244660e+06  2.43022936e+06
  5.37496419e+06]
E1 = -706.6387174183252  E_coul = 198.70894967748617
cycle= 2 E= -507.929767740839  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156555
diis-c [-2.38261859e-04  4.38377459e-03  9.95616225e-01]
  HOMO = -0.238887828597291  LUMO = 9.40281291910627
  mo_energy =
[-1.20316207e+02 -1.23781342e+01 -6.67800534e+00 -6.67800534e+00
 -6.67800534e+00 -1.16456036e+00 -2.38887829e-01 -2.38887829e-01
 -2.38887829e-01  9.40281292e+00  9.12666684e+01  4.77443263e+02
  2.24670488e+03  1.14218270e+04  4.10131815e+04  1.09868060e+05
  2.54068286e+05  5.48498559e+05  1.15244651e+06  2.43022927e+06
  5.37496410e+06]
E1 = -706.6225864447027  E_coul = 198.69280464180753
cycle= 3 E= -507.929781802895  delta_E= -1.41e-05  |g|= 0.00094  |ddm|= 0.00983
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000767546
diis-c [-1.95835786e-08  5.04930469e-05 -5.03250645e-02  1.05027457e+00]
  HOMO = -0.239142685527708  LUMO = 9.4022460188197
  mo_energy =
[-1.20318960e+02 -1.23793576e+01 -6.67948422e+00 -6.67948422e+00
 -6.67948422e+00 -1.16468643e+00 -2.39142686e-01 -2.39142686e-01
 -2.39142686e-01  9.40224602e+00  9.12646263e+01  4.77440519e+02
  2.24670170e+03  1.14218236e+04  4.10131780e+04  1.09868057e+05
  2.54068282e+05  5.48498555e+05  1.15244651e+06  2.43022926e+06
  5.37496410e+06]
E1 = -706.6217495650433  E_coul = 198.69196772428165
cycle= 4 E= -507.929781840762  delta_E= -3.79e-08  |g|= 8.34e-06  |ddm|= 0.000541
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.04987e-06
diis-c [-6.16350225e-12 -2.16226835e-06  2.52911958e-03 -5.06877653e-02
  1.04816081e+00]
  HOMO = -0.239144000973743  LUMO = 9.40224424283354
  mo_energy =
[-1.20318961e+02 -1.23793624e+01 -6.67948819e+00 -6.67948819e+00
 -6.67948819e+00 -1.16468716e+00 -2.39144001e-01 -2.39144001e-01
 -2.39144001e-01  9.40224424e+00  9.12646236e+01  4.77440518e+02
  2.24670171e+03  1.14218236e+04  4.10131780e+04  1.09868057e+05
  2.54068282e+05  5.48498555e+05  1.15244651e+06  2.43022926e+06
  5.37496410e+06]
E1 = -706.6217468901272  E_coul = 198.69196504936272
cycle= 5 E= -507.929781840764  delta_E= -2.84e-12  |g|= 1.52e-07  |ddm|= 3.55e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6217468901272  E_coul = 198.69196504936272
  HOMO = -0.239144038094739  LUMO = 9.40224417313356
  mo_energy =
[-1.20318961e+02 -1.23793626e+01 -6.67948837e+00 -6.67948837e+00
 -6.67948837e+00 -1.16468718e+00 -2.39144038e-01 -2.39144038e-01
 -2.39144038e-01  9.40224417e+00  9.12646234e+01  4.77440518e+02
  2.24670171e+03  1.14218236e+04  4.10131780e+04  1.09868057e+05
  2.54068282e+05  5.48498555e+05  1.15244651e+06  2.43022926e+06
  5.37496410e+06]
E1 = -706.6217467865964  E_coul = 198.69196494583198
Extra cycle  E= -507.929781840764  delta_E=    0  |g|= 8.11e-09  |ddm|= 8.18e-08
    CPU time for scf_cycle      4.86 sec, wall time      0.40 sec
exp = [3.96221477e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177176e+03
 1.83771599e+04 1.23895445e+03 2.98403285e+02 9.23896776e+01
 3.30788730e+01 7.85734899e+00 3.10324157e+00 8.59895906e+00
 4.92595960e-01]
E = -507.92978184076446
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396221477321       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017798        1
[INPUT] 0    0    [1    /1   ]  73510.5078852        1
[INPUT] 0    0    [1    /1   ]  36755.2339183        1
[INPUT] 0    0    [1    /1   ]  7331.77176111        1
[INPUT] 0    0    [1    /1   ]  18377.1598516        1
[INPUT] 0    0    [1    /1   ]  1238.95444683        1
[INPUT] 0    0    [1    /1   ]  298.403285422        1
[INPUT] 0    0    [1    /1   ]  92.3896775888        1
[INPUT] 0    0    [1    /1   ]  33.0788729737        1
[INPUT] 0    0    [1    /1   ]  7.85734899402        1
[INPUT] 0    0    [1    /1   ]  3.10324157251        1
[INPUT] 1    0    [1    /1   ]  8.59895906087        1
[INPUT] 1    0    [1    /1   ]  0.492595960108       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39622147732073215, 1.0]], [0, [1176168.1426065592, 1.0]], [0, [588084.0713018463, 1.0]], [0, [294042.03564692923, 1.0]], [0, [147021.01779818238, 1.0]], [0, [73510.50788519195, 1.0]], [0, [36755.233918307415, 1.0]], [0, [7331.771761111923, 1.0]], [0, [18377.159851621847, 1.0]], [0, [1238.9544468326524, 1.0]], [0, [298.40328542226695, 1.0]], [0, [92.38967758877673, 1.0]], [0, [33.07887297370694, 1.0]], [0, [7.85734899401528, 1.0]], [0, [3.1032415725132148, 1.0]], [1, [8.598959060871973, 1.0]], [1, [0.49259596010762063, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39622148]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130185]
bas 3, expnt(s) = [294042.03564693]
bas 4, expnt(s) = [147021.01779818]
bas 5, expnt(s) = [73510.50788519]
bas 6, expnt(s) = [36755.23391831]
bas 7, expnt(s) = [7331.77176111]
bas 8, expnt(s) = [18377.15985162]
bas 9, expnt(s) = [1238.95444683]
bas 10, expnt(s) = [298.40328542]
bas 11, expnt(s) = [92.38967759]
bas 12, expnt(s) = [33.07887297]
bas 13, expnt(s) = [7.85734899]
bas 14, expnt(s) = [3.10324157]
bas 15, expnt(s) = [8.59895906]
bas 16, expnt(s) = [0.49259596]
CPU time:       763.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96221477e-01 1.26173611e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177176e+03 2.00180480e+03
 1.83771599e+04 3.98771231e+03 1.23895445e+03 5.27602116e+02
 2.98403285e+02 1.81391831e+02 9.23896776e+01 7.52891879e+01
 3.30788730e+01 3.48480156e+01 7.85734899e+00 1.18569246e+01
 3.10324157e+00 5.90713250e+00 8.59895906e+00 4.29577716e+01
 4.92595960e-01 1.20392089e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325844044144713
cond(S) = 12535.847234544139
E1 = -689.3467446812415  E_coul = 184.87981324431973
init E= -504.466931436922
    CPU time for initialize scf      4.61 sec, wall time      0.33 sec
  HOMO = -0.675068335076274  LUMO = 8.52665052802351
  mo_energy =
[-1.21705349e+02 -1.33899932e+01 -7.63010888e+00 -7.63010888e+00
 -7.63010888e+00 -1.64035843e+00 -6.75068335e-01 -6.75068335e-01
 -6.75068335e-01  8.52665053e+00  8.99920647e+01  4.76071014e+02
  2.24540226e+03  1.14206596e+04  4.10120896e+04  1.09867009e+05
  2.54067262e+05  5.48497555e+05  1.15244553e+06  2.43022829e+06
  5.37496313e+06]
E1 = -707.0124756336198  E_coul = 199.08950528125038
cycle= 1 E= -507.922970352369  delta_E= -3.46  |g|= 0.445  |ddm|= 0.357
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.593818
diis-c [-0.35262003  1.        ]
  HOMO = -0.234036242744501  LUMO = 9.41383321641049
  mo_energy =
[-1.20256228e+02 -1.23541967e+01 -6.64846490e+00 -6.64846490e+00
 -6.64846490e+00 -1.16205780e+00 -2.34036243e-01 -2.34036243e-01
 -2.34036243e-01  9.41383322e+00  9.13091848e+01  4.77504068e+02
  2.24677995e+03  1.14219117e+04  4.10132694e+04  1.09868149e+05
  2.54068376e+05  5.48498649e+05  1.15244660e+06  2.43022936e+06
  5.37496419e+06]
E1 = -706.6387174183252  E_coul = 198.70894967748617
cycle= 2 E= -507.929767740839  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156555
diis-c [-2.38261859e-04  4.38377459e-03  9.95616225e-01]
  HOMO = -0.238887828597291  LUMO = 9.40281291910627
  mo_energy =
[-1.20316207e+02 -1.23781342e+01 -6.67800534e+00 -6.67800534e+00
 -6.67800534e+00 -1.16456036e+00 -2.38887829e-01 -2.38887829e-01
 -2.38887829e-01  9.40281292e+00  9.12666684e+01  4.77443263e+02
  2.24670488e+03  1.14218270e+04  4.10131815e+04  1.09868060e+05
  2.54068286e+05  5.48498559e+05  1.15244651e+06  2.43022927e+06
  5.37496410e+06]
E1 = -706.6225864447027  E_coul = 198.69280464180753
cycle= 3 E= -507.929781802895  delta_E= -1.41e-05  |g|= 0.00094  |ddm|= 0.00983
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000767546
diis-c [-1.95835786e-08  5.04930469e-05 -5.03250645e-02  1.05027457e+00]
  HOMO = -0.239142685527708  LUMO = 9.4022460188197
  mo_energy =
[-1.20318960e+02 -1.23793576e+01 -6.67948422e+00 -6.67948422e+00
 -6.67948422e+00 -1.16468643e+00 -2.39142686e-01 -2.39142686e-01
 -2.39142686e-01  9.40224602e+00  9.12646263e+01  4.77440519e+02
  2.24670170e+03  1.14218236e+04  4.10131780e+04  1.09868057e+05
  2.54068282e+05  5.48498555e+05  1.15244651e+06  2.43022926e+06
  5.37496410e+06]
E1 = -706.6217495650433  E_coul = 198.69196772428165
cycle= 4 E= -507.929781840762  delta_E= -3.79e-08  |g|= 8.34e-06  |ddm|= 0.000541
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.04987e-06
diis-c [-6.16350225e-12 -2.16226835e-06  2.52911958e-03 -5.06877653e-02
  1.04816081e+00]
  HOMO = -0.239144000973743  LUMO = 9.40224424283354
  mo_energy =
[-1.20318961e+02 -1.23793624e+01 -6.67948819e+00 -6.67948819e+00
 -6.67948819e+00 -1.16468716e+00 -2.39144001e-01 -2.39144001e-01
 -2.39144001e-01  9.40224424e+00  9.12646236e+01  4.77440518e+02
  2.24670171e+03  1.14218236e+04  4.10131780e+04  1.09868057e+05
  2.54068282e+05  5.48498555e+05  1.15244651e+06  2.43022926e+06
  5.37496410e+06]
E1 = -706.6217468901272  E_coul = 198.69196504936272
cycle= 5 E= -507.929781840764  delta_E= -2.84e-12  |g|= 1.52e-07  |ddm|= 3.55e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6217468901272  E_coul = 198.69196504936272
  HOMO = -0.239144038094739  LUMO = 9.40224417313356
  mo_energy =
[-1.20318961e+02 -1.23793626e+01 -6.67948837e+00 -6.67948837e+00
 -6.67948837e+00 -1.16468718e+00 -2.39144038e-01 -2.39144038e-01
 -2.39144038e-01  9.40224417e+00  9.12646234e+01  4.77440518e+02
  2.24670171e+03  1.14218236e+04  4.10131780e+04  1.09868057e+05
  2.54068282e+05  5.48498555e+05  1.15244651e+06  2.43022926e+06
  5.37496410e+06]
E1 = -706.6217467865964  E_coul = 198.69196494583198
Extra cycle  E= -507.929781840764  delta_E=    0  |g|= 8.11e-09  |ddm|= 8.18e-08
    CPU time for scf_cycle      4.86 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12535.847234544139
E1 = -706.6217467865964  E_coul = 198.69196494583198
init E= -507.929781840764
    CPU time for initialize scf      9.66 sec, wall time      0.69 sec
  HOMO = -0.239144039931797  LUMO = 9.40224416882408
  mo_energy =
[-1.20318961e+02 -1.23793626e+01 -6.67948838e+00 -6.67948838e+00
 -6.67948838e+00 -1.16468718e+00 -2.39144040e-01 -2.39144040e-01
 -2.39144040e-01  9.40224417e+00  9.12646234e+01  4.77440518e+02
  2.24670170e+03  1.14218236e+04  4.10131780e+04  1.09868057e+05
  2.54068282e+05  5.48498555e+05  1.15244651e+06  2.43022926e+06
  5.37496410e+06]
E1 = -706.6217467815708  E_coul = 198.69196494080612
cycle= 1 E= -507.929781840765  delta_E= -2.27e-13  |g|= 9.8e-10  |ddm|= 4.29e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6217467815708  E_coul = 198.69196494080612
  HOMO = -0.239144040027043  LUMO = 9.4022441685078
  mo_energy =
[-1.20318961e+02 -1.23793626e+01 -6.67948838e+00 -6.67948838e+00
 -6.67948838e+00 -1.16468718e+00 -2.39144040e-01 -2.39144040e-01
 -2.39144040e-01  9.40224417e+00  9.12646234e+01  4.77440518e+02
  2.24670170e+03  1.14218236e+04  4.10131780e+04  1.09868057e+05
  2.54068282e+05  5.48498555e+05  1.15244651e+06  2.43022926e+06
  5.37496410e+06]
E1 = -706.6217467813609  E_coul = 198.6919649405965
Extra cycle  E= -507.929781840764  delta_E= 2.84e-13  |g|= 1.13e-09  |ddm|= 2.18e-10
    CPU time for scf_cycle      9.84 sec, wall time      0.77 sec
exp = [3.96221477e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177176e+03
 1.83771599e+04 1.23895445e+03 2.98403285e+02 9.23896776e+01
 3.30788730e+01 7.85734899e+00 3.10324157e+00 8.59895906e+00
 4.92595960e-01]
grad_E = [-6.39513807e-03 -2.36699086e-11  3.85757547e-10  1.28141262e-09
  7.63299333e-09  2.48464264e-08  1.53303751e-07  8.35570285e-06
  3.69840933e-07  4.90452803e-05 -5.38074965e-04 -3.15949115e-04
  4.98368708e-04 -4.37641398e-04  1.12837391e-03 -4.09975023e-03
 -1.26992387e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396631043881       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078817        1
[INPUT] 0    0    [1    /1   ]  36755.233897         1
[INPUT] 0    0    [1    /1   ]  7331.77059291        1
[INPUT] 0    0    [1    /1   ]  18377.159799         1
[INPUT] 0    0    [1    /1   ]  1238.95466191        1
[INPUT] 0    0    [1    /1   ]  298.396893048        1
[INPUT] 0    0    [1    /1   ]  92.6010046153        1
[INPUT] 0    0    [1    /1   ]  33.104219013         1
[INPUT] 0    0    [1    /1   ]  7.87853888346        1
[INPUT] 0    0    [1    /1   ]  3.10295397847        1
[INPUT] 1    0    [1    /1   ]  8.60397106704        1
[INPUT] 1    0    [1    /1   ]  0.493031485037       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966310438808503, 1.0]], [0, [1176168.1426065618, 1.0]], [0, [588084.0713017925, 1.0]], [0, [294042.0356467487, 1.0]], [0, [147021.0177971222, 1.0]], [0, [73510.50788169993, 1.0]], [0, [36755.23389702654, 1.0]], [0, [7331.770592907304, 1.0]], [0, [18377.1597989764, 1.0]], [0, [1238.9546619115436, 1.0]], [0, [298.3968930475114, 1.0]], [0, [92.60100461534964, 1.0]], [0, [33.104219013018195, 1.0]], [0, [7.878538883462749, 1.0]], [0, [3.102953978467289, 1.0]], [1, [8.603971067040192, 1.0]], [1, [0.49303148503654887, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39663104]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130179]
bas 3, expnt(s) = [294042.03564675]
bas 4, expnt(s) = [147021.01779712]
bas 5, expnt(s) = [73510.5078817]
bas 6, expnt(s) = [36755.23389703]
bas 7, expnt(s) = [7331.77059291]
bas 8, expnt(s) = [18377.15979898]
bas 9, expnt(s) = [1238.95466191]
bas 10, expnt(s) = [298.39689305]
bas 11, expnt(s) = [92.60100462]
bas 12, expnt(s) = [33.10421901]
bas 13, expnt(s) = [7.87853888]
bas 14, expnt(s) = [3.10295398]
bas 15, expnt(s) = [8.60397107]
bas 16, expnt(s) = [0.49303149]
CPU time:       781.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96631044e-01 1.26271416e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177059e+03 2.00180456e+03
 1.83771598e+04 3.98771230e+03 1.23895466e+03 5.27602184e+02
 2.98396893e+02 1.81388917e+02 9.26010046e+01 7.54183103e+01
 3.31042190e+01 3.48680399e+01 7.87853888e+00 1.18808985e+01
 3.10295398e+00 5.90672192e+00 8.60397107e+00 4.29890719e+01
 4.93031485e-01 1.20525158e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325203172052483
cond(S) = 12536.06134977234
E1 = -689.390095137335  E_coul = 184.91848457521803
init E= -504.471610562117
    CPU time for initialize scf      4.71 sec, wall time      0.36 sec
  HOMO = -0.674513840608731  LUMO = 8.55039906125093
  mo_energy =
[-1.21699276e+02 -1.33869063e+01 -7.62751464e+00 -7.62751464e+00
 -7.62751464e+00 -1.63984814e+00 -6.74513841e-01 -6.74513841e-01
 -6.74513841e-01  8.55039906e+00  9.02054891e+01  4.76767107e+02
  2.24632331e+03  1.14215047e+04  4.10128730e+04  1.09867758e+05
  2.54067987e+05  5.48498260e+05  1.15244621e+06  2.43022895e+06
  5.37496378e+06]
E1 = -707.0628362696006  E_coul = 199.1398090487482
cycle= 1 E= -507.923027220852  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.594024
diis-c [-0.35286424  1.        ]
  HOMO = -0.232905713610223  LUMO = 9.43885988438136
  mo_energy =
[-1.20249276e+02 -1.23503826e+01 -6.64513746e+00 -6.64513746e+00
 -6.64513746e+00 -1.16107263e+00 -2.32905714e-01 -2.32905714e-01
 -2.32905714e-01  9.43885988e+00  9.15237000e+01  4.78201026e+02
  2.24770187e+03  1.14227576e+04  4.10140535e+04  1.09868900e+05
  2.54069102e+05  5.48499354e+05  1.15244729e+06  2.43023002e+06
  5.37496484e+06]
E1 = -706.6894465671772  E_coul = 198.7596281186212
cycle= 2 E= -507.929818448556  delta_E= -0.00679  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156681
diis-c [-2.38648338e-04  4.38518267e-03  9.95614817e-01]
  HOMO = -0.237750834902624  LUMO = 9.42783812884458
  mo_energy =
[-1.20309234e+02 -1.23742788e+01 -6.67464449e+00 -6.67464449e+00
 -6.67464449e+00 -1.16356833e+00 -2.37750835e-01 -2.37750835e-01
 -2.37750835e-01  9.42783813e+00  9.14811799e+01  4.78140229e+02
  2.24762681e+03  1.14226729e+04  4.10139657e+04  1.09868811e+05
  2.54069012e+05  5.48499264e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6733576714582  E_coul = 198.74352522428012
cycle= 3 E= -507.929832447178  delta_E= -1.4e-05  |g|= 0.000938  |ddm|= 0.00979
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000767525
diis-c [-1.93937494e-08  5.02648589e-05 -5.02913503e-02  1.05024109e+00]
  HOMO = -0.238004922021422  LUMO = 9.42727210959561
  mo_energy =
[-1.20311983e+02 -1.23754982e+01 -6.67611950e+00 -6.67611950e+00
 -6.67611950e+00 -1.16369385e+00 -2.38004922e-01 -2.38004922e-01
 -2.38004922e-01  9.42727211e+00  9.14791406e+01  4.78137488e+02
  2.24762364e+03  1.14226695e+04  4.10139622e+04  1.09868807e+05
  2.54069009e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6725243192125  E_coul = 198.74269183447177
cycle= 4 E= -507.929832484741  delta_E= -3.76e-08  |g|= 8.27e-06  |ddm|= 0.000537
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.00592e-06
diis-c [-6.14579757e-12 -2.15346182e-06  2.52093104e-03 -5.05350256e-02
  1.04801625e+00]
  HOMO = -0.23800621788582  LUMO = 9.42727037051617
  mo_energy =
[-1.20311984e+02 -1.23755029e+01 -6.67612338e+00 -6.67612338e+00
 -6.67612338e+00 -1.16369457e+00 -2.38006218e-01 -2.38006218e-01
 -2.38006218e-01  9.42727037e+00  9.14791381e+01  4.78137488e+02
  2.24762364e+03  1.14226695e+04  4.10139622e+04  1.09868807e+05
  2.54069009e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6725217019764  E_coul = 198.74268921723248
cycle= 5 E= -507.929832484744  delta_E= -3.18e-12  |g|= 1.51e-07  |ddm|= 3.5e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6725217019764  E_coul = 198.74268921723248
  HOMO = -0.23800625497101  LUMO = 9.42727030020529
  mo_energy =
[-1.20311984e+02 -1.23755031e+01 -6.67612357e+00 -6.67612357e+00
 -6.67612357e+00 -1.16369459e+00 -2.38006255e-01 -2.38006255e-01
 -2.38006255e-01  9.42727030e+00  9.14791378e+01  4.78137487e+02
  2.24762364e+03  1.14226695e+04  4.10139622e+04  1.09868807e+05
  2.54069009e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6725215986098  E_coul = 198.7426891138659
Extra cycle  E= -507.929832484744  delta_E=    0  |g|= 8.16e-09  |ddm|= 8.15e-08
    CPU time for scf_cycle      4.80 sec, wall time      0.43 sec
exp = [3.96631044e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177059e+03
 1.83771598e+04 1.23895466e+03 2.98396893e+02 9.26010046e+01
 3.31042190e+01 7.87853888e+00 3.10295398e+00 8.60397107e+00
 4.93031485e-01]
E = -507.9298324847439
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396631043881       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078817        1
[INPUT] 0    0    [1    /1   ]  36755.233897         1
[INPUT] 0    0    [1    /1   ]  7331.77059291        1
[INPUT] 0    0    [1    /1   ]  18377.159799         1
[INPUT] 0    0    [1    /1   ]  1238.95466191        1
[INPUT] 0    0    [1    /1   ]  298.396893048        1
[INPUT] 0    0    [1    /1   ]  92.6010046153        1
[INPUT] 0    0    [1    /1   ]  33.104219013         1
[INPUT] 0    0    [1    /1   ]  7.87853888346        1
[INPUT] 0    0    [1    /1   ]  3.10295397847        1
[INPUT] 1    0    [1    /1   ]  8.60397106704        1
[INPUT] 1    0    [1    /1   ]  0.493031485037       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966310438808503, 1.0]], [0, [1176168.1426065618, 1.0]], [0, [588084.0713017925, 1.0]], [0, [294042.0356467487, 1.0]], [0, [147021.0177971222, 1.0]], [0, [73510.50788169993, 1.0]], [0, [36755.23389702654, 1.0]], [0, [7331.770592907304, 1.0]], [0, [18377.1597989764, 1.0]], [0, [1238.9546619115436, 1.0]], [0, [298.3968930475114, 1.0]], [0, [92.60100461534964, 1.0]], [0, [33.104219013018195, 1.0]], [0, [7.878538883462749, 1.0]], [0, [3.102953978467289, 1.0]], [1, [8.603971067040192, 1.0]], [1, [0.49303148503654887, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39663104]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130179]
bas 3, expnt(s) = [294042.03564675]
bas 4, expnt(s) = [147021.01779712]
bas 5, expnt(s) = [73510.5078817]
bas 6, expnt(s) = [36755.23389703]
bas 7, expnt(s) = [7331.77059291]
bas 8, expnt(s) = [18377.15979898]
bas 9, expnt(s) = [1238.95466191]
bas 10, expnt(s) = [298.39689305]
bas 11, expnt(s) = [92.60100462]
bas 12, expnt(s) = [33.10421901]
bas 13, expnt(s) = [7.87853888]
bas 14, expnt(s) = [3.10295398]
bas 15, expnt(s) = [8.60397107]
bas 16, expnt(s) = [0.49303149]
CPU time:       786.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96631044e-01 1.26271416e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177059e+03 2.00180456e+03
 1.83771598e+04 3.98771230e+03 1.23895466e+03 5.27602184e+02
 2.98396893e+02 1.81388917e+02 9.26010046e+01 7.54183103e+01
 3.31042190e+01 3.48680399e+01 7.87853888e+00 1.18808985e+01
 3.10295398e+00 5.90672192e+00 8.60397107e+00 4.29890719e+01
 4.93031485e-01 1.20525158e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325203172052483
cond(S) = 12536.06134977234
E1 = -689.390095137335  E_coul = 184.91848457521803
init E= -504.471610562117
    CPU time for initialize scf      4.70 sec, wall time      0.33 sec
  HOMO = -0.674513840608731  LUMO = 8.55039906125093
  mo_energy =
[-1.21699276e+02 -1.33869063e+01 -7.62751464e+00 -7.62751464e+00
 -7.62751464e+00 -1.63984814e+00 -6.74513841e-01 -6.74513841e-01
 -6.74513841e-01  8.55039906e+00  9.02054891e+01  4.76767107e+02
  2.24632331e+03  1.14215047e+04  4.10128730e+04  1.09867758e+05
  2.54067987e+05  5.48498260e+05  1.15244621e+06  2.43022895e+06
  5.37496378e+06]
E1 = -707.0628362696006  E_coul = 199.1398090487482
cycle= 1 E= -507.923027220852  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.594024
diis-c [-0.35286424  1.        ]
  HOMO = -0.232905713610223  LUMO = 9.43885988438136
  mo_energy =
[-1.20249276e+02 -1.23503826e+01 -6.64513746e+00 -6.64513746e+00
 -6.64513746e+00 -1.16107263e+00 -2.32905714e-01 -2.32905714e-01
 -2.32905714e-01  9.43885988e+00  9.15237000e+01  4.78201026e+02
  2.24770187e+03  1.14227576e+04  4.10140535e+04  1.09868900e+05
  2.54069102e+05  5.48499354e+05  1.15244729e+06  2.43023002e+06
  5.37496484e+06]
E1 = -706.6894465671772  E_coul = 198.7596281186212
cycle= 2 E= -507.929818448556  delta_E= -0.00679  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156681
diis-c [-2.38648338e-04  4.38518267e-03  9.95614817e-01]
  HOMO = -0.237750834902624  LUMO = 9.42783812884458
  mo_energy =
[-1.20309234e+02 -1.23742788e+01 -6.67464449e+00 -6.67464449e+00
 -6.67464449e+00 -1.16356833e+00 -2.37750835e-01 -2.37750835e-01
 -2.37750835e-01  9.42783813e+00  9.14811799e+01  4.78140229e+02
  2.24762681e+03  1.14226729e+04  4.10139657e+04  1.09868811e+05
  2.54069012e+05  5.48499264e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6733576714582  E_coul = 198.74352522428012
cycle= 3 E= -507.929832447178  delta_E= -1.4e-05  |g|= 0.000938  |ddm|= 0.00979
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000767525
diis-c [-1.93937494e-08  5.02648589e-05 -5.02913503e-02  1.05024109e+00]
  HOMO = -0.238004922021422  LUMO = 9.42727210959561
  mo_energy =
[-1.20311983e+02 -1.23754982e+01 -6.67611950e+00 -6.67611950e+00
 -6.67611950e+00 -1.16369385e+00 -2.38004922e-01 -2.38004922e-01
 -2.38004922e-01  9.42727211e+00  9.14791406e+01  4.78137488e+02
  2.24762364e+03  1.14226695e+04  4.10139622e+04  1.09868807e+05
  2.54069009e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6725243192125  E_coul = 198.74269183447177
cycle= 4 E= -507.929832484741  delta_E= -3.76e-08  |g|= 8.27e-06  |ddm|= 0.000537
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.00592e-06
diis-c [-6.14579757e-12 -2.15346182e-06  2.52093104e-03 -5.05350256e-02
  1.04801625e+00]
  HOMO = -0.23800621788582  LUMO = 9.42727037051617
  mo_energy =
[-1.20311984e+02 -1.23755029e+01 -6.67612338e+00 -6.67612338e+00
 -6.67612338e+00 -1.16369457e+00 -2.38006218e-01 -2.38006218e-01
 -2.38006218e-01  9.42727037e+00  9.14791381e+01  4.78137488e+02
  2.24762364e+03  1.14226695e+04  4.10139622e+04  1.09868807e+05
  2.54069009e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6725217019764  E_coul = 198.74268921723248
cycle= 5 E= -507.929832484744  delta_E= -3.18e-12  |g|= 1.51e-07  |ddm|= 3.5e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6725217019764  E_coul = 198.74268921723248
  HOMO = -0.23800625497101  LUMO = 9.42727030020529
  mo_energy =
[-1.20311984e+02 -1.23755031e+01 -6.67612357e+00 -6.67612357e+00
 -6.67612357e+00 -1.16369459e+00 -2.38006255e-01 -2.38006255e-01
 -2.38006255e-01  9.42727030e+00  9.14791378e+01  4.78137487e+02
  2.24762364e+03  1.14226695e+04  4.10139622e+04  1.09868807e+05
  2.54069009e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6725215986098  E_coul = 198.7426891138659
Extra cycle  E= -507.929832484744  delta_E=    0  |g|= 8.16e-09  |ddm|= 8.15e-08
    CPU time for scf_cycle      4.95 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12536.06134977234
E1 = -706.6725215986098  E_coul = 198.7426891138659
init E= -507.929832484744
    CPU time for initialize scf      9.22 sec, wall time      0.68 sec
  HOMO = -0.238006256803291  LUMO = 9.42727029533428
  mo_energy =
[-1.20311984e+02 -1.23755031e+01 -6.67612357e+00 -6.67612357e+00
 -6.67612357e+00 -1.16369459e+00 -2.38006257e-01 -2.38006257e-01
 -2.38006257e-01  9.42727030e+00  9.14791378e+01  4.78137487e+02
  2.24762364e+03  1.14226695e+04  4.10139622e+04  1.09868807e+05
  2.54069009e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6725215936632  E_coul = 198.7426891089198
cycle= 1 E= -507.929832484743  delta_E= 4.55e-13  |g|= 1.13e-09  |ddm|= 4.28e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6725215936632  E_coul = 198.7426891089198
  HOMO = -0.238006256898144  LUMO = 9.42727029502974
  mo_energy =
[-1.20311984e+02 -1.23755031e+01 -6.67612357e+00 -6.67612357e+00
 -6.67612357e+00 -1.16369459e+00 -2.38006257e-01 -2.38006257e-01
 -2.38006257e-01  9.42727030e+00  9.14791378e+01  4.78137487e+02
  2.24762364e+03  1.14226695e+04  4.10139622e+04  1.09868807e+05
  2.54069009e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6725215933883  E_coul = 198.74268910864456
Extra cycle  E= -507.929832484744  delta_E= -3.41e-13  |g|= 7.94e-10  |ddm|= 2.13e-10
    CPU time for scf_cycle      9.41 sec, wall time      0.76 sec
exp = [3.96631044e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177059e+03
 1.83771598e+04 1.23895466e+03 2.98396893e+02 9.26010046e+01
 3.31042190e+01 7.87853888e+00 3.10295398e+00 8.60397107e+00
 4.93031485e-01]
grad_E = [-4.82571145e-04 -2.41077548e-11  3.82771100e-10  1.27005522e-09
  7.57629065e-09  2.46321290e-08  1.52173244e-07  8.28730822e-06
  3.66171331e-07  5.40865494e-05 -5.99739907e-04 -8.79679810e-05
  2.22876230e-04 -4.06314453e-05  1.39952158e-04 -3.50277239e-04
 -1.02470999e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396679680217       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.507882         1
[INPUT] 0    0    [1    /1   ]  36755.2338991        1
[INPUT] 0    0    [1    /1   ]  7331.77070639        1
[INPUT] 0    0    [1    /1   ]  18377.159804         1
[INPUT] 0    0    [1    /1   ]  1238.95501569        1
[INPUT] 0    0    [1    /1   ]  298.392519321        1
[INPUT] 0    0    [1    /1   ]  92.6001814379        1
[INPUT] 0    0    [1    /1   ]  33.0765614295        1
[INPUT] 0    0    [1    /1   ]  7.8776144762         1
[INPUT] 0    0    [1    /1   ]  3.10109175134        1
[INPUT] 1    0    [1    /1   ]  8.60459466128        1
[INPUT] 1    0    [1    /1   ]  0.493083169241       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966796802169363, 1.0]], [0, [1176168.1426065615, 1.0]], [0, [588084.0713017978, 1.0]], [0, [294042.0356467662, 1.0]], [0, [147021.01779722553, 1.0]], [0, [73510.50788203818, 1.0]], [0, [36755.233899101666, 1.0]], [0, [7331.770706385441, 1.0]], [0, [18377.15980404102, 1.0]], [0, [1238.9550156892913, 1.0]], [0, [298.3925193206887, 1.0]], [0, [92.60018143793903, 1.0]], [0, [33.07656142953855, 1.0]], [0, [7.8776144761981115, 1.0]], [0, [3.101091751336337, 1.0]], [1, [8.604594661282034, 1.0]], [1, [0.4930831692406805, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39667968]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.0713018]
bas 3, expnt(s) = [294042.03564677]
bas 4, expnt(s) = [147021.01779723]
bas 5, expnt(s) = [73510.50788204]
bas 6, expnt(s) = [36755.2338991]
bas 7, expnt(s) = [7331.77070639]
bas 8, expnt(s) = [18377.15980404]
bas 9, expnt(s) = [1238.95501569]
bas 10, expnt(s) = [298.39251932]
bas 11, expnt(s) = [92.60018144]
bas 12, expnt(s) = [33.07656143]
bas 13, expnt(s) = [7.87761448]
bas 14, expnt(s) = [3.10109175]
bas 15, expnt(s) = [8.60459466]
bas 16, expnt(s) = [0.49308317]
CPU time:       803.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96679680e-01 1.26283029e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177071e+03 2.00180459e+03
 1.83771598e+04 3.98771230e+03 1.23895502e+03 5.27602297e+02
 2.98392519e+02 1.81386923e+02 9.26001814e+01 7.54178075e+01
 3.30765614e+01 3.48461892e+01 7.87761448e+00 1.18798530e+01
 3.10109175e+00 5.90406304e+00 8.60459466e+00 4.29929666e+01
 4.93083169e-01 1.20540952e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325127954657166
cond(S) = 12536.027155442387
E1 = -689.3955897408974  E_coul = 184.92322956727588
init E= -504.472360173622
    CPU time for initialize scf      4.40 sec, wall time      0.33 sec
  HOMO = -0.674448361206597  LUMO = 8.54420097021611
  mo_energy =
[-1.21698529e+02 -1.33865246e+01 -7.62719527e+00 -7.62719527e+00
 -7.62719527e+00 -1.63977982e+00 -6.74448361e-01 -6.74448361e-01
 -6.74448361e-01  8.54420097e+00  9.01457426e+01  4.76651520e+02
  2.24619757e+03  1.14213917e+04  4.10127686e+04  1.09867658e+05
  2.54067891e+05  5.48498166e+05  1.15244612e+06  2.43022886e+06
  5.37496369e+06]
E1 = -707.068893315799  E_coul = 199.1458695649001
cycle= 1 E= -507.923023750899  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.594041
diis-c [-0.35288462  1.        ]
  HOMO = -0.23277160729904  LUMO = 9.43255171329418
  mo_energy =
[-1.20248456e+02 -1.23499144e+01 -6.64473260e+00 -6.64473260e+00
 -6.64473260e+00 -1.16094787e+00 -2.32771607e-01 -2.32771607e-01
 -2.32771607e-01  9.43255171e+00  9.14639293e+01  4.78085491e+02
  2.24757619e+03  1.14226446e+04  4.10139492e+04  1.09868800e+05
  2.54069005e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6952349870323  E_coul = 198.76541424486632
cycle= 2 E= -507.929820742166  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156753
diis-c [-2.38886178e-04  4.38122457e-03  9.95618775e-01]
  HOMO = -0.237622058261509  LUMO = 9.42152602922842
  mo_energy =
[-1.20308449e+02 -1.23738293e+01 -6.67426167e+00 -6.67426167e+00
 -6.67426167e+00 -1.16344636e+00 -2.37622058e-01 -2.37622058e-01
 -2.37622058e-01  9.42152603e+00  9.14213901e+01  4.78024660e+02
  2.24750109e+03  1.14225599e+04  4.10138613e+04  1.09868711e+05
  2.54068916e+05  5.48499171e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6791287630497  E_coul = 198.74929399956176
cycle= 3 E= -507.929834763488  delta_E= -1.4e-05  |g|= 0.000939  |ddm|= 0.0098
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000767951
diis-c [-1.94841377e-08  5.03419400e-05 -5.02932407e-02  1.05024290e+00]
  HOMO = -0.237876499974348  LUMO = 9.42095964062641
  mo_energy =
[-1.20311200e+02 -1.23750500e+01 -6.67573814e+00 -6.67573814e+00
 -6.67573814e+00 -1.16357206e+00 -2.37876500e-01 -2.37876500e-01
 -2.37876500e-01  9.42095964e+00  9.14193494e+01  4.78021918e+02
  2.24749791e+03  1.14225565e+04  4.10138578e+04  1.09868707e+05
  2.54068912e+05  5.48499167e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6782942761907  E_coul = 198.74845947505355
cycle= 4 E= -507.929834801137  delta_E= -3.76e-08  |g|= 8.3e-06  |ddm|= 0.000538
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.02646e-06
diis-c [-6.16609234e-12 -2.15821157e-06  2.52341371e-03 -5.05867151e-02
  1.04806546e+00]
  HOMO = -0.237877801948587  LUMO = 9.4209578904613
  mo_energy =
[-1.20311201e+02 -1.23750547e+01 -6.67574205e+00 -6.67574205e+00
 -6.67574205e+00 -1.16357279e+00 -2.37877802e-01 -2.37877802e-01
 -2.37877802e-01  9.42095789e+00  9.14193468e+01  4.78021917e+02
  2.24749791e+03  1.14225565e+04  4.10138578e+04  1.09868707e+05
  2.54068912e+05  5.48499167e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6782916422765  E_coul = 198.74845684113677
cycle= 5 E= -507.92983480114  delta_E= -2.5e-12  |g|= 1.51e-07  |ddm|= 3.51e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6782916422765  E_coul = 198.74845684113677
  HOMO = -0.237877839079731  LUMO = 9.42095781868246
  mo_energy =
[-1.20311201e+02 -1.23750549e+01 -6.67574223e+00 -6.67574223e+00
 -6.67574223e+00 -1.16357281e+00 -2.37877839e-01 -2.37877839e-01
 -2.37877839e-01  9.42095782e+00  9.14193465e+01  4.78021917e+02
  2.24749791e+03  1.14225565e+04  4.10138578e+04  1.09868707e+05
  2.54068912e+05  5.48499167e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6782915387663  E_coul = 198.74845673762613
Extra cycle  E= -507.92983480114  delta_E= -4.55e-13  |g|= 8.05e-09  |ddm|= 8.16e-08
    CPU time for scf_cycle      4.63 sec, wall time      0.41 sec
exp = [3.96679680e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177071e+03
 1.83771598e+04 1.23895502e+03 2.98392519e+02 9.26001814e+01
 3.30765614e+01 7.87761448e+00 3.10109175e+00 8.60459466e+00
 4.93083169e-01]
E = -507.92983480114015
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396679680217       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.507882         1
[INPUT] 0    0    [1    /1   ]  36755.2338991        1
[INPUT] 0    0    [1    /1   ]  7331.77070639        1
[INPUT] 0    0    [1    /1   ]  18377.159804         1
[INPUT] 0    0    [1    /1   ]  1238.95501569        1
[INPUT] 0    0    [1    /1   ]  298.392519321        1
[INPUT] 0    0    [1    /1   ]  92.6001814379        1
[INPUT] 0    0    [1    /1   ]  33.0765614295        1
[INPUT] 0    0    [1    /1   ]  7.8776144762         1
[INPUT] 0    0    [1    /1   ]  3.10109175134        1
[INPUT] 1    0    [1    /1   ]  8.60459466128        1
[INPUT] 1    0    [1    /1   ]  0.493083169241       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966796802169363, 1.0]], [0, [1176168.1426065615, 1.0]], [0, [588084.0713017978, 1.0]], [0, [294042.0356467662, 1.0]], [0, [147021.01779722553, 1.0]], [0, [73510.50788203818, 1.0]], [0, [36755.233899101666, 1.0]], [0, [7331.770706385441, 1.0]], [0, [18377.15980404102, 1.0]], [0, [1238.9550156892913, 1.0]], [0, [298.3925193206887, 1.0]], [0, [92.60018143793903, 1.0]], [0, [33.07656142953855, 1.0]], [0, [7.8776144761981115, 1.0]], [0, [3.101091751336337, 1.0]], [1, [8.604594661282034, 1.0]], [1, [0.4930831692406805, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39667968]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.0713018]
bas 3, expnt(s) = [294042.03564677]
bas 4, expnt(s) = [147021.01779723]
bas 5, expnt(s) = [73510.50788204]
bas 6, expnt(s) = [36755.2338991]
bas 7, expnt(s) = [7331.77070639]
bas 8, expnt(s) = [18377.15980404]
bas 9, expnt(s) = [1238.95501569]
bas 10, expnt(s) = [298.39251932]
bas 11, expnt(s) = [92.60018144]
bas 12, expnt(s) = [33.07656143]
bas 13, expnt(s) = [7.87761448]
bas 14, expnt(s) = [3.10109175]
bas 15, expnt(s) = [8.60459466]
bas 16, expnt(s) = [0.49308317]
CPU time:       808.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96679680e-01 1.26283029e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177071e+03 2.00180459e+03
 1.83771598e+04 3.98771230e+03 1.23895502e+03 5.27602297e+02
 2.98392519e+02 1.81386923e+02 9.26001814e+01 7.54178075e+01
 3.30765614e+01 3.48461892e+01 7.87761448e+00 1.18798530e+01
 3.10109175e+00 5.90406304e+00 8.60459466e+00 4.29929666e+01
 4.93083169e-01 1.20540952e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325127954657166
cond(S) = 12536.027155442387
E1 = -689.3955897408974  E_coul = 184.92322956727588
init E= -504.472360173622
    CPU time for initialize scf      4.66 sec, wall time      0.35 sec
  HOMO = -0.674448361206597  LUMO = 8.54420097021611
  mo_energy =
[-1.21698529e+02 -1.33865246e+01 -7.62719527e+00 -7.62719527e+00
 -7.62719527e+00 -1.63977982e+00 -6.74448361e-01 -6.74448361e-01
 -6.74448361e-01  8.54420097e+00  9.01457426e+01  4.76651520e+02
  2.24619757e+03  1.14213917e+04  4.10127686e+04  1.09867658e+05
  2.54067891e+05  5.48498166e+05  1.15244612e+06  2.43022886e+06
  5.37496369e+06]
E1 = -707.068893315799  E_coul = 199.1458695649001
cycle= 1 E= -507.923023750899  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.594041
diis-c [-0.35288462  1.        ]
  HOMO = -0.23277160729904  LUMO = 9.43255171329418
  mo_energy =
[-1.20248456e+02 -1.23499144e+01 -6.64473260e+00 -6.64473260e+00
 -6.64473260e+00 -1.16094787e+00 -2.32771607e-01 -2.32771607e-01
 -2.32771607e-01  9.43255171e+00  9.14639293e+01  4.78085491e+02
  2.24757619e+03  1.14226446e+04  4.10139492e+04  1.09868800e+05
  2.54069005e+05  5.48499261e+05  1.15244720e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6952349870323  E_coul = 198.76541424486632
cycle= 2 E= -507.929820742166  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156753
diis-c [-2.38886178e-04  4.38122457e-03  9.95618775e-01]
  HOMO = -0.237622058261509  LUMO = 9.42152602922842
  mo_energy =
[-1.20308449e+02 -1.23738293e+01 -6.67426167e+00 -6.67426167e+00
 -6.67426167e+00 -1.16344636e+00 -2.37622058e-01 -2.37622058e-01
 -2.37622058e-01  9.42152603e+00  9.14213901e+01  4.78024660e+02
  2.24750109e+03  1.14225599e+04  4.10138613e+04  1.09868711e+05
  2.54068916e+05  5.48499171e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6791287630497  E_coul = 198.74929399956176
cycle= 3 E= -507.929834763488  delta_E= -1.4e-05  |g|= 0.000939  |ddm|= 0.0098
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000767951
diis-c [-1.94841377e-08  5.03419400e-05 -5.02932407e-02  1.05024290e+00]
  HOMO = -0.237876499974348  LUMO = 9.42095964062641
  mo_energy =
[-1.20311200e+02 -1.23750500e+01 -6.67573814e+00 -6.67573814e+00
 -6.67573814e+00 -1.16357206e+00 -2.37876500e-01 -2.37876500e-01
 -2.37876500e-01  9.42095964e+00  9.14193494e+01  4.78021918e+02
  2.24749791e+03  1.14225565e+04  4.10138578e+04  1.09868707e+05
  2.54068912e+05  5.48499167e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6782942761907  E_coul = 198.74845947505355
cycle= 4 E= -507.929834801137  delta_E= -3.76e-08  |g|= 8.3e-06  |ddm|= 0.000538
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.02646e-06
diis-c [-6.16609234e-12 -2.15821157e-06  2.52341371e-03 -5.05867151e-02
  1.04806546e+00]
  HOMO = -0.237877801948587  LUMO = 9.4209578904613
  mo_energy =
[-1.20311201e+02 -1.23750547e+01 -6.67574205e+00 -6.67574205e+00
 -6.67574205e+00 -1.16357279e+00 -2.37877802e-01 -2.37877802e-01
 -2.37877802e-01  9.42095789e+00  9.14193468e+01  4.78021917e+02
  2.24749791e+03  1.14225565e+04  4.10138578e+04  1.09868707e+05
  2.54068912e+05  5.48499167e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6782916422765  E_coul = 198.74845684113677
cycle= 5 E= -507.92983480114  delta_E= -2.5e-12  |g|= 1.51e-07  |ddm|= 3.51e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6782916422765  E_coul = 198.74845684113677
  HOMO = -0.237877839079731  LUMO = 9.42095781868246
  mo_energy =
[-1.20311201e+02 -1.23750549e+01 -6.67574223e+00 -6.67574223e+00
 -6.67574223e+00 -1.16357281e+00 -2.37877839e-01 -2.37877839e-01
 -2.37877839e-01  9.42095782e+00  9.14193465e+01  4.78021917e+02
  2.24749791e+03  1.14225565e+04  4.10138578e+04  1.09868707e+05
  2.54068912e+05  5.48499167e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6782915387663  E_coul = 198.74845673762613
Extra cycle  E= -507.92983480114  delta_E= -4.55e-13  |g|= 8.05e-09  |ddm|= 8.16e-08
    CPU time for scf_cycle      4.74 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12536.027155442387
E1 = -706.6782915387663  E_coul = 198.74845673762613
init E= -507.92983480114
    CPU time for initialize scf     10.05 sec, wall time      0.68 sec
  HOMO = -0.237877840915297  LUMO = 9.4209578150102
  mo_energy =
[-1.20311201e+02 -1.23750549e+01 -6.67574224e+00 -6.67574224e+00
 -6.67574224e+00 -1.16357281e+00 -2.37877841e-01 -2.37877841e-01
 -2.37877841e-01  9.42095782e+00  9.14193465e+01  4.78021917e+02
  2.24749791e+03  1.14225565e+04  4.10138578e+04  1.09868707e+05
  2.54068912e+05  5.48499167e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.678291533808  E_coul = 198.74845673266825
cycle= 1 E= -507.92983480114  delta_E= 4.55e-13  |g|= 8.45e-10  |ddm|= 4.24e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.678291533808  E_coul = 198.74845673266825
  HOMO = -0.237877841009487  LUMO = 9.4209578147927
  mo_energy =
[-1.20311201e+02 -1.23750549e+01 -6.67574224e+00 -6.67574224e+00
 -6.67574224e+00 -1.16357281e+00 -2.37877841e-01 -2.37877841e-01
 -2.37877841e-01  9.42095781e+00  9.14193465e+01  4.78021917e+02
  2.24749791e+03  1.14225565e+04  4.10138578e+04  1.09868707e+05
  2.54068912e+05  5.48499167e+05  1.15244711e+06  2.43022984e+06
  5.37496466e+06]
E1 = -706.6782915336092  E_coul = 198.7484567324695
Extra cycle  E= -507.92983480114  delta_E= -5.68e-14  |g|= 9.29e-10  |ddm|= 2.01e-10
    CPU time for scf_cycle     10.12 sec, wall time      0.75 sec
exp = [3.96679680e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177071e+03
 1.83771598e+04 1.23895502e+03 2.98392519e+02 9.26001814e+01
 3.30765614e+01 7.87761448e+00 3.10109175e+00 8.60459466e+00
 4.93083169e-01]
grad_E = [ 1.61056432e-04 -2.41677278e-11  3.82359947e-10  1.26849280e-09
  7.56848324e-09  2.46026478e-08  1.52017550e-07  8.27785658e-06
  3.65666924e-07  5.48012951e-05 -6.09658381e-04 -3.70418766e-05
  1.26317156e-04  1.04409344e-06 -1.26496174e-05  1.06777001e-04
  2.80032135e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396680252548       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078822        1
[INPUT] 0    0    [1    /1   ]  36755.2339002        1
[INPUT] 0    0    [1    /1   ]  7331.7707672         1
[INPUT] 0    0    [1    /1   ]  18377.1598068        1
[INPUT] 0    0    [1    /1   ]  1238.95506668        1
[INPUT] 0    0    [1    /1   ]  298.391926935        1
[INPUT] 0    0    [1    /1   ]  92.5939562579        1
[INPUT] 0    0    [1    /1   ]  33.0669566406        1
[INPUT] 0    0    [1    /1   ]  7.87668950237        1
[INPUT] 0    0    [1    /1   ]  3.10054326398        1
[INPUT] 1    0    [1    /1   ]  8.604598398          1
[INPUT] 1    0    [1    /1   ]  0.493084165133       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39668025254765055, 1.0]], [0, [1176168.1426065613, 1.0]], [0, [588084.0713018005, 1.0]], [0, [294042.03564677556, 1.0]], [0, [147021.01779728077, 1.0]], [0, [73510.5078822198, 1.0]], [0, [36755.233900210784, 1.0]], [0, [7331.770767199436, 1.0]], [0, [18377.1598067734, 1.0]], [0, [1238.9550666846144, 1.0]], [0, [298.3919269351134, 1.0]], [0, [92.59395625788264, 1.0]], [0, [33.06695664060519, 1.0]], [0, [7.876689502370237, 1.0]], [0, [3.1005432639768125, 1.0]], [1, [8.604598397997657, 1.0]], [1, [0.49308416513292835, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39668025]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.0713018]
bas 3, expnt(s) = [294042.03564678]
bas 4, expnt(s) = [147021.01779728]
bas 5, expnt(s) = [73510.50788222]
bas 6, expnt(s) = [36755.23390021]
bas 7, expnt(s) = [7331.7707672]
bas 8, expnt(s) = [18377.15980677]
bas 9, expnt(s) = [1238.95506668]
bas 10, expnt(s) = [298.39192694]
bas 11, expnt(s) = [92.59395626]
bas 12, expnt(s) = [33.06695664]
bas 13, expnt(s) = [7.8766895]
bas 14, expnt(s) = [3.10054326]
bas 15, expnt(s) = [8.6045984]
bas 16, expnt(s) = [0.49308417]
CPU time:       825.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96680253e-01 1.26283166e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177077e+03 2.00180460e+03
 1.83771598e+04 3.98771230e+03 1.23895507e+03 5.27602314e+02
 2.98391927e+02 1.81386653e+02 9.25939563e+01 7.54140049e+01
 3.30669566e+01 3.48385999e+01 7.87668950e+00 1.18788068e+01
 3.10054326e+00 5.90327984e+00 8.60459840e+00 4.29929900e+01
 4.93084165e-01 1.20541256e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325126936369507
cond(S) = 12536.010552963064
E1 = -689.3957402587657  E_coul = 184.92329059744057
init E= -504.472449661325
    CPU time for initialize scf      4.81 sec, wall time      0.34 sec
  HOMO = -0.67444709800678  LUMO = 8.5415816452154
  mo_energy =
[-1.21698523e+02 -1.33865184e+01 -7.62719124e+00 -7.62719124e+00
 -7.62719124e+00 -1.63977643e+00 -6.74447098e-01 -6.74447098e-01
 -6.74447098e-01  8.54158165e+00  9.01205212e+01  4.76595162e+02
  2.24613289e+03  1.14213335e+04  4.10127148e+04  1.09867607e+05
  2.54067841e+05  5.48498118e+05  1.15244607e+06  2.43022882e+06
  5.37496365e+06]
E1 = -707.068942590948  E_coul = 199.14592022163785
cycle= 1 E= -507.92302236931  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.594039
diis-c [-0.35288248  1.        ]
  HOMO = -0.232769331012414  LUMO = 9.42985694338253
  mo_energy =
[-1.20248461e+02 -1.23499075e+01 -6.64472865e+00 -6.64472865e+00
 -6.64472865e+00 -1.16094375e+00 -2.32769331e-01 -2.32769331e-01
 -2.32769331e-01  9.42985694e+00  9.14386615e+01  4.78029118e+02
  2.24751149e+03  1.14225864e+04  4.10138954e+04  1.09868749e+05
  2.54068956e+05  5.48499213e+05  1.15244715e+06  2.43022989e+06
  5.37496471e+06]
E1 = -706.6951930940161  E_coul = 198.76537183465015
cycle= 2 E= -507.929821259366  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156771
diis-c [-2.38945839e-04  4.37985598e-03  9.95620144e-01]
  HOMO = -0.237621569254321  LUMO = 9.41883016339003
  mo_energy =
[-1.20308464e+02 -1.23738292e+01 -6.67426531e+00 -6.67426531e+00
 -6.67426531e+00 -1.16344329e+00 -2.37621569e-01 -2.37621569e-01
 -2.37621569e-01  9.41883016e+00  9.13961169e+01  4.77968276e+02
  2.24743638e+03  1.14225017e+04  4.10138075e+04  1.09868659e+05
  2.54068866e+05  5.48499122e+05  1.15244706e+06  2.43022980e+06
  5.37496462e+06]
E1 = -706.6790803655423  E_coul = 198.74924507604766
cycle= 3 E= -507.929835289495  delta_E= -1.4e-05  |g|= 0.000939  |ddm|= 0.0098
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000768079
diis-c [-1.95173831e-08  5.03786485e-05 -5.02948367e-02  1.05024446e+00]
  HOMO = -0.23787614048781  LUMO = 9.41826363635211
  mo_energy =
[-1.20311216e+02 -1.23750505e+01 -6.67574232e+00 -6.67574232e+00
 -6.67574232e+00 -1.16356907e+00 -2.37876140e-01 -2.37876140e-01
 -2.37876140e-01  9.41826364e+00  9.13940757e+01  4.77965533e+02
  2.24743320e+03  1.14224983e+04  4.10138039e+04  1.09868656e+05
  2.54068862e+05  5.48499119e+05  1.15244706e+06  2.43022979e+06
  5.37496462e+06]
E1 = -706.6782454293497  E_coul = 198.74841010216994
cycle= 4 E= -507.92983532718  delta_E= -3.77e-08  |g|= 8.3e-06  |ddm|= 0.000538
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.0335e-06
diis-c [-6.17249745e-12 -2.15630888e-06  2.52422479e-03 -5.06047903e-02
  1.04808272e+00]
  HOMO = -0.237877444933782  LUMO = 9.41826188426842
  mo_energy =
[-1.20311217e+02 -1.23750552e+01 -6.67574624e+00 -6.67574624e+00
 -6.67574624e+00 -1.16356979e+00 -2.37877445e-01 -2.37877445e-01
 -2.37877445e-01  9.41826188e+00  9.13940731e+01  4.77965532e+02
  2.24743320e+03  1.14224983e+04  4.10138039e+04  1.09868656e+05
  2.54068862e+05  5.48499119e+05  1.15244706e+06  2.43022979e+06
  5.37496462e+06]
E1 = -706.678242788641  E_coul = 198.74840746145853
cycle= 5 E= -507.929835327182  delta_E= -2.73e-12  |g|= 1.51e-07  |ddm|= 3.52e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.678242788641  E_coul = 198.74840746145853
  HOMO = -0.237877482081507  LUMO = 9.41826181217767
  mo_energy =
[-1.20311217e+02 -1.23750554e+01 -6.67574643e+00 -6.67574643e+00
 -6.67574643e+00 -1.16356981e+00 -2.37877482e-01 -2.37877482e-01
 -2.37877482e-01  9.41826181e+00  9.13940729e+01  4.77965532e+02
  2.24743320e+03  1.14224983e+04  4.10138039e+04  1.09868656e+05
  2.54068862e+05  5.48499119e+05  1.15244706e+06  2.43022979e+06
  5.37496462e+06]
E1 = -706.6782426849616  E_coul = 198.7484073577792
Extra cycle  E= -507.929835327182  delta_E= 1.14e-13  |g|= 8.07e-09  |ddm|= 8.17e-08
    CPU time for scf_cycle      5.04 sec, wall time      0.41 sec
exp = [3.96680253e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177077e+03
 1.83771598e+04 1.23895507e+03 2.98391927e+02 9.25939563e+01
 3.30669566e+01 7.87668950e+00 3.10054326e+00 8.60459840e+00
 4.93084165e-01]
E = -507.92983532718233
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396680252548       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078822        1
[INPUT] 0    0    [1    /1   ]  36755.2339002        1
[INPUT] 0    0    [1    /1   ]  7331.7707672         1
[INPUT] 0    0    [1    /1   ]  18377.1598068        1
[INPUT] 0    0    [1    /1   ]  1238.95506668        1
[INPUT] 0    0    [1    /1   ]  298.391926935        1
[INPUT] 0    0    [1    /1   ]  92.5939562579        1
[INPUT] 0    0    [1    /1   ]  33.0669566406        1
[INPUT] 0    0    [1    /1   ]  7.87668950237        1
[INPUT] 0    0    [1    /1   ]  3.10054326398        1
[INPUT] 1    0    [1    /1   ]  8.604598398          1
[INPUT] 1    0    [1    /1   ]  0.493084165133       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39668025254765055, 1.0]], [0, [1176168.1426065613, 1.0]], [0, [588084.0713018005, 1.0]], [0, [294042.03564677556, 1.0]], [0, [147021.01779728077, 1.0]], [0, [73510.5078822198, 1.0]], [0, [36755.233900210784, 1.0]], [0, [7331.770767199436, 1.0]], [0, [18377.1598067734, 1.0]], [0, [1238.9550666846144, 1.0]], [0, [298.3919269351134, 1.0]], [0, [92.59395625788264, 1.0]], [0, [33.06695664060519, 1.0]], [0, [7.876689502370237, 1.0]], [0, [3.1005432639768125, 1.0]], [1, [8.604598397997657, 1.0]], [1, [0.49308416513292835, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39668025]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.0713018]
bas 3, expnt(s) = [294042.03564678]
bas 4, expnt(s) = [147021.01779728]
bas 5, expnt(s) = [73510.50788222]
bas 6, expnt(s) = [36755.23390021]
bas 7, expnt(s) = [7331.7707672]
bas 8, expnt(s) = [18377.15980677]
bas 9, expnt(s) = [1238.95506668]
bas 10, expnt(s) = [298.39192694]
bas 11, expnt(s) = [92.59395626]
bas 12, expnt(s) = [33.06695664]
bas 13, expnt(s) = [7.8766895]
bas 14, expnt(s) = [3.10054326]
bas 15, expnt(s) = [8.6045984]
bas 16, expnt(s) = [0.49308417]
CPU time:       830.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96680253e-01 1.26283166e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177077e+03 2.00180460e+03
 1.83771598e+04 3.98771230e+03 1.23895507e+03 5.27602314e+02
 2.98391927e+02 1.81386653e+02 9.25939563e+01 7.54140049e+01
 3.30669566e+01 3.48385999e+01 7.87668950e+00 1.18788068e+01
 3.10054326e+00 5.90327984e+00 8.60459840e+00 4.29929900e+01
 4.93084165e-01 1.20541256e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325126936369507
cond(S) = 12536.010552963064
E1 = -689.3957402587657  E_coul = 184.92329059744057
init E= -504.472449661325
    CPU time for initialize scf      4.87 sec, wall time      0.34 sec
  HOMO = -0.67444709800678  LUMO = 8.5415816452154
  mo_energy =
[-1.21698523e+02 -1.33865184e+01 -7.62719124e+00 -7.62719124e+00
 -7.62719124e+00 -1.63977643e+00 -6.74447098e-01 -6.74447098e-01
 -6.74447098e-01  8.54158165e+00  9.01205212e+01  4.76595162e+02
  2.24613289e+03  1.14213335e+04  4.10127148e+04  1.09867607e+05
  2.54067841e+05  5.48498118e+05  1.15244607e+06  2.43022882e+06
  5.37496365e+06]
E1 = -707.068942590948  E_coul = 199.14592022163785
cycle= 1 E= -507.92302236931  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.594039
diis-c [-0.35288248  1.        ]
  HOMO = -0.232769331012414  LUMO = 9.42985694338253
  mo_energy =
[-1.20248461e+02 -1.23499075e+01 -6.64472865e+00 -6.64472865e+00
 -6.64472865e+00 -1.16094375e+00 -2.32769331e-01 -2.32769331e-01
 -2.32769331e-01  9.42985694e+00  9.14386615e+01  4.78029118e+02
  2.24751149e+03  1.14225864e+04  4.10138954e+04  1.09868749e+05
  2.54068956e+05  5.48499213e+05  1.15244715e+06  2.43022989e+06
  5.37496471e+06]
E1 = -706.6951930940161  E_coul = 198.76537183465015
cycle= 2 E= -507.929821259366  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156771
diis-c [-2.38945839e-04  4.37985598e-03  9.95620144e-01]
  HOMO = -0.237621569254321  LUMO = 9.41883016339003
  mo_energy =
[-1.20308464e+02 -1.23738292e+01 -6.67426531e+00 -6.67426531e+00
 -6.67426531e+00 -1.16344329e+00 -2.37621569e-01 -2.37621569e-01
 -2.37621569e-01  9.41883016e+00  9.13961169e+01  4.77968276e+02
  2.24743638e+03  1.14225017e+04  4.10138075e+04  1.09868659e+05
  2.54068866e+05  5.48499122e+05  1.15244706e+06  2.43022980e+06
  5.37496462e+06]
E1 = -706.6790803655423  E_coul = 198.74924507604766
cycle= 3 E= -507.929835289495  delta_E= -1.4e-05  |g|= 0.000939  |ddm|= 0.0098
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000768079
diis-c [-1.95173831e-08  5.03786485e-05 -5.02948367e-02  1.05024446e+00]
  HOMO = -0.23787614048781  LUMO = 9.41826363635211
  mo_energy =
[-1.20311216e+02 -1.23750505e+01 -6.67574232e+00 -6.67574232e+00
 -6.67574232e+00 -1.16356907e+00 -2.37876140e-01 -2.37876140e-01
 -2.37876140e-01  9.41826364e+00  9.13940757e+01  4.77965533e+02
  2.24743320e+03  1.14224983e+04  4.10138039e+04  1.09868656e+05
  2.54068862e+05  5.48499119e+05  1.15244706e+06  2.43022979e+06
  5.37496462e+06]
E1 = -706.6782454293497  E_coul = 198.74841010216994
cycle= 4 E= -507.92983532718  delta_E= -3.77e-08  |g|= 8.3e-06  |ddm|= 0.000538
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.0335e-06
diis-c [-6.17249745e-12 -2.15630888e-06  2.52422479e-03 -5.06047903e-02
  1.04808272e+00]
  HOMO = -0.237877444933782  LUMO = 9.41826188426842
  mo_energy =
[-1.20311217e+02 -1.23750552e+01 -6.67574624e+00 -6.67574624e+00
 -6.67574624e+00 -1.16356979e+00 -2.37877445e-01 -2.37877445e-01
 -2.37877445e-01  9.41826188e+00  9.13940731e+01  4.77965532e+02
  2.24743320e+03  1.14224983e+04  4.10138039e+04  1.09868656e+05
  2.54068862e+05  5.48499119e+05  1.15244706e+06  2.43022979e+06
  5.37496462e+06]
E1 = -706.678242788641  E_coul = 198.74840746145853
cycle= 5 E= -507.929835327182  delta_E= -2.73e-12  |g|= 1.51e-07  |ddm|= 3.52e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.678242788641  E_coul = 198.74840746145853
  HOMO = -0.237877482081507  LUMO = 9.41826181217767
  mo_energy =
[-1.20311217e+02 -1.23750554e+01 -6.67574643e+00 -6.67574643e+00
 -6.67574643e+00 -1.16356981e+00 -2.37877482e-01 -2.37877482e-01
 -2.37877482e-01  9.41826181e+00  9.13940729e+01  4.77965532e+02
  2.24743320e+03  1.14224983e+04  4.10138039e+04  1.09868656e+05
  2.54068862e+05  5.48499119e+05  1.15244706e+06  2.43022979e+06
  5.37496462e+06]
E1 = -706.6782426849616  E_coul = 198.7484073577792
Extra cycle  E= -507.929835327182  delta_E= 1.14e-13  |g|= 8.07e-09  |ddm|= 8.17e-08
    CPU time for scf_cycle      5.11 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12536.010552963064
E1 = -706.6782426849616  E_coul = 198.7484073577792
init E= -507.929835327182
    CPU time for initialize scf     10.16 sec, wall time      0.68 sec
  HOMO = -0.237877483918928  LUMO = 9.41826180671464
  mo_energy =
[-1.20311217e+02 -1.23750554e+01 -6.67574643e+00 -6.67574643e+00
 -6.67574643e+00 -1.16356981e+00 -2.37877484e-01 -2.37877484e-01
 -2.37877484e-01  9.41826181e+00  9.13940729e+01  4.77965532e+02
  2.24743320e+03  1.14224983e+04  4.10138039e+04  1.09868656e+05
  2.54068862e+05  5.48499119e+05  1.15244706e+06  2.43022979e+06
  5.37496462e+06]
E1 = -706.6782426800453  E_coul = 198.74840735286267
cycle= 1 E= -507.929835327183  delta_E= -2.84e-13  |g|= 1.17e-09  |ddm|= 4.25e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6782426800453  E_coul = 198.74840735286267
  HOMO = -0.237877484013189  LUMO = 9.41826180782989
  mo_energy =
[-1.20311217e+02 -1.23750554e+01 -6.67574643e+00 -6.67574643e+00
 -6.67574643e+00 -1.16356981e+00 -2.37877484e-01 -2.37877484e-01
 -2.37877484e-01  9.41826181e+00  9.13940729e+01  4.77965532e+02
  2.24743320e+03  1.14224983e+04  4.10138039e+04  1.09868656e+05
  2.54068862e+05  5.48499119e+05  1.15244706e+06  2.43022979e+06
  5.37496462e+06]
E1 = -706.6782426798126  E_coul = 198.7484073526302
Extra cycle  E= -507.929835327182  delta_E= 2.84e-13  |g|= 1.16e-09  |ddm|= 2.06e-10
    CPU time for scf_cycle     10.32 sec, wall time      0.75 sec
exp = [3.96680253e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177077e+03
 1.83771598e+04 1.23895507e+03 2.98391927e+02 9.25939563e+01
 3.30669566e+01 7.87668950e+00 3.10054326e+00 8.60459840e+00
 4.93084165e-01]
grad_E = [ 1.50729507e-04 -2.41737849e-11  3.82318105e-10  1.26833396e-09
  7.56768853e-09  2.45996503e-08  1.52001694e-07  8.27688609e-06
  3.65615688e-07  5.48799166e-05 -6.11046416e-04 -2.71619587e-05
  1.02957125e-04  3.35660802e-07 -2.45189238e-05  1.05006489e-04
  2.97765259e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396674600024       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078826        1
[INPUT] 0    0    [1    /1   ]  36755.2339024        1
[INPUT] 0    0    [1    /1   ]  7331.77088765        1
[INPUT] 0    0    [1    /1   ]  18377.1598122        1
[INPUT] 0    0    [1    /1   ]  1238.95498086        1
[INPUT] 0    0    [1    /1   ]  298.392817154        1
[INPUT] 0    0    [1    /1   ]  92.5784936438        1
[INPUT] 0    0    [1    /1   ]  33.0422577063        1
[INPUT] 0    0    [1    /1   ]  7.87425574406        1
[INPUT] 0    0    [1    /1   ]  3.09921382761        1
[INPUT] 1    0    [1    /1   ]  8.60451132296        1
[INPUT] 1    0    [1    /1   ]  0.493080213794       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39667460002435656, 1.0]], [0, [1176168.142606561, 1.0]], [0, [588084.0713018061, 1.0]], [0, [294042.0356467942, 1.0]], [0, [147021.01779739, 1.0]], [0, [73510.50788257997, 1.0]], [0, [36755.23390240337, 1.0]], [0, [7331.770887645251, 1.0]], [0, [18377.159812209473, 1.0]], [0, [1238.9549808606707, 1.0]], [0, [298.3928171537112, 1.0]], [0, [92.57849364380787, 1.0]], [0, [33.042257706283735, 1.0]], [0, [7.87425574406393, 1.0]], [0, [3.099213827614464, 1.0]], [1, [8.604511322961878, 1.0]], [1, [0.4930802137939669, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3966746]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130181]
bas 3, expnt(s) = [294042.03564679]
bas 4, expnt(s) = [147021.01779739]
bas 5, expnt(s) = [73510.50788258]
bas 6, expnt(s) = [36755.2339024]
bas 7, expnt(s) = [7331.77088765]
bas 8, expnt(s) = [18377.15981221]
bas 9, expnt(s) = [1238.95498086]
bas 10, expnt(s) = [298.39281715]
bas 11, expnt(s) = [92.57849364]
bas 12, expnt(s) = [33.04225771]
bas 13, expnt(s) = [7.87425574]
bas 14, expnt(s) = [3.09921383]
bas 15, expnt(s) = [8.60451132]
bas 16, expnt(s) = [0.49308021]
CPU time:       849.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96674600e-01 1.26281816e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177089e+03 2.00180462e+03
 1.83771598e+04 3.98771230e+03 1.23895498e+03 5.27602286e+02
 2.98392817e+02 1.81387058e+02 9.25784936e+01 7.54045594e+01
 3.30422577e+01 3.48190814e+01 7.87425574e+00 1.18760539e+01
 3.09921383e+00 5.90138135e+00 8.60451132e+00 4.29924461e+01
 4.93080214e-01 1.20540049e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32513407704667
cond(S) = 12535.969878431535
E1 = -689.3953981814883  E_coul = 184.92276326272292
init E= -504.472634918765
    CPU time for initialize scf      4.84 sec, wall time      0.34 sec
  HOMO = -0.674452215791145  LUMO = 8.53493070016751
  mo_energy =
[-1.21698622e+02 -1.33865560e+01 -7.62722734e+00 -7.62722734e+00
 -7.62722734e+00 -1.63977570e+00 -6.74452216e-01 -6.74452216e-01
 -6.74452216e-01  8.53493070e+00  9.00558923e+01  4.76453264e+02
  2.24597518e+03  1.14211935e+04  4.10125855e+04  1.09867483e+05
  2.54067722e+05  5.48498002e+05  1.15244596e+06  2.43022871e+06
  5.37496354e+06]
E1 = -707.0681849836182  E_coul = 199.1451652125015
cycle= 1 E= -507.923019771117  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.594032
diis-c [-0.35287366  1.        ]
  HOMO = -0.232781033417843  LUMO = 9.42300453553309
  mo_energy =
[-1.20248602e+02 -1.23499560e+01 -6.64477802e+00 -6.64477802e+00
 -6.64477802e+00 -1.16094894e+00 -2.32781033e-01 -2.32781033e-01
 -2.32781033e-01  9.42300454e+00  9.13738993e+01  4.77887162e+02
  2.24735372e+03  1.14224463e+04  4.10137660e+04  1.09868625e+05
  2.54068836e+05  5.48499096e+05  1.15244704e+06  2.43022978e+06
  5.37496460e+06]
E1 = -706.6942113341619  E_coul = 198.764388021209
cycle= 2 E= -507.929823312953  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156813
diis-c [-2.39089131e-04  4.37624391e-03  9.95623756e-01]
  HOMO = -0.237637665951698  LUMO = 9.41197516572719
  mo_energy =
[-1.20308631e+02 -1.23738948e+01 -6.67433337e+00 -6.67433337e+00
 -6.67433337e+00 -1.16345112e+00 -2.37637666e-01 -2.37637666e-01
 -2.37637666e-01  9.41197517e+00  9.13313419e+01  4.77826296e+02
  2.24727858e+03  1.14223615e+04  4.10136781e+04  1.09868536e+05
  2.54068746e+05  5.48499006e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6780823438842  E_coul = 198.74824497865413
cycle= 3 E= -507.92983736523  delta_E= -1.41e-05  |g|= 0.00094  |ddm|= 0.00981
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000768387
diis-c [-1.96019665e-08  5.04496661e-05 -5.02986491e-02  1.05024820e+00]
  HOMO = -0.237892558892021  LUMO = 9.41140829954478
  mo_energy =
[-1.20311385e+02 -1.23751173e+01 -6.67581176e+00 -6.67581176e+00
 -6.67581176e+00 -1.16357707e+00 -2.37892559e-01 -2.37892559e-01
 -2.37892559e-01  9.41140830e+00  9.13292995e+01  4.77823551e+02
  2.24727540e+03  1.14223581e+04  4.10136745e+04  1.09868532e+05
  2.54068742e+05  5.48499002e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6772462791943  E_coul = 198.74740887618927
cycle= 4 E= -507.929837403005  delta_E= -3.78e-08  |g|= 8.33e-06  |ddm|= 0.000539
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.05222e-06
diis-c [-6.18831421e-12 -2.15841522e-06  2.52659131e-03 -5.06547886e-02
  1.04813036e+00]
  HOMO = -0.237893869544947  LUMO = 9.41140653498798
  mo_energy =
[-1.20311386e+02 -1.23751221e+01 -6.67581571e+00 -6.67581571e+00
 -6.67581571e+00 -1.16357780e+00 -2.37893870e-01 -2.37893870e-01
 -2.37893870e-01  9.41140653e+00  9.13292969e+01  4.77823550e+02
  2.24727540e+03  1.14223581e+04  4.10136745e+04  1.09868532e+05
  2.54068742e+05  5.48499002e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6772436210496  E_coul = 198.74740621804187
cycle= 5 E= -507.929837403008  delta_E= -2.73e-12  |g|= 1.52e-07  |ddm|= 3.53e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6772436210496  E_coul = 198.74740621804187
  HOMO = -0.23789390672065  LUMO = 9.41140646562434
  mo_energy =
[-1.20311386e+02 -1.23751222e+01 -6.67581589e+00 -6.67581589e+00
 -6.67581589e+00 -1.16357782e+00 -2.37893907e-01 -2.37893907e-01
 -2.37893907e-01  9.41140647e+00  9.13292966e+01  4.77823550e+02
  2.24727540e+03  1.14223581e+04  4.10136745e+04  1.09868532e+05
  2.54068742e+05  5.48499002e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6772435174569  E_coul = 198.74740611444912
Extra cycle  E= -507.929837403008  delta_E= -5.68e-14  |g|= 8.08e-09  |ddm|= 8.17e-08
    CPU time for scf_cycle      5.07 sec, wall time      0.41 sec
exp = [3.96674600e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177089e+03
 1.83771598e+04 1.23895498e+03 2.98392817e+02 9.25784936e+01
 3.30422577e+01 7.87425574e+00 3.09921383e+00 8.60451132e+00
 4.93080214e-01]
E = -507.92983740300775
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396674600024       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078826        1
[INPUT] 0    0    [1    /1   ]  36755.2339024        1
[INPUT] 0    0    [1    /1   ]  7331.77088765        1
[INPUT] 0    0    [1    /1   ]  18377.1598122        1
[INPUT] 0    0    [1    /1   ]  1238.95498086        1
[INPUT] 0    0    [1    /1   ]  298.392817154        1
[INPUT] 0    0    [1    /1   ]  92.5784936438        1
[INPUT] 0    0    [1    /1   ]  33.0422577063        1
[INPUT] 0    0    [1    /1   ]  7.87425574406        1
[INPUT] 0    0    [1    /1   ]  3.09921382761        1
[INPUT] 1    0    [1    /1   ]  8.60451132296        1
[INPUT] 1    0    [1    /1   ]  0.493080213794       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39667460002435656, 1.0]], [0, [1176168.142606561, 1.0]], [0, [588084.0713018061, 1.0]], [0, [294042.0356467942, 1.0]], [0, [147021.01779739, 1.0]], [0, [73510.50788257997, 1.0]], [0, [36755.23390240337, 1.0]], [0, [7331.770887645251, 1.0]], [0, [18377.159812209473, 1.0]], [0, [1238.9549808606707, 1.0]], [0, [298.3928171537112, 1.0]], [0, [92.57849364380787, 1.0]], [0, [33.042257706283735, 1.0]], [0, [7.87425574406393, 1.0]], [0, [3.099213827614464, 1.0]], [1, [8.604511322961878, 1.0]], [1, [0.4930802137939669, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3966746]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130181]
bas 3, expnt(s) = [294042.03564679]
bas 4, expnt(s) = [147021.01779739]
bas 5, expnt(s) = [73510.50788258]
bas 6, expnt(s) = [36755.2339024]
bas 7, expnt(s) = [7331.77088765]
bas 8, expnt(s) = [18377.15981221]
bas 9, expnt(s) = [1238.95498086]
bas 10, expnt(s) = [298.39281715]
bas 11, expnt(s) = [92.57849364]
bas 12, expnt(s) = [33.04225771]
bas 13, expnt(s) = [7.87425574]
bas 14, expnt(s) = [3.09921383]
bas 15, expnt(s) = [8.60451132]
bas 16, expnt(s) = [0.49308021]
CPU time:       854.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96674600e-01 1.26281816e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177089e+03 2.00180462e+03
 1.83771598e+04 3.98771230e+03 1.23895498e+03 5.27602286e+02
 2.98392817e+02 1.81387058e+02 9.25784936e+01 7.54045594e+01
 3.30422577e+01 3.48190814e+01 7.87425574e+00 1.18760539e+01
 3.09921383e+00 5.90138135e+00 8.60451132e+00 4.29924461e+01
 4.93080214e-01 1.20540049e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32513407704667
cond(S) = 12535.969878431535
E1 = -689.3953981814883  E_coul = 184.92276326272292
init E= -504.472634918765
    CPU time for initialize scf      4.83 sec, wall time      0.34 sec
  HOMO = -0.674452215791145  LUMO = 8.53493070016751
  mo_energy =
[-1.21698622e+02 -1.33865560e+01 -7.62722734e+00 -7.62722734e+00
 -7.62722734e+00 -1.63977570e+00 -6.74452216e-01 -6.74452216e-01
 -6.74452216e-01  8.53493070e+00  9.00558923e+01  4.76453264e+02
  2.24597518e+03  1.14211935e+04  4.10125855e+04  1.09867483e+05
  2.54067722e+05  5.48498002e+05  1.15244596e+06  2.43022871e+06
  5.37496354e+06]
E1 = -707.0681849836182  E_coul = 199.1451652125015
cycle= 1 E= -507.923019771117  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.594032
diis-c [-0.35287366  1.        ]
  HOMO = -0.232781033417843  LUMO = 9.42300453553309
  mo_energy =
[-1.20248602e+02 -1.23499560e+01 -6.64477802e+00 -6.64477802e+00
 -6.64477802e+00 -1.16094894e+00 -2.32781033e-01 -2.32781033e-01
 -2.32781033e-01  9.42300454e+00  9.13738993e+01  4.77887162e+02
  2.24735372e+03  1.14224463e+04  4.10137660e+04  1.09868625e+05
  2.54068836e+05  5.48499096e+05  1.15244704e+06  2.43022978e+06
  5.37496460e+06]
E1 = -706.6942113341619  E_coul = 198.764388021209
cycle= 2 E= -507.929823312953  delta_E= -0.0068  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156813
diis-c [-2.39089131e-04  4.37624391e-03  9.95623756e-01]
  HOMO = -0.237637665951698  LUMO = 9.41197516572719
  mo_energy =
[-1.20308631e+02 -1.23738948e+01 -6.67433337e+00 -6.67433337e+00
 -6.67433337e+00 -1.16345112e+00 -2.37637666e-01 -2.37637666e-01
 -2.37637666e-01  9.41197517e+00  9.13313419e+01  4.77826296e+02
  2.24727858e+03  1.14223615e+04  4.10136781e+04  1.09868536e+05
  2.54068746e+05  5.48499006e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6780823438842  E_coul = 198.74824497865413
cycle= 3 E= -507.92983736523  delta_E= -1.41e-05  |g|= 0.00094  |ddm|= 0.00981
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000768387
diis-c [-1.96019665e-08  5.04496661e-05 -5.02986491e-02  1.05024820e+00]
  HOMO = -0.237892558892021  LUMO = 9.41140829954478
  mo_energy =
[-1.20311385e+02 -1.23751173e+01 -6.67581176e+00 -6.67581176e+00
 -6.67581176e+00 -1.16357707e+00 -2.37892559e-01 -2.37892559e-01
 -2.37892559e-01  9.41140830e+00  9.13292995e+01  4.77823551e+02
  2.24727540e+03  1.14223581e+04  4.10136745e+04  1.09868532e+05
  2.54068742e+05  5.48499002e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6772462791943  E_coul = 198.74740887618927
cycle= 4 E= -507.929837403005  delta_E= -3.78e-08  |g|= 8.33e-06  |ddm|= 0.000539
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.05222e-06
diis-c [-6.18831421e-12 -2.15841522e-06  2.52659131e-03 -5.06547886e-02
  1.04813036e+00]
  HOMO = -0.237893869544947  LUMO = 9.41140653498798
  mo_energy =
[-1.20311386e+02 -1.23751221e+01 -6.67581571e+00 -6.67581571e+00
 -6.67581571e+00 -1.16357780e+00 -2.37893870e-01 -2.37893870e-01
 -2.37893870e-01  9.41140653e+00  9.13292969e+01  4.77823550e+02
  2.24727540e+03  1.14223581e+04  4.10136745e+04  1.09868532e+05
  2.54068742e+05  5.48499002e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6772436210496  E_coul = 198.74740621804187
cycle= 5 E= -507.929837403008  delta_E= -2.73e-12  |g|= 1.52e-07  |ddm|= 3.53e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6772436210496  E_coul = 198.74740621804187
  HOMO = -0.23789390672065  LUMO = 9.41140646562434
  mo_energy =
[-1.20311386e+02 -1.23751222e+01 -6.67581589e+00 -6.67581589e+00
 -6.67581589e+00 -1.16357782e+00 -2.37893907e-01 -2.37893907e-01
 -2.37893907e-01  9.41140647e+00  9.13292966e+01  4.77823550e+02
  2.24727540e+03  1.14223581e+04  4.10136745e+04  1.09868532e+05
  2.54068742e+05  5.48499002e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6772435174569  E_coul = 198.74740611444912
Extra cycle  E= -507.929837403008  delta_E= -5.68e-14  |g|= 8.08e-09  |ddm|= 8.17e-08
    CPU time for scf_cycle      5.05 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12535.969878431535
E1 = -706.6772435174569  E_coul = 198.74740611444912
init E= -507.929837403008
    CPU time for initialize scf      1.83 sec, wall time      0.12 sec
  HOMO = -0.237893908558968  LUMO = 9.41140646102479
  mo_energy =
[-1.20311386e+02 -1.23751222e+01 -6.67581590e+00 -6.67581590e+00
 -6.67581590e+00 -1.16357782e+00 -2.37893909e-01 -2.37893909e-01
 -2.37893909e-01  9.41140646e+00  9.13292966e+01  4.77823550e+02
  2.24727540e+03  1.14223581e+04  4.10136745e+04  1.09868532e+05
  2.54068742e+05  5.48499002e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6772435125337  E_coul = 198.7474061095262
cycle= 1 E= -507.929837403007  delta_E= 2.84e-13  |g|= 1.06e-09  |ddm|= 4.26e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6772435125337  E_coul = 198.7474061095262
  HOMO = -0.237893908653586  LUMO = 9.41140645987836
  mo_energy =
[-1.20311386e+02 -1.23751222e+01 -6.67581590e+00 -6.67581590e+00
 -6.67581590e+00 -1.16357782e+00 -2.37893909e-01 -2.37893909e-01
 -2.37893909e-01  9.41140646e+00  9.13292966e+01  4.77823550e+02
  2.24727540e+03  1.14223581e+04  4.10136745e+04  1.09868532e+05
  2.54068742e+05  5.48499002e+05  1.15244695e+06  2.43022969e+06
  5.37496451e+06]
E1 = -706.6772435122956  E_coul = 198.74740610928788
Extra cycle  E= -507.929837403008  delta_E= -2.27e-13  |g|= 1.05e-09  |ddm|= 2.25e-10
    CPU time for scf_cycle      2.01 sec, wall time      0.19 sec
exp = [3.96674600e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177089e+03
 1.83771598e+04 1.23895498e+03 2.98392817e+02 9.25784936e+01
 3.30422577e+01 7.87425574e+00 3.09921383e+00 8.60451132e+00
 4.93080214e-01]
grad_E = [ 2.26608831e-05 -2.41869239e-11  3.82227196e-10  1.26798892e-09
  7.56596176e-09  2.45931393e-08  1.51967233e-07  8.27476313e-06
  3.65504413e-07  5.50602253e-05 -6.14503252e-04 -1.61040091e-06
  4.20741903e-05 -7.35153061e-06 -3.68734194e-05  2.59791593e-05
  1.89543004e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396662406907       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078827        1
[INPUT] 0    0    [1    /1   ]  36755.2339034        1
[INPUT] 0    0    [1    /1   ]  7331.77094174        1
[INPUT] 0    0    [1    /1   ]  18377.1598147        1
[INPUT] 0    0    [1    /1   ]  1238.95435794        1
[INPUT] 0    0    [1    /1   ]  298.399625738        1
[INPUT] 0    0    [1    /1   ]  92.5624682128        1
[INPUT] 0    0    [1    /1   ]  33.0114521412        1
[INPUT] 0    0    [1    /1   ]  7.87133379916        1
[INPUT] 0    0    [1    /1   ]  3.09763842211        1
[INPUT] 1    0    [1    /1   ]  8.60432966484        1
[INPUT] 1    0    [1    /1   ]  0.493070700515       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39666240690665533, 1.0]], [0, [1176168.142606561, 1.0]], [0, [588084.0713018086, 1.0]], [0, [294042.0356468027, 1.0]], [0, [147021.01779743846, 1.0]], [0, [73510.50788274319, 1.0]], [0, [36755.233903375236, 1.0]], [0, [7331.770941736213, 1.0]], [0, [18377.15981472715, 1.0]], [0, [1238.9543579397273, 1.0]], [0, [298.3996257375091, 1.0]], [0, [92.56246821281988, 1.0]], [0, [33.01145214121632, 1.0]], [0, [7.871333799158649, 1.0]], [0, [3.0976384221138344, 1.0]], [1, [8.604329664838097, 1.0]], [1, [0.49307070051478585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39666241]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130181]
bas 3, expnt(s) = [294042.0356468]
bas 4, expnt(s) = [147021.01779744]
bas 5, expnt(s) = [73510.50788274]
bas 6, expnt(s) = [36755.23390338]
bas 7, expnt(s) = [7331.77094174]
bas 8, expnt(s) = [18377.15981473]
bas 9, expnt(s) = [1238.95435794]
bas 10, expnt(s) = [298.39962574]
bas 11, expnt(s) = [92.56246821]
bas 12, expnt(s) = [33.01145214]
bas 13, expnt(s) = [7.8713338]
bas 14, expnt(s) = [3.09763842]
bas 15, expnt(s) = [8.60432966]
bas 16, expnt(s) = [0.4930707]
CPU time:       864.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96662407e-01 1.26278905e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177094e+03 2.00180463e+03
 1.83771598e+04 3.98771230e+03 1.23895436e+03 5.27602087e+02
 2.98399626e+02 1.81390162e+02 9.25624682e+01 7.53947698e+01
 3.30114521e+01 3.47947320e+01 7.87133380e+00 1.18727486e+01
 3.09763842e+00 5.89913135e+00 8.60432966e+00 4.29913115e+01
 4.93070701e-01 1.20537141e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32514984859526
cond(S) = 12535.925621135751
E1 = -689.3944465399911  E_coul = 184.921597810035
init E= -504.472848729956
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674464555875647  LUMO = 8.52689850057049
  mo_energy =
[-1.21698832e+02 -1.33866423e+01 -7.62730699e+00 -7.62730699e+00
 -7.62730699e+00 -1.63978036e+00 -6.74464556e-01 -6.74464556e-01
 -6.74464556e-01  8.52689850e+00  8.99772410e+01  4.76289033e+02
  2.24580664e+03  1.14210487e+04  4.10124523e+04  1.09867356e+05
  2.54067598e+05  5.48497882e+05  1.15244584e+06  2.43022860e+06
  5.37496343e+06]
E1 = -707.0665804293042  E_coul = 199.1435617603013
cycle= 1 E= -507.923018669003  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.594021
diis-c [-0.35286055  1.        ]
  HOMO = -0.232808237040212  LUMO = 9.41472131792654
  mo_energy =
[-1.20248878e+02 -1.23500653e+01 -6.64488437e+00 -6.64488437e+00
 -6.64488437e+00 -1.16096675e+00 -2.32808237e-01 -2.32808237e-01
 -2.32808237e-01  9.41472132e+00  9.12950728e+01  4.77722846e+02
  2.24718509e+03  1.14223014e+04  4.10136326e+04  1.09868497e+05
  2.54068713e+05  5.48498976e+05  1.15244692e+06  2.43022967e+06
  5.37496449e+06]
E1 = -706.6923411612271  E_coul = 198.7625134466162
cycle= 2 E= -507.929827714611  delta_E= -0.00681  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156863
diis-c [-2.39260670e-04  4.37152611e-03  9.95628474e-01]
  HOMO = -0.237670078769198  LUMO = 9.40368894854397
  mo_energy =
[-1.20308938e+02 -1.23740245e+01 -6.67446191e+00 -6.67446191e+00
 -6.67446191e+00 -1.16347208e+00 -2.37670079e-01 -2.37670079e-01
 -2.37670079e-01  9.40368895e+00  9.12525005e+01  4.77661950e+02
  2.24710992e+03  1.14222166e+04  4.10135446e+04  1.09868408e+05
  2.54068623e+05  5.48498886e+05  1.15244683e+06  2.43022958e+06
  5.37496440e+06]
E1 = -706.6761926929711  E_coul = 198.74635089944388
cycle= 3 E= -507.929841793527  delta_E= -1.41e-05  |g|= 0.000941  |ddm|= 0.00982
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000768754
diis-c [-1.97042715e-08  5.05470102e-05 -5.03031372e-02  1.05025259e+00]
  HOMO = -0.237925354189761  LUMO = 9.4031216830027
  mo_energy =
[-1.20311693e+02 -1.23752486e+01 -6.67594194e+00 -6.67594194e+00
 -6.67594194e+00 -1.16359824e+00 -2.37925354e-01 -2.37925354e-01
 -2.37925354e-01  9.40312168e+00  9.12504567e+01  4.77659203e+02
  2.24710674e+03  1.14222131e+04  4.10135411e+04  1.09868404e+05
  2.54068619e+05  5.48498882e+05  1.15244683e+06  2.43022957e+06
  5.37496440e+06]
E1 = -706.675355276973  E_coul = 198.74551344556244
cycle= 4 E= -507.929841831411  delta_E= -3.79e-08  |g|= 8.36e-06  |ddm|= 0.00054
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.07468e-06
diis-c [-6.20858080e-12 -2.15963259e-06  2.52934857e-03 -5.07135674e-02
  1.04818638e+00]
  HOMO = -0.237926672354571  LUMO = 9.40311990769561
  mo_energy =
[-1.20311694e+02 -1.23752534e+01 -6.67594592e+00 -6.67594592e+00
 -6.67594592e+00 -1.16359897e+00 -2.37926672e-01 -2.37926672e-01
 -2.37926672e-01  9.40311991e+00  9.12504541e+01  4.77659203e+02
  2.24710674e+03  1.14222131e+04  4.10135411e+04  1.09868404e+05
  2.54068619e+05  5.48498882e+05  1.15244683e+06  2.43022957e+06
  5.37496440e+06]
E1 = -706.6753525978922  E_coul = 198.74551076647964
cycle= 5 E= -507.929841831413  delta_E= -1.99e-12  |g|= 1.52e-07  |ddm|= 3.55e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6753525978922  E_coul = 198.74551076647964
  HOMO = -0.237926709567646  LUMO = 9.40311983569943
  mo_energy =
[-1.20311695e+02 -1.23752535e+01 -6.67594610e+00 -6.67594610e+00
 -6.67594610e+00 -1.16359899e+00 -2.37926710e-01 -2.37926710e-01
 -2.37926710e-01  9.40311984e+00  9.12504538e+01  4.77659202e+02
  2.24710674e+03  1.14222131e+04  4.10135411e+04  1.09868404e+05
  2.54068619e+05  5.48498882e+05  1.15244683e+06  2.43022957e+06
  5.37496440e+06]
E1 = -706.6753524941827  E_coul = 198.74551066276962
Extra cycle  E= -507.929841831413  delta_E= -4.55e-13  |g|= 8.19e-09  |ddm|= 8.18e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [3.96662407e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177094e+03
 1.83771598e+04 1.23895436e+03 2.98399626e+02 9.25624682e+01
 3.30114521e+01 7.87133380e+00 3.09763842e+00 8.60432966e+00
 4.93070701e-01]
E = -507.92984183141306
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396662406907       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078827        1
[INPUT] 0    0    [1    /1   ]  36755.2339034        1
[INPUT] 0    0    [1    /1   ]  7331.77094174        1
[INPUT] 0    0    [1    /1   ]  18377.1598147        1
[INPUT] 0    0    [1    /1   ]  1238.95435794        1
[INPUT] 0    0    [1    /1   ]  298.399625738        1
[INPUT] 0    0    [1    /1   ]  92.5624682128        1
[INPUT] 0    0    [1    /1   ]  33.0114521412        1
[INPUT] 0    0    [1    /1   ]  7.87133379916        1
[INPUT] 0    0    [1    /1   ]  3.09763842211        1
[INPUT] 1    0    [1    /1   ]  8.60432966484        1
[INPUT] 1    0    [1    /1   ]  0.493070700515       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39666240690665533, 1.0]], [0, [1176168.142606561, 1.0]], [0, [588084.0713018086, 1.0]], [0, [294042.0356468027, 1.0]], [0, [147021.01779743846, 1.0]], [0, [73510.50788274319, 1.0]], [0, [36755.233903375236, 1.0]], [0, [7331.770941736213, 1.0]], [0, [18377.15981472715, 1.0]], [0, [1238.9543579397273, 1.0]], [0, [298.3996257375091, 1.0]], [0, [92.56246821281988, 1.0]], [0, [33.01145214121632, 1.0]], [0, [7.871333799158649, 1.0]], [0, [3.0976384221138344, 1.0]], [1, [8.604329664838097, 1.0]], [1, [0.49307070051478585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39666241]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130181]
bas 3, expnt(s) = [294042.0356468]
bas 4, expnt(s) = [147021.01779744]
bas 5, expnt(s) = [73510.50788274]
bas 6, expnt(s) = [36755.23390338]
bas 7, expnt(s) = [7331.77094174]
bas 8, expnt(s) = [18377.15981473]
bas 9, expnt(s) = [1238.95435794]
bas 10, expnt(s) = [298.39962574]
bas 11, expnt(s) = [92.56246821]
bas 12, expnt(s) = [33.01145214]
bas 13, expnt(s) = [7.8713338]
bas 14, expnt(s) = [3.09763842]
bas 15, expnt(s) = [8.60432966]
bas 16, expnt(s) = [0.4930707]
CPU time:       864.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96662407e-01 1.26278905e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177094e+03 2.00180463e+03
 1.83771598e+04 3.98771230e+03 1.23895436e+03 5.27602087e+02
 2.98399626e+02 1.81390162e+02 9.25624682e+01 7.53947698e+01
 3.30114521e+01 3.47947320e+01 7.87133380e+00 1.18727486e+01
 3.09763842e+00 5.89913135e+00 8.60432966e+00 4.29913115e+01
 4.93070701e-01 1.20537141e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32514984859526
cond(S) = 12535.925621135751
E1 = -689.3944465399911  E_coul = 184.921597810035
init E= -504.472848729956
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674464555875647  LUMO = 8.52689850057049
  mo_energy =
[-1.21698832e+02 -1.33866423e+01 -7.62730699e+00 -7.62730699e+00
 -7.62730699e+00 -1.63978036e+00 -6.74464556e-01 -6.74464556e-01
 -6.74464556e-01  8.52689850e+00  8.99772410e+01  4.76289033e+02
  2.24580664e+03  1.14210487e+04  4.10124523e+04  1.09867356e+05
  2.54067598e+05  5.48497882e+05  1.15244584e+06  2.43022860e+06
  5.37496343e+06]
E1 = -707.0665804293042  E_coul = 199.1435617603013
cycle= 1 E= -507.923018669003  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.594021
diis-c [-0.35286055  1.        ]
  HOMO = -0.232808237040212  LUMO = 9.41472131792654
  mo_energy =
[-1.20248878e+02 -1.23500653e+01 -6.64488437e+00 -6.64488437e+00
 -6.64488437e+00 -1.16096675e+00 -2.32808237e-01 -2.32808237e-01
 -2.32808237e-01  9.41472132e+00  9.12950728e+01  4.77722846e+02
  2.24718509e+03  1.14223014e+04  4.10136326e+04  1.09868497e+05
  2.54068713e+05  5.48498976e+05  1.15244692e+06  2.43022967e+06
  5.37496449e+06]
E1 = -706.6923411612271  E_coul = 198.7625134466162
cycle= 2 E= -507.929827714611  delta_E= -0.00681  |g|= 0.0188  |ddm|= 0.208
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156863
diis-c [-2.39260670e-04  4.37152611e-03  9.95628474e-01]
  HOMO = -0.237670078769198  LUMO = 9.40368894854397
  mo_energy =
[-1.20308938e+02 -1.23740245e+01 -6.67446191e+00 -6.67446191e+00
 -6.67446191e+00 -1.16347208e+00 -2.37670079e-01 -2.37670079e-01
 -2.37670079e-01  9.40368895e+00  9.12525005e+01  4.77661950e+02
  2.24710992e+03  1.14222166e+04  4.10135446e+04  1.09868408e+05
  2.54068623e+05  5.48498886e+05  1.15244683e+06  2.43022958e+06
  5.37496440e+06]
E1 = -706.6761926929711  E_coul = 198.74635089944388
cycle= 3 E= -507.929841793527  delta_E= -1.41e-05  |g|= 0.000941  |ddm|= 0.00982
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000768754
diis-c [-1.97042715e-08  5.05470102e-05 -5.03031372e-02  1.05025259e+00]
  HOMO = -0.237925354189761  LUMO = 9.4031216830027
  mo_energy =
[-1.20311693e+02 -1.23752486e+01 -6.67594194e+00 -6.67594194e+00
 -6.67594194e+00 -1.16359824e+00 -2.37925354e-01 -2.37925354e-01
 -2.37925354e-01  9.40312168e+00  9.12504567e+01  4.77659203e+02
  2.24710674e+03  1.14222131e+04  4.10135411e+04  1.09868404e+05
  2.54068619e+05  5.48498882e+05  1.15244683e+06  2.43022957e+06
  5.37496440e+06]
E1 = -706.675355276973  E_coul = 198.74551344556244
cycle= 4 E= -507.929841831411  delta_E= -3.79e-08  |g|= 8.36e-06  |ddm|= 0.00054
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.07468e-06
diis-c [-6.20858080e-12 -2.15963259e-06  2.52934857e-03 -5.07135674e-02
  1.04818638e+00]
  HOMO = -0.237926672354571  LUMO = 9.40311990769561
  mo_energy =
[-1.20311694e+02 -1.23752534e+01 -6.67594592e+00 -6.67594592e+00
 -6.67594592e+00 -1.16359897e+00 -2.37926672e-01 -2.37926672e-01
 -2.37926672e-01  9.40311991e+00  9.12504541e+01  4.77659203e+02
  2.24710674e+03  1.14222131e+04  4.10135411e+04  1.09868404e+05
  2.54068619e+05  5.48498882e+05  1.15244683e+06  2.43022957e+06
  5.37496440e+06]
E1 = -706.6753525978922  E_coul = 198.74551076647964
cycle= 5 E= -507.929841831413  delta_E= -1.99e-12  |g|= 1.52e-07  |ddm|= 3.55e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6753525978922  E_coul = 198.74551076647964
  HOMO = -0.237926709567646  LUMO = 9.40311983569943
  mo_energy =
[-1.20311695e+02 -1.23752535e+01 -6.67594610e+00 -6.67594610e+00
 -6.67594610e+00 -1.16359899e+00 -2.37926710e-01 -2.37926710e-01
 -2.37926710e-01  9.40311984e+00  9.12504538e+01  4.77659202e+02
  2.24710674e+03  1.14222131e+04  4.10135411e+04  1.09868404e+05
  2.54068619e+05  5.48498882e+05  1.15244683e+06  2.43022957e+06
  5.37496440e+06]
E1 = -706.6753524941827  E_coul = 198.74551066276962
Extra cycle  E= -507.929841831413  delta_E= -4.55e-13  |g|= 8.19e-09  |ddm|= 8.18e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12535.925621135751
E1 = -706.6753524941827  E_coul = 198.74551066276962
init E= -507.929841831413
    CPU time for initialize scf      1.25 sec, wall time      0.08 sec
  HOMO = -0.237926711409086  LUMO = 9.40311983205767
  mo_energy =
[-1.20311695e+02 -1.23752535e+01 -6.67594611e+00 -6.67594611e+00
 -6.67594611e+00 -1.16359899e+00 -2.37926711e-01 -2.37926711e-01
 -2.37926711e-01  9.40311983e+00  9.12504538e+01  4.77659202e+02
  2.24710674e+03  1.14222131e+04  4.10135411e+04  1.09868404e+05
  2.54068619e+05  5.48498882e+05  1.15244683e+06  2.43022957e+06
  5.37496440e+06]
E1 = -706.6753524891552  E_coul = 198.74551065774241
cycle= 1 E= -507.929841831413  delta_E= 2.84e-13  |g|= 1.22e-09  |ddm|= 4.26e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6753524891552  E_coul = 198.74551065774241
  HOMO = -0.237926711504009  LUMO = 9.40311983326078
  mo_energy =
[-1.20311695e+02 -1.23752535e+01 -6.67594611e+00 -6.67594611e+00
 -6.67594611e+00 -1.16359899e+00 -2.37926712e-01 -2.37926712e-01
 -2.37926712e-01  9.40311983e+00  9.12504538e+01  4.77659202e+02
  2.24710674e+03  1.14222131e+04  4.10135411e+04  1.09868404e+05
  2.54068619e+05  5.48498882e+05  1.15244683e+06  2.43022957e+06
  5.37496440e+06]
E1 = -706.6753524889632  E_coul = 198.74551065755006
Extra cycle  E= -507.929841831413  delta_E= -3.41e-13  |g|= 9.31e-10  |ddm|= 2.23e-10
    CPU time for scf_cycle      1.43 sec, wall time      0.15 sec
exp = [3.96662407e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177094e+03
 1.83771598e+04 1.23895436e+03 2.98399626e+02 9.25624682e+01
 3.30114521e+01 7.87133380e+00 3.09763842e+00 8.60432966e+00
 4.93070701e-01]
grad_E = [-2.11630782e-04 -2.42018963e-11  3.82123488e-10  1.26759539e-09
  7.56399173e-09  2.45857129e-08  1.51927898e-07  8.27231381e-06
  3.65377492e-07  5.52838835e-05 -6.19173308e-04  3.29436760e-05
 -3.85618005e-05 -2.06559556e-05 -3.94420998e-05 -1.29513904e-04
 -4.94721502e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396635728895       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078822        1
[INPUT] 0    0    [1    /1   ]  36755.2339002        1
[INPUT] 0    0    [1    /1   ]  7331.77076781        1
[INPUT] 0    0    [1    /1   ]  18377.1598072        1
[INPUT] 0    0    [1    /1   ]  1238.95188251        1
[INPUT] 0    0    [1    /1   ]  298.42688328         1
[INPUT] 0    0    [1    /1   ]  92.5438440836        1
[INPUT] 0    0    [1    /1   ]  32.9609495776        1
[INPUT] 0    0    [1    /1   ]  7.86677112568        1
[INPUT] 0    0    [1    /1   ]  3.09516396305        1
[INPUT] 1    0    [1    /1   ]  8.60393590301        1
[INPUT] 1    0    [1    /1   ]  0.493049132996       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39663572889506077, 1.0]], [0, [1176168.1426065618, 1.0]], [0, [588084.0713018005, 1.0]], [0, [294042.03564677626, 1.0]], [0, [147021.0177972781, 1.0]], [0, [73510.50788222956, 1.0]], [0, [36755.233900152205, 1.0]], [0, [7331.770767811904, 1.0]], [0, [18377.15980721725, 1.0]], [0, [1238.9518825147222, 1.0]], [0, [298.4268832802815, 1.0]], [0, [92.54384408364679, 1.0]], [0, [32.96094957763755, 1.0]], [0, [7.866771125680846, 1.0]], [0, [3.09516396304675, 1.0]], [1, [8.603935903010129, 1.0]], [1, [0.4930491329963276, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39663573]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.0713018]
bas 3, expnt(s) = [294042.03564678]
bas 4, expnt(s) = [147021.01779728]
bas 5, expnt(s) = [73510.50788223]
bas 6, expnt(s) = [36755.23390015]
bas 7, expnt(s) = [7331.77076781]
bas 8, expnt(s) = [18377.15980722]
bas 9, expnt(s) = [1238.95188251]
bas 10, expnt(s) = [298.42688328]
bas 11, expnt(s) = [92.54384408]
bas 12, expnt(s) = [32.96094958]
bas 13, expnt(s) = [7.86677113]
bas 14, expnt(s) = [3.09516396]
bas 15, expnt(s) = [8.6039359]
bas 16, expnt(s) = [0.49304913]
CPU time:       869.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96635729e-01 1.26272535e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177077e+03 2.00180460e+03
 1.83771598e+04 3.98771230e+03 1.23895188e+03 5.27601297e+02
 2.98426883e+02 1.81402589e+02 9.25438441e+01 7.53833921e+01
 3.29609496e+01 3.47548013e+01 7.86677113e+00 1.18675866e+01
 3.09516396e+00 5.89559673e+00 8.60393590e+00 4.29888523e+01
 4.93049133e-01 1.20530551e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325184611807003
cond(S) = 12535.869805934622
E1 = -689.3921969592377  E_coul = 184.9190199544136
init E= -504.473177004824
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674492619071799  LUMO = 8.5141479805826
  mo_energy =
[-1.21699289e+02 -1.33868349e+01 -7.62748313e+00 -7.62748313e+00
 -7.62748313e+00 -1.63979510e+00 -6.74492619e-01 -6.74492619e-01
 -6.74492619e-01  8.51414798e+00  8.98524363e+01  4.76051283e+02
  2.24560367e+03  1.14208898e+04  4.10123074e+04  1.09867217e+05
  2.54067464e+05  5.48497752e+05  1.15244572e+06  2.43022847e+06
  5.37496331e+06]
E1 = -707.0630797700682  E_coul = 199.14005732598167
cycle= 1 E= -507.923022444086  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.594
diis-c [-0.35283613  1.        ]
  HOMO = -0.232869401409806  LUMO = 9.40156178902413
  mo_energy =
[-1.20249464e+02 -1.23503086e+01 -6.64511810e+00 -6.64511810e+00
 -6.64511810e+00 -1.16101065e+00 -2.32869401e-01 -2.32869401e-01
 -2.32869401e-01  9.40156179e+00  9.11699709e+01  4.77484938e+02
  2.24698197e+03  1.14221423e+04  4.10134876e+04  1.09868359e+05
  2.54068578e+05  5.48498846e+05  1.15244680e+06  2.43022954e+06
  5.37496437e+06]
E1 = -706.6884251432273  E_coul = 198.7585850558217
cycle= 2 E= -507.929840087406  delta_E= -0.00682  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156942
diis-c [-2.39534973e-04  4.36342167e-03  9.95636578e-01]
  HOMO = -0.237739391112784  LUMO = 9.39052481933035
  mo_energy =
[-1.20309571e+02 -1.23743001e+01 -6.67473039e+00 -6.67473039e+00
 -6.67473039e+00 -1.16352096e+00 -2.37739391e-01 -2.37739391e-01
 -2.37739391e-01  9.39052482e+00  9.11273757e+01  4.77423996e+02
  2.24690674e+03  1.14220574e+04  4.10133996e+04  1.09868269e+05
  2.54068488e+05  5.48498756e+05  1.15244671e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.6722459344899  E_coul = 198.74239172596302
cycle= 3 E= -507.929854208527  delta_E= -1.41e-05  |g|= 0.000942  |ddm|= 0.00984
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000769328
diis-c [-1.98682309e-08  5.06998105e-05 -5.03097417e-02  1.05025904e+00]
  HOMO = -0.237995265668744  LUMO = 9.38995693166973
  mo_energy =
[-1.20312330e+02 -1.23755266e+01 -6.67621298e+00 -6.67621298e+00
 -6.67621298e+00 -1.16364746e+00 -2.37995266e-01 -2.37995266e-01
 -2.37995266e-01  9.38995693e+00  9.11253298e+01  4.77421245e+02
  2.24690356e+03  1.14220540e+04  4.10133960e+04  1.09868266e+05
  2.54068485e+05  5.48498752e+05  1.15244670e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.6714063882534  E_coul = 198.74155214167223
cycle= 4 E= -507.929854246581  delta_E= -3.81e-08  |g|= 8.4e-06  |ddm|= 0.000542
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.11025e-06
diis-c [-6.23560404e-12 -2.16387906e-06  2.53370746e-03 -5.08074930e-02
  1.04827595e+00]
  HOMO = -0.237996595789867  LUMO = 9.38995513725336
  mo_energy =
[-1.20312331e+02 -1.23755314e+01 -6.67621700e+00 -6.67621700e+00
 -6.67621700e+00 -1.16364819e+00 -2.37996596e-01 -2.37996596e-01
 -2.37996596e-01  9.38995514e+00  9.11253271e+01  4.77421245e+02
  2.24690356e+03  1.14220540e+04  4.10133961e+04  1.09868266e+05
  2.54068485e+05  5.48498752e+05  1.15244670e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.671403675711  E_coul = 198.74154942912688
cycle= 5 E= -507.929854246584  delta_E= -2.9e-12  |g|= 1.52e-07  |ddm|= 3.58e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.671403675711  E_coul = 198.74154942912688
  HOMO = -0.237996633043168  LUMO = 9.38995506560686
  mo_energy =
[-1.20312331e+02 -1.23755315e+01 -6.67621719e+00 -6.67621719e+00
 -6.67621719e+00 -1.16364821e+00 -2.37996633e-01 -2.37996633e-01
 -2.37996633e-01  9.38995507e+00  9.11253268e+01  4.77421244e+02
  2.24690356e+03  1.14220540e+04  4.10133960e+04  1.09868266e+05
  2.54068485e+05  5.48498752e+05  1.15244670e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.6714035717974  E_coul = 198.74154932521367
Extra cycle  E= -507.929854246584  delta_E= 3.41e-13  |g|= 8.09e-09  |ddm|= 8.19e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.96635729e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177077e+03
 1.83771598e+04 1.23895188e+03 2.98426883e+02 9.25438441e+01
 3.29609496e+01 7.86677113e+00 3.09516396e+00 8.60393590e+00
 4.93049133e-01]
E = -507.9298542465838
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396635728895       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017797        1
[INPUT] 0    0    [1    /1   ]  73510.5078822        1
[INPUT] 0    0    [1    /1   ]  36755.2339002        1
[INPUT] 0    0    [1    /1   ]  7331.77076781        1
[INPUT] 0    0    [1    /1   ]  18377.1598072        1
[INPUT] 0    0    [1    /1   ]  1238.95188251        1
[INPUT] 0    0    [1    /1   ]  298.42688328         1
[INPUT] 0    0    [1    /1   ]  92.5438440836        1
[INPUT] 0    0    [1    /1   ]  32.9609495776        1
[INPUT] 0    0    [1    /1   ]  7.86677112568        1
[INPUT] 0    0    [1    /1   ]  3.09516396305        1
[INPUT] 1    0    [1    /1   ]  8.60393590301        1
[INPUT] 1    0    [1    /1   ]  0.493049132996       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39663572889506077, 1.0]], [0, [1176168.1426065618, 1.0]], [0, [588084.0713018005, 1.0]], [0, [294042.03564677626, 1.0]], [0, [147021.0177972781, 1.0]], [0, [73510.50788222956, 1.0]], [0, [36755.233900152205, 1.0]], [0, [7331.770767811904, 1.0]], [0, [18377.15980721725, 1.0]], [0, [1238.9518825147222, 1.0]], [0, [298.4268832802815, 1.0]], [0, [92.54384408364679, 1.0]], [0, [32.96094957763755, 1.0]], [0, [7.866771125680846, 1.0]], [0, [3.09516396304675, 1.0]], [1, [8.603935903010129, 1.0]], [1, [0.4930491329963276, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39663573]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.0713018]
bas 3, expnt(s) = [294042.03564678]
bas 4, expnt(s) = [147021.01779728]
bas 5, expnt(s) = [73510.50788223]
bas 6, expnt(s) = [36755.23390015]
bas 7, expnt(s) = [7331.77076781]
bas 8, expnt(s) = [18377.15980722]
bas 9, expnt(s) = [1238.95188251]
bas 10, expnt(s) = [298.42688328]
bas 11, expnt(s) = [92.54384408]
bas 12, expnt(s) = [32.96094958]
bas 13, expnt(s) = [7.86677113]
bas 14, expnt(s) = [3.09516396]
bas 15, expnt(s) = [8.6039359]
bas 16, expnt(s) = [0.49304913]
CPU time:       869.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96635729e-01 1.26272535e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33177077e+03 2.00180460e+03
 1.83771598e+04 3.98771230e+03 1.23895188e+03 5.27601297e+02
 2.98426883e+02 1.81402589e+02 9.25438441e+01 7.53833921e+01
 3.29609496e+01 3.47548013e+01 7.86677113e+00 1.18675866e+01
 3.09516396e+00 5.89559673e+00 8.60393590e+00 4.29888523e+01
 4.93049133e-01 1.20530551e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325184611807003
cond(S) = 12535.869805934622
E1 = -689.3921969592377  E_coul = 184.9190199544136
init E= -504.473177004824
    CPU time for initialize scf      0.20 sec, wall time      0.03 sec
  HOMO = -0.674492619071799  LUMO = 8.5141479805826
  mo_energy =
[-1.21699289e+02 -1.33868349e+01 -7.62748313e+00 -7.62748313e+00
 -7.62748313e+00 -1.63979510e+00 -6.74492619e-01 -6.74492619e-01
 -6.74492619e-01  8.51414798e+00  8.98524363e+01  4.76051283e+02
  2.24560367e+03  1.14208898e+04  4.10123074e+04  1.09867217e+05
  2.54067464e+05  5.48497752e+05  1.15244572e+06  2.43022847e+06
  5.37496331e+06]
E1 = -707.0630797700682  E_coul = 199.14005732598167
cycle= 1 E= -507.923022444086  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.18 sec, wall time      0.01 sec
diis-norm(errvec)=0.594
diis-c [-0.35283613  1.        ]
  HOMO = -0.232869401409806  LUMO = 9.40156178902413
  mo_energy =
[-1.20249464e+02 -1.23503086e+01 -6.64511810e+00 -6.64511810e+00
 -6.64511810e+00 -1.16101065e+00 -2.32869401e-01 -2.32869401e-01
 -2.32869401e-01  9.40156179e+00  9.11699709e+01  4.77484938e+02
  2.24698197e+03  1.14221423e+04  4.10134876e+04  1.09868359e+05
  2.54068578e+05  5.48498846e+05  1.15244680e+06  2.43022954e+06
  5.37496437e+06]
E1 = -706.6884251432273  E_coul = 198.7585850558217
cycle= 2 E= -507.929840087406  delta_E= -0.00682  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156942
diis-c [-2.39534973e-04  4.36342167e-03  9.95636578e-01]
  HOMO = -0.237739391112784  LUMO = 9.39052481933035
  mo_energy =
[-1.20309571e+02 -1.23743001e+01 -6.67473039e+00 -6.67473039e+00
 -6.67473039e+00 -1.16352096e+00 -2.37739391e-01 -2.37739391e-01
 -2.37739391e-01  9.39052482e+00  9.11273757e+01  4.77423996e+02
  2.24690674e+03  1.14220574e+04  4.10133996e+04  1.09868269e+05
  2.54068488e+05  5.48498756e+05  1.15244671e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.6722459344899  E_coul = 198.74239172596302
cycle= 3 E= -507.929854208527  delta_E= -1.41e-05  |g|= 0.000942  |ddm|= 0.00984
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000769328
diis-c [-1.98682309e-08  5.06998105e-05 -5.03097417e-02  1.05025904e+00]
  HOMO = -0.237995265668744  LUMO = 9.38995693166973
  mo_energy =
[-1.20312330e+02 -1.23755266e+01 -6.67621298e+00 -6.67621298e+00
 -6.67621298e+00 -1.16364746e+00 -2.37995266e-01 -2.37995266e-01
 -2.37995266e-01  9.38995693e+00  9.11253298e+01  4.77421245e+02
  2.24690356e+03  1.14220540e+04  4.10133960e+04  1.09868266e+05
  2.54068485e+05  5.48498752e+05  1.15244670e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.6714063882534  E_coul = 198.74155214167223
cycle= 4 E= -507.929854246581  delta_E= -3.81e-08  |g|= 8.4e-06  |ddm|= 0.000542
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.11025e-06
diis-c [-6.23560404e-12 -2.16387906e-06  2.53370746e-03 -5.08074930e-02
  1.04827595e+00]
  HOMO = -0.237996595789867  LUMO = 9.38995513725336
  mo_energy =
[-1.20312331e+02 -1.23755314e+01 -6.67621700e+00 -6.67621700e+00
 -6.67621700e+00 -1.16364819e+00 -2.37996596e-01 -2.37996596e-01
 -2.37996596e-01  9.38995514e+00  9.11253271e+01  4.77421245e+02
  2.24690356e+03  1.14220540e+04  4.10133961e+04  1.09868266e+05
  2.54068485e+05  5.48498752e+05  1.15244670e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.671403675711  E_coul = 198.74154942912688
cycle= 5 E= -507.929854246584  delta_E= -2.9e-12  |g|= 1.52e-07  |ddm|= 3.58e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.671403675711  E_coul = 198.74154942912688
  HOMO = -0.237996633043168  LUMO = 9.38995506560686
  mo_energy =
[-1.20312331e+02 -1.23755315e+01 -6.67621719e+00 -6.67621719e+00
 -6.67621719e+00 -1.16364821e+00 -2.37996633e-01 -2.37996633e-01
 -2.37996633e-01  9.38995507e+00  9.11253268e+01  4.77421244e+02
  2.24690356e+03  1.14220540e+04  4.10133960e+04  1.09868266e+05
  2.54068485e+05  5.48498752e+05  1.15244670e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.6714035717974  E_coul = 198.74154932521367
Extra cycle  E= -507.929854246584  delta_E= 3.41e-13  |g|= 8.09e-09  |ddm|= 8.19e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12535.869805934622
E1 = -706.6714035717974  E_coul = 198.74154932521367
init E= -507.929854246584
    CPU time for initialize scf      1.50 sec, wall time      0.10 sec
  HOMO = -0.237996634888352  LUMO = 9.38995506330371
  mo_energy =
[-1.20312331e+02 -1.23755316e+01 -6.67621719e+00 -6.67621719e+00
 -6.67621719e+00 -1.16364821e+00 -2.37996635e-01 -2.37996635e-01
 -2.37996635e-01  9.38995506e+00  9.11253268e+01  4.77421244e+02
  2.24690356e+03  1.14220540e+04  4.10133960e+04  1.09868266e+05
  2.54068485e+05  5.48498752e+05  1.15244670e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.6714035668639  E_coul = 198.74154932027974
cycle= 1 E= -507.929854246584  delta_E= -3.41e-13  |g|= 8.62e-10  |ddm|= 4.26e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6714035668639  E_coul = 198.74154932027974
  HOMO = -0.23799663498311  LUMO = 9.3899550621844
  mo_energy =
[-1.20312331e+02 -1.23755316e+01 -6.67621719e+00 -6.67621719e+00
 -6.67621719e+00 -1.16364821e+00 -2.37996635e-01 -2.37996635e-01
 -2.37996635e-01  9.38995506e+00  9.11253268e+01  4.77421244e+02
  2.24690356e+03  1.14220540e+04  4.10133960e+04  1.09868266e+05
  2.54068485e+05  5.48498752e+05  1.15244670e+06  2.43022945e+06
  5.37496428e+06]
E1 = -706.6714035665725  E_coul = 198.74154931998848
Extra cycle  E= -507.929854246584  delta_E= 1.14e-13  |g|= 1.12e-09  |ddm|= 2.42e-10
    CPU time for scf_cycle      1.69 sec, wall time      0.16 sec
exp = [3.96635729e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33177077e+03
 1.83771598e+04 1.23895188e+03 2.98426883e+02 9.25438441e+01
 3.29609496e+01 7.86677113e+00 3.09516396e+00 8.60393590e+00
 4.93049133e-01]
grad_E = [-6.94483631e-04 -2.42188074e-11  3.82005570e-10  1.26714834e-09
  7.56175106e-09  2.45772759e-08  1.51883085e-07  8.26942854e-06
  3.65233334e-07  5.56042821e-05 -6.27298230e-04  9.49054472e-05
 -1.80502790e-04 -4.72695153e-05 -2.77431729e-05 -4.59603092e-04
 -5.76879410e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.39658788139        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017796        1
[INPUT] 0    0    [1    /1   ]  73510.5078795        1
[INPUT] 0    0    [1    /1   ]  36755.2338831        1
[INPUT] 0    0    [1    /1   ]  7331.76984037        1
[INPUT] 0    0    [1    /1   ]  18377.1597664        1
[INPUT] 0    0    [1    /1   ]  1238.94450192        1
[INPUT] 0    0    [1    /1   ]  298.508433765        1
[INPUT] 0    0    [1    /1   ]  92.5346272255        1
[INPUT] 0    0    [1    /1   ]  32.8888779127        1
[INPUT] 0    0    [1    /1   ]  7.86063725013        1
[INPUT] 0    0    [1    /1   ]  3.09176016935        1
[INPUT] 1    0    [1    /1   ]  8.60323340198        1
[INPUT] 1    0    [1    /1   ]  0.493009672949       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3965878813899371, 1.0]], [0, [1176168.1426065646, 1.0]], [0, [588084.0713017577, 1.0]], [0, [294042.03564663435, 1.0]], [0, [147021.01779642887, 1.0]], [0, [73510.5078794762, 1.0]], [0, [36755.233883093046, 1.0]], [0, [7331.7698403707045, 1.0]], [0, [18377.159766410387, 1.0]], [0, [1238.9445019244706, 1.0]], [0, [298.50843376549363, 1.0]], [0, [92.53462722547329, 1.0]], [0, [32.88887791267923, 1.0]], [0, [7.86063725012527, 1.0]], [0, [3.091760169346847, 1.0]], [1, [8.603233401984749, 1.0]], [1, [0.49300967294891057, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39658788]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130176]
bas 3, expnt(s) = [294042.03564663]
bas 4, expnt(s) = [147021.01779643]
bas 5, expnt(s) = [73510.50787948]
bas 6, expnt(s) = [36755.23388309]
bas 7, expnt(s) = [7331.76984037]
bas 8, expnt(s) = [18377.15976641]
bas 9, expnt(s) = [1238.94450192]
bas 10, expnt(s) = [298.50843377]
bas 11, expnt(s) = [92.53462723]
bas 12, expnt(s) = [32.88887791]
bas 13, expnt(s) = [7.86063725]
bas 14, expnt(s) = [3.09176017]
bas 15, expnt(s) = [8.6032334]
bas 16, expnt(s) = [0.49300967]
CPU time:       874.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96587881e-01 1.26261110e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33176984e+03 2.00180441e+03
 1.83771598e+04 3.98771230e+03 1.23894450e+03 5.27598939e+02
 2.98508434e+02 1.81439767e+02 9.25346272e+01 7.53777612e+01
 3.28888779e+01 3.46977902e+01 7.86063725e+00 1.18606459e+01
 3.09176017e+00 5.89073346e+00 8.60323340e+00 4.29844648e+01
 4.93009673e-01 1.20518493e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325247123162896
cond(S) = 12535.831674613879
E1 = -689.3879633558212  E_coul = 184.91436253193206
init E= -504.473600823889
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67454420061024  LUMO = 8.49652319854738
  mo_energy =
[-1.21700114e+02 -1.33871842e+01 -7.62780142e+00 -7.62780142e+00
 -7.62780142e+00 -1.63982612e+00 -6.74544201e-01 -6.74544201e-01
 -6.74544201e-01  8.49652320e+00  8.96827070e+01  4.75786975e+02
  2.24549668e+03  1.14208603e+04  4.10122861e+04  1.09867197e+05
  2.54067444e+05  5.48497733e+05  1.15244570e+06  2.43022846e+06
  5.37496329e+06]
E1 = -707.056803358703  E_coul = 199.13376138740568
cycle= 1 E= -507.923041971297  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593967
diis-c [-0.35279623  1.        ]
  HOMO = -0.232981028054242  LUMO = 9.38335642662134
  mo_energy =
[-1.20250503e+02 -1.23507498e+01 -6.64553958e+00 -6.64553958e+00
 -6.64553958e+00 -1.16109457e+00 -2.32981028e-01 -2.32981028e-01
 -2.32981028e-01  9.38335643e+00  9.09998065e+01  4.77220373e+02
  2.24687472e+03  1.14221126e+04  4.10134659e+04  1.09868338e+05
  2.54068558e+05  5.48498826e+05  1.15244678e+06  2.43022952e+06
  5.37496436e+06]
E1 = -706.6815827530909  E_coul = 198.75171143117646
cycle= 2 E= -507.929871321914  delta_E= -0.00683  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157053
diis-c [-2.39922170e-04  4.35111794e-03  9.95648882e-01]
  HOMO = -0.237862119549655  LUMO = 9.37231326492453
  mo_energy =
[-1.20310673e+02 -1.23747856e+01 -6.67519929e+00 -6.67519929e+00
 -6.67519929e+00 -1.16361173e+00 -2.37862120e-01 -2.37862120e-01
 -2.37862120e-01  9.37231326e+00  9.09571800e+01  4.77159367e+02
  2.24679942e+03  1.14220276e+04  4.10133778e+04  1.09868249e+05
  2.54068468e+05  5.48498736e+05  1.15244669e+06  2.43022943e+06
  5.37496427e+06]
E1 = -706.6653612571367  E_coul = 198.73547575579263
cycle= 3 E= -507.929885501344  delta_E= -1.42e-05  |g|= 0.000944  |ddm|= 0.00987
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000770116
diis-c [-2.00986770e-08  5.09019989e-05 -5.03179123e-02  1.05026701e+00]
  HOMO = -0.238118810596092  LUMO = 9.37174453972356
  mo_energy =
[-1.20313437e+02 -1.23760154e+01 -6.67668537e+00 -6.67668537e+00
 -6.67668537e+00 -1.16373867e+00 -2.38118811e-01 -2.38118811e-01
 -2.38118811e-01  9.37174454e+00  9.09551311e+01  4.77156612e+02
  2.24679623e+03  1.14220242e+04  4.10133743e+04  1.09868245e+05
  2.54068465e+05  5.48498732e+05  1.15244668e+06  2.43022943e+06
  5.37496426e+06]
E1 = -706.6645187879872  E_coul = 198.7346332483532
cycle= 4 E= -507.929885539634  delta_E= -3.83e-08  |g|= 8.47e-06  |ddm|= 0.000544
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.16107e-06
diis-c [-6.28067758e-12 -2.17223792e-06  2.53986380e-03 -5.09377120e-02
  1.04840002e+00]
  HOMO = -0.23812015722664  LUMO = 9.37174271622425
  mo_energy =
[-1.20313438e+02 -1.23760203e+01 -6.67668946e+00 -6.67668946e+00
 -6.67668946e+00 -1.16373942e+00 -2.38120157e-01 -2.38120157e-01
 -2.38120157e-01  9.37174272e+00  9.09551283e+01  4.77156611e+02
  2.24679623e+03  1.14220242e+04  4.10133743e+04  1.09868245e+05
  2.54068465e+05  5.48498732e+05  1.15244668e+06  2.43022943e+06
  5.37496426e+06]
E1 = -706.6645160290319  E_coul = 198.7346304893952
cycle= 5 E= -507.929885539637  delta_E= -2.79e-12  |g|= 1.52e-07  |ddm|= 3.62e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6645160290319  E_coul = 198.7346304893952
  HOMO = -0.238120194554647  LUMO = 9.37174264540038
  mo_energy =
[-1.20313438e+02 -1.23760205e+01 -6.67668964e+00 -6.67668964e+00
 -6.67668964e+00 -1.16373944e+00 -2.38120195e-01 -2.38120195e-01
 -2.38120195e-01  9.37174265e+00  9.09551280e+01  4.77156611e+02
  2.24679623e+03  1.14220242e+04  4.10133743e+04  1.09868245e+05
  2.54068465e+05  5.48498732e+05  1.15244668e+06  2.43022943e+06
  5.37496426e+06]
E1 = -706.6645159248848  E_coul = 198.73463038524815
Extra cycle  E= -507.929885539637  delta_E= 1.14e-13  |g|= 8.13e-09  |ddm|= 8.21e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [3.96587881e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33176984e+03
 1.83771598e+04 1.23894450e+03 2.98508434e+02 9.25346272e+01
 3.28888779e+01 7.86063725e+00 3.09176017e+00 8.60323340e+00
 4.93009673e-01]
E = -507.92988553963664
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.39658788139        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035647        1
[INPUT] 0    0    [1    /1   ]  147021.017796        1
[INPUT] 0    0    [1    /1   ]  73510.5078795        1
[INPUT] 0    0    [1    /1   ]  36755.2338831        1
[INPUT] 0    0    [1    /1   ]  7331.76984037        1
[INPUT] 0    0    [1    /1   ]  18377.1597664        1
[INPUT] 0    0    [1    /1   ]  1238.94450192        1
[INPUT] 0    0    [1    /1   ]  298.508433765        1
[INPUT] 0    0    [1    /1   ]  92.5346272255        1
[INPUT] 0    0    [1    /1   ]  32.8888779127        1
[INPUT] 0    0    [1    /1   ]  7.86063725013        1
[INPUT] 0    0    [1    /1   ]  3.09176016935        1
[INPUT] 1    0    [1    /1   ]  8.60323340198        1
[INPUT] 1    0    [1    /1   ]  0.493009672949       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3965878813899371, 1.0]], [0, [1176168.1426065646, 1.0]], [0, [588084.0713017577, 1.0]], [0, [294042.03564663435, 1.0]], [0, [147021.01779642887, 1.0]], [0, [73510.5078794762, 1.0]], [0, [36755.233883093046, 1.0]], [0, [7331.7698403707045, 1.0]], [0, [18377.159766410387, 1.0]], [0, [1238.9445019244706, 1.0]], [0, [298.50843376549363, 1.0]], [0, [92.53462722547329, 1.0]], [0, [32.88887791267923, 1.0]], [0, [7.86063725012527, 1.0]], [0, [3.091760169346847, 1.0]], [1, [8.603233401984749, 1.0]], [1, [0.49300967294891057, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39658788]
bas 1, expnt(s) = [1176168.14260656]
bas 2, expnt(s) = [588084.07130176]
bas 3, expnt(s) = [294042.03564663]
bas 4, expnt(s) = [147021.01779643]
bas 5, expnt(s) = [73510.50787948]
bas 6, expnt(s) = [36755.23388309]
bas 7, expnt(s) = [7331.76984037]
bas 8, expnt(s) = [18377.15976641]
bas 9, expnt(s) = [1238.94450192]
bas 10, expnt(s) = [298.50843377]
bas 11, expnt(s) = [92.53462723]
bas 12, expnt(s) = [32.88887791]
bas 13, expnt(s) = [7.86063725]
bas 14, expnt(s) = [3.09176017]
bas 15, expnt(s) = [8.6032334]
bas 16, expnt(s) = [0.49300967]
CPU time:       875.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96587881e-01 1.26261110e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552339e+04 6.70663108e+03 7.33176984e+03 2.00180441e+03
 1.83771598e+04 3.98771230e+03 1.23894450e+03 5.27598939e+02
 2.98508434e+02 1.81439767e+02 9.25346272e+01 7.53777612e+01
 3.28888779e+01 3.46977902e+01 7.86063725e+00 1.18606459e+01
 3.09176017e+00 5.89073346e+00 8.60323340e+00 4.29844648e+01
 4.93009673e-01 1.20518493e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325247123162896
cond(S) = 12535.831674613879
E1 = -689.3879633558212  E_coul = 184.91436253193206
init E= -504.473600823889
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67454420061024  LUMO = 8.49652319854738
  mo_energy =
[-1.21700114e+02 -1.33871842e+01 -7.62780142e+00 -7.62780142e+00
 -7.62780142e+00 -1.63982612e+00 -6.74544201e-01 -6.74544201e-01
 -6.74544201e-01  8.49652320e+00  8.96827070e+01  4.75786975e+02
  2.24549668e+03  1.14208603e+04  4.10122861e+04  1.09867197e+05
  2.54067444e+05  5.48497733e+05  1.15244570e+06  2.43022846e+06
  5.37496329e+06]
E1 = -707.056803358703  E_coul = 199.13376138740568
cycle= 1 E= -507.923041971297  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593967
diis-c [-0.35279623  1.        ]
  HOMO = -0.232981028054242  LUMO = 9.38335642662134
  mo_energy =
[-1.20250503e+02 -1.23507498e+01 -6.64553958e+00 -6.64553958e+00
 -6.64553958e+00 -1.16109457e+00 -2.32981028e-01 -2.32981028e-01
 -2.32981028e-01  9.38335643e+00  9.09998065e+01  4.77220373e+02
  2.24687472e+03  1.14221126e+04  4.10134659e+04  1.09868338e+05
  2.54068558e+05  5.48498826e+05  1.15244678e+06  2.43022952e+06
  5.37496436e+06]
E1 = -706.6815827530909  E_coul = 198.75171143117646
cycle= 2 E= -507.929871321914  delta_E= -0.00683  |g|= 0.0188  |ddm|= 0.209
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157053
diis-c [-2.39922170e-04  4.35111794e-03  9.95648882e-01]
  HOMO = -0.237862119549655  LUMO = 9.37231326492453
  mo_energy =
[-1.20310673e+02 -1.23747856e+01 -6.67519929e+00 -6.67519929e+00
 -6.67519929e+00 -1.16361173e+00 -2.37862120e-01 -2.37862120e-01
 -2.37862120e-01  9.37231326e+00  9.09571800e+01  4.77159367e+02
  2.24679942e+03  1.14220276e+04  4.10133778e+04  1.09868249e+05
  2.54068468e+05  5.48498736e+05  1.15244669e+06  2.43022943e+06
  5.37496427e+06]
E1 = -706.6653612571367  E_coul = 198.73547575579263
cycle= 3 E= -507.929885501344  delta_E= -1.42e-05  |g|= 0.000944  |ddm|= 0.00987
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000770116
diis-c [-2.00986770e-08  5.09019989e-05 -5.03179123e-02  1.05026701e+00]
  HOMO = -0.238118810596092  LUMO = 9.37174453972356
  mo_energy =
[-1.20313437e+02 -1.23760154e+01 -6.67668537e+00 -6.67668537e+00
 -6.67668537e+00 -1.16373867e+00 -2.38118811e-01 -2.38118811e-01
 -2.38118811e-01  9.37174454e+00  9.09551311e+01  4.77156612e+02
  2.24679623e+03  1.14220242e+04  4.10133743e+04  1.09868245e+05
  2.54068465e+05  5.48498732e+05  1.15244668e+06  2.43022943e+06
  5.37496426e+06]
E1 = -706.6645187879872  E_coul = 198.7346332483532
cycle= 4 E= -507.929885539634  delta_E= -3.83e-08  |g|= 8.47e-06  |ddm|= 0.000544
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.16107e-06
diis-c [-6.28067758e-12 -2.17223792e-06  2.53986380e-03 -5.09377120e-02
  1.04840002e+00]
  HOMO = -0.23812015722664  LUMO = 9.37174271622425
  mo_energy =
[-1.20313438e+02 -1.23760203e+01 -6.67668946e+00 -6.67668946e+00
 -6.67668946e+00 -1.16373942e+00 -2.38120157e-01 -2.38120157e-01
 -2.38120157e-01  9.37174272e+00  9.09551283e+01  4.77156611e+02
  2.24679623e+03  1.14220242e+04  4.10133743e+04  1.09868245e+05
  2.54068465e+05  5.48498732e+05  1.15244668e+06  2.43022943e+06
  5.37496426e+06]
E1 = -706.6645160290319  E_coul = 198.7346304893952
cycle= 5 E= -507.929885539637  delta_E= -2.79e-12  |g|= 1.52e-07  |ddm|= 3.62e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6645160290319  E_coul = 198.7346304893952
  HOMO = -0.238120194554647  LUMO = 9.37174264540038
  mo_energy =
[-1.20313438e+02 -1.23760205e+01 -6.67668964e+00 -6.67668964e+00
 -6.67668964e+00 -1.16373944e+00 -2.38120195e-01 -2.38120195e-01
 -2.38120195e-01  9.37174265e+00  9.09551280e+01  4.77156611e+02
  2.24679623e+03  1.14220242e+04  4.10133743e+04  1.09868245e+05
  2.54068465e+05  5.48498732e+05  1.15244668e+06  2.43022943e+06
  5.37496426e+06]
E1 = -706.6645159248848  E_coul = 198.73463038524815
Extra cycle  E= -507.929885539637  delta_E= 1.14e-13  |g|= 8.13e-09  |ddm|= 8.21e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12535.831674613879
E1 = -706.6645159248848  E_coul = 198.73463038524815
init E= -507.929885539637
    CPU time for initialize scf      1.55 sec, wall time      0.10 sec
  HOMO = -0.238120196405514  LUMO = 9.37174264104061
  mo_energy =
[-1.20313438e+02 -1.23760205e+01 -6.67668965e+00 -6.67668965e+00
 -6.67668965e+00 -1.16373944e+00 -2.38120196e-01 -2.38120196e-01
 -2.38120196e-01  9.37174264e+00  9.09551280e+01  4.77156611e+02
  2.24679623e+03  1.14220242e+04  4.10133743e+04  1.09868245e+05
  2.54068465e+05  5.48498732e+05  1.15244668e+06  2.43022943e+06
  5.37496426e+06]
E1 = -706.6645159199034  E_coul = 198.7346303802659
cycle= 1 E= -507.929885539637  delta_E= -7.96e-13  |g|= 9.4e-10  |ddm|= 4.29e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6645159199034  E_coul = 198.7346303802659
  HOMO = -0.238120196500996  LUMO = 9.37174264170511
  mo_energy =
[-1.20313438e+02 -1.23760205e+01 -6.67668965e+00 -6.67668965e+00
 -6.67668965e+00 -1.16373944e+00 -2.38120197e-01 -2.38120197e-01
 -2.38120197e-01  9.37174264e+00  9.09551280e+01  4.77156611e+02
  2.24679623e+03  1.14220242e+04  4.10133743e+04  1.09868245e+05
  2.54068465e+05  5.48498732e+05  1.15244668e+06  2.43022943e+06
  5.37496426e+06]
E1 = -706.6645159196488  E_coul = 198.7346303800118
Extra cycle  E= -507.929885539637  delta_E= 4.55e-13  |g|= 9.58e-10  |ddm|= 2.37e-10
    CPU time for scf_cycle      1.70 sec, wall time      0.17 sec
exp = [3.96587881e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552339e+04 7.33176984e+03
 1.83771598e+04 1.23894450e+03 2.98508434e+02 9.25346272e+01
 3.28888779e+01 7.86063725e+00 3.09176017e+00 8.60323340e+00
 4.93009673e-01]
grad_E = [-1.53185967e-03 -2.42161134e-11  3.82020334e-10  1.26720633e-09
  7.56202812e-09  2.45783659e-08  1.51888297e-07  8.26933981e-06
  3.65252174e-07  5.58613118e-05 -6.39145295e-04  1.93343252e-04
 -4.02907358e-04 -9.24168063e-05  9.50618575e-06 -1.04154456e-03
 -1.52798141e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396503124619       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035646        1
[INPUT] 0    0    [1    /1   ]  147021.017794        1
[INPUT] 0    0    [1    /1   ]  73510.50787          1
[INPUT] 0    0    [1    /1   ]  36755.2338248        1
[INPUT] 0    0    [1    /1   ]  7331.76666491        1
[INPUT] 0    0    [1    /1   ]  18377.1596261        1
[INPUT] 0    0    [1    /1   ]  1238.9234153         1
[INPUT] 0    0    [1    /1   ]  298.741884086        1
[INPUT] 0    0    [1    /1   ]  92.5664007277        1
[INPUT] 0    0    [1    /1   ]  32.7877803987        1
[INPUT] 0    0    [1    /1   ]  7.85269506511        1
[INPUT] 0    0    [1    /1   ]  3.08711535249        1
[INPUT] 1    0    [1    /1   ]  8.60199342023        1
[INPUT] 1    0    [1    /1   ]  0.492938868187       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39650312461862347, 1.0]], [0, [1176168.1426065739, 1.0]], [0, [588084.071301611, 1.0]], [0, [294042.03564614773, 1.0]], [0, [147021.01779352545, 1.0]], [0, [73510.50787003852, 1.0]], [0, [36755.23382477605, 1.0]], [0, [7331.766664914211, 1.0]], [0, [18377.159626145272, 1.0]], [0, [1238.923415300047, 1.0]], [0, [298.7418840857735, 1.0]], [0, [92.56640072774567, 1.0]], [0, [32.787780398685264, 1.0]], [0, [7.852695065109851, 1.0]], [0, [3.0871153524875874, 1.0]], [1, [8.601993420231413, 1.0]], [1, [0.4929388681873408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39650312]
bas 1, expnt(s) = [1176168.14260657]
bas 2, expnt(s) = [588084.07130161]
bas 3, expnt(s) = [294042.03564615]
bas 4, expnt(s) = [147021.01779353]
bas 5, expnt(s) = [73510.50787004]
bas 6, expnt(s) = [36755.23382478]
bas 7, expnt(s) = [7331.76666491]
bas 8, expnt(s) = [18377.15962615]
bas 9, expnt(s) = [1238.9234153]
bas 10, expnt(s) = [298.74188409]
bas 11, expnt(s) = [92.56640073]
bas 12, expnt(s) = [32.7877804]
bas 13, expnt(s) = [7.85269507]
bas 14, expnt(s) = [3.08711535]
bas 15, expnt(s) = [8.60199342]
bas 16, expnt(s) = [0.49293887]
CPU time:       880.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96503125e-01 1.26240872e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552338e+04 6.70663107e+03 7.33176666e+03 2.00180376e+03
 1.83771596e+04 3.98771227e+03 1.23892342e+03 5.27592205e+02
 2.98741884e+02 1.81546178e+02 9.25664007e+01 7.53971721e+01
 3.27877804e+01 3.46177660e+01 7.85269507e+00 1.18516570e+01
 3.08711535e+00 5.88409488e+00 8.60199342e+00 4.29767208e+01
 4.92938868e-01 1.20496858e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32535770905337
cond(S) = 12535.89024035805
E1 = -689.3801545699712  E_coul = 184.9060595776151
init E= -504.474094992356
    CPU time for initialize scf      4.48 sec, wall time      0.34 sec
  HOMO = -0.674637401171002  LUMO = 8.4725431673548
  mo_energy =
[-1.21701588e+02 -1.33878080e+01 -7.62836908e+00 -7.62836908e+00
 -7.62836908e+00 -1.63988656e+00 -6.74637401e-01 -6.74637401e-01
 -6.74637401e-01  8.47254317e+00  8.94641440e+01  4.75614107e+02
  2.24584084e+03  1.14213556e+04  4.10127601e+04  1.09867651e+05
  2.54067883e+05  5.48498158e+05  1.15244611e+06  2.43022886e+06
  5.37496368e+06]
E1 = -707.0456755597481  E_coul = 199.12256770571992
cycle= 1 E= -507.923107854028  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.59391
diis-c [-0.35272911  1.        ]
  HOMO = -0.233181514414172  LUMO = 9.35856143500457
  mo_energy =
[-1.20252339e+02 -1.23515388e+01 -6.64629146e+00 -6.64629146e+00
 -6.64629146e+00 -1.16124977e+00 -2.33181514e-01 -2.33181514e-01
 -2.33181514e-01  9.35856144e+00  9.07806219e+01  4.77047086e+02
  2.24721846e+03  1.14226073e+04  4.10139395e+04  1.09868791e+05
  2.54068996e+05  5.48499252e+05  1.15244719e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6696974487999  E_coul = 198.73974458013765
cycle= 2 E= -507.929952868662  delta_E= -0.00685  |g|= 0.0189  |ddm|= 0.209
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157208
diis-c [-2.40471695e-04  4.33216417e-03  9.95667836e-01]
  HOMO = -0.238077449370584  LUMO = 9.34750999989914
  mo_energy =
[-1.20312594e+02 -1.23756345e+01 -6.67601475e+00 -6.67601475e+00
 -6.67601475e+00 -1.16377621e+00 -2.38077449e-01 -2.38077449e-01
 -2.38077449e-01  9.34751000e+00  9.07379514e+01  4.76985989e+02
  2.24714307e+03  1.14225223e+04  4.10138513e+04  1.09868702e+05
  2.54068906e+05  5.48499161e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.653418726985  E_coul = 198.72345159955708
cycle= 3 E= -507.929967127428  delta_E= -1.43e-05  |g|= 0.000946  |ddm|= 0.00991
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000771183
diis-c [-2.04195936e-08  5.11700164e-05 -5.03270132e-02  1.05027584e+00]
  HOMO = -0.238335229916387  LUMO = 9.34694016113543
  mo_energy =
[-1.20315363e+02 -1.23768687e+01 -6.67750549e+00 -6.67750549e+00
 -6.67750549e+00 -1.16390377e+00 -2.38335230e-01 -2.38335230e-01
 -2.38335230e-01  9.34694016e+00  9.07358985e+01  4.76983228e+02
  2.24713987e+03  1.14225189e+04  4.10138478e+04  1.09868698e+05
  2.54068903e+05  5.48499157e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.6525723220036  E_coul = 198.72260515596568
cycle= 4 E= -507.929967166038  delta_E= -3.86e-08  |g|= 8.55e-06  |ddm|= 0.000546
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.23065e-06
diis-c [-6.33501764e-12 -2.18506657e-06  2.54807151e-03 -5.11143510e-02
  1.04856846e+00]
  HOMO = -0.238336599087893  LUMO = 9.34693829923668
  mo_energy =
[-1.20315364e+02 -1.23768736e+01 -6.67750967e+00 -6.67750967e+00
 -6.67750967e+00 -1.16390453e+00 -2.38336599e-01 -2.38336599e-01
 -2.38336599e-01  9.34693830e+00  9.07358956e+01  4.76983227e+02
  2.24713987e+03  1.14225189e+04  4.10138478e+04  1.09868698e+05
  2.54068903e+05  5.48499157e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.652569499657  E_coul = 198.72260233361598
cycle= 5 E= -507.929967166041  delta_E= -3.07e-12  |g|= 1.52e-07  |ddm|= 3.68e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.652569499657  E_coul = 198.72260233361598
  HOMO = -0.238336636490631  LUMO = 9.34693822802093
  mo_energy =
[-1.20315365e+02 -1.23768738e+01 -6.67750985e+00 -6.67750985e+00
 -6.67750985e+00 -1.16390455e+00 -2.38336636e-01 -2.38336636e-01
 -2.38336636e-01  9.34693823e+00  9.07358954e+01  4.76983227e+02
  2.24713987e+03  1.14225189e+04  4.10138478e+04  1.09868698e+05
  2.54068903e+05  5.48499157e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.6525693951612  E_coul = 198.72260222912033
Extra cycle  E= -507.929967166041  delta_E= 1.14e-13  |g|= 8.12e-09  |ddm|= 8.24e-08
    CPU time for scf_cycle      4.72 sec, wall time      0.41 sec
exp = [3.96503125e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552338e+04 7.33176666e+03
 1.83771596e+04 1.23892342e+03 2.98741884e+02 9.25664007e+01
 3.27877804e+01 7.85269507e+00 3.08711535e+00 8.60199342e+00
 4.92938868e-01]
E = -507.9299671660409
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396503124619       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071302        1
[INPUT] 0    0    [1    /1   ]  294042.035646        1
[INPUT] 0    0    [1    /1   ]  147021.017794        1
[INPUT] 0    0    [1    /1   ]  73510.50787          1
[INPUT] 0    0    [1    /1   ]  36755.2338248        1
[INPUT] 0    0    [1    /1   ]  7331.76666491        1
[INPUT] 0    0    [1    /1   ]  18377.1596261        1
[INPUT] 0    0    [1    /1   ]  1238.9234153         1
[INPUT] 0    0    [1    /1   ]  298.741884086        1
[INPUT] 0    0    [1    /1   ]  92.5664007277        1
[INPUT] 0    0    [1    /1   ]  32.7877803987        1
[INPUT] 0    0    [1    /1   ]  7.85269506511        1
[INPUT] 0    0    [1    /1   ]  3.08711535249        1
[INPUT] 1    0    [1    /1   ]  8.60199342023        1
[INPUT] 1    0    [1    /1   ]  0.492938868187       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39650312461862347, 1.0]], [0, [1176168.1426065739, 1.0]], [0, [588084.071301611, 1.0]], [0, [294042.03564614773, 1.0]], [0, [147021.01779352545, 1.0]], [0, [73510.50787003852, 1.0]], [0, [36755.23382477605, 1.0]], [0, [7331.766664914211, 1.0]], [0, [18377.159626145272, 1.0]], [0, [1238.923415300047, 1.0]], [0, [298.7418840857735, 1.0]], [0, [92.56640072774567, 1.0]], [0, [32.787780398685264, 1.0]], [0, [7.852695065109851, 1.0]], [0, [3.0871153524875874, 1.0]], [1, [8.601993420231413, 1.0]], [1, [0.4929388681873408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39650312]
bas 1, expnt(s) = [1176168.14260657]
bas 2, expnt(s) = [588084.07130161]
bas 3, expnt(s) = [294042.03564615]
bas 4, expnt(s) = [147021.01779353]
bas 5, expnt(s) = [73510.50787004]
bas 6, expnt(s) = [36755.23382478]
bas 7, expnt(s) = [7331.76666491]
bas 8, expnt(s) = [18377.15962615]
bas 9, expnt(s) = [1238.9234153]
bas 10, expnt(s) = [298.74188409]
bas 11, expnt(s) = [92.56640073]
bas 12, expnt(s) = [32.7877804]
bas 13, expnt(s) = [7.85269507]
bas 14, expnt(s) = [3.08711535]
bas 15, expnt(s) = [8.60199342]
bas 16, expnt(s) = [0.49293887]
CPU time:       885.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96503125e-01 1.26240872e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105079e+04 1.12791687e+04
 3.67552338e+04 6.70663107e+03 7.33176666e+03 2.00180376e+03
 1.83771596e+04 3.98771227e+03 1.23892342e+03 5.27592205e+02
 2.98741884e+02 1.81546178e+02 9.25664007e+01 7.53971721e+01
 3.27877804e+01 3.46177660e+01 7.85269507e+00 1.18516570e+01
 3.08711535e+00 5.88409488e+00 8.60199342e+00 4.29767208e+01
 4.92938868e-01 1.20496858e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32535770905337
cond(S) = 12535.89024035805
E1 = -689.3801545699712  E_coul = 184.9060595776151
init E= -504.474094992356
    CPU time for initialize scf      4.90 sec, wall time      0.34 sec
  HOMO = -0.674637401171002  LUMO = 8.4725431673548
  mo_energy =
[-1.21701588e+02 -1.33878080e+01 -7.62836908e+00 -7.62836908e+00
 -7.62836908e+00 -1.63988656e+00 -6.74637401e-01 -6.74637401e-01
 -6.74637401e-01  8.47254317e+00  8.94641440e+01  4.75614107e+02
  2.24584084e+03  1.14213556e+04  4.10127601e+04  1.09867651e+05
  2.54067883e+05  5.48498158e+05  1.15244611e+06  2.43022886e+06
  5.37496368e+06]
E1 = -707.0456755597481  E_coul = 199.12256770571992
cycle= 1 E= -507.923107854028  delta_E= -3.45  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.59391
diis-c [-0.35272911  1.        ]
  HOMO = -0.233181514414172  LUMO = 9.35856143500457
  mo_energy =
[-1.20252339e+02 -1.23515388e+01 -6.64629146e+00 -6.64629146e+00
 -6.64629146e+00 -1.16124977e+00 -2.33181514e-01 -2.33181514e-01
 -2.33181514e-01  9.35856144e+00  9.07806219e+01  4.77047086e+02
  2.24721846e+03  1.14226073e+04  4.10139395e+04  1.09868791e+05
  2.54068996e+05  5.48499252e+05  1.15244719e+06  2.43022993e+06
  5.37496475e+06]
E1 = -706.6696974487999  E_coul = 198.73974458013765
cycle= 2 E= -507.929952868662  delta_E= -0.00685  |g|= 0.0189  |ddm|= 0.209
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157208
diis-c [-2.40471695e-04  4.33216417e-03  9.95667836e-01]
  HOMO = -0.238077449370584  LUMO = 9.34750999989914
  mo_energy =
[-1.20312594e+02 -1.23756345e+01 -6.67601475e+00 -6.67601475e+00
 -6.67601475e+00 -1.16377621e+00 -2.38077449e-01 -2.38077449e-01
 -2.38077449e-01  9.34751000e+00  9.07379514e+01  4.76985989e+02
  2.24714307e+03  1.14225223e+04  4.10138513e+04  1.09868702e+05
  2.54068906e+05  5.48499161e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.653418726985  E_coul = 198.72345159955708
cycle= 3 E= -507.929967127428  delta_E= -1.43e-05  |g|= 0.000946  |ddm|= 0.00991
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000771183
diis-c [-2.04195936e-08  5.11700164e-05 -5.03270132e-02  1.05027584e+00]
  HOMO = -0.238335229916387  LUMO = 9.34694016113543
  mo_energy =
[-1.20315363e+02 -1.23768687e+01 -6.67750549e+00 -6.67750549e+00
 -6.67750549e+00 -1.16390377e+00 -2.38335230e-01 -2.38335230e-01
 -2.38335230e-01  9.34694016e+00  9.07358985e+01  4.76983228e+02
  2.24713987e+03  1.14225189e+04  4.10138478e+04  1.09868698e+05
  2.54068903e+05  5.48499157e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.6525723220036  E_coul = 198.72260515596568
cycle= 4 E= -507.929967166038  delta_E= -3.86e-08  |g|= 8.55e-06  |ddm|= 0.000546
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.23065e-06
diis-c [-6.33501764e-12 -2.18506657e-06  2.54807151e-03 -5.11143510e-02
  1.04856846e+00]
  HOMO = -0.238336599087893  LUMO = 9.34693829923668
  mo_energy =
[-1.20315364e+02 -1.23768736e+01 -6.67750967e+00 -6.67750967e+00
 -6.67750967e+00 -1.16390453e+00 -2.38336599e-01 -2.38336599e-01
 -2.38336599e-01  9.34693830e+00  9.07358956e+01  4.76983227e+02
  2.24713987e+03  1.14225189e+04  4.10138478e+04  1.09868698e+05
  2.54068903e+05  5.48499157e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.652569499657  E_coul = 198.72260233361598
cycle= 5 E= -507.929967166041  delta_E= -3.07e-12  |g|= 1.52e-07  |ddm|= 3.68e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.652569499657  E_coul = 198.72260233361598
  HOMO = -0.238336636490631  LUMO = 9.34693822802093
  mo_energy =
[-1.20315365e+02 -1.23768738e+01 -6.67750985e+00 -6.67750985e+00
 -6.67750985e+00 -1.16390455e+00 -2.38336636e-01 -2.38336636e-01
 -2.38336636e-01  9.34693823e+00  9.07358954e+01  4.76983227e+02
  2.24713987e+03  1.14225189e+04  4.10138478e+04  1.09868698e+05
  2.54068903e+05  5.48499157e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.6525693951612  E_coul = 198.72260222912033
Extra cycle  E= -507.929967166041  delta_E= 1.14e-13  |g|= 8.12e-09  |ddm|= 8.24e-08
    CPU time for scf_cycle      5.11 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12535.89024035805
E1 = -706.6525693951612  E_coul = 198.72260222912033
init E= -507.929967166041
    CPU time for initialize scf      9.87 sec, wall time      0.66 sec
  HOMO = -0.238336638349518  LUMO = 9.34693822456219
  mo_energy =
[-1.20315365e+02 -1.23768738e+01 -6.67750986e+00 -6.67750986e+00
 -6.67750986e+00 -1.16390455e+00 -2.38336638e-01 -2.38336638e-01
 -2.38336638e-01  9.34693822e+00  9.07358954e+01  4.76983227e+02
  2.24713987e+03  1.14225189e+04  4.10138478e+04  1.09868698e+05
  2.54068903e+05  5.48499157e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.6525693901524  E_coul = 198.72260222411137
cycle= 1 E= -507.929967166041  delta_E= -1.14e-13  |g|= 8.88e-10  |ddm|= 4.29e-09
    CPU time for cycle= 1      0.09 sec, wall time      0.01 sec
E1 = -706.6525693901524  E_coul = 198.72260222411137
  HOMO = -0.238336638445089  LUMO = 9.34693822474015
  mo_energy =
[-1.20315365e+02 -1.23768738e+01 -6.67750986e+00 -6.67750986e+00
 -6.67750986e+00 -1.16390455e+00 -2.38336638e-01 -2.38336638e-01
 -2.38336638e-01  9.34693822e+00  9.07358954e+01  4.76983227e+02
  2.24713987e+03  1.14225189e+04  4.10138478e+04  1.09868698e+05
  2.54068903e+05  5.48499157e+05  1.15244710e+06  2.43022983e+06
  5.37496465e+06]
E1 = -706.6525693899179  E_coul = 198.722602223877
Extra cycle  E= -507.929967166041  delta_E= 1.71e-13  |g|= 7.86e-10  |ddm|= 2.45e-10
    CPU time for scf_cycle     10.03 sec, wall time      0.74 sec
exp = [3.96503125e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105079e+04 3.67552338e+04 7.33176666e+03
 1.83771596e+04 1.23892342e+03 2.98741884e+02 9.25664007e+01
 3.27877804e+01 7.85269507e+00 3.08711535e+00 8.60199342e+00
 4.92938868e-01]
grad_E = [-2.98338221e-03 -2.41293430e-11  3.82607066e-10  1.26943989e-09
  7.57316161e-09  2.46205001e-08  1.52109518e-07  8.28172463e-06
  3.65973162e-07  5.55683335e-05 -6.55210788e-04  3.54114094e-04
 -7.62942126e-04 -1.69110816e-04  9.28951818e-05 -2.06048387e-03
 -3.21732550e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.39636363307        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071301        1
[INPUT] 0    0    [1    /1   ]  294042.035645        1
[INPUT] 0    0    [1    /1   ]  147021.017785        1
[INPUT] 0    0    [1    /1   ]  73510.5078427        1
[INPUT] 0    0    [1    /1   ]  36755.2336562        1
[INPUT] 0    0    [1    /1   ]  7331.75748159        1
[INPUT] 0    0    [1    /1   ]  18377.1592199        1
[INPUT] 0    0    [1    /1   ]  1238.86729647        1
[INPUT] 0    0    [1    /1   ]  299.363926078        1
[INPUT] 0    0    [1    /1   ]  92.7303242951        1
[INPUT] 0    0    [1    /1   ]  32.6689080846        1
[INPUT] 0    0    [1    /1   ]  7.84447156126        1
[INPUT] 0    0    [1    /1   ]  3.08165106659        1
[INPUT] 1    0    [1    /1   ]  8.59995660347        1
[INPUT] 1    0    [1    /1   ]  0.492821123121       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3963636330704666, 1.0]], [0, [1176168.1426066002, 1.0]], [0, [588084.0713011869, 1.0]], [0, [294042.03564473963, 1.0]], [0, [147021.01778513374, 1.0]], [0, [73510.50784273294, 1.0]], [0, [36755.233656231605, 1.0]], [0, [7331.757481586664, 1.0]], [0, [18377.159219866913, 1.0]], [0, [1238.8672964743405, 1.0]], [0, [299.36392607752424, 1.0]], [0, [92.7303242950635, 1.0]], [0, [32.66890808460959, 1.0]], [0, [7.844471561264444, 1.0]], [0, [3.0816510665860553, 1.0]], [1, [8.599956603474386, 1.0]], [1, [0.492821123120878, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39636363]
bas 1, expnt(s) = [1176168.1426066]
bas 2, expnt(s) = [588084.07130119]
bas 3, expnt(s) = [294042.03564474]
bas 4, expnt(s) = [147021.01778513]
bas 5, expnt(s) = [73510.50784273]
bas 6, expnt(s) = [36755.23365623]
bas 7, expnt(s) = [7331.75748159]
bas 8, expnt(s) = [18377.15921987]
bas 9, expnt(s) = [1238.86729647]
bas 10, expnt(s) = [299.36392608]
bas 11, expnt(s) = [92.7303243]
bas 12, expnt(s) = [32.66890808]
bas 13, expnt(s) = [7.84447156]
bas 14, expnt(s) = [3.08165107]
bas 15, expnt(s) = [8.5999566]
bas 16, expnt(s) = [0.49282112]
CPU time:       903.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96363633e-01 1.26207561e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105078e+04 1.12791687e+04
 3.67552337e+04 6.70663105e+03 7.33175748e+03 2.00180188e+03
 1.83771592e+04 3.98771221e+03 1.23886730e+03 5.27574281e+02
 2.99363926e+02 1.81829617e+02 9.27303243e+01 7.54972892e+01
 3.26689081e+01 3.45235930e+01 7.84447156e+00 1.18423473e+01
 3.08165107e+00 5.87628189e+00 8.59995660e+00 4.29640009e+01
 4.92821123e-01 1.20460881e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325538850680072
cond(S) = 12536.281445206096
E1 = -689.3667395088697  E_coul = 184.89228520234968
init E= -504.47445430652
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.674794071974133  LUMO = 8.44485680534372
  mo_energy =
[-1.21704057e+02 -1.33888432e+01 -7.62931152e+00 -7.62931152e+00
 -7.62931152e+00 -1.63999361e+00 -6.74794072e-01 -6.74794072e-01
 -6.74794072e-01  8.44485681e+00  8.92578355e+01  4.75974561e+02
  2.24766956e+03  1.14234875e+04  4.10147736e+04  1.09869578e+05
  2.54069746e+05  5.48499966e+05  1.15244787e+06  2.43023056e+06
  5.37496534e+06]
E1 = -707.0273095504893  E_coul = 199.10401369259037
cycle= 1 E= -507.923295857899  delta_E= -3.45  |g|= 0.445  |ddm|= 0.357
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593818
diis-c [-0.35262023  1.        ]
  HOMO = -0.233516318960332  LUMO = 9.32988819243502
  mo_energy =
[-1.20255382e+02 -1.23528520e+01 -6.64754240e+00 -6.64754240e+00
 -6.64754240e+00 -1.16151510e+00 -2.33516319e-01 -2.33516319e-01
 -2.33516319e-01  9.32988819e+00  9.05735715e+01  4.77406900e+02
  2.24904654e+03  1.14247386e+04  4.10159523e+04  1.09870718e+05
  2.54070858e+05  5.48501059e+05  1.15244895e+06  2.43023163e+06
  5.37496640e+06]
E1 = -706.6504812994901  E_coul = 198.72032284392714
cycle= 2 E= -507.930158455563  delta_E= -0.00686  |g|= 0.0189  |ddm|= 0.21
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157401
diis-c [-2.41162383e-04  4.30570424e-03  9.95694296e-01]
  HOMO = -0.238428834867073  LUMO = 9.31882717608503
  mo_energy =
[-1.20315731e+02 -1.23770162e+01 -6.67733729e+00 -6.67733729e+00
 -6.67733729e+00 -1.16405214e+00 -2.38428835e-01 -2.38428835e-01
 -2.38428835e-01  9.31882718e+00  9.05308434e+01  4.77345689e+02
  2.24897104e+03  1.14246535e+04  4.10158640e+04  1.09870628e+05
  2.54070768e+05  5.48500968e+05  1.15244886e+06  2.43023154e+06
  5.37496631e+06]
E1 = -706.6341372844997  E_coul = 198.7039644788903
cycle= 3 E= -507.930172805609  delta_E= -1.44e-05  |g|= 0.000949  |ddm|= 0.00995
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000772414
diis-c [-2.08042578e-08  5.14372668e-05 -5.03330565e-02  1.05028162e+00]
  HOMO = -0.238687824745025  LUMO = 9.31825609540518
  mo_energy =
[-1.20318507e+02 -1.23782553e+01 -6.67883318e+00 -6.67883318e+00
 -6.67883318e+00 -1.16418039e+00 -2.38687825e-01 -2.38687825e-01
 -2.38687825e-01  9.31825610e+00  9.05287858e+01  4.77342921e+02
  2.24896784e+03  1.14246500e+04  4.10158604e+04  1.09870624e+05
  2.54070765e+05  5.48500965e+05  1.15244885e+06  2.43023154e+06
  5.37496630e+06]
E1 = -706.633286439693  E_coul = 198.70311359510995
cycle= 4 E= -507.930172844583  delta_E= -3.9e-08  |g|= 8.65e-06  |ddm|= 0.000549
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.31123e-06
diis-c [-6.40612855e-12 -2.18784701e-06  2.55633486e-03 -5.13021828e-02
  1.04874804e+00]
  HOMO = -0.238689219751262  LUMO = 9.31825419414653
  mo_energy =
[-1.20318508e+02 -1.23782604e+01 -6.67883747e+00 -6.67883747e+00
 -6.67883747e+00 -1.16418117e+00 -2.38689220e-01 -2.38689220e-01
 -2.38689220e-01  9.31825419e+00  9.05287828e+01  4.77342920e+02
  2.24896784e+03  1.14246500e+04  4.10158604e+04  1.09870624e+05
  2.54070765e+05  5.48500965e+05  1.15244885e+06  2.43023154e+06
  5.37496630e+06]
E1 = -706.6332835443228  E_coul = 198.70311069973616
cycle= 5 E= -507.930172844587  delta_E= -3.52e-12  |g|= 1.53e-07  |ddm|= 3.74e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6332835443228  E_coul = 198.70311069973616
  HOMO = -0.23868925724418  LUMO = 9.31825412212247
  mo_energy =
[-1.20318509e+02 -1.23782606e+01 -6.67883765e+00 -6.67883765e+00
 -6.67883765e+00 -1.16418118e+00 -2.38689257e-01 -2.38689257e-01
 -2.38689257e-01  9.31825412e+00  9.05287825e+01  4.77342919e+02
  2.24896784e+03  1.14246500e+04  4.10158604e+04  1.09870624e+05
  2.54070765e+05  5.48500965e+05  1.15244885e+06  2.43023154e+06
  5.37496630e+06]
E1 = -706.6332834395281  E_coul = 198.70311059494173
Extra cycle  E= -507.930172844586  delta_E= 2.84e-13  |g|= 8.22e-09  |ddm|= 8.26e-08
    CPU time for scf_cycle      5.01 sec, wall time      0.41 sec
exp = [3.96363633e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105078e+04 3.67552337e+04 7.33175748e+03
 1.83771592e+04 1.23886730e+03 2.99363926e+02 9.27303243e+01
 3.26689081e+01 7.84447156e+00 3.08165107e+00 8.59995660e+00
 4.92821123e-01]
E = -507.93017284458637
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.39636363307        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071301        1
[INPUT] 0    0    [1    /1   ]  294042.035645        1
[INPUT] 0    0    [1    /1   ]  147021.017785        1
[INPUT] 0    0    [1    /1   ]  73510.5078427        1
[INPUT] 0    0    [1    /1   ]  36755.2336562        1
[INPUT] 0    0    [1    /1   ]  7331.75748159        1
[INPUT] 0    0    [1    /1   ]  18377.1592199        1
[INPUT] 0    0    [1    /1   ]  1238.86729647        1
[INPUT] 0    0    [1    /1   ]  299.363926078        1
[INPUT] 0    0    [1    /1   ]  92.7303242951        1
[INPUT] 0    0    [1    /1   ]  32.6689080846        1
[INPUT] 0    0    [1    /1   ]  7.84447156126        1
[INPUT] 0    0    [1    /1   ]  3.08165106659        1
[INPUT] 1    0    [1    /1   ]  8.59995660347        1
[INPUT] 1    0    [1    /1   ]  0.492821123121       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3963636330704666, 1.0]], [0, [1176168.1426066002, 1.0]], [0, [588084.0713011869, 1.0]], [0, [294042.03564473963, 1.0]], [0, [147021.01778513374, 1.0]], [0, [73510.50784273294, 1.0]], [0, [36755.233656231605, 1.0]], [0, [7331.757481586664, 1.0]], [0, [18377.159219866913, 1.0]], [0, [1238.8672964743405, 1.0]], [0, [299.36392607752424, 1.0]], [0, [92.7303242950635, 1.0]], [0, [32.66890808460959, 1.0]], [0, [7.844471561264444, 1.0]], [0, [3.0816510665860553, 1.0]], [1, [8.599956603474386, 1.0]], [1, [0.492821123120878, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39636363]
bas 1, expnt(s) = [1176168.1426066]
bas 2, expnt(s) = [588084.07130119]
bas 3, expnt(s) = [294042.03564474]
bas 4, expnt(s) = [147021.01778513]
bas 5, expnt(s) = [73510.50784273]
bas 6, expnt(s) = [36755.23365623]
bas 7, expnt(s) = [7331.75748159]
bas 8, expnt(s) = [18377.15921987]
bas 9, expnt(s) = [1238.86729647]
bas 10, expnt(s) = [299.36392608]
bas 11, expnt(s) = [92.7303243]
bas 12, expnt(s) = [32.66890808]
bas 13, expnt(s) = [7.84447156]
bas 14, expnt(s) = [3.08165107]
bas 15, expnt(s) = [8.5999566]
bas 16, expnt(s) = [0.49282112]
CPU time:       908.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96363633e-01 1.26207561e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105078e+04 1.12791687e+04
 3.67552337e+04 6.70663105e+03 7.33175748e+03 2.00180188e+03
 1.83771592e+04 3.98771221e+03 1.23886730e+03 5.27574281e+02
 2.99363926e+02 1.81829617e+02 9.27303243e+01 7.54972892e+01
 3.26689081e+01 3.45235930e+01 7.84447156e+00 1.18423473e+01
 3.08165107e+00 5.87628189e+00 8.59995660e+00 4.29640009e+01
 4.92821123e-01 1.20460881e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325538850680072
cond(S) = 12536.281445206096
E1 = -689.3667395088697  E_coul = 184.89228520234968
init E= -504.47445430652
    CPU time for initialize scf      4.50 sec, wall time      0.34 sec
  HOMO = -0.674794071974133  LUMO = 8.44485680534372
  mo_energy =
[-1.21704057e+02 -1.33888432e+01 -7.62931152e+00 -7.62931152e+00
 -7.62931152e+00 -1.63999361e+00 -6.74794072e-01 -6.74794072e-01
 -6.74794072e-01  8.44485681e+00  8.92578355e+01  4.75974561e+02
  2.24766956e+03  1.14234875e+04  4.10147736e+04  1.09869578e+05
  2.54069746e+05  5.48499966e+05  1.15244787e+06  2.43023056e+06
  5.37496534e+06]
E1 = -707.0273095504893  E_coul = 199.10401369259037
cycle= 1 E= -507.923295857899  delta_E= -3.45  |g|= 0.445  |ddm|= 0.357
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593818
diis-c [-0.35262023  1.        ]
  HOMO = -0.233516318960332  LUMO = 9.32988819243502
  mo_energy =
[-1.20255382e+02 -1.23528520e+01 -6.64754240e+00 -6.64754240e+00
 -6.64754240e+00 -1.16151510e+00 -2.33516319e-01 -2.33516319e-01
 -2.33516319e-01  9.32988819e+00  9.05735715e+01  4.77406900e+02
  2.24904654e+03  1.14247386e+04  4.10159523e+04  1.09870718e+05
  2.54070858e+05  5.48501059e+05  1.15244895e+06  2.43023163e+06
  5.37496640e+06]
E1 = -706.6504812994901  E_coul = 198.72032284392714
cycle= 2 E= -507.930158455563  delta_E= -0.00686  |g|= 0.0189  |ddm|= 0.21
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157401
diis-c [-2.41162383e-04  4.30570424e-03  9.95694296e-01]
  HOMO = -0.238428834867073  LUMO = 9.31882717608503
  mo_energy =
[-1.20315731e+02 -1.23770162e+01 -6.67733729e+00 -6.67733729e+00
 -6.67733729e+00 -1.16405214e+00 -2.38428835e-01 -2.38428835e-01
 -2.38428835e-01  9.31882718e+00  9.05308434e+01  4.77345689e+02
  2.24897104e+03  1.14246535e+04  4.10158640e+04  1.09870628e+05
  2.54070768e+05  5.48500968e+05  1.15244886e+06  2.43023154e+06
  5.37496631e+06]
E1 = -706.6341372844997  E_coul = 198.7039644788903
cycle= 3 E= -507.930172805609  delta_E= -1.44e-05  |g|= 0.000949  |ddm|= 0.00995
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000772414
diis-c [-2.08042578e-08  5.14372668e-05 -5.03330565e-02  1.05028162e+00]
  HOMO = -0.238687824745025  LUMO = 9.31825609540518
  mo_energy =
[-1.20318507e+02 -1.23782553e+01 -6.67883318e+00 -6.67883318e+00
 -6.67883318e+00 -1.16418039e+00 -2.38687825e-01 -2.38687825e-01
 -2.38687825e-01  9.31825610e+00  9.05287858e+01  4.77342921e+02
  2.24896784e+03  1.14246500e+04  4.10158604e+04  1.09870624e+05
  2.54070765e+05  5.48500965e+05  1.15244885e+06  2.43023154e+06
  5.37496630e+06]
E1 = -706.633286439693  E_coul = 198.70311359510995
cycle= 4 E= -507.930172844583  delta_E= -3.9e-08  |g|= 8.65e-06  |ddm|= 0.000549
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.31123e-06
diis-c [-6.40612855e-12 -2.18784701e-06  2.55633486e-03 -5.13021828e-02
  1.04874804e+00]
  HOMO = -0.238689219751262  LUMO = 9.31825419414653
  mo_energy =
[-1.20318508e+02 -1.23782604e+01 -6.67883747e+00 -6.67883747e+00
 -6.67883747e+00 -1.16418117e+00 -2.38689220e-01 -2.38689220e-01
 -2.38689220e-01  9.31825419e+00  9.05287828e+01  4.77342920e+02
  2.24896784e+03  1.14246500e+04  4.10158604e+04  1.09870624e+05
  2.54070765e+05  5.48500965e+05  1.15244885e+06  2.43023154e+06
  5.37496630e+06]
E1 = -706.6332835443228  E_coul = 198.70311069973616
cycle= 5 E= -507.930172844587  delta_E= -3.52e-12  |g|= 1.53e-07  |ddm|= 3.74e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6332835443228  E_coul = 198.70311069973616
  HOMO = -0.23868925724418  LUMO = 9.31825412212247
  mo_energy =
[-1.20318509e+02 -1.23782606e+01 -6.67883765e+00 -6.67883765e+00
 -6.67883765e+00 -1.16418118e+00 -2.38689257e-01 -2.38689257e-01
 -2.38689257e-01  9.31825412e+00  9.05287825e+01  4.77342919e+02
  2.24896784e+03  1.14246500e+04  4.10158604e+04  1.09870624e+05
  2.54070765e+05  5.48500965e+05  1.15244885e+06  2.43023154e+06
  5.37496630e+06]
E1 = -706.6332834395281  E_coul = 198.70311059494173
Extra cycle  E= -507.930172844586  delta_E= 2.84e-13  |g|= 8.22e-09  |ddm|= 8.26e-08
    CPU time for scf_cycle      4.75 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12536.281445206096
E1 = -706.6332834395281  E_coul = 198.70311059494173
init E= -507.930172844586
    CPU time for initialize scf      9.04 sec, wall time      0.69 sec
  HOMO = -0.238689259110279  LUMO = 9.31825411775063
  mo_energy =
[-1.20318509e+02 -1.23782606e+01 -6.67883766e+00 -6.67883766e+00
 -6.67883766e+00 -1.16418119e+00 -2.38689259e-01 -2.38689259e-01
 -2.38689259e-01  9.31825412e+00  9.05287825e+01  4.77342919e+02
  2.24896784e+03  1.14246500e+04  4.10158604e+04  1.09870624e+05
  2.54070765e+05  5.48500965e+05  1.15244885e+06  2.43023154e+06
  5.37496630e+06]
E1 = -706.6332834345214  E_coul = 198.70311058993488
cycle= 1 E= -507.930172844587  delta_E= -1.71e-13  |g|= 9.48e-10  |ddm|= 4.34e-09
    CPU time for cycle= 1      0.08 sec, wall time      0.01 sec
E1 = -706.6332834345214  E_coul = 198.70311058993488
  HOMO = -0.23868925920698  LUMO = 9.31825411643119
  mo_energy =
[-1.20318509e+02 -1.23782606e+01 -6.67883766e+00 -6.67883766e+00
 -6.67883766e+00 -1.16418119e+00 -2.38689259e-01 -2.38689259e-01
 -2.38689259e-01  9.31825412e+00  9.05287825e+01  4.77342919e+02
  2.24896784e+03  1.14246500e+04  4.10158604e+04  1.09870624e+05
  2.54070765e+05  5.48500965e+05  1.15244885e+06  2.43023154e+06
  5.37496630e+06]
E1 = -706.633283434162  E_coul = 198.7031105895755
Extra cycle  E= -507.930172844586  delta_E= 5.68e-14  |g|= 8.6e-10  |ddm|= 2.61e-10
    CPU time for scf_cycle      9.19 sec, wall time      0.76 sec
exp = [3.96363633e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105078e+04 3.67552337e+04 7.33175748e+03
 1.83771592e+04 1.23886730e+03 2.99363926e+02 9.27303243e+01
 3.26689081e+01 7.84447156e+00 3.08165107e+00 8.59995660e+00
 4.92821123e-01]
grad_E = [-5.33660274e-03 -2.37781337e-11  3.84993569e-10  1.27851973e-09
  7.61845885e-09  2.47918016e-08  1.53010772e-07  8.33377375e-06
  3.68904658e-07  5.32491625e-05 -6.71313314e-04  6.03541364e-04
 -1.31979659e-03 -2.89749352e-04  2.49706962e-04 -3.72331488e-03
 -6.00077985e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396154382241       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.0713          1
[INPUT] 0    0    [1    /1   ]  294042.035641        1
[INPUT] 0    0    [1    /1   ]  147021.017763        1
[INPUT] 0    0    [1    /1   ]  73510.5077709        1
[INPUT] 0    0    [1    /1   ]  36755.2332128        1
[INPUT] 0    0    [1    /1   ]  7331.73331172        1
[INPUT] 0    0    [1    /1   ]  18377.1581497        1
[INPUT] 0    0    [1    /1   ]  1238.72621386        1
[INPUT] 0    0    [1    /1   ]  300.928918402        1
[INPUT] 0    0    [1    /1   ]  93.2591338069        1
[INPUT] 0    0    [1    /1   ]  32.5936762006        1
[INPUT] 0    0    [1    /1   ]  7.84066665386        1
[INPUT] 0    0    [1    /1   ]  3.07729828849        1
[INPUT] 1    0    [1    /1   ]  8.59689535061        1
[INPUT] 1    0    [1    /1   ]  0.492642344058       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39615438224125565, 1.0]], [0, [1176168.1426066684, 1.0]], [0, [588084.071300071, 1.0]], [0, [294042.03564103233, 1.0]], [0, [147021.01776305403, 1.0]], [0, [73510.50777085009, 1.0]], [0, [36755.23321277968, 1.0]], [0, [7331.733311720244, 1.0]], [0, [18377.158149705803, 1.0]], [0, [1238.7262138564438, 1.0]], [0, [300.92891840235416, 1.0]], [0, [93.25913380686762, 1.0]], [0, [32.5936762005561, 1.0]], [0, [7.840666653857668, 1.0]], [0, [3.0772982884906623, 1.0]], [1, [8.596895350605287, 1.0]], [1, [0.4926423440576276, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39615438]
bas 1, expnt(s) = [1176168.14260667]
bas 2, expnt(s) = [588084.07130007]
bas 3, expnt(s) = [294042.03564103]
bas 4, expnt(s) = [147021.01776305]
bas 5, expnt(s) = [73510.50777085]
bas 6, expnt(s) = [36755.23321278]
bas 7, expnt(s) = [7331.73331172]
bas 8, expnt(s) = [18377.15814971]
bas 9, expnt(s) = [1238.72621386]
bas 10, expnt(s) = [300.9289184]
bas 11, expnt(s) = [93.25913381]
bas 12, expnt(s) = [32.5936762]
bas 13, expnt(s) = [7.84066665]
bas 14, expnt(s) = [3.07729829]
bas 15, expnt(s) = [8.59689535]
bas 16, expnt(s) = [0.49264234]
CPU time:       924.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96154382e-01 1.26157587e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105078e+04 1.12791687e+04
 3.67552332e+04 6.70663099e+03 7.33173331e+03 2.00179693e+03
 1.83771581e+04 3.98771203e+03 1.23872621e+03 5.27529220e+02
 3.00928918e+02 1.82542068e+02 9.32591338e+01 7.58199611e+01
 3.25936762e+01 3.44639486e+01 7.84066665e+00 1.18380390e+01
 3.07729829e+00 5.87005568e+00 8.59689535e+00 4.29448849e+01
 4.92642344e-01 1.20406260e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325808628889053
cond(S) = 12537.610392921644
E1 = -689.3454931003306  E_coul = 184.87133888699412
init E= -504.474154213336
    CPU time for initialize scf      4.53 sec, wall time      0.34 sec
  HOMO = -0.67503600203888  LUMO = 8.42462101566177
  mo_energy =
[-1.21707882e+02 -1.33904197e+01 -7.63074635e+00 -7.63074635e+00
 -7.63074635e+00 -1.64016644e+00 -6.75036002e-01 -6.75036002e-01
 -6.75036002e-01  8.42462102e+00  8.92848749e+01  4.78087202e+02
  2.25360623e+03  1.14300458e+04  4.10209438e+04  1.09875482e+05
  2.54075455e+05  5.48505508e+05  1.15245325e+06  2.43023580e+06
  5.37497041e+06]
E1 = -706.9995649743507  E_coul = 199.07578215011378
cycle= 1 E= -507.923782824237  delta_E= -3.45  |g|= 0.445  |ddm|= 0.357
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593675
diis-c [-0.35245036  1.        ]
  HOMO = -0.234028835349643  LUMO = 9.3088338299693
  mo_energy =
[-1.20260048e+02 -1.23548603e+01 -6.64945472e+00 -6.64945472e+00
 -6.64945472e+00 -1.16193089e+00 -2.34028835e-01 -2.34028835e-01
 -2.34028835e-01  9.30883383e+00  9.06001290e+01  4.79518668e+02
  2.25498230e+03  1.14312961e+04  4.10221217e+04  1.09876621e+05
  2.54076567e+05  5.48506600e+05  1.15245433e+06  2.43023687e+06
  5.37497147e+06]
E1 = -706.6221776569572  E_coul = 198.69152066206107
cycle= 2 E= -507.930656994896  delta_E= -0.00687  |g|= 0.0189  |ddm|= 0.21
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157573
diis-c [-2.41796055e-04  4.27661510e-03  9.95723385e-01]
  HOMO = -0.238951921000599  LUMO = 9.29776486929509
  mo_energy =
[-1.20320458e+02 -1.23790725e+01 -6.67929715e+00 -6.67929715e+00
 -6.67929715e+00 -1.16447532e+00 -2.38951921e-01 -2.38951921e-01
 -2.38951921e-01  9.29776487e+00  9.05573289e+01  4.79457336e+02
  2.25490672e+03  1.14312109e+04  4.10220333e+04  1.09876532e+05
  2.54076476e+05  5.48506510e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6057886155883  E_coul = 198.6751172062434
cycle= 3 E= -507.930671409345  delta_E= -1.44e-05  |g|= 0.00095  |ddm|= 0.00997
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000773313
diis-c [-2.11074007e-08  5.15109328e-05 -5.03279105e-02  1.05027640e+00]
  HOMO = -0.239211662393346  LUMO = 9.29719297247005
  mo_energy =
[-1.20323237e+02 -1.23803149e+01 -6.68079626e+00 -6.68079626e+00
 -6.68079626e+00 -1.16460402e+00 -2.39211662e-01 -2.39211662e-01
 -2.39211662e-01  9.29719297e+00  9.05552671e+01  4.79454563e+02
  2.25490352e+03  1.14312075e+04  4.10220298e+04  1.09876528e+05
  2.54076473e+05  5.48506506e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6049348368205  E_coul = 198.67426338825558
cycle= 4 E= -507.930671448565  delta_E= -3.92e-08  |g|= 8.72e-06  |ddm|= 0.000551
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.37353e-06
diis-c [-6.46454285e-12 -2.19402064e-06  2.56172680e-03 -5.14316586e-02
  1.04887213e+00]
  HOMO = -0.23921307500403  LUMO = 9.2971910377171
  mo_energy =
[-1.20323238e+02 -1.23803201e+01 -6.68080062e+00 -6.68080062e+00
 -6.68080062e+00 -1.16460481e+00 -2.39213075e-01 -2.39213075e-01
 -2.39213075e-01  9.29719104e+00  9.05552640e+01  4.79454562e+02
  2.25490352e+03  1.14312075e+04  4.10220298e+04  1.09876528e+05
  2.54076473e+05  5.48506506e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6049318914943  E_coul = 198.6742604429262
cycle= 5 E= -507.930671448568  delta_E= -3.18e-12  |g|= 1.53e-07  |ddm|= 3.79e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6049318914943  E_coul = 198.6742604429262
  HOMO = -0.23921311253939  LUMO = 9.297190967457
  mo_energy =
[-1.20323239e+02 -1.23803202e+01 -6.68080081e+00 -6.68080081e+00
 -6.68080081e+00 -1.16460483e+00 -2.39213113e-01 -2.39213113e-01
 -2.39213113e-01  9.29719097e+00  9.05552637e+01  4.79454561e+02
  2.25490352e+03  1.14312075e+04  4.10220298e+04  1.09876528e+05
  2.54076473e+05  5.48506506e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6049317865985  E_coul = 198.67426033803042
Extra cycle  E= -507.930671448568  delta_E=    0  |g|= 8.2e-09  |ddm|= 8.27e-08
    CPU time for scf_cycle      4.78 sec, wall time      0.42 sec
exp = [3.96154382e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105078e+04 3.67552332e+04 7.33173331e+03
 1.83771581e+04 1.23872621e+03 3.00928918e+02 9.32591338e+01
 3.25936762e+01 7.84066665e+00 3.07729829e+00 8.59689535e+00
 4.92642344e-01]
E = -507.9306714485681
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396154382241       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.0713          1
[INPUT] 0    0    [1    /1   ]  294042.035641        1
[INPUT] 0    0    [1    /1   ]  147021.017763        1
[INPUT] 0    0    [1    /1   ]  73510.5077709        1
[INPUT] 0    0    [1    /1   ]  36755.2332128        1
[INPUT] 0    0    [1    /1   ]  7331.73331172        1
[INPUT] 0    0    [1    /1   ]  18377.1581497        1
[INPUT] 0    0    [1    /1   ]  1238.72621386        1
[INPUT] 0    0    [1    /1   ]  300.928918402        1
[INPUT] 0    0    [1    /1   ]  93.2591338069        1
[INPUT] 0    0    [1    /1   ]  32.5936762006        1
[INPUT] 0    0    [1    /1   ]  7.84066665386        1
[INPUT] 0    0    [1    /1   ]  3.07729828849        1
[INPUT] 1    0    [1    /1   ]  8.59689535061        1
[INPUT] 1    0    [1    /1   ]  0.492642344058       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39615438224125565, 1.0]], [0, [1176168.1426066684, 1.0]], [0, [588084.071300071, 1.0]], [0, [294042.03564103233, 1.0]], [0, [147021.01776305403, 1.0]], [0, [73510.50777085009, 1.0]], [0, [36755.23321277968, 1.0]], [0, [7331.733311720244, 1.0]], [0, [18377.158149705803, 1.0]], [0, [1238.7262138564438, 1.0]], [0, [300.92891840235416, 1.0]], [0, [93.25913380686762, 1.0]], [0, [32.5936762005561, 1.0]], [0, [7.840666653857668, 1.0]], [0, [3.0772982884906623, 1.0]], [1, [8.596895350605287, 1.0]], [1, [0.4926423440576276, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39615438]
bas 1, expnt(s) = [1176168.14260667]
bas 2, expnt(s) = [588084.07130007]
bas 3, expnt(s) = [294042.03564103]
bas 4, expnt(s) = [147021.01776305]
bas 5, expnt(s) = [73510.50777085]
bas 6, expnt(s) = [36755.23321278]
bas 7, expnt(s) = [7331.73331172]
bas 8, expnt(s) = [18377.15814971]
bas 9, expnt(s) = [1238.72621386]
bas 10, expnt(s) = [300.9289184]
bas 11, expnt(s) = [93.25913381]
bas 12, expnt(s) = [32.5936762]
bas 13, expnt(s) = [7.84066665]
bas 14, expnt(s) = [3.07729829]
bas 15, expnt(s) = [8.59689535]
bas 16, expnt(s) = [0.49264234]
CPU time:       929.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96154382e-01 1.26157587e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105078e+04 1.12791687e+04
 3.67552332e+04 6.70663099e+03 7.33173331e+03 2.00179693e+03
 1.83771581e+04 3.98771203e+03 1.23872621e+03 5.27529220e+02
 3.00928918e+02 1.82542068e+02 9.32591338e+01 7.58199611e+01
 3.25936762e+01 3.44639486e+01 7.84066665e+00 1.18380390e+01
 3.07729829e+00 5.87005568e+00 8.59689535e+00 4.29448849e+01
 4.92642344e-01 1.20406260e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325808628889053
cond(S) = 12537.610392921644
E1 = -689.3454931003306  E_coul = 184.87133888699412
init E= -504.474154213336
    CPU time for initialize scf      4.34 sec, wall time      0.33 sec
  HOMO = -0.67503600203888  LUMO = 8.42462101566177
  mo_energy =
[-1.21707882e+02 -1.33904197e+01 -7.63074635e+00 -7.63074635e+00
 -7.63074635e+00 -1.64016644e+00 -6.75036002e-01 -6.75036002e-01
 -6.75036002e-01  8.42462102e+00  8.92848749e+01  4.78087202e+02
  2.25360623e+03  1.14300458e+04  4.10209438e+04  1.09875482e+05
  2.54075455e+05  5.48505508e+05  1.15245325e+06  2.43023580e+06
  5.37497041e+06]
E1 = -706.9995649743507  E_coul = 199.07578215011378
cycle= 1 E= -507.923782824237  delta_E= -3.45  |g|= 0.445  |ddm|= 0.357
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593675
diis-c [-0.35245036  1.        ]
  HOMO = -0.234028835349643  LUMO = 9.3088338299693
  mo_energy =
[-1.20260048e+02 -1.23548603e+01 -6.64945472e+00 -6.64945472e+00
 -6.64945472e+00 -1.16193089e+00 -2.34028835e-01 -2.34028835e-01
 -2.34028835e-01  9.30883383e+00  9.06001290e+01  4.79518668e+02
  2.25498230e+03  1.14312961e+04  4.10221217e+04  1.09876621e+05
  2.54076567e+05  5.48506600e+05  1.15245433e+06  2.43023687e+06
  5.37497147e+06]
E1 = -706.6221776569572  E_coul = 198.69152066206107
cycle= 2 E= -507.930656994896  delta_E= -0.00687  |g|= 0.0189  |ddm|= 0.21
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157573
diis-c [-2.41796055e-04  4.27661510e-03  9.95723385e-01]
  HOMO = -0.238951921000599  LUMO = 9.29776486929509
  mo_energy =
[-1.20320458e+02 -1.23790725e+01 -6.67929715e+00 -6.67929715e+00
 -6.67929715e+00 -1.16447532e+00 -2.38951921e-01 -2.38951921e-01
 -2.38951921e-01  9.29776487e+00  9.05573289e+01  4.79457336e+02
  2.25490672e+03  1.14312109e+04  4.10220333e+04  1.09876532e+05
  2.54076476e+05  5.48506510e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6057886155883  E_coul = 198.6751172062434
cycle= 3 E= -507.930671409345  delta_E= -1.44e-05  |g|= 0.00095  |ddm|= 0.00997
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000773313
diis-c [-2.11074007e-08  5.15109328e-05 -5.03279105e-02  1.05027640e+00]
  HOMO = -0.239211662393346  LUMO = 9.29719297247005
  mo_energy =
[-1.20323237e+02 -1.23803149e+01 -6.68079626e+00 -6.68079626e+00
 -6.68079626e+00 -1.16460402e+00 -2.39211662e-01 -2.39211662e-01
 -2.39211662e-01  9.29719297e+00  9.05552671e+01  4.79454563e+02
  2.25490352e+03  1.14312075e+04  4.10220298e+04  1.09876528e+05
  2.54076473e+05  5.48506506e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6049348368205  E_coul = 198.67426338825558
cycle= 4 E= -507.930671448565  delta_E= -3.92e-08  |g|= 8.72e-06  |ddm|= 0.000551
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.37353e-06
diis-c [-6.46454285e-12 -2.19402064e-06  2.56172680e-03 -5.14316586e-02
  1.04887213e+00]
  HOMO = -0.23921307500403  LUMO = 9.2971910377171
  mo_energy =
[-1.20323238e+02 -1.23803201e+01 -6.68080062e+00 -6.68080062e+00
 -6.68080062e+00 -1.16460481e+00 -2.39213075e-01 -2.39213075e-01
 -2.39213075e-01  9.29719104e+00  9.05552640e+01  4.79454562e+02
  2.25490352e+03  1.14312075e+04  4.10220298e+04  1.09876528e+05
  2.54076473e+05  5.48506506e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6049318914943  E_coul = 198.6742604429262
cycle= 5 E= -507.930671448568  delta_E= -3.18e-12  |g|= 1.53e-07  |ddm|= 3.79e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6049318914943  E_coul = 198.6742604429262
  HOMO = -0.23921311253939  LUMO = 9.297190967457
  mo_energy =
[-1.20323239e+02 -1.23803202e+01 -6.68080081e+00 -6.68080081e+00
 -6.68080081e+00 -1.16460483e+00 -2.39213113e-01 -2.39213113e-01
 -2.39213113e-01  9.29719097e+00  9.05552637e+01  4.79454561e+02
  2.25490352e+03  1.14312075e+04  4.10220298e+04  1.09876528e+05
  2.54076473e+05  5.48506506e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6049317865985  E_coul = 198.67426033803042
Extra cycle  E= -507.930671448568  delta_E=    0  |g|= 8.2e-09  |ddm|= 8.27e-08
    CPU time for scf_cycle      4.58 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12537.610392921644
E1 = -706.6049317865985  E_coul = 198.67426033803042
init E= -507.930671448568
    CPU time for initialize scf      9.59 sec, wall time      0.69 sec
  HOMO = -0.239213114410528  LUMO = 9.29719096508688
  mo_energy =
[-1.20323239e+02 -1.23803202e+01 -6.68080081e+00 -6.68080081e+00
 -6.68080081e+00 -1.16460483e+00 -2.39213114e-01 -2.39213114e-01
 -2.39213114e-01  9.29719097e+00  9.05552637e+01  4.79454561e+02
  2.25490352e+03  1.14312075e+04  4.10220298e+04  1.09876528e+05
  2.54076473e+05  5.48506506e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.6049317816424  E_coul = 198.67426033307444
cycle= 1 E= -507.930671448568  delta_E= 1.14e-13  |g|= 1.57e-09  |ddm|= 4.31e-09
    CPU time for cycle= 1      0.10 sec, wall time      0.01 sec
E1 = -706.6049317816424  E_coul = 198.67426033307444
  HOMO = -0.23921311450664  LUMO = 9.29719096504514
  mo_energy =
[-1.20323239e+02 -1.23803202e+01 -6.68080081e+00 -6.68080081e+00
 -6.68080081e+00 -1.16460483e+00 -2.39213115e-01 -2.39213115e-01
 -2.39213115e-01  9.29719097e+00  9.05552637e+01  4.79454561e+02
  2.25490352e+03  1.14312075e+04  4.10220298e+04  1.09876528e+05
  2.54076473e+05  5.48506506e+05  1.15245424e+06  2.43023677e+06
  5.37497138e+06]
E1 = -706.604931781315  E_coul = 198.67426033274722
Extra cycle  E= -507.930671448568  delta_E= 1.71e-13  |g|= 7.1e-10  |ddm|= 2.61e-10
    CPU time for scf_cycle      9.77 sec, wall time      0.77 sec
exp = [3.96154382e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105078e+04 3.67552332e+04 7.33173331e+03
 1.83771581e+04 1.23872621e+03 3.00928918e+02 9.32591338e+01
 3.25936762e+01 7.84066665e+00 3.07729829e+00 8.59689535e+00
 4.92642344e-01]
grad_E = [-8.83162132e-03 -2.27188996e-11  3.92179038e-10  1.30587386e-09
  7.75484889e-09  2.53079097e-08  1.55725101e-07  8.49165918e-06
  3.77745501e-07  4.52876616e-05 -6.72499184e-04  9.59450851e-04
 -2.11958963e-03 -4.56456018e-04  5.08968424e-04 -6.20607276e-03
 -1.01810528e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395904501898       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071297        1
[INPUT] 0    0    [1    /1   ]  294042.035632        1
[INPUT] 0    0    [1    /1   ]  147021.017711        1
[INPUT] 0    0    [1    /1   ]  73510.5076024        1
[INPUT] 0    0    [1    /1   ]  36755.232174         1
[INPUT] 0    0    [1    /1   ]  7331.67668107        1
[INPUT] 0    0    [1    /1   ]  18377.155641         1
[INPUT] 0    0    [1    /1   ]  1238.4054824         1
[INPUT] 0    0    [1    /1   ]  304.488353804        1
[INPUT] 0    0    [1    /1   ]  94.6468137143        1
[INPUT] 0    0    [1    /1   ]  32.7588696714        1
[INPUT] 0    0    [1    /1   ]  7.84948966668        1
[INPUT] 0    0    [1    /1   ]  3.0789080885         1
[INPUT] 1    0    [1    /1   ]  8.59318521677        1
[INPUT] 1    0    [1    /1   ]  0.492423897889       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39590450189832754, 1.0]], [0, [1176168.1426068272, 1.0]], [0, [588084.0712974566, 1.0]], [0, [294042.03563234414, 1.0]], [0, [147021.01771133058, 1.0]], [0, [73510.50760240213, 1.0]], [0, [36755.232173975324, 1.0]], [0, [7331.676681073072, 1.0]], [0, [18377.155641004076, 1.0]], [0, [1238.4054824037291, 1.0]], [0, [304.488353804226, 1.0]], [0, [94.64681371432421, 1.0]], [0, [32.75886967141461, 1.0]], [0, [7.849489666677537, 1.0]], [0, [3.0789080885030256, 1.0]], [1, [8.593185216765145, 1.0]], [1, [0.49242389788933866, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3959045]
bas 1, expnt(s) = [1176168.14260683]
bas 2, expnt(s) = [588084.07129746]
bas 3, expnt(s) = [294042.03563234]
bas 4, expnt(s) = [147021.01771133]
bas 5, expnt(s) = [73510.5076024]
bas 6, expnt(s) = [36755.23217398]
bas 7, expnt(s) = [7331.67668107]
bas 8, expnt(s) = [18377.155641]
bas 9, expnt(s) = [1238.4054824]
bas 10, expnt(s) = [304.4883538]
bas 11, expnt(s) = [94.64681371]
bas 12, expnt(s) = [32.75886967]
bas 13, expnt(s) = [7.84948967]
bas 14, expnt(s) = [3.07890809]
bas 15, expnt(s) = [8.59318522]
bas 16, expnt(s) = [0.4924239]
CPU time:       947.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95904502e-01 1.26097900e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105076e+04 1.12791687e+04
 3.67552322e+04 6.70663085e+03 7.33167668e+03 2.00178533e+03
 1.83771556e+04 3.98771162e+03 1.23840548e+03 5.27426776e+02
 3.04488354e+02 1.84159039e+02 9.46468137e+01 7.66645380e+01
 3.27588697e+01 3.45948702e+01 7.84948967e+00 1.18480285e+01
 3.07890809e+00 5.87235859e+00 8.59318522e+00 4.29217191e+01
 4.92423898e-01 1.20339525e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.326128877529253
cond(S) = 12541.149905679275
E1 = -689.3176998235144  E_coul = 184.8455630264178
init E= -504.472136797097
    CPU time for initialize scf      4.52 sec, wall time      0.34 sec
  HOMO = -0.67533977348893  LUMO = 8.4388991952928
  mo_energy =
[-1.21712785e+02 -1.33923744e+01 -7.63251508e+00 -7.63251508e+00
 -7.63251508e+00 -1.64039604e+00 -6.75339773e-01 -6.75339773e-01
 -6.75339773e-01  8.43889920e+00  9.01333537e+01  4.84690326e+02
  2.26909727e+03  1.14467673e+04  4.10366524e+04  1.09890516e+05
  2.54089992e+05  5.48519621e+05  1.15246697e+06  2.43024913e+06
  5.37498333e+06]
E1 = -706.9658988630374  E_coul = 199.0409985801635
cycle= 1 E= -507.924900282874  delta_E= -3.45  |g|= 0.445  |ddm|= 0.357
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593478
diis-c [-0.35221562  1.        ]
  HOMO = -0.234663521165125  LUMO = 9.32339098730049
  mo_energy =
[-1.20265940e+02 -1.23573626e+01 -6.65182632e+00 -6.65182632e+00
 -6.65182632e+00 -1.16246290e+00 -2.34663521e-01 -2.34663521e-01
 -2.34663521e-01  9.32339099e+00  9.14495936e+01  4.86120917e+02
  2.27047231e+03  1.14480170e+04  4.10378296e+04  1.09891654e+05
  2.54091103e+05  5.48520712e+05  1.15246805e+06  2.43025019e+06
  5.37498439e+06]
E1 = -706.5891254174591  E_coul = 198.65736372742288
cycle= 2 E= -507.931761690036  delta_E= -0.00686  |g|= 0.0189  |ddm|= 0.209
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157537
diis-c [-2.41703992e-04  4.27079332e-03  9.95729207e-01]
  HOMO = -0.239573321293711  LUMO = 9.31232139711868
  mo_energy =
[-1.20326278e+02 -1.23815335e+01 -6.68161782e+00 -6.68161782e+00
 -6.68161782e+00 -1.16500067e+00 -2.39573321e-01 -2.39573321e-01
 -2.39573321e-01  9.31232140e+00  9.14066950e+01  4.86059509e+02
  2.27039679e+03  1.14479319e+04  4.10377413e+04  1.09891564e+05
  2.54091013e+05  5.48520621e+05  1.15246796e+06  2.43025010e+06
  5.37498430e+06]
E1 = -706.5727790092757  E_coul = 198.64100296111337
cycle= 3 E= -507.931776048162  delta_E= -1.44e-05  |g|= 0.000948  |ddm|= 0.00993
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000772651
diis-c [-2.09391306e-08  5.09150018e-05 -5.03053280e-02  1.05025441e+00]
  HOMO = -0.239832068807115  LUMO = 9.31175019442736
  mo_energy =
[-1.20329052e+02 -1.23827724e+01 -6.68311287e+00 -6.68311287e+00
 -6.68311287e+00 -1.16512888e+00 -2.39832069e-01 -2.39832069e-01
 -2.39832069e-01  9.31175019e+00  9.14046313e+01  4.86056737e+02
  2.27039359e+03  1.14479284e+04  4.10377378e+04  1.09891561e+05
  2.54091009e+05  5.48520618e+05  1.15246795e+06  2.43025010e+06
  5.37498429e+06]
E1 = -706.5719283951072  E_coul = 198.640152307972
cycle= 4 E= -507.931776087135  delta_E= -3.9e-08  |g|= 8.66e-06  |ddm|= 0.000548
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.33175e-06
diis-c [-6.43918076e-12 -2.16969434e-06  2.55419596e-03 -5.12877302e-02
  1.04873570e+00]
  HOMO = -0.239833462776155  LUMO = 9.31174829515598
  mo_energy =
[-1.20329053e+02 -1.23827775e+01 -6.68311715e+00 -6.68311715e+00
 -6.68311715e+00 -1.16512966e+00 -2.39833463e-01 -2.39833463e-01
 -2.39833463e-01  9.31174830e+00  9.14046284e+01  4.86056736e+02
  2.27039359e+03  1.14479284e+04  4.10377378e+04  1.09891561e+05
  2.54091009e+05  5.48520618e+05  1.15246795e+06  2.43025010e+06
  5.37498429e+06]
E1 = -706.5719255035879  E_coul = 198.6401494164499
cycle= 5 E= -507.931776087138  delta_E= -2.79e-12  |g|= 1.53e-07  |ddm|= 3.74e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5719255035879  E_coul = 198.6401494164499
  HOMO = -0.239833500227789  LUMO = 9.3117482240334
  mo_energy =
[-1.20329053e+02 -1.23827777e+01 -6.68311734e+00 -6.68311734e+00
 -6.68311734e+00 -1.16512968e+00 -2.39833500e-01 -2.39833500e-01
 -2.39833500e-01  9.31174822e+00  9.14046281e+01  4.86056735e+02
  2.27039359e+03  1.14479284e+04  4.10377378e+04  1.09891561e+05
  2.54091009e+05  5.48520618e+05  1.15246795e+06  2.43025010e+06
  5.37498429e+06]
E1 = -706.5719253989698  E_coul = 198.6401493118319
Extra cycle  E= -507.931776087138  delta_E= 5.68e-14  |g|= 8.15e-09  |ddm|= 8.24e-08
    CPU time for scf_cycle      4.78 sec, wall time      0.41 sec
exp = [3.95904502e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105076e+04 3.67552322e+04 7.33167668e+03
 1.83771556e+04 1.23840548e+03 3.04488354e+02 9.46468137e+01
 3.27588697e+01 7.84948967e+00 3.07890809e+00 8.59318522e+00
 4.92423898e-01]
E = -507.9317760871379
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395904501898       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071297        1
[INPUT] 0    0    [1    /1   ]  294042.035632        1
[INPUT] 0    0    [1    /1   ]  147021.017711        1
[INPUT] 0    0    [1    /1   ]  73510.5076024        1
[INPUT] 0    0    [1    /1   ]  36755.232174         1
[INPUT] 0    0    [1    /1   ]  7331.67668107        1
[INPUT] 0    0    [1    /1   ]  18377.155641         1
[INPUT] 0    0    [1    /1   ]  1238.4054824         1
[INPUT] 0    0    [1    /1   ]  304.488353804        1
[INPUT] 0    0    [1    /1   ]  94.6468137143        1
[INPUT] 0    0    [1    /1   ]  32.7588696714        1
[INPUT] 0    0    [1    /1   ]  7.84948966668        1
[INPUT] 0    0    [1    /1   ]  3.0789080885         1
[INPUT] 1    0    [1    /1   ]  8.59318521677        1
[INPUT] 1    0    [1    /1   ]  0.492423897889       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39590450189832754, 1.0]], [0, [1176168.1426068272, 1.0]], [0, [588084.0712974566, 1.0]], [0, [294042.03563234414, 1.0]], [0, [147021.01771133058, 1.0]], [0, [73510.50760240213, 1.0]], [0, [36755.232173975324, 1.0]], [0, [7331.676681073072, 1.0]], [0, [18377.155641004076, 1.0]], [0, [1238.4054824037291, 1.0]], [0, [304.488353804226, 1.0]], [0, [94.64681371432421, 1.0]], [0, [32.75886967141461, 1.0]], [0, [7.849489666677537, 1.0]], [0, [3.0789080885030256, 1.0]], [1, [8.593185216765145, 1.0]], [1, [0.49242389788933866, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3959045]
bas 1, expnt(s) = [1176168.14260683]
bas 2, expnt(s) = [588084.07129746]
bas 3, expnt(s) = [294042.03563234]
bas 4, expnt(s) = [147021.01771133]
bas 5, expnt(s) = [73510.5076024]
bas 6, expnt(s) = [36755.23217398]
bas 7, expnt(s) = [7331.67668107]
bas 8, expnt(s) = [18377.155641]
bas 9, expnt(s) = [1238.4054824]
bas 10, expnt(s) = [304.4883538]
bas 11, expnt(s) = [94.64681371]
bas 12, expnt(s) = [32.75886967]
bas 13, expnt(s) = [7.84948967]
bas 14, expnt(s) = [3.07890809]
bas 15, expnt(s) = [8.59318522]
bas 16, expnt(s) = [0.4924239]
CPU time:       952.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95904502e-01 1.26097900e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105076e+04 1.12791687e+04
 3.67552322e+04 6.70663085e+03 7.33167668e+03 2.00178533e+03
 1.83771556e+04 3.98771162e+03 1.23840548e+03 5.27426776e+02
 3.04488354e+02 1.84159039e+02 9.46468137e+01 7.66645380e+01
 3.27588697e+01 3.45948702e+01 7.84948967e+00 1.18480285e+01
 3.07890809e+00 5.87235859e+00 8.59318522e+00 4.29217191e+01
 4.92423898e-01 1.20339525e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.326128877529253
cond(S) = 12541.149905679275
E1 = -689.3176998235144  E_coul = 184.8455630264178
init E= -504.472136797097
    CPU time for initialize scf      4.31 sec, wall time      0.32 sec
  HOMO = -0.67533977348893  LUMO = 8.4388991952928
  mo_energy =
[-1.21712785e+02 -1.33923744e+01 -7.63251508e+00 -7.63251508e+00
 -7.63251508e+00 -1.64039604e+00 -6.75339773e-01 -6.75339773e-01
 -6.75339773e-01  8.43889920e+00  9.01333537e+01  4.84690326e+02
  2.26909727e+03  1.14467673e+04  4.10366524e+04  1.09890516e+05
  2.54089992e+05  5.48519621e+05  1.15246697e+06  2.43024913e+06
  5.37498333e+06]
E1 = -706.9658988630374  E_coul = 199.0409985801635
cycle= 1 E= -507.924900282874  delta_E= -3.45  |g|= 0.445  |ddm|= 0.357
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593478
diis-c [-0.35221562  1.        ]
  HOMO = -0.234663521165125  LUMO = 9.32339098730049
  mo_energy =
[-1.20265940e+02 -1.23573626e+01 -6.65182632e+00 -6.65182632e+00
 -6.65182632e+00 -1.16246290e+00 -2.34663521e-01 -2.34663521e-01
 -2.34663521e-01  9.32339099e+00  9.14495936e+01  4.86120917e+02
  2.27047231e+03  1.14480170e+04  4.10378296e+04  1.09891654e+05
  2.54091103e+05  5.48520712e+05  1.15246805e+06  2.43025019e+06
  5.37498439e+06]
E1 = -706.5891254174591  E_coul = 198.65736372742288
cycle= 2 E= -507.931761690036  delta_E= -0.00686  |g|= 0.0189  |ddm|= 0.209
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0157537
diis-c [-2.41703992e-04  4.27079332e-03  9.95729207e-01]
  HOMO = -0.239573321293711  LUMO = 9.31232139711868
  mo_energy =
[-1.20326278e+02 -1.23815335e+01 -6.68161782e+00 -6.68161782e+00
 -6.68161782e+00 -1.16500067e+00 -2.39573321e-01 -2.39573321e-01
 -2.39573321e-01  9.31232140e+00  9.14066950e+01  4.86059509e+02
  2.27039679e+03  1.14479319e+04  4.10377413e+04  1.09891564e+05
  2.54091013e+05  5.48520621e+05  1.15246796e+06  2.43025010e+06
  5.37498430e+06]
E1 = -706.5727790092757  E_coul = 198.64100296111337
cycle= 3 E= -507.931776048162  delta_E= -1.44e-05  |g|= 0.000948  |ddm|= 0.00993
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000772651
diis-c [-2.09391306e-08  5.09150018e-05 -5.03053280e-02  1.05025441e+00]
  HOMO = -0.239832068807115  LUMO = 9.31175019442736
  mo_energy =
[-1.20329052e+02 -1.23827724e+01 -6.68311287e+00 -6.68311287e+00
 -6.68311287e+00 -1.16512888e+00 -2.39832069e-01 -2.39832069e-01
 -2.39832069e-01  9.31175019e+00  9.14046313e+01  4.86056737e+02
  2.27039359e+03  1.14479284e+04  4.10377378e+04  1.09891561e+05
  2.54091009e+05  5.48520618e+05  1.15246795e+06  2.43025010e+06
  5.37498429e+06]
E1 = -706.5719283951072  E_coul = 198.640152307972
cycle= 4 E= -507.931776087135  delta_E= -3.9e-08  |g|= 8.66e-06  |ddm|= 0.000548
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.33175e-06
diis-c [-6.43918076e-12 -2.16969434e-06  2.55419596e-03 -5.12877302e-02
  1.04873570e+00]
  HOMO = -0.239833462776155  LUMO = 9.31174829515598
  mo_energy =
[-1.20329053e+02 -1.23827775e+01 -6.68311715e+00 -6.68311715e+00
 -6.68311715e+00 -1.16512966e+00 -2.39833463e-01 -2.39833463e-01
 -2.39833463e-01  9.31174830e+00  9.14046284e+01  4.86056736e+02
  2.27039359e+03  1.14479284e+04  4.10377378e+04  1.09891561e+05
  2.54091009e+05  5.48520618e+05  1.15246795e+06  2.43025010e+06
  5.37498429e+06]
E1 = -706.5719255035879  E_coul = 198.6401494164499
cycle= 5 E= -507.931776087138  delta_E= -2.79e-12  |g|= 1.53e-07  |ddm|= 3.74e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5719255035879  E_coul = 198.6401494164499
  HOMO = -0.239833500227789  LUMO = 9.3117482240334
  mo_energy =
[-1.20329053e+02 -1.23827777e+01 -6.68311734e+00 -6.68311734e+00
 -6.68311734e+00 -1.16512968e+00 -2.39833500e-01 -2.39833500e-01
 -2.39833500e-01  9.31174822e+00  9.14046281e+01  4.86056735e+02
  2.27039359e+03  1.14479284e+04  4.10377378e+04  1.09891561e+05
  2.54091009e+05  5.48520618e+05  1.15246795e+06  2.43025010e+06
  5.37498429e+06]
E1 = -706.5719253989698  E_coul = 198.6401493118319
Extra cycle  E= -507.931776087138  delta_E= 5.68e-14  |g|= 8.15e-09  |ddm|= 8.24e-08
    CPU time for scf_cycle      4.58 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12541.149905679275
E1 = -706.5719253989698  E_coul = 198.6401493118319
init E= -507.931776087138
    CPU time for initialize scf      9.61 sec, wall time      0.69 sec
  HOMO = -0.239833502092783  LUMO = 9.31174821938498
  mo_energy =
[-1.20329053e+02 -1.23827777e+01 -6.68311734e+00 -6.68311734e+00
 -6.68311734e+00 -1.16512968e+00 -2.39833502e-01 -2.39833502e-01
 -2.39833502e-01  9.31174822e+00  9.14046281e+01  4.86056735e+02
  2.27039359e+03  1.14479284e+04  4.10377378e+04  1.09891561e+05
  2.54091009e+05  5.48520618e+05  1.15246795e+06  2.43025010e+06
  5.37498429e+06]
E1 = -706.5719253939925  E_coul = 198.64014930685434
cycle= 1 E= -507.931776087138  delta_E= -2.27e-13  |g|= 1.23e-09  |ddm|= 4.3e-09
    CPU time for cycle= 1      0.09 sec, wall time      0.01 sec
E1 = -706.5719253939925  E_coul = 198.64014930685434
  HOMO = -0.239833502188741  LUMO = 9.31174822038301
  mo_energy =
[-1.20329053e+02 -1.23827777e+01 -6.68311735e+00 -6.68311735e+00
 -6.68311735e+00 -1.16512968e+00 -2.39833502e-01 -2.39833502e-01
 -2.39833502e-01  9.31174822e+00  9.14046281e+01  4.86056735e+02
  2.27039359e+03  1.14479284e+04  4.10377378e+04  1.09891561e+05
  2.54091009e+05  5.48520618e+05  1.15246795e+06  2.43025010e+06
  5.37498429e+06]
E1 = -706.5719253936921  E_coul = 198.6401493065538
Extra cycle  E= -507.931776087138  delta_E= -2.27e-13  |g|= 7.8e-10  |ddm|= 2.58e-10
    CPU time for scf_cycle      9.78 sec, wall time      0.76 sec
exp = [3.95904502e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105076e+04 3.67552322e+04 7.33167668e+03
 1.83771556e+04 1.23840548e+03 3.04488354e+02 9.46468137e+01
 3.27588697e+01 7.84948967e+00 3.07890809e+00 8.59318522e+00
 4.92423898e-01]
grad_E = [-1.29842671e-02 -2.00772268e-11  4.09956085e-10  1.37368316e-09
  8.09225443e-09  2.65874941e-08  1.62437799e-07  8.88115563e-06
  3.99721781e-07  2.50630450e-05 -6.22939092e-04  1.35321297e-03
 -3.02760782e-03 -6.11262799e-04  8.44477276e-04 -9.18588580e-03
 -1.51923379e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395764236237       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071292        1
[INPUT] 0    0    [1    /1   ]  294042.035615        1
[INPUT] 0    0    [1    /1   ]  147021.017608        1
[INPUT] 0    0    [1    /1   ]  73510.507267         1
[INPUT] 0    0    [1    /1   ]  36755.2301061        1
[INPUT] 0    0    [1    /1   ]  7331.56393366        1
[INPUT] 0    0    [1    /1   ]  18377.1506444        1
[INPUT] 0    0    [1    /1   ]  1237.78201062        1
[INPUT] 0    0    [1    /1   ]  311.409359893        1
[INPUT] 0    0    [1    /1   ]  97.6526569378        1
[INPUT] 0    0    [1    /1   ]  33.5703991908        1
[INPUT] 0    0    [1    /1   ]  7.87008766733        1
[INPUT] 0    0    [1    /1   ]  3.09201549399        1
[INPUT] 1    0    [1    /1   ]  8.5908975033         1
[INPUT] 1    0    [1    /1   ]  0.492289165482       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39576423623722107, 1.0]], [0, [1176168.1426071415, 1.0]], [0, [588084.0712922522, 1.0]], [0, [294042.0356150438, 1.0]], [0, [147021.0176083682, 1.0]], [0, [73510.50726699707, 1.0]], [0, [36755.23010612325, 1.0]], [0, [7331.563933662673, 1.0]], [0, [18377.150644391662, 1.0]], [0, [1237.7820106223967, 1.0]], [0, [311.4093598927695, 1.0]], [0, [97.65265693780452, 1.0]], [0, [33.57039919075581, 1.0]], [0, [7.870087667327809, 1.0]], [0, [3.092015493990626, 1.0]], [1, [8.590897503301232, 1.0]], [1, [0.49228916548158863, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39576424]
bas 1, expnt(s) = [1176168.14260714]
bas 2, expnt(s) = [588084.07129225]
bas 3, expnt(s) = [294042.03561504]
bas 4, expnt(s) = [147021.01760837]
bas 5, expnt(s) = [73510.507267]
bas 6, expnt(s) = [36755.23010612]
bas 7, expnt(s) = [7331.56393366]
bas 8, expnt(s) = [18377.15064439]
bas 9, expnt(s) = [1237.78201062]
bas 10, expnt(s) = [311.40935989]
bas 11, expnt(s) = [97.65265694]
bas 12, expnt(s) = [33.57039919]
bas 13, expnt(s) = [7.87008767]
bas 14, expnt(s) = [3.09201549]
bas 15, expnt(s) = [8.5908975]
bas 16, expnt(s) = [0.49228917]
CPU time:       969.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95764236e-01 1.26064392e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105073e+04 1.12791686e+04
 3.67552301e+04 6.70663056e+03 7.33156393e+03 2.00176225e+03
 1.83771506e+04 3.98771081e+03 1.23778201e+03 5.27227615e+02
 3.11409360e+02 1.87289647e+02 9.76526569e+01 7.84834476e+01
 3.35703992e+01 3.52356594e+01 7.87008767e+00 1.18713389e+01
 3.09201549e+00 5.89109831e+00 8.59089750e+00 4.29074361e+01
 4.92289165e-01 1.20298369e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32631076614456
cond(S) = 12548.803084687768
E1 = -689.2952489998637  E_coul = 184.8292320918575
init E= -504.466016908006
    CPU time for initialize scf      4.53 sec, wall time      0.34 sec
  HOMO = -0.675540771593932  LUMO = 8.51711083491994
  mo_energy =
[-1.21716455e+02 -1.33936787e+01 -7.63363958e+00 -7.63363958e+00
 -7.63363958e+00 -1.64057797e+00 -6.75540772e-01 -6.75540772e-01
 -6.75540772e-01  8.51711083e+00  9.28555365e+01  5.00134814e+02
  2.30209087e+03  1.14819885e+04  4.10697299e+04  1.09922176e+05
  2.54120611e+05  5.48549347e+05  1.15249586e+06  2.43027720e+06
  5.37501054e+06]
E1 = -706.9461672428935  E_coul = 199.0191498624479
cycle= 1 E= -507.927017380446  delta_E= -3.46  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593296
diis-c [-0.35200029  1.        ]
  HOMO = -0.235065813577749  LUMO = 9.40423451541045
  mo_energy =
[-1.20270094e+02 -1.23590294e+01 -6.65334523e+00 -6.65334523e+00
 -6.65334523e+00 -1.16283622e+00 -2.35065814e-01 -2.35065814e-01
 -2.35065814e-01  9.40423452e+00  9.41766285e+01  5.01565397e+02
  2.30346550e+03  1.14832387e+04  4.10709076e+04  1.09923315e+05
  2.54121722e+05  5.48550439e+05  1.15249694e+06  2.43027827e+06
  5.37501160e+06]
E1 = -706.5719858447704  E_coul = 198.63816128627562
cycle= 2 E= -507.933824558495  delta_E= -0.00681  |g|= 0.0188  |ddm|= 0.207
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156968
diis-c [-2.39670338e-04  4.35116319e-03  9.95648837e-01]
  HOMO = -0.239921913895421  LUMO = 9.39317107702479
  mo_energy =
[-1.20330147e+02 -1.23830019e+01 -6.68291731e+00 -6.68291731e+00
 -6.68291731e+00 -1.16534264e+00 -2.39921914e-01 -2.39921914e-01
 -2.39921914e-01  9.39317108e+00  9.41335178e+01  5.01503980e+02
  2.30339025e+03  1.14831539e+04  4.10708196e+04  1.09923225e+05
  2.54121632e+05  5.48550349e+05  1.15249685e+06  2.43027818e+06
  5.37501151e+06]
E1 = -706.5558364730607  E_coul = 198.62199782858204
cycle= 3 E= -507.933838644479  delta_E= -1.41e-05  |g|= 0.00094  |ddm|= 0.00978
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000769077
diis-c [-1.98336980e-08  4.91417927e-05 -5.02975386e-02  1.05024840e+00]
  HOMO = -0.240176859031508  LUMO = 9.39260257762966
  mo_energy =
[-1.20332901e+02 -1.23842263e+01 -6.68439679e+00 -6.68439679e+00
 -6.68439679e+00 -1.16546881e+00 -2.40176859e-01 -2.40176859e-01
 -2.40176859e-01  9.39260258e+00  9.41314519e+01  5.01501216e+02
  2.30338707e+03  1.14831505e+04  4.10708161e+04  1.09923222e+05
  2.54121629e+05  5.48550345e+05  1.15249684e+06  2.43027817e+06
  5.37501151e+06]
E1 = -706.5549991319962  E_coul = 198.62116044961414
cycle= 4 E= -507.933838682382  delta_E= -3.79e-08  |g|= 8.36e-06  |ddm|= 0.000537
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.09461e-06
diis-c [-6.22085035e-12 -2.12229820e-06  2.52869468e-03 -5.06978980e-02
  1.04817133e+00]
  HOMO = -0.240178169482679  LUMO = 9.39260082033734
  mo_energy =
[-1.20332902e+02 -1.23842311e+01 -6.68440072e+00 -6.68440072e+00
 -6.68440072e+00 -1.16546953e+00 -2.40178169e-01 -2.40178169e-01
 -2.40178169e-01  9.39260082e+00  9.41314494e+01  5.01501215e+02
  2.30338707e+03  1.14831505e+04  4.10708161e+04  1.09923222e+05
  2.54121629e+05  5.48550345e+05  1.15249684e+06  2.43027817e+06
  5.37501151e+06]
E1 = -706.5549964805901  E_coul = 198.62115779820533
cycle= 5 E= -507.933838682385  delta_E= -2.79e-12  |g|= 1.52e-07  |ddm|= 3.53e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5549964805901  E_coul = 198.62115779820533
  HOMO = -0.240178206643253  LUMO = 9.3926007503227
  mo_energy =
[-1.20332902e+02 -1.23842312e+01 -6.68440090e+00 -6.68440090e+00
 -6.68440090e+00 -1.16546955e+00 -2.40178207e-01 -2.40178207e-01
 -2.40178207e-01  9.39260075e+00  9.41314491e+01  5.01501215e+02
  2.30338707e+03  1.14831505e+04  4.10708161e+04  1.09923222e+05
  2.54121629e+05  5.48550345e+05  1.15249684e+06  2.43027817e+06
  5.37501151e+06]
E1 = -706.5549963769065  E_coul = 198.62115769452186
Extra cycle  E= -507.933838682385  delta_E= 1.71e-13  |g|= 8.07e-09  |ddm|= 8.15e-08
    CPU time for scf_cycle      4.78 sec, wall time      0.41 sec
exp = [3.95764236e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105073e+04 3.67552301e+04 7.33156393e+03
 1.83771506e+04 1.23778201e+03 3.11409360e+02 9.76526569e+01
 3.35703992e+01 7.87008767e+00 3.09201549e+00 8.59089750e+00
 4.92289165e-01]
E = -507.93383868238465
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.395764236237       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071292        1
[INPUT] 0    0    [1    /1   ]  294042.035615        1
[INPUT] 0    0    [1    /1   ]  147021.017608        1
[INPUT] 0    0    [1    /1   ]  73510.507267         1
[INPUT] 0    0    [1    /1   ]  36755.2301061        1
[INPUT] 0    0    [1    /1   ]  7331.56393366        1
[INPUT] 0    0    [1    /1   ]  18377.1506444        1
[INPUT] 0    0    [1    /1   ]  1237.78201062        1
[INPUT] 0    0    [1    /1   ]  311.409359893        1
[INPUT] 0    0    [1    /1   ]  97.6526569378        1
[INPUT] 0    0    [1    /1   ]  33.5703991908        1
[INPUT] 0    0    [1    /1   ]  7.87008766733        1
[INPUT] 0    0    [1    /1   ]  3.09201549399        1
[INPUT] 1    0    [1    /1   ]  8.5908975033         1
[INPUT] 1    0    [1    /1   ]  0.492289165482       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39576423623722107, 1.0]], [0, [1176168.1426071415, 1.0]], [0, [588084.0712922522, 1.0]], [0, [294042.0356150438, 1.0]], [0, [147021.0176083682, 1.0]], [0, [73510.50726699707, 1.0]], [0, [36755.23010612325, 1.0]], [0, [7331.563933662673, 1.0]], [0, [18377.150644391662, 1.0]], [0, [1237.7820106223967, 1.0]], [0, [311.4093598927695, 1.0]], [0, [97.65265693780452, 1.0]], [0, [33.57039919075581, 1.0]], [0, [7.870087667327809, 1.0]], [0, [3.092015493990626, 1.0]], [1, [8.590897503301232, 1.0]], [1, [0.49228916548158863, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39576424]
bas 1, expnt(s) = [1176168.14260714]
bas 2, expnt(s) = [588084.07129225]
bas 3, expnt(s) = [294042.03561504]
bas 4, expnt(s) = [147021.01760837]
bas 5, expnt(s) = [73510.507267]
bas 6, expnt(s) = [36755.23010612]
bas 7, expnt(s) = [7331.56393366]
bas 8, expnt(s) = [18377.15064439]
bas 9, expnt(s) = [1237.78201062]
bas 10, expnt(s) = [311.40935989]
bas 11, expnt(s) = [97.65265694]
bas 12, expnt(s) = [33.57039919]
bas 13, expnt(s) = [7.87008767]
bas 14, expnt(s) = [3.09201549]
bas 15, expnt(s) = [8.5908975]
bas 16, expnt(s) = [0.49228917]
CPU time:       974.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.95764236e-01 1.26064392e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021018e+05 1.89692252e+04 7.35105073e+04 1.12791686e+04
 3.67552301e+04 6.70663056e+03 7.33156393e+03 2.00176225e+03
 1.83771506e+04 3.98771081e+03 1.23778201e+03 5.27227615e+02
 3.11409360e+02 1.87289647e+02 9.76526569e+01 7.84834476e+01
 3.35703992e+01 3.52356594e+01 7.87008767e+00 1.18713389e+01
 3.09201549e+00 5.89109831e+00 8.59089750e+00 4.29074361e+01
 4.92289165e-01 1.20298369e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32631076614456
cond(S) = 12548.803084687768
E1 = -689.2952489998637  E_coul = 184.8292320918575
init E= -504.466016908006
    CPU time for initialize scf      4.60 sec, wall time      0.33 sec
  HOMO = -0.675540771593932  LUMO = 8.51711083491994
  mo_energy =
[-1.21716455e+02 -1.33936787e+01 -7.63363958e+00 -7.63363958e+00
 -7.63363958e+00 -1.64057797e+00 -6.75540772e-01 -6.75540772e-01
 -6.75540772e-01  8.51711083e+00  9.28555365e+01  5.00134814e+02
  2.30209087e+03  1.14819885e+04  4.10697299e+04  1.09922176e+05
  2.54120611e+05  5.48549347e+05  1.15249586e+06  2.43027720e+06
  5.37501054e+06]
E1 = -706.9461672428935  E_coul = 199.0191498624479
cycle= 1 E= -507.927017380446  delta_E= -3.46  |g|= 0.445  |ddm|= 0.356
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593296
diis-c [-0.35200029  1.        ]
  HOMO = -0.235065813577749  LUMO = 9.40423451541045
  mo_energy =
[-1.20270094e+02 -1.23590294e+01 -6.65334523e+00 -6.65334523e+00
 -6.65334523e+00 -1.16283622e+00 -2.35065814e-01 -2.35065814e-01
 -2.35065814e-01  9.40423452e+00  9.41766285e+01  5.01565397e+02
  2.30346550e+03  1.14832387e+04  4.10709076e+04  1.09923315e+05
  2.54121722e+05  5.48550439e+05  1.15249694e+06  2.43027827e+06
  5.37501160e+06]
E1 = -706.5719858447704  E_coul = 198.63816128627562
cycle= 2 E= -507.933824558495  delta_E= -0.00681  |g|= 0.0188  |ddm|= 0.207
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0156968
diis-c [-2.39670338e-04  4.35116319e-03  9.95648837e-01]
  HOMO = -0.239921913895421  LUMO = 9.39317107702479
  mo_energy =
[-1.20330147e+02 -1.23830019e+01 -6.68291731e+00 -6.68291731e+00
 -6.68291731e+00 -1.16534264e+00 -2.39921914e-01 -2.39921914e-01
 -2.39921914e-01  9.39317108e+00  9.41335178e+01  5.01503980e+02
  2.30339025e+03  1.14831539e+04  4.10708196e+04  1.09923225e+05
  2.54121632e+05  5.48550349e+05  1.15249685e+06  2.43027818e+06
  5.37501151e+06]
E1 = -706.5558364730607  E_coul = 198.62199782858204
cycle= 3 E= -507.933838644479  delta_E= -1.41e-05  |g|= 0.00094  |ddm|= 0.00978
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000769077
diis-c [-1.98336980e-08  4.91417927e-05 -5.02975386e-02  1.05024840e+00]
  HOMO = -0.240176859031508  LUMO = 9.39260257762966
  mo_energy =
[-1.20332901e+02 -1.23842263e+01 -6.68439679e+00 -6.68439679e+00
 -6.68439679e+00 -1.16546881e+00 -2.40176859e-01 -2.40176859e-01
 -2.40176859e-01  9.39260258e+00  9.41314519e+01  5.01501216e+02
  2.30338707e+03  1.14831505e+04  4.10708161e+04  1.09923222e+05
  2.54121629e+05  5.48550345e+05  1.15249684e+06  2.43027817e+06
  5.37501151e+06]
E1 = -706.5549991319962  E_coul = 198.62116044961414
cycle= 4 E= -507.933838682382  delta_E= -3.79e-08  |g|= 8.36e-06  |ddm|= 0.000537
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.09461e-06
diis-c [-6.22085035e-12 -2.12229820e-06  2.52869468e-03 -5.06978980e-02
  1.04817133e+00]
  HOMO = -0.240178169482679  LUMO = 9.39260082033734
  mo_energy =
[-1.20332902e+02 -1.23842311e+01 -6.68440072e+00 -6.68440072e+00
 -6.68440072e+00 -1.16546953e+00 -2.40178169e-01 -2.40178169e-01
 -2.40178169e-01  9.39260082e+00  9.41314494e+01  5.01501215e+02
  2.30338707e+03  1.14831505e+04  4.10708161e+04  1.09923222e+05
  2.54121629e+05  5.48550345e+05  1.15249684e+06  2.43027817e+06
  5.37501151e+06]
E1 = -706.5549964805901  E_coul = 198.62115779820533
cycle= 5 E= -507.933838682385  delta_E= -2.79e-12  |g|= 1.52e-07  |ddm|= 3.53e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5549964805901  E_coul = 198.62115779820533
  HOMO = -0.240178206643253  LUMO = 9.3926007503227
  mo_energy =
[-1.20332902e+02 -1.23842312e+01 -6.68440090e+00 -6.68440090e+00
 -6.68440090e+00 -1.16546955e+00 -2.40178207e-01 -2.40178207e-01
 -2.40178207e-01  9.39260075e+00  9.41314491e+01  5.01501215e+02
  2.30338707e+03  1.14831505e+04  4.10708161e+04  1.09923222e+05
  2.54121629e+05  5.48550345e+05  1.15249684e+06  2.43027817e+06
  5.37501151e+06]
E1 = -706.5549963769065  E_coul = 198.62115769452186
Extra cycle  E= -507.933838682385  delta_E= 1.71e-13  |g|= 8.07e-09  |ddm|= 8.15e-08
    CPU time for scf_cycle      4.85 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12548.803084687768
E1 = -706.5549963769065  E_coul = 198.62115769452186
init E= -507.933838682385
    CPU time for initialize scf      9.64 sec, wall time      0.70 sec
  HOMO = -0.240178208483565  LUMO = 9.39260074527529
  mo_energy =
[-1.20332902e+02 -1.23842313e+01 -6.68440091e+00 -6.68440091e+00
 -6.68440091e+00 -1.16546956e+00 -2.40178208e-01 -2.40178208e-01
 -2.40178208e-01  9.39260075e+00  9.41314491e+01  5.01501215e+02
  2.30338707e+03  1.14831505e+04  4.10708161e+04  1.09923222e+05
  2.54121629e+05  5.48550345e+05  1.15249684e+06  2.43027817e+06
  5.37501151e+06]
E1 = -706.5549963720223  E_coul = 198.62115768963778
cycle= 1 E= -507.933838682384  delta_E= 1.71e-13  |g|= 1.36e-09  |ddm|= 4.21e-09
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
E1 = -706.5549963720223  E_coul = 198.62115768963778
  HOMO = -0.240178208577429  LUMO = 9.39260074486992
  mo_energy =
[-1.20332902e+02 -1.23842313e+01 -6.68440091e+00 -6.68440091e+00
 -6.68440091e+00 -1.16546956e+00 -2.40178209e-01 -2.40178209e-01
 -2.40178209e-01  9.39260074e+00  9.41314491e+01  5.01501215e+02
  2.30338707e+03  1.14831505e+04  4.10708161e+04  1.09923222e+05
  2.54121629e+05  5.48550345e+05  1.15249684e+06  2.43027817e+06
  5.37501151e+06]
E1 = -706.5549963717524  E_coul = 198.62115768936758
Extra cycle  E= -507.933838682385  delta_E= -3.41e-13  |g|= 1e-09  |ddm|= 2.45e-10
    CPU time for scf_cycle      9.73 sec, wall time      0.77 sec
exp = [3.95764236e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021018e+05 7.35105073e+04 3.67552301e+04 7.33156393e+03
 1.83771506e+04 1.23778201e+03 3.11409360e+02 9.76526569e+01
 3.35703992e+01 7.87008767e+00 3.09201549e+00 8.59089750e+00
 4.92289165e-01]
grad_E = [-1.53115410e-02 -1.46518080e-11  4.45853173e-10  1.51117501e-09
  8.77342871e-09  2.91827053e-08  1.75977513e-07  9.65787544e-06
  4.44526082e-07 -1.43944070e-05 -4.69285917e-04  1.47926804e-03
 -3.33822459e-03 -5.89975653e-04  9.81653391e-04 -1.09522631e-02
 -1.80408238e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396020502701       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071285        1
[INPUT] 0    0    [1    /1   ]  294042.035592        1
[INPUT] 0    0    [1    /1   ]  147021.01747         1
[INPUT] 0    0    [1    /1   ]  73510.5068176        1
[INPUT] 0    0    [1    /1   ]  36755.2273363        1
[INPUT] 0    0    [1    /1   ]  7331.4128926         1
[INPUT] 0    0    [1    /1   ]  18377.1439486        1
[INPUT] 0    0    [1    /1   ]  1236.96315145        1
[INPUT] 0    0    [1    /1   ]  320.501290662        1
[INPUT] 0    0    [1    /1   ]  101.949103126        1
[INPUT] 0    0    [1    /1   ]  35.1619109191        1
[INPUT] 0    0    [1    /1   ]  7.87837739236        1
[INPUT] 0    0    [1    /1   ]  3.11431657905        1
[INPUT] 1    0    [1    /1   ]  8.59439157794        1
[INPUT] 1    0    [1    /1   ]  0.492493961251       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3960205027010074, 1.0]], [0, [1176168.1426075606, 1.0]], [0, [588084.0712852804, 1.0]], [0, [294042.03559186443, 1.0]], [0, [147021.01747045197, 1.0]], [0, [73510.50681763352, 1.0]], [0, [36755.22733630161, 1.0]], [0, [7331.412892599892, 1.0]], [0, [18377.14394857531, 1.0]], [0, [1236.9631514478478, 1.0]], [0, [320.50129066167983, 1.0]], [0, [101.9491031262213, 1.0]], [0, [35.16191091912666, 1.0]], [0, [7.878377392358909, 1.0]], [0, [3.1143165790525305, 1.0]], [1, [8.594391577939879, 1.0]], [1, [0.49249396125092615, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3960205]
bas 1, expnt(s) = [1176168.14260756]
bas 2, expnt(s) = [588084.07128528]
bas 3, expnt(s) = [294042.03559186]
bas 4, expnt(s) = [147021.01747045]
bas 5, expnt(s) = [73510.50681763]
bas 6, expnt(s) = [36755.2273363]
bas 7, expnt(s) = [7331.4128926]
bas 8, expnt(s) = [18377.14394858]
bas 9, expnt(s) = [1236.96315145]
bas 10, expnt(s) = [320.50129066]
bas 11, expnt(s) = [101.94910313]
bas 12, expnt(s) = [35.16191092]
bas 13, expnt(s) = [7.87837739]
bas 14, expnt(s) = [3.11431658]
bas 15, expnt(s) = [8.59439158]
bas 16, expnt(s) = [0.49249396]
CPU time:       991.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96020503e-01 1.26125609e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552273e+04 6.70663018e+03 7.33141289e+03 2.00173132e+03
 1.83771439e+04 3.98770972e+03 1.23696315e+03 5.26966001e+02
 3.20501291e+02 1.91375951e+02 1.01949103e+02 8.10592500e+01
 3.51619109e+01 3.64812219e+01 7.87837739e+00 1.18807159e+01
 3.11431658e+00 5.92293672e+00 8.59439158e+00 4.29292513e+01
 4.92493961e-01 1.20360929e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325978521812193
cond(S) = 12559.712300545976
E1 = -689.3028283473891  E_coul = 184.85279322565017
init E= -504.450035121739
    CPU time for initialize scf      5.21 sec, wall time      0.42 sec
  HOMO = -0.675282553978747  LUMO = 8.63880163158537
  mo_energy =
[-1.21713235e+02 -1.33920458e+01 -7.63203197e+00 -7.63203197e+00
 -7.63203197e+00 -1.64046347e+00 -6.75282554e-01 -6.75282554e-01
 -6.75282554e-01  8.63880163e+00  9.75295696e+01  5.23140470e+02
  2.34838817e+03  1.15312004e+04  4.11159692e+04  1.09966447e+05
  2.54163431e+05  5.48590923e+05  1.15253627e+06  2.43031647e+06
  5.37504861e+06]
E1 = -706.9815225315676  E_coul = 199.05234692763602
cycle= 1 E= -507.929175603932  delta_E= -3.48  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.593432
diis-c [-0.35216159  1.        ]
  HOMO = -0.234479630288249  LUMO = 9.53070192304667
  mo_energy =
[-1.20265410e+02 -1.23568805e+01 -6.65115965e+00 -6.65115965e+00
 -6.65115965e+00 -1.16242939e+00 -2.34479630e-01 -2.34479630e-01
 -2.34479630e-01  9.53070192e+00  9.88601482e+01  5.24573489e+02
  2.34976479e+03  1.15324540e+04  4.11171504e+04  1.09967589e+05
  2.54164546e+05  5.48592018e+05  1.15253735e+06  2.43031754e+06
  5.37504967e+06]
E1 = -706.6109266267239  E_coul = 198.6750196666819
cycle= 2 E= -507.935906960042  delta_E= -0.00673  |g|= 0.0186  |ddm|= 0.205
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155827
diis-c [-2.35498003e-04  4.54118139e-03  9.95458819e-01]
  HOMO = -0.239261836643481  LUMO = 9.51963860886209
  mo_energy =
[-1.20325082e+02 -1.23805638e+01 -6.68042362e+00 -6.68042362e+00
 -6.68042362e+00 -1.16489046e+00 -2.39261837e-01 -2.39261837e-01
 -2.39261837e-01  9.51963861e+00  9.88166409e+01  5.24512066e+02
  2.34968991e+03  1.15323697e+04  4.11170629e+04  1.09967500e+05
  2.54164456e+05  5.48591928e+05  1.15253726e+06  2.43031745e+06
  5.37504958e+06]
E1 = -706.5950619513712  E_coul = 198.65914130440473
cycle= 3 E= -507.935920646967  delta_E= -1.37e-05  |g|= 0.000929  |ddm|= 0.00957
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000763397
diis-c [-1.80656635e-08  4.66887200e-05 -5.03587698e-02  1.05031208e+00]
  HOMO = -0.2395117504229  LUMO = 9.5190730308964
  mo_energy =
[-1.20327815e+02 -1.23817686e+01 -6.68188270e+00 -6.68188270e+00
 -6.68188270e+00 -1.16501382e+00 -2.39511750e-01 -2.39511750e-01
 -2.39511750e-01  9.51907303e+00  9.88145653e+01  5.24509311e+02
  2.34968675e+03  1.15323662e+04  4.11170594e+04  1.09967497e+05
  2.54164453e+05  5.48591924e+05  1.15253726e+06  2.43031744e+06
  5.37504958e+06]
E1 = -706.5942428141028  E_coul = 198.65832213070914
cycle= 4 E= -507.935920683394  delta_E= -3.64e-08  |g|= 7.94e-06  |ddm|= 0.000523
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.72232e-06
diis-c [-5.83825035e-12 -2.03651500e-06  2.49574379e-03 -4.98528045e-02
  1.04735910e+00]
  HOMO = -0.239512939598967  LUMO = 9.51907149153541
  mo_energy =
[-1.20327815e+02 -1.23817728e+01 -6.68188610e+00 -6.68188610e+00
 -6.68188610e+00 -1.16501448e+00 -2.39512940e-01 -2.39512940e-01
 -2.39512940e-01  9.51907149e+00  9.88145634e+01  5.24509311e+02
  2.34968675e+03  1.15323662e+04  4.11170594e+04  1.09967497e+05
  2.54164453e+05  5.48591924e+05  1.15253726e+06  2.43031744e+06
  5.37504958e+06]
E1 = -706.5942405110513  E_coul = 198.65831982765562
cycle= 5 E= -507.935920683396  delta_E= -2.05e-12  |g|= 1.5e-07  |ddm|= 3.23e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5942405110513  E_coul = 198.65831982765562
  HOMO = -0.239512976436742  LUMO = 9.51907142059003
  mo_energy =
[-1.20327815e+02 -1.23817730e+01 -6.68188628e+00 -6.68188628e+00
 -6.68188628e+00 -1.16501450e+00 -2.39512976e-01 -2.39512976e-01
 -2.39512976e-01  9.51907142e+00  9.88145632e+01  5.24509311e+02
  2.34968675e+03  1.15323662e+04  4.11170594e+04  1.09967497e+05
  2.54164453e+05  5.48591924e+05  1.15253726e+06  2.43031744e+06
  5.37504958e+06]
E1 = -706.5942404086405  E_coul = 198.65831972524464
Extra cycle  E= -507.935920683396  delta_E= -2.27e-13  |g|= 7.94e-09  |ddm|= 8.02e-08
    CPU time for scf_cycle      5.31 sec, wall time      0.49 sec
exp = [3.96020503e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552273e+04 7.33141289e+03
 1.83771439e+04 1.23696315e+03 3.20501291e+02 1.01949103e+02
 3.51619109e+01 7.87837739e+00 3.11431658e+00 8.59439158e+00
 4.92493961e-01]
E = -507.9359206833959
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396020502701       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071285        1
[INPUT] 0    0    [1    /1   ]  294042.035592        1
[INPUT] 0    0    [1    /1   ]  147021.01747         1
[INPUT] 0    0    [1    /1   ]  73510.5068176        1
[INPUT] 0    0    [1    /1   ]  36755.2273363        1
[INPUT] 0    0    [1    /1   ]  7331.4128926         1
[INPUT] 0    0    [1    /1   ]  18377.1439486        1
[INPUT] 0    0    [1    /1   ]  1236.96315145        1
[INPUT] 0    0    [1    /1   ]  320.501290662        1
[INPUT] 0    0    [1    /1   ]  101.949103126        1
[INPUT] 0    0    [1    /1   ]  35.1619109191        1
[INPUT] 0    0    [1    /1   ]  7.87837739236        1
[INPUT] 0    0    [1    /1   ]  3.11431657905        1
[INPUT] 1    0    [1    /1   ]  8.59439157794        1
[INPUT] 1    0    [1    /1   ]  0.492493961251       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3960205027010074, 1.0]], [0, [1176168.1426075606, 1.0]], [0, [588084.0712852804, 1.0]], [0, [294042.03559186443, 1.0]], [0, [147021.01747045197, 1.0]], [0, [73510.50681763352, 1.0]], [0, [36755.22733630161, 1.0]], [0, [7331.412892599892, 1.0]], [0, [18377.14394857531, 1.0]], [0, [1236.9631514478478, 1.0]], [0, [320.50129066167983, 1.0]], [0, [101.9491031262213, 1.0]], [0, [35.16191091912666, 1.0]], [0, [7.878377392358909, 1.0]], [0, [3.1143165790525305, 1.0]], [1, [8.594391577939879, 1.0]], [1, [0.49249396125092615, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3960205]
bas 1, expnt(s) = [1176168.14260756]
bas 2, expnt(s) = [588084.07128528]
bas 3, expnt(s) = [294042.03559186]
bas 4, expnt(s) = [147021.01747045]
bas 5, expnt(s) = [73510.50681763]
bas 6, expnt(s) = [36755.2273363]
bas 7, expnt(s) = [7331.4128926]
bas 8, expnt(s) = [18377.14394858]
bas 9, expnt(s) = [1236.96315145]
bas 10, expnt(s) = [320.50129066]
bas 11, expnt(s) = [101.94910313]
bas 12, expnt(s) = [35.16191092]
bas 13, expnt(s) = [7.87837739]
bas 14, expnt(s) = [3.11431658]
bas 15, expnt(s) = [8.59439158]
bas 16, expnt(s) = [0.49249396]
CPU time:       996.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96020503e-01 1.26125609e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552273e+04 6.70663018e+03 7.33141289e+03 2.00173132e+03
 1.83771439e+04 3.98770972e+03 1.23696315e+03 5.26966001e+02
 3.20501291e+02 1.91375951e+02 1.01949103e+02 8.10592500e+01
 3.51619109e+01 3.64812219e+01 7.87837739e+00 1.18807159e+01
 3.11431658e+00 5.92293672e+00 8.59439158e+00 4.29292513e+01
 4.92493961e-01 1.20360929e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325978521812193
cond(S) = 12559.712300545976
E1 = -689.3028283473891  E_coul = 184.85279322565017
init E= -504.450035121739
    CPU time for initialize scf      4.15 sec, wall time      0.34 sec
  HOMO = -0.675282553978747  LUMO = 8.63880163158537
  mo_energy =
[-1.21713235e+02 -1.33920458e+01 -7.63203197e+00 -7.63203197e+00
 -7.63203197e+00 -1.64046347e+00 -6.75282554e-01 -6.75282554e-01
 -6.75282554e-01  8.63880163e+00  9.75295696e+01  5.23140470e+02
  2.34838817e+03  1.15312004e+04  4.11159692e+04  1.09966447e+05
  2.54163431e+05  5.48590923e+05  1.15253627e+06  2.43031647e+06
  5.37504861e+06]
E1 = -706.9815225315676  E_coul = 199.05234692763602
cycle= 1 E= -507.929175603932  delta_E= -3.48  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593432
diis-c [-0.35216159  1.        ]
  HOMO = -0.234479630288249  LUMO = 9.53070192304667
  mo_energy =
[-1.20265410e+02 -1.23568805e+01 -6.65115965e+00 -6.65115965e+00
 -6.65115965e+00 -1.16242939e+00 -2.34479630e-01 -2.34479630e-01
 -2.34479630e-01  9.53070192e+00  9.88601482e+01  5.24573489e+02
  2.34976479e+03  1.15324540e+04  4.11171504e+04  1.09967589e+05
  2.54164546e+05  5.48592018e+05  1.15253735e+06  2.43031754e+06
  5.37504967e+06]
E1 = -706.6109266267239  E_coul = 198.6750196666819
cycle= 2 E= -507.935906960042  delta_E= -0.00673  |g|= 0.0186  |ddm|= 0.205
    CPU time for cycle= 2      0.09 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155827
diis-c [-2.35498003e-04  4.54118139e-03  9.95458819e-01]
  HOMO = -0.239261836643481  LUMO = 9.51963860886209
  mo_energy =
[-1.20325082e+02 -1.23805638e+01 -6.68042362e+00 -6.68042362e+00
 -6.68042362e+00 -1.16489046e+00 -2.39261837e-01 -2.39261837e-01
 -2.39261837e-01  9.51963861e+00  9.88166409e+01  5.24512066e+02
  2.34968991e+03  1.15323697e+04  4.11170629e+04  1.09967500e+05
  2.54164456e+05  5.48591928e+05  1.15253726e+06  2.43031745e+06
  5.37504958e+06]
E1 = -706.5950619513712  E_coul = 198.65914130440473
cycle= 3 E= -507.935920646967  delta_E= -1.37e-05  |g|= 0.000929  |ddm|= 0.00957
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000763397
diis-c [-1.80656635e-08  4.66887200e-05 -5.03587698e-02  1.05031208e+00]
  HOMO = -0.2395117504229  LUMO = 9.5190730308964
  mo_energy =
[-1.20327815e+02 -1.23817686e+01 -6.68188270e+00 -6.68188270e+00
 -6.68188270e+00 -1.16501382e+00 -2.39511750e-01 -2.39511750e-01
 -2.39511750e-01  9.51907303e+00  9.88145653e+01  5.24509311e+02
  2.34968675e+03  1.15323662e+04  4.11170594e+04  1.09967497e+05
  2.54164453e+05  5.48591924e+05  1.15253726e+06  2.43031744e+06
  5.37504958e+06]
E1 = -706.5942428141028  E_coul = 198.65832213070914
cycle= 4 E= -507.935920683394  delta_E= -3.64e-08  |g|= 7.94e-06  |ddm|= 0.000523
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.72232e-06
diis-c [-5.83825035e-12 -2.03651500e-06  2.49574379e-03 -4.98528045e-02
  1.04735910e+00]
  HOMO = -0.239512939598967  LUMO = 9.51907149153541
  mo_energy =
[-1.20327815e+02 -1.23817728e+01 -6.68188610e+00 -6.68188610e+00
 -6.68188610e+00 -1.16501448e+00 -2.39512940e-01 -2.39512940e-01
 -2.39512940e-01  9.51907149e+00  9.88145634e+01  5.24509311e+02
  2.34968675e+03  1.15323662e+04  4.11170594e+04  1.09967497e+05
  2.54164453e+05  5.48591924e+05  1.15253726e+06  2.43031744e+06
  5.37504958e+06]
E1 = -706.5942405110513  E_coul = 198.65831982765562
cycle= 5 E= -507.935920683396  delta_E= -2.05e-12  |g|= 1.5e-07  |ddm|= 3.23e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.5942405110513  E_coul = 198.65831982765562
  HOMO = -0.239512976436742  LUMO = 9.51907142059003
  mo_energy =
[-1.20327815e+02 -1.23817730e+01 -6.68188628e+00 -6.68188628e+00
 -6.68188628e+00 -1.16501450e+00 -2.39512976e-01 -2.39512976e-01
 -2.39512976e-01  9.51907142e+00  9.88145632e+01  5.24509311e+02
  2.34968675e+03  1.15323662e+04  4.11170594e+04  1.09967497e+05
  2.54164453e+05  5.48591924e+05  1.15253726e+06  2.43031744e+06
  5.37504958e+06]
E1 = -706.5942404086405  E_coul = 198.65831972524464
Extra cycle  E= -507.935920683396  delta_E= -2.27e-13  |g|= 7.94e-09  |ddm|= 8.02e-08
    CPU time for scf_cycle      4.43 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12559.712300545976
E1 = -706.5942404086405  E_coul = 198.65831972524464
init E= -507.935920683396
    CPU time for initialize scf      9.23 sec, wall time      0.72 sec
  HOMO = -0.23951297824308  LUMO = 9.51907141726727
  mo_energy =
[-1.20327815e+02 -1.23817730e+01 -6.68188629e+00 -6.68188629e+00
 -6.68188629e+00 -1.16501450e+00 -2.39512978e-01 -2.39512978e-01
 -2.39512978e-01  9.51907142e+00  9.88145632e+01  5.24509311e+02
  2.34968675e+03  1.15323662e+04  4.11170594e+04  1.09967497e+05
  2.54164453e+05  5.48591924e+05  1.15253726e+06  2.43031744e+06
  5.37504958e+06]
E1 = -706.594240403858  E_coul = 198.65831972046183
cycle= 1 E= -507.935920683396  delta_E= -2.27e-13  |g|= 9.96e-10  |ddm|= 4.1e-09
    CPU time for cycle= 1      0.05 sec, wall time      0.01 sec
E1 = -706.594240403858  E_coul = 198.65831972046183
  HOMO = -0.239512978334335  LUMO = 9.51907141628071
  mo_energy =
[-1.20327815e+02 -1.23817730e+01 -6.68188629e+00 -6.68188629e+00
 -6.68188629e+00 -1.16501450e+00 -2.39512978e-01 -2.39512978e-01
 -2.39512978e-01  9.51907142e+00  9.88145632e+01  5.24509311e+02
  2.34968675e+03  1.15323662e+04  4.11170594e+04  1.09967497e+05
  2.54164453e+05  5.48591924e+05  1.15253726e+06  2.43031744e+06
  5.37504958e+06]
E1 = -706.5942404035537  E_coul = 198.65831972015818
Extra cycle  E= -507.935920683396  delta_E= 5.68e-13  |g|= 9.31e-10  |ddm|= 2.38e-10
    CPU time for scf_cycle      9.33 sec, wall time      0.79 sec
exp = [3.96020503e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552273e+04 7.33141289e+03
 1.83771439e+04 1.23696315e+03 3.20501291e+02 1.01949103e+02
 3.51619109e+01 7.87837739e+00 3.11431658e+00 8.59439158e+00
 4.92493961e-01]
grad_E = [-1.09703218e-02 -7.04372272e-12  4.95022864e-10  1.70060048e-09
  9.70617314e-09  3.27595251e-08  1.94493114e-07  1.07017124e-05
  5.06726175e-07 -6.49290396e-05 -2.11952054e-04  8.71001110e-04
 -1.71734063e-03 -4.39397279e-04  3.78148420e-04 -7.95987381e-03
 -1.27881817e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396359620046       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071283        1
[INPUT] 0    0    [1    /1   ]  294042.035585        1
[INPUT] 0    0    [1    /1   ]  147021.017432        1
[INPUT] 0    0    [1    /1   ]  73510.5066932        1
[INPUT] 0    0    [1    /1   ]  36755.2265689        1
[INPUT] 0    0    [1    /1   ]  7331.37105041        1
[INPUT] 0    0    [1    /1   ]  18377.1420941        1
[INPUT] 0    0    [1    /1   ]  1236.73287742        1
[INPUT] 0    0    [1    /1   ]  323.063486538        1
[INPUT] 0    0    [1    /1   ]  103.005516874        1
[INPUT] 0    0    [1    /1   ]  35.6896490497        1
[INPUT] 0    0    [1    /1   ]  7.93845214974        1
[INPUT] 0    0    [1    /1   ]  3.14311176328        1
[INPUT] 1    0    [1    /1   ]  8.5999010159         1
[INPUT] 1    0    [1    /1   ]  0.492786468023       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3963596200455489, 1.0]], [0, [1176168.142607677, 1.0]], [0, [588084.071283349, 1.0]], [0, [294042.0355854438, 1.0]], [0, [147021.01743224222, 1.0]], [0, [73510.50669315629, 1.0]], [0, [36755.22656891592, 1.0]], [0, [7331.371050406822, 1.0]], [0, [18377.142094091883, 1.0]], [0, [1236.7328774239381, 1.0]], [0, [323.06348653795266, 1.0]], [0, [103.00551687379793, 1.0]], [0, [35.68964904969501, 1.0]], [0, [7.938452149741709, 1.0]], [0, [3.1431117632822017, 1.0]], [1, [8.59990101590377, 1.0]], [1, [0.49278646802296266, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39635962]
bas 1, expnt(s) = [1176168.14260768]
bas 2, expnt(s) = [588084.07128335]
bas 3, expnt(s) = [294042.03558544]
bas 4, expnt(s) = [147021.01743224]
bas 5, expnt(s) = [73510.50669316]
bas 6, expnt(s) = [36755.22656892]
bas 7, expnt(s) = [7331.37105041]
bas 8, expnt(s) = [18377.14209409]
bas 9, expnt(s) = [1236.73287742]
bas 10, expnt(s) = [323.06348654]
bas 11, expnt(s) = [103.00551687]
bas 12, expnt(s) = [35.68964905]
bas 13, expnt(s) = [7.93845215]
bas 14, expnt(s) = [3.14311176]
bas 15, expnt(s) = [8.59990102]
bas 16, expnt(s) = [0.49278647]
CPU time:      1013.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96359620e-01 1.26206603e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791685e+04
 3.67552266e+04 6.70663008e+03 7.33137105e+03 2.00172275e+03
 1.83771421e+04 3.98770942e+03 1.23673288e+03 5.26892424e+02
 3.23063487e+02 1.92522251e+02 1.03005517e+02 8.16883998e+01
 3.56896490e+01 3.68911108e+01 7.93845215e+00 1.19485966e+01
 3.14311176e+00 5.96396234e+00 8.59990102e+00 4.29636538e+01
 4.92786468e-01 1.20450293e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32551532009141
cond(S) = 12562.874528082073
E1 = -689.3288218368074  E_coul = 184.88834800353652
init E= -504.440473833271
    CPU time for initialize scf      4.25 sec, wall time      0.34 sec
  HOMO = -0.674911443086817  LUMO = 8.79415173704973
  mo_energy =
[-1.21707195e+02 -1.33892862e+01 -7.62961734e+00 -7.62961734e+00
 -7.62961734e+00 -1.64024846e+00 -6.74911443e-01 -6.74911443e-01
 -6.74911443e-01  8.79415174e+00  9.92779611e+01  5.29853831e+02
  2.36141061e+03  1.15450590e+04  4.11289996e+04  1.09978925e+05
  2.54175501e+05  5.48602643e+05  1.15254766e+06  2.43032754e+06
  5.37505934e+06]
E1 = -707.0299055266721  E_coul = 199.10028600930715
cycle= 1 E= -507.929619517365  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593607
diis-c [-0.35236975  1.        ]
  HOMO = -0.233657171181483  LUMO = 9.69100701040634
  mo_energy =
[-1.20257790e+02 -1.23534115e+01 -6.64795034e+00 -6.64795034e+00
 -6.64795034e+00 -1.16181880e+00 -2.33657171e-01 -2.33657171e-01
 -2.33657171e-01  9.69100701e+00  1.00612280e+02  5.31288762e+02
  2.36278914e+03  1.15463150e+04  4.11301833e+04  1.09980070e+05
  2.54176619e+05  5.48603741e+05  1.15254875e+06  2.43032861e+06
  5.37506040e+06]
E1 = -706.6642226152452  E_coul = 198.7279734862373
cycle= 2 E= -507.936249129008  delta_E= -0.00663  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155116
diis-c [-2.33158134e-04  4.57880316e-03  9.95421197e-01]
  HOMO = -0.238345007853484  LUMO = 9.67999948327015
  mo_energy =
[-1.20316907e+02 -1.23767147e+01 -6.67680394e+00 -6.67680394e+00
 -6.67680394e+00 -1.16422208e+00 -2.38345008e-01 -2.38345008e-01
 -2.38345008e-01  9.67999948e+00  1.00569023e+02  5.31227801e+02
  2.36271486e+03  1.15462313e+04  4.11300965e+04  1.09979982e+05
  2.54176530e+05  5.48603651e+05  1.15254866e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.6487127297289  E_coul = 198.71245039314772
cycle= 3 E= -507.936262336581  delta_E= -1.32e-05  |g|= 0.000913  |ddm|= 0.00934
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756958
diis-c [-1.64024308e-08  4.49617708e-05 -5.02233019e-02  1.05017834e+00]
  HOMO = -0.238587782739466  LUMO = 9.67944181384182
  mo_energy =
[-1.20319597e+02 -1.23778903e+01 -6.67823152e+00 -6.67823152e+00
 -6.67823152e+00 -1.16434148e+00 -2.38587783e-01 -2.38587783e-01
 -2.38587783e-01  9.67944181e+00  1.00566975e+02  5.31225085e+02
  2.36271174e+03  1.15462280e+04  4.11300930e+04  1.09979978e+05
  2.54176527e+05  5.48603648e+05  1.15254865e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.6479187741353  E_coul = 198.71165640309727
cycle= 4 E= -507.936262371038  delta_E= -3.45e-08  |g|= 7.43e-06  |ddm|= 0.000505
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.33582e-06
diis-c [-5.52295858e-12 -1.97690456e-06  2.43662787e-03 -4.86605232e-02
  1.04622587e+00]
  HOMO = -0.238588841417185  LUMO = 9.67944049802152
  mo_energy =
[-1.20319597e+02 -1.23778940e+01 -6.67823440e+00 -6.67823440e+00
 -6.67823440e+00 -1.16434208e+00 -2.38588841e-01 -2.38588841e-01
 -2.38588841e-01  9.67944050e+00  1.00566974e+02  5.31225086e+02
  2.36271174e+03  1.15462280e+04  4.11300930e+04  1.09979978e+05
  2.54176527e+05  5.48603648e+05  1.15254865e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.647916828246  E_coul = 198.71165445720607
cycle= 5 E= -507.93626237104  delta_E= -1.93e-12  |g|= 1.48e-07  |ddm|= 2.91e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.647916828246  E_coul = 198.71165445720607
  HOMO = -0.238588877530697  LUMO = 9.67944042792833
  mo_energy =
[-1.20319597e+02 -1.23778942e+01 -6.67823458e+00 -6.67823458e+00
 -6.67823458e+00 -1.16434210e+00 -2.38588878e-01 -2.38588878e-01
 -2.38588878e-01  9.67944043e+00  1.00566974e+02  5.31225086e+02
  2.36271174e+03  1.15462280e+04  4.11300930e+04  1.09979978e+05
  2.54176527e+05  5.48603648e+05  1.15254865e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.6479167283471  E_coul = 198.7116543573073
Extra cycle  E= -507.93626237104  delta_E= 1.71e-13  |g|= 7.75e-09  |ddm|= 7.83e-08
    CPU time for scf_cycle      4.48 sec, wall time      0.42 sec
exp = [3.96359620e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552266e+04 7.33137105e+03
 1.83771421e+04 1.23673288e+03 3.23063487e+02 1.03005517e+02
 3.56896490e+01 7.93845215e+00 3.14311176e+00 8.59990102e+00
 4.92786468e-01]
E = -507.9362623710398
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:28:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396359620046       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071283        1
[INPUT] 0    0    [1    /1   ]  294042.035585        1
[INPUT] 0    0    [1    /1   ]  147021.017432        1
[INPUT] 0    0    [1    /1   ]  73510.5066932        1
[INPUT] 0    0    [1    /1   ]  36755.2265689        1
[INPUT] 0    0    [1    /1   ]  7331.37105041        1
[INPUT] 0    0    [1    /1   ]  18377.1420941        1
[INPUT] 0    0    [1    /1   ]  1236.73287742        1
[INPUT] 0    0    [1    /1   ]  323.063486538        1
[INPUT] 0    0    [1    /1   ]  103.005516874        1
[INPUT] 0    0    [1    /1   ]  35.6896490497        1
[INPUT] 0    0    [1    /1   ]  7.93845214974        1
[INPUT] 0    0    [1    /1   ]  3.14311176328        1
[INPUT] 1    0    [1    /1   ]  8.5999010159         1
[INPUT] 1    0    [1    /1   ]  0.492786468023       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3963596200455489, 1.0]], [0, [1176168.142607677, 1.0]], [0, [588084.071283349, 1.0]], [0, [294042.0355854438, 1.0]], [0, [147021.01743224222, 1.0]], [0, [73510.50669315629, 1.0]], [0, [36755.22656891592, 1.0]], [0, [7331.371050406822, 1.0]], [0, [18377.142094091883, 1.0]], [0, [1236.7328774239381, 1.0]], [0, [323.06348653795266, 1.0]], [0, [103.00551687379793, 1.0]], [0, [35.68964904969501, 1.0]], [0, [7.938452149741709, 1.0]], [0, [3.1431117632822017, 1.0]], [1, [8.59990101590377, 1.0]], [1, [0.49278646802296266, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39635962]
bas 1, expnt(s) = [1176168.14260768]
bas 2, expnt(s) = [588084.07128335]
bas 3, expnt(s) = [294042.03558544]
bas 4, expnt(s) = [147021.01743224]
bas 5, expnt(s) = [73510.50669316]
bas 6, expnt(s) = [36755.22656892]
bas 7, expnt(s) = [7331.37105041]
bas 8, expnt(s) = [18377.14209409]
bas 9, expnt(s) = [1236.73287742]
bas 10, expnt(s) = [323.06348654]
bas 11, expnt(s) = [103.00551687]
bas 12, expnt(s) = [35.68964905]
bas 13, expnt(s) = [7.93845215]
bas 14, expnt(s) = [3.14311176]
bas 15, expnt(s) = [8.59990102]
bas 16, expnt(s) = [0.49278647]
CPU time:      1018.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96359620e-01 1.26206603e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791685e+04
 3.67552266e+04 6.70663008e+03 7.33137105e+03 2.00172275e+03
 1.83771421e+04 3.98770942e+03 1.23673288e+03 5.26892424e+02
 3.23063487e+02 1.92522251e+02 1.03005517e+02 8.16883998e+01
 3.56896490e+01 3.68911108e+01 7.93845215e+00 1.19485966e+01
 3.14311176e+00 5.96396234e+00 8.59990102e+00 4.29636538e+01
 4.92786468e-01 1.20450293e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32551532009141
cond(S) = 12562.874528082073
E1 = -689.3288218368074  E_coul = 184.88834800353652
init E= -504.440473833271
    CPU time for initialize scf      4.14 sec, wall time      0.33 sec
  HOMO = -0.674911443086817  LUMO = 8.79415173704973
  mo_energy =
[-1.21707195e+02 -1.33892862e+01 -7.62961734e+00 -7.62961734e+00
 -7.62961734e+00 -1.64024846e+00 -6.74911443e-01 -6.74911443e-01
 -6.74911443e-01  8.79415174e+00  9.92779611e+01  5.29853831e+02
  2.36141061e+03  1.15450590e+04  4.11289996e+04  1.09978925e+05
  2.54175501e+05  5.48602643e+05  1.15254766e+06  2.43032754e+06
  5.37505934e+06]
E1 = -707.0299055266721  E_coul = 199.10028600930715
cycle= 1 E= -507.929619517365  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593607
diis-c [-0.35236975  1.        ]
  HOMO = -0.233657171181483  LUMO = 9.69100701040634
  mo_energy =
[-1.20257790e+02 -1.23534115e+01 -6.64795034e+00 -6.64795034e+00
 -6.64795034e+00 -1.16181880e+00 -2.33657171e-01 -2.33657171e-01
 -2.33657171e-01  9.69100701e+00  1.00612280e+02  5.31288762e+02
  2.36278914e+03  1.15463150e+04  4.11301833e+04  1.09980070e+05
  2.54176619e+05  5.48603741e+05  1.15254875e+06  2.43032861e+06
  5.37506040e+06]
E1 = -706.6642226152452  E_coul = 198.7279734862373
cycle= 2 E= -507.936249129008  delta_E= -0.00663  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.08 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155116
diis-c [-2.33158134e-04  4.57880316e-03  9.95421197e-01]
  HOMO = -0.238345007853484  LUMO = 9.67999948327015
  mo_energy =
[-1.20316907e+02 -1.23767147e+01 -6.67680394e+00 -6.67680394e+00
 -6.67680394e+00 -1.16422208e+00 -2.38345008e-01 -2.38345008e-01
 -2.38345008e-01  9.67999948e+00  1.00569023e+02  5.31227801e+02
  2.36271486e+03  1.15462313e+04  4.11300965e+04  1.09979982e+05
  2.54176530e+05  5.48603651e+05  1.15254866e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.6487127297289  E_coul = 198.71245039314772
cycle= 3 E= -507.936262336581  delta_E= -1.32e-05  |g|= 0.000913  |ddm|= 0.00934
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756958
diis-c [-1.64024308e-08  4.49617708e-05 -5.02233019e-02  1.05017834e+00]
  HOMO = -0.238587782739466  LUMO = 9.67944181384182
  mo_energy =
[-1.20319597e+02 -1.23778903e+01 -6.67823152e+00 -6.67823152e+00
 -6.67823152e+00 -1.16434148e+00 -2.38587783e-01 -2.38587783e-01
 -2.38587783e-01  9.67944181e+00  1.00566975e+02  5.31225085e+02
  2.36271174e+03  1.15462280e+04  4.11300930e+04  1.09979978e+05
  2.54176527e+05  5.48603648e+05  1.15254865e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.6479187741353  E_coul = 198.71165640309727
cycle= 4 E= -507.936262371038  delta_E= -3.45e-08  |g|= 7.43e-06  |ddm|= 0.000505
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.33582e-06
diis-c [-5.52295858e-12 -1.97690456e-06  2.43662787e-03 -4.86605232e-02
  1.04622587e+00]
  HOMO = -0.238588841417185  LUMO = 9.67944049802152
  mo_energy =
[-1.20319597e+02 -1.23778940e+01 -6.67823440e+00 -6.67823440e+00
 -6.67823440e+00 -1.16434208e+00 -2.38588841e-01 -2.38588841e-01
 -2.38588841e-01  9.67944050e+00  1.00566974e+02  5.31225086e+02
  2.36271174e+03  1.15462280e+04  4.11300930e+04  1.09979978e+05
  2.54176527e+05  5.48603648e+05  1.15254865e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.647916828246  E_coul = 198.71165445720607
cycle= 5 E= -507.93626237104  delta_E= -1.93e-12  |g|= 1.48e-07  |ddm|= 2.91e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.647916828246  E_coul = 198.71165445720607
  HOMO = -0.238588877530697  LUMO = 9.67944042792833
  mo_energy =
[-1.20319597e+02 -1.23778942e+01 -6.67823458e+00 -6.67823458e+00
 -6.67823458e+00 -1.16434210e+00 -2.38588878e-01 -2.38588878e-01
 -2.38588878e-01  9.67944043e+00  1.00566974e+02  5.31225086e+02
  2.36271174e+03  1.15462280e+04  4.11300930e+04  1.09979978e+05
  2.54176527e+05  5.48603648e+05  1.15254865e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.6479167283471  E_coul = 198.7116543573073
Extra cycle  E= -507.93626237104  delta_E= 1.71e-13  |g|= 7.75e-09  |ddm|= 7.83e-08
    CPU time for scf_cycle      4.41 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12562.874528082073
E1 = -706.6479167283471  E_coul = 198.7116543573073
init E= -507.93626237104
    CPU time for initialize scf      8.85 sec, wall time      0.68 sec
  HOMO = -0.2385888792825  LUMO = 9.67944042423892
  mo_energy =
[-1.20319597e+02 -1.23778942e+01 -6.67823459e+00 -6.67823459e+00
 -6.67823459e+00 -1.16434210e+00 -2.38588879e-01 -2.38588879e-01
 -2.38588879e-01  9.67944042e+00  1.00566974e+02  5.31225086e+02
  2.36271174e+03  1.15462280e+04  4.11300930e+04  1.09979978e+05
  2.54176527e+05  5.48603648e+05  1.15254865e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.6479167236371  E_coul = 198.71165435259695
cycle= 1 E= -507.93626237104  delta_E= -3.41e-13  |g|= 1.03e-09  |ddm|= 4e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6479167236371  E_coul = 198.71165435259695
  HOMO = -0.238588879371023  LUMO = 9.67944042484306
  mo_energy =
[-1.20319597e+02 -1.23778942e+01 -6.67823459e+00 -6.67823459e+00
 -6.67823459e+00 -1.16434210e+00 -2.38588879e-01 -2.38588879e-01
 -2.38588879e-01  9.67944042e+00  1.00566974e+02  5.31225086e+02
  2.36271174e+03  1.15462280e+04  4.11300930e+04  1.09979978e+05
  2.54176527e+05  5.48603648e+05  1.15254865e+06  2.43032852e+06
  5.37506031e+06]
E1 = -706.6479167234249  E_coul = 198.71165435238484
Extra cycle  E= -507.93626237104  delta_E=    0  |g|= 1.13e-09  |ddm|= 2.13e-10
    CPU time for scf_cycle      9.05 sec, wall time      0.76 sec
exp = [3.96359620e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552266e+04 7.33137105e+03
 1.83771421e+04 1.23673288e+03 3.23063487e+02 1.03005517e+02
 3.56896490e+01 7.93845215e+00 3.14311176e+00 8.59990102e+00
 4.92786468e-01]
grad_E = [-4.71826022e-03 -4.22326285e-12  5.12963679e-10  1.76999533e-09
  1.00464461e-08  3.40702314e-08  2.01243031e-07  1.10795447e-05
  5.29635578e-07 -8.36706547e-05 -8.21750939e-05  3.66086654e-04
 -5.17677658e-04 -3.09385731e-04  6.09051889e-04 -3.40804323e-03
 -5.88356400e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396538246362       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035587        1
[INPUT] 0    0    [1    /1   ]  147021.017439        1
[INPUT] 0    0    [1    /1   ]  73510.5067159        1
[INPUT] 0    0    [1    /1   ]  36755.2267089        1
[INPUT] 0    0    [1    /1   ]  7331.37869042        1
[INPUT] 0    0    [1    /1   ]  18377.1424337        1
[INPUT] 0    0    [1    /1   ]  1236.76699774        1
[INPUT] 0    0    [1    /1   ]  322.69107903         1
[INPUT] 0    0    [1    /1   ]  102.574543841        1
[INPUT] 0    0    [1    /1   ]  35.615682077         1
[INPUT] 0    0    [1    /1   ]  7.97794416518        1
[INPUT] 0    0    [1    /1   ]  3.15466035251        1
[INPUT] 1    0    [1    /1   ]  8.60245671689        1
[INPUT] 1    0    [1    /1   ]  0.492916516144       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39653824636239665, 1.0]], [0, [1176168.1426076568, 1.0]], [0, [588084.0712837013, 1.0]], [0, [294042.03558661754, 1.0]], [0, [147021.017439211, 1.0]], [0, [73510.50671590342, 1.0]], [0, [36755.22670886013, 1.0]], [0, [7331.378690418198, 1.0]], [0, [18377.142433708857, 1.0]], [0, [1236.7669977433532, 1.0]], [0, [322.6910790301618, 1.0]], [0, [102.57454384084986, 1.0]], [0, [35.615682076984605, 1.0]], [0, [7.97794416517857, 1.0]], [0, [3.1546603525132846, 1.0]], [1, [8.60245671689402, 1.0]], [1, [0.4929165161444242, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39653825]
bas 1, expnt(s) = [1176168.14260766]
bas 2, expnt(s) = [588084.0712837]
bas 3, expnt(s) = [294042.03558662]
bas 4, expnt(s) = [147021.01743921]
bas 5, expnt(s) = [73510.5067159]
bas 6, expnt(s) = [36755.22670886]
bas 7, expnt(s) = [7331.37869042]
bas 8, expnt(s) = [18377.14243371]
bas 9, expnt(s) = [1236.76699774]
bas 10, expnt(s) = [322.69107903]
bas 11, expnt(s) = [102.57454384]
bas 12, expnt(s) = [35.61568208]
bas 13, expnt(s) = [7.97794417]
bas 14, expnt(s) = [3.15466035]
bas 15, expnt(s) = [8.60245672]
bas 16, expnt(s) = [0.49291652]
CPU time:      1034.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96538246e-01 1.26249258e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791685e+04
 3.67552267e+04 6.70663010e+03 7.33137869e+03 2.00172431e+03
 1.83771424e+04 3.98770948e+03 1.23676700e+03 5.26903326e+02
 3.22691079e+02 1.92355781e+02 1.02574544e+02 8.14319285e+01
 3.56156821e+01 3.68337532e+01 7.97794417e+00 1.19931501e+01
 3.15466035e+00 5.98038963e+00 8.60245672e+00 4.29796142e+01
 4.92916516e-01 1.20490028e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32530729379286
cond(S) = 12562.284994710459
E1 = -689.3431228368595  E_coul = 184.90470753755474
init E= -504.438415299305
    CPU time for initialize scf      3.94 sec, wall time      0.34 sec
  HOMO = -0.674742480034849  LUMO = 8.86288483988723
  mo_energy =
[-1.21704408e+02 -1.33879903e+01 -7.62850488e+00 -7.62850488e+00
 -7.62850488e+00 -1.64012621e+00 -6.74742480e-01 -6.74742480e-01
 -6.74742480e-01  8.86288484e+00  9.91831246e+01  5.28468385e+02
  2.35875257e+03  1.15422969e+04  4.11264077e+04  1.09976443e+05
  2.54173101e+05  5.48600312e+05  1.15254540e+06  2.43032533e+06
  5.37505720e+06]
E1 = -707.0511609890154  E_coul = 199.12142386629657
cycle= 1 E= -507.929737122719  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
diis-norm(errvec)=0.593657
diis-c [-0.35242868  1.        ]
  HOMO = -0.233293359287531  LUMO = 9.76169393192299
  mo_energy =
[-1.20254479e+02 -1.23518382e+01 -6.64652932e+00 -6.64652932e+00
 -6.64652932e+00 -1.16152715e+00 -2.33293359e-01 -2.33293359e-01
 -2.33293359e-01  9.76169393e+00  1.00517429e+02  5.29903799e+02
  2.36013161e+03  1.15435534e+04  4.11275920e+04  1.09977588e+05
  2.54174219e+05  5.48601410e+05  1.15254648e+06  2.43032641e+06
  5.37505827e+06]
E1 = -706.6876461833012  E_coul = 198.75132380949543
cycle= 2 E= -507.936322373806  delta_E= -0.00659  |g|= 0.0184  |ddm|= 0.201
    CPU time for cycle= 2      0.10 sec, wall time      0.01 sec
diis-norm(errvec)=0.0154974
diis-c [-2.32784021e-04  4.55846627e-03  9.95441534e-01]
  HOMO = -0.237940273702243  LUMO = 9.75071934801239
  mo_energy =
[-1.20313348e+02 -1.23749752e+01 -6.67520388e+00 -6.67520388e+00
 -6.67520388e+00 -1.16390543e+00 -2.37940274e-01 -2.37940274e-01
 -2.37940274e-01  9.75071935e+00  1.00474419e+02  5.29843116e+02
  2.36005761e+03  1.15434700e+04  4.11275054e+04  1.09977501e+05
  2.54174130e+05  5.48601321e+05  1.15254639e+06  2.43032632e+06
  5.37505818e+06]
E1 = -706.6722890135513  E_coul = 198.73595363519422
cycle= 3 E= -507.936335378357  delta_E= -1.3e-05  |g|= 0.000906  |ddm|= 0.00924
    CPU time for cycle= 3      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.00075445
diis-c [-1.58023938e-08  4.44370680e-05 -5.01238888e-02  1.05007945e+00]
  HOMO = -0.238179817563359  LUMO = 9.75016584316924
  mo_energy =
[-1.20316017e+02 -1.23761373e+01 -6.67661684e+00 -6.67661684e+00
 -6.67661684e+00 -1.16402306e+00 -2.38179818e-01 -2.38179818e-01
 -2.38179818e-01  9.75016584e+00  1.00472390e+02  5.29840422e+02
  2.36005452e+03  1.15434667e+04  4.11275020e+04  1.09977497e+05
  2.54174127e+05  5.48601318e+05  1.15254639e+06  2.43032631e+06
  5.37505818e+06]
E1 = -706.6715063637472  E_coul = 198.73517095179946
cycle= 4 E= -507.936335411948  delta_E= -3.36e-08  |g|= 7.21e-06  |ddm|= 0.000498
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.18731e-06
diis-c [-5.41504779e-12 -1.96686138e-06  2.40753666e-03 -4.81110263e-02
  1.04570546e+00]
  HOMO = -0.238180823794231  LUMO = 9.75016461248514
  mo_energy =
[-1.20316017e+02 -1.23761408e+01 -6.67661951e+00 -6.67661951e+00
 -6.67661951e+00 -1.16402362e+00 -2.38180824e-01 -2.38180824e-01
 -2.38180824e-01  9.75016461e+00  1.00472389e+02  5.29840423e+02
  2.36005452e+03  1.15434667e+04  4.11275020e+04  1.09977497e+05
  2.54174127e+05  5.48601318e+05  1.15254639e+06  2.43032631e+06
  5.37505818e+06]
E1 = -706.671504557629  E_coul = 198.73516914567955
cycle= 5 E= -507.936335411949  delta_E= -1.65e-12  |g|= 1.47e-07  |ddm|= 2.78e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.671504557629  E_coul = 198.73516914567955
  HOMO = -0.238180859519381  LUMO = 9.75016454307618
  mo_energy =
[-1.20316017e+02 -1.23761410e+01 -6.67661969e+00 -6.67661969e+00
 -6.67661969e+00 -1.16402364e+00 -2.38180860e-01 -2.38180860e-01
 -2.38180860e-01  9.75016454e+00  1.00472389e+02  5.29840423e+02
  2.36005452e+03  1.15434667e+04  4.11275020e+04  1.09977497e+05
  2.54174127e+05  5.48601318e+05  1.15254639e+06  2.43032631e+06
  5.37505818e+06]
E1 = -706.6715044589865  E_coul = 198.7351690470371
Extra cycle  E= -507.936335411949  delta_E= -5.68e-14  |g|= 7.71e-09  |ddm|= 7.73e-08
    CPU time for scf_cycle      4.22 sec, wall time      0.41 sec
exp = [3.96538246e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552267e+04 7.33137869e+03
 1.83771424e+04 1.23676700e+03 3.22691079e+02 1.02574544e+02
 3.56156821e+01 7.97794417e+00 3.15466035e+00 8.60245672e+00
 4.92916516e-01]
E = -507.93633541194947
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396538246362       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035587        1
[INPUT] 0    0    [1    /1   ]  147021.017439        1
[INPUT] 0    0    [1    /1   ]  73510.5067159        1
[INPUT] 0    0    [1    /1   ]  36755.2267089        1
[INPUT] 0    0    [1    /1   ]  7331.37869042        1
[INPUT] 0    0    [1    /1   ]  18377.1424337        1
[INPUT] 0    0    [1    /1   ]  1236.76699774        1
[INPUT] 0    0    [1    /1   ]  322.69107903         1
[INPUT] 0    0    [1    /1   ]  102.574543841        1
[INPUT] 0    0    [1    /1   ]  35.615682077         1
[INPUT] 0    0    [1    /1   ]  7.97794416518        1
[INPUT] 0    0    [1    /1   ]  3.15466035251        1
[INPUT] 1    0    [1    /1   ]  8.60245671689        1
[INPUT] 1    0    [1    /1   ]  0.492916516144       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39653824636239665, 1.0]], [0, [1176168.1426076568, 1.0]], [0, [588084.0712837013, 1.0]], [0, [294042.03558661754, 1.0]], [0, [147021.017439211, 1.0]], [0, [73510.50671590342, 1.0]], [0, [36755.22670886013, 1.0]], [0, [7331.378690418198, 1.0]], [0, [18377.142433708857, 1.0]], [0, [1236.7669977433532, 1.0]], [0, [322.6910790301618, 1.0]], [0, [102.57454384084986, 1.0]], [0, [35.615682076984605, 1.0]], [0, [7.97794416517857, 1.0]], [0, [3.1546603525132846, 1.0]], [1, [8.60245671689402, 1.0]], [1, [0.4929165161444242, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39653825]
bas 1, expnt(s) = [1176168.14260766]
bas 2, expnt(s) = [588084.0712837]
bas 3, expnt(s) = [294042.03558662]
bas 4, expnt(s) = [147021.01743921]
bas 5, expnt(s) = [73510.5067159]
bas 6, expnt(s) = [36755.22670886]
bas 7, expnt(s) = [7331.37869042]
bas 8, expnt(s) = [18377.14243371]
bas 9, expnt(s) = [1236.76699774]
bas 10, expnt(s) = [322.69107903]
bas 11, expnt(s) = [102.57454384]
bas 12, expnt(s) = [35.61568208]
bas 13, expnt(s) = [7.97794417]
bas 14, expnt(s) = [3.15466035]
bas 15, expnt(s) = [8.60245672]
bas 16, expnt(s) = [0.49291652]
CPU time:      1038.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96538246e-01 1.26249258e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791685e+04
 3.67552267e+04 6.70663010e+03 7.33137869e+03 2.00172431e+03
 1.83771424e+04 3.98770948e+03 1.23676700e+03 5.26903326e+02
 3.22691079e+02 1.92355781e+02 1.02574544e+02 8.14319285e+01
 3.56156821e+01 3.68337532e+01 7.97794417e+00 1.19931501e+01
 3.15466035e+00 5.98038963e+00 8.60245672e+00 4.29796142e+01
 4.92916516e-01 1.20490028e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32530729379286
cond(S) = 12562.284994710459
E1 = -689.3431228368595  E_coul = 184.90470753755474
init E= -504.438415299305
    CPU time for initialize scf      3.81 sec, wall time      0.33 sec
  HOMO = -0.674742480034849  LUMO = 8.86288483988723
  mo_energy =
[-1.21704408e+02 -1.33879903e+01 -7.62850488e+00 -7.62850488e+00
 -7.62850488e+00 -1.64012621e+00 -6.74742480e-01 -6.74742480e-01
 -6.74742480e-01  8.86288484e+00  9.91831246e+01  5.28468385e+02
  2.35875257e+03  1.15422969e+04  4.11264077e+04  1.09976443e+05
  2.54173101e+05  5.48600312e+05  1.15254540e+06  2.43032533e+06
  5.37505720e+06]
E1 = -707.0511609890154  E_coul = 199.12142386629657
cycle= 1 E= -507.929737122719  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.20 sec, wall time      0.02 sec
diis-norm(errvec)=0.593657
diis-c [-0.35242868  1.        ]
  HOMO = -0.233293359287531  LUMO = 9.76169393192299
  mo_energy =
[-1.20254479e+02 -1.23518382e+01 -6.64652932e+00 -6.64652932e+00
 -6.64652932e+00 -1.16152715e+00 -2.33293359e-01 -2.33293359e-01
 -2.33293359e-01  9.76169393e+00  1.00517429e+02  5.29903799e+02
  2.36013161e+03  1.15435534e+04  4.11275920e+04  1.09977588e+05
  2.54174219e+05  5.48601410e+05  1.15254648e+06  2.43032641e+06
  5.37505827e+06]
E1 = -706.6876461833012  E_coul = 198.75132380949543
cycle= 2 E= -507.936322373806  delta_E= -0.00659  |g|= 0.0184  |ddm|= 0.201
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0154974
diis-c [-2.32784021e-04  4.55846627e-03  9.95441534e-01]
  HOMO = -0.237940273702243  LUMO = 9.75071934801239
  mo_energy =
[-1.20313348e+02 -1.23749752e+01 -6.67520388e+00 -6.67520388e+00
 -6.67520388e+00 -1.16390543e+00 -2.37940274e-01 -2.37940274e-01
 -2.37940274e-01  9.75071935e+00  1.00474419e+02  5.29843116e+02
  2.36005761e+03  1.15434700e+04  4.11275054e+04  1.09977501e+05
  2.54174130e+05  5.48601321e+05  1.15254639e+06  2.43032632e+06
  5.37505818e+06]
E1 = -706.6722890135513  E_coul = 198.73595363519422
cycle= 3 E= -507.936335378357  delta_E= -1.3e-05  |g|= 0.000906  |ddm|= 0.00924
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00075445
diis-c [-1.58023938e-08  4.44370680e-05 -5.01238888e-02  1.05007945e+00]
  HOMO = -0.238179817563359  LUMO = 9.75016584316924
  mo_energy =
[-1.20316017e+02 -1.23761373e+01 -6.67661684e+00 -6.67661684e+00
 -6.67661684e+00 -1.16402306e+00 -2.38179818e-01 -2.38179818e-01
 -2.38179818e-01  9.75016584e+00  1.00472390e+02  5.29840422e+02
  2.36005452e+03  1.15434667e+04  4.11275020e+04  1.09977497e+05
  2.54174127e+05  5.48601318e+05  1.15254639e+06  2.43032631e+06
  5.37505818e+06]
E1 = -706.6715063637472  E_coul = 198.73517095179946
cycle= 4 E= -507.936335411948  delta_E= -3.36e-08  |g|= 7.21e-06  |ddm|= 0.000498
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.18731e-06
diis-c [-5.41504779e-12 -1.96686138e-06  2.40753666e-03 -4.81110263e-02
  1.04570546e+00]
  HOMO = -0.238180823794231  LUMO = 9.75016461248514
  mo_energy =
[-1.20316017e+02 -1.23761408e+01 -6.67661951e+00 -6.67661951e+00
 -6.67661951e+00 -1.16402362e+00 -2.38180824e-01 -2.38180824e-01
 -2.38180824e-01  9.75016461e+00  1.00472389e+02  5.29840423e+02
  2.36005452e+03  1.15434667e+04  4.11275020e+04  1.09977497e+05
  2.54174127e+05  5.48601318e+05  1.15254639e+06  2.43032631e+06
  5.37505818e+06]
E1 = -706.671504557629  E_coul = 198.73516914567955
cycle= 5 E= -507.936335411949  delta_E= -1.65e-12  |g|= 1.47e-07  |ddm|= 2.78e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.671504557629  E_coul = 198.73516914567955
  HOMO = -0.238180859519381  LUMO = 9.75016454307618
  mo_energy =
[-1.20316017e+02 -1.23761410e+01 -6.67661969e+00 -6.67661969e+00
 -6.67661969e+00 -1.16402364e+00 -2.38180860e-01 -2.38180860e-01
 -2.38180860e-01  9.75016454e+00  1.00472389e+02  5.29840423e+02
  2.36005452e+03  1.15434667e+04  4.11275020e+04  1.09977497e+05
  2.54174127e+05  5.48601318e+05  1.15254639e+06  2.43032631e+06
  5.37505818e+06]
E1 = -706.6715044589865  E_coul = 198.7351690470371
Extra cycle  E= -507.936335411949  delta_E= -5.68e-14  |g|= 7.71e-09  |ddm|= 7.73e-08
    CPU time for scf_cycle      4.10 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12562.284994710459
E1 = -706.6715044589865  E_coul = 198.7351690470371
init E= -507.936335411949
    CPU time for initialize scf      8.69 sec, wall time      0.73 sec
  HOMO = -0.23818086124473  LUMO = 9.75016453984967
  mo_energy =
[-1.20316017e+02 -1.23761410e+01 -6.67661970e+00 -6.67661970e+00
 -6.67661970e+00 -1.16402364e+00 -2.38180861e-01 -2.38180861e-01
 -2.38180861e-01  9.75016454e+00  1.00472389e+02  5.29840423e+02
  2.36005452e+03  1.15434667e+04  4.11275020e+04  1.09977497e+05
  2.54174127e+05  5.48601318e+05  1.15254639e+06  2.43032631e+06
  5.37505818e+06]
E1 = -706.6715044544195  E_coul = 198.7351690424697
cycle= 1 E= -507.93633541195  delta_E= -3.41e-13  |g|= 9.56e-10  |ddm|= 3.93e-09
    CPU time for cycle= 1      0.03 sec, wall time      0.01 sec
E1 = -706.6715044544195  E_coul = 198.7351690424697
  HOMO = -0.238180861331251  LUMO = 9.75016454027287
  mo_energy =
[-1.20316017e+02 -1.23761410e+01 -6.67661970e+00 -6.67661970e+00
 -6.67661970e+00 -1.16402364e+00 -2.38180861e-01 -2.38180861e-01
 -2.38180861e-01  9.75016454e+00  1.00472389e+02  5.29840423e+02
  2.36005452e+03  1.15434667e+04  4.11275020e+04  1.09977497e+05
  2.54174127e+05  5.48601318e+05  1.15254639e+06  2.43032631e+06
  5.37505818e+06]
E1 = -706.6715044541535  E_coul = 198.73516904220352
Extra cycle  E= -507.93633541195  delta_E= -1.14e-13  |g|= 1.07e-09  |ddm|= 2.31e-10
    CPU time for scf_cycle      8.78 sec, wall time      0.80 sec
exp = [3.96538246e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552267e+04 7.33137869e+03
 1.83771424e+04 1.23676700e+03 3.22691079e+02 1.02574544e+02
 3.56156821e+01 7.97794417e+00 3.15466035e+00 8.60245672e+00
 4.92916516e-01]
grad_E = [-1.71270077e-03 -3.86643587e-12  5.15224757e-10  1.77874878e-09
  1.00893373e-08  3.42355887e-08  2.02095361e-07  1.11293112e-05
  5.32532425e-07 -8.73643855e-05 -3.23711329e-05  1.35881793e-04
 -1.66251173e-04 -1.18291067e-04  6.20521328e-04 -1.33345175e-03
 -2.99175446e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396652253256       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035588        1
[INPUT] 0    0    [1    /1   ]  147021.01745         1
[INPUT] 0    0    [1    /1   ]  73510.5067517        1
[INPUT] 0    0    [1    /1   ]  36755.2269291        1
[INPUT] 0    0    [1    /1   ]  7331.39070455        1
[INPUT] 0    0    [1    /1   ]  18377.1429669        1
[INPUT] 0    0    [1    /1   ]  1236.82740043        1
[INPUT] 0    0    [1    /1   ]  322.025748515        1
[INPUT] 0    0    [1    /1   ]  102.089294728        1
[INPUT] 0    0    [1    /1   ]  35.497045389         1
[INPUT] 0    0    [1    /1   ]  7.97037604615        1
[INPUT] 0    0    [1    /1   ]  3.14911726419        1
[INPUT] 1    0    [1    /1   ]  8.6038757021         1
[INPUT] 1    0    [1    /1   ]  0.493013455218       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966522532562355, 1.0]], [0, [1176168.142607624, 1.0]], [0, [588084.0712842557, 1.0]], [0, [294042.0355884621, 1.0]], [0, [147021.01745017632, 1.0]], [0, [73510.50675165732, 1.0]], [0, [36755.22692907317, 1.0]], [0, [7331.390704552352, 1.0]], [0, [18377.142966892032, 1.0]], [0, [1236.8274004279838, 1.0]], [0, [322.0257485148865, 1.0]], [0, [102.08929472804209, 1.0]], [0, [35.4970453890001, 1.0]], [0, [7.970376046154419, 1.0]], [0, [3.149117264193651, 1.0]], [1, [8.60387570210397, 1.0]], [1, [0.4930134552179368, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39665225]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128426]
bas 3, expnt(s) = [294042.03558846]
bas 4, expnt(s) = [147021.01745018]
bas 5, expnt(s) = [73510.50675166]
bas 6, expnt(s) = [36755.22692907]
bas 7, expnt(s) = [7331.39070455]
bas 8, expnt(s) = [18377.14296689]
bas 9, expnt(s) = [1236.82740043]
bas 10, expnt(s) = [322.02574851]
bas 11, expnt(s) = [102.08929473]
bas 12, expnt(s) = [35.49704539]
bas 13, expnt(s) = [7.97037605]
bas 14, expnt(s) = [3.14911726]
bas 15, expnt(s) = [8.6038757]
bas 16, expnt(s) = [0.49301346]
CPU time:      1054.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96652253e-01 1.26276480e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552269e+04 6.70663013e+03 7.33139070e+03 2.00172677e+03
 1.83771430e+04 3.98770956e+03 1.23682740e+03 5.26922626e+02
 3.22025749e+02 1.92058253e+02 1.02089295e+02 8.11428349e+01
 3.54970454e+01 3.67416942e+01 7.97037605e+00 1.19846163e+01
 3.14911726e+00 5.97250674e+00 8.60387570e+00 4.29884763e+01
 4.93013455e-01 1.20519649e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325165950822857
cond(S) = 12561.326297479276
E1 = -689.3527991681095  E_coul = 184.9150541851639
init E= -504.437744982946
    CPU time for initialize scf      3.82 sec, wall time      0.33 sec
  HOMO = -0.674612229616537  LUMO = 8.83848310824142
  mo_energy =
[-1.21702704e+02 -1.33872176e+01 -7.62779771e+00 -7.62779771e+00
 -7.62779771e+00 -1.63998757e+00 -6.74612230e-01 -6.74612230e-01
 -6.74612230e-01  8.83848311e+00  9.87230425e+01  5.26321339e+02
  2.35471789e+03  1.15380711e+04  4.11224400e+04  1.09972644e+05
  2.54169425e+05  5.48596744e+05  1.15254193e+06  2.43032196e+06
  5.37505394e+06]
E1 = -707.0643728982378  E_coul = 199.13463705858695
cycle= 1 E= -507.929735839651  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
diis-norm(errvec)=0.593709
diis-c [-0.35249008  1.        ]
  HOMO = -0.233029506065554  LUMO = 9.73669799182665
  mo_energy =
[-1.20252541e+02 -1.23508899e+01 -6.64564009e+00 -6.64564009e+00
 -6.64564009e+00 -1.16127419e+00 -2.33029506e-01 -2.33029506e-01
 -2.33029506e-01  9.73669799e+00  1.00056838e+02  5.27756945e+02
  2.35609713e+03  1.15393278e+04  4.11236245e+04  1.09973789e+05
  2.54170544e+05  5.48597842e+05  1.15254301e+06  2.43032304e+06
  5.37505500e+06]
E1 = -706.6999411712607  E_coul = 198.763600699066
cycle= 2 E= -507.936340472195  delta_E= -0.0066  |g|= 0.0184  |ddm|= 0.202
    CPU time for cycle= 2      0.10 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155142
diis-c [-2.33317460e-04  4.55369121e-03  9.95446309e-01]
  HOMO = -0.237693950049887  LUMO = 9.72571212749983
  mo_energy =
[-1.20311522e+02 -1.23740924e+01 -6.67439072e+00 -6.67439072e+00
 -6.67439072e+00 -1.16366218e+00 -2.37693950e-01 -2.37693950e-01
 -2.37693950e-01  9.72571213e+00  1.00013800e+02  5.27696184e+02
  2.35602300e+03  1.15392443e+04  4.11235377e+04  1.09973701e+05
  2.54170455e+05  5.48597753e+05  1.15254292e+06  2.43032295e+06
  5.37505491e+06]
E1 = -706.6845242650717  E_coul = 198.74817071112264
cycle= 3 E= -507.936353553949  delta_E= -1.31e-05  |g|= 0.000908  |ddm|= 0.00928
    CPU time for cycle= 3      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.000755687
diis-c [-1.60565077e-08  4.47850667e-05 -5.01422725e-02  1.05009749e+00]
  HOMO = -0.237934723268836  LUMO = 9.72515729908577
  mo_energy =
[-1.20314199e+02 -1.23752592e+01 -6.67580903e+00 -6.67580903e+00
 -6.67580903e+00 -1.16378045e+00 -2.37934723e-01 -2.37934723e-01
 -2.37934723e-01  9.72515730e+00  1.00011768e+02  5.27693484e+02
  2.35601990e+03  1.15392409e+04  4.11235343e+04  1.09973698e+05
  2.54170452e+05  5.48597749e+05  1.15254292e+06  2.43032294e+06
  5.37505491e+06]
E1 = -706.6837375630041  E_coul = 198.74738397516305
cycle= 4 E= -507.936353587841  delta_E= -3.39e-08  |g|= 7.29e-06  |ddm|= 0.0005
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.24924e-06
diis-c [-5.47522239e-12 -1.96964339e-06  2.41764827e-03 -4.83183895e-02
  1.04590271e+00]
  HOMO = -0.237935749887471  LUMO = 9.72515603572686
  mo_energy =
[-1.20314198e+02 -1.23752628e+01 -6.67581178e+00 -6.67581178e+00
 -6.67581178e+00 -1.16378102e+00 -2.37935750e-01 -2.37935750e-01
 -2.37935750e-01  9.72515604e+00  1.00011767e+02  5.27693485e+02
  2.35601991e+03  1.15392409e+04  4.11235343e+04  1.09973698e+05
  2.54170452e+05  5.48597749e+05  1.15254292e+06  2.43032294e+06
  5.37505491e+06]
E1 = -706.6837357024282  E_coul = 198.74738211458518
cycle= 5 E= -507.936353587843  delta_E= -1.93e-12  |g|= 1.47e-07  |ddm|= 2.83e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6837357024282  E_coul = 198.74738211458518
  HOMO = -0.237935785801614  LUMO = 9.72515596669608
  mo_energy =
[-1.20314198e+02 -1.23752630e+01 -6.67581196e+00 -6.67581196e+00
 -6.67581196e+00 -1.16378104e+00 -2.37935786e-01 -2.37935786e-01
 -2.37935786e-01  9.72515597e+00  1.00011766e+02  5.27693484e+02
  2.35601991e+03  1.15392409e+04  4.11235343e+04  1.09973698e+05
  2.54170452e+05  5.48597749e+05  1.15254292e+06  2.43032294e+06
  5.37505491e+06]
E1 = -706.6837356031858  E_coul = 198.74738201534265
Extra cycle  E= -507.936353587843  delta_E= -2.27e-13  |g|= 7.69e-09  |ddm|= 7.77e-08
    CPU time for scf_cycle      4.10 sec, wall time      0.40 sec
exp = [3.96652253e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552269e+04 7.33139070e+03
 1.83771430e+04 1.23682740e+03 3.22025749e+02 1.02089295e+02
 3.54970454e+01 7.97037605e+00 3.14911726e+00 8.60387570e+00
 4.93013455e-01]
E = -507.9363535878432
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396652253256       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035588        1
[INPUT] 0    0    [1    /1   ]  147021.01745         1
[INPUT] 0    0    [1    /1   ]  73510.5067517        1
[INPUT] 0    0    [1    /1   ]  36755.2269291        1
[INPUT] 0    0    [1    /1   ]  7331.39070455        1
[INPUT] 0    0    [1    /1   ]  18377.1429669        1
[INPUT] 0    0    [1    /1   ]  1236.82740043        1
[INPUT] 0    0    [1    /1   ]  322.025748515        1
[INPUT] 0    0    [1    /1   ]  102.089294728        1
[INPUT] 0    0    [1    /1   ]  35.497045389         1
[INPUT] 0    0    [1    /1   ]  7.97037604615        1
[INPUT] 0    0    [1    /1   ]  3.14911726419        1
[INPUT] 1    0    [1    /1   ]  8.6038757021         1
[INPUT] 1    0    [1    /1   ]  0.493013455218       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966522532562355, 1.0]], [0, [1176168.142607624, 1.0]], [0, [588084.0712842557, 1.0]], [0, [294042.0355884621, 1.0]], [0, [147021.01745017632, 1.0]], [0, [73510.50675165732, 1.0]], [0, [36755.22692907317, 1.0]], [0, [7331.390704552352, 1.0]], [0, [18377.142966892032, 1.0]], [0, [1236.8274004279838, 1.0]], [0, [322.0257485148865, 1.0]], [0, [102.08929472804209, 1.0]], [0, [35.4970453890001, 1.0]], [0, [7.970376046154419, 1.0]], [0, [3.149117264193651, 1.0]], [1, [8.60387570210397, 1.0]], [1, [0.4930134552179368, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39665225]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128426]
bas 3, expnt(s) = [294042.03558846]
bas 4, expnt(s) = [147021.01745018]
bas 5, expnt(s) = [73510.50675166]
bas 6, expnt(s) = [36755.22692907]
bas 7, expnt(s) = [7331.39070455]
bas 8, expnt(s) = [18377.14296689]
bas 9, expnt(s) = [1236.82740043]
bas 10, expnt(s) = [322.02574851]
bas 11, expnt(s) = [102.08929473]
bas 12, expnt(s) = [35.49704539]
bas 13, expnt(s) = [7.97037605]
bas 14, expnt(s) = [3.14911726]
bas 15, expnt(s) = [8.6038757]
bas 16, expnt(s) = [0.49301346]
CPU time:      1058.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96652253e-01 1.26276480e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552269e+04 6.70663013e+03 7.33139070e+03 2.00172677e+03
 1.83771430e+04 3.98770956e+03 1.23682740e+03 5.26922626e+02
 3.22025749e+02 1.92058253e+02 1.02089295e+02 8.11428349e+01
 3.54970454e+01 3.67416942e+01 7.97037605e+00 1.19846163e+01
 3.14911726e+00 5.97250674e+00 8.60387570e+00 4.29884763e+01
 4.93013455e-01 1.20519649e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325165950822857
cond(S) = 12561.326297479276
E1 = -689.3527991681095  E_coul = 184.9150541851639
init E= -504.437744982946
    CPU time for initialize scf      3.95 sec, wall time      0.33 sec
  HOMO = -0.674612229616537  LUMO = 8.83848310824142
  mo_energy =
[-1.21702704e+02 -1.33872176e+01 -7.62779771e+00 -7.62779771e+00
 -7.62779771e+00 -1.63998757e+00 -6.74612230e-01 -6.74612230e-01
 -6.74612230e-01  8.83848311e+00  9.87230425e+01  5.26321339e+02
  2.35471789e+03  1.15380711e+04  4.11224400e+04  1.09972644e+05
  2.54169425e+05  5.48596744e+05  1.15254193e+06  2.43032196e+06
  5.37505394e+06]
E1 = -707.0643728982378  E_coul = 199.13463705858695
cycle= 1 E= -507.929735839651  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593709
diis-c [-0.35249008  1.        ]
  HOMO = -0.233029506065554  LUMO = 9.73669799182665
  mo_energy =
[-1.20252541e+02 -1.23508899e+01 -6.64564009e+00 -6.64564009e+00
 -6.64564009e+00 -1.16127419e+00 -2.33029506e-01 -2.33029506e-01
 -2.33029506e-01  9.73669799e+00  1.00056838e+02  5.27756945e+02
  2.35609713e+03  1.15393278e+04  4.11236245e+04  1.09973789e+05
  2.54170544e+05  5.48597842e+05  1.15254301e+06  2.43032304e+06
  5.37505500e+06]
E1 = -706.6999411712607  E_coul = 198.763600699066
cycle= 2 E= -507.936340472195  delta_E= -0.0066  |g|= 0.0184  |ddm|= 0.202
    CPU time for cycle= 2      0.09 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155142
diis-c [-2.33317460e-04  4.55369121e-03  9.95446309e-01]
  HOMO = -0.237693950049887  LUMO = 9.72571212749983
  mo_energy =
[-1.20311522e+02 -1.23740924e+01 -6.67439072e+00 -6.67439072e+00
 -6.67439072e+00 -1.16366218e+00 -2.37693950e-01 -2.37693950e-01
 -2.37693950e-01  9.72571213e+00  1.00013800e+02  5.27696184e+02
  2.35602300e+03  1.15392443e+04  4.11235377e+04  1.09973701e+05
  2.54170455e+05  5.48597753e+05  1.15254292e+06  2.43032295e+06
  5.37505491e+06]
E1 = -706.6845242650717  E_coul = 198.74817071112264
cycle= 3 E= -507.936353553949  delta_E= -1.31e-05  |g|= 0.000908  |ddm|= 0.00928
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000755687
diis-c [-1.60565077e-08  4.47850667e-05 -5.01422725e-02  1.05009749e+00]
  HOMO = -0.237934723268836  LUMO = 9.72515729908577
  mo_energy =
[-1.20314199e+02 -1.23752592e+01 -6.67580903e+00 -6.67580903e+00
 -6.67580903e+00 -1.16378045e+00 -2.37934723e-01 -2.37934723e-01
 -2.37934723e-01  9.72515730e+00  1.00011768e+02  5.27693484e+02
  2.35601990e+03  1.15392409e+04  4.11235343e+04  1.09973698e+05
  2.54170452e+05  5.48597749e+05  1.15254292e+06  2.43032294e+06
  5.37505491e+06]
E1 = -706.6837375630041  E_coul = 198.74738397516305
cycle= 4 E= -507.936353587841  delta_E= -3.39e-08  |g|= 7.29e-06  |ddm|= 0.0005
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.24924e-06
diis-c [-5.47522239e-12 -1.96964339e-06  2.41764827e-03 -4.83183895e-02
  1.04590271e+00]
  HOMO = -0.237935749887471  LUMO = 9.72515603572686
  mo_energy =
[-1.20314198e+02 -1.23752628e+01 -6.67581178e+00 -6.67581178e+00
 -6.67581178e+00 -1.16378102e+00 -2.37935750e-01 -2.37935750e-01
 -2.37935750e-01  9.72515604e+00  1.00011767e+02  5.27693485e+02
  2.35601991e+03  1.15392409e+04  4.11235343e+04  1.09973698e+05
  2.54170452e+05  5.48597749e+05  1.15254292e+06  2.43032294e+06
  5.37505491e+06]
E1 = -706.6837357024282  E_coul = 198.74738211458518
cycle= 5 E= -507.936353587843  delta_E= -1.93e-12  |g|= 1.47e-07  |ddm|= 2.83e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6837357024282  E_coul = 198.74738211458518
  HOMO = -0.237935785801614  LUMO = 9.72515596669608
  mo_energy =
[-1.20314198e+02 -1.23752630e+01 -6.67581196e+00 -6.67581196e+00
 -6.67581196e+00 -1.16378104e+00 -2.37935786e-01 -2.37935786e-01
 -2.37935786e-01  9.72515597e+00  1.00011766e+02  5.27693484e+02
  2.35601991e+03  1.15392409e+04  4.11235343e+04  1.09973698e+05
  2.54170452e+05  5.48597749e+05  1.15254292e+06  2.43032294e+06
  5.37505491e+06]
E1 = -706.6837356031858  E_coul = 198.74738201534265
Extra cycle  E= -507.936353587843  delta_E= -2.27e-13  |g|= 7.69e-09  |ddm|= 7.77e-08
    CPU time for scf_cycle      4.22 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.326297479276
E1 = -706.6837356031858  E_coul = 198.74738201534265
init E= -507.936353587843
    CPU time for initialize scf      9.05 sec, wall time      0.71 sec
  HOMO = -0.237935787538932  LUMO = 9.72515596187541
  mo_energy =
[-1.20314199e+02 -1.23752630e+01 -6.67581197e+00 -6.67581197e+00
 -6.67581197e+00 -1.16378104e+00 -2.37935788e-01 -2.37935788e-01
 -2.37935788e-01  9.72515596e+00  1.00011766e+02  5.27693484e+02
  2.35601991e+03  1.15392409e+04  4.11235343e+04  1.09973698e+05
  2.54170452e+05  5.48597749e+05  1.15254292e+06  2.43032294e+06
  5.37505491e+06]
E1 = -706.6837355985572  E_coul = 198.7473820107144
cycle= 1 E= -507.936353587843  delta_E= 4.55e-13  |g|= 1.34e-09  |ddm|= 3.96e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.6837355985572  E_coul = 198.7473820107144
  HOMO = -0.237935787626397  LUMO = 9.7251559609057
  mo_energy =
[-1.20314199e+02 -1.23752630e+01 -6.67581197e+00 -6.67581197e+00
 -6.67581197e+00 -1.16378104e+00 -2.37935788e-01 -2.37935788e-01
 -2.37935788e-01  9.72515596e+00  1.00011766e+02  5.27693484e+02
  2.35601991e+03  1.15392409e+04  4.11235343e+04  1.09973698e+05
  2.54170452e+05  5.48597749e+05  1.15254292e+06  2.43032294e+06
  5.37505491e+06]
E1 = -706.6837355983055  E_coul = 198.74738201046276
Extra cycle  E= -507.936353587843  delta_E=    0  |g|= 1.01e-09  |ddm|= 1.92e-10
    CPU time for scf_cycle      9.12 sec, wall time      0.77 sec
exp = [3.96652253e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552269e+04 7.33139070e+03
 1.83771430e+04 1.23682740e+03 3.22025749e+02 1.02089295e+02
 3.54970454e+01 7.97037605e+00 3.14911726e+00 8.60387570e+00
 4.93013455e-01]
grad_E = [-2.67351842e-04 -3.95781413e-12  5.14645489e-10  1.77650488e-09
  1.00783585e-08  3.41932145e-08  2.01879119e-07  1.11191768e-05
  5.31793464e-07 -8.79686998e-05 -5.82462732e-06 -8.69090476e-06
  2.78273709e-05  7.54077320e-06  8.98911560e-05 -2.49193330e-04
 -8.08213814e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396665261112       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.5067558        1
[INPUT] 0    0    [1    /1   ]  36755.2269544        1
[INPUT] 0    0    [1    /1   ]  7331.39208492        1
[INPUT] 0    0    [1    /1   ]  18377.1430281        1
[INPUT] 0    0    [1    /1   ]  1236.8349114         1
[INPUT] 0    0    [1    /1   ]  321.943420095        1
[INPUT] 0    0    [1    /1   ]  102.047064224        1
[INPUT] 0    0    [1    /1   ]  35.4801057068        1
[INPUT] 0    0    [1    /1   ]  7.96426047957        1
[INPUT] 0    0    [1    /1   ]  3.14683280599        1
[INPUT] 1    0    [1    /1   ]  8.60411840502        1
[INPUT] 1    0    [1    /1   ]  0.493038142651       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39666526111216116, 1.0]], [0, [1176168.14260762, 1.0]], [0, [588084.0712843194, 1.0]], [0, [294042.03558867384, 1.0]], [0, [147021.0174514367, 1.0]], [0, [73510.50675576324, 1.0]], [0, [36755.22695438607, 1.0]], [0, [7331.39208492413, 1.0]], [0, [18377.14302806169, 1.0]], [0, [1236.8349114024404, 1.0]], [0, [321.94342009500025, 1.0]], [0, [102.0470642240981, 1.0]], [0, [35.48010570684165, 1.0]], [0, [7.964260479571316, 1.0]], [0, [3.146832805985725, 1.0]], [1, [8.604118405017873, 1.0]], [1, [0.49303814265102164, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39666526]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128432]
bas 3, expnt(s) = [294042.03558867]
bas 4, expnt(s) = [147021.01745144]
bas 5, expnt(s) = [73510.50675576]
bas 6, expnt(s) = [36755.22695439]
bas 7, expnt(s) = [7331.39208492]
bas 8, expnt(s) = [18377.14302806]
bas 9, expnt(s) = [1236.8349114]
bas 10, expnt(s) = [321.9434201]
bas 11, expnt(s) = [102.04706422]
bas 12, expnt(s) = [35.48010571]
bas 13, expnt(s) = [7.96426048]
bas 14, expnt(s) = [3.14683281]
bas 15, expnt(s) = [8.60411841]
bas 16, expnt(s) = [0.49303814]
CPU time:      1074.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96665261e-01 1.26279586e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552270e+04 6.70663013e+03 7.33139208e+03 2.00172705e+03
 1.83771430e+04 3.98770957e+03 1.23683491e+03 5.26925026e+02
 3.21943420e+02 1.92021425e+02 1.02047064e+02 8.11176593e+01
 3.54801057e+01 3.67285432e+01 7.96426048e+00 1.19777189e+01
 3.14683281e+00 5.96925698e+00 8.60411841e+00 4.29899921e+01
 4.93038143e-01 1.20527193e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325132795120606
cond(S) = 12561.210269989615
E1 = -689.355180039268  E_coul = 184.9170940795201
init E= -504.438085959748
    CPU time for initialize scf      4.13 sec, wall time      0.33 sec
  HOMO = -0.674580703790456  LUMO = 8.82613925564412
  mo_energy =
[-1.21702389e+02 -1.33870602e+01 -7.62766007e+00 -7.62766007e+00
 -7.62766007e+00 -1.63995535e+00 -6.74580704e-01 -6.74580704e-01
 -6.74580704e-01  8.82613926e+00  9.86416450e+01  5.26064314e+02
  2.35425136e+03  1.15375822e+04  4.11219811e+04  1.09972205e+05
  2.54169000e+05  5.48596331e+05  1.15254153e+06  2.43032157e+06
  5.37505356e+06]
E1 = -707.0671070535374  E_coul = 199.137379653256
cycle= 1 E= -507.929727400281  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
diis-norm(errvec)=0.593713
diis-c [-0.35249522  1.        ]
  HOMO = -0.232965387321505  LUMO = 9.72405161896829
  mo_energy =
[-1.20252186e+02 -1.23506843e+01 -6.64545381e+00 -6.64545381e+00
 -6.64545381e+00 -1.16121490e+00 -2.32965387e-01 -2.32965387e-01
 -2.32965387e-01  9.72405162e+00  9.99753925e+01  5.27499953e+02
  2.35563063e+03  1.15388390e+04  4.11231656e+04  1.09973350e+05
  2.54170119e+05  5.48597429e+05  1.15254261e+06  2.43032265e+06
  5.37505463e+06]
E1 = -706.7022535022992  E_coul = 198.76591269939738
cycle= 2 E= -507.936340802902  delta_E= -0.00661  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.09 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155195
diis-c [-2.33479810e-04  4.55446148e-03  9.95445539e-01]
  HOMO = -0.237638068150073  LUMO = 9.7130601151639
  mo_energy =
[-1.20311216e+02 -1.23739180e+01 -6.67423922e+00 -6.67423922e+00
 -6.67423922e+00 -1.16360759e+00 -2.37638068e-01 -2.37638068e-01
 -2.37638068e-01  9.71306012e+00  9.99323223e+01  5.27439145e+02
  2.35555645e+03  1.15387554e+04  4.11230788e+04  1.09973262e+05
  2.54170030e+05  5.48597340e+05  1.15254252e+06  2.43032256e+06
  5.37505454e+06]
E1 = -706.6868075717867  E_coul = 198.75045364891918
cycle= 3 E= -507.936353922868  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756221
diis-c [-1.61738894e-08  4.49099298e-05 -5.01563618e-02  1.05011145e+00]
  HOMO = -0.237879454809048  LUMO = 9.71250457217572
  mo_energy =
[-1.20313897e+02 -1.23750873e+01 -6.67566022e+00 -6.67566022e+00
 -6.67566022e+00 -1.16372618e+00 -2.37879455e-01 -2.37879455e-01
 -2.37879455e-01  9.71250457e+00  9.99302867e+01  5.27436441e+02
  2.35555335e+03  1.15387520e+04  4.11230754e+04  1.09973258e+05
  2.54170026e+05  5.48597337e+05  1.15254252e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.6860187973776  E_coul = 198.74966484046084
cycle= 4 E= -507.936353956917  delta_E= -3.4e-08  |g|= 7.33e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.27784e-06
diis-c [-5.49783250e-12 -1.97265470e-06  2.42275907e-03 -4.84180912e-02
  1.04599730e+00]
  HOMO = -0.237880491436381  LUMO = 9.71250329240254
  mo_energy =
[-1.20313896e+02 -1.23750909e+01 -6.67566301e+00 -6.67566301e+00
 -6.67566301e+00 -1.16372677e+00 -2.37880491e-01 -2.37880491e-01
 -2.37880491e-01  9.71250329e+00  9.99302855e+01  5.27436442e+02
  2.35555335e+03  1.15387520e+04  4.11230754e+04  1.09973258e+05
  2.54170026e+05  5.48597337e+05  1.15254252e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.6860169099072  E_coul = 198.74966295298856
cycle= 5 E= -507.936353956919  delta_E= -1.76e-12  |g|= 1.47e-07  |ddm|= 2.85e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6860169099072  E_coul = 198.74966295298856
  HOMO = -0.237880527431121  LUMO = 9.71250322041471
  mo_energy =
[-1.20313896e+02 -1.23750911e+01 -6.67566319e+00 -6.67566319e+00
 -6.67566319e+00 -1.16372678e+00 -2.37880527e-01 -2.37880527e-01
 -2.37880527e-01  9.71250322e+00  9.99302853e+01  5.27436441e+02
  2.35555335e+03  1.15387520e+04  4.11230754e+04  1.09973258e+05
  2.54170026e+05  5.48597337e+05  1.15254252e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.686016810461  E_coul = 198.7496628535422
Extra cycle  E= -507.936353956919  delta_E= -1.71e-13  |g|= 7.72e-09  |ddm|= 7.79e-08
    CPU time for scf_cycle      4.40 sec, wall time      0.40 sec
exp = [3.96665261e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552270e+04 7.33139208e+03
 1.83771430e+04 1.23683491e+03 3.21943420e+02 1.02047064e+02
 3.54801057e+01 7.96426048e+00 3.14683281e+00 8.60411841e+00
 4.93038143e-01]
E = -507.93635395691877
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396665261112       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.5067558        1
[INPUT] 0    0    [1    /1   ]  36755.2269544        1
[INPUT] 0    0    [1    /1   ]  7331.39208492        1
[INPUT] 0    0    [1    /1   ]  18377.1430281        1
[INPUT] 0    0    [1    /1   ]  1236.8349114         1
[INPUT] 0    0    [1    /1   ]  321.943420095        1
[INPUT] 0    0    [1    /1   ]  102.047064224        1
[INPUT] 0    0    [1    /1   ]  35.4801057068        1
[INPUT] 0    0    [1    /1   ]  7.96426047957        1
[INPUT] 0    0    [1    /1   ]  3.14683280599        1
[INPUT] 1    0    [1    /1   ]  8.60411840502        1
[INPUT] 1    0    [1    /1   ]  0.493038142651       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39666526111216116, 1.0]], [0, [1176168.14260762, 1.0]], [0, [588084.0712843194, 1.0]], [0, [294042.03558867384, 1.0]], [0, [147021.0174514367, 1.0]], [0, [73510.50675576324, 1.0]], [0, [36755.22695438607, 1.0]], [0, [7331.39208492413, 1.0]], [0, [18377.14302806169, 1.0]], [0, [1236.8349114024404, 1.0]], [0, [321.94342009500025, 1.0]], [0, [102.0470642240981, 1.0]], [0, [35.48010570684165, 1.0]], [0, [7.964260479571316, 1.0]], [0, [3.146832805985725, 1.0]], [1, [8.604118405017873, 1.0]], [1, [0.49303814265102164, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39666526]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128432]
bas 3, expnt(s) = [294042.03558867]
bas 4, expnt(s) = [147021.01745144]
bas 5, expnt(s) = [73510.50675576]
bas 6, expnt(s) = [36755.22695439]
bas 7, expnt(s) = [7331.39208492]
bas 8, expnt(s) = [18377.14302806]
bas 9, expnt(s) = [1236.8349114]
bas 10, expnt(s) = [321.9434201]
bas 11, expnt(s) = [102.04706422]
bas 12, expnt(s) = [35.48010571]
bas 13, expnt(s) = [7.96426048]
bas 14, expnt(s) = [3.14683281]
bas 15, expnt(s) = [8.60411841]
bas 16, expnt(s) = [0.49303814]
CPU time:      1079.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96665261e-01 1.26279586e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552270e+04 6.70663013e+03 7.33139208e+03 2.00172705e+03
 1.83771430e+04 3.98770957e+03 1.23683491e+03 5.26925026e+02
 3.21943420e+02 1.92021425e+02 1.02047064e+02 8.11176593e+01
 3.54801057e+01 3.67285432e+01 7.96426048e+00 1.19777189e+01
 3.14683281e+00 5.96925698e+00 8.60411841e+00 4.29899921e+01
 4.93038143e-01 1.20527193e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325132795120606
cond(S) = 12561.210269989615
E1 = -689.355180039268  E_coul = 184.9170940795201
init E= -504.438085959748
    CPU time for initialize scf      4.46 sec, wall time      0.33 sec
  HOMO = -0.674580703790456  LUMO = 8.82613925564412
  mo_energy =
[-1.21702389e+02 -1.33870602e+01 -7.62766007e+00 -7.62766007e+00
 -7.62766007e+00 -1.63995535e+00 -6.74580704e-01 -6.74580704e-01
 -6.74580704e-01  8.82613926e+00  9.86416450e+01  5.26064314e+02
  2.35425136e+03  1.15375822e+04  4.11219811e+04  1.09972205e+05
  2.54169000e+05  5.48596331e+05  1.15254153e+06  2.43032157e+06
  5.37505356e+06]
E1 = -707.0671070535374  E_coul = 199.137379653256
cycle= 1 E= -507.929727400281  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593713
diis-c [-0.35249522  1.        ]
  HOMO = -0.232965387321505  LUMO = 9.72405161896829
  mo_energy =
[-1.20252186e+02 -1.23506843e+01 -6.64545381e+00 -6.64545381e+00
 -6.64545381e+00 -1.16121490e+00 -2.32965387e-01 -2.32965387e-01
 -2.32965387e-01  9.72405162e+00  9.99753925e+01  5.27499953e+02
  2.35563063e+03  1.15388390e+04  4.11231656e+04  1.09973350e+05
  2.54170119e+05  5.48597429e+05  1.15254261e+06  2.43032265e+06
  5.37505463e+06]
E1 = -706.7022535022992  E_coul = 198.76591269939738
cycle= 2 E= -507.936340802902  delta_E= -0.00661  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155195
diis-c [-2.33479810e-04  4.55446148e-03  9.95445539e-01]
  HOMO = -0.237638068150073  LUMO = 9.7130601151639
  mo_energy =
[-1.20311216e+02 -1.23739180e+01 -6.67423922e+00 -6.67423922e+00
 -6.67423922e+00 -1.16360759e+00 -2.37638068e-01 -2.37638068e-01
 -2.37638068e-01  9.71306012e+00  9.99323223e+01  5.27439145e+02
  2.35555645e+03  1.15387554e+04  4.11230788e+04  1.09973262e+05
  2.54170030e+05  5.48597340e+05  1.15254252e+06  2.43032256e+06
  5.37505454e+06]
E1 = -706.6868075717867  E_coul = 198.75045364891918
cycle= 3 E= -507.936353922868  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756221
diis-c [-1.61738894e-08  4.49099298e-05 -5.01563618e-02  1.05011145e+00]
  HOMO = -0.237879454809048  LUMO = 9.71250457217572
  mo_energy =
[-1.20313897e+02 -1.23750873e+01 -6.67566022e+00 -6.67566022e+00
 -6.67566022e+00 -1.16372618e+00 -2.37879455e-01 -2.37879455e-01
 -2.37879455e-01  9.71250457e+00  9.99302867e+01  5.27436441e+02
  2.35555335e+03  1.15387520e+04  4.11230754e+04  1.09973258e+05
  2.54170026e+05  5.48597337e+05  1.15254252e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.6860187973776  E_coul = 198.74966484046084
cycle= 4 E= -507.936353956917  delta_E= -3.4e-08  |g|= 7.33e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.27784e-06
diis-c [-5.49783250e-12 -1.97265470e-06  2.42275907e-03 -4.84180912e-02
  1.04599730e+00]
  HOMO = -0.237880491436381  LUMO = 9.71250329240254
  mo_energy =
[-1.20313896e+02 -1.23750909e+01 -6.67566301e+00 -6.67566301e+00
 -6.67566301e+00 -1.16372677e+00 -2.37880491e-01 -2.37880491e-01
 -2.37880491e-01  9.71250329e+00  9.99302855e+01  5.27436442e+02
  2.35555335e+03  1.15387520e+04  4.11230754e+04  1.09973258e+05
  2.54170026e+05  5.48597337e+05  1.15254252e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.6860169099072  E_coul = 198.74966295298856
cycle= 5 E= -507.936353956919  delta_E= -1.76e-12  |g|= 1.47e-07  |ddm|= 2.85e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6860169099072  E_coul = 198.74966295298856
  HOMO = -0.237880527431121  LUMO = 9.71250322041471
  mo_energy =
[-1.20313896e+02 -1.23750911e+01 -6.67566319e+00 -6.67566319e+00
 -6.67566319e+00 -1.16372678e+00 -2.37880527e-01 -2.37880527e-01
 -2.37880527e-01  9.71250322e+00  9.99302853e+01  5.27436441e+02
  2.35555335e+03  1.15387520e+04  4.11230754e+04  1.09973258e+05
  2.54170026e+05  5.48597337e+05  1.15254252e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.686016810461  E_coul = 198.7496628535422
Extra cycle  E= -507.936353956919  delta_E= -1.71e-13  |g|= 7.72e-09  |ddm|= 7.79e-08
    CPU time for scf_cycle      4.72 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.210269989615
E1 = -706.686016810461  E_coul = 198.7496628535422
init E= -507.936353956919
    CPU time for initialize scf      9.26 sec, wall time      0.66 sec
  HOMO = -0.237880529173594  LUMO = 9.71250321693948
  mo_energy =
[-1.20313897e+02 -1.23750911e+01 -6.67566320e+00 -6.67566320e+00
 -6.67566320e+00 -1.16372678e+00 -2.37880529e-01 -2.37880529e-01
 -2.37880529e-01  9.71250322e+00  9.99302852e+01  5.27436441e+02
  2.35555335e+03  1.15387520e+04  4.11230754e+04  1.09973258e+05
  2.54170026e+05  5.48597337e+05  1.15254252e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.6860168058209  E_coul = 198.74966284890203
cycle= 1 E= -507.936353956919  delta_E= -1.14e-13  |g|= 8.99e-10  |ddm|= 3.94e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6860168058209  E_coul = 198.74966284890203
  HOMO = -0.237880529260813  LUMO = 9.71250321653026
  mo_energy =
[-1.20313897e+02 -1.23750911e+01 -6.67566320e+00 -6.67566320e+00
 -6.67566320e+00 -1.16372678e+00 -2.37880529e-01 -2.37880529e-01
 -2.37880529e-01  9.71250322e+00  9.99302852e+01  5.27436441e+02
  2.35555335e+03  1.15387520e+04  4.11230754e+04  1.09973258e+05
  2.54170026e+05  5.48597337e+05  1.15254252e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.686016805604  E_coul = 198.7496628486855
Extra cycle  E= -507.936353956919  delta_E= 3.41e-13  |g|= 1.23e-09  |ddm|= 2.06e-10
    CPU time for scf_cycle      9.45 sec, wall time      0.72 sec
exp = [3.96665261e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552270e+04 7.33139208e+03
 1.83771430e+04 1.23683491e+03 3.21943420e+02 1.02047064e+02
 3.54801057e+01 7.96426048e+00 3.14683281e+00 8.60411841e+00
 4.93038143e-01]
grad_E = [-8.50379936e-05 -4.02460033e-12  5.14221868e-10  1.77486476e-09
  1.00703244e-08  3.41622341e-08  2.01719844e-07  1.11103689e-05
  5.31251429e-07 -8.75817685e-05 -7.58414505e-06 -3.30952348e-06
  9.59680637e-06 -4.32628942e-06  4.11905970e-05 -7.81806578e-05
 -1.59734500e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396671604701       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.506756         1
[INPUT] 0    0    [1    /1   ]  36755.2269556        1
[INPUT] 0    0    [1    /1   ]  7331.39215018        1
[INPUT] 0    0    [1    /1   ]  18377.1430309        1
[INPUT] 0    0    [1    /1   ]  1236.83538518        1
[INPUT] 0    0    [1    /1   ]  321.939446297        1
[INPUT] 0    0    [1    /1   ]  102.043668352        1
[INPUT] 0    0    [1    /1   ]  35.476665132         1
[INPUT] 0    0    [1    /1   ]  7.96246095526        1
[INPUT] 0    0    [1    /1   ]  3.14603400238        1
[INPUT] 1    0    [1    /1   ]  8.6042071813         1
[INPUT] 1    0    [1    /1   ]  0.493044787146       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966716047009314, 1.0]], [0, [1176168.1426076198, 1.0]], [0, [588084.0712843224, 1.0]], [0, [294042.0355886838, 1.0]], [0, [147021.0174514963, 1.0]], [0, [73510.50675595611, 1.0]], [0, [36755.22695558376, 1.0]], [0, [7331.392150179298, 1.0]], [0, [18377.14303091325, 1.0]], [0, [1236.835385184645, 1.0]], [0, [321.9394462971044, 1.0]], [0, [102.04366835227185, 1.0]], [0, [35.476665131991304, 1.0]], [0, [7.962460955261137, 1.0]], [0, [3.1460340023816857, 1.0]], [1, [8.60420718130082, 1.0]], [1, [0.4930447871464992, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3966716]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128432]
bas 3, expnt(s) = [294042.03558868]
bas 4, expnt(s) = [147021.0174515]
bas 5, expnt(s) = [73510.50675596]
bas 6, expnt(s) = [36755.22695558]
bas 7, expnt(s) = [7331.39215018]
bas 8, expnt(s) = [18377.14303091]
bas 9, expnt(s) = [1236.83538518]
bas 10, expnt(s) = [321.9394463]
bas 11, expnt(s) = [102.04366835]
bas 12, expnt(s) = [35.47666513]
bas 13, expnt(s) = [7.96246096]
bas 14, expnt(s) = [3.146034]
bas 15, expnt(s) = [8.60420718]
bas 16, expnt(s) = [0.49304479]
CPU time:      1096.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96671605e-01 1.26281101e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552270e+04 6.70663013e+03 7.33139215e+03 2.00172707e+03
 1.83771430e+04 3.98770957e+03 1.23683539e+03 5.26925178e+02
 3.21939446e+02 1.92019648e+02 1.02043668e+02 8.11156348e+01
 3.54766651e+01 3.67258720e+01 7.96246096e+00 1.19756891e+01
 3.14603400e+00 5.96812050e+00 8.60420718e+00 4.29905466e+01
 4.93044787e-01 1.20529223e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325123514563703
cond(S) = 12561.197904351184
E1 = -689.3559447982589  E_coul = 184.9177644922977
init E= -504.438180305961
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.674572103196267  LUMO = 8.8222406910032
  mo_energy =
[-1.21702281e+02 -1.33870093e+01 -7.62761428e+00 -7.62761428e+00
 -7.62761428e+00 -1.63994462e+00 -6.74572103e-01 -6.74572103e-01
 -6.74572103e-01  8.82224069e+00  9.86235407e+01  5.26030594e+02
  2.35420697e+03  1.15375395e+04  4.11219414e+04  1.09972167e+05
  2.54168964e+05  5.48596295e+05  1.15254149e+06  2.43032154e+06
  5.37505353e+06]
E1 = -707.0679503621427  E_coul = 199.1382258161193
cycle= 1 E= -507.929724546023  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593715
diis-c [-0.35249794  1.        ]
  HOMO = -0.232947775945024  LUMO = 9.72005794731463
  mo_energy =
[-1.20252069e+02 -1.23506215e+01 -6.64539631e+00 -6.64539631e+00
 -6.64539631e+00 -1.16119663e+00 -2.32947776e-01 -2.32947776e-01
 -2.32947776e-01  9.72005795e+00  9.99572812e+01  5.27466240e+02
  2.35558625e+03  1.15387963e+04  4.11231259e+04  1.09973312e+05
  2.54170082e+05  5.48597394e+05  1.15254258e+06  2.43032261e+06
  5.37505459e+06]
E1 = -706.7029584577427  E_coul = 198.76661762686663
cycle= 2 E= -507.936340830876  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155213
diis-c [-2.33535630e-04  4.55490741e-03  9.95445093e-01]
  HOMO = -0.237623091564356  LUMO = 9.70906440224783
  mo_energy =
[-1.20311116e+02 -1.23738653e+01 -6.67419313e+00 -6.67419313e+00
 -6.67419313e+00 -1.16359083e+00 -2.37623092e-01 -2.37623092e-01
 -2.37623092e-01  9.70906440e+00  9.99141988e+01  5.27405416e+02
  2.35551205e+03  1.15387126e+04  4.11230391e+04  1.09973224e+05
  2.54169993e+05  5.48597304e+05  1.15254249e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.6875032617666  E_coul = 198.75114929882662
cycle= 3 E= -507.93635396294  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0007564
diis-c [-1.62116359e-08  4.49458867e-05 -5.01609047e-02  1.05011596e+00]
  HOMO = -0.237864673251961  LUMO = 9.7085086227823
  mo_energy =
[-1.20313798e+02 -1.23750354e+01 -6.67561499e+00 -6.67561499e+00
 -6.67561499e+00 -1.16370952e+00 -2.37864673e-01 -2.37864673e-01
 -2.37864673e-01  9.70850862e+00  9.99121623e+01  5.27402710e+02
  2.35550894e+03  1.15387093e+04  4.11230356e+04  1.09973220e+05
  2.54169990e+05  5.48597301e+05  1.15254248e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.6867138295377  E_coul = 198.7503598324988
cycle= 4 E= -507.936353997039  delta_E= -3.41e-08  |g|= 7.34e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.28722e-06
diis-c [-5.50653129e-12 -1.97360362e-06  2.42441378e-03 -4.84500149e-02
  1.04602757e+00]
  HOMO = -0.237865712995846  LUMO = 9.70850733582684
  mo_energy =
[-1.20313797e+02 -1.23750390e+01 -6.67561779e+00 -6.67561779e+00
 -6.67561779e+00 -1.16371011e+00 -2.37865713e-01 -2.37865713e-01
 -2.37865713e-01  9.70850734e+00  9.99121611e+01  5.27402711e+02
  2.35550894e+03  1.15387093e+04  4.11230356e+04  1.09973220e+05
  2.54169990e+05  5.48597301e+05  1.15254248e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.6867119337325  E_coul = 198.75035793669147
cycle= 5 E= -507.936353997041  delta_E= -2.16e-12  |g|= 1.48e-07  |ddm|= 2.86e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6867119337325  E_coul = 198.75035793669147
  HOMO = -0.237865749018433  LUMO = 9.70850726487079
  mo_energy =
[-1.20313798e+02 -1.23750392e+01 -6.67561797e+00 -6.67561797e+00
 -6.67561797e+00 -1.16371013e+00 -2.37865749e-01 -2.37865749e-01
 -2.37865749e-01  9.70850726e+00  9.99121608e+01  5.27402711e+02
  2.35550894e+03  1.15387093e+04  4.11230356e+04  1.09973220e+05
  2.54169990e+05  5.48597301e+05  1.15254248e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.68671183418  E_coul = 198.7503578371387
Extra cycle  E= -507.936353997041  delta_E= -2.27e-13  |g|= 7.76e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      5.03 sec, wall time      0.40 sec
exp = [3.96671605e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552270e+04 7.33139215e+03
 1.83771430e+04 1.23683539e+03 3.21939446e+02 1.02043668e+02
 3.54766651e+01 7.96246096e+00 3.14603400e+00 8.60420718e+00
 4.93044787e-01]
E = -507.93635399704124
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396671604701       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.506756         1
[INPUT] 0    0    [1    /1   ]  36755.2269556        1
[INPUT] 0    0    [1    /1   ]  7331.39215018        1
[INPUT] 0    0    [1    /1   ]  18377.1430309        1
[INPUT] 0    0    [1    /1   ]  1236.83538518        1
[INPUT] 0    0    [1    /1   ]  321.939446297        1
[INPUT] 0    0    [1    /1   ]  102.043668352        1
[INPUT] 0    0    [1    /1   ]  35.476665132         1
[INPUT] 0    0    [1    /1   ]  7.96246095526        1
[INPUT] 0    0    [1    /1   ]  3.14603400238        1
[INPUT] 1    0    [1    /1   ]  8.6042071813         1
[INPUT] 1    0    [1    /1   ]  0.493044787146       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966716047009314, 1.0]], [0, [1176168.1426076198, 1.0]], [0, [588084.0712843224, 1.0]], [0, [294042.0355886838, 1.0]], [0, [147021.0174514963, 1.0]], [0, [73510.50675595611, 1.0]], [0, [36755.22695558376, 1.0]], [0, [7331.392150179298, 1.0]], [0, [18377.14303091325, 1.0]], [0, [1236.835385184645, 1.0]], [0, [321.9394462971044, 1.0]], [0, [102.04366835227185, 1.0]], [0, [35.476665131991304, 1.0]], [0, [7.962460955261137, 1.0]], [0, [3.1460340023816857, 1.0]], [1, [8.60420718130082, 1.0]], [1, [0.4930447871464992, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3966716]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128432]
bas 3, expnt(s) = [294042.03558868]
bas 4, expnt(s) = [147021.0174515]
bas 5, expnt(s) = [73510.50675596]
bas 6, expnt(s) = [36755.22695558]
bas 7, expnt(s) = [7331.39215018]
bas 8, expnt(s) = [18377.14303091]
bas 9, expnt(s) = [1236.83538518]
bas 10, expnt(s) = [321.9394463]
bas 11, expnt(s) = [102.04366835]
bas 12, expnt(s) = [35.47666513]
bas 13, expnt(s) = [7.96246096]
bas 14, expnt(s) = [3.146034]
bas 15, expnt(s) = [8.60420718]
bas 16, expnt(s) = [0.49304479]
CPU time:      1101.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96671605e-01 1.26281101e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552270e+04 6.70663013e+03 7.33139215e+03 2.00172707e+03
 1.83771430e+04 3.98770957e+03 1.23683539e+03 5.26925178e+02
 3.21939446e+02 1.92019648e+02 1.02043668e+02 8.11156348e+01
 3.54766651e+01 3.67258720e+01 7.96246096e+00 1.19756891e+01
 3.14603400e+00 5.96812050e+00 8.60420718e+00 4.29905466e+01
 4.93044787e-01 1.20529223e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325123514563703
cond(S) = 12561.197904351184
E1 = -689.3559447982589  E_coul = 184.9177644922977
init E= -504.438180305961
    CPU time for initialize scf      4.58 sec, wall time      0.34 sec
  HOMO = -0.674572103196267  LUMO = 8.8222406910032
  mo_energy =
[-1.21702281e+02 -1.33870093e+01 -7.62761428e+00 -7.62761428e+00
 -7.62761428e+00 -1.63994462e+00 -6.74572103e-01 -6.74572103e-01
 -6.74572103e-01  8.82224069e+00  9.86235407e+01  5.26030594e+02
  2.35420697e+03  1.15375395e+04  4.11219414e+04  1.09972167e+05
  2.54168964e+05  5.48596295e+05  1.15254149e+06  2.43032154e+06
  5.37505353e+06]
E1 = -707.0679503621427  E_coul = 199.1382258161193
cycle= 1 E= -507.929724546023  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593715
diis-c [-0.35249794  1.        ]
  HOMO = -0.232947775945024  LUMO = 9.72005794731463
  mo_energy =
[-1.20252069e+02 -1.23506215e+01 -6.64539631e+00 -6.64539631e+00
 -6.64539631e+00 -1.16119663e+00 -2.32947776e-01 -2.32947776e-01
 -2.32947776e-01  9.72005795e+00  9.99572812e+01  5.27466240e+02
  2.35558625e+03  1.15387963e+04  4.11231259e+04  1.09973312e+05
  2.54170082e+05  5.48597394e+05  1.15254258e+06  2.43032261e+06
  5.37505459e+06]
E1 = -706.7029584577427  E_coul = 198.76661762686663
cycle= 2 E= -507.936340830876  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155213
diis-c [-2.33535630e-04  4.55490741e-03  9.95445093e-01]
  HOMO = -0.237623091564356  LUMO = 9.70906440224783
  mo_energy =
[-1.20311116e+02 -1.23738653e+01 -6.67419313e+00 -6.67419313e+00
 -6.67419313e+00 -1.16359083e+00 -2.37623092e-01 -2.37623092e-01
 -2.37623092e-01  9.70906440e+00  9.99141988e+01  5.27405416e+02
  2.35551205e+03  1.15387126e+04  4.11230391e+04  1.09973224e+05
  2.54169993e+05  5.48597304e+05  1.15254249e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.6875032617666  E_coul = 198.75114929882662
cycle= 3 E= -507.93635396294  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0007564
diis-c [-1.62116359e-08  4.49458867e-05 -5.01609047e-02  1.05011596e+00]
  HOMO = -0.237864673251961  LUMO = 9.7085086227823
  mo_energy =
[-1.20313798e+02 -1.23750354e+01 -6.67561499e+00 -6.67561499e+00
 -6.67561499e+00 -1.16370952e+00 -2.37864673e-01 -2.37864673e-01
 -2.37864673e-01  9.70850862e+00  9.99121623e+01  5.27402710e+02
  2.35550894e+03  1.15387093e+04  4.11230356e+04  1.09973220e+05
  2.54169990e+05  5.48597301e+05  1.15254248e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.6867138295377  E_coul = 198.7503598324988
cycle= 4 E= -507.936353997039  delta_E= -3.41e-08  |g|= 7.34e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.28722e-06
diis-c [-5.50653129e-12 -1.97360362e-06  2.42441378e-03 -4.84500149e-02
  1.04602757e+00]
  HOMO = -0.237865712995846  LUMO = 9.70850733582684
  mo_energy =
[-1.20313797e+02 -1.23750390e+01 -6.67561779e+00 -6.67561779e+00
 -6.67561779e+00 -1.16371011e+00 -2.37865713e-01 -2.37865713e-01
 -2.37865713e-01  9.70850734e+00  9.99121611e+01  5.27402711e+02
  2.35550894e+03  1.15387093e+04  4.11230356e+04  1.09973220e+05
  2.54169990e+05  5.48597301e+05  1.15254248e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.6867119337325  E_coul = 198.75035793669147
cycle= 5 E= -507.936353997041  delta_E= -2.16e-12  |g|= 1.48e-07  |ddm|= 2.86e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6867119337325  E_coul = 198.75035793669147
  HOMO = -0.237865749018433  LUMO = 9.70850726487079
  mo_energy =
[-1.20313798e+02 -1.23750392e+01 -6.67561797e+00 -6.67561797e+00
 -6.67561797e+00 -1.16371013e+00 -2.37865749e-01 -2.37865749e-01
 -2.37865749e-01  9.70850726e+00  9.99121608e+01  5.27402711e+02
  2.35550894e+03  1.15387093e+04  4.11230356e+04  1.09973220e+05
  2.54169990e+05  5.48597301e+05  1.15254248e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.68671183418  E_coul = 198.7503578371387
Extra cycle  E= -507.936353997041  delta_E= -2.27e-13  |g|= 7.76e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      4.84 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.197904351184
E1 = -706.68671183418  E_coul = 198.7503578371387
init E= -507.936353997041
    CPU time for initialize scf      9.11 sec, wall time      0.70 sec
  HOMO = -0.237865750762709  LUMO = 9.70850726166394
  mo_energy =
[-1.20313798e+02 -1.23750392e+01 -6.67561798e+00 -6.67561798e+00
 -6.67561798e+00 -1.16371013e+00 -2.37865751e-01 -2.37865751e-01
 -2.37865751e-01  9.70850726e+00  9.99121608e+01  5.27402711e+02
  2.35550894e+03  1.15387093e+04  4.11230356e+04  1.09973220e+05
  2.54169990e+05  5.48597301e+05  1.15254248e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.6867118295299  E_coul = 198.750357832489
cycle= 1 E= -507.936353997041  delta_E= 2.84e-13  |g|= 9.32e-10  |ddm|= 3.98e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6867118295299  E_coul = 198.750357832489
  HOMO = -0.237865750850672  LUMO = 9.70850726295241
  mo_energy =
[-1.20313798e+02 -1.23750392e+01 -6.67561798e+00 -6.67561798e+00
 -6.67561798e+00 -1.16371013e+00 -2.37865751e-01 -2.37865751e-01
 -2.37865751e-01  9.70850726e+00  9.99121608e+01  5.27402711e+02
  2.35550894e+03  1.15387093e+04  4.11230356e+04  1.09973220e+05
  2.54169990e+05  5.48597301e+05  1.15254248e+06  2.43032252e+06
  5.37505450e+06]
E1 = -706.6867118293465  E_coul = 198.75035783230553
Extra cycle  E= -507.936353997041  delta_E= 5.68e-14  |g|= 9.28e-10  |ddm|= 1.92e-10
    CPU time for scf_cycle      9.32 sec, wall time      0.77 sec
exp = [3.96671605e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552270e+04 7.33139215e+03
 1.83771430e+04 1.23683539e+03 3.21939446e+02 1.02043668e+02
 3.54766651e+01 7.96246096e+00 3.14603400e+00 8.60420718e+00
 4.93044787e-01]
grad_E = [-1.75972093e-05 -4.03126582e-12  5.14179283e-10  1.77470004e-09
  1.00695165e-08  3.41591223e-08  2.01703813e-07  1.11094649e-05
  5.31197011e-07 -8.75318819e-05 -8.09942252e-06 -1.65946090e-09
  1.31496020e-06 -4.51681186e-07  6.17804105e-07 -1.36085199e-05
 -1.48286954e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396674089382       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.5067556        1
[INPUT] 0    0    [1    /1   ]  36755.2269531        1
[INPUT] 0    0    [1    /1   ]  7331.39201679        1
[INPUT] 0    0    [1    /1   ]  18377.143025         1
[INPUT] 0    0    [1    /1   ]  1236.83479933        1
[INPUT] 0    0    [1    /1   ]  321.947500499        1
[INPUT] 0    0    [1    /1   ]  102.04504924         1
[INPUT] 0    0    [1    /1   ]  35.4759927959        1
[INPUT] 0    0    [1    /1   ]  7.96210015116        1
[INPUT] 0    0    [1    /1   ]  3.1458698226         1
[INPUT] 1    0    [1    /1   ]  8.60424480629        1
[INPUT] 1    0    [1    /1   ]  0.493047266993       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39667408938155274, 1.0]], [0, [1176168.14260762, 1.0]], [0, [588084.0712843162, 1.0]], [0, [294042.03558866325, 1.0]], [0, [147021.01745137453, 1.0]], [0, [73510.50675555777, 1.0]], [0, [36755.226953138794, 1.0]], [0, [7331.392016791604, 1.0]], [0, [18377.14302495178, 1.0]], [0, [1236.8347993298541, 1.0]], [0, [321.9475004993357, 1.0]], [0, [102.04504924001866, 1.0]], [0, [35.47599279587892, 1.0]], [0, [7.9621001511564975, 1.0]], [0, [3.1458698226012403, 1.0]], [1, [8.604244806289081, 1.0]], [1, [0.49304726699256446, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39667409]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128432]
bas 3, expnt(s) = [294042.03558866]
bas 4, expnt(s) = [147021.01745137]
bas 5, expnt(s) = [73510.50675556]
bas 6, expnt(s) = [36755.22695314]
bas 7, expnt(s) = [7331.39201679]
bas 8, expnt(s) = [18377.14302495]
bas 9, expnt(s) = [1236.83479933]
bas 10, expnt(s) = [321.9475005]
bas 11, expnt(s) = [102.04504924]
bas 12, expnt(s) = [35.4759928]
bas 13, expnt(s) = [7.96210015]
bas 14, expnt(s) = [3.14586982]
bas 15, expnt(s) = [8.60424481]
bas 16, expnt(s) = [0.49304727]
CPU time:      1118.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96674089e-01 1.26281694e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552270e+04 6.70663013e+03 7.33139202e+03 2.00172704e+03
 1.83771430e+04 3.98770957e+03 1.23683480e+03 5.26924990e+02
 3.21947500e+02 1.92023251e+02 1.02045049e+02 8.11164580e+01
 3.54759928e+01 3.67253499e+01 7.96210015e+00 1.19752821e+01
 3.14586982e+00 5.96788691e+00 8.60424481e+00 4.29907816e+01
 4.93047267e-01 1.20529981e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32511992994516
cond(S) = 12561.20290943179
E1 = -689.3562211481533  E_coul = 184.9180316132015
init E= -504.438189534952
    CPU time for initialize scf      4.29 sec, wall time      0.34 sec
  HOMO = -0.674568913219881  LUMO = 8.82146265475272
  mo_energy =
[-1.21702237e+02 -1.33869884e+01 -7.62759608e+00 -7.62759608e+00
 -7.62759608e+00 -1.63994122e+00 -6.74568913e-01 -6.74568913e-01
 -6.74568913e-01  8.82146265e+00  9.86207684e+01  5.26035382e+02
  2.35422969e+03  1.15375670e+04  4.11219675e+04  1.09972192e+05
  2.54168988e+05  5.48596319e+05  1.15254152e+06  2.43032156e+06
  5.37505355e+06]
E1 = -707.0682935902915  E_coul = 199.13856962466664
cycle= 1 E= -507.929723965625  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593716
diis-c [-0.35249817  1.        ]
  HOMO = -0.232941044565445  LUMO = 9.71926298769671
  mo_energy =
[-1.20252020e+02 -1.23505955e+01 -6.64537284e+00 -6.64537284e+00
 -6.64537284e+00 -1.16119019e+00 -2.32941045e-01 -2.32941045e-01
 -2.32941045e-01  9.71926299e+00  9.99545124e+01  5.27471032e+02
  2.35560898e+03  1.15388237e+04  4.11231520e+04  1.09973337e+05
  2.54170106e+05  5.48597417e+05  1.15254260e+06  2.43032264e+06
  5.37505462e+06]
E1 = -706.7032732921114  E_coul = 198.7669324499717
cycle= 2 E= -507.93634084214  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155217
diis-c [-2.33549025e-04  4.55494283e-03  9.95445057e-01]
  HOMO = -0.237616907959651  LUMO = 9.70826901866282
  mo_energy =
[-1.20311071e+02 -1.23738413e+01 -6.67417199e+00 -6.67417199e+00
 -6.67417199e+00 -1.16358469e+00 -2.37616908e-01 -2.37616908e-01
 -2.37616908e-01  9.70826902e+00  9.99114273e+01  5.27410205e+02
  2.35553477e+03  1.15387401e+04  4.11230652e+04  1.09973249e+05
  2.54170017e+05  5.48597328e+05  1.15254251e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.6878162026611  E_coul = 198.75146222599668
cycle= 3 E= -507.936353976664  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756437
diis-c [-1.62192959e-08  4.49537089e-05 -5.01617282e-02  1.05011677e+00]
  HOMO = -0.237858529534563  LUMO = 9.70771318979715
  mo_energy =
[-1.20313753e+02 -1.23750115e+01 -6.67559402e+00 -6.67559402e+00
 -6.67559402e+00 -1.16370341e+00 -2.37858530e-01 -2.37858530e-01
 -2.37858530e-01  9.70771319e+00  9.99093905e+01  5.27407499e+02
  2.35553166e+03  1.15387367e+04  4.11230618e+04  1.09973246e+05
  2.54170014e+05  5.48597324e+05  1.15254251e+06  2.43032254e+06
  5.37505452e+06]
E1 = -706.6870266371848  E_coul = 198.7506726264116
cycle= 4 E= -507.936354010773  delta_E= -3.41e-08  |g|= 7.35e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.28889e-06
diis-c [-5.50071694e-12 -1.97765574e-06  2.42491485e-03 -4.84606742e-02
  1.04603774e+00]
  HOMO = -0.237859569948887  LUMO = 9.70771190315816
  mo_energy =
[-1.20313752e+02 -1.23750152e+01 -6.67559683e+00 -6.67559683e+00
 -6.67559683e+00 -1.16370400e+00 -2.37859570e-01 -2.37859570e-01
 -2.37859570e-01  9.70771190e+00  9.99093893e+01  5.27407500e+02
  2.35553167e+03  1.15387367e+04  4.11230618e+04  1.09973246e+05
  2.54170014e+05  5.48597324e+05  1.15254251e+06  2.43032254e+06
  5.37505452e+06]
E1 = -706.6870247397575  E_coul = 198.75067072898233
cycle= 5 E= -507.936354010775  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.86e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6870247397575  E_coul = 198.75067072898233
  HOMO = -0.237859605948363  LUMO = 9.70771183450873
  mo_energy =
[-1.20313752e+02 -1.23750153e+01 -6.67559701e+00 -6.67559701e+00
 -6.67559701e+00 -1.16370402e+00 -2.37859606e-01 -2.37859606e-01
 -2.37859606e-01  9.70771183e+00  9.99093891e+01  5.27407499e+02
  2.35553166e+03  1.15387367e+04  4.11230618e+04  1.09973246e+05
  2.54170014e+05  5.48597324e+05  1.15254251e+06  2.43032254e+06
  5.37505452e+06]
E1 = -706.6870246402067  E_coul = 198.7506706294316
Extra cycle  E= -507.936354010775  delta_E= 1.14e-13  |g|= 7.8e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      4.55 sec, wall time      0.41 sec
exp = [3.96674089e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552270e+04 7.33139202e+03
 1.83771430e+04 1.23683480e+03 3.21947500e+02 1.02045049e+02
 3.54759928e+01 7.96210015e+00 3.14586982e+00 8.60424481e+00
 4.93047267e-01]
E = -507.93635401077506
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396674089382       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.5067556        1
[INPUT] 0    0    [1    /1   ]  36755.2269531        1
[INPUT] 0    0    [1    /1   ]  7331.39201679        1
[INPUT] 0    0    [1    /1   ]  18377.143025         1
[INPUT] 0    0    [1    /1   ]  1236.83479933        1
[INPUT] 0    0    [1    /1   ]  321.947500499        1
[INPUT] 0    0    [1    /1   ]  102.04504924         1
[INPUT] 0    0    [1    /1   ]  35.4759927959        1
[INPUT] 0    0    [1    /1   ]  7.96210015116        1
[INPUT] 0    0    [1    /1   ]  3.1458698226         1
[INPUT] 1    0    [1    /1   ]  8.60424480629        1
[INPUT] 1    0    [1    /1   ]  0.493047266993       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39667408938155274, 1.0]], [0, [1176168.14260762, 1.0]], [0, [588084.0712843162, 1.0]], [0, [294042.03558866325, 1.0]], [0, [147021.01745137453, 1.0]], [0, [73510.50675555777, 1.0]], [0, [36755.226953138794, 1.0]], [0, [7331.392016791604, 1.0]], [0, [18377.14302495178, 1.0]], [0, [1236.8347993298541, 1.0]], [0, [321.9475004993357, 1.0]], [0, [102.04504924001866, 1.0]], [0, [35.47599279587892, 1.0]], [0, [7.9621001511564975, 1.0]], [0, [3.1458698226012403, 1.0]], [1, [8.604244806289081, 1.0]], [1, [0.49304726699256446, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39667409]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128432]
bas 3, expnt(s) = [294042.03558866]
bas 4, expnt(s) = [147021.01745137]
bas 5, expnt(s) = [73510.50675556]
bas 6, expnt(s) = [36755.22695314]
bas 7, expnt(s) = [7331.39201679]
bas 8, expnt(s) = [18377.14302495]
bas 9, expnt(s) = [1236.83479933]
bas 10, expnt(s) = [321.9475005]
bas 11, expnt(s) = [102.04504924]
bas 12, expnt(s) = [35.4759928]
bas 13, expnt(s) = [7.96210015]
bas 14, expnt(s) = [3.14586982]
bas 15, expnt(s) = [8.60424481]
bas 16, expnt(s) = [0.49304727]
CPU time:      1123.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96674089e-01 1.26281694e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552270e+04 6.70663013e+03 7.33139202e+03 2.00172704e+03
 1.83771430e+04 3.98770957e+03 1.23683480e+03 5.26924990e+02
 3.21947500e+02 1.92023251e+02 1.02045049e+02 8.11164580e+01
 3.54759928e+01 3.67253499e+01 7.96210015e+00 1.19752821e+01
 3.14586982e+00 5.96788691e+00 8.60424481e+00 4.29907816e+01
 4.93047267e-01 1.20529981e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32511992994516
cond(S) = 12561.20290943179
E1 = -689.3562211481533  E_coul = 184.9180316132015
init E= -504.438189534952
    CPU time for initialize scf      4.80 sec, wall time      0.34 sec
  HOMO = -0.674568913219881  LUMO = 8.82146265475272
  mo_energy =
[-1.21702237e+02 -1.33869884e+01 -7.62759608e+00 -7.62759608e+00
 -7.62759608e+00 -1.63994122e+00 -6.74568913e-01 -6.74568913e-01
 -6.74568913e-01  8.82146265e+00  9.86207684e+01  5.26035382e+02
  2.35422969e+03  1.15375670e+04  4.11219675e+04  1.09972192e+05
  2.54168988e+05  5.48596319e+05  1.15254152e+06  2.43032156e+06
  5.37505355e+06]
E1 = -707.0682935902915  E_coul = 199.13856962466664
cycle= 1 E= -507.929723965625  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593716
diis-c [-0.35249817  1.        ]
  HOMO = -0.232941044565445  LUMO = 9.71926298769671
  mo_energy =
[-1.20252020e+02 -1.23505955e+01 -6.64537284e+00 -6.64537284e+00
 -6.64537284e+00 -1.16119019e+00 -2.32941045e-01 -2.32941045e-01
 -2.32941045e-01  9.71926299e+00  9.99545124e+01  5.27471032e+02
  2.35560898e+03  1.15388237e+04  4.11231520e+04  1.09973337e+05
  2.54170106e+05  5.48597417e+05  1.15254260e+06  2.43032264e+06
  5.37505462e+06]
E1 = -706.7032732921114  E_coul = 198.7669324499717
cycle= 2 E= -507.93634084214  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155217
diis-c [-2.33549025e-04  4.55494283e-03  9.95445057e-01]
  HOMO = -0.237616907959651  LUMO = 9.70826901866282
  mo_energy =
[-1.20311071e+02 -1.23738413e+01 -6.67417199e+00 -6.67417199e+00
 -6.67417199e+00 -1.16358469e+00 -2.37616908e-01 -2.37616908e-01
 -2.37616908e-01  9.70826902e+00  9.99114273e+01  5.27410205e+02
  2.35553477e+03  1.15387401e+04  4.11230652e+04  1.09973249e+05
  2.54170017e+05  5.48597328e+05  1.15254251e+06  2.43032255e+06
  5.37505453e+06]
E1 = -706.6878162026611  E_coul = 198.75146222599668
cycle= 3 E= -507.936353976664  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756437
diis-c [-1.62192959e-08  4.49537089e-05 -5.01617282e-02  1.05011677e+00]
  HOMO = -0.237858529534563  LUMO = 9.70771318979715
  mo_energy =
[-1.20313753e+02 -1.23750115e+01 -6.67559402e+00 -6.67559402e+00
 -6.67559402e+00 -1.16370341e+00 -2.37858530e-01 -2.37858530e-01
 -2.37858530e-01  9.70771319e+00  9.99093905e+01  5.27407499e+02
  2.35553166e+03  1.15387367e+04  4.11230618e+04  1.09973246e+05
  2.54170014e+05  5.48597324e+05  1.15254251e+06  2.43032254e+06
  5.37505452e+06]
E1 = -706.6870266371848  E_coul = 198.7506726264116
cycle= 4 E= -507.936354010773  delta_E= -3.41e-08  |g|= 7.35e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.28889e-06
diis-c [-5.50071694e-12 -1.97765574e-06  2.42491485e-03 -4.84606742e-02
  1.04603774e+00]
  HOMO = -0.237859569948887  LUMO = 9.70771190315816
  mo_energy =
[-1.20313752e+02 -1.23750152e+01 -6.67559683e+00 -6.67559683e+00
 -6.67559683e+00 -1.16370400e+00 -2.37859570e-01 -2.37859570e-01
 -2.37859570e-01  9.70771190e+00  9.99093893e+01  5.27407500e+02
  2.35553167e+03  1.15387367e+04  4.11230618e+04  1.09973246e+05
  2.54170014e+05  5.48597324e+05  1.15254251e+06  2.43032254e+06
  5.37505452e+06]
E1 = -706.6870247397575  E_coul = 198.75067072898233
cycle= 5 E= -507.936354010775  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.86e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6870247397575  E_coul = 198.75067072898233
  HOMO = -0.237859605948363  LUMO = 9.70771183450873
  mo_energy =
[-1.20313752e+02 -1.23750153e+01 -6.67559701e+00 -6.67559701e+00
 -6.67559701e+00 -1.16370402e+00 -2.37859606e-01 -2.37859606e-01
 -2.37859606e-01  9.70771183e+00  9.99093891e+01  5.27407499e+02
  2.35553166e+03  1.15387367e+04  4.11230618e+04  1.09973246e+05
  2.54170014e+05  5.48597324e+05  1.15254251e+06  2.43032254e+06
  5.37505452e+06]
E1 = -706.6870246402067  E_coul = 198.7506706294316
Extra cycle  E= -507.936354010775  delta_E= 1.14e-13  |g|= 7.8e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      5.06 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.20290943179
E1 = -706.6870246402067  E_coul = 198.7506706294316
init E= -507.936354010775
    CPU time for initialize scf      9.97 sec, wall time      0.67 sec
  HOMO = -0.237859607691967  LUMO = 9.7077118289526
  mo_energy =
[-1.20313752e+02 -1.23750153e+01 -6.67559701e+00 -6.67559701e+00
 -6.67559701e+00 -1.16370402e+00 -2.37859608e-01 -2.37859608e-01
 -2.37859608e-01  9.70771183e+00  9.99093891e+01  5.27407499e+02
  2.35553166e+03  1.15387367e+04  4.11230618e+04  1.09973246e+05
  2.54170014e+05  5.48597324e+05  1.15254251e+06  2.43032254e+06
  5.37505452e+06]
E1 = -706.6870246356201  E_coul = 198.7506706248449
cycle= 1 E= -507.936354010775  delta_E= -1.14e-13  |g|= 9.6e-10  |ddm|= 3.95e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6870246356201  E_coul = 198.7506706248449
  HOMO = -0.237859607779138  LUMO = 9.70771182826443
  mo_energy =
[-1.20313752e+02 -1.23750153e+01 -6.67559701e+00 -6.67559701e+00
 -6.67559701e+00 -1.16370402e+00 -2.37859608e-01 -2.37859608e-01
 -2.37859608e-01  9.70771183e+00  9.99093891e+01  5.27407499e+02
  2.35553166e+03  1.15387367e+04  4.11230618e+04  1.09973246e+05
  2.54170014e+05  5.48597324e+05  1.15254251e+06  2.43032254e+06
  5.37505452e+06]
E1 = -706.6870246352794  E_coul = 198.7506706245042
Extra cycle  E= -507.936354010775  delta_E=    0  |g|= 8.48e-10  |ddm|= 2.52e-10
    CPU time for scf_cycle     10.16 sec, wall time      0.74 sec
exp = [3.96674089e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552270e+04 7.33139202e+03
 1.83771430e+04 1.23683480e+03 3.21947500e+02 1.02045049e+02
 3.54759928e+01 7.96210015e+00 3.14586982e+00 8.60424481e+00
 4.93047267e-01]
grad_E = [ 1.59569965e-05 -4.02373281e-12  5.14226776e-10  1.77488406e-09
  1.00704171e-08  3.41625980e-08  2.01721666e-07  1.11104531e-05
  5.31257871e-07 -8.75756830e-05 -7.94699857e-06  6.64608233e-07
 -1.35269546e-06  5.71580800e-08 -6.52619231e-06  1.47904086e-05
  3.99020181e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396677602398       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.5067545        1
[INPUT] 0    0    [1    /1   ]  36755.2269465        1
[INPUT] 0    0    [1    /1   ]  7331.39165206        1
[INPUT] 0    0    [1    /1   ]  18377.1430086        1
[INPUT] 0    0    [1    /1   ]  1236.83338309        1
[INPUT] 0    0    [1    /1   ]  321.968388152        1
[INPUT] 0    0    [1    /1   ]  102.049310671        1
[INPUT] 0    0    [1    /1   ]  35.4753894371        1
[INPUT] 0    0    [1    /1   ]  7.96174868793        1
[INPUT] 0    0    [1    /1   ]  3.14567754241        1
[INPUT] 1    0    [1    /1   ]  8.60429551182        1
[INPUT] 1    0    [1    /1   ]  0.493050294488       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966776023980625, 1.0]], [0, [1176168.142607621, 1.0]], [0, [588084.0712842994, 1.0]], [0, [294042.03558860696, 1.0]], [0, [147021.01745104167, 1.0]], [0, [73510.50675446741, 1.0]], [0, [36755.22694645633, 1.0]], [0, [7331.391652064001, 1.0]], [0, [18377.143008608466, 1.0]], [0, [1236.8333830889146, 1.0]], [0, [321.96838815154746, 1.0]], [0, [102.04931067059331, 1.0]], [0, [35.475389437101875, 1.0]], [0, [7.96174868793448, 1.0]], [0, [3.145677542410513, 1.0]], [1, [8.604295511822453, 1.0]], [1, [0.4930502944877197, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3966776]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.0712843]
bas 3, expnt(s) = [294042.03558861]
bas 4, expnt(s) = [147021.01745104]
bas 5, expnt(s) = [73510.50675447]
bas 6, expnt(s) = [36755.22694646]
bas 7, expnt(s) = [7331.39165206]
bas 8, expnt(s) = [18377.14300861]
bas 9, expnt(s) = [1236.83338309]
bas 10, expnt(s) = [321.96838815]
bas 11, expnt(s) = [102.04931067]
bas 12, expnt(s) = [35.47538944]
bas 13, expnt(s) = [7.96174869]
bas 14, expnt(s) = [3.14567754]
bas 15, expnt(s) = [8.60429551]
bas 16, expnt(s) = [0.49305029]
CPU time:      1141.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96677602e-01 1.26282533e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552269e+04 6.70663013e+03 7.33139165e+03 2.00172697e+03
 1.83771430e+04 3.98770957e+03 1.23683338e+03 5.26924538e+02
 3.21968388e+02 1.92032594e+02 1.02049311e+02 8.11189986e+01
 3.54753894e+01 3.67248815e+01 7.96174869e+00 1.19748856e+01
 3.14567754e+00 5.96761333e+00 8.60429551e+00 4.29910982e+01
 4.93050294e-01 1.20530906e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325115461861138
cond(S) = 12561.218791454734
E1 = -689.3565545754574  E_coul = 184.91838018792475
init E= -504.438174387533
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.674565029506403  LUMO = 8.82063255869344
  mo_energy =
[-1.21702178e+02 -1.33869611e+01 -7.62757228e+00 -7.62757228e+00
 -7.62757228e+00 -1.63993683e+00 -6.74565030e-01 -6.74565030e-01
 -6.74565030e-01  8.82063256e+00  9.86191976e+01  5.26056741e+02
  2.35429812e+03  1.15376468e+04  4.11220433e+04  1.09972264e+05
  2.54169058e+05  5.48596387e+05  1.15254158e+06  2.43032163e+06
  5.37505361e+06]
E1 = -707.0687329770967  E_coul = 199.13900964355614
cycle= 1 E= -507.929723333541  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593715
diis-c [-0.35249806  1.        ]
  HOMO = -0.232932791097591  LUMO = 9.71841579581332
  mo_energy =
[-1.20251956e+02 -1.23505621e+01 -6.64534280e+00 -6.64534280e+00
 -6.64534280e+00 -1.16118207e+00 -2.32932791e-01 -2.32932791e-01
 -2.32932791e-01  9.71841580e+00  9.99529483e+01  5.27492396e+02
  2.35567740e+03  1.15389035e+04  4.11232278e+04  1.09973410e+05
  2.54170176e+05  5.48597485e+05  1.15254267e+06  2.43032270e+06
  5.37505468e+06]
E1 = -706.7036811350303  E_coul = 198.76734026529488
cycle= 2 E= -507.936340869735  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155223
diis-c [-2.33566070e-04  4.55492594e-03  9.95445074e-01]
  HOMO = -0.237609255451598  LUMO = 9.70742132512556
  mo_energy =
[-1.20311011e+02 -1.23738102e+01 -6.67414455e+00 -6.67414455e+00
 -6.67414455e+00 -1.16357690e+00 -2.37609255e-01 -2.37609255e-01
 -2.37609255e-01  9.70742133e+00  9.99098599e+01  5.27431564e+02
  2.35560319e+03  1.15388199e+04  4.11231410e+04  1.09973322e+05
  2.54170088e+05  5.48597396e+05  1.15254258e+06  2.43032261e+06
  5.37505459e+06]
E1 = -706.6882219897673  E_coul = 198.7518679828586
cycle= 3 E= -507.936354006909  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756481
diis-c [-1.62276191e-08  4.49638752e-05 -5.01625884e-02  1.05011762e+00]
  HOMO = -0.237850919915763  LUMO = 9.70686544446608
  mo_energy =
[-1.20313693e+02 -1.23749805e+01 -6.67556677e+00 -6.67556677e+00
 -6.67556677e+00 -1.16369564e+00 -2.37850920e-01 -2.37850920e-01
 -2.37850920e-01  9.70686544e+00  9.99078229e+01  5.27428858e+02
  2.35560009e+03  1.15388165e+04  4.11231376e+04  1.09973318e+05
  2.54170084e+05  5.48597393e+05  1.15254257e+06  2.43032261e+06
  5.37505458e+06]
E1 = -706.6874322821461  E_coul = 198.75107824111825
cycle= 4 E= -507.936354041028  delta_E= -3.41e-08  |g|= 7.35e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.29089e-06
diis-c [-5.50649066e-12 -1.97517551e-06  2.42511870e-03 -4.84645338e-02
  1.04604139e+00]
  HOMO = -0.237851960992067  LUMO = 9.70686415593423
  mo_energy =
[-1.20313693e+02 -1.23749842e+01 -6.67556957e+00 -6.67556957e+00
 -6.67556957e+00 -1.16369623e+00 -2.37851961e-01 -2.37851961e-01
 -2.37851961e-01  9.70686416e+00  9.99078217e+01  5.27428859e+02
  2.35560009e+03  1.15388165e+04  4.11231376e+04  1.09973318e+05
  2.54170084e+05  5.48597393e+05  1.15254257e+06  2.43032261e+06
  5.37505458e+06]
E1 = -706.6874303828494  E_coul = 198.75107634181944
cycle= 5 E= -507.93635404103  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.86e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6874303828494  E_coul = 198.75107634181944
  HOMO = -0.23785199701308  LUMO = 9.70686408390901
  mo_energy =
[-1.20313693e+02 -1.23749843e+01 -6.67556975e+00 -6.67556975e+00
 -6.67556975e+00 -1.16369625e+00 -2.37851997e-01 -2.37851997e-01
 -2.37851997e-01  9.70686408e+00  9.99078215e+01  5.27428858e+02
  2.35560009e+03  1.15388165e+04  4.11231376e+04  1.09973318e+05
  2.54170084e+05  5.48597393e+05  1.15254257e+06  2.43032261e+06
  5.37505458e+06]
E1 = -706.6874302833342  E_coul = 198.7510762423043
Extra cycle  E= -507.93635404103  delta_E= 5.68e-14  |g|= 7.91e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      5.00 sec, wall time      0.41 sec
exp = [3.96677602e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552269e+04 7.33139165e+03
 1.83771430e+04 1.23683338e+03 3.21968388e+02 1.02049311e+02
 3.54753894e+01 7.96174869e+00 3.14567754e+00 8.60429551e+00
 4.93050294e-01]
E = -507.93635404102986
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396677602398       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.5067545        1
[INPUT] 0    0    [1    /1   ]  36755.2269465        1
[INPUT] 0    0    [1    /1   ]  7331.39165206        1
[INPUT] 0    0    [1    /1   ]  18377.1430086        1
[INPUT] 0    0    [1    /1   ]  1236.83338309        1
[INPUT] 0    0    [1    /1   ]  321.968388152        1
[INPUT] 0    0    [1    /1   ]  102.049310671        1
[INPUT] 0    0    [1    /1   ]  35.4753894371        1
[INPUT] 0    0    [1    /1   ]  7.96174868793        1
[INPUT] 0    0    [1    /1   ]  3.14567754241        1
[INPUT] 1    0    [1    /1   ]  8.60429551182        1
[INPUT] 1    0    [1    /1   ]  0.493050294488       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966776023980625, 1.0]], [0, [1176168.142607621, 1.0]], [0, [588084.0712842994, 1.0]], [0, [294042.03558860696, 1.0]], [0, [147021.01745104167, 1.0]], [0, [73510.50675446741, 1.0]], [0, [36755.22694645633, 1.0]], [0, [7331.391652064001, 1.0]], [0, [18377.143008608466, 1.0]], [0, [1236.8333830889146, 1.0]], [0, [321.96838815154746, 1.0]], [0, [102.04931067059331, 1.0]], [0, [35.475389437101875, 1.0]], [0, [7.96174868793448, 1.0]], [0, [3.145677542410513, 1.0]], [1, [8.604295511822453, 1.0]], [1, [0.4930502944877197, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.3966776]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.0712843]
bas 3, expnt(s) = [294042.03558861]
bas 4, expnt(s) = [147021.01745104]
bas 5, expnt(s) = [73510.50675447]
bas 6, expnt(s) = [36755.22694646]
bas 7, expnt(s) = [7331.39165206]
bas 8, expnt(s) = [18377.14300861]
bas 9, expnt(s) = [1236.83338309]
bas 10, expnt(s) = [321.96838815]
bas 11, expnt(s) = [102.04931067]
bas 12, expnt(s) = [35.47538944]
bas 13, expnt(s) = [7.96174869]
bas 14, expnt(s) = [3.14567754]
bas 15, expnt(s) = [8.60429551]
bas 16, expnt(s) = [0.49305029]
CPU time:      1146.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96677602e-01 1.26282533e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552269e+04 6.70663013e+03 7.33139165e+03 2.00172697e+03
 1.83771430e+04 3.98770957e+03 1.23683338e+03 5.26924538e+02
 3.21968388e+02 1.92032594e+02 1.02049311e+02 8.11189986e+01
 3.54753894e+01 3.67248815e+01 7.96174869e+00 1.19748856e+01
 3.14567754e+00 5.96761333e+00 8.60429551e+00 4.29910982e+01
 4.93050294e-01 1.20530906e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325115461861138
cond(S) = 12561.218791454734
E1 = -689.3565545754574  E_coul = 184.91838018792475
init E= -504.438174387533
    CPU time for initialize scf      4.75 sec, wall time      0.33 sec
  HOMO = -0.674565029506403  LUMO = 8.82063255869344
  mo_energy =
[-1.21702178e+02 -1.33869611e+01 -7.62757228e+00 -7.62757228e+00
 -7.62757228e+00 -1.63993683e+00 -6.74565030e-01 -6.74565030e-01
 -6.74565030e-01  8.82063256e+00  9.86191976e+01  5.26056741e+02
  2.35429812e+03  1.15376468e+04  4.11220433e+04  1.09972264e+05
  2.54169058e+05  5.48596387e+05  1.15254158e+06  2.43032163e+06
  5.37505361e+06]
E1 = -707.0687329770967  E_coul = 199.13900964355614
cycle= 1 E= -507.929723333541  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593715
diis-c [-0.35249806  1.        ]
  HOMO = -0.232932791097591  LUMO = 9.71841579581332
  mo_energy =
[-1.20251956e+02 -1.23505621e+01 -6.64534280e+00 -6.64534280e+00
 -6.64534280e+00 -1.16118207e+00 -2.32932791e-01 -2.32932791e-01
 -2.32932791e-01  9.71841580e+00  9.99529483e+01  5.27492396e+02
  2.35567740e+03  1.15389035e+04  4.11232278e+04  1.09973410e+05
  2.54170176e+05  5.48597485e+05  1.15254267e+06  2.43032270e+06
  5.37505468e+06]
E1 = -706.7036811350303  E_coul = 198.76734026529488
cycle= 2 E= -507.936340869735  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155223
diis-c [-2.33566070e-04  4.55492594e-03  9.95445074e-01]
  HOMO = -0.237609255451598  LUMO = 9.70742132512556
  mo_energy =
[-1.20311011e+02 -1.23738102e+01 -6.67414455e+00 -6.67414455e+00
 -6.67414455e+00 -1.16357690e+00 -2.37609255e-01 -2.37609255e-01
 -2.37609255e-01  9.70742133e+00  9.99098599e+01  5.27431564e+02
  2.35560319e+03  1.15388199e+04  4.11231410e+04  1.09973322e+05
  2.54170088e+05  5.48597396e+05  1.15254258e+06  2.43032261e+06
  5.37505459e+06]
E1 = -706.6882219897673  E_coul = 198.7518679828586
cycle= 3 E= -507.936354006909  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756481
diis-c [-1.62276191e-08  4.49638752e-05 -5.01625884e-02  1.05011762e+00]
  HOMO = -0.237850919915763  LUMO = 9.70686544446608
  mo_energy =
[-1.20313693e+02 -1.23749805e+01 -6.67556677e+00 -6.67556677e+00
 -6.67556677e+00 -1.16369564e+00 -2.37850920e-01 -2.37850920e-01
 -2.37850920e-01  9.70686544e+00  9.99078229e+01  5.27428858e+02
  2.35560009e+03  1.15388165e+04  4.11231376e+04  1.09973318e+05
  2.54170084e+05  5.48597393e+05  1.15254257e+06  2.43032261e+06
  5.37505458e+06]
E1 = -706.6874322821461  E_coul = 198.75107824111825
cycle= 4 E= -507.936354041028  delta_E= -3.41e-08  |g|= 7.35e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.29089e-06
diis-c [-5.50649066e-12 -1.97517551e-06  2.42511870e-03 -4.84645338e-02
  1.04604139e+00]
  HOMO = -0.237851960992067  LUMO = 9.70686415593423
  mo_energy =
[-1.20313693e+02 -1.23749842e+01 -6.67556957e+00 -6.67556957e+00
 -6.67556957e+00 -1.16369623e+00 -2.37851961e-01 -2.37851961e-01
 -2.37851961e-01  9.70686416e+00  9.99078217e+01  5.27428859e+02
  2.35560009e+03  1.15388165e+04  4.11231376e+04  1.09973318e+05
  2.54170084e+05  5.48597393e+05  1.15254257e+06  2.43032261e+06
  5.37505458e+06]
E1 = -706.6874303828494  E_coul = 198.75107634181944
cycle= 5 E= -507.93635404103  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.86e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6874303828494  E_coul = 198.75107634181944
  HOMO = -0.23785199701308  LUMO = 9.70686408390901
  mo_energy =
[-1.20313693e+02 -1.23749843e+01 -6.67556975e+00 -6.67556975e+00
 -6.67556975e+00 -1.16369625e+00 -2.37851997e-01 -2.37851997e-01
 -2.37851997e-01  9.70686408e+00  9.99078215e+01  5.27428858e+02
  2.35560009e+03  1.15388165e+04  4.11231376e+04  1.09973318e+05
  2.54170084e+05  5.48597393e+05  1.15254257e+06  2.43032261e+06
  5.37505458e+06]
E1 = -706.6874302833342  E_coul = 198.7510762423043
Extra cycle  E= -507.93635404103  delta_E= 5.68e-14  |g|= 7.91e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      4.96 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.218791454734
E1 = -706.6874302833342  E_coul = 198.7510762423043
init E= -507.93635404103
    CPU time for initialize scf     10.22 sec, wall time      0.69 sec
  HOMO = -0.237851998757265  LUMO = 9.70686408128121
  mo_energy =
[-1.20313693e+02 -1.23749844e+01 -6.67556976e+00 -6.67556976e+00
 -6.67556976e+00 -1.16369625e+00 -2.37851999e-01 -2.37851999e-01
 -2.37851999e-01  9.70686408e+00  9.99078215e+01  5.27428858e+02
  2.35560009e+03  1.15388165e+04  4.11231376e+04  1.09973318e+05
  2.54170084e+05  5.48597393e+05  1.15254257e+06  2.43032261e+06
  5.37505458e+06]
E1 = -706.687430278629  E_coul = 198.75107623759948
cycle= 1 E= -507.93635404103  delta_E= 3.41e-13  |g|= 1.17e-09  |ddm|= 3.99e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.687430278629  E_coul = 198.75107623759948
  HOMO = -0.237851998845521  LUMO = 9.70686408259856
  mo_energy =
[-1.20313693e+02 -1.23749844e+01 -6.67556976e+00 -6.67556976e+00
 -6.67556976e+00 -1.16369625e+00 -2.37851999e-01 -2.37851999e-01
 -2.37851999e-01  9.70686408e+00  9.99078215e+01  5.27428858e+02
  2.35560009e+03  1.15388165e+04  4.11231376e+04  1.09973318e+05
  2.54170084e+05  5.48597393e+05  1.15254257e+06  2.43032261e+06
  5.37505458e+06]
E1 = -706.6874302784466  E_coul = 198.75107623741712
Extra cycle  E= -507.93635404103  delta_E=    0  |g|= 6.63e-10  |ddm|= 1.8e-10
    CPU time for scf_cycle     10.30 sec, wall time      0.77 sec
exp = [3.96677602e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552269e+04 7.33139165e+03
 1.83771430e+04 1.23683338e+03 3.21968388e+02 1.02049311e+02
 3.54753894e+01 7.96174869e+00 3.14567754e+00 8.60429551e+00
 4.93050294e-01]
grad_E = [ 6.13109045e-05 -4.00297747e-12  5.14357820e-10  1.77539171e-09
  1.00729021e-08  3.41721868e-08  2.01770937e-07  1.11131877e-05
  5.31425749e-07 -8.77010441e-05 -7.37991391e-06  1.09692016e-06
 -4.91299017e-06  1.91596030e-06 -1.83019565e-05  5.33889522e-05
  1.01946501e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396680482596       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.5067531        1
[INPUT] 0    0    [1    /1   ]  36755.2269379        1
[INPUT] 0    0    [1    /1   ]  7331.39118466        1
[INPUT] 0    0    [1    /1   ]  18377.1429875        1
[INPUT] 0    0    [1    /1   ]  1236.83210877        1
[INPUT] 0    0    [1    /1   ]  321.992506489        1
[INPUT] 0    0    [1    /1   ]  102.054349315        1
[INPUT] 0    0    [1    /1   ]  35.4750319318        1
[INPUT] 0    0    [1    /1   ]  7.96152931727        1
[INPUT] 0    0    [1    /1   ]  3.14554580187        1
[INPUT] 1    0    [1    /1   ]  8.60433645365        1
[INPUT] 1    0    [1    /1   ]  0.493052709272       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39668048259582617, 1.0]], [0, [1176168.142607622, 1.0]], [0, [588084.0712842778, 1.0]], [0, [294042.03558853455, 1.0]], [0, [147021.01745061539, 1.0]], [0, [73510.50675306622, 1.0]], [0, [36755.22693790031, 1.0]], [0, [7331.391184659294, 1.0]], [0, [18377.14298752711, 1.0]], [0, [1236.8321087700112, 1.0]], [0, [321.99250648897606, 1.0]], [0, [102.05434931539119, 1.0]], [0, [35.47503193176317, 1.0]], [0, [7.961529317267315, 1.0]], [0, [3.145545801869213, 1.0]], [1, [8.604336453648534, 1.0]], [1, [0.4930527092717075, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39668048]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128428]
bas 3, expnt(s) = [294042.03558853]
bas 4, expnt(s) = [147021.01745062]
bas 5, expnt(s) = [73510.50675307]
bas 6, expnt(s) = [36755.2269379]
bas 7, expnt(s) = [7331.39118466]
bas 8, expnt(s) = [18377.14298753]
bas 9, expnt(s) = [1236.83210877]
bas 10, expnt(s) = [321.99250649]
bas 11, expnt(s) = [102.05434932]
bas 12, expnt(s) = [35.47503193]
bas 13, expnt(s) = [7.96152932]
bas 14, expnt(s) = [3.1455458]
bas 15, expnt(s) = [8.60433645]
bas 16, expnt(s) = [0.49305271]
CPU time:      1164.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96680483e-01 1.26283221e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552269e+04 6.70663013e+03 7.33139118e+03 2.00172687e+03
 1.83771430e+04 3.98770957e+03 1.23683211e+03 5.26924131e+02
 3.21992506e+02 1.92043383e+02 1.02054349e+02 8.11220025e+01
 3.54750319e+01 3.67246039e+01 7.96152932e+00 1.19746381e+01
 3.14554580e+00 5.96742589e+00 8.60433645e+00 4.29913539e+01
 4.93052709e-01 1.20531644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325111869880462
cond(S) = 12561.238179961683
E1 = -689.3568036701406  E_coul = 184.91865990351673
init E= -504.438143766624
    CPU time for initialize scf      4.70 sec, wall time      0.34 sec
  HOMO = -0.674561930644336  LUMO = 8.82009175958443
  mo_energy =
[-1.21702131e+02 -1.33869390e+01 -7.62755320e+00 -7.62755320e+00
 -7.62755320e+00 -1.63993341e+00 -6.74561931e-01 -6.74561931e-01
 -6.74561931e-01  8.82009176e+00  9.86191600e+01  5.26083986e+02
  2.35438007e+03  1.15377423e+04  4.11221341e+04  1.09972351e+05
  2.54169142e+05  5.48596469e+05  1.15254166e+06  2.43032170e+06
  5.37505369e+06]
E1 = -707.0690861491997  E_coul = 199.13936320899782
cycle= 1 E= -507.929722940202  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593715
diis-c [-0.35249742  1.        ]
  HOMO = -0.232926178830253  LUMO = 9.71786479639474
  mo_energy =
[-1.20251905e+02 -1.23505351e+01 -6.64531864e+00 -6.64531864e+00
 -6.64531864e+00 -1.16117563e+00 -2.32926179e-01 -2.32926179e-01
 -2.32926179e-01  9.71786480e+00  9.99529180e+01  5.27519645e+02
  2.35575936e+03  1.15389990e+04  4.11233186e+04  1.09973497e+05
  2.54170261e+05  5.48597567e+05  1.15254274e+06  2.43032278e+06
  5.37505475e+06]
E1 = -706.7040132523497  E_coul = 198.76767233541213
cycle= 2 E= -507.936340916938  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155227
diis-c [-2.33578972e-04  4.55485312e-03  9.95445147e-01]
  HOMO = -0.2376030450989  LUMO = 9.70686997748405
  mo_energy =
[-1.20310963e+02 -1.23737847e+01 -6.67412212e+00 -6.67412212e+00
 -6.67412212e+00 -1.16357069e+00 -2.37603045e-01 -2.37603045e-01
 -2.37603045e-01  9.70686998e+00  9.99098273e+01  5.27458809e+02
  2.35568514e+03  1.15389154e+04  4.11232318e+04  1.09973409e+05
  2.54170172e+05  5.48597478e+05  1.15254266e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6885527461568  E_coul = 198.7521986903025
cycle= 3 E= -507.936354055854  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756512
diis-c [-1.62331897e-08  4.49691197e-05 -5.01631020e-02  1.05011813e+00]
  HOMO = -0.237844737724093  LUMO = 9.70631406430149
  mo_energy =
[-1.20313645e+02 -1.23749551e+01 -6.67554446e+00 -6.67554446e+00
 -6.67554446e+00 -1.16368944e+00 -2.37844738e-01 -2.37844738e-01
 -2.37844738e-01  9.70631406e+00  9.99077901e+01  5.27456103e+02
  2.35568203e+03  1.15389120e+04  4.11232284e+04  1.09973405e+05
  2.54170168e+05  5.48597474e+05  1.15254265e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6877629457622  E_coul = 198.75140885578128
cycle= 4 E= -507.936354089981  delta_E= -3.41e-08  |g|= 7.35e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.29302e-06
diis-c [-5.50594888e-12 -1.98009981e-06  2.42567972e-03 -4.84743291e-02
  1.04605063e+00]
  HOMO = -0.237845779242392  LUMO = 9.70631277439694
  mo_energy =
[-1.20313644e+02 -1.23749588e+01 -6.67554727e+00 -6.67554727e+00
 -6.67554727e+00 -1.16369003e+00 -2.37845779e-01 -2.37845779e-01
 -2.37845779e-01  9.70631277e+00  9.99077889e+01  5.27456104e+02
  2.35568204e+03  1.15389120e+04  4.11232284e+04  1.09973405e+05
  2.54170168e+05  5.48597474e+05  1.15254265e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6877610453016  E_coul = 198.75140695531925
cycle= 5 E= -507.936354089982  delta_E= -1.48e-12  |g|= 1.48e-07  |ddm|= 2.87e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6877610453016  E_coul = 198.75140695531925
  HOMO = -0.237845815258244  LUMO = 9.706312703185
  mo_energy =
[-1.20313645e+02 -1.23749590e+01 -6.67554745e+00 -6.67554745e+00
 -6.67554745e+00 -1.16369005e+00 -2.37845815e-01 -2.37845815e-01
 -2.37845815e-01  9.70631270e+00  9.99077886e+01  5.27456104e+02
  2.35568204e+03  1.15389120e+04  4.11232284e+04  1.09973405e+05
  2.54170168e+05  5.48597474e+05  1.15254265e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6877609457488  E_coul = 198.7514068557661
Extra cycle  E= -507.936354089983  delta_E= -2.84e-13  |g|= 7.79e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      4.92 sec, wall time      0.42 sec
exp = [3.96680483e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552269e+04 7.33139118e+03
 1.83771430e+04 1.23683211e+03 3.21992506e+02 1.02054349e+02
 3.54750319e+01 7.96152932e+00 3.14554580e+00 8.60433645e+00
 4.93052709e-01]
E = -507.9363540899827
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396680482596       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035589        1
[INPUT] 0    0    [1    /1   ]  147021.017451        1
[INPUT] 0    0    [1    /1   ]  73510.5067531        1
[INPUT] 0    0    [1    /1   ]  36755.2269379        1
[INPUT] 0    0    [1    /1   ]  7331.39118466        1
[INPUT] 0    0    [1    /1   ]  18377.1429875        1
[INPUT] 0    0    [1    /1   ]  1236.83210877        1
[INPUT] 0    0    [1    /1   ]  321.992506489        1
[INPUT] 0    0    [1    /1   ]  102.054349315        1
[INPUT] 0    0    [1    /1   ]  35.4750319318        1
[INPUT] 0    0    [1    /1   ]  7.96152931727        1
[INPUT] 0    0    [1    /1   ]  3.14554580187        1
[INPUT] 1    0    [1    /1   ]  8.60433645365        1
[INPUT] 1    0    [1    /1   ]  0.493052709272       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39668048259582617, 1.0]], [0, [1176168.142607622, 1.0]], [0, [588084.0712842778, 1.0]], [0, [294042.03558853455, 1.0]], [0, [147021.01745061539, 1.0]], [0, [73510.50675306622, 1.0]], [0, [36755.22693790031, 1.0]], [0, [7331.391184659294, 1.0]], [0, [18377.14298752711, 1.0]], [0, [1236.8321087700112, 1.0]], [0, [321.99250648897606, 1.0]], [0, [102.05434931539119, 1.0]], [0, [35.47503193176317, 1.0]], [0, [7.961529317267315, 1.0]], [0, [3.145545801869213, 1.0]], [1, [8.604336453648534, 1.0]], [1, [0.4930527092717075, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39668048]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128428]
bas 3, expnt(s) = [294042.03558853]
bas 4, expnt(s) = [147021.01745062]
bas 5, expnt(s) = [73510.50675307]
bas 6, expnt(s) = [36755.2269379]
bas 7, expnt(s) = [7331.39118466]
bas 8, expnt(s) = [18377.14298753]
bas 9, expnt(s) = [1236.83210877]
bas 10, expnt(s) = [321.99250649]
bas 11, expnt(s) = [102.05434932]
bas 12, expnt(s) = [35.47503193]
bas 13, expnt(s) = [7.96152932]
bas 14, expnt(s) = [3.1455458]
bas 15, expnt(s) = [8.60433645]
bas 16, expnt(s) = [0.49305271]
CPU time:      1169.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96680483e-01 1.26283221e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105068e+04 1.12791686e+04
 3.67552269e+04 6.70663013e+03 7.33139118e+03 2.00172687e+03
 1.83771430e+04 3.98770957e+03 1.23683211e+03 5.26924131e+02
 3.21992506e+02 1.92043383e+02 1.02054349e+02 8.11220025e+01
 3.54750319e+01 3.67246039e+01 7.96152932e+00 1.19746381e+01
 3.14554580e+00 5.96742589e+00 8.60433645e+00 4.29913539e+01
 4.93052709e-01 1.20531644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325111869880462
cond(S) = 12561.238179961683
E1 = -689.3568036701406  E_coul = 184.91865990351673
init E= -504.438143766624
    CPU time for initialize scf      4.62 sec, wall time      0.32 sec
  HOMO = -0.674561930644336  LUMO = 8.82009175958443
  mo_energy =
[-1.21702131e+02 -1.33869390e+01 -7.62755320e+00 -7.62755320e+00
 -7.62755320e+00 -1.63993341e+00 -6.74561931e-01 -6.74561931e-01
 -6.74561931e-01  8.82009176e+00  9.86191600e+01  5.26083986e+02
  2.35438007e+03  1.15377423e+04  4.11221341e+04  1.09972351e+05
  2.54169142e+05  5.48596469e+05  1.15254166e+06  2.43032170e+06
  5.37505369e+06]
E1 = -707.0690861491997  E_coul = 199.13936320899782
cycle= 1 E= -507.929722940202  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593715
diis-c [-0.35249742  1.        ]
  HOMO = -0.232926178830253  LUMO = 9.71786479639474
  mo_energy =
[-1.20251905e+02 -1.23505351e+01 -6.64531864e+00 -6.64531864e+00
 -6.64531864e+00 -1.16117563e+00 -2.32926179e-01 -2.32926179e-01
 -2.32926179e-01  9.71786480e+00  9.99529180e+01  5.27519645e+02
  2.35575936e+03  1.15389990e+04  4.11233186e+04  1.09973497e+05
  2.54170261e+05  5.48597567e+05  1.15254274e+06  2.43032278e+06
  5.37505475e+06]
E1 = -706.7040132523497  E_coul = 198.76767233541213
cycle= 2 E= -507.936340916938  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155227
diis-c [-2.33578972e-04  4.55485312e-03  9.95445147e-01]
  HOMO = -0.2376030450989  LUMO = 9.70686997748405
  mo_energy =
[-1.20310963e+02 -1.23737847e+01 -6.67412212e+00 -6.67412212e+00
 -6.67412212e+00 -1.16357069e+00 -2.37603045e-01 -2.37603045e-01
 -2.37603045e-01  9.70686998e+00  9.99098273e+01  5.27458809e+02
  2.35568514e+03  1.15389154e+04  4.11232318e+04  1.09973409e+05
  2.54170172e+05  5.48597478e+05  1.15254266e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6885527461568  E_coul = 198.7521986903025
cycle= 3 E= -507.936354055854  delta_E= -1.31e-05  |g|= 0.00091  |ddm|= 0.0093
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756512
diis-c [-1.62331897e-08  4.49691197e-05 -5.01631020e-02  1.05011813e+00]
  HOMO = -0.237844737724093  LUMO = 9.70631406430149
  mo_energy =
[-1.20313645e+02 -1.23749551e+01 -6.67554446e+00 -6.67554446e+00
 -6.67554446e+00 -1.16368944e+00 -2.37844738e-01 -2.37844738e-01
 -2.37844738e-01  9.70631406e+00  9.99077901e+01  5.27456103e+02
  2.35568203e+03  1.15389120e+04  4.11232284e+04  1.09973405e+05
  2.54170168e+05  5.48597474e+05  1.15254265e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6877629457622  E_coul = 198.75140885578128
cycle= 4 E= -507.936354089981  delta_E= -3.41e-08  |g|= 7.35e-06  |ddm|= 0.000502
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.29302e-06
diis-c [-5.50594888e-12 -1.98009981e-06  2.42567972e-03 -4.84743291e-02
  1.04605063e+00]
  HOMO = -0.237845779242392  LUMO = 9.70631277439694
  mo_energy =
[-1.20313644e+02 -1.23749588e+01 -6.67554727e+00 -6.67554727e+00
 -6.67554727e+00 -1.16369003e+00 -2.37845779e-01 -2.37845779e-01
 -2.37845779e-01  9.70631277e+00  9.99077889e+01  5.27456104e+02
  2.35568204e+03  1.15389120e+04  4.11232284e+04  1.09973405e+05
  2.54170168e+05  5.48597474e+05  1.15254265e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6877610453016  E_coul = 198.75140695531925
cycle= 5 E= -507.936354089982  delta_E= -1.48e-12  |g|= 1.48e-07  |ddm|= 2.87e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6877610453016  E_coul = 198.75140695531925
  HOMO = -0.237845815258244  LUMO = 9.706312703185
  mo_energy =
[-1.20313645e+02 -1.23749590e+01 -6.67554745e+00 -6.67554745e+00
 -6.67554745e+00 -1.16369005e+00 -2.37845815e-01 -2.37845815e-01
 -2.37845815e-01  9.70631270e+00  9.99077886e+01  5.27456104e+02
  2.35568204e+03  1.15389120e+04  4.11232284e+04  1.09973405e+05
  2.54170168e+05  5.48597474e+05  1.15254265e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6877609457488  E_coul = 198.7514068557661
Extra cycle  E= -507.936354089983  delta_E= -2.84e-13  |g|= 7.79e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      4.86 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.238179961683
E1 = -706.6877609457488  E_coul = 198.7514068557661
init E= -507.936354089983
    CPU time for initialize scf     10.34 sec, wall time      0.70 sec
  HOMO = -0.237845817002396  LUMO = 9.70631270071764
  mo_energy =
[-1.20313645e+02 -1.23749590e+01 -6.67554746e+00 -6.67554746e+00
 -6.67554746e+00 -1.16369005e+00 -2.37845817e-01 -2.37845817e-01
 -2.37845817e-01  9.70631270e+00  9.99077886e+01  5.27456104e+02
  2.35568204e+03  1.15389120e+04  4.11232284e+04  1.09973405e+05
  2.54170168e+05  5.48597474e+05  1.15254265e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6877609410437  E_coul = 198.7514068510611
cycle= 1 E= -507.936354089983  delta_E= 5.68e-14  |g|= 2.12e-09  |ddm|= 3.98e-09
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
E1 = -706.6877609410437  E_coul = 198.7514068510611
  HOMO = -0.237845817090582  LUMO = 9.70631269965139
  mo_energy =
[-1.20313645e+02 -1.23749590e+01 -6.67554746e+00 -6.67554746e+00
 -6.67554746e+00 -1.16369005e+00 -2.37845817e-01 -2.37845817e-01
 -2.37845817e-01  9.70631270e+00  9.99077886e+01  5.27456104e+02
  2.35568204e+03  1.15389120e+04  4.11232284e+04  1.09973405e+05
  2.54170168e+05  5.48597474e+05  1.15254265e+06  2.43032269e+06
  5.37505466e+06]
E1 = -706.6877609408883  E_coul = 198.75140685090565
Extra cycle  E= -507.936354089983  delta_E= -5.68e-14  |g|= 8.77e-10  |ddm|= 2.11e-10
    CPU time for scf_cycle     10.43 sec, wall time      0.77 sec
exp = [3.96680483e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105068e+04 3.67552269e+04 7.33139118e+03
 1.83771430e+04 1.23683211e+03 3.21992506e+02 1.02054349e+02
 3.54750319e+01 7.96152932e+00 3.14554580e+00 8.60433645e+00
 4.93052709e-01]
grad_E = [ 9.93272104e-05 -3.97866372e-12  5.14511381e-10  1.77598658e-09
  1.00758142e-08  3.41834228e-08  2.01828677e-07  1.11163967e-05
  5.31622462e-07 -8.78501168e-05 -6.66013683e-06  1.15235894e-06
 -7.98696827e-06  3.28475106e-06 -2.64332241e-05  8.46395545e-05
  1.51762989e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396685007109       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035588        1
[INPUT] 0    0    [1    /1   ]  147021.01745         1
[INPUT] 0    0    [1    /1   ]  73510.50675          1
[INPUT] 0    0    [1    /1   ]  36755.2269192        1
[INPUT] 0    0    [1    /1   ]  7331.39016415        1
[INPUT] 0    0    [1    /1   ]  18377.1429411        1
[INPUT] 0    0    [1    /1   ]  1236.83082267        1
[INPUT] 0    0    [1    /1   ]  322.037957394        1
[INPUT] 0    0    [1    /1   ]  102.0638953          1
[INPUT] 0    0    [1    /1   ]  35.4745769889        1
[INPUT] 0    0    [1    /1   ]  7.96123129103        1
[INPUT] 0    0    [1    /1   ]  3.14534921592        1
[INPUT] 1    0    [1    /1   ]  8.6043996076         1
[INPUT] 1    0    [1    /1   ]  0.493056384153       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966850071088394, 1.0]], [0, [1176168.1426076242, 1.0]], [0, [588084.0712842307, 1.0]], [0, [294042.0355883758, 1.0]], [0, [147021.0174496855, 1.0]], [0, [73510.50674999609, 1.0]], [0, [36755.22691924065, 1.0]], [0, [7331.390164152127, 1.0]], [0, [18377.142941117134, 1.0]], [0, [1236.830822666723, 1.0]], [0, [322.0379573935443, 1.0]], [0, [102.06389530022226, 1.0]], [0, [35.474576988904275, 1.0]], [0, [7.961231291028098, 1.0]], [0, [3.145349215916264, 1.0]], [1, [8.604399607600481, 1.0]], [1, [0.4930563841531556, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39668501]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128423]
bas 3, expnt(s) = [294042.03558838]
bas 4, expnt(s) = [147021.01744969]
bas 5, expnt(s) = [73510.50675]
bas 6, expnt(s) = [36755.22691924]
bas 7, expnt(s) = [7331.39016415]
bas 8, expnt(s) = [18377.14294112]
bas 9, expnt(s) = [1236.83082267]
bas 10, expnt(s) = [322.03795739]
bas 11, expnt(s) = [102.0638953]
bas 12, expnt(s) = [35.47457699]
bas 13, expnt(s) = [7.96123129]
bas 14, expnt(s) = [3.14534922]
bas 15, expnt(s) = [8.60439961]
bas 16, expnt(s) = [0.49305638]
CPU time:      1187.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96685007e-01 1.26284301e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791686e+04
 3.67552269e+04 6.70663013e+03 7.33139016e+03 2.00172666e+03
 1.83771429e+04 3.98770956e+03 1.23683082e+03 5.26923720e+02
 3.22037957e+02 1.92063714e+02 1.02063895e+02 8.11276935e+01
 3.54745770e+01 3.67242507e+01 7.96123129e+00 1.19743019e+01
 3.14534922e+00 5.96714618e+00 8.60439961e+00 4.29917484e+01
 4.93056384e-01 1.20532767e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32510637526293
cond(S) = 12561.275899586444
E1 = -689.3571662869571  E_coul = 184.9190893446615
init E= -504.438076942296
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.674557220607408  LUMO = 8.81931837128765
  mo_energy =
[-1.21702060e+02 -1.33869051e+01 -7.62752390e+00 -7.62752390e+00
 -7.62752390e+00 -1.63992816e+00 -6.74557221e-01 -6.74557221e-01
 -6.74557221e-01  8.81931837e+00  9.86201753e+01  5.26136893e+02
  2.35453709e+03  1.15379268e+04  4.11223101e+04  1.09972520e+05
  2.54169306e+05  5.48596627e+05  1.15254181e+06  2.43032185e+06
  5.37505383e+06]
E1 = -707.0696259522364  E_coul = 199.139903515099
cycle= 1 E= -507.929722437137  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593714
diis-c [-0.35249586  1.        ]
  HOMO = -0.232916116100341  LUMO = 9.7170774195168
  mo_energy =
[-1.20251827e+02 -1.23504937e+01 -6.64528173e+00 -6.64528173e+00
 -6.64528173e+00 -1.16116578e+00 -2.32916116e-01 -2.32916116e-01
 -2.32916116e-01  9.71707742e+00  9.99539461e+01  5.27572557e+02
  2.35591638e+03  1.15391835e+04  4.11234946e+04  1.09973665e+05
  2.54170424e+05  5.48597725e+05  1.15254290e+06  2.43032293e+06
  5.37505490e+06]
E1 = -706.7045224242733  E_coul = 198.7681813687675
cycle= 2 E= -507.936341055506  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155233
diis-c [-2.33599215e-04  4.55469726e-03  9.95445303e-01]
  HOMO = -0.237593564987322  LUMO = 9.70608207936225
  mo_energy =
[-1.20310888e+02 -1.23737455e+01 -6.67408772e+00 -6.67408772e+00
 -6.67408772e+00 -1.16356115e+00 -2.37593565e-01 -2.37593565e-01
 -2.37593565e-01  9.70608208e+00  9.99108517e+01  5.27511716e+02
  2.35584216e+03  1.15390999e+04  4.11234078e+04  1.09973577e+05
  2.54170335e+05  5.48597636e+05  1.15254281e+06  2.43032284e+06
  5.37505481e+06]
E1 = -706.689059955097  E_coul = 198.75270575816884
cycle= 3 E= -507.936354196928  delta_E= -1.31e-05  |g|= 0.000911  |ddm|= 0.0093
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756554
diis-c [-1.62414505e-08  4.49725586e-05 -5.01636261e-02  1.05011865e+00]
  HOMO = -0.237835297931908  LUMO = 9.70552611596815
  mo_energy =
[-1.20313571e+02 -1.23749161e+01 -6.67551023e+00 -6.67551023e+00
 -6.67551023e+00 -1.16367993e+00 -2.37835298e-01 -2.37835298e-01
 -2.37835298e-01  9.70552612e+00  9.99088143e+01  5.27509009e+02
  2.35583906e+03  1.15390965e+04  4.11234043e+04  1.09973574e+05
  2.54170332e+05  5.48597633e+05  1.15254281e+06  2.43032283e+06
  5.37505480e+06]
E1 = -706.6882700224833  E_coul = 198.7519157914189
cycle= 4 E= -507.936354231064  delta_E= -3.41e-08  |g|= 7.35e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.29459e-06
diis-c [-5.51206698e-12 -1.97552635e-06  2.42568885e-03 -4.84751627e-02
  1.04605145e+00]
  HOMO = -0.237836340060274  LUMO = 9.70552482519854
  mo_energy =
[-1.20313571e+02 -1.23749197e+01 -6.67551305e+00 -6.67551305e+00
 -6.67551305e+00 -1.16368052e+00 -2.37836340e-01 -2.37836340e-01
 -2.37836340e-01  9.70552483e+00  9.99088131e+01  5.27509010e+02
  2.35583906e+03  1.15390965e+04  4.11234043e+04  1.09973574e+05
  2.54170332e+05  5.48597633e+05  1.15254281e+06  2.43032283e+06
  5.37505480e+06]
E1 = -706.6882681204318  E_coul = 198.7519138893655
cycle= 5 E= -507.936354231066  delta_E= -1.93e-12  |g|= 1.48e-07  |ddm|= 2.87e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6882681204318  E_coul = 198.7519138893655
  HOMO = -0.237836376099378  LUMO = 9.70552475475778
  mo_energy =
[-1.20313571e+02 -1.23749199e+01 -6.67551323e+00 -6.67551323e+00
 -6.67551323e+00 -1.16368053e+00 -2.37836376e-01 -2.37836376e-01
 -2.37836376e-01  9.70552475e+00  9.99088128e+01  5.27509010e+02
  2.35583906e+03  1.15390965e+04  4.11234043e+04  1.09973574e+05
  2.54170332e+05  5.48597633e+05  1.15254281e+06  2.43032283e+06
  5.37505480e+06]
E1 = -706.688268020753  E_coul = 198.75191378968665
Extra cycle  E= -507.936354231066  delta_E=    0  |g|= 7.81e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      5.03 sec, wall time      0.40 sec
exp = [3.96685007e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552269e+04 7.33139016e+03
 1.83771429e+04 1.23683082e+03 3.22037957e+02 1.02063895e+02
 3.54745770e+01 7.96123129e+00 3.14534922e+00 8.60439961e+00
 4.93056384e-01]
E = -507.9363542310663
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396685007109       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035588        1
[INPUT] 0    0    [1    /1   ]  147021.01745         1
[INPUT] 0    0    [1    /1   ]  73510.50675          1
[INPUT] 0    0    [1    /1   ]  36755.2269192        1
[INPUT] 0    0    [1    /1   ]  7331.39016415        1
[INPUT] 0    0    [1    /1   ]  18377.1429411        1
[INPUT] 0    0    [1    /1   ]  1236.83082267        1
[INPUT] 0    0    [1    /1   ]  322.037957394        1
[INPUT] 0    0    [1    /1   ]  102.0638953          1
[INPUT] 0    0    [1    /1   ]  35.4745769889        1
[INPUT] 0    0    [1    /1   ]  7.96123129103        1
[INPUT] 0    0    [1    /1   ]  3.14534921592        1
[INPUT] 1    0    [1    /1   ]  8.6043996076         1
[INPUT] 1    0    [1    /1   ]  0.493056384153       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966850071088394, 1.0]], [0, [1176168.1426076242, 1.0]], [0, [588084.0712842307, 1.0]], [0, [294042.0355883758, 1.0]], [0, [147021.0174496855, 1.0]], [0, [73510.50674999609, 1.0]], [0, [36755.22691924065, 1.0]], [0, [7331.390164152127, 1.0]], [0, [18377.142941117134, 1.0]], [0, [1236.830822666723, 1.0]], [0, [322.0379573935443, 1.0]], [0, [102.06389530022226, 1.0]], [0, [35.474576988904275, 1.0]], [0, [7.961231291028098, 1.0]], [0, [3.145349215916264, 1.0]], [1, [8.604399607600481, 1.0]], [1, [0.4930563841531556, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39668501]
bas 1, expnt(s) = [1176168.14260762]
bas 2, expnt(s) = [588084.07128423]
bas 3, expnt(s) = [294042.03558838]
bas 4, expnt(s) = [147021.01744969]
bas 5, expnt(s) = [73510.50675]
bas 6, expnt(s) = [36755.22691924]
bas 7, expnt(s) = [7331.39016415]
bas 8, expnt(s) = [18377.14294112]
bas 9, expnt(s) = [1236.83082267]
bas 10, expnt(s) = [322.03795739]
bas 11, expnt(s) = [102.0638953]
bas 12, expnt(s) = [35.47457699]
bas 13, expnt(s) = [7.96123129]
bas 14, expnt(s) = [3.14534922]
bas 15, expnt(s) = [8.60439961]
bas 16, expnt(s) = [0.49305638]
CPU time:      1193.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96685007e-01 1.26284301e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791686e+04
 3.67552269e+04 6.70663013e+03 7.33139016e+03 2.00172666e+03
 1.83771429e+04 3.98770956e+03 1.23683082e+03 5.26923720e+02
 3.22037957e+02 1.92063714e+02 1.02063895e+02 8.11276935e+01
 3.54745770e+01 3.67242507e+01 7.96123129e+00 1.19743019e+01
 3.14534922e+00 5.96714618e+00 8.60439961e+00 4.29917484e+01
 4.93056384e-01 1.20532767e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32510637526293
cond(S) = 12561.275899586444
E1 = -689.3571662869571  E_coul = 184.9190893446615
init E= -504.438076942296
    CPU time for initialize scf      4.78 sec, wall time      0.33 sec
  HOMO = -0.674557220607408  LUMO = 8.81931837128765
  mo_energy =
[-1.21702060e+02 -1.33869051e+01 -7.62752390e+00 -7.62752390e+00
 -7.62752390e+00 -1.63992816e+00 -6.74557221e-01 -6.74557221e-01
 -6.74557221e-01  8.81931837e+00  9.86201753e+01  5.26136893e+02
  2.35453709e+03  1.15379268e+04  4.11223101e+04  1.09972520e+05
  2.54169306e+05  5.48596627e+05  1.15254181e+06  2.43032185e+06
  5.37505383e+06]
E1 = -707.0696259522364  E_coul = 199.139903515099
cycle= 1 E= -507.929722437137  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593714
diis-c [-0.35249586  1.        ]
  HOMO = -0.232916116100341  LUMO = 9.7170774195168
  mo_energy =
[-1.20251827e+02 -1.23504937e+01 -6.64528173e+00 -6.64528173e+00
 -6.64528173e+00 -1.16116578e+00 -2.32916116e-01 -2.32916116e-01
 -2.32916116e-01  9.71707742e+00  9.99539461e+01  5.27572557e+02
  2.35591638e+03  1.15391835e+04  4.11234946e+04  1.09973665e+05
  2.54170424e+05  5.48597725e+05  1.15254290e+06  2.43032293e+06
  5.37505490e+06]
E1 = -706.7045224242733  E_coul = 198.7681813687675
cycle= 2 E= -507.936341055506  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155233
diis-c [-2.33599215e-04  4.55469726e-03  9.95445303e-01]
  HOMO = -0.237593564987322  LUMO = 9.70608207936225
  mo_energy =
[-1.20310888e+02 -1.23737455e+01 -6.67408772e+00 -6.67408772e+00
 -6.67408772e+00 -1.16356115e+00 -2.37593565e-01 -2.37593565e-01
 -2.37593565e-01  9.70608208e+00  9.99108517e+01  5.27511716e+02
  2.35584216e+03  1.15390999e+04  4.11234078e+04  1.09973577e+05
  2.54170335e+05  5.48597636e+05  1.15254281e+06  2.43032284e+06
  5.37505481e+06]
E1 = -706.689059955097  E_coul = 198.75270575816884
cycle= 3 E= -507.936354196928  delta_E= -1.31e-05  |g|= 0.000911  |ddm|= 0.0093
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756554
diis-c [-1.62414505e-08  4.49725586e-05 -5.01636261e-02  1.05011865e+00]
  HOMO = -0.237835297931908  LUMO = 9.70552611596815
  mo_energy =
[-1.20313571e+02 -1.23749161e+01 -6.67551023e+00 -6.67551023e+00
 -6.67551023e+00 -1.16367993e+00 -2.37835298e-01 -2.37835298e-01
 -2.37835298e-01  9.70552612e+00  9.99088143e+01  5.27509009e+02
  2.35583906e+03  1.15390965e+04  4.11234043e+04  1.09973574e+05
  2.54170332e+05  5.48597633e+05  1.15254281e+06  2.43032283e+06
  5.37505480e+06]
E1 = -706.6882700224833  E_coul = 198.7519157914189
cycle= 4 E= -507.936354231064  delta_E= -3.41e-08  |g|= 7.35e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.29459e-06
diis-c [-5.51206698e-12 -1.97552635e-06  2.42568885e-03 -4.84751627e-02
  1.04605145e+00]
  HOMO = -0.237836340060274  LUMO = 9.70552482519854
  mo_energy =
[-1.20313571e+02 -1.23749197e+01 -6.67551305e+00 -6.67551305e+00
 -6.67551305e+00 -1.16368052e+00 -2.37836340e-01 -2.37836340e-01
 -2.37836340e-01  9.70552483e+00  9.99088131e+01  5.27509010e+02
  2.35583906e+03  1.15390965e+04  4.11234043e+04  1.09973574e+05
  2.54170332e+05  5.48597633e+05  1.15254281e+06  2.43032283e+06
  5.37505480e+06]
E1 = -706.6882681204318  E_coul = 198.7519138893655
cycle= 5 E= -507.936354231066  delta_E= -1.93e-12  |g|= 1.48e-07  |ddm|= 2.87e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6882681204318  E_coul = 198.7519138893655
  HOMO = -0.237836376099378  LUMO = 9.70552475475778
  mo_energy =
[-1.20313571e+02 -1.23749199e+01 -6.67551323e+00 -6.67551323e+00
 -6.67551323e+00 -1.16368053e+00 -2.37836376e-01 -2.37836376e-01
 -2.37836376e-01  9.70552475e+00  9.99088128e+01  5.27509010e+02
  2.35583906e+03  1.15390965e+04  4.11234043e+04  1.09973574e+05
  2.54170332e+05  5.48597633e+05  1.15254281e+06  2.43032283e+06
  5.37505480e+06]
E1 = -706.688268020753  E_coul = 198.75191378968665
Extra cycle  E= -507.936354231066  delta_E=    0  |g|= 7.81e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      5.03 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.275899586444
E1 = -706.688268020753  E_coul = 198.75191378968665
init E= -507.936354231066
    CPU time for initialize scf      9.01 sec, wall time      0.61 sec
  HOMO = -0.237836377845195  LUMO = 9.70552475105462
  mo_energy =
[-1.20313571e+02 -1.23749199e+01 -6.67551324e+00 -6.67551324e+00
 -6.67551324e+00 -1.16368054e+00 -2.37836378e-01 -2.37836378e-01
 -2.37836378e-01  9.70552475e+00  9.99088128e+01  5.27509010e+02
  2.35583906e+03  1.15390965e+04  4.11234043e+04  1.09973574e+05
  2.54170332e+05  5.48597633e+05  1.15254281e+06  2.43032283e+06
  5.37505480e+06]
E1 = -706.6882680160785  E_coul = 198.75191378501265
cycle= 1 E= -507.936354231066  delta_E= 4.55e-13  |g|= 8.54e-10  |ddm|= 3.97e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6882680160785  E_coul = 198.75191378501265
  HOMO = -0.237836377933071  LUMO = 9.70552475174271
  mo_energy =
[-1.20313571e+02 -1.23749199e+01 -6.67551324e+00 -6.67551324e+00
 -6.67551324e+00 -1.16368054e+00 -2.37836378e-01 -2.37836378e-01
 -2.37836378e-01  9.70552475e+00  9.99088128e+01  5.27509010e+02
  2.35583906e+03  1.15390965e+04  4.11234043e+04  1.09973574e+05
  2.54170332e+05  5.48597633e+05  1.15254281e+06  2.43032283e+06
  5.37505480e+06]
E1 = -706.6882680158883  E_coul = 198.75191378482208
Extra cycle  E= -507.936354231066  delta_E= -3.98e-13  |g|= 1.13e-09  |ddm|= 2.06e-10
    CPU time for scf_cycle      9.19 sec, wall time      0.67 sec
exp = [3.96685007e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552269e+04 7.33139016e+03
 1.83771429e+04 1.23683082e+03 3.22037957e+02 1.02063895e+02
 3.54745770e+01 7.96123129e+00 3.14534922e+00 8.60439961e+00
 4.93056384e-01]
grad_E = [ 1.58407468e-04 -3.93313792e-12  5.14798924e-10  1.77710047e-09
  1.00812671e-08  3.42044626e-08  2.01936803e-07  1.11224126e-05
  5.31990806e-07 -8.81321343e-05 -5.26539434e-06  9.56657369e-07
 -1.30541947e-05  5.67108127e-06 -3.94060847e-05  1.32856045e-04
  2.26733355e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396691434664       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035588        1
[INPUT] 0    0    [1    /1   ]  147021.017448        1
[INPUT] 0    0    [1    /1   ]  73510.5067441        1
[INPUT] 0    0    [1    /1   ]  36755.2268835        1
[INPUT] 0    0    [1    /1   ]  7331.38820781        1
[INPUT] 0    0    [1    /1   ]  18377.1428513        1
[INPUT] 0    0    [1    /1   ]  1236.83170978        1
[INPUT] 0    0    [1    /1   ]  322.108985826        1
[INPUT] 0    0    [1    /1   ]  102.078844799        1
[INPUT] 0    0    [1    /1   ]  35.4740295684        1
[INPUT] 0    0    [1    /1   ]  7.96083642777        1
[INPUT] 0    0    [1    /1   ]  3.14507846361        1
[INPUT] 1    0    [1    /1   ]  8.60448858184        1
[INPUT] 1    0    [1    /1   ]  0.493061564706       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39669143466440887, 1.0]], [0, [1176168.1426076274, 1.0]], [0, [588084.0712841402, 1.0]], [0, [294042.03558807, 1.0]], [0, [147021.01744790463, 1.0]], [0, [73510.50674408625, 1.0]], [0, [36755.22688351683, 1.0]], [0, [7331.388207814628, 1.0]], [0, [18377.142851290966, 1.0]], [0, [1236.8317097805077, 1.0]], [0, [322.108985826356, 1.0]], [0, [102.07884479941967, 1.0]], [0, [35.474029568379464, 1.0]], [0, [7.96083642777098, 1.0]], [0, [3.145078463605553, 1.0]], [1, [8.604488581841267, 1.0]], [1, [0.4930615647060836, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39669143]
bas 1, expnt(s) = [1176168.14260763]
bas 2, expnt(s) = [588084.07128414]
bas 3, expnt(s) = [294042.03558807]
bas 4, expnt(s) = [147021.0174479]
bas 5, expnt(s) = [73510.50674409]
bas 6, expnt(s) = [36755.22688352]
bas 7, expnt(s) = [7331.38820781]
bas 8, expnt(s) = [18377.14285129]
bas 9, expnt(s) = [1236.83170978]
bas 10, expnt(s) = [322.10898583]
bas 11, expnt(s) = [102.0788448]
bas 12, expnt(s) = [35.47402957]
bas 13, expnt(s) = [7.96083643]
bas 14, expnt(s) = [3.14507846]
bas 15, expnt(s) = [8.60448858]
bas 16, expnt(s) = [0.49306156]
CPU time:      1210.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96691435e-01 1.26285835e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791686e+04
 3.67552269e+04 6.70663012e+03 7.33138821e+03 2.00172626e+03
 1.83771429e+04 3.98770954e+03 1.23683171e+03 5.26924003e+02
 3.22108986e+02 1.92095484e+02 1.02078845e+02 8.11366055e+01
 3.54740296e+01 3.67238257e+01 7.96083643e+00 1.19738565e+01
 3.14507846e+00 5.96676094e+00 8.60448858e+00 4.29923041e+01
 4.93061565e-01 1.20534350e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32509861530063
cond(S) = 12561.336970563434
E1 = -689.3576627802337  E_coul = 184.91969416252988
init E= -504.437968617704
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674550583220697  LUMO = 8.81827330915787
  mo_energy =
[-1.21701959e+02 -1.33868572e+01 -7.62748266e+00 -7.62748266e+00
 -7.62748266e+00 -1.63992076e+00 -6.74550583e-01 -6.74550583e-01
 -6.74550583e-01  8.81827331e+00  9.86225060e+01  5.26220675e+02
  2.35478627e+03  1.15382244e+04  4.11225954e+04  1.09972794e+05
  2.54169570e+05  5.48596884e+05  1.15254206e+06  2.43032210e+06
  5.37505407e+06]
E1 = -707.0703859743998  E_coul = 199.1406640657754
cycle= 1 E= -507.929721908624  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593711
diis-c [-0.35249302  1.        ]
  HOMO = -0.232901928698376  LUMO = 9.71601401381629
  mo_energy =
[-1.20251718e+02 -1.23504354e+01 -6.64522976e+00 -6.64522976e+00
 -6.64522976e+00 -1.16115190e+00 -2.32901929e-01 -2.32901929e-01
 -2.32901929e-01  9.71601401e+00  9.99562962e+01  5.27656347e+02
  2.35616556e+03  1.15394811e+04  4.11237799e+04  1.09973939e+05
  2.54170688e+05  5.48597982e+05  1.15254315e+06  2.43032317e+06
  5.37505513e+06]
E1 = -706.7052407274556  E_coul = 198.76889932640208
cycle= 2 E= -507.936341401053  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155242
diis-c [-2.33627787e-04  4.55443768e-03  9.95445562e-01]
  HOMO = -0.23758017087176  LUMO = 9.70501795064867
  mo_energy =
[-1.20310784e+02 -1.23736901e+01 -6.67403917e+00 -6.67403917e+00
 -6.67403917e+00 -1.16354770e+00 -2.37580171e-01 -2.37580171e-01
 -2.37580171e-01  9.70501795e+00  9.99131966e+01  5.27595499e+02
  2.35609134e+03  1.15393975e+04  4.11236931e+04  1.09973851e+05
  2.54170600e+05  5.48597893e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6897755930195  E_coul = 198.7534210471475
cycle= 3 E= -507.936354545872  delta_E= -1.31e-05  |g|= 0.000911  |ddm|= 0.00931
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756614
diis-c [-1.62525347e-08  4.49822597e-05 -5.01643874e-02  1.05011941e+00]
  HOMO = -0.237821958332012  LUMO = 9.70446192060369
  mo_energy =
[-1.20313467e+02 -1.23748609e+01 -6.67546193e+00 -6.67546193e+00
 -6.67546193e+00 -1.16366651e+00 -2.37821958e-01 -2.37821958e-01
 -2.37821958e-01  9.70446192e+00  9.99111588e+01  5.27592792e+02
  2.35608823e+03  1.15393941e+04  4.11236896e+04  1.09973847e+05
  2.54170596e+05  5.48597890e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6889854817973  E_coul = 198.75263090177637
cycle= 4 E= -507.936354580021  delta_E= -3.41e-08  |g|= 7.36e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.2971e-06
diis-c [-5.51440494e-12 -1.97485533e-06  2.42607144e-03 -4.84835994e-02
  1.04605950e+00]
  HOMO = -0.237823001316542  LUMO = 9.70446062968792
  mo_energy =
[-1.20313467e+02 -1.23748646e+01 -6.67546474e+00 -6.67546474e+00
 -6.67546474e+00 -1.16366709e+00 -2.37823001e-01 -2.37823001e-01
 -2.37823001e-01  9.70446063e+00  9.99111576e+01  5.27592793e+02
  2.35608823e+03  1.15393942e+04  4.11236896e+04  1.09973847e+05
  2.54170596e+05  5.48597890e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6889835775289  E_coul = 198.7526289975058
cycle= 5 E= -507.936354580023  delta_E= -2.16e-12  |g|= 1.48e-07  |ddm|= 2.87e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6889835775289  E_coul = 198.7526289975058
  HOMO = -0.237823037360047  LUMO = 9.70446055792986
  mo_energy =
[-1.20313467e+02 -1.23748647e+01 -6.67546492e+00 -6.67546492e+00
 -6.67546492e+00 -1.16366711e+00 -2.37823037e-01 -2.37823037e-01
 -2.37823037e-01  9.70446056e+00  9.99111574e+01  5.27592792e+02
  2.35608823e+03  1.15393942e+04  4.11236896e+04  1.09973847e+05
  2.54170596e+05  5.48597890e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6889834778522  E_coul = 198.75262889782923
Extra cycle  E= -507.936354580023  delta_E= 2.27e-13  |g|= 7.85e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [3.96691435e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552269e+04 7.33138821e+03
 1.83771429e+04 1.23683171e+03 3.22108986e+02 1.02078845e+02
 3.54740296e+01 7.96083643e+00 3.14507846e+00 8.60448858e+00
 4.93061565e-01]
E = -507.9363545800229
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396691434664       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035588        1
[INPUT] 0    0    [1    /1   ]  147021.017448        1
[INPUT] 0    0    [1    /1   ]  73510.5067441        1
[INPUT] 0    0    [1    /1   ]  36755.2268835        1
[INPUT] 0    0    [1    /1   ]  7331.38820781        1
[INPUT] 0    0    [1    /1   ]  18377.1428513        1
[INPUT] 0    0    [1    /1   ]  1236.83170978        1
[INPUT] 0    0    [1    /1   ]  322.108985826        1
[INPUT] 0    0    [1    /1   ]  102.078844799        1
[INPUT] 0    0    [1    /1   ]  35.4740295684        1
[INPUT] 0    0    [1    /1   ]  7.96083642777        1
[INPUT] 0    0    [1    /1   ]  3.14507846361        1
[INPUT] 1    0    [1    /1   ]  8.60448858184        1
[INPUT] 1    0    [1    /1   ]  0.493061564706       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39669143466440887, 1.0]], [0, [1176168.1426076274, 1.0]], [0, [588084.0712841402, 1.0]], [0, [294042.03558807, 1.0]], [0, [147021.01744790463, 1.0]], [0, [73510.50674408625, 1.0]], [0, [36755.22688351683, 1.0]], [0, [7331.388207814628, 1.0]], [0, [18377.142851290966, 1.0]], [0, [1236.8317097805077, 1.0]], [0, [322.108985826356, 1.0]], [0, [102.07884479941967, 1.0]], [0, [35.474029568379464, 1.0]], [0, [7.96083642777098, 1.0]], [0, [3.145078463605553, 1.0]], [1, [8.604488581841267, 1.0]], [1, [0.4930615647060836, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39669143]
bas 1, expnt(s) = [1176168.14260763]
bas 2, expnt(s) = [588084.07128414]
bas 3, expnt(s) = [294042.03558807]
bas 4, expnt(s) = [147021.0174479]
bas 5, expnt(s) = [73510.50674409]
bas 6, expnt(s) = [36755.22688352]
bas 7, expnt(s) = [7331.38820781]
bas 8, expnt(s) = [18377.14285129]
bas 9, expnt(s) = [1236.83170978]
bas 10, expnt(s) = [322.10898583]
bas 11, expnt(s) = [102.0788448]
bas 12, expnt(s) = [35.47402957]
bas 13, expnt(s) = [7.96083643]
bas 14, expnt(s) = [3.14507846]
bas 15, expnt(s) = [8.60448858]
bas 16, expnt(s) = [0.49306156]
CPU time:      1210.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96691435e-01 1.26285835e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791686e+04
 3.67552269e+04 6.70663012e+03 7.33138821e+03 2.00172626e+03
 1.83771429e+04 3.98770954e+03 1.23683171e+03 5.26924003e+02
 3.22108986e+02 1.92095484e+02 1.02078845e+02 8.11366055e+01
 3.54740296e+01 3.67238257e+01 7.96083643e+00 1.19738565e+01
 3.14507846e+00 5.96676094e+00 8.60448858e+00 4.29923041e+01
 4.93061565e-01 1.20534350e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32509861530063
cond(S) = 12561.336970563434
E1 = -689.3576627802337  E_coul = 184.91969416252988
init E= -504.437968617704
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674550583220697  LUMO = 8.81827330915787
  mo_energy =
[-1.21701959e+02 -1.33868572e+01 -7.62748266e+00 -7.62748266e+00
 -7.62748266e+00 -1.63992076e+00 -6.74550583e-01 -6.74550583e-01
 -6.74550583e-01  8.81827331e+00  9.86225060e+01  5.26220675e+02
  2.35478627e+03  1.15382244e+04  4.11225954e+04  1.09972794e+05
  2.54169570e+05  5.48596884e+05  1.15254206e+06  2.43032210e+06
  5.37505407e+06]
E1 = -707.0703859743998  E_coul = 199.1406640657754
cycle= 1 E= -507.929721908624  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593711
diis-c [-0.35249302  1.        ]
  HOMO = -0.232901928698376  LUMO = 9.71601401381629
  mo_energy =
[-1.20251718e+02 -1.23504354e+01 -6.64522976e+00 -6.64522976e+00
 -6.64522976e+00 -1.16115190e+00 -2.32901929e-01 -2.32901929e-01
 -2.32901929e-01  9.71601401e+00  9.99562962e+01  5.27656347e+02
  2.35616556e+03  1.15394811e+04  4.11237799e+04  1.09973939e+05
  2.54170688e+05  5.48597982e+05  1.15254315e+06  2.43032317e+06
  5.37505513e+06]
E1 = -706.7052407274556  E_coul = 198.76889932640208
cycle= 2 E= -507.936341401053  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155242
diis-c [-2.33627787e-04  4.55443768e-03  9.95445562e-01]
  HOMO = -0.23758017087176  LUMO = 9.70501795064867
  mo_energy =
[-1.20310784e+02 -1.23736901e+01 -6.67403917e+00 -6.67403917e+00
 -6.67403917e+00 -1.16354770e+00 -2.37580171e-01 -2.37580171e-01
 -2.37580171e-01  9.70501795e+00  9.99131966e+01  5.27595499e+02
  2.35609134e+03  1.15393975e+04  4.11236931e+04  1.09973851e+05
  2.54170600e+05  5.48597893e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6897755930195  E_coul = 198.7534210471475
cycle= 3 E= -507.936354545872  delta_E= -1.31e-05  |g|= 0.000911  |ddm|= 0.00931
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756614
diis-c [-1.62525347e-08  4.49822597e-05 -5.01643874e-02  1.05011941e+00]
  HOMO = -0.237821958332012  LUMO = 9.70446192060369
  mo_energy =
[-1.20313467e+02 -1.23748609e+01 -6.67546193e+00 -6.67546193e+00
 -6.67546193e+00 -1.16366651e+00 -2.37821958e-01 -2.37821958e-01
 -2.37821958e-01  9.70446192e+00  9.99111588e+01  5.27592792e+02
  2.35608823e+03  1.15393941e+04  4.11236896e+04  1.09973847e+05
  2.54170596e+05  5.48597890e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6889854817973  E_coul = 198.75263090177637
cycle= 4 E= -507.936354580021  delta_E= -3.41e-08  |g|= 7.36e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.2971e-06
diis-c [-5.51440494e-12 -1.97485533e-06  2.42607144e-03 -4.84835994e-02
  1.04605950e+00]
  HOMO = -0.237823001316542  LUMO = 9.70446062968792
  mo_energy =
[-1.20313467e+02 -1.23748646e+01 -6.67546474e+00 -6.67546474e+00
 -6.67546474e+00 -1.16366709e+00 -2.37823001e-01 -2.37823001e-01
 -2.37823001e-01  9.70446063e+00  9.99111576e+01  5.27592793e+02
  2.35608823e+03  1.15393942e+04  4.11236896e+04  1.09973847e+05
  2.54170596e+05  5.48597890e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6889835775289  E_coul = 198.7526289975058
cycle= 5 E= -507.936354580023  delta_E= -2.16e-12  |g|= 1.48e-07  |ddm|= 2.87e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6889835775289  E_coul = 198.7526289975058
  HOMO = -0.237823037360047  LUMO = 9.70446055792986
  mo_energy =
[-1.20313467e+02 -1.23748647e+01 -6.67546492e+00 -6.67546492e+00
 -6.67546492e+00 -1.16366711e+00 -2.37823037e-01 -2.37823037e-01
 -2.37823037e-01  9.70446056e+00  9.99111574e+01  5.27592792e+02
  2.35608823e+03  1.15393942e+04  4.11236896e+04  1.09973847e+05
  2.54170596e+05  5.48597890e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6889834778522  E_coul = 198.75262889782923
Extra cycle  E= -507.936354580023  delta_E= 2.27e-13  |g|= 7.85e-09  |ddm|= 7.8e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.336970563434
E1 = -706.6889834778522  E_coul = 198.75262889782923
init E= -507.936354580023
    CPU time for initialize scf      1.33 sec, wall time      0.08 sec
  HOMO = -0.237823039105905  LUMO = 9.70446055438906
  mo_energy =
[-1.20313467e+02 -1.23748647e+01 -6.67546493e+00 -6.67546493e+00
 -6.67546493e+00 -1.16366711e+00 -2.37823039e-01 -2.37823039e-01
 -2.37823039e-01  9.70446055e+00  9.99111574e+01  5.27592792e+02
  2.35608823e+03  1.15393942e+04  4.11236896e+04  1.09973847e+05
  2.54170596e+05  5.48597890e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6889834731697  E_coul = 198.75262889314675
cycle= 1 E= -507.936354580023  delta_E= -1.14e-13  |g|= 9.44e-10  |ddm|= 3.99e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6889834731697  E_coul = 198.75262889314675
  HOMO = -0.237823039194197  LUMO = 9.70446055480354
  mo_energy =
[-1.20313467e+02 -1.23748647e+01 -6.67546493e+00 -6.67546493e+00
 -6.67546493e+00 -1.16366711e+00 -2.37823039e-01 -2.37823039e-01
 -2.37823039e-01  9.70446055e+00  9.99111574e+01  5.27592792e+02
  2.35608823e+03  1.15393942e+04  4.11236896e+04  1.09973847e+05
  2.54170596e+05  5.48597890e+05  1.15254306e+06  2.43032308e+06
  5.37505504e+06]
E1 = -706.6889834729778  E_coul = 198.7526288929549
Extra cycle  E= -507.936354580023  delta_E= 1.14e-13  |g|= 7.45e-10  |ddm|= 1.99e-10
    CPU time for scf_cycle      1.50 sec, wall time      0.15 sec
exp = [3.96691435e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552269e+04 7.33138821e+03
 1.83771429e+04 1.23683171e+03 3.22108986e+02 1.02078845e+02
 3.54740296e+01 7.96083643e+00 3.14507846e+00 8.60448858e+00
 4.93061565e-01]
grad_E = [ 2.42325698e-04 -3.86359210e-12  5.15238132e-10  1.77880193e-09
  1.00895962e-08  3.42366009e-08  2.02101972e-07  1.11316171e-05
  5.32553449e-07 -8.85682829e-05 -3.08138743e-06  4.74108299e-07
 -2.04919593e-05  9.03651122e-06 -5.74066501e-05  2.00765254e-04
  3.32662919e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396701675364       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035587        1
[INPUT] 0    0    [1    /1   ]  147021.017444        1
[INPUT] 0    0    [1    /1   ]  73510.5067312        1
[INPUT] 0    0    [1    /1   ]  36755.2268058        1
[INPUT] 0    0    [1    /1   ]  7331.38394638        1
[INPUT] 0    0    [1    /1   ]  18377.1426538        1
[INPUT] 0    0    [1    /1   ]  1236.84088382        1
[INPUT] 0    0    [1    /1   ]  322.228936517        1
[INPUT] 0    0    [1    /1   ]  102.104181586        1
[INPUT] 0    0    [1    /1   ]  35.4733288548        1
[INPUT] 0    0    [1    /1   ]  7.96023025067        1
[INPUT] 0    0    [1    /1   ]  3.14465315341        1
[INPUT] 1    0    [1    /1   ]  8.60462967521        1
[INPUT] 1    0    [1    /1   ]  0.493069777022       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39670167536410916, 1.0]], [0, [1176168.1426076333, 1.0]], [0, [588084.0712839431, 1.0]], [0, [294042.03558740043, 1.0]], [0, [147021.01744402922, 1.0]], [0, [73510.50673116047, 1.0]], [0, [36755.22680580255, 1.0]], [0, [7331.383946377812, 1.0]], [0, [18377.14265377343, 1.0]], [0, [1236.8408838199553, 1.0]], [0, [322.22893651678993, 1.0]], [0, [102.10418158640134, 1.0]], [0, [35.47332885476285, 1.0]], [0, [7.960230250674396, 1.0]], [0, [3.1446531534078366, 1.0]], [1, [8.604629675210425, 1.0]], [1, [0.49306977702237625, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39670168]
bas 1, expnt(s) = [1176168.14260763]
bas 2, expnt(s) = [588084.07128394]
bas 3, expnt(s) = [294042.0355874]
bas 4, expnt(s) = [147021.01744403]
bas 5, expnt(s) = [73510.50673116]
bas 6, expnt(s) = [36755.2268058]
bas 7, expnt(s) = [7331.38394638]
bas 8, expnt(s) = [18377.14265377]
bas 9, expnt(s) = [1236.84088382]
bas 10, expnt(s) = [322.22893652]
bas 11, expnt(s) = [102.10418159]
bas 12, expnt(s) = [35.47332885]
bas 13, expnt(s) = [7.96023025]
bas 14, expnt(s) = [3.14465315]
bas 15, expnt(s) = [8.60462968]
bas 16, expnt(s) = [0.49306978]
CPU time:      1215.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96701675e-01 1.26288281e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791686e+04
 3.67552268e+04 6.70663011e+03 7.33138395e+03 2.00172539e+03
 1.83771427e+04 3.98770951e+03 1.23684088e+03 5.26926934e+02
 3.22228937e+02 1.92149132e+02 1.02104182e+02 8.11517091e+01
 3.54733289e+01 3.67232816e+01 7.96023025e+00 1.19731727e+01
 3.14465315e+00 5.96615576e+00 8.60462968e+00 4.29931853e+01
 4.93069777e-01 1.20536859e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32508629785082
cond(S) = 12561.4452580582
E1 = -689.3584398803575  E_coul = 184.92065283411125
init E= -504.437787046246
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.674540069553559  LUMO = 8.8166524647446
  mo_energy =
[-1.21701799e+02 -1.33867812e+01 -7.62741730e+00 -7.62741730e+00
 -7.62741730e+00 -1.63990902e+00 -6.74540070e-01 -6.74540070e-01
 -6.74540070e-01  8.81665246e+00  9.86272677e+01  5.26363615e+02
  2.35521574e+03  1.15387505e+04  4.11231032e+04  1.09973281e+05
  2.54170041e+05  5.48597341e+05  1.15254251e+06  2.43032253e+06
  5.37505448e+06]
E1 = -707.0715902092569  E_coul = 199.1418687397592
cycle= 1 E= -507.929721469498  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593707
diis-c [-0.35248767  1.        ]
  HOMO = -0.232879445421819  LUMO = 9.71436525767793
  mo_energy =
[-1.20251545e+02 -1.23503430e+01 -6.64514745e+00 -6.64514745e+00
 -6.64514745e+00 -1.16112988e+00 -2.32879445e-01 -2.32879445e-01
 -2.32879445e-01  9.71436526e+00  9.99610904e+01  5.27799299e+02
  2.35659504e+03  1.15400072e+04  4.11242877e+04  1.09974426e+05
  2.54171159e+05  5.48598439e+05  1.15254359e+06  2.43032360e+06
  5.37505555e+06]
E1 = -706.7063798825254  E_coul = 198.77003755678064
cycle= 2 E= -507.936342325745  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155256
diis-c [-2.33673002e-04  4.55401532e-03  9.95445985e-01]
  HOMO = -0.237558923983108  LUMO = 9.70336805288304
  mo_energy =
[-1.20310619e+02 -1.23736022e+01 -6.67396220e+00 -6.67396220e+00
 -6.67396220e+00 -1.16352636e+00 -2.37558924e-01 -2.37558924e-01
 -2.37558924e-01  9.70336805e+00  9.99179825e+01  5.27738439e+02
  2.35652080e+03  1.15399236e+04  4.11242009e+04  1.09974338e+05
  2.54171071e+05  5.48598350e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.6909106015681  E_coul = 198.75455512572773
cycle= 3 E= -507.93635547584  delta_E= -1.32e-05  |g|= 0.000911  |ddm|= 0.00931
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756706
diis-c [-1.62702316e-08  4.49846875e-05 -5.01653988e-02  1.05012041e+00]
  HOMO = -0.237800796187904  LUMO = 9.70281191725697
  mo_energy =
[-1.20313303e+02 -1.23747733e+01 -6.67538532e+00 -6.67538532e+00
 -6.67538532e+00 -1.16364521e+00 -2.37800796e-01 -2.37800796e-01
 -2.37800796e-01  9.70281192e+00  9.99159442e+01  5.27735731e+02
  2.35651769e+03  1.15399202e+04  4.11241974e+04  1.09974335e+05
  2.54171067e+05  5.48598347e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.690120213188  E_coul = 198.7537647031782
cycle= 4 E= -507.93635551001  delta_E= -3.42e-08  |g|= 7.36e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.30122e-06
diis-c [-5.51684171e-12 -1.97455752e-06  2.42671166e-03 -4.84967195e-02
  1.04607198e+00]
  HOMO = -0.23780184046299  LUMO = 9.70281062444499
  mo_energy =
[-1.20313302e+02 -1.23747770e+01 -6.67538814e+00 -6.67538814e+00
 -6.67538814e+00 -1.16364580e+00 -2.37801840e-01 -2.37801840e-01
 -2.37801840e-01  9.70281062e+00  9.99159430e+01  5.27735732e+02
  2.35651769e+03  1.15399202e+04  4.11241974e+04  1.09974335e+05
  2.54171067e+05  5.48598347e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.6901183054732  E_coul = 198.75376279546134
cycle= 5 E= -507.936355510012  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.87e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6901183054732  E_coul = 198.75376279546134
  HOMO = -0.237801876520381  LUMO = 9.70281055430985
  mo_energy =
[-1.20313303e+02 -1.23747772e+01 -6.67538832e+00 -6.67538832e+00
 -6.67538832e+00 -1.16364581e+00 -2.37801877e-01 -2.37801877e-01
 -2.37801877e-01  9.70281055e+00  9.99159428e+01  5.27735732e+02
  2.35651769e+03  1.15399202e+04  4.11241974e+04  1.09974335e+05
  2.54171067e+05  5.48598347e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.690118205749  E_coul = 198.7537626957373
Extra cycle  E= -507.936355510012  delta_E= 2.27e-13  |g|= 7.81e-09  |ddm|= 7.81e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [3.96701675e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552268e+04 7.33138395e+03
 1.83771427e+04 1.23684088e+03 3.22228937e+02 1.02104182e+02
 3.54733289e+01 7.96023025e+00 3.14465315e+00 8.60462968e+00
 4.93069777e-01]
E = -507.93635551001165
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396701675364       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035587        1
[INPUT] 0    0    [1    /1   ]  147021.017444        1
[INPUT] 0    0    [1    /1   ]  73510.5067312        1
[INPUT] 0    0    [1    /1   ]  36755.2268058        1
[INPUT] 0    0    [1    /1   ]  7331.38394638        1
[INPUT] 0    0    [1    /1   ]  18377.1426538        1
[INPUT] 0    0    [1    /1   ]  1236.84088382        1
[INPUT] 0    0    [1    /1   ]  322.228936517        1
[INPUT] 0    0    [1    /1   ]  102.104181586        1
[INPUT] 0    0    [1    /1   ]  35.4733288548        1
[INPUT] 0    0    [1    /1   ]  7.96023025067        1
[INPUT] 0    0    [1    /1   ]  3.14465315341        1
[INPUT] 1    0    [1    /1   ]  8.60462967521        1
[INPUT] 1    0    [1    /1   ]  0.493069777022       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39670167536410916, 1.0]], [0, [1176168.1426076333, 1.0]], [0, [588084.0712839431, 1.0]], [0, [294042.03558740043, 1.0]], [0, [147021.01744402922, 1.0]], [0, [73510.50673116047, 1.0]], [0, [36755.22680580255, 1.0]], [0, [7331.383946377812, 1.0]], [0, [18377.14265377343, 1.0]], [0, [1236.8408838199553, 1.0]], [0, [322.22893651678993, 1.0]], [0, [102.10418158640134, 1.0]], [0, [35.47332885476285, 1.0]], [0, [7.960230250674396, 1.0]], [0, [3.1446531534078366, 1.0]], [1, [8.604629675210425, 1.0]], [1, [0.49306977702237625, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39670168]
bas 1, expnt(s) = [1176168.14260763]
bas 2, expnt(s) = [588084.07128394]
bas 3, expnt(s) = [294042.0355874]
bas 4, expnt(s) = [147021.01744403]
bas 5, expnt(s) = [73510.50673116]
bas 6, expnt(s) = [36755.2268058]
bas 7, expnt(s) = [7331.38394638]
bas 8, expnt(s) = [18377.14265377]
bas 9, expnt(s) = [1236.84088382]
bas 10, expnt(s) = [322.22893652]
bas 11, expnt(s) = [102.10418159]
bas 12, expnt(s) = [35.47332885]
bas 13, expnt(s) = [7.96023025]
bas 14, expnt(s) = [3.14465315]
bas 15, expnt(s) = [8.60462968]
bas 16, expnt(s) = [0.49306978]
CPU time:      1216.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96701675e-01 1.26288281e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791686e+04
 3.67552268e+04 6.70663011e+03 7.33138395e+03 2.00172539e+03
 1.83771427e+04 3.98770951e+03 1.23684088e+03 5.26926934e+02
 3.22228937e+02 1.92149132e+02 1.02104182e+02 8.11517091e+01
 3.54733289e+01 3.67232816e+01 7.96023025e+00 1.19731727e+01
 3.14465315e+00 5.96615576e+00 8.60462968e+00 4.29931853e+01
 4.93069777e-01 1.20536859e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32508629785082
cond(S) = 12561.4452580582
E1 = -689.3584398803575  E_coul = 184.92065283411125
init E= -504.437787046246
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674540069553559  LUMO = 8.8166524647446
  mo_energy =
[-1.21701799e+02 -1.33867812e+01 -7.62741730e+00 -7.62741730e+00
 -7.62741730e+00 -1.63990902e+00 -6.74540070e-01 -6.74540070e-01
 -6.74540070e-01  8.81665246e+00  9.86272677e+01  5.26363615e+02
  2.35521574e+03  1.15387505e+04  4.11231032e+04  1.09973281e+05
  2.54170041e+05  5.48597341e+05  1.15254251e+06  2.43032253e+06
  5.37505448e+06]
E1 = -707.0715902092569  E_coul = 199.1418687397592
cycle= 1 E= -507.929721469498  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593707
diis-c [-0.35248767  1.        ]
  HOMO = -0.232879445421819  LUMO = 9.71436525767793
  mo_energy =
[-1.20251545e+02 -1.23503430e+01 -6.64514745e+00 -6.64514745e+00
 -6.64514745e+00 -1.16112988e+00 -2.32879445e-01 -2.32879445e-01
 -2.32879445e-01  9.71436526e+00  9.99610904e+01  5.27799299e+02
  2.35659504e+03  1.15400072e+04  4.11242877e+04  1.09974426e+05
  2.54171159e+05  5.48598439e+05  1.15254359e+06  2.43032360e+06
  5.37505555e+06]
E1 = -706.7063798825254  E_coul = 198.77003755678064
cycle= 2 E= -507.936342325745  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155256
diis-c [-2.33673002e-04  4.55401532e-03  9.95445985e-01]
  HOMO = -0.237558923983108  LUMO = 9.70336805288304
  mo_energy =
[-1.20310619e+02 -1.23736022e+01 -6.67396220e+00 -6.67396220e+00
 -6.67396220e+00 -1.16352636e+00 -2.37558924e-01 -2.37558924e-01
 -2.37558924e-01  9.70336805e+00  9.99179825e+01  5.27738439e+02
  2.35652080e+03  1.15399236e+04  4.11242009e+04  1.09974338e+05
  2.54171071e+05  5.48598350e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.6909106015681  E_coul = 198.75455512572773
cycle= 3 E= -507.93635547584  delta_E= -1.32e-05  |g|= 0.000911  |ddm|= 0.00931
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756706
diis-c [-1.62702316e-08  4.49846875e-05 -5.01653988e-02  1.05012041e+00]
  HOMO = -0.237800796187904  LUMO = 9.70281191725697
  mo_energy =
[-1.20313303e+02 -1.23747733e+01 -6.67538532e+00 -6.67538532e+00
 -6.67538532e+00 -1.16364521e+00 -2.37800796e-01 -2.37800796e-01
 -2.37800796e-01  9.70281192e+00  9.99159442e+01  5.27735731e+02
  2.35651769e+03  1.15399202e+04  4.11241974e+04  1.09974335e+05
  2.54171067e+05  5.48598347e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.690120213188  E_coul = 198.7537647031782
cycle= 4 E= -507.93635551001  delta_E= -3.42e-08  |g|= 7.36e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.30122e-06
diis-c [-5.51684171e-12 -1.97455752e-06  2.42671166e-03 -4.84967195e-02
  1.04607198e+00]
  HOMO = -0.23780184046299  LUMO = 9.70281062444499
  mo_energy =
[-1.20313302e+02 -1.23747770e+01 -6.67538814e+00 -6.67538814e+00
 -6.67538814e+00 -1.16364580e+00 -2.37801840e-01 -2.37801840e-01
 -2.37801840e-01  9.70281062e+00  9.99159430e+01  5.27735732e+02
  2.35651769e+03  1.15399202e+04  4.11241974e+04  1.09974335e+05
  2.54171067e+05  5.48598347e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.6901183054732  E_coul = 198.75376279546134
cycle= 5 E= -507.936355510012  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.87e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6901183054732  E_coul = 198.75376279546134
  HOMO = -0.237801876520381  LUMO = 9.70281055430985
  mo_energy =
[-1.20313303e+02 -1.23747772e+01 -6.67538832e+00 -6.67538832e+00
 -6.67538832e+00 -1.16364581e+00 -2.37801877e-01 -2.37801877e-01
 -2.37801877e-01  9.70281055e+00  9.99159428e+01  5.27735732e+02
  2.35651769e+03  1.15399202e+04  4.11241974e+04  1.09974335e+05
  2.54171067e+05  5.48598347e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.690118205749  E_coul = 198.7537626957373
Extra cycle  E= -507.936355510012  delta_E= 2.27e-13  |g|= 7.81e-09  |ddm|= 7.81e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.4452580582
E1 = -706.690118205749  E_coul = 198.7537626957373
init E= -507.936355510012
    CPU time for initialize scf      4.42 sec, wall time      0.30 sec
  HOMO = -0.237801878266983  LUMO = 9.70281055063994
  mo_energy =
[-1.20313303e+02 -1.23747772e+01 -6.67538833e+00 -6.67538833e+00
 -6.67538833e+00 -1.16364582e+00 -2.37801878e-01 -2.37801878e-01
 -2.37801878e-01  9.70281055e+00  9.99159428e+01  5.27735732e+02
  2.35651769e+03  1.15399202e+04  4.11241974e+04  1.09974335e+05
  2.54171067e+05  5.48598347e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.6901182011381  E_coul = 198.75376269112644
cycle= 1 E= -507.936355510012  delta_E= -5.68e-14  |g|= 7.76e-10  |ddm|= 3.96e-09
    CPU time for cycle= 1      0.14 sec, wall time      0.02 sec
E1 = -706.6901182011381  E_coul = 198.75376269112644
  HOMO = -0.237801878354538  LUMO = 9.70281054939082
  mo_energy =
[-1.20313303e+02 -1.23747772e+01 -6.67538833e+00 -6.67538833e+00
 -6.67538833e+00 -1.16364582e+00 -2.37801878e-01 -2.37801878e-01
 -2.37801878e-01  9.70281055e+00  9.99159428e+01  5.27735732e+02
  2.35651769e+03  1.15399202e+04  4.11241974e+04  1.09974335e+05
  2.54171067e+05  5.48598347e+05  1.15254350e+06  2.43032351e+06
  5.37505546e+06]
E1 = -706.6901182009037  E_coul = 198.75376269089196
Extra cycle  E= -507.936355510012  delta_E= -5.68e-14  |g|= 8.04e-10  |ddm|= 2.1e-10
    CPU time for scf_cycle      4.63 sec, wall time      0.37 sec
exp = [3.96701675e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552268e+04 7.33138395e+03
 1.83771427e+04 1.23684088e+03 3.22228937e+02 1.02104182e+02
 3.54733289e+01 7.96023025e+00 3.14465315e+00 8.60462968e+00
 4.93069777e-01]
grad_E = [ 3.75741267e-04 -3.75097112e-12  5.15949219e-10  1.78155680e-09
  1.01030815e-08  3.42886365e-08  2.02369414e-07  1.11465589e-05
  5.33464418e-07 -8.92876443e-05  5.56308904e-07 -4.49018748e-07
 -3.25423445e-05  1.44563845e-05 -8.60851585e-05  3.08434708e-04
  5.00565204e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396717834456       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035586        1
[INPUT] 0    0    [1    /1   ]  147021.017435        1
[INPUT] 0    0    [1    /1   ]  73510.5067022        1
[INPUT] 0    0    [1    /1   ]  36755.2266325        1
[INPUT] 0    0    [1    /1   ]  7331.3744304         1
[INPUT] 0    0    [1    /1   ]  18377.142209         1
[INPUT] 0    0    [1    /1   ]  1236.87577986        1
[INPUT] 0    0    [1    /1   ]  322.427610181        1
[INPUT] 0    0    [1    /1   ]  102.146399959        1
[INPUT] 0    0    [1    /1   ]  35.472613658         1
[INPUT] 0    0    [1    /1   ]  7.95930118948        1
[INPUT] 0    0    [1    /1   ]  3.14399265945        1
[INPUT] 1    0    [1    /1   ]  8.60485183035        1
[INPUT] 1    0    [1    /1   ]  0.493082711743       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39671783445613235, 1.0]], [0, [1176168.142607644, 1.0]], [0, [588084.071283503, 1.0]], [0, [294042.0355858987, 1.0]], [0, [147021.01743538288, 1.0]], [0, [73510.50670219203, 1.0]], [0, [36755.22663246598, 1.0]], [0, [7331.374430399568, 1.0]], [0, [18377.14220902335, 1.0]], [0, [1236.875779858446, 1.0]], [0, [322.42761018108445, 1.0]], [0, [102.14639995878957, 1.0]], [0, [35.47261365804515, 1.0]], [0, [7.959301189483901, 1.0]], [0, [3.1439926594468313, 1.0]], [1, [8.604851830352853, 1.0]], [1, [0.4930827117434214, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39671783]
bas 1, expnt(s) = [1176168.14260764]
bas 2, expnt(s) = [588084.0712835]
bas 3, expnt(s) = [294042.0355859]
bas 4, expnt(s) = [147021.01743538]
bas 5, expnt(s) = [73510.50670219]
bas 6, expnt(s) = [36755.22663247]
bas 7, expnt(s) = [7331.3744304]
bas 8, expnt(s) = [18377.14220902]
bas 9, expnt(s) = [1236.87577986]
bas 10, expnt(s) = [322.42761018]
bas 11, expnt(s) = [102.14639996]
bas 12, expnt(s) = [35.47261366]
bas 13, expnt(s) = [7.95930119]
bas 14, expnt(s) = [3.14399266]
bas 15, expnt(s) = [8.60485183]
bas 16, expnt(s) = [0.49308271]
CPU time:      1224.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96717834e-01 1.26292139e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791685e+04
 3.67552266e+04 6.70663009e+03 7.33137443e+03 2.00172344e+03
 1.83771422e+04 3.98770944e+03 1.23687578e+03 5.26938084e+02
 3.22427610e+02 1.92237979e+02 1.02146400e+02 8.11768739e+01
 3.54726137e+01 3.67227263e+01 7.95930119e+00 1.19721246e+01
 3.14399266e+00 5.96521590e+00 8.60485183e+00 4.29945728e+01
 4.93082712e-01 1.20540812e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325066873834654
cond(S) = 12561.637560816851
E1 = -689.359659972714  E_coul = 184.92216176320775
init E= -504.437498209506
    CPU time for initialize scf      4.48 sec, wall time      0.34 sec
  HOMO = -0.674523526677407  LUMO = 8.81416292955559
  mo_energy =
[-1.21701547e+02 -1.33866616e+01 -7.62731444e+00 -7.62731444e+00
 -7.62731444e+00 -1.63989056e+00 -6.74523527e-01 -6.74523527e-01
 -6.74523527e-01  8.81416293e+00  9.86365761e+01  5.26603224e+02
  2.35594851e+03  1.15396814e+04  4.11240107e+04  1.09974153e+05
  2.54170884e+05  5.48598158e+05  1.15254330e+06  2.43032330e+06
  5.37505523e+06]
E1 = -707.0734865256468  E_coul = 199.14376475816644
cycle= 1 E= -507.92972176748  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.593698
diis-c [-0.35247761  1.        ]
  HOMO = -0.232844043070137  LUMO = 9.71183381537094
  mo_energy =
[-1.20251273e+02 -1.23501975e+01 -6.64501791e+00 -6.64501791e+00
 -6.64501791e+00 -1.16109523e+00 -2.32844043e-01 -2.32844043e-01
 -2.32844043e-01  9.71183382e+00  9.99704531e+01  5.28038926e+02
  2.35732781e+03  1.15409381e+04  4.11251952e+04  1.09975298e+05
  2.54172002e+05  5.48599257e+05  1.15254439e+06  2.43032437e+06
  5.37505630e+06]
E1 = -706.7081756228586  E_coul = 198.77183089106563
cycle= 2 E= -507.936344731793  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155278
diis-c [-2.33743212e-04  4.55337568e-03  9.95446624e-01]
  HOMO = -0.237525430960109  LUMO = 9.70083482503165
  mo_energy =
[-1.20310360e+02 -1.23734636e+01 -6.67384091e+00 -6.67384091e+00
 -6.67384091e+00 -1.16349275e+00 -2.37525431e-01 -2.37525431e-01
 -2.37525431e-01  9.70083483e+00  9.99273320e+01  5.27978047e+02
  2.35725356e+03  1.15408545e+04  4.11251083e+04  1.09975210e+05
  2.54171913e+05  5.48599168e+05  1.15254430e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6926999516998  E_coul = 198.7563420616871
cycle= 3 E= -507.936357890013  delta_E= -1.32e-05  |g|= 0.000911  |ddm|= 0.00931
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756854
diis-c [-1.62964979e-08  4.50149006e-05 -5.01672978e-02  1.05012228e+00]
  HOMO = -0.23776743377698  LUMO = 9.70027852828383
  mo_energy =
[-1.20313045e+02 -1.23746353e+01 -6.67526460e+00 -6.67526460e+00
 -6.67526460e+00 -1.16361166e+00 -2.37767434e-01 -2.37767434e-01
 -2.37767434e-01  9.70027853e+00  9.99252929e+01  5.27975338e+02
  2.35725045e+03  1.15408511e+04  4.11251049e+04  1.09975206e+05
  2.54171910e+05  5.48599164e+05  1.15254429e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6919091365857  E_coul = 198.7555512123725
cycle= 4 E= -507.936357924213  delta_E= -3.42e-08  |g|= 7.37e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.308e-06
diis-c [-5.52013598e-12 -1.97744559e-06  2.42798621e-03 -4.85221884e-02
  1.04609618e+00]
  HOMO = -0.23776848010316  LUMO = 9.70027723163942
  mo_energy =
[-1.20313044e+02 -1.23746390e+01 -6.67526743e+00 -6.67526743e+00
 -6.67526743e+00 -1.16361225e+00 -2.37768480e-01 -2.37768480e-01
 -2.37768480e-01  9.70027723e+00  9.99252917e+01  5.27975339e+02
  2.35725045e+03  1.15408511e+04  4.11251049e+04  1.09975206e+05
  2.54171910e+05  5.48599164e+05  1.15254429e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6919072234597  E_coul = 198.75554929924414
cycle= 5 E= -507.936357924216  delta_E= -2.39e-12  |g|= 1.48e-07  |ddm|= 2.88e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6919072234597  E_coul = 198.75554929924414
  HOMO = -0.237768516171413  LUMO = 9.70027716115316
  mo_energy =
[-1.20313045e+02 -1.23746391e+01 -6.67526761e+00 -6.67526761e+00
 -6.67526761e+00 -1.16361227e+00 -2.37768516e-01 -2.37768516e-01
 -2.37768516e-01  9.70027716e+00  9.99252915e+01  5.27975339e+02
  2.35725045e+03  1.15408511e+04  4.11251049e+04  1.09975206e+05
  2.54171910e+05  5.48599164e+05  1.15254429e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6919071237008  E_coul = 198.75554919948584
Extra cycle  E= -507.936357924215  delta_E= 5.12e-13  |g|= 7.81e-09  |ddm|= 7.81e-08
    CPU time for scf_cycle      4.73 sec, wall time      0.41 sec
exp = [3.96717834e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552266e+04 7.33137443e+03
 1.83771422e+04 1.23687578e+03 3.22427610e+02 1.02146400e+02
 3.54726137e+01 7.95930119e+00 3.14399266e+00 8.60485183e+00
 4.93082712e-01]
E = -507.93635792421503
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396717834456       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071284        1
[INPUT] 0    0    [1    /1   ]  294042.035586        1
[INPUT] 0    0    [1    /1   ]  147021.017435        1
[INPUT] 0    0    [1    /1   ]  73510.5067022        1
[INPUT] 0    0    [1    /1   ]  36755.2266325        1
[INPUT] 0    0    [1    /1   ]  7331.3744304         1
[INPUT] 0    0    [1    /1   ]  18377.142209         1
[INPUT] 0    0    [1    /1   ]  1236.87577986        1
[INPUT] 0    0    [1    /1   ]  322.427610181        1
[INPUT] 0    0    [1    /1   ]  102.146399959        1
[INPUT] 0    0    [1    /1   ]  35.472613658         1
[INPUT] 0    0    [1    /1   ]  7.95930118948        1
[INPUT] 0    0    [1    /1   ]  3.14399265945        1
[INPUT] 1    0    [1    /1   ]  8.60485183035        1
[INPUT] 1    0    [1    /1   ]  0.493082711743       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39671783445613235, 1.0]], [0, [1176168.142607644, 1.0]], [0, [588084.071283503, 1.0]], [0, [294042.0355858987, 1.0]], [0, [147021.01743538288, 1.0]], [0, [73510.50670219203, 1.0]], [0, [36755.22663246598, 1.0]], [0, [7331.374430399568, 1.0]], [0, [18377.14220902335, 1.0]], [0, [1236.875779858446, 1.0]], [0, [322.42761018108445, 1.0]], [0, [102.14639995878957, 1.0]], [0, [35.47261365804515, 1.0]], [0, [7.959301189483901, 1.0]], [0, [3.1439926594468313, 1.0]], [1, [8.604851830352853, 1.0]], [1, [0.4930827117434214, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39671783]
bas 1, expnt(s) = [1176168.14260764]
bas 2, expnt(s) = [588084.0712835]
bas 3, expnt(s) = [294042.0355859]
bas 4, expnt(s) = [147021.01743538]
bas 5, expnt(s) = [73510.50670219]
bas 6, expnt(s) = [36755.22663247]
bas 7, expnt(s) = [7331.3744304]
bas 8, expnt(s) = [18377.14220902]
bas 9, expnt(s) = [1236.87577986]
bas 10, expnt(s) = [322.42761018]
bas 11, expnt(s) = [102.14639996]
bas 12, expnt(s) = [35.47261366]
bas 13, expnt(s) = [7.95930119]
bas 14, expnt(s) = [3.14399266]
bas 15, expnt(s) = [8.60485183]
bas 16, expnt(s) = [0.49308271]
CPU time:      1228.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96717834e-01 1.26292139e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105067e+04 1.12791685e+04
 3.67552266e+04 6.70663009e+03 7.33137443e+03 2.00172344e+03
 1.83771422e+04 3.98770944e+03 1.23687578e+03 5.26938084e+02
 3.22427610e+02 1.92237979e+02 1.02146400e+02 8.11768739e+01
 3.54726137e+01 3.67227263e+01 7.95930119e+00 1.19721246e+01
 3.14399266e+00 5.96521590e+00 8.60485183e+00 4.29945728e+01
 4.93082712e-01 1.20540812e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325066873834654
cond(S) = 12561.637560816851
E1 = -689.359659972714  E_coul = 184.92216176320775
init E= -504.437498209506
    CPU time for initialize scf      4.52 sec, wall time      0.34 sec
  HOMO = -0.674523526677407  LUMO = 8.81416292955559
  mo_energy =
[-1.21701547e+02 -1.33866616e+01 -7.62731444e+00 -7.62731444e+00
 -7.62731444e+00 -1.63989056e+00 -6.74523527e-01 -6.74523527e-01
 -6.74523527e-01  8.81416293e+00  9.86365761e+01  5.26603224e+02
  2.35594851e+03  1.15396814e+04  4.11240107e+04  1.09974153e+05
  2.54170884e+05  5.48598158e+05  1.15254330e+06  2.43032330e+06
  5.37505523e+06]
E1 = -707.0734865256468  E_coul = 199.14376475816644
cycle= 1 E= -507.92972176748  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.593698
diis-c [-0.35247761  1.        ]
  HOMO = -0.232844043070137  LUMO = 9.71183381537094
  mo_energy =
[-1.20251273e+02 -1.23501975e+01 -6.64501791e+00 -6.64501791e+00
 -6.64501791e+00 -1.16109523e+00 -2.32844043e-01 -2.32844043e-01
 -2.32844043e-01  9.71183382e+00  9.99704531e+01  5.28038926e+02
  2.35732781e+03  1.15409381e+04  4.11251952e+04  1.09975298e+05
  2.54172002e+05  5.48599257e+05  1.15254439e+06  2.43032437e+06
  5.37505630e+06]
E1 = -706.7081756228586  E_coul = 198.77183089106563
cycle= 2 E= -507.936344731793  delta_E= -0.00662  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155278
diis-c [-2.33743212e-04  4.55337568e-03  9.95446624e-01]
  HOMO = -0.237525430960109  LUMO = 9.70083482503165
  mo_energy =
[-1.20310360e+02 -1.23734636e+01 -6.67384091e+00 -6.67384091e+00
 -6.67384091e+00 -1.16349275e+00 -2.37525431e-01 -2.37525431e-01
 -2.37525431e-01  9.70083483e+00  9.99273320e+01  5.27978047e+02
  2.35725356e+03  1.15408545e+04  4.11251083e+04  1.09975210e+05
  2.54171913e+05  5.48599168e+05  1.15254430e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6926999516998  E_coul = 198.7563420616871
cycle= 3 E= -507.936357890013  delta_E= -1.32e-05  |g|= 0.000911  |ddm|= 0.00931
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000756854
diis-c [-1.62964979e-08  4.50149006e-05 -5.01672978e-02  1.05012228e+00]
  HOMO = -0.23776743377698  LUMO = 9.70027852828383
  mo_energy =
[-1.20313045e+02 -1.23746353e+01 -6.67526460e+00 -6.67526460e+00
 -6.67526460e+00 -1.16361166e+00 -2.37767434e-01 -2.37767434e-01
 -2.37767434e-01  9.70027853e+00  9.99252929e+01  5.27975338e+02
  2.35725045e+03  1.15408511e+04  4.11251049e+04  1.09975206e+05
  2.54171910e+05  5.48599164e+05  1.15254429e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6919091365857  E_coul = 198.7555512123725
cycle= 4 E= -507.936357924213  delta_E= -3.42e-08  |g|= 7.37e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.308e-06
diis-c [-5.52013598e-12 -1.97744559e-06  2.42798621e-03 -4.85221884e-02
  1.04609618e+00]
  HOMO = -0.23776848010316  LUMO = 9.70027723163942
  mo_energy =
[-1.20313044e+02 -1.23746390e+01 -6.67526743e+00 -6.67526743e+00
 -6.67526743e+00 -1.16361225e+00 -2.37768480e-01 -2.37768480e-01
 -2.37768480e-01  9.70027723e+00  9.99252917e+01  5.27975339e+02
  2.35725045e+03  1.15408511e+04  4.11251049e+04  1.09975206e+05
  2.54171910e+05  5.48599164e+05  1.15254429e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6919072234597  E_coul = 198.75554929924414
cycle= 5 E= -507.936357924216  delta_E= -2.39e-12  |g|= 1.48e-07  |ddm|= 2.88e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6919072234597  E_coul = 198.75554929924414
  HOMO = -0.237768516171413  LUMO = 9.70027716115316
  mo_energy =
[-1.20313045e+02 -1.23746391e+01 -6.67526761e+00 -6.67526761e+00
 -6.67526761e+00 -1.16361227e+00 -2.37768516e-01 -2.37768516e-01
 -2.37768516e-01  9.70027716e+00  9.99252915e+01  5.27975339e+02
  2.35725045e+03  1.15408511e+04  4.11251049e+04  1.09975206e+05
  2.54171910e+05  5.48599164e+05  1.15254429e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6919071237008  E_coul = 198.75554919948584
Extra cycle  E= -507.936357924215  delta_E= 5.12e-13  |g|= 7.81e-09  |ddm|= 7.81e-08
    CPU time for scf_cycle      4.76 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.637560816851
E1 = -706.6919071237008  E_coul = 198.75554919948584
init E= -507.936357924215
    CPU time for initialize scf      9.77 sec, wall time      0.71 sec
  HOMO = -0.237768517918795  LUMO = 9.70027715778265
  mo_energy =
[-1.20313045e+02 -1.23746391e+01 -6.67526762e+00 -6.67526762e+00
 -6.67526762e+00 -1.16361227e+00 -2.37768518e-01 -2.37768518e-01
 -2.37768518e-01  9.70027716e+00  9.99252915e+01  5.27975339e+02
  2.35725045e+03  1.15408511e+04  4.11251049e+04  1.09975206e+05
  2.54171910e+05  5.48599164e+05  1.15254429e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6919071191546  E_coul = 198.75554919493973
cycle= 1 E= -507.936357924215  delta_E= 1.14e-13  |g|= 1.25e-09  |ddm|= 3.96e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.6919071191546  E_coul = 198.75554919493973
  HOMO = -0.237768518006128  LUMO = 9.70027715786421
  mo_energy =
[-1.20313045e+02 -1.23746391e+01 -6.67526762e+00 -6.67526762e+00
 -6.67526762e+00 -1.16361227e+00 -2.37768518e-01 -2.37768518e-01
 -2.37768518e-01  9.70027716e+00  9.99252915e+01  5.27975339e+02
  2.35725045e+03  1.15408511e+04  4.11251049e+04  1.09975206e+05
  2.54171910e+05  5.48599164e+05  1.15254429e+06  2.43032428e+06
  5.37505621e+06]
E1 = -706.6919071189161  E_coul = 198.75554919470127
Extra cycle  E= -507.936357924215  delta_E= 1.14e-13  |g|= 1.23e-09  |ddm|= 2.12e-10
    CPU time for scf_cycle      9.85 sec, wall time      0.78 sec
exp = [3.96717834e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105067e+04 3.67552266e+04 7.33137443e+03
 1.83771422e+04 1.23687578e+03 3.22427610e+02 1.02146400e+02
 3.54726137e+01 7.95930119e+00 3.14399266e+00 8.60485183e+00
 4.93082712e-01]
grad_E = [ 5.86152259e-04 -3.57726127e-12  5.17045613e-10  1.78580478e-09
  1.01238742e-08  3.43688758e-08  2.02781855e-07  1.11697026e-05
  5.34869079e-07 -9.04313102e-05  6.40793632e-06 -2.01073239e-06
 -5.17115300e-05  2.30089299e-05 -1.31220458e-04  4.77967675e-04
  7.65265251e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396743779029       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071282        1
[INPUT] 0    0    [1    /1   ]  294042.035582        1
[INPUT] 0    0    [1    /1   ]  147021.017415        1
[INPUT] 0    0    [1    /1   ]  73510.5066337        1
[INPUT] 0    0    [1    /1   ]  36755.2262242        1
[INPUT] 0    0    [1    /1   ]  7331.35199408        1
[INPUT] 0    0    [1    /1   ]  18377.1411535        1
[INPUT] 0    0    [1    /1   ]  1236.9852756         1
[INPUT] 0    0    [1    /1   ]  322.765351048        1
[INPUT] 0    0    [1    /1   ]  102.21884836         1
[INPUT] 0    0    [1    /1   ]  35.4724594953        1
[INPUT] 0    0    [1    /1   ]  7.9578620282         1
[INPUT] 0    0    [1    /1   ]  3.14295582997        1
[INPUT] 1    0    [1    /1   ]  8.60520807312        1
[INPUT] 1    0    [1    /1   ]  0.493103449979       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3967437790291523, 1.0]], [0, [1176168.1426076642, 1.0]], [0, [588084.0712824651, 1.0]], [0, [294042.03558234544, 1.0]], [0, [147021.0174150113, 1.0]], [0, [73510.50663369412, 1.0]], [0, [36755.22622416457, 1.0]], [0, [7331.351994084191, 1.0]], [0, [18377.14115345309, 1.0]], [0, [1236.985275597812, 1.0]], [0, [322.7653510475757, 1.0]], [0, [102.21884835982831, 1.0]], [0, [35.47245949529828, 1.0]], [0, [7.957862028198436, 1.0]], [0, [3.1429558299700866, 1.0]], [1, [8.605208073116279, 1.0]], [1, [0.4931034499787168, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39674378]
bas 1, expnt(s) = [1176168.14260766]
bas 2, expnt(s) = [588084.07128247]
bas 3, expnt(s) = [294042.03558235]
bas 4, expnt(s) = [147021.01741501]
bas 5, expnt(s) = [73510.50663369]
bas 6, expnt(s) = [36755.22622416]
bas 7, expnt(s) = [7331.35199408]
bas 8, expnt(s) = [18377.14115345]
bas 9, expnt(s) = [1236.9852756]
bas 10, expnt(s) = [322.76535105]
bas 11, expnt(s) = [102.21884836]
bas 12, expnt(s) = [35.4724595]
bas 13, expnt(s) = [7.95786203]
bas 14, expnt(s) = [3.14295583]
bas 15, expnt(s) = [8.60520807]
bas 16, expnt(s) = [0.49310345]
CPU time:      1246.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96743779e-01 1.26298333e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105066e+04 1.12791685e+04
 3.67552262e+04 6.70663003e+03 7.33135199e+03 2.00171884e+03
 1.83771412e+04 3.98770927e+03 1.23698528e+03 5.26973070e+02
 3.22765351e+02 1.92388985e+02 1.02218848e+02 8.12200518e+01
 3.54724595e+01 3.67226066e+01 7.95786203e+00 1.19705010e+01
 3.14295583e+00 5.96374043e+00 8.60520807e+00 4.29967978e+01
 4.93103450e-01 1.20547149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32503567802326
cond(S) = 12561.99729848442
E1 = -689.3616229689992  E_coul = 184.9245797373848
init E= -504.437043231614
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.674497046187335  LUMO = 8.81031302015298
  mo_energy =
[-1.21701146e+02 -1.33864698e+01 -7.62714962e+00 -7.62714962e+00
 -7.62714962e+00 -1.63986103e+00 -6.74497046e-01 -6.74497046e-01
 -6.74497046e-01  8.81031302e+00  9.86555981e+01  5.27017365e+02
  2.35724842e+03  1.15414151e+04  4.11257219e+04  1.09975798e+05
  2.54172473e+05  5.48599700e+05  1.15254480e+06  2.43032476e+06
  5.37505664e+06]
E1 = -707.0765280586162  E_coul = 199.14680326797418
cycle= 1 E= -507.929724790642  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593681
diis-c [-0.35245771  1.        ]
  HOMO = -0.232787305235533  LUMO = 9.70792134345457
  mo_energy =
[-1.20250838e+02 -1.23499642e+01 -6.64481037e+00 -6.64481037e+00
 -6.64481037e+00 -1.16103975e+00 -2.32787305e-01 -2.32787305e-01
 -2.32787305e-01  9.70792134e+00  9.99895690e+01  5.28453098e+02
  2.35862771e+03  1.15426719e+04  4.11269064e+04  1.09976944e+05
  2.54173591e+05  5.48600799e+05  1.15254589e+06  2.43032583e+06
  5.37505771e+06]
E1 = -706.711060171611  E_coul = 198.7747091253129
cycle= 2 E= -507.936351046298  delta_E= -0.00663  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155312
diis-c [-2.33852597e-04  4.55247729e-03  9.95447523e-01]
  HOMO = -0.237471669513876  LUMO = 9.69691951080405
  mo_energy =
[-1.20309946e+02 -1.23732413e+01 -6.67364624e+00 -6.67364624e+00
 -6.67364624e+00 -1.16343887e+00 -2.37471670e-01 -2.37471670e-01
 -2.37471670e-01  9.69691951e+00  9.99464266e+01  5.28392189e+02
  2.35855344e+03  1.15425882e+04  4.11268195e+04  1.09976855e+05
  2.54173503e+05  5.48600710e+05  1.15254580e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.6955745689309  E_coul = 198.75921035180752
cycle= 3 E= -507.936364217123  delta_E= -1.32e-05  |g|= 0.000912  |ddm|= 0.00932
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757079
diis-c [-1.63380624e-08  4.50350936e-05 -5.01699729e-02  1.05012494e+00]
  HOMO = -0.237713875876502  LUMO = 9.69636295958825
  mo_energy =
[-1.20312631e+02 -1.23744137e+01 -6.67507080e+00 -6.67507080e+00
 -6.67507080e+00 -1.16355789e+00 -2.37713876e-01 -2.37713876e-01
 -2.37713876e-01  9.69636296e+00  9.99443862e+01  5.28389478e+02
  2.35855033e+03  1.15425848e+04  4.11268161e+04  1.09976852e+05
  2.54173499e+05  5.48600706e+05  1.15254579e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.6947830902683  E_coul = 198.7584188388955
cycle= 4 E= -507.936364251373  delta_E= -3.42e-08  |g|= 7.38e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.31817e-06
diis-c [-5.53182293e-12 -1.97674540e-06  2.42952842e-03 -4.85535667e-02
  1.04612602e+00]
  HOMO = -0.237714925302918  LUMO = 9.69636165695139
  mo_energy =
[-1.20312631e+02 -1.23744174e+01 -6.67507365e+00 -6.67507365e+00
 -6.67507365e+00 -1.16355848e+00 -2.37714925e-01 -2.37714925e-01
 -2.37714925e-01  9.69636166e+00  9.99443850e+01  5.28389479e+02
  2.35855033e+03  1.15425848e+04  4.11268161e+04  1.09976852e+05
  2.54173499e+05  5.48600706e+05  1.15254579e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.694781168993  E_coul = 198.75841691761826
cycle= 5 E= -507.936364251375  delta_E= -1.99e-12  |g|= 1.48e-07  |ddm|= 2.88e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.694781168993  E_coul = 198.75841691761826
  HOMO = -0.237714961404653  LUMO = 9.69636158718659
  mo_energy =
[-1.20312631e+02 -1.23744175e+01 -6.67507383e+00 -6.67507383e+00
 -6.67507383e+00 -1.16355850e+00 -2.37714961e-01 -2.37714961e-01
 -2.37714961e-01  9.69636159e+00  9.99443848e+01  5.28389479e+02
  2.35855033e+03  1.15425848e+04  4.11268161e+04  1.09976852e+05
  2.54173499e+05  5.48600706e+05  1.15254579e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.6947810691426  E_coul = 198.75841681776765
Extra cycle  E= -507.936364251375  delta_E= -1.71e-13  |g|= 7.81e-09  |ddm|= 7.82e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [3.96743779e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105066e+04 3.67552262e+04 7.33135199e+03
 1.83771412e+04 1.23698528e+03 3.22765351e+02 1.02218848e+02
 3.54724595e+01 7.95786203e+00 3.14295583e+00 8.60520807e+00
 4.93103450e-01]
E = -507.9363642513749
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396743779029       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071282        1
[INPUT] 0    0    [1    /1   ]  294042.035582        1
[INPUT] 0    0    [1    /1   ]  147021.017415        1
[INPUT] 0    0    [1    /1   ]  73510.5066337        1
[INPUT] 0    0    [1    /1   ]  36755.2262242        1
[INPUT] 0    0    [1    /1   ]  7331.35199408        1
[INPUT] 0    0    [1    /1   ]  18377.1411535        1
[INPUT] 0    0    [1    /1   ]  1236.9852756         1
[INPUT] 0    0    [1    /1   ]  322.765351048        1
[INPUT] 0    0    [1    /1   ]  102.21884836         1
[INPUT] 0    0    [1    /1   ]  35.4724594953        1
[INPUT] 0    0    [1    /1   ]  7.9578620282         1
[INPUT] 0    0    [1    /1   ]  3.14295582997        1
[INPUT] 1    0    [1    /1   ]  8.60520807312        1
[INPUT] 1    0    [1    /1   ]  0.493103449979       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3967437790291523, 1.0]], [0, [1176168.1426076642, 1.0]], [0, [588084.0712824651, 1.0]], [0, [294042.03558234544, 1.0]], [0, [147021.0174150113, 1.0]], [0, [73510.50663369412, 1.0]], [0, [36755.22622416457, 1.0]], [0, [7331.351994084191, 1.0]], [0, [18377.14115345309, 1.0]], [0, [1236.985275597812, 1.0]], [0, [322.7653510475757, 1.0]], [0, [102.21884835982831, 1.0]], [0, [35.47245949529828, 1.0]], [0, [7.957862028198436, 1.0]], [0, [3.1429558299700866, 1.0]], [1, [8.605208073116279, 1.0]], [1, [0.4931034499787168, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39674378]
bas 1, expnt(s) = [1176168.14260766]
bas 2, expnt(s) = [588084.07128247]
bas 3, expnt(s) = [294042.03558235]
bas 4, expnt(s) = [147021.01741501]
bas 5, expnt(s) = [73510.50663369]
bas 6, expnt(s) = [36755.22622416]
bas 7, expnt(s) = [7331.35199408]
bas 8, expnt(s) = [18377.14115345]
bas 9, expnt(s) = [1236.9852756]
bas 10, expnt(s) = [322.76535105]
bas 11, expnt(s) = [102.21884836]
bas 12, expnt(s) = [35.4724595]
bas 13, expnt(s) = [7.95786203]
bas 14, expnt(s) = [3.14295583]
bas 15, expnt(s) = [8.60520807]
bas 16, expnt(s) = [0.49310345]
CPU time:      1247.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96743779e-01 1.26298333e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105066e+04 1.12791685e+04
 3.67552262e+04 6.70663003e+03 7.33135199e+03 2.00171884e+03
 1.83771412e+04 3.98770927e+03 1.23698528e+03 5.26973070e+02
 3.22765351e+02 1.92388985e+02 1.02218848e+02 8.12200518e+01
 3.54724595e+01 3.67226066e+01 7.95786203e+00 1.19705010e+01
 3.14295583e+00 5.96374043e+00 8.60520807e+00 4.29967978e+01
 4.93103450e-01 1.20547149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32503567802326
cond(S) = 12561.99729848442
E1 = -689.3616229689992  E_coul = 184.9245797373848
init E= -504.437043231614
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674497046187335  LUMO = 8.81031302015298
  mo_energy =
[-1.21701146e+02 -1.33864698e+01 -7.62714962e+00 -7.62714962e+00
 -7.62714962e+00 -1.63986103e+00 -6.74497046e-01 -6.74497046e-01
 -6.74497046e-01  8.81031302e+00  9.86555981e+01  5.27017365e+02
  2.35724842e+03  1.15414151e+04  4.11257219e+04  1.09975798e+05
  2.54172473e+05  5.48599700e+05  1.15254480e+06  2.43032476e+06
  5.37505664e+06]
E1 = -707.0765280586162  E_coul = 199.14680326797418
cycle= 1 E= -507.929724790642  delta_E= -3.49  |g|= 0.444  |ddm|= 0.354
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593681
diis-c [-0.35245771  1.        ]
  HOMO = -0.232787305235533  LUMO = 9.70792134345457
  mo_energy =
[-1.20250838e+02 -1.23499642e+01 -6.64481037e+00 -6.64481037e+00
 -6.64481037e+00 -1.16103975e+00 -2.32787305e-01 -2.32787305e-01
 -2.32787305e-01  9.70792134e+00  9.99895690e+01  5.28453098e+02
  2.35862771e+03  1.15426719e+04  4.11269064e+04  1.09976944e+05
  2.54173591e+05  5.48600799e+05  1.15254589e+06  2.43032583e+06
  5.37505771e+06]
E1 = -706.711060171611  E_coul = 198.7747091253129
cycle= 2 E= -507.936351046298  delta_E= -0.00663  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155312
diis-c [-2.33852597e-04  4.55247729e-03  9.95447523e-01]
  HOMO = -0.237471669513876  LUMO = 9.69691951080405
  mo_energy =
[-1.20309946e+02 -1.23732413e+01 -6.67364624e+00 -6.67364624e+00
 -6.67364624e+00 -1.16343887e+00 -2.37471670e-01 -2.37471670e-01
 -2.37471670e-01  9.69691951e+00  9.99464266e+01  5.28392189e+02
  2.35855344e+03  1.15425882e+04  4.11268195e+04  1.09976855e+05
  2.54173503e+05  5.48600710e+05  1.15254580e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.6955745689309  E_coul = 198.75921035180752
cycle= 3 E= -507.936364217123  delta_E= -1.32e-05  |g|= 0.000912  |ddm|= 0.00932
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757079
diis-c [-1.63380624e-08  4.50350936e-05 -5.01699729e-02  1.05012494e+00]
  HOMO = -0.237713875876502  LUMO = 9.69636295958825
  mo_energy =
[-1.20312631e+02 -1.23744137e+01 -6.67507080e+00 -6.67507080e+00
 -6.67507080e+00 -1.16355789e+00 -2.37713876e-01 -2.37713876e-01
 -2.37713876e-01  9.69636296e+00  9.99443862e+01  5.28389478e+02
  2.35855033e+03  1.15425848e+04  4.11268161e+04  1.09976852e+05
  2.54173499e+05  5.48600706e+05  1.15254579e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.6947830902683  E_coul = 198.7584188388955
cycle= 4 E= -507.936364251373  delta_E= -3.42e-08  |g|= 7.38e-06  |ddm|= 0.000503
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.31817e-06
diis-c [-5.53182293e-12 -1.97674540e-06  2.42952842e-03 -4.85535667e-02
  1.04612602e+00]
  HOMO = -0.237714925302918  LUMO = 9.69636165695139
  mo_energy =
[-1.20312631e+02 -1.23744174e+01 -6.67507365e+00 -6.67507365e+00
 -6.67507365e+00 -1.16355848e+00 -2.37714925e-01 -2.37714925e-01
 -2.37714925e-01  9.69636166e+00  9.99443850e+01  5.28389479e+02
  2.35855033e+03  1.15425848e+04  4.11268161e+04  1.09976852e+05
  2.54173499e+05  5.48600706e+05  1.15254579e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.694781168993  E_coul = 198.75841691761826
cycle= 5 E= -507.936364251375  delta_E= -1.99e-12  |g|= 1.48e-07  |ddm|= 2.88e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.694781168993  E_coul = 198.75841691761826
  HOMO = -0.237714961404653  LUMO = 9.69636158718659
  mo_energy =
[-1.20312631e+02 -1.23744175e+01 -6.67507383e+00 -6.67507383e+00
 -6.67507383e+00 -1.16355850e+00 -2.37714961e-01 -2.37714961e-01
 -2.37714961e-01  9.69636159e+00  9.99443848e+01  5.28389479e+02
  2.35855033e+03  1.15425848e+04  4.11268161e+04  1.09976852e+05
  2.54173499e+05  5.48600706e+05  1.15254579e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.6947810691426  E_coul = 198.75841681776765
Extra cycle  E= -507.936364251375  delta_E= -1.71e-13  |g|= 7.81e-09  |ddm|= 7.82e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12561.99729848442
E1 = -706.6947810691426  E_coul = 198.75841681776765
init E= -507.936364251375
    CPU time for initialize scf      1.26 sec, wall time      0.08 sec
  HOMO = -0.237714963154152  LUMO = 9.69636158562476
  mo_energy =
[-1.20312631e+02 -1.23744176e+01 -6.67507383e+00 -6.67507383e+00
 -6.67507383e+00 -1.16355850e+00 -2.37714963e-01 -2.37714963e-01
 -2.37714963e-01  9.69636159e+00  9.99443848e+01  5.28389479e+02
  2.35855033e+03  1.15425848e+04  4.11268161e+04  1.09976852e+05
  2.54173499e+05  5.48600706e+05  1.15254579e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.6947810645294  E_coul = 198.75841681315435
cycle= 1 E= -507.936364251375  delta_E= -1.14e-13  |g|= 1.08e-09  |ddm|= 3.97e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6947810645294  E_coul = 198.75841681315435
  HOMO = -0.237714963241951  LUMO = 9.69636158266635
  mo_energy =
[-1.20312631e+02 -1.23744176e+01 -6.67507383e+00 -6.67507383e+00
 -6.67507383e+00 -1.16355850e+00 -2.37714963e-01 -2.37714963e-01
 -2.37714963e-01  9.69636158e+00  9.99443848e+01  5.28389479e+02
  2.35855033e+03  1.15425848e+04  4.11268161e+04  1.09976852e+05
  2.54173499e+05  5.48600706e+05  1.15254579e+06  2.43032574e+06
  5.37505762e+06]
E1 = -706.6947810642931  E_coul = 198.75841681291843
Extra cycle  E= -507.936364251375  delta_E= 3.41e-13  |g|= 7.35e-10  |ddm|= 2.25e-10
    CPU time for scf_cycle      1.44 sec, wall time      0.15 sec
exp = [3.96743779e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105066e+04 3.67552262e+04 7.33135199e+03
 1.83771412e+04 1.23698528e+03 3.22765351e+02 1.02218848e+02
 3.54724595e+01 7.95786203e+00 3.14295583e+00 8.60520807e+00
 4.93103450e-01]
grad_E = [ 9.23851064e-04 -3.31502752e-12  5.18699803e-10  1.79221482e-09
  1.01552465e-08  3.44899545e-08  2.03404357e-07  1.12049113e-05
  5.36988436e-07 -9.22506196e-05  1.58808936e-05 -4.58491340e-06
 -8.26109498e-05  3.67593155e-05 -2.03673529e-04  7.49892951e-04
  1.19000363e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396785252353       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.07128         1
[INPUT] 0    0    [1    /1   ]  294042.035574        1
[INPUT] 0    0    [1    /1   ]  147021.017366        1
[INPUT] 0    0    [1    /1   ]  73510.5064671        1
[INPUT] 0    0    [1    /1   ]  36755.2252338        1
[INPUT] 0    0    [1    /1   ]  7331.29753454        1
[INPUT] 0    0    [1    /1   ]  18377.1385788        1
[INPUT] 0    0    [1    /1   ]  1237.29997619        1
[INPUT] 0    0    [1    /1   ]  323.350261398        1
[INPUT] 0    0    [1    /1   ]  102.346052068        1
[INPUT] 0    0    [1    /1   ]  35.4748106602        1
[INPUT] 0    0    [1    /1   ]  7.95568562833        1
[INPUT] 0    0    [1    /1   ]  3.14135869742        1
[INPUT] 1    0    [1    /1   ]  8.60577702024        1
[INPUT] 1    0    [1    /1   ]  0.493136555209       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39678525235265866, 1.0]], [0, [1176168.1426077045, 1.0]], [0, [588084.0712799454, 1.0]], [0, [294042.0355736983, 1.0]], [0, [147021.01736558933, 1.0]], [0, [73510.50646707453, 1.0]], [0, [36755.22523378555, 1.0]], [0, [7331.297534536525, 1.0]], [0, [18377.138578764105, 1.0]], [0, [1237.2999761910796, 1.0]], [0, [323.35026139834054, 1.0]], [0, [102.34605206816184, 1.0]], [0, [35.47481066018697, 1.0]], [0, [7.955685628328573, 1.0]], [0, [3.141358697424668, 1.0]], [1, [8.605777020243652, 1.0]], [1, [0.4931365552087349, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39678525]
bas 1, expnt(s) = [1176168.1426077]
bas 2, expnt(s) = [588084.07127995]
bas 3, expnt(s) = [294042.0355737]
bas 4, expnt(s) = [147021.01736559]
bas 5, expnt(s) = [73510.50646707]
bas 6, expnt(s) = [36755.22523379]
bas 7, expnt(s) = [7331.29753454]
bas 8, expnt(s) = [18377.13857876]
bas 9, expnt(s) = [1237.29997619]
bas 10, expnt(s) = [323.3502614]
bas 11, expnt(s) = [102.34605207]
bas 12, expnt(s) = [35.47481066]
bas 13, expnt(s) = [7.95568563]
bas 14, expnt(s) = [3.1413587]
bas 15, expnt(s) = [8.60577702]
bas 16, expnt(s) = [0.49313656]
CPU time:      1251.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96785252e-01 1.26308235e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105065e+04 1.12791685e+04
 3.67552252e+04 6.70662990e+03 7.33129753e+03 2.00170769e+03
 1.83771386e+04 3.98770885e+03 1.23729998e+03 5.27073617e+02
 3.23350261e+02 1.92650410e+02 1.02346052e+02 8.12958442e+01
 3.54748107e+01 3.67244321e+01 7.95568563e+00 1.19680456e+01
 3.14135870e+00 5.96146737e+00 8.60577702e+00 4.30003513e+01
 4.93136555e-01 1.20557266e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324985747173404
cond(S) = 12562.70212247057
E1 = -689.364787013868  E_coul = 184.92843687155863
init E= -504.436350142309
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67445488384047  LUMO = 8.80452630473455
  mo_energy =
[-1.21700508e+02 -1.33861638e+01 -7.62688672e+00 -7.62688672e+00
 -7.62688672e+00 -1.63981409e+00 -6.74454884e-01 -6.74454884e-01
 -6.74454884e-01  8.80452630e+00  9.86962882e+01  5.27751412e+02
  2.35963463e+03  1.15447945e+04  4.11291057e+04  1.09979056e+05
  2.54175619e+05  5.48602751e+05  1.15254777e+06  2.43032764e+06
  5.37505944e+06]
E1 = -707.0813878471863  E_coul = 199.15165161631705
cycle= 1 E= -507.929736230869  delta_E= -3.49  |g|= 0.444  |ddm|= 0.353
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593647
diis-c [-0.35241632  1.        ]
  HOMO = -0.23269678751642  LUMO = 9.70204648685757
  mo_energy =
[-1.20250147e+02 -1.23495920e+01 -6.64447934e+00 -6.64447934e+00
 -6.64447934e+00 -1.16095135e+00 -2.32696788e-01 -2.32696788e-01
 -2.32696788e-01  9.70204649e+00  1.00030427e+02  5.29187195e+02
  2.36101392e+03  1.15460513e+04  4.11302903e+04  1.09980201e+05
  2.54176737e+05  5.48603850e+05  1.15254885e+06  2.43032871e+06
  5.37506050e+06]
E1 = -706.7156802361808  E_coul = 198.77931272114776
cycle= 2 E= -507.936367515033  delta_E= -0.00663  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155364
diis-c [-2.34018432e-04  4.55138767e-03  9.95448612e-01]
  HOMO = -0.237385687016697  LUMO = 9.69104017642643
  mo_energy =
[-1.20309286e+02 -1.23728856e+01 -6.67333481e+00 -6.67333481e+00
 -6.67333481e+00 -1.16335292e+00 -2.37385687e-01 -2.37385687e-01
 -2.37385687e-01  9.69104018e+00  9.99872495e+01  5.29126238e+02
  2.36093960e+03  1.15459676e+04  4.11302033e+04  1.09980113e+05
  2.54176649e+05  5.48603761e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.7001795797893  E_coul = 198.76379887487673
cycle= 3 E= -507.936380704913  delta_E= -1.32e-05  |g|= 0.000912  |ddm|= 0.00932
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757426
diis-c [-1.64001520e-08  4.50745047e-05 -5.01743781e-02  1.05012930e+00]
  HOMO = -0.237628203305847  LUMO = 9.6904832322609
  mo_energy =
[-1.20311973e+02 -1.23740592e+01 -6.67476073e+00 -6.67476073e+00
 -6.67476073e+00 -1.16347209e+00 -2.37628203e-01 -2.37628203e-01
 -2.37628203e-01  9.69048323e+00  9.99852071e+01  5.29123525e+02
  2.36093649e+03  1.15459643e+04  4.11301999e+04  1.09980110e+05
  2.54176645e+05  5.48603757e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.6993870941244  E_coul = 198.76300635488863
cycle= 4 E= -507.936380739236  delta_E= -3.43e-08  |g|= 7.4e-06  |ddm|= 0.000504
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.33299e-06
diis-c [-5.54616828e-12 -1.97404849e-06  2.43181772e-03 -4.86001676e-02
  1.04617032e+00]
  HOMO = -0.237629257407689  LUMO = 9.69048192314094
  mo_energy =
[-1.20311973e+02 -1.23740629e+01 -6.67476358e+00 -6.67476358e+00
 -6.67476358e+00 -1.16347269e+00 -2.37629257e-01 -2.37629257e-01
 -2.37629257e-01  9.69048192e+00  9.99852058e+01  5.29123526e+02
  2.36093649e+03  1.15459643e+04  4.11301999e+04  1.09980110e+05
  2.54176645e+05  5.48603757e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.6993851606386  E_coul = 198.76300442140075
cycle= 5 E= -507.936380739238  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.9e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6993851606386  E_coul = 198.76300442140075
  HOMO = -0.237629293566156  LUMO = 9.69048185242294
  mo_energy =
[-1.20311973e+02 -1.23740631e+01 -6.67476376e+00 -6.67476376e+00
 -6.67476376e+00 -1.16347270e+00 -2.37629294e-01 -2.37629294e-01
 -2.37629294e-01  9.69048185e+00  9.99852056e+01  5.29123525e+02
  2.36093649e+03  1.15459643e+04  4.11301999e+04  1.09980110e+05
  2.54176645e+05  5.48603757e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.6993850605662  E_coul = 198.76300432132894
Extra cycle  E= -507.936380739237  delta_E= 5.68e-13  |g|= 7.85e-09  |ddm|= 7.83e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.96785252e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105065e+04 3.67552252e+04 7.33129753e+03
 1.83771386e+04 1.23729998e+03 3.23350261e+02 1.02346052e+02
 3.54748107e+01 7.95568563e+00 3.14135870e+00 8.60577702e+00
 4.93136555e-01]
E = -507.9363807392373
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396785252353       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.07128         1
[INPUT] 0    0    [1    /1   ]  294042.035574        1
[INPUT] 0    0    [1    /1   ]  147021.017366        1
[INPUT] 0    0    [1    /1   ]  73510.5064671        1
[INPUT] 0    0    [1    /1   ]  36755.2252338        1
[INPUT] 0    0    [1    /1   ]  7331.29753454        1
[INPUT] 0    0    [1    /1   ]  18377.1385788        1
[INPUT] 0    0    [1    /1   ]  1237.29997619        1
[INPUT] 0    0    [1    /1   ]  323.350261398        1
[INPUT] 0    0    [1    /1   ]  102.346052068        1
[INPUT] 0    0    [1    /1   ]  35.4748106602        1
[INPUT] 0    0    [1    /1   ]  7.95568562833        1
[INPUT] 0    0    [1    /1   ]  3.14135869742        1
[INPUT] 1    0    [1    /1   ]  8.60577702024        1
[INPUT] 1    0    [1    /1   ]  0.493136555209       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39678525235265866, 1.0]], [0, [1176168.1426077045, 1.0]], [0, [588084.0712799454, 1.0]], [0, [294042.0355736983, 1.0]], [0, [147021.01736558933, 1.0]], [0, [73510.50646707453, 1.0]], [0, [36755.22523378555, 1.0]], [0, [7331.297534536525, 1.0]], [0, [18377.138578764105, 1.0]], [0, [1237.2999761910796, 1.0]], [0, [323.35026139834054, 1.0]], [0, [102.34605206816184, 1.0]], [0, [35.47481066018697, 1.0]], [0, [7.955685628328573, 1.0]], [0, [3.141358697424668, 1.0]], [1, [8.605777020243652, 1.0]], [1, [0.4931365552087349, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39678525]
bas 1, expnt(s) = [1176168.1426077]
bas 2, expnt(s) = [588084.07127995]
bas 3, expnt(s) = [294042.0355737]
bas 4, expnt(s) = [147021.01736559]
bas 5, expnt(s) = [73510.50646707]
bas 6, expnt(s) = [36755.22523379]
bas 7, expnt(s) = [7331.29753454]
bas 8, expnt(s) = [18377.13857876]
bas 9, expnt(s) = [1237.29997619]
bas 10, expnt(s) = [323.3502614]
bas 11, expnt(s) = [102.34605207]
bas 12, expnt(s) = [35.47481066]
bas 13, expnt(s) = [7.95568563]
bas 14, expnt(s) = [3.1413587]
bas 15, expnt(s) = [8.60577702]
bas 16, expnt(s) = [0.49313656]
CPU time:      1252.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96785252e-01 1.26308235e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105065e+04 1.12791685e+04
 3.67552252e+04 6.70662990e+03 7.33129753e+03 2.00170769e+03
 1.83771386e+04 3.98770885e+03 1.23729998e+03 5.27073617e+02
 3.23350261e+02 1.92650410e+02 1.02346052e+02 8.12958442e+01
 3.54748107e+01 3.67244321e+01 7.95568563e+00 1.19680456e+01
 3.14135870e+00 5.96146737e+00 8.60577702e+00 4.30003513e+01
 4.93136555e-01 1.20557266e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324985747173404
cond(S) = 12562.70212247057
E1 = -689.364787013868  E_coul = 184.92843687155863
init E= -504.436350142309
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67445488384047  LUMO = 8.80452630473455
  mo_energy =
[-1.21700508e+02 -1.33861638e+01 -7.62688672e+00 -7.62688672e+00
 -7.62688672e+00 -1.63981409e+00 -6.74454884e-01 -6.74454884e-01
 -6.74454884e-01  8.80452630e+00  9.86962882e+01  5.27751412e+02
  2.35963463e+03  1.15447945e+04  4.11291057e+04  1.09979056e+05
  2.54175619e+05  5.48602751e+05  1.15254777e+06  2.43032764e+06
  5.37505944e+06]
E1 = -707.0813878471863  E_coul = 199.15165161631705
cycle= 1 E= -507.929736230869  delta_E= -3.49  |g|= 0.444  |ddm|= 0.353
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.593647
diis-c [-0.35241632  1.        ]
  HOMO = -0.23269678751642  LUMO = 9.70204648685757
  mo_energy =
[-1.20250147e+02 -1.23495920e+01 -6.64447934e+00 -6.64447934e+00
 -6.64447934e+00 -1.16095135e+00 -2.32696788e-01 -2.32696788e-01
 -2.32696788e-01  9.70204649e+00  1.00030427e+02  5.29187195e+02
  2.36101392e+03  1.15460513e+04  4.11302903e+04  1.09980201e+05
  2.54176737e+05  5.48603850e+05  1.15254885e+06  2.43032871e+06
  5.37506050e+06]
E1 = -706.7156802361808  E_coul = 198.77931272114776
cycle= 2 E= -507.936367515033  delta_E= -0.00663  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155364
diis-c [-2.34018432e-04  4.55138767e-03  9.95448612e-01]
  HOMO = -0.237385687016697  LUMO = 9.69104017642643
  mo_energy =
[-1.20309286e+02 -1.23728856e+01 -6.67333481e+00 -6.67333481e+00
 -6.67333481e+00 -1.16335292e+00 -2.37385687e-01 -2.37385687e-01
 -2.37385687e-01  9.69104018e+00  9.99872495e+01  5.29126238e+02
  2.36093960e+03  1.15459676e+04  4.11302033e+04  1.09980113e+05
  2.54176649e+05  5.48603761e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.7001795797893  E_coul = 198.76379887487673
cycle= 3 E= -507.936380704913  delta_E= -1.32e-05  |g|= 0.000912  |ddm|= 0.00932
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757426
diis-c [-1.64001520e-08  4.50745047e-05 -5.01743781e-02  1.05012930e+00]
  HOMO = -0.237628203305847  LUMO = 9.6904832322609
  mo_energy =
[-1.20311973e+02 -1.23740592e+01 -6.67476073e+00 -6.67476073e+00
 -6.67476073e+00 -1.16347209e+00 -2.37628203e-01 -2.37628203e-01
 -2.37628203e-01  9.69048323e+00  9.99852071e+01  5.29123525e+02
  2.36093649e+03  1.15459643e+04  4.11301999e+04  1.09980110e+05
  2.54176645e+05  5.48603757e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.6993870941244  E_coul = 198.76300635488863
cycle= 4 E= -507.936380739236  delta_E= -3.43e-08  |g|= 7.4e-06  |ddm|= 0.000504
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.33299e-06
diis-c [-5.54616828e-12 -1.97404849e-06  2.43181772e-03 -4.86001676e-02
  1.04617032e+00]
  HOMO = -0.237629257407689  LUMO = 9.69048192314094
  mo_energy =
[-1.20311973e+02 -1.23740629e+01 -6.67476358e+00 -6.67476358e+00
 -6.67476358e+00 -1.16347269e+00 -2.37629257e-01 -2.37629257e-01
 -2.37629257e-01  9.69048192e+00  9.99852058e+01  5.29123526e+02
  2.36093649e+03  1.15459643e+04  4.11301999e+04  1.09980110e+05
  2.54176645e+05  5.48603757e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.6993851606386  E_coul = 198.76300442140075
cycle= 5 E= -507.936380739238  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.9e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6993851606386  E_coul = 198.76300442140075
  HOMO = -0.237629293566156  LUMO = 9.69048185242294
  mo_energy =
[-1.20311973e+02 -1.23740631e+01 -6.67476376e+00 -6.67476376e+00
 -6.67476376e+00 -1.16347270e+00 -2.37629294e-01 -2.37629294e-01
 -2.37629294e-01  9.69048185e+00  9.99852056e+01  5.29123525e+02
  2.36093649e+03  1.15459643e+04  4.11301999e+04  1.09980110e+05
  2.54176645e+05  5.48603757e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.6993850605662  E_coul = 198.76300432132894
Extra cycle  E= -507.936380739237  delta_E= 5.68e-13  |g|= 7.85e-09  |ddm|= 7.83e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12562.70212247057
E1 = -706.6993850605662  E_coul = 198.76300432132894
init E= -507.936380739237
    CPU time for initialize scf      1.53 sec, wall time      0.10 sec
  HOMO = -0.237629295319309  LUMO = 9.69048184814997
  mo_energy =
[-1.20311973e+02 -1.23740631e+01 -6.67476377e+00 -6.67476377e+00
 -6.67476377e+00 -1.16347271e+00 -2.37629295e-01 -2.37629295e-01
 -2.37629295e-01  9.69048185e+00  9.99852056e+01  5.29123525e+02
  2.36093649e+03  1.15459643e+04  4.11301999e+04  1.09980110e+05
  2.54176645e+05  5.48603757e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.6993850558791  E_coul = 198.7630043166416
cycle= 1 E= -507.936380739238  delta_E= -2.27e-13  |g|= 1.72e-09  |ddm|= 3.98e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.6993850558791  E_coul = 198.7630043166416
  HOMO = -0.237629295407548  LUMO = 9.69048184999376
  mo_energy =
[-1.20311973e+02 -1.23740631e+01 -6.67476377e+00 -6.67476377e+00
 -6.67476377e+00 -1.16347271e+00 -2.37629295e-01 -2.37629295e-01
 -2.37629295e-01  9.69048185e+00  9.99852056e+01  5.29123525e+02
  2.36093649e+03  1.15459643e+04  4.11301999e+04  1.09980110e+05
  2.54176645e+05  5.48603757e+05  1.15254876e+06  2.43032862e+06
  5.37506041e+06]
E1 = -706.6993850557013  E_coul = 198.76300431646368
Extra cycle  E= -507.936380739238  delta_E= -1.14e-13  |g|= 1.05e-09  |ddm|= 2e-10
    CPU time for scf_cycle      1.72 sec, wall time      0.16 sec
exp = [3.96785252e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105065e+04 3.67552252e+04 7.33129753e+03
 1.83771386e+04 1.23729998e+03 3.23350261e+02 1.02346052e+02
 3.54748107e+01 7.95568563e+00 3.14135870e+00 8.60577702e+00
 4.93136555e-01]
grad_E = [ 1.46362392e-03 -2.94399681e-12  5.21038426e-10  1.80127875e-09
  1.01996030e-08  3.46611643e-08  2.04285088e-07  1.12555150e-05
  5.39984300e-07 -9.50854995e-05  3.10677750e-05 -8.71567438e-06
 -1.32130284e-04  5.87590730e-05 -3.19483151e-04  1.18439564e-03
  1.86887869e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396851165847       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071274        1
[INPUT] 0    0    [1    /1   ]  294042.035552        1
[INPUT] 0    0    [1    /1   ]  147021.017243        1
[INPUT] 0    0    [1    /1   ]  73510.5060526        1
[INPUT] 0    0    [1    /1   ]  36755.2227753        1
[INPUT] 0    0    [1    /1   ]  7331.16227769        1
[INPUT] 0    0    [1    /1   ]  18377.1321625        1
[INPUT] 0    0    [1    /1   ]  1238.16631857        1
[INPUT] 0    0    [1    /1   ]  324.396047504        1
[INPUT] 0    0    [1    /1   ]  102.57780024         1
[INPUT] 0    0    [1    /1   ]  35.4854274421        1
[INPUT] 0    0    [1    /1   ]  7.95254037484        1
[INPUT] 0    0    [1    /1   ]  3.13897732955        1
[INPUT] 1    0    [1    /1   ]  8.60668038975        1
[INPUT] 1    0    [1    /1   ]  0.49318907151        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3968511658468271, 1.0]], [0, [1176168.1426077893, 1.0]], [0, [588084.071273687, 1.0]], [0, [294042.0355521831, 1.0]], [0, [147021.01724288863, 1.0]], [0, [73510.50605263979, 1.0]], [0, [36755.2227752531, 1.0]], [0, [7331.162277685637, 1.0]], [0, [18377.132162545793, 1.0]], [0, [1238.1663185744756, 1.0]], [0, [324.3960475042218, 1.0]], [0, [102.57780023953033, 1.0]], [0, [35.4854274420604, 1.0]], [0, [7.952540374841371, 1.0]], [0, [3.1389773295544208, 1.0]], [1, [8.606680389745112, 1.0]], [1, [0.49318907150983216, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39685117]
bas 1, expnt(s) = [1176168.14260779]
bas 2, expnt(s) = [588084.07127369]
bas 3, expnt(s) = [294042.03555218]
bas 4, expnt(s) = [147021.01724289]
bas 5, expnt(s) = [73510.50605264]
bas 6, expnt(s) = [36755.22277525]
bas 7, expnt(s) = [7331.16227769]
bas 8, expnt(s) = [18377.13216255]
bas 9, expnt(s) = [1238.16631857]
bas 10, expnt(s) = [324.3960475]
bas 11, expnt(s) = [102.57780024]
bas 12, expnt(s) = [35.48542744]
bas 13, expnt(s) = [7.95254037]
bas 14, expnt(s) = [3.13897733]
bas 15, expnt(s) = [8.60668039]
bas 16, expnt(s) = [0.49318907]
CPU time:      1257.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96851166e-01 1.26323971e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105061e+04 1.12791685e+04
 3.67552228e+04 6.70662956e+03 7.33116228e+03 2.00168000e+03
 1.83771322e+04 3.98770780e+03 1.23816632e+03 5.27350380e+02
 3.24396048e+02 1.93117526e+02 1.02577800e+02 8.14338674e+01
 3.54854274e+01 3.67326749e+01 7.95254037e+00 1.19644968e+01
 3.13897733e+00 5.95807764e+00 8.60668039e+00 4.30059937e+01
 4.93189072e-01 1.20573314e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324906203213892
cond(S) = 12564.16130907085
E1 = -689.3698976641884  E_coul = 184.93454919955104
init E= -504.435348464637
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674388283522262  LUMO = 8.79627925720885
  mo_energy =
[-1.21699505e+02 -1.33856787e+01 -7.62647016e+00 -7.62647016e+00
 -7.62647016e+00 -1.63974013e+00 -6.74388284e-01 -6.74388284e-01
 -6.74388284e-01  8.79627926e+00  9.87879049e+01  5.29105147e+02
  2.36422920e+03  1.15517523e+04  4.11361768e+04  1.09985872e+05
  2.54182199e+05  5.48609130e+05  1.15255396e+06  2.43033366e+06
  5.37506527e+06]
E1 = -707.0891099119319  E_coul = 199.15933824939492
cycle= 1 E= -507.929771662537  delta_E= -3.49  |g|= 0.444  |ddm|= 0.353
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.59357
diis-c [-0.35232549  1.        ]
  HOMO = -0.232553340885535  LUMO = 9.69369017474375
  mo_energy =
[-1.20249059e+02 -1.23490020e+01 -6.64395484e+00 -6.64395484e+00
 -6.64395484e+00 -1.16081160e+00 -2.32553341e-01 -2.32553341e-01
 -2.32553341e-01  9.69369017e+00  1.00122355e+02  5.30541013e+02
  2.36560846e+03  1.15530092e+04  4.11373615e+04  1.09987017e+05
  2.54183317e+05  5.48610229e+05  1.15255505e+06  2.43033473e+06
  5.37506634e+06]
E1 = -706.7230503549608  E_coul = 198.78664001925716
cycle= 2 E= -507.936410335704  delta_E= -0.00664  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.015544
diis-c [-2.34257829e-04  4.55059077e-03  9.95449409e-01]
  HOMO = -0.237248870599966  LUMO = 9.6826769111443
  mo_energy =
[-1.20308243e+02 -1.23723196e+01 -6.67283903e+00 -6.67283903e+00
 -6.67283903e+00 -1.16321672e+00 -2.37248871e-01 -2.37248871e-01
 -2.37248871e-01  9.68267691e+00  1.00079121e+02  5.30479978e+02
  2.36553408e+03  1.15529254e+04  4.11372745e+04  1.09986929e+05
  2.54183228e+05  5.48610140e+05  1.15255496e+06  2.43033464e+06
  5.37506625e+06]
E1 = -706.7075279079799  E_coul = 198.77110435496422
cycle= 3 E= -507.936423553016  delta_E= -1.32e-05  |g|= 0.000913  |ddm|= 0.00933
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757937
diis-c [-1.64885469e-08  4.51243486e-05 -5.01812818e-02  1.05013616e+00]
  HOMO = -0.237491839536174  LUMO = 9.68211937510412
  mo_energy =
[-1.20310933e+02 -1.23734950e+01 -6.67426691e+00 -6.67426691e+00
 -6.67426691e+00 -1.16333612e+00 -2.37491840e-01 -2.37491840e-01
 -2.37491840e-01  9.68211938e+00  1.00077076e+02  5.30477262e+02
  2.36553096e+03  1.15529220e+04  4.11372711e+04  1.09986926e+05
  2.54183225e+05  5.48610136e+05  1.15255495e+06  2.43033464e+06
  5.37506624e+06]
E1 = -706.7067339613692  E_coul = 198.7703103739239
cycle= 4 E= -507.936423587445  delta_E= -3.44e-08  |g|= 7.43e-06  |ddm|= 0.000505
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.35505e-06
diis-c [-5.56862463e-12 -1.97375117e-06  2.43539241e-03 -4.86707487e-02
  1.04623733e+00]
  HOMO = -0.237492900298694  LUMO = 9.68211805367714
  mo_energy =
[-1.20310933e+02 -1.23734987e+01 -6.67426979e+00 -6.67426979e+00
 -6.67426979e+00 -1.16333672e+00 -2.37492900e-01 -2.37492900e-01
 -2.37492900e-01  9.68211805e+00  1.00077074e+02  5.30477262e+02
  2.36553097e+03  1.15529220e+04  4.11372711e+04  1.09986926e+05
  2.54183225e+05  5.48610136e+05  1.15255495e+06  2.43033464e+06
  5.37506624e+06]
E1 = -706.7067320105306  E_coul = 198.77030842308324
cycle= 5 E= -507.936423587447  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.91e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7067320105306  E_coul = 198.77030842308324
  HOMO = -0.2374929365365  LUMO = 9.68211798408738
  mo_energy =
[-1.20310933e+02 -1.23734989e+01 -6.67426997e+00 -6.67426997e+00
 -6.67426997e+00 -1.16333674e+00 -2.37492937e-01 -2.37492937e-01
 -2.37492937e-01  9.68211798e+00  1.00077074e+02  5.30477262e+02
  2.36553097e+03  1.15529220e+04  4.11372711e+04  1.09986926e+05
  2.54183225e+05  5.48610136e+05  1.15255495e+06  2.43033464e+06
  5.37506624e+06]
E1 = -706.7067319102315  E_coul = 198.77030832278402
Extra cycle  E= -507.936423587448  delta_E= -1.71e-13  |g|= 7.79e-09  |ddm|= 7.84e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.96851166e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105061e+04 3.67552228e+04 7.33116228e+03
 1.83771322e+04 1.23816632e+03 3.24396048e+02 1.02577800e+02
 3.54854274e+01 7.95254037e+00 3.13897733e+00 8.60668039e+00
 4.93189072e-01]
E = -507.9364235874475
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396851165847       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071274        1
[INPUT] 0    0    [1    /1   ]  294042.035552        1
[INPUT] 0    0    [1    /1   ]  147021.017243        1
[INPUT] 0    0    [1    /1   ]  73510.5060526        1
[INPUT] 0    0    [1    /1   ]  36755.2227753        1
[INPUT] 0    0    [1    /1   ]  7331.16227769        1
[INPUT] 0    0    [1    /1   ]  18377.1321625        1
[INPUT] 0    0    [1    /1   ]  1238.16631857        1
[INPUT] 0    0    [1    /1   ]  324.396047504        1
[INPUT] 0    0    [1    /1   ]  102.57780024         1
[INPUT] 0    0    [1    /1   ]  35.4854274421        1
[INPUT] 0    0    [1    /1   ]  7.95254037484        1
[INPUT] 0    0    [1    /1   ]  3.13897732955        1
[INPUT] 1    0    [1    /1   ]  8.60668038975        1
[INPUT] 1    0    [1    /1   ]  0.49318907151        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3968511658468271, 1.0]], [0, [1176168.1426077893, 1.0]], [0, [588084.071273687, 1.0]], [0, [294042.0355521831, 1.0]], [0, [147021.01724288863, 1.0]], [0, [73510.50605263979, 1.0]], [0, [36755.2227752531, 1.0]], [0, [7331.162277685637, 1.0]], [0, [18377.132162545793, 1.0]], [0, [1238.1663185744756, 1.0]], [0, [324.3960475042218, 1.0]], [0, [102.57780023953033, 1.0]], [0, [35.4854274420604, 1.0]], [0, [7.952540374841371, 1.0]], [0, [3.1389773295544208, 1.0]], [1, [8.606680389745112, 1.0]], [1, [0.49318907150983216, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39685117]
bas 1, expnt(s) = [1176168.14260779]
bas 2, expnt(s) = [588084.07127369]
bas 3, expnt(s) = [294042.03555218]
bas 4, expnt(s) = [147021.01724289]
bas 5, expnt(s) = [73510.50605264]
bas 6, expnt(s) = [36755.22277525]
bas 7, expnt(s) = [7331.16227769]
bas 8, expnt(s) = [18377.13216255]
bas 9, expnt(s) = [1238.16631857]
bas 10, expnt(s) = [324.3960475]
bas 11, expnt(s) = [102.57780024]
bas 12, expnt(s) = [35.48542744]
bas 13, expnt(s) = [7.95254037]
bas 14, expnt(s) = [3.13897733]
bas 15, expnt(s) = [8.60668039]
bas 16, expnt(s) = [0.49318907]
CPU time:      1257.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96851166e-01 1.26323971e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042036e+05 3.19023070e+04
 1.47021017e+05 1.89692252e+04 7.35105061e+04 1.12791685e+04
 3.67552228e+04 6.70662956e+03 7.33116228e+03 2.00168000e+03
 1.83771322e+04 3.98770780e+03 1.23816632e+03 5.27350380e+02
 3.24396048e+02 1.93117526e+02 1.02577800e+02 8.14338674e+01
 3.54854274e+01 3.67326749e+01 7.95254037e+00 1.19644968e+01
 3.13897733e+00 5.95807764e+00 8.60668039e+00 4.30059937e+01
 4.93189072e-01 1.20573314e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324906203213892
cond(S) = 12564.16130907085
E1 = -689.3698976641884  E_coul = 184.93454919955104
init E= -504.435348464637
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674388283522262  LUMO = 8.79627925720885
  mo_energy =
[-1.21699505e+02 -1.33856787e+01 -7.62647016e+00 -7.62647016e+00
 -7.62647016e+00 -1.63974013e+00 -6.74388284e-01 -6.74388284e-01
 -6.74388284e-01  8.79627926e+00  9.87879049e+01  5.29105147e+02
  2.36422920e+03  1.15517523e+04  4.11361768e+04  1.09985872e+05
  2.54182199e+05  5.48609130e+05  1.15255396e+06  2.43033366e+06
  5.37506527e+06]
E1 = -707.0891099119319  E_coul = 199.15933824939492
cycle= 1 E= -507.929771662537  delta_E= -3.49  |g|= 0.444  |ddm|= 0.353
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.59357
diis-c [-0.35232549  1.        ]
  HOMO = -0.232553340885535  LUMO = 9.69369017474375
  mo_energy =
[-1.20249059e+02 -1.23490020e+01 -6.64395484e+00 -6.64395484e+00
 -6.64395484e+00 -1.16081160e+00 -2.32553341e-01 -2.32553341e-01
 -2.32553341e-01  9.69369017e+00  1.00122355e+02  5.30541013e+02
  2.36560846e+03  1.15530092e+04  4.11373615e+04  1.09987017e+05
  2.54183317e+05  5.48610229e+05  1.15255505e+06  2.43033473e+06
  5.37506634e+06]
E1 = -706.7230503549608  E_coul = 198.78664001925716
cycle= 2 E= -507.936410335704  delta_E= -0.00664  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.015544
diis-c [-2.34257829e-04  4.55059077e-03  9.95449409e-01]
  HOMO = -0.237248870599966  LUMO = 9.6826769111443
  mo_energy =
[-1.20308243e+02 -1.23723196e+01 -6.67283903e+00 -6.67283903e+00
 -6.67283903e+00 -1.16321672e+00 -2.37248871e-01 -2.37248871e-01
 -2.37248871e-01  9.68267691e+00  1.00079121e+02  5.30479978e+02
  2.36553408e+03  1.15529254e+04  4.11372745e+04  1.09986929e+05
  2.54183228e+05  5.48610140e+05  1.15255496e+06  2.43033464e+06
  5.37506625e+06]
E1 = -706.7075279079799  E_coul = 198.77110435496422
cycle= 3 E= -507.936423553016  delta_E= -1.32e-05  |g|= 0.000913  |ddm|= 0.00933
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757937
diis-c [-1.64885469e-08  4.51243486e-05 -5.01812818e-02  1.05013616e+00]
  HOMO = -0.237491839536174  LUMO = 9.68211937510412
  mo_energy =
[-1.20310933e+02 -1.23734950e+01 -6.67426691e+00 -6.67426691e+00
 -6.67426691e+00 -1.16333612e+00 -2.37491840e-01 -2.37491840e-01
 -2.37491840e-01  9.68211938e+00  1.00077076e+02  5.30477262e+02
  2.36553096e+03  1.15529220e+04  4.11372711e+04  1.09986926e+05
  2.54183225e+05  5.48610136e+05  1.15255495e+06  2.43033464e+06
  5.37506624e+06]
E1 = -706.7067339613692  E_coul = 198.7703103739239
cycle= 4 E= -507.936423587445  delta_E= -3.44e-08  |g|= 7.43e-06  |ddm|= 0.000505
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.35505e-06
diis-c [-5.56862463e-12 -1.97375117e-06  2.43539241e-03 -4.86707487e-02
  1.04623733e+00]
  HOMO = -0.237492900298694  LUMO = 9.68211805367714
  mo_energy =
[-1.20310933e+02 -1.23734987e+01 -6.67426979e+00 -6.67426979e+00
 -6.67426979e+00 -1.16333672e+00 -2.37492900e-01 -2.37492900e-01
 -2.37492900e-01  9.68211805e+00  1.00077074e+02  5.30477262e+02
  2.36553097e+03  1.15529220e+04  4.11372711e+04  1.09986926e+05
  2.54183225e+05  5.48610136e+05  1.15255495e+06  2.43033464e+06
  5.37506624e+06]
E1 = -706.7067320105306  E_coul = 198.77030842308324
cycle= 5 E= -507.936423587447  delta_E= -2.05e-12  |g|= 1.48e-07  |ddm|= 2.91e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7067320105306  E_coul = 198.77030842308324
  HOMO = -0.2374929365365  LUMO = 9.68211798408738
  mo_energy =
[-1.20310933e+02 -1.23734989e+01 -6.67426997e+00 -6.67426997e+00
 -6.67426997e+00 -1.16333674e+00 -2.37492937e-01 -2.37492937e-01
 -2.37492937e-01  9.68211798e+00  1.00077074e+02  5.30477262e+02
  2.36553097e+03  1.15529220e+04  4.11372711e+04  1.09986926e+05
  2.54183225e+05  5.48610136e+05  1.15255495e+06  2.43033464e+06
  5.37506624e+06]
E1 = -706.7067319102315  E_coul = 198.77030832278402
Extra cycle  E= -507.936423587448  delta_E= -1.71e-13  |g|= 7.79e-09  |ddm|= 7.84e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12564.16130907085
E1 = -706.7067319102315  E_coul = 198.77030832278402
init E= -507.936423587448
    CPU time for initialize scf      1.33 sec, wall time      0.08 sec
  HOMO = -0.237492938294103  LUMO = 9.68211798010482
  mo_energy =
[-1.20310933e+02 -1.23734989e+01 -6.67426998e+00 -6.67426998e+00
 -6.67426998e+00 -1.16333674e+00 -2.37492938e-01 -2.37492938e-01
 -2.37492938e-01  9.68211798e+00  1.00077074e+02  5.30477262e+02
  2.36553097e+03  1.15529220e+04  4.11372711e+04  1.09986926e+05
  2.54183225e+05  5.48610136e+05  1.15255495e+06  2.43033464e+06
  5.37506624e+06]
E1 = -706.7067319056096  E_coul = 198.77030831816217
cycle= 1 E= -507.936423587447  delta_E= 1.14e-13  |g|= 1.16e-09  |ddm|= 3.99e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7067319056096  E_coul = 198.77030831816217
  HOMO = -0.237492938382249  LUMO = 9.68211797836923
  mo_energy =
[-1.20310933e+02 -1.23734989e+01 -6.67426998e+00 -6.67426998e+00
 -6.67426998e+00 -1.16333674e+00 -2.37492938e-01 -2.37492938e-01
 -2.37492938e-01  9.68211798e+00  1.00077074e+02  5.30477262e+02
  2.36553097e+03  1.15529220e+04  4.11372711e+04  1.09986926e+05
  2.54183225e+05  5.48610136e+05  1.15255495e+06  2.43033464e+06
  5.37506624e+06]
E1 = -706.7067319053177  E_coul = 198.77030831787025
Extra cycle  E= -507.936423587448  delta_E= -1.14e-13  |g|= 1.15e-09  |ddm|= 2.31e-10
    CPU time for scf_cycle      1.51 sec, wall time      0.15 sec
exp = [3.96851166e-01 1.17616814e+06 5.88084071e+05 2.94042036e+05
 1.47021017e+05 7.35105061e+04 3.67552228e+04 7.33116228e+03
 1.83771322e+04 1.23816632e+03 3.24396048e+02 1.02577800e+02
 3.54854274e+01 7.95254037e+00 3.13897733e+00 8.60668039e+00
 4.93189072e-01]
grad_E = [ 2.32158674e-03 -2.48419012e-12  5.23933842e-10  1.81250295e-09
  1.02545317e-08  3.48731825e-08  2.05377554e-07  1.13206677e-05
  5.43690143e-07 -9.93753547e-05  5.51884642e-05 -1.51709811e-05
 -2.11065815e-04  9.38067775e-05 -5.03682464e-04  1.87490209e-03
  2.94791061e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396953748472       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071258        1
[INPUT] 0    0    [1    /1   ]  294042.035498        1
[INPUT] 0    0    [1    /1   ]  147021.016936        1
[INPUT] 0    0    [1    /1   ]  73510.5050137        1
[INPUT] 0    0    [1    /1   ]  36755.2166204        1
[INPUT] 0    0    [1    /1   ]  7330.82355412        1
[INPUT] 0    0    [1    /1   ]  18377.116058         1
[INPUT] 0    0    [1    /1   ]  1240.47822751        1
[INPUT] 0    0    [1    /1   ]  326.331529326        1
[INPUT] 0    0    [1    /1   ]  103.017047287        1
[INPUT] 0    0    [1    /1   ]  35.5203312525        1
[INPUT] 0    0    [1    /1   ]  7.94844806006        1
[INPUT] 0    0    [1    /1   ]  3.13568337399        1
[INPUT] 1    0    [1    /1   ]  8.60808478458        1
[INPUT] 1    0    [1    /1   ]  0.493270587611       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3969537484717283, 1.0]], [0, [1176168.142607976, 1.0]], [0, [588084.0712580126, 1.0]], [0, [294042.0354982374, 1.0]], [0, [147021.01693568463, 1.0]], [0, [73510.50501373867, 1.0]], [0, [36755.21662035745, 1.0]], [0, [7330.823554119294, 1.0]], [0, [18377.11605802961, 1.0]], [0, [1240.4782275099378, 1.0]], [0, [326.3315293261939, 1.0]], [0, [103.01704728678357, 1.0]], [0, [35.52033125248356, 1.0]], [0, [7.948448060064938, 1.0]], [0, [3.135683373990598, 1.0]], [1, [8.60808478457978, 1.0]], [1, [0.4932705876112158, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39695375]
bas 1, expnt(s) = [1176168.14260798]
bas 2, expnt(s) = [588084.07125801]
bas 3, expnt(s) = [294042.03549824]
bas 4, expnt(s) = [147021.01693568]
bas 5, expnt(s) = [73510.50501374]
bas 6, expnt(s) = [36755.21662036]
bas 7, expnt(s) = [7330.82355412]
bas 8, expnt(s) = [18377.11605803]
bas 9, expnt(s) = [1240.47822751]
bas 10, expnt(s) = [326.33152933]
bas 11, expnt(s) = [103.01704729]
bas 12, expnt(s) = [35.52033125]
bas 13, expnt(s) = [7.94844806]
bas 14, expnt(s) = [3.13568337]
bas 15, expnt(s) = [8.60808478]
bas 16, expnt(s) = [0.49327059]
CPU time:      1262.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96953748e-01 1.26348461e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042035e+05 3.19023070e+04
 1.47021017e+05 1.89692251e+04 7.35105050e+04 1.12791684e+04
 3.67552166e+04 6.70662872e+03 7.33082355e+03 2.00161063e+03
 1.83771161e+04 3.98770518e+03 1.24047823e+03 5.28088711e+02
 3.26331529e+02 1.93981048e+02 1.03017047e+02 8.16952578e+01
 3.55203313e+01 3.67597695e+01 7.94844806e+00 1.19598788e+01
 3.13568337e+00 5.95338785e+00 8.60808478e+00 4.30147658e+01
 4.93270588e-01 1.20598226e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324781881473236
cond(S) = 12567.327998429924
E1 = -689.3780876536083  E_coul = 184.94402080959213
init E= -504.434066844016
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.674285636223919  LUMO = 8.78592226672078
  mo_energy =
[-1.21697971e+02 -1.33849264e+01 -7.62582481e+00 -7.62582481e+00
 -7.62582481e+00 -1.63962671e+00 -6.74285636e-01 -6.74285636e-01
 -6.74285636e-01  8.78592227e+00  9.90022431e+01  5.31709153e+02
  2.37349965e+03  1.15667662e+04  4.11516490e+04  1.10000804e+05
  2.54196608e+05  5.48623097e+05  1.15256753e+06  2.43034683e+06
  5.37507804e+06]
E1 = -707.1011296038971  E_coul = 199.17125772685304
cycle= 1 E= -507.929871877044  delta_E= -3.5  |g|= 0.444  |ddm|= 0.353
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.593395
diis-c [-0.35211786  1.        ]
  HOMO = -0.232331080130147  LUMO = 9.68324396058446
  mo_energy =
[-1.20247388e+02 -1.23480874e+01 -6.64314242e+00 -6.64314242e+00
 -6.64314242e+00 -1.16059599e+00 -2.32331080e-01 -2.32331080e-01
 -2.32331080e-01  9.68324396e+00  1.00337297e+02  5.33145160e+02
  2.37487883e+03  1.15680233e+04  4.11528338e+04  1.10001949e+05
  2.54197727e+05  5.48624196e+05  1.15256861e+06  2.43034791e+06
  5.37507911e+06]
E1 = -706.734598366233  E_coul = 198.7980778953981
cycle= 2 E= -507.936520470835  delta_E= -0.00665  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155539
diis-c [-2.34566214e-04  4.55190944e-03  9.95448091e-01]
  HOMO = -0.237035411522125  LUMO = 9.6722202963787
  mo_energy =
[-1.20306635e+02 -1.23714366e+01 -6.67206484e+00 -6.67206484e+00
 -6.67206484e+00 -1.16300571e+00 -2.37035412e-01 -2.37035412e-01
 -2.37035412e-01  9.67222030e+00  1.00293972e+02  5.33084003e+02
  2.37480435e+03  1.15679394e+04  4.11527468e+04  1.10001861e+05
  2.54197638e+05  5.48624106e+05  1.15256852e+06  2.43034782e+06
  5.37507902e+06]
E1 = -706.7190476156097  E_coul = 198.78251389228376
cycle= 3 E= -507.936533723326  delta_E= -1.33e-05  |g|= 0.000914  |ddm|= 0.00935
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000758619
diis-c [-1.65990988e-08  4.51488378e-05 -5.01917658e-02  1.05014662e+00]
  HOMO = -0.237278980425602  LUMO = 9.67166192182846
  mo_energy =
[-1.20309329e+02 -1.23726142e+01 -6.67349534e+00 -6.67349534e+00
 -6.67349534e+00 -1.16312542e+00 -2.37278980e-01 -2.37278980e-01
 -2.37278980e-01  9.67166192e+00  1.00291921e+02  5.33081280e+02
  2.37480123e+03  1.15679361e+04  4.11527433e+04  1.10001858e+05
  2.54197634e+05  5.48624103e+05  1.15256852e+06  2.43034781e+06
  5.37507902e+06]
E1 = -706.7182517605382  E_coul = 198.7817180026443
cycle= 4 E= -507.936533757894  delta_E= -3.46e-08  |g|= 7.47e-06  |ddm|= 0.000506
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.38329e-06
diis-c [-5.58634371e-12 -1.97714959e-06  2.44058088e-03 -4.87716817e-02
  1.04633308e+00]
  HOMO = -0.237280049463097  LUMO = 9.67166058864516
  mo_energy =
[-1.20309329e+02 -1.23726179e+01 -6.67349826e+00 -6.67349826e+00
 -6.67349826e+00 -1.16312602e+00 -2.37280049e-01 -2.37280049e-01
 -2.37280049e-01  9.67166059e+00  1.00291920e+02  5.33081281e+02
  2.37480123e+03  1.15679361e+04  4.11527433e+04  1.10001858e+05
  2.54197634e+05  5.48624103e+05  1.15256852e+06  2.43034781e+06
  5.37507902e+06]
E1 = -706.7182497885065  E_coul = 198.78171603061062
cycle= 5 E= -507.936533757896  delta_E= -1.93e-12  |g|= 1.48e-07  |ddm|= 2.93e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7182497885065  E_coul = 198.78171603061062
  HOMO = -0.237280085775846  LUMO = 9.67166051722297
  mo_energy =
[-1.20309329e+02 -1.23726181e+01 -6.67349844e+00 -6.67349844e+00
 -6.67349844e+00 -1.16312604e+00 -2.37280086e-01 -2.37280086e-01
 -2.37280086e-01  9.67166052e+00  1.00291920e+02  5.33081281e+02
  2.37480123e+03  1.15679361e+04  4.11527433e+04  1.10001858e+05
  2.54197634e+05  5.48624103e+05  1.15256852e+06  2.43034781e+06
  5.37507902e+06]
E1 = -706.7182496880569  E_coul = 198.7817159301611
Extra cycle  E= -507.936533757896  delta_E= 1.14e-13  |g|= 7.81e-09  |ddm|= 7.85e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
exp = [3.96953748e-01 1.17616814e+06 5.88084071e+05 2.94042035e+05
 1.47021017e+05 7.35105050e+04 3.67552166e+04 7.33082355e+03
 1.83771161e+04 1.24047823e+03 3.26331529e+02 1.03017047e+02
 3.55203313e+01 7.94844806e+00 3.13568337e+00 8.60808478e+00
 4.93270588e-01]
E = -507.93653375789575
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:29:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396953748472       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071258        1
[INPUT] 0    0    [1    /1   ]  294042.035498        1
[INPUT] 0    0    [1    /1   ]  147021.016936        1
[INPUT] 0    0    [1    /1   ]  73510.5050137        1
[INPUT] 0    0    [1    /1   ]  36755.2166204        1
[INPUT] 0    0    [1    /1   ]  7330.82355412        1
[INPUT] 0    0    [1    /1   ]  18377.116058         1
[INPUT] 0    0    [1    /1   ]  1240.47822751        1
[INPUT] 0    0    [1    /1   ]  326.331529326        1
[INPUT] 0    0    [1    /1   ]  103.017047287        1
[INPUT] 0    0    [1    /1   ]  35.5203312525        1
[INPUT] 0    0    [1    /1   ]  7.94844806006        1
[INPUT] 0    0    [1    /1   ]  3.13568337399        1
[INPUT] 1    0    [1    /1   ]  8.60808478458        1
[INPUT] 1    0    [1    /1   ]  0.493270587611       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3969537484717283, 1.0]], [0, [1176168.142607976, 1.0]], [0, [588084.0712580126, 1.0]], [0, [294042.0354982374, 1.0]], [0, [147021.01693568463, 1.0]], [0, [73510.50501373867, 1.0]], [0, [36755.21662035745, 1.0]], [0, [7330.823554119294, 1.0]], [0, [18377.11605802961, 1.0]], [0, [1240.4782275099378, 1.0]], [0, [326.3315293261939, 1.0]], [0, [103.01704728678357, 1.0]], [0, [35.52033125248356, 1.0]], [0, [7.948448060064938, 1.0]], [0, [3.135683373990598, 1.0]], [1, [8.60808478457978, 1.0]], [1, [0.4932705876112158, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39695375]
bas 1, expnt(s) = [1176168.14260798]
bas 2, expnt(s) = [588084.07125801]
bas 3, expnt(s) = [294042.03549824]
bas 4, expnt(s) = [147021.01693568]
bas 5, expnt(s) = [73510.50501374]
bas 6, expnt(s) = [36755.21662036]
bas 7, expnt(s) = [7330.82355412]
bas 8, expnt(s) = [18377.11605803]
bas 9, expnt(s) = [1240.47822751]
bas 10, expnt(s) = [326.33152933]
bas 11, expnt(s) = [103.01704729]
bas 12, expnt(s) = [35.52033125]
bas 13, expnt(s) = [7.94844806]
bas 14, expnt(s) = [3.13568337]
bas 15, expnt(s) = [8.60808478]
bas 16, expnt(s) = [0.49327059]
CPU time:      1263.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96953748e-01 1.26348461e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042035e+05 3.19023070e+04
 1.47021017e+05 1.89692251e+04 7.35105050e+04 1.12791684e+04
 3.67552166e+04 6.70662872e+03 7.33082355e+03 2.00161063e+03
 1.83771161e+04 3.98770518e+03 1.24047823e+03 5.28088711e+02
 3.26331529e+02 1.93981048e+02 1.03017047e+02 8.16952578e+01
 3.55203313e+01 3.67597695e+01 7.94844806e+00 1.19598788e+01
 3.13568337e+00 5.95338785e+00 8.60808478e+00 4.30147658e+01
 4.93270588e-01 1.20598226e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324781881473236
cond(S) = 12567.327998429924
E1 = -689.3780876536083  E_coul = 184.94402080959213
init E= -504.434066844016
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.674285636223919  LUMO = 8.78592226672078
  mo_energy =
[-1.21697971e+02 -1.33849264e+01 -7.62582481e+00 -7.62582481e+00
 -7.62582481e+00 -1.63962671e+00 -6.74285636e-01 -6.74285636e-01
 -6.74285636e-01  8.78592227e+00  9.90022431e+01  5.31709153e+02
  2.37349965e+03  1.15667662e+04  4.11516490e+04  1.10000804e+05
  2.54196608e+05  5.48623097e+05  1.15256753e+06  2.43034683e+06
  5.37507804e+06]
E1 = -707.1011296038971  E_coul = 199.17125772685304
cycle= 1 E= -507.929871877044  delta_E= -3.5  |g|= 0.444  |ddm|= 0.353
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.593395
diis-c [-0.35211786  1.        ]
  HOMO = -0.232331080130147  LUMO = 9.68324396058446
  mo_energy =
[-1.20247388e+02 -1.23480874e+01 -6.64314242e+00 -6.64314242e+00
 -6.64314242e+00 -1.16059599e+00 -2.32331080e-01 -2.32331080e-01
 -2.32331080e-01  9.68324396e+00  1.00337297e+02  5.33145160e+02
  2.37487883e+03  1.15680233e+04  4.11528338e+04  1.10001949e+05
  2.54197727e+05  5.48624196e+05  1.15256861e+06  2.43034791e+06
  5.37507911e+06]
E1 = -706.734598366233  E_coul = 198.7980778953981
cycle= 2 E= -507.936520470835  delta_E= -0.00665  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155539
diis-c [-2.34566214e-04  4.55190944e-03  9.95448091e-01]
  HOMO = -0.237035411522125  LUMO = 9.6722202963787
  mo_energy =
[-1.20306635e+02 -1.23714366e+01 -6.67206484e+00 -6.67206484e+00
 -6.67206484e+00 -1.16300571e+00 -2.37035412e-01 -2.37035412e-01
 -2.37035412e-01  9.67222030e+00  1.00293972e+02  5.33084003e+02
  2.37480435e+03  1.15679394e+04  4.11527468e+04  1.10001861e+05
  2.54197638e+05  5.48624106e+05  1.15256852e+06  2.43034782e+06
  5.37507902e+06]
E1 = -706.7190476156097  E_coul = 198.78251389228376
cycle= 3 E= -507.936533723326  delta_E= -1.33e-05  |g|= 0.000914  |ddm|= 0.00935
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000758619
diis-c [-1.65990988e-08  4.51488378e-05 -5.01917658e-02  1.05014662e+00]
  HOMO = -0.237278980425602  LUMO = 9.67166192182846
  mo_energy =
[-1.20309329e+02 -1.23726142e+01 -6.67349534e+00 -6.67349534e+00
 -6.67349534e+00 -1.16312542e+00 -2.37278980e-01 -2.37278980e-01
 -2.37278980e-01  9.67166192e+00  1.00291921e+02  5.33081280e+02
  2.37480123e+03  1.15679361e+04  4.11527433e+04  1.10001858e+05
  2.54197634e+05  5.48624103e+05  1.15256852e+06  2.43034781e+06
  5.37507902e+06]
E1 = -706.7182517605382  E_coul = 198.7817180026443
cycle= 4 E= -507.936533757894  delta_E= -3.46e-08  |g|= 7.47e-06  |ddm|= 0.000506
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.38329e-06
diis-c [-5.58634371e-12 -1.97714959e-06  2.44058088e-03 -4.87716817e-02
  1.04633308e+00]
  HOMO = -0.237280049463097  LUMO = 9.67166058864516
  mo_energy =
[-1.20309329e+02 -1.23726179e+01 -6.67349826e+00 -6.67349826e+00
 -6.67349826e+00 -1.16312602e+00 -2.37280049e-01 -2.37280049e-01
 -2.37280049e-01  9.67166059e+00  1.00291920e+02  5.33081281e+02
  2.37480123e+03  1.15679361e+04  4.11527433e+04  1.10001858e+05
  2.54197634e+05  5.48624103e+05  1.15256852e+06  2.43034781e+06
  5.37507902e+06]
E1 = -706.7182497885065  E_coul = 198.78171603061062
cycle= 5 E= -507.936533757896  delta_E= -1.93e-12  |g|= 1.48e-07  |ddm|= 2.93e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7182497885065  E_coul = 198.78171603061062
  HOMO = -0.237280085775846  LUMO = 9.67166051722297
  mo_energy =
[-1.20309329e+02 -1.23726181e+01 -6.67349844e+00 -6.67349844e+00
 -6.67349844e+00 -1.16312604e+00 -2.37280086e-01 -2.37280086e-01
 -2.37280086e-01  9.67166052e+00  1.00291920e+02  5.33081281e+02
  2.37480123e+03  1.15679361e+04  4.11527433e+04  1.10001858e+05
  2.54197634e+05  5.48624103e+05  1.15256852e+06  2.43034781e+06
  5.37507902e+06]
E1 = -706.7182496880569  E_coul = 198.7817159301611
Extra cycle  E= -507.936533757896  delta_E= 1.14e-13  |g|= 7.81e-09  |ddm|= 7.85e-08
    CPU time for scf_cycle      0.44 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12567.327998429924
E1 = -706.7182496880569  E_coul = 198.7817159301611
init E= -507.936533757896
    CPU time for initialize scf      1.27 sec, wall time      0.08 sec
  HOMO = -0.237280087537504  LUMO = 9.67166051393829
  mo_energy =
[-1.20309329e+02 -1.23726181e+01 -6.67349845e+00 -6.67349845e+00
 -6.67349845e+00 -1.16312604e+00 -2.37280088e-01 -2.37280088e-01
 -2.37280088e-01  9.67166051e+00  1.00291920e+02  5.33081280e+02
  2.37480123e+03  1.15679361e+04  4.11527433e+04  1.10001858e+05
  2.54197634e+05  5.48624103e+05  1.15256852e+06  2.43034781e+06
  5.37507902e+06]
E1 = -706.7182496833144  E_coul = 198.7817159254187
cycle= 1 E= -507.936533757896  delta_E=    0  |g|= 1.11e-09  |ddm|= 4.01e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.7182496833144  E_coul = 198.7817159254187
  HOMO = -0.237280087626583  LUMO = 9.67166051367198
  mo_energy =
[-1.20309329e+02 -1.23726181e+01 -6.67349845e+00 -6.67349845e+00
 -6.67349845e+00 -1.16312604e+00 -2.37280088e-01 -2.37280088e-01
 -2.37280088e-01  9.67166051e+00  1.00291920e+02  5.33081280e+02
  2.37480123e+03  1.15679361e+04  4.11527433e+04  1.10001858e+05
  2.54197634e+05  5.48624103e+05  1.15256852e+06  2.43034781e+06
  5.37507902e+06]
E1 = -706.7182496830874  E_coul = 198.7817159251914
Extra cycle  E= -507.936533757896  delta_E= -2.27e-13  |g|= 1.24e-09  |ddm|= 2.02e-10
    CPU time for scf_cycle      1.45 sec, wall time      0.15 sec
exp = [3.96953748e-01 1.17616814e+06 5.88084071e+05 2.94042035e+05
 1.47021017e+05 7.35105050e+04 3.67552166e+04 7.33082355e+03
 1.83771161e+04 1.24047823e+03 3.26331529e+02 1.03017047e+02
 3.55203313e+01 7.94844806e+00 3.13568337e+00 8.60808478e+00
 4.93270588e-01]
grad_E = [ 3.65775731e-03 -2.11240143e-12  5.26274171e-10  1.82157474e-09
  1.02989710e-08  3.50445411e-08  2.06267683e-07  1.13818808e-05
  5.46667859e-07 -1.05461184e-04  9.25280585e-05 -2.46884324e-05
 -3.34544840e-04  1.48716045e-04 -7.91181216e-04  2.95002767e-03
  4.62832439e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397105353117       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071219        1
[INPUT] 0    0    [1    /1   ]  294042.035364        1
[INPUT] 0    0    [1    /1   ]  147021.016173        1
[INPUT] 0    0    [1    /1   ]  73510.502433         1
[INPUT] 0    0    [1    /1   ]  36755.2013439        1
[INPUT] 0    0    [1    /1   ]  7329.98266424        1
[INPUT] 0    0    [1    /1   ]  18377.0760188        1
[INPUT] 0    0    [1    /1   ]  1246.44971031        1
[INPUT] 0    0    [1    /1   ]  330.021639654        1
[INPUT] 0    0    [1    /1   ]  103.877747789        1
[INPUT] 0    0    [1    /1   ]  35.6213979885        1
[INPUT] 0    0    [1    /1   ]  7.94445519559        1
[INPUT] 0    0    [1    /1   ]  3.13190399265        1
[INPUT] 1    0    [1    /1   ]  8.61015839016        1
[INPUT] 1    0    [1    /1   ]  0.493390622881       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39710535311660566, 1.0]], [0, [1176168.142608398, 1.0]], [0, [588084.0712190988, 1.0]], [0, [294042.0353642093, 1.0]], [0, [147021.01617316555, 1.0]], [0, [73510.50243295635, 1.0]], [0, [36755.201343941015, 1.0]], [0, [7329.982664236901, 1.0]], [0, [18377.07601882064, 1.0]], [0, [1246.4497103136823, 1.0]], [0, [330.02163965435335, 1.0]], [0, [103.87774778897015, 1.0]], [0, [35.62139798845385, 1.0]], [0, [7.944455195587708, 1.0]], [0, [3.13190399265305, 1.0]], [1, [8.610158390160242, 1.0]], [1, [0.49339062288054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39710535]
bas 1, expnt(s) = [1176168.1426084]
bas 2, expnt(s) = [588084.0712191]
bas 3, expnt(s) = [294042.03536421]
bas 4, expnt(s) = [147021.01617317]
bas 5, expnt(s) = [73510.50243296]
bas 6, expnt(s) = [36755.20134394]
bas 7, expnt(s) = [7329.98266424]
bas 8, expnt(s) = [18377.07601882]
bas 9, expnt(s) = [1246.44971031]
bas 10, expnt(s) = [330.02163965]
bas 11, expnt(s) = [103.87774779]
bas 12, expnt(s) = [35.62139799]
bas 13, expnt(s) = [7.9444552]
bas 14, expnt(s) = [3.13190399]
bas 15, expnt(s) = [8.61015839]
bas 16, expnt(s) = [0.49339062]
CPU time:      1268.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97105353e-01 1.26384650e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042035e+05 3.19023070e+04
 1.47021016e+05 1.89692251e+04 7.35105024e+04 1.12791681e+04
 3.67552013e+04 6.70662663e+03 7.32998266e+03 2.00143843e+03
 1.83770760e+04 3.98769867e+03 1.24644971e+03 5.29994173e+02
 3.30021640e+02 1.95623866e+02 1.03877748e+02 8.22066438e+01
 3.56213980e+01 3.68381866e+01 7.94445520e+00 1.19553726e+01
 3.13190399e+00 5.94800541e+00 8.61015839e+00 4.30277185e+01
 4.93390623e-01 1.20634911e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324596703908558
cond(S) = 12574.402243222197
E1 = -689.390858388115  E_coul = 184.95792909345425
init E= -504.432929294661
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.674136331448592  LUMO = 8.7771104188706
  mo_energy =
[-1.21695770e+02 -1.33838212e+01 -7.62487757e+00 -7.62487757e+00
 -7.62487757e+00 -1.63946322e+00 -6.74136331e-01 -6.74136331e-01
 -6.74136331e-01  8.77711042e+00  9.95123530e+01  5.36898258e+02
  2.39286904e+03  1.16001036e+04  4.11864213e+04  1.10034399e+05
  2.54229021e+05  5.48654507e+05  1.15259803e+06  2.43037647e+06
  5.37510677e+06]
E1 = -707.1189155611277  E_coul = 199.18877788745047
cycle= 1 E= -507.930137673677  delta_E= -3.5  |g|= 0.444  |ddm|= 0.352
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592988
diis-c [-0.35163523  1.        ]
  HOMO = -0.232004906326054  LUMO = 9.67451330336342
  mo_energy =
[-1.20244976e+02 -1.23467445e+01 -6.64195077e+00 -6.64195077e+00
 -6.64195077e+00 -1.16028201e+00 -2.32004906e-01 -2.32004906e-01
 -2.32004906e-01  9.67451330e+00  1.00848617e+02  5.38334496e+02
  2.39424798e+03  1.16013609e+04  4.11876064e+04  1.10035545e+05
  2.54230140e+05  5.48655606e+05  1.15259912e+06  2.43037754e+06
  5.37510784e+06]
E1 = -706.7518874140844  E_coul = 198.81509064328768
cycle= 2 E= -507.936796770797  delta_E= -0.00666  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155636
diis-c [-2.34849834e-04  4.56073681e-03  9.95439263e-01]
  HOMO = -0.236718237380012  LUMO = 9.66347533329543
  mo_energy =
[-1.20304293e+02 -1.23701248e+01 -6.67091275e+00 -6.67091275e+00
 -6.67091275e+00 -1.16269617e+00 -2.36718237e-01 -2.36718237e-01
 -2.36718237e-01  9.66347533e+00  1.00805147e+02  5.38273155e+02
  2.39417337e+03  1.16012769e+04  4.11875193e+04  1.10035457e+05
  2.54230051e+05  5.48655516e+05  1.15259903e+06  2.43037745e+06
  5.37510775e+06]
E1 = -706.7363096658611  E_coul = 198.7994996105222
cycle= 3 E= -507.936810055339  delta_E= -1.33e-05  |g|= 0.000916  |ddm|= 0.00935
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000759345
diis-c [-1.66876233e-08  4.50999399e-05 -5.02073845e-02  1.05016228e+00]
  HOMO = -0.236962416507989  LUMO = 9.66291594408102
  mo_energy =
[-1.20306992e+02 -1.23713046e+01 -6.67234597e+00 -6.67234597e+00
 -6.67234597e+00 -1.16281617e+00 -2.36962417e-01 -2.36962417e-01
 -2.36962417e-01  9.66291594e+00  1.00803089e+02  5.38270423e+02
  2.39417024e+03  1.16012735e+04  4.11875158e+04  1.10035453e+05
  2.54230047e+05  5.48655513e+05  1.15259902e+06  2.43037745e+06
  5.37510774e+06]
E1 = -706.7355119577478  E_coul = 198.79870186771205
cycle= 4 E= -507.936810090036  delta_E= -3.47e-08  |g|= 7.5e-06  |ddm|= 0.000506
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.40738e-06
diis-c [-5.60461018e-12 -1.97212950e-06  2.44562627e-03 -4.88643231e-02
  1.04642067e+00]
  HOMO = -0.236963492196874  LUMO = 9.66291460259125
  mo_energy =
[-1.20306992e+02 -1.23713084e+01 -6.67234890e+00 -6.67234890e+00
 -6.67234890e+00 -1.16281678e+00 -2.36963492e-01 -2.36963492e-01
 -2.36963492e-01  9.66291460e+00  1.00803088e+02  5.38270424e+02
  2.39417024e+03  1.16012735e+04  4.11875158e+04  1.10035453e+05
  2.54230047e+05  5.48655513e+05  1.15259902e+06  2.43037745e+06
  5.37510774e+06]
E1 = -706.73550996979  E_coul = 198.7986998797529
cycle= 5 E= -507.936810090037  delta_E= -1.31e-12  |g|= 1.49e-07  |ddm|= 2.95e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.73550996979  E_coul = 198.7986998797529
  HOMO = -0.236963528603584  LUMO = 9.66291453197158
  mo_energy =
[-1.20306992e+02 -1.23713086e+01 -6.67234909e+00 -6.67234909e+00
 -6.67234909e+00 -1.16281679e+00 -2.36963529e-01 -2.36963529e-01
 -2.36963529e-01  9.66291453e+00  1.00803088e+02  5.38270424e+02
  2.39417024e+03  1.16012735e+04  4.11875158e+04  1.10035453e+05
  2.54230047e+05  5.48655513e+05  1.15259902e+06  2.43037745e+06
  5.37510774e+06]
E1 = -706.7355098690329  E_coul = 198.79869977899526
Extra cycle  E= -507.936810090038  delta_E= -5.68e-13  |g|= 7.78e-09  |ddm|= 7.86e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.97105353e-01 1.17616814e+06 5.88084071e+05 2.94042035e+05
 1.47021016e+05 7.35105024e+04 3.67552013e+04 7.32998266e+03
 1.83770760e+04 1.24644971e+03 3.30021640e+02 1.03877748e+02
 3.56213980e+01 7.94445520e+00 3.13190399e+00 8.61015839e+00
 4.93390623e-01]
E = -507.9368100900376
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397105353117       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071219        1
[INPUT] 0    0    [1    /1   ]  294042.035364        1
[INPUT] 0    0    [1    /1   ]  147021.016173        1
[INPUT] 0    0    [1    /1   ]  73510.502433         1
[INPUT] 0    0    [1    /1   ]  36755.2013439        1
[INPUT] 0    0    [1    /1   ]  7329.98266424        1
[INPUT] 0    0    [1    /1   ]  18377.0760188        1
[INPUT] 0    0    [1    /1   ]  1246.44971031        1
[INPUT] 0    0    [1    /1   ]  330.021639654        1
[INPUT] 0    0    [1    /1   ]  103.877747789        1
[INPUT] 0    0    [1    /1   ]  35.6213979885        1
[INPUT] 0    0    [1    /1   ]  7.94445519559        1
[INPUT] 0    0    [1    /1   ]  3.13190399265        1
[INPUT] 1    0    [1    /1   ]  8.61015839016        1
[INPUT] 1    0    [1    /1   ]  0.493390622881       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39710535311660566, 1.0]], [0, [1176168.142608398, 1.0]], [0, [588084.0712190988, 1.0]], [0, [294042.0353642093, 1.0]], [0, [147021.01617316555, 1.0]], [0, [73510.50243295635, 1.0]], [0, [36755.201343941015, 1.0]], [0, [7329.982664236901, 1.0]], [0, [18377.07601882064, 1.0]], [0, [1246.4497103136823, 1.0]], [0, [330.02163965435335, 1.0]], [0, [103.87774778897015, 1.0]], [0, [35.62139798845385, 1.0]], [0, [7.944455195587708, 1.0]], [0, [3.13190399265305, 1.0]], [1, [8.610158390160242, 1.0]], [1, [0.49339062288054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39710535]
bas 1, expnt(s) = [1176168.1426084]
bas 2, expnt(s) = [588084.0712191]
bas 3, expnt(s) = [294042.03536421]
bas 4, expnt(s) = [147021.01617317]
bas 5, expnt(s) = [73510.50243296]
bas 6, expnt(s) = [36755.20134394]
bas 7, expnt(s) = [7329.98266424]
bas 8, expnt(s) = [18377.07601882]
bas 9, expnt(s) = [1246.44971031]
bas 10, expnt(s) = [330.02163965]
bas 11, expnt(s) = [103.87774779]
bas 12, expnt(s) = [35.62139799]
bas 13, expnt(s) = [7.9444552]
bas 14, expnt(s) = [3.13190399]
bas 15, expnt(s) = [8.61015839]
bas 16, expnt(s) = [0.49339062]
CPU time:      1268.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97105353e-01 1.26384650e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530712e+04 2.94042035e+05 3.19023070e+04
 1.47021016e+05 1.89692251e+04 7.35105024e+04 1.12791681e+04
 3.67552013e+04 6.70662663e+03 7.32998266e+03 2.00143843e+03
 1.83770760e+04 3.98769867e+03 1.24644971e+03 5.29994173e+02
 3.30021640e+02 1.95623866e+02 1.03877748e+02 8.22066438e+01
 3.56213980e+01 3.68381866e+01 7.94445520e+00 1.19553726e+01
 3.13190399e+00 5.94800541e+00 8.61015839e+00 4.30277185e+01
 4.93390623e-01 1.20634911e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324596703908558
cond(S) = 12574.402243222197
E1 = -689.390858388115  E_coul = 184.95792909345425
init E= -504.432929294661
    CPU time for initialize scf      2.74 sec, wall time      0.20 sec
  HOMO = -0.674136331448592  LUMO = 8.7771104188706
  mo_energy =
[-1.21695770e+02 -1.33838212e+01 -7.62487757e+00 -7.62487757e+00
 -7.62487757e+00 -1.63946322e+00 -6.74136331e-01 -6.74136331e-01
 -6.74136331e-01  8.77711042e+00  9.95123530e+01  5.36898258e+02
  2.39286904e+03  1.16001036e+04  4.11864213e+04  1.10034399e+05
  2.54229021e+05  5.48654507e+05  1.15259803e+06  2.43037647e+06
  5.37510677e+06]
E1 = -707.1189155611277  E_coul = 199.18877788745047
cycle= 1 E= -507.930137673677  delta_E= -3.5  |g|= 0.444  |ddm|= 0.352
    CPU time for cycle= 1      0.17 sec, wall time      0.01 sec
diis-norm(errvec)=0.592988
diis-c [-0.35163523  1.        ]
  HOMO = -0.232004906326054  LUMO = 9.67451330336342
  mo_energy =
[-1.20244976e+02 -1.23467445e+01 -6.64195077e+00 -6.64195077e+00
 -6.64195077e+00 -1.16028201e+00 -2.32004906e-01 -2.32004906e-01
 -2.32004906e-01  9.67451330e+00  1.00848617e+02  5.38334496e+02
  2.39424798e+03  1.16013609e+04  4.11876064e+04  1.10035545e+05
  2.54230140e+05  5.48655606e+05  1.15259912e+06  2.43037754e+06
  5.37510784e+06]
E1 = -706.7518874140844  E_coul = 198.81509064328768
cycle= 2 E= -507.936796770797  delta_E= -0.00666  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155636
diis-c [-2.34849834e-04  4.56073681e-03  9.95439263e-01]
  HOMO = -0.236718237380012  LUMO = 9.66347533329543
  mo_energy =
[-1.20304293e+02 -1.23701248e+01 -6.67091275e+00 -6.67091275e+00
 -6.67091275e+00 -1.16269617e+00 -2.36718237e-01 -2.36718237e-01
 -2.36718237e-01  9.66347533e+00  1.00805147e+02  5.38273155e+02
  2.39417337e+03  1.16012769e+04  4.11875193e+04  1.10035457e+05
  2.54230051e+05  5.48655516e+05  1.15259903e+06  2.43037745e+06
  5.37510775e+06]
E1 = -706.7363096658611  E_coul = 198.7994996105222
cycle= 3 E= -507.936810055339  delta_E= -1.33e-05  |g|= 0.000916  |ddm|= 0.00935
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000759345
diis-c [-1.66876233e-08  4.50999399e-05 -5.02073845e-02  1.05016228e+00]
  HOMO = -0.236962416507989  LUMO = 9.66291594408102
  mo_energy =
[-1.20306992e+02 -1.23713046e+01 -6.67234597e+00 -6.67234597e+00
 -6.67234597e+00 -1.16281617e+00 -2.36962417e-01 -2.36962417e-01
 -2.36962417e-01  9.66291594e+00  1.00803089e+02  5.38270423e+02
  2.39417024e+03  1.16012735e+04  4.11875158e+04  1.10035453e+05
  2.54230047e+05  5.48655513e+05  1.15259902e+06  2.43037745e+06
  5.37510774e+06]
E1 = -706.7355119577478  E_coul = 198.79870186771205
cycle= 4 E= -507.936810090036  delta_E= -3.47e-08  |g|= 7.5e-06  |ddm|= 0.000506
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.40738e-06
diis-c [-5.60461018e-12 -1.97212950e-06  2.44562627e-03 -4.88643231e-02
  1.04642067e+00]
  HOMO = -0.236963492196874  LUMO = 9.66291460259125
  mo_energy =
[-1.20306992e+02 -1.23713084e+01 -6.67234890e+00 -6.67234890e+00
 -6.67234890e+00 -1.16281678e+00 -2.36963492e-01 -2.36963492e-01
 -2.36963492e-01  9.66291460e+00  1.00803088e+02  5.38270424e+02
  2.39417024e+03  1.16012735e+04  4.11875158e+04  1.10035453e+05
  2.54230047e+05  5.48655513e+05  1.15259902e+06  2.43037745e+06
  5.37510774e+06]
E1 = -706.73550996979  E_coul = 198.7986998797529
cycle= 5 E= -507.936810090037  delta_E= -1.31e-12  |g|= 1.49e-07  |ddm|= 2.95e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.73550996979  E_coul = 198.7986998797529
  HOMO = -0.236963528603584  LUMO = 9.66291453197158
  mo_energy =
[-1.20306992e+02 -1.23713086e+01 -6.67234909e+00 -6.67234909e+00
 -6.67234909e+00 -1.16281679e+00 -2.36963529e-01 -2.36963529e-01
 -2.36963529e-01  9.66291453e+00  1.00803088e+02  5.38270424e+02
  2.39417024e+03  1.16012735e+04  4.11875158e+04  1.10035453e+05
  2.54230047e+05  5.48655513e+05  1.15259902e+06  2.43037745e+06
  5.37510774e+06]
E1 = -706.7355098690329  E_coul = 198.79869977899526
Extra cycle  E= -507.936810090038  delta_E= -5.68e-13  |g|= 7.78e-09  |ddm|= 7.86e-08
    CPU time for scf_cycle      2.97 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12574.402243222197
E1 = -706.7355098690329  E_coul = 198.79869977899526
init E= -507.936810090038
    CPU time for initialize scf      1.57 sec, wall time      0.10 sec
  HOMO = -0.236963530371066  LUMO = 9.66291452759336
  mo_energy =
[-1.20306992e+02 -1.23713086e+01 -6.67234909e+00 -6.67234909e+00
 -6.67234909e+00 -1.16281680e+00 -2.36963530e-01 -2.36963530e-01
 -2.36963530e-01  9.66291453e+00  1.00803088e+02  5.38270424e+02
  2.39417024e+03  1.16012735e+04  4.11875158e+04  1.10035453e+05
  2.54230047e+05  5.48655513e+05  1.15259902e+06  2.43037745e+06
  5.37510774e+06]
E1 = -706.7355098642919  E_coul = 198.79869977425415
cycle= 1 E= -507.936810090038  delta_E= -1.14e-13  |g|= 9.72e-10  |ddm|= 4.01e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7355098642919  E_coul = 198.79869977425415
  HOMO = -0.236963530460292  LUMO = 9.66291452713344
  mo_energy =
[-1.20306992e+02 -1.23713086e+01 -6.67234909e+00 -6.67234909e+00
 -6.67234909e+00 -1.16281680e+00 -2.36963530e-01 -2.36963530e-01
 -2.36963530e-01  9.66291453e+00  1.00803088e+02  5.38270424e+02
  2.39417024e+03  1.16012735e+04  4.11875158e+04  1.10035453e+05
  2.54230047e+05  5.48655513e+05  1.15259902e+06  2.43037745e+06
  5.37510774e+06]
E1 = -706.7355098641124  E_coul = 198.79869977407495
Extra cycle  E= -507.936810090037  delta_E= 3.41e-13  |g|= 1.08e-09  |ddm|= 2.12e-10
    CPU time for scf_cycle      1.76 sec, wall time      0.17 sec
exp = [3.97105353e-01 1.17616814e+06 5.88084071e+05 2.94042035e+05
 1.47021016e+05 7.35105024e+04 3.67552013e+04 7.32998266e+03
 1.83770760e+04 1.24644971e+03 3.30021640e+02 1.03877748e+02
 3.56213980e+01 7.94445520e+00 3.13190399e+00 8.61015839e+00
 4.93390623e-01]
grad_E = [ 5.63731979e-03 -2.45995659e-12  5.24095650e-10  1.81311395e-09
  1.02578136e-08  3.48846931e-08  2.05475085e-07  1.13680357e-05
  5.43795931e-07 -1.12889176e-04  1.46967400e-04 -3.69716668e-05
 -5.18293951e-04  2.31481180e-04 -1.22043684e-03  4.54206696e-03
  7.11767462e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397300270838       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071127        1
[INPUT] 0    0    [1    /1   ]  294042.035046        1
[INPUT] 0    0    [1    /1   ]  147021.014361        1
[INPUT] 0    0    [1    /1   ]  73510.4962975        1
[INPUT] 0    0    [1    /1   ]  36755.1650472        1
[INPUT] 0    0    [1    /1   ]  7327.98442976        1
[INPUT] 0    0    [1    /1   ]  18376.980779         1
[INPUT] 0    0    [1    /1   ]  1261.00478252        1
[INPUT] 0    0    [1    /1   ]  337.038901952        1
[INPUT] 0    0    [1    /1   ]  105.55938195         1
[INPUT] 0    0    [1    /1   ]  35.8847078743        1
[INPUT] 0    0    [1    /1   ]  7.94462153799        1
[INPUT] 0    0    [1    /1   ]  3.12994696399        1
[INPUT] 1    0    [1    /1   ]  8.61282831909        1
[INPUT] 1    0    [1    /1   ]  0.493544339172       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39730027083809644, 1.0]], [0, [1176168.1426093362, 1.0]], [0, [588084.0711266239, 1.0]], [0, [294042.03504554665, 1.0]], [0, [147021.014361359, 1.0]], [0, [73510.49629751092, 1.0]], [0, [36755.16504722469, 1.0]], [0, [7327.9844297603895, 1.0]], [0, [18376.980779048725, 1.0]], [0, [1261.0047825190984, 1.0]], [0, [337.0389019524434, 1.0]], [0, [105.55938195016796, 1.0]], [0, [35.884707874278824, 1.0]], [0, [7.944621537987859, 1.0]], [0, [3.129946963992474, 1.0]], [1, [8.612828319085652, 1.0]], [1, [0.4935443391718255, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39730027]
bas 1, expnt(s) = [1176168.14260934]
bas 2, expnt(s) = [588084.07112662]
bas 3, expnt(s) = [294042.03504555]
bas 4, expnt(s) = [147021.01436136]
bas 5, expnt(s) = [73510.49629751]
bas 6, expnt(s) = [36755.16504722]
bas 7, expnt(s) = [7327.98442976]
bas 8, expnt(s) = [18376.98077905]
bas 9, expnt(s) = [1261.00478252]
bas 10, expnt(s) = [337.03890195]
bas 11, expnt(s) = [105.55938195]
bas 12, expnt(s) = [35.88470787]
bas 13, expnt(s) = [7.94462154]
bas 14, expnt(s) = [3.12994696]
bas 15, expnt(s) = [8.61282832]
bas 16, expnt(s) = [0.49354434]
CPU time:      1276.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97300271e-01 1.26431174e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530711e+04 2.94042035e+05 3.19023069e+04
 1.47021014e+05 1.89692249e+04 7.35104963e+04 1.12791674e+04
 3.67551650e+04 6.70662166e+03 7.32798443e+03 2.00102921e+03
 1.83769808e+04 3.98768317e+03 1.26100478e+03 5.34629076e+02
 3.37038902e+02 1.98735315e+02 1.05559382e+02 8.32027447e+01
 3.58847079e+01 3.70422267e+01 7.94462154e+00 1.19555603e+01
 3.12994696e+00 5.94521765e+00 8.61282832e+00 4.30443972e+01
 4.93544339e-01 1.20681892e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32435459047478
cond(S) = 12590.008132911415
E1 = -689.4090806028918  E_coul = 184.975652575223
init E= -504.433428027669
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.673949662548195  LUMO = 8.78294680049094
  mo_energy =
[-1.21693096e+02 -1.33824136e+01 -7.62367175e+00 -7.62367175e+00
 -7.62367175e+00 -1.63926312e+00 -6.73949663e-01 -6.73949663e-01
 -6.73949663e-01  8.78294680e+00  1.00693852e+02  5.47232072e+02
  2.43314779e+03  1.16730821e+04  4.12633508e+04  1.10108815e+05
  2.54300812e+05  5.48724070e+05  1.15266559e+06  2.43044210e+06
  5.37517038e+06]
E1 = -707.1419243598768  E_coul = 199.2111383838911
cycle= 1 E= -507.930785975986  delta_E= -3.5  |g|= 0.445  |ddm|= 0.351
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592074
diis-c [-0.35055174  1.        ]
  HOMO = -0.231590329331777  LUMO = 9.68101864114916
  mo_energy =
[-1.20242005e+02 -1.23450373e+01 -6.64043739e+00 -6.64043739e+00
 -6.64043739e+00 -1.15988968e+00 -2.31590329e-01 -2.31590329e-01
 -2.31590329e-01  9.68101864e+00  1.02032514e+02  5.48668666e+02
  2.43452615e+03  1.16743399e+04  4.12645366e+04  1.10109962e+05
  2.54301932e+05  5.48725169e+05  1.15266667e+06  2.43044317e+06
  5.37517145e+06]
E1 = -706.7747875604888  E_coul = 198.83734000546684
cycle= 2 E= -507.937447555022  delta_E= -0.00666  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155629
diis-c [-2.34753761e-04  4.59042804e-03  9.95409572e-01]
  HOMO = -0.236304576398446  LUMO = 9.66996504416421
  mo_energy =
[-1.20301352e+02 -1.23684166e+01 -6.66940529e+00 -6.66940529e+00
 -6.66940529e+00 -1.16230321e+00 -2.36304576e-01 -2.36304576e-01
 -2.36304576e-01  9.66996504e+00  1.01988830e+02  5.48607078e+02
  2.43445138e+03  1.16742558e+04  4.12644494e+04  1.10109874e+05
  2.54301842e+05  5.48725080e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7592145381947  E_coul = 198.8217537105859
cycle= 3 E= -507.937460827609  delta_E= -1.33e-05  |g|= 0.000915  |ddm|= 0.00933
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000759504
diis-c [-1.66013769e-08  4.47516169e-05 -5.02268388e-02  1.05018209e+00]
  HOMO = -0.236548803611431  LUMO = 9.66940492938637
  mo_energy =
[-1.20304054e+02 -1.23695964e+01 -6.67083893e+00 -6.67083893e+00
 -6.67083893e+00 -1.16242318e+00 -2.36548804e-01 -2.36548804e-01
 -2.36548804e-01  9.66940493e+00  1.01986763e+02  5.48604337e+02
  2.43444825e+03  1.16742525e+04  4.12644459e+04  1.10109870e+05
  2.54301839e+05  5.48725076e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7584170252389  E_coul = 198.8209561629667
cycle= 4 E= -507.937460862272  delta_E= -3.47e-08  |g|= 7.49e-06  |ddm|= 0.000505
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.39393e-06
diis-c [-5.58494850e-12 -1.95534530e-06  2.44689968e-03 -4.88648014e-02
  1.04641986e+00]
  HOMO = -0.236549872895001  LUMO = 9.66940360330008
  mo_energy =
[-1.20304053e+02 -1.23696001e+01 -6.67084183e+00 -6.67084183e+00
 -6.67084183e+00 -1.16242378e+00 -2.36549873e-01 -2.36549873e-01
 -2.36549873e-01  9.66940360e+00  1.01986761e+02  5.48604338e+02
  2.43444825e+03  1.16742525e+04  4.12644459e+04  1.10109870e+05
  2.54301839e+05  5.48725076e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7584150582865  E_coul = 198.82095419601248
cycle= 5 E= -507.937460862274  delta_E= -1.71e-12  |g|= 1.49e-07  |ddm|= 2.93e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7584150582865  E_coul = 198.82095419601248
  HOMO = -0.236549909332771  LUMO = 9.66940353247264
  mo_energy =
[-1.20304053e+02 -1.23696003e+01 -6.67084201e+00 -6.67084201e+00
 -6.67084201e+00 -1.16242380e+00 -2.36549909e-01 -2.36549909e-01
 -2.36549909e-01  9.66940353e+00  1.01986761e+02  5.48604338e+02
  2.43444825e+03  1.16742525e+04  4.12644459e+04  1.10109870e+05
  2.54301839e+05  5.48725076e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7584149573937  E_coul = 198.8209540951195
Extra cycle  E= -507.937460862274  delta_E= -2.27e-13  |g|= 7.77e-09  |ddm|= 7.85e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
exp = [3.97300271e-01 1.17616814e+06 5.88084071e+05 2.94042035e+05
 1.47021014e+05 7.35104963e+04 3.67551650e+04 7.32798443e+03
 1.83769808e+04 1.26100478e+03 3.37038902e+02 1.05559382e+02
 3.58847079e+01 7.94462154e+00 3.12994696e+00 8.61282832e+00
 4.93544339e-01]
E = -507.9374608622742
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397300270838       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.071127        1
[INPUT] 0    0    [1    /1   ]  294042.035046        1
[INPUT] 0    0    [1    /1   ]  147021.014361        1
[INPUT] 0    0    [1    /1   ]  73510.4962975        1
[INPUT] 0    0    [1    /1   ]  36755.1650472        1
[INPUT] 0    0    [1    /1   ]  7327.98442976        1
[INPUT] 0    0    [1    /1   ]  18376.980779         1
[INPUT] 0    0    [1    /1   ]  1261.00478252        1
[INPUT] 0    0    [1    /1   ]  337.038901952        1
[INPUT] 0    0    [1    /1   ]  105.55938195         1
[INPUT] 0    0    [1    /1   ]  35.8847078743        1
[INPUT] 0    0    [1    /1   ]  7.94462153799        1
[INPUT] 0    0    [1    /1   ]  3.12994696399        1
[INPUT] 1    0    [1    /1   ]  8.61282831909        1
[INPUT] 1    0    [1    /1   ]  0.493544339172       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39730027083809644, 1.0]], [0, [1176168.1426093362, 1.0]], [0, [588084.0711266239, 1.0]], [0, [294042.03504554665, 1.0]], [0, [147021.014361359, 1.0]], [0, [73510.49629751092, 1.0]], [0, [36755.16504722469, 1.0]], [0, [7327.9844297603895, 1.0]], [0, [18376.980779048725, 1.0]], [0, [1261.0047825190984, 1.0]], [0, [337.0389019524434, 1.0]], [0, [105.55938195016796, 1.0]], [0, [35.884707874278824, 1.0]], [0, [7.944621537987859, 1.0]], [0, [3.129946963992474, 1.0]], [1, [8.612828319085652, 1.0]], [1, [0.4935443391718255, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39730027]
bas 1, expnt(s) = [1176168.14260934]
bas 2, expnt(s) = [588084.07112662]
bas 3, expnt(s) = [294042.03504555]
bas 4, expnt(s) = [147021.01436136]
bas 5, expnt(s) = [73510.49629751]
bas 6, expnt(s) = [36755.16504722]
bas 7, expnt(s) = [7327.98442976]
bas 8, expnt(s) = [18376.98077905]
bas 9, expnt(s) = [1261.00478252]
bas 10, expnt(s) = [337.03890195]
bas 11, expnt(s) = [105.55938195]
bas 12, expnt(s) = [35.88470787]
bas 13, expnt(s) = [7.94462154]
bas 14, expnt(s) = [3.12994696]
bas 15, expnt(s) = [8.61282832]
bas 16, expnt(s) = [0.49354434]
CPU time:      1277.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97300271e-01 1.26431174e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530711e+04 2.94042035e+05 3.19023069e+04
 1.47021014e+05 1.89692249e+04 7.35104963e+04 1.12791674e+04
 3.67551650e+04 6.70662166e+03 7.32798443e+03 2.00102921e+03
 1.83769808e+04 3.98768317e+03 1.26100478e+03 5.34629076e+02
 3.37038902e+02 1.98735315e+02 1.05559382e+02 8.32027447e+01
 3.58847079e+01 3.70422267e+01 7.94462154e+00 1.19555603e+01
 3.12994696e+00 5.94521765e+00 8.61282832e+00 4.30443972e+01
 4.93544339e-01 1.20681892e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32435459047478
cond(S) = 12590.008132911415
E1 = -689.4090806028918  E_coul = 184.975652575223
init E= -504.433428027669
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.673949662548195  LUMO = 8.78294680049094
  mo_energy =
[-1.21693096e+02 -1.33824136e+01 -7.62367175e+00 -7.62367175e+00
 -7.62367175e+00 -1.63926312e+00 -6.73949663e-01 -6.73949663e-01
 -6.73949663e-01  8.78294680e+00  1.00693852e+02  5.47232072e+02
  2.43314779e+03  1.16730821e+04  4.12633508e+04  1.10108815e+05
  2.54300812e+05  5.48724070e+05  1.15266559e+06  2.43044210e+06
  5.37517038e+06]
E1 = -707.1419243598768  E_coul = 199.2111383838911
cycle= 1 E= -507.930785975986  delta_E= -3.5  |g|= 0.445  |ddm|= 0.351
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.592074
diis-c [-0.35055174  1.        ]
  HOMO = -0.231590329331777  LUMO = 9.68101864114916
  mo_energy =
[-1.20242005e+02 -1.23450373e+01 -6.64043739e+00 -6.64043739e+00
 -6.64043739e+00 -1.15988968e+00 -2.31590329e-01 -2.31590329e-01
 -2.31590329e-01  9.68101864e+00  1.02032514e+02  5.48668666e+02
  2.43452615e+03  1.16743399e+04  4.12645366e+04  1.10109962e+05
  2.54301932e+05  5.48725169e+05  1.15266667e+06  2.43044317e+06
  5.37517145e+06]
E1 = -706.7747875604888  E_coul = 198.83734000546684
cycle= 2 E= -507.937447555022  delta_E= -0.00666  |g|= 0.0185  |ddm|= 0.202
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155629
diis-c [-2.34753761e-04  4.59042804e-03  9.95409572e-01]
  HOMO = -0.236304576398446  LUMO = 9.66996504416421
  mo_energy =
[-1.20301352e+02 -1.23684166e+01 -6.66940529e+00 -6.66940529e+00
 -6.66940529e+00 -1.16230321e+00 -2.36304576e-01 -2.36304576e-01
 -2.36304576e-01  9.66996504e+00  1.01988830e+02  5.48607078e+02
  2.43445138e+03  1.16742558e+04  4.12644494e+04  1.10109874e+05
  2.54301842e+05  5.48725080e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7592145381947  E_coul = 198.8217537105859
cycle= 3 E= -507.937460827609  delta_E= -1.33e-05  |g|= 0.000915  |ddm|= 0.00933
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000759504
diis-c [-1.66013769e-08  4.47516169e-05 -5.02268388e-02  1.05018209e+00]
  HOMO = -0.236548803611431  LUMO = 9.66940492938637
  mo_energy =
[-1.20304054e+02 -1.23695964e+01 -6.67083893e+00 -6.67083893e+00
 -6.67083893e+00 -1.16242318e+00 -2.36548804e-01 -2.36548804e-01
 -2.36548804e-01  9.66940493e+00  1.01986763e+02  5.48604337e+02
  2.43444825e+03  1.16742525e+04  4.12644459e+04  1.10109870e+05
  2.54301839e+05  5.48725076e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7584170252389  E_coul = 198.8209561629667
cycle= 4 E= -507.937460862272  delta_E= -3.47e-08  |g|= 7.49e-06  |ddm|= 0.000505
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.39393e-06
diis-c [-5.58494850e-12 -1.95534530e-06  2.44689968e-03 -4.88648014e-02
  1.04641986e+00]
  HOMO = -0.236549872895001  LUMO = 9.66940360330008
  mo_energy =
[-1.20304053e+02 -1.23696001e+01 -6.67084183e+00 -6.67084183e+00
 -6.67084183e+00 -1.16242378e+00 -2.36549873e-01 -2.36549873e-01
 -2.36549873e-01  9.66940360e+00  1.01986761e+02  5.48604338e+02
  2.43444825e+03  1.16742525e+04  4.12644459e+04  1.10109870e+05
  2.54301839e+05  5.48725076e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7584150582865  E_coul = 198.82095419601248
cycle= 5 E= -507.937460862274  delta_E= -1.71e-12  |g|= 1.49e-07  |ddm|= 2.93e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7584150582865  E_coul = 198.82095419601248
  HOMO = -0.236549909332771  LUMO = 9.66940353247264
  mo_energy =
[-1.20304053e+02 -1.23696003e+01 -6.67084201e+00 -6.67084201e+00
 -6.67084201e+00 -1.16242380e+00 -2.36549909e-01 -2.36549909e-01
 -2.36549909e-01  9.66940353e+00  1.01986761e+02  5.48604338e+02
  2.43444825e+03  1.16742525e+04  4.12644459e+04  1.10109870e+05
  2.54301839e+05  5.48725076e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7584149573937  E_coul = 198.8209540951195
Extra cycle  E= -507.937460862274  delta_E= -2.27e-13  |g|= 7.77e-09  |ddm|= 7.85e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12590.008132911415
E1 = -706.7584149573937  E_coul = 198.8209540951195
init E= -507.937460862274
    CPU time for initialize scf      1.39 sec, wall time      0.09 sec
  HOMO = -0.236549911100659  LUMO = 9.66940352892726
  mo_energy =
[-1.20304053e+02 -1.23696003e+01 -6.67084202e+00 -6.67084202e+00
 -6.67084202e+00 -1.16242380e+00 -2.36549911e-01 -2.36549911e-01
 -2.36549911e-01  9.66940353e+00  1.01986761e+02  5.48604338e+02
  2.43444825e+03  1.16742525e+04  4.12644459e+04  1.10109870e+05
  2.54301839e+05  5.48725076e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7584149526851  E_coul = 198.82095409041133
cycle= 1 E= -507.937460862274  delta_E= 3.41e-13  |g|= 1.26e-09  |ddm|= 4e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7584149526851  E_coul = 198.82095409041133
  HOMO = -0.236549911189626  LUMO = 9.66940352688987
  mo_energy =
[-1.20304053e+02 -1.23696003e+01 -6.67084202e+00 -6.67084202e+00
 -6.67084202e+00 -1.16242380e+00 -2.36549911e-01 -2.36549911e-01
 -2.36549911e-01  9.66940353e+00  1.01986761e+02  5.48604338e+02
  2.43444825e+03  1.16742525e+04  4.12644459e+04  1.10109870e+05
  2.54301839e+05  5.48725076e+05  1.15266658e+06  2.43044308e+06
  5.37517136e+06]
E1 = -706.7584149524006  E_coul = 198.82095409012624
Extra cycle  E= -507.937460862274  delta_E= -5.12e-13  |g|= 1.2e-09  |ddm|= 2.34e-10
    CPU time for scf_cycle      1.58 sec, wall time      0.15 sec
exp = [3.97300271e-01 1.17616814e+06 5.88084071e+05 2.94042035e+05
 1.47021014e+05 7.35104963e+04 3.67551650e+04 7.32798443e+03
 1.83769808e+04 1.26100478e+03 3.37038902e+02 1.05559382e+02
 3.58847079e+01 7.94462154e+00 3.12994696e+00 8.61282832e+00
 4.93544339e-01]
grad_E = [ 8.20612950e-03 -5.17188426e-12  5.06988864e-10  1.74681049e-09
  9.93377043e-09  3.36322046e-08  1.99105505e-07  1.10857254e-05
  5.21691491e-07 -1.18555237e-04  2.15588666e-04 -4.92757227e-05
 -7.51641534e-04  3.44138994e-04 -1.79319143e-03  6.60557496e-03
  1.03466844e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397460685184       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.070932        1
[INPUT] 0    0    [1    /1   ]  294042.034375        1
[INPUT] 0    0    [1    /1   ]  147021.010551        1
[INPUT] 0    0    [1    /1   ]  73510.4833877        1
[INPUT] 0    0    [1    /1   ]  36755.0887051        1
[INPUT] 0    0    [1    /1   ]  7323.78116276        1
[INPUT] 0    0    [1    /1   ]  18376.7803031        1
[INPUT] 0    0    [1    /1   ]  1292.16836973        1
[INPUT] 0    0    [1    /1   ]  349.181641105        1
[INPUT] 0    0    [1    /1   ]  108.518554289        1
[INPUT] 0    0    [1    /1   ]  36.4571755896        1
[INPUT] 0    0    [1    /1   ]  7.95920140796        1
[INPUT] 0    0    [1    /1   ]  3.13629344441        1
[INPUT] 1    0    [1    /1   ]  8.61507216485        1
[INPUT] 1    0    [1    /1   ]  0.493671101273       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3974606851839381, 1.0]], [0, [1176168.1426112119, 1.0]], [0, [588084.0709320997, 1.0]], [0, [294042.03437499143, 1.0]], [0, [147021.01055052993, 1.0]], [0, [73510.48338768519, 1.0]], [0, [36755.08870512734, 1.0]], [0, [7323.781162759302, 1.0]], [0, [18376.78030307241, 1.0]], [0, [1292.1683697327649, 1.0]], [0, [349.1816411047014, 1.0]], [0, [108.51855428937287, 1.0]], [0, [36.45717558955591, 1.0]], [0, [7.959201407964671, 1.0]], [0, [3.1362934444066046, 1.0]], [1, [8.61507216485232, 1.0]], [1, [0.4936711012733292, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39746069]
bas 1, expnt(s) = [1176168.14261121]
bas 2, expnt(s) = [588084.0709321]
bas 3, expnt(s) = [294042.03437499]
bas 4, expnt(s) = [147021.01055053]
bas 5, expnt(s) = [73510.48338769]
bas 6, expnt(s) = [36755.08870513]
bas 7, expnt(s) = [7323.78116276]
bas 8, expnt(s) = [18376.78030307]
bas 9, expnt(s) = [1292.16836973]
bas 10, expnt(s) = [349.1816411]
bas 11, expnt(s) = [108.51855429]
bas 12, expnt(s) = [36.45717559]
bas 13, expnt(s) = [7.95920141]
bas 14, expnt(s) = [3.13629344]
bas 15, expnt(s) = [8.61507216]
bas 16, expnt(s) = [0.4936711]
CPU time:      1281.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97460685e-01 1.26469458e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530711e+04 2.94042034e+05 3.19023069e+04
 1.47021011e+05 1.89692245e+04 7.35104834e+04 1.12791659e+04
 3.67550887e+04 6.70661121e+03 7.32378116e+03 2.00016832e+03
 1.83767803e+04 3.98765054e+03 1.29216837e+03 5.44508111e+02
 3.49181641e+02 2.04081471e+02 1.08518554e+02 8.49460177e+01
 3.64571756e+01 3.74845489e+01 7.95920141e+00 1.19720120e+01
 3.13629344e+00 5.95425653e+00 8.61507216e+00 4.30584153e+01
 4.93671101e-01 1.20720639e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324143484272653
cond(S) = 12621.114321910367
E1 = -689.4285054210055  E_coul = 184.99009581969446
init E= -504.438409601311
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.6738067999916  LUMO = 8.83459752442243
  mo_energy =
[-1.21691251e+02 -1.33812729e+01 -7.62269343e+00 -7.62269343e+00
 -7.62269343e+00 -1.63912374e+00 -6.73806800e-01 -6.73806800e-01
 -6.73806800e-01  8.83459752e+00  1.03102149e+02  5.65876904e+02
  2.50904289e+03  1.18168530e+04  4.14165513e+04  1.10257262e+05
  2.54444050e+05  5.48862865e+05  1.15280038e+06  2.43057304e+06
  5.37529731e+06]
E1 = -707.1615885393744  E_coul = 199.2294619146511
cycle= 1 E= -507.932126624723  delta_E= -3.49  |g|= 0.444  |ddm|= 0.35
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.590291
diis-c [-0.34844346  1.        ]
  HOMO = -0.231256870180873  LUMO = 9.73474792125394
  mo_energy =
[-1.20239822e+02 -1.23436638e+01 -6.63922018e+00 -6.63922018e+00
 -6.63922018e+00 -1.15959390e+00 -2.31256870e-01 -2.31256870e-01
 -2.31256870e-01  9.73474792e+00  1.04445010e+02  5.67313951e+02
  2.51042003e+03  1.18181114e+04  4.14177382e+04  1.10258409e+05
  2.54445171e+05  5.48863966e+05  1.15280146e+06  2.43057412e+06
  5.37529838e+06]
E1 = -706.7958035256535  E_coul = 198.85704325691003
cycle= 2 E= -507.938760268743  delta_E= -0.00663  |g|= 0.0185  |ddm|= 0.201
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155269
diis-c [-2.33446641e-04  4.66194179e-03  9.95338058e-01]
  HOMO = -0.235942952866075  LUMO = 9.72368929363224
  mo_energy =
[-1.20299034e+02 -1.23669303e+01 -6.66807090e+00 -6.66807090e+00
 -6.66807090e+00 -1.16198974e+00 -2.35942953e-01 -2.35942953e-01
 -2.35942953e-01  9.72368929e+00  1.04401080e+02  5.67252129e+02
  2.51034520e+03  1.18180275e+04  4.14176512e+04  1.10258321e+05
  2.54445082e+05  5.48863877e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7803412614155  E_coul = 198.84156787367556
cycle= 3 E= -507.93877338774  delta_E= -1.31e-05  |g|= 0.000911  |ddm|= 0.00924
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757526
diis-c [-1.59962170e-08  4.37368620e-05 -5.02390198e-02  1.05019528e+00]
  HOMO = -0.236185209742508  LUMO = 9.72313021735933
  mo_energy =
[-1.20301727e+02 -1.23681022e+01 -6.66949645e+00 -6.66949645e+00
 -6.66949645e+00 -1.16210859e+00 -2.36185210e-01 -2.36185210e-01
 -2.36185210e-01  9.72313022e+00  1.04399005e+02  5.67249385e+02
  2.51034207e+03  1.18180241e+04  4.14176477e+04  1.10258318e+05
  2.54445078e+05  5.48863873e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7795509307762  E_coul = 198.84077750894068
cycle= 4 E= -507.938773421835  delta_E= -3.41e-08  |g|= 7.33e-06  |ddm|= 0.000499
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.26429e-06
diis-c [-5.45341186e-12 -1.92262273e-06  2.43383306e-03 -4.85444352e-02
  1.04611252e+00]
  HOMO = -0.236186233644322  LUMO = 9.72312897512901
  mo_energy =
[-1.20301727e+02 -1.23681058e+01 -6.66949916e+00 -6.66949916e+00
 -6.66949916e+00 -1.16210917e+00 -2.36186234e-01 -2.36186234e-01
 -2.36186234e-01  9.72312898e+00  1.04399004e+02  5.67249386e+02
  2.51034207e+03  1.18180241e+04  4.14176477e+04  1.10258318e+05
  2.54445078e+05  5.48863873e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7795490915479  E_coul = 198.84077566971044
cycle= 5 E= -507.938773421837  delta_E= -1.99e-12  |g|= 1.47e-07  |ddm|= 2.82e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7795490915479  E_coul = 198.84077566971044
  HOMO = -0.23618626984587  LUMO = 9.72312890217766
  mo_energy =
[-1.20301727e+02 -1.23681060e+01 -6.66949934e+00 -6.66949934e+00
 -6.66949934e+00 -1.16210919e+00 -2.36186270e-01 -2.36186270e-01
 -2.36186270e-01  9.72312890e+00  1.04399004e+02  5.67249386e+02
  2.51034207e+03  1.18180241e+04  4.14176477e+04  1.10258318e+05
  2.54445078e+05  5.48863873e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7795489914752  E_coul = 198.84077556963757
Extra cycle  E= -507.938773421838  delta_E= -1.14e-13  |g|= 7.76e-09  |ddm|= 7.77e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.97460685e-01 1.17616814e+06 5.88084071e+05 2.94042034e+05
 1.47021011e+05 7.35104834e+04 3.67550887e+04 7.32378116e+03
 1.83767803e+04 1.29216837e+03 3.49181641e+02 1.08518554e+02
 3.64571756e+01 7.95920141e+00 3.13629344e+00 8.61507216e+00
 4.93671101e-01]
E = -507.9387734218376
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397460685184       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.070932        1
[INPUT] 0    0    [1    /1   ]  294042.034375        1
[INPUT] 0    0    [1    /1   ]  147021.010551        1
[INPUT] 0    0    [1    /1   ]  73510.4833877        1
[INPUT] 0    0    [1    /1   ]  36755.0887051        1
[INPUT] 0    0    [1    /1   ]  7323.78116276        1
[INPUT] 0    0    [1    /1   ]  18376.7803031        1
[INPUT] 0    0    [1    /1   ]  1292.16836973        1
[INPUT] 0    0    [1    /1   ]  349.181641105        1
[INPUT] 0    0    [1    /1   ]  108.518554289        1
[INPUT] 0    0    [1    /1   ]  36.4571755896        1
[INPUT] 0    0    [1    /1   ]  7.95920140796        1
[INPUT] 0    0    [1    /1   ]  3.13629344441        1
[INPUT] 1    0    [1    /1   ]  8.61507216485        1
[INPUT] 1    0    [1    /1   ]  0.493671101273       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3974606851839381, 1.0]], [0, [1176168.1426112119, 1.0]], [0, [588084.0709320997, 1.0]], [0, [294042.03437499143, 1.0]], [0, [147021.01055052993, 1.0]], [0, [73510.48338768519, 1.0]], [0, [36755.08870512734, 1.0]], [0, [7323.781162759302, 1.0]], [0, [18376.78030307241, 1.0]], [0, [1292.1683697327649, 1.0]], [0, [349.1816411047014, 1.0]], [0, [108.51855428937287, 1.0]], [0, [36.45717558955591, 1.0]], [0, [7.959201407964671, 1.0]], [0, [3.1362934444066046, 1.0]], [1, [8.61507216485232, 1.0]], [1, [0.4936711012733292, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39746069]
bas 1, expnt(s) = [1176168.14261121]
bas 2, expnt(s) = [588084.0709321]
bas 3, expnt(s) = [294042.03437499]
bas 4, expnt(s) = [147021.01055053]
bas 5, expnt(s) = [73510.48338769]
bas 6, expnt(s) = [36755.08870513]
bas 7, expnt(s) = [7323.78116276]
bas 8, expnt(s) = [18376.78030307]
bas 9, expnt(s) = [1292.16836973]
bas 10, expnt(s) = [349.1816411]
bas 11, expnt(s) = [108.51855429]
bas 12, expnt(s) = [36.45717559]
bas 13, expnt(s) = [7.95920141]
bas 14, expnt(s) = [3.13629344]
bas 15, expnt(s) = [8.61507216]
bas 16, expnt(s) = [0.4936711]
CPU time:      1282.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97460685e-01 1.26469458e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530711e+04 2.94042034e+05 3.19023069e+04
 1.47021011e+05 1.89692245e+04 7.35104834e+04 1.12791659e+04
 3.67550887e+04 6.70661121e+03 7.32378116e+03 2.00016832e+03
 1.83767803e+04 3.98765054e+03 1.29216837e+03 5.44508111e+02
 3.49181641e+02 2.04081471e+02 1.08518554e+02 8.49460177e+01
 3.64571756e+01 3.74845489e+01 7.95920141e+00 1.19720120e+01
 3.13629344e+00 5.95425653e+00 8.61507216e+00 4.30584153e+01
 4.93671101e-01 1.20720639e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324143484272653
cond(S) = 12621.114321910367
E1 = -689.4285054210055  E_coul = 184.99009581969446
init E= -504.438409601311
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.6738067999916  LUMO = 8.83459752442243
  mo_energy =
[-1.21691251e+02 -1.33812729e+01 -7.62269343e+00 -7.62269343e+00
 -7.62269343e+00 -1.63912374e+00 -6.73806800e-01 -6.73806800e-01
 -6.73806800e-01  8.83459752e+00  1.03102149e+02  5.65876904e+02
  2.50904289e+03  1.18168530e+04  4.14165513e+04  1.10257262e+05
  2.54444050e+05  5.48862865e+05  1.15280038e+06  2.43057304e+06
  5.37529731e+06]
E1 = -707.1615885393744  E_coul = 199.2294619146511
cycle= 1 E= -507.932126624723  delta_E= -3.49  |g|= 0.444  |ddm|= 0.35
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.590291
diis-c [-0.34844346  1.        ]
  HOMO = -0.231256870180873  LUMO = 9.73474792125394
  mo_energy =
[-1.20239822e+02 -1.23436638e+01 -6.63922018e+00 -6.63922018e+00
 -6.63922018e+00 -1.15959390e+00 -2.31256870e-01 -2.31256870e-01
 -2.31256870e-01  9.73474792e+00  1.04445010e+02  5.67313951e+02
  2.51042003e+03  1.18181114e+04  4.14177382e+04  1.10258409e+05
  2.54445171e+05  5.48863966e+05  1.15280146e+06  2.43057412e+06
  5.37529838e+06]
E1 = -706.7958035256535  E_coul = 198.85704325691003
cycle= 2 E= -507.938760268743  delta_E= -0.00663  |g|= 0.0185  |ddm|= 0.201
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0155269
diis-c [-2.33446641e-04  4.66194179e-03  9.95338058e-01]
  HOMO = -0.235942952866075  LUMO = 9.72368929363224
  mo_energy =
[-1.20299034e+02 -1.23669303e+01 -6.66807090e+00 -6.66807090e+00
 -6.66807090e+00 -1.16198974e+00 -2.35942953e-01 -2.35942953e-01
 -2.35942953e-01  9.72368929e+00  1.04401080e+02  5.67252129e+02
  2.51034520e+03  1.18180275e+04  4.14176512e+04  1.10258321e+05
  2.54445082e+05  5.48863877e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7803412614155  E_coul = 198.84156787367556
cycle= 3 E= -507.93877338774  delta_E= -1.31e-05  |g|= 0.000911  |ddm|= 0.00924
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757526
diis-c [-1.59962170e-08  4.37368620e-05 -5.02390198e-02  1.05019528e+00]
  HOMO = -0.236185209742508  LUMO = 9.72313021735933
  mo_energy =
[-1.20301727e+02 -1.23681022e+01 -6.66949645e+00 -6.66949645e+00
 -6.66949645e+00 -1.16210859e+00 -2.36185210e-01 -2.36185210e-01
 -2.36185210e-01  9.72313022e+00  1.04399005e+02  5.67249385e+02
  2.51034207e+03  1.18180241e+04  4.14176477e+04  1.10258318e+05
  2.54445078e+05  5.48863873e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7795509307762  E_coul = 198.84077750894068
cycle= 4 E= -507.938773421835  delta_E= -3.41e-08  |g|= 7.33e-06  |ddm|= 0.000499
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.26429e-06
diis-c [-5.45341186e-12 -1.92262273e-06  2.43383306e-03 -4.85444352e-02
  1.04611252e+00]
  HOMO = -0.236186233644322  LUMO = 9.72312897512901
  mo_energy =
[-1.20301727e+02 -1.23681058e+01 -6.66949916e+00 -6.66949916e+00
 -6.66949916e+00 -1.16210917e+00 -2.36186234e-01 -2.36186234e-01
 -2.36186234e-01  9.72312898e+00  1.04399004e+02  5.67249386e+02
  2.51034207e+03  1.18180241e+04  4.14176477e+04  1.10258318e+05
  2.54445078e+05  5.48863873e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7795490915479  E_coul = 198.84077566971044
cycle= 5 E= -507.938773421837  delta_E= -1.99e-12  |g|= 1.47e-07  |ddm|= 2.82e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7795490915479  E_coul = 198.84077566971044
  HOMO = -0.23618626984587  LUMO = 9.72312890217766
  mo_energy =
[-1.20301727e+02 -1.23681060e+01 -6.66949934e+00 -6.66949934e+00
 -6.66949934e+00 -1.16210919e+00 -2.36186270e-01 -2.36186270e-01
 -2.36186270e-01  9.72312890e+00  1.04399004e+02  5.67249386e+02
  2.51034207e+03  1.18180241e+04  4.14176477e+04  1.10258318e+05
  2.54445078e+05  5.48863873e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7795489914752  E_coul = 198.84077556963757
Extra cycle  E= -507.938773421838  delta_E= -1.14e-13  |g|= 7.76e-09  |ddm|= 7.77e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12621.114321910367
E1 = -706.7795489914752  E_coul = 198.84077556963757
init E= -507.938773421838
    CPU time for initialize scf      1.25 sec, wall time      0.08 sec
  HOMO = -0.236186271594725  LUMO = 9.72312889917371
  mo_energy =
[-1.20301727e+02 -1.23681060e+01 -6.66949935e+00 -6.66949935e+00
 -6.66949935e+00 -1.16210919e+00 -2.36186272e-01 -2.36186272e-01
 -2.36186272e-01  9.72312890e+00  1.04399004e+02  5.67249386e+02
  2.51034207e+03  1.18180241e+04  4.14176477e+04  1.10258318e+05
  2.54445078e+05  5.48863873e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7795489868032  E_coul = 198.8407755649658
cycle= 1 E= -507.938773421837  delta_E= 2.27e-13  |g|= 9.36e-10  |ddm|= 3.96e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7795489868032  E_coul = 198.8407755649658
  HOMO = -0.236186271682758  LUMO = 9.72312890009466
  mo_energy =
[-1.20301727e+02 -1.23681060e+01 -6.66949935e+00 -6.66949935e+00
 -6.66949935e+00 -1.16210919e+00 -2.36186272e-01 -2.36186272e-01
 -2.36186272e-01  9.72312890e+00  1.04399004e+02  5.67249386e+02
  2.51034207e+03  1.18180241e+04  4.14176477e+04  1.10258318e+05
  2.54445078e+05  5.48863873e+05  1.15280137e+06  2.43057403e+06
  5.37529829e+06]
E1 = -706.7795489866121  E_coul = 198.8407755647743
Extra cycle  E= -507.938773421838  delta_E= -4.55e-13  |g|= 9.48e-10  |ddm|= 2.03e-10
    CPU time for scf_cycle      1.44 sec, wall time      0.15 sec
exp = [3.97460685e-01 1.17616814e+06 5.88084071e+05 2.94042034e+05
 1.47021011e+05 7.35104834e+04 3.67550887e+04 7.32378116e+03
 1.83767803e+04 1.29216837e+03 3.49181641e+02 1.08518554e+02
 3.64571756e+01 7.95920141e+00 3.13629344e+00 8.61507216e+00
 4.93671101e-01]
grad_E = [ 1.04249265e-02 -1.29083900e-11  4.57399776e-10  1.55538931e-09
  8.99393304e-09  3.00169648e-08  1.80570220e-07  1.01937525e-05
  4.58307665e-07 -1.14746829e-04  2.76628158e-04 -6.58942369e-05
 -9.00784700e-04  4.51395882e-04 -2.33696902e-03  8.38238239e-03
  1.31286789e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397397690182       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.070622        1
[INPUT] 0    0    [1    /1   ]  294042.033305        1
[INPUT] 0    0    [1    /1   ]  147021.004475        1
[INPUT] 0    0    [1    /1   ]  73510.4627981        1
[INPUT] 0    0    [1    /1   ]  36754.9669943        1
[INPUT] 0    0    [1    /1   ]  7317.0793587         1
[INPUT] 0    0    [1    /1   ]  18376.4604544        1
[INPUT] 0    0    [1    /1   ]  1342.65098132        1
[INPUT] 0    0    [1    /1   ]  364.78907347         1
[INPUT] 0    0    [1    /1   ]  112.225398709        1
[INPUT] 0    0    [1    /1   ]  37.2844273091        1
[INPUT] 0    0    [1    /1   ]  8.00279806353        1
[INPUT] 0    0    [1    /1   ]  3.15946152628        1
[INPUT] 1    0    [1    /1   ]  8.61443100135        1
[INPUT] 1    0    [1    /1   ]  0.493625704312       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39739769018218773, 1.0]], [0, [1176168.14261406, 1.0]], [0, [588084.0706219387, 1.0]], [0, [294042.03330547287, 1.0]], [0, [147021.00447485532, 1.0]], [0, [73510.46279809841, 1.0]], [0, [36754.96699431778, 1.0]], [0, [7317.079358704452, 1.0]], [0, [18376.460454432457, 1.0]], [0, [1342.650981315278, 1.0]], [0, [364.7890734700651, 1.0]], [0, [112.22539870891042, 1.0]], [0, [37.28442730910935, 1.0]], [0, [8.002798063527571, 1.0]], [0, [3.1594615262828016, 1.0]], [1, [8.614431001348127, 1.0]], [1, [0.49362570431190006, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39739769]
bas 1, expnt(s) = [1176168.14261406]
bas 2, expnt(s) = [588084.07062194]
bas 3, expnt(s) = [294042.03330547]
bas 4, expnt(s) = [147021.00447486]
bas 5, expnt(s) = [73510.4627981]
bas 6, expnt(s) = [36754.96699432]
bas 7, expnt(s) = [7317.0793587]
bas 8, expnt(s) = [18376.46045443]
bas 9, expnt(s) = [1342.65098132]
bas 10, expnt(s) = [364.78907347]
bas 11, expnt(s) = [112.22539871]
bas 12, expnt(s) = [37.28442731]
bas 13, expnt(s) = [8.00279806]
bas 14, expnt(s) = [3.15946153]
bas 15, expnt(s) = [8.614431]
bas 16, expnt(s) = [0.4936257]
CPU time:      1287.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97397690e-01 1.26454424e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530711e+04 2.94042033e+05 3.19023068e+04
 1.47021004e+05 1.89692239e+04 7.35104628e+04 1.12791635e+04
 3.67549670e+04 6.70659456e+03 7.31707936e+03 1.99879543e+03
 1.83764605e+04 3.98759849e+03 1.34265098e+03 5.60386126e+02
 3.64789073e+02 2.10885340e+02 1.12225399e+02 8.71130846e+01
 3.72844273e+01 3.81206794e+01 8.00279806e+00 1.20211611e+01
 3.15946153e+00 5.98721464e+00 8.61443100e+00 4.30544096e+01
 4.93625704e-01 1.20706762e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324185830595606
cond(S) = 12668.166092131412
E1 = -689.4335005323856  E_coul = 184.9845130033253
init E= -504.44898752906
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.673891870755653  LUMO = 8.96613049976661
  mo_energy =
[-1.21693000e+02 -1.33817164e+01 -7.62308860e+00 -7.62308860e+00
 -7.62308860e+00 -1.63925877e+00 -6.73891871e-01 -6.73891871e-01
 -6.73891871e-01  8.96613050e+00  1.06553169e+02  5.90340025e+02
  2.61623628e+03  1.20305819e+04  4.16475400e+04  1.10481685e+05
  2.54660713e+05  5.49072840e+05  1.15300431e+06  2.43077117e+06
  5.37548937e+06]
E1 = -707.1569425338784  E_coul = 199.2228094961154
cycle= 1 E= -507.934133037763  delta_E= -3.49  |g|= 0.444  |ddm|= 0.349
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.587792
diis-c [-0.34549953  1.        ]
  HOMO = -0.231401120946309  LUMO = 9.87032456464722
  mo_energy =
[-1.20241385e+02 -1.23442243e+01 -6.63973238e+00 -6.63973238e+00
 -6.63973238e+00 -1.15978990e+00 -2.31401121e-01 -2.31401121e-01
 -2.31401121e-01  9.87032456e+00  1.07901103e+02  5.91777386e+02
  2.61761153e+03  1.20318410e+04  4.16487285e+04  1.10482835e+05
  2.54661835e+05  5.49073942e+05  1.15300540e+06  2.43077225e+06
  5.37549044e+06]
E1 = -706.7952740099314  E_coul = 198.8545930046404
cycle= 2 E= -507.940681005291  delta_E= -0.00655  |g|= 0.0183  |ddm|= 0.199
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0154326
diis-c [-2.30243584e-04  4.76725114e-03  9.95232749e-01]
  HOMO = -0.236005883987501  LUMO = 9.85929664696597
  mo_energy =
[-1.20300132e+02 -1.23671760e+01 -6.66823621e+00 -6.66823621e+00
 -6.66823621e+00 -1.16213789e+00 -2.36005884e-01 -2.36005884e-01
 -2.36005884e-01  9.85929665e+00  1.07857089e+02  5.91715581e+02
  2.61753692e+03  1.20317576e+04  4.16486420e+04  1.10482747e+05
  2.54661747e+05  5.49073853e+05  1.15300531e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.7801084815625  E_coul = 198.8394147510656
cycle= 3 E= -507.940693730497  delta_E= -1.27e-05  |g|= 0.000899  |ddm|= 0.00903
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000751571
diis-c [-1.46150900e-08  4.18366023e-05 -5.02039792e-02  1.05016214e+00]
  HOMO = -0.236242455426066  LUMO = 9.85874268049187
  mo_energy =
[-1.20302793e+02 -1.23683255e+01 -6.66963751e+00 -6.66963751e+00
 -6.66963751e+00 -1.16225367e+00 -2.36242455e-01 -2.36242455e-01
 -2.36242455e-01  9.85874268e+00  1.07855022e+02  5.91712853e+02
  2.61753381e+03  1.20317543e+04  4.16486386e+04  1.10482743e+05
  2.54661743e+05  5.49073850e+05  1.15300530e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.7793378074083  E_coul = 198.83864404430398
cycle= 4 E= -507.940693763104  delta_E= -3.26e-08  |g|= 6.92e-06  |ddm|= 0.000485
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.94666e-06
diis-c [-5.14955394e-12 -1.87299369e-06  2.39055699e-03 -4.75989372e-02
  1.04521025e+00]
  HOMO = -0.236243372704746  LUMO = 9.85874162605624
  mo_energy =
[-1.20302792e+02 -1.23683286e+01 -6.66963978e+00 -6.66963978e+00
 -6.66963978e+00 -1.16225419e+00 -2.36243373e-01 -2.36243373e-01
 -2.36243373e-01  9.85874163e+00  1.07855022e+02  5.91712855e+02
  2.61753381e+03  1.20317543e+04  4.16486386e+04  1.10482743e+05
  2.54661743e+05  5.49073850e+05  1.15300530e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.7793362578033  E_coul = 198.83864249469755
cycle= 5 E= -507.940693763106  delta_E= -1.42e-12  |g|= 1.45e-07  |ddm|= 2.56e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7793362578033  E_coul = 198.83864249469755
  HOMO = -0.236243408105732  LUMO = 9.85874155476417
  mo_energy =
[-1.20302793e+02 -1.23683288e+01 -6.66963996e+00 -6.66963996e+00
 -6.66963996e+00 -1.16225421e+00 -2.36243408e-01 -2.36243408e-01
 -2.36243408e-01  9.85874155e+00  1.07855022e+02  5.91712854e+02
  2.61753381e+03  1.20317543e+04  4.16486386e+04  1.10482743e+05
  2.54661743e+05  5.49073850e+05  1.15300530e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.779336160237  E_coul = 198.83864239713157
Extra cycle  E= -507.940693763105  delta_E= 3.41e-13  |g|= 7.56e-09  |ddm|= 7.56e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.97397690e-01 1.17616814e+06 5.88084071e+05 2.94042033e+05
 1.47021004e+05 7.35104628e+04 3.67549670e+04 7.31707936e+03
 1.83764605e+04 1.34265098e+03 3.64789073e+02 1.12225399e+02
 3.72844273e+01 8.00279806e+00 3.15946153e+00 8.61443100e+00
 4.93625704e-01]
E = -507.9406937631054
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397397690182       1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.070622        1
[INPUT] 0    0    [1    /1   ]  294042.033305        1
[INPUT] 0    0    [1    /1   ]  147021.004475        1
[INPUT] 0    0    [1    /1   ]  73510.4627981        1
[INPUT] 0    0    [1    /1   ]  36754.9669943        1
[INPUT] 0    0    [1    /1   ]  7317.0793587         1
[INPUT] 0    0    [1    /1   ]  18376.4604544        1
[INPUT] 0    0    [1    /1   ]  1342.65098132        1
[INPUT] 0    0    [1    /1   ]  364.78907347         1
[INPUT] 0    0    [1    /1   ]  112.225398709        1
[INPUT] 0    0    [1    /1   ]  37.2844273091        1
[INPUT] 0    0    [1    /1   ]  8.00279806353        1
[INPUT] 0    0    [1    /1   ]  3.15946152628        1
[INPUT] 1    0    [1    /1   ]  8.61443100135        1
[INPUT] 1    0    [1    /1   ]  0.493625704312       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39739769018218773, 1.0]], [0, [1176168.14261406, 1.0]], [0, [588084.0706219387, 1.0]], [0, [294042.03330547287, 1.0]], [0, [147021.00447485532, 1.0]], [0, [73510.46279809841, 1.0]], [0, [36754.96699431778, 1.0]], [0, [7317.079358704452, 1.0]], [0, [18376.460454432457, 1.0]], [0, [1342.650981315278, 1.0]], [0, [364.7890734700651, 1.0]], [0, [112.22539870891042, 1.0]], [0, [37.28442730910935, 1.0]], [0, [8.002798063527571, 1.0]], [0, [3.1594615262828016, 1.0]], [1, [8.614431001348127, 1.0]], [1, [0.49362570431190006, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39739769]
bas 1, expnt(s) = [1176168.14261406]
bas 2, expnt(s) = [588084.07062194]
bas 3, expnt(s) = [294042.03330547]
bas 4, expnt(s) = [147021.00447486]
bas 5, expnt(s) = [73510.4627981]
bas 6, expnt(s) = [36754.96699432]
bas 7, expnt(s) = [7317.0793587]
bas 8, expnt(s) = [18376.46045443]
bas 9, expnt(s) = [1342.65098132]
bas 10, expnt(s) = [364.78907347]
bas 11, expnt(s) = [112.22539871]
bas 12, expnt(s) = [37.28442731]
bas 13, expnt(s) = [8.00279806]
bas 14, expnt(s) = [3.15946153]
bas 15, expnt(s) = [8.614431]
bas 16, expnt(s) = [0.4936257]
CPU time:      1287.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97397690e-01 1.26454424e+00 1.17616814e+06 9.02333504e+04
 5.88084071e+05 5.36530711e+04 2.94042033e+05 3.19023068e+04
 1.47021004e+05 1.89692239e+04 7.35104628e+04 1.12791635e+04
 3.67549670e+04 6.70659456e+03 7.31707936e+03 1.99879543e+03
 1.83764605e+04 3.98759849e+03 1.34265098e+03 5.60386126e+02
 3.64789073e+02 2.10885340e+02 1.12225399e+02 8.71130846e+01
 3.72844273e+01 3.81206794e+01 8.00279806e+00 1.20211611e+01
 3.15946153e+00 5.98721464e+00 8.61443100e+00 4.30544096e+01
 4.93625704e-01 1.20706762e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324185830595606
cond(S) = 12668.166092131412
E1 = -689.4335005323856  E_coul = 184.9845130033253
init E= -504.44898752906
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.673891870755653  LUMO = 8.96613049976661
  mo_energy =
[-1.21693000e+02 -1.33817164e+01 -7.62308860e+00 -7.62308860e+00
 -7.62308860e+00 -1.63925877e+00 -6.73891871e-01 -6.73891871e-01
 -6.73891871e-01  8.96613050e+00  1.06553169e+02  5.90340025e+02
  2.61623628e+03  1.20305819e+04  4.16475400e+04  1.10481685e+05
  2.54660713e+05  5.49072840e+05  1.15300431e+06  2.43077117e+06
  5.37548937e+06]
E1 = -707.1569425338784  E_coul = 199.2228094961154
cycle= 1 E= -507.934133037763  delta_E= -3.49  |g|= 0.444  |ddm|= 0.349
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.587792
diis-c [-0.34549953  1.        ]
  HOMO = -0.231401120946309  LUMO = 9.87032456464722
  mo_energy =
[-1.20241385e+02 -1.23442243e+01 -6.63973238e+00 -6.63973238e+00
 -6.63973238e+00 -1.15978990e+00 -2.31401121e-01 -2.31401121e-01
 -2.31401121e-01  9.87032456e+00  1.07901103e+02  5.91777386e+02
  2.61761153e+03  1.20318410e+04  4.16487285e+04  1.10482835e+05
  2.54661835e+05  5.49073942e+05  1.15300540e+06  2.43077225e+06
  5.37549044e+06]
E1 = -706.7952740099314  E_coul = 198.8545930046404
cycle= 2 E= -507.940681005291  delta_E= -0.00655  |g|= 0.0183  |ddm|= 0.199
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0154326
diis-c [-2.30243584e-04  4.76725114e-03  9.95232749e-01]
  HOMO = -0.236005883987501  LUMO = 9.85929664696597
  mo_energy =
[-1.20300132e+02 -1.23671760e+01 -6.66823621e+00 -6.66823621e+00
 -6.66823621e+00 -1.16213789e+00 -2.36005884e-01 -2.36005884e-01
 -2.36005884e-01  9.85929665e+00  1.07857089e+02  5.91715581e+02
  2.61753692e+03  1.20317576e+04  4.16486420e+04  1.10482747e+05
  2.54661747e+05  5.49073853e+05  1.15300531e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.7801084815625  E_coul = 198.8394147510656
cycle= 3 E= -507.940693730497  delta_E= -1.27e-05  |g|= 0.000899  |ddm|= 0.00903
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000751571
diis-c [-1.46150900e-08  4.18366023e-05 -5.02039792e-02  1.05016214e+00]
  HOMO = -0.236242455426066  LUMO = 9.85874268049187
  mo_energy =
[-1.20302793e+02 -1.23683255e+01 -6.66963751e+00 -6.66963751e+00
 -6.66963751e+00 -1.16225367e+00 -2.36242455e-01 -2.36242455e-01
 -2.36242455e-01  9.85874268e+00  1.07855022e+02  5.91712853e+02
  2.61753381e+03  1.20317543e+04  4.16486386e+04  1.10482743e+05
  2.54661743e+05  5.49073850e+05  1.15300530e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.7793378074083  E_coul = 198.83864404430398
cycle= 4 E= -507.940693763104  delta_E= -3.26e-08  |g|= 6.92e-06  |ddm|= 0.000485
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.94666e-06
diis-c [-5.14955394e-12 -1.87299369e-06  2.39055699e-03 -4.75989372e-02
  1.04521025e+00]
  HOMO = -0.236243372704746  LUMO = 9.85874162605624
  mo_energy =
[-1.20302792e+02 -1.23683286e+01 -6.66963978e+00 -6.66963978e+00
 -6.66963978e+00 -1.16225419e+00 -2.36243373e-01 -2.36243373e-01
 -2.36243373e-01  9.85874163e+00  1.07855022e+02  5.91712855e+02
  2.61753381e+03  1.20317543e+04  4.16486386e+04  1.10482743e+05
  2.54661743e+05  5.49073850e+05  1.15300530e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.7793362578033  E_coul = 198.83864249469755
cycle= 5 E= -507.940693763106  delta_E= -1.42e-12  |g|= 1.45e-07  |ddm|= 2.56e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7793362578033  E_coul = 198.83864249469755
  HOMO = -0.236243408105732  LUMO = 9.85874155476417
  mo_energy =
[-1.20302793e+02 -1.23683288e+01 -6.66963996e+00 -6.66963996e+00
 -6.66963996e+00 -1.16225421e+00 -2.36243408e-01 -2.36243408e-01
 -2.36243408e-01  9.85874155e+00  1.07855022e+02  5.91712854e+02
  2.61753381e+03  1.20317543e+04  4.16486386e+04  1.10482743e+05
  2.54661743e+05  5.49073850e+05  1.15300530e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.779336160237  E_coul = 198.83864239713157
Extra cycle  E= -507.940693763105  delta_E= 3.41e-13  |g|= 7.56e-09  |ddm|= 7.56e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12668.166092131412
E1 = -706.779336160237  E_coul = 198.83864239713157
init E= -507.940693763105
    CPU time for initialize scf      1.54 sec, wall time      0.10 sec
  HOMO = -0.236243409800289  LUMO = 9.85874155336697
  mo_energy =
[-1.20302793e+02 -1.23683288e+01 -6.66963996e+00 -6.66963996e+00
 -6.66963996e+00 -1.16225421e+00 -2.36243410e-01 -2.36243410e-01
 -2.36243410e-01  9.85874155e+00  1.07855022e+02  5.91712854e+02
  2.61753381e+03  1.20317543e+04  4.16486386e+04  1.10482743e+05
  2.54661743e+05  5.49073850e+05  1.15300530e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.7793361557113  E_coul = 198.83864239260558
cycle= 1 E= -507.940693763106  delta_E= -3.41e-13  |g|= 2.03e-09  |ddm|= 3.81e-09
    CPU time for cycle= 1      0.13 sec, wall time      0.01 sec
E1 = -706.7793361557113  E_coul = 198.83864239260558
  HOMO = -0.236243409884772  LUMO = 9.85874155064848
  mo_energy =
[-1.20302793e+02 -1.23683288e+01 -6.66963997e+00 -6.66963997e+00
 -6.66963997e+00 -1.16225421e+00 -2.36243410e-01 -2.36243410e-01
 -2.36243410e-01  9.85874155e+00  1.07855022e+02  5.91712854e+02
  2.61753381e+03  1.20317543e+04  4.16486386e+04  1.10482743e+05
  2.54661743e+05  5.49073850e+05  1.15300530e+06  2.43077216e+06
  5.37549035e+06]
E1 = -706.7793361555763  E_coul = 198.83864239247075
Extra cycle  E= -507.940693763106  delta_E= 2.27e-13  |g|= 1.21e-09  |ddm|= 1.79e-10
    CPU time for scf_cycle      1.73 sec, wall time      0.16 sec
exp = [3.97397690e-01 1.17616814e+06 5.88084071e+05 2.94042033e+05
 1.47021004e+05 7.35104628e+04 3.67549670e+04 7.31707936e+03
 1.83764605e+04 1.34265098e+03 3.64789073e+02 1.12225399e+02
 3.72844273e+01 8.00279806e+00 3.15946153e+00 8.61443100e+00
 4.93625704e-01]
grad_E = [ 9.98623339e-03 -2.58700829e-11  3.71016682e-10  1.22511437e-09
  7.35577052e-09  2.37824278e-08  1.48176264e-07  8.56266961e-06
  3.50291678e-07 -9.50408747e-05  2.95911734e-04 -1.22934119e-04
 -6.93747468e-04  4.14884782e-04 -2.22632197e-03  8.00977000e-03
  1.25227188e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397051352705       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.07029         1
[INPUT] 0    0    [1    /1   ]  294042.032162        1
[INPUT] 0    0    [1    /1   ]  147020.99798         1
[INPUT] 0    0    [1    /1   ]  73510.4407773        1
[INPUT] 0    0    [1    /1   ]  36754.8368862        1
[INPUT] 0    0    [1    /1   ]  7309.91433204        1
[INPUT] 0    0    [1    /1   ]  18376.1182146        1
[INPUT] 0    0    [1    /1   ]  1397.71986046        1
[INPUT] 0    0    [1    /1   ]  376.373698248        1
[INPUT] 0    0    [1    /1   ]  114.516548815        1
[INPUT] 0    0    [1    /1   ]  37.8332229086        1
[INPUT] 0    0    [1    /1   ]  8.07345651065        1
[INPUT] 0    0    [1    /1   ]  3.1939366828         1
[INPUT] 1    0    [1    /1   ]  8.61002775517        1
[INPUT] 1    0    [1    /1   ]  0.493354598242       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39705135270498504, 1.0]], [0, [1176168.142616908, 1.0]], [0, [588084.0702903303, 1.0]], [0, [294042.03216152027, 1.0]], [0, [147020.99797980377, 1.0]], [0, [73510.44077730304, 1.0]], [0, [36754.83688622924, 1.0]], [0, [7309.914332035285, 1.0]], [0, [18376.11821463118, 1.0]], [0, [1397.7198604613427, 1.0]], [0, [376.3736982483581, 1.0]], [0, [114.51654881500055, 1.0]], [0, [37.83322290864967, 1.0]], [0, [8.07345651065085, 1.0]], [0, [3.193936682801615, 1.0]], [1, [8.610027755168538, 1.0]], [1, [0.4933545982417409, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39705135]
bas 1, expnt(s) = [1176168.14261691]
bas 2, expnt(s) = [588084.07029033]
bas 3, expnt(s) = [294042.03216152]
bas 4, expnt(s) = [147020.9979798]
bas 5, expnt(s) = [73510.4407773]
bas 6, expnt(s) = [36754.83688623]
bas 7, expnt(s) = [7309.91433204]
bas 8, expnt(s) = [18376.11821463]
bas 9, expnt(s) = [1397.71986046]
bas 10, expnt(s) = [376.37369825]
bas 11, expnt(s) = [114.51654882]
bas 12, expnt(s) = [37.83322291]
bas 13, expnt(s) = [8.07345651]
bas 14, expnt(s) = [3.19393668]
bas 15, expnt(s) = [8.61002776]
bas 16, expnt(s) = [0.4933546]
CPU time:      1292.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97051353e-01 1.26371760e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042032e+05 3.19023067e+04
 1.47020998e+05 1.89692233e+04 7.35104408e+04 1.12791610e+04
 3.67548369e+04 6.70657675e+03 7.30991433e+03 1.99732731e+03
 1.83761182e+04 3.98754279e+03 1.39771986e+03 5.77537417e+02
 3.76373698e+02 2.15888483e+02 1.14516549e+02 8.84435595e+01
 3.78332229e+01 3.85407382e+01 8.07345651e+00 1.21006767e+01
 3.19393668e+00 6.03614621e+00 8.61002776e+00 4.30269024e+01
 4.93354598e-01 1.20623901e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324571884028945
cond(S) = 12714.351296636658
E1 = -689.415796291299  E_coul = 184.95303616206292
init E= -504.462760129236
    CPU time for initialize scf      0.17 sec, wall time      0.03 sec
  HOMO = -0.67426486275469  LUMO = 9.14450562889914
  mo_energy =
[-1.21699110e+02 -1.33841480e+01 -7.62525526e+00 -7.62525526e+00
 -7.62525526e+00 -1.63971684e+00 -6.74264863e-01 -6.74264863e-01
 -6.74264863e-01  9.14450563e+00  1.09087099e+02  6.07651911e+02
  2.71020877e+03  1.22360994e+04  4.18745281e+04  1.10703111e+05
  2.54874638e+05  5.49280200e+05  1.15320572e+06  2.43096686e+06
  5.37567907e+06]
E1 = -707.119668309485  E_coul = 199.1834967435207
cycle= 1 E= -507.936171565964  delta_E= -3.47  |g|= 0.443  |ddm|= 0.349
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.58559
diis-c [-0.34291583  1.        ]
  HOMO = -0.232160495078499  LUMO = 10.0533099398543
  mo_energy =
[-1.20247774e+02 -1.23472065e+01 -6.64245579e+00 -6.64245579e+00
 -6.64245579e+00 -1.16058824e+00 -2.32160495e-01 -2.32160495e-01
 -2.32160495e-01  1.00533099e+01  1.10437829e+02  6.09088998e+02
  2.71158171e+03  1.22373586e+04  4.18757175e+04  1.10704261e+05
  2.54875762e+05  5.49281304e+05  1.15320681e+06  2.43096794e+06
  5.37568014e+06]
E1 = -706.7639276728821  E_coul = 198.82133159571353
cycle= 2 E= -507.942596077169  delta_E= -0.00642  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0153143
diis-c [-2.26425195e-04  4.83864790e-03  9.95161352e-01]
  HOMO = -0.236651932960532  LUMO = 10.0423545251128
  mo_energy =
[-1.20305815e+02 -1.23697209e+01 -6.67046596e+00 -6.67046596e+00
 -6.67046596e+00 -1.16287132e+00 -2.36651933e-01 -2.36651933e-01
 -2.36651933e-01  1.00423545e+01  1.10394093e+02  6.09027594e+02
  2.71150762e+03  1.22372760e+04  4.18756318e+04  1.10704175e+05
  2.54875674e+05  5.49281216e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7491623092617  E_coul = 198.80655402190476
cycle= 3 E= -507.942608287357  delta_E= -1.22e-05  |g|= 0.000882  |ddm|= 0.00878
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000743271
diis-c [-1.30146723e-08  3.98573421e-05 -5.00942600e-02  1.05005440e+00]
  HOMO = -0.236880554786486  LUMO = 10.0418092186682
  mo_energy =
[-1.20308429e+02 -1.23708389e+01 -6.67183243e+00 -6.67183243e+00
 -6.67183243e+00 -1.16298288e+00 -2.36880555e-01 -2.36880555e-01
 -2.36880555e-01  1.00418092e+01  1.10392055e+02  6.09024904e+02
  2.71150456e+03  1.22372727e+04  4.18756285e+04  1.10704171e+05
  2.54875670e+05  5.49281212e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7484184533675  E_coul = 198.8058101353615
cycle= 4 E= -507.942608318006  delta_E= -3.06e-08  |g|= 6.39e-06  |ddm|= 0.000466
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.54994e-06
diis-c [-4.78926518e-12 -1.82425860e-06  2.32124686e-03 -4.61699226e-02
  1.04385050e+00]
  HOMO = -0.236881342150113  LUMO = 10.0418083897845
  mo_energy =
[-1.20308427e+02 -1.23708415e+01 -6.67183417e+00 -6.67183417e+00
 -6.67183417e+00 -1.16298333e+00 -2.36881342e-01 -2.36881342e-01
 -2.36881342e-01  1.00418084e+01  1.10392055e+02  6.09024907e+02
  2.71150457e+03  1.22372727e+04  4.18756285e+04  1.10704171e+05
  2.54875671e+05  5.49281212e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7484172448534  E_coul = 198.80580892684554
cycle= 5 E= -507.942608318008  delta_E= -1.82e-12  |g|= 1.41e-07  |ddm|= 2.25e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7484172448534  E_coul = 198.80580892684554
  HOMO = -0.236881376316696  LUMO = 10.0418083208611
  mo_energy =
[-1.20308427e+02 -1.23708417e+01 -6.67183434e+00 -6.67183434e+00
 -6.67183434e+00 -1.16298335e+00 -2.36881376e-01 -2.36881376e-01
 -2.36881376e-01  1.00418083e+01  1.10392055e+02  6.09024906e+02
  2.71150457e+03  1.22372727e+04  4.18756285e+04  1.10704171e+05
  2.54875671e+05  5.49281212e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7484171512782  E_coul = 198.80580883327053
Extra cycle  E= -507.942608318008  delta_E= 1.71e-13  |g|= 7.31e-09  |ddm|= 7.27e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.09 sec
exp = [3.97051353e-01 1.17616814e+06 5.88084070e+05 2.94042032e+05
 1.47020998e+05 7.35104408e+04 3.67548369e+04 7.30991433e+03
 1.83761182e+04 1.39771986e+03 3.76373698e+02 1.14516549e+02
 3.78332229e+01 8.07345651e+00 3.19393668e+00 8.61002776e+00
 4.93354598e-01]
E = -507.9426083180077
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.397051352705       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.07029         1
[INPUT] 0    0    [1    /1   ]  294042.032162        1
[INPUT] 0    0    [1    /1   ]  147020.99798         1
[INPUT] 0    0    [1    /1   ]  73510.4407773        1
[INPUT] 0    0    [1    /1   ]  36754.8368862        1
[INPUT] 0    0    [1    /1   ]  7309.91433204        1
[INPUT] 0    0    [1    /1   ]  18376.1182146        1
[INPUT] 0    0    [1    /1   ]  1397.71986046        1
[INPUT] 0    0    [1    /1   ]  376.373698248        1
[INPUT] 0    0    [1    /1   ]  114.516548815        1
[INPUT] 0    0    [1    /1   ]  37.8332229086        1
[INPUT] 0    0    [1    /1   ]  8.07345651065        1
[INPUT] 0    0    [1    /1   ]  3.1939366828         1
[INPUT] 1    0    [1    /1   ]  8.61002775517        1
[INPUT] 1    0    [1    /1   ]  0.493354598242       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39705135270498504, 1.0]], [0, [1176168.142616908, 1.0]], [0, [588084.0702903303, 1.0]], [0, [294042.03216152027, 1.0]], [0, [147020.99797980377, 1.0]], [0, [73510.44077730304, 1.0]], [0, [36754.83688622924, 1.0]], [0, [7309.914332035285, 1.0]], [0, [18376.11821463118, 1.0]], [0, [1397.7198604613427, 1.0]], [0, [376.3736982483581, 1.0]], [0, [114.51654881500055, 1.0]], [0, [37.83322290864967, 1.0]], [0, [8.07345651065085, 1.0]], [0, [3.193936682801615, 1.0]], [1, [8.610027755168538, 1.0]], [1, [0.4933545982417409, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39705135]
bas 1, expnt(s) = [1176168.14261691]
bas 2, expnt(s) = [588084.07029033]
bas 3, expnt(s) = [294042.03216152]
bas 4, expnt(s) = [147020.9979798]
bas 5, expnt(s) = [73510.4407773]
bas 6, expnt(s) = [36754.83688623]
bas 7, expnt(s) = [7309.91433204]
bas 8, expnt(s) = [18376.11821463]
bas 9, expnt(s) = [1397.71986046]
bas 10, expnt(s) = [376.37369825]
bas 11, expnt(s) = [114.51654882]
bas 12, expnt(s) = [37.83322291]
bas 13, expnt(s) = [8.07345651]
bas 14, expnt(s) = [3.19393668]
bas 15, expnt(s) = [8.61002776]
bas 16, expnt(s) = [0.4933546]
CPU time:      1293.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.97051353e-01 1.26371760e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042032e+05 3.19023067e+04
 1.47020998e+05 1.89692233e+04 7.35104408e+04 1.12791610e+04
 3.67548369e+04 6.70657675e+03 7.30991433e+03 1.99732731e+03
 1.83761182e+04 3.98754279e+03 1.39771986e+03 5.77537417e+02
 3.76373698e+02 2.15888483e+02 1.14516549e+02 8.84435595e+01
 3.78332229e+01 3.85407382e+01 8.07345651e+00 1.21006767e+01
 3.19393668e+00 6.03614621e+00 8.61002776e+00 4.30269024e+01
 4.93354598e-01 1.20623901e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.324571884028945
cond(S) = 12714.351296636658
E1 = -689.415796291299  E_coul = 184.95303616206292
init E= -504.462760129236
    CPU time for initialize scf      0.18 sec, wall time      0.03 sec
  HOMO = -0.67426486275469  LUMO = 9.14450562889914
  mo_energy =
[-1.21699110e+02 -1.33841480e+01 -7.62525526e+00 -7.62525526e+00
 -7.62525526e+00 -1.63971684e+00 -6.74264863e-01 -6.74264863e-01
 -6.74264863e-01  9.14450563e+00  1.09087099e+02  6.07651911e+02
  2.71020877e+03  1.22360994e+04  4.18745281e+04  1.10703111e+05
  2.54874638e+05  5.49280200e+05  1.15320572e+06  2.43096686e+06
  5.37567907e+06]
E1 = -707.119668309485  E_coul = 199.1834967435207
cycle= 1 E= -507.936171565964  delta_E= -3.47  |g|= 0.443  |ddm|= 0.349
    CPU time for cycle= 1      0.16 sec, wall time      0.01 sec
diis-norm(errvec)=0.58559
diis-c [-0.34291583  1.        ]
  HOMO = -0.232160495078499  LUMO = 10.0533099398543
  mo_energy =
[-1.20247774e+02 -1.23472065e+01 -6.64245579e+00 -6.64245579e+00
 -6.64245579e+00 -1.16058824e+00 -2.32160495e-01 -2.32160495e-01
 -2.32160495e-01  1.00533099e+01  1.10437829e+02  6.09088998e+02
  2.71158171e+03  1.22373586e+04  4.18757175e+04  1.10704261e+05
  2.54875762e+05  5.49281304e+05  1.15320681e+06  2.43096794e+06
  5.37568014e+06]
E1 = -706.7639276728821  E_coul = 198.82133159571353
cycle= 2 E= -507.942596077169  delta_E= -0.00642  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.0153143
diis-c [-2.26425195e-04  4.83864790e-03  9.95161352e-01]
  HOMO = -0.236651932960532  LUMO = 10.0423545251128
  mo_energy =
[-1.20305815e+02 -1.23697209e+01 -6.67046596e+00 -6.67046596e+00
 -6.67046596e+00 -1.16287132e+00 -2.36651933e-01 -2.36651933e-01
 -2.36651933e-01  1.00423545e+01  1.10394093e+02  6.09027594e+02
  2.71150762e+03  1.22372760e+04  4.18756318e+04  1.10704175e+05
  2.54875674e+05  5.49281216e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7491623092617  E_coul = 198.80655402190476
cycle= 3 E= -507.942608287357  delta_E= -1.22e-05  |g|= 0.000882  |ddm|= 0.00878
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000743271
diis-c [-1.30146723e-08  3.98573421e-05 -5.00942600e-02  1.05005440e+00]
  HOMO = -0.236880554786486  LUMO = 10.0418092186682
  mo_energy =
[-1.20308429e+02 -1.23708389e+01 -6.67183243e+00 -6.67183243e+00
 -6.67183243e+00 -1.16298288e+00 -2.36880555e-01 -2.36880555e-01
 -2.36880555e-01  1.00418092e+01  1.10392055e+02  6.09024904e+02
  2.71150456e+03  1.22372727e+04  4.18756285e+04  1.10704171e+05
  2.54875670e+05  5.49281212e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7484184533675  E_coul = 198.8058101353615
cycle= 4 E= -507.942608318006  delta_E= -3.06e-08  |g|= 6.39e-06  |ddm|= 0.000466
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.54994e-06
diis-c [-4.78926518e-12 -1.82425860e-06  2.32124686e-03 -4.61699226e-02
  1.04385050e+00]
  HOMO = -0.236881342150113  LUMO = 10.0418083897845
  mo_energy =
[-1.20308427e+02 -1.23708415e+01 -6.67183417e+00 -6.67183417e+00
 -6.67183417e+00 -1.16298333e+00 -2.36881342e-01 -2.36881342e-01
 -2.36881342e-01  1.00418084e+01  1.10392055e+02  6.09024907e+02
  2.71150457e+03  1.22372727e+04  4.18756285e+04  1.10704171e+05
  2.54875671e+05  5.49281212e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7484172448534  E_coul = 198.80580892684554
cycle= 5 E= -507.942608318008  delta_E= -1.82e-12  |g|= 1.41e-07  |ddm|= 2.25e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7484172448534  E_coul = 198.80580892684554
  HOMO = -0.236881376316696  LUMO = 10.0418083208611
  mo_energy =
[-1.20308427e+02 -1.23708417e+01 -6.67183434e+00 -6.67183434e+00
 -6.67183434e+00 -1.16298335e+00 -2.36881376e-01 -2.36881376e-01
 -2.36881376e-01  1.00418083e+01  1.10392055e+02  6.09024906e+02
  2.71150457e+03  1.22372727e+04  4.18756285e+04  1.10704171e+05
  2.54875671e+05  5.49281212e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7484171512782  E_coul = 198.80580883327053
Extra cycle  E= -507.942608318008  delta_E= 1.71e-13  |g|= 7.31e-09  |ddm|= 7.27e-08
    CPU time for scf_cycle      0.43 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12714.351296636658
E1 = -706.7484171512782  E_coul = 198.80580883327053
init E= -507.942608318008
    CPU time for initialize scf     10.10 sec, wall time      0.69 sec
  HOMO = -0.236881377932818  LUMO = 10.0418083185386
  mo_energy =
[-1.20308428e+02 -1.23708417e+01 -6.67183435e+00 -6.67183435e+00
 -6.67183435e+00 -1.16298335e+00 -2.36881378e-01 -2.36881378e-01
 -2.36881378e-01  1.00418083e+01  1.10392055e+02  6.09024906e+02
  2.71150457e+03  1.22372727e+04  4.18756285e+04  1.10704171e+05
  2.54875671e+05  5.49281212e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7484171469932  E_coul = 198.80580882898562
cycle= 1 E= -507.942608318008  delta_E= 5.68e-14  |g|= 1.01e-09  |ddm|= 3.63e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -706.7484171469932  E_coul = 198.80580882898562
  HOMO = -0.236881378012716  LUMO = 10.0418083169124
  mo_energy =
[-1.20308428e+02 -1.23708417e+01 -6.67183435e+00 -6.67183435e+00
 -6.67183435e+00 -1.16298335e+00 -2.36881378e-01 -2.36881378e-01
 -2.36881378e-01  1.00418083e+01  1.10392055e+02  6.09024906e+02
  2.71150457e+03  1.22372727e+04  4.18756285e+04  1.10704171e+05
  2.54875671e+05  5.49281212e+05  1.15320672e+06  2.43096785e+06
  5.37568005e+06]
E1 = -706.7484171468054  E_coul = 198.80580882879767
Extra cycle  E= -507.942608318008  delta_E= -1.14e-13  |g|= 1.02e-09  |ddm|= 1.71e-10
    CPU time for scf_cycle     10.17 sec, wall time      0.75 sec
exp = [3.97051353e-01 1.17616814e+06 5.88084070e+05 2.94042032e+05
 1.47020998e+05 7.35104408e+04 3.67548369e+04 7.30991433e+03
 1.83761182e+04 1.39771986e+03 3.76373698e+02 1.14516549e+02
 3.78332229e+01 8.07345651e+00 3.19393668e+00 8.61002776e+00
 4.93354598e-01]
grad_E = [ 6.00582535e-03 -3.89983131e-11  2.76921523e-10  8.71447540e-10
  5.56967663e-09  1.71124776e-08  1.12725409e-07  6.68615281e-06
  2.37166053e-07 -6.47907175e-05  2.62768063e-04 -2.00977179e-04
 -3.47005079e-04  1.88645164e-04 -8.85777158e-04  4.74928931e-03
  7.24759446e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396675213634       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.070038        1
[INPUT] 0    0    [1    /1   ]  294042.03129         1
[INPUT] 0    0    [1    /1   ]  147020.993033        1
[INPUT] 0    0    [1    /1   ]  73510.4239945        1
[INPUT] 0    0    [1    /1   ]  36754.7377926        1
[INPUT] 0    0    [1    /1   ]  7304.45637575        1
[INPUT] 0    0    [1    /1   ]  18375.8572157        1
[INPUT] 0    0    [1    /1   ]  1440.82488526        1
[INPUT] 0    0    [1    /1   ]  379.77248712         1
[INPUT] 0    0    [1    /1   ]  114.686664304        1
[INPUT] 0    0    [1    /1   ]  37.9480106674        1
[INPUT] 0    0    [1    /1   ]  8.11425224615        1
[INPUT] 0    0    [1    /1   ]  3.21289476962        1
[INPUT] 1    0    [1    /1   ]  8.60466375295        1
[INPUT] 1    0    [1    /1   ]  0.493032821611       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39667521363357455, 1.0]], [0, [1176168.1426188701, 1.0]], [0, [588084.0700377183, 1.0]], [0, [294042.03128957935, 1.0]], [0, [147020.9930328032, 1.0]], [0, [73510.42399449371, 1.0]], [0, [36754.73779258817, 1.0]], [0, [7304.456375746946, 1.0]], [0, [18375.8572156574, 1.0]], [0, [1440.8248852576899, 1.0]], [0, [379.77248711993053, 1.0]], [0, [114.68666430426362, 1.0]], [0, [37.948010667443896, 1.0]], [0, [8.114252246149182, 1.0]], [0, [3.212894769616135, 1.0]], [1, [8.60466375294575, 1.0]], [1, [0.49303282161062434, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39667521]
bas 1, expnt(s) = [1176168.14261887]
bas 2, expnt(s) = [588084.07003772]
bas 3, expnt(s) = [294042.03128958]
bas 4, expnt(s) = [147020.9930328]
bas 5, expnt(s) = [73510.42399449]
bas 6, expnt(s) = [36754.73779259]
bas 7, expnt(s) = [7304.45637575]
bas 8, expnt(s) = [18375.85721566]
bas 9, expnt(s) = [1440.82488526]
bas 10, expnt(s) = [379.77248712]
bas 11, expnt(s) = [114.6866643]
bas 12, expnt(s) = [37.94801067]
bas 13, expnt(s) = [8.11425225]
bas 14, expnt(s) = [3.21289477]
bas 15, expnt(s) = [8.60466375]
bas 16, expnt(s) = [0.49303282]
CPU time:      1306.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96675214e-01 1.26281962e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020993e+05 1.89692228e+04 7.35104240e+04 1.12791590e+04
 3.67547378e+04 6.70656319e+03 7.30445638e+03 1.99620872e+03
 1.83758572e+04 3.98750031e+03 1.44082489e+03 5.90844810e+02
 3.79772487e+02 2.17349001e+02 1.14686664e+02 8.85420790e+01
 3.79480107e+01 3.86284058e+01 8.11425225e+00 1.21465069e+01
 3.21289477e+00 6.06299766e+00 8.60466375e+00 4.29933981e+01
 4.93032822e-01 1.20525567e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32504532201598
cond(S) = 12744.921820859749
E1 = -689.3921962253264  E_coul = 184.91590137676502
init E= -504.476294848561
    CPU time for initialize scf      4.53 sec, wall time      0.32 sec
  HOMO = -0.674689001323925  LUMO = 9.23728941071775
  mo_energy =
[-1.21705975e+02 -1.33870795e+01 -7.62779301e+00 -7.62779301e+00
 -7.62779301e+00 -1.64016707e+00 -6.74689001e-01 -6.74689001e-01
 -6.74689001e-01  9.23728941e+00  1.09696599e+02  6.11771117e+02
  2.76065516e+03  1.23693015e+04  4.20265763e+04  1.10852237e+05
  2.55018821e+05  5.49419974e+05  1.15334149e+06  2.43109879e+06
  5.37580696e+06]
E1 = -707.073883934578  E_coul = 199.1362346183045
cycle= 1 E= -507.937649316274  delta_E= -3.46  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.20 sec, wall time      0.02 sec
diis-norm(errvec)=0.584485
diis-c [-0.34162325  1.        ]
  HOMO = -0.233052371259777  LUMO = 10.1480306965811
  mo_energy =
[-1.20255239e+02 -1.23508179e+01 -6.64569856e+00 -6.64569856e+00
 -6.64569856e+00 -1.16144696e+00 -2.33052371e-01 -2.33052371e-01
 -2.33052371e-01  1.01480307e+01  1.11047229e+02  6.13207607e+02
  2.76202609e+03  1.23705599e+04  4.20277656e+04  1.10853388e+05
  2.55019944e+05  5.49421077e+05  1.15334258e+06  2.43109987e+06
  5.37580803e+06]
E1 = -706.7213749397187  E_coul = 198.7773683867885
cycle= 2 E= -507.94400655293  delta_E= -0.00636  |g|= 0.018  |ddm|= 0.194
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.015238
diis-c [-2.23989398e-04  4.87875948e-03  9.95121241e-01]
  HOMO = -0.237482458577168  LUMO = 10.1371228304005
  mo_energy =
[-1.20312880e+02 -1.23731009e+01 -6.67344138e+00 -6.67344138e+00
 -6.67344138e+00 -1.16369612e+00 -2.37482459e-01 -2.37482459e-01
 -2.37482459e-01  1.01371228e+01  1.11003765e+02  6.13146520e+02
  2.76195229e+03  1.23704778e+04  4.20276804e+04  1.10853301e+05
  2.55019857e+05  5.49420989e+05  1.15334249e+06  2.43109978e+06
  5.37580794e+06]
E1 = -706.7068192207048  E_coul = 198.76280072037565
cycle= 3 E= -507.944018500329  delta_E= -1.19e-05  |g|= 0.000873  |ddm|= 0.00866
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0007384
diis-c [-1.22524625e-08  3.90205506e-05 -5.00420480e-02  1.05000303e+00]
  HOMO = -0.237706925509466  LUMO = 10.1365823023616
  mo_energy =
[-1.20315468e+02 -1.23742027e+01 -6.67478969e+00 -6.67478969e+00
 -6.67478969e+00 -1.16380552e+00 -2.37706926e-01 -2.37706926e-01
 -2.37706926e-01  1.01365823e+01  1.11001747e+02  6.13143854e+02
  2.76194925e+03  1.23704745e+04  4.20276771e+04  1.10853298e+05
  2.55019854e+05  5.49420986e+05  1.15334249e+06  2.43109977e+06
  5.37580794e+06]
E1 = -706.7060890646029  E_coul = 198.7620705345907
cycle= 4 E= -507.944018530012  delta_E= -2.97e-08  |g|= 6.13e-06  |ddm|= 0.000457
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.35413e-06
diis-c [-4.60818291e-12 -1.80940962e-06  2.28407764e-03 -4.54023210e-02
  1.04312005e+00]
  HOMO = -0.23770765071953  LUMO = 10.1365815792511
  mo_energy =
[-1.20315466e+02 -1.23742051e+01 -6.67479119e+00 -6.67479119e+00
 -6.67479119e+00 -1.16380594e+00 -2.37707651e-01 -2.37707651e-01
 -2.37707651e-01  1.01365816e+01  1.11001747e+02  6.13143857e+02
  2.76194926e+03  1.23704745e+04  4.20276771e+04  1.10853298e+05
  2.55019854e+05  5.49420986e+05  1.15334249e+06  2.43109977e+06
  5.37580794e+06]
E1 = -706.706088015115  E_coul = 198.76206948510116
cycle= 5 E= -507.944018530014  delta_E= -1.65e-12  |g|= 1.39e-07  |ddm|= 2.1e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.706088015115  E_coul = 198.76206948510116
  HOMO = -0.237707684162861  LUMO = 10.1365815116854
  mo_energy =
[-1.20315466e+02 -1.23742052e+01 -6.67479136e+00 -6.67479136e+00
 -6.67479136e+00 -1.16380596e+00 -2.37707684e-01 -2.37707684e-01
 -2.37707684e-01  1.01365815e+01  1.11001747e+02  6.13143857e+02
  2.76194926e+03  1.23704745e+04  4.20276771e+04  1.10853298e+05
  2.55019854e+05  5.49420986e+05  1.15334249e+06  2.43109977e+06
  5.37580794e+06]
E1 = -706.7060879237382  E_coul = 198.76206939372418
Extra cycle  E= -507.944018530014  delta_E= -1.71e-13  |g|= 7.11e-09  |ddm|= 7.11e-08
    CPU time for scf_cycle      4.79 sec, wall time      0.39 sec
exp = [3.96675214e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020993e+05 7.35104240e+04 3.67547378e+04 7.30445638e+03
 1.83758572e+04 1.44082489e+03 3.79772487e+02 1.14686664e+02
 3.79480107e+01 8.11425225e+00 3.21289477e+00 8.60466375e+00
 4.93032822e-01]
E = -507.94401853001403
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396675213634       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.070038        1
[INPUT] 0    0    [1    /1   ]  294042.03129         1
[INPUT] 0    0    [1    /1   ]  147020.993033        1
[INPUT] 0    0    [1    /1   ]  73510.4239945        1
[INPUT] 0    0    [1    /1   ]  36754.7377926        1
[INPUT] 0    0    [1    /1   ]  7304.45637575        1
[INPUT] 0    0    [1    /1   ]  18375.8572157        1
[INPUT] 0    0    [1    /1   ]  1440.82488526        1
[INPUT] 0    0    [1    /1   ]  379.77248712         1
[INPUT] 0    0    [1    /1   ]  114.686664304        1
[INPUT] 0    0    [1    /1   ]  37.9480106674        1
[INPUT] 0    0    [1    /1   ]  8.11425224615        1
[INPUT] 0    0    [1    /1   ]  3.21289476962        1
[INPUT] 1    0    [1    /1   ]  8.60466375295        1
[INPUT] 1    0    [1    /1   ]  0.493032821611       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39667521363357455, 1.0]], [0, [1176168.1426188701, 1.0]], [0, [588084.0700377183, 1.0]], [0, [294042.03128957935, 1.0]], [0, [147020.9930328032, 1.0]], [0, [73510.42399449371, 1.0]], [0, [36754.73779258817, 1.0]], [0, [7304.456375746946, 1.0]], [0, [18375.8572156574, 1.0]], [0, [1440.8248852576899, 1.0]], [0, [379.77248711993053, 1.0]], [0, [114.68666430426362, 1.0]], [0, [37.948010667443896, 1.0]], [0, [8.114252246149182, 1.0]], [0, [3.212894769616135, 1.0]], [1, [8.60466375294575, 1.0]], [1, [0.49303282161062434, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39667521]
bas 1, expnt(s) = [1176168.14261887]
bas 2, expnt(s) = [588084.07003772]
bas 3, expnt(s) = [294042.03128958]
bas 4, expnt(s) = [147020.9930328]
bas 5, expnt(s) = [73510.42399449]
bas 6, expnt(s) = [36754.73779259]
bas 7, expnt(s) = [7304.45637575]
bas 8, expnt(s) = [18375.85721566]
bas 9, expnt(s) = [1440.82488526]
bas 10, expnt(s) = [379.77248712]
bas 11, expnt(s) = [114.6866643]
bas 12, expnt(s) = [37.94801067]
bas 13, expnt(s) = [8.11425225]
bas 14, expnt(s) = [3.21289477]
bas 15, expnt(s) = [8.60466375]
bas 16, expnt(s) = [0.49303282]
CPU time:      1311.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96675214e-01 1.26281962e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020993e+05 1.89692228e+04 7.35104240e+04 1.12791590e+04
 3.67547378e+04 6.70656319e+03 7.30445638e+03 1.99620872e+03
 1.83758572e+04 3.98750031e+03 1.44082489e+03 5.90844810e+02
 3.79772487e+02 2.17349001e+02 1.14686664e+02 8.85420790e+01
 3.79480107e+01 3.86284058e+01 8.11425225e+00 1.21465069e+01
 3.21289477e+00 6.06299766e+00 8.60466375e+00 4.29933981e+01
 4.93032822e-01 1.20525567e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32504532201598
cond(S) = 12744.921820859749
E1 = -689.3921962253264  E_coul = 184.91590137676502
init E= -504.476294848561
    CPU time for initialize scf      4.82 sec, wall time      0.34 sec
  HOMO = -0.674689001323925  LUMO = 9.23728941071775
  mo_energy =
[-1.21705975e+02 -1.33870795e+01 -7.62779301e+00 -7.62779301e+00
 -7.62779301e+00 -1.64016707e+00 -6.74689001e-01 -6.74689001e-01
 -6.74689001e-01  9.23728941e+00  1.09696599e+02  6.11771117e+02
  2.76065516e+03  1.23693015e+04  4.20265763e+04  1.10852237e+05
  2.55018821e+05  5.49419974e+05  1.15334149e+06  2.43109879e+06
  5.37580696e+06]
E1 = -707.073883934578  E_coul = 199.1362346183045
cycle= 1 E= -507.937649316274  delta_E= -3.46  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.584485
diis-c [-0.34162325  1.        ]
  HOMO = -0.233052371259777  LUMO = 10.1480306965811
  mo_energy =
[-1.20255239e+02 -1.23508179e+01 -6.64569856e+00 -6.64569856e+00
 -6.64569856e+00 -1.16144696e+00 -2.33052371e-01 -2.33052371e-01
 -2.33052371e-01  1.01480307e+01  1.11047229e+02  6.13207607e+02
  2.76202609e+03  1.23705599e+04  4.20277656e+04  1.10853388e+05
  2.55019944e+05  5.49421077e+05  1.15334258e+06  2.43109987e+06
  5.37580803e+06]
E1 = -706.7213749397187  E_coul = 198.7773683867885
cycle= 2 E= -507.94400655293  delta_E= -0.00636  |g|= 0.018  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.015238
diis-c [-2.23989398e-04  4.87875948e-03  9.95121241e-01]
  HOMO = -0.237482458577168  LUMO = 10.1371228304005
  mo_energy =
[-1.20312880e+02 -1.23731009e+01 -6.67344138e+00 -6.67344138e+00
 -6.67344138e+00 -1.16369612e+00 -2.37482459e-01 -2.37482459e-01
 -2.37482459e-01  1.01371228e+01  1.11003765e+02  6.13146520e+02
  2.76195229e+03  1.23704778e+04  4.20276804e+04  1.10853301e+05
  2.55019857e+05  5.49420989e+05  1.15334249e+06  2.43109978e+06
  5.37580794e+06]
E1 = -706.7068192207048  E_coul = 198.76280072037565
cycle= 3 E= -507.944018500329  delta_E= -1.19e-05  |g|= 0.000873  |ddm|= 0.00866
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0007384
diis-c [-1.22524625e-08  3.90205506e-05 -5.00420480e-02  1.05000303e+00]
  HOMO = -0.237706925509466  LUMO = 10.1365823023616
  mo_energy =
[-1.20315468e+02 -1.23742027e+01 -6.67478969e+00 -6.67478969e+00
 -6.67478969e+00 -1.16380552e+00 -2.37706926e-01 -2.37706926e-01
 -2.37706926e-01  1.01365823e+01  1.11001747e+02  6.13143854e+02
  2.76194925e+03  1.23704745e+04  4.20276771e+04  1.10853298e+05
  2.55019854e+05  5.49420986e+05  1.15334249e+06  2.43109977e+06
  5.37580794e+06]
E1 = -706.7060890646029  E_coul = 198.7620705345907
cycle= 4 E= -507.944018530012  delta_E= -2.97e-08  |g|= 6.13e-06  |ddm|= 0.000457
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.35413e-06
diis-c [-4.60818291e-12 -1.80940962e-06  2.28407764e-03 -4.54023210e-02
  1.04312005e+00]
  HOMO = -0.23770765071953  LUMO = 10.1365815792511
  mo_energy =
[-1.20315466e+02 -1.23742051e+01 -6.67479119e+00 -6.67479119e+00
 -6.67479119e+00 -1.16380594e+00 -2.37707651e-01 -2.37707651e-01
 -2.37707651e-01  1.01365816e+01  1.11001747e+02  6.13143857e+02
  2.76194926e+03  1.23704745e+04  4.20276771e+04  1.10853298e+05
  2.55019854e+05  5.49420986e+05  1.15334249e+06  2.43109977e+06
  5.37580794e+06]
E1 = -706.706088015115  E_coul = 198.76206948510116
cycle= 5 E= -507.944018530014  delta_E= -1.65e-12  |g|= 1.39e-07  |ddm|= 2.1e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.706088015115  E_coul = 198.76206948510116
  HOMO = -0.237707684162861  LUMO = 10.1365815116854
  mo_energy =
[-1.20315466e+02 -1.23742052e+01 -6.67479136e+00 -6.67479136e+00
 -6.67479136e+00 -1.16380596e+00 -2.37707684e-01 -2.37707684e-01
 -2.37707684e-01  1.01365815e+01  1.11001747e+02  6.13143857e+02
  2.76194926e+03  1.23704745e+04  4.20276771e+04  1.10853298e+05
  2.55019854e+05  5.49420986e+05  1.15334249e+06  2.43109977e+06
  5.37580794e+06]
E1 = -706.7060879237382  E_coul = 198.76206939372418
Extra cycle  E= -507.944018530014  delta_E= -1.71e-13  |g|= 7.11e-09  |ddm|= 7.11e-08
    CPU time for scf_cycle      5.08 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12744.921820859749
E1 = -706.7060879237382  E_coul = 198.76206939372418
init E= -507.944018530014
    CPU time for initialize scf     10.05 sec, wall time      0.67 sec
  HOMO = -0.237707685736594  LUMO = 10.1365815074173
  mo_energy =
[-1.20315466e+02 -1.23742052e+01 -6.67479137e+00 -6.67479137e+00
 -6.67479137e+00 -1.16380596e+00 -2.37707686e-01 -2.37707686e-01
 -2.37707686e-01  1.01365815e+01  1.11001747e+02  6.13143857e+02
  2.76194926e+03  1.23704745e+04  4.20276771e+04  1.10853298e+05
  2.55019854e+05  5.49420986e+05  1.15334249e+06  2.43109977e+06
  5.37580794e+06]
E1 = -706.7060879196697  E_coul = 198.7620693896557
cycle= 1 E= -507.944018530014  delta_E= 5.68e-14  |g|= 1.04e-09  |ddm|= 3.49e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.7060879196697  E_coul = 198.7620693896557
  HOMO = -0.23770768581285  LUMO = 10.1365815087244
  mo_energy =
[-1.20315466e+02 -1.23742052e+01 -6.67479137e+00 -6.67479137e+00
 -6.67479137e+00 -1.16380596e+00 -2.37707686e-01 -2.37707686e-01
 -2.37707686e-01  1.01365815e+01  1.11001747e+02  6.13143857e+02
  2.76194926e+03  1.23704745e+04  4.20276771e+04  1.10853298e+05
  2.55019854e+05  5.49420986e+05  1.15334249e+06  2.43109977e+06
  5.37580794e+06]
E1 = -706.7060879195167  E_coul = 198.7620693895029
Extra cycle  E= -507.944018530014  delta_E= 2.27e-13  |g|= 7.1e-10  |ddm|= 1.61e-10
    CPU time for scf_cycle     10.24 sec, wall time      0.74 sec
exp = [3.96675214e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020993e+05 7.35104240e+04 3.67547378e+04 7.30445638e+03
 1.83758572e+04 1.44082489e+03 3.79772487e+02 1.14686664e+02
 3.79480107e+01 8.11425225e+00 3.21289477e+00 8.60466375e+00
 4.93032822e-01]
grad_E = [ 8.45991896e-04 -4.86352172e-11  1.99663713e-10  5.88091438e-10
  4.10122589e-09  1.17759506e-08  8.34243705e-08  5.02830983e-06
  1.49557077e-07 -3.06101348e-05  1.72206131e-04 -2.39065052e-04
 -3.45645305e-06  5.02929577e-05  4.63272333e-05  6.58062260e-04
  4.94114791e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396554405116       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069949        1
[INPUT] 0    0    [1    /1   ]  294042.030985        1
[INPUT] 0    0    [1    /1   ]  147020.991305        1
[INPUT] 0    0    [1    /1   ]  73510.4181259        1
[INPUT] 0    0    [1    /1   ]  36754.7031887        1
[INPUT] 0    0    [1    /1   ]  7302.5497942         1
[INPUT] 0    0    [1    /1   ]  18375.7658318        1
[INPUT] 0    0    [1    /1   ]  1456.70777484        1
[INPUT] 0    0    [1    /1   ]  377.017798195        1
[INPUT] 0    0    [1    /1   ]  113.885676604        1
[INPUT] 0    0    [1    /1   ]  37.8581340999        1
[INPUT] 0    0    [1    /1   ]  8.10514727098        1
[INPUT] 0    0    [1    /1   ]  3.21077559898        1
[INPUT] 1    0    [1    /1   ]  8.60269519343        1
[INPUT] 1    0    [1    /1   ]  0.492933042673       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3965544051163429, 1.0]], [0, [1176168.1426194082, 1.0]], [0, [588084.0699494691, 1.0]], [0, [294042.03098461236, 1.0]], [0, [147020.99130514456, 1.0]], [0, [73510.41812589737, 1.0]], [0, [36754.70318865438, 1.0]], [0, [7302.549794196091, 1.0]], [0, [18375.765831767934, 1.0]], [0, [1456.7077748446889, 1.0]], [0, [377.01779819549546, 1.0]], [0, [113.88567660360124, 1.0]], [0, [37.85813409988706, 1.0]], [0, [8.10514727097691, 1.0]], [0, [3.210775598978795, 1.0]], [1, [8.602695193429344, 1.0]], [1, [0.4929330426734138, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39655441]
bas 1, expnt(s) = [1176168.14261941]
bas 2, expnt(s) = [588084.06994947]
bas 3, expnt(s) = [294042.03098461]
bas 4, expnt(s) = [147020.99130514]
bas 5, expnt(s) = [73510.4181259]
bas 6, expnt(s) = [36754.70318865]
bas 7, expnt(s) = [7302.5497942]
bas 8, expnt(s) = [18375.76583177]
bas 9, expnt(s) = [1456.70777484]
bas 10, expnt(s) = [377.0177982]
bas 11, expnt(s) = [113.8856766]
bas 12, expnt(s) = [37.8581341]
bas 13, expnt(s) = [8.10514727]
bas 14, expnt(s) = [3.2107756]
bas 15, expnt(s) = [8.60269519]
bas 16, expnt(s) = [0.49293304]
CPU time:      1330.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96554405e-01 1.26253117e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104181e+04 1.12791584e+04
 3.67547032e+04 6.70655845e+03 7.30254979e+03 1.99581793e+03
 1.83757658e+04 3.98748544e+03 1.45670777e+03 5.95722979e+02
 3.77017798e+02 2.16165516e+02 1.13885677e+02 8.80778802e+01
 3.78581341e+01 3.85597694e+01 8.10514727e+00 1.21362833e+01
 3.21077560e+00 6.05999812e+00 8.60269519e+00 4.29811035e+01
 4.92933043e-01 1.20495078e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325201351065406
cond(S) = 12752.340213654648
E1 = -689.3887465063198  E_coul = 184.9033320925555
init E= -504.485414413764
    CPU time for initialize scf      4.61 sec, wall time      0.32 sec
  HOMO = -0.674812136211603  LUMO = 9.21803284968576
  mo_energy =
[-1.21708335e+02 -1.33881239e+01 -7.62864710e+00 -7.62864710e+00
 -7.62864710e+00 -1.64028348e+00 -6.74812136e-01 -6.74812136e-01
 -6.74812136e-01  9.21803285e+00  1.09166187e+02  6.07544456e+02
  2.76428325e+03  1.24005951e+04  4.20656339e+04  1.10890970e+05
  2.55056287e+05  5.49456279e+05  1.15337675e+06  2.43113305e+06
  5.37584018e+06]
E1 = -707.0584203158462  E_coul = 199.12032326934616
cycle= 1 E= -507.9380970465  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.584514
diis-c [-0.34165637  1.        ]
  HOMO = -0.233327488376948  LUMO = 10.1280311737846
  mo_energy =
[-1.20257818e+02 -1.23520805e+01 -6.64678832e+00 -6.64678832e+00
 -6.64678832e+00 -1.16169439e+00 -2.33327488e-01 -2.33327488e-01
 -2.33327488e-01  1.01280312e+01  1.10515818e+02  6.08980783e+02
  2.76565360e+03  1.24018529e+04  4.20668229e+04  1.10892120e+05
  2.55057410e+05  5.49457382e+05  1.15337784e+06  2.43113413e+06
  5.37584125e+06]
E1 = -706.7054467159626  E_coul = 198.76098293254984
cycle= 2 E= -507.944463783413  delta_E= -0.00637  |g|= 0.018  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152257
diis-c [-2.23542479e-04  4.90037251e-03  9.95099627e-01]
  HOMO = -0.23776626667306  LUMO = 10.117121399146
  mo_energy =
[-1.20315504e+02 -1.23744020e+01 -6.67457018e+00 -6.67457018e+00
 -6.67457018e+00 -1.16394933e+00 -2.37766267e-01 -2.37766267e-01
 -2.37766267e-01  1.01171214e+01  1.10472383e+02  6.08919714e+02
  2.76557971e+03  1.24017708e+04  4.20667377e+04  1.10892033e+05
  2.55057322e+05  5.49457295e+05  1.15337775e+06  2.43113404e+06
  5.37584116e+06]
E1 = -706.6908559606209  E_coul = 198.7463801823561
cycle= 3 E= -507.944475778265  delta_E= -1.2e-05  |g|= 0.000875  |ddm|= 0.00868
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000738503
diis-c [-1.23685234e-08  3.92938774e-05 -5.00822918e-02  1.05004300e+00]
  HOMO = -0.237991541292103  LUMO = 10.1165798948427
  mo_energy =
[-1.20318098e+02 -1.23755075e+01 -6.67592238e+00 -6.67592238e+00
 -6.67592238e+00 -1.16405920e+00 -2.37991541e-01 -2.37991541e-01
 -2.37991541e-01  1.01165799e+01  1.10470363e+02  6.08917044e+02
  2.76557666e+03  1.24017676e+04  4.20667344e+04  1.10892030e+05
  2.55057319e+05  5.49457291e+05  1.15337775e+06  2.43113403e+06
  5.37584116e+06]
E1 = -706.6901229120879  E_coul = 198.74564710392124
cycle= 4 E= -507.944475808167  delta_E= -2.99e-08  |g|= 6.18e-06  |ddm|= 0.000459
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.38592e-06
diis-c [-4.62721822e-12 -1.82537894e-06  2.29369240e-03 -4.55804373e-02
  1.04328857e+00]
  HOMO = -0.237992280019036  LUMO = 10.1165791459455
  mo_energy =
[-1.20318096e+02 -1.23755099e+01 -6.67592393e+00 -6.67592393e+00
 -6.67592393e+00 -1.16405962e+00 -2.37992280e-01 -2.37992280e-01
 -2.37992280e-01  1.01165791e+01  1.10470364e+02  6.08917047e+02
  2.76557667e+03  1.24017676e+04  4.20667344e+04  1.10892030e+05
  2.55057319e+05  5.49457291e+05  1.15337775e+06  2.43113403e+06
  5.37584116e+06]
E1 = -706.6901218264901  E_coul = 198.74564601832216
cycle= 5 E= -507.944475808168  delta_E= -1.25e-12  |g|= 1.39e-07  |ddm|= 2.13e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6901218264901  E_coul = 198.74564601832216
  HOMO = -0.237992313498627  LUMO = 10.1165790779834
  mo_energy =
[-1.20318096e+02 -1.23755101e+01 -6.67592410e+00 -6.67592410e+00
 -6.67592410e+00 -1.16405964e+00 -2.37992313e-01 -2.37992313e-01
 -2.37992313e-01  1.01165791e+01  1.10470363e+02  6.08917046e+02
  2.76557667e+03  1.24017676e+04  4.20667344e+04  1.10892030e+05
  2.55057319e+05  5.49457291e+05  1.15337775e+06  2.43113403e+06
  5.37584116e+06]
E1 = -706.6901217350004  E_coul = 198.74564592683265
Extra cycle  E= -507.944475808168  delta_E= 1.71e-13  |g|= 7.09e-09  |ddm|= 7.13e-08
    CPU time for scf_cycle      4.86 sec, wall time      0.39 sec
exp = [3.96554405e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104181e+04 3.67547032e+04 7.30254979e+03
 1.83757658e+04 1.45670777e+03 3.77017798e+02 1.13885677e+02
 3.78581341e+01 8.10514727e+00 3.21077560e+00 8.60269519e+00
 4.92933043e-01]
E = -507.94447580816774
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396554405116       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069949        1
[INPUT] 0    0    [1    /1   ]  294042.030985        1
[INPUT] 0    0    [1    /1   ]  147020.991305        1
[INPUT] 0    0    [1    /1   ]  73510.4181259        1
[INPUT] 0    0    [1    /1   ]  36754.7031887        1
[INPUT] 0    0    [1    /1   ]  7302.5497942         1
[INPUT] 0    0    [1    /1   ]  18375.7658318        1
[INPUT] 0    0    [1    /1   ]  1456.70777484        1
[INPUT] 0    0    [1    /1   ]  377.017798195        1
[INPUT] 0    0    [1    /1   ]  113.885676604        1
[INPUT] 0    0    [1    /1   ]  37.8581340999        1
[INPUT] 0    0    [1    /1   ]  8.10514727098        1
[INPUT] 0    0    [1    /1   ]  3.21077559898        1
[INPUT] 1    0    [1    /1   ]  8.60269519343        1
[INPUT] 1    0    [1    /1   ]  0.492933042673       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3965544051163429, 1.0]], [0, [1176168.1426194082, 1.0]], [0, [588084.0699494691, 1.0]], [0, [294042.03098461236, 1.0]], [0, [147020.99130514456, 1.0]], [0, [73510.41812589737, 1.0]], [0, [36754.70318865438, 1.0]], [0, [7302.549794196091, 1.0]], [0, [18375.765831767934, 1.0]], [0, [1456.7077748446889, 1.0]], [0, [377.01779819549546, 1.0]], [0, [113.88567660360124, 1.0]], [0, [37.85813409988706, 1.0]], [0, [8.10514727097691, 1.0]], [0, [3.210775598978795, 1.0]], [1, [8.602695193429344, 1.0]], [1, [0.4929330426734138, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39655441]
bas 1, expnt(s) = [1176168.14261941]
bas 2, expnt(s) = [588084.06994947]
bas 3, expnt(s) = [294042.03098461]
bas 4, expnt(s) = [147020.99130514]
bas 5, expnt(s) = [73510.4181259]
bas 6, expnt(s) = [36754.70318865]
bas 7, expnt(s) = [7302.5497942]
bas 8, expnt(s) = [18375.76583177]
bas 9, expnt(s) = [1456.70777484]
bas 10, expnt(s) = [377.0177982]
bas 11, expnt(s) = [113.8856766]
bas 12, expnt(s) = [37.8581341]
bas 13, expnt(s) = [8.10514727]
bas 14, expnt(s) = [3.2107756]
bas 15, expnt(s) = [8.60269519]
bas 16, expnt(s) = [0.49293304]
CPU time:      1335.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96554405e-01 1.26253117e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104181e+04 1.12791584e+04
 3.67547032e+04 6.70655845e+03 7.30254979e+03 1.99581793e+03
 1.83757658e+04 3.98748544e+03 1.45670777e+03 5.95722979e+02
 3.77017798e+02 2.16165516e+02 1.13885677e+02 8.80778802e+01
 3.78581341e+01 3.85597694e+01 8.10514727e+00 1.21362833e+01
 3.21077560e+00 6.05999812e+00 8.60269519e+00 4.29811035e+01
 4.92933043e-01 1.20495078e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325201351065406
cond(S) = 12752.340213654648
E1 = -689.3887465063198  E_coul = 184.9033320925555
init E= -504.485414413764
    CPU time for initialize scf      4.77 sec, wall time      0.33 sec
  HOMO = -0.674812136211603  LUMO = 9.21803284968576
  mo_energy =
[-1.21708335e+02 -1.33881239e+01 -7.62864710e+00 -7.62864710e+00
 -7.62864710e+00 -1.64028348e+00 -6.74812136e-01 -6.74812136e-01
 -6.74812136e-01  9.21803285e+00  1.09166187e+02  6.07544456e+02
  2.76428325e+03  1.24005951e+04  4.20656339e+04  1.10890970e+05
  2.55056287e+05  5.49456279e+05  1.15337675e+06  2.43113305e+06
  5.37584018e+06]
E1 = -707.0584203158462  E_coul = 199.12032326934616
cycle= 1 E= -507.9380970465  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.584514
diis-c [-0.34165637  1.        ]
  HOMO = -0.233327488376948  LUMO = 10.1280311737846
  mo_energy =
[-1.20257818e+02 -1.23520805e+01 -6.64678832e+00 -6.64678832e+00
 -6.64678832e+00 -1.16169439e+00 -2.33327488e-01 -2.33327488e-01
 -2.33327488e-01  1.01280312e+01  1.10515818e+02  6.08980783e+02
  2.76565360e+03  1.24018529e+04  4.20668229e+04  1.10892120e+05
  2.55057410e+05  5.49457382e+05  1.15337784e+06  2.43113413e+06
  5.37584125e+06]
E1 = -706.7054467159626  E_coul = 198.76098293254984
cycle= 2 E= -507.944463783413  delta_E= -0.00637  |g|= 0.018  |ddm|= 0.194
    CPU time for cycle= 2      0.06 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152257
diis-c [-2.23542479e-04  4.90037251e-03  9.95099627e-01]
  HOMO = -0.23776626667306  LUMO = 10.117121399146
  mo_energy =
[-1.20315504e+02 -1.23744020e+01 -6.67457018e+00 -6.67457018e+00
 -6.67457018e+00 -1.16394933e+00 -2.37766267e-01 -2.37766267e-01
 -2.37766267e-01  1.01171214e+01  1.10472383e+02  6.08919714e+02
  2.76557971e+03  1.24017708e+04  4.20667377e+04  1.10892033e+05
  2.55057322e+05  5.49457295e+05  1.15337775e+06  2.43113404e+06
  5.37584116e+06]
E1 = -706.6908559606209  E_coul = 198.7463801823561
cycle= 3 E= -507.944475778265  delta_E= -1.2e-05  |g|= 0.000875  |ddm|= 0.00868
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000738503
diis-c [-1.23685234e-08  3.92938774e-05 -5.00822918e-02  1.05004300e+00]
  HOMO = -0.237991541292103  LUMO = 10.1165798948427
  mo_energy =
[-1.20318098e+02 -1.23755075e+01 -6.67592238e+00 -6.67592238e+00
 -6.67592238e+00 -1.16405920e+00 -2.37991541e-01 -2.37991541e-01
 -2.37991541e-01  1.01165799e+01  1.10470363e+02  6.08917044e+02
  2.76557666e+03  1.24017676e+04  4.20667344e+04  1.10892030e+05
  2.55057319e+05  5.49457291e+05  1.15337775e+06  2.43113403e+06
  5.37584116e+06]
E1 = -706.6901229120879  E_coul = 198.74564710392124
cycle= 4 E= -507.944475808167  delta_E= -2.99e-08  |g|= 6.18e-06  |ddm|= 0.000459
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.38592e-06
diis-c [-4.62721822e-12 -1.82537894e-06  2.29369240e-03 -4.55804373e-02
  1.04328857e+00]
  HOMO = -0.237992280019036  LUMO = 10.1165791459455
  mo_energy =
[-1.20318096e+02 -1.23755099e+01 -6.67592393e+00 -6.67592393e+00
 -6.67592393e+00 -1.16405962e+00 -2.37992280e-01 -2.37992280e-01
 -2.37992280e-01  1.01165791e+01  1.10470364e+02  6.08917047e+02
  2.76557667e+03  1.24017676e+04  4.20667344e+04  1.10892030e+05
  2.55057319e+05  5.49457291e+05  1.15337775e+06  2.43113403e+06
  5.37584116e+06]
E1 = -706.6901218264901  E_coul = 198.74564601832216
cycle= 5 E= -507.944475808168  delta_E= -1.25e-12  |g|= 1.39e-07  |ddm|= 2.13e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6901218264901  E_coul = 198.74564601832216
  HOMO = -0.237992313498627  LUMO = 10.1165790779834
  mo_energy =
[-1.20318096e+02 -1.23755101e+01 -6.67592410e+00 -6.67592410e+00
 -6.67592410e+00 -1.16405964e+00 -2.37992313e-01 -2.37992313e-01
 -2.37992313e-01  1.01165791e+01  1.10470363e+02  6.08917046e+02
  2.76557667e+03  1.24017676e+04  4.20667344e+04  1.10892030e+05
  2.55057319e+05  5.49457291e+05  1.15337775e+06  2.43113403e+06
  5.37584116e+06]
E1 = -706.6901217350004  E_coul = 198.74564592683265
Extra cycle  E= -507.944475808168  delta_E= 1.71e-13  |g|= 7.09e-09  |ddm|= 7.13e-08
    CPU time for scf_cycle      5.03 sec, wall time      0.40 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12752.340213654648
E1 = -706.6901217350004  E_coul = 198.74564592683265
init E= -507.944475808168
    CPU time for initialize scf     10.15 sec, wall time      0.70 sec
  HOMO = -0.237992315075813  LUMO = 10.1165790751253
  mo_energy =
[-1.20318096e+02 -1.23755101e+01 -6.67592411e+00 -6.67592411e+00
 -6.67592411e+00 -1.16405964e+00 -2.37992315e-01 -2.37992315e-01
 -2.37992315e-01  1.01165791e+01  1.10470363e+02  6.08917046e+02
  2.76557667e+03  1.24017676e+04  4.20667344e+04  1.10892030e+05
  2.55057319e+05  5.49457291e+05  1.15337775e+06  2.43113403e+06
  5.37584116e+06]
E1 = -706.6901217308542  E_coul = 198.74564592268644
cycle= 1 E= -507.944475808168  delta_E= -5.68e-14  |g|= 1e-09  |ddm|= 3.5e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.6901217308542  E_coul = 198.74564592268644
  HOMO = -0.237992315152618  LUMO = 10.1165790751464
  mo_energy =
[-1.20318096e+02 -1.23755101e+01 -6.67592411e+00 -6.67592411e+00
 -6.67592411e+00 -1.16405964e+00 -2.37992315e-01 -2.37992315e-01
 -2.37992315e-01  1.01165791e+01  1.10470363e+02  6.08917046e+02
  2.76557667e+03  1.24017676e+04  4.20667344e+04  1.10892030e+05
  2.55057319e+05  5.49457291e+05  1.15337775e+06  2.43113403e+06
  5.37584116e+06]
E1 = -706.6901217307303  E_coul = 198.7456459225626
Extra cycle  E= -507.944475808168  delta_E= 1.14e-13  |g|= 1.13e-09  |ddm|= 1.67e-10
    CPU time for scf_cycle     10.35 sec, wall time      0.77 sec
exp = [3.96554405e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104181e+04 3.67547032e+04 7.30254979e+03
 1.83757658e+04 1.45670777e+03 3.77017798e+02 1.13885677e+02
 3.78581341e+01 8.10514727e+00 3.21077560e+00 8.60269519e+00
 4.92933043e-01]
grad_E = [-1.08417091e-03 -5.28874040e-11  1.60932879e-10  4.49605261e-10
  3.36397947e-09  9.17195986e-09  6.86206706e-08  4.11849679e-06
  1.08405084e-07 -4.46408751e-06  4.84070829e-05 -1.10091461e-04
  8.73717601e-05  1.79160356e-06  1.16730976e-04 -8.94758871e-04
 -1.52716675e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396599556661       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069965        1
[INPUT] 0    0    [1    /1   ]  294042.03104         1
[INPUT] 0    0    [1    /1   ]  147020.991619        1
[INPUT] 0    0    [1    /1   ]  73510.4191866        1
[INPUT] 0    0    [1    /1   ]  36754.7094725        1
[INPUT] 0    0    [1    /1   ]  7302.89561431        1
[INPUT] 0    0    [1    /1   ]  18375.7822754        1
[INPUT] 0    0    [1    /1   ]  1454.34266713        1
[INPUT] 0    0    [1    /1   ]  375.044863767        1
[INPUT] 0    0    [1    /1   ]  113.528788407        1
[INPUT] 0    0    [1    /1   ]  37.8029545281        1
[INPUT] 0    0    [1    /1   ]  8.09463362146        1
[INPUT] 0    0    [1    /1   ]  3.20701389296        1
[INPUT] 1    0    [1    /1   ]  8.603410682          1
[INPUT] 1    0    [1    /1   ]  0.492980692489       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3965995566610769, 1.0]], [0, [1176168.1426192187, 1.0]], [0, [588084.069965472, 1.0]], [0, [294042.0310396915, 1.0]], [0, [147020.991618784, 1.0]], [0, [73510.41918661633, 1.0]], [0, [36754.70947246288, 1.0]], [0, [7302.895614306874, 1.0]], [0, [18375.782275357134, 1.0]], [0, [1454.3426671250725, 1.0]], [0, [375.04486376713015, 1.0]], [0, [113.52878840670863, 1.0]], [0, [37.802954528112664, 1.0]], [0, [8.094633621455039, 1.0]], [0, [3.207013892959131, 1.0]], [1, [8.60341068199822, 1.0]], [1, [0.4929806924887895, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39659956]
bas 1, expnt(s) = [1176168.14261922]
bas 2, expnt(s) = [588084.06996547]
bas 3, expnt(s) = [294042.03103969]
bas 4, expnt(s) = [147020.99161878]
bas 5, expnt(s) = [73510.41918662]
bas 6, expnt(s) = [36754.70947246]
bas 7, expnt(s) = [7302.89561431]
bas 8, expnt(s) = [18375.78227536]
bas 9, expnt(s) = [1454.34266713]
bas 10, expnt(s) = [375.04486377]
bas 11, expnt(s) = [113.52878841]
bas 12, expnt(s) = [37.80295453]
bas 13, expnt(s) = [8.09463362]
bas 14, expnt(s) = [3.20701389]
bas 15, expnt(s) = [8.60341068]
bas 16, expnt(s) = [0.49298069]
CPU time:      1353.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96599557e-01 1.26263898e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104192e+04 1.12791585e+04
 3.67547095e+04 6.70655931e+03 7.30289561e+03 1.99588881e+03
 1.83757823e+04 3.98748811e+03 1.45434267e+03 5.94997421e+02
 3.75044864e+02 2.15316564e+02 1.13528788e+02 8.78707891e+01
 3.78029545e+01 3.85176101e+01 8.09463362e+00 1.21244744e+01
 3.20701389e+00 6.05467248e+00 8.60341068e+00 4.29855720e+01
 4.92980692e-01 1.20509638e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32513500319293
cond(S) = 12748.961145135601
E1 = -689.3961377323568  E_coul = 184.9085295930161
init E= -504.487608139341
    CPU time for initialize scf      4.50 sec, wall time      0.34 sec
  HOMO = -0.67474721376618  LUMO = 9.19573298982075
  mo_energy =
[-1.21707491e+02 -1.33877282e+01 -7.62829145e+00 -7.62829145e+00
 -7.62829145e+00 -1.64022159e+00 -6.74747214e-01 -6.74747214e-01
 -6.74747214e-01  9.19573299e+00  1.08848691e+02  6.04907336e+02
  2.75508661e+03  1.23856915e+04  4.20499158e+04  1.10875682e+05
  2.55041493e+05  5.49441925e+05  1.15336280e+06  2.43111949e+06
  5.37582703e+06]
E1 = -707.0652997531101  E_coul = 199.12718912312465
cycle= 1 E= -507.938110629985  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.584735
diis-c [-0.34191448  1.        ]
  HOMO = -0.233193754586159  LUMO = 10.1051887122716
  mo_energy =
[-1.20256852e+02 -1.23515715e+01 -6.64631515e+00 -6.64631515e+00
 -6.64631515e+00 -1.16157101e+00 -2.33193755e-01 -2.33193755e-01
 -2.33193755e-01  1.01051887e+01  1.10198029e+02  6.06343805e+02
  2.75645723e+03  1.23869495e+04  4.20511048e+04  1.10876832e+05
  2.55042616e+05  5.49443028e+05  1.15336389e+06  2.43112057e+06
  5.37582811e+06]
E1 = -706.711618290801  E_coul = 198.76712627937204
cycle= 2 E= -507.944492011429  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.015235
diis-c [-2.23815019e-04  4.90150001e-03  9.95098500e-01]
  HOMO = -0.237646220340463  LUMO = 10.0942709223604
  mo_energy =
[-1.20314621e+02 -1.23739452e+01 -6.67415564e+00 -6.67415564e+00
 -6.67415564e+00 -1.16383372e+00 -2.37646220e-01 -2.37646220e-01
 -2.37646220e-01  1.00942709e+01  1.10154564e+02  6.06282697e+02
  2.75638327e+03  1.23868672e+04  4.20510196e+04  1.10876745e+05
  2.55042529e+05  5.49442940e+05  1.15336380e+06  2.43112048e+06
  5.37582802e+06]
E1 = -706.6969794363208  E_coul = 198.7524753685076
cycle= 3 E= -507.944504067813  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00872
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739399
diis-c [-1.25373686e-08  3.95351750e-05 -5.01056175e-02  1.05006608e+00]
  HOMO = -0.237872500687115  LUMO = 10.0937282762166
  mo_energy =
[-1.20317221e+02 -1.23750547e+01 -6.67551231e+00 -6.67551231e+00
 -6.67551231e+00 -1.16394412e+00 -2.37872501e-01 -2.37872501e-01
 -2.37872501e-01  1.00937283e+01  1.10152540e+02  6.06280022e+02
  2.75638022e+03  1.23868640e+04  4.20510162e+04  1.10876742e+05
  2.55042526e+05  5.49442937e+05  1.15336380e+06  2.43112048e+06
  5.37582801e+06]
E1 = -706.6962430125983  E_coul = 198.7517389146412
cycle= 4 E= -507.944504097957  delta_E= -3.01e-08  |g|= 6.24e-06  |ddm|= 0.000462
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.42869e-06
diis-c [-4.66638589e-12 -1.82887878e-06  2.30272410e-03 -4.57614284e-02
  1.04346053e+00]
  HOMO = -0.237873254872654  LUMO = 10.0937275024391
  mo_energy =
[-1.20317219e+02 -1.23750572e+01 -6.67551393e+00 -6.67551393e+00
 -6.67551393e+00 -1.16394455e+00 -2.37873255e-01 -2.37873255e-01
 -2.37873255e-01  1.00937275e+01  1.10152540e+02  6.06280025e+02
  2.75638022e+03  1.23868640e+04  4.20510162e+04  1.10876742e+05
  2.55042526e+05  5.49442937e+05  1.15336380e+06  2.43112048e+06
  5.37582801e+06]
E1 = -706.696241886625  E_coul = 198.75173778866645
cycle= 5 E= -507.944504097959  delta_E= -1.48e-12  |g|= 1.39e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.696241886625  E_coul = 198.75173778866645
  HOMO = -0.23787328849453  LUMO = 10.0937274321733
  mo_energy =
[-1.20317219e+02 -1.23750573e+01 -6.67551410e+00 -6.67551410e+00
 -6.67551410e+00 -1.16394457e+00 -2.37873288e-01 -2.37873288e-01
 -2.37873288e-01  1.00937274e+01  1.10152540e+02  6.06280025e+02
  2.75638022e+03  1.23868640e+04  4.20510162e+04  1.10876742e+05
  2.55042526e+05  5.49442937e+05  1.15336380e+06  2.43112048e+06
  5.37582801e+06]
E1 = -706.696241794668  E_coul = 198.75173769670963
Extra cycle  E= -507.944504097958  delta_E= 1.14e-13  |g|= 7.15e-09  |ddm|= 7.16e-08
    CPU time for scf_cycle      4.76 sec, wall time      0.41 sec
exp = [3.96599557e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104192e+04 3.67547095e+04 7.30289561e+03
 1.83757823e+04 1.45434267e+03 3.75044864e+02 1.13528788e+02
 3.78029545e+01 8.09463362e+00 3.20701389e+00 8.60341068e+00
 4.92980692e-01]
E = -507.94450409795843
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396599556661       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069965        1
[INPUT] 0    0    [1    /1   ]  294042.03104         1
[INPUT] 0    0    [1    /1   ]  147020.991619        1
[INPUT] 0    0    [1    /1   ]  73510.4191866        1
[INPUT] 0    0    [1    /1   ]  36754.7094725        1
[INPUT] 0    0    [1    /1   ]  7302.89561431        1
[INPUT] 0    0    [1    /1   ]  18375.7822754        1
[INPUT] 0    0    [1    /1   ]  1454.34266713        1
[INPUT] 0    0    [1    /1   ]  375.044863767        1
[INPUT] 0    0    [1    /1   ]  113.528788407        1
[INPUT] 0    0    [1    /1   ]  37.8029545281        1
[INPUT] 0    0    [1    /1   ]  8.09463362146        1
[INPUT] 0    0    [1    /1   ]  3.20701389296        1
[INPUT] 1    0    [1    /1   ]  8.603410682          1
[INPUT] 1    0    [1    /1   ]  0.492980692489       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3965995566610769, 1.0]], [0, [1176168.1426192187, 1.0]], [0, [588084.069965472, 1.0]], [0, [294042.0310396915, 1.0]], [0, [147020.991618784, 1.0]], [0, [73510.41918661633, 1.0]], [0, [36754.70947246288, 1.0]], [0, [7302.895614306874, 1.0]], [0, [18375.782275357134, 1.0]], [0, [1454.3426671250725, 1.0]], [0, [375.04486376713015, 1.0]], [0, [113.52878840670863, 1.0]], [0, [37.802954528112664, 1.0]], [0, [8.094633621455039, 1.0]], [0, [3.207013892959131, 1.0]], [1, [8.60341068199822, 1.0]], [1, [0.4929806924887895, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39659956]
bas 1, expnt(s) = [1176168.14261922]
bas 2, expnt(s) = [588084.06996547]
bas 3, expnt(s) = [294042.03103969]
bas 4, expnt(s) = [147020.99161878]
bas 5, expnt(s) = [73510.41918662]
bas 6, expnt(s) = [36754.70947246]
bas 7, expnt(s) = [7302.89561431]
bas 8, expnt(s) = [18375.78227536]
bas 9, expnt(s) = [1454.34266713]
bas 10, expnt(s) = [375.04486377]
bas 11, expnt(s) = [113.52878841]
bas 12, expnt(s) = [37.80295453]
bas 13, expnt(s) = [8.09463362]
bas 14, expnt(s) = [3.20701389]
bas 15, expnt(s) = [8.60341068]
bas 16, expnt(s) = [0.49298069]
CPU time:      1358.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96599557e-01 1.26263898e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104192e+04 1.12791585e+04
 3.67547095e+04 6.70655931e+03 7.30289561e+03 1.99588881e+03
 1.83757823e+04 3.98748811e+03 1.45434267e+03 5.94997421e+02
 3.75044864e+02 2.15316564e+02 1.13528788e+02 8.78707891e+01
 3.78029545e+01 3.85176101e+01 8.09463362e+00 1.21244744e+01
 3.20701389e+00 6.05467248e+00 8.60341068e+00 4.29855720e+01
 4.92980692e-01 1.20509638e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32513500319293
cond(S) = 12748.961145135601
E1 = -689.3961377323568  E_coul = 184.9085295930161
init E= -504.487608139341
    CPU time for initialize scf      4.52 sec, wall time      0.34 sec
  HOMO = -0.67474721376618  LUMO = 9.19573298982075
  mo_energy =
[-1.21707491e+02 -1.33877282e+01 -7.62829145e+00 -7.62829145e+00
 -7.62829145e+00 -1.64022159e+00 -6.74747214e-01 -6.74747214e-01
 -6.74747214e-01  9.19573299e+00  1.08848691e+02  6.04907336e+02
  2.75508661e+03  1.23856915e+04  4.20499158e+04  1.10875682e+05
  2.55041493e+05  5.49441925e+05  1.15336280e+06  2.43111949e+06
  5.37582703e+06]
E1 = -707.0652997531101  E_coul = 199.12718912312465
cycle= 1 E= -507.938110629985  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.584735
diis-c [-0.34191448  1.        ]
  HOMO = -0.233193754586159  LUMO = 10.1051887122716
  mo_energy =
[-1.20256852e+02 -1.23515715e+01 -6.64631515e+00 -6.64631515e+00
 -6.64631515e+00 -1.16157101e+00 -2.33193755e-01 -2.33193755e-01
 -2.33193755e-01  1.01051887e+01  1.10198029e+02  6.06343805e+02
  2.75645723e+03  1.23869495e+04  4.20511048e+04  1.10876832e+05
  2.55042616e+05  5.49443028e+05  1.15336389e+06  2.43112057e+06
  5.37582811e+06]
E1 = -706.711618290801  E_coul = 198.76712627937204
cycle= 2 E= -507.944492011429  delta_E= -0.00638  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.015235
diis-c [-2.23815019e-04  4.90150001e-03  9.95098500e-01]
  HOMO = -0.237646220340463  LUMO = 10.0942709223604
  mo_energy =
[-1.20314621e+02 -1.23739452e+01 -6.67415564e+00 -6.67415564e+00
 -6.67415564e+00 -1.16383372e+00 -2.37646220e-01 -2.37646220e-01
 -2.37646220e-01  1.00942709e+01  1.10154564e+02  6.06282697e+02
  2.75638327e+03  1.23868672e+04  4.20510196e+04  1.10876745e+05
  2.55042529e+05  5.49442940e+05  1.15336380e+06  2.43112048e+06
  5.37582802e+06]
E1 = -706.6969794363208  E_coul = 198.7524753685076
cycle= 3 E= -507.944504067813  delta_E= -1.21e-05  |g|= 0.000877  |ddm|= 0.00872
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739399
diis-c [-1.25373686e-08  3.95351750e-05 -5.01056175e-02  1.05006608e+00]
  HOMO = -0.237872500687115  LUMO = 10.0937282762166
  mo_energy =
[-1.20317221e+02 -1.23750547e+01 -6.67551231e+00 -6.67551231e+00
 -6.67551231e+00 -1.16394412e+00 -2.37872501e-01 -2.37872501e-01
 -2.37872501e-01  1.00937283e+01  1.10152540e+02  6.06280022e+02
  2.75638022e+03  1.23868640e+04  4.20510162e+04  1.10876742e+05
  2.55042526e+05  5.49442937e+05  1.15336380e+06  2.43112048e+06
  5.37582801e+06]
E1 = -706.6962430125983  E_coul = 198.7517389146412
cycle= 4 E= -507.944504097957  delta_E= -3.01e-08  |g|= 6.24e-06  |ddm|= 0.000462
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.42869e-06
diis-c [-4.66638589e-12 -1.82887878e-06  2.30272410e-03 -4.57614284e-02
  1.04346053e+00]
  HOMO = -0.237873254872654  LUMO = 10.0937275024391
  mo_energy =
[-1.20317219e+02 -1.23750572e+01 -6.67551393e+00 -6.67551393e+00
 -6.67551393e+00 -1.16394455e+00 -2.37873255e-01 -2.37873255e-01
 -2.37873255e-01  1.00937275e+01  1.10152540e+02  6.06280025e+02
  2.75638022e+03  1.23868640e+04  4.20510162e+04  1.10876742e+05
  2.55042526e+05  5.49442937e+05  1.15336380e+06  2.43112048e+06
  5.37582801e+06]
E1 = -706.696241886625  E_coul = 198.75173778866645
cycle= 5 E= -507.944504097959  delta_E= -1.48e-12  |g|= 1.39e-07  |ddm|= 2.17e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.696241886625  E_coul = 198.75173778866645
  HOMO = -0.23787328849453  LUMO = 10.0937274321733
  mo_energy =
[-1.20317219e+02 -1.23750573e+01 -6.67551410e+00 -6.67551410e+00
 -6.67551410e+00 -1.16394457e+00 -2.37873288e-01 -2.37873288e-01
 -2.37873288e-01  1.00937274e+01  1.10152540e+02  6.06280025e+02
  2.75638022e+03  1.23868640e+04  4.20510162e+04  1.10876742e+05
  2.55042526e+05  5.49442937e+05  1.15336380e+06  2.43112048e+06
  5.37582801e+06]
E1 = -706.696241794668  E_coul = 198.75173769670963
Extra cycle  E= -507.944504097958  delta_E= 1.14e-13  |g|= 7.15e-09  |ddm|= 7.16e-08
    CPU time for scf_cycle      4.79 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12748.961145135601
E1 = -706.696241794668  E_coul = 198.75173769670963
init E= -507.944504097958
    CPU time for initialize scf      9.85 sec, wall time      0.70 sec
  HOMO = -0.237873290080646  LUMO = 10.0937274300635
  mo_energy =
[-1.20317219e+02 -1.23750573e+01 -6.67551411e+00 -6.67551411e+00
 -6.67551411e+00 -1.16394457e+00 -2.37873290e-01 -2.37873290e-01
 -2.37873290e-01  1.00937274e+01  1.10152540e+02  6.06280025e+02
  2.75638022e+03  1.23868640e+04  4.20510162e+04  1.10876742e+05
  2.55042526e+05  5.49442937e+05  1.15336380e+06  2.43112048e+06
  5.37582801e+06]
E1 = -706.6962417905197  E_coul = 198.75173769256088
cycle= 1 E= -507.944504097959  delta_E= -3.98e-13  |g|= 1.16e-09  |ddm|= 3.53e-09
    CPU time for cycle= 1      0.02 sec, wall time      0.01 sec
E1 = -706.6962417905197  E_coul = 198.75173769256088
  HOMO = -0.237873290157975  LUMO = 10.093727428592
  mo_energy =
[-1.20317219e+02 -1.23750573e+01 -6.67551411e+00 -6.67551411e+00
 -6.67551411e+00 -1.16394457e+00 -2.37873290e-01 -2.37873290e-01
 -2.37873290e-01  1.00937274e+01  1.10152540e+02  6.06280025e+02
  2.75638022e+03  1.23868640e+04  4.20510162e+04  1.10876742e+05
  2.55042526e+05  5.49442937e+05  1.15336380e+06  2.43112048e+06
  5.37582801e+06]
E1 = -706.6962417902613  E_coul = 198.7517376923031
Extra cycle  E= -507.944504097958  delta_E= 6.25e-13  |g|= 6.51e-10  |ddm|= 1.89e-10
    CPU time for scf_cycle      9.92 sec, wall time      0.77 sec
exp = [3.96599557e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104192e+04 3.67547095e+04 7.30289561e+03
 1.83757823e+04 1.45434267e+03 3.75044864e+02 1.13528788e+02
 3.78029545e+01 8.09463362e+00 3.20701389e+00 8.60341068e+00
 4.92980692e-01]
grad_E = [-4.06121682e-04 -5.32100240e-11  1.57778512e-10  4.38474698e-10
  3.30382345e-09  8.96303474e-09  6.73984070e-08  4.02660658e-06
  1.05232772e-07  1.23279726e-06  4.00843347e-06 -1.26647739e-05
  1.13198334e-05 -1.34518477e-05  8.16860082e-05 -3.55398924e-04
 -4.51274566e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396629323209       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031101        1
[INPUT] 0    0    [1    /1   ]  147020.991967        1
[INPUT] 0    0    [1    /1   ]  73510.4203677        1
[INPUT] 0    0    [1    /1   ]  36754.7164522        1
[INPUT] 0    0    [1    /1   ]  7303.27996805        1
[INPUT] 0    0    [1    /1   ]  18375.8006277        1
[INPUT] 0    0    [1    /1   ]  1451.41437483        1
[INPUT] 0    0    [1    /1   ]  374.295241215        1
[INPUT] 0    0    [1    /1   ]  113.39700402         1
[INPUT] 0    0    [1    /1   ]  37.7787324553        1
[INPUT] 0    0    [1    /1   ]  8.09024486617        1
[INPUT] 0    0    [1    /1   ]  3.20507891283        1
[INPUT] 1    0    [1    /1   ]  8.60386515886        1
[INPUT] 1    0    [1    /1   ]  0.493005396598       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.396629323209414, 1.0]], [0, [1176168.1426190613, 1.0]], [0, [588084.0699832604, 1.0]], [0, [294042.03110104514, 1.0]], [0, [147020.99196721258, 1.0]], [0, [73510.42036769832, 1.0]], [0, [36754.71645223008, 1.0]], [0, [7303.279968052238, 1.0]], [0, [18375.80062772079, 1.0]], [0, [1451.414374829935, 1.0]], [0, [374.29524121497445, 1.0]], [0, [113.39700401984112, 1.0]], [0, [37.77873245528772, 1.0]], [0, [8.09024486616564, 1.0]], [0, [3.205078912825485, 1.0]], [1, [8.603865158861488, 1.0]], [1, [0.4930053965980663, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39662932]
bas 1, expnt(s) = [1176168.14261906]
bas 2, expnt(s) = [588084.06998326]
bas 3, expnt(s) = [294042.03110105]
bas 4, expnt(s) = [147020.99196721]
bas 5, expnt(s) = [73510.4203677]
bas 6, expnt(s) = [36754.71645223]
bas 7, expnt(s) = [7303.27996805]
bas 8, expnt(s) = [18375.80062772]
bas 9, expnt(s) = [1451.41437483]
bas 10, expnt(s) = [374.29524121]
bas 11, expnt(s) = [113.39700402]
bas 12, expnt(s) = [37.77873246]
bas 13, expnt(s) = [8.09024487]
bas 14, expnt(s) = [3.20507891]
bas 15, expnt(s) = [8.60386516]
bas 16, expnt(s) = [0.4930054]
CPU time:      1375.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96629323e-01 1.26271005e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104204e+04 1.12791586e+04
 3.67547165e+04 6.70656027e+03 7.30327997e+03 1.99596760e+03
 1.83758006e+04 3.98749110e+03 1.45141437e+03 5.94098682e+02
 3.74295241e+02 2.14993710e+02 1.13397004e+02 8.77942776e+01
 3.77787325e+01 3.84990986e+01 8.09024487e+00 1.21195438e+01
 3.20507891e+00 6.05193241e+00 8.60386516e+00 4.29884105e+01
 4.93005397e-01 1.20517186e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325099307779457
cond(S) = 12746.365638433708
E1 = -689.3993139423836  E_coul = 184.9116132767977
init E= -504.487700665586
    CPU time for initialize scf      4.58 sec, wall time      0.35 sec
  HOMO = -0.674714052399751  LUMO = 9.18554395995454
  mo_energy =
[-1.21706966e+02 -1.33874944e+01 -7.62807951e+00 -7.62807951e+00
 -7.62807951e+00 -1.64018510e+00 -6.74714052e-01 -6.74714052e-01
 -6.74714052e-01  9.18554396e+00  1.08716595e+02  6.03877036e+02
  2.74973748e+03  1.23744065e+04  4.20373857e+04  1.10863417e+05
  2.55029626e+05  5.49430415e+05  1.15335162e+06  2.43110862e+06
  5.37581650e+06]
E1 = -707.0692058117463  E_coul = 199.1310997892218
cycle= 1 E= -507.938106022524  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
diis-norm(errvec)=0.584843
diis-c [-0.34204124  1.        ]
  HOMO = -0.233124327011185  LUMO = 10.0947589802269
  mo_energy =
[-1.20256269e+02 -1.23512831e+01 -6.64604636e+00 -6.64604636e+00
 -6.64604636e+00 -1.16150264e+00 -2.33124327e-01 -2.33124327e-01
 -2.33124327e-01  1.00947590e+01  1.10065825e+02  6.05313571e+02
  2.75110828e+03  1.23756645e+04  4.20385747e+04  1.10864567e+05
  2.55030749e+05  5.49431518e+05  1.15335271e+06  2.43110970e+06
  5.37581757e+06]
E1 = -706.7151831905989  E_coul = 198.77068868469271
cycle= 2 E= -507.944494505906  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152414
diis-c [-2.24012458e-04  4.89965262e-03  9.95100347e-01]
  HOMO = -0.237583268125594  LUMO = 10.0838368111726
  mo_energy =
[-1.20314079e+02 -1.23736816e+01 -6.67391515e+00 -6.67391515e+00
 -6.67391515e+00 -1.16376899e+00 -2.37583268e-01 -2.37583268e-01
 -2.37583268e-01  1.00838368e+01  1.10022342e+02  6.05252440e+02
  2.75103428e+03  1.23755822e+04  4.20384894e+04  1.10864480e+05
  2.55030662e+05  5.49431430e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.700521827672  E_coul = 198.75601523687345
cycle= 3 E= -507.944506590799  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739874
diis-c [-1.26187016e-08  3.96401227e-05 -5.01136813e-02  1.05007404e+00]
  HOMO = -0.237810005317273  LUMO = 10.0832936458662
  mo_energy =
[-1.20316682e+02 -1.23747929e+01 -6.67527385e+00 -6.67527385e+00
 -6.67527385e+00 -1.16387963e+00 -2.37810005e-01 -2.37810005e-01
 -2.37810005e-01  1.00832936e+01  1.10020316e+02  6.05249763e+02
  2.75103123e+03  1.23755790e+04  4.20384860e+04  1.10864477e+05
  2.55030659e+05  5.49431427e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.6997838809903  E_coul = 198.7552772599391
cycle= 4 E= -507.944506621051  delta_E= -3.03e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.44985e-06
diis-c [-4.68015675e-12 -1.83548141e-06  2.30717257e-03 -4.58511824e-02
  1.04354585e+00]
  HOMO = -0.237810766506229  LUMO = 10.0832928574096
  mo_energy =
[-1.20316680e+02 -1.23747954e+01 -6.67527550e+00 -6.67527550e+00
 -6.67527550e+00 -1.16388006e+00 -2.37810767e-01 -2.37810767e-01
 -2.37810767e-01  1.00832929e+01  1.10020316e+02  6.05249766e+02
  2.75103123e+03  1.23755790e+04  4.20384860e+04  1.10864477e+05
  2.55030659e+05  5.49431427e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.6997827368693  E_coul = 198.75527611581722
cycle= 5 E= -507.944506621052  delta_E= -1.02e-12  |g|= 1.4e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6997827368693  E_coul = 198.75527611581722
  HOMO = -0.237810800184739  LUMO = 10.0832927905574
  mo_energy =
[-1.20316680e+02 -1.23747956e+01 -6.67527567e+00 -6.67527567e+00
 -6.67527567e+00 -1.16388008e+00 -2.37810800e-01 -2.37810800e-01
 -2.37810800e-01  1.00832928e+01  1.10020316e+02  6.05249765e+02
  2.75103123e+03  1.23755790e+04  4.20384860e+04  1.10864477e+05
  2.55030659e+05  5.49431427e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.6997826447605  E_coul = 198.755276023708
Extra cycle  E= -507.944506621052  delta_E= -3.41e-13  |g|= 7.15e-09  |ddm|= 7.17e-08
    CPU time for scf_cycle      4.78 sec, wall time      0.43 sec
exp = [3.96629323e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104204e+04 3.67547165e+04 7.30327997e+03
 1.83758006e+04 1.45141437e+03 3.74295241e+02 1.13397004e+02
 3.77787325e+01 8.09024487e+00 3.20507891e+00 8.60386516e+00
 4.93005397e-01]
E = -507.9445066210525
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396629323209       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069983        1
[INPUT] 0    0    [1    /1   ]  294042.031101        1
[INPUT] 0    0    [1    /1   ]  147020.991967        1
[INPUT] 0    0    [1    /1   ]  73510.4203677        1
[INPUT] 0    0    [1    /1   ]  36754.7164522        1
[INPUT] 0    0    [1    /1   ]  7303.27996805        1
[INPUT] 0    0    [1    /1   ]  18375.8006277        1
[INPUT] 0    0    [1    /1   ]  1451.41437483        1
[INPUT] 0    0    [1    /1   ]  374.295241215        1
[INPUT] 0    0    [1    /1   ]  113.39700402         1
[INPUT] 0    0    [1    /1   ]  37.7787324553        1
[INPUT] 0    0    [1    /1   ]  8.09024486617        1
[INPUT] 0    0    [1    /1   ]  3.20507891283        1
[INPUT] 1    0    [1    /1   ]  8.60386515886        1
[INPUT] 1    0    [1    /1   ]  0.493005396598       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.396629323209414, 1.0]], [0, [1176168.1426190613, 1.0]], [0, [588084.0699832604, 1.0]], [0, [294042.03110104514, 1.0]], [0, [147020.99196721258, 1.0]], [0, [73510.42036769832, 1.0]], [0, [36754.71645223008, 1.0]], [0, [7303.279968052238, 1.0]], [0, [18375.80062772079, 1.0]], [0, [1451.414374829935, 1.0]], [0, [374.29524121497445, 1.0]], [0, [113.39700401984112, 1.0]], [0, [37.77873245528772, 1.0]], [0, [8.09024486616564, 1.0]], [0, [3.205078912825485, 1.0]], [1, [8.603865158861488, 1.0]], [1, [0.4930053965980663, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39662932]
bas 1, expnt(s) = [1176168.14261906]
bas 2, expnt(s) = [588084.06998326]
bas 3, expnt(s) = [294042.03110105]
bas 4, expnt(s) = [147020.99196721]
bas 5, expnt(s) = [73510.4203677]
bas 6, expnt(s) = [36754.71645223]
bas 7, expnt(s) = [7303.27996805]
bas 8, expnt(s) = [18375.80062772]
bas 9, expnt(s) = [1451.41437483]
bas 10, expnt(s) = [374.29524121]
bas 11, expnt(s) = [113.39700402]
bas 12, expnt(s) = [37.77873246]
bas 13, expnt(s) = [8.09024487]
bas 14, expnt(s) = [3.20507891]
bas 15, expnt(s) = [8.60386516]
bas 16, expnt(s) = [0.4930054]
CPU time:      1380.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96629323e-01 1.26271005e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104204e+04 1.12791586e+04
 3.67547165e+04 6.70656027e+03 7.30327997e+03 1.99596760e+03
 1.83758006e+04 3.98749110e+03 1.45141437e+03 5.94098682e+02
 3.74295241e+02 2.14993710e+02 1.13397004e+02 8.77942776e+01
 3.77787325e+01 3.84990986e+01 8.09024487e+00 1.21195438e+01
 3.20507891e+00 6.05193241e+00 8.60386516e+00 4.29884105e+01
 4.93005397e-01 1.20517186e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325099307779457
cond(S) = 12746.365638433708
E1 = -689.3993139423836  E_coul = 184.9116132767977
init E= -504.487700665586
    CPU time for initialize scf      4.13 sec, wall time      0.33 sec
  HOMO = -0.674714052399751  LUMO = 9.18554395995454
  mo_energy =
[-1.21706966e+02 -1.33874944e+01 -7.62807951e+00 -7.62807951e+00
 -7.62807951e+00 -1.64018510e+00 -6.74714052e-01 -6.74714052e-01
 -6.74714052e-01  9.18554396e+00  1.08716595e+02  6.03877036e+02
  2.74973748e+03  1.23744065e+04  4.20373857e+04  1.10863417e+05
  2.55029626e+05  5.49430415e+05  1.15335162e+06  2.43110862e+06
  5.37581650e+06]
E1 = -707.0692058117463  E_coul = 199.1310997892218
cycle= 1 E= -507.938106022524  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.584843
diis-c [-0.34204124  1.        ]
  HOMO = -0.233124327011185  LUMO = 10.0947589802269
  mo_energy =
[-1.20256269e+02 -1.23512831e+01 -6.64604636e+00 -6.64604636e+00
 -6.64604636e+00 -1.16150264e+00 -2.33124327e-01 -2.33124327e-01
 -2.33124327e-01  1.00947590e+01  1.10065825e+02  6.05313571e+02
  2.75110828e+03  1.23756645e+04  4.20385747e+04  1.10864567e+05
  2.55030749e+05  5.49431518e+05  1.15335271e+06  2.43110970e+06
  5.37581757e+06]
E1 = -706.7151831905989  E_coul = 198.77068868469271
cycle= 2 E= -507.944494505906  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.08 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152414
diis-c [-2.24012458e-04  4.89965262e-03  9.95100347e-01]
  HOMO = -0.237583268125594  LUMO = 10.0838368111726
  mo_energy =
[-1.20314079e+02 -1.23736816e+01 -6.67391515e+00 -6.67391515e+00
 -6.67391515e+00 -1.16376899e+00 -2.37583268e-01 -2.37583268e-01
 -2.37583268e-01  1.00838368e+01  1.10022342e+02  6.05252440e+02
  2.75103428e+03  1.23755822e+04  4.20384894e+04  1.10864480e+05
  2.55030662e+05  5.49431430e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.700521827672  E_coul = 198.75601523687345
cycle= 3 E= -507.944506590799  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739874
diis-c [-1.26187016e-08  3.96401227e-05 -5.01136813e-02  1.05007404e+00]
  HOMO = -0.237810005317273  LUMO = 10.0832936458662
  mo_energy =
[-1.20316682e+02 -1.23747929e+01 -6.67527385e+00 -6.67527385e+00
 -6.67527385e+00 -1.16387963e+00 -2.37810005e-01 -2.37810005e-01
 -2.37810005e-01  1.00832936e+01  1.10020316e+02  6.05249763e+02
  2.75103123e+03  1.23755790e+04  4.20384860e+04  1.10864477e+05
  2.55030659e+05  5.49431427e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.6997838809903  E_coul = 198.7552772599391
cycle= 4 E= -507.944506621051  delta_E= -3.03e-08  |g|= 6.27e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.44985e-06
diis-c [-4.68015675e-12 -1.83548141e-06  2.30717257e-03 -4.58511824e-02
  1.04354585e+00]
  HOMO = -0.237810766506229  LUMO = 10.0832928574096
  mo_energy =
[-1.20316680e+02 -1.23747954e+01 -6.67527550e+00 -6.67527550e+00
 -6.67527550e+00 -1.16388006e+00 -2.37810767e-01 -2.37810767e-01
 -2.37810767e-01  1.00832929e+01  1.10020316e+02  6.05249766e+02
  2.75103123e+03  1.23755790e+04  4.20384860e+04  1.10864477e+05
  2.55030659e+05  5.49431427e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.6997827368693  E_coul = 198.75527611581722
cycle= 5 E= -507.944506621052  delta_E= -1.02e-12  |g|= 1.4e-07  |ddm|= 2.18e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6997827368693  E_coul = 198.75527611581722
  HOMO = -0.237810800184739  LUMO = 10.0832927905574
  mo_energy =
[-1.20316680e+02 -1.23747956e+01 -6.67527567e+00 -6.67527567e+00
 -6.67527567e+00 -1.16388008e+00 -2.37810800e-01 -2.37810800e-01
 -2.37810800e-01  1.00832928e+01  1.10020316e+02  6.05249765e+02
  2.75103123e+03  1.23755790e+04  4.20384860e+04  1.10864477e+05
  2.55030659e+05  5.49431427e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.6997826447605  E_coul = 198.755276023708
Extra cycle  E= -507.944506621052  delta_E= -3.41e-13  |g|= 7.15e-09  |ddm|= 7.17e-08
    CPU time for scf_cycle      4.41 sec, wall time      0.41 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12746.365638433708
E1 = -706.6997826447605  E_coul = 198.755276023708
init E= -507.944506621052
    CPU time for initialize scf      8.92 sec, wall time      0.69 sec
  HOMO = -0.237810801773947  LUMO = 10.0832927861247
  mo_energy =
[-1.20316680e+02 -1.23747956e+01 -6.67527568e+00 -6.67527568e+00
 -6.67527568e+00 -1.16388008e+00 -2.37810802e-01 -2.37810802e-01
 -2.37810802e-01  1.00832928e+01  1.10020316e+02  6.05249765e+02
  2.75103123e+03  1.23755790e+04  4.20384860e+04  1.10864477e+05
  2.55030659e+05  5.49431427e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.6997826405807  E_coul = 198.75527601952822
cycle= 1 E= -507.944506621052  delta_E=    0  |g|= 9.98e-10  |ddm|= 3.54e-09
    CPU time for cycle= 1      0.11 sec, wall time      0.01 sec
E1 = -706.6997826405807  E_coul = 198.75527601952822
  HOMO = -0.23781080185155  LUMO = 10.0832927866766
  mo_energy =
[-1.20316680e+02 -1.23747956e+01 -6.67527568e+00 -6.67527568e+00
 -6.67527568e+00 -1.16388008e+00 -2.37810802e-01 -2.37810802e-01
 -2.37810802e-01  1.00832928e+01  1.10020316e+02  6.05249765e+02
  2.75103123e+03  1.23755790e+04  4.20384860e+04  1.10864477e+05
  2.55030659e+05  5.49431427e+05  1.15335262e+06  2.43110961e+06
  5.37581748e+06]
E1 = -706.699782640437  E_coul = 198.7552760193848
Extra cycle  E= -507.944506621052  delta_E= 3.41e-13  |g|= 9.93e-10  |ddm|= 1.85e-10
    CPU time for scf_cycle      9.12 sec, wall time      0.76 sec
exp = [3.96629323e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104204e+04 3.67547165e+04 7.30327997e+03
 1.83758006e+04 1.45141437e+03 3.74295241e+02 1.13397004e+02
 3.77787325e+01 8.09024487e+00 3.20507891e+00 8.60386516e+00
 4.93005397e-01]
grad_E = [-5.03883818e-06 -5.29524349e-11  1.60282766e-10  4.47323471e-10
  3.35148434e-09  9.12939911e-09  6.83519972e-08  4.07925988e-06
  1.07849451e-07  1.09360692e-06 -1.18224664e-06  3.23331800e-06
 -3.00479339e-06 -1.49004518e-06 -3.85468071e-06 -5.81127573e-06
  1.64593725e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396634925059       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209821        1
[INPUT] 0    0    [1    /1   ]  36754.7200825        1
[INPUT] 0    0    [1    /1   ]  7303.47988684        1
[INPUT] 0    0    [1    /1   ]  18375.8101771        1
[INPUT] 0    0    [1    /1   ]  1449.87736953        1
[INPUT] 0    0    [1    /1   ]  373.974758656        1
[INPUT] 0    0    [1    /1   ]  113.330153976        1
[INPUT] 0    0    [1    /1   ]  37.7645574006        1
[INPUT] 0    0    [1    /1   ]  8.0896691706         1
[INPUT] 0    0    [1    /1   ]  3.20472857192        1
[INPUT] 1    0    [1    /1   ]  8.60395612889        1
[INPUT] 1    0    [1    /1   ]  0.493009909525       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39663492505885756, 1.0]], [0, [1176168.142618982, 1.0]], [0, [588084.0699925129, 1.0]], [0, [294042.0311329642, 1.0]], [0, [147020.99214843794, 1.0]], [0, [73510.42098213072, 1.0]], [0, [36754.7200825113, 1.0]], [0, [7303.479886837559, 1.0]], [0, [18375.810177127434, 1.0]], [0, [1449.8773695282625, 1.0]], [0, [373.9747586558661, 1.0]], [0, [113.33015397569277, 1.0]], [0, [37.7645574006111, 1.0]], [0, [8.089669170603274, 1.0]], [0, [3.2047285719222987, 1.0]], [1, [8.60395612889121, 1.0]], [1, [0.4930099095245898, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39663493]
bas 1, expnt(s) = [1176168.14261898]
bas 2, expnt(s) = [588084.06999251]
bas 3, expnt(s) = [294042.03113296]
bas 4, expnt(s) = [147020.99214844]
bas 5, expnt(s) = [73510.42098213]
bas 6, expnt(s) = [36754.72008251]
bas 7, expnt(s) = [7303.47988684]
bas 8, expnt(s) = [18375.81017713]
bas 9, expnt(s) = [1449.87736953]
bas 10, expnt(s) = [373.97475866]
bas 11, expnt(s) = [113.33015398]
bas 12, expnt(s) = [37.7645574]
bas 13, expnt(s) = [8.08966917]
bas 14, expnt(s) = [3.20472857]
bas 15, expnt(s) = [8.60395613]
bas 16, expnt(s) = [0.49300991]
CPU time:      1397.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96634925e-01 1.26272343e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547201e+04 6.70656077e+03 7.30347989e+03 1.99600857e+03
 1.83758102e+04 3.98749266e+03 1.44987737e+03 5.93626770e+02
 3.73974759e+02 2.14855632e+02 1.13330154e+02 8.77554572e+01
 3.77645574e+01 3.84882641e+01 8.08966917e+00 1.21188970e+01
 3.20472857e+00 6.05143626e+00 8.60395613e+00 4.29889786e+01
 4.93009910e-01 1.20518565e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325092908799046
cond(S) = 12745.062195724506
E1 = -689.3997693102853  E_coul = 184.91221502827423
init E= -504.487554282011
    CPU time for initialize scf      4.21 sec, wall time      0.34 sec
  HOMO = -0.674707794775552  LUMO = 9.18359029177141
  mo_energy =
[-1.21706863e+02 -1.33874485e+01 -7.62803808e+00 -7.62803808e+00
 -7.62803808e+00 -1.64017851e+00 -6.74707795e-01 -6.74707795e-01
 -6.74707795e-01  9.18359029e+00  1.08655174e+02  6.03399863e+02
  2.74714377e+03  1.23687468e+04  4.20310665e+04  1.10857227e+05
  2.55023638e+05  5.49424607e+05  1.15334598e+06  2.43110314e+06
  5.37581118e+06]
E1 = -707.0699647564081  E_coul = 199.1318596716032
cycle= 1 E= -507.938105084805  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.19 sec, wall time      0.02 sec
diis-norm(errvec)=0.584887
diis-c [-0.34209223  1.        ]
  HOMO = -0.233111346636597  LUMO = 10.0927517469958
  mo_energy =
[-1.20256157e+02 -1.23512263e+01 -6.64599329e+00 -6.64599329e+00
 -6.64599329e+00 -1.16149004e+00 -2.33111347e-01 -2.33111347e-01
 -2.33111347e-01  1.00927517e+01  1.10004330e+02  6.04836409e+02
  2.74851463e+03  1.23700048e+04  4.20322555e+04  1.10858377e+05
  2.55024761e+05  5.49425710e+05  1.15334707e+06  2.43110422e+06
  5.37581225e+06]
E1 = -706.7158810027555  E_coul = 198.77138615704334
cycle= 2 E= -507.944494845712  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.03 sec, wall time      0.02 sec
diis-norm(errvec)=0.0152434
diis-c [-2.24080864e-04  4.89741454e-03  9.95102585e-01]
  HOMO = -0.237571497678306  LUMO = 10.0818291539788
  mo_energy =
[-1.20313974e+02 -1.23736294e+01 -6.67386725e+00 -6.67386725e+00
 -6.67386725e+00 -1.16375707e+00 -2.37571498e-01 -2.37571498e-01
 -2.37571498e-01  1.00818292e+01  1.09960849e+02  6.04775280e+02
  2.74844063e+03  1.23699225e+04  4.20321702e+04  1.10858291e+05
  2.55024674e+05  5.49425622e+05  1.15334698e+06  2.43110413e+06
  5.37581217e+06]
E1 = -706.7012153642344  E_coul = 198.75670842813255
cycle= 3 E= -507.944506936102  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00073998
diis-c [-1.26369727e-08  3.96681134e-05 -5.01134088e-02  1.05007374e+00]
  HOMO = -0.237798313619275  LUMO = 10.0812859260748
  mo_energy =
[-1.20316577e+02 -1.23747410e+01 -6.67522628e+00 -6.67522628e+00
 -6.67522628e+00 -1.16386775e+00 -2.37798314e-01 -2.37798314e-01
 -2.37798314e-01  1.00812859e+01  1.09958824e+02  6.04772602e+02
  2.74843757e+03  1.23699192e+04  4.20321668e+04  1.10858287e+05
  2.55024670e+05  5.49425619e+05  1.15334697e+06  2.43110413e+06
  5.37581216e+06]
E1 = -706.7004771517728  E_coul = 198.75597018539932
cycle= 4 E= -507.944506966374  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45375e-06
diis-c [-4.69144590e-12 -1.83092468e-06  2.30734637e-03 -4.58567685e-02
  1.04355125e+00]
  HOMO = -0.237799076187895  LUMO = 10.0812851364513
  mo_energy =
[-1.20316575e+02 -1.23747435e+01 -6.67522793e+00 -6.67522793e+00
 -6.67522793e+00 -1.16386819e+00 -2.37799076e-01 -2.37799076e-01
 -2.37799076e-01  1.00812851e+01  1.09958824e+02  6.04772605e+02
  2.74843758e+03  1.23699193e+04  4.20321668e+04  1.10858287e+05
  2.55024670e+05  5.49425619e+05  1.15334697e+06  2.43110413e+06
  5.37581216e+06]
E1 = -706.7004760038672  E_coul = 198.75596903749206
cycle= 5 E= -507.944506966375  delta_E= -1.59e-12  |g|= 1.4e-07  |ddm|= 2.19e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7004760038672  E_coul = 198.75596903749206
  HOMO = -0.237799109901424  LUMO = 10.0812850661333
  mo_energy =
[-1.20316575e+02 -1.23747437e+01 -6.67522810e+00 -6.67522810e+00
 -6.67522810e+00 -1.16386820e+00 -2.37799110e-01 -2.37799110e-01
 -2.37799110e-01  1.00812851e+01  1.09958824e+02  6.04772605e+02
  2.74843758e+03  1.23699193e+04  4.20321668e+04  1.10858287e+05
  2.55024670e+05  5.49425619e+05  1.15334697e+06  2.43110413e+06
  5.37581216e+06]
E1 = -706.7004759116522  E_coul = 198.75596894527743
Extra cycle  E= -507.944506966375  delta_E= 3.41e-13  |g|= 7.17e-09  |ddm|= 7.18e-08
    CPU time for scf_cycle      4.49 sec, wall time      0.43 sec
exp = [3.96634925e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104210e+04 3.67547201e+04 7.30347989e+03
 1.83758102e+04 1.44987737e+03 3.73974759e+02 1.13330154e+02
 3.77645574e+01 8.08966917e+00 3.20472857e+00 8.60395613e+00
 4.93009910e-01]
E = -507.9445069663748
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396634925059       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031133        1
[INPUT] 0    0    [1    /1   ]  147020.992148        1
[INPUT] 0    0    [1    /1   ]  73510.4209821        1
[INPUT] 0    0    [1    /1   ]  36754.7200825        1
[INPUT] 0    0    [1    /1   ]  7303.47988684        1
[INPUT] 0    0    [1    /1   ]  18375.8101771        1
[INPUT] 0    0    [1    /1   ]  1449.87736953        1
[INPUT] 0    0    [1    /1   ]  373.974758656        1
[INPUT] 0    0    [1    /1   ]  113.330153976        1
[INPUT] 0    0    [1    /1   ]  37.7645574006        1
[INPUT] 0    0    [1    /1   ]  8.0896691706         1
[INPUT] 0    0    [1    /1   ]  3.20472857192        1
[INPUT] 1    0    [1    /1   ]  8.60395612889        1
[INPUT] 1    0    [1    /1   ]  0.493009909525       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.39663492505885756, 1.0]], [0, [1176168.142618982, 1.0]], [0, [588084.0699925129, 1.0]], [0, [294042.0311329642, 1.0]], [0, [147020.99214843794, 1.0]], [0, [73510.42098213072, 1.0]], [0, [36754.7200825113, 1.0]], [0, [7303.479886837559, 1.0]], [0, [18375.810177127434, 1.0]], [0, [1449.8773695282625, 1.0]], [0, [373.9747586558661, 1.0]], [0, [113.33015397569277, 1.0]], [0, [37.7645574006111, 1.0]], [0, [8.089669170603274, 1.0]], [0, [3.2047285719222987, 1.0]], [1, [8.60395612889121, 1.0]], [1, [0.4930099095245898, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39663493]
bas 1, expnt(s) = [1176168.14261898]
bas 2, expnt(s) = [588084.06999251]
bas 3, expnt(s) = [294042.03113296]
bas 4, expnt(s) = [147020.99214844]
bas 5, expnt(s) = [73510.42098213]
bas 6, expnt(s) = [36754.72008251]
bas 7, expnt(s) = [7303.47988684]
bas 8, expnt(s) = [18375.81017713]
bas 9, expnt(s) = [1449.87736953]
bas 10, expnt(s) = [373.97475866]
bas 11, expnt(s) = [113.33015398]
bas 12, expnt(s) = [37.7645574]
bas 13, expnt(s) = [8.08966917]
bas 14, expnt(s) = [3.20472857]
bas 15, expnt(s) = [8.60395613]
bas 16, expnt(s) = [0.49300991]
CPU time:      1402.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96634925e-01 1.26272343e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547201e+04 6.70656077e+03 7.30347989e+03 1.99600857e+03
 1.83758102e+04 3.98749266e+03 1.44987737e+03 5.93626770e+02
 3.73974759e+02 2.14855632e+02 1.13330154e+02 8.77554572e+01
 3.77645574e+01 3.84882641e+01 8.08966917e+00 1.21188970e+01
 3.20472857e+00 6.05143626e+00 8.60395613e+00 4.29889786e+01
 4.93009910e-01 1.20518565e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325092908799046
cond(S) = 12745.062195724506
E1 = -689.3997693102853  E_coul = 184.91221502827423
init E= -504.487554282011
    CPU time for initialize scf      4.24 sec, wall time      0.34 sec
  HOMO = -0.674707794775552  LUMO = 9.18359029177141
  mo_energy =
[-1.21706863e+02 -1.33874485e+01 -7.62803808e+00 -7.62803808e+00
 -7.62803808e+00 -1.64017851e+00 -6.74707795e-01 -6.74707795e-01
 -6.74707795e-01  9.18359029e+00  1.08655174e+02  6.03399863e+02
  2.74714377e+03  1.23687468e+04  4.20310665e+04  1.10857227e+05
  2.55023638e+05  5.49424607e+05  1.15334598e+06  2.43110314e+06
  5.37581118e+06]
E1 = -707.0699647564081  E_coul = 199.1318596716032
cycle= 1 E= -507.938105084805  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.19 sec, wall time      0.02 sec
diis-norm(errvec)=0.584887
diis-c [-0.34209223  1.        ]
  HOMO = -0.233111346636597  LUMO = 10.0927517469958
  mo_energy =
[-1.20256157e+02 -1.23512263e+01 -6.64599329e+00 -6.64599329e+00
 -6.64599329e+00 -1.16149004e+00 -2.33111347e-01 -2.33111347e-01
 -2.33111347e-01  1.00927517e+01  1.10004330e+02  6.04836409e+02
  2.74851463e+03  1.23700048e+04  4.20322555e+04  1.10858377e+05
  2.55024761e+05  5.49425710e+05  1.15334707e+06  2.43110422e+06
  5.37581225e+06]
E1 = -706.7158810027555  E_coul = 198.77138615704334
cycle= 2 E= -507.944494845712  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152434
diis-c [-2.24080864e-04  4.89741454e-03  9.95102585e-01]
  HOMO = -0.237571497678306  LUMO = 10.0818291539788
  mo_energy =
[-1.20313974e+02 -1.23736294e+01 -6.67386725e+00 -6.67386725e+00
 -6.67386725e+00 -1.16375707e+00 -2.37571498e-01 -2.37571498e-01
 -2.37571498e-01  1.00818292e+01  1.09960849e+02  6.04775280e+02
  2.74844063e+03  1.23699225e+04  4.20321702e+04  1.10858291e+05
  2.55024674e+05  5.49425622e+05  1.15334698e+06  2.43110413e+06
  5.37581217e+06]
E1 = -706.7012153642344  E_coul = 198.75670842813255
cycle= 3 E= -507.944506936102  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00073998
diis-c [-1.26369727e-08  3.96681134e-05 -5.01134088e-02  1.05007374e+00]
  HOMO = -0.237798313619275  LUMO = 10.0812859260748
  mo_energy =
[-1.20316577e+02 -1.23747410e+01 -6.67522628e+00 -6.67522628e+00
 -6.67522628e+00 -1.16386775e+00 -2.37798314e-01 -2.37798314e-01
 -2.37798314e-01  1.00812859e+01  1.09958824e+02  6.04772602e+02
  2.74843757e+03  1.23699192e+04  4.20321668e+04  1.10858287e+05
  2.55024670e+05  5.49425619e+05  1.15334697e+06  2.43110413e+06
  5.37581216e+06]
E1 = -706.7004771517728  E_coul = 198.75597018539932
cycle= 4 E= -507.944506966374  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45375e-06
diis-c [-4.69144590e-12 -1.83092468e-06  2.30734637e-03 -4.58567685e-02
  1.04355125e+00]
  HOMO = -0.237799076187895  LUMO = 10.0812851364513
  mo_energy =
[-1.20316575e+02 -1.23747435e+01 -6.67522793e+00 -6.67522793e+00
 -6.67522793e+00 -1.16386819e+00 -2.37799076e-01 -2.37799076e-01
 -2.37799076e-01  1.00812851e+01  1.09958824e+02  6.04772605e+02
  2.74843758e+03  1.23699193e+04  4.20321668e+04  1.10858287e+05
  2.55024670e+05  5.49425619e+05  1.15334697e+06  2.43110413e+06
  5.37581216e+06]
E1 = -706.7004760038672  E_coul = 198.75596903749206
cycle= 5 E= -507.944506966375  delta_E= -1.59e-12  |g|= 1.4e-07  |ddm|= 2.19e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.7004760038672  E_coul = 198.75596903749206
  HOMO = -0.237799109901424  LUMO = 10.0812850661333
  mo_energy =
[-1.20316575e+02 -1.23747437e+01 -6.67522810e+00 -6.67522810e+00
 -6.67522810e+00 -1.16386820e+00 -2.37799110e-01 -2.37799110e-01
 -2.37799110e-01  1.00812851e+01  1.09958824e+02  6.04772605e+02
  2.74843758e+03  1.23699193e+04  4.20321668e+04  1.10858287e+05
  2.55024670e+05  5.49425619e+05  1.15334697e+06  2.43110413e+06
  5.37581216e+06]
E1 = -706.7004759116522  E_coul = 198.75596894527743
Extra cycle  E= -507.944506966375  delta_E= 3.41e-13  |g|= 7.17e-09  |ddm|= 7.18e-08
    CPU time for scf_cycle      4.51 sec, wall time      0.42 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12745.062195724506
E1 = -706.7004759116522  E_coul = 198.75596894527743
init E= -507.944506966375
    CPU time for initialize scf      9.55 sec, wall time      0.69 sec
  HOMO = -0.23779911149294  LUMO = 10.0812850639968
  mo_energy =
[-1.20316575e+02 -1.23747437e+01 -6.67522811e+00 -6.67522811e+00
 -6.67522811e+00 -1.16386820e+00 -2.37799111e-01 -2.37799111e-01
 -2.37799111e-01  1.00812851e+01  1.09958824e+02  6.04772605e+02
  2.74843758e+03  1.23699193e+04  4.20321668e+04  1.10858287e+05
  2.55024670e+05  5.49425619e+05  1.15334697e+06  2.43110413e+06
  5.37581216e+06]
E1 = -706.7004759075304  E_coul = 198.75596894115546
cycle= 1 E= -507.944506966375  delta_E= -1.71e-13  |g|= 8.77e-10  |ddm|= 3.54e-09
    CPU time for cycle= 1      0.12 sec, wall time      0.01 sec
E1 = -706.7004759075304  E_coul = 198.75596894115546
  HOMO = -0.237799111570335  LUMO = 10.081285065597
  mo_energy =
[-1.20316575e+02 -1.23747437e+01 -6.67522811e+00 -6.67522811e+00
 -6.67522811e+00 -1.16386820e+00 -2.37799112e-01 -2.37799112e-01
 -2.37799112e-01  1.00812851e+01  1.09958824e+02  6.04772605e+02
  2.74843758e+03  1.23699193e+04  4.20321668e+04  1.10858287e+05
  2.55024670e+05  5.49425619e+05  1.15334697e+06  2.43110413e+06
  5.37581216e+06]
E1 = -706.7004759073194  E_coul = 198.7559689409444
Extra cycle  E= -507.944506966375  delta_E= -5.68e-14  |g|= 9.15e-10  |ddm|= 1.89e-10
    CPU time for scf_cycle      9.75 sec, wall time      0.75 sec
exp = [3.96634925e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104210e+04 3.67547201e+04 7.30347989e+03
 1.83758102e+04 1.44987737e+03 3.73974759e+02 1.13330154e+02
 3.77645574e+01 8.08966917e+00 3.20472857e+00 8.60395613e+00
 4.93009910e-01]
grad_E = [ 7.71420704e-05 -5.27780859e-11  1.61966667e-10  4.53280264e-10
  3.38353905e-09  9.24137565e-09  6.89945427e-08  4.11642386e-06
  1.09605854e-07  5.93223400e-07 -4.35403882e-07  2.54130767e-06
 -5.42576705e-06  9.13814216e-07 -5.42634385e-06  6.43003280e-05
  9.67067426e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396631573255       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.992159        1
[INPUT] 0    0    [1    /1   ]  73510.4210174        1
[INPUT] 0    0    [1    /1   ]  36754.7202909        1
[INPUT] 0    0    [1    /1   ]  7303.4913642         1
[INPUT] 0    0    [1    /1   ]  18375.8107259        1
[INPUT] 0    0    [1    /1   ]  1449.78731317        1
[INPUT] 0    0    [1    /1   ]  373.964675687        1
[INPUT] 0    0    [1    /1   ]  113.328695773        1
[INPUT] 0    0    [1    /1   ]  37.7651903437        1
[INPUT] 0    0    [1    /1   ]  8.08970696736        1
[INPUT] 0    0    [1    /1   ]  3.20476161049        1
[INPUT] 1    0    [1    /1   ]  8.60389827442        1
[INPUT] 1    0    [1    /1   ]  0.493006586608       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966315732547864, 1.0]], [0, [1176168.1426189777, 1.0]], [0, [588084.0699930441, 1.0]], [0, [294042.03113479767, 1.0]], [0, [147020.99215884155, 1.0]], [0, [73510.42101742189, 1.0]], [0, [36754.720290907135, 1.0]], [0, [7303.4913642015845, 1.0]], [0, [18375.810725907908, 1.0]], [0, [1449.7873131716578, 1.0]], [0, [373.96467568673256, 1.0]], [0, [113.32869577322367, 1.0]], [0, [37.76519034373311, 1.0]], [0, [8.089706967356364, 1.0]], [0, [3.2047616104921315, 1.0]], [1, [8.603898274416181, 1.0]], [1, [0.49300658660833646, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39663157]
bas 1, expnt(s) = [1176168.14261898]
bas 2, expnt(s) = [588084.06999304]
bas 3, expnt(s) = [294042.0311348]
bas 4, expnt(s) = [147020.99215884]
bas 5, expnt(s) = [73510.42101742]
bas 6, expnt(s) = [36754.72029091]
bas 7, expnt(s) = [7303.4913642]
bas 8, expnt(s) = [18375.81072591]
bas 9, expnt(s) = [1449.78731317]
bas 10, expnt(s) = [373.96467569]
bas 11, expnt(s) = [113.32869577]
bas 12, expnt(s) = [37.76519034]
bas 13, expnt(s) = [8.08970697]
bas 14, expnt(s) = [3.20476161]
bas 15, expnt(s) = [8.60389827]
bas 16, expnt(s) = [0.49300659]
CPU time:      1419.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96631573e-01 1.26271543e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547203e+04 6.70656079e+03 7.30349136e+03 1.99601093e+03
 1.83758107e+04 3.98749275e+03 1.44978731e+03 5.93599116e+02
 3.73964676e+02 2.14851287e+02 1.13328696e+02 8.77546104e+01
 3.77651903e+01 3.84887479e+01 8.08970697e+00 1.21189395e+01
 3.20476161e+00 6.05148305e+00 8.60389827e+00 4.29886173e+01
 4.93006587e-01 1.20517550e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32509784871666
cond(S) = 12744.99604973735
E1 = -689.3993222456821  E_coul = 184.91182817298733
init E= -504.487494072695
    CPU time for initialize scf      4.26 sec, wall time      0.34 sec
  HOMO = -0.67471202688265  LUMO = 9.18370340146118
  mo_energy =
[-1.21706928e+02 -1.33874797e+01 -7.62806441e+00 -7.62806441e+00
 -7.62806441e+00 -1.64018230e+00 -6.74712027e-01 -6.74712027e-01
 -6.74712027e-01  9.18370340e+00  1.08655853e+02  6.03390251e+02
  2.74703060e+03  1.23684591e+04  4.20307384e+04  1.10856905e+05
  2.55023327e+05  5.49424305e+05  1.15334568e+06  2.43110286e+06
  5.37581091e+06]
E1 = -707.0694624360578  E_coul = 199.1313572233024
cycle= 1 E= -507.938105212755  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.584888
diis-c [-0.3420943  1.       ]
  HOMO = -0.233120527453954  LUMO = 10.0928624770059
  mo_energy =
[-1.20256230e+02 -1.23512653e+01 -6.64602782e+00 -6.64602782e+00
 -6.64602782e+00 -1.16149814e+00 -2.33120527e-01 -2.33120527e-01
 -2.33120527e-01  1.00928625e+01  1.10005001e+02  6.04826790e+02
  2.74840146e+03  1.23697171e+04  4.20319275e+04  1.10858055e+05
  2.55024450e+05  5.49425408e+05  1.15334677e+06  2.43110393e+06
  5.37581198e+06]
E1 = -706.7153843570921  E_coul = 198.77088950352797
cycle= 2 E= -507.944494853564  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.04 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152432
diis-c [-2.24075742e-04  4.89739751e-03  9.95102602e-01]
  HOMO = -0.237580552411346  LUMO = 10.0819399517797
  mo_energy =
[-1.20314046e+02 -1.23736680e+01 -6.67390133e+00 -6.67390133e+00
 -6.67390133e+00 -1.16376512e+00 -2.37580552e-01 -2.37580552e-01
 -2.37580552e-01  1.00819400e+01  1.09961521e+02  6.04765662e+02
  2.74832747e+03  1.23696348e+04  4.20318421e+04  1.10857969e+05
  2.55024362e+05  5.49425320e+05  1.15334668e+06  2.43110385e+06
  5.37581189e+06]
E1 = -706.7007190749432  E_coul = 198.75621213142054
cycle= 3 E= -507.944506943523  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739969
diis-c [-1.26358766e-08  3.96649221e-05 -5.01132841e-02  1.05007362e+00]
  HOMO = -0.237807360071154  LUMO = 10.0813967319732
  mo_energy =
[-1.20316649e+02 -1.23747795e+01 -6.67526033e+00 -6.67526033e+00
 -6.67526033e+00 -1.16387579e+00 -2.37807360e-01 -2.37807360e-01
 -2.37807360e-01  1.00813967e+01  1.09959495e+02  6.04762984e+02
  2.74832441e+03  1.23696315e+04  4.20318388e+04  1.10857965e+05
  2.55024359e+05  5.49425317e+05  1.15334668e+06  2.43110384e+06
  5.37581189e+06]
E1 = -706.6999808865615  E_coul = 198.75547391276862
cycle= 4 E= -507.944506973793  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45429e-06
diis-c [-4.68544281e-12 -1.83700760e-06  2.30781578e-03 -4.58650923e-02
  1.04355911e+00]
  HOMO = -0.237808122548486  LUMO = 10.0813959420459
  mo_energy =
[-1.20316647e+02 -1.23747821e+01 -6.67526198e+00 -6.67526198e+00
 -6.67526198e+00 -1.16387623e+00 -2.37808123e-01 -2.37808123e-01
 -2.37808123e-01  1.00813959e+01  1.09959496e+02  6.04762987e+02
  2.74832442e+03  1.23696316e+04  4.20318388e+04  1.10857965e+05
  2.55024359e+05  5.49425317e+05  1.15334668e+06  2.43110384e+06
  5.37581189e+06]
E1 = -706.6999797390248  E_coul = 198.75547276523102
cycle= 5 E= -507.944506973794  delta_E= -7.96e-13  |g|= 1.4e-07  |ddm|= 2.19e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6999797390248  E_coul = 198.75547276523102
  HOMO = -0.237808156242383  LUMO = 10.08139587293
  mo_energy =
[-1.20316648e+02 -1.23747822e+01 -6.67526215e+00 -6.67526215e+00
 -6.67526215e+00 -1.16387624e+00 -2.37808156e-01 -2.37808156e-01
 -2.37808156e-01  1.00813959e+01  1.09959496e+02  6.04762987e+02
  2.74832442e+03  1.23696316e+04  4.20318388e+04  1.10857965e+05
  2.55024359e+05  5.49425317e+05  1.15334668e+06  2.43110384e+06
  5.37581189e+06]
E1 = -706.6999796468789  E_coul = 198.75547267308423
Extra cycle  E= -507.944506973795  delta_E= -9.09e-13  |g|= 7.18e-09  |ddm|= 7.18e-08
    CPU time for scf_cycle      4.48 sec, wall time      0.41 sec
exp = [3.96631573e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104210e+04 3.67547203e+04 7.30349136e+03
 1.83758107e+04 1.44978731e+03 3.73964676e+02 1.13328696e+02
 3.77651903e+01 8.08970697e+00 3.20476161e+00 8.60389827e+00
 4.93006587e-01]
E = -507.94450697379466
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396631573255       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.992159        1
[INPUT] 0    0    [1    /1   ]  73510.4210174        1
[INPUT] 0    0    [1    /1   ]  36754.7202909        1
[INPUT] 0    0    [1    /1   ]  7303.4913642         1
[INPUT] 0    0    [1    /1   ]  18375.8107259        1
[INPUT] 0    0    [1    /1   ]  1449.78731317        1
[INPUT] 0    0    [1    /1   ]  373.964675687        1
[INPUT] 0    0    [1    /1   ]  113.328695773        1
[INPUT] 0    0    [1    /1   ]  37.7651903437        1
[INPUT] 0    0    [1    /1   ]  8.08970696736        1
[INPUT] 0    0    [1    /1   ]  3.20476161049        1
[INPUT] 1    0    [1    /1   ]  8.60389827442        1
[INPUT] 1    0    [1    /1   ]  0.493006586608       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966315732547864, 1.0]], [0, [1176168.1426189777, 1.0]], [0, [588084.0699930441, 1.0]], [0, [294042.03113479767, 1.0]], [0, [147020.99215884155, 1.0]], [0, [73510.42101742189, 1.0]], [0, [36754.720290907135, 1.0]], [0, [7303.4913642015845, 1.0]], [0, [18375.810725907908, 1.0]], [0, [1449.7873131716578, 1.0]], [0, [373.96467568673256, 1.0]], [0, [113.32869577322367, 1.0]], [0, [37.76519034373311, 1.0]], [0, [8.089706967356364, 1.0]], [0, [3.2047616104921315, 1.0]], [1, [8.603898274416181, 1.0]], [1, [0.49300658660833646, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39663157]
bas 1, expnt(s) = [1176168.14261898]
bas 2, expnt(s) = [588084.06999304]
bas 3, expnt(s) = [294042.0311348]
bas 4, expnt(s) = [147020.99215884]
bas 5, expnt(s) = [73510.42101742]
bas 6, expnt(s) = [36754.72029091]
bas 7, expnt(s) = [7303.4913642]
bas 8, expnt(s) = [18375.81072591]
bas 9, expnt(s) = [1449.78731317]
bas 10, expnt(s) = [373.96467569]
bas 11, expnt(s) = [113.32869577]
bas 12, expnt(s) = [37.76519034]
bas 13, expnt(s) = [8.08970697]
bas 14, expnt(s) = [3.20476161]
bas 15, expnt(s) = [8.60389827]
bas 16, expnt(s) = [0.49300659]
CPU time:      1423.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96631573e-01 1.26271543e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547203e+04 6.70656079e+03 7.30349136e+03 1.99601093e+03
 1.83758107e+04 3.98749275e+03 1.44978731e+03 5.93599116e+02
 3.73964676e+02 2.14851287e+02 1.13328696e+02 8.77546104e+01
 3.77651903e+01 3.84887479e+01 8.08970697e+00 1.21189395e+01
 3.20476161e+00 6.05148305e+00 8.60389827e+00 4.29886173e+01
 4.93006587e-01 1.20517550e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.32509784871666
cond(S) = 12744.99604973735
E1 = -689.3993222456821  E_coul = 184.91182817298733
init E= -504.487494072695
    CPU time for initialize scf      4.31 sec, wall time      0.32 sec
  HOMO = -0.67471202688265  LUMO = 9.18370340146118
  mo_energy =
[-1.21706928e+02 -1.33874797e+01 -7.62806441e+00 -7.62806441e+00
 -7.62806441e+00 -1.64018230e+00 -6.74712027e-01 -6.74712027e-01
 -6.74712027e-01  9.18370340e+00  1.08655853e+02  6.03390251e+02
  2.74703060e+03  1.23684591e+04  4.20307384e+04  1.10856905e+05
  2.55023327e+05  5.49424305e+05  1.15334568e+06  2.43110286e+06
  5.37581091e+06]
E1 = -707.0694624360578  E_coul = 199.1313572233024
cycle= 1 E= -507.938105212755  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.14 sec, wall time      0.01 sec
diis-norm(errvec)=0.584888
diis-c [-0.3420943  1.       ]
  HOMO = -0.233120527453954  LUMO = 10.0928624770059
  mo_energy =
[-1.20256230e+02 -1.23512653e+01 -6.64602782e+00 -6.64602782e+00
 -6.64602782e+00 -1.16149814e+00 -2.33120527e-01 -2.33120527e-01
 -2.33120527e-01  1.00928625e+01  1.10005001e+02  6.04826790e+02
  2.74840146e+03  1.23697171e+04  4.20319275e+04  1.10858055e+05
  2.55024450e+05  5.49425408e+05  1.15334677e+06  2.43110393e+06
  5.37581198e+06]
E1 = -706.7153843570921  E_coul = 198.77088950352797
cycle= 2 E= -507.944494853564  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.07 sec, wall time      0.01 sec
diis-norm(errvec)=0.0152432
diis-c [-2.24075742e-04  4.89739751e-03  9.95102602e-01]
  HOMO = -0.237580552411346  LUMO = 10.0819399517797
  mo_energy =
[-1.20314046e+02 -1.23736680e+01 -6.67390133e+00 -6.67390133e+00
 -6.67390133e+00 -1.16376512e+00 -2.37580552e-01 -2.37580552e-01
 -2.37580552e-01  1.00819400e+01  1.09961521e+02  6.04765662e+02
  2.74832747e+03  1.23696348e+04  4.20318421e+04  1.10857969e+05
  2.55024362e+05  5.49425320e+05  1.15334668e+06  2.43110385e+06
  5.37581189e+06]
E1 = -706.7007190749432  E_coul = 198.75621213142054
cycle= 3 E= -507.944506943523  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.02 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739969
diis-c [-1.26358766e-08  3.96649221e-05 -5.01132841e-02  1.05007362e+00]
  HOMO = -0.237807360071154  LUMO = 10.0813967319732
  mo_energy =
[-1.20316649e+02 -1.23747795e+01 -6.67526033e+00 -6.67526033e+00
 -6.67526033e+00 -1.16387579e+00 -2.37807360e-01 -2.37807360e-01
 -2.37807360e-01  1.00813967e+01  1.09959495e+02  6.04762984e+02
  2.74832441e+03  1.23696315e+04  4.20318388e+04  1.10857965e+05
  2.55024359e+05  5.49425317e+05  1.15334668e+06  2.43110384e+06
  5.37581189e+06]
E1 = -706.6999808865615  E_coul = 198.75547391276862
cycle= 4 E= -507.944506973793  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45429e-06
diis-c [-4.68544281e-12 -1.83700760e-06  2.30781578e-03 -4.58650923e-02
  1.04355911e+00]
  HOMO = -0.237808122548486  LUMO = 10.0813959420459
  mo_energy =
[-1.20316647e+02 -1.23747821e+01 -6.67526198e+00 -6.67526198e+00
 -6.67526198e+00 -1.16387623e+00 -2.37808123e-01 -2.37808123e-01
 -2.37808123e-01  1.00813959e+01  1.09959496e+02  6.04762987e+02
  2.74832442e+03  1.23696316e+04  4.20318388e+04  1.10857965e+05
  2.55024359e+05  5.49425317e+05  1.15334668e+06  2.43110384e+06
  5.37581189e+06]
E1 = -706.6999797390248  E_coul = 198.75547276523102
cycle= 5 E= -507.944506973794  delta_E= -7.96e-13  |g|= 1.4e-07  |ddm|= 2.19e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.6999797390248  E_coul = 198.75547276523102
  HOMO = -0.237808156242383  LUMO = 10.08139587293
  mo_energy =
[-1.20316648e+02 -1.23747822e+01 -6.67526215e+00 -6.67526215e+00
 -6.67526215e+00 -1.16387624e+00 -2.37808156e-01 -2.37808156e-01
 -2.37808156e-01  1.00813959e+01  1.09959496e+02  6.04762987e+02
  2.74832442e+03  1.23696316e+04  4.20318388e+04  1.10857965e+05
  2.55024359e+05  5.49425317e+05  1.15334668e+06  2.43110384e+06
  5.37581189e+06]
E1 = -706.6999796468789  E_coul = 198.75547267308423
Extra cycle  E= -507.944506973795  delta_E= -9.09e-13  |g|= 7.18e-09  |ddm|= 7.18e-08
    CPU time for scf_cycle      4.58 sec, wall time      0.39 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 12744.99604973735
E1 = -706.6999796468789  E_coul = 198.75547267308423
init E= -507.944506973795
    CPU time for initialize scf      9.35 sec, wall time      0.67 sec
  HOMO = -0.237808157832584  LUMO = 10.0813958705962
  mo_energy =
[-1.20316648e+02 -1.23747822e+01 -6.67526216e+00 -6.67526216e+00
 -6.67526216e+00 -1.16387624e+00 -2.37808158e-01 -2.37808158e-01
 -2.37808158e-01  1.00813959e+01  1.09959496e+02  6.04762987e+02
  2.74832442e+03  1.23696316e+04  4.20318388e+04  1.10857965e+05
  2.55024359e+05  5.49425317e+05  1.15334668e+06  2.43110384e+06
  5.37581189e+06]
E1 = -706.699979642744  E_coul = 198.75547266895003
cycle= 1 E= -507.944506973794  delta_E= 6.82e-13  |g|= 1.16e-09  |ddm|= 3.55e-09
    CPU time for cycle= 1      0.09 sec, wall time      0.01 sec
E1 = -706.699979642744  E_coul = 198.75547266895003
  HOMO = -0.237808157910261  LUMO = 10.0813958713657
  mo_energy =
[-1.20316648e+02 -1.23747822e+01 -6.67526216e+00 -6.67526216e+00
 -6.67526216e+00 -1.16387624e+00 -2.37808158e-01 -2.37808158e-01
 -2.37808158e-01  1.00813959e+01  1.09959496e+02  6.04762987e+02
  2.74832442e+03  1.23696316e+04  4.20318388e+04  1.10857965e+05
  2.55024359e+05  5.49425317e+05  1.15334668e+06  2.43110384e+06
  5.37581189e+06]
E1 = -706.6999796424838  E_coul = 198.75547266868986
Extra cycle  E= -507.944506973794  delta_E= 1.14e-13  |g|= 1.18e-09  |ddm|= 2e-10
    CPU time for scf_cycle      9.51 sec, wall time      0.75 sec
exp = [3.96631573e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104210e+04 3.67547203e+04 7.30349136e+03
 1.83758107e+04 1.44978731e+03 3.73964676e+02 1.13328696e+02
 3.77651903e+01 8.08970697e+00 3.20476161e+00 8.60389827e+00
 4.93006587e-01]
grad_E = [ 2.13025122e-05 -5.27637148e-11  1.62105367e-10  4.53771042e-10
  3.38618012e-09  9.25059978e-09  6.90475960e-08  4.11964262e-06
  1.09749947e-07  5.15873457e-07  4.82178422e-08  3.09969530e-07
 -1.57881381e-08  9.84431516e-07 -7.75665122e-06  1.94004376e-05
  2.38601659e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396629852181       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210215        1
[INPUT] 0    0    [1    /1   ]  36754.7203149        1
[INPUT] 0    0    [1    /1   ]  7303.49268418        1
[INPUT] 0    0    [1    /1   ]  18375.8107889        1
[INPUT] 0    0    [1    /1   ]  1449.77759225        1
[INPUT] 0    0    [1    /1   ]  373.960610012        1
[INPUT] 0    0    [1    /1   ]  113.326661489        1
[INPUT] 0    0    [1    /1   ]  37.7646602819        1
[INPUT] 0    0    [1    /1   ]  8.0899613623         1
[INPUT] 0    0    [1    /1   ]  3.20486789277        1
[INPUT] 1    0    [1    /1   ]  8.6038733922         1
[INPUT] 1    0    [1    /1   ]  0.493005278333       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966298521809672, 1.0]], [0, [1176168.1426189772, 1.0]], [0, [588084.0699931053, 1.0]], [0, [294042.03113500844, 1.0]], [0, [147020.99216003876, 1.0]], [0, [73510.4210214793, 1.0]], [0, [36754.72031488961, 1.0]], [0, [7303.492684179647, 1.0]], [0, [18375.810788940234, 1.0]], [0, [1449.7775922494905, 1.0]], [0, [373.9606100121569, 1.0]], [0, [113.32666148932557, 1.0]], [0, [37.764660281877305, 1.0]], [0, [8.089961362299052, 1.0]], [0, [3.2048678927685397, 1.0]], [1, [8.603873392201061, 1.0]], [1, [0.4930052783328494, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39662985]
bas 1, expnt(s) = [1176168.14261898]
bas 2, expnt(s) = [588084.06999311]
bas 3, expnt(s) = [294042.03113501]
bas 4, expnt(s) = [147020.99216004]
bas 5, expnt(s) = [73510.42102148]
bas 6, expnt(s) = [36754.72031489]
bas 7, expnt(s) = [7303.49268418]
bas 8, expnt(s) = [18375.81078894]
bas 9, expnt(s) = [1449.77759225]
bas 10, expnt(s) = [373.96061001]
bas 11, expnt(s) = [113.32666149]
bas 12, expnt(s) = [37.76466028]
bas 13, expnt(s) = [8.08996136]
bas 14, expnt(s) = [3.20486789]
bas 15, expnt(s) = [8.60387339]
bas 16, expnt(s) = [0.49300528]
CPU time:      1441.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96629852e-01 1.26271132e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547203e+04 6.70656080e+03 7.30349268e+03 1.99601120e+03
 1.83758108e+04 3.98749276e+03 1.44977759e+03 5.93596131e+02
 3.73960610e+02 2.14849535e+02 1.13326661e+02 8.77534290e+01
 3.77646603e+01 3.84883427e+01 8.08996136e+00 1.21192253e+01
 3.20486789e+00 6.05163357e+00 8.60387339e+00 4.29884619e+01
 4.93005278e-01 1.20517150e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325099793742854
cond(S) = 12744.984997607982
E1 = -689.3991452539904  E_coul = 184.9116612463669
init E= -504.487484007623
    CPU time for initialize scf      4.61 sec, wall time      0.33 sec
  HOMO = -0.674713735377971  LUMO = 9.18421024270119
  mo_energy =
[-1.21706957e+02 -1.33874922e+01 -7.62807590e+00 -7.62807590e+00
 -7.62807590e+00 -1.64018437e+00 -6.74713735e-01 -6.74713735e-01
 -6.74713735e-01  9.18421024e+00  1.08655431e+02  6.03381459e+02
  2.74700228e+03  1.23684102e+04  4.20306859e+04  1.10856854e+05
  2.55023277e+05  5.49424257e+05  1.15334564e+06  2.43110281e+06
  5.37581086e+06]
E1 = -707.0692542155382  E_coul = 199.13114862058416
cycle= 1 E= -507.938105594954  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.584888
diis-c [-0.34209355  1.        ]
  HOMO = -0.233124155550346  LUMO = 10.093379792883
  mo_energy =
[-1.20256262e+02 -1.23512804e+01 -6.64604199e+00 -6.64604199e+00
 -6.64604199e+00 -1.16150187e+00 -2.33124156e-01 -2.33124156e-01
 -2.33124156e-01  1.00933798e+01  1.10004574e+02  6.04817994e+02
  2.74837314e+03  1.23696682e+04  4.20318750e+04  1.10858004e+05
  2.55024400e+05  5.49425360e+05  1.15334673e+06  2.43110389e+06
  5.37581193e+06]
E1 = -706.7151943784935  E_coul = 198.77069952284265
cycle= 2 E= -507.944494855651  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.05 sec, wall time      0.01 sec
diis-norm(errvec)=0.015243
diis-c [-2.24069963e-04  4.89718769e-03  9.95102812e-01]
  HOMO = -0.237583846958417  LUMO = 10.0824575823556
  mo_energy =
[-1.20314076e+02 -1.23736818e+01 -6.67391400e+00 -6.67391400e+00
 -6.67391400e+00 -1.16376866e+00 -2.37583847e-01 -2.37583847e-01
 -2.37583847e-01  1.00824576e+01  1.09961096e+02  6.04756868e+02
  2.74829914e+03  1.23695859e+04  4.20317896e+04  1.10857918e+05
  2.55024313e+05  5.49425272e+05  1.15334664e+06  2.43110380e+06
  5.37581185e+06]
E1 = -706.700530237288  E_coul = 198.75602329310072
cycle= 3 E= -507.944506944187  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739948
diis-c [-1.26321222e-08  3.96646892e-05 -5.01126675e-02  1.05007300e+00]
  HOMO = -0.23781063027097  LUMO = 10.0819143948146
  mo_energy =
[-1.20316679e+02 -1.23747933e+01 -6.67527289e+00 -6.67527289e+00
 -6.67527289e+00 -1.16387932e+00 -2.37810630e-01 -2.37810630e-01
 -2.37810630e-01  1.00819144e+01  1.09959070e+02  6.04754191e+02
  2.74829609e+03  1.23695826e+04  4.20317863e+04  1.10857914e+05
  2.55024309e+05  5.49425269e+05  1.15334663e+06  2.43110380e+06
  5.37581184e+06]
E1 = -706.6997921291525  E_coul = 198.75528515470094
cycle= 4 E= -507.944506974452  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45297e-06
diis-c [-4.68752929e-12 -1.83371462e-06  2.30736537e-03 -4.58565552e-02
  1.04355102e+00]
  HOMO = -0.237811392404414  LUMO = 10.0819136055137
  mo_energy =
[-1.20316677e+02 -1.23747958e+01 -6.67527454e+00 -6.67527454e+00
 -6.67527454e+00 -1.16387976e+00 -2.37811392e-01 -2.37811392e-01
 -2.37811392e-01  1.00819136e+01  1.09959071e+02  6.04754194e+02
  2.74829609e+03  1.23695827e+04  4.20317863e+04  1.10857914e+05
  2.55024309e+05  5.49425269e+05  1.15334663e+06  2.43110380e+06
  5.37581184e+06]
E1 = -706.699790982493  E_coul = 198.7552840080405
cycle= 5 E= -507.944506974453  delta_E= -1.02e-12  |g|= 1.4e-07  |ddm|= 2.19e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.699790982493  E_coul = 198.7552840080405
  HOMO = -0.237811426106471  LUMO = 10.0819135362294
  mo_energy =
[-1.20316677e+02 -1.23747960e+01 -6.67527471e+00 -6.67527471e+00
 -6.67527471e+00 -1.16387978e+00 -2.37811426e-01 -2.37811426e-01
 -2.37811426e-01  1.00819135e+01  1.09959070e+02  6.04754193e+02
  2.74829609e+03  1.23695827e+04  4.20317863e+04  1.10857914e+05
  2.55024309e+05  5.49425269e+05  1.15334663e+06  2.43110380e+06
  5.37581184e+06]
E1 = -706.6997908902724  E_coul = 198.75528391581972
Extra cycle  E= -507.944506974453  delta_E= -1.14e-13  |g|= 7.18e-09  |ddm|= 7.18e-08
    CPU time for scf_cycle      4.87 sec, wall time      0.40 sec
exp = [3.96629852e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104210e+04 3.67547203e+04 7.30349268e+03
 1.83758108e+04 1.44977759e+03 3.73960610e+02 1.13326661e+02
 3.77646603e+01 8.08996136e+00 3.20486789e+00 8.60387339e+00
 4.93005278e-01]
E = -507.9445069744527
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -507.9445069744527
       x: [ 3.966e-01  1.176e+06 ...  8.604e+00  4.930e-01]
     nit: 76
     jac: [ 2.130e-05 -5.276e-11 ...  1.940e-05  2.386e-05]
    nfev: 82
    njev: 76
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((17, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([1.1761681426064924e+06,5.8808407130324619e+05,2.9404203565162310e+05,1.4702101782581155e+05,7.3510507976032939e+04,3.6755234472949749e+04,7.3318021734695621e+03,1.8377161218510078e+04,1.2389777727143498e+03,2.9819001594010280e+02,8.8430468748019706e+01,3.0676681173089506e+01,4.6834518331880934e+00,3.9101606979807535e-01,8.5988787479386612e+00,4.9105109461223539e-01])
exps[1:, 0] = exps_old[:]
exps[0, 0] = np.max(exps_old) * 0.0000001

basis = "15s2p"

minimize_energy(basis, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc11344.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 16
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 01:30:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35632568.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 16000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 16000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 16000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.396629852181       1
[INPUT] 0    0    [1    /1   ]  1176168.14262        1
[INPUT] 0    0    [1    /1   ]  588084.069993        1
[INPUT] 0    0    [1    /1   ]  294042.031135        1
[INPUT] 0    0    [1    /1   ]  147020.99216         1
[INPUT] 0    0    [1    /1   ]  73510.4210215        1
[INPUT] 0    0    [1    /1   ]  36754.7203149        1
[INPUT] 0    0    [1    /1   ]  7303.49268418        1
[INPUT] 0    0    [1    /1   ]  18375.8107889        1
[INPUT] 0    0    [1    /1   ]  1449.77759225        1
[INPUT] 0    0    [1    /1   ]  373.960610012        1
[INPUT] 0    0    [1    /1   ]  113.326661489        1
[INPUT] 0    0    [1    /1   ]  37.7646602819        1
[INPUT] 0    0    [1    /1   ]  8.0899613623         1
[INPUT] 0    0    [1    /1   ]  3.20486789277        1
[INPUT] 1    0    [1    /1   ]  8.6038733922         1
[INPUT] 1    0    [1    /1   ]  0.493005278333       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 21
number of NR cGTOs = 21
basis = {'Ar': [[0, [0.3966298521809672, 1.0]], [0, [1176168.1426189772, 1.0]], [0, [588084.0699931053, 1.0]], [0, [294042.03113500844, 1.0]], [0, [147020.99216003876, 1.0]], [0, [73510.4210214793, 1.0]], [0, [36754.72031488961, 1.0]], [0, [7303.492684179647, 1.0]], [0, [18375.810788940234, 1.0]], [0, [1449.7775922494905, 1.0]], [0, [373.9606100121569, 1.0]], [0, [113.32666148932557, 1.0]], [0, [37.764660281877305, 1.0]], [0, [8.089961362299052, 1.0]], [0, [3.2048678927685397, 1.0]], [1, [8.603873392201061, 1.0]], [1, [0.4930052783328494, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.39662985]
bas 1, expnt(s) = [1176168.14261898]
bas 2, expnt(s) = [588084.06999311]
bas 3, expnt(s) = [294042.03113501]
bas 4, expnt(s) = [147020.99216004]
bas 5, expnt(s) = [73510.42102148]
bas 6, expnt(s) = [36754.72031489]
bas 7, expnt(s) = [7303.49268418]
bas 8, expnt(s) = [18375.81078894]
bas 9, expnt(s) = [1449.77759225]
bas 10, expnt(s) = [373.96061001]
bas 11, expnt(s) = [113.32666149]
bas 12, expnt(s) = [37.76466028]
bas 13, expnt(s) = [8.08996136]
bas 14, expnt(s) = [3.20486789]
bas 15, expnt(s) = [8.60387339]
bas 16, expnt(s) = [0.49300528]
CPU time:      1446.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.96629852e-01 1.26271132e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020992e+05 1.89692227e+04 7.35104210e+04 1.12791587e+04
 3.67547203e+04 6.70656080e+03 7.30349268e+03 1.99601120e+03
 1.83758108e+04 3.98749276e+03 1.44977759e+03 5.93596131e+02
 3.73960610e+02 2.14849535e+02 1.13326661e+02 8.77534290e+01
 3.77646603e+01 3.84883427e+01 8.08996136e+00 1.21192253e+01
 3.20486789e+00 6.05163357e+00 8.60387339e+00 4.29884619e+01
 4.93005278e-01 1.20517150e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.325099793742854
cond(S) = 12744.984997607982
E1 = -689.3991452539904  E_coul = 184.9116612463669
init E= -504.487484007623
    CPU time for initialize scf      4.81 sec, wall time      0.34 sec
  HOMO = -0.674713735377971  LUMO = 9.18421024270119
  mo_energy =
[-1.21706957e+02 -1.33874922e+01 -7.62807590e+00 -7.62807590e+00
 -7.62807590e+00 -1.64018437e+00 -6.74713735e-01 -6.74713735e-01
 -6.74713735e-01  9.18421024e+00  1.08655431e+02  6.03381459e+02
  2.74700228e+03  1.23684102e+04  4.20306859e+04  1.10856854e+05
  2.55023277e+05  5.49424257e+05  1.15334564e+06  2.43110281e+06
  5.37581086e+06]
E1 = -707.0692542155382  E_coul = 199.13114862058416
cycle= 1 E= -507.938105594954  delta_E= -3.45  |g|= 0.442  |ddm|= 0.349
    CPU time for cycle= 1      0.15 sec, wall time      0.01 sec
diis-norm(errvec)=0.584888
diis-c [-0.34209355  1.        ]
  HOMO = -0.233124155550346  LUMO = 10.093379792883
  mo_energy =
[-1.20256262e+02 -1.23512804e+01 -6.64604199e+00 -6.64604199e+00
 -6.64604199e+00 -1.16150187e+00 -2.33124156e-01 -2.33124156e-01
 -2.33124156e-01  1.00933798e+01  1.10004574e+02  6.04817994e+02
  2.74837314e+03  1.23696682e+04  4.20318750e+04  1.10858004e+05
  2.55024400e+05  5.49425360e+05  1.15334673e+06  2.43110389e+06
  5.37581193e+06]
E1 = -706.7151943784935  E_coul = 198.77069952284265
cycle= 2 E= -507.944494855651  delta_E= -0.00639  |g|= 0.0181  |ddm|= 0.195
    CPU time for cycle= 2      0.03 sec, wall time      0.01 sec
diis-norm(errvec)=0.015243
diis-c [-2.24069963e-04  4.89718769e-03  9.95102812e-01]
  HOMO = -0.237583846958417  LUMO = 10.0824575823556
  mo_energy =
[-1.20314076e+02 -1.23736818e+01 -6.67391400e+00 -6.67391400e+00
 -6.67391400e+00 -1.16376866e+00 -2.37583847e-01 -2.37583847e-01
 -2.37583847e-01  1.00824576e+01  1.09961096e+02  6.04756868e+02
  2.74829914e+03  1.23695859e+04  4.20317896e+04  1.10857918e+05
  2.55024313e+05  5.49425272e+05  1.15334664e+06  2.43110380e+06
  5.37581185e+06]
E1 = -706.700530237288  E_coul = 198.75602329310072
cycle= 3 E= -507.944506944187  delta_E= -1.21e-05  |g|= 0.000878  |ddm|= 0.00873
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000739948
diis-c [-1.26321222e-08  3.96646892e-05 -5.01126675e-02  1.05007300e+00]
  HOMO = -0.23781063027097  LUMO = 10.0819143948146
  mo_energy =
[-1.20316679e+02 -1.23747933e+01 -6.67527289e+00 -6.67527289e+00
 -6.67527289e+00 -1.16387932e+00 -2.37810630e-01 -2.37810630e-01
 -2.37810630e-01  1.00819144e+01  1.09959070e+02  6.04754191e+02
  2.74829609e+03  1.23695826e+04  4.20317863e+04  1.10857914e+05
  2.55024309e+05  5.49425269e+05  1.15334663e+06  2.43110380e+06
  5.37581184e+06]
E1 = -706.6997921291525  E_coul = 198.75528515470094
cycle= 4 E= -507.944506974452  delta_E= -3.03e-08  |g|= 6.28e-06  |ddm|= 0.000463
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.45297e-06
diis-c [-4.68752929e-12 -1.83371462e-06  2.30736537e-03 -4.58565552e-02
  1.04355102e+00]
  HOMO = -0.237811392404414  LUMO = 10.0819136055137
  mo_energy =
[-1.20316677e+02 -1.23747958e+01 -6.67527454e+00 -6.67527454e+00
 -6.67527454e+00 -1.16387976e+00 -2.37811392e-01 -2.37811392e-01
 -2.37811392e-01  1.00819136e+01  1.09959071e+02  6.04754194e+02
  2.74829609e+03  1.23695827e+04  4.20317863e+04  1.10857914e+05
  2.55024309e+05  5.49425269e+05  1.15334663e+06  2.43110380e+06
  5.37581184e+06]
E1 = -706.699790982493  E_coul = 198.7552840080405
cycle= 5 E= -507.944506974453  delta_E= -1.02e-12  |g|= 1.4e-07  |ddm|= 2.19e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -706.699790982493  E_coul = 198.7552840080405
  HOMO = -0.237811426106471  LUMO = 10.0819135362294
  mo_energy =
[-1.20316677e+02 -1.23747960e+01 -6.67527471e+00 -6.67527471e+00
 -6.67527471e+00 -1.16387978e+00 -2.37811426e-01 -2.37811426e-01
 -2.37811426e-01  1.00819135e+01  1.09959070e+02  6.04754193e+02
  2.74829609e+03  1.23695827e+04  4.20317863e+04  1.10857914e+05
  2.55024309e+05  5.49425269e+05  1.15334663e+06  2.43110380e+06
  5.37581184e+06]
E1 = -706.6997908902724  E_coul = 198.75528391581972
Extra cycle  E= -507.944506974453  delta_E= -1.14e-13  |g|= 7.18e-09  |ddm|= 7.18e-08
    CPU time for scf_cycle      5.04 sec, wall time      0.41 sec
exp = [3.96629852e-01 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020992e+05 7.35104210e+04 3.67547203e+04 7.30349268e+03
 1.83758108e+04 1.44977759e+03 3.73960610e+02 1.13326661e+02
 3.77646603e+01 8.08996136e+00 3.20486789e+00 8.60387339e+00
 4.93005278e-01]
E = -507.9445069744527
E = -507.9445069744527
exp = [3.9662985218096719e-01,1.1761681426189772e+06,5.8808406999310525e+05,2.9404203113500844e+05,1.4702099216003876e+05,7.3510421021479298e+04,3.6754720314889608e+04,7.3034926841796469e+03,1.8375810788940234e+04,1.4497775922494905e+03,3.7396061001215691e+02,1.1332666148932557e+02,3.7764660281877305e+01,8.0899613622990518e+00,3.2048678927685397e+00,8.6038733922010611e+00,4.9300527833284941e-01]
