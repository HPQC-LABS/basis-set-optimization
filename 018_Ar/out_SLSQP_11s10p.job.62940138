created virtual environment CPython3.10.2.final.0-64 in 1392ms
  creator CPython3Posix(dest=/localscratch/nike.62940138.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==23.0.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages (23.0.1)
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/pyscf_properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada

real	0m52.851s
user	0m46.524s
sys	0m1.924s
/project/6004934/nike/basis-set-optimization/018_Ar/./input.py:89: OptimizeWarning: Unknown solver options: maxfev
  res = optimize.minimize(
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:08:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558552        1
[INPUT] 0    0    [1    /1   ]  7617.52191563        1
[INPUT] 0    0    [1    /1   ]  3617.35086742        1
[INPUT] 0    0    [1    /1   ]  1597.82569303        1
[INPUT] 0    0    [1    /1   ]  382.851149473        1
[INPUT] 0    0    [1    /1   ]  108.121083403        1
[INPUT] 0    0    [1    /1   ]  34.8054690698        1
[INPUT] 0    0    [1    /1   ]  7.58522390534        1
[INPUT] 0    0    [1    /1   ]  2.58522390534        1
[INPUT] 0    0    [1    /1   ]  0.395313490558       1
[INPUT] 0    0    [1    /1   ]  0.0995313490558      1
[INPUT] 1    0    [1    /1   ]  1362.78320627        1
[INPUT] 1    0    [1    /1   ]  664.745680987        1
[INPUT] 1    0    [1    /1   ]  300.961991574        1
[INPUT] 1    0    [1    /1   ]  314.042273999        1
[INPUT] 1    0    [1    /1   ]  61.6222358638        1
[INPUT] 1    0    [1    /1   ]  7.32989794841        1
[INPUT] 1    0    [1    /1   ]  20.2391201296        1
[INPUT] 1    0    [1    /1   ]  0.772070364573       1
[INPUT] 1    0    [1    /1   ]  2.80887843481        1
[INPUT] 1    0    [1    /1   ]  0.222573632039       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65585524854, 1.0]], [0, [7617.521915627052, 1.0]], [0, [3617.3508674245704, 1.0]], [0, [1597.8256930291025, 1.0]], [0, [382.85114947300525, 1.0]], [0, [108.1210834029935, 1.0]], [0, [34.80546906975482, 1.0]], [0, [7.585223905343421, 1.0]], [0, [2.5852239053434207, 1.0]], [0, [0.39531349055767473, 1.0]], [0, [0.09953134905576748, 1.0]], [1, [1362.7832062666114, 1.0]], [1, [664.7456809871924, 1.0]], [1, [300.9619915744506, 1.0]], [1, [314.0422739991703, 1.0]], [1, [61.622235863813884, 1.0]], [1, [7.329897948406479, 1.0]], [1, [20.239120129550937, 1.0]], [1, [0.7720703645725635, 1.0]], [1, [2.8088784348099196, 1.0]], [1, [0.22257363203907735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585525]
bas 1, expnt(s) = [7617.52191563]
bas 2, expnt(s) = [3617.35086742]
bas 3, expnt(s) = [1597.82569303]
bas 4, expnt(s) = [382.85114947]
bas 5, expnt(s) = [108.1210834]
bas 6, expnt(s) = [34.80546907]
bas 7, expnt(s) = [7.58522391]
bas 8, expnt(s) = [2.58522391]
bas 9, expnt(s) = [0.39531349]
bas 10, expnt(s) = [0.09953135]
bas 11, expnt(s) = [1362.78320627]
bas 12, expnt(s) = [664.74568099]
bas 13, expnt(s) = [300.96199157]
bas 14, expnt(s) = [314.042274]
bas 15, expnt(s) = [61.62223586]
bas 16, expnt(s) = [7.32989795]
bas 17, expnt(s) = [20.23912013]
bas 18, expnt(s) = [0.77207036]
bas 19, expnt(s) = [2.80887843]
bas 20, expnt(s) = [0.22257363]
CPU time:         0.96
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752192e+03 2.06003837e+03
 3.61735087e+03 1.17844143e+03 1.59782569e+03 6.38501724e+02
 3.82851149e+02 2.18669137e+02 1.08121083e+02 8.47125619e+01
 3.48054691e+01 3.62035070e+01 7.58522391e+00 1.15475893e+01
 2.58522391e+00 5.15096557e+00 3.95313491e-01 1.25956693e+00
 9.95313491e-02 4.47697781e-01 1.36278321e+03 2.41556016e+04
 6.64745681e+02 9.84699683e+03 3.00961992e+02 3.65699156e+03
 3.14042274e+02 3.85673265e+03 6.16222359e+01 5.03681741e+02
 7.32989795e+00 3.51849390e+01 2.02391201e+01 1.25234483e+02
 7.72070365e-01 2.11132697e+00 2.80887843e+00 1.06084167e+01
 2.22573632e-01 4.45991451e-01]
ecpbas  = []
2023-03-19 09:08:56.437462: W external/org_tensorflow/tensorflow/tsl/platform/default/dso_loader.cc:67] Could not load dynamic library 'libcuda.so.1'; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2023-03-19 09:08:56.437548: W external/org_tensorflow/tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:264] failed call to cuInit: UNKNOWN ERROR (303)
No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
Set gradient conv threshold to 3.16228e-05
/localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscfad/gto/moleintor.py:74: UserWarning: AO symmetry is not supported. Setting aosym = s1.
  warnings.warn(msg)
Nelec from initial guess = 17.98824480344862
cond(S) = 102158.77242826286
E1 = -729.1013135654215  E_coul = 202.95923306391555
init E= -526.142080501506
    CPU time for initialize scf      0.25 sec, wall time      0.17 sec
/localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/jax/_src/numpy/lax_numpy.py:3493: UserWarning: 'kind' argument to argsort is ignored; only 'stable' sorts are supported.
  warnings.warn("'kind' argument to argsort is ignored; only 'stable' sorts "
  HOMO = -0.565689593071935  LUMO = 0.298481097394126
  mo_energy =
[-1.18337540e+02 -1.22164882e+01 -9.46178530e+00 -9.46178530e+00
 -9.46178530e+00 -1.23017126e+00 -5.65689593e-01 -5.65689593e-01
 -5.65689593e-01  2.98481097e-01  1.02323312e+00  1.02323312e+00
  1.02323312e+00  7.31243409e+00  7.31243409e+00  7.31243409e+00
  8.28087014e+00  3.34856766e+01  3.34856766e+01  3.34856766e+01
  9.88160121e+01  1.29108870e+02  1.29108870e+02  1.29108870e+02
  4.83518865e+02  4.83518865e+02  4.83518865e+02  5.79727432e+02
  1.33541450e+03  1.33541450e+03  1.33541450e+03  2.64886111e+03
  3.02972927e+03  3.02972927e+03  3.02972927e+03  6.65028749e+03
  6.65028749e+03  6.65028749e+03  9.05498912e+03  2.54109893e+04
  7.61538065e+04]
E1 = -727.3054648489323  E_coul = 200.615303456441
cycle= 1 E= -526.690161392491  delta_E= -0.548  |g|= 0.209  |ddm|= 0.611
    CPU time for cycle= 1      0.31 sec, wall time      0.31 sec
diis-norm(errvec)=0.579472
diis-c [-0.33578788  1.        ]
  HOMO = -0.599921588398766  LUMO = 0.29292798509454
  mo_energy =
[-1.18684689e+02 -1.23752301e+01 -9.63745058e+00 -9.63745058e+00
 -9.63745058e+00 -1.26612802e+00 -5.99921588e-01 -5.99921588e-01
 -5.99921588e-01  2.92927985e-01  9.99981970e-01  9.99981970e-01
  9.99981970e-01  7.21218083e+00  7.21218083e+00  7.21218083e+00
  8.17929251e+00  3.33064332e+01  3.33064332e+01  3.33064332e+01
  9.85608569e+01  1.28846644e+02  1.28846644e+02  1.28846644e+02
  4.83172640e+02  4.83172640e+02  4.83172640e+02  5.79343513e+02
  1.33501144e+03  1.33501144e+03  1.33501144e+03  2.64832099e+03
  3.02925854e+03  3.02925854e+03  3.02925854e+03  6.64970209e+03
  6.64970209e+03  6.64970209e+03  9.05432749e+03  2.54102331e+04
  7.61529598e+04]
E1 = -727.9610249624732  E_coul = 201.26972361865552
cycle= 2 E= -526.691301343818  delta_E= -0.00114  |g|= 0.0442  |ddm|= 0.0601
    CPU time for cycle= 2      0.11 sec, wall time      0.11 sec
diis-norm(errvec)=0.08505
diis-c [-0.00365001  0.09409696  0.90590304]
  HOMO = -0.589665504513514  LUMO = 0.296242539426097
  mo_energy =
[-1.18607793e+02 -1.23321969e+01 -9.59297965e+00 -9.59297965e+00
 -9.59297965e+00 -1.25370728e+00 -5.89665505e-01 -5.89665505e-01
 -5.89665505e-01  2.96242539e-01  1.00755611e+00  1.00755611e+00
  1.00755611e+00  7.23873982e+00  7.23873982e+00  7.23873982e+00
  8.21116088e+00  3.33514722e+01  3.33514722e+01  3.33514722e+01
  9.86239319e+01  1.28909994e+02  1.28909994e+02  1.28909994e+02
  4.83248595e+02  4.83248595e+02  4.83248595e+02  5.79422075e+02
  1.33509189e+03  1.33509189e+03  1.33509189e+03  2.64840482e+03
  3.02934135e+03  3.02934135e+03  3.02934135e+03  6.64978658e+03
  6.64978658e+03  6.64978658e+03  9.05441273e+03  2.54103188e+04
  7.61530458e+04]
E1 = -727.8035037114363  E_coul = 201.1121280840851
cycle= 3 E= -526.691375627351  delta_E= -7.43e-05  |g|= 0.00618  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0136619
diis-c [-3.05151293e-06 -1.77374372e-03  1.30885983e-01  8.70887761e-01]
  HOMO = -0.59099270461649  LUMO = 0.29591572668596
  mo_energy =
[-1.18617286e+02 -1.23374508e+01 -9.59870369e+00 -9.59870369e+00
 -9.59870369e+00 -1.25504580e+00 -5.90992705e-01 -5.90992705e-01
 -5.90992705e-01  2.95915727e-01  1.00660849e+00  1.00660849e+00
  1.00660849e+00  7.23534064e+00  7.23534064e+00  7.23534064e+00
  8.20750969e+00  3.33457328e+01  3.33457328e+01  3.33457328e+01
  9.86161962e+01  1.28902125e+02  1.28902125e+02  1.28902125e+02
  4.83239218e+02  4.83239218e+02  4.83239218e+02  5.79412298e+02
  1.33508187e+03  1.33508187e+03  1.33508187e+03  2.64839404e+03
  3.02933088e+03  3.02933088e+03  3.02933088e+03  6.64977563e+03
  6.64977563e+03  6.64977563e+03  9.05440150e+03  2.54103074e+04
  7.61530341e+04]
E1 = -727.8233716444078  E_coul = 201.13199425121934
cycle= 4 E= -526.691377393188  delta_E= -1.77e-06  |g|= 0.000263  |ddm|= 0.00193
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000468967
diis-c [-6.50082271e-09  1.53137552e-04 -1.67008790e-02 -1.42711919e-01
  1.15925966e+00]
  HOMO = -0.591018972674979  LUMO = 0.295927366753566
  mo_energy =
[-1.18617459e+02 -1.23375081e+01 -9.59880566e+00 -9.59880566e+00
 -9.59880566e+00 -1.25502276e+00 -5.91018973e-01 -5.91018973e-01
 -5.91018973e-01  2.95927367e-01  1.00659385e+00  1.00659385e+00
  1.00659385e+00  7.23528713e+00  7.23528713e+00  7.23528713e+00
  8.20750200e+00  3.33456331e+01  3.33456331e+01  3.33456331e+01
  9.86160763e+01  1.28901990e+02  1.28901990e+02  1.28901990e+02
  4.83239048e+02  4.83239048e+02  4.83239048e+02  5.79412107e+02
  1.33508168e+03  1.33508168e+03  1.33508168e+03  2.64839379e+03
  3.02933066e+03  3.02933066e+03  3.02933066e+03  6.64977536e+03
  6.64977536e+03  6.64977536e+03  9.05440121e+03  2.54103071e+04
  7.61530338e+04]
E1 = -727.8236056791623  E_coul = 201.13222827320394
cycle= 5 E= -526.691377405958  delta_E= -1.28e-08  |g|= 1.7e-05  |ddm|= 0.000404
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.07811e-05
diis-c [-1.64708123e-10 -1.10375848e-05  1.27599330e-03  1.07898123e-02
 -1.20473585e-01  1.10841882e+00]
  HOMO = -0.591026138453745  LUMO = 0.295926504585002
  mo_energy =
[-1.18617479e+02 -1.23375249e+01 -9.59882317e+00 -9.59882317e+00
 -9.59882317e+00 -1.25502697e+00 -5.91026138e-01 -5.91026138e-01
 -5.91026138e-01  2.95926505e-01  1.00658908e+00  1.00658908e+00
  1.00658908e+00  7.23527411e+00  7.23527411e+00  7.23527411e+00
  8.20748895e+00  3.33456161e+01  3.33456161e+01  3.33456161e+01
  9.86160576e+01  1.28901971e+02  1.28901971e+02  1.28901971e+02
  4.83239029e+02  4.83239029e+02  4.83239029e+02  5.79412087e+02
  1.33508166e+03  1.33508166e+03  1.33508166e+03  2.64839377e+03
  3.02933064e+03  3.02933064e+03  3.02933064e+03  6.64977534e+03
  6.64977534e+03  6.64977534e+03  9.05440119e+03  2.54103070e+04
  7.61530338e+04]
E1 = -727.8236425394465  E_coul = 201.1322651333935
cycle= 6 E= -526.691377406053  delta_E= -9.47e-11  |g|= 2.47e-06  |ddm|= 3.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.8236425394465  E_coul = 201.1322651333935
  HOMO = -0.591025270845173  LUMO = 0.295926851845345
  mo_energy =
[-1.18617474e+02 -1.23375215e+01 -9.59881972e+00 -9.59881972e+00
 -9.59881972e+00 -1.25502573e+00 -5.91025271e-01 -5.91025271e-01
 -5.91025271e-01  2.95926852e-01  1.00658973e+00  1.00658973e+00
  1.00658973e+00  7.23527636e+00  7.23527636e+00  7.23527636e+00
  8.20749152e+00  3.33456194e+01  3.33456194e+01  3.33456194e+01
  9.86160617e+01  1.28901975e+02  1.28901975e+02  1.28901975e+02
  4.83239033e+02  4.83239033e+02  4.83239033e+02  5.79412092e+02
  1.33508166e+03  1.33508166e+03  1.33508166e+03  2.64839377e+03
  3.02933064e+03  3.02933064e+03  3.02933064e+03  6.64977535e+03
  6.64977535e+03  6.64977535e+03  9.05440120e+03  2.54103071e+04
  7.61530338e+04]
E1 = -727.8236299090626  E_coul = 201.13225250300982
Extra cycle  E= -526.691377406053  delta_E= 2.27e-13  |g|= 7.31e-07  |ddm|= 3.1e-06
    CPU time for scf_cycle      0.85 sec, wall time      0.77 sec
exp = [2.61826559e+04 7.61752192e+03 3.61735087e+03 1.59782569e+03
 3.82851149e+02 1.08121083e+02 3.48054691e+01 7.58522391e+00
 2.58522391e+00 3.95313491e-01 9.95313491e-02 1.36278321e+03
 6.64745681e+02 3.00961992e+02 3.14042274e+02 6.16222359e+01
 7.32989795e+00 2.02391201e+01 7.72070365e-01 2.80887843e+00
 2.22573632e-01]
E = -526.6913774060528
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:08:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558552        1
[INPUT] 0    0    [1    /1   ]  7617.52191563        1
[INPUT] 0    0    [1    /1   ]  3617.35086742        1
[INPUT] 0    0    [1    /1   ]  1597.82569303        1
[INPUT] 0    0    [1    /1   ]  382.851149473        1
[INPUT] 0    0    [1    /1   ]  108.121083403        1
[INPUT] 0    0    [1    /1   ]  34.8054690698        1
[INPUT] 0    0    [1    /1   ]  7.58522390534        1
[INPUT] 0    0    [1    /1   ]  2.58522390534        1
[INPUT] 0    0    [1    /1   ]  0.395313490558       1
[INPUT] 0    0    [1    /1   ]  0.0995313490558      1
[INPUT] 1    0    [1    /1   ]  1362.78320627        1
[INPUT] 1    0    [1    /1   ]  664.745680987        1
[INPUT] 1    0    [1    /1   ]  300.961991574        1
[INPUT] 1    0    [1    /1   ]  314.042273999        1
[INPUT] 1    0    [1    /1   ]  61.6222358638        1
[INPUT] 1    0    [1    /1   ]  7.32989794841        1
[INPUT] 1    0    [1    /1   ]  20.2391201296        1
[INPUT] 1    0    [1    /1   ]  0.772070364573       1
[INPUT] 1    0    [1    /1   ]  2.80887843481        1
[INPUT] 1    0    [1    /1   ]  0.222573632039       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65585524854, 1.0]], [0, [7617.521915627052, 1.0]], [0, [3617.3508674245704, 1.0]], [0, [1597.8256930291025, 1.0]], [0, [382.85114947300525, 1.0]], [0, [108.1210834029935, 1.0]], [0, [34.80546906975482, 1.0]], [0, [7.585223905343421, 1.0]], [0, [2.5852239053434207, 1.0]], [0, [0.39531349055767473, 1.0]], [0, [0.09953134905576748, 1.0]], [1, [1362.7832062666114, 1.0]], [1, [664.7456809871924, 1.0]], [1, [300.9619915744506, 1.0]], [1, [314.0422739991703, 1.0]], [1, [61.622235863813884, 1.0]], [1, [7.329897948406479, 1.0]], [1, [20.239120129550937, 1.0]], [1, [0.7720703645725635, 1.0]], [1, [2.8088784348099196, 1.0]], [1, [0.22257363203907735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585525]
bas 1, expnt(s) = [7617.52191563]
bas 2, expnt(s) = [3617.35086742]
bas 3, expnt(s) = [1597.82569303]
bas 4, expnt(s) = [382.85114947]
bas 5, expnt(s) = [108.1210834]
bas 6, expnt(s) = [34.80546907]
bas 7, expnt(s) = [7.58522391]
bas 8, expnt(s) = [2.58522391]
bas 9, expnt(s) = [0.39531349]
bas 10, expnt(s) = [0.09953135]
bas 11, expnt(s) = [1362.78320627]
bas 12, expnt(s) = [664.74568099]
bas 13, expnt(s) = [300.96199157]
bas 14, expnt(s) = [314.042274]
bas 15, expnt(s) = [61.62223586]
bas 16, expnt(s) = [7.32989795]
bas 17, expnt(s) = [20.23912013]
bas 18, expnt(s) = [0.77207036]
bas 19, expnt(s) = [2.80887843]
bas 20, expnt(s) = [0.22257363]
CPU time:         2.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752192e+03 2.06003837e+03
 3.61735087e+03 1.17844143e+03 1.59782569e+03 6.38501724e+02
 3.82851149e+02 2.18669137e+02 1.08121083e+02 8.47125619e+01
 3.48054691e+01 3.62035070e+01 7.58522391e+00 1.15475893e+01
 2.58522391e+00 5.15096557e+00 3.95313491e-01 1.25956693e+00
 9.95313491e-02 4.47697781e-01 1.36278321e+03 2.41556016e+04
 6.64745681e+02 9.84699683e+03 3.00961992e+02 3.65699156e+03
 3.14042274e+02 3.85673265e+03 6.16222359e+01 5.03681741e+02
 7.32989795e+00 3.51849390e+01 2.02391201e+01 1.25234483e+02
 7.72070365e-01 2.11132697e+00 2.80887843e+00 1.06084167e+01
 2.22573632e-01 4.45991451e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98824480344862
cond(S) = 102158.77242826286
E1 = -729.1013135654215  E_coul = 202.95923306391555
init E= -526.142080501506
    CPU time for initialize scf      0.12 sec, wall time      0.05 sec
  HOMO = -0.565689593071935  LUMO = 0.298481097394126
  mo_energy =
[-1.18337540e+02 -1.22164882e+01 -9.46178530e+00 -9.46178530e+00
 -9.46178530e+00 -1.23017126e+00 -5.65689593e-01 -5.65689593e-01
 -5.65689593e-01  2.98481097e-01  1.02323312e+00  1.02323312e+00
  1.02323312e+00  7.31243409e+00  7.31243409e+00  7.31243409e+00
  8.28087014e+00  3.34856766e+01  3.34856766e+01  3.34856766e+01
  9.88160121e+01  1.29108870e+02  1.29108870e+02  1.29108870e+02
  4.83518865e+02  4.83518865e+02  4.83518865e+02  5.79727432e+02
  1.33541450e+03  1.33541450e+03  1.33541450e+03  2.64886111e+03
  3.02972927e+03  3.02972927e+03  3.02972927e+03  6.65028749e+03
  6.65028749e+03  6.65028749e+03  9.05498912e+03  2.54109893e+04
  7.61538065e+04]
E1 = -727.3054648489323  E_coul = 200.615303456441
cycle= 1 E= -526.690161392491  delta_E= -0.548  |g|= 0.209  |ddm|= 0.611
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.579472
diis-c [-0.33578788  1.        ]
  HOMO = -0.599921588398766  LUMO = 0.29292798509454
  mo_energy =
[-1.18684689e+02 -1.23752301e+01 -9.63745058e+00 -9.63745058e+00
 -9.63745058e+00 -1.26612802e+00 -5.99921588e-01 -5.99921588e-01
 -5.99921588e-01  2.92927985e-01  9.99981970e-01  9.99981970e-01
  9.99981970e-01  7.21218083e+00  7.21218083e+00  7.21218083e+00
  8.17929251e+00  3.33064332e+01  3.33064332e+01  3.33064332e+01
  9.85608569e+01  1.28846644e+02  1.28846644e+02  1.28846644e+02
  4.83172640e+02  4.83172640e+02  4.83172640e+02  5.79343513e+02
  1.33501144e+03  1.33501144e+03  1.33501144e+03  2.64832099e+03
  3.02925854e+03  3.02925854e+03  3.02925854e+03  6.64970209e+03
  6.64970209e+03  6.64970209e+03  9.05432749e+03  2.54102331e+04
  7.61529598e+04]
E1 = -727.9610249624732  E_coul = 201.26972361865552
cycle= 2 E= -526.691301343818  delta_E= -0.00114  |g|= 0.0442  |ddm|= 0.0601
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.08505
diis-c [-0.00365001  0.09409696  0.90590304]
  HOMO = -0.589665504513514  LUMO = 0.296242539426097
  mo_energy =
[-1.18607793e+02 -1.23321969e+01 -9.59297965e+00 -9.59297965e+00
 -9.59297965e+00 -1.25370728e+00 -5.89665505e-01 -5.89665505e-01
 -5.89665505e-01  2.96242539e-01  1.00755611e+00  1.00755611e+00
  1.00755611e+00  7.23873982e+00  7.23873982e+00  7.23873982e+00
  8.21116088e+00  3.33514722e+01  3.33514722e+01  3.33514722e+01
  9.86239319e+01  1.28909994e+02  1.28909994e+02  1.28909994e+02
  4.83248595e+02  4.83248595e+02  4.83248595e+02  5.79422075e+02
  1.33509189e+03  1.33509189e+03  1.33509189e+03  2.64840482e+03
  3.02934135e+03  3.02934135e+03  3.02934135e+03  6.64978658e+03
  6.64978658e+03  6.64978658e+03  9.05441273e+03  2.54103188e+04
  7.61530458e+04]
E1 = -727.8035037114363  E_coul = 201.1121280840851
cycle= 3 E= -526.691375627351  delta_E= -7.43e-05  |g|= 0.00618  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0136619
diis-c [-3.05151293e-06 -1.77374372e-03  1.30885983e-01  8.70887761e-01]
  HOMO = -0.59099270461649  LUMO = 0.29591572668596
  mo_energy =
[-1.18617286e+02 -1.23374508e+01 -9.59870369e+00 -9.59870369e+00
 -9.59870369e+00 -1.25504580e+00 -5.90992705e-01 -5.90992705e-01
 -5.90992705e-01  2.95915727e-01  1.00660849e+00  1.00660849e+00
  1.00660849e+00  7.23534064e+00  7.23534064e+00  7.23534064e+00
  8.20750969e+00  3.33457328e+01  3.33457328e+01  3.33457328e+01
  9.86161962e+01  1.28902125e+02  1.28902125e+02  1.28902125e+02
  4.83239218e+02  4.83239218e+02  4.83239218e+02  5.79412298e+02
  1.33508187e+03  1.33508187e+03  1.33508187e+03  2.64839404e+03
  3.02933088e+03  3.02933088e+03  3.02933088e+03  6.64977563e+03
  6.64977563e+03  6.64977563e+03  9.05440150e+03  2.54103074e+04
  7.61530341e+04]
E1 = -727.8233716444078  E_coul = 201.13199425121934
cycle= 4 E= -526.691377393188  delta_E= -1.77e-06  |g|= 0.000263  |ddm|= 0.00193
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000468967
diis-c [-6.50082271e-09  1.53137552e-04 -1.67008790e-02 -1.42711919e-01
  1.15925966e+00]
  HOMO = -0.591018972674979  LUMO = 0.295927366753566
  mo_energy =
[-1.18617459e+02 -1.23375081e+01 -9.59880566e+00 -9.59880566e+00
 -9.59880566e+00 -1.25502276e+00 -5.91018973e-01 -5.91018973e-01
 -5.91018973e-01  2.95927367e-01  1.00659385e+00  1.00659385e+00
  1.00659385e+00  7.23528713e+00  7.23528713e+00  7.23528713e+00
  8.20750200e+00  3.33456331e+01  3.33456331e+01  3.33456331e+01
  9.86160763e+01  1.28901990e+02  1.28901990e+02  1.28901990e+02
  4.83239048e+02  4.83239048e+02  4.83239048e+02  5.79412107e+02
  1.33508168e+03  1.33508168e+03  1.33508168e+03  2.64839379e+03
  3.02933066e+03  3.02933066e+03  3.02933066e+03  6.64977536e+03
  6.64977536e+03  6.64977536e+03  9.05440121e+03  2.54103071e+04
  7.61530338e+04]
E1 = -727.8236056791623  E_coul = 201.13222827320394
cycle= 5 E= -526.691377405958  delta_E= -1.28e-08  |g|= 1.7e-05  |ddm|= 0.000404
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.07811e-05
diis-c [-1.64708123e-10 -1.10375848e-05  1.27599330e-03  1.07898123e-02
 -1.20473585e-01  1.10841882e+00]
  HOMO = -0.591026138453745  LUMO = 0.295926504585002
  mo_energy =
[-1.18617479e+02 -1.23375249e+01 -9.59882317e+00 -9.59882317e+00
 -9.59882317e+00 -1.25502697e+00 -5.91026138e-01 -5.91026138e-01
 -5.91026138e-01  2.95926505e-01  1.00658908e+00  1.00658908e+00
  1.00658908e+00  7.23527411e+00  7.23527411e+00  7.23527411e+00
  8.20748895e+00  3.33456161e+01  3.33456161e+01  3.33456161e+01
  9.86160576e+01  1.28901971e+02  1.28901971e+02  1.28901971e+02
  4.83239029e+02  4.83239029e+02  4.83239029e+02  5.79412087e+02
  1.33508166e+03  1.33508166e+03  1.33508166e+03  2.64839377e+03
  3.02933064e+03  3.02933064e+03  3.02933064e+03  6.64977534e+03
  6.64977534e+03  6.64977534e+03  9.05440119e+03  2.54103070e+04
  7.61530338e+04]
E1 = -727.8236425394465  E_coul = 201.1322651333935
cycle= 6 E= -526.691377406053  delta_E= -9.47e-11  |g|= 2.47e-06  |ddm|= 3.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -727.8236425394465  E_coul = 201.1322651333935
  HOMO = -0.591025270845173  LUMO = 0.295926851845345
  mo_energy =
[-1.18617474e+02 -1.23375215e+01 -9.59881972e+00 -9.59881972e+00
 -9.59881972e+00 -1.25502573e+00 -5.91025271e-01 -5.91025271e-01
 -5.91025271e-01  2.95926852e-01  1.00658973e+00  1.00658973e+00
  1.00658973e+00  7.23527636e+00  7.23527636e+00  7.23527636e+00
  8.20749152e+00  3.33456194e+01  3.33456194e+01  3.33456194e+01
  9.86160617e+01  1.28901975e+02  1.28901975e+02  1.28901975e+02
  4.83239033e+02  4.83239033e+02  4.83239033e+02  5.79412092e+02
  1.33508166e+03  1.33508166e+03  1.33508166e+03  2.64839377e+03
  3.02933064e+03  3.02933064e+03  3.02933064e+03  6.64977535e+03
  6.64977535e+03  6.64977535e+03  9.05440120e+03  2.54103071e+04
  7.61530338e+04]
E1 = -727.8236299090626  E_coul = 201.13225250300982
Extra cycle  E= -526.691377406053  delta_E= 2.27e-13  |g|= 7.31e-07  |ddm|= 3.1e-06
    CPU time for scf_cycle      0.36 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102158.77242826286
E1 = -727.8236299090626  E_coul = 201.13225250300982
init E= -526.691377406053
    CPU time for initialize scf      1.15 sec, wall time      0.48 sec
  HOMO = -0.591025536205648  LUMO = 0.295926790494767
  mo_energy =
[-1.18617475e+02 -1.23375224e+01 -9.59882068e+00 -9.59882068e+00
 -9.59882068e+00 -1.25502598e+00 -5.91025536e-01 -5.91025536e-01
 -5.91025536e-01  2.95926790e-01  1.00658954e+00  1.00658954e+00
  1.00658954e+00  7.23527574e+00  7.23527574e+00  7.23527574e+00
  8.20749085e+00  3.33456185e+01  3.33456185e+01  3.33456185e+01
  9.86160605e+01  1.28901974e+02  1.28901974e+02  1.28901974e+02
  4.83239032e+02  4.83239032e+02  4.83239032e+02  5.79412090e+02
  1.33508166e+03  1.33508166e+03  1.33508166e+03  2.64839377e+03
  3.02933064e+03  3.02933064e+03  3.02933064e+03  6.64977535e+03
  6.64977535e+03  6.64977535e+03  9.05440120e+03  2.54103071e+04
  7.61530338e+04]
E1 = -727.8236329769908  E_coul = 201.13225557093733
cycle= 1 E= -526.691377406053  delta_E= -6.82e-13  |g|= 2.03e-07  |ddm|= 5.17e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -727.8236329769908  E_coul = 201.13225557093733
  HOMO = -0.591025484681211  LUMO = 0.295926809643087
  mo_energy =
[-1.18617475e+02 -1.23375222e+01 -9.59882045e+00 -9.59882045e+00
 -9.59882045e+00 -1.25502591e+00 -5.91025485e-01 -5.91025485e-01
 -5.91025485e-01  2.95926810e-01  1.00658958e+00  1.00658958e+00
  1.00658958e+00  7.23527588e+00  7.23527588e+00  7.23527588e+00
  8.20749101e+00  3.33456187e+01  3.33456187e+01  3.33456187e+01
  9.86160608e+01  1.28901974e+02  1.28901974e+02  1.28901974e+02
  4.83239032e+02  4.83239032e+02  4.83239032e+02  5.79412090e+02
  1.33508166e+03  1.33508166e+03  1.33508166e+03  2.64839377e+03
  3.02933064e+03  3.02933064e+03  3.02933064e+03  6.64977535e+03
  6.64977535e+03  6.64977535e+03  9.05440120e+03  2.54103071e+04
  7.61530338e+04]
E1 = -727.823632117073  E_coul = 201.1322547110205
Extra cycle  E= -526.691377406052  delta_E= 1.02e-12  |g|= 5.4e-08  |ddm|= 1.46e-07
    CPU time for scf_cycle      2.17 sec, wall time      1.50 sec
exp = [2.61826559e+04 7.61752192e+03 3.61735087e+03 1.59782569e+03
 3.82851149e+02 1.08121083e+02 3.48054691e+01 7.58522391e+00
 2.58522391e+00 3.95313491e-01 9.95313491e-02 1.36278321e+03
 6.64745681e+02 3.00961992e+02 3.14042274e+02 6.16222359e+01
 7.32989795e+00 2.02391201e+01 7.72070365e-01 2.80887843e+00
 2.22573632e-01]
grad_E = [-1.51540231e-06  3.28814865e-06 -1.59428947e-06  6.85544384e-05
 -7.04299001e-06 -6.51496393e-04 -7.90573651e-04  3.39243140e-02
 -1.02624020e-01 -4.41337857e-01  4.00810707e-02 -5.04677642e-07
  5.05052071e-06  2.38663247e-05  2.05771859e-05 -3.82862526e-05
 -8.01863461e-05  1.29814464e-04  1.47112928e-03 -3.75670643e-05
 -2.08247677e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558568        1
[INPUT] 0    0    [1    /1   ]  7617.52191234        1
[INPUT] 0    0    [1    /1   ]  3617.35086902        1
[INPUT] 0    0    [1    /1   ]  1597.82562447        1
[INPUT] 0    0    [1    /1   ]  382.851156516        1
[INPUT] 0    0    [1    /1   ]  108.121734899        1
[INPUT] 0    0    [1    /1   ]  34.8062596434        1
[INPUT] 0    0    [1    /1   ]  7.55129959134        1
[INPUT] 0    0    [1    /1   ]  2.68784792499        1
[INPUT] 0    0    [1    /1   ]  0.83665134785        1
[INPUT] 0    0    [1    /1   ]  0.0594502784016      1
[INPUT] 1    0    [1    /1   ]  1362.78320677        1
[INPUT] 1    0    [1    /1   ]  664.745675937        1
[INPUT] 1    0    [1    /1   ]  300.961967708        1
[INPUT] 1    0    [1    /1   ]  314.042253422        1
[INPUT] 1    0    [1    /1   ]  61.6222741501        1
[INPUT] 1    0    [1    /1   ]  7.32997813475        1
[INPUT] 1    0    [1    /1   ]  20.2389903151        1
[INPUT] 1    0    [1    /1   ]  0.770599235289       1
[INPUT] 1    0    [1    /1   ]  2.80891600187        1
[INPUT] 1    0    [1    /1   ]  0.243398399698       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655856763944, 1.0]], [0, [7617.521912338903, 1.0]], [0, [3617.35086901886, 1.0]], [0, [1597.8256244746642, 1.0]], [0, [382.8511565159953, 1.0]], [0, [108.1217348993862, 1.0]], [0, [34.80625964340551, 1.0]], [0, [7.5512995913420955, 1.0]], [0, [2.6878479249894838, 1.0]], [0, [0.8366513478504118, 1.0]], [0, [0.05945027840160515, 1.0]], [1, [1362.783206771289, 1.0]], [1, [664.7456759366717, 1.0]], [1, [300.9619677081259, 1.0]], [1, [314.04225342198436, 1.0]], [1, [61.62227415006644, 1.0]], [1, [7.329978134752593, 1.0]], [1, [20.23899031508717, 1.0]], [1, [0.7705992352887918, 1.0]], [1, [2.8089160018742536, 1.0]], [1, [0.24339839969811342, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585676]
bas 1, expnt(s) = [7617.52191234]
bas 2, expnt(s) = [3617.35086902]
bas 3, expnt(s) = [1597.82562447]
bas 4, expnt(s) = [382.85115652]
bas 5, expnt(s) = [108.1217349]
bas 6, expnt(s) = [34.80625964]
bas 7, expnt(s) = [7.55129959]
bas 8, expnt(s) = [2.68784792]
bas 9, expnt(s) = [0.83665135]
bas 10, expnt(s) = [0.05945028]
bas 11, expnt(s) = [1362.78320677]
bas 12, expnt(s) = [664.74567594]
bas 13, expnt(s) = [300.96196771]
bas 14, expnt(s) = [314.04225342]
bas 15, expnt(s) = [61.62227415]
bas 16, expnt(s) = [7.32997813]
bas 17, expnt(s) = [20.23899032]
bas 18, expnt(s) = [0.77059924]
bas 19, expnt(s) = [2.808916]
bas 20, expnt(s) = [0.2433984]
CPU time:        11.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782562e+03 6.38501704e+02
 3.82851157e+02 2.18669140e+02 1.08121735e+02 8.47129447e+01
 3.48062596e+01 3.62041238e+01 7.55129959e+00 1.15088333e+01
 2.68784792e+00 5.30357292e+00 8.36651348e-01 2.21015845e+00
 5.94502784e-02 3.04179852e-01 1.36278321e+03 2.41556017e+04
 6.64745676e+02 9.84699673e+03 3.00961968e+02 3.65699119e+03
 3.14042253e+02 3.85673233e+03 6.16222742e+01 5.03682132e+02
 7.32997813e+00 3.51854202e+01 2.02389903e+01 1.25233479e+02
 7.70599235e-01 2.10629943e+00 2.80891600e+00 1.06085941e+01
 2.43398400e-01 4.98748429e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.87506842563018
cond(S) = 102774.5124562156
E1 = -727.9595780174623  E_coul = 202.71239711068702
init E= -525.247180906775
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.58443889955679  LUMO = 0.286975000942518
  mo_energy =
[-1.18353447e+02 -1.22263968e+01 -9.47237550e+00 -9.47237550e+00
 -9.47237550e+00 -1.09642519e+00 -5.84438900e-01 -5.84438900e-01
 -5.84438900e-01  2.86975001e-01  1.06139569e+00  1.06139569e+00
  1.06139569e+00  7.38308575e+00  7.38308575e+00  7.38308575e+00
  1.04674030e+01  3.35284800e+01  3.35284800e+01  3.35284800e+01
  1.00839388e+02  1.29137615e+02  1.29137615e+02  1.29137615e+02
  4.83531964e+02  4.83531964e+02  4.83531964e+02  5.81345073e+02
  1.33542612e+03  1.33542612e+03  1.33542612e+03  2.65022555e+03
  3.02973802e+03  3.02973802e+03  3.02973802e+03  6.65029376e+03
  6.65029376e+03  6.65029376e+03  9.05622882e+03  2.54121592e+04
  7.61548944e+04]
E1 = -728.7347335474919  E_coul = 202.31835808617456
cycle= 1 E= -526.416375461317  delta_E= -1.17  |g|= 0.182  |ddm|= 2.24
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.473977
diis-c [-0.22465438  1.        ]
  HOMO = -0.568013203752418  LUMO = 0.314244411356683
  mo_energy =
[-1.18508512e+02 -1.22464170e+01 -9.49507081e+00 -9.49507081e+00
 -9.49507081e+00 -1.10527629e+00 -5.68013204e-01 -5.68013204e-01
 -5.68013204e-01  3.14244411e-01  1.08588655e+00  1.08588655e+00
  1.08588655e+00  7.38053157e+00  7.38053157e+00  7.38053157e+00
  1.04481450e+01  3.34967765e+01  3.34967765e+01  3.34967765e+01
  1.00762987e+02  1.29049892e+02  1.29049892e+02  1.29049892e+02
  4.83377881e+02  4.83377881e+02  4.83377881e+02  5.81154631e+02
  1.33521866e+03  1.33521866e+03  1.33521866e+03  2.64989120e+03
  3.02946865e+03  3.02946865e+03  3.02946865e+03  6.64991602e+03
  6.64991602e+03  6.64991602e+03  9.05577862e+03  2.54116174e+04
  7.61542642e+04]
E1 = -728.6904461794585  E_coul = 202.27313272048522
cycle= 2 E= -526.417313458973  delta_E= -0.000938  |g|= 0.0142  |ddm|= 0.155
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0292701
diis-c [-7.48217312e-04  2.15412873e-02  9.78458713e-01]
  HOMO = -0.572888086011855  LUMO = 0.312887197852873
  mo_energy =
[-1.18499120e+02 -1.22503064e+01 -9.49827125e+00 -9.49827125e+00
 -9.49827125e+00 -1.10870517e+00 -5.72888086e-01 -5.72888086e-01
 -5.72888086e-01  3.12887198e-01  1.08241515e+00  1.08241515e+00
  1.08241515e+00  7.37432990e+00  7.37432990e+00  7.37432990e+00
  1.04419533e+01  3.34944455e+01  3.34944455e+01  3.34944455e+01
  1.00766684e+02  1.29053743e+02  1.29053743e+02  1.29053743e+02
  4.83386952e+02  4.83386952e+02  4.83386952e+02  5.81165060e+02
  1.33522988e+03  1.33522988e+03  1.33522988e+03  2.64990444e+03
  3.02948118e+03  3.02948118e+03  3.02948118e+03  6.64992963e+03
  6.64992963e+03  6.64992963e+03  9.05579275e+03  2.54116319e+04
  7.61542789e+04]
E1 = -728.6909187347072  E_coul = 202.2735895784852
cycle= 3 E= -526.417329156222  delta_E= -1.57e-05  |g|= 0.00165  |ddm|= 0.0134
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00257753
diis-c [-3.30469118e-06 -7.59311707e-04  5.43008371e-02  9.46458475e-01]
  HOMO = -0.572910432811144  LUMO = 0.313049367200117
  mo_energy =
[-1.18500094e+02 -1.22501528e+01 -9.49820891e+00 -9.49820891e+00
 -9.49820891e+00 -1.10829481e+00 -5.72910433e-01 -5.72910433e-01
 -5.72910433e-01  3.13049367e-01  1.08239758e+00  1.08239758e+00
  1.08239758e+00  7.37447408e+00  7.37447408e+00  7.37447408e+00
  1.04421241e+01  3.34944180e+01  3.34944180e+01  3.34944180e+01
  1.00766189e+02  1.29053217e+02  1.29053217e+02  1.29053217e+02
  4.83386002e+02  4.83386002e+02  4.83386002e+02  5.81163979e+02
  1.33522873e+03  1.33522873e+03  1.33522873e+03  2.64990304e+03
  3.02947988e+03  3.02947988e+03  3.02947988e+03  6.64992817e+03
  6.64992817e+03  6.64992817e+03  9.05579120e+03  2.54116303e+04
  7.61542772e+04]
E1 = -728.68910057407  E_coul = 202.27177066115155
cycle= 4 E= -526.417329912918  delta_E= -7.57e-07  |g|= 0.000385  |ddm|= 0.00333
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000449316
diis-c [-2.93773616e-08  6.97801094e-05 -1.70919127e-02 -2.77536024e-01
  1.29455816e+00]
  HOMO = -0.573036001717238  LUMO = 0.313064970025753
  mo_energy =
[-1.18500250e+02 -1.22502883e+01 -9.49837675e+00 -9.49837675e+00
 -9.49837675e+00 -1.10826607e+00 -5.73036002e-01 -5.73036002e-01
 -5.73036002e-01  3.13064970e-01  1.08230858e+00  1.08230858e+00
  1.08230858e+00  7.37432372e+00  7.37432372e+00  7.37432372e+00
  1.04420087e+01  3.34942575e+01  3.34942575e+01  3.34942575e+01
  1.00766041e+02  1.29053059e+02  1.29053059e+02  1.29053059e+02
  4.83385847e+02  4.83385847e+02  4.83385847e+02  5.81163818e+02
  1.33522857e+03  1.33522857e+03  1.33522857e+03  2.64990285e+03
  3.02947971e+03  3.02947971e+03  3.02947971e+03  6.64992798e+03
  6.64992798e+03  6.64992798e+03  9.05579099e+03  2.54116301e+04
  7.61542770e+04]
E1 = -728.6891178282962  E_coul = 202.2717878558395
cycle= 5 E= -526.417329972457  delta_E= -5.95e-08  |g|= 2.98e-05  |ddm|= 0.00108
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.2851e-05
diis-c [-8.20139417e-10  8.69184004e-06 -6.11982332e-04 -3.41522641e-03
  3.29237066e-02  9.71094810e-01]
  HOMO = -0.573021857097106  LUMO = 0.31307165654502
  mo_energy =
[-1.18500201e+02 -1.22502476e+01 -9.49833696e+00 -9.49833696e+00
 -9.49833696e+00 -1.10824930e+00 -5.73021857e-01 -5.73021857e-01
 -5.73021857e-01  3.13071657e-01  1.08231924e+00  1.08231924e+00
  1.08231924e+00  7.37435327e+00  7.37435327e+00  7.37435327e+00
  1.04420445e+01  3.34942968e+01  3.34942968e+01  3.34942968e+01
  1.00766087e+02  1.29053105e+02  1.29053105e+02  1.29053105e+02
  4.83385895e+02  4.83385895e+02  4.83385895e+02  5.81163865e+02
  1.33522862e+03  1.33522862e+03  1.33522862e+03  2.64990290e+03
  3.02947976e+03  3.02947976e+03  3.02947976e+03  6.64992803e+03
  6.64992803e+03  6.64992803e+03  9.05579104e+03  2.54116301e+04
  7.61542770e+04]
E1 = -728.6889563022388  E_coul = 202.27162632971536
cycle= 6 E= -526.417329972523  delta_E= -6.68e-11  |g|= 7.72e-06  |ddm|= 2.27e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.6889563022388  E_coul = 202.27162632971536
  HOMO = -0.573025569483317  LUMO = 0.313070427905553
  mo_energy =
[-1.18500217e+02 -1.22502588e+01 -9.49834885e+00 -9.49834885e+00
 -9.49834885e+00 -1.10825271e+00 -5.73025569e-01 -5.73025569e-01
 -5.73025569e-01  3.13070428e-01  1.08231648e+00  1.08231648e+00
  1.08231648e+00  7.37434531e+00  7.37434531e+00  7.37434531e+00
  1.04420359e+01  3.34942851e+01  3.34942851e+01  3.34942851e+01
  1.00766073e+02  1.29053091e+02  1.29053091e+02  1.29053091e+02
  4.83385879e+02  4.83385879e+02  4.83385879e+02  5.81163849e+02
  1.33522860e+03  1.33522860e+03  1.33522860e+03  2.64990288e+03
  3.02947974e+03  3.02947974e+03  3.02947974e+03  6.64992801e+03
  6.64992801e+03  6.64992801e+03  9.05579102e+03  2.54116301e+04
  7.61542770e+04]
E1 = -728.6890023494002  E_coul = 202.27167237687044
Extra cycle  E= -526.41732997253  delta_E= -6.25e-12  |g|= 2.66e-06  |ddm|= 5.49e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782562e+03
 3.82851157e+02 1.08121735e+02 3.48062596e+01 7.55129959e+00
 2.68784792e+00 8.36651348e-01 5.94502784e-02 1.36278321e+03
 6.64745676e+02 3.00961968e+02 3.14042253e+02 6.16222742e+01
 7.32997813e+00 2.02389903e+01 7.70599235e-01 2.80891600e+00
 2.43398400e-01]
E = -526.4173299725297
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558556        1
[INPUT] 0    0    [1    /1   ]  7617.52191492        1
[INPUT] 0    0    [1    /1   ]  3617.35086777        1
[INPUT] 0    0    [1    /1   ]  1597.82567822        1
[INPUT] 0    0    [1    /1   ]  382.851150995        1
[INPUT] 0    0    [1    /1   ]  108.121224155        1
[INPUT] 0    0    [1    /1   ]  34.8056398684        1
[INPUT] 0    0    [1    /1   ]  7.57789476369        1
[INPUT] 0    0    [1    /1   ]  2.60739520044        1
[INPUT] 0    0    [1    /1   ]  0.490661849587       1
[INPUT] 0    0    [1    /1   ]  0.0908720775886      1
[INPUT] 1    0    [1    /1   ]  1362.78320638        1
[INPUT] 1    0    [1    /1   ]  664.745679896        1
[INPUT] 1    0    [1    /1   ]  300.961986418        1
[INPUT] 1    0    [1    /1   ]  314.042269554        1
[INPUT] 1    0    [1    /1   ]  61.6222441353        1
[INPUT] 1    0    [1    /1   ]  7.32991527218        1
[INPUT] 1    0    [1    /1   ]  20.2390920839        1
[INPUT] 1    0    [1    /1   ]  0.771752536041       1
[INPUT] 1    0    [1    /1   ]  2.80888655095        1
[INPUT] 1    0    [1    /1   ]  0.227072696397       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655855575933, 1.0]], [0, [7617.521914916668, 1.0]], [0, [3617.350867769007, 1.0]], [0, [1597.8256782183332, 1.0]], [0, [382.8511509946004, 1.0]], [0, [108.12122415482554, 1.0]], [0, [34.805639868382315, 1.0]], [0, [7.577894763694283, 1.0]], [0, [2.607395200437569, 1.0]], [0, [0.4906618495871081, 1.0]], [0, [0.09087207758864231, 1.0]], [1, [1362.7832063756439, 1.0]], [1, [664.745679896058, 1.0]], [1, [300.96198641827635, 1.0]], [1, [314.04226955359445, 1.0]], [1, [61.62224413532582, 1.0]], [1, [7.329915272178714, 1.0]], [1, [20.239092083925815, 1.0]], [1, [0.7717525360409523, 1.0]], [1, [2.808886550945616, 1.0]], [1, [0.22707269639679742, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585558]
bas 1, expnt(s) = [7617.52191492]
bas 2, expnt(s) = [3617.35086777]
bas 3, expnt(s) = [1597.82567822]
bas 4, expnt(s) = [382.85115099]
bas 5, expnt(s) = [108.12122415]
bas 6, expnt(s) = [34.80563987]
bas 7, expnt(s) = [7.57789476]
bas 8, expnt(s) = [2.6073952]
bas 9, expnt(s) = [0.49066185]
bas 10, expnt(s) = [0.09087208]
bas 11, expnt(s) = [1362.78320638]
bas 12, expnt(s) = [664.7456799]
bas 13, expnt(s) = [300.96198642]
bas 14, expnt(s) = [314.04226955]
bas 15, expnt(s) = [61.62224414]
bas 16, expnt(s) = [7.32991527]
bas 17, expnt(s) = [20.23909208]
bas 18, expnt(s) = [0.77175254]
bas 19, expnt(s) = [2.80888655]
bas 20, expnt(s) = [0.2270727]
CPU time:        11.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782568e+03 6.38501720e+02
 3.82851151e+02 2.18669138e+02 1.08121224e+02 8.47126446e+01
 3.48056399e+01 3.62036403e+01 7.57789476e+00 1.15392200e+01
 2.60739520e+00 5.18406180e+00 4.90661850e-01 1.48115921e+00
 9.08720776e-02 4.18155552e-01 1.36278321e+03 2.41556016e+04
 6.64745680e+02 9.84699681e+03 3.00961986e+02 3.65699148e+03
 3.14042270e+02 3.85673258e+03 6.16222441e+01 5.03681825e+02
 7.32991527e+00 3.51850430e+01 2.02390921e+01 1.25234266e+02
 7.71752536e-01 2.11024060e+00 2.80888655e+00 1.06084551e+01
 2.27072696e-01 4.57288773e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98835574320175
cond(S) = 102284.02856340382
E1 = -729.5066782232474  E_coul = 203.2072876704422
init E= -526.299390552805
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555101413589317  LUMO = 0.314292799738074
  mo_energy =
[-1.18322501e+02 -1.21990907e+01 -9.44460593e+00 -9.44460593e+00
 -9.44460593e+00 -1.23095549e+00 -5.55101414e-01 -5.55101414e-01
 -5.55101414e-01  3.14292800e-01  1.04555129e+00  1.04555129e+00
  1.04555129e+00  7.34733911e+00  7.34733911e+00  7.34733911e+00
  8.79598414e+00  3.35144100e+01  3.35144100e+01  3.35144100e+01
  9.92598142e+01  1.29134003e+02  1.29134003e+02  1.29134003e+02
  4.83540178e+02  4.83540178e+02  4.83540178e+02  5.80083140e+02
  1.33543547e+03  1.33543547e+03  1.33543547e+03  2.64916349e+03
  3.02974953e+03  3.02974953e+03  3.02974953e+03  6.65030717e+03
  6.65030717e+03  6.65030717e+03  9.05526540e+03  2.54112510e+04
  7.61540511e+04]
E1 = -727.8634517345638  E_coul = 201.1553180215339
cycle= 1 E= -526.70813371303  delta_E= -0.409  |g|= 0.19  |ddm|= 0.397
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.547269
diis-c [-0.29950319  1.        ]
  HOMO = -0.586468414344188  LUMO = 0.30728664428206
  mo_energy =
[-1.18633810e+02 -1.23353702e+01 -9.59403288e+00 -9.59403288e+00
 -9.59403288e+00 -1.26620948e+00 -5.86468414e-01 -5.86468414e-01
 -5.86468414e-01  3.07286644e-01  1.02407099e+00  1.02407099e+00
  1.02407099e+00  7.25979194e+00  7.25979194e+00  7.25979194e+00
  8.69926648e+00  3.33599745e+01  3.33599745e+01  3.33599745e+01
  9.90369449e+01  1.28903152e+02  1.28903152e+02  1.28903152e+02
  4.83229691e+02  4.83229691e+02  4.83229691e+02  5.79735310e+02
  1.33506905e+03  1.33506905e+03  1.33506905e+03  2.64866264e+03
  3.02931694e+03  3.02931694e+03  3.02931694e+03  6.64976155e+03
  6.64976155e+03  6.64976155e+03  9.05464453e+03  2.54105364e+04
  7.61532465e+04]
E1 = -728.4059978077911  E_coul = 201.6971325971625
cycle= 2 E= -526.708865210629  delta_E= -0.000731  |g|= 0.0373  |ddm|= 0.0471
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0739872
diis-c [-0.0031116   0.08196223  0.91803777]
  HOMO = -0.578216181070304  LUMO = 0.310301600362591
  mo_energy =
[-1.18568084e+02 -1.22994382e+01 -9.55666225e+00 -9.55666225e+00
 -9.55666225e+00 -1.25595175e+00 -5.78216181e-01 -5.78216181e-01
 -5.78216181e-01  3.10301600e-01  1.03026158e+00  1.03026158e+00
  1.03026158e+00  7.28172871e+00  7.28172871e+00  7.28172871e+00
  8.72540578e+00  3.33978565e+01  3.33978565e+01  3.33978565e+01
  9.90904155e+01  1.28956948e+02  1.28956948e+02  1.28956948e+02
  4.83294593e+02  4.83294593e+02  4.83294593e+02  5.79802595e+02
  1.33513801e+03  1.33513801e+03  1.33513801e+03  2.64873482e+03
  3.02938810e+03  3.02938810e+03  3.02938810e+03  6.64983436e+03
  6.64983436e+03  6.64983436e+03  9.05471811e+03  2.54106105e+04
  7.61533209e+04]
E1 = -728.2682420327596  E_coul = 201.55932373135062
cycle= 3 E= -526.708918301409  delta_E= -5.31e-05  |g|= 0.00584  |ddm|= 0.0142
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0125391
diis-c [-1.58427861e-06 -1.41453181e-03  1.39131918e-01  8.62282614e-01]
  HOMO = -0.579589277430004  LUMO = 0.30989249277751
  mo_energy =
[-1.18577286e+02 -1.23046633e+01 -9.56226727e+00 -9.56226727e+00
 -9.56226727e+00 -1.25740730e+00 -5.79589277e-01 -5.79589277e-01
 -5.79589277e-01  3.09892493e-01  1.02926511e+00  1.02926511e+00
  1.02926511e+00  7.27832473e+00  7.27832473e+00  7.27832473e+00
  8.72161118e+00  3.33922289e+01  3.33922289e+01  3.33922289e+01
  9.90828558e+01  1.28949278e+02  1.28949278e+02  1.28949278e+02
  4.83285500e+02  4.83285500e+02  4.83285500e+02  5.79793145e+02
  1.33512833e+03  1.33512833e+03  1.33512833e+03  2.64872449e+03
  3.02937803e+03  3.02937803e+03  3.02937803e+03  6.64982389e+03
  6.64982389e+03  6.64982389e+03  9.05470741e+03  2.54105996e+04
  7.61533098e+04]
E1 = -728.2877978216699  E_coul = 201.57887791941542
cycle= 4 E= -526.708919902254  delta_E= -1.6e-06  |g|= 0.0002  |ddm|= 0.00191
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000268812
diis-c [-1.06175723e-08  1.68118220e-04 -2.09447799e-02 -1.44668614e-01
  1.16544528e+00]
  HOMO = -0.579596090757546  LUMO = 0.309910420363356
  mo_energy =
[-1.18577308e+02 -1.23046317e+01 -9.56226368e+00 -9.56226368e+00
 -9.56226368e+00 -1.25736178e+00 -5.79596091e-01 -5.79596091e-01
 -5.79596091e-01  3.09910420e-01  1.02926448e+00  1.02926448e+00
  1.02926448e+00  7.27833183e+00  7.27833183e+00  7.27833183e+00
  8.72165310e+00  3.33922317e+01  3.33922317e+01  3.33922317e+01
  9.90828597e+01  1.28949272e+02  1.28949272e+02  1.28949272e+02
  4.83285479e+02  4.83285479e+02  4.83285479e+02  5.79793112e+02
  1.33512830e+03  1.33512830e+03  1.33512830e+03  2.64872442e+03
  3.02937798e+03  3.02937798e+03  3.02937798e+03  6.64982381e+03
  6.64982381e+03  6.64982381e+03  9.05470731e+03  2.54105995e+04
  7.61533097e+04]
E1 = -728.2876331036683  E_coul = 201.57871319052163
cycle= 5 E= -526.708919913147  delta_E= -1.09e-08  |g|= 2.28e-05  |ddm|= 0.000361
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.80493e-05
diis-c [-1.98330337e-10  1.10109361e-05 -1.19979517e-03 -1.00688744e-02
  2.07362647e-03  1.00918403e+00]
  HOMO = -0.579606924800243  LUMO = 0.309908262428177
  mo_energy =
[-1.18577344e+02 -1.23046608e+01 -9.56229435e+00 -9.56229435e+00
 -9.56229435e+00 -1.25737010e+00 -5.79606925e-01 -5.79606925e-01
 -5.79606925e-01  3.09908262e-01  1.02925702e+00  1.02925702e+00
  1.02925702e+00  7.27831014e+00  7.27831014e+00  7.27831014e+00
  8.72163096e+00  3.33922019e+01  3.33922019e+01  3.33922019e+01
  9.90828261e+01  1.28949238e+02  1.28949238e+02  1.28949238e+02
  4.83285443e+02  4.83285443e+02  4.83285443e+02  5.79793075e+02
  1.33512826e+03  1.33512826e+03  1.33512826e+03  2.64872438e+03
  3.02937794e+03  3.02937794e+03  3.02937794e+03  6.64982377e+03
  6.64982377e+03  6.64982377e+03  9.05470727e+03  2.54105994e+04
  7.61533097e+04]
E1 = -728.2877205394418  E_coul = 201.57880062619293
cycle= 6 E= -526.708919913249  delta_E= -1.02e-10  |g|= 2.44e-06  |ddm|= 2.95e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2877205394418  E_coul = 201.57880062619293
  HOMO = -0.579606234218317  LUMO = 0.309908617404303
  mo_energy =
[-1.18577340e+02 -1.23046579e+01 -9.56229135e+00 -9.56229135e+00
 -9.56229135e+00 -1.25736896e+00 -5.79606234e-01 -5.79606234e-01
 -5.79606234e-01  3.09908617e-01  1.02925756e+00  1.02925756e+00
  1.02925756e+00  7.27831204e+00  7.27831204e+00  7.27831204e+00
  8.72163317e+00  3.33922048e+01  3.33922048e+01  3.33922048e+01
  9.90828298e+01  1.28949242e+02  1.28949242e+02  1.28949242e+02
  4.83285447e+02  4.83285447e+02  4.83285447e+02  5.79793079e+02
  1.33512826e+03  1.33512826e+03  1.33512826e+03  2.64872439e+03
  3.02937794e+03  3.02937794e+03  3.02937794e+03  6.64982377e+03
  6.64982377e+03  6.64982377e+03  9.05470728e+03  2.54105994e+04
  7.61533097e+04]
E1 = -728.2877090619028  E_coul = 201.57878914865324
Extra cycle  E= -526.708919913249  delta_E= -5.68e-13  |g|= 6.84e-07  |ddm|= 2.93e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782568e+03
 3.82851151e+02 1.08121224e+02 3.48056399e+01 7.57789476e+00
 2.60739520e+00 4.90661850e-01 9.08720776e-02 1.36278321e+03
 6.64745680e+02 3.00961986e+02 3.14042270e+02 6.16222441e+01
 7.32991527e+00 2.02390921e+01 7.71752536e-01 2.80888655e+00
 2.27072696e-01]
E = -526.7089199132495
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558556        1
[INPUT] 0    0    [1    /1   ]  7617.52191492        1
[INPUT] 0    0    [1    /1   ]  3617.35086777        1
[INPUT] 0    0    [1    /1   ]  1597.82567822        1
[INPUT] 0    0    [1    /1   ]  382.851150995        1
[INPUT] 0    0    [1    /1   ]  108.121224155        1
[INPUT] 0    0    [1    /1   ]  34.8056398684        1
[INPUT] 0    0    [1    /1   ]  7.57789476369        1
[INPUT] 0    0    [1    /1   ]  2.60739520044        1
[INPUT] 0    0    [1    /1   ]  0.490661849587       1
[INPUT] 0    0    [1    /1   ]  0.0908720775886      1
[INPUT] 1    0    [1    /1   ]  1362.78320638        1
[INPUT] 1    0    [1    /1   ]  664.745679896        1
[INPUT] 1    0    [1    /1   ]  300.961986418        1
[INPUT] 1    0    [1    /1   ]  314.042269554        1
[INPUT] 1    0    [1    /1   ]  61.6222441353        1
[INPUT] 1    0    [1    /1   ]  7.32991527218        1
[INPUT] 1    0    [1    /1   ]  20.2390920839        1
[INPUT] 1    0    [1    /1   ]  0.771752536041       1
[INPUT] 1    0    [1    /1   ]  2.80888655095        1
[INPUT] 1    0    [1    /1   ]  0.227072696397       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655855575933, 1.0]], [0, [7617.521914916668, 1.0]], [0, [3617.350867769007, 1.0]], [0, [1597.8256782183332, 1.0]], [0, [382.8511509946004, 1.0]], [0, [108.12122415482554, 1.0]], [0, [34.805639868382315, 1.0]], [0, [7.577894763694283, 1.0]], [0, [2.607395200437569, 1.0]], [0, [0.4906618495871081, 1.0]], [0, [0.09087207758864231, 1.0]], [1, [1362.7832063756439, 1.0]], [1, [664.745679896058, 1.0]], [1, [300.96198641827635, 1.0]], [1, [314.04226955359445, 1.0]], [1, [61.62224413532582, 1.0]], [1, [7.329915272178714, 1.0]], [1, [20.239092083925815, 1.0]], [1, [0.7717525360409523, 1.0]], [1, [2.808886550945616, 1.0]], [1, [0.22707269639679742, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585558]
bas 1, expnt(s) = [7617.52191492]
bas 2, expnt(s) = [3617.35086777]
bas 3, expnt(s) = [1597.82567822]
bas 4, expnt(s) = [382.85115099]
bas 5, expnt(s) = [108.12122415]
bas 6, expnt(s) = [34.80563987]
bas 7, expnt(s) = [7.57789476]
bas 8, expnt(s) = [2.6073952]
bas 9, expnt(s) = [0.49066185]
bas 10, expnt(s) = [0.09087208]
bas 11, expnt(s) = [1362.78320638]
bas 12, expnt(s) = [664.7456799]
bas 13, expnt(s) = [300.96198642]
bas 14, expnt(s) = [314.04226955]
bas 15, expnt(s) = [61.62224414]
bas 16, expnt(s) = [7.32991527]
bas 17, expnt(s) = [20.23909208]
bas 18, expnt(s) = [0.77175254]
bas 19, expnt(s) = [2.80888655]
bas 20, expnt(s) = [0.2270727]
CPU time:        12.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782568e+03 6.38501720e+02
 3.82851151e+02 2.18669138e+02 1.08121224e+02 8.47126446e+01
 3.48056399e+01 3.62036403e+01 7.57789476e+00 1.15392200e+01
 2.60739520e+00 5.18406180e+00 4.90661850e-01 1.48115921e+00
 9.08720776e-02 4.18155552e-01 1.36278321e+03 2.41556016e+04
 6.64745680e+02 9.84699681e+03 3.00961986e+02 3.65699148e+03
 3.14042270e+02 3.85673258e+03 6.16222441e+01 5.03681825e+02
 7.32991527e+00 3.51850430e+01 2.02390921e+01 1.25234266e+02
 7.71752536e-01 2.11024060e+00 2.80888655e+00 1.06084551e+01
 2.27072696e-01 4.57288773e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.98835574320175
cond(S) = 102284.02856340382
E1 = -729.5066782232474  E_coul = 203.2072876704422
init E= -526.299390552805
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555101413589317  LUMO = 0.314292799738074
  mo_energy =
[-1.18322501e+02 -1.21990907e+01 -9.44460593e+00 -9.44460593e+00
 -9.44460593e+00 -1.23095549e+00 -5.55101414e-01 -5.55101414e-01
 -5.55101414e-01  3.14292800e-01  1.04555129e+00  1.04555129e+00
  1.04555129e+00  7.34733911e+00  7.34733911e+00  7.34733911e+00
  8.79598414e+00  3.35144100e+01  3.35144100e+01  3.35144100e+01
  9.92598142e+01  1.29134003e+02  1.29134003e+02  1.29134003e+02
  4.83540178e+02  4.83540178e+02  4.83540178e+02  5.80083140e+02
  1.33543547e+03  1.33543547e+03  1.33543547e+03  2.64916349e+03
  3.02974953e+03  3.02974953e+03  3.02974953e+03  6.65030717e+03
  6.65030717e+03  6.65030717e+03  9.05526540e+03  2.54112510e+04
  7.61540511e+04]
E1 = -727.8634517345638  E_coul = 201.1553180215339
cycle= 1 E= -526.70813371303  delta_E= -0.409  |g|= 0.19  |ddm|= 0.397
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.547269
diis-c [-0.29950319  1.        ]
  HOMO = -0.586468414344188  LUMO = 0.30728664428206
  mo_energy =
[-1.18633810e+02 -1.23353702e+01 -9.59403288e+00 -9.59403288e+00
 -9.59403288e+00 -1.26620948e+00 -5.86468414e-01 -5.86468414e-01
 -5.86468414e-01  3.07286644e-01  1.02407099e+00  1.02407099e+00
  1.02407099e+00  7.25979194e+00  7.25979194e+00  7.25979194e+00
  8.69926648e+00  3.33599745e+01  3.33599745e+01  3.33599745e+01
  9.90369449e+01  1.28903152e+02  1.28903152e+02  1.28903152e+02
  4.83229691e+02  4.83229691e+02  4.83229691e+02  5.79735310e+02
  1.33506905e+03  1.33506905e+03  1.33506905e+03  2.64866264e+03
  3.02931694e+03  3.02931694e+03  3.02931694e+03  6.64976155e+03
  6.64976155e+03  6.64976155e+03  9.05464453e+03  2.54105364e+04
  7.61532465e+04]
E1 = -728.4059978077911  E_coul = 201.6971325971625
cycle= 2 E= -526.708865210629  delta_E= -0.000731  |g|= 0.0373  |ddm|= 0.0471
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0739872
diis-c [-0.0031116   0.08196223  0.91803777]
  HOMO = -0.578216181070304  LUMO = 0.310301600362591
  mo_energy =
[-1.18568084e+02 -1.22994382e+01 -9.55666225e+00 -9.55666225e+00
 -9.55666225e+00 -1.25595175e+00 -5.78216181e-01 -5.78216181e-01
 -5.78216181e-01  3.10301600e-01  1.03026158e+00  1.03026158e+00
  1.03026158e+00  7.28172871e+00  7.28172871e+00  7.28172871e+00
  8.72540578e+00  3.33978565e+01  3.33978565e+01  3.33978565e+01
  9.90904155e+01  1.28956948e+02  1.28956948e+02  1.28956948e+02
  4.83294593e+02  4.83294593e+02  4.83294593e+02  5.79802595e+02
  1.33513801e+03  1.33513801e+03  1.33513801e+03  2.64873482e+03
  3.02938810e+03  3.02938810e+03  3.02938810e+03  6.64983436e+03
  6.64983436e+03  6.64983436e+03  9.05471811e+03  2.54106105e+04
  7.61533209e+04]
E1 = -728.2682420327596  E_coul = 201.55932373135062
cycle= 3 E= -526.708918301409  delta_E= -5.31e-05  |g|= 0.00584  |ddm|= 0.0142
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0125391
diis-c [-1.58427861e-06 -1.41453181e-03  1.39131918e-01  8.62282614e-01]
  HOMO = -0.579589277430004  LUMO = 0.30989249277751
  mo_energy =
[-1.18577286e+02 -1.23046633e+01 -9.56226727e+00 -9.56226727e+00
 -9.56226727e+00 -1.25740730e+00 -5.79589277e-01 -5.79589277e-01
 -5.79589277e-01  3.09892493e-01  1.02926511e+00  1.02926511e+00
  1.02926511e+00  7.27832473e+00  7.27832473e+00  7.27832473e+00
  8.72161118e+00  3.33922289e+01  3.33922289e+01  3.33922289e+01
  9.90828558e+01  1.28949278e+02  1.28949278e+02  1.28949278e+02
  4.83285500e+02  4.83285500e+02  4.83285500e+02  5.79793145e+02
  1.33512833e+03  1.33512833e+03  1.33512833e+03  2.64872449e+03
  3.02937803e+03  3.02937803e+03  3.02937803e+03  6.64982389e+03
  6.64982389e+03  6.64982389e+03  9.05470741e+03  2.54105996e+04
  7.61533098e+04]
E1 = -728.2877978216699  E_coul = 201.57887791941542
cycle= 4 E= -526.708919902254  delta_E= -1.6e-06  |g|= 0.0002  |ddm|= 0.00191
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000268812
diis-c [-1.06175723e-08  1.68118220e-04 -2.09447799e-02 -1.44668614e-01
  1.16544528e+00]
  HOMO = -0.579596090757546  LUMO = 0.309910420363356
  mo_energy =
[-1.18577308e+02 -1.23046317e+01 -9.56226368e+00 -9.56226368e+00
 -9.56226368e+00 -1.25736178e+00 -5.79596091e-01 -5.79596091e-01
 -5.79596091e-01  3.09910420e-01  1.02926448e+00  1.02926448e+00
  1.02926448e+00  7.27833183e+00  7.27833183e+00  7.27833183e+00
  8.72165310e+00  3.33922317e+01  3.33922317e+01  3.33922317e+01
  9.90828597e+01  1.28949272e+02  1.28949272e+02  1.28949272e+02
  4.83285479e+02  4.83285479e+02  4.83285479e+02  5.79793112e+02
  1.33512830e+03  1.33512830e+03  1.33512830e+03  2.64872442e+03
  3.02937798e+03  3.02937798e+03  3.02937798e+03  6.64982381e+03
  6.64982381e+03  6.64982381e+03  9.05470731e+03  2.54105995e+04
  7.61533097e+04]
E1 = -728.2876331036683  E_coul = 201.57871319052163
cycle= 5 E= -526.708919913147  delta_E= -1.09e-08  |g|= 2.28e-05  |ddm|= 0.000361
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.80493e-05
diis-c [-1.98330337e-10  1.10109361e-05 -1.19979517e-03 -1.00688744e-02
  2.07362647e-03  1.00918403e+00]
  HOMO = -0.579606924800243  LUMO = 0.309908262428177
  mo_energy =
[-1.18577344e+02 -1.23046608e+01 -9.56229435e+00 -9.56229435e+00
 -9.56229435e+00 -1.25737010e+00 -5.79606925e-01 -5.79606925e-01
 -5.79606925e-01  3.09908262e-01  1.02925702e+00  1.02925702e+00
  1.02925702e+00  7.27831014e+00  7.27831014e+00  7.27831014e+00
  8.72163096e+00  3.33922019e+01  3.33922019e+01  3.33922019e+01
  9.90828261e+01  1.28949238e+02  1.28949238e+02  1.28949238e+02
  4.83285443e+02  4.83285443e+02  4.83285443e+02  5.79793075e+02
  1.33512826e+03  1.33512826e+03  1.33512826e+03  2.64872438e+03
  3.02937794e+03  3.02937794e+03  3.02937794e+03  6.64982377e+03
  6.64982377e+03  6.64982377e+03  9.05470727e+03  2.54105994e+04
  7.61533097e+04]
E1 = -728.2877205394418  E_coul = 201.57880062619293
cycle= 6 E= -526.708919913249  delta_E= -1.02e-10  |g|= 2.44e-06  |ddm|= 2.95e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2877205394418  E_coul = 201.57880062619293
  HOMO = -0.579606234218317  LUMO = 0.309908617404303
  mo_energy =
[-1.18577340e+02 -1.23046579e+01 -9.56229135e+00 -9.56229135e+00
 -9.56229135e+00 -1.25736896e+00 -5.79606234e-01 -5.79606234e-01
 -5.79606234e-01  3.09908617e-01  1.02925756e+00  1.02925756e+00
  1.02925756e+00  7.27831204e+00  7.27831204e+00  7.27831204e+00
  8.72163317e+00  3.33922048e+01  3.33922048e+01  3.33922048e+01
  9.90828298e+01  1.28949242e+02  1.28949242e+02  1.28949242e+02
  4.83285447e+02  4.83285447e+02  4.83285447e+02  5.79793079e+02
  1.33512826e+03  1.33512826e+03  1.33512826e+03  2.64872439e+03
  3.02937794e+03  3.02937794e+03  3.02937794e+03  6.64982377e+03
  6.64982377e+03  6.64982377e+03  9.05470728e+03  2.54105994e+04
  7.61533097e+04]
E1 = -728.2877090619028  E_coul = 201.57878914865324
Extra cycle  E= -526.708919913249  delta_E= -5.68e-13  |g|= 6.84e-07  |ddm|= 2.93e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102284.02856340382
E1 = -728.2877090619028  E_coul = 201.57878914865324
init E= -526.708919913249
    CPU time for initialize scf      0.88 sec, wall time      0.23 sec
  HOMO = -0.579606480871613  LUMO = 0.309908559198739
  mo_energy =
[-1.18577341e+02 -1.23046588e+01 -9.56229223e+00 -9.56229223e+00
 -9.56229223e+00 -1.25736918e+00 -5.79606481e-01 -5.79606481e-01
 -5.79606481e-01  3.09908559e-01  1.02925738e+00  1.02925738e+00
  1.02925738e+00  7.27831149e+00  7.27831149e+00  7.27831149e+00
  8.72163256e+00  3.33922040e+01  3.33922040e+01  3.33922040e+01
  9.90828287e+01  1.28949241e+02  1.28949241e+02  1.28949241e+02
  4.83285446e+02  4.83285446e+02  4.83285446e+02  5.79793078e+02
  1.33512826e+03  1.33512826e+03  1.33512826e+03  2.64872439e+03
  3.02937794e+03  3.02937794e+03  3.02937794e+03  6.64982377e+03
  6.64982377e+03  6.64982377e+03  9.05470728e+03  2.54105994e+04
  7.61533097e+04]
E1 = -728.2877118838112  E_coul = 201.57879197056116
cycle= 1 E= -526.70891991325  delta_E= -5.68e-13  |g|= 1.91e-07  |ddm|= 5.19e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2877118838112  E_coul = 201.57879197056116
  HOMO = -0.579606434539541  LUMO = 0.309908580495339
  mo_energy =
[-1.18577341e+02 -1.23046586e+01 -9.56229201e+00 -9.56229201e+00
 -9.56229201e+00 -1.25736911e+00 -5.79606435e-01 -5.79606435e-01
 -5.79606435e-01  3.09908580e-01  1.02925742e+00  1.02925742e+00
  1.02925742e+00  7.27831162e+00  7.27831162e+00  7.27831162e+00
  8.72163272e+00  3.33922042e+01  3.33922042e+01  3.33922042e+01
  9.90828289e+01  1.28949241e+02  1.28949241e+02  1.28949241e+02
  4.83285446e+02  4.83285446e+02  4.83285446e+02  5.79793078e+02
  1.33512826e+03  1.33512826e+03  1.33512826e+03  2.64872439e+03
  3.02937794e+03  3.02937794e+03  3.02937794e+03  6.64982377e+03
  6.64982377e+03  6.64982377e+03  9.05470728e+03  2.54105994e+04
  7.61533097e+04]
E1 = -728.2877110681012  E_coul = 201.57879115485102
Extra cycle  E= -526.70891991325  delta_E= -1.14e-13  |g|= 5.06e-08  |ddm|= 1.44e-07
    CPU time for scf_cycle      1.01 sec, wall time      0.36 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782568e+03
 3.82851151e+02 1.08121224e+02 3.48056399e+01 7.57789476e+00
 2.60739520e+00 4.90661850e-01 9.08720776e-02 1.36278321e+03
 6.64745680e+02 3.00961986e+02 3.14042270e+02 6.16222441e+01
 7.32991527e+00 2.02390921e+01 7.71752536e-01 2.80888655e+00
 2.27072696e-01]
grad_E = [-1.51668024e-06  3.29576599e-06 -1.59220618e-06  6.88303143e-05
 -1.58763013e-05 -5.49164008e-04 -1.35334985e-03  2.51032894e-02
 -7.56395582e-02  7.15260595e-02 -2.84861722e-01 -5.04271929e-07
  5.03913512e-06  2.38049759e-05  2.05248463e-05 -3.26853267e-05
  3.03778165e-04  7.71396545e-05 -3.98680582e-02  8.13103790e-05
  1.52982837e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558576        1
[INPUT] 0    0    [1    /1   ]  7617.52191048        1
[INPUT] 0    0    [1    /1   ]  3617.35086992        1
[INPUT] 0    0    [1    /1   ]  1597.82558554        1
[INPUT] 0    0    [1    /1   ]  382.851167975        1
[INPUT] 0    0    [1    /1   ]  108.122015973        1
[INPUT] 0    0    [1    /1   ]  34.8071826875        1
[INPUT] 0    0    [1    /1   ]  7.53962238258        1
[INPUT] 0    0    [1    /1   ]  2.72291827577        1
[INPUT] 0    0    [1    /1   ]  0.651300607688       1
[INPUT] 0    0    [1    /1   ]  0.31210725122        1
[INPUT] 1    0    [1    /1   ]  1362.78320706        1
[INPUT] 1    0    [1    /1   ]  664.745673095        1
[INPUT] 1    0    [1    /1   ]  300.961954288        1
[INPUT] 1    0    [1    /1   ]  314.042241851        1
[INPUT] 1    0    [1    /1   ]  61.6222910176        1
[INPUT] 1    0    [1    /1   ]  7.32969811547        1
[INPUT] 1    0    [1    /1   ]  20.23896166          1
[INPUT] 1    0    [1    /1   ]  0.804790208558       1
[INPUT] 1    0    [1    /1   ]  2.80883649864        1
[INPUT] 1    0    [1    /1   ]  0.107908886348       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655857620462, 1.0]], [0, [7617.521910476304, 1.0]], [0, [3617.3508699170648, 1.0]], [0, [1597.8255855422476, 1.0]], [0, [382.8511679750723, 1.0]], [0, [108.12201597328097, 1.0]], [0, [34.80718268749891, 1.0]], [0, [7.53962238257787, 1.0]], [0, [2.722918275766872, 1.0]], [0, [0.6513006076876577, 1.0]], [0, [0.312107251220361, 1.0]], [1, [1362.7832070558338, 1.0]], [1, [664.7456730953187, 1.0]], [1, [300.96195428765554, 1.0]], [1, [314.0422418505871, 1.0]], [1, [61.62229101755064, 1.0]], [1, [7.329698115472991, 1.0]], [1, [20.23896165999536, 1.0]], [1, [0.804790208557561, 1.0]], [1, [2.8088364986373757, 1.0]], [1, [0.10790888634792845, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585762]
bas 1, expnt(s) = [7617.52191048]
bas 2, expnt(s) = [3617.35086992]
bas 3, expnt(s) = [1597.82558554]
bas 4, expnt(s) = [382.85116798]
bas 5, expnt(s) = [108.12201597]
bas 6, expnt(s) = [34.80718269]
bas 7, expnt(s) = [7.53962238]
bas 8, expnt(s) = [2.72291828]
bas 9, expnt(s) = [0.65130061]
bas 10, expnt(s) = [0.31210725]
bas 11, expnt(s) = [1362.78320706]
bas 12, expnt(s) = [664.7456731]
bas 13, expnt(s) = [300.96195429]
bas 14, expnt(s) = [314.04224185]
bas 15, expnt(s) = [61.62229102]
bas 16, expnt(s) = [7.32969812]
bas 17, expnt(s) = [20.23896166]
bas 18, expnt(s) = [0.80479021]
bas 19, expnt(s) = [2.8088365]
bas 20, expnt(s) = [0.10790889]
CPU time:        17.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782559e+03 6.38501692e+02
 3.82851168e+02 2.18669145e+02 1.08122016e+02 8.47131099e+01
 3.48071827e+01 3.62048439e+01 7.53962238e+00 1.14954829e+01
 2.72291828e+00 5.35538847e+00 6.51300608e-01 1.83168647e+00
 3.12107251e-01 1.05497682e+00 1.36278321e+03 2.41556017e+04
 6.64745673e+02 9.84699668e+03 3.00961954e+02 3.65699099e+03
 3.14042242e+02 3.85673216e+03 6.16222910e+01 5.03682304e+02
 7.32969812e+00 3.51837400e+01 2.02389617e+01 1.25233257e+02
 8.04790209e-01 2.22375915e+00 2.80883650e+00 1.06082188e+01
 1.07908886e-01 1.80428819e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.792860204618
cond(S) = 103373.14890746585
E1 = -727.4052920107097  E_coul = 202.14084293095794
init E= -525.264449079752
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555767075148504  LUMO = 0.473718687251328
  mo_energy =
[-1.18378235e+02 -1.22588208e+01 -9.50156978e+00 -9.50156978e+00
 -9.50156978e+00 -1.30092304e+00 -5.55767075e-01 -5.55767075e-01
 -5.55767075e-01  4.73718687e-01  4.73718687e-01  4.73718687e-01
  1.12097989e+00  6.98623297e+00  6.98623297e+00  6.98623297e+00
  1.09108204e+01  3.32664037e+01  3.32664037e+01  3.32664037e+01
  1.01119087e+02  1.28942674e+02  1.28942674e+02  1.28942674e+02
  4.83384693e+02  4.83384693e+02  4.83384693e+02  5.81550845e+02
  1.33529385e+03  1.33529385e+03  1.33529385e+03  2.65039541e+03
  3.02961491e+03  3.02961491e+03  3.02961491e+03  6.65017968e+03
  6.65017968e+03  6.65017968e+03  9.05638092e+03  2.54123012e+04
  7.61550247e+04]
E1 = -726.4071869850694  E_coul = 200.03323445215642
cycle= 1 E= -526.373952532913  delta_E= -1.11  |g|= 0.221  |ddm|= 4.99
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.533881
diis-c [-0.28502946  1.        ]
  HOMO = -0.600662940165569  LUMO = 0.479846345410977
  mo_energy =
[-1.18672868e+02 -1.23953351e+01 -9.64997051e+00 -9.64997051e+00
 -9.64997051e+00 -1.35141833e+00 -6.00662940e-01 -6.00662940e-01
 -6.00662940e-01  4.79846345e-01  4.79846345e-01  4.79846345e-01
  1.08746393e+00  6.87957609e+00  6.87957609e+00  6.87957609e+00
  1.08073748e+01  3.31117666e+01  3.31117666e+01  3.31117666e+01
  1.00906410e+02  1.28722329e+02  1.28722329e+02  1.28722329e+02
  4.83090397e+02  4.83090397e+02  4.83090397e+02  5.81220289e+02
  1.33494540e+03  1.33494540e+03  1.33494540e+03  2.64991314e+03
  3.02920079e+03  3.02920079e+03  3.02920079e+03  6.64965262e+03
  6.64965262e+03  6.64965262e+03  9.05577859e+03  2.54116050e+04
  7.61542384e+04]
E1 = -727.2701420861946  E_coul = 200.8944842022711
cycle= 2 E= -526.375657883924  delta_E= -0.00171  |g|= 0.0508  |ddm|= 0.133
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0977826
diis-c [-0.00548084  0.10779483  0.89220517]
  HOMO = -0.585676790608046  LUMO = 0.488101465303296
  mo_energy =
[-1.18583299e+02 -1.23388601e+01 -9.59143024e+00 -9.59143024e+00
 -9.59143024e+00 -1.33369191e+00 -5.85676791e-01 -5.85676791e-01
 -5.85676791e-01  4.88101465e-01  4.88101465e-01  4.88101465e-01
  1.10071222e+00  6.91670761e+00  6.91670761e+00  6.91670761e+00
  1.08499578e+01  3.31700349e+01  3.31700349e+01  3.31700349e+01
  1.00982228e+02  1.28798845e+02  1.28798845e+02  1.28798845e+02
  4.83179005e+02  4.83179005e+02  4.83179005e+02  5.81311381e+02
  1.33503835e+03  1.33503835e+03  1.33503835e+03  2.65000952e+03
  3.02929608e+03  3.02929608e+03  3.02929608e+03  6.64974970e+03
  6.64974970e+03  6.64974970e+03  9.05587650e+03  2.54117035e+04
  7.61543372e+04]
E1 = -726.9054980738829  E_coul = 200.52963598958624
cycle= 3 E= -526.375862084297  delta_E= -0.000204  |g|= 0.0142  |ddm|= 0.0355
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0243317
diis-c [-1.82052988e-05 -1.82123949e-03  1.92802044e-01  8.09019196e-01]
  HOMO = -0.590705012139045  LUMO = 0.485147247417155
  mo_energy =
[-1.18603487e+02 -1.23531936e+01 -9.60619855e+00 -9.60619855e+00
 -9.60619855e+00 -1.34011981e+00 -5.90705012e-01 -5.90705012e-01
 -5.90705012e-01  4.85147247e-01  4.85147247e-01  4.85147247e-01
  1.09554145e+00  6.90591389e+00  6.90591389e+00  6.90591389e+00
  1.08382381e+01  3.31553016e+01  3.31553016e+01  3.31553016e+01
  1.00964453e+02  1.28780904e+02  1.28780904e+02  1.28780904e+02
  4.83158982e+02  4.83158982e+02  4.83158982e+02  5.81290919e+02
  1.33501756e+03  1.33501756e+03  1.33501756e+03  2.64998800e+03
  3.02927483e+03  3.02927483e+03  3.02927483e+03  6.64972801e+03
  6.64972801e+03  6.64972801e+03  9.05585457e+03  2.54116814e+04
  7.61543149e+04]
E1 = -727.0038612053851  E_coul = 200.6279751808328
cycle= 4 E= -526.375886024552  delta_E= -2.39e-05  |g|= 0.00126  |ddm|= 0.0127
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00209532
diis-c [-3.23534738e-07 -2.40463547e-04  9.94781610e-03  1.14037623e-01
  8.76255024e-01]
  HOMO = -0.590215955605755  LUMO = 0.485409687604235
  mo_energy =
[-1.18601876e+02 -1.23517863e+01 -9.60475501e+00 -9.60475501e+00
 -9.60475501e+00 -1.33959171e+00 -5.90215956e-01 -5.90215956e-01
 -5.90215956e-01  4.85409688e-01  4.85409688e-01  4.85409688e-01
  1.09593239e+00  6.90697951e+00  6.90697951e+00  6.90697951e+00
  1.08393674e+01  3.31566940e+01  3.31566940e+01  3.31566940e+01
  1.00965977e+02  1.28782442e+02  1.28782442e+02  1.28782442e+02
  4.83160584e+02  4.83160584e+02  4.83160584e+02  5.81292530e+02
  1.33501918e+03  1.33501918e+03  1.33501918e+03  2.64998964e+03
  3.02927646e+03  3.02927646e+03  3.02927646e+03  6.64972965e+03
  6.64972965e+03  6.64972965e+03  9.05585622e+03  2.54116830e+04
  7.61543166e+04]
E1 = -726.994075866454  E_coul = 200.61818952905813
cycle= 5 E= -526.375886337396  delta_E= -3.13e-07  |g|= 0.000146  |ddm|= 0.00107
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.39398e-05
diis-c [-3.43789226e-09  3.26672884e-05 -3.02105716e-03 -1.86420590e-02
 -5.72229954e-02  1.07885344e+00]
  HOMO = -0.590252136812894  LUMO = 0.485383325403388
  mo_energy =
[-1.18601959e+02 -1.23518659e+01 -9.60482816e+00 -9.60482816e+00
 -9.60482816e+00 -1.33966358e+00 -5.90252137e-01 -5.90252137e-01
 -5.90252137e-01  4.85383325e-01  4.85383325e-01  4.85383325e-01
  1.09586891e+00  6.90691367e+00  6.90691367e+00  6.90691367e+00
  1.08392884e+01  3.31566187e+01  3.31566187e+01  3.31566187e+01
  1.00965892e+02  1.28782360e+02  1.28782360e+02  1.28782360e+02
  4.83160501e+02  4.83160501e+02  4.83160501e+02  5.81292449e+02
  1.33501910e+03  1.33501910e+03  1.33501910e+03  2.64998956e+03
  3.02927638e+03  3.02927638e+03  3.02927638e+03  6.64972958e+03
  6.64972958e+03  6.64972958e+03  9.05585615e+03  2.54116829e+04
  7.61543165e+04]
E1 = -726.9945953080088  E_coul = 200.6187089662415
cycle= 6 E= -526.375886341767  delta_E= -4.37e-09  |g|= 1.87e-05  |ddm|= 0.000342
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.30755e-05
diis-c [-3.06378802e-12 -1.57613865e-06  3.89535128e-04  3.33284265e-03
 -1.33149192e-04 -1.76251025e-01  1.17266337e+00]
  HOMO = -0.590247690284732  LUMO = 0.48538521858076
  mo_energy =
[-1.18601940e+02 -1.23518531e+01 -9.60481333e+00 -9.60481333e+00
 -9.60481333e+00 -1.33966152e+00 -5.90247690e-01 -5.90247690e-01
 -5.90247690e-01  4.85385219e-01  4.85385219e-01  4.85385219e-01
  1.09586996e+00  6.90692399e+00  6.90692399e+00  6.90692399e+00
  1.08392978e+01  3.31566332e+01  3.31566332e+01  3.31566332e+01
  1.00965909e+02  1.28782377e+02  1.28782377e+02  1.28782377e+02
  4.83160520e+02  4.83160520e+02  4.83160520e+02  5.81292469e+02
  1.33501912e+03  1.33501912e+03  1.33501912e+03  2.64998959e+03
  3.02927640e+03  3.02927640e+03  3.02927640e+03  6.64972960e+03
  6.64972960e+03  6.64972960e+03  9.05585617e+03  2.54116830e+04
  7.61543166e+04]
E1 = -726.994499046439  E_coul = 200.6186127046012
cycle= 7 E= -526.375886341838  delta_E= -7.06e-11  |g|= 1.66e-07  |ddm|= 3.17e-05
    CPU time for cycle= 7      0.03 sec, wall time      0.03 sec
E1 = -726.994499046439  E_coul = 200.6186127046012
  HOMO = -0.590247661403514  LUMO = 0.48538523692762
  mo_energy =
[-1.18601940e+02 -1.23518530e+01 -9.60481316e+00 -9.60481316e+00
 -9.60481316e+00 -1.33966150e+00 -5.90247661e-01 -5.90247661e-01
 -5.90247661e-01  4.85385237e-01  4.85385237e-01  4.85385237e-01
  1.09586997e+00  6.90692409e+00  6.90692409e+00  6.90692409e+00
  1.08392979e+01  3.31566333e+01  3.31566333e+01  3.31566333e+01
  1.00965909e+02  1.28782378e+02  1.28782378e+02  1.28782378e+02
  4.83160520e+02  4.83160520e+02  4.83160520e+02  5.81292469e+02
  1.33501912e+03  1.33501912e+03  1.33501912e+03  2.64998959e+03
  3.02927640e+03  3.02927640e+03  3.02927640e+03  6.64972960e+03
  6.64972960e+03  6.64972960e+03  9.05585617e+03  2.54116830e+04
  7.61543166e+04]
E1 = -726.9944979540294  E_coul = 200.61861161219215
Extra cycle  E= -526.375886341837  delta_E= 5.68e-13  |g|= 6.27e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782559e+03
 3.82851168e+02 1.08122016e+02 3.48071827e+01 7.53962238e+00
 2.72291828e+00 6.51300608e-01 3.12107251e-01 1.36278321e+03
 6.64745673e+02 3.00961954e+02 3.14042242e+02 6.16222910e+01
 7.32969812e+00 2.02389617e+01 8.04790209e-01 2.80883650e+00
 1.07908886e-01]
E = -526.3758863418373
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558558        1
[INPUT] 0    0    [1    /1   ]  7617.52191447        1
[INPUT] 0    0    [1    /1   ]  3617.35086798        1
[INPUT] 0    0    [1    /1   ]  1597.82566895        1
[INPUT] 0    0    [1    /1   ]  382.851152693        1
[INPUT] 0    0    [1    /1   ]  108.121303337        1
[INPUT] 0    0    [1    /1   ]  34.8057941503        1
[INPUT] 0    0    [1    /1   ]  7.57406752558        1
[INPUT] 0    0    [1    /1   ]  2.61894750797        1
[INPUT] 0    0    [1    /1   ]  0.506725725397       1
[INPUT] 0    0    [1    /1   ]  0.112995594952       1
[INPUT] 1    0    [1    /1   ]  1362.78320644        1
[INPUT] 1    0    [1    /1   ]  664.745679216        1
[INPUT] 1    0    [1    /1   ]  300.961983205        1
[INPUT] 1    0    [1    /1   ]  314.042266783        1
[INPUT] 1    0    [1    /1   ]  61.6222488235        1
[INPUT] 1    0    [1    /1   ]  7.32989355651        1
[INPUT] 1    0    [1    /1   ]  20.2390790415        1
[INPUT] 1    0    [1    /1   ]  0.775056303293       1
[INPUT] 1    0    [1    /1   ]  2.80888154571        1
[INPUT] 1    0    [1    /1   ]  0.215156315392       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655855780387, 1.0]], [0, [7617.521914472632, 1.0]], [0, [3617.350867983813, 1.0]], [0, [1597.8256689507245, 1.0]], [0, [382.8511526926476, 1.0]], [0, [108.12130333667109, 1.0]], [0, [34.80579415029398, 1.0]], [0, [7.574067525582642, 1.0]], [0, [2.6189475079704994, 1.0]], [0, [0.5067257253971631, 1.0]], [0, [0.11299559495181419, 1.0]], [1, [1362.783206443663, 1.0]], [1, [664.7456792159841, 1.0]], [1, [300.96198320521427, 1.0]], [1, [314.0422667832937, 1.0]], [1, [61.622248823548304, 1.0]], [1, [7.329893556508142, 1.0]], [1, [20.23907904153277, 1.0]], [1, [0.7750563032926131, 1.0]], [1, [2.808881545714792, 1.0]], [1, [0.21515631539191052, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585578]
bas 1, expnt(s) = [7617.52191447]
bas 2, expnt(s) = [3617.35086798]
bas 3, expnt(s) = [1597.82566895]
bas 4, expnt(s) = [382.85115269]
bas 5, expnt(s) = [108.12130334]
bas 6, expnt(s) = [34.80579415]
bas 7, expnt(s) = [7.57406753]
bas 8, expnt(s) = [2.61894751]
bas 9, expnt(s) = [0.50672573]
bas 10, expnt(s) = [0.11299559]
bas 11, expnt(s) = [1362.78320644]
bas 12, expnt(s) = [664.74567922]
bas 13, expnt(s) = [300.96198321]
bas 14, expnt(s) = [314.04226678]
bas 15, expnt(s) = [61.62224882]
bas 16, expnt(s) = [7.32989356]
bas 17, expnt(s) = [20.23907904]
bas 18, expnt(s) = [0.7750563]
bas 19, expnt(s) = [2.80888155]
bas 20, expnt(s) = [0.21515632]
CPU time:        18.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782567e+03 6.38501717e+02
 3.82851153e+02 2.18669138e+02 1.08121303e+02 8.47126911e+01
 3.48057942e+01 3.62037606e+01 7.57406753e+00 1.15348487e+01
 2.61894751e+00 5.20127863e+00 5.06725725e-01 1.51738134e+00
 1.12995595e-01 4.92392194e-01 1.36278321e+03 2.41556016e+04
 6.64745679e+02 9.84699679e+03 3.00961983e+02 3.65699143e+03
 3.14042267e+02 3.85673254e+03 6.16222488e+01 5.03681873e+02
 7.32989356e+00 3.51849127e+01 2.02390790e+01 1.25234165e+02
 7.75056303e-01 2.12153870e+00 2.80888155e+00 1.06084314e+01
 2.15156315e-01 4.27491039e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.990771107140247
cond(S) = 102371.47300505542
E1 = -729.5050927213013  E_coul = 203.1952669655466
init E= -526.309825755755
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.556183160153871  LUMO = 0.398382378403725
  mo_energy =
[-1.18322950e+02 -1.21997895e+01 -9.44498863e+00 -9.44498863e+00
 -9.44498863e+00 -1.23434245e+00 -5.56183160e-01 -5.56183160e-01
 -5.56183160e-01  3.98382378e-01  1.00119395e+00  1.00119395e+00
  1.00119395e+00  7.31300406e+00  7.31300406e+00  7.31300406e+00
  9.01580213e+00  3.34911290e+01  3.34911290e+01  3.34911290e+01
  9.94441041e+01  1.29117094e+02  1.29117094e+02  1.29117094e+02
  4.83527481e+02  4.83527481e+02  4.83527481e+02  5.80228886e+02
  1.33542449e+03  1.33542449e+03  1.33542449e+03  2.64928648e+03
  3.02973939e+03  3.02973939e+03  3.02973939e+03  6.65029790e+03
  6.65029790e+03  6.65029790e+03  9.05537721e+03  2.54113566e+04
  7.61541493e+04]
E1 = -727.6091001762297  E_coul = 200.89579945409056
cycle= 1 E= -526.713300722139  delta_E= -0.403  |g|= 0.195  |ddm|= 0.326
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.55299
diis-c [-0.30579757  1.        ]
  HOMO = -0.596244680069746  LUMO = 0.384348842657526
  mo_energy =
[-1.18653225e+02 -1.23531508e+01 -9.61167594e+00 -9.61167594e+00
 -9.61167594e+00 -1.27921267e+00 -5.96244680e-01 -5.96244680e-01
 -5.96244680e-01  3.84348843e-01  9.73721938e-01  9.73721938e-01
  9.73721938e-01  7.21023570e+00  7.21023570e+00  7.21023570e+00
  8.90369664e+00  3.33195845e+01  3.33195845e+01  3.33195845e+01
  9.92031751e+01  1.28868006e+02  1.28868006e+02  1.28868006e+02
  4.83198107e+02  4.83198107e+02  4.83198107e+02  5.79862001e+02
  1.33503889e+03  1.33503889e+03  1.33503889e+03  2.64876616e+03
  3.02928744e+03  3.02928744e+03  3.02928744e+03  6.64973273e+03
  6.64973273e+03  6.64973273e+03  9.05473668e+03  2.54106222e+04
  7.61533249e+04]
E1 = -728.2335377048529  E_coul = 201.51935551957095
cycle= 2 E= -526.714182185282  delta_E= -0.000881  |g|= 0.041  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.080898
diis-c [-0.00356461  0.09032624  0.90967376]
  HOMO = -0.586396576639604  LUMO = 0.388727798892667
  mo_energy =
[-1.18580496e+02 -1.23120115e+01 -9.56892445e+00 -9.56892445e+00
 -9.56892445e+00 -1.26715694e+00 -5.86396577e-01 -5.86396577e-01
 -5.86396577e-01  3.88727799e-01  9.80942244e-01  9.80942244e-01
  9.80942244e-01  7.23583978e+00  7.23583978e+00  7.23583978e+00
  8.93386444e+00  3.33627386e+01  3.33627386e+01  3.33627386e+01
  9.92629087e+01  1.28928129e+02  1.28928129e+02  1.28928129e+02
  4.83269955e+02  4.83269955e+02  4.83269955e+02  5.79936346e+02
  1.33511500e+03  1.33511500e+03  1.33511500e+03  2.64884568e+03
  3.02936587e+03  3.02936587e+03  3.02936587e+03  6.64981292e+03
  6.64981292e+03  6.64981292e+03  9.05481768e+03  2.54107037e+04
  7.61534068e+04]
E1 = -728.0712198864649  E_coul = 201.3569671753182
cycle= 3 E= -526.714252711147  delta_E= -7.05e-05  |g|= 0.00644  |ddm|= 0.0168
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013677
diis-c [-1.47936730e-06 -1.43389033e-03  1.39200922e-01  8.62232969e-01]
  HOMO = -0.587981295999059  LUMO = 0.388121393649215
  mo_energy =
[-1.18590638e+02 -1.23179024e+01 -9.57521875e+00 -9.57521875e+00
 -9.57521875e+00 -1.26887138e+00 -5.87981296e-01 -5.87981296e-01
 -5.87981296e-01  3.88121394e-01  9.79812599e-01  9.79812599e-01
  9.79812599e-01  7.23194961e+00  7.23194961e+00  7.23194961e+00
  8.92953460e+00  3.33564261e+01  3.33564261e+01  3.33564261e+01
  9.92545209e+01  1.28919622e+02  1.28919622e+02  1.28919622e+02
  4.83259930e+02  4.83259930e+02  4.83259930e+02  5.79925945e+02
  1.33510437e+03  1.33510437e+03  1.33510437e+03  2.64883435e+03
  3.02935482e+03  3.02935482e+03  3.02935482e+03  6.64980144e+03
  6.64980144e+03  6.64980144e+03  9.05480597e+03  2.54106918e+04
  7.61533947e+04]
E1 = -728.0941404339537  E_coul = 201.37988565892095
cycle= 4 E= -526.714254775033  delta_E= -2.06e-06  |g|= 0.000187  |ddm|= 0.00215
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000266578
diis-c [-9.37053556e-09  1.52985178e-04 -1.88596794e-02 -1.31845587e-01
  1.15055228e+00]
  HOMO = -0.587988229399145  LUMO = 0.388140829448528
  mo_energy =
[-1.18590675e+02 -1.23178805e+01 -9.57522453e+00 -9.57522453e+00
 -9.57522453e+00 -1.26883198e+00 -5.87988229e-01 -5.87988229e-01
 -5.87988229e-01  3.88140829e-01  9.79812158e-01  9.79812158e-01
  9.79812158e-01  7.23195068e+00  7.23195068e+00  7.23195068e+00
  8.92956650e+00  3.33564191e+01  3.33564191e+01  3.33564191e+01
  9.92545112e+01  1.28919603e+02  1.28919603e+02  1.28919603e+02
  4.83259894e+02  4.83259894e+02  4.83259894e+02  5.79925897e+02
  1.33510431e+03  1.33510431e+03  1.33510431e+03  2.64883426e+03
  3.02935475e+03  3.02935475e+03  3.02935475e+03  6.64980134e+03
  6.64980134e+03  6.64980134e+03  9.05480586e+03  2.54106917e+04
  7.61533945e+04]
E1 = -728.0940212740729  E_coul = 201.37976649044086
cycle= 5 E= -526.714254783632  delta_E= -8.6e-09  |g|= 2.32e-05  |ddm|= 0.000333
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8786e-05
diis-c [-1.97994140e-10  1.02585888e-05 -1.09376329e-03 -9.17184700e-03
 -6.07615161e-03  1.01633150e+00]
  HOMO = -0.587998661231243  LUMO = 0.388138459334225
  mo_energy =
[-1.18590711e+02 -1.23179088e+01 -9.57525453e+00 -9.57525453e+00
 -9.57525453e+00 -1.26883969e+00 -5.87998661e-01 -5.87998661e-01
 -5.87998661e-01  3.88138459e-01  9.79805203e-01  9.79805203e-01
  9.79805203e-01  7.23192954e+00  7.23192954e+00  7.23192954e+00
  8.92954513e+00  3.33563900e+01  3.33563900e+01  3.33563900e+01
  9.92544784e+01  1.28919570e+02  1.28919570e+02  1.28919570e+02
  4.83259858e+02  4.83259858e+02  4.83259858e+02  5.79925861e+02
  1.33510428e+03  1.33510428e+03  1.33510428e+03  2.64883423e+03
  3.02935472e+03  3.02935472e+03  3.02935472e+03  6.64980130e+03
  6.64980130e+03  6.64980130e+03  9.05480582e+03  2.54106916e+04
  7.61533945e+04]
E1 = -728.0941120910641  E_coul = 201.37985730732444
cycle= 6 E= -526.71425478374  delta_E= -1.08e-10  |g|= 2.62e-06  |ddm|= 3.12e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.0941120910641  E_coul = 201.37985730732444
  HOMO = -0.587997905594819  LUMO = 0.388138969489959
  mo_energy =
[-1.18590706e+02 -1.23179058e+01 -9.57525145e+00 -9.57525145e+00
 -9.57525145e+00 -1.26883841e+00 -5.87997906e-01 -5.87997906e-01
 -5.87997906e-01  3.88138969e-01  9.79805786e-01  9.79805786e-01
  9.79805786e-01  7.23193155e+00  7.23193155e+00  7.23193155e+00
  8.92954748e+00  3.33563930e+01  3.33563930e+01  3.33563930e+01
  9.92544822e+01  1.28919574e+02  1.28919574e+02  1.28919574e+02
  4.83259863e+02  4.83259863e+02  4.83259863e+02  5.79925865e+02
  1.33510428e+03  1.33510428e+03  1.33510428e+03  2.64883423e+03
  3.02935472e+03  3.02935472e+03  3.02935472e+03  6.64980131e+03
  6.64980131e+03  6.64980131e+03  9.05480582e+03  2.54106916e+04
  7.61533945e+04]
E1 = -728.0940997020621  E_coul = 201.37984491832077
Extra cycle  E= -526.714254783741  delta_E= -1.71e-12  |g|= 7.36e-07  |ddm|= 3.61e-06
    CPU time for scf_cycle      0.31 sec, wall time      0.26 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782567e+03
 3.82851153e+02 1.08121303e+02 3.48057942e+01 7.57406753e+00
 2.61894751e+00 5.06725725e-01 1.12995595e-01 1.36278321e+03
 6.64745679e+02 3.00961983e+02 3.14042267e+02 6.16222488e+01
 7.32989356e+00 2.02390790e+01 7.75056303e-01 2.80888155e+00
 2.15156315e-01]
E = -526.7142547837414
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558558        1
[INPUT] 0    0    [1    /1   ]  7617.52191447        1
[INPUT] 0    0    [1    /1   ]  3617.35086798        1
[INPUT] 0    0    [1    /1   ]  1597.82566895        1
[INPUT] 0    0    [1    /1   ]  382.851152693        1
[INPUT] 0    0    [1    /1   ]  108.121303337        1
[INPUT] 0    0    [1    /1   ]  34.8057941503        1
[INPUT] 0    0    [1    /1   ]  7.57406752558        1
[INPUT] 0    0    [1    /1   ]  2.61894750797        1
[INPUT] 0    0    [1    /1   ]  0.506725725397       1
[INPUT] 0    0    [1    /1   ]  0.112995594952       1
[INPUT] 1    0    [1    /1   ]  1362.78320644        1
[INPUT] 1    0    [1    /1   ]  664.745679216        1
[INPUT] 1    0    [1    /1   ]  300.961983205        1
[INPUT] 1    0    [1    /1   ]  314.042266783        1
[INPUT] 1    0    [1    /1   ]  61.6222488235        1
[INPUT] 1    0    [1    /1   ]  7.32989355651        1
[INPUT] 1    0    [1    /1   ]  20.2390790415        1
[INPUT] 1    0    [1    /1   ]  0.775056303293       1
[INPUT] 1    0    [1    /1   ]  2.80888154571        1
[INPUT] 1    0    [1    /1   ]  0.215156315392       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655855780387, 1.0]], [0, [7617.521914472632, 1.0]], [0, [3617.350867983813, 1.0]], [0, [1597.8256689507245, 1.0]], [0, [382.8511526926476, 1.0]], [0, [108.12130333667109, 1.0]], [0, [34.80579415029398, 1.0]], [0, [7.574067525582642, 1.0]], [0, [2.6189475079704994, 1.0]], [0, [0.5067257253971631, 1.0]], [0, [0.11299559495181419, 1.0]], [1, [1362.783206443663, 1.0]], [1, [664.7456792159841, 1.0]], [1, [300.96198320521427, 1.0]], [1, [314.0422667832937, 1.0]], [1, [61.622248823548304, 1.0]], [1, [7.329893556508142, 1.0]], [1, [20.23907904153277, 1.0]], [1, [0.7750563032926131, 1.0]], [1, [2.808881545714792, 1.0]], [1, [0.21515631539191052, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585578]
bas 1, expnt(s) = [7617.52191447]
bas 2, expnt(s) = [3617.35086798]
bas 3, expnt(s) = [1597.82566895]
bas 4, expnt(s) = [382.85115269]
bas 5, expnt(s) = [108.12130334]
bas 6, expnt(s) = [34.80579415]
bas 7, expnt(s) = [7.57406753]
bas 8, expnt(s) = [2.61894751]
bas 9, expnt(s) = [0.50672573]
bas 10, expnt(s) = [0.11299559]
bas 11, expnt(s) = [1362.78320644]
bas 12, expnt(s) = [664.74567922]
bas 13, expnt(s) = [300.96198321]
bas 14, expnt(s) = [314.04226678]
bas 15, expnt(s) = [61.62224882]
bas 16, expnt(s) = [7.32989356]
bas 17, expnt(s) = [20.23907904]
bas 18, expnt(s) = [0.7750563]
bas 19, expnt(s) = [2.80888155]
bas 20, expnt(s) = [0.21515632]
CPU time:        18.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782567e+03 6.38501717e+02
 3.82851153e+02 2.18669138e+02 1.08121303e+02 8.47126911e+01
 3.48057942e+01 3.62037606e+01 7.57406753e+00 1.15348487e+01
 2.61894751e+00 5.20127863e+00 5.06725725e-01 1.51738134e+00
 1.12995595e-01 4.92392194e-01 1.36278321e+03 2.41556016e+04
 6.64745679e+02 9.84699679e+03 3.00961983e+02 3.65699143e+03
 3.14042267e+02 3.85673254e+03 6.16222488e+01 5.03681873e+02
 7.32989356e+00 3.51849127e+01 2.02390790e+01 1.25234165e+02
 7.75056303e-01 2.12153870e+00 2.80888155e+00 1.06084314e+01
 2.15156315e-01 4.27491039e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.990771107140247
cond(S) = 102371.47300505542
E1 = -729.5050927213013  E_coul = 203.1952669655466
init E= -526.309825755755
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.556183160153871  LUMO = 0.398382378403725
  mo_energy =
[-1.18322950e+02 -1.21997895e+01 -9.44498863e+00 -9.44498863e+00
 -9.44498863e+00 -1.23434245e+00 -5.56183160e-01 -5.56183160e-01
 -5.56183160e-01  3.98382378e-01  1.00119395e+00  1.00119395e+00
  1.00119395e+00  7.31300406e+00  7.31300406e+00  7.31300406e+00
  9.01580213e+00  3.34911290e+01  3.34911290e+01  3.34911290e+01
  9.94441041e+01  1.29117094e+02  1.29117094e+02  1.29117094e+02
  4.83527481e+02  4.83527481e+02  4.83527481e+02  5.80228886e+02
  1.33542449e+03  1.33542449e+03  1.33542449e+03  2.64928648e+03
  3.02973939e+03  3.02973939e+03  3.02973939e+03  6.65029790e+03
  6.65029790e+03  6.65029790e+03  9.05537721e+03  2.54113566e+04
  7.61541493e+04]
E1 = -727.6091001762297  E_coul = 200.89579945409056
cycle= 1 E= -526.713300722139  delta_E= -0.403  |g|= 0.195  |ddm|= 0.326
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.55299
diis-c [-0.30579757  1.        ]
  HOMO = -0.596244680069746  LUMO = 0.384348842657526
  mo_energy =
[-1.18653225e+02 -1.23531508e+01 -9.61167594e+00 -9.61167594e+00
 -9.61167594e+00 -1.27921267e+00 -5.96244680e-01 -5.96244680e-01
 -5.96244680e-01  3.84348843e-01  9.73721938e-01  9.73721938e-01
  9.73721938e-01  7.21023570e+00  7.21023570e+00  7.21023570e+00
  8.90369664e+00  3.33195845e+01  3.33195845e+01  3.33195845e+01
  9.92031751e+01  1.28868006e+02  1.28868006e+02  1.28868006e+02
  4.83198107e+02  4.83198107e+02  4.83198107e+02  5.79862001e+02
  1.33503889e+03  1.33503889e+03  1.33503889e+03  2.64876616e+03
  3.02928744e+03  3.02928744e+03  3.02928744e+03  6.64973273e+03
  6.64973273e+03  6.64973273e+03  9.05473668e+03  2.54106222e+04
  7.61533249e+04]
E1 = -728.2335377048529  E_coul = 201.51935551957095
cycle= 2 E= -526.714182185282  delta_E= -0.000881  |g|= 0.041  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.080898
diis-c [-0.00356461  0.09032624  0.90967376]
  HOMO = -0.586396576639604  LUMO = 0.388727798892667
  mo_energy =
[-1.18580496e+02 -1.23120115e+01 -9.56892445e+00 -9.56892445e+00
 -9.56892445e+00 -1.26715694e+00 -5.86396577e-01 -5.86396577e-01
 -5.86396577e-01  3.88727799e-01  9.80942244e-01  9.80942244e-01
  9.80942244e-01  7.23583978e+00  7.23583978e+00  7.23583978e+00
  8.93386444e+00  3.33627386e+01  3.33627386e+01  3.33627386e+01
  9.92629087e+01  1.28928129e+02  1.28928129e+02  1.28928129e+02
  4.83269955e+02  4.83269955e+02  4.83269955e+02  5.79936346e+02
  1.33511500e+03  1.33511500e+03  1.33511500e+03  2.64884568e+03
  3.02936587e+03  3.02936587e+03  3.02936587e+03  6.64981292e+03
  6.64981292e+03  6.64981292e+03  9.05481768e+03  2.54107037e+04
  7.61534068e+04]
E1 = -728.0712198864649  E_coul = 201.3569671753182
cycle= 3 E= -526.714252711147  delta_E= -7.05e-05  |g|= 0.00644  |ddm|= 0.0168
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013677
diis-c [-1.47936730e-06 -1.43389033e-03  1.39200922e-01  8.62232969e-01]
  HOMO = -0.587981295999059  LUMO = 0.388121393649215
  mo_energy =
[-1.18590638e+02 -1.23179024e+01 -9.57521875e+00 -9.57521875e+00
 -9.57521875e+00 -1.26887138e+00 -5.87981296e-01 -5.87981296e-01
 -5.87981296e-01  3.88121394e-01  9.79812599e-01  9.79812599e-01
  9.79812599e-01  7.23194961e+00  7.23194961e+00  7.23194961e+00
  8.92953460e+00  3.33564261e+01  3.33564261e+01  3.33564261e+01
  9.92545209e+01  1.28919622e+02  1.28919622e+02  1.28919622e+02
  4.83259930e+02  4.83259930e+02  4.83259930e+02  5.79925945e+02
  1.33510437e+03  1.33510437e+03  1.33510437e+03  2.64883435e+03
  3.02935482e+03  3.02935482e+03  3.02935482e+03  6.64980144e+03
  6.64980144e+03  6.64980144e+03  9.05480597e+03  2.54106918e+04
  7.61533947e+04]
E1 = -728.0941404339537  E_coul = 201.37988565892095
cycle= 4 E= -526.714254775033  delta_E= -2.06e-06  |g|= 0.000187  |ddm|= 0.00215
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000266578
diis-c [-9.37053556e-09  1.52985178e-04 -1.88596794e-02 -1.31845587e-01
  1.15055228e+00]
  HOMO = -0.587988229399145  LUMO = 0.388140829448528
  mo_energy =
[-1.18590675e+02 -1.23178805e+01 -9.57522453e+00 -9.57522453e+00
 -9.57522453e+00 -1.26883198e+00 -5.87988229e-01 -5.87988229e-01
 -5.87988229e-01  3.88140829e-01  9.79812158e-01  9.79812158e-01
  9.79812158e-01  7.23195068e+00  7.23195068e+00  7.23195068e+00
  8.92956650e+00  3.33564191e+01  3.33564191e+01  3.33564191e+01
  9.92545112e+01  1.28919603e+02  1.28919603e+02  1.28919603e+02
  4.83259894e+02  4.83259894e+02  4.83259894e+02  5.79925897e+02
  1.33510431e+03  1.33510431e+03  1.33510431e+03  2.64883426e+03
  3.02935475e+03  3.02935475e+03  3.02935475e+03  6.64980134e+03
  6.64980134e+03  6.64980134e+03  9.05480586e+03  2.54106917e+04
  7.61533945e+04]
E1 = -728.0940212740729  E_coul = 201.37976649044086
cycle= 5 E= -526.714254783632  delta_E= -8.6e-09  |g|= 2.32e-05  |ddm|= 0.000333
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8786e-05
diis-c [-1.97994140e-10  1.02585888e-05 -1.09376329e-03 -9.17184700e-03
 -6.07615161e-03  1.01633150e+00]
  HOMO = -0.587998661231243  LUMO = 0.388138459334225
  mo_energy =
[-1.18590711e+02 -1.23179088e+01 -9.57525453e+00 -9.57525453e+00
 -9.57525453e+00 -1.26883969e+00 -5.87998661e-01 -5.87998661e-01
 -5.87998661e-01  3.88138459e-01  9.79805203e-01  9.79805203e-01
  9.79805203e-01  7.23192954e+00  7.23192954e+00  7.23192954e+00
  8.92954513e+00  3.33563900e+01  3.33563900e+01  3.33563900e+01
  9.92544784e+01  1.28919570e+02  1.28919570e+02  1.28919570e+02
  4.83259858e+02  4.83259858e+02  4.83259858e+02  5.79925861e+02
  1.33510428e+03  1.33510428e+03  1.33510428e+03  2.64883423e+03
  3.02935472e+03  3.02935472e+03  3.02935472e+03  6.64980130e+03
  6.64980130e+03  6.64980130e+03  9.05480582e+03  2.54106916e+04
  7.61533945e+04]
E1 = -728.0941120910641  E_coul = 201.37985730732444
cycle= 6 E= -526.71425478374  delta_E= -1.08e-10  |g|= 2.62e-06  |ddm|= 3.12e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.0941120910641  E_coul = 201.37985730732444
  HOMO = -0.587997905594819  LUMO = 0.388138969489959
  mo_energy =
[-1.18590706e+02 -1.23179058e+01 -9.57525145e+00 -9.57525145e+00
 -9.57525145e+00 -1.26883841e+00 -5.87997906e-01 -5.87997906e-01
 -5.87997906e-01  3.88138969e-01  9.79805786e-01  9.79805786e-01
  9.79805786e-01  7.23193155e+00  7.23193155e+00  7.23193155e+00
  8.92954748e+00  3.33563930e+01  3.33563930e+01  3.33563930e+01
  9.92544822e+01  1.28919574e+02  1.28919574e+02  1.28919574e+02
  4.83259863e+02  4.83259863e+02  4.83259863e+02  5.79925865e+02
  1.33510428e+03  1.33510428e+03  1.33510428e+03  2.64883423e+03
  3.02935472e+03  3.02935472e+03  3.02935472e+03  6.64980131e+03
  6.64980131e+03  6.64980131e+03  9.05480582e+03  2.54106916e+04
  7.61533945e+04]
E1 = -728.0940997020621  E_coul = 201.37984491832077
Extra cycle  E= -526.714254783741  delta_E= -1.71e-12  |g|= 7.36e-07  |ddm|= 3.61e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102371.47300505542
E1 = -728.0940997020621  E_coul = 201.37984491832077
init E= -526.714254783741
    CPU time for initialize scf      0.88 sec, wall time      0.23 sec
  HOMO = -0.587998177026604  LUMO = 0.388138894959871
  mo_energy =
[-1.18590708e+02 -1.23179067e+01 -9.57525240e+00 -9.57525240e+00
 -9.57525240e+00 -1.26883864e+00 -5.87998177e-01 -5.87998177e-01
 -5.87998177e-01  3.88138895e-01  9.79805600e-01  9.79805600e-01
  9.79805600e-01  7.23193095e+00  7.23193095e+00  7.23193095e+00
  8.92954682e+00  3.33563921e+01  3.33563921e+01  3.33563921e+01
  9.92544810e+01  1.28919572e+02  1.28919572e+02  1.28919572e+02
  4.83259861e+02  4.83259861e+02  4.83259861e+02  5.79925864e+02
  1.33510428e+03  1.33510428e+03  1.33510428e+03  2.64883423e+03
  3.02935472e+03  3.02935472e+03  3.02935472e+03  6.64980131e+03
  6.64980131e+03  6.64980131e+03  9.05480582e+03  2.54106916e+04
  7.61533945e+04]
E1 = -728.0941028802124  E_coul = 201.37984809647153
cycle= 1 E= -526.714254783741  delta_E= 4.55e-13  |g|= 2.12e-07  |ddm|= 6.26e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.0941028802124  E_coul = 201.37984809647153
  HOMO = -0.587998122770797  LUMO = 0.388138926574227
  mo_energy =
[-1.18590707e+02 -1.23179065e+01 -9.57525216e+00 -9.57525216e+00
 -9.57525216e+00 -1.26883856e+00 -5.87998123e-01 -5.87998123e-01
 -5.87998123e-01  3.88138927e-01  9.79805641e-01  9.79805641e-01
  9.79805641e-01  7.23193109e+00  7.23193109e+00  7.23193109e+00
  8.92954700e+00  3.33563923e+01  3.33563923e+01  3.33563923e+01
  9.92544813e+01  1.28919573e+02  1.28919573e+02  1.28919573e+02
  4.83259862e+02  4.83259862e+02  4.83259862e+02  5.79925864e+02
  1.33510428e+03  1.33510428e+03  1.33510428e+03  2.64883423e+03
  3.02935472e+03  3.02935472e+03  3.02935472e+03  6.64980131e+03
  6.64980131e+03  6.64980131e+03  9.05480582e+03  2.54106916e+04
  7.61533945e+04]
E1 = -728.0941019264319  E_coul = 201.3798471426903
Extra cycle  E= -526.714254783742  delta_E= -6.82e-13  |g|= 5.78e-08  |ddm|= 1.83e-07
    CPU time for scf_cycle      1.01 sec, wall time      0.36 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782567e+03
 3.82851153e+02 1.08121303e+02 3.48057942e+01 7.57406753e+00
 2.61894751e+00 5.06725725e-01 1.12995595e-01 1.36278321e+03
 6.64745679e+02 3.00961983e+02 3.14042267e+02 6.16222488e+01
 7.32989356e+00 2.02390790e+01 7.75056303e-01 2.80888155e+00
 2.15156315e-01]
grad_E = [-1.51678106e-06  3.29742343e-06 -1.59109226e-06  6.88987269e-05
 -1.83558501e-05 -5.19377862e-04 -1.50051662e-03  2.34001428e-02
 -7.09316767e-02  2.66937554e-02 -1.96515730e-01 -5.03406856e-07
  5.05918887e-06  2.39289738e-05  2.06299113e-05 -5.36771400e-05
 -1.14214345e-03  2.95183273e-04  5.32313999e-02  3.08147670e-04
 -1.82473683e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558612        1
[INPUT] 0    0    [1    /1   ]  7617.52190281        1
[INPUT] 0    0    [1    /1   ]  3617.35087362        1
[INPUT] 0    0    [1    /1   ]  1597.82542535        1
[INPUT] 0    0    [1    /1   ]  382.851204315        1
[INPUT] 0    0    [1    /1   ]  108.123299942        1
[INPUT] 0    0    [1    /1   ]  34.8102781378        1
[INPUT] 0    0    [1    /1   ]  7.47945556694        1
[INPUT] 0    0    [1    /1   ]  2.90501292729        1
[INPUT] 0    0    [1    /1   ]  0.792947847503       1
[INPUT] 0    0    [1    /1   ]  0.693514214123       1
[INPUT] 1    0    [1    /1   ]  1362.78320823        1
[INPUT] 1    0    [1    /1   ]  664.745661331        1
[INPUT] 1    0    [1    /1   ]  300.961898666        1
[INPUT] 1    0    [1    /1   ]  314.042193896        1
[INPUT] 1    0    [1    /1   ]  61.6224000413        1
[INPUT] 1    0    [1    /1   ]  7.33125891141        1
[INPUT] 1    0    [1    /1   ]  20.2384425722        1
[INPUT] 1    0    [1    /1   ]  0.74368003816        1
[INPUT] 1    0    [1    /1   ]  2.80837646115        1
[INPUT] 1    0    [1    /1   ]  0.318182159905       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655861150553, 1.0]], [0, [7617.521902805602, 1.0]], [0, [3617.350873622806, 1.0]], [0, [1597.8254253504115, 1.0]], [0, [382.8512043151735, 1.0]], [0, [108.12329994160592, 1.0]], [0, [34.810278137752846, 1.0]], [0, [7.479455566943031, 1.0]], [0, [2.90501292729126, 1.0]], [0, [0.7929478475026901, 1.0]], [0, [0.6935142141226844, 1.0]], [1, [1362.7832082286295, 1.0]], [1, [664.7456613308211, 1.0]], [1, [300.9618986661305, 1.0]], [1, [314.04219389617816, 1.0]], [1, [61.62240004125233, 1.0]], [1, [7.331258911405709, 1.0]], [1, [20.23844257217431, 1.0]], [1, [0.7436800381600287, 1.0]], [1, [2.8083764611488173, 1.0]], [1, [0.3181821599053967, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586115]
bas 1, expnt(s) = [7617.52190281]
bas 2, expnt(s) = [3617.35087362]
bas 3, expnt(s) = [1597.82542535]
bas 4, expnt(s) = [382.85120432]
bas 5, expnt(s) = [108.12329994]
bas 6, expnt(s) = [34.81027814]
bas 7, expnt(s) = [7.47945557]
bas 8, expnt(s) = [2.90501293]
bas 9, expnt(s) = [0.79294785]
bas 10, expnt(s) = [0.69351421]
bas 11, expnt(s) = [1362.78320823]
bas 12, expnt(s) = [664.74566133]
bas 13, expnt(s) = [300.96189867]
bas 14, expnt(s) = [314.0421939]
bas 15, expnt(s) = [61.62240004]
bas 16, expnt(s) = [7.33125891]
bas 17, expnt(s) = [20.23844257]
bas 18, expnt(s) = [0.74368004]
bas 19, expnt(s) = [2.80837646]
bas 20, expnt(s) = [0.31818216]
CPU time:        24.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752190e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782543e+03 6.38501644e+02
 3.82851204e+02 2.18669160e+02 1.08123300e+02 8.47138644e+01
 3.48102781e+01 3.62072586e+01 7.47945557e+00 1.14266129e+01
 2.90501293e+00 5.62180887e+00 7.92947848e-01 2.12299266e+00
 6.93514214e-01 1.92002352e+00 1.36278321e+03 2.41556017e+04
 6.64745661e+02 9.84699646e+03 3.00961899e+02 3.65699015e+03
 3.14042194e+02 3.85673142e+03 6.16224000e+01 5.03683418e+02
 7.33125891e+00 3.51931053e+01 2.02384426e+01 1.25229242e+02
 7.43680038e-01 2.01473090e+00 2.80837646e+00 1.06060470e+01
 3.18182160e-01 6.97154724e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.89070437719522
cond(S) = 105627.01414126714
E1 = -728.3297933323094  E_coul = 202.73418608386282
init E= -525.595607248447
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.559251295612944  LUMO = 1.31476423909222
  mo_energy =
[-1.18353786e+02 -1.22353584e+01 -9.47672306e+00 -9.47672306e+00
 -9.47672306e+00 -1.18696374e+00 -5.59251296e-01 -5.59251296e-01
 -5.59251296e-01  1.31476424e+00  1.31476424e+00  1.31476424e+00
  2.46345619e+00  7.57401614e+00  7.57401614e+00  7.57401614e+00
  1.38511045e+01  3.36637481e+01  3.36637481e+01  3.36637481e+01
  1.03948211e+02  1.29234803e+02  1.29234803e+02  1.29234803e+02
  4.83606769e+02  4.83606769e+02  4.83606769e+02  5.83837716e+02
  1.33548881e+03  1.33548881e+03  1.33548881e+03  2.65233689e+03
  3.02979577e+03  3.02979577e+03  3.02979577e+03  6.65034620e+03
  6.65034620e+03  6.65034620e+03  9.05814997e+03  2.54139733e+04
  7.61565830e+04]
E1 = -730.4630476604739  E_coul = 203.96005480811166
cycle= 1 E= -526.502992852362  delta_E= -0.907  |g|= 0.182  |ddm|= 59.3
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.502294
diis-c [-0.25229899  1.        ]
  HOMO = -0.476061422041643  LUMO = 1.38841318305809
  mo_energy =
[-1.18407735e+02 -1.21434936e+01 -9.39269675e+00 -9.39269675e+00
 -9.39269675e+00 -1.11437499e+00 -4.76061422e-01 -4.76061422e-01
 -4.76061422e-01  1.38841318e+00  1.38841318e+00  1.38841318e+00
  2.55878549e+00  7.68108457e+00  7.68108457e+00  7.68108457e+00
  1.39561506e+01  3.37377125e+01  3.37377125e+01  3.37377125e+01
  1.03972050e+02  1.29251671e+02  1.29251671e+02  1.29251671e+02
  4.83552727e+02  4.83552727e+02  4.83552727e+02  5.83748211e+02
  1.33538186e+03  1.33538186e+03  1.33538186e+03  2.65209923e+03
  3.02962491e+03  3.02962491e+03  3.02962491e+03  6.65006453e+03
  6.65006453e+03  6.65006453e+03  9.05779429e+03  2.54135249e+04
  7.61560452e+04]
E1 = -730.3153515501956  E_coul = 203.81153287968107
cycle= 2 E= -526.503818670515  delta_E= -0.000826  |g|= 0.0102  |ddm|= 2.53
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130467
diis-c [-1.64306634e-04  4.81846614e-03  9.95181534e-01]
  HOMO = -0.480657132158273  LUMO = 1.38477668723995
  mo_energy =
[-1.18411358e+02 -1.21560977e+01 -9.40509123e+00 -9.40509123e+00
 -9.40509123e+00 -1.12108797e+00 -4.80657132e-01 -4.80657132e-01
 -4.80657132e-01  1.38477669e+00  1.38477669e+00  1.38477669e+00
  2.55145766e+00  7.67122836e+00  7.67122836e+00  7.67122836e+00
  1.39452087e+01  3.37266177e+01  3.37266177e+01  3.37266177e+01
  1.03964581e+02  1.29244217e+02  1.29244217e+02  1.29244217e+02
  4.83548933e+02  4.83548933e+02  4.83548933e+02  5.83745473e+02
  1.33537968e+03  1.33537968e+03  1.33537968e+03  2.65209855e+03
  3.02962372e+03  3.02962372e+03  3.02962372e+03  6.65006410e+03
  6.65006410e+03  6.65006410e+03  9.05779420e+03  2.54135250e+04
  7.61560454e+04]
E1 = -730.3368861195207  E_coul = 203.83305891452667
cycle= 3 E= -526.503827204994  delta_E= -8.53e-06  |g|= 0.00116  |ddm|= 0.659
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00162594
diis-c [-2.24159581e-06  6.31592422e-04 -4.08147511e-02  1.04018316e+00]
  HOMO = -0.480117359834311  LUMO = 1.38514594960347
  mo_energy =
[-1.18409486e+02 -1.21544441e+01 -9.40333850e+00 -9.40333850e+00
 -9.40333850e+00 -1.12060679e+00 -4.80117360e-01 -4.80117360e-01
 -4.80117360e-01  1.38514595e+00  1.38514595e+00  1.38514595e+00
  2.55198122e+00  7.67244477e+00  7.67244477e+00  7.67244477e+00
  1.39465314e+01  3.37282940e+01  3.37282940e+01  3.37282940e+01
  1.03966402e+02  1.29246064e+02  1.29246064e+02  1.29246064e+02
  4.83550789e+02  4.83550789e+02  4.83550789e+02  5.83747310e+02
  1.33538152e+03  1.33538152e+03  1.33538152e+03  2.65210035e+03
  3.02962553e+03  3.02962553e+03  3.02962553e+03  6.65006589e+03
  6.65006589e+03  6.65006589e+03  9.05779599e+03  2.54135268e+04
  7.61560472e+04]
E1 = -730.3326070519889  E_coul = 203.828779660721
cycle= 4 E= -526.503827391268  delta_E= -1.86e-07  |g|= 0.000299  |ddm|= 0.0602
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000448032
diis-c [-3.01477708e-08 -1.80665974e-04  1.28784432e-02  1.29343381e-01
  8.57958841e-01]
  HOMO = -0.480216392930769  LUMO = 1.38506515847381
  mo_energy =
[-1.18410010e+02 -1.21548171e+01 -9.40371672e+00 -9.40371672e+00
 -9.40371672e+00 -1.12074393e+00 -4.80216393e-01 -4.80216393e-01
 -4.80216393e-01  1.38506516e+00  1.38506516e+00  1.38506516e+00
  2.55182444e+00  7.67220215e+00  7.67220215e+00  7.67220215e+00
  1.39462377e+01  3.37279215e+01  3.37279215e+01  3.37279215e+01
  1.03965938e+02  1.29245598e+02  1.29245598e+02  1.29245598e+02
  4.83550270e+02  4.83550270e+02  4.83550270e+02  5.83746786e+02
  1.33538099e+03  1.33538099e+03  1.33538099e+03  2.65209982e+03
  3.02962500e+03  3.02962500e+03  3.02962500e+03  6.65006536e+03
  6.65006536e+03  6.65006536e+03  9.05779546e+03  2.54135262e+04
  7.61560466e+04]
E1 = -730.3336038341329  E_coul = 203.82977643746935
cycle= 5 E= -526.503827396663  delta_E= -5.4e-09  |g|= 6.02e-05  |ddm|= 0.0114
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010066
diis-c [-3.01862575e-10  1.39794227e-05 -1.37462668e-03 -3.04821218e-02
  7.99605136e-02  9.51882255e-01]
  HOMO = -0.480205870510769  LUMO = 1.38507106937939
  mo_energy =
[-1.18409947e+02 -1.21547793e+01 -9.40367256e+00 -9.40367256e+00
 -9.40367256e+00 -1.12074028e+00 -4.80205871e-01 -4.80205871e-01
 -4.80205871e-01  1.38507107e+00  1.38507107e+00  1.38507107e+00
  2.55182731e+00  7.67222872e+00  7.67222872e+00  7.67222872e+00
  1.39462649e+01  3.37279643e+01  3.37279643e+01  3.37279643e+01
  1.03965991e+02  1.29245653e+02  1.29245653e+02  1.29245653e+02
  4.83550332e+02  4.83550332e+02  4.83550332e+02  5.83746850e+02
  1.33538105e+03  1.33538105e+03  1.33538105e+03  2.65209989e+03
  3.02962507e+03  3.02962507e+03  3.02962507e+03  6.65006543e+03
  6.65006543e+03  6.65006543e+03  9.05779553e+03  2.54135263e+04
  7.61560467e+04]
E1 = -730.3334764460525  E_coul = 203.82964904894973
cycle= 6 E= -526.503827397103  delta_E= -4.39e-10  |g|= 4e-06  |ddm|= 0.00376
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -730.3334764460525  E_coul = 203.82964904894973
  HOMO = -0.480205559870386  LUMO = 1.38507118313807
  mo_energy =
[-1.18409943e+02 -1.21547776e+01 -9.40367036e+00 -9.40367036e+00
 -9.40367036e+00 -1.12074041e+00 -4.80205560e-01 -4.80205560e-01
 -4.80205560e-01  1.38507118e+00  1.38507118e+00  1.38507118e+00
  2.55182703e+00  7.67222978e+00  7.67222978e+00  7.67222978e+00
  1.39462659e+01  3.37279665e+01  3.37279665e+01  3.37279665e+01
  1.03965994e+02  1.29245656e+02  1.29245656e+02  1.29245656e+02
  4.83550336e+02  4.83550336e+02  4.83550336e+02  5.83746854e+02
  1.33538106e+03  1.33538106e+03  1.33538106e+03  2.65209990e+03
  3.02962507e+03  3.02962507e+03  3.02962507e+03  6.65006544e+03
  6.65006544e+03  6.65006544e+03  9.05779554e+03  2.54135263e+04
  7.61560467e+04]
E1 = -730.3334691688951  E_coul = 203.82964177178965
Extra cycle  E= -526.503827397106  delta_E= -2.73e-12  |g|= 7.85e-07  |ddm|= 0.000223
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826559e+04 7.61752190e+03 3.61735087e+03 1.59782543e+03
 3.82851204e+02 1.08123300e+02 3.48102781e+01 7.47945557e+00
 2.90501293e+00 7.92947848e-01 6.93514214e-01 1.36278321e+03
 6.64745661e+02 3.00961899e+02 3.14042194e+02 6.16224000e+01
 7.33125891e+00 2.02384426e+01 7.43680038e-01 2.80837646e+00
 3.18182160e-01]
E = -526.5038273971055
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558569        1
[INPUT] 0    0    [1    /1   ]  7617.52191205        1
[INPUT] 0    0    [1    /1   ]  3617.35086915        1
[INPUT] 0    0    [1    /1   ]  1597.82561837        1
[INPUT] 0    0    [1    /1   ]  382.851163411        1
[INPUT] 0    0    [1    /1   ]  108.121717872        1
[INPUT] 0    0    [1    /1   ]  34.8067251156        1
[INPUT] 0    0    [1    /1   ]  7.55442419412        1
[INPUT] 0    0    [1    /1   ]  2.67834040008        1
[INPUT] 0    0    [1    /1   ]  0.566151152135       1
[INPUT] 0    0    [1    /1   ]  0.233522849868       1
[INPUT] 1    0    [1    /1   ]  1362.78320681        1
[INPUT] 1    0    [1    /1   ]  664.745675503        1
[INPUT] 1    0    [1    /1   ]  300.961965653        1
[INPUT] 1    0    [1    /1   ]  314.04225165         1
[INPUT] 1    0    [1    /1   ]  61.6222802194        1
[INPUT] 1    0    [1    /1   ]  7.33017703144        1
[INPUT] 1    0    [1    /1   ]  20.2389468978        1
[INPUT] 1    0    [1    /1   ]  0.76854196425        1
[INPUT] 1    0    [1    /1   ]  2.80877668008        1
[INPUT] 1    0    [1    /1   ]  0.236546537539       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65585689534, 1.0]], [0, [7617.521912050323, 1.0]], [0, [3617.3508691545803, 1.0]], [0, [1597.8256183744363, 1.0]], [0, [382.8511634105146, 1.0]], [0, [108.12171787171613, 1.0]], [0, [34.80672511560956, 1.0]], [0, [7.554424194119194, 1.0]], [0, [2.678340400082082, 1.0]], [0, [0.5661511521353055, 1.0]], [0, [0.2335228498680057, 1.0]], [1, [1362.7832068142577, 1.0]], [1, [664.7456755026672, 1.0]], [1, [300.9619656532127, 1.0]], [1, [314.04225165047336, 1.0]], [1, [61.622280219362594, 1.0]], [1, [7.330177031443063, 1.0]], [1, [20.238946897787365, 1.0]], [1, [0.7685419642497857, 1.0]], [1, [2.8087766800752982, 1.0]], [1, [0.23654653753907978, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6558569]
bas 1, expnt(s) = [7617.52191205]
bas 2, expnt(s) = [3617.35086915]
bas 3, expnt(s) = [1597.82561837]
bas 4, expnt(s) = [382.85116341]
bas 5, expnt(s) = [108.12171787]
bas 6, expnt(s) = [34.80672512]
bas 7, expnt(s) = [7.55442419]
bas 8, expnt(s) = [2.6783404]
bas 9, expnt(s) = [0.56615115]
bas 10, expnt(s) = [0.23352285]
bas 11, expnt(s) = [1362.78320681]
bas 12, expnt(s) = [664.7456755]
bas 13, expnt(s) = [300.96196565]
bas 14, expnt(s) = [314.04225165]
bas 15, expnt(s) = [61.62228022]
bas 16, expnt(s) = [7.33017703]
bas 17, expnt(s) = [20.2389469]
bas 18, expnt(s) = [0.76854196]
bas 19, expnt(s) = [2.80877668]
bas 20, expnt(s) = [0.23654654]
CPU time:        24.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782562e+03 6.38501702e+02
 3.82851163e+02 2.18669143e+02 1.08121718e+02 8.47129347e+01
 3.48067251e+01 3.62044869e+01 7.55442419e+00 1.15124047e+01
 2.67834040e+00 5.28949674e+00 5.66151152e-01 1.64897595e+00
 2.33522850e-01 8.48715357e-01 1.36278321e+03 2.41556017e+04
 6.64745676e+02 9.84699672e+03 3.00961966e+02 3.65699116e+03
 3.14042252e+02 3.85673231e+03 6.16222802e+01 5.03682194e+02
 7.33017703e+00 3.51866136e+01 2.02389469e+01 1.25233143e+02
 7.68541964e-01 2.09927278e+00 2.80877668e+00 1.06079364e+01
 2.36546538e-01 4.81260410e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99018712892664
cond(S) = 102900.04143276345
E1 = -729.4352423466772  E_coul = 203.13578365739517
init E= -526.299458689282
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.556480336002055  LUMO = 0.84628351199855
  mo_energy =
[-1.18328381e+02 -1.22065238e+01 -9.45029894e+00 -9.45029894e+00
 -9.45029894e+00 -1.23790228e+00 -5.56480336e-01 -5.56480336e-01
 -5.56480336e-01  8.46283512e-01  1.07928582e+00  1.07928582e+00
  1.07928582e+00  7.36763592e+00  7.36763592e+00  7.36763592e+00
  1.00610488e+01  3.35253265e+01  3.35253265e+01  3.35253265e+01
  1.00346207e+02  1.29140344e+02  1.29140344e+02  1.29140344e+02
  4.83543062e+02  4.83543062e+02  4.83543062e+02  5.80944526e+02
  1.33543728e+03  1.33543728e+03  1.33543728e+03  2.64989046e+03
  3.02975062e+03  3.02975062e+03  3.02975062e+03  6.65030757e+03
  6.65030757e+03  6.65030757e+03  9.05592609e+03  2.54118746e+04
  7.61546311e+04]
E1 = -728.0065964968438  E_coul = 201.28658647711777
cycle= 1 E= -526.720010019726  delta_E= -0.421  |g|= 0.189  |ddm|= 0.566
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.548468
diis-c [-0.30081735  1.        ]
  HOMO = -0.579863296479595  LUMO = 0.832809486963566
  mo_energy =
[-1.18626954e+02 -1.23288684e+01 -9.58593353e+00 -9.58593353e+00
 -9.58593353e+00 -1.26393622e+00 -5.79863296e-01 -5.79863296e-01
 -5.79863296e-01  8.32809487e-01  1.06317191e+00  1.06317191e+00
  1.06317191e+00  7.29342054e+00  7.29342054e+00  7.29342054e+00
  9.97801841e+00  3.33843620e+01  3.33843620e+01  3.33843620e+01
  1.00137400e+02  1.28922865e+02  1.28922865e+02  1.28922865e+02
  4.83245432e+02  4.83245432e+02  4.83245432e+02  5.80609132e+02
  1.33508311e+03  1.33508311e+03  1.33508311e+03  2.64940111e+03
  3.02932990e+03  3.02932990e+03  3.02932990e+03  6.64977325e+03
  6.64977325e+03  6.64977325e+03  9.05531618e+03  2.54111705e+04
  7.61538369e+04]
E1 = -728.5208559433486  E_coul = 201.80018798895688
cycle= 2 E= -526.720667954392  delta_E= -0.000658  |g|= 0.0358  |ddm|= 0.0501
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.070935
diis-c [-0.00288492  0.07824525  0.92175475]
  HOMO = -0.5719876722357  LUMO = 0.838767541809594
  mo_energy =
[-1.18563747e+02 -1.22947902e+01 -9.55045326e+00 -9.55045326e+00
 -9.55045326e+00 -1.25450745e+00 -5.71987672e-01 -5.71987672e-01
 -5.71987672e-01  8.38767542e-01  1.06908786e+00  1.06908786e+00
  1.06908786e+00  7.31419334e+00  7.31419334e+00  7.31419334e+00
  1.00028672e+01  3.34203934e+01  3.34203934e+01  3.34203934e+01
  1.00188567e+02  1.28974411e+02  1.28974411e+02  1.28974411e+02
  4.83307841e+02  4.83307841e+02  4.83307841e+02  5.80673865e+02
  1.33514950e+03  1.33514950e+03  1.33514950e+03  2.64947066e+03
  3.02939844e+03  3.02939844e+03  3.02939844e+03  6.64984340e+03
  6.64984340e+03  6.64984340e+03  9.05538708e+03  2.54112419e+04
  7.61539085e+04]
E1 = -728.3919064787483  E_coul = 201.67119229276074
cycle= 3 E= -526.720714185988  delta_E= -4.62e-05  |g|= 0.00563  |ddm|= 0.0143
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0121402
diis-c [-9.79367616e-07 -1.38161876e-03  1.40454088e-01  8.60927530e-01]
  HOMO = -0.573225022815572  LUMO = 0.837943233105089
  mo_energy =
[-1.18572626e+02 -1.22997981e+01 -9.55582316e+00 -9.55582316e+00
 -9.55582316e+00 -1.25586863e+00 -5.73225023e-01 -5.73225023e-01
 -5.73225023e-01  8.37943233e-01  1.06818554e+00  1.06818554e+00
  1.06818554e+00  7.31099232e+00  7.31099232e+00  7.31099232e+00
  9.99924183e+00  3.34150084e+01  3.34150084e+01  3.34150084e+01
  1.00181301e+02  1.28967028e+02  1.28967028e+02  1.28967028e+02
  4.83299068e+02  4.83299068e+02  4.83299068e+02  5.80664746e+02
  1.33514016e+03  1.33514016e+03  1.33514016e+03  2.64946068e+03
  3.02938872e+03  3.02938872e+03  3.02938872e+03  6.64983329e+03
  6.64983329e+03  6.64983329e+03  9.05537675e+03  2.54112314e+04
  7.61538979e+04]
E1 = -728.4108194378526  E_coul = 201.6901038551092
cycle= 4 E= -526.720715582743  delta_E= -1.4e-06  |g|= 0.00013  |ddm|= 0.00185
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000184998
diis-c [-5.07686874e-09  9.92466660e-05 -1.29387874e-02 -9.15302007e-02
  1.10436974e+00]
  HOMO = -0.573208300626569  LUMO = 0.837976013563073
  mo_energy =
[-1.18572613e+02 -1.22997428e+01 -9.55578891e+00 -9.55578891e+00
 -9.55578891e+00 -1.25582487e+00 -5.73208301e-01 -5.73208301e-01
 -5.73208301e-01  8.37976014e-01  1.06820084e+00  1.06820084e+00
  1.06820084e+00  7.31102710e+00  7.31102710e+00  7.31102710e+00
  9.99929880e+00  3.34150420e+01  3.34150420e+01  3.34150420e+01
  1.00181336e+02  1.28967055e+02  1.28967055e+02  1.28967055e+02
  4.83299082e+02  4.83299082e+02  4.83299082e+02  5.80664749e+02
  1.33514016e+03  1.33514016e+03  1.33514016e+03  2.64946065e+03
  3.02938870e+03  3.02938870e+03  3.02938870e+03  6.64983325e+03
  6.64983325e+03  6.64983325e+03  9.05537670e+03  2.54112314e+04
  7.61538978e+04]
E1 = -728.4106686595743  E_coul = 201.6899530741517
cycle= 5 E= -526.720715585423  delta_E= -2.68e-09  |g|= 2.17e-05  |ddm|= 0.000216
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.99877e-05
diis-c [-1.13424869e-10  1.36697251e-05 -1.62906575e-03 -1.36539679e-02
  7.00493734e-02  9.45219991e-01]
  HOMO = -0.573216505541332  LUMO = 0.837972294208059
  mo_energy =
[-1.18572646e+02 -1.22997673e+01 -9.55581529e+00 -9.55581529e+00
 -9.55581529e+00 -1.25583156e+00 -5.73216506e-01 -5.73216506e-01
 -5.73216506e-01  8.37972294e-01  1.06819532e+00  1.06819532e+00
  1.06819532e+00  7.31100916e+00  7.31100916e+00  7.31100916e+00
  9.99928020e+00  3.34150164e+01  3.34150164e+01  3.34150164e+01
  1.00181306e+02  1.28967025e+02  1.28967025e+02  1.28967025e+02
  4.83299049e+02  4.83299049e+02  4.83299049e+02  5.80664716e+02
  1.33514013e+03  1.33514013e+03  1.33514013e+03  2.64946062e+03
  3.02938867e+03  3.02938867e+03  3.02938867e+03  6.64983322e+03
  6.64983322e+03  6.64983322e+03  9.05537666e+03  2.54112313e+04
  7.61538978e+04]
E1 = -728.4107480313986  E_coul = 201.6900324459115
cycle= 6 E= -526.720715585487  delta_E= -6.46e-11  |g|= 2.32e-06  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.4107480313986  E_coul = 201.6900324459115
  HOMO = -0.573216699076633  LUMO = 0.837972563865731
  mo_energy =
[-1.18572646e+02 -1.22997674e+01 -9.55581551e+00 -9.55581551e+00
 -9.55581551e+00 -1.25583125e+00 -5.73216699e-01 -5.73216699e-01
 -5.73216699e-01  8.37972564e-01  1.06819526e+00  1.06819526e+00
  1.06819526e+00  7.31100896e+00  7.31100896e+00  7.31100896e+00
  9.99928019e+00  3.34150162e+01  3.34150162e+01  3.34150162e+01
  1.00181306e+02  1.28967025e+02  1.28967025e+02  1.28967025e+02
  4.83299049e+02  4.83299049e+02  4.83299049e+02  5.80664716e+02
  1.33514013e+03  1.33514013e+03  1.33514013e+03  2.64946062e+03
  3.02938867e+03  3.02938867e+03  3.02938867e+03  6.64983322e+03
  6.64983322e+03  6.64983322e+03  9.05537666e+03  2.54112313e+04
  7.61538978e+04]
E1 = -728.4107470898377  E_coul = 201.6900315043488
Extra cycle  E= -526.720715585489  delta_E= -1.82e-12  |g|= 4.84e-07  |ddm|= 4.92e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782562e+03
 3.82851163e+02 1.08121718e+02 3.48067251e+01 7.55442419e+00
 2.67834040e+00 5.66151152e-01 2.33522850e-01 1.36278321e+03
 6.64745676e+02 3.00961966e+02 3.14042252e+02 6.16222802e+01
 7.33017703e+00 2.02389469e+01 7.68541964e-01 2.80877668e+00
 2.36546538e-01]
E = -526.720715585489
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558569        1
[INPUT] 0    0    [1    /1   ]  7617.52191205        1
[INPUT] 0    0    [1    /1   ]  3617.35086915        1
[INPUT] 0    0    [1    /1   ]  1597.82561837        1
[INPUT] 0    0    [1    /1   ]  382.851163411        1
[INPUT] 0    0    [1    /1   ]  108.121717872        1
[INPUT] 0    0    [1    /1   ]  34.8067251156        1
[INPUT] 0    0    [1    /1   ]  7.55442419412        1
[INPUT] 0    0    [1    /1   ]  2.67834040008        1
[INPUT] 0    0    [1    /1   ]  0.566151152135       1
[INPUT] 0    0    [1    /1   ]  0.233522849868       1
[INPUT] 1    0    [1    /1   ]  1362.78320681        1
[INPUT] 1    0    [1    /1   ]  664.745675503        1
[INPUT] 1    0    [1    /1   ]  300.961965653        1
[INPUT] 1    0    [1    /1   ]  314.04225165         1
[INPUT] 1    0    [1    /1   ]  61.6222802194        1
[INPUT] 1    0    [1    /1   ]  7.33017703144        1
[INPUT] 1    0    [1    /1   ]  20.2389468978        1
[INPUT] 1    0    [1    /1   ]  0.76854196425        1
[INPUT] 1    0    [1    /1   ]  2.80877668008        1
[INPUT] 1    0    [1    /1   ]  0.236546537539       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65585689534, 1.0]], [0, [7617.521912050323, 1.0]], [0, [3617.3508691545803, 1.0]], [0, [1597.8256183744363, 1.0]], [0, [382.8511634105146, 1.0]], [0, [108.12171787171613, 1.0]], [0, [34.80672511560956, 1.0]], [0, [7.554424194119194, 1.0]], [0, [2.678340400082082, 1.0]], [0, [0.5661511521353055, 1.0]], [0, [0.2335228498680057, 1.0]], [1, [1362.7832068142577, 1.0]], [1, [664.7456755026672, 1.0]], [1, [300.9619656532127, 1.0]], [1, [314.04225165047336, 1.0]], [1, [61.622280219362594, 1.0]], [1, [7.330177031443063, 1.0]], [1, [20.238946897787365, 1.0]], [1, [0.7685419642497857, 1.0]], [1, [2.8087766800752982, 1.0]], [1, [0.23654653753907978, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6558569]
bas 1, expnt(s) = [7617.52191205]
bas 2, expnt(s) = [3617.35086915]
bas 3, expnt(s) = [1597.82561837]
bas 4, expnt(s) = [382.85116341]
bas 5, expnt(s) = [108.12171787]
bas 6, expnt(s) = [34.80672512]
bas 7, expnt(s) = [7.55442419]
bas 8, expnt(s) = [2.6783404]
bas 9, expnt(s) = [0.56615115]
bas 10, expnt(s) = [0.23352285]
bas 11, expnt(s) = [1362.78320681]
bas 12, expnt(s) = [664.7456755]
bas 13, expnt(s) = [300.96196565]
bas 14, expnt(s) = [314.04225165]
bas 15, expnt(s) = [61.62228022]
bas 16, expnt(s) = [7.33017703]
bas 17, expnt(s) = [20.2389469]
bas 18, expnt(s) = [0.76854196]
bas 19, expnt(s) = [2.80877668]
bas 20, expnt(s) = [0.23654654]
CPU time:        24.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782562e+03 6.38501702e+02
 3.82851163e+02 2.18669143e+02 1.08121718e+02 8.47129347e+01
 3.48067251e+01 3.62044869e+01 7.55442419e+00 1.15124047e+01
 2.67834040e+00 5.28949674e+00 5.66151152e-01 1.64897595e+00
 2.33522850e-01 8.48715357e-01 1.36278321e+03 2.41556017e+04
 6.64745676e+02 9.84699672e+03 3.00961966e+02 3.65699116e+03
 3.14042252e+02 3.85673231e+03 6.16222802e+01 5.03682194e+02
 7.33017703e+00 3.51866136e+01 2.02389469e+01 1.25233143e+02
 7.68541964e-01 2.09927278e+00 2.80877668e+00 1.06079364e+01
 2.36546538e-01 4.81260410e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99018712892664
cond(S) = 102900.04143276345
E1 = -729.4352423466772  E_coul = 203.13578365739517
init E= -526.299458689282
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.556480336002055  LUMO = 0.84628351199855
  mo_energy =
[-1.18328381e+02 -1.22065238e+01 -9.45029894e+00 -9.45029894e+00
 -9.45029894e+00 -1.23790228e+00 -5.56480336e-01 -5.56480336e-01
 -5.56480336e-01  8.46283512e-01  1.07928582e+00  1.07928582e+00
  1.07928582e+00  7.36763592e+00  7.36763592e+00  7.36763592e+00
  1.00610488e+01  3.35253265e+01  3.35253265e+01  3.35253265e+01
  1.00346207e+02  1.29140344e+02  1.29140344e+02  1.29140344e+02
  4.83543062e+02  4.83543062e+02  4.83543062e+02  5.80944526e+02
  1.33543728e+03  1.33543728e+03  1.33543728e+03  2.64989046e+03
  3.02975062e+03  3.02975062e+03  3.02975062e+03  6.65030757e+03
  6.65030757e+03  6.65030757e+03  9.05592609e+03  2.54118746e+04
  7.61546311e+04]
E1 = -728.0065964968438  E_coul = 201.28658647711777
cycle= 1 E= -526.720010019726  delta_E= -0.421  |g|= 0.189  |ddm|= 0.566
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.548468
diis-c [-0.30081735  1.        ]
  HOMO = -0.579863296479595  LUMO = 0.832809486963566
  mo_energy =
[-1.18626954e+02 -1.23288684e+01 -9.58593353e+00 -9.58593353e+00
 -9.58593353e+00 -1.26393622e+00 -5.79863296e-01 -5.79863296e-01
 -5.79863296e-01  8.32809487e-01  1.06317191e+00  1.06317191e+00
  1.06317191e+00  7.29342054e+00  7.29342054e+00  7.29342054e+00
  9.97801841e+00  3.33843620e+01  3.33843620e+01  3.33843620e+01
  1.00137400e+02  1.28922865e+02  1.28922865e+02  1.28922865e+02
  4.83245432e+02  4.83245432e+02  4.83245432e+02  5.80609132e+02
  1.33508311e+03  1.33508311e+03  1.33508311e+03  2.64940111e+03
  3.02932990e+03  3.02932990e+03  3.02932990e+03  6.64977325e+03
  6.64977325e+03  6.64977325e+03  9.05531618e+03  2.54111705e+04
  7.61538369e+04]
E1 = -728.5208559433486  E_coul = 201.80018798895688
cycle= 2 E= -526.720667954392  delta_E= -0.000658  |g|= 0.0358  |ddm|= 0.0501
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.070935
diis-c [-0.00288492  0.07824525  0.92175475]
  HOMO = -0.5719876722357  LUMO = 0.838767541809594
  mo_energy =
[-1.18563747e+02 -1.22947902e+01 -9.55045326e+00 -9.55045326e+00
 -9.55045326e+00 -1.25450745e+00 -5.71987672e-01 -5.71987672e-01
 -5.71987672e-01  8.38767542e-01  1.06908786e+00  1.06908786e+00
  1.06908786e+00  7.31419334e+00  7.31419334e+00  7.31419334e+00
  1.00028672e+01  3.34203934e+01  3.34203934e+01  3.34203934e+01
  1.00188567e+02  1.28974411e+02  1.28974411e+02  1.28974411e+02
  4.83307841e+02  4.83307841e+02  4.83307841e+02  5.80673865e+02
  1.33514950e+03  1.33514950e+03  1.33514950e+03  2.64947066e+03
  3.02939844e+03  3.02939844e+03  3.02939844e+03  6.64984340e+03
  6.64984340e+03  6.64984340e+03  9.05538708e+03  2.54112419e+04
  7.61539085e+04]
E1 = -728.3919064787483  E_coul = 201.67119229276074
cycle= 3 E= -526.720714185988  delta_E= -4.62e-05  |g|= 0.00563  |ddm|= 0.0143
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0121402
diis-c [-9.79367616e-07 -1.38161876e-03  1.40454088e-01  8.60927530e-01]
  HOMO = -0.573225022815572  LUMO = 0.837943233105089
  mo_energy =
[-1.18572626e+02 -1.22997981e+01 -9.55582316e+00 -9.55582316e+00
 -9.55582316e+00 -1.25586863e+00 -5.73225023e-01 -5.73225023e-01
 -5.73225023e-01  8.37943233e-01  1.06818554e+00  1.06818554e+00
  1.06818554e+00  7.31099232e+00  7.31099232e+00  7.31099232e+00
  9.99924183e+00  3.34150084e+01  3.34150084e+01  3.34150084e+01
  1.00181301e+02  1.28967028e+02  1.28967028e+02  1.28967028e+02
  4.83299068e+02  4.83299068e+02  4.83299068e+02  5.80664746e+02
  1.33514016e+03  1.33514016e+03  1.33514016e+03  2.64946068e+03
  3.02938872e+03  3.02938872e+03  3.02938872e+03  6.64983329e+03
  6.64983329e+03  6.64983329e+03  9.05537675e+03  2.54112314e+04
  7.61538979e+04]
E1 = -728.4108194378526  E_coul = 201.6901038551092
cycle= 4 E= -526.720715582743  delta_E= -1.4e-06  |g|= 0.00013  |ddm|= 0.00185
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000184998
diis-c [-5.07686874e-09  9.92466660e-05 -1.29387874e-02 -9.15302007e-02
  1.10436974e+00]
  HOMO = -0.573208300626569  LUMO = 0.837976013563073
  mo_energy =
[-1.18572613e+02 -1.22997428e+01 -9.55578891e+00 -9.55578891e+00
 -9.55578891e+00 -1.25582487e+00 -5.73208301e-01 -5.73208301e-01
 -5.73208301e-01  8.37976014e-01  1.06820084e+00  1.06820084e+00
  1.06820084e+00  7.31102710e+00  7.31102710e+00  7.31102710e+00
  9.99929880e+00  3.34150420e+01  3.34150420e+01  3.34150420e+01
  1.00181336e+02  1.28967055e+02  1.28967055e+02  1.28967055e+02
  4.83299082e+02  4.83299082e+02  4.83299082e+02  5.80664749e+02
  1.33514016e+03  1.33514016e+03  1.33514016e+03  2.64946065e+03
  3.02938870e+03  3.02938870e+03  3.02938870e+03  6.64983325e+03
  6.64983325e+03  6.64983325e+03  9.05537670e+03  2.54112314e+04
  7.61538978e+04]
E1 = -728.4106686595743  E_coul = 201.6899530741517
cycle= 5 E= -526.720715585423  delta_E= -2.68e-09  |g|= 2.17e-05  |ddm|= 0.000216
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.99877e-05
diis-c [-1.13424869e-10  1.36697251e-05 -1.62906575e-03 -1.36539679e-02
  7.00493734e-02  9.45219991e-01]
  HOMO = -0.573216505541332  LUMO = 0.837972294208059
  mo_energy =
[-1.18572646e+02 -1.22997673e+01 -9.55581529e+00 -9.55581529e+00
 -9.55581529e+00 -1.25583156e+00 -5.73216506e-01 -5.73216506e-01
 -5.73216506e-01  8.37972294e-01  1.06819532e+00  1.06819532e+00
  1.06819532e+00  7.31100916e+00  7.31100916e+00  7.31100916e+00
  9.99928020e+00  3.34150164e+01  3.34150164e+01  3.34150164e+01
  1.00181306e+02  1.28967025e+02  1.28967025e+02  1.28967025e+02
  4.83299049e+02  4.83299049e+02  4.83299049e+02  5.80664716e+02
  1.33514013e+03  1.33514013e+03  1.33514013e+03  2.64946062e+03
  3.02938867e+03  3.02938867e+03  3.02938867e+03  6.64983322e+03
  6.64983322e+03  6.64983322e+03  9.05537666e+03  2.54112313e+04
  7.61538978e+04]
E1 = -728.4107480313986  E_coul = 201.6900324459115
cycle= 6 E= -526.720715585487  delta_E= -6.46e-11  |g|= 2.32e-06  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.4107480313986  E_coul = 201.6900324459115
  HOMO = -0.573216699076633  LUMO = 0.837972563865731
  mo_energy =
[-1.18572646e+02 -1.22997674e+01 -9.55581551e+00 -9.55581551e+00
 -9.55581551e+00 -1.25583125e+00 -5.73216699e-01 -5.73216699e-01
 -5.73216699e-01  8.37972564e-01  1.06819526e+00  1.06819526e+00
  1.06819526e+00  7.31100896e+00  7.31100896e+00  7.31100896e+00
  9.99928019e+00  3.34150162e+01  3.34150162e+01  3.34150162e+01
  1.00181306e+02  1.28967025e+02  1.28967025e+02  1.28967025e+02
  4.83299049e+02  4.83299049e+02  4.83299049e+02  5.80664716e+02
  1.33514013e+03  1.33514013e+03  1.33514013e+03  2.64946062e+03
  3.02938867e+03  3.02938867e+03  3.02938867e+03  6.64983322e+03
  6.64983322e+03  6.64983322e+03  9.05537666e+03  2.54112313e+04
  7.61538978e+04]
E1 = -728.4107470898377  E_coul = 201.6900315043488
Extra cycle  E= -526.720715585489  delta_E= -1.82e-12  |g|= 4.84e-07  |ddm|= 4.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102900.04143276345
E1 = -728.4107470898377  E_coul = 201.6900315043488
init E= -526.720715585489
    CPU time for initialize scf      0.88 sec, wall time      0.23 sec
  HOMO = -0.573216742041485  LUMO = 0.837972618457432
  mo_energy =
[-1.18572646e+02 -1.22997675e+01 -9.55581559e+00 -9.55581559e+00
 -9.55581559e+00 -1.25583119e+00 -5.73216742e-01 -5.73216742e-01
 -5.73216742e-01  8.37972618e-01  1.06819525e+00  1.06819525e+00
  1.06819525e+00  7.31100890e+00  7.31100890e+00  7.31100890e+00
  9.99928018e+00  3.34150161e+01  3.34150161e+01  3.34150161e+01
  1.00181306e+02  1.28967025e+02  1.28967025e+02  1.28967025e+02
  4.83299049e+02  4.83299049e+02  4.83299049e+02  5.80664716e+02
  1.33514013e+03  1.33514013e+03  1.33514013e+03  2.64946062e+03
  3.02938867e+03  3.02938867e+03  3.02938867e+03  6.64983322e+03
  6.64983322e+03  6.64983322e+03  9.05537666e+03  2.54112313e+04
  7.61538978e+04]
E1 = -728.4107470582527  E_coul = 201.69003147276456
cycle= 1 E= -526.720715585488  delta_E= 7.96e-13  |g|= 1.01e-07  |ddm|= 9.83e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.4107470582527  E_coul = 201.69003147276456
  HOMO = -0.573216747874779  LUMO = 0.837972631861804
  mo_energy =
[-1.18572646e+02 -1.22997675e+01 -9.55581560e+00 -9.55581560e+00
 -9.55581560e+00 -1.25583118e+00 -5.73216748e-01 -5.73216748e-01
 -5.73216748e-01  8.37972632e-01  1.06819525e+00  1.06819525e+00
  1.06819525e+00  7.31100889e+00  7.31100889e+00  7.31100889e+00
  9.99928018e+00  3.34150161e+01  3.34150161e+01  3.34150161e+01
  1.00181306e+02  1.28967025e+02  1.28967025e+02  1.28967025e+02
  4.83299049e+02  4.83299049e+02  4.83299049e+02  5.80664716e+02
  1.33514013e+03  1.33514013e+03  1.33514013e+03  2.64946062e+03
  3.02938867e+03  3.02938867e+03  3.02938867e+03  6.64983322e+03
  6.64983322e+03  6.64983322e+03  9.05537666e+03  2.54112313e+04
  7.61538978e+04]
E1 = -728.410747010204  E_coul = 201.69003142471513
Extra cycle  E= -526.720715585489  delta_E= -6.82e-13  |g|= 2.06e-08  |ddm|= 2.02e-07
    CPU time for scf_cycle      1.01 sec, wall time      0.36 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782562e+03
 3.82851163e+02 1.08121718e+02 3.48067251e+01 7.55442419e+00
 2.67834040e+00 5.66151152e-01 2.33522850e-01 1.36278321e+03
 6.64745676e+02 3.00961966e+02 3.14042252e+02 6.16222802e+01
 7.33017703e+00 2.02389469e+01 7.68541964e-01 2.80877668e+00
 2.36546538e-01]
grad_E = [-1.51724128e-06  3.30468951e-06 -1.58604898e-06  6.91967008e-05
 -2.89924124e-05 -3.91258398e-04 -2.10813184e-03  1.72924338e-02
 -5.55575373e-02 -8.48858224e-02  1.11473432e-01 -5.05441209e-07
  5.01853956e-06  2.36761983e-05  2.04156027e-05 -1.10213809e-05
  1.63666440e-03 -1.37348240e-04 -1.03353818e-01 -2.39993706e-05
  3.60568674e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558585        1
[INPUT] 0    0    [1    /1   ]  7617.52190849        1
[INPUT] 0    0    [1    /1   ]  3617.35087087        1
[INPUT] 0    0    [1    /1   ]  1597.82554378        1
[INPUT] 0    0    [1    /1   ]  382.851193201        1
[INPUT] 0    0    [1    /1   ]  108.122158259        1
[INPUT] 0    0    [1    /1   ]  34.8089247815        1
[INPUT] 0    0    [1    /1   ]  7.53554962291        1
[INPUT] 0    0    [1    /1   ]  2.73798964042        1
[INPUT] 0    0    [1    /1   ]  0.577564510714       1
[INPUT] 0    0    [1    /1   ]  0.218974883018       1
[INPUT] 1    0    [1    /1   ]  1362.78320736        1
[INPUT] 1    0    [1    /1   ]  664.745670064        1
[INPUT] 1    0    [1    /1   ]  300.961939958        1
[INPUT] 1    0    [1    /1   ]  314.042229496        1
[INPUT] 1    0    [1    /1   ]  61.6223194724        1
[INPUT] 1    0    [1    /1   ]  7.33023699466        1
[INPUT] 1    0    [1    /1   ]  20.23881407          1
[INPUT] 1    0    [1    /1   ]  0.772963116779       1
[INPUT] 1    0    [1    /1   ]  2.80853294906        1
[INPUT] 1    0    [1    /1   ]  0.222328403828       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655858531863, 1.0]], [0, [7617.521908486754, 1.0]], [0, [3617.3508708662757, 1.0]], [0, [1597.8255437781124, 1.0]], [0, [382.85119320136454, 1.0]], [0, [108.12215825914853, 1.0]], [0, [34.808924781538806, 1.0]], [0, [7.535549622906951, 1.0]], [0, [2.737989640416898, 1.0]], [0, [0.5775645107142552, 1.0]], [0, [0.21897488301798054, 1.0]], [1, [1362.7832073581105, 1.0]], [1, [664.7456700643686, 1.0]], [1, [300.96193995787667, 1.0]], [1, [314.04222949616894, 1.0]], [1, [61.62231947241123, 1.0]], [1, [7.33023699465508, 1.0]], [1, [20.238814070043578, 1.0]], [1, [0.772963116778884, 1.0]], [1, [2.8085329490641344, 1.0]], [1, [0.2223284038283488, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585853]
bas 1, expnt(s) = [7617.52190849]
bas 2, expnt(s) = [3617.35087087]
bas 3, expnt(s) = [1597.82554378]
bas 4, expnt(s) = [382.8511932]
bas 5, expnt(s) = [108.12215826]
bas 6, expnt(s) = [34.80892478]
bas 7, expnt(s) = [7.53554962]
bas 8, expnt(s) = [2.73798964]
bas 9, expnt(s) = [0.57756451]
bas 10, expnt(s) = [0.21897488]
bas 11, expnt(s) = [1362.78320736]
bas 12, expnt(s) = [664.74567006]
bas 13, expnt(s) = [300.96193996]
bas 14, expnt(s) = [314.0422295]
bas 15, expnt(s) = [61.62231947]
bas 16, expnt(s) = [7.33023699]
bas 17, expnt(s) = [20.23881407]
bas 18, expnt(s) = [0.77296312]
bas 19, expnt(s) = [2.80853295]
bas 20, expnt(s) = [0.2223284]
CPU time:        30.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782554e+03 6.38501680e+02
 3.82851193e+02 2.18669156e+02 1.08122158e+02 8.47131935e+01
 3.48089248e+01 3.62062029e+01 7.53554962e+00 1.14908254e+01
 2.73798964e+00 5.37760470e+00 5.77564511e-01 1.67384561e+00
 2.18974883e-01 8.08743404e-01 1.36278321e+03 2.41556017e+04
 6.64745670e+02 9.84699662e+03 3.00961940e+02 3.65699077e+03
 3.14042229e+02 3.85673197e+03 6.16223195e+01 5.03682595e+02
 7.33023699e+00 3.51869734e+01 2.02388141e+01 1.25232116e+02
 7.72963117e-01 2.11437910e+00 2.80853295e+00 1.06067858e+01
 2.22328404e-01 4.45377302e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99354746464138
cond(S) = 102896.09705905971
E1 = -729.4891695216388  E_coul = 203.15829173135214
init E= -526.330877790287
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.556652245887925  LUMO = 0.814971688248006
  mo_energy =
[-1.18326981e+02 -1.22052743e+01 -9.44833538e+00 -9.44833538e+00
 -9.44833538e+00 -1.23913526e+00 -5.56652246e-01 -5.56652246e-01
 -5.56652246e-01  8.14971688e-01  1.02871594e+00  1.02871594e+00
  1.02871594e+00  7.33044664e+00  7.33044664e+00  7.33044664e+00
  1.01848698e+01  3.35003192e+01  3.35003192e+01  3.35003192e+01
  1.00528118e+02  1.29122561e+02  1.29122561e+02  1.29122561e+02
  4.83529754e+02  4.83529754e+02  4.83529754e+02  5.81095795e+02
  1.33542616e+03  1.33542616e+03  1.33542616e+03  2.65002007e+03
  3.02974038e+03  3.02974038e+03  3.02974038e+03  6.65029831e+03
  6.65029831e+03  6.65029831e+03  9.05604433e+03  2.54119863e+04
  7.61547351e+04]
E1 = -727.7633825559143  E_coul = 201.03527435166288
cycle= 1 E= -526.728108204251  delta_E= -0.397  |g|= 0.191  |ddm|= 0.33
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.551476
diis-c [-0.30412585  1.        ]
  HOMO = -0.590608208642021  LUMO = 0.792866281399096
  mo_energy =
[-1.18645007e+02 -1.23462178e+01 -9.60220624e+00 -9.60220624e+00
 -9.60220624e+00 -1.27728292e+00 -5.90608209e-01 -5.90608209e-01
 -5.90608209e-01  7.92866281e-01  1.00498279e+00  1.00498279e+00
  1.00498279e+00  7.23879002e+00  7.23879002e+00  7.23879002e+00
  1.00831348e+01  3.33410437e+01  3.33410437e+01  3.33410437e+01
  1.00300946e+02  1.28886115e+02  1.28886115e+02  1.28886115e+02
  4.83212841e+02  4.83212841e+02  4.83212841e+02  5.80740765e+02
  1.33505224e+03  1.33505224e+03  1.33505224e+03  2.64951082e+03
  3.02929982e+03  3.02929982e+03  3.02929982e+03  6.64974400e+03
  6.64974400e+03  6.64974400e+03  9.05541438e+03  2.54112621e+04
  7.61539208e+04]
E1 = -728.35427562003  E_coul = 201.62538548084893
cycle= 2 E= -526.728890139181  delta_E= -0.000782  |g|= 0.0391  |ddm|= 0.0563
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0775524
diis-c [-0.0033267   0.08636218  0.91363782]
  HOMO = -0.581288271363269  LUMO = 0.799762058793193
  mo_energy =
[-1.18575253e+02 -1.23072132e+01 -9.56159821e+00 -9.56159821e+00
 -9.56159821e+00 -1.26615434e+00 -5.81288271e-01 -5.81288271e-01
 -5.81288271e-01  7.99762059e-01  1.01182878e+00  1.01182878e+00
  1.01182878e+00  7.26301234e+00  7.26301234e+00  7.26301234e+00
  1.01119151e+01  3.33820747e+01  3.33820747e+01  3.33820747e+01
  1.00357995e+02  1.28943606e+02  1.28943606e+02  1.28943606e+02
  4.83281746e+02  4.83281746e+02  4.83281746e+02  5.80812100e+02
  1.33512532e+03  1.33512532e+03  1.33512532e+03  2.64958725e+03
  3.02937517e+03  3.02937517e+03  3.02937517e+03  6.64982108e+03
  6.64982108e+03  6.64982108e+03  9.05549226e+03  2.54113406e+04
  7.61539995e+04]
E1 = -728.2020810399  E_coul = 201.47312910263065
cycle= 3 E= -526.728951937269  delta_E= -6.18e-05  |g|= 0.00621  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131856
diis-c [-8.52111965e-07 -1.36101639e-03  1.40178111e-01  8.61182906e-01]
  HOMO = -0.58274876554012  LUMO = 0.798769569336318
  mo_energy =
[-1.18585067e+02 -1.23128900e+01 -9.56764978e+00 -9.56764978e+00
 -9.56764978e+00 -1.26779082e+00 -5.82748766e-01 -5.82748766e-01
 -5.82748766e-01  7.98769569e-01  1.01077916e+00  1.01077916e+00
  1.01077916e+00  7.25931990e+00  7.25931990e+00  7.25931990e+00
  1.01077203e+01  3.33760086e+01  3.33760086e+01  3.33760086e+01
  1.00349903e+02  1.28935389e+02  1.28935389e+02  1.28935389e+02
  4.83272046e+02  4.83272046e+02  4.83272046e+02  5.80802038e+02
  1.33511502e+03  1.33511502e+03  1.33511502e+03  2.64957629e+03
  3.02936447e+03  3.02936447e+03  3.02936447e+03  6.64980998e+03
  6.64980998e+03  6.64980998e+03  9.05548093e+03  2.54113291e+04
  7.61539878e+04]
E1 = -728.2242126238384  E_coul = 201.49525884933323
cycle= 4 E= -526.728953774505  delta_E= -1.84e-06  |g|= 0.000111  |ddm|= 0.00217
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169692
diis-c [-4.54823939e-09  8.91241043e-05 -1.17531350e-02 -8.26625005e-02
  1.09432651e+00]
  HOMO = -0.582734907813153  LUMO = 0.798796507945233
  mo_energy =
[-1.18585060e+02 -1.23128410e+01 -9.56761958e+00 -9.56761958e+00
 -9.56761958e+00 -1.26775377e+00 -5.82734908e-01 -5.82734908e-01
 -5.82734908e-01  7.98796508e-01  1.01079167e+00  1.01079167e+00
  1.01079167e+00  7.25934954e+00  7.25934954e+00  7.25934954e+00
  1.01077691e+01  3.33760372e+01  3.33760372e+01  3.33760372e+01
  1.00349931e+02  1.28935410e+02  1.28935410e+02  1.28935410e+02
  4.83272054e+02  4.83272054e+02  4.83272054e+02  5.80802037e+02
  1.33511502e+03  1.33511502e+03  1.33511502e+03  2.64957626e+03
  3.02936445e+03  3.02936445e+03  3.02936445e+03  6.64980994e+03
  6.64980994e+03  6.64980994e+03  9.05548089e+03  2.54113290e+04
  7.61539878e+04]
E1 = -728.2240694735715  E_coul = 201.49511569717447
cycle= 5 E= -526.728953776397  delta_E= -1.89e-09  |g|= 2.06e-05  |ddm|= 0.000173
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83114e-05
diis-c [-9.07040498e-11  1.32611562e-05 -1.59356943e-03 -1.29858478e-02
  6.52519702e-02  9.49314186e-01]
  HOMO = -0.582742761513445  LUMO = 0.798792868592974
  mo_energy =
[-1.18585091e+02 -1.23128645e+01 -9.56764478e+00 -9.56764478e+00
 -9.56764478e+00 -1.26776034e+00 -5.82742762e-01 -5.82742762e-01
 -5.82742762e-01  7.98792869e-01  1.01078644e+00  1.01078644e+00
  1.01078644e+00  7.25933230e+00  7.25933230e+00  7.25933230e+00
  1.01077512e+01  3.33760127e+01  3.33760127e+01  3.33760127e+01
  1.00349902e+02  1.28935382e+02  1.28935382e+02  1.28935382e+02
  4.83272023e+02  4.83272023e+02  4.83272023e+02  5.80802005e+02
  1.33511499e+03  1.33511499e+03  1.33511499e+03  2.64957623e+03
  3.02936442e+03  3.02936442e+03  3.02936442e+03  6.64980991e+03
  6.64980991e+03  6.64980991e+03  9.05548085e+03  2.54113290e+04
  7.61539877e+04]
E1 = -728.2241506323543  E_coul = 201.49519685589922
cycle= 6 E= -526.728953776455  delta_E= -5.8e-11  |g|= 2.09e-06  |ddm|= 1.91e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2241506323543  E_coul = 201.49519685589922
  HOMO = -0.582742869558113  LUMO = 0.798793167262567
  mo_energy =
[-1.18585091e+02 -1.23128645e+01 -9.56764484e+00 -9.56764484e+00
 -9.56764484e+00 -1.26775998e+00 -5.82742870e-01 -5.82742870e-01
 -5.82742870e-01  7.98793167e-01  1.01078643e+00  1.01078643e+00
  1.01078643e+00  7.25933224e+00  7.25933224e+00  7.25933224e+00
  1.01077513e+01  3.33760127e+01  3.33760127e+01  3.33760127e+01
  1.00349903e+02  1.28935382e+02  1.28935382e+02  1.28935382e+02
  4.83272023e+02  4.83272023e+02  4.83272023e+02  5.80802005e+02
  1.33511499e+03  1.33511499e+03  1.33511499e+03  2.64957623e+03
  3.02936442e+03  3.02936442e+03  3.02936442e+03  6.64980991e+03
  6.64980991e+03  6.64980991e+03  9.05548085e+03  2.54113290e+04
  7.61539877e+04]
E1 = -728.2241494486666  E_coul = 201.49519567221083
Extra cycle  E= -526.728953776456  delta_E= -7.96e-13  |g|= 4.41e-07  |ddm|= 4.22e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782554e+03
 3.82851193e+02 1.08122158e+02 3.48089248e+01 7.53554962e+00
 2.73798964e+00 5.77564511e-01 2.18974883e-01 1.36278321e+03
 6.64745670e+02 3.00961940e+02 3.14042229e+02 6.16223195e+01
 7.33023699e+00 2.02388141e+01 7.72963117e-01 2.80853295e+00
 2.22328404e-01]
E = -526.7289537764558
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558585        1
[INPUT] 0    0    [1    /1   ]  7617.52190849        1
[INPUT] 0    0    [1    /1   ]  3617.35087087        1
[INPUT] 0    0    [1    /1   ]  1597.82554378        1
[INPUT] 0    0    [1    /1   ]  382.851193201        1
[INPUT] 0    0    [1    /1   ]  108.122158259        1
[INPUT] 0    0    [1    /1   ]  34.8089247815        1
[INPUT] 0    0    [1    /1   ]  7.53554962291        1
[INPUT] 0    0    [1    /1   ]  2.73798964042        1
[INPUT] 0    0    [1    /1   ]  0.577564510714       1
[INPUT] 0    0    [1    /1   ]  0.218974883018       1
[INPUT] 1    0    [1    /1   ]  1362.78320736        1
[INPUT] 1    0    [1    /1   ]  664.745670064        1
[INPUT] 1    0    [1    /1   ]  300.961939958        1
[INPUT] 1    0    [1    /1   ]  314.042229496        1
[INPUT] 1    0    [1    /1   ]  61.6223194724        1
[INPUT] 1    0    [1    /1   ]  7.33023699466        1
[INPUT] 1    0    [1    /1   ]  20.23881407          1
[INPUT] 1    0    [1    /1   ]  0.772963116779       1
[INPUT] 1    0    [1    /1   ]  2.80853294906        1
[INPUT] 1    0    [1    /1   ]  0.222328403828       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655858531863, 1.0]], [0, [7617.521908486754, 1.0]], [0, [3617.3508708662757, 1.0]], [0, [1597.8255437781124, 1.0]], [0, [382.85119320136454, 1.0]], [0, [108.12215825914853, 1.0]], [0, [34.808924781538806, 1.0]], [0, [7.535549622906951, 1.0]], [0, [2.737989640416898, 1.0]], [0, [0.5775645107142552, 1.0]], [0, [0.21897488301798054, 1.0]], [1, [1362.7832073581105, 1.0]], [1, [664.7456700643686, 1.0]], [1, [300.96193995787667, 1.0]], [1, [314.04222949616894, 1.0]], [1, [61.62231947241123, 1.0]], [1, [7.33023699465508, 1.0]], [1, [20.238814070043578, 1.0]], [1, [0.772963116778884, 1.0]], [1, [2.8085329490641344, 1.0]], [1, [0.2223284038283488, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65585853]
bas 1, expnt(s) = [7617.52190849]
bas 2, expnt(s) = [3617.35087087]
bas 3, expnt(s) = [1597.82554378]
bas 4, expnt(s) = [382.8511932]
bas 5, expnt(s) = [108.12215826]
bas 6, expnt(s) = [34.80892478]
bas 7, expnt(s) = [7.53554962]
bas 8, expnt(s) = [2.73798964]
bas 9, expnt(s) = [0.57756451]
bas 10, expnt(s) = [0.21897488]
bas 11, expnt(s) = [1362.78320736]
bas 12, expnt(s) = [664.74567006]
bas 13, expnt(s) = [300.96193996]
bas 14, expnt(s) = [314.0422295]
bas 15, expnt(s) = [61.62231947]
bas 16, expnt(s) = [7.33023699]
bas 17, expnt(s) = [20.23881407]
bas 18, expnt(s) = [0.77296312]
bas 19, expnt(s) = [2.80853295]
bas 20, expnt(s) = [0.2223284]
CPU time:        30.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752191e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782554e+03 6.38501680e+02
 3.82851193e+02 2.18669156e+02 1.08122158e+02 8.47131935e+01
 3.48089248e+01 3.62062029e+01 7.53554962e+00 1.14908254e+01
 2.73798964e+00 5.37760470e+00 5.77564511e-01 1.67384561e+00
 2.18974883e-01 8.08743404e-01 1.36278321e+03 2.41556017e+04
 6.64745670e+02 9.84699662e+03 3.00961940e+02 3.65699077e+03
 3.14042229e+02 3.85673197e+03 6.16223195e+01 5.03682595e+02
 7.33023699e+00 3.51869734e+01 2.02388141e+01 1.25232116e+02
 7.72963117e-01 2.11437910e+00 2.80853295e+00 1.06067858e+01
 2.22328404e-01 4.45377302e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99354746464138
cond(S) = 102896.09705905971
E1 = -729.4891695216388  E_coul = 203.15829173135214
init E= -526.330877790287
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.556652245887925  LUMO = 0.814971688248006
  mo_energy =
[-1.18326981e+02 -1.22052743e+01 -9.44833538e+00 -9.44833538e+00
 -9.44833538e+00 -1.23913526e+00 -5.56652246e-01 -5.56652246e-01
 -5.56652246e-01  8.14971688e-01  1.02871594e+00  1.02871594e+00
  1.02871594e+00  7.33044664e+00  7.33044664e+00  7.33044664e+00
  1.01848698e+01  3.35003192e+01  3.35003192e+01  3.35003192e+01
  1.00528118e+02  1.29122561e+02  1.29122561e+02  1.29122561e+02
  4.83529754e+02  4.83529754e+02  4.83529754e+02  5.81095795e+02
  1.33542616e+03  1.33542616e+03  1.33542616e+03  2.65002007e+03
  3.02974038e+03  3.02974038e+03  3.02974038e+03  6.65029831e+03
  6.65029831e+03  6.65029831e+03  9.05604433e+03  2.54119863e+04
  7.61547351e+04]
E1 = -727.7633825559143  E_coul = 201.03527435166288
cycle= 1 E= -526.728108204251  delta_E= -0.397  |g|= 0.191  |ddm|= 0.33
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.551476
diis-c [-0.30412585  1.        ]
  HOMO = -0.590608208642021  LUMO = 0.792866281399096
  mo_energy =
[-1.18645007e+02 -1.23462178e+01 -9.60220624e+00 -9.60220624e+00
 -9.60220624e+00 -1.27728292e+00 -5.90608209e-01 -5.90608209e-01
 -5.90608209e-01  7.92866281e-01  1.00498279e+00  1.00498279e+00
  1.00498279e+00  7.23879002e+00  7.23879002e+00  7.23879002e+00
  1.00831348e+01  3.33410437e+01  3.33410437e+01  3.33410437e+01
  1.00300946e+02  1.28886115e+02  1.28886115e+02  1.28886115e+02
  4.83212841e+02  4.83212841e+02  4.83212841e+02  5.80740765e+02
  1.33505224e+03  1.33505224e+03  1.33505224e+03  2.64951082e+03
  3.02929982e+03  3.02929982e+03  3.02929982e+03  6.64974400e+03
  6.64974400e+03  6.64974400e+03  9.05541438e+03  2.54112621e+04
  7.61539208e+04]
E1 = -728.35427562003  E_coul = 201.62538548084893
cycle= 2 E= -526.728890139181  delta_E= -0.000782  |g|= 0.0391  |ddm|= 0.0563
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0775524
diis-c [-0.0033267   0.08636218  0.91363782]
  HOMO = -0.581288271363269  LUMO = 0.799762058793193
  mo_energy =
[-1.18575253e+02 -1.23072132e+01 -9.56159821e+00 -9.56159821e+00
 -9.56159821e+00 -1.26615434e+00 -5.81288271e-01 -5.81288271e-01
 -5.81288271e-01  7.99762059e-01  1.01182878e+00  1.01182878e+00
  1.01182878e+00  7.26301234e+00  7.26301234e+00  7.26301234e+00
  1.01119151e+01  3.33820747e+01  3.33820747e+01  3.33820747e+01
  1.00357995e+02  1.28943606e+02  1.28943606e+02  1.28943606e+02
  4.83281746e+02  4.83281746e+02  4.83281746e+02  5.80812100e+02
  1.33512532e+03  1.33512532e+03  1.33512532e+03  2.64958725e+03
  3.02937517e+03  3.02937517e+03  3.02937517e+03  6.64982108e+03
  6.64982108e+03  6.64982108e+03  9.05549226e+03  2.54113406e+04
  7.61539995e+04]
E1 = -728.2020810399  E_coul = 201.47312910263065
cycle= 3 E= -526.728951937269  delta_E= -6.18e-05  |g|= 0.00621  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131856
diis-c [-8.52111965e-07 -1.36101639e-03  1.40178111e-01  8.61182906e-01]
  HOMO = -0.58274876554012  LUMO = 0.798769569336318
  mo_energy =
[-1.18585067e+02 -1.23128900e+01 -9.56764978e+00 -9.56764978e+00
 -9.56764978e+00 -1.26779082e+00 -5.82748766e-01 -5.82748766e-01
 -5.82748766e-01  7.98769569e-01  1.01077916e+00  1.01077916e+00
  1.01077916e+00  7.25931990e+00  7.25931990e+00  7.25931990e+00
  1.01077203e+01  3.33760086e+01  3.33760086e+01  3.33760086e+01
  1.00349903e+02  1.28935389e+02  1.28935389e+02  1.28935389e+02
  4.83272046e+02  4.83272046e+02  4.83272046e+02  5.80802038e+02
  1.33511502e+03  1.33511502e+03  1.33511502e+03  2.64957629e+03
  3.02936447e+03  3.02936447e+03  3.02936447e+03  6.64980998e+03
  6.64980998e+03  6.64980998e+03  9.05548093e+03  2.54113291e+04
  7.61539878e+04]
E1 = -728.2242126238384  E_coul = 201.49525884933323
cycle= 4 E= -526.728953774505  delta_E= -1.84e-06  |g|= 0.000111  |ddm|= 0.00217
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169692
diis-c [-4.54823939e-09  8.91241043e-05 -1.17531350e-02 -8.26625005e-02
  1.09432651e+00]
  HOMO = -0.582734907813153  LUMO = 0.798796507945233
  mo_energy =
[-1.18585060e+02 -1.23128410e+01 -9.56761958e+00 -9.56761958e+00
 -9.56761958e+00 -1.26775377e+00 -5.82734908e-01 -5.82734908e-01
 -5.82734908e-01  7.98796508e-01  1.01079167e+00  1.01079167e+00
  1.01079167e+00  7.25934954e+00  7.25934954e+00  7.25934954e+00
  1.01077691e+01  3.33760372e+01  3.33760372e+01  3.33760372e+01
  1.00349931e+02  1.28935410e+02  1.28935410e+02  1.28935410e+02
  4.83272054e+02  4.83272054e+02  4.83272054e+02  5.80802037e+02
  1.33511502e+03  1.33511502e+03  1.33511502e+03  2.64957626e+03
  3.02936445e+03  3.02936445e+03  3.02936445e+03  6.64980994e+03
  6.64980994e+03  6.64980994e+03  9.05548089e+03  2.54113290e+04
  7.61539878e+04]
E1 = -728.2240694735715  E_coul = 201.49511569717447
cycle= 5 E= -526.728953776397  delta_E= -1.89e-09  |g|= 2.06e-05  |ddm|= 0.000173
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83114e-05
diis-c [-9.07040498e-11  1.32611562e-05 -1.59356943e-03 -1.29858478e-02
  6.52519702e-02  9.49314186e-01]
  HOMO = -0.582742761513445  LUMO = 0.798792868592974
  mo_energy =
[-1.18585091e+02 -1.23128645e+01 -9.56764478e+00 -9.56764478e+00
 -9.56764478e+00 -1.26776034e+00 -5.82742762e-01 -5.82742762e-01
 -5.82742762e-01  7.98792869e-01  1.01078644e+00  1.01078644e+00
  1.01078644e+00  7.25933230e+00  7.25933230e+00  7.25933230e+00
  1.01077512e+01  3.33760127e+01  3.33760127e+01  3.33760127e+01
  1.00349902e+02  1.28935382e+02  1.28935382e+02  1.28935382e+02
  4.83272023e+02  4.83272023e+02  4.83272023e+02  5.80802005e+02
  1.33511499e+03  1.33511499e+03  1.33511499e+03  2.64957623e+03
  3.02936442e+03  3.02936442e+03  3.02936442e+03  6.64980991e+03
  6.64980991e+03  6.64980991e+03  9.05548085e+03  2.54113290e+04
  7.61539877e+04]
E1 = -728.2241506323543  E_coul = 201.49519685589922
cycle= 6 E= -526.728953776455  delta_E= -5.8e-11  |g|= 2.09e-06  |ddm|= 1.91e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2241506323543  E_coul = 201.49519685589922
  HOMO = -0.582742869558113  LUMO = 0.798793167262567
  mo_energy =
[-1.18585091e+02 -1.23128645e+01 -9.56764484e+00 -9.56764484e+00
 -9.56764484e+00 -1.26775998e+00 -5.82742870e-01 -5.82742870e-01
 -5.82742870e-01  7.98793167e-01  1.01078643e+00  1.01078643e+00
  1.01078643e+00  7.25933224e+00  7.25933224e+00  7.25933224e+00
  1.01077513e+01  3.33760127e+01  3.33760127e+01  3.33760127e+01
  1.00349903e+02  1.28935382e+02  1.28935382e+02  1.28935382e+02
  4.83272023e+02  4.83272023e+02  4.83272023e+02  5.80802005e+02
  1.33511499e+03  1.33511499e+03  1.33511499e+03  2.64957623e+03
  3.02936442e+03  3.02936442e+03  3.02936442e+03  6.64980991e+03
  6.64980991e+03  6.64980991e+03  9.05548085e+03  2.54113290e+04
  7.61539877e+04]
E1 = -728.2241494486666  E_coul = 201.49519567221083
Extra cycle  E= -526.728953776456  delta_E= -7.96e-13  |g|= 4.41e-07  |ddm|= 4.22e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102896.09705905971
E1 = -728.2241494486666  E_coul = 201.49519567221083
init E= -526.728953776456
    CPU time for initialize scf      0.89 sec, wall time      0.23 sec
  HOMO = -0.582742913551636  LUMO = 0.798793214694134
  mo_energy =
[-1.18585091e+02 -1.23128645e+01 -9.56764494e+00 -9.56764494e+00
 -9.56764494e+00 -1.26775993e+00 -5.82742914e-01 -5.82742914e-01
 -5.82742914e-01  7.98793215e-01  1.01078641e+00  1.01078641e+00
  1.01078641e+00  7.25933217e+00  7.25933217e+00  7.25933217e+00
  1.01077513e+01  3.33760126e+01  3.33760126e+01  3.33760126e+01
  1.00349902e+02  1.28935382e+02  1.28935382e+02  1.28935382e+02
  4.83272023e+02  4.83272023e+02  4.83272023e+02  5.80802005e+02
  1.33511499e+03  1.33511499e+03  1.33511499e+03  2.64957623e+03
  3.02936442e+03  3.02936442e+03  3.02936442e+03  6.64980991e+03
  6.64980991e+03  6.64980991e+03  9.05548085e+03  2.54113290e+04
  7.61539877e+04]
E1 = -728.2241495411859  E_coul = 201.49519576472937
cycle= 1 E= -526.728953776456  delta_E= -6.82e-13  |g|= 9.35e-08  |ddm|= 8.46e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2241495411859  E_coul = 201.49519576472937
  HOMO = -0.58274291633195  LUMO = 0.798793229066862
  mo_energy =
[-1.18585091e+02 -1.23128645e+01 -9.56764494e+00 -9.56764494e+00
 -9.56764494e+00 -1.26775992e+00 -5.82742916e-01 -5.82742916e-01
 -5.82742916e-01  7.98793229e-01  1.01078641e+00  1.01078641e+00
  1.01078641e+00  7.25933218e+00  7.25933218e+00  7.25933218e+00
  1.01077513e+01  3.33760126e+01  3.33760126e+01  3.33760126e+01
  1.00349902e+02  1.28935382e+02  1.28935382e+02  1.28935382e+02
  4.83272023e+02  4.83272023e+02  4.83272023e+02  5.80802005e+02
  1.33511499e+03  1.33511499e+03  1.33511499e+03  2.64957623e+03
  3.02936442e+03  3.02936442e+03  3.02936442e+03  6.64980991e+03
  6.64980991e+03  6.64980991e+03  9.05548085e+03  2.54113290e+04
  7.61539877e+04]
E1 = -728.2241494670401  E_coul = 201.49519569058432
Extra cycle  E= -526.728953776456  delta_E= 6.82e-13  |g|= 1.93e-08  |ddm|= 1.78e-07
    CPU time for scf_cycle      1.02 sec, wall time      0.36 sec
exp = [2.61826559e+04 7.61752191e+03 3.61735087e+03 1.59782554e+03
 3.82851193e+02 1.08122158e+02 3.48089248e+01 7.53554962e+00
 2.73798964e+00 5.77564511e-01 2.18974883e-01 1.36278321e+03
 6.64745670e+02 3.00961940e+02 3.14042229e+02 6.16223195e+01
 7.33023699e+00 2.02388141e+01 7.72963117e-01 2.80853295e+00
 2.22328404e-01]
grad_E = [-1.51765948e-06  3.30992912e-06 -1.58233065e-06  6.94061146e-05
 -3.62125174e-05 -2.98917405e-04 -2.56657442e-03  1.15325992e-02
 -4.02600294e-02 -5.84634753e-02  6.96489250e-02 -5.04697804e-07
  5.03792117e-06  2.37977385e-05  2.05180731e-05 -3.40539339e-05
 -4.26606817e-05  1.01095313e-04 -3.37547572e-03 -1.26686823e-04
  7.21145372e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558615        1
[INPUT] 0    0    [1    /1   ]  7617.52190196        1
[INPUT] 0    0    [1    /1   ]  3617.35087399        1
[INPUT] 0    0    [1    /1   ]  1597.82540708        1
[INPUT] 0    0    [1    /1   ]  382.85126013         1
[INPUT] 0    0    [1    /1   ]  108.122803879        1
[INPUT] 0    0    [1    /1   ]  34.8137216321        1
[INPUT] 0    0    [1    /1   ]  7.51023670851        1
[INPUT] 0    0    [1    /1   ]  2.82339721753        1
[INPUT] 0    0    [1    /1   ]  0.590784582576       1
[INPUT] 0    0    [1    /1   ]  0.206709968836       1
[INPUT] 1    0    [1    /1   ]  1362.78320835        1
[INPUT] 1    0    [1    /1   ]  664.745660129        1
[INPUT] 1    0    [1    /1   ]  300.961893021        1
[INPUT] 1    0    [1    /1   ]  314.042189028        1
[INPUT] 1    0    [1    /1   ]  61.6223902178        1
[INPUT] 1    0    [1    /1   ]  7.33048804204        1
[INPUT] 1    0    [1    /1   ]  20.2385792419        1
[INPUT] 1    0    [1    /1   ]  0.775059038881       1
[INPUT] 1    0    [1    /1   ]  2.80862303317        1
[INPUT] 1    0    [1    /1   ]  0.216947512241       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655861523624, 1.0]], [0, [7617.521901964608, 1.0]], [0, [3617.35087398817, 1.0]], [0, [1597.8254070768792, 1.0]], [0, [382.85126013034875, 1.0]], [0, [108.12280387858183, 1.0]], [0, [34.81372163212721, 1.0]], [0, [7.510236708506791, 1.0]], [0, [2.8233972175317663, 1.0]], [0, [0.5907845825763337, 1.0]], [0, [0.20670996883623297, 1.0]], [1, [1362.7832083526448, 1.0]], [1, [664.7456601293463, 1.0]], [1, [300.96189302134235, 1.0]], [1, [314.042189028316, 1.0]], [1, [61.622390217762145, 1.0]], [1, [7.330488042040201, 1.0]], [1, [20.23857924194881, 1.0]], [1, [0.7750590388811948, 1.0]], [1, [2.8086230331732307, 1.0]], [1, [0.21694751224086803, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586152]
bas 1, expnt(s) = [7617.52190196]
bas 2, expnt(s) = [3617.35087399]
bas 3, expnt(s) = [1597.82540708]
bas 4, expnt(s) = [382.85126013]
bas 5, expnt(s) = [108.12280388]
bas 6, expnt(s) = [34.81372163]
bas 7, expnt(s) = [7.51023671]
bas 8, expnt(s) = [2.82339722]
bas 9, expnt(s) = [0.59078458]
bas 10, expnt(s) = [0.20670997]
bas 11, expnt(s) = [1362.78320835]
bas 12, expnt(s) = [664.74566013]
bas 13, expnt(s) = [300.96189302]
bas 14, expnt(s) = [314.04218903]
bas 15, expnt(s) = [61.62239022]
bas 16, expnt(s) = [7.33048804]
bas 17, expnt(s) = [20.23857924]
bas 18, expnt(s) = [0.77505904]
bas 19, expnt(s) = [2.80862303]
bas 20, expnt(s) = [0.21694751]
CPU time:        36.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752190e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782541e+03 6.38501639e+02
 3.82851260e+02 2.18669184e+02 1.08122804e+02 8.47135729e+01
 3.48137216e+01 3.62099449e+01 7.51023671e+00 1.14618638e+01
 2.82339722e+00 5.50293029e+00 5.90784583e-01 1.70249909e+00
 2.06709969e-01 7.74526159e-01 1.36278321e+03 2.41556017e+04
 6.64745660e+02 9.84699644e+03 3.00961893e+02 3.65699006e+03
 3.14042189e+02 3.85673134e+03 6.16223902e+01 5.03683318e+02
 7.33048804e+00 3.51884798e+01 2.02385792e+01 1.25230300e+02
 7.75059039e-01 2.12154806e+00 2.80862303e+00 1.06072110e+01
 2.16947512e-01 4.31944288e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993969876406183
cond(S) = 102919.5591220454
E1 = -729.5114477451489  E_coul = 203.1696280589362
init E= -526.341819686213
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.5563826374414  LUMO = 0.791699247240211
  mo_energy =
[-1.18326685e+02 -1.22047092e+01 -9.44731750e+00 -9.44731750e+00
 -9.44731750e+00 -1.24001425e+00 -5.56382637e-01 -5.56382637e-01
 -5.56382637e-01  7.91699247e-01  1.00920953e+00  1.00920953e+00
  1.00920953e+00  7.31935379e+00  7.31935379e+00  7.31935379e+00
  1.03884251e+01  3.34937350e+01  3.34937350e+01  3.34937350e+01
  1.00818323e+02  1.29118257e+02  1.29118257e+02  1.29118257e+02
  4.83526056e+02  4.83526056e+02  4.83526056e+02  5.81341254e+02
  1.33542324e+03  1.33542324e+03  1.33542324e+03  2.65023099e+03
  3.02973751e+03  3.02973751e+03  3.02973751e+03  6.65029560e+03
  6.65029560e+03  6.65029560e+03  9.05623671e+03  2.54121680e+04
  7.61549043e+04]
E1 = -727.678294075513  E_coul = 200.9468076071342
cycle= 1 E= -526.731486468379  delta_E= -0.39  |g|= 0.192  |ddm|= 0.293
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550618
diis-c [-0.30318053  1.        ]
  HOMO = -0.594994181937634  LUMO = 0.766094405528113
  mo_energy =
[-1.18650728e+02 -1.23522896e+01 -9.60717410e+00 -9.60717410e+00
 -9.60717410e+00 -1.28338983e+00 -5.94994182e-01 -5.94994182e-01
 -5.94994182e-01  7.66094406e-01  9.82396528e-01  9.82396528e-01
  9.82396528e-01  7.22074078e+00  7.22074078e+00  7.22074078e+00
  1.02782537e+01  3.33282144e+01  3.33282144e+01  3.33282144e+01
  1.00585938e+02  1.28875809e+02  1.28875809e+02  1.28875809e+02
  4.83203313e+02  4.83203313e+02  4.83203313e+02  5.80979989e+02
  1.33504303e+03  1.33504303e+03  1.33504303e+03  2.64971539e+03
  3.02929063e+03  3.02929063e+03  3.02929063e+03  6.64973485e+03
  6.64973485e+03  6.64973485e+03  9.05560028e+03  2.54114373e+04
  7.61540833e+04]
E1 = -728.297995713383  E_coul = 201.56567960640297
cycle= 2 E= -526.73231610698  delta_E= -0.00083  |g|= 0.0402  |ddm|= 0.0573
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0797957
diis-c [-0.00349959  0.08910652  0.91089348]
  HOMO = -0.585112899603048  LUMO = 0.773364494487004
  mo_energy =
[-1.18578717e+02 -1.23114403e+01 -9.56462920e+00 -9.56462920e+00
 -9.56462920e+00 -1.27155906e+00 -5.85112900e-01 -5.85112900e-01
 -5.85112900e-01  7.73364494e-01  9.89607968e-01  9.89607968e-01
  9.89607968e-01  7.24630062e+00  7.24630062e+00  7.24630062e+00
  1.03086898e+01  3.33711144e+01  3.33711144e+01  3.33711144e+01
  1.00645075e+02  1.28935413e+02  1.28935413e+02  1.28935413e+02
  4.83274462e+02  4.83274462e+02  4.83274462e+02  5.81053594e+02
  1.33511839e+03  1.33511839e+03  1.33511839e+03  2.64979416e+03
  3.02936830e+03  3.02936830e+03  3.02936830e+03  6.64981430e+03
  6.64981430e+03  6.64981430e+03  9.05568056e+03  2.54115181e+04
  7.61541644e+04]
E1 = -728.1356771017141  E_coul = 201.4032920545427
cycle= 3 E= -526.732385047171  delta_E= -6.89e-05  |g|= 0.00647  |ddm|= 0.0174
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013616
diis-c [-8.24575909e-07 -1.34544373e-03  1.40862862e-01  8.60482582e-01]
  HOMO = -0.586689197261819  LUMO = 0.772294821322841
  mo_energy =
[-1.18588959e+02 -1.23174402e+01 -9.57100353e+00 -9.57100353e+00
 -9.57100353e+00 -1.27332684e+00 -5.86689197e-01 -5.86689197e-01
 -5.86689197e-01  7.72294821e-01  9.88482345e-01  9.88482345e-01
  9.88482345e-01  7.24236707e+00  7.24236707e+00  7.24236707e+00
  1.03041900e+01  3.33647261e+01  3.33647261e+01  3.33647261e+01
  1.00636599e+02  1.28926809e+02  1.28926809e+02  1.28926809e+02
  4.83264338e+02  4.83264338e+02  4.83264338e+02  5.81043103e+02
  1.33510766e+03  1.33510766e+03  1.33510766e+03  2.64978277e+03
  3.02935717e+03  3.02935717e+03  3.02935717e+03  6.64980275e+03
  6.64980275e+03  6.64980275e+03  9.05566879e+03  2.54115062e+04
  7.61541523e+04]
E1 = -728.1594079181717  E_coul = 201.42702078681972
cycle= 4 E= -526.732387131352  delta_E= -2.08e-06  |g|= 0.000113  |ddm|= 0.0023
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000158505
diis-c [-4.89040646e-09  8.81025254e-05 -1.17967264e-02 -8.10333505e-02
  1.09274197e+00]
  HOMO = -0.586676244550791  LUMO = 0.772322328948025
  mo_energy =
[-1.18588946e+02 -1.23173888e+01 -9.57096972e+00 -9.57096972e+00
 -9.57096972e+00 -1.27328850e+00 -5.86676245e-01 -5.86676245e-01
 -5.86676245e-01  7.72322329e-01  9.88494443e-01  9.88494443e-01
  9.88494443e-01  7.24239747e+00  7.24239747e+00  7.24239747e+00
  1.03042395e+01  3.33647580e+01  3.33647580e+01  3.33647580e+01
  1.00636631e+02  1.28926835e+02  1.28926835e+02  1.28926835e+02
  4.83264353e+02  4.83264353e+02  4.83264353e+02  5.81043108e+02
  1.33510767e+03  1.33510767e+03  1.33510767e+03  2.64978274e+03
  3.02935716e+03  3.02935716e+03  3.02935716e+03  6.64980273e+03
  6.64980273e+03  6.64980273e+03  9.05566875e+03  2.54115061e+04
  7.61541523e+04]
E1 = -728.1592364665299  E_coul = 201.42684933291716
cycle= 5 E= -526.732387133613  delta_E= -2.26e-09  |g|= 2.17e-05  |ddm|= 0.000184
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.00419e-05
diis-c [-1.05353105e-10  1.37878263e-05 -1.64645520e-03 -1.30728676e-02
  4.61882299e-02  9.68517305e-01]
  HOMO = -0.586684553432449  LUMO = 0.772318700342908
  mo_energy =
[-1.18588978e+02 -1.23174133e+01 -9.57099610e+00 -9.57099610e+00
 -9.57099610e+00 -1.27329519e+00 -5.86684553e-01 -5.86684553e-01
 -5.86684553e-01  7.72318700e-01  9.88488958e-01  9.88488958e-01
  9.88488958e-01  7.24237937e+00  7.24237937e+00  7.24237937e+00
  1.03042207e+01  3.33647323e+01  3.33647323e+01  3.33647323e+01
  1.00636602e+02  1.28926805e+02  1.28926805e+02  1.28926805e+02
  4.83264320e+02  4.83264320e+02  4.83264320e+02  5.81043075e+02
  1.33510763e+03  1.33510763e+03  1.33510763e+03  2.64978271e+03
  3.02935713e+03  3.02935713e+03  3.02935713e+03  6.64980269e+03
  6.64980269e+03  6.64980269e+03  9.05566871e+03  2.54115061e+04
  7.61541522e+04]
E1 = -728.1593232226385  E_coul = 201.42693608895624
cycle= 6 E= -526.732387133682  delta_E= -6.95e-11  |g|= 2.09e-06  |ddm|= 2.12e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.1593232226385  E_coul = 201.42693608895624
  HOMO = -0.586684515045508  LUMO = 0.77231909949314
  mo_energy =
[-1.18588977e+02 -1.23174128e+01 -9.57099569e+00 -9.57099569e+00
 -9.57099569e+00 -1.27329466e+00 -5.86684515e-01 -5.86684515e-01
 -5.86684515e-01  7.72319099e-01  9.88489053e-01  9.88489053e-01
  9.88489053e-01  7.24237963e+00  7.24237963e+00  7.24237963e+00
  1.03042212e+01  3.33647328e+01  3.33647328e+01  3.33647328e+01
  1.00636602e+02  1.28926805e+02  1.28926805e+02  1.28926805e+02
  4.83264321e+02  4.83264321e+02  4.83264321e+02  5.81043075e+02
  1.33510763e+03  1.33510763e+03  1.33510763e+03  2.64978271e+03
  3.02935713e+03  3.02935713e+03  3.02935713e+03  6.64980269e+03
  6.64980269e+03  6.64980269e+03  9.05566871e+03  2.54115061e+04
  7.61541522e+04]
E1 = -728.1593204677464  E_coul = 201.42693333406402
Extra cycle  E= -526.732387133682  delta_E= -1.14e-13  |g|= 4.46e-07  |ddm|= 3.99e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826559e+04 7.61752190e+03 3.61735087e+03 1.59782541e+03
 3.82851260e+02 1.08122804e+02 3.48137216e+01 7.51023671e+00
 2.82339722e+00 5.90784583e-01 2.06709969e-01 1.36278321e+03
 6.64745660e+02 3.00961893e+02 3.14042189e+02 6.16223902e+01
 7.33048804e+00 2.02385792e+01 7.75059039e-01 2.80862303e+00
 2.16947512e-01]
E = -526.7323871336823
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558615        1
[INPUT] 0    0    [1    /1   ]  7617.52190196        1
[INPUT] 0    0    [1    /1   ]  3617.35087399        1
[INPUT] 0    0    [1    /1   ]  1597.82540708        1
[INPUT] 0    0    [1    /1   ]  382.85126013         1
[INPUT] 0    0    [1    /1   ]  108.122803879        1
[INPUT] 0    0    [1    /1   ]  34.8137216321        1
[INPUT] 0    0    [1    /1   ]  7.51023670851        1
[INPUT] 0    0    [1    /1   ]  2.82339721753        1
[INPUT] 0    0    [1    /1   ]  0.590784582576       1
[INPUT] 0    0    [1    /1   ]  0.206709968836       1
[INPUT] 1    0    [1    /1   ]  1362.78320835        1
[INPUT] 1    0    [1    /1   ]  664.745660129        1
[INPUT] 1    0    [1    /1   ]  300.961893021        1
[INPUT] 1    0    [1    /1   ]  314.042189028        1
[INPUT] 1    0    [1    /1   ]  61.6223902178        1
[INPUT] 1    0    [1    /1   ]  7.33048804204        1
[INPUT] 1    0    [1    /1   ]  20.2385792419        1
[INPUT] 1    0    [1    /1   ]  0.775059038881       1
[INPUT] 1    0    [1    /1   ]  2.80862303317        1
[INPUT] 1    0    [1    /1   ]  0.216947512241       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655861523624, 1.0]], [0, [7617.521901964608, 1.0]], [0, [3617.35087398817, 1.0]], [0, [1597.8254070768792, 1.0]], [0, [382.85126013034875, 1.0]], [0, [108.12280387858183, 1.0]], [0, [34.81372163212721, 1.0]], [0, [7.510236708506791, 1.0]], [0, [2.8233972175317663, 1.0]], [0, [0.5907845825763337, 1.0]], [0, [0.20670996883623297, 1.0]], [1, [1362.7832083526448, 1.0]], [1, [664.7456601293463, 1.0]], [1, [300.96189302134235, 1.0]], [1, [314.042189028316, 1.0]], [1, [61.622390217762145, 1.0]], [1, [7.330488042040201, 1.0]], [1, [20.23857924194881, 1.0]], [1, [0.7750590388811948, 1.0]], [1, [2.8086230331732307, 1.0]], [1, [0.21694751224086803, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586152]
bas 1, expnt(s) = [7617.52190196]
bas 2, expnt(s) = [3617.35087399]
bas 3, expnt(s) = [1597.82540708]
bas 4, expnt(s) = [382.85126013]
bas 5, expnt(s) = [108.12280388]
bas 6, expnt(s) = [34.81372163]
bas 7, expnt(s) = [7.51023671]
bas 8, expnt(s) = [2.82339722]
bas 9, expnt(s) = [0.59078458]
bas 10, expnt(s) = [0.20670997]
bas 11, expnt(s) = [1362.78320835]
bas 12, expnt(s) = [664.74566013]
bas 13, expnt(s) = [300.96189302]
bas 14, expnt(s) = [314.04218903]
bas 15, expnt(s) = [61.62239022]
bas 16, expnt(s) = [7.33048804]
bas 17, expnt(s) = [20.23857924]
bas 18, expnt(s) = [0.77505904]
bas 19, expnt(s) = [2.80862303]
bas 20, expnt(s) = [0.21694751]
CPU time:        36.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752190e+03 2.06003836e+03
 3.61735087e+03 1.17844143e+03 1.59782541e+03 6.38501639e+02
 3.82851260e+02 2.18669184e+02 1.08122804e+02 8.47135729e+01
 3.48137216e+01 3.62099449e+01 7.51023671e+00 1.14618638e+01
 2.82339722e+00 5.50293029e+00 5.90784583e-01 1.70249909e+00
 2.06709969e-01 7.74526159e-01 1.36278321e+03 2.41556017e+04
 6.64745660e+02 9.84699644e+03 3.00961893e+02 3.65699006e+03
 3.14042189e+02 3.85673134e+03 6.16223902e+01 5.03683318e+02
 7.33048804e+00 3.51884798e+01 2.02385792e+01 1.25230300e+02
 7.75059039e-01 2.12154806e+00 2.80862303e+00 1.06072110e+01
 2.16947512e-01 4.31944288e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993969876406183
cond(S) = 102919.5591220454
E1 = -729.5114477451489  E_coul = 203.1696280589362
init E= -526.341819686213
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.5563826374414  LUMO = 0.791699247240211
  mo_energy =
[-1.18326685e+02 -1.22047092e+01 -9.44731750e+00 -9.44731750e+00
 -9.44731750e+00 -1.24001425e+00 -5.56382637e-01 -5.56382637e-01
 -5.56382637e-01  7.91699247e-01  1.00920953e+00  1.00920953e+00
  1.00920953e+00  7.31935379e+00  7.31935379e+00  7.31935379e+00
  1.03884251e+01  3.34937350e+01  3.34937350e+01  3.34937350e+01
  1.00818323e+02  1.29118257e+02  1.29118257e+02  1.29118257e+02
  4.83526056e+02  4.83526056e+02  4.83526056e+02  5.81341254e+02
  1.33542324e+03  1.33542324e+03  1.33542324e+03  2.65023099e+03
  3.02973751e+03  3.02973751e+03  3.02973751e+03  6.65029560e+03
  6.65029560e+03  6.65029560e+03  9.05623671e+03  2.54121680e+04
  7.61549043e+04]
E1 = -727.678294075513  E_coul = 200.9468076071342
cycle= 1 E= -526.731486468379  delta_E= -0.39  |g|= 0.192  |ddm|= 0.293
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.550618
diis-c [-0.30318053  1.        ]
  HOMO = -0.594994181937634  LUMO = 0.766094405528113
  mo_energy =
[-1.18650728e+02 -1.23522896e+01 -9.60717410e+00 -9.60717410e+00
 -9.60717410e+00 -1.28338983e+00 -5.94994182e-01 -5.94994182e-01
 -5.94994182e-01  7.66094406e-01  9.82396528e-01  9.82396528e-01
  9.82396528e-01  7.22074078e+00  7.22074078e+00  7.22074078e+00
  1.02782537e+01  3.33282144e+01  3.33282144e+01  3.33282144e+01
  1.00585938e+02  1.28875809e+02  1.28875809e+02  1.28875809e+02
  4.83203313e+02  4.83203313e+02  4.83203313e+02  5.80979989e+02
  1.33504303e+03  1.33504303e+03  1.33504303e+03  2.64971539e+03
  3.02929063e+03  3.02929063e+03  3.02929063e+03  6.64973485e+03
  6.64973485e+03  6.64973485e+03  9.05560028e+03  2.54114373e+04
  7.61540833e+04]
E1 = -728.297995713383  E_coul = 201.56567960640297
cycle= 2 E= -526.73231610698  delta_E= -0.00083  |g|= 0.0402  |ddm|= 0.0573
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0797957
diis-c [-0.00349959  0.08910652  0.91089348]
  HOMO = -0.585112899603048  LUMO = 0.773364494487004
  mo_energy =
[-1.18578717e+02 -1.23114403e+01 -9.56462920e+00 -9.56462920e+00
 -9.56462920e+00 -1.27155906e+00 -5.85112900e-01 -5.85112900e-01
 -5.85112900e-01  7.73364494e-01  9.89607968e-01  9.89607968e-01
  9.89607968e-01  7.24630062e+00  7.24630062e+00  7.24630062e+00
  1.03086898e+01  3.33711144e+01  3.33711144e+01  3.33711144e+01
  1.00645075e+02  1.28935413e+02  1.28935413e+02  1.28935413e+02
  4.83274462e+02  4.83274462e+02  4.83274462e+02  5.81053594e+02
  1.33511839e+03  1.33511839e+03  1.33511839e+03  2.64979416e+03
  3.02936830e+03  3.02936830e+03  3.02936830e+03  6.64981430e+03
  6.64981430e+03  6.64981430e+03  9.05568056e+03  2.54115181e+04
  7.61541644e+04]
E1 = -728.1356771017141  E_coul = 201.4032920545427
cycle= 3 E= -526.732385047171  delta_E= -6.89e-05  |g|= 0.00647  |ddm|= 0.0174
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013616
diis-c [-8.24575909e-07 -1.34544373e-03  1.40862862e-01  8.60482582e-01]
  HOMO = -0.586689197261819  LUMO = 0.772294821322841
  mo_energy =
[-1.18588959e+02 -1.23174402e+01 -9.57100353e+00 -9.57100353e+00
 -9.57100353e+00 -1.27332684e+00 -5.86689197e-01 -5.86689197e-01
 -5.86689197e-01  7.72294821e-01  9.88482345e-01  9.88482345e-01
  9.88482345e-01  7.24236707e+00  7.24236707e+00  7.24236707e+00
  1.03041900e+01  3.33647261e+01  3.33647261e+01  3.33647261e+01
  1.00636599e+02  1.28926809e+02  1.28926809e+02  1.28926809e+02
  4.83264338e+02  4.83264338e+02  4.83264338e+02  5.81043103e+02
  1.33510766e+03  1.33510766e+03  1.33510766e+03  2.64978277e+03
  3.02935717e+03  3.02935717e+03  3.02935717e+03  6.64980275e+03
  6.64980275e+03  6.64980275e+03  9.05566879e+03  2.54115062e+04
  7.61541523e+04]
E1 = -728.1594079181717  E_coul = 201.42702078681972
cycle= 4 E= -526.732387131352  delta_E= -2.08e-06  |g|= 0.000113  |ddm|= 0.0023
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000158505
diis-c [-4.89040646e-09  8.81025254e-05 -1.17967264e-02 -8.10333505e-02
  1.09274197e+00]
  HOMO = -0.586676244550791  LUMO = 0.772322328948025
  mo_energy =
[-1.18588946e+02 -1.23173888e+01 -9.57096972e+00 -9.57096972e+00
 -9.57096972e+00 -1.27328850e+00 -5.86676245e-01 -5.86676245e-01
 -5.86676245e-01  7.72322329e-01  9.88494443e-01  9.88494443e-01
  9.88494443e-01  7.24239747e+00  7.24239747e+00  7.24239747e+00
  1.03042395e+01  3.33647580e+01  3.33647580e+01  3.33647580e+01
  1.00636631e+02  1.28926835e+02  1.28926835e+02  1.28926835e+02
  4.83264353e+02  4.83264353e+02  4.83264353e+02  5.81043108e+02
  1.33510767e+03  1.33510767e+03  1.33510767e+03  2.64978274e+03
  3.02935716e+03  3.02935716e+03  3.02935716e+03  6.64980273e+03
  6.64980273e+03  6.64980273e+03  9.05566875e+03  2.54115061e+04
  7.61541523e+04]
E1 = -728.1592364665299  E_coul = 201.42684933291716
cycle= 5 E= -526.732387133613  delta_E= -2.26e-09  |g|= 2.17e-05  |ddm|= 0.000184
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.00419e-05
diis-c [-1.05353105e-10  1.37878263e-05 -1.64645520e-03 -1.30728676e-02
  4.61882299e-02  9.68517305e-01]
  HOMO = -0.586684553432449  LUMO = 0.772318700342908
  mo_energy =
[-1.18588978e+02 -1.23174133e+01 -9.57099610e+00 -9.57099610e+00
 -9.57099610e+00 -1.27329519e+00 -5.86684553e-01 -5.86684553e-01
 -5.86684553e-01  7.72318700e-01  9.88488958e-01  9.88488958e-01
  9.88488958e-01  7.24237937e+00  7.24237937e+00  7.24237937e+00
  1.03042207e+01  3.33647323e+01  3.33647323e+01  3.33647323e+01
  1.00636602e+02  1.28926805e+02  1.28926805e+02  1.28926805e+02
  4.83264320e+02  4.83264320e+02  4.83264320e+02  5.81043075e+02
  1.33510763e+03  1.33510763e+03  1.33510763e+03  2.64978271e+03
  3.02935713e+03  3.02935713e+03  3.02935713e+03  6.64980269e+03
  6.64980269e+03  6.64980269e+03  9.05566871e+03  2.54115061e+04
  7.61541522e+04]
E1 = -728.1593232226385  E_coul = 201.42693608895624
cycle= 6 E= -526.732387133682  delta_E= -6.95e-11  |g|= 2.09e-06  |ddm|= 2.12e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.1593232226385  E_coul = 201.42693608895624
  HOMO = -0.586684515045508  LUMO = 0.77231909949314
  mo_energy =
[-1.18588977e+02 -1.23174128e+01 -9.57099569e+00 -9.57099569e+00
 -9.57099569e+00 -1.27329466e+00 -5.86684515e-01 -5.86684515e-01
 -5.86684515e-01  7.72319099e-01  9.88489053e-01  9.88489053e-01
  9.88489053e-01  7.24237963e+00  7.24237963e+00  7.24237963e+00
  1.03042212e+01  3.33647328e+01  3.33647328e+01  3.33647328e+01
  1.00636602e+02  1.28926805e+02  1.28926805e+02  1.28926805e+02
  4.83264321e+02  4.83264321e+02  4.83264321e+02  5.81043075e+02
  1.33510763e+03  1.33510763e+03  1.33510763e+03  2.64978271e+03
  3.02935713e+03  3.02935713e+03  3.02935713e+03  6.64980269e+03
  6.64980269e+03  6.64980269e+03  9.05566871e+03  2.54115061e+04
  7.61541522e+04]
E1 = -728.1593204677464  E_coul = 201.42693333406402
Extra cycle  E= -526.732387133682  delta_E= -1.14e-13  |g|= 4.46e-07  |ddm|= 3.99e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102919.5591220454
E1 = -728.1593204677464  E_coul = 201.42693333406402
init E= -526.732387133682
    CPU time for initialize scf      0.89 sec, wall time      0.23 sec
  HOMO = -0.586684589448201  LUMO = 0.772319124657282
  mo_energy =
[-1.18588978e+02 -1.23174130e+01 -9.57099592e+00 -9.57099592e+00
 -9.57099592e+00 -1.27329465e+00 -5.86684589e-01 -5.86684589e-01
 -5.86684589e-01  7.72319125e-01  9.88489014e-01  9.88489014e-01
  9.88489014e-01  7.24237948e+00  7.24237948e+00  7.24237948e+00
  1.03042211e+01  3.33647326e+01  3.33647326e+01  3.33647326e+01
  1.00636602e+02  1.28926805e+02  1.28926805e+02  1.28926805e+02
  4.83264321e+02  4.83264321e+02  4.83264321e+02  5.81043075e+02
  1.33510763e+03  1.33510763e+03  1.33510763e+03  2.64978271e+03
  3.02935713e+03  3.02935713e+03  3.02935713e+03  6.64980269e+03
  6.64980269e+03  6.64980269e+03  9.05566871e+03  2.54115061e+04
  7.61541522e+04]
E1 = -728.1593210251281  E_coul = 201.42693389144503
cycle= 1 E= -526.732387133683  delta_E= -6.82e-13  |g|= 1.01e-07  |ddm|= 7.71e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.1593210251281  E_coul = 201.42693389144503
  HOMO = -0.58668458326842  LUMO = 0.772319145397183
  mo_energy =
[-1.18588978e+02 -1.23174129e+01 -9.57099588e+00 -9.57099588e+00
 -9.57099588e+00 -1.27329462e+00 -5.86684583e-01 -5.86684583e-01
 -5.86684583e-01  7.72319145e-01  9.88489022e-01  9.88489022e-01
  9.88489022e-01  7.24237951e+00  7.24237951e+00  7.24237951e+00
  1.03042211e+01  3.33647326e+01  3.33647326e+01  3.33647326e+01
  1.00636602e+02  1.28926805e+02  1.28926805e+02  1.28926805e+02
  4.83264321e+02  4.83264321e+02  4.83264321e+02  5.81043075e+02
  1.33510763e+03  1.33510763e+03  1.33510763e+03  2.64978271e+03
  3.02935713e+03  3.02935713e+03  3.02935713e+03  6.64980269e+03
  6.64980269e+03  6.64980269e+03  9.05566871e+03  2.54115061e+04
  7.61541522e+04]
E1 = -728.1593208200152  E_coul = 201.42693368633158
Extra cycle  E= -526.732387133684  delta_E= -5.68e-13  |g|= 2.16e-08  |ddm|= 1.74e-07
    CPU time for scf_cycle      1.20 sec, wall time      0.54 sec
exp = [2.61826559e+04 7.61752190e+03 3.61735087e+03 1.59782541e+03
 3.82851260e+02 1.08122804e+02 3.48137216e+01 7.51023671e+00
 2.82339722e+00 5.90784583e-01 2.06709969e-01 1.36278321e+03
 6.64745660e+02 3.00961893e+02 3.14042189e+02 6.16223902e+01
 7.33048804e+00 2.02385792e+01 7.75059039e-01 2.80862303e+00
 2.16947512e-01]
grad_E = [-1.51818794e-06  3.31683221e-06 -1.57704317e-06  6.96819339e-05
 -4.56312946e-05 -1.75275920e-04 -3.17019094e-03  4.29682497e-03
 -2.05862423e-02 -2.20724953e-02  8.64706116e-03 -5.04572533e-07
  5.04268423e-06  2.38283848e-05  2.05436894e-05 -4.11016739e-05
 -6.64338222e-04  1.81768785e-04  4.00067272e-02 -8.00414427e-05
 -1.46147289e-01]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558648        1
[INPUT] 0    0    [1    /1   ]  7617.52189471        1
[INPUT] 0    0    [1    /1   ]  3617.35087745        1
[INPUT] 0    0    [1    /1   ]  1597.82525486        1
[INPUT] 0    0    [1    /1   ]  382.851347685        1
[INPUT] 0    0    [1    /1   ]  108.123347896        1
[INPUT] 0    0    [1    /1   ]  34.8198854224        1
[INPUT] 0    0    [1    /1   ]  7.49175521946        1
[INPUT] 0    0    [1    /1   ]  2.89254669467        1
[INPUT] 0    0    [1    /1   ]  0.60649032363        1
[INPUT] 0    0    [1    /1   ]  0.211906900804       1
[INPUT] 1    0    [1    /1   ]  1362.78320946        1
[INPUT] 1    0    [1    /1   ]  664.745649101        1
[INPUT] 1    0    [1    /1   ]  300.96184093         1
[INPUT] 1    0    [1    /1   ]  314.042144116        1
[INPUT] 1    0    [1    /1   ]  61.6224637126        1
[INPUT] 1    0    [1    /1   ]  7.33062875472        1
[INPUT] 1    0    [1    /1   ]  20.2383594167        1
[INPUT] 1    0    [1    /1   ]  0.775727630586       1
[INPUT] 1    0    [1    /1   ]  2.80879230631        1
[INPUT] 1    0    [1    /1   ]  0.219319698252       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655864847286, 1.0]], [0, [7617.521894710812, 1.0]], [0, [3617.350877448168, 1.0]], [0, [1597.8252548562825, 1.0]], [0, [382.8513476850318, 1.0]], [0, [108.12334789580007, 1.0]], [0, [34.81988542244281, 1.0]], [0, [7.491755219463787, 1.0]], [0, [2.8925466946742313, 1.0]], [0, [0.6064903236295521, 1.0]], [0, [0.2119069008039322, 1.0]], [1, [1362.783209457819, 1.0]], [1, [664.7456491012846, 1.0]], [1, [300.96184093044997, 1.0]], [1, [314.0421441162894, 1.0]], [1, [61.62246371258589, 1.0]], [1, [7.330628754718192, 1.0]], [1, [20.23835941669973, 1.0]], [1, [0.7757276305858022, 1.0]], [1, [2.8087923063089466, 1.0]], [1, [0.21931969825241734, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586485]
bas 1, expnt(s) = [7617.52189471]
bas 2, expnt(s) = [3617.35087745]
bas 3, expnt(s) = [1597.82525486]
bas 4, expnt(s) = [382.85134769]
bas 5, expnt(s) = [108.1233479]
bas 6, expnt(s) = [34.81988542]
bas 7, expnt(s) = [7.49175522]
bas 8, expnt(s) = [2.89254669]
bas 9, expnt(s) = [0.60649032]
bas 10, expnt(s) = [0.2119069]
bas 11, expnt(s) = [1362.78320946]
bas 12, expnt(s) = [664.7456491]
bas 13, expnt(s) = [300.96184093]
bas 14, expnt(s) = [314.04214412]
bas 15, expnt(s) = [61.62246371]
bas 16, expnt(s) = [7.33062875]
bas 17, expnt(s) = [20.23835942]
bas 18, expnt(s) = [0.77572763]
bas 19, expnt(s) = [2.80879231]
bas 20, expnt(s) = [0.2193197]
CPU time:        42.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752189e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782525e+03 6.38501593e+02
 3.82851348e+02 2.18669222e+02 1.08123348e+02 8.47138925e+01
 3.48198854e+01 3.62147530e+01 7.49175522e+00 1.14407029e+01
 2.89254669e+00 5.60370557e+00 6.06490324e-01 1.73633265e+00
 2.11906901e-01 7.89085111e-01 1.36278321e+03 2.41556017e+04
 6.64745649e+02 9.84699624e+03 3.00961841e+02 3.65698927e+03
 3.14042144e+02 3.85673066e+03 6.16224637e+01 5.03684069e+02
 7.33062875e+00 3.51893241e+01 2.02383594e+01 1.25228599e+02
 7.75727631e-01 2.12383595e+00 2.80879231e+00 1.06080101e+01
 2.19319698e-01 4.37856138e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993944246547102
cond(S) = 103004.78321018275
E1 = -729.5146386362545  E_coul = 203.17209931573058
init E= -526.342539320524
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.556091458571014  LUMO = 0.828948074245531
  mo_energy =
[-1.18327124e+02 -1.22046480e+01 -9.44728466e+00 -9.44728466e+00
 -9.44728466e+00 -1.24007433e+00 -5.56091459e-01 -5.56091459e-01
 -5.56091459e-01  8.28948074e-01  1.01931808e+00  1.01931808e+00
  1.01931808e+00  7.33207135e+00  7.33207135e+00  7.33207135e+00
  1.06534397e+01  3.35036129e+01  3.35036129e+01  3.35036129e+01
  1.01146879e+02  1.29125583e+02  1.29125583e+02  1.29125583e+02
  4.83530954e+02  4.83530954e+02  4.83530954e+02  5.81621339e+02
  1.33542752e+03  1.33542752e+03  1.33542752e+03  2.65047197e+03
  3.02974122e+03  3.02974122e+03  3.02974122e+03  6.65029879e+03
  6.65029879e+03  6.65029879e+03  9.05645651e+03  2.54123756e+04
  7.61550974e+04]
E1 = -727.732981782972  E_coul = 200.99995225510713
cycle= 1 E= -526.733029527865  delta_E= -0.39  |g|= 0.19  |ddm|= 0.294
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.5482
diis-c [-0.30052323  1.        ]
  HOMO = -0.593546963005779  LUMO = 0.803222288185179
  mo_energy =
[-1.18646615e+02 -1.23486040e+01 -9.60303579e+00 -9.60303579e+00
 -9.60303579e+00 -1.28211734e+00 -5.93546963e-01 -5.93546963e-01
 -5.93546963e-01  8.03222288e-01  9.93242447e-01  9.93242447e-01
  9.93242447e-01  7.23617808e+00  7.23617808e+00  7.23617808e+00
  1.05451231e+01  3.33419466e+01  3.33419466e+01  3.33419466e+01
  1.00919423e+02  1.28887521e+02  1.28887521e+02  1.28887521e+02
  4.83212875e+02  4.83212875e+02  4.83212875e+02  5.81264477e+02
  1.33505170e+03  1.33505170e+03  1.33505170e+03  2.64996071e+03
  3.02929871e+03  3.02929871e+03  3.02929871e+03  6.64974234e+03
  6.64974234e+03  6.64974234e+03  9.05582434e+03  2.54116490e+04
  7.61542806e+04]
E1 = -728.3365008377418  E_coul = 201.60267910910142
cycle= 2 E= -526.73382172864  delta_E= -0.000792  |g|= 0.0394  |ddm|= 0.0554
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0782513
diis-c [-0.00340807  0.08725457  0.91274543]
  HOMO = -0.583959292535662  LUMO = 0.810559608396458
  mo_energy =
[-1.18576096e+02 -1.23087699e+01 -9.56151574e+00 -9.56151574e+00
 -9.56151574e+00 -1.27062438e+00 -5.83959293e-01 -5.83959293e-01
 -5.83959293e-01  8.10559608e-01  1.00028036e+00  1.00028036e+00
  1.00028036e+00  7.26105895e+00  7.26105895e+00  7.26105895e+00
  1.05749344e+01  3.33838244e+01  3.33838244e+01  3.33838244e+01
  1.00977259e+02  1.28945822e+02  1.28945822e+02  1.28945822e+02
  4.83282549e+02  4.83282549e+02  4.83282549e+02  5.81336573e+02
  1.33512553e+03  1.33512553e+03  1.33512553e+03  2.65003792e+03
  3.02937483e+03  3.02937483e+03  3.02937483e+03  6.64982021e+03
  6.64982021e+03  6.64982021e+03  9.05590303e+03  2.54117283e+04
  7.61543602e+04]
E1 = -728.17846065529  E_coul = 201.44457353908462
cycle= 3 E= -526.733887116205  delta_E= -6.54e-05  |g|= 0.00638  |ddm|= 0.017
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0134158
diis-c [-7.83694816e-07 -1.32485364e-03  1.41499011e-01  8.59825843e-01]
  HOMO = -0.585508246923273  LUMO = 0.809471789475434
  mo_energy =
[-1.18586210e+02 -1.23146888e+01 -9.56779917e+00 -9.56779917e+00
 -9.56779917e+00 -1.27235747e+00 -5.85508247e-01 -5.85508247e-01
 -5.85508247e-01  8.09471789e-01  9.99169656e-01  9.99169656e-01
  9.99169656e-01  7.25718800e+00  7.25718800e+00  7.25718800e+00
  1.05704709e+01  3.33775269e+01  3.33775269e+01  3.33775269e+01
  1.00968895e+02  1.28937330e+02  1.28937330e+02  1.28937330e+02
  4.83272553e+02  4.83272553e+02  4.83272553e+02  5.81326214e+02
  1.33511493e+03  1.33511493e+03  1.33511493e+03  2.65002667e+03
  3.02936384e+03  3.02936384e+03  3.02936384e+03  6.64980882e+03
  6.64980882e+03  6.64980882e+03  9.05589141e+03  2.54117165e+04
  7.61543482e+04]
E1 = -728.2017722175292  E_coul = 201.46788308542781
cycle= 4 E= -526.733889132101  delta_E= -2.02e-06  |g|= 0.000115  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000147104
diis-c [-5.03140615e-09  8.68692381e-05 -1.18101371e-02 -7.97317977e-02
  1.09145507e+00]
  HOMO = -0.585493567108933  LUMO = 0.80950229123696
  mo_energy =
[-1.18586186e+02 -1.23146315e+01 -9.56775850e+00 -9.56775850e+00
 -9.56775850e+00 -1.27231616e+00 -5.85493567e-01 -5.85493567e-01
 -5.85493567e-01  8.09502291e-01  9.99183214e-01  9.99183214e-01
  9.99183214e-01  7.25722288e+00  7.25722288e+00  7.25722288e+00
  1.05705249e+01  3.33775657e+01  3.33775657e+01  3.33775657e+01
  1.00968935e+02  1.28937364e+02  1.28937364e+02  1.28937364e+02
  4.83272577e+02  4.83272577e+02  4.83272577e+02  5.81326229e+02
  1.33511495e+03  1.33511495e+03  1.33511495e+03  2.65002666e+03
  3.02936384e+03  3.02936384e+03  3.02936384e+03  6.64980880e+03
  6.64980880e+03  6.64980880e+03  9.05589138e+03  2.54117165e+04
  7.61543482e+04]
E1 = -728.2015753285747  E_coul = 201.46768619400225
cycle= 5 E= -526.733889134572  delta_E= -2.47e-09  |g|= 2.23e-05  |ddm|= 0.000191
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.11269e-05
diis-c [-1.08466572e-10  1.45030108e-05 -1.74100372e-03 -1.36333518e-02
  4.00417147e-02  9.75318138e-01]
  HOMO = -0.585502012193832  LUMO = 0.809498577297285
  mo_energy =
[-1.18586219e+02 -1.23146564e+01 -9.56778540e+00 -9.56778540e+00
 -9.56778540e+00 -1.27232280e+00 -5.85502012e-01 -5.85502012e-01
 -5.85502012e-01  8.09498577e-01  9.99177633e-01  9.99177633e-01
  9.99177633e-01  7.25720447e+00  7.25720447e+00  7.25720447e+00
  1.05705057e+01  3.33775396e+01  3.33775396e+01  3.33775396e+01
  1.00968905e+02  1.28937334e+02  1.28937334e+02  1.28937334e+02
  4.83272544e+02  4.83272544e+02  4.83272544e+02  5.81326196e+02
  1.33511491e+03  1.33511491e+03  1.33511491e+03  2.65002662e+03
  3.02936380e+03  3.02936380e+03  3.02936380e+03  6.64980877e+03
  6.64980877e+03  6.64980877e+03  9.05589135e+03  2.54117164e+04
  7.61543481e+04]
E1 = -728.2016633345713  E_coul = 201.4677741999243
cycle= 6 E= -526.733889134647  delta_E= -7.46e-11  |g|= 2.04e-06  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2016633345713  E_coul = 201.4677741999243
  HOMO = -0.585501952773911  LUMO = 0.809498991626425
  mo_energy =
[-1.18586219e+02 -1.23146558e+01 -9.56778494e+00 -9.56778494e+00
 -9.56778494e+00 -1.27232227e+00 -5.85501953e-01 -5.85501953e-01
 -5.85501953e-01  8.09498992e-01  9.99177740e-01  9.99177740e-01
  9.99177740e-01  7.25720477e+00  7.25720477e+00  7.25720477e+00
  1.05705062e+01  3.33775401e+01  3.33775401e+01  3.33775401e+01
  1.00968906e+02  1.28937335e+02  1.28937335e+02  1.28937335e+02
  4.83272545e+02  4.83272545e+02  4.83272545e+02  5.81326196e+02
  1.33511491e+03  1.33511491e+03  1.33511491e+03  2.65002662e+03
  3.02936380e+03  3.02936380e+03  3.02936380e+03  6.64980877e+03
  6.64980877e+03  6.64980877e+03  9.05589135e+03  2.54117164e+04
  7.61543481e+04]
E1 = -728.201660468802  E_coul = 201.4677713341539
Extra cycle  E= -526.733889134648  delta_E= -1.02e-12  |g|= 4.35e-07  |ddm|= 3.77e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826559e+04 7.61752189e+03 3.61735088e+03 1.59782525e+03
 3.82851348e+02 1.08123348e+02 3.48198854e+01 7.49175522e+00
 2.89254669e+00 6.06490324e-01 2.11906901e-01 1.36278321e+03
 6.64745649e+02 3.00961841e+02 3.14042144e+02 6.16224637e+01
 7.33062875e+00 2.02383594e+01 7.75727631e-01 2.80879231e+00
 2.19319698e-01]
E = -526.733889134648
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558648        1
[INPUT] 0    0    [1    /1   ]  7617.52189471        1
[INPUT] 0    0    [1    /1   ]  3617.35087745        1
[INPUT] 0    0    [1    /1   ]  1597.82525486        1
[INPUT] 0    0    [1    /1   ]  382.851347685        1
[INPUT] 0    0    [1    /1   ]  108.123347896        1
[INPUT] 0    0    [1    /1   ]  34.8198854224        1
[INPUT] 0    0    [1    /1   ]  7.49175521946        1
[INPUT] 0    0    [1    /1   ]  2.89254669467        1
[INPUT] 0    0    [1    /1   ]  0.60649032363        1
[INPUT] 0    0    [1    /1   ]  0.211906900804       1
[INPUT] 1    0    [1    /1   ]  1362.78320946        1
[INPUT] 1    0    [1    /1   ]  664.745649101        1
[INPUT] 1    0    [1    /1   ]  300.96184093         1
[INPUT] 1    0    [1    /1   ]  314.042144116        1
[INPUT] 1    0    [1    /1   ]  61.6224637126        1
[INPUT] 1    0    [1    /1   ]  7.33062875472        1
[INPUT] 1    0    [1    /1   ]  20.2383594167        1
[INPUT] 1    0    [1    /1   ]  0.775727630586       1
[INPUT] 1    0    [1    /1   ]  2.80879230631        1
[INPUT] 1    0    [1    /1   ]  0.219319698252       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655864847286, 1.0]], [0, [7617.521894710812, 1.0]], [0, [3617.350877448168, 1.0]], [0, [1597.8252548562825, 1.0]], [0, [382.8513476850318, 1.0]], [0, [108.12334789580007, 1.0]], [0, [34.81988542244281, 1.0]], [0, [7.491755219463787, 1.0]], [0, [2.8925466946742313, 1.0]], [0, [0.6064903236295521, 1.0]], [0, [0.2119069008039322, 1.0]], [1, [1362.783209457819, 1.0]], [1, [664.7456491012846, 1.0]], [1, [300.96184093044997, 1.0]], [1, [314.0421441162894, 1.0]], [1, [61.62246371258589, 1.0]], [1, [7.330628754718192, 1.0]], [1, [20.23835941669973, 1.0]], [1, [0.7757276305858022, 1.0]], [1, [2.8087923063089466, 1.0]], [1, [0.21931969825241734, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586485]
bas 1, expnt(s) = [7617.52189471]
bas 2, expnt(s) = [3617.35087745]
bas 3, expnt(s) = [1597.82525486]
bas 4, expnt(s) = [382.85134769]
bas 5, expnt(s) = [108.1233479]
bas 6, expnt(s) = [34.81988542]
bas 7, expnt(s) = [7.49175522]
bas 8, expnt(s) = [2.89254669]
bas 9, expnt(s) = [0.60649032]
bas 10, expnt(s) = [0.2119069]
bas 11, expnt(s) = [1362.78320946]
bas 12, expnt(s) = [664.7456491]
bas 13, expnt(s) = [300.96184093]
bas 14, expnt(s) = [314.04214412]
bas 15, expnt(s) = [61.62246371]
bas 16, expnt(s) = [7.33062875]
bas 17, expnt(s) = [20.23835942]
bas 18, expnt(s) = [0.77572763]
bas 19, expnt(s) = [2.80879231]
bas 20, expnt(s) = [0.2193197]
CPU time:        43.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752189e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782525e+03 6.38501593e+02
 3.82851348e+02 2.18669222e+02 1.08123348e+02 8.47138925e+01
 3.48198854e+01 3.62147530e+01 7.49175522e+00 1.14407029e+01
 2.89254669e+00 5.60370557e+00 6.06490324e-01 1.73633265e+00
 2.11906901e-01 7.89085111e-01 1.36278321e+03 2.41556017e+04
 6.64745649e+02 9.84699624e+03 3.00961841e+02 3.65698927e+03
 3.14042144e+02 3.85673066e+03 6.16224637e+01 5.03684069e+02
 7.33062875e+00 3.51893241e+01 2.02383594e+01 1.25228599e+02
 7.75727631e-01 2.12383595e+00 2.80879231e+00 1.06080101e+01
 2.19319698e-01 4.37856138e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993944246547102
cond(S) = 103004.78321018275
E1 = -729.5146386362545  E_coul = 203.17209931573058
init E= -526.342539320524
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.556091458571014  LUMO = 0.828948074245531
  mo_energy =
[-1.18327124e+02 -1.22046480e+01 -9.44728466e+00 -9.44728466e+00
 -9.44728466e+00 -1.24007433e+00 -5.56091459e-01 -5.56091459e-01
 -5.56091459e-01  8.28948074e-01  1.01931808e+00  1.01931808e+00
  1.01931808e+00  7.33207135e+00  7.33207135e+00  7.33207135e+00
  1.06534397e+01  3.35036129e+01  3.35036129e+01  3.35036129e+01
  1.01146879e+02  1.29125583e+02  1.29125583e+02  1.29125583e+02
  4.83530954e+02  4.83530954e+02  4.83530954e+02  5.81621339e+02
  1.33542752e+03  1.33542752e+03  1.33542752e+03  2.65047197e+03
  3.02974122e+03  3.02974122e+03  3.02974122e+03  6.65029879e+03
  6.65029879e+03  6.65029879e+03  9.05645651e+03  2.54123756e+04
  7.61550974e+04]
E1 = -727.732981782972  E_coul = 200.99995225510713
cycle= 1 E= -526.733029527865  delta_E= -0.39  |g|= 0.19  |ddm|= 0.294
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.5482
diis-c [-0.30052323  1.        ]
  HOMO = -0.593546963005779  LUMO = 0.803222288185179
  mo_energy =
[-1.18646615e+02 -1.23486040e+01 -9.60303579e+00 -9.60303579e+00
 -9.60303579e+00 -1.28211734e+00 -5.93546963e-01 -5.93546963e-01
 -5.93546963e-01  8.03222288e-01  9.93242447e-01  9.93242447e-01
  9.93242447e-01  7.23617808e+00  7.23617808e+00  7.23617808e+00
  1.05451231e+01  3.33419466e+01  3.33419466e+01  3.33419466e+01
  1.00919423e+02  1.28887521e+02  1.28887521e+02  1.28887521e+02
  4.83212875e+02  4.83212875e+02  4.83212875e+02  5.81264477e+02
  1.33505170e+03  1.33505170e+03  1.33505170e+03  2.64996071e+03
  3.02929871e+03  3.02929871e+03  3.02929871e+03  6.64974234e+03
  6.64974234e+03  6.64974234e+03  9.05582434e+03  2.54116490e+04
  7.61542806e+04]
E1 = -728.3365008377418  E_coul = 201.60267910910142
cycle= 2 E= -526.73382172864  delta_E= -0.000792  |g|= 0.0394  |ddm|= 0.0554
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0782513
diis-c [-0.00340807  0.08725457  0.91274543]
  HOMO = -0.583959292535662  LUMO = 0.810559608396458
  mo_energy =
[-1.18576096e+02 -1.23087699e+01 -9.56151574e+00 -9.56151574e+00
 -9.56151574e+00 -1.27062438e+00 -5.83959293e-01 -5.83959293e-01
 -5.83959293e-01  8.10559608e-01  1.00028036e+00  1.00028036e+00
  1.00028036e+00  7.26105895e+00  7.26105895e+00  7.26105895e+00
  1.05749344e+01  3.33838244e+01  3.33838244e+01  3.33838244e+01
  1.00977259e+02  1.28945822e+02  1.28945822e+02  1.28945822e+02
  4.83282549e+02  4.83282549e+02  4.83282549e+02  5.81336573e+02
  1.33512553e+03  1.33512553e+03  1.33512553e+03  2.65003792e+03
  3.02937483e+03  3.02937483e+03  3.02937483e+03  6.64982021e+03
  6.64982021e+03  6.64982021e+03  9.05590303e+03  2.54117283e+04
  7.61543602e+04]
E1 = -728.17846065529  E_coul = 201.44457353908462
cycle= 3 E= -526.733887116205  delta_E= -6.54e-05  |g|= 0.00638  |ddm|= 0.017
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0134158
diis-c [-7.83694816e-07 -1.32485364e-03  1.41499011e-01  8.59825843e-01]
  HOMO = -0.585508246923273  LUMO = 0.809471789475434
  mo_energy =
[-1.18586210e+02 -1.23146888e+01 -9.56779917e+00 -9.56779917e+00
 -9.56779917e+00 -1.27235747e+00 -5.85508247e-01 -5.85508247e-01
 -5.85508247e-01  8.09471789e-01  9.99169656e-01  9.99169656e-01
  9.99169656e-01  7.25718800e+00  7.25718800e+00  7.25718800e+00
  1.05704709e+01  3.33775269e+01  3.33775269e+01  3.33775269e+01
  1.00968895e+02  1.28937330e+02  1.28937330e+02  1.28937330e+02
  4.83272553e+02  4.83272553e+02  4.83272553e+02  5.81326214e+02
  1.33511493e+03  1.33511493e+03  1.33511493e+03  2.65002667e+03
  3.02936384e+03  3.02936384e+03  3.02936384e+03  6.64980882e+03
  6.64980882e+03  6.64980882e+03  9.05589141e+03  2.54117165e+04
  7.61543482e+04]
E1 = -728.2017722175292  E_coul = 201.46788308542781
cycle= 4 E= -526.733889132101  delta_E= -2.02e-06  |g|= 0.000115  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000147104
diis-c [-5.03140615e-09  8.68692381e-05 -1.18101371e-02 -7.97317977e-02
  1.09145507e+00]
  HOMO = -0.585493567108933  LUMO = 0.80950229123696
  mo_energy =
[-1.18586186e+02 -1.23146315e+01 -9.56775850e+00 -9.56775850e+00
 -9.56775850e+00 -1.27231616e+00 -5.85493567e-01 -5.85493567e-01
 -5.85493567e-01  8.09502291e-01  9.99183214e-01  9.99183214e-01
  9.99183214e-01  7.25722288e+00  7.25722288e+00  7.25722288e+00
  1.05705249e+01  3.33775657e+01  3.33775657e+01  3.33775657e+01
  1.00968935e+02  1.28937364e+02  1.28937364e+02  1.28937364e+02
  4.83272577e+02  4.83272577e+02  4.83272577e+02  5.81326229e+02
  1.33511495e+03  1.33511495e+03  1.33511495e+03  2.65002666e+03
  3.02936384e+03  3.02936384e+03  3.02936384e+03  6.64980880e+03
  6.64980880e+03  6.64980880e+03  9.05589138e+03  2.54117165e+04
  7.61543482e+04]
E1 = -728.2015753285747  E_coul = 201.46768619400225
cycle= 5 E= -526.733889134572  delta_E= -2.47e-09  |g|= 2.23e-05  |ddm|= 0.000191
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.11269e-05
diis-c [-1.08466572e-10  1.45030108e-05 -1.74100372e-03 -1.36333518e-02
  4.00417147e-02  9.75318138e-01]
  HOMO = -0.585502012193832  LUMO = 0.809498577297285
  mo_energy =
[-1.18586219e+02 -1.23146564e+01 -9.56778540e+00 -9.56778540e+00
 -9.56778540e+00 -1.27232280e+00 -5.85502012e-01 -5.85502012e-01
 -5.85502012e-01  8.09498577e-01  9.99177633e-01  9.99177633e-01
  9.99177633e-01  7.25720447e+00  7.25720447e+00  7.25720447e+00
  1.05705057e+01  3.33775396e+01  3.33775396e+01  3.33775396e+01
  1.00968905e+02  1.28937334e+02  1.28937334e+02  1.28937334e+02
  4.83272544e+02  4.83272544e+02  4.83272544e+02  5.81326196e+02
  1.33511491e+03  1.33511491e+03  1.33511491e+03  2.65002662e+03
  3.02936380e+03  3.02936380e+03  3.02936380e+03  6.64980877e+03
  6.64980877e+03  6.64980877e+03  9.05589135e+03  2.54117164e+04
  7.61543481e+04]
E1 = -728.2016633345713  E_coul = 201.4677741999243
cycle= 6 E= -526.733889134647  delta_E= -7.46e-11  |g|= 2.04e-06  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2016633345713  E_coul = 201.4677741999243
  HOMO = -0.585501952773911  LUMO = 0.809498991626425
  mo_energy =
[-1.18586219e+02 -1.23146558e+01 -9.56778494e+00 -9.56778494e+00
 -9.56778494e+00 -1.27232227e+00 -5.85501953e-01 -5.85501953e-01
 -5.85501953e-01  8.09498992e-01  9.99177740e-01  9.99177740e-01
  9.99177740e-01  7.25720477e+00  7.25720477e+00  7.25720477e+00
  1.05705062e+01  3.33775401e+01  3.33775401e+01  3.33775401e+01
  1.00968906e+02  1.28937335e+02  1.28937335e+02  1.28937335e+02
  4.83272545e+02  4.83272545e+02  4.83272545e+02  5.81326196e+02
  1.33511491e+03  1.33511491e+03  1.33511491e+03  2.65002662e+03
  3.02936380e+03  3.02936380e+03  3.02936380e+03  6.64980877e+03
  6.64980877e+03  6.64980877e+03  9.05589135e+03  2.54117164e+04
  7.61543481e+04]
E1 = -728.201660468802  E_coul = 201.4677713341539
Extra cycle  E= -526.733889134648  delta_E= -1.02e-12  |g|= 4.35e-07  |ddm|= 3.77e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103004.78321018275
E1 = -728.201660468802  E_coul = 201.4677713341539
init E= -526.733889134648
    CPU time for initialize scf      0.89 sec, wall time      0.24 sec
  HOMO = -0.585502027665067  LUMO = 0.809499013917682
  mo_energy =
[-1.18586219e+02 -1.23146560e+01 -9.56778518e+00 -9.56778518e+00
 -9.56778518e+00 -1.27232226e+00 -5.85502028e-01 -5.85502028e-01
 -5.85502028e-01  8.09499014e-01  9.99177701e-01  9.99177701e-01
  9.99177701e-01  7.25720462e+00  7.25720462e+00  7.25720462e+00
  1.05705061e+01  3.33775398e+01  3.33775398e+01  3.33775398e+01
  1.00968906e+02  1.28937334e+02  1.28937334e+02  1.28937334e+02
  4.83272544e+02  4.83272544e+02  4.83272544e+02  5.81326196e+02
  1.33511491e+03  1.33511491e+03  1.33511491e+03  2.65002662e+03
  3.02936380e+03  3.02936380e+03  3.02936380e+03  6.64980877e+03
  6.64980877e+03  6.64980877e+03  9.05589135e+03  2.54117164e+04
  7.61543481e+04]
E1 = -728.2016610748328  E_coul = 201.46777194018358
cycle= 1 E= -526.733889134649  delta_E= -1.14e-12  |g|= 9.89e-08  |ddm|= 7.23e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2016610748328  E_coul = 201.46777194018358
  HOMO = -0.58550202028371  LUMO = 0.809499035549485
  mo_energy =
[-1.18586219e+02 -1.23146560e+01 -9.56778513e+00 -9.56778513e+00
 -9.56778513e+00 -1.27232223e+00 -5.85502020e-01 -5.85502020e-01
 -5.85502020e-01  8.09499036e-01  9.99177709e-01  9.99177709e-01
  9.99177709e-01  7.25720464e+00  7.25720464e+00  7.25720464e+00
  1.05705061e+01  3.33775399e+01  3.33775399e+01  3.33775399e+01
  1.00968906e+02  1.28937334e+02  1.28937334e+02  1.28937334e+02
  4.83272545e+02  4.83272545e+02  4.83272545e+02  5.81326196e+02
  1.33511491e+03  1.33511491e+03  1.33511491e+03  2.65002662e+03
  3.02936380e+03  3.02936380e+03  3.02936380e+03  6.64980877e+03
  6.64980877e+03  6.64980877e+03  9.05589135e+03  2.54117164e+04
  7.61543481e+04]
E1 = -728.2016608605722  E_coul = 201.46777172592417
Extra cycle  E= -526.733889134648  delta_E= 1.14e-12  |g|= 2.13e-08  |ddm|= 1.65e-07
    CPU time for scf_cycle      1.20 sec, wall time      0.54 sec
exp = [2.61826559e+04 7.61752189e+03 3.61735088e+03 1.59782525e+03
 3.82851348e+02 1.08123348e+02 3.48198854e+01 7.49175522e+00
 2.89254669e+00 6.06490324e-01 2.11906901e-01 1.36278321e+03
 6.64745649e+02 3.00961841e+02 3.14042144e+02 6.16224637e+01
 7.33062875e+00 2.02383594e+01 7.75727631e-01 2.80879231e+00
 2.19319698e-01]
grad_E = [-1.51853976e-06  3.32170635e-06 -1.57299870e-06  6.98769370e-05
 -5.22493582e-05 -8.52768901e-05 -3.60588720e-03 -5.32048607e-04
 -7.54863183e-03 -8.53274240e-03 -6.62962839e-03 -5.04962943e-07
  5.03620049e-06  2.37889225e-05  2.05099627e-05 -3.58125078e-05
 -4.05572750e-04  1.32338419e-04  2.41027436e-02 -2.22334163e-04
 -8.54283236e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558687        1
[INPUT] 0    0    [1    /1   ]  7617.52188628        1
[INPUT] 0    0    [1    /1   ]  3617.35088146        1
[INPUT] 0    0    [1    /1   ]  1597.82507764        1
[INPUT] 0    0    [1    /1   ]  382.851465776        1
[INPUT] 0    0    [1    /1   ]  108.123759318        1
[INPUT] 0    0    [1    /1   ]  34.8281073857        1
[INPUT] 0    0    [1    /1   ]  7.48223710831        1
[INPUT] 0    0    [1    /1   ]  2.94082365376        1
[INPUT] 0    0    [1    /1   ]  0.622574885439       1
[INPUT] 0    0    [1    /1   ]  0.223545050565       1
[INPUT] 1    0    [1    /1   ]  1362.78321074        1
[INPUT] 1    0    [1    /1   ]  664.745636305        1
[INPUT] 1    0    [1    /1   ]  300.961780495        1
[INPUT] 1    0    [1    /1   ]  314.04209201         1
[INPUT] 1    0    [1    /1   ]  61.6225447792        1
[INPUT] 1    0    [1    /1   ]  7.33075460435        1
[INPUT] 1    0    [1    /1   ]  20.2381359632        1
[INPUT] 1    0    [1    /1   ]  0.775104331798       1
[INPUT] 1    0    [1    /1   ]  2.80924498978        1
[INPUT] 1    0    [1    /1   ]  0.222084202367       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65586870702, 1.0]], [0, [7617.521886276913, 1.0]], [0, [3617.3508814555803, 1.0]], [0, [1597.8250776416148, 1.0]], [0, [382.85146577624437, 1.0]], [0, [108.12375931780696, 1.0]], [0, [34.82810738567818, 1.0]], [0, [7.482237108312014, 1.0]], [0, [2.940823653757364, 1.0]], [0, [0.6225748854385311, 1.0]], [0, [0.22354505056489782, 1.0]], [1, [1362.7832107415836, 1.0]], [1, [664.7456363046133, 1.0]], [1, [300.96178049504573, 1.0]], [1, [314.0420920097811, 1.0]], [1, [61.62254477919818, 1.0]], [1, [7.330754604346848, 1.0]], [1, [20.238135963239426, 1.0]], [1, [0.7751043317975069, 1.0]], [1, [2.8092449897773597, 1.0]], [1, [0.22208420236711476, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586871]
bas 1, expnt(s) = [7617.52188628]
bas 2, expnt(s) = [3617.35088146]
bas 3, expnt(s) = [1597.82507764]
bas 4, expnt(s) = [382.85146578]
bas 5, expnt(s) = [108.12375932]
bas 6, expnt(s) = [34.82810739]
bas 7, expnt(s) = [7.48223711]
bas 8, expnt(s) = [2.94082365]
bas 9, expnt(s) = [0.62257489]
bas 10, expnt(s) = [0.22354505]
bas 11, expnt(s) = [1362.78321074]
bas 12, expnt(s) = [664.7456363]
bas 13, expnt(s) = [300.9617805]
bas 14, expnt(s) = [314.04209201]
bas 15, expnt(s) = [61.62254478]
bas 16, expnt(s) = [7.3307546]
bas 17, expnt(s) = [20.23813596]
bas 18, expnt(s) = [0.77510433]
bas 19, expnt(s) = [2.80924499]
bas 20, expnt(s) = [0.2220842]
CPU time:        48.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752189e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782508e+03 6.38501540e+02
 3.82851466e+02 2.18669272e+02 1.08123759e+02 8.47141343e+01
 3.48281074e+01 3.62211663e+01 7.48223711e+00 1.14297998e+01
 2.94082365e+00 5.67370513e+00 6.22574885e-01 1.77075600e+00
 2.23545051e-01 8.21369966e-01 1.36278321e+03 2.41556017e+04
 6.64745636e+02 9.84699600e+03 3.00961780e+02 3.65698835e+03
 3.14042092e+02 3.85672986e+03 6.16225448e+01 5.03684897e+02
 7.33075460e+00 3.51900792e+01 2.02381360e+01 1.25226871e+02
 7.75104332e-01 2.12170303e+00 2.80924499e+00 1.06101473e+01
 2.22084202e-01 4.44765893e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99382707944595
cond(S) = 103105.22938541236
E1 = -729.5107519280273  E_coul = 203.16993929571015
init E= -526.340812632317
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555921096981554  LUMO = 0.888685573434117
  mo_energy =
[-1.18327718e+02 -1.22048236e+01 -9.44761713e+00 -9.44761713e+00
 -9.44761713e+00 -1.24008168e+00 -5.55921097e-01 -5.55921097e-01
 -5.55921097e-01  8.88685573e-01  1.02985602e+00  1.02985602e+00
  1.02985602e+00  7.34132513e+00  7.34132513e+00  7.34132513e+00
  1.09053549e+01  3.35107469e+01  3.35107469e+01  3.35107469e+01
  1.01451118e+02  1.29130808e+02  1.29130808e+02  1.29130808e+02
  4.83534432e+02  4.83534432e+02  4.83534432e+02  5.81887786e+02
  1.33543046e+03  1.33543046e+03  1.33543046e+03  2.65070269e+03
  3.02974368e+03  3.02974368e+03  3.02974368e+03  6.65030084e+03
  6.65030084e+03  6.65030084e+03  9.05666715e+03  2.54125745e+04
  7.61552826e+04]
E1 = -727.7968540566036  E_coul = 201.0632923041812
cycle= 1 E= -526.733561752422  delta_E= -0.393  |g|= 0.189  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546447
diis-c [-0.29860414  1.        ]
  HOMO = -0.59133803742142  LUMO = 0.863160331711445
  mo_energy =
[-1.18642020e+02 -1.23441936e+01 -9.59851511e+00 -9.59851511e+00
 -9.59851511e+00 -1.27987866e+00 -5.91338037e-01 -5.91338037e-01
 -5.91338037e-01  8.63160332e-01  1.00515280e+00  1.00515280e+00
  1.00515280e+00  7.24930786e+00  7.24930786e+00  7.24930786e+00
  1.08004613e+01  3.33537627e+01  3.33537627e+01  3.33537627e+01
  1.01229035e+02  1.28897816e+02  1.28897816e+02  1.28897816e+02
  4.83221602e+02  4.83221602e+02  4.83221602e+02  5.81536032e+02
  1.33505974e+03  1.33505974e+03  1.33505974e+03  2.65019649e+03
  3.02930626e+03  3.02930626e+03  3.02930626e+03  6.64974942e+03
  6.64974942e+03  6.64974942e+03  9.05603997e+03  2.54118529e+04
  7.61544707e+04]
E1 = -728.3810823892157  E_coul = 201.64676993921503
cycle= 2 E= -526.734312450001  delta_E= -0.000751  |g|= 0.0384  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0765136
diis-c [-0.00329632  0.08514618  0.91485382]
  HOMO = -0.582105935294433  LUMO = 0.870589087909424
  mo_energy =
[-1.18573206e+02 -1.23055846e+01 -9.55824347e+00 -9.55824347e+00
 -9.55824347e+00 -1.26881827e+00 -5.82105935e-01 -5.82105935e-01
 -5.82105935e-01  8.70589088e-01  1.01195886e+00  1.01195886e+00
  1.01195886e+00  7.27335399e+00  7.27335399e+00  7.27335399e+00
  1.08294271e+01  3.33944084e+01  3.33944084e+01  3.33944084e+01
  1.01285357e+02  1.28954598e+02  1.28954598e+02  1.28954598e+02
  4.83289588e+02  4.83289588e+02  4.83289588e+02  5.81606404e+02
  1.33513182e+03  1.33513182e+03  1.33513182e+03  2.65027191e+03
  3.02938060e+03  3.02938060e+03  3.02938060e+03  6.64982549e+03
  6.64982549e+03  6.64982549e+03  9.05611686e+03  2.54119304e+04
  7.61545484e+04]
E1 = -728.2286598766376  E_coul = 201.49428636853918
cycle= 3 E= -526.734373508098  delta_E= -6.11e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131495
diis-c [-7.27261950e-07 -1.30722413e-03  1.41811230e-01  8.59495994e-01]
  HOMO = -0.583606009790081  LUMO = 0.869480778218247
  mo_energy =
[-1.18583121e+02 -1.23113677e+01 -9.56438197e+00 -9.56438197e+00
 -9.56438197e+00 -1.27049883e+00 -5.83606010e-01 -5.83606010e-01
 -5.83606010e-01  8.69480778e-01  1.01087919e+00  1.01087919e+00
  1.01087919e+00  7.26958674e+00  7.26958674e+00  7.26958674e+00
  1.08250547e+01  3.33882554e+01  3.33882554e+01  3.33882554e+01
  1.01277168e+02  1.28946283e+02  1.28946283e+02  1.28946283e+02
  4.83279788e+02  4.83279788e+02  4.83279788e+02  5.81596248e+02
  1.33512143e+03  1.33512143e+03  1.33512143e+03  2.65026087e+03
  3.02936982e+03  3.02936982e+03  3.02936982e+03  6.64981431e+03
  6.64981431e+03  6.64981431e+03  9.05610546e+03  2.54119188e+04
  7.61545367e+04]
E1 = -728.2513102315697  E_coul = 201.51693481732042
cycle= 4 E= -526.734375414249  delta_E= -1.91e-06  |g|= 0.00011  |ddm|= 0.00221
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000133636
diis-c [-4.82073022e-09  8.07408952e-05 -1.11769041e-02 -7.47698263e-02
  1.08586599e+00]
  HOMO = -0.583588737100454  LUMO = 0.869513515124225
  mo_energy =
[-1.18583088e+02 -1.23113045e+01 -9.56433427e+00 -9.56433427e+00
 -9.56433427e+00 -1.27045602e+00 -5.83588737e-01 -5.83588737e-01
 -5.83588737e-01  8.69513515e-01  1.01089452e+00  1.01089452e+00
  1.01089452e+00  7.26962664e+00  7.26962664e+00  7.26962664e+00
  1.08251132e+01  3.33883012e+01  3.33883012e+01  3.33883012e+01
  1.01277216e+02  1.28946326e+02  1.28946326e+02  1.28946326e+02
  4.83279822e+02  4.83279822e+02  4.83279822e+02  5.81596274e+02
  1.33512145e+03  1.33512145e+03  1.33512145e+03  2.65026087e+03
  3.02936983e+03  3.02936983e+03  3.02936983e+03  6.64981431e+03
  6.64981431e+03  6.64981431e+03  9.05610545e+03  2.54119188e+04
  7.61545366e+04]
E1 = -728.2510971346024  E_coul = 201.51672171812623
cycle= 5 E= -526.734375416476  delta_E= -2.23e-09  |g|= 2.21e-05  |ddm|= 0.000182
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.10878e-05
diis-c [-9.94627962e-11  1.47326034e-05 -1.79225106e-03 -1.39640936e-02
  4.41389952e-02  9.71602617e-01]
  HOMO = -0.583596952496467  LUMO = 0.869509679290502
  mo_energy =
[-1.18583121e+02 -1.23113290e+01 -9.56436075e+00 -9.56436075e+00
 -9.56436075e+00 -1.27046251e+00 -5.83596952e-01 -5.83596952e-01
 -5.83596952e-01  8.69509679e-01  1.01088907e+00  1.01088907e+00
  1.01088907e+00  7.26960859e+00  7.26960859e+00  7.26960859e+00
  1.08250943e+01  3.33882755e+01  3.33882755e+01  3.33882755e+01
  1.01277187e+02  1.28946295e+02  1.28946295e+02  1.28946295e+02
  4.83279789e+02  4.83279789e+02  4.83279789e+02  5.81596240e+02
  1.33512142e+03  1.33512142e+03  1.33512142e+03  2.65026084e+03
  3.02936980e+03  3.02936980e+03  3.02936980e+03  6.64981427e+03
  6.64981427e+03  6.64981427e+03  9.05610541e+03  2.54119187e+04
  7.61545366e+04]
E1 = -728.2511836027924  E_coul = 201.51680818624737
cycle= 6 E= -526.734375416545  delta_E= -6.87e-11  |g|= 1.98e-06  |ddm|= 2.12e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2511836027924  E_coul = 201.51680818624737
  HOMO = -0.583596961233407  LUMO = 0.86951004824456
  mo_energy =
[-1.18583120e+02 -1.23113287e+01 -9.56436055e+00 -9.56436055e+00
 -9.56436055e+00 -1.27046207e+00 -5.83596961e-01 -5.83596961e-01
 -5.83596961e-01  8.69510048e-01  1.01088913e+00  1.01088913e+00
  1.01088913e+00  7.26960872e+00  7.26960872e+00  7.26960872e+00
  1.08250946e+01  3.33882757e+01  3.33882757e+01  3.33882757e+01
  1.01277187e+02  1.28946296e+02  1.28946296e+02  1.28946296e+02
  4.83279790e+02  4.83279790e+02  4.83279790e+02  5.81596241e+02
  1.33512142e+03  1.33512142e+03  1.33512142e+03  2.65026084e+03
  3.02936980e+03  3.02936980e+03  3.02936980e+03  6.64981427e+03
  6.64981427e+03  6.64981427e+03  9.05610541e+03  2.54119187e+04
  7.61545366e+04]
E1 = -728.2511817497091  E_coul = 201.51680633316252
Extra cycle  E= -526.734375416547  delta_E= -1.59e-12  |g|= 4.15e-07  |ddm|= 3.61e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61826559e+04 7.61752189e+03 3.61735088e+03 1.59782508e+03
 3.82851466e+02 1.08123759e+02 3.48281074e+01 7.48223711e+00
 2.94082365e+00 6.22574885e-01 2.23545051e-01 1.36278321e+03
 6.64745636e+02 3.00961780e+02 3.14042092e+02 6.16225448e+01
 7.33075460e+00 2.02381360e+01 7.75104332e-01 2.80924499e+00
 2.22084202e-01]
E = -526.7343754165465
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558687        1
[INPUT] 0    0    [1    /1   ]  7617.52188628        1
[INPUT] 0    0    [1    /1   ]  3617.35088146        1
[INPUT] 0    0    [1    /1   ]  1597.82507764        1
[INPUT] 0    0    [1    /1   ]  382.851465776        1
[INPUT] 0    0    [1    /1   ]  108.123759318        1
[INPUT] 0    0    [1    /1   ]  34.8281073857        1
[INPUT] 0    0    [1    /1   ]  7.48223710831        1
[INPUT] 0    0    [1    /1   ]  2.94082365376        1
[INPUT] 0    0    [1    /1   ]  0.622574885439       1
[INPUT] 0    0    [1    /1   ]  0.223545050565       1
[INPUT] 1    0    [1    /1   ]  1362.78321074        1
[INPUT] 1    0    [1    /1   ]  664.745636305        1
[INPUT] 1    0    [1    /1   ]  300.961780495        1
[INPUT] 1    0    [1    /1   ]  314.04209201         1
[INPUT] 1    0    [1    /1   ]  61.6225447792        1
[INPUT] 1    0    [1    /1   ]  7.33075460435        1
[INPUT] 1    0    [1    /1   ]  20.2381359632        1
[INPUT] 1    0    [1    /1   ]  0.775104331798       1
[INPUT] 1    0    [1    /1   ]  2.80924498978        1
[INPUT] 1    0    [1    /1   ]  0.222084202367       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65586870702, 1.0]], [0, [7617.521886276913, 1.0]], [0, [3617.3508814555803, 1.0]], [0, [1597.8250776416148, 1.0]], [0, [382.85146577624437, 1.0]], [0, [108.12375931780696, 1.0]], [0, [34.82810738567818, 1.0]], [0, [7.482237108312014, 1.0]], [0, [2.940823653757364, 1.0]], [0, [0.6225748854385311, 1.0]], [0, [0.22354505056489782, 1.0]], [1, [1362.7832107415836, 1.0]], [1, [664.7456363046133, 1.0]], [1, [300.96178049504573, 1.0]], [1, [314.0420920097811, 1.0]], [1, [61.62254477919818, 1.0]], [1, [7.330754604346848, 1.0]], [1, [20.238135963239426, 1.0]], [1, [0.7751043317975069, 1.0]], [1, [2.8092449897773597, 1.0]], [1, [0.22208420236711476, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65586871]
bas 1, expnt(s) = [7617.52188628]
bas 2, expnt(s) = [3617.35088146]
bas 3, expnt(s) = [1597.82507764]
bas 4, expnt(s) = [382.85146578]
bas 5, expnt(s) = [108.12375932]
bas 6, expnt(s) = [34.82810739]
bas 7, expnt(s) = [7.48223711]
bas 8, expnt(s) = [2.94082365]
bas 9, expnt(s) = [0.62257489]
bas 10, expnt(s) = [0.22354505]
bas 11, expnt(s) = [1362.78321074]
bas 12, expnt(s) = [664.7456363]
bas 13, expnt(s) = [300.9617805]
bas 14, expnt(s) = [314.04209201]
bas 15, expnt(s) = [61.62254478]
bas 16, expnt(s) = [7.3307546]
bas 17, expnt(s) = [20.23813596]
bas 18, expnt(s) = [0.77510433]
bas 19, expnt(s) = [2.80924499]
bas 20, expnt(s) = [0.2220842]
CPU time:        49.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752189e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782508e+03 6.38501540e+02
 3.82851466e+02 2.18669272e+02 1.08123759e+02 8.47141343e+01
 3.48281074e+01 3.62211663e+01 7.48223711e+00 1.14297998e+01
 2.94082365e+00 5.67370513e+00 6.22574885e-01 1.77075600e+00
 2.23545051e-01 8.21369966e-01 1.36278321e+03 2.41556017e+04
 6.64745636e+02 9.84699600e+03 3.00961780e+02 3.65698835e+03
 3.14042092e+02 3.85672986e+03 6.16225448e+01 5.03684897e+02
 7.33075460e+00 3.51900792e+01 2.02381360e+01 1.25226871e+02
 7.75104332e-01 2.12170303e+00 2.80924499e+00 1.06101473e+01
 2.22084202e-01 4.44765893e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99382707944595
cond(S) = 103105.22938541236
E1 = -729.5107519280273  E_coul = 203.16993929571015
init E= -526.340812632317
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555921096981554  LUMO = 0.888685573434117
  mo_energy =
[-1.18327718e+02 -1.22048236e+01 -9.44761713e+00 -9.44761713e+00
 -9.44761713e+00 -1.24008168e+00 -5.55921097e-01 -5.55921097e-01
 -5.55921097e-01  8.88685573e-01  1.02985602e+00  1.02985602e+00
  1.02985602e+00  7.34132513e+00  7.34132513e+00  7.34132513e+00
  1.09053549e+01  3.35107469e+01  3.35107469e+01  3.35107469e+01
  1.01451118e+02  1.29130808e+02  1.29130808e+02  1.29130808e+02
  4.83534432e+02  4.83534432e+02  4.83534432e+02  5.81887786e+02
  1.33543046e+03  1.33543046e+03  1.33543046e+03  2.65070269e+03
  3.02974368e+03  3.02974368e+03  3.02974368e+03  6.65030084e+03
  6.65030084e+03  6.65030084e+03  9.05666715e+03  2.54125745e+04
  7.61552826e+04]
E1 = -727.7968540566036  E_coul = 201.0632923041812
cycle= 1 E= -526.733561752422  delta_E= -0.393  |g|= 0.189  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546447
diis-c [-0.29860414  1.        ]
  HOMO = -0.59133803742142  LUMO = 0.863160331711445
  mo_energy =
[-1.18642020e+02 -1.23441936e+01 -9.59851511e+00 -9.59851511e+00
 -9.59851511e+00 -1.27987866e+00 -5.91338037e-01 -5.91338037e-01
 -5.91338037e-01  8.63160332e-01  1.00515280e+00  1.00515280e+00
  1.00515280e+00  7.24930786e+00  7.24930786e+00  7.24930786e+00
  1.08004613e+01  3.33537627e+01  3.33537627e+01  3.33537627e+01
  1.01229035e+02  1.28897816e+02  1.28897816e+02  1.28897816e+02
  4.83221602e+02  4.83221602e+02  4.83221602e+02  5.81536032e+02
  1.33505974e+03  1.33505974e+03  1.33505974e+03  2.65019649e+03
  3.02930626e+03  3.02930626e+03  3.02930626e+03  6.64974942e+03
  6.64974942e+03  6.64974942e+03  9.05603997e+03  2.54118529e+04
  7.61544707e+04]
E1 = -728.3810823892157  E_coul = 201.64676993921503
cycle= 2 E= -526.734312450001  delta_E= -0.000751  |g|= 0.0384  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0765136
diis-c [-0.00329632  0.08514618  0.91485382]
  HOMO = -0.582105935294433  LUMO = 0.870589087909424
  mo_energy =
[-1.18573206e+02 -1.23055846e+01 -9.55824347e+00 -9.55824347e+00
 -9.55824347e+00 -1.26881827e+00 -5.82105935e-01 -5.82105935e-01
 -5.82105935e-01  8.70589088e-01  1.01195886e+00  1.01195886e+00
  1.01195886e+00  7.27335399e+00  7.27335399e+00  7.27335399e+00
  1.08294271e+01  3.33944084e+01  3.33944084e+01  3.33944084e+01
  1.01285357e+02  1.28954598e+02  1.28954598e+02  1.28954598e+02
  4.83289588e+02  4.83289588e+02  4.83289588e+02  5.81606404e+02
  1.33513182e+03  1.33513182e+03  1.33513182e+03  2.65027191e+03
  3.02938060e+03  3.02938060e+03  3.02938060e+03  6.64982549e+03
  6.64982549e+03  6.64982549e+03  9.05611686e+03  2.54119304e+04
  7.61545484e+04]
E1 = -728.2286598766376  E_coul = 201.49428636853918
cycle= 3 E= -526.734373508098  delta_E= -6.11e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131495
diis-c [-7.27261950e-07 -1.30722413e-03  1.41811230e-01  8.59495994e-01]
  HOMO = -0.583606009790081  LUMO = 0.869480778218247
  mo_energy =
[-1.18583121e+02 -1.23113677e+01 -9.56438197e+00 -9.56438197e+00
 -9.56438197e+00 -1.27049883e+00 -5.83606010e-01 -5.83606010e-01
 -5.83606010e-01  8.69480778e-01  1.01087919e+00  1.01087919e+00
  1.01087919e+00  7.26958674e+00  7.26958674e+00  7.26958674e+00
  1.08250547e+01  3.33882554e+01  3.33882554e+01  3.33882554e+01
  1.01277168e+02  1.28946283e+02  1.28946283e+02  1.28946283e+02
  4.83279788e+02  4.83279788e+02  4.83279788e+02  5.81596248e+02
  1.33512143e+03  1.33512143e+03  1.33512143e+03  2.65026087e+03
  3.02936982e+03  3.02936982e+03  3.02936982e+03  6.64981431e+03
  6.64981431e+03  6.64981431e+03  9.05610546e+03  2.54119188e+04
  7.61545367e+04]
E1 = -728.2513102315697  E_coul = 201.51693481732042
cycle= 4 E= -526.734375414249  delta_E= -1.91e-06  |g|= 0.00011  |ddm|= 0.00221
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000133636
diis-c [-4.82073022e-09  8.07408952e-05 -1.11769041e-02 -7.47698263e-02
  1.08586599e+00]
  HOMO = -0.583588737100454  LUMO = 0.869513515124225
  mo_energy =
[-1.18583088e+02 -1.23113045e+01 -9.56433427e+00 -9.56433427e+00
 -9.56433427e+00 -1.27045602e+00 -5.83588737e-01 -5.83588737e-01
 -5.83588737e-01  8.69513515e-01  1.01089452e+00  1.01089452e+00
  1.01089452e+00  7.26962664e+00  7.26962664e+00  7.26962664e+00
  1.08251132e+01  3.33883012e+01  3.33883012e+01  3.33883012e+01
  1.01277216e+02  1.28946326e+02  1.28946326e+02  1.28946326e+02
  4.83279822e+02  4.83279822e+02  4.83279822e+02  5.81596274e+02
  1.33512145e+03  1.33512145e+03  1.33512145e+03  2.65026087e+03
  3.02936983e+03  3.02936983e+03  3.02936983e+03  6.64981431e+03
  6.64981431e+03  6.64981431e+03  9.05610545e+03  2.54119188e+04
  7.61545366e+04]
E1 = -728.2510971346024  E_coul = 201.51672171812623
cycle= 5 E= -526.734375416476  delta_E= -2.23e-09  |g|= 2.21e-05  |ddm|= 0.000182
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.10878e-05
diis-c [-9.94627962e-11  1.47326034e-05 -1.79225106e-03 -1.39640936e-02
  4.41389952e-02  9.71602617e-01]
  HOMO = -0.583596952496467  LUMO = 0.869509679290502
  mo_energy =
[-1.18583121e+02 -1.23113290e+01 -9.56436075e+00 -9.56436075e+00
 -9.56436075e+00 -1.27046251e+00 -5.83596952e-01 -5.83596952e-01
 -5.83596952e-01  8.69509679e-01  1.01088907e+00  1.01088907e+00
  1.01088907e+00  7.26960859e+00  7.26960859e+00  7.26960859e+00
  1.08250943e+01  3.33882755e+01  3.33882755e+01  3.33882755e+01
  1.01277187e+02  1.28946295e+02  1.28946295e+02  1.28946295e+02
  4.83279789e+02  4.83279789e+02  4.83279789e+02  5.81596240e+02
  1.33512142e+03  1.33512142e+03  1.33512142e+03  2.65026084e+03
  3.02936980e+03  3.02936980e+03  3.02936980e+03  6.64981427e+03
  6.64981427e+03  6.64981427e+03  9.05610541e+03  2.54119187e+04
  7.61545366e+04]
E1 = -728.2511836027924  E_coul = 201.51680818624737
cycle= 6 E= -526.734375416545  delta_E= -6.87e-11  |g|= 1.98e-06  |ddm|= 2.12e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2511836027924  E_coul = 201.51680818624737
  HOMO = -0.583596961233407  LUMO = 0.86951004824456
  mo_energy =
[-1.18583120e+02 -1.23113287e+01 -9.56436055e+00 -9.56436055e+00
 -9.56436055e+00 -1.27046207e+00 -5.83596961e-01 -5.83596961e-01
 -5.83596961e-01  8.69510048e-01  1.01088913e+00  1.01088913e+00
  1.01088913e+00  7.26960872e+00  7.26960872e+00  7.26960872e+00
  1.08250946e+01  3.33882757e+01  3.33882757e+01  3.33882757e+01
  1.01277187e+02  1.28946296e+02  1.28946296e+02  1.28946296e+02
  4.83279790e+02  4.83279790e+02  4.83279790e+02  5.81596241e+02
  1.33512142e+03  1.33512142e+03  1.33512142e+03  2.65026084e+03
  3.02936980e+03  3.02936980e+03  3.02936980e+03  6.64981427e+03
  6.64981427e+03  6.64981427e+03  9.05610541e+03  2.54119187e+04
  7.61545366e+04]
E1 = -728.2511817497091  E_coul = 201.51680633316252
Extra cycle  E= -526.734375416547  delta_E= -1.59e-12  |g|= 4.15e-07  |ddm|= 3.61e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103105.22938541236
E1 = -728.2511817497091  E_coul = 201.51680633316252
init E= -526.734375416547
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583597014314008  LUMO = 0.869510085348075
  mo_energy =
[-1.18583121e+02 -1.23113288e+01 -9.56436070e+00 -9.56436070e+00
 -9.56436070e+00 -1.27046204e+00 -5.83597014e-01 -5.83597014e-01
 -5.83597014e-01  8.69510085e-01  1.01088911e+00  1.01088911e+00
  1.01088911e+00  7.26960862e+00  7.26960862e+00  7.26960862e+00
  1.08250945e+01  3.33882756e+01  3.33882756e+01  3.33882756e+01
  1.01277187e+02  1.28946296e+02  1.28946296e+02  1.28946296e+02
  4.83279790e+02  4.83279790e+02  4.83279790e+02  5.81596241e+02
  1.33512142e+03  1.33512142e+03  1.33512142e+03  2.65026084e+03
  3.02936980e+03  3.02936980e+03  3.02936980e+03  6.64981427e+03
  6.64981427e+03  6.64981427e+03  9.05610541e+03  2.54119187e+04
  7.61545366e+04]
E1 = -728.251182088798  E_coul = 201.5168066722517
cycle= 1 E= -526.734375416546  delta_E= 2.27e-13  |g|= 9.02e-08  |ddm|= 7.06e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.251182088798  E_coul = 201.5168066722517
  HOMO = -0.583597011631985  LUMO = 0.869510103611797
  mo_energy =
[-1.18583120e+02 -1.23113288e+01 -9.56436068e+00 -9.56436068e+00
 -9.56436068e+00 -1.27046201e+00 -5.83597012e-01 -5.83597012e-01
 -5.83597012e-01  8.69510104e-01  1.01088911e+00  1.01088911e+00
  1.01088911e+00  7.26960863e+00  7.26960863e+00  7.26960863e+00
  1.08250945e+01  3.33882756e+01  3.33882756e+01  3.33882756e+01
  1.01277187e+02  1.28946296e+02  1.28946296e+02  1.28946296e+02
  4.83279790e+02  4.83279790e+02  4.83279790e+02  5.81596241e+02
  1.33512142e+03  1.33512142e+03  1.33512142e+03  2.65026084e+03
  3.02936980e+03  3.02936980e+03  3.02936980e+03  6.64981427e+03
  6.64981427e+03  6.64981427e+03  9.05610541e+03  2.54119187e+04
  7.61545366e+04]
E1 = -728.2511819558152  E_coul = 201.51680653926925
Extra cycle  E= -526.734375416546  delta_E= 3.41e-13  |g|= 1.87e-08  |ddm|= 1.54e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61826559e+04 7.61752189e+03 3.61735088e+03 1.59782508e+03
 3.82851466e+02 1.08123759e+02 3.48281074e+01 7.48223711e+00
 2.94082365e+00 6.22574885e-01 2.23545051e-01 1.36278321e+03
 6.64745636e+02 3.00961780e+02 3.14042092e+02 6.16225448e+01
 7.33075460e+00 2.02381360e+01 7.75104332e-01 2.80924499e+00
 2.22084202e-01]
grad_E = [-1.51868765e-06  3.32402509e-06 -1.57077332e-06  6.99701895e-05
 -5.54326829e-05 -3.67878740e-05 -3.85683197e-03 -3.25493399e-03
 -3.89807737e-04 -8.41456362e-03  4.63918179e-03 -5.05276861e-07
  5.03012095e-06  2.37516481e-05  2.04782524e-05 -3.01905926e-05
 -8.56016700e-05  7.92668554e-05  2.81683695e-03 -2.42555972e-04
 -9.34319312e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558711        1
[INPUT] 0    0    [1    /1   ]  7617.52188097        1
[INPUT] 0    0    [1    /1   ]  3617.35088397        1
[INPUT] 0    0    [1    /1   ]  1597.82496596        1
[INPUT] 0    0    [1    /1   ]  382.851549508        1
[INPUT] 0    0    [1    /1   ]  108.123885143        1
[INPUT] 0    0    [1    /1   ]  34.8339401313        1
[INPUT] 0    0    [1    /1   ]  7.48374159194        1
[INPUT] 0    0    [1    /1   ]  2.9512422553         1
[INPUT] 0    0    [1    /1   ]  0.627722675168       1
[INPUT] 0    0    [1    /1   ]  0.225793536041       1
[INPUT] 1    0    [1    /1   ]  1362.78321155        1
[INPUT] 1    0    [1    /1   ]  664.745628264        1
[INPUT] 1    0    [1    /1   ]  300.961742529        1
[INPUT] 1    0    [1    /1   ]  314.042059276        1
[INPUT] 1    0    [1    /1   ]  61.6225934392        1
[INPUT] 1    0    [1    /1   ]  7.33083764365        1
[INPUT] 1    0    [1    /1   ]  20.238009566         1
[INPUT] 1    0    [1    /1   ]  0.7747372421         1
[INPUT] 1    0    [1    /1   ]  2.80959241722        1
[INPUT] 1    0    [1    /1   ]  0.222423916021       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655871133873, 1.0]], [0, [7617.521880968145, 1.0]], [0, [3617.350883968901, 1.0]], [0, [1597.8249659605083, 1.0]], [0, [382.85154950776035, 1.0]], [0, [108.12388514302219, 1.0]], [0, [34.83394013129328, 1.0]], [0, [7.483741591943388, 1.0]], [0, [2.951242255295446, 1.0]], [0, [0.6277226751680078, 1.0]], [0, [0.22579353604076347, 1.0]], [1, [1362.7832115489362, 1.0]], [1, [664.7456282644191, 1.0]], [1, [300.96174252853564, 1.0]], [1, [314.0420592756414, 1.0]], [1, [61.62259343917238, 1.0]], [1, [7.33083764364981, 1.0]], [1, [20.238009565982512, 1.0]], [1, [0.7747372421001458, 1.0]], [1, [2.8095924172221634, 1.0]], [1, [0.22242391602136735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65587113]
bas 1, expnt(s) = [7617.52188097]
bas 2, expnt(s) = [3617.35088397]
bas 3, expnt(s) = [1597.82496596]
bas 4, expnt(s) = [382.85154951]
bas 5, expnt(s) = [108.12388514]
bas 6, expnt(s) = [34.83394013]
bas 7, expnt(s) = [7.48374159]
bas 8, expnt(s) = [2.95124226]
bas 9, expnt(s) = [0.62772268]
bas 10, expnt(s) = [0.22579354]
bas 11, expnt(s) = [1362.78321155]
bas 12, expnt(s) = [664.74562826]
bas 13, expnt(s) = [300.96174253]
bas 14, expnt(s) = [314.04205928]
bas 15, expnt(s) = [61.62259344]
bas 16, expnt(s) = [7.33083764]
bas 17, expnt(s) = [20.23800957]
bas 18, expnt(s) = [0.77473724]
bas 19, expnt(s) = [2.80959242]
bas 20, expnt(s) = [0.22242392]
CPU time:        54.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752188e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782497e+03 6.38501506e+02
 3.82851550e+02 2.18669308e+02 1.08123885e+02 8.47142082e+01
 3.48339401e+01 3.62257158e+01 7.48374159e+00 1.14315235e+01
 2.95124226e+00 5.68877385e+00 6.27722675e-01 1.78172587e+00
 2.25793536e-01 8.27558403e-01 1.36278321e+03 2.41556018e+04
 6.64745628e+02 9.84699585e+03 3.00961743e+02 3.65698777e+03
 3.14042059e+02 3.85672935e+03 6.16225934e+01 5.03685394e+02
 7.33083764e+00 3.51905775e+01 2.02380096e+01 1.25225893e+02
 7.74737242e-01 2.12044706e+00 2.80959242e+00 1.06117875e+01
 2.22423916e-01 4.45616482e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993800445059733
cond(S) = 103130.35676636416
E1 = -729.5103804493995  E_coul = 203.16999244023037
init E= -526.340388009169
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555884138755984  LUMO = 0.902708398783788
  mo_energy =
[-1.18327795e+02 -1.22048068e+01 -9.44763446e+00 -9.44763446e+00
 -9.44763446e+00 -1.24007276e+00 -5.55884139e-01 -5.55884139e-01
 -5.55884139e-01  9.02708399e-01  1.03091253e+00  1.03091253e+00
  1.03091253e+00  7.34192010e+00  7.34192010e+00  7.34192010e+00
  1.09698851e+01  3.35117422e+01  3.35117422e+01  3.35117422e+01
  1.01545019e+02  1.29131647e+02  1.29131647e+02  1.29131647e+02
  4.83534993e+02  4.83534993e+02  4.83534993e+02  5.81979258e+02
  1.33543090e+03  1.33543090e+03  1.33543090e+03  2.65078385e+03
  3.02974397e+03  3.02974397e+03  3.02974397e+03  6.65030101e+03
  6.65030101e+03  6.65030101e+03  9.05674153e+03  2.54126448e+04
  7.61553480e+04]
E1 = -727.8063061391904  E_coul = 201.07268140492212
cycle= 1 E= -526.733624734268  delta_E= -0.393  |g|= 0.188  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546075
diis-c [-0.29819839  1.        ]
  HOMO = -0.591039850251692  LUMO = 0.877066927048834
  mo_energy =
[-1.18641295e+02 -1.23435246e+01 -9.59782023e+00 -9.59782023e+00
 -9.59782023e+00 -1.27958462e+00 -5.91039850e-01 -5.91039850e-01
 -5.91039850e-01  8.77066927e-01  1.00640151e+00  1.00640151e+00
  1.00640151e+00  7.25042517e+00  7.25042517e+00  7.25042517e+00
  1.08653656e+01  3.33554424e+01  3.33554424e+01  3.33554424e+01
  1.01323752e+02  1.28899420e+02  1.28899420e+02  1.28899420e+02
  4.83222977e+02  4.83222977e+02  4.83222977e+02  5.81628298e+02
  1.33506097e+03  1.33506097e+03  1.33506097e+03  2.65027844e+03
  3.02930735e+03  3.02930735e+03  3.02930735e+03  6.64975039e+03
  6.64975039e+03  6.64975039e+03  9.05611514e+03  2.54119240e+04
  7.61545368e+04]
E1 = -728.3878180993815  E_coul = 201.65344867985954
cycle= 2 E= -526.734369419522  delta_E= -0.000745  |g|= 0.0383  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0762572
diis-c [-0.00328111  0.0848318   0.9151682 ]
  HOMO = -0.581856600270355  LUMO = 0.884545167733624
  mo_energy =
[-1.18572731e+02 -1.23050877e+01 -9.55772287e+00 -9.55772287e+00
 -9.55772287e+00 -1.26858220e+00 -5.81856600e-01 -5.81856600e-01
 -5.81856600e-01  8.84545168e-01  1.01317317e+00  1.01317317e+00
  1.01317317e+00  7.27435694e+00  7.27435694e+00  7.27435694e+00
  1.08942278e+01  3.33959153e+01  3.33959153e+01  3.33959153e+01
  1.01379856e+02  1.28955984e+02  1.28955984e+02  1.28955984e+02
  4.83290715e+02  4.83290715e+02  4.83290715e+02  5.81698417e+02
  1.33513279e+03  1.33513279e+03  1.33513279e+03  2.65035360e+03
  3.02938143e+03  3.02938143e+03  3.02938143e+03  6.64982620e+03
  6.64982620e+03  6.64982620e+03  9.05619177e+03  2.54120012e+04
  7.61546143e+04]
E1 = -728.2361328958747  E_coul = 201.50170299365706
cycle= 3 E= -526.734429902218  delta_E= -6.05e-05  |g|= 0.00623  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131151
diis-c [-7.19043764e-07 -1.30411365e-03  1.41910330e-01  8.59393784e-01]
  HOMO = -0.583350862843707  LUMO = 0.883427992780953
  mo_energy =
[-1.18582622e+02 -1.23108549e+01 -9.56384413e+00 -9.56384413e+00
 -9.56384413e+00 -1.27025641e+00 -5.83350863e-01 -5.83350863e-01
 -5.83350863e-01  8.83427993e-01  1.01209761e+00  1.01209761e+00
  1.01209761e+00  7.27060186e+00  7.27060186e+00  7.27060186e+00
  1.08898628e+01  3.33897795e+01  3.33897795e+01  3.33897795e+01
  1.01371688e+02  1.28947689e+02  1.28947689e+02  1.28947689e+02
  4.83280939e+02  4.83280939e+02  4.83280939e+02  5.81688286e+02
  1.33512243e+03  1.33512243e+03  1.33512243e+03  2.65034259e+03
  3.02937068e+03  3.02937068e+03  3.02937068e+03  6.64981505e+03
  6.64981505e+03  6.64981505e+03  9.05618040e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2587090740219  E_coul = 201.52427727796544
cycle= 4 E= -526.734431796056  delta_E= -1.89e-06  |g|= 0.000109  |ddm|= 0.0022
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000131524
diis-c [-4.80650090e-09  7.99191368e-05 -1.10977990e-02 -7.40640185e-02
  1.08508190e+00]
  HOMO = -0.583333170890039  LUMO = 0.883461308646262
  mo_energy =
[-1.18582587e+02 -1.23107907e+01 -9.56379522e+00 -9.56379522e+00
 -9.56379522e+00 -1.27021323e+00 -5.83333171e-01 -5.83333171e-01
 -5.83333171e-01  8.83461309e-01  1.01211324e+00  1.01211324e+00
  1.01211324e+00  7.27064261e+00  7.27064261e+00  7.27064261e+00
  1.08899222e+01  3.33898265e+01  3.33898265e+01  3.33898265e+01
  1.01371738e+02  1.28947734e+02  1.28947734e+02  1.28947734e+02
  4.83280975e+02  4.83280975e+02  4.83280975e+02  5.81688313e+02
  1.33512245e+03  1.33512245e+03  1.33512245e+03  2.65034259e+03
  3.02937069e+03  3.02937069e+03  3.02937069e+03  6.64981505e+03
  6.64981505e+03  6.64981505e+03  9.05618039e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2584928878008  E_coul = 201.5240610895336
cycle= 5 E= -526.734431798267  delta_E= -2.21e-09  |g|= 2.21e-05  |ddm|= 0.000181
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.11538e-05
diis-c [-9.85019249e-11  1.47864099e-05 -1.80230747e-03 -1.40223767e-02
  4.40579670e-02  9.71751931e-01]
  HOMO = -0.583341360415999  LUMO = 0.883457441830961
  mo_energy =
[-1.18582620e+02 -1.23108152e+01 -9.56382167e+00 -9.56382167e+00
 -9.56382167e+00 -1.27021970e+00 -5.83341360e-01 -5.83341360e-01
 -5.83341360e-01  8.83457442e-01  1.01210781e+00  1.01210781e+00
  1.01210781e+00  7.27062459e+00  7.27062459e+00  7.27062459e+00
  1.08899032e+01  3.33898008e+01  3.33898008e+01  3.33898008e+01
  1.01371708e+02  1.28947704e+02  1.28947704e+02  1.28947704e+02
  4.83280942e+02  4.83280942e+02  4.83280942e+02  5.81688280e+02
  1.33512242e+03  1.33512242e+03  1.33512242e+03  2.65034256e+03
  3.02937066e+03  3.02937066e+03  3.02937066e+03  6.64981501e+03
  6.64981501e+03  6.64981501e+03  9.05618035e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2585793273697  E_coul = 201.5241475290323
cycle= 6 E= -526.734431798337  delta_E= -7.03e-11  |g|= 1.97e-06  |ddm|= 2.11e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2585793273697  E_coul = 201.5241475290323
  HOMO = -0.583341373034423  LUMO = 0.88345780839454
  mo_energy =
[-1.18582619e+02 -1.23108149e+01 -9.56382149e+00 -9.56382149e+00
 -9.56382149e+00 -1.27021927e+00 -5.83341373e-01 -5.83341373e-01
 -5.83341373e-01  8.83457808e-01  1.01210787e+00  1.01210787e+00
  1.01210787e+00  7.27062471e+00  7.27062471e+00  7.27062471e+00
  1.08899035e+01  3.33898011e+01  3.33898011e+01  3.33898011e+01
  1.01371708e+02  1.28947704e+02  1.28947704e+02  1.28947704e+02
  4.83280943e+02  4.83280943e+02  4.83280943e+02  5.81688280e+02
  1.33512242e+03  1.33512242e+03  1.33512242e+03  2.65034256e+03
  3.02937066e+03  3.02937066e+03  3.02937066e+03  6.64981501e+03
  6.64981501e+03  6.64981501e+03  9.05618035e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2585775759757  E_coul = 201.52414577763685
Extra cycle  E= -526.734431798339  delta_E= -1.36e-12  |g|= 4.12e-07  |ddm|= 3.57e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
exp = [2.61826559e+04 7.61752188e+03 3.61735088e+03 1.59782497e+03
 3.82851550e+02 1.08123885e+02 3.48339401e+01 7.48374159e+00
 2.95124226e+00 6.27722675e-01 2.25793536e-01 1.36278321e+03
 6.64745628e+02 3.00961743e+02 3.14042059e+02 6.16225934e+01
 7.33083764e+00 2.02380096e+01 7.74737242e-01 2.80959242e+00
 2.22423916e-01]
E = -526.7344317983388
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558711        1
[INPUT] 0    0    [1    /1   ]  7617.52188097        1
[INPUT] 0    0    [1    /1   ]  3617.35088397        1
[INPUT] 0    0    [1    /1   ]  1597.82496596        1
[INPUT] 0    0    [1    /1   ]  382.851549508        1
[INPUT] 0    0    [1    /1   ]  108.123885143        1
[INPUT] 0    0    [1    /1   ]  34.8339401313        1
[INPUT] 0    0    [1    /1   ]  7.48374159194        1
[INPUT] 0    0    [1    /1   ]  2.9512422553         1
[INPUT] 0    0    [1    /1   ]  0.627722675168       1
[INPUT] 0    0    [1    /1   ]  0.225793536041       1
[INPUT] 1    0    [1    /1   ]  1362.78321155        1
[INPUT] 1    0    [1    /1   ]  664.745628264        1
[INPUT] 1    0    [1    /1   ]  300.961742529        1
[INPUT] 1    0    [1    /1   ]  314.042059276        1
[INPUT] 1    0    [1    /1   ]  61.6225934392        1
[INPUT] 1    0    [1    /1   ]  7.33083764365        1
[INPUT] 1    0    [1    /1   ]  20.238009566         1
[INPUT] 1    0    [1    /1   ]  0.7747372421         1
[INPUT] 1    0    [1    /1   ]  2.80959241722        1
[INPUT] 1    0    [1    /1   ]  0.222423916021       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655871133873, 1.0]], [0, [7617.521880968145, 1.0]], [0, [3617.350883968901, 1.0]], [0, [1597.8249659605083, 1.0]], [0, [382.85154950776035, 1.0]], [0, [108.12388514302219, 1.0]], [0, [34.83394013129328, 1.0]], [0, [7.483741591943388, 1.0]], [0, [2.951242255295446, 1.0]], [0, [0.6277226751680078, 1.0]], [0, [0.22579353604076347, 1.0]], [1, [1362.7832115489362, 1.0]], [1, [664.7456282644191, 1.0]], [1, [300.96174252853564, 1.0]], [1, [314.0420592756414, 1.0]], [1, [61.62259343917238, 1.0]], [1, [7.33083764364981, 1.0]], [1, [20.238009565982512, 1.0]], [1, [0.7747372421001458, 1.0]], [1, [2.8095924172221634, 1.0]], [1, [0.22242391602136735, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65587113]
bas 1, expnt(s) = [7617.52188097]
bas 2, expnt(s) = [3617.35088397]
bas 3, expnt(s) = [1597.82496596]
bas 4, expnt(s) = [382.85154951]
bas 5, expnt(s) = [108.12388514]
bas 6, expnt(s) = [34.83394013]
bas 7, expnt(s) = [7.48374159]
bas 8, expnt(s) = [2.95124226]
bas 9, expnt(s) = [0.62772268]
bas 10, expnt(s) = [0.22579354]
bas 11, expnt(s) = [1362.78321155]
bas 12, expnt(s) = [664.74562826]
bas 13, expnt(s) = [300.96174253]
bas 14, expnt(s) = [314.04205928]
bas 15, expnt(s) = [61.62259344]
bas 16, expnt(s) = [7.33083764]
bas 17, expnt(s) = [20.23800957]
bas 18, expnt(s) = [0.77473724]
bas 19, expnt(s) = [2.80959242]
bas 20, expnt(s) = [0.22242392]
CPU time:        55.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752188e+03 2.06003836e+03
 3.61735088e+03 1.17844143e+03 1.59782497e+03 6.38501506e+02
 3.82851550e+02 2.18669308e+02 1.08123885e+02 8.47142082e+01
 3.48339401e+01 3.62257158e+01 7.48374159e+00 1.14315235e+01
 2.95124226e+00 5.68877385e+00 6.27722675e-01 1.78172587e+00
 2.25793536e-01 8.27558403e-01 1.36278321e+03 2.41556018e+04
 6.64745628e+02 9.84699585e+03 3.00961743e+02 3.65698777e+03
 3.14042059e+02 3.85672935e+03 6.16225934e+01 5.03685394e+02
 7.33083764e+00 3.51905775e+01 2.02380096e+01 1.25225893e+02
 7.74737242e-01 2.12044706e+00 2.80959242e+00 1.06117875e+01
 2.22423916e-01 4.45616482e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993800445059733
cond(S) = 103130.35676636416
E1 = -729.5103804493995  E_coul = 203.16999244023037
init E= -526.340388009169
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555884138755984  LUMO = 0.902708398783788
  mo_energy =
[-1.18327795e+02 -1.22048068e+01 -9.44763446e+00 -9.44763446e+00
 -9.44763446e+00 -1.24007276e+00 -5.55884139e-01 -5.55884139e-01
 -5.55884139e-01  9.02708399e-01  1.03091253e+00  1.03091253e+00
  1.03091253e+00  7.34192010e+00  7.34192010e+00  7.34192010e+00
  1.09698851e+01  3.35117422e+01  3.35117422e+01  3.35117422e+01
  1.01545019e+02  1.29131647e+02  1.29131647e+02  1.29131647e+02
  4.83534993e+02  4.83534993e+02  4.83534993e+02  5.81979258e+02
  1.33543090e+03  1.33543090e+03  1.33543090e+03  2.65078385e+03
  3.02974397e+03  3.02974397e+03  3.02974397e+03  6.65030101e+03
  6.65030101e+03  6.65030101e+03  9.05674153e+03  2.54126448e+04
  7.61553480e+04]
E1 = -727.8063061391904  E_coul = 201.07268140492212
cycle= 1 E= -526.733624734268  delta_E= -0.393  |g|= 0.188  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.546075
diis-c [-0.29819839  1.        ]
  HOMO = -0.591039850251692  LUMO = 0.877066927048834
  mo_energy =
[-1.18641295e+02 -1.23435246e+01 -9.59782023e+00 -9.59782023e+00
 -9.59782023e+00 -1.27958462e+00 -5.91039850e-01 -5.91039850e-01
 -5.91039850e-01  8.77066927e-01  1.00640151e+00  1.00640151e+00
  1.00640151e+00  7.25042517e+00  7.25042517e+00  7.25042517e+00
  1.08653656e+01  3.33554424e+01  3.33554424e+01  3.33554424e+01
  1.01323752e+02  1.28899420e+02  1.28899420e+02  1.28899420e+02
  4.83222977e+02  4.83222977e+02  4.83222977e+02  5.81628298e+02
  1.33506097e+03  1.33506097e+03  1.33506097e+03  2.65027844e+03
  3.02930735e+03  3.02930735e+03  3.02930735e+03  6.64975039e+03
  6.64975039e+03  6.64975039e+03  9.05611514e+03  2.54119240e+04
  7.61545368e+04]
E1 = -728.3878180993815  E_coul = 201.65344867985954
cycle= 2 E= -526.734369419522  delta_E= -0.000745  |g|= 0.0383  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0762572
diis-c [-0.00328111  0.0848318   0.9151682 ]
  HOMO = -0.581856600270355  LUMO = 0.884545167733624
  mo_energy =
[-1.18572731e+02 -1.23050877e+01 -9.55772287e+00 -9.55772287e+00
 -9.55772287e+00 -1.26858220e+00 -5.81856600e-01 -5.81856600e-01
 -5.81856600e-01  8.84545168e-01  1.01317317e+00  1.01317317e+00
  1.01317317e+00  7.27435694e+00  7.27435694e+00  7.27435694e+00
  1.08942278e+01  3.33959153e+01  3.33959153e+01  3.33959153e+01
  1.01379856e+02  1.28955984e+02  1.28955984e+02  1.28955984e+02
  4.83290715e+02  4.83290715e+02  4.83290715e+02  5.81698417e+02
  1.33513279e+03  1.33513279e+03  1.33513279e+03  2.65035360e+03
  3.02938143e+03  3.02938143e+03  3.02938143e+03  6.64982620e+03
  6.64982620e+03  6.64982620e+03  9.05619177e+03  2.54120012e+04
  7.61546143e+04]
E1 = -728.2361328958747  E_coul = 201.50170299365706
cycle= 3 E= -526.734429902218  delta_E= -6.05e-05  |g|= 0.00623  |ddm|= 0.0163
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0131151
diis-c [-7.19043764e-07 -1.30411365e-03  1.41910330e-01  8.59393784e-01]
  HOMO = -0.583350862843707  LUMO = 0.883427992780953
  mo_energy =
[-1.18582622e+02 -1.23108549e+01 -9.56384413e+00 -9.56384413e+00
 -9.56384413e+00 -1.27025641e+00 -5.83350863e-01 -5.83350863e-01
 -5.83350863e-01  8.83427993e-01  1.01209761e+00  1.01209761e+00
  1.01209761e+00  7.27060186e+00  7.27060186e+00  7.27060186e+00
  1.08898628e+01  3.33897795e+01  3.33897795e+01  3.33897795e+01
  1.01371688e+02  1.28947689e+02  1.28947689e+02  1.28947689e+02
  4.83280939e+02  4.83280939e+02  4.83280939e+02  5.81688286e+02
  1.33512243e+03  1.33512243e+03  1.33512243e+03  2.65034259e+03
  3.02937068e+03  3.02937068e+03  3.02937068e+03  6.64981505e+03
  6.64981505e+03  6.64981505e+03  9.05618040e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2587090740219  E_coul = 201.52427727796544
cycle= 4 E= -526.734431796056  delta_E= -1.89e-06  |g|= 0.000109  |ddm|= 0.0022
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.000131524
diis-c [-4.80650090e-09  7.99191368e-05 -1.10977990e-02 -7.40640185e-02
  1.08508190e+00]
  HOMO = -0.583333170890039  LUMO = 0.883461308646262
  mo_energy =
[-1.18582587e+02 -1.23107907e+01 -9.56379522e+00 -9.56379522e+00
 -9.56379522e+00 -1.27021323e+00 -5.83333171e-01 -5.83333171e-01
 -5.83333171e-01  8.83461309e-01  1.01211324e+00  1.01211324e+00
  1.01211324e+00  7.27064261e+00  7.27064261e+00  7.27064261e+00
  1.08899222e+01  3.33898265e+01  3.33898265e+01  3.33898265e+01
  1.01371738e+02  1.28947734e+02  1.28947734e+02  1.28947734e+02
  4.83280975e+02  4.83280975e+02  4.83280975e+02  5.81688313e+02
  1.33512245e+03  1.33512245e+03  1.33512245e+03  2.65034259e+03
  3.02937069e+03  3.02937069e+03  3.02937069e+03  6.64981505e+03
  6.64981505e+03  6.64981505e+03  9.05618039e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2584928878008  E_coul = 201.5240610895336
cycle= 5 E= -526.734431798267  delta_E= -2.21e-09  |g|= 2.21e-05  |ddm|= 0.000181
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=4.11538e-05
diis-c [-9.85019249e-11  1.47864099e-05 -1.80230747e-03 -1.40223767e-02
  4.40579670e-02  9.71751931e-01]
  HOMO = -0.583341360415999  LUMO = 0.883457441830961
  mo_energy =
[-1.18582620e+02 -1.23108152e+01 -9.56382167e+00 -9.56382167e+00
 -9.56382167e+00 -1.27021970e+00 -5.83341360e-01 -5.83341360e-01
 -5.83341360e-01  8.83457442e-01  1.01210781e+00  1.01210781e+00
  1.01210781e+00  7.27062459e+00  7.27062459e+00  7.27062459e+00
  1.08899032e+01  3.33898008e+01  3.33898008e+01  3.33898008e+01
  1.01371708e+02  1.28947704e+02  1.28947704e+02  1.28947704e+02
  4.83280942e+02  4.83280942e+02  4.83280942e+02  5.81688280e+02
  1.33512242e+03  1.33512242e+03  1.33512242e+03  2.65034256e+03
  3.02937066e+03  3.02937066e+03  3.02937066e+03  6.64981501e+03
  6.64981501e+03  6.64981501e+03  9.05618035e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2585793273697  E_coul = 201.5241475290323
cycle= 6 E= -526.734431798337  delta_E= -7.03e-11  |g|= 1.97e-06  |ddm|= 2.11e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2585793273697  E_coul = 201.5241475290323
  HOMO = -0.583341373034423  LUMO = 0.88345780839454
  mo_energy =
[-1.18582619e+02 -1.23108149e+01 -9.56382149e+00 -9.56382149e+00
 -9.56382149e+00 -1.27021927e+00 -5.83341373e-01 -5.83341373e-01
 -5.83341373e-01  8.83457808e-01  1.01210787e+00  1.01210787e+00
  1.01210787e+00  7.27062471e+00  7.27062471e+00  7.27062471e+00
  1.08899035e+01  3.33898011e+01  3.33898011e+01  3.33898011e+01
  1.01371708e+02  1.28947704e+02  1.28947704e+02  1.28947704e+02
  4.83280943e+02  4.83280943e+02  4.83280943e+02  5.81688280e+02
  1.33512242e+03  1.33512242e+03  1.33512242e+03  2.65034256e+03
  3.02937066e+03  3.02937066e+03  3.02937066e+03  6.64981501e+03
  6.64981501e+03  6.64981501e+03  9.05618035e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2585775759757  E_coul = 201.52414577763685
Extra cycle  E= -526.734431798339  delta_E= -1.36e-12  |g|= 4.12e-07  |ddm|= 3.57e-06
    CPU time for scf_cycle      0.36 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103130.35676636416
E1 = -728.2585775759757  E_coul = 201.52414577763685
init E= -526.734431798339
    CPU time for initialize scf      0.95 sec, wall time      0.26 sec
  HOMO = -0.583341423638667  LUMO = 0.883457846999517
  mo_energy =
[-1.18582620e+02 -1.23108150e+01 -9.56382163e+00 -9.56382163e+00
 -9.56382163e+00 -1.27021923e+00 -5.83341424e-01 -5.83341424e-01
 -5.83341424e-01  8.83457847e-01  1.01210784e+00  1.01210784e+00
  1.01210784e+00  7.27062461e+00  7.27062461e+00  7.27062461e+00
  1.08899034e+01  3.33898009e+01  3.33898009e+01  3.33898009e+01
  1.01371708e+02  1.28947704e+02  1.28947704e+02  1.28947704e+02
  4.83280942e+02  4.83280942e+02  4.83280942e+02  5.81688280e+02
  1.33512242e+03  1.33512242e+03  1.33512242e+03  2.65034256e+03
  3.02937066e+03  3.02937066e+03  3.02937066e+03  6.64981501e+03
  6.64981501e+03  6.64981501e+03  9.05618035e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2585778925954  E_coul = 201.52414609425756
cycle= 1 E= -526.734431798338  delta_E= 9.09e-13  |g|= 8.91e-08  |ddm|= 6.98e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2585778925954  E_coul = 201.52414609425756
  HOMO = -0.583341421279454  LUMO = 0.883457865016075
  mo_energy =
[-1.18582620e+02 -1.23108150e+01 -9.56382161e+00 -9.56382161e+00
 -9.56382161e+00 -1.27021921e+00 -5.83341421e-01 -5.83341421e-01
 -5.83341421e-01  8.83457865e-01  1.01210785e+00  1.01210785e+00
  1.01210785e+00  7.27062462e+00  7.27062462e+00  7.27062462e+00
  1.08899035e+01  3.33898009e+01  3.33898009e+01  3.33898009e+01
  1.01371708e+02  1.28947704e+02  1.28947704e+02  1.28947704e+02
  4.83280942e+02  4.83280942e+02  4.83280942e+02  5.81688280e+02
  1.33512242e+03  1.33512242e+03  1.33512242e+03  2.65034256e+03
  3.02937066e+03  3.02937066e+03  3.02937066e+03  6.64981501e+03
  6.64981501e+03  6.64981501e+03  9.05618035e+03  2.54119896e+04
  7.61546026e+04]
E1 = -728.2585777673368  E_coul = 201.52414596899848
Extra cycle  E= -526.734431798338  delta_E= -3.41e-13  |g|= 1.84e-08  |ddm|= 1.52e-07
    CPU time for scf_cycle      1.09 sec, wall time      0.40 sec
exp = [2.61826559e+04 7.61752188e+03 3.61735088e+03 1.59782497e+03
 3.82851550e+02 1.08123885e+02 3.48339401e+01 7.48374159e+00
 2.95124226e+00 6.27722675e-01 2.25793536e-01 1.36278321e+03
 6.64745628e+02 3.00961743e+02 3.14042059e+02 6.16225934e+01
 7.33083764e+00 2.02380096e+01 7.74737242e-01 2.80959242e+00
 2.22423916e-01]
grad_E = [-1.51863865e-06  3.32356370e-06 -1.57086180e-06  6.99521653e-05
 -5.48621915e-05 -3.81412872e-05 -3.87823350e-03 -3.72784690e-03
  9.68279598e-04 -7.05574656e-03  4.20113378e-03 -5.05303462e-07
  5.02933278e-06  2.37468989e-05  2.04742261e-05 -2.94950260e-05
 -5.47525894e-05  7.45534256e-05 -6.36309001e-04 -1.80415465e-04
  1.84647645e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558795        1
[INPUT] 0    0    [1    /1   ]  7617.52186259        1
[INPUT] 0    0    [1    /1   ]  3617.35089267        1
[INPUT] 0    0    [1    /1   ]  1597.82457922        1
[INPUT] 0    0    [1    /1   ]  382.851844246        1
[INPUT] 0    0    [1    /1   ]  108.124235594        1
[INPUT] 0    0    [1    /1   ]  34.8546307015        1
[INPUT] 0    0    [1    /1   ]  7.49526097406        1
[INPUT] 0    0    [1    /1   ]  2.97021160333        1
[INPUT] 0    0    [1    /1   ]  0.641970971605       1
[INPUT] 0    0    [1    /1   ]  0.231400596189       1
[INPUT] 1    0    [1    /1   ]  1362.78321434        1
[INPUT] 1    0    [1    /1   ]  664.745600436        1
[INPUT] 1    0    [1    /1   ]  300.961611122        1
[INPUT] 1    0    [1    /1   ]  314.041945979        1
[INPUT] 1    0    [1    /1   ]  61.6227602865        1
[INPUT] 1    0    [1    /1   ]  7.33116888005        1
[INPUT] 1    0    [1    /1   ]  20.2375757461        1
[INPUT] 1    0    [1    /1   ]  0.774320642976       1
[INPUT] 1    0    [1    /1   ]  2.81066724222        1
[INPUT] 1    0    [1    /1   ]  0.222956445366       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.6558795349, 1.0]], [0, [7617.5218625877915, 1.0]], [0, [3617.3508926653913, 1.0]], [0, [1597.8245792242528, 1.0]], [0, [382.85184424564903, 1.0]], [0, [108.12423559428757, 1.0]], [0, [34.85463070147413, 1.0]], [0, [7.495260974064226, 1.0]], [0, [2.9702116033266286, 1.0]], [0, [0.6419709716049139, 1.0]], [0, [0.23140059618916706, 1.0]], [1, [1362.7832143439086, 1.0]], [1, [664.745600435552, 1.0]], [1, [300.9616111219382, 1.0]], [1, [314.04194597889574, 1.0]], [1, [61.62276028649245, 1.0]], [1, [7.331168880054986, 1.0]], [1, [20.237575746128677, 1.0]], [1, [0.7743206429759947, 1.0]], [1, [2.8106672422160064, 1.0]], [1, [0.2229564453658699, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65587953]
bas 1, expnt(s) = [7617.52186259]
bas 2, expnt(s) = [3617.35089267]
bas 3, expnt(s) = [1597.82457922]
bas 4, expnt(s) = [382.85184425]
bas 5, expnt(s) = [108.12423559]
bas 6, expnt(s) = [34.8546307]
bas 7, expnt(s) = [7.49526097]
bas 8, expnt(s) = [2.9702116]
bas 9, expnt(s) = [0.64197097]
bas 10, expnt(s) = [0.2314006]
bas 11, expnt(s) = [1362.78321434]
bas 12, expnt(s) = [664.74560044]
bas 13, expnt(s) = [300.96161112]
bas 14, expnt(s) = [314.04194598]
bas 15, expnt(s) = [61.62276029]
bas 16, expnt(s) = [7.33116888]
bas 17, expnt(s) = [20.23757575]
bas 18, expnt(s) = [0.77432064]
bas 19, expnt(s) = [2.81066724]
bas 20, expnt(s) = [0.22295645]
CPU time:        61.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752186e+03 2.06003835e+03
 3.61735089e+03 1.17844143e+03 1.59782458e+03 6.38501391e+02
 3.82851844e+02 2.18669435e+02 1.08124236e+02 8.47144142e+01
 3.48546307e+01 3.62418525e+01 7.49526097e+00 1.14447179e+01
 2.97021160e+00 5.71617567e+00 6.41970972e-01 1.81197235e+00
 2.31400596e-01 8.42923922e-01 1.36278321e+03 2.41556018e+04
 6.64745600e+02 9.84699533e+03 3.00961611e+02 3.65698578e+03
 3.14041946e+02 3.85672761e+03 6.16227603e+01 5.03687099e+02
 7.33116888e+00 3.51925651e+01 2.02375757e+01 1.25222538e+02
 7.74320643e-01 2.11902187e+00 2.81066724e+00 1.06168623e+01
 2.22956445e-01 4.46950505e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993738694706614
cond(S) = 103194.52134454843
E1 = -729.5104383265951  E_coul = 203.17051232288276
init E= -526.339926003712
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555819886984725  LUMO = 0.939260206149942
  mo_energy =
[-1.18327885e+02 -1.22047759e+01 -9.44762137e+00 -9.44762137e+00
 -9.44762137e+00 -1.24004002e+00 -5.55819887e-01 -5.55819887e-01
 -5.55819887e-01  9.39260206e-01  1.03270425e+00  1.03270425e+00
  1.03270425e+00  7.34445428e+00  7.34445428e+00  7.34445428e+00
  1.11270989e+01  3.35161174e+01  3.35161174e+01  3.35161174e+01
  1.01797585e+02  1.29135350e+02  1.29135350e+02  1.29135350e+02
  4.83537682e+02  4.83537682e+02  4.83537682e+02  5.82239222e+02
  1.33543304e+03  1.33543304e+03  1.33543304e+03  2.65101717e+03
  3.02974559e+03  3.02974559e+03  3.02974559e+03  6.65030220e+03
  6.65030220e+03  6.65030220e+03  9.05695575e+03  2.54128472e+04
  7.61555364e+04]
E1 = -727.8220921329013  E_coul = 201.0883174757994
cycle= 1 E= -526.733774657102  delta_E= -0.394  |g|= 0.188  |ddm|= 0.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545359
diis-c [-0.29741623  1.        ]
  HOMO = -0.590570065105427  LUMO = 0.913103797629538
  mo_energy =
[-1.18640011e+02 -1.23424363e+01 -9.59665006e+00 -9.59665006e+00
 -9.59665006e+00 -1.27912678e+00 -5.90570065e-01 -5.90570065e-01
 -5.90570065e-01  9.13103798e-01  1.00849087e+00  1.00849087e+00
  1.00849087e+00  7.25376804e+00  7.25376804e+00  7.25376804e+00
  1.10230511e+01  3.33609410e+01  3.33609410e+01  3.33609410e+01
  1.01577647e+02  1.28904404e+02  1.28904404e+02  1.28904404e+02
  4.83227055e+02  4.83227055e+02  4.83227055e+02  5.81889644e+02
  1.33506449e+03  1.33506449e+03  1.33506449e+03  2.65051317e+03
  3.02931036e+03  3.02931036e+03  3.02931036e+03  6.64975297e+03
  6.64975297e+03  6.64975297e+03  9.05633078e+03  2.54121279e+04
  7.61547267e+04]
E1 = -728.3993675059461  E_coul = 201.66485790682526
cycle= 2 E= -526.734509599121  delta_E= -0.000735  |g|= 0.0381  |ddm|= 0.0533
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0758542
diis-c [-0.00325883  0.08433076  0.91566924]
  HOMO = -0.581463176231758  LUMO = 0.920744314988476
  mo_energy =
[-1.18571844e+02 -1.23042660e+01 -9.55682183e+00 -9.55682183e+00
 -9.55682183e+00 -1.26821523e+00 -5.81463176e-01 -5.81463176e-01
 -5.81463176e-01  9.20744315e-01  1.01520960e+00  1.01520960e+00
  1.01520960e+00  7.27752571e+00  7.27752571e+00  7.27752571e+00
  1.10517758e+01  3.34011455e+01  3.34011455e+01  3.34011455e+01
  1.01633407e+02  1.28960622e+02  1.28960622e+02  1.28960622e+02
  4.83294400e+02  4.83294400e+02  4.83294400e+02  5.81959361e+02
  1.33513591e+03  1.33513591e+03  1.33513591e+03  2.65058791e+03
  3.02938403e+03  3.02938403e+03  3.02938403e+03  6.64982837e+03
  6.64982837e+03  6.64982837e+03  9.05640699e+03  2.54122046e+04
  7.61548037e+04]
E1 = -728.2487693797431  E_coul = 201.5142001610046
cycle= 3 E= -526.734569218738  delta_E= -5.96e-05  |g|= 0.00621  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130672
diis-c [-7.03204906e-07 -1.29867347e-03  1.42132600e-01  8.59166074e-01]
  HOMO = -0.582949010492845  LUMO = 0.919598924771249
  mo_energy =
[-1.18581703e+02 -1.23100123e+01 -9.56291991e+00 -9.56291991e+00
 -9.56291991e+00 -1.26988121e+00 -5.82949010e-01 -5.82949010e-01
 -5.82949010e-01  9.19598925e-01  1.01413974e+00  1.01413974e+00
  1.01413974e+00  7.27378678e+00  7.27378678e+00  7.27378678e+00
  1.10474155e+01  3.33950329e+01  3.33950329e+01  3.33950329e+01
  1.01625266e+02  1.28952356e+02  1.28952356e+02  1.28952356e+02
  4.83284656e+02  4.83284656e+02  4.83284656e+02  5.81949263e+02
  1.33512558e+03  1.33512558e+03  1.33512558e+03  2.65057694e+03
  3.02937331e+03  3.02937331e+03  3.02937331e+03  6.64981726e+03
  6.64981726e+03  6.64981726e+03  9.05639566e+03  2.54121931e+04
  7.61547921e+04]
E1 = -728.2712569744209  E_coul = 201.53668587751918
cycle= 4 E= -526.734571096902  delta_E= -1.88e-06  |g|= 0.000108  |ddm|= 0.0022
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127168
diis-c [-4.76174709e-09  7.77628999e-05 -1.08739150e-02 -7.22358144e-02
  1.08303197e+00]
  HOMO = -0.582930436298452  LUMO = 0.919633462199481
  mo_energy =
[-1.18581664e+02 -1.23099460e+01 -9.56286856e+00 -9.56286856e+00
 -9.56286856e+00 -1.26983744e+00 -5.82930436e-01 -5.82930436e-01
 -5.82930436e-01  9.19633462e-01  1.01415597e+00  1.01415597e+00
  1.01415597e+00  7.27382923e+00  7.27382923e+00  7.27382923e+00
  1.10474763e+01  3.33950824e+01  3.33950824e+01  3.33950824e+01
  1.01625319e+02  1.28952403e+02  1.28952403e+02  1.28952403e+02
  4.83284695e+02  4.83284695e+02  4.83284695e+02  5.81949294e+02
  1.33512561e+03  1.33512561e+03  1.33512561e+03  2.65057695e+03
  3.02937333e+03  3.02937333e+03  3.02937333e+03  6.64981726e+03
  6.64981726e+03  6.64981726e+03  9.05639565e+03  2.54121931e+04
  7.61547921e+04]
E1 = -728.2710351984263  E_coul = 201.53646409938386
cycle= 5 E= -526.734571099042  delta_E= -2.14e-09  |g|= 2.21e-05  |ddm|= 0.000177
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.1238e-05
diis-c [-9.54968528e-11  1.48174812e-05 -1.81447384e-03 -1.40831611e-02
  4.42726978e-02  9.71610120e-01]
  HOMO = -0.582938545248971  LUMO = 0.919629505789939
  mo_energy =
[-1.18581697e+02 -1.23099703e+01 -9.56289490e+00 -9.56289490e+00
 -9.56289490e+00 -1.26984385e+00 -5.82938545e-01 -5.82938545e-01
 -5.82938545e-01  9.19629506e-01  1.01415060e+00  1.01415060e+00
  1.01415060e+00  7.27381131e+00  7.27381131e+00  7.27381131e+00
  1.10474574e+01  3.33950568e+01  3.33950568e+01  3.33950568e+01
  1.01625289e+02  1.28952373e+02  1.28952373e+02  1.28952373e+02
  4.83284663e+02  4.83284663e+02  4.83284663e+02  5.81949261e+02
  1.33512557e+03  1.33512557e+03  1.33512557e+03  2.65057691e+03
  3.02937329e+03  3.02937329e+03  3.02937329e+03  6.64981722e+03
  6.64981722e+03  6.64981722e+03  9.05639561e+03  2.54121930e+04
  7.61547920e+04]
E1 = -728.2711216039085  E_coul = 201.53655050479588
cycle= 6 E= -526.734571099113  delta_E= -7.03e-11  |g|= 1.94e-06  |ddm|= 2.07e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2711216039085  E_coul = 201.53655050479588
  HOMO = -0.582938566009872  LUMO = 0.919629867674157
  mo_energy =
[-1.18581697e+02 -1.23099701e+01 -9.56289476e+00 -9.56289476e+00
 -9.56289476e+00 -1.26984343e+00 -5.82938566e-01 -5.82938566e-01
 -5.82938566e-01  9.19629868e-01  1.01415065e+00  1.01415065e+00
  1.01415065e+00  7.27381140e+00  7.27381140e+00  7.27381140e+00
  1.10474577e+01  3.33950570e+01  3.33950570e+01  3.33950570e+01
  1.01625290e+02  1.28952373e+02  1.28952373e+02  1.28952373e+02
  4.83284663e+02  4.83284663e+02  4.83284663e+02  5.81949261e+02
  1.33512557e+03  1.33512557e+03  1.33512557e+03  2.65057691e+03
  3.02937329e+03  3.02937329e+03  3.02937329e+03  6.64981722e+03
  6.64981722e+03  6.64981722e+03  9.05639561e+03  2.54121930e+04
  7.61547920e+04]
E1 = -728.271120102745  E_coul = 201.53654900363233
Extra cycle  E= -526.734571099113  delta_E= -1.14e-13  |g|= 4.04e-07  |ddm|= 3.47e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826559e+04 7.61752186e+03 3.61735089e+03 1.59782458e+03
 3.82851844e+02 1.08124236e+02 3.48546307e+01 7.49526097e+00
 2.97021160e+00 6.41970972e-01 2.31400596e-01 1.36278321e+03
 6.64745600e+02 3.00961611e+02 3.14041946e+02 6.16227603e+01
 7.33116888e+00 2.02375757e+01 7.74320643e-01 2.81066724e+00
 2.22956445e-01]
E = -526.7345710991127
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558795        1
[INPUT] 0    0    [1    /1   ]  7617.52186259        1
[INPUT] 0    0    [1    /1   ]  3617.35089267        1
[INPUT] 0    0    [1    /1   ]  1597.82457922        1
[INPUT] 0    0    [1    /1   ]  382.851844246        1
[INPUT] 0    0    [1    /1   ]  108.124235594        1
[INPUT] 0    0    [1    /1   ]  34.8546307015        1
[INPUT] 0    0    [1    /1   ]  7.49526097406        1
[INPUT] 0    0    [1    /1   ]  2.97021160333        1
[INPUT] 0    0    [1    /1   ]  0.641970971605       1
[INPUT] 0    0    [1    /1   ]  0.231400596189       1
[INPUT] 1    0    [1    /1   ]  1362.78321434        1
[INPUT] 1    0    [1    /1   ]  664.745600436        1
[INPUT] 1    0    [1    /1   ]  300.961611122        1
[INPUT] 1    0    [1    /1   ]  314.041945979        1
[INPUT] 1    0    [1    /1   ]  61.6227602865        1
[INPUT] 1    0    [1    /1   ]  7.33116888005        1
[INPUT] 1    0    [1    /1   ]  20.2375757461        1
[INPUT] 1    0    [1    /1   ]  0.774320642976       1
[INPUT] 1    0    [1    /1   ]  2.81066724222        1
[INPUT] 1    0    [1    /1   ]  0.222956445366       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.6558795349, 1.0]], [0, [7617.5218625877915, 1.0]], [0, [3617.3508926653913, 1.0]], [0, [1597.8245792242528, 1.0]], [0, [382.85184424564903, 1.0]], [0, [108.12423559428757, 1.0]], [0, [34.85463070147413, 1.0]], [0, [7.495260974064226, 1.0]], [0, [2.9702116033266286, 1.0]], [0, [0.6419709716049139, 1.0]], [0, [0.23140059618916706, 1.0]], [1, [1362.7832143439086, 1.0]], [1, [664.745600435552, 1.0]], [1, [300.9616111219382, 1.0]], [1, [314.04194597889574, 1.0]], [1, [61.62276028649245, 1.0]], [1, [7.331168880054986, 1.0]], [1, [20.237575746128677, 1.0]], [1, [0.7743206429759947, 1.0]], [1, [2.8106672422160064, 1.0]], [1, [0.2229564453658699, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65587953]
bas 1, expnt(s) = [7617.52186259]
bas 2, expnt(s) = [3617.35089267]
bas 3, expnt(s) = [1597.82457922]
bas 4, expnt(s) = [382.85184425]
bas 5, expnt(s) = [108.12423559]
bas 6, expnt(s) = [34.8546307]
bas 7, expnt(s) = [7.49526097]
bas 8, expnt(s) = [2.9702116]
bas 9, expnt(s) = [0.64197097]
bas 10, expnt(s) = [0.2314006]
bas 11, expnt(s) = [1362.78321434]
bas 12, expnt(s) = [664.74560044]
bas 13, expnt(s) = [300.96161112]
bas 14, expnt(s) = [314.04194598]
bas 15, expnt(s) = [61.62276029]
bas 16, expnt(s) = [7.33116888]
bas 17, expnt(s) = [20.23757575]
bas 18, expnt(s) = [0.77432064]
bas 19, expnt(s) = [2.81066724]
bas 20, expnt(s) = [0.22295645]
CPU time:        61.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752186e+03 2.06003835e+03
 3.61735089e+03 1.17844143e+03 1.59782458e+03 6.38501391e+02
 3.82851844e+02 2.18669435e+02 1.08124236e+02 8.47144142e+01
 3.48546307e+01 3.62418525e+01 7.49526097e+00 1.14447179e+01
 2.97021160e+00 5.71617567e+00 6.41970972e-01 1.81197235e+00
 2.31400596e-01 8.42923922e-01 1.36278321e+03 2.41556018e+04
 6.64745600e+02 9.84699533e+03 3.00961611e+02 3.65698578e+03
 3.14041946e+02 3.85672761e+03 6.16227603e+01 5.03687099e+02
 7.33116888e+00 3.51925651e+01 2.02375757e+01 1.25222538e+02
 7.74320643e-01 2.11902187e+00 2.81066724e+00 1.06168623e+01
 2.22956445e-01 4.46950505e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993738694706614
cond(S) = 103194.52134454843
E1 = -729.5104383265951  E_coul = 203.17051232288276
init E= -526.339926003712
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555819886984725  LUMO = 0.939260206149942
  mo_energy =
[-1.18327885e+02 -1.22047759e+01 -9.44762137e+00 -9.44762137e+00
 -9.44762137e+00 -1.24004002e+00 -5.55819887e-01 -5.55819887e-01
 -5.55819887e-01  9.39260206e-01  1.03270425e+00  1.03270425e+00
  1.03270425e+00  7.34445428e+00  7.34445428e+00  7.34445428e+00
  1.11270989e+01  3.35161174e+01  3.35161174e+01  3.35161174e+01
  1.01797585e+02  1.29135350e+02  1.29135350e+02  1.29135350e+02
  4.83537682e+02  4.83537682e+02  4.83537682e+02  5.82239222e+02
  1.33543304e+03  1.33543304e+03  1.33543304e+03  2.65101717e+03
  3.02974559e+03  3.02974559e+03  3.02974559e+03  6.65030220e+03
  6.65030220e+03  6.65030220e+03  9.05695575e+03  2.54128472e+04
  7.61555364e+04]
E1 = -727.8220921329013  E_coul = 201.0883174757994
cycle= 1 E= -526.733774657102  delta_E= -0.394  |g|= 0.188  |ddm|= 0.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.545359
diis-c [-0.29741623  1.        ]
  HOMO = -0.590570065105427  LUMO = 0.913103797629538
  mo_energy =
[-1.18640011e+02 -1.23424363e+01 -9.59665006e+00 -9.59665006e+00
 -9.59665006e+00 -1.27912678e+00 -5.90570065e-01 -5.90570065e-01
 -5.90570065e-01  9.13103798e-01  1.00849087e+00  1.00849087e+00
  1.00849087e+00  7.25376804e+00  7.25376804e+00  7.25376804e+00
  1.10230511e+01  3.33609410e+01  3.33609410e+01  3.33609410e+01
  1.01577647e+02  1.28904404e+02  1.28904404e+02  1.28904404e+02
  4.83227055e+02  4.83227055e+02  4.83227055e+02  5.81889644e+02
  1.33506449e+03  1.33506449e+03  1.33506449e+03  2.65051317e+03
  3.02931036e+03  3.02931036e+03  3.02931036e+03  6.64975297e+03
  6.64975297e+03  6.64975297e+03  9.05633078e+03  2.54121279e+04
  7.61547267e+04]
E1 = -728.3993675059461  E_coul = 201.66485790682526
cycle= 2 E= -526.734509599121  delta_E= -0.000735  |g|= 0.0381  |ddm|= 0.0533
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0758542
diis-c [-0.00325883  0.08433076  0.91566924]
  HOMO = -0.581463176231758  LUMO = 0.920744314988476
  mo_energy =
[-1.18571844e+02 -1.23042660e+01 -9.55682183e+00 -9.55682183e+00
 -9.55682183e+00 -1.26821523e+00 -5.81463176e-01 -5.81463176e-01
 -5.81463176e-01  9.20744315e-01  1.01520960e+00  1.01520960e+00
  1.01520960e+00  7.27752571e+00  7.27752571e+00  7.27752571e+00
  1.10517758e+01  3.34011455e+01  3.34011455e+01  3.34011455e+01
  1.01633407e+02  1.28960622e+02  1.28960622e+02  1.28960622e+02
  4.83294400e+02  4.83294400e+02  4.83294400e+02  5.81959361e+02
  1.33513591e+03  1.33513591e+03  1.33513591e+03  2.65058791e+03
  3.02938403e+03  3.02938403e+03  3.02938403e+03  6.64982837e+03
  6.64982837e+03  6.64982837e+03  9.05640699e+03  2.54122046e+04
  7.61548037e+04]
E1 = -728.2487693797431  E_coul = 201.5142001610046
cycle= 3 E= -526.734569218738  delta_E= -5.96e-05  |g|= 0.00621  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130672
diis-c [-7.03204906e-07 -1.29867347e-03  1.42132600e-01  8.59166074e-01]
  HOMO = -0.582949010492845  LUMO = 0.919598924771249
  mo_energy =
[-1.18581703e+02 -1.23100123e+01 -9.56291991e+00 -9.56291991e+00
 -9.56291991e+00 -1.26988121e+00 -5.82949010e-01 -5.82949010e-01
 -5.82949010e-01  9.19598925e-01  1.01413974e+00  1.01413974e+00
  1.01413974e+00  7.27378678e+00  7.27378678e+00  7.27378678e+00
  1.10474155e+01  3.33950329e+01  3.33950329e+01  3.33950329e+01
  1.01625266e+02  1.28952356e+02  1.28952356e+02  1.28952356e+02
  4.83284656e+02  4.83284656e+02  4.83284656e+02  5.81949263e+02
  1.33512558e+03  1.33512558e+03  1.33512558e+03  2.65057694e+03
  3.02937331e+03  3.02937331e+03  3.02937331e+03  6.64981726e+03
  6.64981726e+03  6.64981726e+03  9.05639566e+03  2.54121931e+04
  7.61547921e+04]
E1 = -728.2712569744209  E_coul = 201.53668587751918
cycle= 4 E= -526.734571096902  delta_E= -1.88e-06  |g|= 0.000108  |ddm|= 0.0022
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000127168
diis-c [-4.76174709e-09  7.77628999e-05 -1.08739150e-02 -7.22358144e-02
  1.08303197e+00]
  HOMO = -0.582930436298452  LUMO = 0.919633462199481
  mo_energy =
[-1.18581664e+02 -1.23099460e+01 -9.56286856e+00 -9.56286856e+00
 -9.56286856e+00 -1.26983744e+00 -5.82930436e-01 -5.82930436e-01
 -5.82930436e-01  9.19633462e-01  1.01415597e+00  1.01415597e+00
  1.01415597e+00  7.27382923e+00  7.27382923e+00  7.27382923e+00
  1.10474763e+01  3.33950824e+01  3.33950824e+01  3.33950824e+01
  1.01625319e+02  1.28952403e+02  1.28952403e+02  1.28952403e+02
  4.83284695e+02  4.83284695e+02  4.83284695e+02  5.81949294e+02
  1.33512561e+03  1.33512561e+03  1.33512561e+03  2.65057695e+03
  3.02937333e+03  3.02937333e+03  3.02937333e+03  6.64981726e+03
  6.64981726e+03  6.64981726e+03  9.05639565e+03  2.54121931e+04
  7.61547921e+04]
E1 = -728.2710351984263  E_coul = 201.53646409938386
cycle= 5 E= -526.734571099042  delta_E= -2.14e-09  |g|= 2.21e-05  |ddm|= 0.000177
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.1238e-05
diis-c [-9.54968528e-11  1.48174812e-05 -1.81447384e-03 -1.40831611e-02
  4.42726978e-02  9.71610120e-01]
  HOMO = -0.582938545248971  LUMO = 0.919629505789939
  mo_energy =
[-1.18581697e+02 -1.23099703e+01 -9.56289490e+00 -9.56289490e+00
 -9.56289490e+00 -1.26984385e+00 -5.82938545e-01 -5.82938545e-01
 -5.82938545e-01  9.19629506e-01  1.01415060e+00  1.01415060e+00
  1.01415060e+00  7.27381131e+00  7.27381131e+00  7.27381131e+00
  1.10474574e+01  3.33950568e+01  3.33950568e+01  3.33950568e+01
  1.01625289e+02  1.28952373e+02  1.28952373e+02  1.28952373e+02
  4.83284663e+02  4.83284663e+02  4.83284663e+02  5.81949261e+02
  1.33512557e+03  1.33512557e+03  1.33512557e+03  2.65057691e+03
  3.02937329e+03  3.02937329e+03  3.02937329e+03  6.64981722e+03
  6.64981722e+03  6.64981722e+03  9.05639561e+03  2.54121930e+04
  7.61547920e+04]
E1 = -728.2711216039085  E_coul = 201.53655050479588
cycle= 6 E= -526.734571099113  delta_E= -7.03e-11  |g|= 1.94e-06  |ddm|= 2.07e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2711216039085  E_coul = 201.53655050479588
  HOMO = -0.582938566009872  LUMO = 0.919629867674157
  mo_energy =
[-1.18581697e+02 -1.23099701e+01 -9.56289476e+00 -9.56289476e+00
 -9.56289476e+00 -1.26984343e+00 -5.82938566e-01 -5.82938566e-01
 -5.82938566e-01  9.19629868e-01  1.01415065e+00  1.01415065e+00
  1.01415065e+00  7.27381140e+00  7.27381140e+00  7.27381140e+00
  1.10474577e+01  3.33950570e+01  3.33950570e+01  3.33950570e+01
  1.01625290e+02  1.28952373e+02  1.28952373e+02  1.28952373e+02
  4.83284663e+02  4.83284663e+02  4.83284663e+02  5.81949261e+02
  1.33512557e+03  1.33512557e+03  1.33512557e+03  2.65057691e+03
  3.02937329e+03  3.02937329e+03  3.02937329e+03  6.64981722e+03
  6.64981722e+03  6.64981722e+03  9.05639561e+03  2.54121930e+04
  7.61547920e+04]
E1 = -728.271120102745  E_coul = 201.53654900363233
Extra cycle  E= -526.734571099113  delta_E= -1.14e-13  |g|= 4.04e-07  |ddm|= 3.47e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103194.52134454843
E1 = -728.271120102745  E_coul = 201.53654900363233
init E= -526.734571099113
    CPU time for initialize scf      0.97 sec, wall time      0.25 sec
  HOMO = -0.582938610502396  LUMO = 0.919629910169102
  mo_energy =
[-1.18581697e+02 -1.23099702e+01 -9.56289489e+00 -9.56289489e+00
 -9.56289489e+00 -1.26984339e+00 -5.82938611e-01 -5.82938611e-01
 -5.82938611e-01  9.19629910e-01  1.01415063e+00  1.01415063e+00
  1.01415063e+00  7.27381132e+00  7.27381132e+00  7.27381132e+00
  1.10474576e+01  3.33950569e+01  3.33950569e+01  3.33950569e+01
  1.01625289e+02  1.28952373e+02  1.28952373e+02  1.28952373e+02
  4.83284663e+02  4.83284663e+02  4.83284663e+02  5.81949261e+02
  1.33512557e+03  1.33512557e+03  1.33512557e+03  2.65057691e+03
  3.02937329e+03  3.02937329e+03  3.02937329e+03  6.64981722e+03
  6.64981722e+03  6.64981722e+03  9.05639561e+03  2.54121930e+04
  7.61547920e+04]
E1 = -728.2711203652512  E_coul = 201.53654926613845
cycle= 1 E= -526.734571099113  delta_E= -1.14e-13  |g|= 8.64e-08  |ddm|= 6.79e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2711203652512  E_coul = 201.53654926613845
  HOMO = -0.582938608895113  LUMO = 0.919629927589802
  mo_energy =
[-1.18581697e+02 -1.23099702e+01 -9.56289488e+00 -9.56289488e+00
 -9.56289488e+00 -1.26984337e+00 -5.82938609e-01 -5.82938609e-01
 -5.82938609e-01  9.19629928e-01  1.01415063e+00  1.01415063e+00
  1.01415063e+00  7.27381133e+00  7.27381133e+00  7.27381133e+00
  1.10474576e+01  3.33950569e+01  3.33950569e+01  3.33950569e+01
  1.01625289e+02  1.28952373e+02  1.28952373e+02  1.28952373e+02
  4.83284663e+02  4.83284663e+02  4.83284663e+02  5.81949261e+02
  1.33512557e+03  1.33512557e+03  1.33512557e+03  2.65057691e+03
  3.02937329e+03  3.02937329e+03  3.02937329e+03  6.64981722e+03
  6.64981722e+03  6.64981722e+03  9.05639561e+03  2.54121930e+04
  7.61547920e+04]
E1 = -728.2711202587386  E_coul = 201.53654915962602
Extra cycle  E= -526.734571099113  delta_E= 2.27e-13  |g|= 1.77e-08  |ddm|= 1.46e-07
    CPU time for scf_cycle      1.11 sec, wall time      0.39 sec
exp = [2.61826559e+04 7.61752186e+03 3.61735089e+03 1.59782458e+03
 3.82851844e+02 1.08124236e+02 3.48546307e+01 7.49526097e+00
 2.97021160e+00 6.41970972e-01 2.31400596e-01 1.36278321e+03
 6.64745600e+02 3.00961611e+02 3.14041946e+02 6.16227603e+01
 7.33116888e+00 2.02375757e+01 7.74320643e-01 2.81066724e+00
 2.22956445e-01]
grad_E = [-1.51834840e-06  3.32036130e-06 -1.57242938e-06  6.98258332e-05
 -5.07540391e-05 -6.95009688e-05 -3.83821360e-03 -4.31488580e-03
  2.88751458e-03 -3.87694515e-03  3.27215562e-03 -5.05342816e-07
  5.02810785e-06  2.37397174e-05  2.04681131e-05 -2.86859335e-05
 -5.36741129e-05  7.35570683e-05 -5.61472752e-03 -8.83333980e-06
  1.79818069e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558963        1
[INPUT] 0    0    [1    /1   ]  7617.5218259         1
[INPUT] 0    0    [1    /1   ]  3617.35091002        1
[INPUT] 0    0    [1    /1   ]  1597.82380735        1
[INPUT] 0    0    [1    /1   ]  382.852430672        1
[INPUT] 0    0    [1    /1   ]  108.124909207        1
[INPUT] 0    0    [1    /1   ]  34.8962975574        1
[INPUT] 0    0    [1    /1   ]  7.52459114783        1
[INPUT] 0    0    [1    /1   ]  2.99046550652        1
[INPUT] 0    0    [1    /1   ]  0.66575850665        1
[INPUT] 0    0    [1    /1   ]  0.239746675728       1
[INPUT] 1    0    [1    /1   ]  1362.78321992        1
[INPUT] 1    0    [1    /1   ]  664.745544892        1
[INPUT] 1    0    [1    /1   ]  300.96134885         1
[INPUT] 1    0    [1    /1   ]  314.041719852        1
[INPUT] 1    0    [1    /1   ]  61.6230920136        1
[INPUT] 1    0    [1    /1   ]  7.33196511965        1
[INPUT] 1    0    [1    /1   ]  20.2367021597        1
[INPUT] 1    0    [1    /1   ]  0.774276912153       1
[INPUT] 1    0    [1    /1   ]  2.81251963753        1
[INPUT] 1    0    [1    /1   ]  0.22343713514        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655896303444, 1.0]], [0, [7617.521825901653, 1.0]], [0, [3617.350910023205, 1.0]], [0, [1597.8238073507198, 1.0]], [0, [382.85243067246546, 1.0]], [0, [108.12490920711097, 1.0]], [0, [34.896297557413774, 1.0]], [0, [7.524591147825761, 1.0]], [0, [2.9904655065170505, 1.0]], [0, [0.6657585066498463, 1.0]], [0, [0.23974667572766273, 1.0]], [1, [1362.783219923041, 1.0]], [1, [664.7455448915493, 1.0]], [1, [300.96134884966295, 1.0]], [1, [314.04171985181745, 1.0]], [1, [61.62309201364127, 1.0]], [1, [7.3319651196504605, 1.0]], [1, [20.23670215969825, 1.0]], [1, [0.7742769121528641, 1.0]], [1, [2.812519637527343, 1.0]], [1, [0.2234371351400231, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6558963]
bas 1, expnt(s) = [7617.5218259]
bas 2, expnt(s) = [3617.35091002]
bas 3, expnt(s) = [1597.82380735]
bas 4, expnt(s) = [382.85243067]
bas 5, expnt(s) = [108.12490921]
bas 6, expnt(s) = [34.89629756]
bas 7, expnt(s) = [7.52459115]
bas 8, expnt(s) = [2.99046551]
bas 9, expnt(s) = [0.66575851]
bas 10, expnt(s) = [0.23974668]
bas 11, expnt(s) = [1362.78321992]
bas 12, expnt(s) = [664.74554489]
bas 13, expnt(s) = [300.96134885]
bas 14, expnt(s) = [314.04171985]
bas 15, expnt(s) = [61.62309201]
bas 16, expnt(s) = [7.33196512]
bas 17, expnt(s) = [20.23670216]
bas 18, expnt(s) = [0.77427691]
bas 19, expnt(s) = [2.81251964]
bas 20, expnt(s) = [0.22343714]
CPU time:        67.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752183e+03 2.06003835e+03
 3.61735091e+03 1.17844144e+03 1.59782381e+03 6.38501159e+02
 3.82852431e+02 2.18669686e+02 1.08124909e+02 8.47148100e+01
 3.48962976e+01 3.62743415e+01 7.52459115e+00 1.14782903e+01
 2.99046551e+00 5.74538482e+00 6.65758507e-01 1.86209814e+00
 2.39746676e-01 8.65624360e-01 1.36278322e+03 2.41556019e+04
 6.64745545e+02 9.84699431e+03 3.00961349e+02 3.65698179e+03
 3.14041720e+02 3.85672414e+03 6.16230920e+01 5.03690488e+02
 7.33196512e+00 3.51973430e+01 2.02367022e+01 1.25215781e+02
 7.74276912e-01 2.11887228e+00 2.81251964e+00 1.06256094e+01
 2.23437135e-01 4.48155350e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993644073049005
cond(S) = 103295.36451557044
E1 = -729.5116576769511  E_coul = 203.17160615434673
init E= -526.340051522604
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555760325665622  LUMO = 0.997196036230883
  mo_energy =
[-1.18327910e+02 -1.22047793e+01 -9.44754811e+00 -9.44754811e+00
 -9.44754811e+00 -1.23996144e+00 -5.55760326e-01 -5.55760326e-01
 -5.55760326e-01  9.97196036e-01  1.03460310e+00  1.03460310e+00
  1.03460310e+00  7.34969019e+00  7.34969019e+00  7.34969019e+00
  1.13647659e+01  3.35253180e+01  3.35253180e+01  3.35253180e+01
  1.02219586e+02  1.29143195e+02  1.29143195e+02  1.29143195e+02
  4.83543543e+02  4.83543543e+02  4.83543543e+02  5.82693595e+02
  1.33543770e+03  1.33543770e+03  1.33543770e+03  2.65142868e+03
  3.02974920e+03  3.02974920e+03  3.02974920e+03  6.65030493e+03
  6.65030493e+03  6.65030493e+03  9.05733411e+03  2.54132048e+04
  7.61558693e+04]
E1 = -727.8373765541415  E_coul = 201.10337040630122
cycle= 1 E= -526.73400614784  delta_E= -0.394  |g|= 0.187  |ddm|= 0.326
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.544537
diis-c [-0.29652059  1.        ]
  HOMO = -0.590146962570334  LUMO = 0.970035650380513
  mo_energy =
[-1.18638655e+02 -1.23414668e+01 -9.59551941e+00 -9.59551941e+00
 -9.59551941e+00 -1.27869606e+00 -5.90146963e-01 -5.90146963e-01
 -5.90146963e-01  9.70035650e-01  1.01065232e+00  1.01065232e+00
  1.01065232e+00  7.25969872e+00  7.25969872e+00  7.25969872e+00
  1.12609351e+01  3.33711944e+01  3.33711944e+01  3.33711944e+01
  1.02000844e+02  1.28913485e+02  1.28913485e+02  1.28913485e+02
  4.83234298e+02  4.83234298e+02  4.83234298e+02  5.82345448e+02
  1.33507059e+03  1.33507059e+03  1.33507059e+03  2.65092618e+03
  3.02931544e+03  3.02931544e+03  3.02931544e+03  6.64975721e+03
  6.64975721e+03  6.64975721e+03  9.05671066e+03  2.54124870e+04
  7.61550611e+04]
E1 = -728.4109402198677  E_coul = 201.67620807981305
cycle= 2 E= -526.734732140055  delta_E= -0.000726  |g|= 0.0378  |ddm|= 0.053
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755031
diis-c [-0.00324205  0.08388066  0.91611934]
  HOMO = -0.581108147424362  LUMO = 0.977961747977746
  mo_energy =
[-1.18570845e+02 -1.23035271e+01 -9.55592316e+00 -9.55592316e+00
 -9.55592316e+00 -1.26786536e+00 -5.81108147e-01 -5.81108147e-01
 -5.81108147e-01  9.77961748e-01  1.01732589e+00  1.01732589e+00
  1.01732589e+00  7.28330999e+00  7.28330999e+00  7.28330999e+00
  1.12895847e+01  3.34111658e+01  3.34111658e+01  3.34111658e+01
  1.02056301e+02  1.28969397e+02  1.28969397e+02  1.28969397e+02
  4.83301291e+02  4.83301291e+02  4.83301291e+02  5.82414803e+02
  1.33514165e+03  1.33514165e+03  1.33514165e+03  2.65100054e+03
  3.02938873e+03  3.02938873e+03  3.02938873e+03  6.64983223e+03
  6.64983223e+03  6.64983223e+03  9.05678649e+03  2.54125634e+04
  7.61551378e+04]
E1 = -728.2612228361155  E_coul = 201.52643178755446
cycle= 3 E= -526.734791048561  delta_E= -5.89e-05  |g|= 0.0062  |ddm|= 0.0161
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130339
diis-c [-6.85996428e-07 -1.29345959e-03  1.42418973e-01  8.58874487e-01]
  HOMO = -0.582586886106411  LUMO = 0.976767796295303
  mo_energy =
[-1.18580681e+02 -1.23092590e+01 -9.56200515e+00 -9.56200515e+00
 -9.56200515e+00 -1.26952600e+00 -5.82586886e-01 -5.82586886e-01
 -5.82586886e-01  9.76767796e-01  1.01626027e+00  1.01626027e+00
  1.01626027e+00  7.27958197e+00  7.27958197e+00  7.27958197e+00
  1.12852177e+01  3.34050694e+01  3.34050694e+01  3.34050694e+01
  1.02048179e+02  1.28961150e+02  1.28961150e+02  1.28961150e+02
  4.83291569e+02  4.83291569e+02  4.83291569e+02  5.82404728e+02
  1.33513134e+03  1.33513134e+03  1.33513134e+03  2.65098960e+03
  3.02937804e+03  3.02937804e+03  3.02937804e+03  6.64982115e+03
  6.64982115e+03  6.64982115e+03  9.05677519e+03  2.54125519e+04
  7.61551262e+04]
E1 = -728.2836661379654  E_coul = 201.5488732206011
cycle= 4 E= -526.734792917364  delta_E= -1.87e-06  |g|= 0.000106  |ddm|= 0.0022
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122079
diis-c [-4.68578338e-09  7.46775318e-05 -1.05372026e-02 -6.96468770e-02
  1.08010940e+00]
  HOMO = -0.582567241097702  LUMO = 0.976803890525949
  mo_energy =
[-1.18580639e+02 -1.23091903e+01 -9.56195101e+00 -9.56195101e+00
 -9.56195101e+00 -1.26948175e+00 -5.82567241e-01 -5.82567241e-01
 -5.82567241e-01  9.76803891e-01  1.01627720e+00  1.01627720e+00
  1.01627720e+00  7.27962636e+00  7.27962636e+00  7.27962636e+00
  1.12852802e+01  3.34051216e+01  3.34051216e+01  3.34051216e+01
  1.02048234e+02  1.28961200e+02  1.28961200e+02  1.28961200e+02
  4.83291612e+02  4.83291612e+02  4.83291612e+02  5.82404763e+02
  1.33513137e+03  1.33513137e+03  1.33513137e+03  2.65098961e+03
  3.02937806e+03  3.02937806e+03  3.02937806e+03  6.64982115e+03
  6.64982115e+03  6.64982115e+03  9.05677519e+03  2.54125519e+04
  7.61551262e+04]
E1 = -728.2834391931905  E_coul = 201.5486462738146
cycle= 5 E= -526.734792919376  delta_E= -2.01e-09  |g|= 2.19e-05  |ddm|= 0.000171
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.12224e-05
diis-c [-9.03866232e-11  1.47244794e-05 -1.81483344e-03 -1.40587719e-02
  4.51133250e-02  9.70745556e-01]
  HOMO = -0.582575207587257  LUMO = 0.976799784805832
  mo_energy =
[-1.18580672e+02 -1.23092144e+01 -9.56197712e+00 -9.56197712e+00
 -9.56197712e+00 -1.26948808e+00 -5.82575208e-01 -5.82575208e-01
 -5.82575208e-01  9.76799785e-01  1.01627192e+00  1.01627192e+00
  1.01627192e+00  7.27960865e+00  7.27960865e+00  7.27960865e+00
  1.12852614e+01  3.34050963e+01  3.34050963e+01  3.34050963e+01
  1.02048205e+02  1.28961170e+02  1.28961170e+02  1.28961170e+02
  4.83291579e+02  4.83291579e+02  4.83291579e+02  5.82404730e+02
  1.33513134e+03  1.33513134e+03  1.33513134e+03  2.65098957e+03
  3.02937803e+03  3.02937803e+03  3.02937803e+03  6.64982112e+03
  6.64982112e+03  6.64982112e+03  9.05677515e+03  2.54125519e+04
  7.61551261e+04]
E1 = -728.2835254966707  E_coul = 201.54873257722738
cycle= 6 E= -526.734792919443  delta_E= -6.74e-11  |g|= 1.9e-06  |ddm|= 2e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2835254966707  E_coul = 201.54873257722738
  HOMO = -0.582575237358527  LUMO = 0.976800141116471
  mo_energy =
[-1.18580671e+02 -1.23092142e+01 -9.56197705e+00 -9.56197705e+00
 -9.56197705e+00 -1.26948769e+00 -5.82575237e-01 -5.82575237e-01
 -5.82575237e-01  9.76800141e-01  1.01627196e+00  1.01627196e+00
  1.01627196e+00  7.27960869e+00  7.27960869e+00  7.27960869e+00
  1.12852616e+01  3.34050964e+01  3.34050964e+01  3.34050964e+01
  1.02048205e+02  1.28961170e+02  1.28961170e+02  1.28961170e+02
  4.83291580e+02  4.83291580e+02  4.83291580e+02  5.82404730e+02
  1.33513134e+03  1.33513134e+03  1.33513134e+03  2.65098957e+03
  3.02937803e+03  3.02937803e+03  3.02937803e+03  6.64982112e+03
  6.64982112e+03  6.64982112e+03  9.05677515e+03  2.54125519e+04
  7.61551261e+04]
E1 = -728.2835243454041  E_coul = 201.54873142596028
Extra cycle  E= -526.734792919444  delta_E= -5.68e-13  |g|= 3.92e-07  |ddm|= 3.33e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826559e+04 7.61752183e+03 3.61735091e+03 1.59782381e+03
 3.82852431e+02 1.08124909e+02 3.48962976e+01 7.52459115e+00
 2.99046551e+00 6.65758507e-01 2.39746676e-01 1.36278322e+03
 6.64745545e+02 3.00961349e+02 3.14041720e+02 6.16230920e+01
 7.33196512e+00 2.02367022e+01 7.74276912e-01 2.81251964e+00
 2.23437135e-01]
E = -526.7347929194439
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6558963        1
[INPUT] 0    0    [1    /1   ]  7617.5218259         1
[INPUT] 0    0    [1    /1   ]  3617.35091002        1
[INPUT] 0    0    [1    /1   ]  1597.82380735        1
[INPUT] 0    0    [1    /1   ]  382.852430672        1
[INPUT] 0    0    [1    /1   ]  108.124909207        1
[INPUT] 0    0    [1    /1   ]  34.8962975574        1
[INPUT] 0    0    [1    /1   ]  7.52459114783        1
[INPUT] 0    0    [1    /1   ]  2.99046550652        1
[INPUT] 0    0    [1    /1   ]  0.66575850665        1
[INPUT] 0    0    [1    /1   ]  0.239746675728       1
[INPUT] 1    0    [1    /1   ]  1362.78321992        1
[INPUT] 1    0    [1    /1   ]  664.745544892        1
[INPUT] 1    0    [1    /1   ]  300.96134885         1
[INPUT] 1    0    [1    /1   ]  314.041719852        1
[INPUT] 1    0    [1    /1   ]  61.6230920136        1
[INPUT] 1    0    [1    /1   ]  7.33196511965        1
[INPUT] 1    0    [1    /1   ]  20.2367021597        1
[INPUT] 1    0    [1    /1   ]  0.774276912153       1
[INPUT] 1    0    [1    /1   ]  2.81251963753        1
[INPUT] 1    0    [1    /1   ]  0.22343713514        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655896303444, 1.0]], [0, [7617.521825901653, 1.0]], [0, [3617.350910023205, 1.0]], [0, [1597.8238073507198, 1.0]], [0, [382.85243067246546, 1.0]], [0, [108.12490920711097, 1.0]], [0, [34.896297557413774, 1.0]], [0, [7.524591147825761, 1.0]], [0, [2.9904655065170505, 1.0]], [0, [0.6657585066498463, 1.0]], [0, [0.23974667572766273, 1.0]], [1, [1362.783219923041, 1.0]], [1, [664.7455448915493, 1.0]], [1, [300.96134884966295, 1.0]], [1, [314.04171985181745, 1.0]], [1, [61.62309201364127, 1.0]], [1, [7.3319651196504605, 1.0]], [1, [20.23670215969825, 1.0]], [1, [0.7742769121528641, 1.0]], [1, [2.812519637527343, 1.0]], [1, [0.2234371351400231, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6558963]
bas 1, expnt(s) = [7617.5218259]
bas 2, expnt(s) = [3617.35091002]
bas 3, expnt(s) = [1597.82380735]
bas 4, expnt(s) = [382.85243067]
bas 5, expnt(s) = [108.12490921]
bas 6, expnt(s) = [34.89629756]
bas 7, expnt(s) = [7.52459115]
bas 8, expnt(s) = [2.99046551]
bas 9, expnt(s) = [0.66575851]
bas 10, expnt(s) = [0.23974668]
bas 11, expnt(s) = [1362.78321992]
bas 12, expnt(s) = [664.74554489]
bas 13, expnt(s) = [300.96134885]
bas 14, expnt(s) = [314.04171985]
bas 15, expnt(s) = [61.62309201]
bas 16, expnt(s) = [7.33196512]
bas 17, expnt(s) = [20.23670216]
bas 18, expnt(s) = [0.77427691]
bas 19, expnt(s) = [2.81251964]
bas 20, expnt(s) = [0.22343714]
CPU time:        67.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026287e+03 7.61752183e+03 2.06003835e+03
 3.61735091e+03 1.17844144e+03 1.59782381e+03 6.38501159e+02
 3.82852431e+02 2.18669686e+02 1.08124909e+02 8.47148100e+01
 3.48962976e+01 3.62743415e+01 7.52459115e+00 1.14782903e+01
 2.99046551e+00 5.74538482e+00 6.65758507e-01 1.86209814e+00
 2.39746676e-01 8.65624360e-01 1.36278322e+03 2.41556019e+04
 6.64745545e+02 9.84699431e+03 3.00961349e+02 3.65698179e+03
 3.14041720e+02 3.85672414e+03 6.16230920e+01 5.03690488e+02
 7.33196512e+00 3.51973430e+01 2.02367022e+01 1.25215781e+02
 7.74276912e-01 2.11887228e+00 2.81251964e+00 1.06256094e+01
 2.23437135e-01 4.48155350e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993644073049005
cond(S) = 103295.36451557044
E1 = -729.5116576769511  E_coul = 203.17160615434673
init E= -526.340051522604
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555760325665622  LUMO = 0.997196036230883
  mo_energy =
[-1.18327910e+02 -1.22047793e+01 -9.44754811e+00 -9.44754811e+00
 -9.44754811e+00 -1.23996144e+00 -5.55760326e-01 -5.55760326e-01
 -5.55760326e-01  9.97196036e-01  1.03460310e+00  1.03460310e+00
  1.03460310e+00  7.34969019e+00  7.34969019e+00  7.34969019e+00
  1.13647659e+01  3.35253180e+01  3.35253180e+01  3.35253180e+01
  1.02219586e+02  1.29143195e+02  1.29143195e+02  1.29143195e+02
  4.83543543e+02  4.83543543e+02  4.83543543e+02  5.82693595e+02
  1.33543770e+03  1.33543770e+03  1.33543770e+03  2.65142868e+03
  3.02974920e+03  3.02974920e+03  3.02974920e+03  6.65030493e+03
  6.65030493e+03  6.65030493e+03  9.05733411e+03  2.54132048e+04
  7.61558693e+04]
E1 = -727.8373765541415  E_coul = 201.10337040630122
cycle= 1 E= -526.73400614784  delta_E= -0.394  |g|= 0.187  |ddm|= 0.326
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.544537
diis-c [-0.29652059  1.        ]
  HOMO = -0.590146962570334  LUMO = 0.970035650380513
  mo_energy =
[-1.18638655e+02 -1.23414668e+01 -9.59551941e+00 -9.59551941e+00
 -9.59551941e+00 -1.27869606e+00 -5.90146963e-01 -5.90146963e-01
 -5.90146963e-01  9.70035650e-01  1.01065232e+00  1.01065232e+00
  1.01065232e+00  7.25969872e+00  7.25969872e+00  7.25969872e+00
  1.12609351e+01  3.33711944e+01  3.33711944e+01  3.33711944e+01
  1.02000844e+02  1.28913485e+02  1.28913485e+02  1.28913485e+02
  4.83234298e+02  4.83234298e+02  4.83234298e+02  5.82345448e+02
  1.33507059e+03  1.33507059e+03  1.33507059e+03  2.65092618e+03
  3.02931544e+03  3.02931544e+03  3.02931544e+03  6.64975721e+03
  6.64975721e+03  6.64975721e+03  9.05671066e+03  2.54124870e+04
  7.61550611e+04]
E1 = -728.4109402198677  E_coul = 201.67620807981305
cycle= 2 E= -526.734732140055  delta_E= -0.000726  |g|= 0.0378  |ddm|= 0.053
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755031
diis-c [-0.00324205  0.08388066  0.91611934]
  HOMO = -0.581108147424362  LUMO = 0.977961747977746
  mo_energy =
[-1.18570845e+02 -1.23035271e+01 -9.55592316e+00 -9.55592316e+00
 -9.55592316e+00 -1.26786536e+00 -5.81108147e-01 -5.81108147e-01
 -5.81108147e-01  9.77961748e-01  1.01732589e+00  1.01732589e+00
  1.01732589e+00  7.28330999e+00  7.28330999e+00  7.28330999e+00
  1.12895847e+01  3.34111658e+01  3.34111658e+01  3.34111658e+01
  1.02056301e+02  1.28969397e+02  1.28969397e+02  1.28969397e+02
  4.83301291e+02  4.83301291e+02  4.83301291e+02  5.82414803e+02
  1.33514165e+03  1.33514165e+03  1.33514165e+03  2.65100054e+03
  3.02938873e+03  3.02938873e+03  3.02938873e+03  6.64983223e+03
  6.64983223e+03  6.64983223e+03  9.05678649e+03  2.54125634e+04
  7.61551378e+04]
E1 = -728.2612228361155  E_coul = 201.52643178755446
cycle= 3 E= -526.734791048561  delta_E= -5.89e-05  |g|= 0.0062  |ddm|= 0.0161
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130339
diis-c [-6.85996428e-07 -1.29345959e-03  1.42418973e-01  8.58874487e-01]
  HOMO = -0.582586886106411  LUMO = 0.976767796295303
  mo_energy =
[-1.18580681e+02 -1.23092590e+01 -9.56200515e+00 -9.56200515e+00
 -9.56200515e+00 -1.26952600e+00 -5.82586886e-01 -5.82586886e-01
 -5.82586886e-01  9.76767796e-01  1.01626027e+00  1.01626027e+00
  1.01626027e+00  7.27958197e+00  7.27958197e+00  7.27958197e+00
  1.12852177e+01  3.34050694e+01  3.34050694e+01  3.34050694e+01
  1.02048179e+02  1.28961150e+02  1.28961150e+02  1.28961150e+02
  4.83291569e+02  4.83291569e+02  4.83291569e+02  5.82404728e+02
  1.33513134e+03  1.33513134e+03  1.33513134e+03  2.65098960e+03
  3.02937804e+03  3.02937804e+03  3.02937804e+03  6.64982115e+03
  6.64982115e+03  6.64982115e+03  9.05677519e+03  2.54125519e+04
  7.61551262e+04]
E1 = -728.2836661379654  E_coul = 201.5488732206011
cycle= 4 E= -526.734792917364  delta_E= -1.87e-06  |g|= 0.000106  |ddm|= 0.0022
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122079
diis-c [-4.68578338e-09  7.46775318e-05 -1.05372026e-02 -6.96468770e-02
  1.08010940e+00]
  HOMO = -0.582567241097702  LUMO = 0.976803890525949
  mo_energy =
[-1.18580639e+02 -1.23091903e+01 -9.56195101e+00 -9.56195101e+00
 -9.56195101e+00 -1.26948175e+00 -5.82567241e-01 -5.82567241e-01
 -5.82567241e-01  9.76803891e-01  1.01627720e+00  1.01627720e+00
  1.01627720e+00  7.27962636e+00  7.27962636e+00  7.27962636e+00
  1.12852802e+01  3.34051216e+01  3.34051216e+01  3.34051216e+01
  1.02048234e+02  1.28961200e+02  1.28961200e+02  1.28961200e+02
  4.83291612e+02  4.83291612e+02  4.83291612e+02  5.82404763e+02
  1.33513137e+03  1.33513137e+03  1.33513137e+03  2.65098961e+03
  3.02937806e+03  3.02937806e+03  3.02937806e+03  6.64982115e+03
  6.64982115e+03  6.64982115e+03  9.05677519e+03  2.54125519e+04
  7.61551262e+04]
E1 = -728.2834391931905  E_coul = 201.5486462738146
cycle= 5 E= -526.734792919376  delta_E= -2.01e-09  |g|= 2.19e-05  |ddm|= 0.000171
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.12224e-05
diis-c [-9.03866232e-11  1.47244794e-05 -1.81483344e-03 -1.40587719e-02
  4.51133250e-02  9.70745556e-01]
  HOMO = -0.582575207587257  LUMO = 0.976799784805832
  mo_energy =
[-1.18580672e+02 -1.23092144e+01 -9.56197712e+00 -9.56197712e+00
 -9.56197712e+00 -1.26948808e+00 -5.82575208e-01 -5.82575208e-01
 -5.82575208e-01  9.76799785e-01  1.01627192e+00  1.01627192e+00
  1.01627192e+00  7.27960865e+00  7.27960865e+00  7.27960865e+00
  1.12852614e+01  3.34050963e+01  3.34050963e+01  3.34050963e+01
  1.02048205e+02  1.28961170e+02  1.28961170e+02  1.28961170e+02
  4.83291579e+02  4.83291579e+02  4.83291579e+02  5.82404730e+02
  1.33513134e+03  1.33513134e+03  1.33513134e+03  2.65098957e+03
  3.02937803e+03  3.02937803e+03  3.02937803e+03  6.64982112e+03
  6.64982112e+03  6.64982112e+03  9.05677515e+03  2.54125519e+04
  7.61551261e+04]
E1 = -728.2835254966707  E_coul = 201.54873257722738
cycle= 6 E= -526.734792919443  delta_E= -6.74e-11  |g|= 1.9e-06  |ddm|= 2e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2835254966707  E_coul = 201.54873257722738
  HOMO = -0.582575237358527  LUMO = 0.976800141116471
  mo_energy =
[-1.18580671e+02 -1.23092142e+01 -9.56197705e+00 -9.56197705e+00
 -9.56197705e+00 -1.26948769e+00 -5.82575237e-01 -5.82575237e-01
 -5.82575237e-01  9.76800141e-01  1.01627196e+00  1.01627196e+00
  1.01627196e+00  7.27960869e+00  7.27960869e+00  7.27960869e+00
  1.12852616e+01  3.34050964e+01  3.34050964e+01  3.34050964e+01
  1.02048205e+02  1.28961170e+02  1.28961170e+02  1.28961170e+02
  4.83291580e+02  4.83291580e+02  4.83291580e+02  5.82404730e+02
  1.33513134e+03  1.33513134e+03  1.33513134e+03  2.65098957e+03
  3.02937803e+03  3.02937803e+03  3.02937803e+03  6.64982112e+03
  6.64982112e+03  6.64982112e+03  9.05677515e+03  2.54125519e+04
  7.61551261e+04]
E1 = -728.2835243454041  E_coul = 201.54873142596028
Extra cycle  E= -526.734792919444  delta_E= -5.68e-13  |g|= 3.92e-07  |ddm|= 3.33e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103295.36451557044
E1 = -728.2835243454041  E_coul = 201.54873142596028
init E= -526.734792919444
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.582575273205128  LUMO = 0.976800189333551
  mo_energy =
[-1.18580671e+02 -1.23092143e+01 -9.56197716e+00 -9.56197716e+00
 -9.56197716e+00 -1.26948764e+00 -5.82575273e-01 -5.82575273e-01
 -5.82575273e-01  9.76800189e-01  1.01627195e+00  1.01627195e+00
  1.01627195e+00  7.27960863e+00  7.27960863e+00  7.27960863e+00
  1.12852616e+01  3.34050963e+01  3.34050963e+01  3.34050963e+01
  1.02048205e+02  1.28961170e+02  1.28961170e+02  1.28961170e+02
  4.83291579e+02  4.83291579e+02  4.83291579e+02  5.82404730e+02
  1.33513134e+03  1.33513134e+03  1.33513134e+03  2.65098957e+03
  3.02937803e+03  3.02937803e+03  3.02937803e+03  6.64982112e+03
  6.64982112e+03  6.64982112e+03  9.05677515e+03  2.54125519e+04
  7.61551261e+04]
E1 = -728.2835245345002  E_coul = 201.54873161505753
cycle= 1 E= -526.734792919443  delta_E= 1.14e-12  |g|= 8.25e-08  |ddm|= 6.53e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2835245345002  E_coul = 201.54873161505753
  HOMO = -0.582575272569472  LUMO = 0.976800205881416
  mo_energy =
[-1.18580671e+02 -1.23092143e+01 -9.56197715e+00 -9.56197715e+00
 -9.56197715e+00 -1.26948762e+00 -5.82575273e-01 -5.82575273e-01
 -5.82575273e-01  9.76800206e-01  1.01627196e+00  1.01627196e+00
  1.01627196e+00  7.27960864e+00  7.27960864e+00  7.27960864e+00
  1.12852616e+01  3.34050963e+01  3.34050963e+01  3.34050963e+01
  1.02048205e+02  1.28961170e+02  1.28961170e+02  1.28961170e+02
  4.83291580e+02  4.83291580e+02  4.83291580e+02  5.82404730e+02
  1.33513134e+03  1.33513134e+03  1.33513134e+03  2.65098957e+03
  3.02937803e+03  3.02937803e+03  3.02937803e+03  6.64982112e+03
  6.64982112e+03  6.64982112e+03  9.05677515e+03  2.54125519e+04
  7.61551261e+04]
E1 = -728.2835244538554  E_coul = 201.54873153441125
Extra cycle  E= -526.734792919444  delta_E= -1.48e-12  |g|= 1.67e-08  |ddm|= 1.38e-07
    CPU time for scf_cycle      1.24 sec, wall time      0.56 sec
exp = [2.61826559e+04 7.61752183e+03 3.61735091e+03 1.59782381e+03
 3.82852431e+02 1.08124909e+02 3.48962976e+01 7.52459115e+00
 2.99046551e+00 6.65758507e-01 2.39746676e-01 1.36278322e+03
 6.64745545e+02 3.00961349e+02 3.14041720e+02 6.16230920e+01
 7.33196512e+00 2.02367022e+01 7.74276912e-01 2.81251964e+00
 2.23437135e-01]
grad_E = [-1.51764899e-06  3.31239540e-06 -1.57678026e-06  6.95110038e-05
 -4.04566264e-05 -1.58407765e-04 -3.64456828e-03 -4.43795597e-03
  3.90631760e-03  1.82010845e-04  2.36801345e-03 -5.05456054e-07
  5.02595106e-06  2.37271745e-05  2.04573398e-05 -2.76768604e-05
 -1.13365790e-04  7.68704196e-05 -9.18665186e-03  2.40626450e-04
  2.97798268e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559263        1
[INPUT] 0    0    [1    /1   ]  7617.52176029        1
[INPUT] 0    0    [1    /1   ]  3617.35094108        1
[INPUT] 0    0    [1    /1   ]  1597.82242724        1
[INPUT] 0    0    [1    /1   ]  382.853461094        1
[INPUT] 0    0    [1    /1   ]  108.126236358        1
[INPUT] 0    0    [1    /1   ]  34.9708460495        1
[INPUT] 0    0    [1    /1   ]  7.58307463261        1
[INPUT] 0    0    [1    /1   ]  3.00893097679        1
[INPUT] 0    0    [1    /1   ]  0.701854834188       1
[INPUT] 0    0    [1    /1   ]  0.250554786074       1
[INPUT] 1    0    [1    /1   ]  1362.7832299         1
[INPUT] 1    0    [1    /1   ]  664.745445544        1
[INPUT] 1    0    [1    /1   ]  300.960879749        1
[INPUT] 1    0    [1    /1   ]  314.041315401        1
[INPUT] 1    0    [1    /1   ]  61.6236829261        1
[INPUT] 1    0    [1    /1   ]  7.33366457033        1
[INPUT] 1    0    [1    /1   ]  20.2351235786        1
[INPUT] 1    0    [1    /1   ]  0.774880219633       1
[INPUT] 1    0    [1    /1   ]  2.81525096066        1
[INPUT] 1    0    [1    /1   ]  0.223683464703       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65592629683, 1.0]], [0, [7617.521760293929, 1.0]], [0, [3617.3509410785077, 1.0]], [0, [1597.8224272374116, 1.0]], [0, [382.85346109438035, 1.0]], [0, [108.1262363579291, 1.0]], [0, [34.97084604948114, 1.0]], [0, [7.583074632613726, 1.0]], [0, [3.0089309767898484, 1.0]], [0, [0.7018548341878459, 1.0]], [0, [0.2505547860741277, 1.0]], [1, [1362.7832299032011, 1.0]], [1, [664.745445543883, 1.0]], [1, [300.9608797490148, 1.0]], [1, [314.04131540060837, 1.0]], [1, [61.62368292608841, 1.0]], [1, [7.333664570330062, 1.0]], [1, [20.235123578557957, 1.0]], [1, [0.7748802196329212, 1.0]], [1, [2.815250960655649, 1.0]], [1, [0.22368346470265754, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6559263]
bas 1, expnt(s) = [7617.52176029]
bas 2, expnt(s) = [3617.35094108]
bas 3, expnt(s) = [1597.82242724]
bas 4, expnt(s) = [382.85346109]
bas 5, expnt(s) = [108.12623636]
bas 6, expnt(s) = [34.97084605]
bas 7, expnt(s) = [7.58307463]
bas 8, expnt(s) = [3.00893098]
bas 9, expnt(s) = [0.70185483]
bas 10, expnt(s) = [0.25055479]
bas 11, expnt(s) = [1362.7832299]
bas 12, expnt(s) = [664.74544554]
bas 13, expnt(s) = [300.96087975]
bas 14, expnt(s) = [314.0413154]
bas 15, expnt(s) = [61.62368293]
bas 16, expnt(s) = [7.33366457]
bas 17, expnt(s) = [20.23512358]
bas 18, expnt(s) = [0.77488022]
bas 19, expnt(s) = [2.81525096]
bas 20, expnt(s) = [0.22368346]
CPU time:        73.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752176e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782243e+03 6.38500746e+02
 3.82853461e+02 2.18670127e+02 1.08126236e+02 8.47155898e+01
 3.49708460e+01 3.63324453e+01 7.58307463e+00 1.15451352e+01
 3.00893098e+00 5.77197170e+00 7.01854834e-01 1.93731614e+00
 2.50554786e-01 8.94730107e-01 1.36278323e+03 2.41556022e+04
 6.64745446e+02 9.84699247e+03 3.00960880e+02 3.65697467e+03
 3.14041315e+02 3.85671793e+03 6.16236829e+01 5.03696526e+02
 7.33366457e+00 3.52075411e+01 2.02351236e+01 1.25203572e+02
 7.74880220e-01 2.12093623e+00 2.81525096e+00 1.06385095e+01
 2.23683465e-01 4.48773025e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993516293583784
cond(S) = 103440.24969595701
E1 = -729.5145997957818  E_coul = 203.1733774769686
init E= -526.341222318813
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555728555613839  LUMO = 1.03611409188124
  mo_energy =
[-1.18327819e+02 -1.22048498e+01 -9.44739183e+00 -9.44739183e+00
 -9.44739183e+00 -1.23981177e+00 -5.55728556e-01 -5.55728556e-01
 -5.55728556e-01  1.03611409e+00  1.03611409e+00  1.03611409e+00
  1.07985832e+00  7.35823870e+00  7.35823870e+00  7.35823870e+00
  1.16978286e+01  3.35410476e+01  3.35410476e+01  3.35410476e+01
  1.02876819e+02  1.29156792e+02  1.29156792e+02  1.29156792e+02
  4.83553855e+02  4.83553855e+02  4.83553855e+02  5.83429038e+02
  1.33544586e+03  1.33544586e+03  1.33544586e+03  2.65209983e+03
  3.02975553e+03  3.02975553e+03  3.02975553e+03  6.65030971e+03
  6.65030971e+03  6.65030971e+03  9.05795189e+03  2.54137888e+04
  7.61564128e+04]
E1 = -727.847556529939  E_coul = 201.1132307453378
cycle= 1 E= -526.734325784601  delta_E= -0.393  |g|= 0.187  |ddm|= 0.329
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543726
diis-c [-0.29563787  1.        ]
  HOMO = -0.589925508717644  LUMO = 1.0122931658823
  mo_energy =
[-1.18637537e+02 -1.23409877e+01 -9.59477357e+00 -9.59477357e+00
 -9.59477357e+00 -1.27842227e+00 -5.89925509e-01 -5.89925509e-01
 -5.89925509e-01  1.01229317e+00  1.01229317e+00  1.01229317e+00
  1.05105117e+00  7.26854655e+00  7.26854655e+00  7.26854655e+00
  1.15936453e+01  3.33875647e+01  3.33875647e+01  3.33875647e+01
  1.02658706e+02  1.28927909e+02  1.28927909e+02  1.28927909e+02
  4.83245618e+02  4.83245618e+02  4.83245618e+02  5.83082039e+02
  1.33507993e+03  1.33507993e+03  1.33507993e+03  2.65159860e+03
  3.02932297e+03  3.02932297e+03  3.02932297e+03  6.64976328e+03
  6.64976328e+03  6.64976328e+03  9.05732978e+03  2.54130724e+04
  7.61556061e+04]
E1 = -728.4192319075917  E_coul = 201.68418545032364
cycle= 2 E= -526.735046457268  delta_E= -0.000721  |g|= 0.0377  |ddm|= 0.0529
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753319
diis-c [-0.0032395   0.08363107  0.91636893]
  HOMO = -0.580923980305882  LUMO = 1.01894582594034
  mo_energy =
[-1.18569922e+02 -1.23031585e+01 -9.55528742e+00 -9.55528742e+00
 -9.55528742e+00 -1.26763439e+00 -5.80923980e-01 -5.80923980e-01
 -5.80923980e-01  1.01894583e+00  1.01894583e+00  1.01894583e+00
  1.05941416e+00  7.29209578e+00  7.29209578e+00  7.29209578e+00
  1.16223603e+01  3.34274217e+01  3.34274217e+01  3.34274217e+01
  1.02714010e+02  1.28983658e+02  1.28983658e+02  1.28983658e+02
  4.83312416e+02  4.83312416e+02  4.83312416e+02  5.83151192e+02
  1.33515078e+03  1.33515078e+03  1.33515078e+03  2.65167276e+03
  3.02939606e+03  3.02939606e+03  3.02939606e+03  6.64983810e+03
  6.64983810e+03  6.64983810e+03  9.05740541e+03  2.54131486e+04
  7.61556826e+04]
E1 = -728.2698420961489  E_coul = 201.534737016837
cycle= 3 E= -526.735105079312  delta_E= -5.86e-05  |g|= 0.0062  |ddm|= 0.0161
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130339
diis-c [-6.71519325e-07 -1.29001623e-03  1.42734163e-01  8.58555853e-01]
  HOMO = -0.582399361998378  LUMO = 1.01788113987428
  mo_energy =
[-1.18579759e+02 -1.23088900e+01 -9.56136860e+00 -9.56136860e+00
 -9.56136860e+00 -1.26929559e+00 -5.82399362e-01 -5.82399362e-01
 -5.82399362e-01  1.01788114e+00  1.01788114e+00  1.01788114e+00
  1.05814744e+00  7.28836757e+00  7.28836757e+00  7.28836757e+00
  1.16179678e+01  3.34213264e+01  3.34213264e+01  3.34213264e+01
  1.02705885e+02  1.28975411e+02  1.28975411e+02  1.28975411e+02
  4.83302694e+02  4.83302694e+02  4.83302694e+02  5.83141119e+02
  1.33514047e+03  1.33514047e+03  1.33514047e+03  2.65166182e+03
  3.02938537e+03  3.02938537e+03  3.02938537e+03  6.64982701e+03
  6.64982701e+03  6.64982701e+03  9.05739411e+03  2.54131371e+04
  7.61556710e+04]
E1 = -728.2923213375035  E_coul = 201.5572143862873
cycle= 4 E= -526.735106951216  delta_E= -1.87e-06  |g|= 0.000103  |ddm|= 0.00222
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117235
diis-c [-4.57955837e-09  7.11231023e-05 -1.01334311e-02 -6.66829703e-02
  1.07674528e+00]
  HOMO = -0.58237867147573  LUMO = 1.01789871470019
  mo_energy =
[-1.18579713e+02 -1.23088193e+01 -9.56131199e+00 -9.56131199e+00
 -9.56131199e+00 -1.26925123e+00 -5.82378671e-01 -5.82378671e-01
 -5.82378671e-01  1.01789871e+00  1.01789871e+00  1.01789871e+00
  1.05818524e+00  7.28841368e+00  7.28841368e+00  7.28841368e+00
  1.16180315e+01  3.34213810e+01  3.34213810e+01  3.34213810e+01
  1.02705943e+02  1.28975464e+02  1.28975464e+02  1.28975464e+02
  4.83302740e+02  4.83302740e+02  4.83302740e+02  5.83141157e+02
  1.33514051e+03  1.33514051e+03  1.33514051e+03  2.65166183e+03
  3.02938540e+03  3.02938540e+03  3.02938540e+03  6.64982702e+03
  6.64982702e+03  6.64982702e+03  9.05739411e+03  2.54131371e+04
  7.61556709e+04]
E1 = -728.2920917912057  E_coul = 201.55698483816528
cycle= 5 E= -526.73510695304  delta_E= -1.82e-09  |g|= 2.16e-05  |ddm|= 0.000163
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.0991e-05
diis-c [-8.30652670e-11  1.44248137e-05 -1.79239641e-03 -1.38772373e-02
  4.67357727e-02  9.68919436e-01]
  HOMO = -0.58238642657505  LUMO = 1.0178935641504
  mo_energy =
[-1.18579746e+02 -1.23088431e+01 -9.56133771e+00 -9.56133771e+00
 -9.56133771e+00 -1.26925748e+00 -5.82386427e-01 -5.82386427e-01
 -5.82386427e-01  1.01789356e+00  1.01789356e+00  1.01789356e+00
  1.05818091e+00  7.28839628e+00  7.28839628e+00  7.28839628e+00
  1.16180129e+01  3.34213560e+01  3.34213560e+01  3.34213560e+01
  1.02705914e+02  1.28975434e+02  1.28975434e+02  1.28975434e+02
  4.83302708e+02  4.83302708e+02  4.83302708e+02  5.83141124e+02
  1.33514047e+03  1.33514047e+03  1.33514047e+03  2.65166180e+03
  3.02938536e+03  3.02938536e+03  3.02938536e+03  6.64982699e+03
  6.64982699e+03  6.64982699e+03  9.05739407e+03  2.54131370e+04
  7.61556709e+04]
E1 = -728.2921778426061  E_coul = 201.55707088950214
cycle= 6 E= -526.735106953104  delta_E= -6.34e-11  |g|= 1.85e-06  |ddm|= 1.88e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2921778426061  E_coul = 201.55707088950214
  HOMO = -0.582386461463984  LUMO = 1.01789359893633
  mo_energy =
[-1.18579745e+02 -1.23088430e+01 -9.56133771e+00 -9.56133771e+00
 -9.56133771e+00 -1.26925711e+00 -5.82386461e-01 -5.82386461e-01
 -5.82386461e-01  1.01789360e+00  1.01789360e+00  1.01789360e+00
  1.05818126e+00  7.28839629e+00  7.28839629e+00  7.28839629e+00
  1.16180131e+01  3.34213560e+01  3.34213560e+01  3.34213560e+01
  1.02705914e+02  1.28975435e+02  1.28975435e+02  1.28975435e+02
  4.83302708e+02  4.83302708e+02  4.83302708e+02  5.83141124e+02
  1.33514047e+03  1.33514047e+03  1.33514047e+03  2.65166180e+03
  3.02938536e+03  3.02938536e+03  3.02938536e+03  6.64982699e+03
  6.64982699e+03  6.64982699e+03  9.05739407e+03  2.54131370e+04
  7.61556709e+04]
E1 = -728.2921770870137  E_coul = 201.557070133911
Extra cycle  E= -526.735106953103  delta_E= 1.25e-12  |g|= 3.77e-07  |ddm|= 3.15e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826559e+04 7.61752176e+03 3.61735094e+03 1.59782243e+03
 3.82853461e+02 1.08126236e+02 3.49708460e+01 7.58307463e+00
 3.00893098e+00 7.01854834e-01 2.50554786e-01 1.36278323e+03
 6.64745446e+02 3.00960880e+02 3.14041315e+02 6.16236829e+01
 7.33366457e+00 2.02351236e+01 7.74880220e-01 2.81525096e+00
 2.23683465e-01]
E = -526.7351069531027
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559263        1
[INPUT] 0    0    [1    /1   ]  7617.52176029        1
[INPUT] 0    0    [1    /1   ]  3617.35094108        1
[INPUT] 0    0    [1    /1   ]  1597.82242724        1
[INPUT] 0    0    [1    /1   ]  382.853461094        1
[INPUT] 0    0    [1    /1   ]  108.126236358        1
[INPUT] 0    0    [1    /1   ]  34.9708460495        1
[INPUT] 0    0    [1    /1   ]  7.58307463261        1
[INPUT] 0    0    [1    /1   ]  3.00893097679        1
[INPUT] 0    0    [1    /1   ]  0.701854834188       1
[INPUT] 0    0    [1    /1   ]  0.250554786074       1
[INPUT] 1    0    [1    /1   ]  1362.7832299         1
[INPUT] 1    0    [1    /1   ]  664.745445544        1
[INPUT] 1    0    [1    /1   ]  300.960879749        1
[INPUT] 1    0    [1    /1   ]  314.041315401        1
[INPUT] 1    0    [1    /1   ]  61.6236829261        1
[INPUT] 1    0    [1    /1   ]  7.33366457033        1
[INPUT] 1    0    [1    /1   ]  20.2351235786        1
[INPUT] 1    0    [1    /1   ]  0.774880219633       1
[INPUT] 1    0    [1    /1   ]  2.81525096066        1
[INPUT] 1    0    [1    /1   ]  0.223683464703       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65592629683, 1.0]], [0, [7617.521760293929, 1.0]], [0, [3617.3509410785077, 1.0]], [0, [1597.8224272374116, 1.0]], [0, [382.85346109438035, 1.0]], [0, [108.1262363579291, 1.0]], [0, [34.97084604948114, 1.0]], [0, [7.583074632613726, 1.0]], [0, [3.0089309767898484, 1.0]], [0, [0.7018548341878459, 1.0]], [0, [0.2505547860741277, 1.0]], [1, [1362.7832299032011, 1.0]], [1, [664.745445543883, 1.0]], [1, [300.9608797490148, 1.0]], [1, [314.04131540060837, 1.0]], [1, [61.62368292608841, 1.0]], [1, [7.333664570330062, 1.0]], [1, [20.235123578557957, 1.0]], [1, [0.7748802196329212, 1.0]], [1, [2.815250960655649, 1.0]], [1, [0.22368346470265754, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6559263]
bas 1, expnt(s) = [7617.52176029]
bas 2, expnt(s) = [3617.35094108]
bas 3, expnt(s) = [1597.82242724]
bas 4, expnt(s) = [382.85346109]
bas 5, expnt(s) = [108.12623636]
bas 6, expnt(s) = [34.97084605]
bas 7, expnt(s) = [7.58307463]
bas 8, expnt(s) = [3.00893098]
bas 9, expnt(s) = [0.70185483]
bas 10, expnt(s) = [0.25055479]
bas 11, expnt(s) = [1362.7832299]
bas 12, expnt(s) = [664.74544554]
bas 13, expnt(s) = [300.96087975]
bas 14, expnt(s) = [314.0413154]
bas 15, expnt(s) = [61.62368293]
bas 16, expnt(s) = [7.33366457]
bas 17, expnt(s) = [20.23512358]
bas 18, expnt(s) = [0.77488022]
bas 19, expnt(s) = [2.81525096]
bas 20, expnt(s) = [0.22368346]
CPU time:        74.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826559e+04 5.20026288e+03 7.61752176e+03 2.06003833e+03
 3.61735094e+03 1.17844144e+03 1.59782243e+03 6.38500746e+02
 3.82853461e+02 2.18670127e+02 1.08126236e+02 8.47155898e+01
 3.49708460e+01 3.63324453e+01 7.58307463e+00 1.15451352e+01
 3.00893098e+00 5.77197170e+00 7.01854834e-01 1.93731614e+00
 2.50554786e-01 8.94730107e-01 1.36278323e+03 2.41556022e+04
 6.64745446e+02 9.84699247e+03 3.00960880e+02 3.65697467e+03
 3.14041315e+02 3.85671793e+03 6.16236829e+01 5.03696526e+02
 7.33366457e+00 3.52075411e+01 2.02351236e+01 1.25203572e+02
 7.74880220e-01 2.12093623e+00 2.81525096e+00 1.06385095e+01
 2.23683465e-01 4.48773025e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993516293583784
cond(S) = 103440.24969595701
E1 = -729.5145997957818  E_coul = 203.1733774769686
init E= -526.341222318813
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555728555613839  LUMO = 1.03611409188124
  mo_energy =
[-1.18327819e+02 -1.22048498e+01 -9.44739183e+00 -9.44739183e+00
 -9.44739183e+00 -1.23981177e+00 -5.55728556e-01 -5.55728556e-01
 -5.55728556e-01  1.03611409e+00  1.03611409e+00  1.03611409e+00
  1.07985832e+00  7.35823870e+00  7.35823870e+00  7.35823870e+00
  1.16978286e+01  3.35410476e+01  3.35410476e+01  3.35410476e+01
  1.02876819e+02  1.29156792e+02  1.29156792e+02  1.29156792e+02
  4.83553855e+02  4.83553855e+02  4.83553855e+02  5.83429038e+02
  1.33544586e+03  1.33544586e+03  1.33544586e+03  2.65209983e+03
  3.02975553e+03  3.02975553e+03  3.02975553e+03  6.65030971e+03
  6.65030971e+03  6.65030971e+03  9.05795189e+03  2.54137888e+04
  7.61564128e+04]
E1 = -727.847556529939  E_coul = 201.1132307453378
cycle= 1 E= -526.734325784601  delta_E= -0.393  |g|= 0.187  |ddm|= 0.329
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543726
diis-c [-0.29563787  1.        ]
  HOMO = -0.589925508717644  LUMO = 1.0122931658823
  mo_energy =
[-1.18637537e+02 -1.23409877e+01 -9.59477357e+00 -9.59477357e+00
 -9.59477357e+00 -1.27842227e+00 -5.89925509e-01 -5.89925509e-01
 -5.89925509e-01  1.01229317e+00  1.01229317e+00  1.01229317e+00
  1.05105117e+00  7.26854655e+00  7.26854655e+00  7.26854655e+00
  1.15936453e+01  3.33875647e+01  3.33875647e+01  3.33875647e+01
  1.02658706e+02  1.28927909e+02  1.28927909e+02  1.28927909e+02
  4.83245618e+02  4.83245618e+02  4.83245618e+02  5.83082039e+02
  1.33507993e+03  1.33507993e+03  1.33507993e+03  2.65159860e+03
  3.02932297e+03  3.02932297e+03  3.02932297e+03  6.64976328e+03
  6.64976328e+03  6.64976328e+03  9.05732978e+03  2.54130724e+04
  7.61556061e+04]
E1 = -728.4192319075917  E_coul = 201.68418545032364
cycle= 2 E= -526.735046457268  delta_E= -0.000721  |g|= 0.0377  |ddm|= 0.0529
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753319
diis-c [-0.0032395   0.08363107  0.91636893]
  HOMO = -0.580923980305882  LUMO = 1.01894582594034
  mo_energy =
[-1.18569922e+02 -1.23031585e+01 -9.55528742e+00 -9.55528742e+00
 -9.55528742e+00 -1.26763439e+00 -5.80923980e-01 -5.80923980e-01
 -5.80923980e-01  1.01894583e+00  1.01894583e+00  1.01894583e+00
  1.05941416e+00  7.29209578e+00  7.29209578e+00  7.29209578e+00
  1.16223603e+01  3.34274217e+01  3.34274217e+01  3.34274217e+01
  1.02714010e+02  1.28983658e+02  1.28983658e+02  1.28983658e+02
  4.83312416e+02  4.83312416e+02  4.83312416e+02  5.83151192e+02
  1.33515078e+03  1.33515078e+03  1.33515078e+03  2.65167276e+03
  3.02939606e+03  3.02939606e+03  3.02939606e+03  6.64983810e+03
  6.64983810e+03  6.64983810e+03  9.05740541e+03  2.54131486e+04
  7.61556826e+04]
E1 = -728.2698420961489  E_coul = 201.534737016837
cycle= 3 E= -526.735105079312  delta_E= -5.86e-05  |g|= 0.0062  |ddm|= 0.0161
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130339
diis-c [-6.71519325e-07 -1.29001623e-03  1.42734163e-01  8.58555853e-01]
  HOMO = -0.582399361998378  LUMO = 1.01788113987428
  mo_energy =
[-1.18579759e+02 -1.23088900e+01 -9.56136860e+00 -9.56136860e+00
 -9.56136860e+00 -1.26929559e+00 -5.82399362e-01 -5.82399362e-01
 -5.82399362e-01  1.01788114e+00  1.01788114e+00  1.01788114e+00
  1.05814744e+00  7.28836757e+00  7.28836757e+00  7.28836757e+00
  1.16179678e+01  3.34213264e+01  3.34213264e+01  3.34213264e+01
  1.02705885e+02  1.28975411e+02  1.28975411e+02  1.28975411e+02
  4.83302694e+02  4.83302694e+02  4.83302694e+02  5.83141119e+02
  1.33514047e+03  1.33514047e+03  1.33514047e+03  2.65166182e+03
  3.02938537e+03  3.02938537e+03  3.02938537e+03  6.64982701e+03
  6.64982701e+03  6.64982701e+03  9.05739411e+03  2.54131371e+04
  7.61556710e+04]
E1 = -728.2923213375035  E_coul = 201.5572143862873
cycle= 4 E= -526.735106951216  delta_E= -1.87e-06  |g|= 0.000103  |ddm|= 0.00222
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117235
diis-c [-4.57955837e-09  7.11231023e-05 -1.01334311e-02 -6.66829703e-02
  1.07674528e+00]
  HOMO = -0.58237867147573  LUMO = 1.01789871470019
  mo_energy =
[-1.18579713e+02 -1.23088193e+01 -9.56131199e+00 -9.56131199e+00
 -9.56131199e+00 -1.26925123e+00 -5.82378671e-01 -5.82378671e-01
 -5.82378671e-01  1.01789871e+00  1.01789871e+00  1.01789871e+00
  1.05818524e+00  7.28841368e+00  7.28841368e+00  7.28841368e+00
  1.16180315e+01  3.34213810e+01  3.34213810e+01  3.34213810e+01
  1.02705943e+02  1.28975464e+02  1.28975464e+02  1.28975464e+02
  4.83302740e+02  4.83302740e+02  4.83302740e+02  5.83141157e+02
  1.33514051e+03  1.33514051e+03  1.33514051e+03  2.65166183e+03
  3.02938540e+03  3.02938540e+03  3.02938540e+03  6.64982702e+03
  6.64982702e+03  6.64982702e+03  9.05739411e+03  2.54131371e+04
  7.61556709e+04]
E1 = -728.2920917912057  E_coul = 201.55698483816528
cycle= 5 E= -526.73510695304  delta_E= -1.82e-09  |g|= 2.16e-05  |ddm|= 0.000163
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.0991e-05
diis-c [-8.30652670e-11  1.44248137e-05 -1.79239641e-03 -1.38772373e-02
  4.67357727e-02  9.68919436e-01]
  HOMO = -0.58238642657505  LUMO = 1.0178935641504
  mo_energy =
[-1.18579746e+02 -1.23088431e+01 -9.56133771e+00 -9.56133771e+00
 -9.56133771e+00 -1.26925748e+00 -5.82386427e-01 -5.82386427e-01
 -5.82386427e-01  1.01789356e+00  1.01789356e+00  1.01789356e+00
  1.05818091e+00  7.28839628e+00  7.28839628e+00  7.28839628e+00
  1.16180129e+01  3.34213560e+01  3.34213560e+01  3.34213560e+01
  1.02705914e+02  1.28975434e+02  1.28975434e+02  1.28975434e+02
  4.83302708e+02  4.83302708e+02  4.83302708e+02  5.83141124e+02
  1.33514047e+03  1.33514047e+03  1.33514047e+03  2.65166180e+03
  3.02938536e+03  3.02938536e+03  3.02938536e+03  6.64982699e+03
  6.64982699e+03  6.64982699e+03  9.05739407e+03  2.54131370e+04
  7.61556709e+04]
E1 = -728.2921778426061  E_coul = 201.55707088950214
cycle= 6 E= -526.735106953104  delta_E= -6.34e-11  |g|= 1.85e-06  |ddm|= 1.88e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2921778426061  E_coul = 201.55707088950214
  HOMO = -0.582386461463984  LUMO = 1.01789359893633
  mo_energy =
[-1.18579745e+02 -1.23088430e+01 -9.56133771e+00 -9.56133771e+00
 -9.56133771e+00 -1.26925711e+00 -5.82386461e-01 -5.82386461e-01
 -5.82386461e-01  1.01789360e+00  1.01789360e+00  1.01789360e+00
  1.05818126e+00  7.28839629e+00  7.28839629e+00  7.28839629e+00
  1.16180131e+01  3.34213560e+01  3.34213560e+01  3.34213560e+01
  1.02705914e+02  1.28975435e+02  1.28975435e+02  1.28975435e+02
  4.83302708e+02  4.83302708e+02  4.83302708e+02  5.83141124e+02
  1.33514047e+03  1.33514047e+03  1.33514047e+03  2.65166180e+03
  3.02938536e+03  3.02938536e+03  3.02938536e+03  6.64982699e+03
  6.64982699e+03  6.64982699e+03  9.05739407e+03  2.54131370e+04
  7.61556709e+04]
E1 = -728.2921770870137  E_coul = 201.557070133911
Extra cycle  E= -526.735106953103  delta_E= 1.25e-12  |g|= 3.77e-07  |ddm|= 3.15e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103440.24969595701
E1 = -728.2921770870137  E_coul = 201.557070133911
init E= -526.735106953103
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.582386487212547  LUMO = 1.01789359293468
  mo_energy =
[-1.18579746e+02 -1.23088430e+01 -9.56133779e+00 -9.56133779e+00
 -9.56133779e+00 -1.26925705e+00 -5.82386487e-01 -5.82386487e-01
 -5.82386487e-01  1.01789359e+00  1.01789359e+00  1.01789359e+00
  1.05818132e+00  7.28839625e+00  7.28839625e+00  7.28839625e+00
  1.16180131e+01  3.34213560e+01  3.34213560e+01  3.34213560e+01
  1.02705914e+02  1.28975434e+02  1.28975434e+02  1.28975434e+02
  4.83302708e+02  4.83302708e+02  4.83302708e+02  5.83141124e+02
  1.33514047e+03  1.33514047e+03  1.33514047e+03  2.65166180e+03
  3.02938536e+03  3.02938536e+03  3.02938536e+03  6.64982699e+03
  6.64982699e+03  6.64982699e+03  9.05739407e+03  2.54131370e+04
  7.61556709e+04]
E1 = -728.2921771982489  E_coul = 201.5570702451455
cycle= 1 E= -526.735106953103  delta_E= -6.82e-13  |g|= 7.77e-08  |ddm|= 6.18e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2921771982489  E_coul = 201.5570702451455
  HOMO = -0.582386487492547  LUMO = 1.01789359527982
  mo_energy =
[-1.18579746e+02 -1.23088430e+01 -9.56133778e+00 -9.56133778e+00
 -9.56133778e+00 -1.26925704e+00 -5.82386487e-01 -5.82386487e-01
 -5.82386487e-01  1.01789360e+00  1.01789360e+00  1.01789360e+00
  1.05818133e+00  7.28839625e+00  7.28839625e+00  7.28839625e+00
  1.16180131e+01  3.34213560e+01  3.34213560e+01  3.34213560e+01
  1.02705914e+02  1.28975434e+02  1.28975434e+02  1.28975434e+02
  4.83302708e+02  4.83302708e+02  4.83302708e+02  5.83141124e+02
  1.33514047e+03  1.33514047e+03  1.33514047e+03  2.65166180e+03
  3.02938536e+03  3.02938536e+03  3.02938536e+03  6.64982699e+03
  6.64982699e+03  6.64982699e+03  9.05739407e+03  2.54131370e+04
  7.61556709e+04]
E1 = -728.2921771463792  E_coul = 201.5570701932762
Extra cycle  E= -526.735106953103  delta_E= 3.41e-13  |g|= 1.55e-08  |ddm|= 1.27e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826559e+04 7.61752176e+03 3.61735094e+03 1.59782243e+03
 3.82853461e+02 1.08126236e+02 3.49708460e+01 7.58307463e+00
 3.00893098e+00 7.01854834e-01 2.50554786e-01 1.36278323e+03
 6.64745446e+02 3.00960880e+02 3.14041315e+02 6.16236829e+01
 7.33366457e+00 2.02351236e+01 7.74880220e-01 2.81525096e+00
 2.23683465e-01]
grad_E = [-1.51629197e-06  3.29680699e-06 -1.58552721e-06  6.88943578e-05
 -2.02082476e-05 -3.40289719e-04 -3.19516357e-03 -3.71280140e-03
  3.12290955e-03  4.66656207e-03  1.24401813e-03 -5.05826115e-07
  5.02057468e-06  2.36954494e-05  2.04299960e-05 -2.50461113e-05
 -2.22562151e-04  7.36291051e-05 -9.33335191e-03  5.15515342e-04
  3.07342523e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559588        1
[INPUT] 0    0    [1    /1   ]  7617.52168914        1
[INPUT] 0    0    [1    /1   ]  3617.3509748         1
[INPUT] 0    0    [1    /1   ]  1597.82093109        1
[INPUT] 0    0    [1    /1   ]  382.854532989        1
[INPUT] 0    0    [1    /1   ]  108.128056471        1
[INPUT] 0    0    [1    /1   ]  35.0510491127        1
[INPUT] 0    0    [1    /1   ]  7.6501217483         1
[INPUT] 0    0    [1    /1   ]  3.01632847204        1
[INPUT] 0    0    [1    /1   ]  0.733729443753       1
[INPUT] 0    0    [1    /1   ]  0.257668638334       1
[INPUT] 1    0    [1    /1   ]  1362.78324073        1
[INPUT] 1    0    [1    /1   ]  664.745337756        1
[INPUT] 1    0    [1    /1   ]  300.960370814        1
[INPUT] 1    0    [1    /1   ]  314.040876605        1
[INPUT] 1    0    [1    /1   ]  61.6243172649        1
[INPUT] 1    0    [1    /1   ]  7.3358652044         1
[INPUT] 1    0    [1    /1   ]  20.2334114338        1
[INPUT] 1    0    [1    /1   ]  0.775866683067       1
[INPUT] 1    0    [1    /1   ]  2.81738475732        1
[INPUT] 1    0    [1    /1   ]  0.223482683044       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65595883949, 1.0]], [0, [7617.521689138774, 1.0]], [0, [3617.3509747953563, 1.0]], [0, [1597.820931090912, 1.0]], [0, [382.8545329887476, 1.0]], [0, [108.12805647088831, 1.0]], [0, [35.05104911271949, 1.0]], [0, [7.650121748297547, 1.0]], [0, [3.0163284720392483, 1.0]], [0, [0.733729443752887, 1.0]], [0, [0.25766863833449044, 1.0]], [1, [1362.783240733731, 1.0]], [1, [664.7453377563203, 1.0]], [1, [300.9603708140251, 1.0]], [1, [314.0408766048819, 1.0]], [1, [61.624317264860416, 1.0]], [1, [7.335865204400402, 1.0]], [1, [20.2334114338188, 1.0]], [1, [0.7758666830666404, 1.0]], [1, [2.8173847573201485, 1.0]], [1, [0.223482683043525, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65595884]
bas 1, expnt(s) = [7617.52168914]
bas 2, expnt(s) = [3617.3509748]
bas 3, expnt(s) = [1597.82093109]
bas 4, expnt(s) = [382.85453299]
bas 5, expnt(s) = [108.12805647]
bas 6, expnt(s) = [35.05104911]
bas 7, expnt(s) = [7.65012175]
bas 8, expnt(s) = [3.01632847]
bas 9, expnt(s) = [0.73372944]
bas 10, expnt(s) = [0.25766864]
bas 11, expnt(s) = [1362.78324073]
bas 12, expnt(s) = [664.74533776]
bas 13, expnt(s) = [300.96037081]
bas 14, expnt(s) = [314.0408766]
bas 15, expnt(s) = [61.62431726]
bas 16, expnt(s) = [7.3358652]
bas 17, expnt(s) = [20.23341143]
bas 18, expnt(s) = [0.77586668]
bas 19, expnt(s) = [2.81738476]
bas 20, expnt(s) = [0.22348268]
CPU time:        79.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026288e+03 7.61752169e+03 2.06003832e+03
 3.61735097e+03 1.17844145e+03 1.59782093e+03 6.38500297e+02
 3.82854533e+02 2.18670586e+02 1.08128056e+02 8.47166594e+01
 3.50510491e+01 3.63949218e+01 7.65012175e+00 1.16216097e+01
 3.01632847e+00 5.78261128e+00 7.33729444e-01 2.00293559e+00
 2.57668638e-01 9.13715929e-01 1.36278324e+03 2.41556024e+04
 6.64745338e+02 9.84699047e+03 3.00960371e+02 3.65696694e+03
 3.14040877e+02 3.85671120e+03 6.16243173e+01 5.03703007e+02
 7.33586520e+00 3.52207477e+01 2.02334114e+01 1.25190330e+02
 7.75866683e-01 2.12431185e+00 2.81738476e+00 1.06485897e+01
 2.23482683e-01 4.48269549e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99343143923816
cond(S) = 103558.9588606999
E1 = -729.518058579827  E_coul = 203.17531781988805
init E= -526.342740759939
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555747263605985  LUMO = 1.03614728676224
  mo_energy =
[-1.18327620e+02 -1.22048901e+01 -9.44718975e+00 -9.44718975e+00
 -9.44718975e+00 -1.23967210e+00 -5.55747264e-01 -5.55747264e-01
 -5.55747264e-01  1.03614729e+00  1.03614729e+00  1.03614729e+00
  1.14501216e+00  7.36560434e+00  7.36560434e+00  7.36560434e+00
  1.19718472e+01  3.35558784e+01  3.35558784e+01  3.35558784e+01
  1.03497801e+02  1.29169950e+02  1.29169950e+02  1.29169950e+02
  4.83563970e+02  4.83563970e+02  4.83563970e+02  5.84152674e+02
  1.33545377e+03  1.33545377e+03  1.33545377e+03  2.65276554e+03
  3.02976154e+03  3.02976154e+03  3.02976154e+03  6.65031414e+03
  6.65031414e+03  6.65031414e+03  9.05856539e+03  2.54143688e+04
  7.61569527e+04]
E1 = -727.8441002330974  E_coul = 201.10954630550253
cycle= 1 E= -526.734553927595  delta_E= -0.392  |g|= 0.187  |ddm|= 0.327
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543297
diis-c [-0.2951718  1.       ]
  HOMO = -0.590167930894028  LUMO = 1.01216272894721
  mo_energy =
[-1.18637412e+02 -1.23414537e+01 -9.59501545e+00 -9.59501545e+00
 -9.59501545e+00 -1.27858644e+00 -5.90167931e-01 -5.90167931e-01
 -5.90167931e-01  1.01216273e+00  1.01216273e+00  1.01216273e+00
  1.11460800e+00  7.27541483e+00  7.27541483e+00  7.27541483e+00
  1.18665779e+01  3.34020447e+01  3.34020447e+01  3.34020447e+01
  1.03279158e+02  1.28940818e+02  1.28940818e+02  1.28940818e+02
  4.83255623e+02  4.83255623e+02  4.83255623e+02  5.83805745e+02
  1.33508794e+03  1.33508794e+03  1.33508794e+03  2.65226450e+03
  3.02932912e+03  3.02932912e+03  3.02932912e+03  6.64976793e+03
  6.64976793e+03  6.64976793e+03  9.05794355e+03  2.54136527e+04
  7.61561463e+04]
E1 = -728.4176403261179  E_coul = 201.6823626335123
cycle= 2 E= -526.735277692606  delta_E= -0.000724  |g|= 0.0378  |ddm|= 0.0531
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755026
diis-c [-0.00325888  0.08379506  0.91620494]
  HOMO = -0.581135386466507  LUMO = 1.01884309213996
  mo_energy =
[-1.18569656e+02 -1.23034946e+01 -9.55539649e+00 -9.55539649e+00
 -9.55539649e+00 -1.26775568e+00 -5.81135386e-01 -5.81135386e-01
 -5.81135386e-01  1.01884309e+00  1.01884309e+00  1.01884309e+00
  1.12336624e+00  7.29906270e+00  7.29906270e+00  7.29906270e+00
  1.18955340e+01  3.34420281e+01  3.34420281e+01  3.34420281e+01
  1.03334611e+02  1.28996704e+02  1.28996704e+02  1.28996704e+02
  4.83322562e+02  4.83322562e+02  4.83322562e+02  5.83875037e+02
  1.33515894e+03  1.33515894e+03  1.33515894e+03  2.65233881e+03
  3.02940236e+03  3.02940236e+03  3.02940236e+03  6.64984290e+03
  6.64984290e+03  6.64984290e+03  9.05801934e+03  2.54137290e+04
  7.61562230e+04]
E1 = -728.2675420064478  E_coul = 201.53220517742122
cycle= 3 E= -526.735336829027  delta_E= -5.91e-05  |g|= 0.00623  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130865
diis-c [-6.74159611e-07 -1.29122768e-03  1.42976934e-01  8.58314294e-01]
  HOMO = -0.582616203944361  LUMO = 1.01777339164907
  mo_energy =
[-1.18579529e+02 -1.23092496e+01 -9.56150270e+00 -9.56150270e+00
 -9.56150270e+00 -1.26942546e+00 -5.82616204e-01 -5.82616204e-01
 -5.82616204e-01  1.01777339e+00  1.01777339e+00  1.01777339e+00
  1.12203669e+00  7.29531618e+00  7.29531618e+00  7.29531618e+00
  1.18910997e+01  3.34359080e+01  3.34359080e+01  3.34359080e+01
  1.03326450e+02  1.28988425e+02  1.28988425e+02  1.28988425e+02
  4.83312804e+02  4.83312804e+02  4.83312804e+02  5.83864928e+02
  1.33514859e+03  1.33514859e+03  1.33514859e+03  2.65232783e+03
  3.02939163e+03  3.02939163e+03  3.02939163e+03  6.64983178e+03
  6.64983178e+03  6.64983178e+03  9.05800800e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.2901640136598  E_coul = 201.55482529038315
cycle= 4 E= -526.735338723277  delta_E= -1.89e-06  |g|= 0.000102  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116877
diis-c [-4.55094866e-09  7.04059609e-05 -1.00514687e-02 -6.60418755e-02
  1.07602294e+00]
  HOMO = -0.582595270829649  LUMO = 1.01779110176984
  mo_energy =
[-1.18579483e+02 -1.23091787e+01 -9.56144589e+00 -9.56144589e+00
 -9.56144589e+00 -1.26938123e+00 -5.82595271e-01 -5.82595271e-01
 -5.82595271e-01  1.01779110e+00  1.01779110e+00  1.01779110e+00
  1.12207565e+00  7.29536246e+00  7.29536246e+00  7.29536246e+00
  1.18911635e+01  3.34359627e+01  3.34359627e+01  3.34359627e+01
  1.03326509e+02  1.28988478e+02  1.28988478e+02  1.28988478e+02
  4.83312850e+02  4.83312850e+02  4.83312850e+02  5.83864966e+02
  1.33514863e+03  1.33514863e+03  1.33514863e+03  2.65232785e+03
  3.02939165e+03  3.02939165e+03  3.02939165e+03  6.64983179e+03
  6.64983179e+03  6.64983179e+03  9.05800800e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.2899370468879  E_coul = 201.55459832186625
cycle= 5 E= -526.735338725022  delta_E= -1.74e-09  |g|= 2.14e-05  |ddm|= 0.000159
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.08607e-05
diis-c [-7.92396788e-11  1.41778780e-05 -1.76873154e-03 -1.36969645e-02
  4.70157307e-02  9.68435787e-01]
  HOMO = -0.582602909009328  LUMO = 1.0177860196917
  mo_energy =
[-1.18579515e+02 -1.23092022e+01 -9.56147142e+00 -9.56147142e+00
 -9.56147142e+00 -1.26938744e+00 -5.82602909e-01 -5.82602909e-01
 -5.82602909e-01  1.01778602e+00  1.01778602e+00  1.01778602e+00
  1.12207114e+00  7.29534520e+00  7.29534520e+00  7.29534520e+00
  1.18911449e+01  3.34359380e+01  3.34359380e+01  3.34359380e+01
  1.03326480e+02  1.28988449e+02  1.28988449e+02  1.28988449e+02
  4.83312818e+02  4.83312818e+02  4.83312818e+02  5.83864934e+02
  1.33514860e+03  1.33514860e+03  1.33514860e+03  2.65232781e+03
  3.02939162e+03  3.02939162e+03  3.02939162e+03  6.64983175e+03
  6.64983175e+03  6.64983175e+03  9.05800796e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.2900233462266  E_coul = 201.55468462114507
cycle= 6 E= -526.735338725082  delta_E= -5.99e-11  |g|= 1.8e-06  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2900233462266  E_coul = 201.55468462114507
  HOMO = -0.582602928669691  LUMO = 1.01778606367852
  mo_energy =
[-1.18579515e+02 -1.23092021e+01 -9.56147141e+00 -9.56147141e+00
 -9.56147141e+00 -1.26938706e+00 -5.82602929e-01 -5.82602929e-01
 -5.82602929e-01  1.01778606e+00  1.01778606e+00  1.01778606e+00
  1.12207150e+00  7.29534523e+00  7.29534523e+00  7.29534523e+00
  1.18911451e+01  3.34359380e+01  3.34359380e+01  3.34359380e+01
  1.03326480e+02  1.28988449e+02  1.28988449e+02  1.28988449e+02
  4.83312819e+02  4.83312819e+02  4.83312819e+02  5.83864934e+02
  1.33514860e+03  1.33514860e+03  1.33514860e+03  2.65232781e+03
  3.02939162e+03  3.02939162e+03  3.02939162e+03  6.64983175e+03
  6.64983175e+03  6.64983175e+03  9.05800796e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.290022655283  E_coul = 201.5546839302015
Extra cycle  E= -526.735338725082  delta_E=    0  |g|= 3.65e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826560e+04 7.61752169e+03 3.61735097e+03 1.59782093e+03
 3.82854533e+02 1.08128056e+02 3.50510491e+01 7.65012175e+00
 3.01632847e+00 7.33729444e-01 2.57668638e-01 1.36278324e+03
 6.64745338e+02 3.00960371e+02 3.14040877e+02 6.16243173e+01
 7.33586520e+00 2.02334114e+01 7.75866683e-01 2.81738476e+00
 2.23482683e-01]
E = -526.7353387250815
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:09:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559588        1
[INPUT] 0    0    [1    /1   ]  7617.52168914        1
[INPUT] 0    0    [1    /1   ]  3617.3509748         1
[INPUT] 0    0    [1    /1   ]  1597.82093109        1
[INPUT] 0    0    [1    /1   ]  382.854532989        1
[INPUT] 0    0    [1    /1   ]  108.128056471        1
[INPUT] 0    0    [1    /1   ]  35.0510491127        1
[INPUT] 0    0    [1    /1   ]  7.6501217483         1
[INPUT] 0    0    [1    /1   ]  3.01632847204        1
[INPUT] 0    0    [1    /1   ]  0.733729443753       1
[INPUT] 0    0    [1    /1   ]  0.257668638334       1
[INPUT] 1    0    [1    /1   ]  1362.78324073        1
[INPUT] 1    0    [1    /1   ]  664.745337756        1
[INPUT] 1    0    [1    /1   ]  300.960370814        1
[INPUT] 1    0    [1    /1   ]  314.040876605        1
[INPUT] 1    0    [1    /1   ]  61.6243172649        1
[INPUT] 1    0    [1    /1   ]  7.3358652044         1
[INPUT] 1    0    [1    /1   ]  20.2334114338        1
[INPUT] 1    0    [1    /1   ]  0.775866683067       1
[INPUT] 1    0    [1    /1   ]  2.81738475732        1
[INPUT] 1    0    [1    /1   ]  0.223482683044       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65595883949, 1.0]], [0, [7617.521689138774, 1.0]], [0, [3617.3509747953563, 1.0]], [0, [1597.820931090912, 1.0]], [0, [382.8545329887476, 1.0]], [0, [108.12805647088831, 1.0]], [0, [35.05104911271949, 1.0]], [0, [7.650121748297547, 1.0]], [0, [3.0163284720392483, 1.0]], [0, [0.733729443752887, 1.0]], [0, [0.25766863833449044, 1.0]], [1, [1362.783240733731, 1.0]], [1, [664.7453377563203, 1.0]], [1, [300.9603708140251, 1.0]], [1, [314.0408766048819, 1.0]], [1, [61.624317264860416, 1.0]], [1, [7.335865204400402, 1.0]], [1, [20.2334114338188, 1.0]], [1, [0.7758666830666404, 1.0]], [1, [2.8173847573201485, 1.0]], [1, [0.223482683043525, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65595884]
bas 1, expnt(s) = [7617.52168914]
bas 2, expnt(s) = [3617.3509748]
bas 3, expnt(s) = [1597.82093109]
bas 4, expnt(s) = [382.85453299]
bas 5, expnt(s) = [108.12805647]
bas 6, expnt(s) = [35.05104911]
bas 7, expnt(s) = [7.65012175]
bas 8, expnt(s) = [3.01632847]
bas 9, expnt(s) = [0.73372944]
bas 10, expnt(s) = [0.25766864]
bas 11, expnt(s) = [1362.78324073]
bas 12, expnt(s) = [664.74533776]
bas 13, expnt(s) = [300.96037081]
bas 14, expnt(s) = [314.0408766]
bas 15, expnt(s) = [61.62431726]
bas 16, expnt(s) = [7.3358652]
bas 17, expnt(s) = [20.23341143]
bas 18, expnt(s) = [0.77586668]
bas 19, expnt(s) = [2.81738476]
bas 20, expnt(s) = [0.22348268]
CPU time:        80.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026288e+03 7.61752169e+03 2.06003832e+03
 3.61735097e+03 1.17844145e+03 1.59782093e+03 6.38500297e+02
 3.82854533e+02 2.18670586e+02 1.08128056e+02 8.47166594e+01
 3.50510491e+01 3.63949218e+01 7.65012175e+00 1.16216097e+01
 3.01632847e+00 5.78261128e+00 7.33729444e-01 2.00293559e+00
 2.57668638e-01 9.13715929e-01 1.36278324e+03 2.41556024e+04
 6.64745338e+02 9.84699047e+03 3.00960371e+02 3.65696694e+03
 3.14040877e+02 3.85671120e+03 6.16243173e+01 5.03703007e+02
 7.33586520e+00 3.52207477e+01 2.02334114e+01 1.25190330e+02
 7.75866683e-01 2.12431185e+00 2.81738476e+00 1.06485897e+01
 2.23482683e-01 4.48269549e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99343143923816
cond(S) = 103558.9588606999
E1 = -729.518058579827  E_coul = 203.17531781988805
init E= -526.342740759939
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555747263605985  LUMO = 1.03614728676224
  mo_energy =
[-1.18327620e+02 -1.22048901e+01 -9.44718975e+00 -9.44718975e+00
 -9.44718975e+00 -1.23967210e+00 -5.55747264e-01 -5.55747264e-01
 -5.55747264e-01  1.03614729e+00  1.03614729e+00  1.03614729e+00
  1.14501216e+00  7.36560434e+00  7.36560434e+00  7.36560434e+00
  1.19718472e+01  3.35558784e+01  3.35558784e+01  3.35558784e+01
  1.03497801e+02  1.29169950e+02  1.29169950e+02  1.29169950e+02
  4.83563970e+02  4.83563970e+02  4.83563970e+02  5.84152674e+02
  1.33545377e+03  1.33545377e+03  1.33545377e+03  2.65276554e+03
  3.02976154e+03  3.02976154e+03  3.02976154e+03  6.65031414e+03
  6.65031414e+03  6.65031414e+03  9.05856539e+03  2.54143688e+04
  7.61569527e+04]
E1 = -727.8441002330974  E_coul = 201.10954630550253
cycle= 1 E= -526.734553927595  delta_E= -0.392  |g|= 0.187  |ddm|= 0.327
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543297
diis-c [-0.2951718  1.       ]
  HOMO = -0.590167930894028  LUMO = 1.01216272894721
  mo_energy =
[-1.18637412e+02 -1.23414537e+01 -9.59501545e+00 -9.59501545e+00
 -9.59501545e+00 -1.27858644e+00 -5.90167931e-01 -5.90167931e-01
 -5.90167931e-01  1.01216273e+00  1.01216273e+00  1.01216273e+00
  1.11460800e+00  7.27541483e+00  7.27541483e+00  7.27541483e+00
  1.18665779e+01  3.34020447e+01  3.34020447e+01  3.34020447e+01
  1.03279158e+02  1.28940818e+02  1.28940818e+02  1.28940818e+02
  4.83255623e+02  4.83255623e+02  4.83255623e+02  5.83805745e+02
  1.33508794e+03  1.33508794e+03  1.33508794e+03  2.65226450e+03
  3.02932912e+03  3.02932912e+03  3.02932912e+03  6.64976793e+03
  6.64976793e+03  6.64976793e+03  9.05794355e+03  2.54136527e+04
  7.61561463e+04]
E1 = -728.4176403261179  E_coul = 201.6823626335123
cycle= 2 E= -526.735277692606  delta_E= -0.000724  |g|= 0.0378  |ddm|= 0.0531
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755026
diis-c [-0.00325888  0.08379506  0.91620494]
  HOMO = -0.581135386466507  LUMO = 1.01884309213996
  mo_energy =
[-1.18569656e+02 -1.23034946e+01 -9.55539649e+00 -9.55539649e+00
 -9.55539649e+00 -1.26775568e+00 -5.81135386e-01 -5.81135386e-01
 -5.81135386e-01  1.01884309e+00  1.01884309e+00  1.01884309e+00
  1.12336624e+00  7.29906270e+00  7.29906270e+00  7.29906270e+00
  1.18955340e+01  3.34420281e+01  3.34420281e+01  3.34420281e+01
  1.03334611e+02  1.28996704e+02  1.28996704e+02  1.28996704e+02
  4.83322562e+02  4.83322562e+02  4.83322562e+02  5.83875037e+02
  1.33515894e+03  1.33515894e+03  1.33515894e+03  2.65233881e+03
  3.02940236e+03  3.02940236e+03  3.02940236e+03  6.64984290e+03
  6.64984290e+03  6.64984290e+03  9.05801934e+03  2.54137290e+04
  7.61562230e+04]
E1 = -728.2675420064478  E_coul = 201.53220517742122
cycle= 3 E= -526.735336829027  delta_E= -5.91e-05  |g|= 0.00623  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130865
diis-c [-6.74159611e-07 -1.29122768e-03  1.42976934e-01  8.58314294e-01]
  HOMO = -0.582616203944361  LUMO = 1.01777339164907
  mo_energy =
[-1.18579529e+02 -1.23092496e+01 -9.56150270e+00 -9.56150270e+00
 -9.56150270e+00 -1.26942546e+00 -5.82616204e-01 -5.82616204e-01
 -5.82616204e-01  1.01777339e+00  1.01777339e+00  1.01777339e+00
  1.12203669e+00  7.29531618e+00  7.29531618e+00  7.29531618e+00
  1.18910997e+01  3.34359080e+01  3.34359080e+01  3.34359080e+01
  1.03326450e+02  1.28988425e+02  1.28988425e+02  1.28988425e+02
  4.83312804e+02  4.83312804e+02  4.83312804e+02  5.83864928e+02
  1.33514859e+03  1.33514859e+03  1.33514859e+03  2.65232783e+03
  3.02939163e+03  3.02939163e+03  3.02939163e+03  6.64983178e+03
  6.64983178e+03  6.64983178e+03  9.05800800e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.2901640136598  E_coul = 201.55482529038315
cycle= 4 E= -526.735338723277  delta_E= -1.89e-06  |g|= 0.000102  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116877
diis-c [-4.55094866e-09  7.04059609e-05 -1.00514687e-02 -6.60418755e-02
  1.07602294e+00]
  HOMO = -0.582595270829649  LUMO = 1.01779110176984
  mo_energy =
[-1.18579483e+02 -1.23091787e+01 -9.56144589e+00 -9.56144589e+00
 -9.56144589e+00 -1.26938123e+00 -5.82595271e-01 -5.82595271e-01
 -5.82595271e-01  1.01779110e+00  1.01779110e+00  1.01779110e+00
  1.12207565e+00  7.29536246e+00  7.29536246e+00  7.29536246e+00
  1.18911635e+01  3.34359627e+01  3.34359627e+01  3.34359627e+01
  1.03326509e+02  1.28988478e+02  1.28988478e+02  1.28988478e+02
  4.83312850e+02  4.83312850e+02  4.83312850e+02  5.83864966e+02
  1.33514863e+03  1.33514863e+03  1.33514863e+03  2.65232785e+03
  3.02939165e+03  3.02939165e+03  3.02939165e+03  6.64983179e+03
  6.64983179e+03  6.64983179e+03  9.05800800e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.2899370468879  E_coul = 201.55459832186625
cycle= 5 E= -526.735338725022  delta_E= -1.74e-09  |g|= 2.14e-05  |ddm|= 0.000159
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.08607e-05
diis-c [-7.92396788e-11  1.41778780e-05 -1.76873154e-03 -1.36969645e-02
  4.70157307e-02  9.68435787e-01]
  HOMO = -0.582602909009328  LUMO = 1.0177860196917
  mo_energy =
[-1.18579515e+02 -1.23092022e+01 -9.56147142e+00 -9.56147142e+00
 -9.56147142e+00 -1.26938744e+00 -5.82602909e-01 -5.82602909e-01
 -5.82602909e-01  1.01778602e+00  1.01778602e+00  1.01778602e+00
  1.12207114e+00  7.29534520e+00  7.29534520e+00  7.29534520e+00
  1.18911449e+01  3.34359380e+01  3.34359380e+01  3.34359380e+01
  1.03326480e+02  1.28988449e+02  1.28988449e+02  1.28988449e+02
  4.83312818e+02  4.83312818e+02  4.83312818e+02  5.83864934e+02
  1.33514860e+03  1.33514860e+03  1.33514860e+03  2.65232781e+03
  3.02939162e+03  3.02939162e+03  3.02939162e+03  6.64983175e+03
  6.64983175e+03  6.64983175e+03  9.05800796e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.2900233462266  E_coul = 201.55468462114507
cycle= 6 E= -526.735338725082  delta_E= -5.99e-11  |g|= 1.8e-06  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2900233462266  E_coul = 201.55468462114507
  HOMO = -0.582602928669691  LUMO = 1.01778606367852
  mo_energy =
[-1.18579515e+02 -1.23092021e+01 -9.56147141e+00 -9.56147141e+00
 -9.56147141e+00 -1.26938706e+00 -5.82602929e-01 -5.82602929e-01
 -5.82602929e-01  1.01778606e+00  1.01778606e+00  1.01778606e+00
  1.12207150e+00  7.29534523e+00  7.29534523e+00  7.29534523e+00
  1.18911451e+01  3.34359380e+01  3.34359380e+01  3.34359380e+01
  1.03326480e+02  1.28988449e+02  1.28988449e+02  1.28988449e+02
  4.83312819e+02  4.83312819e+02  4.83312819e+02  5.83864934e+02
  1.33514860e+03  1.33514860e+03  1.33514860e+03  2.65232781e+03
  3.02939162e+03  3.02939162e+03  3.02939162e+03  6.64983175e+03
  6.64983175e+03  6.64983175e+03  9.05800796e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.290022655283  E_coul = 201.5546839302015
Extra cycle  E= -526.735338725082  delta_E=    0  |g|= 3.65e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103558.9588606999
E1 = -728.290022655283  E_coul = 201.5546839302015
init E= -526.735338725082
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.582602951429759  LUMO = 1.01778605938555
  mo_energy =
[-1.18579515e+02 -1.23092022e+01 -9.56147148e+00 -9.56147148e+00
 -9.56147148e+00 -1.26938701e+00 -5.82602951e-01 -5.82602951e-01
 -5.82602951e-01  1.01778606e+00  1.01778606e+00  1.01778606e+00
  1.12207156e+00  7.29534519e+00  7.29534519e+00  7.29534519e+00
  1.18911451e+01  3.34359379e+01  3.34359379e+01  3.34359379e+01
  1.03326480e+02  1.28988449e+02  1.28988449e+02  1.28988449e+02
  4.83312818e+02  4.83312818e+02  4.83312818e+02  5.83864934e+02
  1.33514860e+03  1.33514860e+03  1.33514860e+03  2.65232781e+03
  3.02939162e+03  3.02939162e+03  3.02939162e+03  6.64983175e+03
  6.64983175e+03  6.64983175e+03  9.05800796e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.29002277297  E_coul = 201.554684047887
cycle= 1 E= -526.735338725083  delta_E= -1.48e-12  |g|= 7.47e-08  |ddm|= 5.9e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.29002277297  E_coul = 201.554684047887
  HOMO = -0.582602951187785  LUMO = 1.0177860619967
  mo_energy =
[-1.18579515e+02 -1.23092021e+01 -9.56147147e+00 -9.56147147e+00
 -9.56147147e+00 -1.26938700e+00 -5.82602951e-01 -5.82602951e-01
 -5.82602951e-01  1.01778606e+00  1.01778606e+00  1.01778606e+00
  1.12207157e+00  7.29534519e+00  7.29534519e+00  7.29534519e+00
  1.18911451e+01  3.34359379e+01  3.34359379e+01  3.34359379e+01
  1.03326480e+02  1.28988449e+02  1.28988449e+02  1.28988449e+02
  4.83312818e+02  4.83312818e+02  4.83312818e+02  5.83864934e+02
  1.33514860e+03  1.33514860e+03  1.33514860e+03  2.65232781e+03
  3.02939162e+03  3.02939162e+03  3.02939162e+03  6.64983175e+03
  6.64983175e+03  6.64983175e+03  9.05800796e+03  2.54137175e+04
  7.61562113e+04]
E1 = -728.2900227242123  E_coul = 201.55468399912988
Extra cycle  E= -526.735338725082  delta_E= 5.68e-13  |g|= 1.48e-08  |ddm|= 1.21e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61826560e+04 7.61752169e+03 3.61735097e+03 1.59782093e+03
 3.82854533e+02 1.08128056e+02 3.50510491e+01 7.65012175e+00
 3.01632847e+00 7.33729444e-01 2.57668638e-01 1.36278324e+03
 6.64745338e+02 3.00960371e+02 3.14040877e+02 6.16243173e+01
 7.33586520e+00 2.02334114e+01 7.75866683e-01 2.81738476e+00
 2.23482683e-01]
grad_E = [-1.51476995e-06  3.27931321e-06 -1.59532617e-06  6.82017104e-05
  2.64103164e-06 -5.48764156e-04 -2.64949495e-03 -2.40166085e-03
  7.96798828e-04  8.51839798e-03 -3.53586683e-03 -5.06511461e-07
  5.01136130e-06  2.36403104e-05  2.03824936e-05 -1.97472459e-05
 -2.62253187e-04  4.46097691e-05 -5.36944780e-03  5.92767251e-04
  1.80674140e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.655979         1
[INPUT] 0    0    [1    /1   ]  7617.52164519        1
[INPUT] 0    0    [1    /1   ]  3617.35099567        1
[INPUT] 0    0    [1    /1   ]  1597.82000808        1
[INPUT] 0    0    [1    /1   ]  382.855127121        1
[INPUT] 0    0    [1    /1   ]  108.12977818         1
[INPUT] 0    0    [1    /1   ]  35.0992956331        1
[INPUT] 0    0    [1    /1   ]  7.69195412072        1
[INPUT] 0    0    [1    /1   ]  3.01588206432        1
[INPUT] 0    0    [1    /1   ]  0.748029101354       1
[INPUT] 0    0    [1    /1   ]  0.260242079723       1
[INPUT] 1    0    [1    /1   ]  1362.78324743        1
[INPUT] 1    0    [1    /1   ]  664.745271133        1
[INPUT] 1    0    [1    /1   ]  300.960056275        1
[INPUT] 1    0    [1    /1   ]  314.040605414        1
[INPUT] 1    0    [1    /1   ]  61.6246957987        1
[INPUT] 1    0    [1    /1   ]  7.33747815795        1
[INPUT] 1    0    [1    /1   ]  20.2324038682        1
[INPUT] 1    0    [1    /1   ]  0.776570957188       1
[INPUT] 1    0    [1    /1   ]  2.81790988052        1
[INPUT] 1    0    [1    /1   ]  0.223225389343       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655978956765, 1.0]], [0, [7617.521645194657, 1.0]], [0, [3617.350995671918, 1.0]], [0, [1597.8200080776367, 1.0]], [0, [382.85512712083295, 1.0]], [0, [108.12977818017556, 1.0]], [0, [35.09929563309428, 1.0]], [0, [7.691954120718606, 1.0]], [0, [3.0158820643245177, 1.0]], [0, [0.7480291013541712, 1.0]], [0, [0.26024207972324254, 1.0]], [1, [1362.783247432298, 1.0]], [1, [664.7452711334633, 1.0]], [1, [300.9600562750068, 1.0]], [1, [314.0406054141412, 1.0]], [1, [61.62469579865912, 1.0]], [1, [7.337478157953636, 1.0]], [1, [20.232403868246376, 1.0]], [1, [0.7765709571884535, 1.0]], [1, [2.8179098805185623, 1.0]], [1, [0.2232253893425461, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65597896]
bas 1, expnt(s) = [7617.52164519]
bas 2, expnt(s) = [3617.35099567]
bas 3, expnt(s) = [1597.82000808]
bas 4, expnt(s) = [382.85512712]
bas 5, expnt(s) = [108.12977818]
bas 6, expnt(s) = [35.09929563]
bas 7, expnt(s) = [7.69195412]
bas 8, expnt(s) = [3.01588206]
bas 9, expnt(s) = [0.7480291]
bas 10, expnt(s) = [0.26024208]
bas 11, expnt(s) = [1362.78324743]
bas 12, expnt(s) = [664.74527113]
bas 13, expnt(s) = [300.96005628]
bas 14, expnt(s) = [314.04060541]
bas 15, expnt(s) = [61.6246958]
bas 16, expnt(s) = [7.33747816]
bas 17, expnt(s) = [20.23240387]
bas 18, expnt(s) = [0.77657096]
bas 19, expnt(s) = [2.81790988]
bas 20, expnt(s) = [0.22322539]
CPU time:        86.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752165e+03 2.06003831e+03
 3.61735100e+03 1.17844146e+03 1.59782001e+03 6.38500021e+02
 3.82855127e+02 2.18670841e+02 1.08129778e+02 8.47176711e+01
 3.50992956e+01 3.64324875e+01 7.69195412e+00 1.16692391e+01
 3.01588206e+00 5.78196942e+00 7.48029101e-01 2.03214126e+00
 2.60242080e-01 9.20551659e-01 1.36278325e+03 2.41556026e+04
 6.64745271e+02 9.84698924e+03 3.00960056e+02 3.65696216e+03
 3.14040605e+02 3.85670703e+03 6.16246958e+01 5.03706875e+02
 7.33747816e+00 3.52304280e+01 2.02324039e+01 1.25182537e+02
 7.76570957e-01 2.12672249e+00 2.81790988e+00 1.06510707e+01
 2.23225389e-01 4.47624531e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99340384038324
cond(S) = 103610.9237693775
E1 = -729.5200680778535  E_coul = 203.17638159771477
init E= -526.343686480139
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555774807831379  LUMO = 1.03570201559782
  mo_energy =
[-1.18327472e+02 -1.22048891e+01 -9.44706870e+00 -9.44706870e+00
 -9.44706870e+00 -1.23961868e+00 -5.55774808e-01 -5.55774808e-01
 -5.55774808e-01  1.03570202e+00  1.03570202e+00  1.03570202e+00
  1.17196035e+00  7.36869727e+00  7.36869727e+00  7.36869727e+00
  1.20939124e+01  3.35628061e+01  3.35628061e+01  3.35628061e+01
  1.03828170e+02  1.29176401e+02  1.29176401e+02  1.29176401e+02
  4.83569036e+02  4.83569036e+02  4.83569036e+02  5.84554785e+02
  1.33545764e+03  1.33545764e+03  1.33545764e+03  2.65313883e+03
  3.02976433e+03  3.02976433e+03  3.02976433e+03  6.65031603e+03
  6.65031603e+03  6.65031603e+03  9.05890986e+03  2.54146945e+04
  7.61572558e+04]
E1 = -727.837742143514  E_coul = 201.1031080170512
cycle= 1 E= -526.734634126463  delta_E= -0.391  |g|= 0.187  |ddm|= 0.323
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543192
diis-c [-0.29505781  1.        ]
  HOMO = -0.590442159949093  LUMO = 1.01153608118838
  mo_energy =
[-1.18637668e+02 -1.23420038e+01 -9.59547874e+00 -9.59547874e+00
 -9.59547874e+00 -1.27883083e+00 -5.90442160e-01 -5.90442160e-01
 -5.90442160e-01  1.01153608e+00  1.01153608e+00  1.01153608e+00
  1.14074940e+00  7.27799041e+00  7.27799041e+00  7.27799041e+00
  1.19878246e+01  3.34084555e+01  3.34084555e+01  3.34084555e+01
  1.03608839e+02  1.28946779e+02  1.28946779e+02  1.28946779e+02
  4.83260260e+02  4.83260260e+02  4.83260260e+02  5.84207544e+02
  1.33509152e+03  1.33509152e+03  1.33509152e+03  2.65263756e+03
  3.02933163e+03  3.02933163e+03  3.02933163e+03  6.64976960e+03
  6.64976960e+03  6.64976960e+03  9.05828784e+03  2.54139782e+04
  7.61564494e+04]
E1 = -728.4135448612004  E_coul = 201.6781825577333
cycle= 2 E= -526.735362303467  delta_E= -0.000728  |g|= 0.0379  |ddm|= 0.0533
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0757084
diis-c [-0.00327678  0.08401974  0.91598026]
  HOMO = -0.581369663869522  LUMO = 1.01824781920091
  mo_energy =
[-1.18569720e+02 -1.23038943e+01 -9.55570702e+00 -9.55570702e+00
 -9.55570702e+00 -1.26794928e+00 -5.81369664e-01 -5.81369664e-01
 -5.81369664e-01  1.01824782e+00  1.01824782e+00  1.01824782e+00
  1.14969656e+00  7.30174429e+00  7.30174429e+00  7.30174429e+00
  1.20169711e+01  3.34485875e+01  3.34485875e+01  3.34485875e+01
  1.03664475e+02  1.29002839e+02  1.29002839e+02  1.29002839e+02
  4.83327388e+02  4.83327388e+02  4.83327388e+02  5.84277028e+02
  1.33516271e+03  1.33516271e+03  1.33516271e+03  2.65271207e+03
  3.02940506e+03  3.02940506e+03  3.02940506e+03  6.64984477e+03
  6.64984477e+03  6.64984477e+03  9.05836382e+03  2.54140548e+04
  7.61565262e+04]
E1 = -728.2627148125675  E_coul = 201.52729282852215
cycle= 3 E= -526.735421984045  delta_E= -5.97e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131322
diis-c [-6.79603680e-07 -1.29327777e-03  1.43082840e-01  8.58210438e-01]
  HOMO = -0.582856379108328  LUMO = 1.01717332554207
  mo_energy =
[-1.18579625e+02 -1.23096701e+01 -9.56183553e+00 -9.56183553e+00
 -9.56183553e+00 -1.26962677e+00 -5.82856379e-01 -5.82856379e-01
 -5.82856379e-01  1.01717333e+00  1.01717333e+00  1.01717333e+00
  1.14833768e+00  7.29798188e+00  7.29798188e+00  7.29798188e+00
  1.20125085e+01  3.34424453e+01  3.34424453e+01  3.34424453e+01
  1.03656285e+02  1.28994532e+02  1.28994532e+02  1.28994532e+02
  4.83317599e+02  4.83317599e+02  4.83317599e+02  5.84266886e+02
  1.33515233e+03  1.33515233e+03  1.33515233e+03  2.65270106e+03
  3.02939430e+03  3.02939430e+03  3.02939430e+03  6.64983361e+03
  6.64983361e+03  6.64983361e+03  9.05835245e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.2854511038778  E_coul = 201.55002720714802
cycle= 4 E= -526.73542389673  delta_E= -1.91e-06  |g|= 0.000102  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117817
diis-c [-4.54509296e-09  7.06207135e-05 -1.00717849e-02 -6.61918072e-02
  1.07619297e+00]
  HOMO = -0.582835555602337  LUMO = 1.01719094300107
  mo_energy =
[-1.18579580e+02 -1.23095997e+01 -9.56177929e+00 -9.56177929e+00
 -9.56177929e+00 -1.26958280e+00 -5.82835556e-01 -5.82835556e-01
 -5.82835556e-01  1.01719094e+00  1.01719094e+00  1.01719094e+00
  1.14837694e+00  7.29802776e+00  7.29802776e+00  7.29802776e+00
  1.20125718e+01  3.34424994e+01  3.34424994e+01  3.34424994e+01
  1.03656342e+02  1.28994585e+02  1.28994585e+02  1.28994585e+02
  4.83317644e+02  4.83317644e+02  4.83317644e+02  5.84266924e+02
  1.33515237e+03  1.33515237e+03  1.33515237e+03  2.65270107e+03
  3.02939432e+03  3.02939432e+03  3.02939432e+03  6.64983362e+03
  6.64983362e+03  6.64983362e+03  9.05835245e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.2852272047228  E_coul = 201.5498033062759
cycle= 5 E= -526.735423898447  delta_E= -1.72e-09  |g|= 2.14e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.07748e-05
diis-c [-7.78202909e-11  1.40393748e-05 -1.75364725e-03 -1.35865821e-02
  4.71221690e-02  9.68204021e-01]
  HOMO = -0.582843149539168  LUMO = 1.01718588496524
  mo_energy =
[-1.18579612e+02 -1.23096232e+01 -9.56180475e+00 -9.56180475e+00
 -9.56180475e+00 -1.26958899e+00 -5.82843150e-01 -5.82843150e-01
 -5.82843150e-01  1.01718588e+00  1.01718588e+00  1.01718588e+00
  1.14837234e+00  7.29801057e+00  7.29801057e+00  7.29801057e+00
  1.20125533e+01  3.34424747e+01  3.34424747e+01  3.34424747e+01
  1.03656314e+02  1.28994556e+02  1.28994556e+02  1.28994556e+02
  4.83317612e+02  4.83317612e+02  4.83317612e+02  5.84266891e+02
  1.33515234e+03  1.33515234e+03  1.33515234e+03  2.65270104e+03
  3.02939429e+03  3.02939429e+03  3.02939429e+03  6.64983359e+03
  6.64983359e+03  6.64983359e+03  9.05835242e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.2853136725602  E_coul = 201.54988977405338
cycle= 6 E= -526.735423898507  delta_E= -5.98e-11  |g|= 1.79e-06  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2853136725602  E_coul = 201.54988977405338
  HOMO = -0.582843158571392  LUMO = 1.01718593586407
  mo_energy =
[-1.18579612e+02 -1.23096230e+01 -9.56180472e+00 -9.56180472e+00
 -9.56180472e+00 -1.26958861e+00 -5.82843159e-01 -5.82843159e-01
 -5.82843159e-01  1.01718594e+00  1.01718594e+00  1.01718594e+00
  1.14837271e+00  7.29801061e+00  7.29801061e+00  7.29801061e+00
  1.20125535e+01  3.34424748e+01  3.34424748e+01  3.34424748e+01
  1.03656314e+02  1.28994556e+02  1.28994556e+02  1.28994556e+02
  4.83317612e+02  4.83317612e+02  4.83317612e+02  5.84266891e+02
  1.33515234e+03  1.33515234e+03  1.33515234e+03  2.65270104e+03
  3.02939429e+03  3.02939429e+03  3.02939429e+03  6.64983359e+03
  6.64983359e+03  6.64983359e+03  9.05835242e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.285312955634  E_coul = 201.54988905712682
Extra cycle  E= -526.735423898507  delta_E= -4.55e-13  |g|= 3.6e-07  |ddm|= 2.99e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826560e+04 7.61752165e+03 3.61735100e+03 1.59782001e+03
 3.82855127e+02 1.08129778e+02 3.50992956e+01 7.69195412e+00
 3.01588206e+00 7.48029101e-01 2.60242080e-01 1.36278325e+03
 6.64745271e+02 3.00960056e+02 3.14040605e+02 6.16246958e+01
 7.33747816e+00 2.02324039e+01 7.76570957e-01 2.81790988e+00
 2.23225389e-01]
E = -526.7354238985072
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.655979         1
[INPUT] 0    0    [1    /1   ]  7617.52164519        1
[INPUT] 0    0    [1    /1   ]  3617.35099567        1
[INPUT] 0    0    [1    /1   ]  1597.82000808        1
[INPUT] 0    0    [1    /1   ]  382.855127121        1
[INPUT] 0    0    [1    /1   ]  108.12977818         1
[INPUT] 0    0    [1    /1   ]  35.0992956331        1
[INPUT] 0    0    [1    /1   ]  7.69195412072        1
[INPUT] 0    0    [1    /1   ]  3.01588206432        1
[INPUT] 0    0    [1    /1   ]  0.748029101354       1
[INPUT] 0    0    [1    /1   ]  0.260242079723       1
[INPUT] 1    0    [1    /1   ]  1362.78324743        1
[INPUT] 1    0    [1    /1   ]  664.745271133        1
[INPUT] 1    0    [1    /1   ]  300.960056275        1
[INPUT] 1    0    [1    /1   ]  314.040605414        1
[INPUT] 1    0    [1    /1   ]  61.6246957987        1
[INPUT] 1    0    [1    /1   ]  7.33747815795        1
[INPUT] 1    0    [1    /1   ]  20.2324038682        1
[INPUT] 1    0    [1    /1   ]  0.776570957188       1
[INPUT] 1    0    [1    /1   ]  2.81790988052        1
[INPUT] 1    0    [1    /1   ]  0.223225389343       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.655978956765, 1.0]], [0, [7617.521645194657, 1.0]], [0, [3617.350995671918, 1.0]], [0, [1597.8200080776367, 1.0]], [0, [382.85512712083295, 1.0]], [0, [108.12977818017556, 1.0]], [0, [35.09929563309428, 1.0]], [0, [7.691954120718606, 1.0]], [0, [3.0158820643245177, 1.0]], [0, [0.7480291013541712, 1.0]], [0, [0.26024207972324254, 1.0]], [1, [1362.783247432298, 1.0]], [1, [664.7452711334633, 1.0]], [1, [300.9600562750068, 1.0]], [1, [314.0406054141412, 1.0]], [1, [61.62469579865912, 1.0]], [1, [7.337478157953636, 1.0]], [1, [20.232403868246376, 1.0]], [1, [0.7765709571884535, 1.0]], [1, [2.8179098805185623, 1.0]], [1, [0.2232253893425461, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65597896]
bas 1, expnt(s) = [7617.52164519]
bas 2, expnt(s) = [3617.35099567]
bas 3, expnt(s) = [1597.82000808]
bas 4, expnt(s) = [382.85512712]
bas 5, expnt(s) = [108.12977818]
bas 6, expnt(s) = [35.09929563]
bas 7, expnt(s) = [7.69195412]
bas 8, expnt(s) = [3.01588206]
bas 9, expnt(s) = [0.7480291]
bas 10, expnt(s) = [0.26024208]
bas 11, expnt(s) = [1362.78324743]
bas 12, expnt(s) = [664.74527113]
bas 13, expnt(s) = [300.96005628]
bas 14, expnt(s) = [314.04060541]
bas 15, expnt(s) = [61.6246958]
bas 16, expnt(s) = [7.33747816]
bas 17, expnt(s) = [20.23240387]
bas 18, expnt(s) = [0.77657096]
bas 19, expnt(s) = [2.81790988]
bas 20, expnt(s) = [0.22322539]
CPU time:        86.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752165e+03 2.06003831e+03
 3.61735100e+03 1.17844146e+03 1.59782001e+03 6.38500021e+02
 3.82855127e+02 2.18670841e+02 1.08129778e+02 8.47176711e+01
 3.50992956e+01 3.64324875e+01 7.69195412e+00 1.16692391e+01
 3.01588206e+00 5.78196942e+00 7.48029101e-01 2.03214126e+00
 2.60242080e-01 9.20551659e-01 1.36278325e+03 2.41556026e+04
 6.64745271e+02 9.84698924e+03 3.00960056e+02 3.65696216e+03
 3.14040605e+02 3.85670703e+03 6.16246958e+01 5.03706875e+02
 7.33747816e+00 3.52304280e+01 2.02324039e+01 1.25182537e+02
 7.76570957e-01 2.12672249e+00 2.81790988e+00 1.06510707e+01
 2.23225389e-01 4.47624531e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99340384038324
cond(S) = 103610.9237693775
E1 = -729.5200680778535  E_coul = 203.17638159771477
init E= -526.343686480139
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555774807831379  LUMO = 1.03570201559782
  mo_energy =
[-1.18327472e+02 -1.22048891e+01 -9.44706870e+00 -9.44706870e+00
 -9.44706870e+00 -1.23961868e+00 -5.55774808e-01 -5.55774808e-01
 -5.55774808e-01  1.03570202e+00  1.03570202e+00  1.03570202e+00
  1.17196035e+00  7.36869727e+00  7.36869727e+00  7.36869727e+00
  1.20939124e+01  3.35628061e+01  3.35628061e+01  3.35628061e+01
  1.03828170e+02  1.29176401e+02  1.29176401e+02  1.29176401e+02
  4.83569036e+02  4.83569036e+02  4.83569036e+02  5.84554785e+02
  1.33545764e+03  1.33545764e+03  1.33545764e+03  2.65313883e+03
  3.02976433e+03  3.02976433e+03  3.02976433e+03  6.65031603e+03
  6.65031603e+03  6.65031603e+03  9.05890986e+03  2.54146945e+04
  7.61572558e+04]
E1 = -727.837742143514  E_coul = 201.1031080170512
cycle= 1 E= -526.734634126463  delta_E= -0.391  |g|= 0.187  |ddm|= 0.323
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543192
diis-c [-0.29505781  1.        ]
  HOMO = -0.590442159949093  LUMO = 1.01153608118838
  mo_energy =
[-1.18637668e+02 -1.23420038e+01 -9.59547874e+00 -9.59547874e+00
 -9.59547874e+00 -1.27883083e+00 -5.90442160e-01 -5.90442160e-01
 -5.90442160e-01  1.01153608e+00  1.01153608e+00  1.01153608e+00
  1.14074940e+00  7.27799041e+00  7.27799041e+00  7.27799041e+00
  1.19878246e+01  3.34084555e+01  3.34084555e+01  3.34084555e+01
  1.03608839e+02  1.28946779e+02  1.28946779e+02  1.28946779e+02
  4.83260260e+02  4.83260260e+02  4.83260260e+02  5.84207544e+02
  1.33509152e+03  1.33509152e+03  1.33509152e+03  2.65263756e+03
  3.02933163e+03  3.02933163e+03  3.02933163e+03  6.64976960e+03
  6.64976960e+03  6.64976960e+03  9.05828784e+03  2.54139782e+04
  7.61564494e+04]
E1 = -728.4135448612004  E_coul = 201.6781825577333
cycle= 2 E= -526.735362303467  delta_E= -0.000728  |g|= 0.0379  |ddm|= 0.0533
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0757084
diis-c [-0.00327678  0.08401974  0.91598026]
  HOMO = -0.581369663869522  LUMO = 1.01824781920091
  mo_energy =
[-1.18569720e+02 -1.23038943e+01 -9.55570702e+00 -9.55570702e+00
 -9.55570702e+00 -1.26794928e+00 -5.81369664e-01 -5.81369664e-01
 -5.81369664e-01  1.01824782e+00  1.01824782e+00  1.01824782e+00
  1.14969656e+00  7.30174429e+00  7.30174429e+00  7.30174429e+00
  1.20169711e+01  3.34485875e+01  3.34485875e+01  3.34485875e+01
  1.03664475e+02  1.29002839e+02  1.29002839e+02  1.29002839e+02
  4.83327388e+02  4.83327388e+02  4.83327388e+02  5.84277028e+02
  1.33516271e+03  1.33516271e+03  1.33516271e+03  2.65271207e+03
  3.02940506e+03  3.02940506e+03  3.02940506e+03  6.64984477e+03
  6.64984477e+03  6.64984477e+03  9.05836382e+03  2.54140548e+04
  7.61565262e+04]
E1 = -728.2627148125675  E_coul = 201.52729282852215
cycle= 3 E= -526.735421984045  delta_E= -5.97e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131322
diis-c [-6.79603680e-07 -1.29327777e-03  1.43082840e-01  8.58210438e-01]
  HOMO = -0.582856379108328  LUMO = 1.01717332554207
  mo_energy =
[-1.18579625e+02 -1.23096701e+01 -9.56183553e+00 -9.56183553e+00
 -9.56183553e+00 -1.26962677e+00 -5.82856379e-01 -5.82856379e-01
 -5.82856379e-01  1.01717333e+00  1.01717333e+00  1.01717333e+00
  1.14833768e+00  7.29798188e+00  7.29798188e+00  7.29798188e+00
  1.20125085e+01  3.34424453e+01  3.34424453e+01  3.34424453e+01
  1.03656285e+02  1.28994532e+02  1.28994532e+02  1.28994532e+02
  4.83317599e+02  4.83317599e+02  4.83317599e+02  5.84266886e+02
  1.33515233e+03  1.33515233e+03  1.33515233e+03  2.65270106e+03
  3.02939430e+03  3.02939430e+03  3.02939430e+03  6.64983361e+03
  6.64983361e+03  6.64983361e+03  9.05835245e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.2854511038778  E_coul = 201.55002720714802
cycle= 4 E= -526.73542389673  delta_E= -1.91e-06  |g|= 0.000102  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117817
diis-c [-4.54509296e-09  7.06207135e-05 -1.00717849e-02 -6.61918072e-02
  1.07619297e+00]
  HOMO = -0.582835555602337  LUMO = 1.01719094300107
  mo_energy =
[-1.18579580e+02 -1.23095997e+01 -9.56177929e+00 -9.56177929e+00
 -9.56177929e+00 -1.26958280e+00 -5.82835556e-01 -5.82835556e-01
 -5.82835556e-01  1.01719094e+00  1.01719094e+00  1.01719094e+00
  1.14837694e+00  7.29802776e+00  7.29802776e+00  7.29802776e+00
  1.20125718e+01  3.34424994e+01  3.34424994e+01  3.34424994e+01
  1.03656342e+02  1.28994585e+02  1.28994585e+02  1.28994585e+02
  4.83317644e+02  4.83317644e+02  4.83317644e+02  5.84266924e+02
  1.33515237e+03  1.33515237e+03  1.33515237e+03  2.65270107e+03
  3.02939432e+03  3.02939432e+03  3.02939432e+03  6.64983362e+03
  6.64983362e+03  6.64983362e+03  9.05835245e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.2852272047228  E_coul = 201.5498033062759
cycle= 5 E= -526.735423898447  delta_E= -1.72e-09  |g|= 2.14e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.07748e-05
diis-c [-7.78202909e-11  1.40393748e-05 -1.75364725e-03 -1.35865821e-02
  4.71221690e-02  9.68204021e-01]
  HOMO = -0.582843149539168  LUMO = 1.01718588496524
  mo_energy =
[-1.18579612e+02 -1.23096232e+01 -9.56180475e+00 -9.56180475e+00
 -9.56180475e+00 -1.26958899e+00 -5.82843150e-01 -5.82843150e-01
 -5.82843150e-01  1.01718588e+00  1.01718588e+00  1.01718588e+00
  1.14837234e+00  7.29801057e+00  7.29801057e+00  7.29801057e+00
  1.20125533e+01  3.34424747e+01  3.34424747e+01  3.34424747e+01
  1.03656314e+02  1.28994556e+02  1.28994556e+02  1.28994556e+02
  4.83317612e+02  4.83317612e+02  4.83317612e+02  5.84266891e+02
  1.33515234e+03  1.33515234e+03  1.33515234e+03  2.65270104e+03
  3.02939429e+03  3.02939429e+03  3.02939429e+03  6.64983359e+03
  6.64983359e+03  6.64983359e+03  9.05835242e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.2853136725602  E_coul = 201.54988977405338
cycle= 6 E= -526.735423898507  delta_E= -5.98e-11  |g|= 1.79e-06  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2853136725602  E_coul = 201.54988977405338
  HOMO = -0.582843158571392  LUMO = 1.01718593586407
  mo_energy =
[-1.18579612e+02 -1.23096230e+01 -9.56180472e+00 -9.56180472e+00
 -9.56180472e+00 -1.26958861e+00 -5.82843159e-01 -5.82843159e-01
 -5.82843159e-01  1.01718594e+00  1.01718594e+00  1.01718594e+00
  1.14837271e+00  7.29801061e+00  7.29801061e+00  7.29801061e+00
  1.20125535e+01  3.34424748e+01  3.34424748e+01  3.34424748e+01
  1.03656314e+02  1.28994556e+02  1.28994556e+02  1.28994556e+02
  4.83317612e+02  4.83317612e+02  4.83317612e+02  5.84266891e+02
  1.33515234e+03  1.33515234e+03  1.33515234e+03  2.65270104e+03
  3.02939429e+03  3.02939429e+03  3.02939429e+03  6.64983359e+03
  6.64983359e+03  6.64983359e+03  9.05835242e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.285312955634  E_coul = 201.54988905712682
Extra cycle  E= -526.735423898507  delta_E= -4.55e-13  |g|= 3.6e-07  |ddm|= 2.99e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103610.9237693775
E1 = -728.285312955634  E_coul = 201.54988905712682
init E= -526.735423898507
    CPU time for initialize scf      0.92 sec, wall time      0.24 sec
  HOMO = -0.582843181164103  LUMO = 1.01718593150339
  mo_energy =
[-1.18579612e+02 -1.23096231e+01 -9.56180479e+00 -9.56180479e+00
 -9.56180479e+00 -1.26958856e+00 -5.82843181e-01 -5.82843181e-01
 -5.82843181e-01  1.01718593e+00  1.01718593e+00  1.01718593e+00
  1.14837277e+00  7.29801057e+00  7.29801057e+00  7.29801057e+00
  1.20125535e+01  3.34424747e+01  3.34424747e+01  3.34424747e+01
  1.03656314e+02  1.28994556e+02  1.28994556e+02  1.28994556e+02
  4.83317612e+02  4.83317612e+02  4.83317612e+02  5.84266891e+02
  1.33515234e+03  1.33515234e+03  1.33515234e+03  2.65270104e+03
  3.02939429e+03  3.02939429e+03  3.02939429e+03  6.64983359e+03
  6.64983359e+03  6.64983359e+03  9.05835242e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.2853130904994  E_coul = 201.54988919199323
cycle= 1 E= -526.735423898506  delta_E= 1.02e-12  |g|= 7.36e-08  |ddm|= 5.78e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2853130904994  E_coul = 201.54988919199323
  HOMO = -0.582843180440402  LUMO = 1.01718593441765
  mo_energy =
[-1.18579612e+02 -1.23096231e+01 -9.56180478e+00 -9.56180478e+00
 -9.56180478e+00 -1.26958854e+00 -5.82843180e-01 -5.82843180e-01
 -5.82843180e-01  1.01718593e+00  1.01718593e+00  1.01718593e+00
  1.14837279e+00  7.29801058e+00  7.29801058e+00  7.29801058e+00
  1.20125535e+01  3.34424747e+01  3.34424747e+01  3.34424747e+01
  1.03656314e+02  1.28994556e+02  1.28994556e+02  1.28994556e+02
  4.83317612e+02  4.83317612e+02  4.83317612e+02  5.84266891e+02
  1.33515234e+03  1.33515234e+03  1.33515234e+03  2.65270104e+03
  3.02939429e+03  3.02939429e+03  3.02939429e+03  6.64983359e+03
  6.64983359e+03  6.64983359e+03  9.05835242e+03  2.54140432e+04
  7.61565145e+04]
E1 = -728.2853130387896  E_coul = 201.5498891402826
Extra cycle  E= -526.735423898507  delta_E= -7.96e-13  |g|= 1.45e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826560e+04 7.61752165e+03 3.61735100e+03 1.59782001e+03
 3.82855127e+02 1.08129778e+02 3.50992956e+01 7.69195412e+00
 3.01588206e+00 7.48029101e-01 2.60242080e-01 1.36278325e+03
 6.64745271e+02 3.00960056e+02 3.14040605e+02 6.16246958e+01
 7.33747816e+00 2.02324039e+01 7.76570957e-01 2.81790988e+00
 2.23225389e-01]
grad_E = [-1.51383783e-06  3.26861230e-06 -1.60126942e-06  6.77775823e-05
  1.67057255e-05 -6.78348921e-04 -2.29780787e-03 -1.41850110e-03
 -1.21106341e-03  1.01034312e-02 -6.30162041e-03 -5.07195357e-07
  5.00225517e-06  2.35852912e-05  2.03351597e-05 -1.37995685e-05
 -1.75929256e-04 -1.50253785e-06 -1.72088772e-03  4.43729538e-04
  6.39019322e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559917        1
[INPUT] 0    0    [1    /1   ]  7617.52161748        1
[INPUT] 0    0    [1    /1   ]  3617.35100891        1
[INPUT] 0    0    [1    /1   ]  1597.8194273         1
[INPUT] 0    0    [1    /1   ]  382.855414436        1
[INPUT] 0    0    [1    /1   ]  108.131645606        1
[INPUT] 0    0    [1    /1   ]  35.1279367764        1
[INPUT] 0    0    [1    /1   ]  7.71697187122        1
[INPUT] 0    0    [1    /1   ]  3.01453673264        1
[INPUT] 0    0    [1    /1   ]  0.751722835913       1
[INPUT] 0    0    [1    /1   ]  0.260609845984       1
[INPUT] 1    0    [1    /1   ]  1362.78325167        1
[INPUT] 1    0    [1    /1   ]  664.745229056        1
[INPUT] 1    0    [1    /1   ]  300.959857668        1
[INPUT] 1    0    [1    /1   ]  314.040434177        1
[INPUT] 1    0    [1    /1   ]  61.6249132902        1
[INPUT] 1    0    [1    /1   ]  7.33859422425        1
[INPUT] 1    0    [1    /1   ]  20.2318812909        1
[INPUT] 1    0    [1    /1   ]  0.776939808055       1
[INPUT] 1    0    [1    /1   ]  2.81757130282        1
[INPUT] 1    0    [1    /1   ]  0.223049190771       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65599166741, 1.0]], [0, [7617.521617484358, 1.0]], [0, [3617.351008905456, 1.0]], [0, [1597.8194273018273, 1.0]], [0, [382.8554144357985, 1.0]], [0, [108.13164560641452, 1.0]], [0, [35.12793677641389, 1.0]], [0, [7.716971871219149, 1.0]], [0, [3.0145367326383847, 1.0]], [0, [0.7517228359128318, 1.0]], [0, [0.2606098459839299, 1.0]], [1, [1362.7832516692529, 1.0]], [1, [664.7452290563496, 1.0]], [1, [300.95985766752784, 1.0]], [1, [314.0404341774279, 1.0]], [1, [61.62491329018968, 1.0]], [1, [7.338594224252346, 1.0]], [1, [20.2318812909105, 1.0]], [1, [0.7769398080552029, 1.0]], [1, [2.8175713028187634, 1.0]], [1, [0.22304919077118648, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65599167]
bas 1, expnt(s) = [7617.52161748]
bas 2, expnt(s) = [3617.35100891]
bas 3, expnt(s) = [1597.8194273]
bas 4, expnt(s) = [382.85541444]
bas 5, expnt(s) = [108.13164561]
bas 6, expnt(s) = [35.12793678]
bas 7, expnt(s) = [7.71697187]
bas 8, expnt(s) = [3.01453673]
bas 9, expnt(s) = [0.75172284]
bas 10, expnt(s) = [0.26060985]
bas 11, expnt(s) = [1362.78325167]
bas 12, expnt(s) = [664.74522906]
bas 13, expnt(s) = [300.95985767]
bas 14, expnt(s) = [314.04043418]
bas 15, expnt(s) = [61.62491329]
bas 16, expnt(s) = [7.33859422]
bas 17, expnt(s) = [20.23188129]
bas 18, expnt(s) = [0.77693981]
bas 19, expnt(s) = [2.8175713]
bas 20, expnt(s) = [0.22304919]
CPU time:        92.21
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752162e+03 2.06003830e+03
 3.61735101e+03 1.17844146e+03 1.59781943e+03 6.38499847e+02
 3.82855414e+02 2.18670964e+02 1.08131646e+02 8.47187684e+01
 3.51279368e+01 3.64547820e+01 7.71697187e+00 1.16976928e+01
 3.01453673e+00 5.78003488e+00 7.51722836e-01 2.03966260e+00
 2.60609846e-01 9.21527158e-01 1.36278325e+03 2.41556026e+04
 6.64745229e+02 9.84698846e+03 3.00959858e+02 3.65695915e+03
 3.14040434e+02 3.85670441e+03 6.16249133e+01 5.03709097e+02
 7.33859422e+00 3.52371265e+01 2.02318813e+01 1.25178496e+02
 7.76939808e-01 2.12798523e+00 2.81757130e+00 1.06494710e+01
 2.23049191e-01 4.47182920e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993404357280525
cond(S) = 103626.33483314219
E1 = -729.5212520875111  E_coul = 203.17698421438516
init E= -526.344267873126
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555791510390323  LUMO = 1.03529418330644
  mo_energy =
[-1.18327380e+02 -1.22048749e+01 -9.44699965e+00 -9.44699965e+00
 -9.44699965e+00 -1.23961309e+00 -5.55791510e-01 -5.55791510e-01
 -5.55791510e-01  1.03529418e+00  1.03529418e+00  1.03529418e+00
  1.17767785e+00  7.36918971e+00  7.36918971e+00  7.36918971e+00
  1.21356345e+01  3.35647857e+01  3.35647857e+01  3.35647857e+01
  1.03995237e+02  1.29178612e+02  1.29178612e+02  1.29178612e+02
  4.83570899e+02  4.83570899e+02  4.83570899e+02  5.84771868e+02
  1.33545893e+03  1.33545893e+03  1.33545893e+03  2.65334323e+03
  3.02976503e+03  3.02976503e+03  3.02976503e+03  6.65031626e+03
  6.65031626e+03  6.65031626e+03  9.05909886e+03  2.54148732e+04
  7.61574222e+04]
E1 = -727.8330123565862  E_coul = 201.0983271937718
cycle= 1 E= -526.734685162814  delta_E= -0.39  |g|= 0.187  |ddm|= 0.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543168
diis-c [-0.2950318  1.       ]
  HOMO = -0.590626012093219  LUMO = 1.0110053415343
  mo_energy =
[-1.18637907e+02 -1.23423877e+01 -9.59583143e+00 -9.59583143e+00
 -9.59583143e+00 -1.27901621e+00 -5.90626012e-01 -5.90626012e-01
 -5.90626012e-01  1.01100534e+00  1.01100534e+00  1.01100534e+00
  1.14617864e+00  7.27814109e+00  7.27814109e+00  7.27814109e+00
  1.20290491e+01  3.34100546e+01  3.34100546e+01  3.34100546e+01
  1.03775404e+02  1.28948614e+02  1.28948614e+02  1.28948614e+02
  4.83261776e+02  4.83261776e+02  4.83261776e+02  5.84424350e+02
  1.33509255e+03  1.33509255e+03  1.33509255e+03  2.65284172e+03
  3.02933207e+03  3.02933207e+03  3.02933207e+03  6.64976960e+03
  6.64976960e+03  6.64976960e+03  9.05847662e+03  2.54141568e+04
  7.61566155e+04]
E1 = -728.410388391341  E_coul = 201.67497190096645
cycle= 2 E= -526.735416490375  delta_E= -0.000731  |g|= 0.038  |ddm|= 0.0535
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0758461
diis-c [-0.00328818  0.08417295  0.91582705]
  HOMO = -0.581524550447274  LUMO = 1.01773870941893
  mo_energy =
[-1.18569823e+02 -1.23041748e+01 -9.55595510e+00 -9.55595510e+00
 -9.55595510e+00 -1.26809901e+00 -5.81524550e-01 -5.81524550e-01
 -5.81524550e-01  1.01773871e+00  1.01773871e+00  1.01773871e+00
  1.15518757e+00  7.30196577e+00  7.30196577e+00  7.30196577e+00
  1.20583140e+01  3.34502895e+01  3.34502895e+01  3.34502895e+01
  1.03831169e+02  1.29004797e+02  1.29004797e+02  1.29004797e+02
  4.83329039e+02  4.83329039e+02  4.83329039e+02  5.84493970e+02
  1.33516388e+03  1.33516388e+03  1.33516388e+03  2.65291637e+03
  3.02940565e+03  3.02940565e+03  3.02940565e+03  6.64984492e+03
  6.64984492e+03  6.64984492e+03  9.05855275e+03  2.54142335e+04
  7.61566925e+04]
E1 = -728.2590685661801  E_coul = 201.52359203257575
cycle= 3 E= -526.735476533604  delta_E= -6e-05  |g|= 0.00627  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131611
diis-c [-6.83368567e-07 -1.29462292e-03  1.43135116e-01  8.58159507e-01]
  HOMO = -0.583015459002274  LUMO = 1.01666102364562
  mo_energy =
[-1.18579749e+02 -1.23099641e+01 -9.56209804e+00 -9.56209804e+00
 -9.56209804e+00 -1.26978146e+00 -5.83015459e-01 -5.83015459e-01
 -5.83015459e-01  1.01666102e+00  1.01666102e+00  1.01666102e+00
  1.15381942e+00  7.29819332e+00  7.29819332e+00  7.29819332e+00
  1.20538351e+01  3.34441328e+01  3.34441328e+01  3.34441328e+01
  1.03822960e+02  1.28996473e+02  1.28996473e+02  1.28996473e+02
  4.83319229e+02  4.83319229e+02  4.83319229e+02  5.84483808e+02
  1.33515348e+03  1.33515348e+03  1.33515348e+03  2.65290534e+03
  3.02939486e+03  3.02939486e+03  3.02939486e+03  6.64983374e+03
  6.64983374e+03  6.64983374e+03  9.05854136e+03  2.54142219e+04
  7.61566808e+04]
E1 = -728.2818745810655  E_coul = 201.54639612333284
cycle= 4 E= -526.735478457733  delta_E= -1.92e-06  |g|= 0.000102  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118834
diis-c [-4.54720006e-09  7.10545694e-05 -1.01176228e-02 -6.65291261e-02
  1.07657569e+00]
  HOMO = -0.582994827441576  LUMO = 1.01667850363675
  mo_energy =
[-1.18579705e+02 -1.23098942e+01 -9.56204246e+00 -9.56204246e+00
 -9.56204246e+00 -1.26973769e+00 -5.82994827e-01 -5.82994827e-01
 -5.82994827e-01  1.01667850e+00  1.01667850e+00  1.01667850e+00
  1.15385862e+00  7.29823875e+00  7.29823875e+00  7.29823875e+00
  1.20538980e+01  3.34441863e+01  3.34441863e+01  3.34441863e+01
  1.03823017e+02  1.28996524e+02  1.28996524e+02  1.28996524e+02
  4.83319273e+02  4.83319273e+02  4.83319273e+02  5.84483844e+02
  1.33515352e+03  1.33515352e+03  1.33515352e+03  2.65290535e+03
  3.02939489e+03  3.02939489e+03  3.02939489e+03  6.64983375e+03
  6.64983375e+03  6.64983375e+03  9.05854136e+03  2.54142219e+04
  7.61566808e+04]
E1 = -728.2816529367057  E_coul = 201.54617447726056
cycle= 5 E= -526.735478459445  delta_E= -1.71e-09  |g|= 2.13e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.07353e-05
diis-c [-7.76052775e-11  1.39878304e-05 -1.74753367e-03 -1.35401347e-02
  4.70382888e-02  9.68235392e-01]
  HOMO = -0.583002413323074  LUMO = 1.0166734491103
  mo_energy =
[-1.18579737e+02 -1.23099176e+01 -9.56206790e+00 -9.56206790e+00
 -9.56206790e+00 -1.26974389e+00 -5.83002413e-01 -5.83002413e-01
 -5.83002413e-01  1.01667345e+00  1.01667345e+00  1.01667345e+00
  1.15385400e+00  7.29822157e+00  7.29822157e+00  7.29822157e+00
  1.20538794e+01  3.34441616e+01  3.34441616e+01  3.34441616e+01
  1.03822988e+02  1.28996495e+02  1.28996495e+02  1.28996495e+02
  4.83319241e+02  4.83319241e+02  4.83319241e+02  5.84483812e+02
  1.33515348e+03  1.33515348e+03  1.33515348e+03  2.65290532e+03
  3.02939485e+03  3.02939485e+03  3.02939485e+03  6.64983372e+03
  6.64983372e+03  6.64983372e+03  9.05854132e+03  2.54142218e+04
  7.61566807e+04]
E1 = -728.2817394918784  E_coul = 201.5462610323718
cycle= 6 E= -526.735478459507  delta_E= -6.15e-11  |g|= 1.78e-06  |ddm|= 1.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2817394918784  E_coul = 201.5462610323718
  HOMO = -0.583002416188698  LUMO = 1.01667350426769
  mo_energy =
[-1.18579737e+02 -1.23099175e+01 -9.56206785e+00 -9.56206785e+00
 -9.56206785e+00 -1.26974350e+00 -5.83002416e-01 -5.83002416e-01
 -5.83002416e-01  1.01667350e+00  1.01667350e+00  1.01667350e+00
  1.15385438e+00  7.29822162e+00  7.29822162e+00  7.29822162e+00
  1.20538796e+01  3.34441617e+01  3.34441617e+01  3.34441617e+01
  1.03822988e+02  1.28996495e+02  1.28996495e+02  1.28996495e+02
  4.83319241e+02  4.83319241e+02  4.83319241e+02  5.84483812e+02
  1.33515348e+03  1.33515348e+03  1.33515348e+03  2.65290532e+03
  3.02939485e+03  3.02939485e+03  3.02939485e+03  6.64983372e+03
  6.64983372e+03  6.64983372e+03  9.05854132e+03  2.54142218e+04
  7.61566807e+04]
E1 = -728.2817387259062  E_coul = 201.54626026640037
Extra cycle  E= -526.735478459506  delta_E= 7.96e-13  |g|= 3.59e-07  |ddm|= 2.98e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826560e+04 7.61752162e+03 3.61735101e+03 1.59781943e+03
 3.82855414e+02 1.08131646e+02 3.51279368e+01 7.71697187e+00
 3.01453673e+00 7.51722836e-01 2.60609846e-01 1.36278325e+03
 6.64745229e+02 3.00959858e+02 3.14040434e+02 6.16249133e+01
 7.33859422e+00 2.02318813e+01 7.76939808e-01 2.81757130e+00
 2.23049191e-01]
E = -526.7354784595058
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6559917        1
[INPUT] 0    0    [1    /1   ]  7617.52161748        1
[INPUT] 0    0    [1    /1   ]  3617.35100891        1
[INPUT] 0    0    [1    /1   ]  1597.8194273         1
[INPUT] 0    0    [1    /1   ]  382.855414436        1
[INPUT] 0    0    [1    /1   ]  108.131645606        1
[INPUT] 0    0    [1    /1   ]  35.1279367764        1
[INPUT] 0    0    [1    /1   ]  7.71697187122        1
[INPUT] 0    0    [1    /1   ]  3.01453673264        1
[INPUT] 0    0    [1    /1   ]  0.751722835913       1
[INPUT] 0    0    [1    /1   ]  0.260609845984       1
[INPUT] 1    0    [1    /1   ]  1362.78325167        1
[INPUT] 1    0    [1    /1   ]  664.745229056        1
[INPUT] 1    0    [1    /1   ]  300.959857668        1
[INPUT] 1    0    [1    /1   ]  314.040434177        1
[INPUT] 1    0    [1    /1   ]  61.6249132902        1
[INPUT] 1    0    [1    /1   ]  7.33859422425        1
[INPUT] 1    0    [1    /1   ]  20.2318812909        1
[INPUT] 1    0    [1    /1   ]  0.776939808055       1
[INPUT] 1    0    [1    /1   ]  2.81757130282        1
[INPUT] 1    0    [1    /1   ]  0.223049190771       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65599166741, 1.0]], [0, [7617.521617484358, 1.0]], [0, [3617.351008905456, 1.0]], [0, [1597.8194273018273, 1.0]], [0, [382.8554144357985, 1.0]], [0, [108.13164560641452, 1.0]], [0, [35.12793677641389, 1.0]], [0, [7.716971871219149, 1.0]], [0, [3.0145367326383847, 1.0]], [0, [0.7517228359128318, 1.0]], [0, [0.2606098459839299, 1.0]], [1, [1362.7832516692529, 1.0]], [1, [664.7452290563496, 1.0]], [1, [300.95985766752784, 1.0]], [1, [314.0404341774279, 1.0]], [1, [61.62491329018968, 1.0]], [1, [7.338594224252346, 1.0]], [1, [20.2318812909105, 1.0]], [1, [0.7769398080552029, 1.0]], [1, [2.8175713028187634, 1.0]], [1, [0.22304919077118648, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65599167]
bas 1, expnt(s) = [7617.52161748]
bas 2, expnt(s) = [3617.35100891]
bas 3, expnt(s) = [1597.8194273]
bas 4, expnt(s) = [382.85541444]
bas 5, expnt(s) = [108.13164561]
bas 6, expnt(s) = [35.12793678]
bas 7, expnt(s) = [7.71697187]
bas 8, expnt(s) = [3.01453673]
bas 9, expnt(s) = [0.75172284]
bas 10, expnt(s) = [0.26060985]
bas 11, expnt(s) = [1362.78325167]
bas 12, expnt(s) = [664.74522906]
bas 13, expnt(s) = [300.95985767]
bas 14, expnt(s) = [314.04043418]
bas 15, expnt(s) = [61.62491329]
bas 16, expnt(s) = [7.33859422]
bas 17, expnt(s) = [20.23188129]
bas 18, expnt(s) = [0.77693981]
bas 19, expnt(s) = [2.8175713]
bas 20, expnt(s) = [0.22304919]
CPU time:        92.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752162e+03 2.06003830e+03
 3.61735101e+03 1.17844146e+03 1.59781943e+03 6.38499847e+02
 3.82855414e+02 2.18670964e+02 1.08131646e+02 8.47187684e+01
 3.51279368e+01 3.64547820e+01 7.71697187e+00 1.16976928e+01
 3.01453673e+00 5.78003488e+00 7.51722836e-01 2.03966260e+00
 2.60609846e-01 9.21527158e-01 1.36278325e+03 2.41556026e+04
 6.64745229e+02 9.84698846e+03 3.00959858e+02 3.65695915e+03
 3.14040434e+02 3.85670441e+03 6.16249133e+01 5.03709097e+02
 7.33859422e+00 3.52371265e+01 2.02318813e+01 1.25178496e+02
 7.76939808e-01 2.12798523e+00 2.81757130e+00 1.06494710e+01
 2.23049191e-01 4.47182920e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993404357280525
cond(S) = 103626.33483314219
E1 = -729.5212520875111  E_coul = 203.17698421438516
init E= -526.344267873126
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555791510390323  LUMO = 1.03529418330644
  mo_energy =
[-1.18327380e+02 -1.22048749e+01 -9.44699965e+00 -9.44699965e+00
 -9.44699965e+00 -1.23961309e+00 -5.55791510e-01 -5.55791510e-01
 -5.55791510e-01  1.03529418e+00  1.03529418e+00  1.03529418e+00
  1.17767785e+00  7.36918971e+00  7.36918971e+00  7.36918971e+00
  1.21356345e+01  3.35647857e+01  3.35647857e+01  3.35647857e+01
  1.03995237e+02  1.29178612e+02  1.29178612e+02  1.29178612e+02
  4.83570899e+02  4.83570899e+02  4.83570899e+02  5.84771868e+02
  1.33545893e+03  1.33545893e+03  1.33545893e+03  2.65334323e+03
  3.02976503e+03  3.02976503e+03  3.02976503e+03  6.65031626e+03
  6.65031626e+03  6.65031626e+03  9.05909886e+03  2.54148732e+04
  7.61574222e+04]
E1 = -727.8330123565862  E_coul = 201.0983271937718
cycle= 1 E= -526.734685162814  delta_E= -0.39  |g|= 0.187  |ddm|= 0.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543168
diis-c [-0.2950318  1.       ]
  HOMO = -0.590626012093219  LUMO = 1.0110053415343
  mo_energy =
[-1.18637907e+02 -1.23423877e+01 -9.59583143e+00 -9.59583143e+00
 -9.59583143e+00 -1.27901621e+00 -5.90626012e-01 -5.90626012e-01
 -5.90626012e-01  1.01100534e+00  1.01100534e+00  1.01100534e+00
  1.14617864e+00  7.27814109e+00  7.27814109e+00  7.27814109e+00
  1.20290491e+01  3.34100546e+01  3.34100546e+01  3.34100546e+01
  1.03775404e+02  1.28948614e+02  1.28948614e+02  1.28948614e+02
  4.83261776e+02  4.83261776e+02  4.83261776e+02  5.84424350e+02
  1.33509255e+03  1.33509255e+03  1.33509255e+03  2.65284172e+03
  3.02933207e+03  3.02933207e+03  3.02933207e+03  6.64976960e+03
  6.64976960e+03  6.64976960e+03  9.05847662e+03  2.54141568e+04
  7.61566155e+04]
E1 = -728.410388391341  E_coul = 201.67497190096645
cycle= 2 E= -526.735416490375  delta_E= -0.000731  |g|= 0.038  |ddm|= 0.0535
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0758461
diis-c [-0.00328818  0.08417295  0.91582705]
  HOMO = -0.581524550447274  LUMO = 1.01773870941893
  mo_energy =
[-1.18569823e+02 -1.23041748e+01 -9.55595510e+00 -9.55595510e+00
 -9.55595510e+00 -1.26809901e+00 -5.81524550e-01 -5.81524550e-01
 -5.81524550e-01  1.01773871e+00  1.01773871e+00  1.01773871e+00
  1.15518757e+00  7.30196577e+00  7.30196577e+00  7.30196577e+00
  1.20583140e+01  3.34502895e+01  3.34502895e+01  3.34502895e+01
  1.03831169e+02  1.29004797e+02  1.29004797e+02  1.29004797e+02
  4.83329039e+02  4.83329039e+02  4.83329039e+02  5.84493970e+02
  1.33516388e+03  1.33516388e+03  1.33516388e+03  2.65291637e+03
  3.02940565e+03  3.02940565e+03  3.02940565e+03  6.64984492e+03
  6.64984492e+03  6.64984492e+03  9.05855275e+03  2.54142335e+04
  7.61566925e+04]
E1 = -728.2590685661801  E_coul = 201.52359203257575
cycle= 3 E= -526.735476533604  delta_E= -6e-05  |g|= 0.00627  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131611
diis-c [-6.83368567e-07 -1.29462292e-03  1.43135116e-01  8.58159507e-01]
  HOMO = -0.583015459002274  LUMO = 1.01666102364562
  mo_energy =
[-1.18579749e+02 -1.23099641e+01 -9.56209804e+00 -9.56209804e+00
 -9.56209804e+00 -1.26978146e+00 -5.83015459e-01 -5.83015459e-01
 -5.83015459e-01  1.01666102e+00  1.01666102e+00  1.01666102e+00
  1.15381942e+00  7.29819332e+00  7.29819332e+00  7.29819332e+00
  1.20538351e+01  3.34441328e+01  3.34441328e+01  3.34441328e+01
  1.03822960e+02  1.28996473e+02  1.28996473e+02  1.28996473e+02
  4.83319229e+02  4.83319229e+02  4.83319229e+02  5.84483808e+02
  1.33515348e+03  1.33515348e+03  1.33515348e+03  2.65290534e+03
  3.02939486e+03  3.02939486e+03  3.02939486e+03  6.64983374e+03
  6.64983374e+03  6.64983374e+03  9.05854136e+03  2.54142219e+04
  7.61566808e+04]
E1 = -728.2818745810655  E_coul = 201.54639612333284
cycle= 4 E= -526.735478457733  delta_E= -1.92e-06  |g|= 0.000102  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118834
diis-c [-4.54720006e-09  7.10545694e-05 -1.01176228e-02 -6.65291261e-02
  1.07657569e+00]
  HOMO = -0.582994827441576  LUMO = 1.01667850363675
  mo_energy =
[-1.18579705e+02 -1.23098942e+01 -9.56204246e+00 -9.56204246e+00
 -9.56204246e+00 -1.26973769e+00 -5.82994827e-01 -5.82994827e-01
 -5.82994827e-01  1.01667850e+00  1.01667850e+00  1.01667850e+00
  1.15385862e+00  7.29823875e+00  7.29823875e+00  7.29823875e+00
  1.20538980e+01  3.34441863e+01  3.34441863e+01  3.34441863e+01
  1.03823017e+02  1.28996524e+02  1.28996524e+02  1.28996524e+02
  4.83319273e+02  4.83319273e+02  4.83319273e+02  5.84483844e+02
  1.33515352e+03  1.33515352e+03  1.33515352e+03  2.65290535e+03
  3.02939489e+03  3.02939489e+03  3.02939489e+03  6.64983375e+03
  6.64983375e+03  6.64983375e+03  9.05854136e+03  2.54142219e+04
  7.61566808e+04]
E1 = -728.2816529367057  E_coul = 201.54617447726056
cycle= 5 E= -526.735478459445  delta_E= -1.71e-09  |g|= 2.13e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.07353e-05
diis-c [-7.76052775e-11  1.39878304e-05 -1.74753367e-03 -1.35401347e-02
  4.70382888e-02  9.68235392e-01]
  HOMO = -0.583002413323074  LUMO = 1.0166734491103
  mo_energy =
[-1.18579737e+02 -1.23099176e+01 -9.56206790e+00 -9.56206790e+00
 -9.56206790e+00 -1.26974389e+00 -5.83002413e-01 -5.83002413e-01
 -5.83002413e-01  1.01667345e+00  1.01667345e+00  1.01667345e+00
  1.15385400e+00  7.29822157e+00  7.29822157e+00  7.29822157e+00
  1.20538794e+01  3.34441616e+01  3.34441616e+01  3.34441616e+01
  1.03822988e+02  1.28996495e+02  1.28996495e+02  1.28996495e+02
  4.83319241e+02  4.83319241e+02  4.83319241e+02  5.84483812e+02
  1.33515348e+03  1.33515348e+03  1.33515348e+03  2.65290532e+03
  3.02939485e+03  3.02939485e+03  3.02939485e+03  6.64983372e+03
  6.64983372e+03  6.64983372e+03  9.05854132e+03  2.54142218e+04
  7.61566807e+04]
E1 = -728.2817394918784  E_coul = 201.5462610323718
cycle= 6 E= -526.735478459507  delta_E= -6.15e-11  |g|= 1.78e-06  |ddm|= 1.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2817394918784  E_coul = 201.5462610323718
  HOMO = -0.583002416188698  LUMO = 1.01667350426769
  mo_energy =
[-1.18579737e+02 -1.23099175e+01 -9.56206785e+00 -9.56206785e+00
 -9.56206785e+00 -1.26974350e+00 -5.83002416e-01 -5.83002416e-01
 -5.83002416e-01  1.01667350e+00  1.01667350e+00  1.01667350e+00
  1.15385438e+00  7.29822162e+00  7.29822162e+00  7.29822162e+00
  1.20538796e+01  3.34441617e+01  3.34441617e+01  3.34441617e+01
  1.03822988e+02  1.28996495e+02  1.28996495e+02  1.28996495e+02
  4.83319241e+02  4.83319241e+02  4.83319241e+02  5.84483812e+02
  1.33515348e+03  1.33515348e+03  1.33515348e+03  2.65290532e+03
  3.02939485e+03  3.02939485e+03  3.02939485e+03  6.64983372e+03
  6.64983372e+03  6.64983372e+03  9.05854132e+03  2.54142218e+04
  7.61566807e+04]
E1 = -728.2817387259062  E_coul = 201.54626026640037
Extra cycle  E= -526.735478459506  delta_E= 7.96e-13  |g|= 3.59e-07  |ddm|= 2.98e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103626.33483314219
E1 = -728.2817387259062  E_coul = 201.54626026640037
init E= -526.735478459506
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583002439590221  LUMO = 1.01667349927603
  mo_energy =
[-1.18579737e+02 -1.23099175e+01 -9.56206792e+00 -9.56206792e+00
 -9.56206792e+00 -1.26974345e+00 -5.83002440e-01 -5.83002440e-01
 -5.83002440e-01  1.01667350e+00  1.01667350e+00  1.01667350e+00
  1.15385444e+00  7.29822158e+00  7.29822158e+00  7.29822158e+00
  1.20538796e+01  3.34441616e+01  3.34441616e+01  3.34441616e+01
  1.03822988e+02  1.28996495e+02  1.28996495e+02  1.28996495e+02
  4.83319241e+02  4.83319241e+02  4.83319241e+02  5.84483812e+02
  1.33515348e+03  1.33515348e+03  1.33515348e+03  2.65290532e+03
  3.02939485e+03  3.02939485e+03  3.02939485e+03  6.64983372e+03
  6.64983372e+03  6.64983372e+03  9.05854132e+03  2.54142218e+04
  7.61566807e+04]
E1 = -728.281738876894  E_coul = 201.54626041738854
cycle= 1 E= -526.735478459505  delta_E= 3.41e-13  |g|= 7.35e-08  |ddm|= 5.75e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.281738876894  E_coul = 201.54626041738854
  HOMO = -0.58300243852706  LUMO = 1.01667350242759
  mo_energy =
[-1.18579737e+02 -1.23099175e+01 -9.56206791e+00 -9.56206791e+00
 -9.56206791e+00 -1.26974344e+00 -5.83002439e-01 -5.83002439e-01
 -5.83002439e-01  1.01667350e+00  1.01667350e+00  1.01667350e+00
  1.15385445e+00  7.29822159e+00  7.29822159e+00  7.29822159e+00
  1.20538796e+01  3.34441616e+01  3.34441616e+01  3.34441616e+01
  1.03822988e+02  1.28996495e+02  1.28996495e+02  1.28996495e+02
  4.83319241e+02  4.83319241e+02  4.83319241e+02  5.84483812e+02
  1.33515348e+03  1.33515348e+03  1.33515348e+03  2.65290532e+03
  3.02939485e+03  3.02939485e+03  3.02939485e+03  6.64983372e+03
  6.64983372e+03  6.64983372e+03  9.05854132e+03  2.54142218e+04
  7.61566807e+04]
E1 = -728.2817388210361  E_coul = 201.5462603615301
Extra cycle  E= -526.735478459506  delta_E= -5.68e-13  |g|= 1.45e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61826560e+04 7.61752162e+03 3.61735101e+03 1.59781943e+03
 3.82855414e+02 1.08131646e+02 3.51279368e+01 7.71697187e+00
 3.01453673e+00 7.51722836e-01 2.60609846e-01 1.36278325e+03
 6.64745229e+02 3.00959858e+02 3.14040434e+02 6.16249133e+01
 7.33859422e+00 2.02318813e+01 7.76939808e-01 2.81757130e+00
 2.23049191e-01]
grad_E = [-1.51329075e-06  3.26234419e-06 -1.60471784e-06  6.75288421e-05
  2.50064744e-05 -7.55526369e-04 -2.08387649e-03 -8.02953534e-04
 -2.55036671e-03  1.06380929e-02 -7.58682216e-03 -5.07800067e-07
  4.99412773e-06  2.35359090e-05  2.02927252e-05 -8.05492899e-06
 -2.34840252e-05 -5.24945865e-05  4.73313802e-04  2.03864807e-04
 -6.09451983e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560152        1
[INPUT] 0    0    [1    /1   ]  7617.52156635        1
[INPUT] 0    0    [1    /1   ]  3617.35103346        1
[INPUT] 0    0    [1    /1   ]  1597.81835798        1
[INPUT] 0    0    [1    /1   ]  382.855775828        1
[INPUT] 0    0    [1    /1   ]  108.136612683        1
[INPUT] 0    0    [1    /1   ]  35.1772492891        1
[INPUT] 0    0    [1    /1   ]  7.75917489415        1
[INPUT] 0    0    [1    /1   ]  3.01383040718        1
[INPUT] 0    0    [1    /1   ]  0.749383962983       1
[INPUT] 0    0    [1    /1   ]  0.259461857611       1
[INPUT] 1    0    [1    /1   ]  1362.78325951        1
[INPUT] 1    0    [1    /1   ]  664.745151288        1
[INPUT] 1    0    [1    /1   ]  300.959490695        1
[INPUT] 1    0    [1    /1   ]  314.040117778        1
[INPUT] 1    0    [1    /1   ]  61.6252675311        1
[INPUT] 1    0    [1    /1   ]  7.3405341834         1
[INPUT] 1    0    [1    /1   ]  20.2312035123        1
[INPUT] 1    0    [1    /1   ]  0.777398908744       1
[INPUT] 1    0    [1    /1   ]  2.8161193942         1
[INPUT] 1    0    [1    /1   ]  0.222753425462       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656015171735, 1.0]], [0, [7617.521566348474, 1.0]], [0, [3617.3510334600237, 1.0]], [0, [1597.8183579827228, 1.0]], [0, [382.85577582778194, 1.0]], [0, [108.13661268346817, 1.0]], [0, [35.17724928908634, 1.0]], [0, [7.759174894148111, 1.0]], [0, [3.0138304071799, 1.0]], [0, [0.7493839629831538, 1.0]], [0, [0.2594618576113549, 1.0]], [1, [1362.783259513583, 1.0]], [1, [664.7451512881718, 1.0]], [1, [300.95949069538466, 1.0]], [1, [314.0401177779812, 1.0]], [1, [61.62526753111632, 1.0]], [1, [7.340534183396211, 1.0]], [1, [20.231203512261327, 1.0]], [1, [0.7773989087437988, 1.0]], [1, [2.8161193941960336, 1.0]], [1, [0.22275342546180354, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65601517]
bas 1, expnt(s) = [7617.52156635]
bas 2, expnt(s) = [3617.35103346]
bas 3, expnt(s) = [1597.81835798]
bas 4, expnt(s) = [382.85577583]
bas 5, expnt(s) = [108.13661268]
bas 6, expnt(s) = [35.17724929]
bas 7, expnt(s) = [7.75917489]
bas 8, expnt(s) = [3.01383041]
bas 9, expnt(s) = [0.74938396]
bas 10, expnt(s) = [0.25946186]
bas 11, expnt(s) = [1362.78325951]
bas 12, expnt(s) = [664.74515129]
bas 13, expnt(s) = [300.9594907]
bas 14, expnt(s) = [314.04011778]
bas 15, expnt(s) = [61.62526753]
bas 16, expnt(s) = [7.34053418]
bas 17, expnt(s) = [20.23120351]
bas 18, expnt(s) = [0.77739891]
bas 19, expnt(s) = [2.81611939]
bas 20, expnt(s) = [0.22275343]
CPU time:        98.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752157e+03 2.06003829e+03
 3.61735103e+03 1.17844147e+03 1.59781836e+03 6.38499526e+02
 3.82855776e+02 2.18671119e+02 1.08136613e+02 8.47216871e+01
 3.51772493e+01 3.64931567e+01 7.75917489e+00 1.17456398e+01
 3.01383041e+00 5.77901913e+00 7.49383963e-01 2.03490116e+00
 2.59461858e-01 9.18480978e-01 1.36278326e+03 2.41556028e+04
 6.64745151e+02 9.84698702e+03 3.00959491e+02 3.65695357e+03
 3.14040118e+02 3.85669955e+03 6.16252675e+01 5.03712716e+02
 7.34053418e+00 3.52487706e+01 2.02312035e+01 1.25173254e+02
 7.77398909e-01 2.12955716e+00 2.81611939e+00 1.06426118e+01
 2.22753425e-01 4.46441832e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993431405264623
cond(S) = 103628.13421794807
E1 = -729.5230939710755  E_coul = 203.17790201984204
init E= -526.345191951233
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555813368633753  LUMO = 1.03446802142573
  mo_energy =
[-1.18327240e+02 -1.22048389e+01 -9.44689653e+00 -9.44689653e+00
 -9.44689653e+00 -1.23964425e+00 -5.55813369e-01 -5.55813369e-01
 -5.55813369e-01  1.03446802e+00  1.03446802e+00  1.03446802e+00
  1.17026957e+00  7.36791612e+00  7.36791612e+00  7.36791612e+00
  1.21615784e+01  3.35646702e+01  3.35646702e+01  3.35646702e+01
  1.04242380e+02  1.29179672e+02  1.29179672e+02  1.29179672e+02
  4.83572164e+02  4.83572164e+02  4.83572164e+02  5.85116618e+02
  1.33545946e+03  1.33545946e+03  1.33545946e+03  2.65367283e+03
  3.02976460e+03  3.02976460e+03  3.02976460e+03  6.65031512e+03
  6.65031512e+03  6.65031512e+03  9.05940426e+03  2.54151620e+04
  7.61576909e+04]
E1 = -727.8249679335811  E_coul = 201.09016673792206
cycle= 1 E= -526.734801195659  delta_E= -0.39  |g|= 0.187  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543146
diis-c [-0.29500752  1.        ]
  HOMO = -0.590921609989627  LUMO = 1.00997787393864
  mo_energy =
[-1.18638352e+02 -1.23430315e+01 -9.59644278e+00 -9.59644278e+00
 -9.59644278e+00 -1.27934839e+00 -5.90921610e-01 -5.90921610e-01
 -5.90921610e-01  1.00997787e+00  1.00997787e+00  1.00997787e+00
  1.13863964e+00  7.27632244e+00  7.27632244e+00  7.27632244e+00
  1.20542025e+01  3.34092896e+01  3.34092896e+01  3.34092896e+01
  1.04021684e+02  1.28949024e+02  1.28949024e+02  1.28949024e+02
  4.83262431e+02  4.83262431e+02  4.83262431e+02  5.84768597e+02
  1.33509260e+03  1.33509260e+03  1.33509260e+03  2.65317088e+03
  3.02933118e+03  3.02933118e+03  3.02933118e+03  6.64976804e+03
  6.64976804e+03  6.64976804e+03  9.05878163e+03  2.54144452e+04
  7.61568840e+04]
E1 = -728.4049419270132  E_coul = 201.66940420511497
cycle= 2 E= -526.735537721898  delta_E= -0.000737  |g|= 0.0381  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0760623
diis-c [-0.00330603  0.08441265  0.91558735]
  HOMO = -0.581770068052644  LUMO = 1.01674705634173
  mo_energy =
[-1.18570043e+02 -1.23046491e+01 -9.55639523e+00 -9.55639523e+00
 -9.55639523e+00 -1.26837138e+00 -5.81770068e-01 -5.81770068e-01
 -5.81770068e-01  1.01674706e+00  1.01674706e+00  1.01674706e+00
  1.14766151e+00  7.30026142e+00  7.30026142e+00  7.30026142e+00
  1.20836606e+01  3.34496940e+01  3.34496940e+01  3.34496940e+01
  1.04077668e+02  1.29005410e+02  1.29005410e+02  1.29005410e+02
  4.83329916e+02  4.83329916e+02  4.83329916e+02  5.84838445e+02
  1.33516416e+03  1.33516416e+03  1.33516416e+03  2.65324577e+03
  3.02940499e+03  3.02940499e+03  3.02940499e+03  6.64984360e+03
  6.64984360e+03  6.64984360e+03  9.05885800e+03  2.54145221e+04
  7.61569612e+04]
E1 = -728.2528295435446  E_coul = 201.51723119965166
cycle= 3 E= -526.735598343893  delta_E= -6.06e-05  |g|= 0.00629  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132056
diis-c [-6.87943463e-07 -1.29629712e-03  1.43211640e-01  8.58084657e-01]
  HOMO = -0.583268239793496  LUMO = 1.01566411770841
  mo_energy =
[-1.18580002e+02 -1.23104600e+01 -9.56256128e+00 -9.56256128e+00
 -9.56256128e+00 -1.27006190e+00 -5.83268240e-01 -5.83268240e-01
 -5.83268240e-01  1.01566412e+00  1.01566412e+00  1.01566412e+00
  1.14629200e+00  7.29647319e+00  7.29647319e+00  7.29647319e+00
  1.20791559e+01  3.34435140e+01  3.34435140e+01  3.34435140e+01
  1.04069427e+02  1.28997057e+02  1.28997057e+02  1.28997057e+02
  4.83320074e+02  4.83320074e+02  4.83320074e+02  5.84828249e+02
  1.33515372e+03  1.33515372e+03  1.33515372e+03  2.65323470e+03
  3.02939417e+03  3.02939417e+03  3.02939417e+03  6.64983238e+03
  6.64983238e+03  6.64983238e+03  9.05884657e+03  2.54145105e+04
  7.61569495e+04]
E1 = -728.2757420975421  E_coul = 201.54014181191351
cycle= 4 E= -526.735600285629  delta_E= -1.94e-06  |g|= 0.000103  |ddm|= 0.00227
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.000120788
diis-c [-4.55029013e-09  7.20169529e-05 -1.02196716e-02 -6.72787433e-02
  1.07742640e+00]
  HOMO = -0.583248076610265  LUMO = 1.01568127022633
  mo_energy =
[-1.18579960e+02 -1.23103913e+01 -9.56250708e+00 -9.56250708e+00
 -9.56250708e+00 -1.27001856e+00 -5.83248077e-01 -5.83248077e-01
 -5.83248077e-01  1.01568127e+00  1.01568127e+00  1.01568127e+00
  1.14633072e+00  7.29651763e+00  7.29651763e+00  7.29651763e+00
  1.20792178e+01  3.34435661e+01  3.34435661e+01  3.34435661e+01
  1.04069482e+02  1.28997107e+02  1.28997107e+02  1.28997107e+02
  4.83320116e+02  4.83320116e+02  4.83320116e+02  5.84828284e+02
  1.33515376e+03  1.33515376e+03  1.33515376e+03  2.65323472e+03
  3.02939419e+03  3.02939419e+03  3.02939419e+03  6.64983239e+03
  6.64983239e+03  6.64983239e+03  9.05884657e+03  2.54145105e+04
  7.61569494e+04]
E1 = -728.275524344179  E_coul = 201.53992405682513
cycle= 5 E= -526.735600287354  delta_E= -1.73e-09  |g|= 2.13e-05  |ddm|= 0.000159
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=4.06689e-05
diis-c [-7.80153202e-11  1.39552469e-05 -1.74310538e-03 -1.34986264e-02
  4.66973964e-02  9.68530380e-01]
  HOMO = -0.583255671093426  LUMO = 1.01567620939589
  mo_energy =
[-1.18579992e+02 -1.23104148e+01 -9.56253252e+00 -9.56253252e+00
 -9.56253252e+00 -1.27002476e+00 -5.83255671e-01 -5.83255671e-01
 -5.83255671e-01  1.01567621e+00  1.01567621e+00  1.01567621e+00
  1.14632611e+00  7.29650044e+00  7.29650044e+00  7.29650044e+00
  1.20791993e+01  3.34435415e+01  3.34435415e+01  3.34435415e+01
  1.04069453e+02  1.28997078e+02  1.28997078e+02  1.28997078e+02
  4.83320084e+02  4.83320084e+02  4.83320084e+02  5.84828251e+02
  1.33515373e+03  1.33515373e+03  1.33515373e+03  2.65323468e+03
  3.02939415e+03  3.02939415e+03  3.02939415e+03  6.64983236e+03
  6.64983236e+03  6.64983236e+03  9.05884653e+03  2.54145105e+04
  7.61569494e+04]
E1 = -728.2756109400125  E_coul = 201.54001065259976
cycle= 6 E= -526.735600287413  delta_E= -5.89e-11  |g|= 1.79e-06  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2756109400125  E_coul = 201.54001065259976
  HOMO = -0.583255665784767  LUMO = 1.01567627053498
  mo_energy =
[-1.18579992e+02 -1.23104146e+01 -9.56253244e+00 -9.56253244e+00
 -9.56253244e+00 -1.27002437e+00 -5.83255666e-01 -5.83255666e-01
 -5.83255666e-01  1.01567627e+00  1.01567627e+00  1.01567627e+00
  1.14632650e+00  7.29650052e+00  7.29650052e+00  7.29650052e+00
  1.20791995e+01  3.34435416e+01  3.34435416e+01  3.34435416e+01
  1.04069453e+02  1.28997078e+02  1.28997078e+02  1.28997078e+02
  4.83320085e+02  4.83320085e+02  4.83320085e+02  5.84828252e+02
  1.33515373e+03  1.33515373e+03  1.33515373e+03  2.65323468e+03
  3.02939416e+03  3.02939416e+03  3.02939416e+03  6.64983236e+03
  6.64983236e+03  6.64983236e+03  9.05884653e+03  2.54145105e+04
  7.61569494e+04]
E1 = -728.2756100617001  E_coul = 201.54000977428547
Extra cycle  E= -526.735600287415  delta_E= -1.93e-12  |g|= 3.59e-07  |ddm|= 2.99e-06
    CPU time for scf_cycle      0.36 sec, wall time      0.30 sec
exp = [2.61826560e+04 7.61752157e+03 3.61735103e+03 1.59781836e+03
 3.82855776e+02 1.08136613e+02 3.51772493e+01 7.75917489e+00
 3.01383041e+00 7.49383963e-01 2.59461858e-01 1.36278326e+03
 6.64745151e+02 3.00959491e+02 3.14040118e+02 6.16252675e+01
 7.34053418e+00 2.02312035e+01 7.77398909e-01 2.81611939e+00
 2.22753425e-01]
E = -526.7356002874146
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560152        1
[INPUT] 0    0    [1    /1   ]  7617.52156635        1
[INPUT] 0    0    [1    /1   ]  3617.35103346        1
[INPUT] 0    0    [1    /1   ]  1597.81835798        1
[INPUT] 0    0    [1    /1   ]  382.855775828        1
[INPUT] 0    0    [1    /1   ]  108.136612683        1
[INPUT] 0    0    [1    /1   ]  35.1772492891        1
[INPUT] 0    0    [1    /1   ]  7.75917489415        1
[INPUT] 0    0    [1    /1   ]  3.01383040718        1
[INPUT] 0    0    [1    /1   ]  0.749383962983       1
[INPUT] 0    0    [1    /1   ]  0.259461857611       1
[INPUT] 1    0    [1    /1   ]  1362.78325951        1
[INPUT] 1    0    [1    /1   ]  664.745151288        1
[INPUT] 1    0    [1    /1   ]  300.959490695        1
[INPUT] 1    0    [1    /1   ]  314.040117778        1
[INPUT] 1    0    [1    /1   ]  61.6252675311        1
[INPUT] 1    0    [1    /1   ]  7.3405341834         1
[INPUT] 1    0    [1    /1   ]  20.2312035123        1
[INPUT] 1    0    [1    /1   ]  0.777398908744       1
[INPUT] 1    0    [1    /1   ]  2.8161193942         1
[INPUT] 1    0    [1    /1   ]  0.222753425462       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656015171735, 1.0]], [0, [7617.521566348474, 1.0]], [0, [3617.3510334600237, 1.0]], [0, [1597.8183579827228, 1.0]], [0, [382.85577582778194, 1.0]], [0, [108.13661268346817, 1.0]], [0, [35.17724928908634, 1.0]], [0, [7.759174894148111, 1.0]], [0, [3.0138304071799, 1.0]], [0, [0.7493839629831538, 1.0]], [0, [0.2594618576113549, 1.0]], [1, [1362.783259513583, 1.0]], [1, [664.7451512881718, 1.0]], [1, [300.95949069538466, 1.0]], [1, [314.0401177779812, 1.0]], [1, [61.62526753111632, 1.0]], [1, [7.340534183396211, 1.0]], [1, [20.231203512261327, 1.0]], [1, [0.7773989087437988, 1.0]], [1, [2.8161193941960336, 1.0]], [1, [0.22275342546180354, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65601517]
bas 1, expnt(s) = [7617.52156635]
bas 2, expnt(s) = [3617.35103346]
bas 3, expnt(s) = [1597.81835798]
bas 4, expnt(s) = [382.85577583]
bas 5, expnt(s) = [108.13661268]
bas 6, expnt(s) = [35.17724929]
bas 7, expnt(s) = [7.75917489]
bas 8, expnt(s) = [3.01383041]
bas 9, expnt(s) = [0.74938396]
bas 10, expnt(s) = [0.25946186]
bas 11, expnt(s) = [1362.78325951]
bas 12, expnt(s) = [664.74515129]
bas 13, expnt(s) = [300.9594907]
bas 14, expnt(s) = [314.04011778]
bas 15, expnt(s) = [61.62526753]
bas 16, expnt(s) = [7.34053418]
bas 17, expnt(s) = [20.23120351]
bas 18, expnt(s) = [0.77739891]
bas 19, expnt(s) = [2.81611939]
bas 20, expnt(s) = [0.22275343]
CPU time:        98.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826560e+04 5.20026289e+03 7.61752157e+03 2.06003829e+03
 3.61735103e+03 1.17844147e+03 1.59781836e+03 6.38499526e+02
 3.82855776e+02 2.18671119e+02 1.08136613e+02 8.47216871e+01
 3.51772493e+01 3.64931567e+01 7.75917489e+00 1.17456398e+01
 3.01383041e+00 5.77901913e+00 7.49383963e-01 2.03490116e+00
 2.59461858e-01 9.18480978e-01 1.36278326e+03 2.41556028e+04
 6.64745151e+02 9.84698702e+03 3.00959491e+02 3.65695357e+03
 3.14040118e+02 3.85669955e+03 6.16252675e+01 5.03712716e+02
 7.34053418e+00 3.52487706e+01 2.02312035e+01 1.25173254e+02
 7.77398909e-01 2.12955716e+00 2.81611939e+00 1.06426118e+01
 2.22753425e-01 4.46441832e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993431405264623
cond(S) = 103628.13421794807
E1 = -729.5230939710755  E_coul = 203.17790201984204
init E= -526.345191951233
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555813368633753  LUMO = 1.03446802142573
  mo_energy =
[-1.18327240e+02 -1.22048389e+01 -9.44689653e+00 -9.44689653e+00
 -9.44689653e+00 -1.23964425e+00 -5.55813369e-01 -5.55813369e-01
 -5.55813369e-01  1.03446802e+00  1.03446802e+00  1.03446802e+00
  1.17026957e+00  7.36791612e+00  7.36791612e+00  7.36791612e+00
  1.21615784e+01  3.35646702e+01  3.35646702e+01  3.35646702e+01
  1.04242380e+02  1.29179672e+02  1.29179672e+02  1.29179672e+02
  4.83572164e+02  4.83572164e+02  4.83572164e+02  5.85116618e+02
  1.33545946e+03  1.33545946e+03  1.33545946e+03  2.65367283e+03
  3.02976460e+03  3.02976460e+03  3.02976460e+03  6.65031512e+03
  6.65031512e+03  6.65031512e+03  9.05940426e+03  2.54151620e+04
  7.61576909e+04]
E1 = -727.8249679335811  E_coul = 201.09016673792206
cycle= 1 E= -526.734801195659  delta_E= -0.39  |g|= 0.187  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543146
diis-c [-0.29500752  1.        ]
  HOMO = -0.590921609989627  LUMO = 1.00997787393864
  mo_energy =
[-1.18638352e+02 -1.23430315e+01 -9.59644278e+00 -9.59644278e+00
 -9.59644278e+00 -1.27934839e+00 -5.90921610e-01 -5.90921610e-01
 -5.90921610e-01  1.00997787e+00  1.00997787e+00  1.00997787e+00
  1.13863964e+00  7.27632244e+00  7.27632244e+00  7.27632244e+00
  1.20542025e+01  3.34092896e+01  3.34092896e+01  3.34092896e+01
  1.04021684e+02  1.28949024e+02  1.28949024e+02  1.28949024e+02
  4.83262431e+02  4.83262431e+02  4.83262431e+02  5.84768597e+02
  1.33509260e+03  1.33509260e+03  1.33509260e+03  2.65317088e+03
  3.02933118e+03  3.02933118e+03  3.02933118e+03  6.64976804e+03
  6.64976804e+03  6.64976804e+03  9.05878163e+03  2.54144452e+04
  7.61568840e+04]
E1 = -728.4049419270132  E_coul = 201.66940420511497
cycle= 2 E= -526.735537721898  delta_E= -0.000737  |g|= 0.0381  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0760623
diis-c [-0.00330603  0.08441265  0.91558735]
  HOMO = -0.581770068052644  LUMO = 1.01674705634173
  mo_energy =
[-1.18570043e+02 -1.23046491e+01 -9.55639523e+00 -9.55639523e+00
 -9.55639523e+00 -1.26837138e+00 -5.81770068e-01 -5.81770068e-01
 -5.81770068e-01  1.01674706e+00  1.01674706e+00  1.01674706e+00
  1.14766151e+00  7.30026142e+00  7.30026142e+00  7.30026142e+00
  1.20836606e+01  3.34496940e+01  3.34496940e+01  3.34496940e+01
  1.04077668e+02  1.29005410e+02  1.29005410e+02  1.29005410e+02
  4.83329916e+02  4.83329916e+02  4.83329916e+02  5.84838445e+02
  1.33516416e+03  1.33516416e+03  1.33516416e+03  2.65324577e+03
  3.02940499e+03  3.02940499e+03  3.02940499e+03  6.64984360e+03
  6.64984360e+03  6.64984360e+03  9.05885800e+03  2.54145221e+04
  7.61569612e+04]
E1 = -728.2528295435446  E_coul = 201.51723119965166
cycle= 3 E= -526.735598343893  delta_E= -6.06e-05  |g|= 0.00629  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132056
diis-c [-6.87943463e-07 -1.29629712e-03  1.43211640e-01  8.58084657e-01]
  HOMO = -0.583268239793496  LUMO = 1.01566411770841
  mo_energy =
[-1.18580002e+02 -1.23104600e+01 -9.56256128e+00 -9.56256128e+00
 -9.56256128e+00 -1.27006190e+00 -5.83268240e-01 -5.83268240e-01
 -5.83268240e-01  1.01566412e+00  1.01566412e+00  1.01566412e+00
  1.14629200e+00  7.29647319e+00  7.29647319e+00  7.29647319e+00
  1.20791559e+01  3.34435140e+01  3.34435140e+01  3.34435140e+01
  1.04069427e+02  1.28997057e+02  1.28997057e+02  1.28997057e+02
  4.83320074e+02  4.83320074e+02  4.83320074e+02  5.84828249e+02
  1.33515372e+03  1.33515372e+03  1.33515372e+03  2.65323470e+03
  3.02939417e+03  3.02939417e+03  3.02939417e+03  6.64983238e+03
  6.64983238e+03  6.64983238e+03  9.05884657e+03  2.54145105e+04
  7.61569495e+04]
E1 = -728.2757420975421  E_coul = 201.54014181191351
cycle= 4 E= -526.735600285629  delta_E= -1.94e-06  |g|= 0.000103  |ddm|= 0.00227
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.000120788
diis-c [-4.55029013e-09  7.20169529e-05 -1.02196716e-02 -6.72787433e-02
  1.07742640e+00]
  HOMO = -0.583248076610265  LUMO = 1.01568127022633
  mo_energy =
[-1.18579960e+02 -1.23103913e+01 -9.56250708e+00 -9.56250708e+00
 -9.56250708e+00 -1.27001856e+00 -5.83248077e-01 -5.83248077e-01
 -5.83248077e-01  1.01568127e+00  1.01568127e+00  1.01568127e+00
  1.14633072e+00  7.29651763e+00  7.29651763e+00  7.29651763e+00
  1.20792178e+01  3.34435661e+01  3.34435661e+01  3.34435661e+01
  1.04069482e+02  1.28997107e+02  1.28997107e+02  1.28997107e+02
  4.83320116e+02  4.83320116e+02  4.83320116e+02  5.84828284e+02
  1.33515376e+03  1.33515376e+03  1.33515376e+03  2.65323472e+03
  3.02939419e+03  3.02939419e+03  3.02939419e+03  6.64983239e+03
  6.64983239e+03  6.64983239e+03  9.05884657e+03  2.54145105e+04
  7.61569494e+04]
E1 = -728.275524344179  E_coul = 201.53992405682513
cycle= 5 E= -526.735600287354  delta_E= -1.73e-09  |g|= 2.13e-05  |ddm|= 0.000159
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=4.06689e-05
diis-c [-7.80153202e-11  1.39552469e-05 -1.74310538e-03 -1.34986264e-02
  4.66973964e-02  9.68530380e-01]
  HOMO = -0.583255671093426  LUMO = 1.01567620939589
  mo_energy =
[-1.18579992e+02 -1.23104148e+01 -9.56253252e+00 -9.56253252e+00
 -9.56253252e+00 -1.27002476e+00 -5.83255671e-01 -5.83255671e-01
 -5.83255671e-01  1.01567621e+00  1.01567621e+00  1.01567621e+00
  1.14632611e+00  7.29650044e+00  7.29650044e+00  7.29650044e+00
  1.20791993e+01  3.34435415e+01  3.34435415e+01  3.34435415e+01
  1.04069453e+02  1.28997078e+02  1.28997078e+02  1.28997078e+02
  4.83320084e+02  4.83320084e+02  4.83320084e+02  5.84828251e+02
  1.33515373e+03  1.33515373e+03  1.33515373e+03  2.65323468e+03
  3.02939415e+03  3.02939415e+03  3.02939415e+03  6.64983236e+03
  6.64983236e+03  6.64983236e+03  9.05884653e+03  2.54145105e+04
  7.61569494e+04]
E1 = -728.2756109400125  E_coul = 201.54001065259976
cycle= 6 E= -526.735600287413  delta_E= -5.89e-11  |g|= 1.79e-06  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2756109400125  E_coul = 201.54001065259976
  HOMO = -0.583255665784767  LUMO = 1.01567627053498
  mo_energy =
[-1.18579992e+02 -1.23104146e+01 -9.56253244e+00 -9.56253244e+00
 -9.56253244e+00 -1.27002437e+00 -5.83255666e-01 -5.83255666e-01
 -5.83255666e-01  1.01567627e+00  1.01567627e+00  1.01567627e+00
  1.14632650e+00  7.29650052e+00  7.29650052e+00  7.29650052e+00
  1.20791995e+01  3.34435416e+01  3.34435416e+01  3.34435416e+01
  1.04069453e+02  1.28997078e+02  1.28997078e+02  1.28997078e+02
  4.83320085e+02  4.83320085e+02  4.83320085e+02  5.84828252e+02
  1.33515373e+03  1.33515373e+03  1.33515373e+03  2.65323468e+03
  3.02939416e+03  3.02939416e+03  3.02939416e+03  6.64983236e+03
  6.64983236e+03  6.64983236e+03  9.05884653e+03  2.54145105e+04
  7.61569494e+04]
E1 = -728.2756100617001  E_coul = 201.54000977428547
Extra cycle  E= -526.735600287415  delta_E= -1.93e-12  |g|= 3.59e-07  |ddm|= 2.99e-06
    CPU time for scf_cycle      0.36 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103628.13421794807
E1 = -728.2756100617001  E_coul = 201.54000977428547
init E= -526.735600287415
    CPU time for initialize scf      0.94 sec, wall time      0.26 sec
  HOMO = -0.583255691531419  LUMO = 1.0156762638778
  mo_energy =
[-1.18579992e+02 -1.23104147e+01 -9.56253252e+00 -9.56253252e+00
 -9.56253252e+00 -1.27002432e+00 -5.83255692e-01 -5.83255692e-01
 -5.83255692e-01  1.01567626e+00  1.01567626e+00  1.01567626e+00
  1.14632655e+00  7.29650047e+00  7.29650047e+00  7.29650047e+00
  1.20791995e+01  3.34435415e+01  3.34435415e+01  3.34435415e+01
  1.04069453e+02  1.28997078e+02  1.28997078e+02  1.28997078e+02
  4.83320085e+02  4.83320085e+02  4.83320085e+02  5.84828251e+02
  1.33515373e+03  1.33515373e+03  1.33515373e+03  2.65323468e+03
  3.02939415e+03  3.02939415e+03  3.02939415e+03  6.64983236e+03
  6.64983236e+03  6.64983236e+03  9.05884653e+03  2.54145105e+04
  7.61569494e+04]
E1 = -728.2756102425969  E_coul = 201.5400099551829
cycle= 1 E= -526.735600287414  delta_E= 5.68e-13  |g|= 7.41e-08  |ddm|= 5.75e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2756102425969  E_coul = 201.5400099551829
  HOMO = -0.583255689932666  LUMO = 1.0156762674276
  mo_energy =
[-1.18579992e+02 -1.23104146e+01 -9.56253251e+00 -9.56253251e+00
 -9.56253251e+00 -1.27002430e+00 -5.83255690e-01 -5.83255690e-01
 -5.83255690e-01  1.01567627e+00  1.01567627e+00  1.01567627e+00
  1.14632657e+00  7.29650047e+00  7.29650047e+00  7.29650047e+00
  1.20791995e+01  3.34435415e+01  3.34435415e+01  3.34435415e+01
  1.04069453e+02  1.28997078e+02  1.28997078e+02  1.28997078e+02
  4.83320085e+02  4.83320085e+02  4.83320085e+02  5.84828251e+02
  1.33515373e+03  1.33515373e+03  1.33515373e+03  2.65323468e+03
  3.02939415e+03  3.02939415e+03  3.02939415e+03  6.64983236e+03
  6.64983236e+03  6.64983236e+03  9.05884653e+03  2.54145105e+04
  7.61569494e+04]
E1 = -728.2756101777776  E_coul = 201.54000989036285
Extra cycle  E= -526.735600287415  delta_E= -6.82e-13  |g|= 1.46e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.08 sec, wall time      0.40 sec
exp = [2.61826560e+04 7.61752157e+03 3.61735103e+03 1.59781836e+03
 3.82855776e+02 1.08136613e+02 3.51772493e+01 7.75917489e+00
 3.01383041e+00 7.49383963e-01 2.59461858e-01 1.36278326e+03
 6.64745151e+02 3.00959491e+02 3.14040118e+02 6.16252675e+01
 7.34053418e+00 2.02312035e+01 7.77398909e-01 2.81611939e+00
 2.22753425e-01]
grad_E = [-1.51238416e-06  3.25201015e-06 -1.61030170e-06  6.71182464e-05
  3.88016565e-05 -8.84126999e-04 -1.72631241e-03  1.49766533e-04
 -4.70490979e-03  1.08430511e-02 -8.72797555e-03 -5.09012613e-07
  4.97770414e-06  2.34358669e-05  2.02068099e-05  3.98659296e-06
  3.59303913e-04 -1.65101795e-04  3.72117792e-03 -3.81785283e-04
 -1.09631462e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560569        1
[INPUT] 0    0    [1    /1   ]  7617.5214757         1
[INPUT] 0    0    [1    /1   ]  3617.3510772         1
[INPUT] 0    0    [1    /1   ]  1597.81646642        1
[INPUT] 0    0    [1    /1   ]  382.856143871        1
[INPUT] 0    0    [1    /1   ]  108.1478849          1
[INPUT] 0    0    [1    /1   ]  35.2588293295        1
[INPUT] 0    0    [1    /1   ]  7.8261411475         1
[INPUT] 0    0    [1    /1   ]  3.01979355346        1
[INPUT] 0    0    [1    /1   ]  0.731793442038       1
[INPUT] 0    0    [1    /1   ]  0.25487785529        1
[INPUT] 1    0    [1    /1   ]  1362.78327346        1
[INPUT] 1    0    [1    /1   ]  664.745013253        1
[INPUT] 1    0    [1    /1   ]  300.958839512        1
[INPUT] 1    0    [1    /1   ]  314.039556333        1
[INPUT] 1    0    [1    /1   ]  61.6258105012        1
[INPUT] 1    0    [1    /1   ]  7.34330462361        1
[INPUT] 1    0    [1    /1   ]  20.2305667143        1
[INPUT] 1    0    [1    /1   ]  0.777789862067       1
[INPUT] 1    0    [1    /1   ]  2.81293682042        1
[INPUT] 1    0    [1    /1   ]  0.222328607027       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656056913598, 1.0]], [0, [7617.521475704918, 1.0]], [0, [3617.351077201133, 1.0]], [0, [1597.8164664247918, 1.0]], [0, [382.8561438713723, 1.0]], [0, [108.14788489982989, 1.0]], [0, [35.258829329521305, 1.0]], [0, [7.826141147503149, 1.0]], [0, [3.019793553463489, 1.0]], [0, [0.7317934420379526, 1.0]], [0, [0.2548778552897309, 1.0]], [1, [1362.7832734604085, 1.0]], [1, [664.745013253015, 1.0]], [1, [300.9588395120433, 1.0]], [1, [314.03955633275893, 1.0]], [1, [61.625810501188354, 1.0]], [1, [7.343304623606925, 1.0]], [1, [20.230566714319895, 1.0]], [1, [0.777789862067454, 1.0]], [1, [2.8129368204168337, 1.0]], [1, [0.22232860702654295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65605691]
bas 1, expnt(s) = [7617.5214757]
bas 2, expnt(s) = [3617.3510772]
bas 3, expnt(s) = [1597.81646642]
bas 4, expnt(s) = [382.85614387]
bas 5, expnt(s) = [108.1478849]
bas 6, expnt(s) = [35.25882933]
bas 7, expnt(s) = [7.82614115]
bas 8, expnt(s) = [3.01979355]
bas 9, expnt(s) = [0.73179344]
bas 10, expnt(s) = [0.25487786]
bas 11, expnt(s) = [1362.78327346]
bas 12, expnt(s) = [664.74501325]
bas 13, expnt(s) = [300.95883951]
bas 14, expnt(s) = [314.03955633]
bas 15, expnt(s) = [61.6258105]
bas 16, expnt(s) = [7.34330462]
bas 17, expnt(s) = [20.23056671]
bas 18, expnt(s) = [0.77778986]
bas 19, expnt(s) = [2.81293682]
bas 20, expnt(s) = [0.22232861]
CPU time:       104.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026290e+03 7.61752148e+03 2.06003828e+03
 3.61735108e+03 1.17844148e+03 1.59781647e+03 6.38498959e+02
 3.82856144e+02 2.18671276e+02 1.08147885e+02 8.47283106e+01
 3.52588293e+01 3.65566121e+01 7.82614115e+00 1.18215870e+01
 3.01979355e+00 5.78759276e+00 7.31793442e-01 1.99897061e+00
 2.54877855e-01 9.06283561e-01 1.36278327e+03 2.41556031e+04
 6.64745013e+02 9.84698446e+03 3.00958840e+02 3.65694368e+03
 3.14039556e+02 3.85669093e+03 6.16258105e+01 5.03718264e+02
 7.34330462e+00 3.52654007e+01 2.02305667e+01 1.25168329e+02
 7.77789862e-01 2.13089593e+00 2.81293682e+00 1.06275796e+01
 2.22328607e-01 4.45377811e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993509966908917
cond(S) = 103595.88137377518
E1 = -729.5253679481785  E_coul = 203.17901919881635
init E= -526.346348749362
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555832513612033  LUMO = 1.03305204833615
  mo_energy =
[-1.18327075e+02 -1.22047870e+01 -9.44677421e+00 -9.44677421e+00
 -9.44677421e+00 -1.23974670e+00 -5.55832514e-01 -5.55832514e-01
 -5.55832514e-01  1.03305205e+00  1.03305205e+00  1.03305205e+00
  1.13183330e+00  7.36317509e+00  7.36317509e+00  7.36317509e+00
  1.21431414e+01  3.35597995e+01  3.35597995e+01  3.35597995e+01
  1.04602204e+02  1.29177637e+02  1.29177637e+02  1.29177637e+02
  4.83571583e+02  4.83571583e+02  4.83571583e+02  5.85653861e+02
  1.33545798e+03  1.33545798e+03  1.33545798e+03  2.65419406e+03
  3.02976160e+03  3.02976160e+03  3.02976160e+03  6.65031105e+03
  6.65031105e+03  6.65031105e+03  9.05988817e+03  2.54156196e+04
  7.61581168e+04]
E1 = -727.8136061819364  E_coul = 201.07856767149815
cycle= 1 E= -526.735038510438  delta_E= -0.389  |g|= 0.187  |ddm|= 0.306
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543116
diis-c [-0.29497463  1.        ]
  HOMO = -0.591314854104656  LUMO = 1.00828650344581
  mo_energy =
[-1.18639031e+02 -1.23439508e+01 -9.59732589e+00 -9.59732589e+00
 -9.59732589e+00 -1.27984494e+00 -5.91314854e-01 -5.91314854e-01
 -5.91314854e-01  1.00828650e+00  1.00828650e+00  1.00828650e+00
  1.10061531e+00  7.27086276e+00  7.27086276e+00  7.27086276e+00
  1.20346561e+01  3.34035011e+01  3.34035011e+01  3.34035011e+01
  1.04380264e+02  1.28946067e+02  1.28946067e+02  1.28946067e+02
  4.83260977e+02  4.83260977e+02  4.83260977e+02  5.85305116e+02
  1.33509043e+03  1.33509043e+03  1.33509043e+03  2.65369147e+03
  3.02932750e+03  3.02932750e+03  3.02932750e+03  6.64976335e+03
  6.64976335e+03  6.64976335e+03  9.05926495e+03  2.54149023e+04
  7.61573094e+04]
E1 = -728.3971033675758  E_coul = 201.66132132251403
cycle= 2 E= -526.735782045062  delta_E= -0.000744  |g|= 0.0383  |ddm|= 0.0541
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.076334
diis-c [-0.00332904  0.08470625  0.91529375]
  HOMO = -0.582090874329905  LUMO = 1.01510497811336
  mo_energy =
[-1.18570415e+02 -1.23053403e+01 -9.55704835e+00 -9.55704835e+00
 -9.55704835e+00 -1.26878446e+00 -5.82090874e-01 -5.82090874e-01
 -5.82090874e-01  1.01510498e+00  1.01510498e+00  1.01510498e+00
  1.10950149e+00  7.29495404e+00  7.29495404e+00  7.29495404e+00
  1.20643957e+01  3.34441352e+01  3.34441352e+01  3.34441352e+01
  1.04436552e+02  1.29002728e+02  1.29002728e+02  1.29002728e+02
  4.83328766e+02  4.83328766e+02  4.83328766e+02  5.85375272e+02
  1.33516230e+03  1.33516230e+03  1.33516230e+03  2.65376668e+03
  3.02940163e+03  3.02940163e+03  3.02940163e+03  6.64983923e+03
  6.64983923e+03  6.64983923e+03  9.05934165e+03  2.54149796e+04
  7.61573869e+04]
E1 = -728.2439510517138  E_coul = 201.5081076399902
cycle= 3 E= -526.735843411724  delta_E= -6.14e-05  |g|= 0.00632  |ddm|= 0.0166
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132605
diis-c [-6.89761258e-07 -1.29714596e-03  1.43302655e-01  8.57994491e-01]
  HOMO = -0.583599461533173  LUMO = 1.01401491674608
  mo_energy =
[-1.18580417e+02 -1.23111794e+01 -9.56324434e+00 -9.56324434e+00
 -9.56324434e+00 -1.27048585e+00 -5.83599462e-01 -5.83599462e-01
 -5.83599462e-01  1.01401492e+00  1.01401492e+00  1.01401492e+00
  1.10815404e+00  7.29114576e+00  7.29114576e+00  7.29114576e+00
  1.20598551e+01  3.34379249e+01  3.34379249e+01  3.34379249e+01
  1.04428269e+02  1.28994338e+02  1.28994338e+02  1.28994338e+02
  4.83318881e+02  4.83318881e+02  4.83318881e+02  5.85365033e+02
  1.33515182e+03  1.33515182e+03  1.33515182e+03  2.65375556e+03
  3.02939076e+03  3.02939076e+03  3.02939076e+03  6.64982797e+03
  6.64982797e+03  6.64982797e+03  9.05933017e+03  2.54149679e+04
  7.61573751e+04]
E1 = -728.2669920650981  E_coul = 201.53114669019263
cycle= 4 E= -526.735845374905  delta_E= -1.96e-06  |g|= 0.000103  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123797
diis-c [-4.54448498e-09  7.37241519e-05 -1.04006451e-02 -6.86030362e-02
  1.07892996e+00]
  HOMO = -0.583580220171869  LUMO = 1.01403143033659
  mo_energy =
[-1.18580378e+02 -1.23111129e+01 -9.56319261e+00 -9.56319261e+00
 -9.56319261e+00 -1.27044327e+00 -5.83580220e-01 -5.83580220e-01
 -5.83580220e-01  1.01403143e+00  1.01403143e+00  1.01403143e+00
  1.10819143e+00  7.29118839e+00  7.29118839e+00  7.29118839e+00
  1.20599154e+01  3.34379745e+01  3.34379745e+01  3.34379745e+01
  1.04428321e+02  1.28994385e+02  1.28994385e+02  1.28994385e+02
  4.83318920e+02  4.83318920e+02  4.83318920e+02  5.85365065e+02
  1.33515185e+03  1.33515185e+03  1.33515185e+03  2.65375557e+03
  3.02939078e+03  3.02939078e+03  3.02939078e+03  6.64982798e+03
  6.64982798e+03  6.64982798e+03  9.05933017e+03  2.54149679e+04
  7.61573751e+04]
E1 = -728.2667801275127  E_coul = 201.53093475084322
cycle= 5 E= -526.735845376669  delta_E= -1.76e-09  |g|= 2.13e-05  |ddm|= 0.00016
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.05287e-05
diis-c [-7.96477874e-11  1.39931027e-05 -1.74658173e-03 -1.34970793e-02
  4.58881783e-02  9.69341490e-01]
  HOMO = -0.583587855489434  LUMO = 1.01402634545966
  mo_energy =
[-1.18580410e+02 -1.23111364e+01 -9.56321805e+00 -9.56321805e+00
 -9.56321805e+00 -1.27044948e+00 -5.83587855e-01 -5.83587855e-01
 -5.83587855e-01  1.01402635e+00  1.01402635e+00  1.01402635e+00
  1.10818694e+00  7.29117118e+00  7.29117118e+00  7.29117118e+00
  1.20598968e+01  3.34379498e+01  3.34379498e+01  3.34379498e+01
  1.04428293e+02  1.28994356e+02  1.28994356e+02  1.28994356e+02
  4.83318889e+02  4.83318889e+02  4.83318889e+02  5.85365032e+02
  1.33515182e+03  1.33515182e+03  1.33515182e+03  2.65375554e+03
  3.02939075e+03  3.02939075e+03  3.02939075e+03  6.64982794e+03
  6.64982794e+03  6.64982794e+03  9.05933013e+03  2.54149678e+04
  7.61573751e+04]
E1 = -728.266866497563  E_coul = 201.53102112083357
cycle= 6 E= -526.735845376729  delta_E= -6e-11  |g|= 1.8e-06  |ddm|= 1.81e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.266866497563  E_coul = 201.53102112083357
  HOMO = -0.583587842482  LUMO = 1.01402641285606
  mo_energy =
[-1.18580410e+02 -1.23111362e+01 -9.56321793e+00 -9.56321793e+00
 -9.56321793e+00 -1.27044907e+00 -5.83587842e-01 -5.83587842e-01
 -5.83587842e-01  1.01402641e+00  1.01402641e+00  1.01402641e+00
  1.10818733e+00  7.29117128e+00  7.29117128e+00  7.29117128e+00
  1.20598970e+01  3.34379500e+01  3.34379500e+01  3.34379500e+01
  1.04428293e+02  1.28994356e+02  1.28994356e+02  1.28994356e+02
  4.83318889e+02  4.83318889e+02  4.83318889e+02  5.85365033e+02
  1.33515182e+03  1.33515182e+03  1.33515182e+03  2.65375554e+03
  3.02939075e+03  3.02939075e+03  3.02939075e+03  6.64982794e+03
  6.64982794e+03  6.64982794e+03  9.05933013e+03  2.54149678e+04
  7.61573751e+04]
E1 = -728.2668654132963  E_coul = 201.53102003656664
Extra cycle  E= -526.73584537673  delta_E= -2.27e-13  |g|= 3.64e-07  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826561e+04 7.61752148e+03 3.61735108e+03 1.59781647e+03
 3.82856144e+02 1.08147885e+02 3.52588293e+01 7.82614115e+00
 3.01979355e+00 7.31793442e-01 2.54877855e-01 1.36278327e+03
 6.64745013e+02 3.00958840e+02 3.14039556e+02 6.16258105e+01
 7.34330462e+00 2.02305667e+01 7.77789862e-01 2.81293682e+00
 2.22328607e-01]
E = -526.7358453767297
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6560569        1
[INPUT] 0    0    [1    /1   ]  7617.5214757         1
[INPUT] 0    0    [1    /1   ]  3617.3510772         1
[INPUT] 0    0    [1    /1   ]  1597.81646642        1
[INPUT] 0    0    [1    /1   ]  382.856143871        1
[INPUT] 0    0    [1    /1   ]  108.1478849          1
[INPUT] 0    0    [1    /1   ]  35.2588293295        1
[INPUT] 0    0    [1    /1   ]  7.8261411475         1
[INPUT] 0    0    [1    /1   ]  3.01979355346        1
[INPUT] 0    0    [1    /1   ]  0.731793442038       1
[INPUT] 0    0    [1    /1   ]  0.25487785529        1
[INPUT] 1    0    [1    /1   ]  1362.78327346        1
[INPUT] 1    0    [1    /1   ]  664.745013253        1
[INPUT] 1    0    [1    /1   ]  300.958839512        1
[INPUT] 1    0    [1    /1   ]  314.039556333        1
[INPUT] 1    0    [1    /1   ]  61.6258105012        1
[INPUT] 1    0    [1    /1   ]  7.34330462361        1
[INPUT] 1    0    [1    /1   ]  20.2305667143        1
[INPUT] 1    0    [1    /1   ]  0.777789862067       1
[INPUT] 1    0    [1    /1   ]  2.81293682042        1
[INPUT] 1    0    [1    /1   ]  0.222328607027       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656056913598, 1.0]], [0, [7617.521475704918, 1.0]], [0, [3617.351077201133, 1.0]], [0, [1597.8164664247918, 1.0]], [0, [382.8561438713723, 1.0]], [0, [108.14788489982989, 1.0]], [0, [35.258829329521305, 1.0]], [0, [7.826141147503149, 1.0]], [0, [3.019793553463489, 1.0]], [0, [0.7317934420379526, 1.0]], [0, [0.2548778552897309, 1.0]], [1, [1362.7832734604085, 1.0]], [1, [664.745013253015, 1.0]], [1, [300.9588395120433, 1.0]], [1, [314.03955633275893, 1.0]], [1, [61.625810501188354, 1.0]], [1, [7.343304623606925, 1.0]], [1, [20.230566714319895, 1.0]], [1, [0.777789862067454, 1.0]], [1, [2.8129368204168337, 1.0]], [1, [0.22232860702654295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65605691]
bas 1, expnt(s) = [7617.5214757]
bas 2, expnt(s) = [3617.3510772]
bas 3, expnt(s) = [1597.81646642]
bas 4, expnt(s) = [382.85614387]
bas 5, expnt(s) = [108.1478849]
bas 6, expnt(s) = [35.25882933]
bas 7, expnt(s) = [7.82614115]
bas 8, expnt(s) = [3.01979355]
bas 9, expnt(s) = [0.73179344]
bas 10, expnt(s) = [0.25487786]
bas 11, expnt(s) = [1362.78327346]
bas 12, expnt(s) = [664.74501325]
bas 13, expnt(s) = [300.95883951]
bas 14, expnt(s) = [314.03955633]
bas 15, expnt(s) = [61.6258105]
bas 16, expnt(s) = [7.34330462]
bas 17, expnt(s) = [20.23056671]
bas 18, expnt(s) = [0.77778986]
bas 19, expnt(s) = [2.81293682]
bas 20, expnt(s) = [0.22232861]
CPU time:       105.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026290e+03 7.61752148e+03 2.06003828e+03
 3.61735108e+03 1.17844148e+03 1.59781647e+03 6.38498959e+02
 3.82856144e+02 2.18671276e+02 1.08147885e+02 8.47283106e+01
 3.52588293e+01 3.65566121e+01 7.82614115e+00 1.18215870e+01
 3.01979355e+00 5.78759276e+00 7.31793442e-01 1.99897061e+00
 2.54877855e-01 9.06283561e-01 1.36278327e+03 2.41556031e+04
 6.64745013e+02 9.84698446e+03 3.00958840e+02 3.65694368e+03
 3.14039556e+02 3.85669093e+03 6.16258105e+01 5.03718264e+02
 7.34330462e+00 3.52654007e+01 2.02305667e+01 1.25168329e+02
 7.77789862e-01 2.13089593e+00 2.81293682e+00 1.06275796e+01
 2.22328607e-01 4.45377811e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993509966908917
cond(S) = 103595.88137377518
E1 = -729.5253679481785  E_coul = 203.17901919881635
init E= -526.346348749362
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555832513612033  LUMO = 1.03305204833615
  mo_energy =
[-1.18327075e+02 -1.22047870e+01 -9.44677421e+00 -9.44677421e+00
 -9.44677421e+00 -1.23974670e+00 -5.55832514e-01 -5.55832514e-01
 -5.55832514e-01  1.03305205e+00  1.03305205e+00  1.03305205e+00
  1.13183330e+00  7.36317509e+00  7.36317509e+00  7.36317509e+00
  1.21431414e+01  3.35597995e+01  3.35597995e+01  3.35597995e+01
  1.04602204e+02  1.29177637e+02  1.29177637e+02  1.29177637e+02
  4.83571583e+02  4.83571583e+02  4.83571583e+02  5.85653861e+02
  1.33545798e+03  1.33545798e+03  1.33545798e+03  2.65419406e+03
  3.02976160e+03  3.02976160e+03  3.02976160e+03  6.65031105e+03
  6.65031105e+03  6.65031105e+03  9.05988817e+03  2.54156196e+04
  7.61581168e+04]
E1 = -727.8136061819364  E_coul = 201.07856767149815
cycle= 1 E= -526.735038510438  delta_E= -0.389  |g|= 0.187  |ddm|= 0.306
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543116
diis-c [-0.29497463  1.        ]
  HOMO = -0.591314854104656  LUMO = 1.00828650344581
  mo_energy =
[-1.18639031e+02 -1.23439508e+01 -9.59732589e+00 -9.59732589e+00
 -9.59732589e+00 -1.27984494e+00 -5.91314854e-01 -5.91314854e-01
 -5.91314854e-01  1.00828650e+00  1.00828650e+00  1.00828650e+00
  1.10061531e+00  7.27086276e+00  7.27086276e+00  7.27086276e+00
  1.20346561e+01  3.34035011e+01  3.34035011e+01  3.34035011e+01
  1.04380264e+02  1.28946067e+02  1.28946067e+02  1.28946067e+02
  4.83260977e+02  4.83260977e+02  4.83260977e+02  5.85305116e+02
  1.33509043e+03  1.33509043e+03  1.33509043e+03  2.65369147e+03
  3.02932750e+03  3.02932750e+03  3.02932750e+03  6.64976335e+03
  6.64976335e+03  6.64976335e+03  9.05926495e+03  2.54149023e+04
  7.61573094e+04]
E1 = -728.3971033675758  E_coul = 201.66132132251403
cycle= 2 E= -526.735782045062  delta_E= -0.000744  |g|= 0.0383  |ddm|= 0.0541
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.076334
diis-c [-0.00332904  0.08470625  0.91529375]
  HOMO = -0.582090874329905  LUMO = 1.01510497811336
  mo_energy =
[-1.18570415e+02 -1.23053403e+01 -9.55704835e+00 -9.55704835e+00
 -9.55704835e+00 -1.26878446e+00 -5.82090874e-01 -5.82090874e-01
 -5.82090874e-01  1.01510498e+00  1.01510498e+00  1.01510498e+00
  1.10950149e+00  7.29495404e+00  7.29495404e+00  7.29495404e+00
  1.20643957e+01  3.34441352e+01  3.34441352e+01  3.34441352e+01
  1.04436552e+02  1.29002728e+02  1.29002728e+02  1.29002728e+02
  4.83328766e+02  4.83328766e+02  4.83328766e+02  5.85375272e+02
  1.33516230e+03  1.33516230e+03  1.33516230e+03  2.65376668e+03
  3.02940163e+03  3.02940163e+03  3.02940163e+03  6.64983923e+03
  6.64983923e+03  6.64983923e+03  9.05934165e+03  2.54149796e+04
  7.61573869e+04]
E1 = -728.2439510517138  E_coul = 201.5081076399902
cycle= 3 E= -526.735843411724  delta_E= -6.14e-05  |g|= 0.00632  |ddm|= 0.0166
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132605
diis-c [-6.89761258e-07 -1.29714596e-03  1.43302655e-01  8.57994491e-01]
  HOMO = -0.583599461533173  LUMO = 1.01401491674608
  mo_energy =
[-1.18580417e+02 -1.23111794e+01 -9.56324434e+00 -9.56324434e+00
 -9.56324434e+00 -1.27048585e+00 -5.83599462e-01 -5.83599462e-01
 -5.83599462e-01  1.01401492e+00  1.01401492e+00  1.01401492e+00
  1.10815404e+00  7.29114576e+00  7.29114576e+00  7.29114576e+00
  1.20598551e+01  3.34379249e+01  3.34379249e+01  3.34379249e+01
  1.04428269e+02  1.28994338e+02  1.28994338e+02  1.28994338e+02
  4.83318881e+02  4.83318881e+02  4.83318881e+02  5.85365033e+02
  1.33515182e+03  1.33515182e+03  1.33515182e+03  2.65375556e+03
  3.02939076e+03  3.02939076e+03  3.02939076e+03  6.64982797e+03
  6.64982797e+03  6.64982797e+03  9.05933017e+03  2.54149679e+04
  7.61573751e+04]
E1 = -728.2669920650981  E_coul = 201.53114669019263
cycle= 4 E= -526.735845374905  delta_E= -1.96e-06  |g|= 0.000103  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000123797
diis-c [-4.54448498e-09  7.37241519e-05 -1.04006451e-02 -6.86030362e-02
  1.07892996e+00]
  HOMO = -0.583580220171869  LUMO = 1.01403143033659
  mo_energy =
[-1.18580378e+02 -1.23111129e+01 -9.56319261e+00 -9.56319261e+00
 -9.56319261e+00 -1.27044327e+00 -5.83580220e-01 -5.83580220e-01
 -5.83580220e-01  1.01403143e+00  1.01403143e+00  1.01403143e+00
  1.10819143e+00  7.29118839e+00  7.29118839e+00  7.29118839e+00
  1.20599154e+01  3.34379745e+01  3.34379745e+01  3.34379745e+01
  1.04428321e+02  1.28994385e+02  1.28994385e+02  1.28994385e+02
  4.83318920e+02  4.83318920e+02  4.83318920e+02  5.85365065e+02
  1.33515185e+03  1.33515185e+03  1.33515185e+03  2.65375557e+03
  3.02939078e+03  3.02939078e+03  3.02939078e+03  6.64982798e+03
  6.64982798e+03  6.64982798e+03  9.05933017e+03  2.54149679e+04
  7.61573751e+04]
E1 = -728.2667801275127  E_coul = 201.53093475084322
cycle= 5 E= -526.735845376669  delta_E= -1.76e-09  |g|= 2.13e-05  |ddm|= 0.00016
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.05287e-05
diis-c [-7.96477874e-11  1.39931027e-05 -1.74658173e-03 -1.34970793e-02
  4.58881783e-02  9.69341490e-01]
  HOMO = -0.583587855489434  LUMO = 1.01402634545966
  mo_energy =
[-1.18580410e+02 -1.23111364e+01 -9.56321805e+00 -9.56321805e+00
 -9.56321805e+00 -1.27044948e+00 -5.83587855e-01 -5.83587855e-01
 -5.83587855e-01  1.01402635e+00  1.01402635e+00  1.01402635e+00
  1.10818694e+00  7.29117118e+00  7.29117118e+00  7.29117118e+00
  1.20598968e+01  3.34379498e+01  3.34379498e+01  3.34379498e+01
  1.04428293e+02  1.28994356e+02  1.28994356e+02  1.28994356e+02
  4.83318889e+02  4.83318889e+02  4.83318889e+02  5.85365032e+02
  1.33515182e+03  1.33515182e+03  1.33515182e+03  2.65375554e+03
  3.02939075e+03  3.02939075e+03  3.02939075e+03  6.64982794e+03
  6.64982794e+03  6.64982794e+03  9.05933013e+03  2.54149678e+04
  7.61573751e+04]
E1 = -728.266866497563  E_coul = 201.53102112083357
cycle= 6 E= -526.735845376729  delta_E= -6e-11  |g|= 1.8e-06  |ddm|= 1.81e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.266866497563  E_coul = 201.53102112083357
  HOMO = -0.583587842482  LUMO = 1.01402641285606
  mo_energy =
[-1.18580410e+02 -1.23111362e+01 -9.56321793e+00 -9.56321793e+00
 -9.56321793e+00 -1.27044907e+00 -5.83587842e-01 -5.83587842e-01
 -5.83587842e-01  1.01402641e+00  1.01402641e+00  1.01402641e+00
  1.10818733e+00  7.29117128e+00  7.29117128e+00  7.29117128e+00
  1.20598970e+01  3.34379500e+01  3.34379500e+01  3.34379500e+01
  1.04428293e+02  1.28994356e+02  1.28994356e+02  1.28994356e+02
  4.83318889e+02  4.83318889e+02  4.83318889e+02  5.85365033e+02
  1.33515182e+03  1.33515182e+03  1.33515182e+03  2.65375554e+03
  3.02939075e+03  3.02939075e+03  3.02939075e+03  6.64982794e+03
  6.64982794e+03  6.64982794e+03  9.05933013e+03  2.54149678e+04
  7.61573751e+04]
E1 = -728.2668654132963  E_coul = 201.53102003656664
Extra cycle  E= -526.73584537673  delta_E= -2.27e-13  |g|= 3.64e-07  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103595.88137377518
E1 = -728.2668654132963  E_coul = 201.53102003656664
init E= -526.73584537673
    CPU time for initialize scf      0.92 sec, wall time      0.24 sec
  HOMO = -0.583587873137677  LUMO = 1.01402640285301
  mo_energy =
[-1.18580410e+02 -1.23111363e+01 -9.56321803e+00 -9.56321803e+00
 -9.56321803e+00 -1.27044903e+00 -5.83587873e-01 -5.83587873e-01
 -5.83587873e-01  1.01402640e+00  1.01402640e+00  1.01402640e+00
  1.10818738e+00  7.29117122e+00  7.29117122e+00  7.29117122e+00
  1.20598970e+01  3.34379499e+01  3.34379499e+01  3.34379499e+01
  1.04428293e+02  1.28994356e+02  1.28994356e+02  1.28994356e+02
  4.83318889e+02  4.83318889e+02  4.83318889e+02  5.85365032e+02
  1.33515182e+03  1.33515182e+03  1.33515182e+03  2.65375554e+03
  3.02939075e+03  3.02939075e+03  3.02939075e+03  6.64982794e+03
  6.64982794e+03  6.64982794e+03  9.05933013e+03  2.54149678e+04
  7.61573751e+04]
E1 = -728.266865640283  E_coul = 201.53102026355285
cycle= 1 E= -526.73584537673  delta_E= -4.55e-13  |g|= 7.61e-08  |ddm|= 5.86e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.266865640283  E_coul = 201.53102026355285
  HOMO = -0.583587870863198  LUMO = 1.01402640694889
  mo_energy =
[-1.18580410e+02 -1.23111363e+01 -9.56321801e+00 -9.56321801e+00
 -9.56321801e+00 -1.27044901e+00 -5.83587871e-01 -5.83587871e-01
 -5.83587871e-01  1.01402641e+00  1.01402641e+00  1.01402641e+00
  1.10818739e+00  7.29117123e+00  7.29117123e+00  7.29117123e+00
  1.20598970e+01  3.34379499e+01  3.34379499e+01  3.34379499e+01
  1.04428293e+02  1.28994356e+02  1.28994356e+02  1.28994356e+02
  4.83318889e+02  4.83318889e+02  4.83318889e+02  5.85365032e+02
  1.33515182e+03  1.33515182e+03  1.33515182e+03  2.65375554e+03
  3.02939075e+03  3.02939075e+03  3.02939075e+03  6.64982794e+03
  6.64982794e+03  6.64982794e+03  9.05933013e+03  2.54149678e+04
  7.61573751e+04]
E1 = -728.2668655597579  E_coul = 201.53102018302758
Extra cycle  E= -526.73584537673  delta_E= -2.27e-13  |g|= 1.52e-08  |ddm|= 1.23e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.37 sec
exp = [2.61826561e+04 7.61752148e+03 3.61735108e+03 1.59781647e+03
 3.82856144e+02 1.08147885e+02 3.52588293e+01 7.82614115e+00
 3.01979355e+00 7.31793442e-01 2.54877855e-01 1.36278327e+03
 6.64745013e+02 3.00958840e+02 3.14039556e+02 6.16258105e+01
 7.34330462e+00 2.02305667e+01 7.77789862e-01 2.81293682e+00
 2.22328607e-01]
grad_E = [-1.51097408e-06  3.23609908e-06 -1.61861682e-06  6.64852544e-05
  6.02343513e-05 -1.08270959e-03 -1.18174703e-03  1.32278109e-03
 -7.47987335e-03  9.86210025e-03 -8.44006643e-03 -5.10946684e-07
  4.95130387e-06  2.32747940e-05  2.00685415e-05  2.38372038e-05
  1.05985619e-03 -3.56822246e-04  7.66233476e-03 -1.43898337e-03
 -2.35540732e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6561329        1
[INPUT] 0    0    [1    /1   ]  7617.52131099        1
[INPUT] 0    0    [1    /1   ]  3617.35115696        1
[INPUT] 0    0    [1    /1   ]  1597.81303398        1
[INPUT] 0    0    [1    /1   ]  382.856470574        1
[INPUT] 0    0    [1    /1   ]  108.171487492        1
[INPUT] 0    0    [1    /1   ]  35.399544047         1
[INPUT] 0    0    [1    /1   ]  7.93541329774        1
[INPUT] 0    0    [1    /1   ]  3.0478512569         1
[INPUT] 0    0    [1    /1   ]  0.685818761663       1
[INPUT] 0    0    [1    /1   ]  0.243994926585       1
[INPUT] 1    0    [1    /1   ]  1362.78329886        1
[INPUT] 1    0    [1    /1   ]  664.744762202        1
[INPUT] 1    0    [1    /1   ]  300.957655422        1
[INPUT] 1    0    [1    /1   ]  314.038535417        1
[INPUT] 1    0    [1    /1   ]  61.6266755603        1
[INPUT] 1    0    [1    /1   ]  7.3466094499         1
[INPUT] 1    0    [1    /1   ]  20.230299203         1
[INPUT] 1    0    [1    /1   ]  0.777822810695       1
[INPUT] 1    0    [1    /1   ]  2.80778788168        1
[INPUT] 1    0    [1    /1   ]  0.221804047757       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656132864868, 1.0]], [0, [7617.521310986805, 1.0]], [0, [3617.3511569574052, 1.0]], [0, [1597.8130339807844, 1.0]], [0, [382.8564705735617, 1.0]], [0, [108.17148749229266, 1.0]], [0, [35.399544046981326, 1.0]], [0, [7.935413297738993, 1.0]], [0, [3.0478512568950418, 1.0]], [0, [0.6858187616627254, 1.0]], [0, [0.24399492658493863, 1.0]], [1, [1362.7832988583796, 1.0]], [1, [664.7447622024737, 1.0]], [1, [300.9576554221117, 1.0]], [1, [314.0385354165417, 1.0]], [1, [61.62667556028216, 1.0]], [1, [7.346609449896549, 1.0]], [1, [20.23029920305, 1.0]], [1, [0.7778228106950936, 1.0]], [1, [2.80778788168231, 1.0]], [1, [0.22180404775682794, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65613286]
bas 1, expnt(s) = [7617.52131099]
bas 2, expnt(s) = [3617.35115696]
bas 3, expnt(s) = [1597.81303398]
bas 4, expnt(s) = [382.85647057]
bas 5, expnt(s) = [108.17148749]
bas 6, expnt(s) = [35.39954405]
bas 7, expnt(s) = [7.9354133]
bas 8, expnt(s) = [3.04785126]
bas 9, expnt(s) = [0.68581876]
bas 10, expnt(s) = [0.24399493]
bas 11, expnt(s) = [1362.78329886]
bas 12, expnt(s) = [664.7447622]
bas 13, expnt(s) = [300.95765542]
bas 14, expnt(s) = [314.03853542]
bas 15, expnt(s) = [61.62667556]
bas 16, expnt(s) = [7.34660945]
bas 17, expnt(s) = [20.2302992]
bas 18, expnt(s) = [0.77782281]
bas 19, expnt(s) = [2.80778788]
bas 20, expnt(s) = [0.22180405]
CPU time:       111.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026291e+03 7.61752131e+03 2.06003824e+03
 3.61735116e+03 1.17844150e+03 1.59781303e+03 6.38497930e+02
 3.82856471e+02 2.18671416e+02 1.08171487e+02 8.47421787e+01
 3.53995440e+01 3.66659782e+01 7.93541330e+00 1.19451659e+01
 3.04785126e+00 5.82787664e+00 6.85818762e-01 1.90402237e+00
 2.43994927e-01 8.77103050e-01 1.36278330e+03 2.41556037e+04
 6.64744762e+02 9.84697981e+03 3.00957655e+02 3.65692570e+03
 3.14038535e+02 3.85667526e+03 6.16266756e+01 5.03727102e+02
 7.34660945e+00 3.52852407e+01 2.02302992e+01 1.25166260e+02
 7.77822811e-01 2.13100877e+00 2.80778788e+00 1.06032686e+01
 2.21804048e-01 4.44064675e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99366246635021
cond(S) = 103509.27375138647
E1 = -729.5263599773492  E_coul = 203.1790600348668
init E= -526.347299942482
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555850204307559  LUMO = 1.03093626950808
  mo_energy =
[-1.18327027e+02 -1.22048471e+01 -9.44675266e+00 -9.44675266e+00
 -9.44675266e+00 -1.23995544e+00 -5.55850204e-01 -5.55850204e-01
 -5.55850204e-01  1.03093627e+00  1.03093627e+00  1.03093627e+00
  1.03787357e+00  7.35337943e+00  7.35337943e+00  7.35337943e+00
  1.20628460e+01  3.35477828e+01  3.35477828e+01  3.35477828e+01
  1.05198289e+02  1.29170838e+02  1.29170838e+02  1.29170838e+02
  4.83568247e+02  4.83568247e+02  4.83568247e+02  5.86570016e+02
  1.33545334e+03  1.33545334e+03  1.33545334e+03  2.65508985e+03
  3.02975433e+03  3.02975433e+03  3.02975433e+03  6.65030196e+03
  6.65030196e+03  6.65030196e+03  9.06072069e+03  2.54164069e+04
  7.61588495e+04]
E1 = -727.8011351866202  E_coul = 201.06567182455768
cycle= 1 E= -526.735463362063  delta_E= -0.388  |g|= 0.188  |ddm|= 0.294
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543072
diis-c [-0.29492665  1.        ]
  HOMO = -0.591671355173145  LUMO = 1.00591242633926
  mo_energy =
[-1.18639856e+02 -1.23450653e+01 -9.59836105e+00 -9.59836105e+00
 -9.59836105e+00 -1.28039476e+00 -5.91671355e-01 -5.91671355e-01
 -5.91671355e-01  1.00591243e+00  1.00591243e+00  1.00591243e+00
  1.00831932e+00  7.26043418e+00  7.26043418e+00  7.26043418e+00
  1.19530556e+01  3.33905297e+01  3.33905297e+01  3.33905297e+01
  1.04974925e+02  1.28938311e+02  1.28938311e+02  1.28938311e+02
  4.83256743e+02  4.83256743e+02  4.83256743e+02  5.86220551e+02
  1.33508513e+03  1.33508513e+03  1.33508513e+03  2.65458661e+03
  3.02931954e+03  3.02931954e+03  3.02931954e+03  6.64975364e+03
  6.64975364e+03  6.64975364e+03  9.06009687e+03  2.54156891e+04
  7.61580415e+04]
E1 = -728.3878341035913  E_coul = 201.65162084784282
cycle= 2 E= -526.736213255748  delta_E= -0.00075  |g|= 0.0384  |ddm|= 0.0545
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0765412
diis-c [-0.00334904  0.08489633  0.91510367]
  HOMO = -0.582370814913799  LUMO = 1.01277803358041
  mo_energy =
[-1.18570959e+02 -1.23062503e+01 -9.55787984e+00 -9.55787984e+00
 -9.55787984e+00 -1.26925379e+00 -5.82370815e-01 -5.82370815e-01
 -5.82370815e-01  1.01277803e+00  1.01277803e+00  1.01277803e+00
  1.01674211e+00  7.28466047e+00  7.28466047e+00  7.28466047e+00
  1.19831582e+01  3.34313730e+01  3.34313730e+01  3.34313730e+01
  1.05031523e+02  1.28995224e+02  1.28995224e+02  1.28995224e+02
  4.83324811e+02  4.83324811e+02  4.83324811e+02  5.86290994e+02
  1.33515729e+03  1.33515729e+03  1.33515729e+03  2.65466212e+03
  3.02939396e+03  3.02939396e+03  3.02939396e+03  6.64982982e+03
  6.64982982e+03  6.64982982e+03  9.06017387e+03  2.54157666e+04
  7.61581194e+04]
E1 = -728.2339123990556  E_coul = 201.49763724422067
cycle= 3 E= -526.736275154835  delta_E= -6.19e-05  |g|= 0.00634  |ddm|= 0.0166
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132914
diis-c [-6.75714656e-07 -1.29350038e-03  1.43290354e-01  8.58003146e-01]
  HOMO = -0.58388830679148  LUMO = 1.01168246215099
  mo_energy =
[-1.18580989e+02 -1.23121077e+01 -9.56409451e+00 -9.56409451e+00
 -9.56409451e+00 -1.27096414e+00 -5.83888307e-01 -5.83888307e-01
 -5.83888307e-01  1.01168246e+00  1.01168246e+00  1.01168246e+00
  1.01546778e+00  7.28084032e+00  7.28084032e+00  7.28084032e+00
  1.19785784e+01  3.34251426e+01  3.34251426e+01  3.34251426e+01
  1.05023207e+02  1.28986809e+02  1.28986809e+02  1.28986809e+02
  4.83314898e+02  4.83314898e+02  4.83314898e+02  5.86280725e+02
  1.33514679e+03  1.33514679e+03  1.33514679e+03  2.65465097e+03
  3.02938307e+03  3.02938307e+03  3.02938307e+03  6.64981852e+03
  6.64981852e+03  6.64981852e+03  9.06016236e+03  2.54157549e+04
  7.61581076e+04]
E1 = -728.2570062736045  E_coul = 201.5207291465412
cycle= 4 E= -526.736277127063  delta_E= -1.97e-06  |g|= 0.000103  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126578
diis-c [-4.45049139e-09  7.57454086e-05 -1.06031454e-02 -7.01693854e-02
  1.08069679e+00]
  HOMO = -0.583870610846092  LUMO = 1.01169785826675
  mo_energy =
[-1.18580955e+02 -1.23120450e+01 -9.56404664e+00 -9.56404664e+00
 -9.56404664e+00 -1.27092315e+00 -5.83870611e-01 -5.83870611e-01
 -5.83870611e-01  1.01169786e+00  1.01169786e+00  1.01169786e+00
  1.01550211e+00  7.28088009e+00  7.28088009e+00  7.28088009e+00
  1.19786359e+01  3.34251884e+01  3.34251884e+01  3.34251884e+01
  1.05023254e+02  1.28986852e+02  1.28986852e+02  1.28986852e+02
  4.83314932e+02  4.83314932e+02  4.83314932e+02  5.86280752e+02
  1.33514681e+03  1.33514681e+03  1.33514681e+03  2.65465097e+03
  3.02938308e+03  3.02938308e+03  3.02938308e+03  6.64981852e+03
  6.64981852e+03  6.64981852e+03  9.06016235e+03  2.54157549e+04
  7.61581075e+04]
E1 = -728.2568027620033  E_coul = 201.52052563314874
cycle= 5 E= -526.736277128855  delta_E= -1.79e-09  |g|= 2.11e-05  |ddm|= 0.000162
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=3.99201e-05
diis-c [-8.13386314e-11  1.40993181e-05 -1.76087764e-03 -1.35435478e-02
  4.55673517e-02  9.69722974e-01]
  HOMO = -0.583878280386507  LUMO = 1.01169275667319
  mo_energy =
[-1.18580987e+02 -1.23120683e+01 -9.56407188e+00 -9.56407188e+00
 -9.56407188e+00 -1.27092934e+00 -5.83878280e-01 -5.83878280e-01
 -5.83878280e-01  1.01169276e+00  1.01169276e+00  1.01169276e+00
  1.01549792e+00  7.28086296e+00  7.28086296e+00  7.28086296e+00
  1.19786173e+01  3.34251639e+01  3.34251639e+01  3.34251639e+01
  1.05023226e+02  1.28986823e+02  1.28986823e+02  1.28986823e+02
  4.83314901e+02  4.83314901e+02  4.83314901e+02  5.86280720e+02
  1.33514678e+03  1.33514678e+03  1.33514678e+03  2.65465094e+03
  3.02938305e+03  3.02938305e+03  3.02938305e+03  6.64981849e+03
  6.64981849e+03  6.64981849e+03  9.06016231e+03  2.54157549e+04
  7.61581075e+04]
E1 = -728.2568875519597  E_coul = 201.5206104230429
cycle= 6 E= -526.736277128917  delta_E= -6.22e-11  |g|= 1.83e-06  |ddm|= 1.86e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2568875519597  E_coul = 201.5206104230429
  HOMO = -0.583878275291256  LUMO = 1.01169281996673
  mo_energy =
[-1.18580986e+02 -1.23120680e+01 -9.56407174e+00 -9.56407174e+00
 -9.56407174e+00 -1.27092893e+00 -5.83878275e-01 -5.83878275e-01
 -5.83878275e-01  1.01169282e+00  1.01169282e+00  1.01169282e+00
  1.01549830e+00  7.28086306e+00  7.28086306e+00  7.28086306e+00
  1.19786176e+01  3.34251641e+01  3.34251641e+01  3.34251641e+01
  1.05023226e+02  1.28986824e+02  1.28986824e+02  1.28986824e+02
  4.83314901e+02  4.83314901e+02  4.83314901e+02  5.86280720e+02
  1.33514678e+03  1.33514678e+03  1.33514678e+03  2.65465094e+03
  3.02938305e+03  3.02938305e+03  3.02938305e+03  6.64981849e+03
  6.64981849e+03  6.64981849e+03  9.06016231e+03  2.54157549e+04
  7.61581075e+04]
E1 = -728.2568862555864  E_coul = 201.520609126669
Extra cycle  E= -526.736277128917  delta_E= -6.82e-13  |g|= 3.76e-07  |ddm|= 3.19e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
exp = [2.61826561e+04 7.61752131e+03 3.61735116e+03 1.59781303e+03
 3.82856471e+02 1.08171487e+02 3.53995440e+01 7.93541330e+00
 3.04785126e+00 6.85818762e-01 2.43994927e-01 1.36278330e+03
 6.64744762e+02 3.00957655e+02 3.14038535e+02 6.16266756e+01
 7.34660945e+00 2.02302992e+01 7.77822811e-01 2.80778788e+00
 2.21804048e-01]
E = -526.7362771289174
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6561329        1
[INPUT] 0    0    [1    /1   ]  7617.52131099        1
[INPUT] 0    0    [1    /1   ]  3617.35115696        1
[INPUT] 0    0    [1    /1   ]  1597.81303398        1
[INPUT] 0    0    [1    /1   ]  382.856470574        1
[INPUT] 0    0    [1    /1   ]  108.171487492        1
[INPUT] 0    0    [1    /1   ]  35.399544047         1
[INPUT] 0    0    [1    /1   ]  7.93541329774        1
[INPUT] 0    0    [1    /1   ]  3.0478512569         1
[INPUT] 0    0    [1    /1   ]  0.685818761663       1
[INPUT] 0    0    [1    /1   ]  0.243994926585       1
[INPUT] 1    0    [1    /1   ]  1362.78329886        1
[INPUT] 1    0    [1    /1   ]  664.744762202        1
[INPUT] 1    0    [1    /1   ]  300.957655422        1
[INPUT] 1    0    [1    /1   ]  314.038535417        1
[INPUT] 1    0    [1    /1   ]  61.6266755603        1
[INPUT] 1    0    [1    /1   ]  7.3466094499         1
[INPUT] 1    0    [1    /1   ]  20.230299203         1
[INPUT] 1    0    [1    /1   ]  0.777822810695       1
[INPUT] 1    0    [1    /1   ]  2.80778788168        1
[INPUT] 1    0    [1    /1   ]  0.221804047757       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656132864868, 1.0]], [0, [7617.521310986805, 1.0]], [0, [3617.3511569574052, 1.0]], [0, [1597.8130339807844, 1.0]], [0, [382.8564705735617, 1.0]], [0, [108.17148749229266, 1.0]], [0, [35.399544046981326, 1.0]], [0, [7.935413297738993, 1.0]], [0, [3.0478512568950418, 1.0]], [0, [0.6858187616627254, 1.0]], [0, [0.24399492658493863, 1.0]], [1, [1362.7832988583796, 1.0]], [1, [664.7447622024737, 1.0]], [1, [300.9576554221117, 1.0]], [1, [314.0385354165417, 1.0]], [1, [61.62667556028216, 1.0]], [1, [7.346609449896549, 1.0]], [1, [20.23029920305, 1.0]], [1, [0.7778228106950936, 1.0]], [1, [2.80778788168231, 1.0]], [1, [0.22180404775682794, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65613286]
bas 1, expnt(s) = [7617.52131099]
bas 2, expnt(s) = [3617.35115696]
bas 3, expnt(s) = [1597.81303398]
bas 4, expnt(s) = [382.85647057]
bas 5, expnt(s) = [108.17148749]
bas 6, expnt(s) = [35.39954405]
bas 7, expnt(s) = [7.9354133]
bas 8, expnt(s) = [3.04785126]
bas 9, expnt(s) = [0.68581876]
bas 10, expnt(s) = [0.24399493]
bas 11, expnt(s) = [1362.78329886]
bas 12, expnt(s) = [664.7447622]
bas 13, expnt(s) = [300.95765542]
bas 14, expnt(s) = [314.03853542]
bas 15, expnt(s) = [61.62667556]
bas 16, expnt(s) = [7.34660945]
bas 17, expnt(s) = [20.2302992]
bas 18, expnt(s) = [0.77782281]
bas 19, expnt(s) = [2.80778788]
bas 20, expnt(s) = [0.22180405]
CPU time:       111.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826561e+04 5.20026291e+03 7.61752131e+03 2.06003824e+03
 3.61735116e+03 1.17844150e+03 1.59781303e+03 6.38497930e+02
 3.82856471e+02 2.18671416e+02 1.08171487e+02 8.47421787e+01
 3.53995440e+01 3.66659782e+01 7.93541330e+00 1.19451659e+01
 3.04785126e+00 5.82787664e+00 6.85818762e-01 1.90402237e+00
 2.43994927e-01 8.77103050e-01 1.36278330e+03 2.41556037e+04
 6.64744762e+02 9.84697981e+03 3.00957655e+02 3.65692570e+03
 3.14038535e+02 3.85667526e+03 6.16266756e+01 5.03727102e+02
 7.34660945e+00 3.52852407e+01 2.02302992e+01 1.25166260e+02
 7.77822811e-01 2.13100877e+00 2.80778788e+00 1.06032686e+01
 2.21804048e-01 4.44064675e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99366246635021
cond(S) = 103509.27375138647
E1 = -729.5263599773492  E_coul = 203.1790600348668
init E= -526.347299942482
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555850204307559  LUMO = 1.03093626950808
  mo_energy =
[-1.18327027e+02 -1.22048471e+01 -9.44675266e+00 -9.44675266e+00
 -9.44675266e+00 -1.23995544e+00 -5.55850204e-01 -5.55850204e-01
 -5.55850204e-01  1.03093627e+00  1.03093627e+00  1.03093627e+00
  1.03787357e+00  7.35337943e+00  7.35337943e+00  7.35337943e+00
  1.20628460e+01  3.35477828e+01  3.35477828e+01  3.35477828e+01
  1.05198289e+02  1.29170838e+02  1.29170838e+02  1.29170838e+02
  4.83568247e+02  4.83568247e+02  4.83568247e+02  5.86570016e+02
  1.33545334e+03  1.33545334e+03  1.33545334e+03  2.65508985e+03
  3.02975433e+03  3.02975433e+03  3.02975433e+03  6.65030196e+03
  6.65030196e+03  6.65030196e+03  9.06072069e+03  2.54164069e+04
  7.61588495e+04]
E1 = -727.8011351866202  E_coul = 201.06567182455768
cycle= 1 E= -526.735463362063  delta_E= -0.388  |g|= 0.188  |ddm|= 0.294
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.543072
diis-c [-0.29492665  1.        ]
  HOMO = -0.591671355173145  LUMO = 1.00591242633926
  mo_energy =
[-1.18639856e+02 -1.23450653e+01 -9.59836105e+00 -9.59836105e+00
 -9.59836105e+00 -1.28039476e+00 -5.91671355e-01 -5.91671355e-01
 -5.91671355e-01  1.00591243e+00  1.00591243e+00  1.00591243e+00
  1.00831932e+00  7.26043418e+00  7.26043418e+00  7.26043418e+00
  1.19530556e+01  3.33905297e+01  3.33905297e+01  3.33905297e+01
  1.04974925e+02  1.28938311e+02  1.28938311e+02  1.28938311e+02
  4.83256743e+02  4.83256743e+02  4.83256743e+02  5.86220551e+02
  1.33508513e+03  1.33508513e+03  1.33508513e+03  2.65458661e+03
  3.02931954e+03  3.02931954e+03  3.02931954e+03  6.64975364e+03
  6.64975364e+03  6.64975364e+03  9.06009687e+03  2.54156891e+04
  7.61580415e+04]
E1 = -728.3878341035913  E_coul = 201.65162084784282
cycle= 2 E= -526.736213255748  delta_E= -0.00075  |g|= 0.0384  |ddm|= 0.0545
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0765412
diis-c [-0.00334904  0.08489633  0.91510367]
  HOMO = -0.582370814913799  LUMO = 1.01277803358041
  mo_energy =
[-1.18570959e+02 -1.23062503e+01 -9.55787984e+00 -9.55787984e+00
 -9.55787984e+00 -1.26925379e+00 -5.82370815e-01 -5.82370815e-01
 -5.82370815e-01  1.01277803e+00  1.01277803e+00  1.01277803e+00
  1.01674211e+00  7.28466047e+00  7.28466047e+00  7.28466047e+00
  1.19831582e+01  3.34313730e+01  3.34313730e+01  3.34313730e+01
  1.05031523e+02  1.28995224e+02  1.28995224e+02  1.28995224e+02
  4.83324811e+02  4.83324811e+02  4.83324811e+02  5.86290994e+02
  1.33515729e+03  1.33515729e+03  1.33515729e+03  2.65466212e+03
  3.02939396e+03  3.02939396e+03  3.02939396e+03  6.64982982e+03
  6.64982982e+03  6.64982982e+03  9.06017387e+03  2.54157666e+04
  7.61581194e+04]
E1 = -728.2339123990556  E_coul = 201.49763724422067
cycle= 3 E= -526.736275154835  delta_E= -6.19e-05  |g|= 0.00634  |ddm|= 0.0166
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132914
diis-c [-6.75714656e-07 -1.29350038e-03  1.43290354e-01  8.58003146e-01]
  HOMO = -0.58388830679148  LUMO = 1.01168246215099
  mo_energy =
[-1.18580989e+02 -1.23121077e+01 -9.56409451e+00 -9.56409451e+00
 -9.56409451e+00 -1.27096414e+00 -5.83888307e-01 -5.83888307e-01
 -5.83888307e-01  1.01168246e+00  1.01168246e+00  1.01168246e+00
  1.01546778e+00  7.28084032e+00  7.28084032e+00  7.28084032e+00
  1.19785784e+01  3.34251426e+01  3.34251426e+01  3.34251426e+01
  1.05023207e+02  1.28986809e+02  1.28986809e+02  1.28986809e+02
  4.83314898e+02  4.83314898e+02  4.83314898e+02  5.86280725e+02
  1.33514679e+03  1.33514679e+03  1.33514679e+03  2.65465097e+03
  3.02938307e+03  3.02938307e+03  3.02938307e+03  6.64981852e+03
  6.64981852e+03  6.64981852e+03  9.06016236e+03  2.54157549e+04
  7.61581076e+04]
E1 = -728.2570062736045  E_coul = 201.5207291465412
cycle= 4 E= -526.736277127063  delta_E= -1.97e-06  |g|= 0.000103  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000126578
diis-c [-4.45049139e-09  7.57454086e-05 -1.06031454e-02 -7.01693854e-02
  1.08069679e+00]
  HOMO = -0.583870610846092  LUMO = 1.01169785826675
  mo_energy =
[-1.18580955e+02 -1.23120450e+01 -9.56404664e+00 -9.56404664e+00
 -9.56404664e+00 -1.27092315e+00 -5.83870611e-01 -5.83870611e-01
 -5.83870611e-01  1.01169786e+00  1.01169786e+00  1.01169786e+00
  1.01550211e+00  7.28088009e+00  7.28088009e+00  7.28088009e+00
  1.19786359e+01  3.34251884e+01  3.34251884e+01  3.34251884e+01
  1.05023254e+02  1.28986852e+02  1.28986852e+02  1.28986852e+02
  4.83314932e+02  4.83314932e+02  4.83314932e+02  5.86280752e+02
  1.33514681e+03  1.33514681e+03  1.33514681e+03  2.65465097e+03
  3.02938308e+03  3.02938308e+03  3.02938308e+03  6.64981852e+03
  6.64981852e+03  6.64981852e+03  9.06016235e+03  2.54157549e+04
  7.61581075e+04]
E1 = -728.2568027620033  E_coul = 201.52052563314874
cycle= 5 E= -526.736277128855  delta_E= -1.79e-09  |g|= 2.11e-05  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.99201e-05
diis-c [-8.13386314e-11  1.40993181e-05 -1.76087764e-03 -1.35435478e-02
  4.55673517e-02  9.69722974e-01]
  HOMO = -0.583878280386507  LUMO = 1.01169275667319
  mo_energy =
[-1.18580987e+02 -1.23120683e+01 -9.56407188e+00 -9.56407188e+00
 -9.56407188e+00 -1.27092934e+00 -5.83878280e-01 -5.83878280e-01
 -5.83878280e-01  1.01169276e+00  1.01169276e+00  1.01169276e+00
  1.01549792e+00  7.28086296e+00  7.28086296e+00  7.28086296e+00
  1.19786173e+01  3.34251639e+01  3.34251639e+01  3.34251639e+01
  1.05023226e+02  1.28986823e+02  1.28986823e+02  1.28986823e+02
  4.83314901e+02  4.83314901e+02  4.83314901e+02  5.86280720e+02
  1.33514678e+03  1.33514678e+03  1.33514678e+03  2.65465094e+03
  3.02938305e+03  3.02938305e+03  3.02938305e+03  6.64981849e+03
  6.64981849e+03  6.64981849e+03  9.06016231e+03  2.54157549e+04
  7.61581075e+04]
E1 = -728.2568875519597  E_coul = 201.5206104230429
cycle= 6 E= -526.736277128917  delta_E= -6.22e-11  |g|= 1.83e-06  |ddm|= 1.86e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2568875519597  E_coul = 201.5206104230429
  HOMO = -0.583878275291256  LUMO = 1.01169281996673
  mo_energy =
[-1.18580986e+02 -1.23120680e+01 -9.56407174e+00 -9.56407174e+00
 -9.56407174e+00 -1.27092893e+00 -5.83878275e-01 -5.83878275e-01
 -5.83878275e-01  1.01169282e+00  1.01169282e+00  1.01169282e+00
  1.01549830e+00  7.28086306e+00  7.28086306e+00  7.28086306e+00
  1.19786176e+01  3.34251641e+01  3.34251641e+01  3.34251641e+01
  1.05023226e+02  1.28986824e+02  1.28986824e+02  1.28986824e+02
  4.83314901e+02  4.83314901e+02  4.83314901e+02  5.86280720e+02
  1.33514678e+03  1.33514678e+03  1.33514678e+03  2.65465094e+03
  3.02938305e+03  3.02938305e+03  3.02938305e+03  6.64981849e+03
  6.64981849e+03  6.64981849e+03  9.06016231e+03  2.54157549e+04
  7.61581075e+04]
E1 = -728.2568862555864  E_coul = 201.520609126669
Extra cycle  E= -526.736277128917  delta_E= -6.82e-13  |g|= 3.76e-07  |ddm|= 3.19e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103509.27375138647
E1 = -728.2568862555864  E_coul = 201.520609126669
init E= -526.736277128917
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583878312435667  LUMO = 1.01169280574796
  mo_energy =
[-1.18580986e+02 -1.23120681e+01 -9.56407186e+00 -9.56407186e+00
 -9.56407186e+00 -1.27092889e+00 -5.83878312e-01 -5.83878312e-01
 -5.83878312e-01  1.01169281e+00  1.01169281e+00  1.01169281e+00
  1.01549835e+00  7.28086299e+00  7.28086299e+00  7.28086299e+00
  1.19786176e+01  3.34251640e+01  3.34251640e+01  3.34251640e+01
  1.05023226e+02  1.28986823e+02  1.28986823e+02  1.28986823e+02
  4.83314901e+02  4.83314901e+02  4.83314901e+02  5.86280720e+02
  1.33514678e+03  1.33514678e+03  1.33514678e+03  2.65465094e+03
  3.02938305e+03  3.02938305e+03  3.02938305e+03  6.64981849e+03
  6.64981849e+03  6.64981849e+03  9.06016231e+03  2.54157549e+04
  7.61581075e+04]
E1 = -728.2568865092358  E_coul = 201.52060938031784
cycle= 1 E= -526.736277128918  delta_E= -4.55e-13  |g|= 7.96e-08  |ddm|= 6.17e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2568865092358  E_coul = 201.52060938031784
  HOMO = -0.583878310182953  LUMO = 1.01169280995248
  mo_energy =
[-1.18580986e+02 -1.23120681e+01 -9.56407184e+00 -9.56407184e+00
 -9.56407184e+00 -1.27092887e+00 -5.83878310e-01 -5.83878310e-01
 -5.83878310e-01  1.01169281e+00  1.01169281e+00  1.01169281e+00
  1.01549836e+00  7.28086300e+00  7.28086300e+00  7.28086300e+00
  1.19786176e+01  3.34251640e+01  3.34251640e+01  3.34251640e+01
  1.05023226e+02  1.28986823e+02  1.28986823e+02  1.28986823e+02
  4.83314901e+02  4.83314901e+02  4.83314901e+02  5.86280720e+02
  1.33514678e+03  1.33514678e+03  1.33514678e+03  2.65465094e+03
  3.02938305e+03  3.02938305e+03  3.02938305e+03  6.64981849e+03
  6.64981849e+03  6.64981849e+03  9.06016231e+03  2.54157549e+04
  7.61581075e+04]
E1 = -728.2568864142794  E_coul = 201.5206092853625
Extra cycle  E= -526.736277128917  delta_E= 1.02e-12  |g|= 1.61e-08  |ddm|= 1.31e-07
    CPU time for scf_cycle      1.06 sec, wall time      0.38 sec
exp = [2.61826561e+04 7.61752131e+03 3.61735116e+03 1.59781303e+03
 3.82856471e+02 1.08171487e+02 3.53995440e+01 7.93541330e+00
 3.04785126e+00 6.85818762e-01 2.43994927e-01 1.36278330e+03
 6.64744762e+02 3.00957655e+02 3.14038535e+02 6.16266756e+01
 7.34660945e+00 2.02302992e+01 7.77822811e-01 2.80778788e+00
 2.21804048e-01]
grad_E = [-1.50872769e-06  3.21116482e-06 -1.63097763e-06  6.54923798e-05
  9.40926910e-05 -1.39019768e-03 -3.71109195e-04  2.33543109e-03
 -1.00243181e-02  4.24212669e-03 -1.43821923e-03 -5.13505800e-07
  4.91607484e-06  2.30596093e-05  1.98838862e-05  5.08869212e-05
  2.09521379e-03 -6.24719920e-04  1.14220229e-02 -2.98279340e-03
 -3.55613520e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562173        1
[INPUT] 0    0    [1    /1   ]  7617.5211278         1
[INPUT] 0    0    [1    /1   ]  3617.35124566        1
[INPUT] 0    0    [1    /1   ]  1597.80921682        1
[INPUT] 0    0    [1    /1   ]  382.856827343        1
[INPUT] 0    0    [1    /1   ]  108.197863009        1
[INPUT] 0    0    [1    /1   ]  35.5552027012        1
[INPUT] 0    0    [1    /1   ]  8.04804147094        1
[INPUT] 0    0    [1    /1   ]  3.10636963578        1
[INPUT] 0    0    [1    /1   ]  0.643921011872       1
[INPUT] 0    0    [1    /1   ]  0.233667624364       1
[INPUT] 1    0    [1    /1   ]  1362.78332711        1
[INPUT] 1    0    [1    /1   ]  664.74448305         1
[INPUT] 1    0    [1    /1   ]  300.956338856        1
[INPUT] 1    0    [1    /1   ]  314.037400278        1
[INPUT] 1    0    [1    /1   ]  61.6275964825        1
[INPUT] 1    0    [1    /1   ]  7.34782584148        1
[INPUT] 1    0    [1    /1   ]  20.2304999749        1
[INPUT] 1    0    [1    /1   ]  0.777126337168       1
[INPUT] 1    0    [1    /1   ]  2.80592941564        1
[INPUT] 1    0    [1    /1   ]  0.221694759933       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656217331343, 1.0]], [0, [7617.521127803475, 1.0]], [0, [3617.3512456566514, 1.0]], [0, [1597.8092168161268, 1.0]], [0, [382.85682734335614, 1.0]], [0, [108.19786300885927, 1.0]], [0, [35.55520270116406, 1.0]], [0, [8.048041470943852, 1.0]], [0, [3.1063696357831136, 1.0]], [0, [0.6439210118718817, 1.0]], [0, [0.2336676243641857, 1.0]], [1, [1362.7833271071088, 1.0]], [1, [664.7444830501644, 1.0]], [1, [300.95633885613097, 1.0]], [1, [314.0374002783777, 1.0]], [1, [61.62759648247786, 1.0]], [1, [7.347825841482993, 1.0]], [1, [20.230499974894467, 1.0]], [1, [0.7771263371676307, 1.0]], [1, [2.8059294156421353, 1.0]], [1, [0.221694759933373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65621733]
bas 1, expnt(s) = [7617.5211278]
bas 2, expnt(s) = [3617.35124566]
bas 3, expnt(s) = [1597.80921682]
bas 4, expnt(s) = [382.85682734]
bas 5, expnt(s) = [108.19786301]
bas 6, expnt(s) = [35.5552027]
bas 7, expnt(s) = [8.04804147]
bas 8, expnt(s) = [3.10636964]
bas 9, expnt(s) = [0.64392101]
bas 10, expnt(s) = [0.23366762]
bas 11, expnt(s) = [1362.78332711]
bas 12, expnt(s) = [664.74448305]
bas 13, expnt(s) = [300.95633886]
bas 14, expnt(s) = [314.03740028]
bas 15, expnt(s) = [61.62759648]
bas 16, expnt(s) = [7.34782584]
bas 17, expnt(s) = [20.23049997]
bas 18, expnt(s) = [0.77712634]
bas 19, expnt(s) = [2.80592942]
bas 20, expnt(s) = [0.22169476]
CPU time:       117.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826562e+04 5.20026292e+03 7.61752113e+03 2.06003821e+03
 3.61735125e+03 1.17844152e+03 1.59780922e+03 6.38496786e+02
 3.82856827e+02 2.18671569e+02 1.08197863e+02 8.47576753e+01
 3.55552027e+01 3.67868324e+01 8.04804147e+00 1.20720959e+01
 3.10636964e+00 5.91159773e+00 6.43921012e-01 1.81609880e+00
 2.33667624e-01 8.49109953e-01 1.36278333e+03 2.41556043e+04
 6.64744483e+02 9.84697464e+03 3.00956339e+02 3.65690570e+03
 3.14037400e+02 3.85665783e+03 6.16275965e+01 5.03736512e+02
 7.34782584e+00 3.52925436e+01 2.02305000e+01 1.25167813e+02
 7.77126337e-01 2.12862387e+00 2.80592942e+00 1.05944965e+01
 2.21694760e-01 4.43791191e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993757943085065
cond(S) = 103458.09040411493
E1 = -729.5231611670843  E_coul = 203.17642754243593
init E= -526.346733624648
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555879777324629  LUMO = 0.954240732934158
  mo_energy =
[-1.18327339e+02 -1.22051090e+01 -9.44697720e+00 -9.44697720e+00
 -9.44697720e+00 -1.24012237e+00 -5.55879777e-01 -5.55879777e-01
 -5.55879777e-01  9.54240733e-01  1.02991778e+00  1.02991778e+00
  1.02991778e+00  7.34730145e+00  7.34730145e+00  7.34730145e+00
  1.20884578e+01  3.35411678e+01  3.35411678e+01  3.35411678e+01
  1.05990295e+02  1.29167756e+02  1.29167756e+02  1.29167756e+02
  4.83567587e+02  4.83567587e+02  4.83567587e+02  5.87692558e+02
  1.33545084e+03  1.33545084e+03  1.33545084e+03  2.65617420e+03
  3.02974861e+03  3.02974861e+03  3.02974861e+03  6.65029397e+03
  6.65029397e+03  6.65029397e+03  9.06172678e+03  2.54173583e+04
  7.61597349e+04]
E1 = -727.8013460622275  E_coul = 201.06550155344442
cycle= 1 E= -526.735844508783  delta_E= -0.389  |g|= 0.187  |ddm|= 0.292
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542523
diis-c [-0.29433122  1.        ]
  HOMO = -0.591626141223768  LUMO = 0.926592785930217
  mo_energy =
[-1.18639739e+02 -1.23453315e+01 -9.59843066e+00 -9.59843066e+00
 -9.59843066e+00 -1.28044559e+00 -5.91626141e-01 -5.91626141e-01
 -5.91626141e-01  9.26592786e-01  1.00494644e+00  1.00494644e+00
  1.00494644e+00  7.25457760e+00  7.25457760e+00  7.25457760e+00
  1.19779848e+01  3.33841071e+01  3.33841071e+01  3.33841071e+01
  1.05766929e+02  1.28935553e+02  1.28935553e+02  1.28935553e+02
  4.83256528e+02  4.83256528e+02  4.83256528e+02  5.87343630e+02
  1.33508320e+03  1.33508320e+03  1.33508320e+03  2.65567152e+03
  3.02931437e+03  3.02931437e+03  3.02931437e+03  6.64974620e+03
  6.64974620e+03  6.64974620e+03  9.06110353e+03  2.54166410e+04
  7.61589275e+04]
E1 = -728.3863572556523  E_coul = 201.64976652421888
cycle= 2 E= -526.736590731433  delta_E= -0.000746  |g|= 0.0383  |ddm|= 0.0546
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0762932
diis-c [-0.00334021  0.08452257  0.91547743]
  HOMO = -0.582334572012746  LUMO = 0.934514704052817
  mo_energy =
[-1.18571010e+02 -1.23066236e+01 -9.55806275e+00 -9.55806275e+00
 -9.55806275e+00 -1.26932447e+00 -5.82334572e-01 -5.82334572e-01
 -5.82334572e-01  9.34514704e-01  1.01179833e+00  1.01179833e+00
  1.01179833e+00  7.27873959e+00  7.27873959e+00  7.27873959e+00
  1.20082897e+01  3.34248459e+01  3.34248459e+01  3.34248459e+01
  1.05823447e+02  1.28992322e+02  1.28992322e+02  1.28992322e+02
  4.83324431e+02  4.83324431e+02  4.83324431e+02  5.87413903e+02
  1.33515520e+03  1.33515520e+03  1.33515520e+03  2.65574685e+03
  3.02938862e+03  3.02938862e+03  3.02938862e+03  6.64982220e+03
  6.64982220e+03  6.64982220e+03  9.06118035e+03  2.54167184e+04
  7.61590052e+04]
E1 = -728.2332371076071  E_coul = 201.49658510195906
cycle= 3 E= -526.736652005648  delta_E= -6.13e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132375
diis-c [-6.44332743e-07 -1.28219718e-03  1.43238980e-01  8.58043217e-01]
  HOMO = -0.583847200348537  LUMO = 0.93331957917408
  mo_energy =
[-1.18581007e+02 -1.23124582e+01 -9.56425108e+00 -9.56425108e+00
 -9.56425108e+00 -1.27102816e+00 -5.83847200e-01 -5.83847200e-01
 -5.83847200e-01  9.33319579e-01  1.01070715e+00  1.01070715e+00
  1.01070715e+00  7.27493776e+00  7.27493776e+00  7.27493776e+00
  1.20036921e+01  3.34186403e+01  3.34186403e+01  3.34186403e+01
  1.05815151e+02  1.28983937e+02  1.28983937e+02  1.28983937e+02
  4.83314550e+02  4.83314550e+02  4.83314550e+02  5.87403668e+02
  1.33514473e+03  1.33514473e+03  1.33514473e+03  2.65573574e+03
  3.02937776e+03  3.02937776e+03  3.02937776e+03  6.64981095e+03
  6.64981095e+03  6.64981095e+03  9.06116888e+03  2.54167067e+04
  7.61589934e+04]
E1 = -728.2561677487088  E_coul = 201.51951379643842
cycle= 4 E= -526.73665395227  delta_E= -1.95e-06  |g|= 0.000101  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000125954
diis-c [-4.29361062e-09  7.73442406e-05 -1.07865470e-02 -7.13802255e-02
  1.08208943e+00]
  HOMO = -0.583830669345275  LUMO = 0.93335134756804
  mo_energy =
[-1.18580976e+02 -1.23123983e+01 -9.56420580e+00 -9.56420580e+00
 -9.56420580e+00 -1.27098841e+00 -5.83830669e-01 -5.83830669e-01
 -5.83830669e-01  9.33351348e-01  1.01072170e+00  1.01072170e+00
  1.01072170e+00  7.27497553e+00  7.27497553e+00  7.27497553e+00
  1.20037479e+01  3.34186836e+01  3.34186836e+01  3.34186836e+01
  1.05815196e+02  1.28983978e+02  1.28983978e+02  1.28983978e+02
  4.83314582e+02  4.83314582e+02  4.83314582e+02  5.87403692e+02
  1.33514475e+03  1.33514475e+03  1.33514475e+03  2.65573574e+03
  3.02937777e+03  3.02937777e+03  3.02937777e+03  6.64981094e+03
  6.64981094e+03  6.64981094e+03  9.06116886e+03  2.54167067e+04
  7.61589933e+04]
E1 = -728.2559697861773  E_coul = 201.51931583209424
cycle= 5 E= -526.736653954083  delta_E= -1.81e-09  |g|= 2.08e-05  |ddm|= 0.000164
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.90229e-05
diis-c [-8.15134629e-11  1.42880907e-05 -1.79184011e-03 -1.36777758e-02
  4.48686522e-02  9.70586676e-01]
  HOMO = -0.583838306095765  LUMO = 0.933347482708357
  mo_energy =
[-1.18581007e+02 -1.23124212e+01 -9.56423065e+00 -9.56423065e+00
 -9.56423065e+00 -1.27099452e+00 -5.83838306e-01 -5.83838306e-01
 -5.83838306e-01  9.33347483e-01  1.01071663e+00  1.01071663e+00
  1.01071663e+00  7.27495862e+00  7.27495862e+00  7.27495862e+00
  1.20037295e+01  3.34186595e+01  3.34186595e+01  3.34186595e+01
  1.05815168e+02  1.28983949e+02  1.28983949e+02  1.28983949e+02
  4.83314551e+02  4.83314551e+02  4.83314551e+02  5.87403661e+02
  1.33514472e+03  1.33514472e+03  1.33514472e+03  2.65573571e+03
  3.02937774e+03  3.02937774e+03  3.02937774e+03  6.64981091e+03
  6.64981091e+03  6.64981091e+03  9.06116883e+03  2.54167067e+04
  7.61589933e+04]
E1 = -728.2560520906115  E_coul = 201.51939813646834
cycle= 6 E= -526.736653954143  delta_E= -6.01e-11  |g|= 1.84e-06  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2560520906115  E_coul = 201.51939813646834
  HOMO = -0.583838313753124  LUMO = 0.933347838857208
  mo_energy =
[-1.18581006e+02 -1.23124210e+01 -9.56423051e+00 -9.56423051e+00
 -9.56423051e+00 -1.27099411e+00 -5.83838314e-01 -5.83838314e-01
 -5.83838314e-01  9.33347839e-01  1.01071668e+00  1.01071668e+00
  1.01071668e+00  7.27495872e+00  7.27495872e+00  7.27495872e+00
  1.20037297e+01  3.34186597e+01  3.34186597e+01  3.34186597e+01
  1.05815169e+02  1.28983950e+02  1.28983950e+02  1.28983950e+02
  4.83314552e+02  4.83314552e+02  4.83314552e+02  5.87403661e+02
  1.33514472e+03  1.33514472e+03  1.33514472e+03  2.65573571e+03
  3.02937774e+03  3.02937774e+03  3.02937774e+03  6.64981091e+03
  6.64981091e+03  6.64981091e+03  9.06116883e+03  2.54167067e+04
  7.61589933e+04]
E1 = -728.2560506506766  E_coul = 201.51939669653197
Extra cycle  E= -526.736653954145  delta_E= -1.36e-12  |g|= 3.81e-07  |ddm|= 3.29e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.28 sec
exp = [2.61826562e+04 7.61752113e+03 3.61735125e+03 1.59780922e+03
 3.82856827e+02 1.08197863e+02 3.55552027e+01 8.04804147e+00
 3.10636964e+00 6.43921012e-01 2.33667624e-01 1.36278333e+03
 6.64744483e+02 3.00956339e+02 3.14037400e+02 6.16275965e+01
 7.34782584e+00 2.02305000e+01 7.77126337e-01 2.80592942e+00
 2.21694760e-01]
E = -526.7366539541446
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562173        1
[INPUT] 0    0    [1    /1   ]  7617.5211278         1
[INPUT] 0    0    [1    /1   ]  3617.35124566        1
[INPUT] 0    0    [1    /1   ]  1597.80921682        1
[INPUT] 0    0    [1    /1   ]  382.856827343        1
[INPUT] 0    0    [1    /1   ]  108.197863009        1
[INPUT] 0    0    [1    /1   ]  35.5552027012        1
[INPUT] 0    0    [1    /1   ]  8.04804147094        1
[INPUT] 0    0    [1    /1   ]  3.10636963578        1
[INPUT] 0    0    [1    /1   ]  0.643921011872       1
[INPUT] 0    0    [1    /1   ]  0.233667624364       1
[INPUT] 1    0    [1    /1   ]  1362.78332711        1
[INPUT] 1    0    [1    /1   ]  664.74448305         1
[INPUT] 1    0    [1    /1   ]  300.956338856        1
[INPUT] 1    0    [1    /1   ]  314.037400278        1
[INPUT] 1    0    [1    /1   ]  61.6275964825        1
[INPUT] 1    0    [1    /1   ]  7.34782584148        1
[INPUT] 1    0    [1    /1   ]  20.2304999749        1
[INPUT] 1    0    [1    /1   ]  0.777126337168       1
[INPUT] 1    0    [1    /1   ]  2.80592941564        1
[INPUT] 1    0    [1    /1   ]  0.221694759933       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656217331343, 1.0]], [0, [7617.521127803475, 1.0]], [0, [3617.3512456566514, 1.0]], [0, [1597.8092168161268, 1.0]], [0, [382.85682734335614, 1.0]], [0, [108.19786300885927, 1.0]], [0, [35.55520270116406, 1.0]], [0, [8.048041470943852, 1.0]], [0, [3.1063696357831136, 1.0]], [0, [0.6439210118718817, 1.0]], [0, [0.2336676243641857, 1.0]], [1, [1362.7833271071088, 1.0]], [1, [664.7444830501644, 1.0]], [1, [300.95633885613097, 1.0]], [1, [314.0374002783777, 1.0]], [1, [61.62759648247786, 1.0]], [1, [7.347825841482993, 1.0]], [1, [20.230499974894467, 1.0]], [1, [0.7771263371676307, 1.0]], [1, [2.8059294156421353, 1.0]], [1, [0.221694759933373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65621733]
bas 1, expnt(s) = [7617.5211278]
bas 2, expnt(s) = [3617.35124566]
bas 3, expnt(s) = [1597.80921682]
bas 4, expnt(s) = [382.85682734]
bas 5, expnt(s) = [108.19786301]
bas 6, expnt(s) = [35.5552027]
bas 7, expnt(s) = [8.04804147]
bas 8, expnt(s) = [3.10636964]
bas 9, expnt(s) = [0.64392101]
bas 10, expnt(s) = [0.23366762]
bas 11, expnt(s) = [1362.78332711]
bas 12, expnt(s) = [664.74448305]
bas 13, expnt(s) = [300.95633886]
bas 14, expnt(s) = [314.03740028]
bas 15, expnt(s) = [61.62759648]
bas 16, expnt(s) = [7.34782584]
bas 17, expnt(s) = [20.23049997]
bas 18, expnt(s) = [0.77712634]
bas 19, expnt(s) = [2.80592942]
bas 20, expnt(s) = [0.22169476]
CPU time:       117.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826562e+04 5.20026292e+03 7.61752113e+03 2.06003821e+03
 3.61735125e+03 1.17844152e+03 1.59780922e+03 6.38496786e+02
 3.82856827e+02 2.18671569e+02 1.08197863e+02 8.47576753e+01
 3.55552027e+01 3.67868324e+01 8.04804147e+00 1.20720959e+01
 3.10636964e+00 5.91159773e+00 6.43921012e-01 1.81609880e+00
 2.33667624e-01 8.49109953e-01 1.36278333e+03 2.41556043e+04
 6.64744483e+02 9.84697464e+03 3.00956339e+02 3.65690570e+03
 3.14037400e+02 3.85665783e+03 6.16275965e+01 5.03736512e+02
 7.34782584e+00 3.52925436e+01 2.02305000e+01 1.25167813e+02
 7.77126337e-01 2.12862387e+00 2.80592942e+00 1.05944965e+01
 2.21694760e-01 4.43791191e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993757943085065
cond(S) = 103458.09040411493
E1 = -729.5231611670843  E_coul = 203.17642754243593
init E= -526.346733624648
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555879777324629  LUMO = 0.954240732934158
  mo_energy =
[-1.18327339e+02 -1.22051090e+01 -9.44697720e+00 -9.44697720e+00
 -9.44697720e+00 -1.24012237e+00 -5.55879777e-01 -5.55879777e-01
 -5.55879777e-01  9.54240733e-01  1.02991778e+00  1.02991778e+00
  1.02991778e+00  7.34730145e+00  7.34730145e+00  7.34730145e+00
  1.20884578e+01  3.35411678e+01  3.35411678e+01  3.35411678e+01
  1.05990295e+02  1.29167756e+02  1.29167756e+02  1.29167756e+02
  4.83567587e+02  4.83567587e+02  4.83567587e+02  5.87692558e+02
  1.33545084e+03  1.33545084e+03  1.33545084e+03  2.65617420e+03
  3.02974861e+03  3.02974861e+03  3.02974861e+03  6.65029397e+03
  6.65029397e+03  6.65029397e+03  9.06172678e+03  2.54173583e+04
  7.61597349e+04]
E1 = -727.8013460622275  E_coul = 201.06550155344442
cycle= 1 E= -526.735844508783  delta_E= -0.389  |g|= 0.187  |ddm|= 0.292
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542523
diis-c [-0.29433122  1.        ]
  HOMO = -0.591626141223768  LUMO = 0.926592785930217
  mo_energy =
[-1.18639739e+02 -1.23453315e+01 -9.59843066e+00 -9.59843066e+00
 -9.59843066e+00 -1.28044559e+00 -5.91626141e-01 -5.91626141e-01
 -5.91626141e-01  9.26592786e-01  1.00494644e+00  1.00494644e+00
  1.00494644e+00  7.25457760e+00  7.25457760e+00  7.25457760e+00
  1.19779848e+01  3.33841071e+01  3.33841071e+01  3.33841071e+01
  1.05766929e+02  1.28935553e+02  1.28935553e+02  1.28935553e+02
  4.83256528e+02  4.83256528e+02  4.83256528e+02  5.87343630e+02
  1.33508320e+03  1.33508320e+03  1.33508320e+03  2.65567152e+03
  3.02931437e+03  3.02931437e+03  3.02931437e+03  6.64974620e+03
  6.64974620e+03  6.64974620e+03  9.06110353e+03  2.54166410e+04
  7.61589275e+04]
E1 = -728.3863572556523  E_coul = 201.64976652421888
cycle= 2 E= -526.736590731433  delta_E= -0.000746  |g|= 0.0383  |ddm|= 0.0546
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0762932
diis-c [-0.00334021  0.08452257  0.91547743]
  HOMO = -0.582334572012746  LUMO = 0.934514704052817
  mo_energy =
[-1.18571010e+02 -1.23066236e+01 -9.55806275e+00 -9.55806275e+00
 -9.55806275e+00 -1.26932447e+00 -5.82334572e-01 -5.82334572e-01
 -5.82334572e-01  9.34514704e-01  1.01179833e+00  1.01179833e+00
  1.01179833e+00  7.27873959e+00  7.27873959e+00  7.27873959e+00
  1.20082897e+01  3.34248459e+01  3.34248459e+01  3.34248459e+01
  1.05823447e+02  1.28992322e+02  1.28992322e+02  1.28992322e+02
  4.83324431e+02  4.83324431e+02  4.83324431e+02  5.87413903e+02
  1.33515520e+03  1.33515520e+03  1.33515520e+03  2.65574685e+03
  3.02938862e+03  3.02938862e+03  3.02938862e+03  6.64982220e+03
  6.64982220e+03  6.64982220e+03  9.06118035e+03  2.54167184e+04
  7.61590052e+04]
E1 = -728.2332371076071  E_coul = 201.49658510195906
cycle= 3 E= -526.736652005648  delta_E= -6.13e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132375
diis-c [-6.44332743e-07 -1.28219718e-03  1.43238980e-01  8.58043217e-01]
  HOMO = -0.583847200348537  LUMO = 0.93331957917408
  mo_energy =
[-1.18581007e+02 -1.23124582e+01 -9.56425108e+00 -9.56425108e+00
 -9.56425108e+00 -1.27102816e+00 -5.83847200e-01 -5.83847200e-01
 -5.83847200e-01  9.33319579e-01  1.01070715e+00  1.01070715e+00
  1.01070715e+00  7.27493776e+00  7.27493776e+00  7.27493776e+00
  1.20036921e+01  3.34186403e+01  3.34186403e+01  3.34186403e+01
  1.05815151e+02  1.28983937e+02  1.28983937e+02  1.28983937e+02
  4.83314550e+02  4.83314550e+02  4.83314550e+02  5.87403668e+02
  1.33514473e+03  1.33514473e+03  1.33514473e+03  2.65573574e+03
  3.02937776e+03  3.02937776e+03  3.02937776e+03  6.64981095e+03
  6.64981095e+03  6.64981095e+03  9.06116888e+03  2.54167067e+04
  7.61589934e+04]
E1 = -728.2561677487088  E_coul = 201.51951379643842
cycle= 4 E= -526.73665395227  delta_E= -1.95e-06  |g|= 0.000101  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000125954
diis-c [-4.29361062e-09  7.73442406e-05 -1.07865470e-02 -7.13802255e-02
  1.08208943e+00]
  HOMO = -0.583830669345275  LUMO = 0.93335134756804
  mo_energy =
[-1.18580976e+02 -1.23123983e+01 -9.56420580e+00 -9.56420580e+00
 -9.56420580e+00 -1.27098841e+00 -5.83830669e-01 -5.83830669e-01
 -5.83830669e-01  9.33351348e-01  1.01072170e+00  1.01072170e+00
  1.01072170e+00  7.27497553e+00  7.27497553e+00  7.27497553e+00
  1.20037479e+01  3.34186836e+01  3.34186836e+01  3.34186836e+01
  1.05815196e+02  1.28983978e+02  1.28983978e+02  1.28983978e+02
  4.83314582e+02  4.83314582e+02  4.83314582e+02  5.87403692e+02
  1.33514475e+03  1.33514475e+03  1.33514475e+03  2.65573574e+03
  3.02937777e+03  3.02937777e+03  3.02937777e+03  6.64981094e+03
  6.64981094e+03  6.64981094e+03  9.06116886e+03  2.54167067e+04
  7.61589933e+04]
E1 = -728.2559697861773  E_coul = 201.51931583209424
cycle= 5 E= -526.736653954083  delta_E= -1.81e-09  |g|= 2.08e-05  |ddm|= 0.000164
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.90229e-05
diis-c [-8.15134629e-11  1.42880907e-05 -1.79184011e-03 -1.36777758e-02
  4.48686522e-02  9.70586676e-01]
  HOMO = -0.583838306095765  LUMO = 0.933347482708357
  mo_energy =
[-1.18581007e+02 -1.23124212e+01 -9.56423065e+00 -9.56423065e+00
 -9.56423065e+00 -1.27099452e+00 -5.83838306e-01 -5.83838306e-01
 -5.83838306e-01  9.33347483e-01  1.01071663e+00  1.01071663e+00
  1.01071663e+00  7.27495862e+00  7.27495862e+00  7.27495862e+00
  1.20037295e+01  3.34186595e+01  3.34186595e+01  3.34186595e+01
  1.05815168e+02  1.28983949e+02  1.28983949e+02  1.28983949e+02
  4.83314551e+02  4.83314551e+02  4.83314551e+02  5.87403661e+02
  1.33514472e+03  1.33514472e+03  1.33514472e+03  2.65573571e+03
  3.02937774e+03  3.02937774e+03  3.02937774e+03  6.64981091e+03
  6.64981091e+03  6.64981091e+03  9.06116883e+03  2.54167067e+04
  7.61589933e+04]
E1 = -728.2560520906115  E_coul = 201.51939813646834
cycle= 6 E= -526.736653954143  delta_E= -6.01e-11  |g|= 1.84e-06  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2560520906115  E_coul = 201.51939813646834
  HOMO = -0.583838313753124  LUMO = 0.933347838857208
  mo_energy =
[-1.18581006e+02 -1.23124210e+01 -9.56423051e+00 -9.56423051e+00
 -9.56423051e+00 -1.27099411e+00 -5.83838314e-01 -5.83838314e-01
 -5.83838314e-01  9.33347839e-01  1.01071668e+00  1.01071668e+00
  1.01071668e+00  7.27495872e+00  7.27495872e+00  7.27495872e+00
  1.20037297e+01  3.34186597e+01  3.34186597e+01  3.34186597e+01
  1.05815169e+02  1.28983950e+02  1.28983950e+02  1.28983950e+02
  4.83314552e+02  4.83314552e+02  4.83314552e+02  5.87403661e+02
  1.33514472e+03  1.33514472e+03  1.33514472e+03  2.65573571e+03
  3.02937774e+03  3.02937774e+03  3.02937774e+03  6.64981091e+03
  6.64981091e+03  6.64981091e+03  9.06116883e+03  2.54167067e+04
  7.61589933e+04]
E1 = -728.2560506506766  E_coul = 201.51939669653197
Extra cycle  E= -526.736653954145  delta_E= -1.36e-12  |g|= 3.81e-07  |ddm|= 3.29e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103458.09040411493
E1 = -728.2560506506766  E_coul = 201.51939669653197
init E= -526.736653954145
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583838355848664  LUMO = 0.933347879194493
  mo_energy =
[-1.18581007e+02 -1.23124211e+01 -9.56423063e+00 -9.56423063e+00
 -9.56423063e+00 -1.27099407e+00 -5.83838356e-01 -5.83838356e-01
 -5.83838356e-01  9.33347879e-01  1.01071667e+00  1.01071667e+00
  1.01071667e+00  7.27495864e+00  7.27495864e+00  7.27495864e+00
  1.20037297e+01  3.34186595e+01  3.34186595e+01  3.34186595e+01
  1.05815169e+02  1.28983950e+02  1.28983950e+02  1.28983950e+02
  4.83314551e+02  4.83314551e+02  4.83314551e+02  5.87403661e+02
  1.33514472e+03  1.33514472e+03  1.33514472e+03  2.65573571e+03
  3.02937774e+03  3.02937774e+03  3.02937774e+03  6.64981091e+03
  6.64981091e+03  6.64981091e+03  9.06116883e+03  2.54167067e+04
  7.61589933e+04]
E1 = -728.2560509129213  E_coul = 201.51939695877815
cycle= 1 E= -526.736653954143  delta_E= 1.48e-12  |g|= 8.17e-08  |ddm|= 6.42e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2560509129213  E_coul = 201.51939695877815
  HOMO = -0.583838353935376  LUMO = 0.933347896163126
  mo_energy =
[-1.18581006e+02 -1.23124211e+01 -9.56423062e+00 -9.56423062e+00
 -9.56423062e+00 -1.27099405e+00 -5.83838354e-01 -5.83838354e-01
 -5.83838354e-01  9.33347896e-01  1.01071667e+00  1.01071667e+00
  1.01071667e+00  7.27495865e+00  7.27495865e+00  7.27495865e+00
  1.20037297e+01  3.34186596e+01  3.34186596e+01  3.34186596e+01
  1.05815169e+02  1.28983950e+02  1.28983950e+02  1.28983950e+02
  4.83314551e+02  4.83314551e+02  4.83314551e+02  5.87403661e+02
  1.33514472e+03  1.33514472e+03  1.33514472e+03  2.65573571e+03
  3.02937774e+03  3.02937774e+03  3.02937774e+03  6.64981091e+03
  6.64981091e+03  6.64981091e+03  9.06116883e+03  2.54167067e+04
  7.61589933e+04]
E1 = -728.256050809262  E_coul = 201.51939685511752
Extra cycle  E= -526.736653954144  delta_E= -1.36e-12  |g|= 1.67e-08  |ddm|= 1.38e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826562e+04 7.61752113e+03 3.61735125e+03 1.59780922e+03
 3.82856827e+02 1.08197863e+02 3.55552027e+01 8.04804147e+00
 3.10636964e+00 6.43921012e-01 2.33667624e-01 1.36278333e+03
 6.64744483e+02 3.00956339e+02 3.14037400e+02 6.16275965e+01
 7.34782584e+00 2.02305000e+01 7.77126337e-01 2.80592942e+00
 2.21694760e-01]
grad_E = [-1.50648621e-06  3.18678705e-06 -1.64222940e-06  6.45220727e-05
  1.27206310e-04 -1.67602463e-03  2.98970982e-04  1.81686992e-03
 -7.88743459e-03 -3.77631866e-03  5.26805464e-03 -5.14494865e-07
  4.90205840e-06  2.29742002e-05  1.98105926e-05  6.16982571e-05
  2.53842093e-03 -7.32599693e-04  1.03849448e-02 -3.55414992e-03
 -3.26252424e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562772        1
[INPUT] 0    0    [1    /1   ]  7617.52099767        1
[INPUT] 0    0    [1    /1   ]  3617.35130836        1
[INPUT] 0    0    [1    /1   ]  1597.8064997         1
[INPUT] 0    0    [1    /1   ]  382.857458726        1
[INPUT] 0    0    [1    /1   ]  108.213260229        1
[INPUT] 0    0    [1    /1   ]  35.6729941811        1
[INPUT] 0    0    [1    /1   ]  8.12792554081        1
[INPUT] 0    0    [1    /1   ]  3.17197583279        1
[INPUT] 0    0    [1    /1   ]  0.648964901914       1
[INPUT] 0    0    [1    /1   ]  0.235588541256       1
[INPUT] 1    0    [1    /1   ]  1362.78334712        1
[INPUT] 1    0    [1    /1   ]  664.744285053        1
[INPUT] 1    0    [1    /1   ]  300.955404872        1
[INPUT] 1    0    [1    /1   ]  314.036595001        1
[INPUT] 1    0    [1    /1   ]  61.628322624         1
[INPUT] 1    0    [1    /1   ]  7.34653251286        1
[INPUT] 1    0    [1    /1   ]  20.2304526187        1
[INPUT] 1    0    [1    /1   ]  0.776262395295       1
[INPUT] 1    0    [1    /1   ]  2.8104105968         1
[INPUT] 1    0    [1    /1   ]  0.222229422169       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656277224964, 1.0]], [0, [7617.520997673775, 1.0]], [0, [3617.3513083626067, 1.0]], [0, [1597.8064997009285, 1.0]], [0, [382.8574587255692, 1.0]], [0, [108.21326022914597, 1.0]], [0, [35.67299418109048, 1.0]], [0, [8.127925540811543, 1.0]], [0, [3.1719758327902765, 1.0]], [0, [0.6489649019138116, 1.0]], [0, [0.23558854125605955, 1.0]], [1, [1362.783347119085, 1.0]], [1, [664.744285053234, 1.0]], [1, [300.95540487164016, 1.0]], [1, [314.0365950011182, 1.0]], [1, [61.62832262400934, 1.0]], [1, [7.346532512862282, 1.0]], [1, [20.230452618661158, 1.0]], [1, [0.7762623952953139, 1.0]], [1, [2.8104105968038233, 1.0]], [1, [0.22222942216875116, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627722]
bas 1, expnt(s) = [7617.52099767]
bas 2, expnt(s) = [3617.35130836]
bas 3, expnt(s) = [1597.8064997]
bas 4, expnt(s) = [382.85745873]
bas 5, expnt(s) = [108.21326023]
bas 6, expnt(s) = [35.67299418]
bas 7, expnt(s) = [8.12792554]
bas 8, expnt(s) = [3.17197583]
bas 9, expnt(s) = [0.6489649]
bas 10, expnt(s) = [0.23558854]
bas 11, expnt(s) = [1362.78334712]
bas 12, expnt(s) = [664.74428505]
bas 13, expnt(s) = [300.95540487]
bas 14, expnt(s) = [314.036595]
bas 15, expnt(s) = [61.62832262]
bas 16, expnt(s) = [7.34653251]
bas 17, expnt(s) = [20.23045262]
bas 18, expnt(s) = [0.7762624]
bas 19, expnt(s) = [2.8104106]
bas 20, expnt(s) = [0.22222942]
CPU time:       123.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752100e+03 2.06003818e+03
 3.61735131e+03 1.17844153e+03 1.59780650e+03 6.38495972e+02
 3.82857459e+02 2.18671840e+02 1.08213260e+02 8.47667213e+01
 3.56729942e+01 3.68781984e+01 8.12792554e+00 1.21618547e+01
 3.17197583e+00 6.00499191e+00 6.48964902e-01 1.82675764e+00
 2.35588541e-01 8.54339815e-01 1.36278335e+03 2.41556048e+04
 6.64744285e+02 9.84697098e+03 3.00955405e+02 3.65689151e+03
 3.14036595e+02 3.85664547e+03 6.16283226e+01 5.03743931e+02
 7.34653251e+00 3.52847788e+01 2.02304526e+01 1.25167446e+02
 7.76262395e-01 2.12566625e+00 2.81041060e+00 1.06156505e+01
 2.22229422e-01 4.45129461e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993705717509002
cond(S) = 103540.13013255752
E1 = -729.523154613383  E_coul = 203.1773168587146
init E= -526.345837754668
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555805886050566  LUMO = 0.970218131183916
  mo_energy =
[-1.18327492e+02 -1.22050182e+01 -9.44692533e+00 -9.44692533e+00
 -9.44692533e+00 -1.24009768e+00 -5.55805886e-01 -5.55805886e-01
 -5.55805886e-01  9.70218131e-01  1.03141373e+00  1.03141373e+00
  1.03141373e+00  7.35354677e+00  7.35354677e+00  7.35354677e+00
  1.23856343e+01  3.35524931e+01  3.35524931e+01  3.35524931e+01
  1.06854090e+02  1.29177546e+02  1.29177546e+02  1.29177546e+02
  4.83575631e+02  4.83575631e+02  4.83575631e+02  5.88747736e+02
  1.33545646e+03  1.33545646e+03  1.33545646e+03  2.65716391e+03
  3.02975134e+03  3.02975134e+03  3.02975134e+03  6.65029445e+03
  6.65029445e+03  6.65029445e+03  9.06264136e+03  2.54182230e+04
  7.61605396e+04]
E1 = -727.820912834374  E_coul = 201.0848006468378
cycle= 1 E= -526.736112187536  delta_E= -0.39  |g|= 0.186  |ddm|= 0.303
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540925
diis-c [-0.29259935  1.        ]
  HOMO = -0.591216507033915  LUMO = 0.942436315393963
  mo_energy =
[-1.18637800e+02 -1.23440531e+01 -9.59687290e+00 -9.59687290e+00
 -9.59687290e+00 -1.28003985e+00 -5.91216507e-01 -5.91216507e-01
 -5.91216507e-01  9.42436315e-01  1.00671397e+00  1.00671397e+00
  1.00671397e+00  7.26167315e+00  7.26167315e+00  7.26167315e+00
  1.22750124e+01  3.33969080e+01  3.33969080e+01  3.33969080e+01
  1.06632522e+02  1.28947188e+02  1.28947188e+02  1.28947188e+02
  4.83266703e+02  4.83266703e+02  4.83266703e+02  5.88400956e+02
  1.33509101e+03  1.33509101e+03  1.33509101e+03  2.65666347e+03
  3.02931929e+03  3.02931929e+03  3.02931929e+03  6.64974891e+03
  6.64974891e+03  6.64974891e+03  9.06202037e+03  2.54175080e+04
  7.61597345e+04]
E1 = -728.4000888655738  E_coul = 201.66324438547937
cycle= 2 E= -526.736844480094  delta_E= -0.000732  |g|= 0.0379  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0756535
diis-c [-0.00331126  0.08367384  0.91632616]
  HOMO = -0.582015622351445  LUMO = 0.950405149532293
  mo_energy =
[-1.18569661e+02 -1.23057073e+01 -9.55686930e+00 -9.55686930e+00
 -9.55686930e+00 -1.26902168e+00 -5.82015622e-01 -5.82015622e-01
 -5.82015622e-01  9.50405150e-01  1.01350218e+00  1.01350218e+00
  1.01350218e+00  7.28562062e+00  7.28562062e+00  7.28562062e+00
  1.23052942e+01  3.34372817e+01  3.34372817e+01  3.34372817e+01
  1.06688574e+02  1.29003458e+02  1.29003458e+02  1.29003458e+02
  4.83334023e+02  4.83334023e+02  4.83334023e+02  5.88470628e+02
  1.33516239e+03  1.33516239e+03  1.33516239e+03  2.65673817e+03
  3.02939292e+03  3.02939292e+03  3.02939292e+03  6.64982429e+03
  6.64982429e+03  6.64982429e+03  9.06209656e+03  2.54175847e+04
  7.61598116e+04]
E1 = -728.2484838275848  E_coul = 201.51157932305824
cycle= 3 E= -526.736904504527  delta_E= -6e-05  |g|= 0.00628  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131696
diis-c [-6.16029863e-07 -1.26866103e-03  1.43713888e-01  8.57554773e-01]
  HOMO = -0.583519783449773  LUMO = 0.949200149238216
  mo_energy =
[-1.18579619e+02 -1.23115175e+01 -9.56302856e+00 -9.56302856e+00
 -9.56302856e+00 -1.27071446e+00 -5.83519783e-01 -5.83519783e-01
 -5.83519783e-01  9.49200149e-01  1.01241727e+00  1.01241727e+00
  1.01241727e+00  7.28183707e+00  7.28183707e+00  7.28183707e+00
  1.23006774e+01  3.34311050e+01  3.34311050e+01  3.34311050e+01
  1.06680309e+02  1.28995109e+02  1.28995109e+02  1.28995109e+02
  4.83324182e+02  4.83324182e+02  4.83324182e+02  5.88460436e+02
  1.33515196e+03  1.33515196e+03  1.33515196e+03  2.65672711e+03
  3.02938210e+03  3.02938210e+03  3.02938210e+03  6.64981308e+03
  6.64981308e+03  6.64981308e+03  9.06208514e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2712877473931  E_coul = 201.53438131648426
cycle= 4 E= -526.736906430909  delta_E= -1.93e-06  |g|= 0.000102  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121331
diis-c [-4.26376208e-09  7.74701065e-05 -1.08648040e-02 -7.12040189e-02
  1.08199135e+00]
  HOMO = -0.583502905078048  LUMO = 0.949232986183127
  mo_energy =
[-1.18579584e+02 -1.23114563e+01 -9.56298165e+00 -9.56298165e+00
 -9.56298165e+00 -1.27067389e+00 -5.83502905e-01 -5.83502905e-01
 -5.83502905e-01  9.49232986e-01  1.01243216e+00  1.01243216e+00
  1.01243216e+00  7.28187586e+00  7.28187586e+00  7.28187586e+00
  1.23007342e+01  3.34311501e+01  3.34311501e+01  3.34311501e+01
  1.06680356e+02  1.28995152e+02  1.28995152e+02  1.28995152e+02
  4.83324217e+02  4.83324217e+02  4.83324217e+02  5.88460463e+02
  1.33515199e+03  1.33515199e+03  1.33515199e+03  2.65672711e+03
  3.02938212e+03  3.02938212e+03  3.02938212e+03  6.64981308e+03
  6.64981308e+03  6.64981308e+03  9.06208513e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2710839764624  E_coul = 201.53417754366237
cycle= 5 E= -526.7369064328  delta_E= -1.89e-09  |g|= 2.08e-05  |ddm|= 0.000167
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.90563e-05
diis-c [-8.12745596e-11  1.46152056e-05 -1.84500598e-03 -1.39367613e-02
  4.05440471e-02  9.75223105e-01]
  HOMO = -0.583510515239317  LUMO = 0.949229155162429
  mo_energy =
[-1.18579615e+02 -1.23114792e+01 -9.56300644e+00 -9.56300644e+00
 -9.56300644e+00 -1.27067988e+00 -5.83510515e-01 -5.83510515e-01
 -5.83510515e-01  9.49229155e-01  1.01242712e+00  1.01242712e+00
  1.01242712e+00  7.28185901e+00  7.28185901e+00  7.28185901e+00
  1.23007157e+01  3.34311260e+01  3.34311260e+01  3.34311260e+01
  1.06680328e+02  1.28995123e+02  1.28995123e+02  1.28995123e+02
  4.83324186e+02  4.83324186e+02  4.83324186e+02  5.88460432e+02
  1.33515195e+03  1.33515195e+03  1.33515195e+03  2.65672708e+03
  3.02938208e+03  3.02938208e+03  3.02938208e+03  6.64981304e+03
  6.64981304e+03  6.64981304e+03  9.06208509e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2711659427486  E_coul = 201.53425950988736
cycle= 6 E= -526.736906432861  delta_E= -6.12e-11  |g|= 1.79e-06  |ddm|= 1.94e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2711659427486  E_coul = 201.53425950988736
  HOMO = -0.583510504439429  LUMO = 0.949229519051952
  mo_energy =
[-1.18579615e+02 -1.23114789e+01 -9.56300624e+00 -9.56300624e+00
 -9.56300624e+00 -1.27067947e+00 -5.83510504e-01 -5.83510504e-01
 -5.83510504e-01  9.49229519e-01  1.01242719e+00  1.01242719e+00
  1.01242719e+00  7.28185914e+00  7.28185914e+00  7.28185914e+00
  1.23007160e+01  3.34311262e+01  3.34311262e+01  3.34311262e+01
  1.06680328e+02  1.28995124e+02  1.28995124e+02  1.28995124e+02
  4.83324187e+02  4.83324187e+02  4.83324187e+02  5.88460432e+02
  1.33515195e+03  1.33515195e+03  1.33515195e+03  2.65672708e+03
  3.02938208e+03  3.02938208e+03  3.02938208e+03  6.64981304e+03
  6.64981304e+03  6.64981304e+03  9.06208509e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2711643538379  E_coul = 201.53425792097443
Extra cycle  E= -526.736906432863  delta_E= -2.27e-12  |g|= 3.71e-07  |ddm|= 3.17e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826563e+04 7.61752100e+03 3.61735131e+03 1.59780650e+03
 3.82857459e+02 1.08213260e+02 3.56729942e+01 8.12792554e+00
 3.17197583e+00 6.48964902e-01 2.35588541e-01 1.36278335e+03
 6.64744285e+02 3.00955405e+02 3.14036595e+02 6.16283226e+01
 7.34653251e+00 2.02304526e+01 7.76262395e-01 2.81041060e+00
 2.22229422e-01]
E = -526.7369064328634
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562772        1
[INPUT] 0    0    [1    /1   ]  7617.52099767        1
[INPUT] 0    0    [1    /1   ]  3617.35130836        1
[INPUT] 0    0    [1    /1   ]  1597.8064997         1
[INPUT] 0    0    [1    /1   ]  382.857458726        1
[INPUT] 0    0    [1    /1   ]  108.213260229        1
[INPUT] 0    0    [1    /1   ]  35.6729941811        1
[INPUT] 0    0    [1    /1   ]  8.12792554081        1
[INPUT] 0    0    [1    /1   ]  3.17197583279        1
[INPUT] 0    0    [1    /1   ]  0.648964901914       1
[INPUT] 0    0    [1    /1   ]  0.235588541256       1
[INPUT] 1    0    [1    /1   ]  1362.78334712        1
[INPUT] 1    0    [1    /1   ]  664.744285053        1
[INPUT] 1    0    [1    /1   ]  300.955404872        1
[INPUT] 1    0    [1    /1   ]  314.036595001        1
[INPUT] 1    0    [1    /1   ]  61.628322624         1
[INPUT] 1    0    [1    /1   ]  7.34653251286        1
[INPUT] 1    0    [1    /1   ]  20.2304526187        1
[INPUT] 1    0    [1    /1   ]  0.776262395295       1
[INPUT] 1    0    [1    /1   ]  2.8104105968         1
[INPUT] 1    0    [1    /1   ]  0.222229422169       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656277224964, 1.0]], [0, [7617.520997673775, 1.0]], [0, [3617.3513083626067, 1.0]], [0, [1597.8064997009285, 1.0]], [0, [382.8574587255692, 1.0]], [0, [108.21326022914597, 1.0]], [0, [35.67299418109048, 1.0]], [0, [8.127925540811543, 1.0]], [0, [3.1719758327902765, 1.0]], [0, [0.6489649019138116, 1.0]], [0, [0.23558854125605955, 1.0]], [1, [1362.783347119085, 1.0]], [1, [664.744285053234, 1.0]], [1, [300.95540487164016, 1.0]], [1, [314.0365950011182, 1.0]], [1, [61.62832262400934, 1.0]], [1, [7.346532512862282, 1.0]], [1, [20.230452618661158, 1.0]], [1, [0.7762623952953139, 1.0]], [1, [2.8104105968038233, 1.0]], [1, [0.22222942216875116, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627722]
bas 1, expnt(s) = [7617.52099767]
bas 2, expnt(s) = [3617.35130836]
bas 3, expnt(s) = [1597.8064997]
bas 4, expnt(s) = [382.85745873]
bas 5, expnt(s) = [108.21326023]
bas 6, expnt(s) = [35.67299418]
bas 7, expnt(s) = [8.12792554]
bas 8, expnt(s) = [3.17197583]
bas 9, expnt(s) = [0.6489649]
bas 10, expnt(s) = [0.23558854]
bas 11, expnt(s) = [1362.78334712]
bas 12, expnt(s) = [664.74428505]
bas 13, expnt(s) = [300.95540487]
bas 14, expnt(s) = [314.036595]
bas 15, expnt(s) = [61.62832262]
bas 16, expnt(s) = [7.34653251]
bas 17, expnt(s) = [20.23045262]
bas 18, expnt(s) = [0.7762624]
bas 19, expnt(s) = [2.8104106]
bas 20, expnt(s) = [0.22222942]
CPU time:       124.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752100e+03 2.06003818e+03
 3.61735131e+03 1.17844153e+03 1.59780650e+03 6.38495972e+02
 3.82857459e+02 2.18671840e+02 1.08213260e+02 8.47667213e+01
 3.56729942e+01 3.68781984e+01 8.12792554e+00 1.21618547e+01
 3.17197583e+00 6.00499191e+00 6.48964902e-01 1.82675764e+00
 2.35588541e-01 8.54339815e-01 1.36278335e+03 2.41556048e+04
 6.64744285e+02 9.84697098e+03 3.00955405e+02 3.65689151e+03
 3.14036595e+02 3.85664547e+03 6.16283226e+01 5.03743931e+02
 7.34653251e+00 3.52847788e+01 2.02304526e+01 1.25167446e+02
 7.76262395e-01 2.12566625e+00 2.81041060e+00 1.06156505e+01
 2.22229422e-01 4.45129461e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993705717509002
cond(S) = 103540.13013255752
E1 = -729.523154613383  E_coul = 203.1773168587146
init E= -526.345837754668
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555805886050566  LUMO = 0.970218131183916
  mo_energy =
[-1.18327492e+02 -1.22050182e+01 -9.44692533e+00 -9.44692533e+00
 -9.44692533e+00 -1.24009768e+00 -5.55805886e-01 -5.55805886e-01
 -5.55805886e-01  9.70218131e-01  1.03141373e+00  1.03141373e+00
  1.03141373e+00  7.35354677e+00  7.35354677e+00  7.35354677e+00
  1.23856343e+01  3.35524931e+01  3.35524931e+01  3.35524931e+01
  1.06854090e+02  1.29177546e+02  1.29177546e+02  1.29177546e+02
  4.83575631e+02  4.83575631e+02  4.83575631e+02  5.88747736e+02
  1.33545646e+03  1.33545646e+03  1.33545646e+03  2.65716391e+03
  3.02975134e+03  3.02975134e+03  3.02975134e+03  6.65029445e+03
  6.65029445e+03  6.65029445e+03  9.06264136e+03  2.54182230e+04
  7.61605396e+04]
E1 = -727.820912834374  E_coul = 201.0848006468378
cycle= 1 E= -526.736112187536  delta_E= -0.39  |g|= 0.186  |ddm|= 0.303
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540925
diis-c [-0.29259935  1.        ]
  HOMO = -0.591216507033915  LUMO = 0.942436315393963
  mo_energy =
[-1.18637800e+02 -1.23440531e+01 -9.59687290e+00 -9.59687290e+00
 -9.59687290e+00 -1.28003985e+00 -5.91216507e-01 -5.91216507e-01
 -5.91216507e-01  9.42436315e-01  1.00671397e+00  1.00671397e+00
  1.00671397e+00  7.26167315e+00  7.26167315e+00  7.26167315e+00
  1.22750124e+01  3.33969080e+01  3.33969080e+01  3.33969080e+01
  1.06632522e+02  1.28947188e+02  1.28947188e+02  1.28947188e+02
  4.83266703e+02  4.83266703e+02  4.83266703e+02  5.88400956e+02
  1.33509101e+03  1.33509101e+03  1.33509101e+03  2.65666347e+03
  3.02931929e+03  3.02931929e+03  3.02931929e+03  6.64974891e+03
  6.64974891e+03  6.64974891e+03  9.06202037e+03  2.54175080e+04
  7.61597345e+04]
E1 = -728.4000888655738  E_coul = 201.66324438547937
cycle= 2 E= -526.736844480094  delta_E= -0.000732  |g|= 0.0379  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0756535
diis-c [-0.00331126  0.08367384  0.91632616]
  HOMO = -0.582015622351445  LUMO = 0.950405149532293
  mo_energy =
[-1.18569661e+02 -1.23057073e+01 -9.55686930e+00 -9.55686930e+00
 -9.55686930e+00 -1.26902168e+00 -5.82015622e-01 -5.82015622e-01
 -5.82015622e-01  9.50405150e-01  1.01350218e+00  1.01350218e+00
  1.01350218e+00  7.28562062e+00  7.28562062e+00  7.28562062e+00
  1.23052942e+01  3.34372817e+01  3.34372817e+01  3.34372817e+01
  1.06688574e+02  1.29003458e+02  1.29003458e+02  1.29003458e+02
  4.83334023e+02  4.83334023e+02  4.83334023e+02  5.88470628e+02
  1.33516239e+03  1.33516239e+03  1.33516239e+03  2.65673817e+03
  3.02939292e+03  3.02939292e+03  3.02939292e+03  6.64982429e+03
  6.64982429e+03  6.64982429e+03  9.06209656e+03  2.54175847e+04
  7.61598116e+04]
E1 = -728.2484838275848  E_coul = 201.51157932305824
cycle= 3 E= -526.736904504527  delta_E= -6e-05  |g|= 0.00628  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131696
diis-c [-6.16029863e-07 -1.26866103e-03  1.43713888e-01  8.57554773e-01]
  HOMO = -0.583519783449773  LUMO = 0.949200149238216
  mo_energy =
[-1.18579619e+02 -1.23115175e+01 -9.56302856e+00 -9.56302856e+00
 -9.56302856e+00 -1.27071446e+00 -5.83519783e-01 -5.83519783e-01
 -5.83519783e-01  9.49200149e-01  1.01241727e+00  1.01241727e+00
  1.01241727e+00  7.28183707e+00  7.28183707e+00  7.28183707e+00
  1.23006774e+01  3.34311050e+01  3.34311050e+01  3.34311050e+01
  1.06680309e+02  1.28995109e+02  1.28995109e+02  1.28995109e+02
  4.83324182e+02  4.83324182e+02  4.83324182e+02  5.88460436e+02
  1.33515196e+03  1.33515196e+03  1.33515196e+03  2.65672711e+03
  3.02938210e+03  3.02938210e+03  3.02938210e+03  6.64981308e+03
  6.64981308e+03  6.64981308e+03  9.06208514e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2712877473931  E_coul = 201.53438131648426
cycle= 4 E= -526.736906430909  delta_E= -1.93e-06  |g|= 0.000102  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000121331
diis-c [-4.26376208e-09  7.74701065e-05 -1.08648040e-02 -7.12040189e-02
  1.08199135e+00]
  HOMO = -0.583502905078048  LUMO = 0.949232986183127
  mo_energy =
[-1.18579584e+02 -1.23114563e+01 -9.56298165e+00 -9.56298165e+00
 -9.56298165e+00 -1.27067389e+00 -5.83502905e-01 -5.83502905e-01
 -5.83502905e-01  9.49232986e-01  1.01243216e+00  1.01243216e+00
  1.01243216e+00  7.28187586e+00  7.28187586e+00  7.28187586e+00
  1.23007342e+01  3.34311501e+01  3.34311501e+01  3.34311501e+01
  1.06680356e+02  1.28995152e+02  1.28995152e+02  1.28995152e+02
  4.83324217e+02  4.83324217e+02  4.83324217e+02  5.88460463e+02
  1.33515199e+03  1.33515199e+03  1.33515199e+03  2.65672711e+03
  3.02938212e+03  3.02938212e+03  3.02938212e+03  6.64981308e+03
  6.64981308e+03  6.64981308e+03  9.06208513e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2710839764624  E_coul = 201.53417754366237
cycle= 5 E= -526.7369064328  delta_E= -1.89e-09  |g|= 2.08e-05  |ddm|= 0.000167
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.90563e-05
diis-c [-8.12745596e-11  1.46152056e-05 -1.84500598e-03 -1.39367613e-02
  4.05440471e-02  9.75223105e-01]
  HOMO = -0.583510515239317  LUMO = 0.949229155162429
  mo_energy =
[-1.18579615e+02 -1.23114792e+01 -9.56300644e+00 -9.56300644e+00
 -9.56300644e+00 -1.27067988e+00 -5.83510515e-01 -5.83510515e-01
 -5.83510515e-01  9.49229155e-01  1.01242712e+00  1.01242712e+00
  1.01242712e+00  7.28185901e+00  7.28185901e+00  7.28185901e+00
  1.23007157e+01  3.34311260e+01  3.34311260e+01  3.34311260e+01
  1.06680328e+02  1.28995123e+02  1.28995123e+02  1.28995123e+02
  4.83324186e+02  4.83324186e+02  4.83324186e+02  5.88460432e+02
  1.33515195e+03  1.33515195e+03  1.33515195e+03  2.65672708e+03
  3.02938208e+03  3.02938208e+03  3.02938208e+03  6.64981304e+03
  6.64981304e+03  6.64981304e+03  9.06208509e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2711659427486  E_coul = 201.53425950988736
cycle= 6 E= -526.736906432861  delta_E= -6.12e-11  |g|= 1.79e-06  |ddm|= 1.94e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2711659427486  E_coul = 201.53425950988736
  HOMO = -0.583510504439429  LUMO = 0.949229519051952
  mo_energy =
[-1.18579615e+02 -1.23114789e+01 -9.56300624e+00 -9.56300624e+00
 -9.56300624e+00 -1.27067947e+00 -5.83510504e-01 -5.83510504e-01
 -5.83510504e-01  9.49229519e-01  1.01242719e+00  1.01242719e+00
  1.01242719e+00  7.28185914e+00  7.28185914e+00  7.28185914e+00
  1.23007160e+01  3.34311262e+01  3.34311262e+01  3.34311262e+01
  1.06680328e+02  1.28995124e+02  1.28995124e+02  1.28995124e+02
  4.83324187e+02  4.83324187e+02  4.83324187e+02  5.88460432e+02
  1.33515195e+03  1.33515195e+03  1.33515195e+03  2.65672708e+03
  3.02938208e+03  3.02938208e+03  3.02938208e+03  6.64981304e+03
  6.64981304e+03  6.64981304e+03  9.06208509e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2711643538379  E_coul = 201.53425792097443
Extra cycle  E= -526.736906432863  delta_E= -2.27e-12  |g|= 3.71e-07  |ddm|= 3.17e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103540.13013255752
E1 = -728.2711643538379  E_coul = 201.53425792097443
init E= -526.736906432863
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583510548624785  LUMO = 0.949229555475662
  mo_energy =
[-1.18579615e+02 -1.23114790e+01 -9.56300637e+00 -9.56300637e+00
 -9.56300637e+00 -1.27067943e+00 -5.83510549e-01 -5.83510549e-01
 -5.83510549e-01  9.49229555e-01  1.01242717e+00  1.01242717e+00
  1.01242717e+00  7.28185906e+00  7.28185906e+00  7.28185906e+00
  1.23007160e+01  3.34311261e+01  3.34311261e+01  3.34311261e+01
  1.06680328e+02  1.28995123e+02  1.28995123e+02  1.28995123e+02
  4.83324186e+02  4.83324186e+02  4.83324186e+02  5.88460432e+02
  1.33515195e+03  1.33515195e+03  1.33515195e+03  2.65672708e+03
  3.02938208e+03  3.02938208e+03  3.02938208e+03  6.64981304e+03
  6.64981304e+03  6.64981304e+03  9.06208509e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2711646673819  E_coul = 201.5342582345194
cycle= 1 E= -526.736906432862  delta_E= 9.09e-13  |g|= 8.01e-08  |ddm|= 6.13e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2711646673819  E_coul = 201.5342582345194
  HOMO = -0.583510545582078  LUMO = 0.949229573056854
  mo_energy =
[-1.18579615e+02 -1.23114790e+01 -9.56300635e+00 -9.56300635e+00
 -9.56300635e+00 -1.27067941e+00 -5.83510546e-01 -5.83510546e-01
 -5.83510546e-01  9.49229573e-01  1.01242717e+00  1.01242717e+00
  1.01242717e+00  7.28185907e+00  7.28185907e+00  7.28185907e+00
  1.23007160e+01  3.34311261e+01  3.34311261e+01  3.34311261e+01
  1.06680328e+02  1.28995124e+02  1.28995124e+02  1.28995124e+02
  4.83324187e+02  4.83324187e+02  4.83324187e+02  5.88460432e+02
  1.33515195e+03  1.33515195e+03  1.33515195e+03  2.65672708e+03
  3.02938208e+03  3.02938208e+03  3.02938208e+03  6.64981304e+03
  6.64981304e+03  6.64981304e+03  9.06208509e+03  2.54175731e+04
  7.61597998e+04]
E1 = -728.2711645513119  E_coul = 201.53425811844926
Extra cycle  E= -526.736906432863  delta_E= -2.27e-13  |g|= 1.65e-08  |ddm|= 1.33e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826563e+04 7.61752100e+03 3.61735131e+03 1.59780650e+03
 3.82857459e+02 1.08213260e+02 3.56729942e+01 8.12792554e+00
 3.17197583e+00 6.48964902e-01 2.35588541e-01 1.36278335e+03
 6.64744285e+02 3.00955405e+02 3.14036595e+02 6.16283226e+01
 7.34653251e+00 2.02304526e+01 7.76262395e-01 2.81041060e+00
 2.22229422e-01]
grad_E = [-1.50496179e-06  3.17033348e-06 -1.64937600e-06  6.38682208e-05
  1.49290896e-04 -1.85106208e-03  6.17260505e-04  3.03662929e-04
 -1.89882559e-03 -3.84975702e-04 -2.68629538e-03 -5.13122149e-07
  4.92008787e-06  2.30853242e-05  1.99058667e-05  4.71026673e-05
  1.92806467e-03 -5.79450655e-04  4.02123269e-03 -2.44440980e-03
 -1.30156826e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562791        1
[INPUT] 0    0    [1    /1   ]  7617.52099362        1
[INPUT] 0    0    [1    /1   ]  3617.35131042        1
[INPUT] 0    0    [1    /1   ]  1597.80641704        1
[INPUT] 0    0    [1    /1   ]  382.857332503        1
[INPUT] 0    0    [1    /1   ]  108.215069053        1
[INPUT] 0    0    [1    /1   ]  35.6733243086        1
[INPUT] 0    0    [1    /1   ]  8.12543104823        1
[INPUT] 0    0    [1    /1   ]  3.18400520472        1
[INPUT] 0    0    [1    /1   ]  0.656630869614       1
[INPUT] 0    0    [1    /1   ]  0.239419937777       1
[INPUT] 1    0    [1    /1   ]  1362.78334777        1
[INPUT] 1    0    [1    /1   ]  664.744278807        1
[INPUT] 1    0    [1    /1   ]  300.955375532        1
[INPUT] 1    0    [1    /1   ]  314.036569703        1
[INPUT] 1    0    [1    /1   ]  61.6282766232        1
[INPUT] 1    0    [1    /1   ]  7.343766085          1
[INPUT] 1    0    [1    /1   ]  20.2311391842        1
[INPUT] 1    0    [1    /1   ]  0.775907487126       1
[INPUT] 1    0    [1    /1   ]  2.81427510942        1
[INPUT] 1    0    [1    /1   ]  0.222621407234       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656279132018, 1.0]], [0, [7617.520993616995, 1.0]], [0, [3617.3513104220324, 1.0]], [0, [1597.8064170372331, 1.0]], [0, [382.85733250268953, 1.0]], [0, [108.21506905284687, 1.0]], [0, [35.673324308632296, 1.0]], [0, [8.125431048232185, 1.0]], [0, [3.1840052047150498, 1.0]], [0, [0.6566308696141614, 1.0]], [0, [0.23941993777711001, 1.0]], [1, [1362.7833477659653, 1.0]], [1, [664.7442788070879, 1.0]], [1, [300.9553755322581, 1.0]], [1, [314.0365697026123, 1.0]], [1, [61.62827662317766, 1.0]], [1, [7.343766085001037, 1.0]], [1, [20.231139184228578, 1.0]], [1, [0.775907487126115, 1.0]], [1, [2.8142751094201968, 1.0]], [1, [0.22262140723417695, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627913]
bas 1, expnt(s) = [7617.52099362]
bas 2, expnt(s) = [3617.35131042]
bas 3, expnt(s) = [1597.80641704]
bas 4, expnt(s) = [382.8573325]
bas 5, expnt(s) = [108.21506905]
bas 6, expnt(s) = [35.67332431]
bas 7, expnt(s) = [8.12543105]
bas 8, expnt(s) = [3.1840052]
bas 9, expnt(s) = [0.65663087]
bas 10, expnt(s) = [0.23941994]
bas 11, expnt(s) = [1362.78334777]
bas 12, expnt(s) = [664.74427881]
bas 13, expnt(s) = [300.95537553]
bas 14, expnt(s) = [314.0365697]
bas 15, expnt(s) = [61.62827662]
bas 16, expnt(s) = [7.34376609]
bas 17, expnt(s) = [20.23113918]
bas 18, expnt(s) = [0.77590749]
bas 19, expnt(s) = [2.81427511]
bas 20, expnt(s) = [0.22262141]
CPU time:       130.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752099e+03 2.06003818e+03
 3.61735131e+03 1.17844153e+03 1.59780642e+03 6.38495947e+02
 3.82857333e+02 2.18671786e+02 1.08215069e+02 8.47677840e+01
 3.56733243e+01 3.68784544e+01 8.12543105e+00 1.21590552e+01
 3.18400520e+00 6.02206378e+00 6.56630870e-01 1.84291793e+00
 2.39419938e-01 8.64739425e-01 1.36278335e+03 2.41556048e+04
 6.64744279e+02 9.84697086e+03 3.00955376e+02 3.65689107e+03
 3.14036570e+02 3.85664508e+03 6.16282766e+01 5.03743461e+02
 7.34376609e+00 3.52681709e+01 2.02311392e+01 1.25172756e+02
 7.75907487e-01 2.12445150e+00 2.81427511e+00 1.06339002e+01
 2.22621407e-01 4.46111118e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993657379518396
cond(S) = 103576.22848760812
E1 = -729.522435397507  E_coul = 203.17689901784956
init E= -526.345536379657
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555780616231374  LUMO = 0.993625631586579
  mo_energy =
[-1.18327603e+02 -1.22050676e+01 -9.44698177e+00 -9.44698177e+00
 -9.44698177e+00 -1.24006090e+00 -5.55780616e-01 -5.55780616e-01
 -5.55780616e-01  9.93625632e-01  1.03274673e+00  1.03274673e+00
  1.03274673e+00  7.35945507e+00  7.35945507e+00  7.35945507e+00
  1.24712479e+01  3.35599665e+01  3.35599665e+01  3.35599665e+01
  1.06945859e+02  1.29182524e+02  1.29182524e+02  1.29182524e+02
  4.83579302e+02  4.83579302e+02  4.83579302e+02  5.88827529e+02
  1.33545960e+03  1.33545960e+03  1.33545960e+03  2.65723409e+03
  3.02975412e+03  3.02975412e+03  3.02975412e+03  6.65029690e+03
  6.65029690e+03  6.65029690e+03  9.06270558e+03  2.54182836e+04
  7.61605961e+04]
E1 = -727.8333707466663  E_coul = 201.09721097828745
cycle= 1 E= -526.736159768379  delta_E= -0.391  |g|= 0.186  |ddm|= 0.31
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540579
diis-c [-0.29222556  1.        ]
  HOMO = -0.590818490652785  LUMO = 0.965630615009253
  mo_energy =
[-1.18636834e+02 -1.23431928e+01 -9.59595722e+00 -9.59595722e+00
 -9.59595722e+00 -1.27961957e+00 -5.90818491e-01 -5.90818491e-01
 -5.90818491e-01  9.65630615e-01  1.00831114e+00  1.00831114e+00
  1.00831114e+00  7.26828557e+00  7.26828557e+00  7.26828557e+00
  1.23612902e+01  3.34053258e+01  3.34053258e+01  3.34053258e+01
  1.06725382e+02  1.28953203e+02  1.28953203e+02  1.28953203e+02
  4.83271462e+02  4.83271462e+02  4.83271462e+02  5.88481811e+02
  1.33509520e+03  1.33509520e+03  1.33509520e+03  2.65673472e+03
  3.02932314e+03  3.02932314e+03  3.02932314e+03  6.64975242e+03
  6.64975242e+03  6.64975242e+03  9.06208565e+03  2.54175697e+04
  7.61597920e+04]
E1 = -728.4090298219714  E_coul = 201.672145581391
cycle= 2 E= -526.73688424058  delta_E= -0.000724  |g|= 0.0377  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753464
diis-c [-0.0032916   0.08329493  0.91670507]
  HOMO = -0.581682483212557  LUMO = 0.973678179016623
  mo_energy =
[-1.18569016e+02 -1.23050715e+01 -9.55618049e+00 -9.55618049e+00
 -9.55618049e+00 -1.26868134e+00 -5.81682483e-01 -5.81682483e-01
 -5.81682483e-01  9.73678179e-01  1.01505446e+00  1.01505446e+00
  1.01505446e+00  7.29209117e+00  7.29209117e+00  7.29209117e+00
  1.23914136e+01  3.34454731e+01  3.34454731e+01  3.34454731e+01
  1.06781150e+02  1.29009190e+02  1.29009190e+02  1.29009190e+02
  4.83338465e+02  4.83338465e+02  4.83338465e+02  5.88551159e+02
  1.33516626e+03  1.33516626e+03  1.33516626e+03  2.65680909e+03
  3.02939643e+03  3.02939643e+03  3.02939643e+03  6.64982746e+03
  6.64982746e+03  6.64982746e+03  9.06216150e+03  2.54176461e+04
  7.61598687e+04]
E1 = -728.2584097447417  E_coul = 201.52146623216527
cycle= 3 E= -526.736943512576  delta_E= -5.93e-05  |g|= 0.00626  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013122
diis-c [-6.02304614e-07 -1.26458536e-03  1.43778133e-01  8.57486453e-01]
  HOMO = -0.583177900010716  LUMO = 0.972458256977458
  mo_energy =
[-1.18578938e+02 -1.23108584e+01 -9.56231457e+00 -9.56231457e+00
 -9.56231457e+00 -1.27036596e+00 -5.83177900e-01 -5.83177900e-01
 -5.83177900e-01  9.72458257e-01  1.01397533e+00  1.01397533e+00
  1.01397533e+00  7.28832409e+00  7.28832409e+00  7.28832409e+00
  1.23868118e+01  3.34393219e+01  3.34393219e+01  3.34393219e+01
  1.06772916e+02  1.29000872e+02  1.29000872e+02  1.29000872e+02
  4.83328658e+02  4.83328658e+02  4.83328658e+02  5.88541003e+02
  1.33515586e+03  1.33515586e+03  1.33515586e+03  2.65679806e+03
  3.02938565e+03  3.02938565e+03  3.02938565e+03  6.64981629e+03
  6.64981629e+03  6.64981629e+03  9.06215012e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2811100053216  E_coul = 201.54416458468833
cycle= 4 E= -526.736945420633  delta_E= -1.91e-06  |g|= 0.0001  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117305
diis-c [-4.20149777e-09  7.50408864e-05 -1.05833478e-02 -6.91841171e-02
  1.07969242e+00]
  HOMO = -0.583160249191244  LUMO = 0.972491720417204
  mo_energy =
[-1.18578901e+02 -1.23107955e+01 -9.56226556e+00 -9.56226556e+00
 -9.56226556e+00 -1.27032509e+00 -5.83160249e-01 -5.83160249e-01
 -5.83160249e-01  9.72491720e-01  1.01399071e+00  1.01399071e+00
  1.01399071e+00  7.28836435e+00  7.28836435e+00  7.28836435e+00
  1.23868699e+01  3.34393690e+01  3.34393690e+01  3.34393690e+01
  1.06772965e+02  1.29000918e+02  1.29000918e+02  1.29000918e+02
  4.83328696e+02  4.83328696e+02  4.83328696e+02  5.88541033e+02
  1.33515589e+03  1.33515589e+03  1.33515589e+03  2.65679807e+03
  3.02938567e+03  3.02938567e+03  3.02938567e+03  6.64981629e+03
  6.64981629e+03  6.64981629e+03  9.06215011e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2809016082721  E_coul = 201.54395618583908
cycle= 5 E= -526.736945422433  delta_E= -1.8e-09  |g|= 2.07e-05  |ddm|= 0.000163
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.89871e-05
diis-c [-7.83978173e-11  1.45713012e-05 -1.84636092e-03 -1.39408613e-02
  4.17635640e-02  9.74009087e-01]
  HOMO = -0.583167774829067  LUMO = 0.972487838476986
  mo_energy =
[-1.18578932e+02 -1.23108182e+01 -9.56229019e+00 -9.56229019e+00
 -9.56229019e+00 -1.27033105e+00 -5.83167775e-01 -5.83167775e-01
 -5.83167775e-01  9.72487838e-01  1.01398572e+00  1.01398572e+00
  1.01398572e+00  7.28834763e+00  7.28834763e+00  7.28834763e+00
  1.23868516e+01  3.34393451e+01  3.34393451e+01  3.34393451e+01
  1.06772938e+02  1.29000889e+02  1.29000889e+02  1.29000889e+02
  4.83328665e+02  4.83328665e+02  4.83328665e+02  5.88541002e+02
  1.33515586e+03  1.33515586e+03  1.33515586e+03  2.65679804e+03
  3.02938564e+03  3.02938564e+03  3.02938564e+03  6.64981626e+03
  6.64981626e+03  6.64981626e+03  9.06215008e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2809832000808  E_coul = 201.5440377775882
cycle= 6 E= -526.736945422493  delta_E= -5.96e-11  |g|= 1.77e-06  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2809832000808  E_coul = 201.5440377775882
  HOMO = -0.583167781063446  LUMO = 0.972488188935559
  mo_energy =
[-1.18578932e+02 -1.23108180e+01 -9.56229006e+00 -9.56229006e+00
 -9.56229006e+00 -1.27033066e+00 -5.83167781e-01 -5.83167781e-01
 -5.83167781e-01  9.72488189e-01  1.01398578e+00  1.01398578e+00
  1.01398578e+00  7.28834772e+00  7.28834772e+00  7.28834772e+00
  1.23868519e+01  3.34393452e+01  3.34393452e+01  3.34393452e+01
  1.06772938e+02  1.29000890e+02  1.29000890e+02  1.29000890e+02
  4.83328666e+02  4.83328666e+02  4.83328666e+02  5.88541002e+02
  1.33515586e+03  1.33515586e+03  1.33515586e+03  2.65679804e+03
  3.02938564e+03  3.02938564e+03  3.02938564e+03  6.64981626e+03
  6.64981626e+03  6.64981626e+03  9.06215008e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2809818995222  E_coul = 201.54403647702776
Extra cycle  E= -526.736945422495  delta_E= -1.93e-12  |g|= 3.66e-07  |ddm|= 3.12e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.28 sec
exp = [2.61826563e+04 7.61752099e+03 3.61735131e+03 1.59780642e+03
 3.82857333e+02 1.08215069e+02 3.56733243e+01 8.12543105e+00
 3.18400520e+00 6.56630870e-01 2.39419938e-01 1.36278335e+03
 6.64744279e+02 3.00955376e+02 3.14036570e+02 6.16282766e+01
 7.34376609e+00 2.02311392e+01 7.75907487e-01 2.81427511e+00
 2.22621407e-01]
E = -526.7369454224945
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562791        1
[INPUT] 0    0    [1    /1   ]  7617.52099362        1
[INPUT] 0    0    [1    /1   ]  3617.35131042        1
[INPUT] 0    0    [1    /1   ]  1597.80641704        1
[INPUT] 0    0    [1    /1   ]  382.857332503        1
[INPUT] 0    0    [1    /1   ]  108.215069053        1
[INPUT] 0    0    [1    /1   ]  35.6733243086        1
[INPUT] 0    0    [1    /1   ]  8.12543104823        1
[INPUT] 0    0    [1    /1   ]  3.18400520472        1
[INPUT] 0    0    [1    /1   ]  0.656630869614       1
[INPUT] 0    0    [1    /1   ]  0.239419937777       1
[INPUT] 1    0    [1    /1   ]  1362.78334777        1
[INPUT] 1    0    [1    /1   ]  664.744278807        1
[INPUT] 1    0    [1    /1   ]  300.955375532        1
[INPUT] 1    0    [1    /1   ]  314.036569703        1
[INPUT] 1    0    [1    /1   ]  61.6282766232        1
[INPUT] 1    0    [1    /1   ]  7.343766085          1
[INPUT] 1    0    [1    /1   ]  20.2311391842        1
[INPUT] 1    0    [1    /1   ]  0.775907487126       1
[INPUT] 1    0    [1    /1   ]  2.81427510942        1
[INPUT] 1    0    [1    /1   ]  0.222621407234       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656279132018, 1.0]], [0, [7617.520993616995, 1.0]], [0, [3617.3513104220324, 1.0]], [0, [1597.8064170372331, 1.0]], [0, [382.85733250268953, 1.0]], [0, [108.21506905284687, 1.0]], [0, [35.673324308632296, 1.0]], [0, [8.125431048232185, 1.0]], [0, [3.1840052047150498, 1.0]], [0, [0.6566308696141614, 1.0]], [0, [0.23941993777711001, 1.0]], [1, [1362.7833477659653, 1.0]], [1, [664.7442788070879, 1.0]], [1, [300.9553755322581, 1.0]], [1, [314.0365697026123, 1.0]], [1, [61.62827662317766, 1.0]], [1, [7.343766085001037, 1.0]], [1, [20.231139184228578, 1.0]], [1, [0.775907487126115, 1.0]], [1, [2.8142751094201968, 1.0]], [1, [0.22262140723417695, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627913]
bas 1, expnt(s) = [7617.52099362]
bas 2, expnt(s) = [3617.35131042]
bas 3, expnt(s) = [1597.80641704]
bas 4, expnt(s) = [382.8573325]
bas 5, expnt(s) = [108.21506905]
bas 6, expnt(s) = [35.67332431]
bas 7, expnt(s) = [8.12543105]
bas 8, expnt(s) = [3.1840052]
bas 9, expnt(s) = [0.65663087]
bas 10, expnt(s) = [0.23941994]
bas 11, expnt(s) = [1362.78334777]
bas 12, expnt(s) = [664.74427881]
bas 13, expnt(s) = [300.95537553]
bas 14, expnt(s) = [314.0365697]
bas 15, expnt(s) = [61.62827662]
bas 16, expnt(s) = [7.34376609]
bas 17, expnt(s) = [20.23113918]
bas 18, expnt(s) = [0.77590749]
bas 19, expnt(s) = [2.81427511]
bas 20, expnt(s) = [0.22262141]
CPU time:       130.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752099e+03 2.06003818e+03
 3.61735131e+03 1.17844153e+03 1.59780642e+03 6.38495947e+02
 3.82857333e+02 2.18671786e+02 1.08215069e+02 8.47677840e+01
 3.56733243e+01 3.68784544e+01 8.12543105e+00 1.21590552e+01
 3.18400520e+00 6.02206378e+00 6.56630870e-01 1.84291793e+00
 2.39419938e-01 8.64739425e-01 1.36278335e+03 2.41556048e+04
 6.64744279e+02 9.84697086e+03 3.00955376e+02 3.65689107e+03
 3.14036570e+02 3.85664508e+03 6.16282766e+01 5.03743461e+02
 7.34376609e+00 3.52681709e+01 2.02311392e+01 1.25172756e+02
 7.75907487e-01 2.12445150e+00 2.81427511e+00 1.06339002e+01
 2.22621407e-01 4.46111118e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993657379518396
cond(S) = 103576.22848760812
E1 = -729.522435397507  E_coul = 203.17689901784956
init E= -526.345536379657
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555780616231374  LUMO = 0.993625631586579
  mo_energy =
[-1.18327603e+02 -1.22050676e+01 -9.44698177e+00 -9.44698177e+00
 -9.44698177e+00 -1.24006090e+00 -5.55780616e-01 -5.55780616e-01
 -5.55780616e-01  9.93625632e-01  1.03274673e+00  1.03274673e+00
  1.03274673e+00  7.35945507e+00  7.35945507e+00  7.35945507e+00
  1.24712479e+01  3.35599665e+01  3.35599665e+01  3.35599665e+01
  1.06945859e+02  1.29182524e+02  1.29182524e+02  1.29182524e+02
  4.83579302e+02  4.83579302e+02  4.83579302e+02  5.88827529e+02
  1.33545960e+03  1.33545960e+03  1.33545960e+03  2.65723409e+03
  3.02975412e+03  3.02975412e+03  3.02975412e+03  6.65029690e+03
  6.65029690e+03  6.65029690e+03  9.06270558e+03  2.54182836e+04
  7.61605961e+04]
E1 = -727.8333707466663  E_coul = 201.09721097828745
cycle= 1 E= -526.736159768379  delta_E= -0.391  |g|= 0.186  |ddm|= 0.31
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540579
diis-c [-0.29222556  1.        ]
  HOMO = -0.590818490652785  LUMO = 0.965630615009253
  mo_energy =
[-1.18636834e+02 -1.23431928e+01 -9.59595722e+00 -9.59595722e+00
 -9.59595722e+00 -1.27961957e+00 -5.90818491e-01 -5.90818491e-01
 -5.90818491e-01  9.65630615e-01  1.00831114e+00  1.00831114e+00
  1.00831114e+00  7.26828557e+00  7.26828557e+00  7.26828557e+00
  1.23612902e+01  3.34053258e+01  3.34053258e+01  3.34053258e+01
  1.06725382e+02  1.28953203e+02  1.28953203e+02  1.28953203e+02
  4.83271462e+02  4.83271462e+02  4.83271462e+02  5.88481811e+02
  1.33509520e+03  1.33509520e+03  1.33509520e+03  2.65673472e+03
  3.02932314e+03  3.02932314e+03  3.02932314e+03  6.64975242e+03
  6.64975242e+03  6.64975242e+03  9.06208565e+03  2.54175697e+04
  7.61597920e+04]
E1 = -728.4090298219714  E_coul = 201.672145581391
cycle= 2 E= -526.73688424058  delta_E= -0.000724  |g|= 0.0377  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753464
diis-c [-0.0032916   0.08329493  0.91670507]
  HOMO = -0.581682483212557  LUMO = 0.973678179016623
  mo_energy =
[-1.18569016e+02 -1.23050715e+01 -9.55618049e+00 -9.55618049e+00
 -9.55618049e+00 -1.26868134e+00 -5.81682483e-01 -5.81682483e-01
 -5.81682483e-01  9.73678179e-01  1.01505446e+00  1.01505446e+00
  1.01505446e+00  7.29209117e+00  7.29209117e+00  7.29209117e+00
  1.23914136e+01  3.34454731e+01  3.34454731e+01  3.34454731e+01
  1.06781150e+02  1.29009190e+02  1.29009190e+02  1.29009190e+02
  4.83338465e+02  4.83338465e+02  4.83338465e+02  5.88551159e+02
  1.33516626e+03  1.33516626e+03  1.33516626e+03  2.65680909e+03
  3.02939643e+03  3.02939643e+03  3.02939643e+03  6.64982746e+03
  6.64982746e+03  6.64982746e+03  9.06216150e+03  2.54176461e+04
  7.61598687e+04]
E1 = -728.2584097447417  E_coul = 201.52146623216527
cycle= 3 E= -526.736943512576  delta_E= -5.93e-05  |g|= 0.00626  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013122
diis-c [-6.02304614e-07 -1.26458536e-03  1.43778133e-01  8.57486453e-01]
  HOMO = -0.583177900010716  LUMO = 0.972458256977458
  mo_energy =
[-1.18578938e+02 -1.23108584e+01 -9.56231457e+00 -9.56231457e+00
 -9.56231457e+00 -1.27036596e+00 -5.83177900e-01 -5.83177900e-01
 -5.83177900e-01  9.72458257e-01  1.01397533e+00  1.01397533e+00
  1.01397533e+00  7.28832409e+00  7.28832409e+00  7.28832409e+00
  1.23868118e+01  3.34393219e+01  3.34393219e+01  3.34393219e+01
  1.06772916e+02  1.29000872e+02  1.29000872e+02  1.29000872e+02
  4.83328658e+02  4.83328658e+02  4.83328658e+02  5.88541003e+02
  1.33515586e+03  1.33515586e+03  1.33515586e+03  2.65679806e+03
  3.02938565e+03  3.02938565e+03  3.02938565e+03  6.64981629e+03
  6.64981629e+03  6.64981629e+03  9.06215012e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2811100053216  E_coul = 201.54416458468833
cycle= 4 E= -526.736945420633  delta_E= -1.91e-06  |g|= 0.0001  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117305
diis-c [-4.20149777e-09  7.50408864e-05 -1.05833478e-02 -6.91841171e-02
  1.07969242e+00]
  HOMO = -0.583160249191244  LUMO = 0.972491720417204
  mo_energy =
[-1.18578901e+02 -1.23107955e+01 -9.56226556e+00 -9.56226556e+00
 -9.56226556e+00 -1.27032509e+00 -5.83160249e-01 -5.83160249e-01
 -5.83160249e-01  9.72491720e-01  1.01399071e+00  1.01399071e+00
  1.01399071e+00  7.28836435e+00  7.28836435e+00  7.28836435e+00
  1.23868699e+01  3.34393690e+01  3.34393690e+01  3.34393690e+01
  1.06772965e+02  1.29000918e+02  1.29000918e+02  1.29000918e+02
  4.83328696e+02  4.83328696e+02  4.83328696e+02  5.88541033e+02
  1.33515589e+03  1.33515589e+03  1.33515589e+03  2.65679807e+03
  3.02938567e+03  3.02938567e+03  3.02938567e+03  6.64981629e+03
  6.64981629e+03  6.64981629e+03  9.06215011e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2809016082721  E_coul = 201.54395618583908
cycle= 5 E= -526.736945422433  delta_E= -1.8e-09  |g|= 2.07e-05  |ddm|= 0.000163
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.89871e-05
diis-c [-7.83978173e-11  1.45713012e-05 -1.84636092e-03 -1.39408613e-02
  4.17635640e-02  9.74009087e-01]
  HOMO = -0.583167774829067  LUMO = 0.972487838476986
  mo_energy =
[-1.18578932e+02 -1.23108182e+01 -9.56229019e+00 -9.56229019e+00
 -9.56229019e+00 -1.27033105e+00 -5.83167775e-01 -5.83167775e-01
 -5.83167775e-01  9.72487838e-01  1.01398572e+00  1.01398572e+00
  1.01398572e+00  7.28834763e+00  7.28834763e+00  7.28834763e+00
  1.23868516e+01  3.34393451e+01  3.34393451e+01  3.34393451e+01
  1.06772938e+02  1.29000889e+02  1.29000889e+02  1.29000889e+02
  4.83328665e+02  4.83328665e+02  4.83328665e+02  5.88541002e+02
  1.33515586e+03  1.33515586e+03  1.33515586e+03  2.65679804e+03
  3.02938564e+03  3.02938564e+03  3.02938564e+03  6.64981626e+03
  6.64981626e+03  6.64981626e+03  9.06215008e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2809832000808  E_coul = 201.5440377775882
cycle= 6 E= -526.736945422493  delta_E= -5.96e-11  |g|= 1.77e-06  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2809832000808  E_coul = 201.5440377775882
  HOMO = -0.583167781063446  LUMO = 0.972488188935559
  mo_energy =
[-1.18578932e+02 -1.23108180e+01 -9.56229006e+00 -9.56229006e+00
 -9.56229006e+00 -1.27033066e+00 -5.83167781e-01 -5.83167781e-01
 -5.83167781e-01  9.72488189e-01  1.01398578e+00  1.01398578e+00
  1.01398578e+00  7.28834772e+00  7.28834772e+00  7.28834772e+00
  1.23868519e+01  3.34393452e+01  3.34393452e+01  3.34393452e+01
  1.06772938e+02  1.29000890e+02  1.29000890e+02  1.29000890e+02
  4.83328666e+02  4.83328666e+02  4.83328666e+02  5.88541002e+02
  1.33515586e+03  1.33515586e+03  1.33515586e+03  2.65679804e+03
  3.02938564e+03  3.02938564e+03  3.02938564e+03  6.64981626e+03
  6.64981626e+03  6.64981626e+03  9.06215008e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2809818995222  E_coul = 201.54403647702776
Extra cycle  E= -526.736945422495  delta_E= -1.93e-12  |g|= 3.66e-07  |ddm|= 3.12e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103576.22848760812
E1 = -728.2809818995222  E_coul = 201.54403647702776
init E= -526.736945422495
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.58316781896603  LUMO = 0.972488230063691
  mo_energy =
[-1.18578932e+02 -1.23108180e+01 -9.56229017e+00 -9.56229017e+00
 -9.56229017e+00 -1.27033062e+00 -5.83167819e-01 -5.83167819e-01
 -5.83167819e-01  9.72488230e-01  1.01398576e+00  1.01398576e+00
  1.01398576e+00  7.28834765e+00  7.28834765e+00  7.28834765e+00
  1.23868518e+01  3.34393451e+01  3.34393451e+01  3.34393451e+01
  1.06772938e+02  1.29000890e+02  1.29000890e+02  1.29000890e+02
  4.83328666e+02  4.83328666e+02  4.83328666e+02  5.88541002e+02
  1.33515586e+03  1.33515586e+03  1.33515586e+03  2.65679804e+03
  3.02938564e+03  3.02938564e+03  3.02938564e+03  6.64981626e+03
  6.64981626e+03  6.64981626e+03  9.06215008e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.2809821400338  E_coul = 201.54403671754102
cycle= 1 E= -526.736945422493  delta_E= 1.82e-12  |g|= 7.78e-08  |ddm|= 6.07e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2809821400338  E_coul = 201.54403671754102
  HOMO = -0.583167817158261  LUMO = 0.972488246587755
  mo_energy =
[-1.18578932e+02 -1.23108180e+01 -9.56229016e+00 -9.56229016e+00
 -9.56229016e+00 -1.27033060e+00 -5.83167817e-01 -5.83167817e-01
 -5.83167817e-01  9.72488247e-01  1.01398576e+00  1.01398576e+00
  1.01398576e+00  7.28834766e+00  7.28834766e+00  7.28834766e+00
  1.23868518e+01  3.34393452e+01  3.34393452e+01  3.34393452e+01
  1.06772938e+02  1.29000890e+02  1.29000890e+02  1.29000890e+02
  4.83328666e+02  4.83328666e+02  4.83328666e+02  5.88541002e+02
  1.33515586e+03  1.33515586e+03  1.33515586e+03  2.65679804e+03
  3.02938564e+03  3.02938564e+03  3.02938564e+03  6.64981626e+03
  6.64981626e+03  6.64981626e+03  9.06215008e+03  2.54176345e+04
  7.61598570e+04]
E1 = -728.280982046463  E_coul = 201.54403662396854
Extra cycle  E= -526.736945422495  delta_E= -1.82e-12  |g|= 1.58e-08  |ddm|= 1.3e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61826563e+04 7.61752099e+03 3.61735131e+03 1.59780642e+03
 3.82857333e+02 1.08215069e+02 3.56733243e+01 8.12543105e+00
 3.18400520e+00 6.56630870e-01 2.39419938e-01 1.36278335e+03
 6.64744279e+02 3.00955376e+02 3.14036570e+02 6.16282766e+01
 7.34376609e+00 2.02311392e+01 7.75907487e-01 2.81427511e+00
 2.22621407e-01]
grad_E = [-1.50508565e-06  3.17175238e-06 -1.64859527e-06  6.39245383e-05
  1.47395734e-04 -1.83144986e-03  5.36576954e-04 -2.02202510e-04
 -2.24241149e-04 -1.95241786e-04 -2.00068261e-04 -5.11040210e-07
  4.94853250e-06  2.32592970e-05  2.00551083e-05  2.52434800e-05
  1.13284824e-03 -3.66937234e-04  3.55820166e-04 -1.24528191e-03
 -1.37580532e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562748        1
[INPUT] 0    0    [1    /1   ]  7617.5210032         1
[INPUT] 0    0    [1    /1   ]  3617.35130601        1
[INPUT] 0    0    [1    /1   ]  1597.80662095        1
[INPUT] 0    0    [1    /1   ]  382.857008508        1
[INPUT] 0    0    [1    /1   ]  108.216436208        1
[INPUT] 0    0    [1    /1   ]  35.6586683146        1
[INPUT] 0    0    [1    /1   ]  8.11406654034        1
[INPUT] 0    0    [1    /1   ]  3.1842160829         1
[INPUT] 0    0    [1    /1   ]  0.658091876008       1
[INPUT] 0    0    [1    /1   ]  0.240197860461       1
[INPUT] 1    0    [1    /1   ]  1362.78334633        1
[INPUT] 1    0    [1    /1   ]  664.744293187        1
[INPUT] 1    0    [1    /1   ]  300.955443531        1
[INPUT] 1    0    [1    /1   ]  314.036628329        1
[INPUT] 1    0    [1    /1   ]  61.6281372235        1
[INPUT] 1    0    [1    /1   ]  7.34138455089        1
[INPUT] 1    0    [1    /1   ]  20.2319065814        1
[INPUT] 1    0    [1    /1   ]  0.775837297982       1
[INPUT] 1    0    [1    /1   ]  2.81675159144        1
[INPUT] 1    0    [1    /1   ]  0.22276504881        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656274800585, 1.0]], [0, [7617.52100319528, 1.0]], [0, [3617.3513060117093, 1.0]], [0, [1597.8066209536046, 1.0]], [0, [382.857008508415, 1.0]], [0, [108.21643620834205, 1.0]], [0, [35.65866831463372, 1.0]], [0, [8.11406654034147, 1.0]], [0, [3.184216082899579, 1.0]], [0, [0.6580918760076278, 1.0]], [0, [0.24019786046106484, 1.0]], [1, [1362.7833463336954, 1.0]], [1, [664.7442931874189, 1.0]], [1, [300.9554435313909, 1.0]], [1, [314.03662832884606, 1.0]], [1, [61.62813722346133, 1.0]], [1, [7.3413845508886135, 1.0]], [1, [20.231906581432717, 1.0]], [1, [0.7758372979815678, 1.0]], [1, [2.8167515914383148, 1.0]], [1, [0.22276504880990225, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6562748]
bas 1, expnt(s) = [7617.5210032]
bas 2, expnt(s) = [3617.35130601]
bas 3, expnt(s) = [1597.80662095]
bas 4, expnt(s) = [382.85700851]
bas 5, expnt(s) = [108.21643621]
bas 6, expnt(s) = [35.65866831]
bas 7, expnt(s) = [8.11406654]
bas 8, expnt(s) = [3.18421608]
bas 9, expnt(s) = [0.65809188]
bas 10, expnt(s) = [0.24019786]
bas 11, expnt(s) = [1362.78334633]
bas 12, expnt(s) = [664.74429319]
bas 13, expnt(s) = [300.95544353]
bas 14, expnt(s) = [314.03662833]
bas 15, expnt(s) = [61.62813722]
bas 16, expnt(s) = [7.34138455]
bas 17, expnt(s) = [20.23190658]
bas 18, expnt(s) = [0.7758373]
bas 19, expnt(s) = [2.81675159]
bas 20, expnt(s) = [0.22276505]
CPU time:       136.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752100e+03 2.06003818e+03
 3.61735131e+03 1.17844153e+03 1.59780662e+03 6.38496008e+02
 3.82857009e+02 2.18671647e+02 1.08216436e+02 8.47685872e+01
 3.56586683e+01 3.68670904e+01 8.11406654e+00 1.21462984e+01
 3.18421608e+00 6.02236291e+00 6.58091876e-01 1.84599245e+00
 2.40197860e-01 8.66845852e-01 1.36278335e+03 2.41556047e+04
 6.64744293e+02 9.84697113e+03 3.00955444e+02 3.65689210e+03
 3.14036628e+02 3.85664598e+03 6.16281372e+01 5.03742037e+02
 7.34138455e+00 3.52538749e+01 2.02319066e+01 1.25178691e+02
 7.75837298e-01 2.12421128e+00 2.81675159e+00 1.06455984e+01
 2.22765049e-01 4.46470952e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993642011321818
cond(S) = 103578.94376650701
E1 = -729.5221184138231  E_coul = 203.17667173634464
init E= -526.345446677479
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555773805353696  LUMO = 0.99820237233765
  mo_energy =
[-1.18327648e+02 -1.22050881e+01 -9.44700890e+00 -9.44700890e+00
 -9.44700890e+00 -1.24004950e+00 -5.55773805e-01 -5.55773805e-01
 -5.55773805e-01  9.98202372e-01  1.03329981e+00  1.03329981e+00
  1.03329981e+00  7.36321991e+00  7.36321991e+00  7.36321991e+00
  1.24702038e+01  3.35637934e+01  3.35637934e+01  3.35637934e+01
  1.06883593e+02  1.29184613e+02  1.29184613e+02  1.29184613e+02
  4.83580823e+02  4.83580823e+02  4.83580823e+02  5.88740745e+02
  1.33546102e+03  1.33546102e+03  1.33546102e+03  2.65715289e+03
  3.02975559e+03  3.02975559e+03  3.02975559e+03  6.65029836e+03
  6.65029836e+03  6.65029836e+03  9.06263054e+03  2.54182126e+04
  7.61605300e+04]
E1 = -727.8371646625467  E_coul = 201.100991831479
cycle= 1 E= -526.736172831068  delta_E= -0.391  |g|= 0.186  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540573
diis-c [-0.2922197  1.       ]
  HOMO = -0.590694327065897  LUMO = 0.97021427535925
  mo_energy =
[-1.18636579e+02 -1.23429152e+01 -9.59567691e+00 -9.59567691e+00
 -9.59567691e+00 -1.27948080e+00 -5.90694327e-01 -5.90694327e-01
 -5.90694327e-01  9.70214275e-01  1.00894355e+00  1.00894355e+00
  1.00894355e+00  7.27227148e+00  7.27227148e+00  7.27227148e+00
  1.23605644e+01  3.34094480e+01  3.34094480e+01  3.34094480e+01
  1.06663465e+02  1.28955599e+02  1.28955599e+02  1.28955599e+02
  4.83273287e+02  4.83273287e+02  4.83273287e+02  5.88395308e+02
  1.33509690e+03  1.33509690e+03  1.33509690e+03  2.65665378e+03
  3.02932488e+03  3.02932488e+03  3.02932488e+03  6.64975416e+03
  6.64975416e+03  6.64975416e+03  9.06201087e+03  2.54174989e+04
  7.61597262e+04]
E1 = -728.41171514806  E_coul = 201.6748201022525
cycle= 2 E= -526.736895045808  delta_E= -0.000722  |g|= 0.0377  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752607
diis-c [-0.00328482  0.0831966   0.9168034 ]
  HOMO = -0.581579932431293  LUMO = 0.97826813311834
  mo_energy =
[-1.18568858e+02 -1.23048657e+01 -9.55597315e+00 -9.55597315e+00
 -9.55597315e+00 -1.26856869e+00 -5.81579932e-01 -5.81579932e-01
 -5.81579932e-01  9.78268133e-01  1.01567312e+00  1.01567312e+00
  1.01567312e+00  7.29603301e+00  7.29603301e+00  7.29603301e+00
  1.23906139e+01  3.34495221e+01  3.34495221e+01  3.34495221e+01
  1.06719142e+02  1.29011499e+02  1.29011499e+02  1.29011499e+02
  4.83340193e+02  4.83340193e+02  4.83340193e+02  5.88464558e+02
  1.33516786e+03  1.33516786e+03  1.33516786e+03  2.65672805e+03
  3.02939808e+03  3.02939808e+03  3.02939808e+03  6.64982909e+03
  6.64982909e+03  6.64982909e+03  9.06208662e+03  2.54175752e+04
  7.61598028e+04]
E1 = -728.2614207416542  E_coul = 201.5244666618877
cycle= 3 E= -526.736954079767  delta_E= -5.9e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131052
diis-c [-6.00470152e-07 -1.26386709e-03  1.43757947e-01  8.57505920e-01]
  HOMO = -0.583072352512718  LUMO = 0.977046755003239
  mo_energy =
[-1.18578767e+02 -1.23106436e+01 -9.56209781e+00 -9.56209781e+00
 -9.56209781e+00 -1.27025012e+00 -5.83072353e-01 -5.83072353e-01
 -5.83072353e-01  9.77046755e-01  1.01459586e+00  1.01459586e+00
  1.01459586e+00  7.29227160e+00  7.29227160e+00  7.29227160e+00
  1.23860215e+01  3.34433806e+01  3.34433806e+01  3.34433806e+01
  1.06710920e+02  1.29003193e+02  1.29003193e+02  1.29003193e+02
  4.83330401e+02  4.83330401e+02  4.83330401e+02  5.88454415e+02
  1.33515748e+03  1.33515748e+03  1.33515748e+03  2.65671704e+03
  3.02938731e+03  3.02938731e+03  3.02938731e+03  6.64981794e+03
  6.64981794e+03  6.64981794e+03  9.06207525e+03  2.54175637e+04
  7.61597911e+04]
E1 = -728.2840798031883  E_coul = 201.54712382226688
cycle= 4 E= -526.736955980921  delta_E= -1.9e-06  |g|= 0.0001  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116447
diis-c [-4.20042846e-09  7.45287995e-05 -1.05235408e-02 -6.87634115e-02
  1.07921242e+00]
  HOMO = -0.583054468982655  LUMO = 0.977080429259662
  mo_energy =
[-1.18578728e+02 -1.23105802e+01 -9.56204815e+00 -9.56204815e+00
 -9.56204815e+00 -1.27020908e+00 -5.83054469e-01 -5.83054469e-01
 -5.83054469e-01  9.77080429e-01  1.01461140e+00  1.01461140e+00
  1.01461140e+00  7.29231235e+00  7.29231235e+00  7.29231235e+00
  1.23860801e+01  3.34434283e+01  3.34434283e+01  3.34434283e+01
  1.06710970e+02  1.29003239e+02  1.29003239e+02  1.29003239e+02
  4.83330439e+02  4.83330439e+02  4.83330439e+02  5.88454447e+02
  1.33515751e+03  1.33515751e+03  1.33515751e+03  2.65671705e+03
  3.02938733e+03  3.02938733e+03  3.02938733e+03  6.64981794e+03
  6.64981794e+03  6.64981794e+03  9.06207524e+03  2.54175637e+04
  7.61597911e+04]
E1 = -728.2838696730507  E_coul = 201.54691369034103
cycle= 5 E= -526.73695598271  delta_E= -1.79e-09  |g|= 2.07e-05  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.90328e-05
diis-c [-7.80448357e-11  1.45747644e-05 -1.84759642e-03 -1.39559285e-02
  4.21398723e-02  9.73649078e-01]
  HOMO = -0.583061988854607  LUMO = 0.977076532036126
  mo_energy =
[-1.18578759e+02 -1.23106029e+01 -9.56207278e+00 -9.56207278e+00
 -9.56207278e+00 -1.27021503e+00 -5.83061989e-01 -5.83061989e-01
 -5.83061989e-01  9.77076532e-01  1.01460642e+00  1.01460642e+00
  1.01460642e+00  7.29229562e+00  7.29229562e+00  7.29229562e+00
  1.23860618e+01  3.34434044e+01  3.34434044e+01  3.34434044e+01
  1.06710942e+02  1.29003211e+02  1.29003211e+02  1.29003211e+02
  4.83330409e+02  4.83330409e+02  4.83330409e+02  5.88454415e+02
  1.33515747e+03  1.33515747e+03  1.33515747e+03  2.65671702e+03
  3.02938730e+03  3.02938730e+03  3.02938730e+03  6.64981791e+03
  6.64981791e+03  6.64981791e+03  9.06207521e+03  2.54175636e+04
  7.61597910e+04]
E1 = -728.2839512902972  E_coul = 201.54699530752802
cycle= 6 E= -526.736955982769  delta_E= -5.95e-11  |g|= 1.77e-06  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2839512902972  E_coul = 201.54699530752802
  HOMO = -0.58306200009919  LUMO = 0.97707687885646
  mo_energy =
[-1.18578759e+02 -1.23106027e+01 -9.56207267e+00 -9.56207267e+00
 -9.56207267e+00 -1.27021465e+00 -5.83062000e-01 -5.83062000e-01
 -5.83062000e-01  9.77076879e-01  1.01460647e+00  1.01460647e+00
  1.01460647e+00  7.29229570e+00  7.29229570e+00  7.29229570e+00
  1.23860621e+01  3.34434046e+01  3.34434046e+01  3.34434046e+01
  1.06710943e+02  1.29003211e+02  1.29003211e+02  1.29003211e+02
  4.83330409e+02  4.83330409e+02  4.83330409e+02  5.88454416e+02
  1.33515747e+03  1.33515747e+03  1.33515747e+03  2.65671702e+03
  3.02938730e+03  3.02938730e+03  3.02938730e+03  6.64981791e+03
  6.64981791e+03  6.64981791e+03  9.06207521e+03  2.54175636e+04
  7.61597910e+04]
E1 = -728.2839500612779  E_coul = 201.5469940785085
Extra cycle  E= -526.736955982769  delta_E= -2.27e-13  |g|= 3.65e-07  |ddm|= 3.11e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.28 sec
exp = [2.61826563e+04 7.61752100e+03 3.61735131e+03 1.59780662e+03
 3.82857009e+02 1.08216436e+02 3.56586683e+01 8.11406654e+00
 3.18421608e+00 6.58091876e-01 2.40197860e-01 1.36278335e+03
 6.64744293e+02 3.00955444e+02 3.14036628e+02 6.16281372e+01
 7.34138455e+00 2.02319066e+01 7.75837298e-01 2.81675159e+00
 2.22765049e-01]
E = -526.7369559827694
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562748        1
[INPUT] 0    0    [1    /1   ]  7617.5210032         1
[INPUT] 0    0    [1    /1   ]  3617.35130601        1
[INPUT] 0    0    [1    /1   ]  1597.80662095        1
[INPUT] 0    0    [1    /1   ]  382.857008508        1
[INPUT] 0    0    [1    /1   ]  108.216436208        1
[INPUT] 0    0    [1    /1   ]  35.6586683146        1
[INPUT] 0    0    [1    /1   ]  8.11406654034        1
[INPUT] 0    0    [1    /1   ]  3.1842160829         1
[INPUT] 0    0    [1    /1   ]  0.658091876008       1
[INPUT] 0    0    [1    /1   ]  0.240197860461       1
[INPUT] 1    0    [1    /1   ]  1362.78334633        1
[INPUT] 1    0    [1    /1   ]  664.744293187        1
[INPUT] 1    0    [1    /1   ]  300.955443531        1
[INPUT] 1    0    [1    /1   ]  314.036628329        1
[INPUT] 1    0    [1    /1   ]  61.6281372235        1
[INPUT] 1    0    [1    /1   ]  7.34138455089        1
[INPUT] 1    0    [1    /1   ]  20.2319065814        1
[INPUT] 1    0    [1    /1   ]  0.775837297982       1
[INPUT] 1    0    [1    /1   ]  2.81675159144        1
[INPUT] 1    0    [1    /1   ]  0.22276504881        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656274800585, 1.0]], [0, [7617.52100319528, 1.0]], [0, [3617.3513060117093, 1.0]], [0, [1597.8066209536046, 1.0]], [0, [382.857008508415, 1.0]], [0, [108.21643620834205, 1.0]], [0, [35.65866831463372, 1.0]], [0, [8.11406654034147, 1.0]], [0, [3.184216082899579, 1.0]], [0, [0.6580918760076278, 1.0]], [0, [0.24019786046106484, 1.0]], [1, [1362.7833463336954, 1.0]], [1, [664.7442931874189, 1.0]], [1, [300.9554435313909, 1.0]], [1, [314.03662832884606, 1.0]], [1, [61.62813722346133, 1.0]], [1, [7.3413845508886135, 1.0]], [1, [20.231906581432717, 1.0]], [1, [0.7758372979815678, 1.0]], [1, [2.8167515914383148, 1.0]], [1, [0.22276504880990225, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.6562748]
bas 1, expnt(s) = [7617.5210032]
bas 2, expnt(s) = [3617.35130601]
bas 3, expnt(s) = [1597.80662095]
bas 4, expnt(s) = [382.85700851]
bas 5, expnt(s) = [108.21643621]
bas 6, expnt(s) = [35.65866831]
bas 7, expnt(s) = [8.11406654]
bas 8, expnt(s) = [3.18421608]
bas 9, expnt(s) = [0.65809188]
bas 10, expnt(s) = [0.24019786]
bas 11, expnt(s) = [1362.78334633]
bas 12, expnt(s) = [664.74429319]
bas 13, expnt(s) = [300.95544353]
bas 14, expnt(s) = [314.03662833]
bas 15, expnt(s) = [61.62813722]
bas 16, expnt(s) = [7.34138455]
bas 17, expnt(s) = [20.23190658]
bas 18, expnt(s) = [0.7758373]
bas 19, expnt(s) = [2.81675159]
bas 20, expnt(s) = [0.22276505]
CPU time:       136.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752100e+03 2.06003818e+03
 3.61735131e+03 1.17844153e+03 1.59780662e+03 6.38496008e+02
 3.82857009e+02 2.18671647e+02 1.08216436e+02 8.47685872e+01
 3.56586683e+01 3.68670904e+01 8.11406654e+00 1.21462984e+01
 3.18421608e+00 6.02236291e+00 6.58091876e-01 1.84599245e+00
 2.40197860e-01 8.66845852e-01 1.36278335e+03 2.41556047e+04
 6.64744293e+02 9.84697113e+03 3.00955444e+02 3.65689210e+03
 3.14036628e+02 3.85664598e+03 6.16281372e+01 5.03742037e+02
 7.34138455e+00 3.52538749e+01 2.02319066e+01 1.25178691e+02
 7.75837298e-01 2.12421128e+00 2.81675159e+00 1.06455984e+01
 2.22765049e-01 4.46470952e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993642011321818
cond(S) = 103578.94376650701
E1 = -729.5221184138231  E_coul = 203.17667173634464
init E= -526.345446677479
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555773805353696  LUMO = 0.99820237233765
  mo_energy =
[-1.18327648e+02 -1.22050881e+01 -9.44700890e+00 -9.44700890e+00
 -9.44700890e+00 -1.24004950e+00 -5.55773805e-01 -5.55773805e-01
 -5.55773805e-01  9.98202372e-01  1.03329981e+00  1.03329981e+00
  1.03329981e+00  7.36321991e+00  7.36321991e+00  7.36321991e+00
  1.24702038e+01  3.35637934e+01  3.35637934e+01  3.35637934e+01
  1.06883593e+02  1.29184613e+02  1.29184613e+02  1.29184613e+02
  4.83580823e+02  4.83580823e+02  4.83580823e+02  5.88740745e+02
  1.33546102e+03  1.33546102e+03  1.33546102e+03  2.65715289e+03
  3.02975559e+03  3.02975559e+03  3.02975559e+03  6.65029836e+03
  6.65029836e+03  6.65029836e+03  9.06263054e+03  2.54182126e+04
  7.61605300e+04]
E1 = -727.8371646625467  E_coul = 201.100991831479
cycle= 1 E= -526.736172831068  delta_E= -0.391  |g|= 0.186  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540573
diis-c [-0.2922197  1.       ]
  HOMO = -0.590694327065897  LUMO = 0.97021427535925
  mo_energy =
[-1.18636579e+02 -1.23429152e+01 -9.59567691e+00 -9.59567691e+00
 -9.59567691e+00 -1.27948080e+00 -5.90694327e-01 -5.90694327e-01
 -5.90694327e-01  9.70214275e-01  1.00894355e+00  1.00894355e+00
  1.00894355e+00  7.27227148e+00  7.27227148e+00  7.27227148e+00
  1.23605644e+01  3.34094480e+01  3.34094480e+01  3.34094480e+01
  1.06663465e+02  1.28955599e+02  1.28955599e+02  1.28955599e+02
  4.83273287e+02  4.83273287e+02  4.83273287e+02  5.88395308e+02
  1.33509690e+03  1.33509690e+03  1.33509690e+03  2.65665378e+03
  3.02932488e+03  3.02932488e+03  3.02932488e+03  6.64975416e+03
  6.64975416e+03  6.64975416e+03  9.06201087e+03  2.54174989e+04
  7.61597262e+04]
E1 = -728.41171514806  E_coul = 201.6748201022525
cycle= 2 E= -526.736895045808  delta_E= -0.000722  |g|= 0.0377  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752607
diis-c [-0.00328482  0.0831966   0.9168034 ]
  HOMO = -0.581579932431293  LUMO = 0.97826813311834
  mo_energy =
[-1.18568858e+02 -1.23048657e+01 -9.55597315e+00 -9.55597315e+00
 -9.55597315e+00 -1.26856869e+00 -5.81579932e-01 -5.81579932e-01
 -5.81579932e-01  9.78268133e-01  1.01567312e+00  1.01567312e+00
  1.01567312e+00  7.29603301e+00  7.29603301e+00  7.29603301e+00
  1.23906139e+01  3.34495221e+01  3.34495221e+01  3.34495221e+01
  1.06719142e+02  1.29011499e+02  1.29011499e+02  1.29011499e+02
  4.83340193e+02  4.83340193e+02  4.83340193e+02  5.88464558e+02
  1.33516786e+03  1.33516786e+03  1.33516786e+03  2.65672805e+03
  3.02939808e+03  3.02939808e+03  3.02939808e+03  6.64982909e+03
  6.64982909e+03  6.64982909e+03  9.06208662e+03  2.54175752e+04
  7.61598028e+04]
E1 = -728.2614207416542  E_coul = 201.5244666618877
cycle= 3 E= -526.736954079767  delta_E= -5.9e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131052
diis-c [-6.00470152e-07 -1.26386709e-03  1.43757947e-01  8.57505920e-01]
  HOMO = -0.583072352512718  LUMO = 0.977046755003239
  mo_energy =
[-1.18578767e+02 -1.23106436e+01 -9.56209781e+00 -9.56209781e+00
 -9.56209781e+00 -1.27025012e+00 -5.83072353e-01 -5.83072353e-01
 -5.83072353e-01  9.77046755e-01  1.01459586e+00  1.01459586e+00
  1.01459586e+00  7.29227160e+00  7.29227160e+00  7.29227160e+00
  1.23860215e+01  3.34433806e+01  3.34433806e+01  3.34433806e+01
  1.06710920e+02  1.29003193e+02  1.29003193e+02  1.29003193e+02
  4.83330401e+02  4.83330401e+02  4.83330401e+02  5.88454415e+02
  1.33515748e+03  1.33515748e+03  1.33515748e+03  2.65671704e+03
  3.02938731e+03  3.02938731e+03  3.02938731e+03  6.64981794e+03
  6.64981794e+03  6.64981794e+03  9.06207525e+03  2.54175637e+04
  7.61597911e+04]
E1 = -728.2840798031883  E_coul = 201.54712382226688
cycle= 4 E= -526.736955980921  delta_E= -1.9e-06  |g|= 0.0001  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116447
diis-c [-4.20042846e-09  7.45287995e-05 -1.05235408e-02 -6.87634115e-02
  1.07921242e+00]
  HOMO = -0.583054468982655  LUMO = 0.977080429259662
  mo_energy =
[-1.18578728e+02 -1.23105802e+01 -9.56204815e+00 -9.56204815e+00
 -9.56204815e+00 -1.27020908e+00 -5.83054469e-01 -5.83054469e-01
 -5.83054469e-01  9.77080429e-01  1.01461140e+00  1.01461140e+00
  1.01461140e+00  7.29231235e+00  7.29231235e+00  7.29231235e+00
  1.23860801e+01  3.34434283e+01  3.34434283e+01  3.34434283e+01
  1.06710970e+02  1.29003239e+02  1.29003239e+02  1.29003239e+02
  4.83330439e+02  4.83330439e+02  4.83330439e+02  5.88454447e+02
  1.33515751e+03  1.33515751e+03  1.33515751e+03  2.65671705e+03
  3.02938733e+03  3.02938733e+03  3.02938733e+03  6.64981794e+03
  6.64981794e+03  6.64981794e+03  9.06207524e+03  2.54175637e+04
  7.61597911e+04]
E1 = -728.2838696730507  E_coul = 201.54691369034103
cycle= 5 E= -526.73695598271  delta_E= -1.79e-09  |g|= 2.07e-05  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.90328e-05
diis-c [-7.80448357e-11  1.45747644e-05 -1.84759642e-03 -1.39559285e-02
  4.21398723e-02  9.73649078e-01]
  HOMO = -0.583061988854607  LUMO = 0.977076532036126
  mo_energy =
[-1.18578759e+02 -1.23106029e+01 -9.56207278e+00 -9.56207278e+00
 -9.56207278e+00 -1.27021503e+00 -5.83061989e-01 -5.83061989e-01
 -5.83061989e-01  9.77076532e-01  1.01460642e+00  1.01460642e+00
  1.01460642e+00  7.29229562e+00  7.29229562e+00  7.29229562e+00
  1.23860618e+01  3.34434044e+01  3.34434044e+01  3.34434044e+01
  1.06710942e+02  1.29003211e+02  1.29003211e+02  1.29003211e+02
  4.83330409e+02  4.83330409e+02  4.83330409e+02  5.88454415e+02
  1.33515747e+03  1.33515747e+03  1.33515747e+03  2.65671702e+03
  3.02938730e+03  3.02938730e+03  3.02938730e+03  6.64981791e+03
  6.64981791e+03  6.64981791e+03  9.06207521e+03  2.54175636e+04
  7.61597910e+04]
E1 = -728.2839512902972  E_coul = 201.54699530752802
cycle= 6 E= -526.736955982769  delta_E= -5.95e-11  |g|= 1.77e-06  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2839512902972  E_coul = 201.54699530752802
  HOMO = -0.58306200009919  LUMO = 0.97707687885646
  mo_energy =
[-1.18578759e+02 -1.23106027e+01 -9.56207267e+00 -9.56207267e+00
 -9.56207267e+00 -1.27021465e+00 -5.83062000e-01 -5.83062000e-01
 -5.83062000e-01  9.77076879e-01  1.01460647e+00  1.01460647e+00
  1.01460647e+00  7.29229570e+00  7.29229570e+00  7.29229570e+00
  1.23860621e+01  3.34434046e+01  3.34434046e+01  3.34434046e+01
  1.06710943e+02  1.29003211e+02  1.29003211e+02  1.29003211e+02
  4.83330409e+02  4.83330409e+02  4.83330409e+02  5.88454416e+02
  1.33515747e+03  1.33515747e+03  1.33515747e+03  2.65671702e+03
  3.02938730e+03  3.02938730e+03  3.02938730e+03  6.64981791e+03
  6.64981791e+03  6.64981791e+03  9.06207521e+03  2.54175636e+04
  7.61597910e+04]
E1 = -728.2839500612779  E_coul = 201.5469940785085
Extra cycle  E= -526.736955982769  delta_E= -2.27e-13  |g|= 3.65e-07  |ddm|= 3.11e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103578.94376650701
E1 = -728.2839500612779  E_coul = 201.5469940785085
init E= -526.736955982769
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583062036506263  LUMO = 0.977076921257203
  mo_energy =
[-1.18578759e+02 -1.23106028e+01 -9.56207278e+00 -9.56207278e+00
 -9.56207278e+00 -1.27021461e+00 -5.83062037e-01 -5.83062037e-01
 -5.83062037e-01  9.77076921e-01  1.01460645e+00  1.01460645e+00
  1.01460645e+00  7.29229563e+00  7.29229563e+00  7.29229563e+00
  1.23860620e+01  3.34434045e+01  3.34434045e+01  3.34434045e+01
  1.06710943e+02  1.29003211e+02  1.29003211e+02  1.29003211e+02
  4.83330409e+02  4.83330409e+02  4.83330409e+02  5.88454415e+02
  1.33515747e+03  1.33515747e+03  1.33515747e+03  2.65671702e+03
  3.02938730e+03  3.02938730e+03  3.02938730e+03  6.64981791e+03
  6.64981791e+03  6.64981791e+03  9.06207521e+03  2.54175636e+04
  7.61597910e+04]
E1 = -728.2839502828053  E_coul = 201.5469943000354
cycle= 1 E= -526.73695598277  delta_E= -5.68e-13  |g|= 7.75e-08  |ddm|= 6.07e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2839502828053  E_coul = 201.5469943000354
  HOMO = -0.58306203503449  LUMO = 0.977076937506996
  mo_energy =
[-1.18578759e+02 -1.23106028e+01 -9.56207276e+00 -9.56207276e+00
 -9.56207276e+00 -1.27021459e+00 -5.83062035e-01 -5.83062035e-01
 -5.83062035e-01  9.77076938e-01  1.01460646e+00  1.01460646e+00
  1.01460646e+00  7.29229564e+00  7.29229564e+00  7.29229564e+00
  1.23860620e+01  3.34434045e+01  3.34434045e+01  3.34434045e+01
  1.06710943e+02  1.29003211e+02  1.29003211e+02  1.29003211e+02
  4.83330409e+02  4.83330409e+02  4.83330409e+02  5.88454415e+02
  1.33515747e+03  1.33515747e+03  1.33515747e+03  2.65671702e+03
  3.02938730e+03  3.02938730e+03  3.02938730e+03  6.64981791e+03
  6.64981791e+03  6.64981791e+03  9.06207521e+03  2.54175636e+04
  7.61597910e+04]
E1 = -728.283950194904  E_coul = 201.54699421213408
Extra cycle  E= -526.73695598277  delta_E=    0  |g|= 1.57e-08  |ddm|= 1.29e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826563e+04 7.61752100e+03 3.61735131e+03 1.59780662e+03
 3.82857009e+02 1.08216436e+02 3.56586683e+01 8.11406654e+00
 3.18421608e+00 6.58091876e-01 2.40197860e-01 1.36278335e+03
 6.64744293e+02 3.00955444e+02 3.14036628e+02 6.16281372e+01
 7.34138455e+00 2.02319066e+01 7.75837298e-01 2.81675159e+00
 2.22765049e-01]
grad_E = [-1.50539955e-06  3.17520043e-06 -1.64697137e-06  6.40610102e-05
  1.42870868e-04 -1.79354605e-03  4.37493158e-04 -3.98880342e-04
  3.17598099e-04 -2.62915821e-04  5.24229857e-04 -5.09368377e-07
  4.97154774e-06  2.33998754e-05  2.01757076e-05  7.73784239e-06
  5.18985797e-04 -2.00221514e-04 -7.90383125e-04 -3.93666540e-04
  2.35628458e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562732        1
[INPUT] 0    0    [1    /1   ]  7617.52100694        1
[INPUT] 0    0    [1    /1   ]  3617.35130455        1
[INPUT] 0    0    [1    /1   ]  1597.80670585        1
[INPUT] 0    0    [1    /1   ]  382.856521705        1
[INPUT] 0    0    [1    /1   ]  108.220201814        1
[INPUT] 0    0    [1    /1   ]  35.6453476948        1
[INPUT] 0    0    [1    /1   ]  8.10506637648        1
[INPUT] 0    0    [1    /1   ]  3.18273409595        1
[INPUT] 0    0    [1    /1   ]  0.657532745606       1
[INPUT] 0    0    [1    /1   ]  0.240077558951       1
[INPUT] 1    0    [1    /1   ]  1362.78334582        1
[INPUT] 1    0    [1    /1   ]  664.744298519        1
[INPUT] 1    0    [1    /1   ]  300.955468894        1
[INPUT] 1    0    [1    /1   ]  314.036650194        1
[INPUT] 1    0    [1    /1   ]  61.6280073386        1
[INPUT] 1    0    [1    /1   ]  7.33883373434        1
[INPUT] 1    0    [1    /1   ]  20.2328203417        1
[INPUT] 1    0    [1    /1   ]  0.775885610511       1
[INPUT] 1    0    [1    /1   ]  2.81904754846        1
[INPUT] 1    0    [1    /1   ]  0.222829147738       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656273205772, 1.0]], [0, [7617.521006943607, 1.0]], [0, [3617.351304553062, 1.0]], [0, [1597.8067058479492, 1.0]], [0, [382.8565217048176, 1.0]], [0, [108.22020181368029, 1.0]], [0, [35.645347694783865, 1.0]], [0, [8.105066376483745, 1.0]], [0, [3.182734095947288, 1.0]], [0, [0.6575327456060344, 1.0]], [0, [0.2400775589505028, 1.0]], [1, [1362.7833458229106, 1.0]], [1, [664.7442985186207, 1.0]], [1, [300.955468894289, 1.0]], [1, [314.036650194118, 1.0]], [1, [61.62800733858204, 1.0]], [1, [7.338833734336506, 1.0]], [1, [20.23282034166822, 1.0]], [1, [0.7758856105113556, 1.0]], [1, [2.8190475484639617, 1.0]], [1, [0.22282914773837265, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627321]
bas 1, expnt(s) = [7617.52100694]
bas 2, expnt(s) = [3617.35130455]
bas 3, expnt(s) = [1597.80670585]
bas 4, expnt(s) = [382.8565217]
bas 5, expnt(s) = [108.22020181]
bas 6, expnt(s) = [35.64534769]
bas 7, expnt(s) = [8.10506638]
bas 8, expnt(s) = [3.1827341]
bas 9, expnt(s) = [0.65753275]
bas 10, expnt(s) = [0.24007756]
bas 11, expnt(s) = [1362.78334582]
bas 12, expnt(s) = [664.74429852]
bas 13, expnt(s) = [300.95546889]
bas 14, expnt(s) = [314.03665019]
bas 15, expnt(s) = [61.62800734]
bas 16, expnt(s) = [7.33883373]
bas 17, expnt(s) = [20.23282034]
bas 18, expnt(s) = [0.77588561]
bas 19, expnt(s) = [2.81904755]
bas 20, expnt(s) = [0.22282915]
CPU time:       142.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752101e+03 2.06003818e+03
 3.61735130e+03 1.17844153e+03 1.59780671e+03 6.38496034e+02
 3.82856522e+02 2.18671438e+02 1.08220202e+02 8.47707994e+01
 3.56453477e+01 3.68567609e+01 8.10506638e+00 1.21361925e+01
 3.18273410e+00 6.02026061e+00 6.57532746e-01 1.84481603e+00
 2.40077559e-01 8.66520216e-01 1.36278335e+03 2.41556047e+04
 6.64744299e+02 9.84697123e+03 3.00955469e+02 3.65689249e+03
 3.14036650e+02 3.85664632e+03 6.16280073e+01 5.03740710e+02
 7.33883373e+00 3.52385641e+01 2.02328203e+01 1.25185758e+02
 7.75885611e-01 2.12437663e+00 2.81904755e+00 1.06564461e+01
 2.22829148e-01 4.46631543e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993637321447423
cond(S) = 103573.95611466763
E1 = -729.5219359000433  E_coul = 203.1765172429086
init E= -526.345418657135
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555773341033961  LUMO = 0.997049425713899
  mo_energy =
[-1.18327673e+02 -1.22050978e+01 -9.44702468e+00 -9.44702468e+00
 -9.44702468e+00 -1.24004816e+00 -5.55773341e-01 -5.55773341e-01
 -5.55773341e-01  9.97049426e-01  1.03363138e+00  1.03363138e+00
  1.03363138e+00  7.36676227e+00  7.36676227e+00  7.36676227e+00
  1.24529680e+01  3.35668778e+01  3.35668778e+01  3.35668778e+01
  1.06814678e+02  1.29186085e+02  1.29186085e+02  1.29186085e+02
  4.83581982e+02  4.83581982e+02  4.83581982e+02  5.88657899e+02
  1.33546207e+03  1.33546207e+03  1.33546207e+03  2.65707900e+03
  3.02975661e+03  3.02975661e+03  3.02975661e+03  6.65029933e+03
  6.65029933e+03  6.65029933e+03  9.06256272e+03  2.54181485e+04
  7.61604702e+04]
E1 = -727.8383824873243  E_coul = 201.10219996090743
cycle= 1 E= -526.736182526417  delta_E= -0.391  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540648
diis-c [-0.29230045  1.        ]
  HOMO = -0.590658703333606  LUMO = 0.969125106972842
  mo_energy =
[-1.18636516e+02 -1.23428127e+01 -9.59558246e+00 -9.59558246e+00
 -9.59558246e+00 -1.27943628e+00 -5.90658703e-01 -5.90658703e-01
 -5.90658703e-01  9.69125107e-01  1.00929375e+00  1.00929375e+00
  1.00929375e+00  7.27588397e+00  7.27588397e+00  7.27588397e+00
  1.23434997e+01  3.34126379e+01  3.34126379e+01  3.34126379e+01
  1.06594673e+02  1.28957171e+02  1.28957171e+02  1.28957171e+02
  4.83274535e+02  4.83274535e+02  4.83274535e+02  5.88312536e+02
  1.33509802e+03  1.33509802e+03  1.33509802e+03  2.65657997e+03
  3.02932597e+03  3.02932597e+03  3.02932597e+03  6.64975519e+03
  6.64975519e+03  6.64975519e+03  9.06194311e+03  2.54174348e+04
  7.61596665e+04]
E1 = -728.4125455369534  E_coul = 201.67564145556713
cycle= 2 E= -526.736904081386  delta_E= -0.000722  |g|= 0.0377  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752393
diis-c [-0.0032822   0.08317615  0.91682385]
  HOMO = -0.581552528646957  LUMO = 0.977164353880671
  mo_energy =
[-1.18568828e+02 -1.23047890e+01 -9.55590511e+00 -9.55590511e+00
 -9.55590511e+00 -1.26853385e+00 -5.81552529e-01 -5.81552529e-01
 -5.81552529e-01  9.77164354e-01  1.01601946e+00  1.01601946e+00
  1.01601946e+00  7.29963196e+00  7.29963196e+00  7.29963196e+00
  1.23735120e+01  3.34526848e+01  3.34526848e+01  3.34526848e+01
  1.06650316e+02  1.29013041e+02  1.29013041e+02  1.29013041e+02
  4.83341409e+02  4.83341409e+02  4.83341409e+02  5.88381753e+02
  1.33516894e+03  1.33516894e+03  1.33516894e+03  2.65665420e+03
  3.02939913e+03  3.02939913e+03  3.02939913e+03  6.64983009e+03
  6.64983009e+03  6.64983009e+03  9.06201882e+03  2.54175111e+04
  7.61597430e+04]
E1 = -728.2623754741625  E_coul = 201.5254124442759
cycle= 3 E= -526.736963029887  delta_E= -5.89e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130981
diis-c [-6.01298285e-07 -1.26387112e-03  1.43721728e-01  8.57542144e-01]
  HOMO = -0.583043827231811  LUMO = 0.975945272364388
  mo_energy =
[-1.18578730e+02 -1.23105628e+01 -9.56202547e+00 -9.56202547e+00
 -9.56202547e+00 -1.27021385e+00 -5.83043827e-01 -5.83043827e-01
 -5.83043827e-01  9.75945272e-01  1.01494273e+00  1.01494273e+00
  1.01494273e+00  7.29587260e+00  7.29587260e+00  7.29587260e+00
  1.23689255e+01  3.34465479e+01  3.34465479e+01  3.34465479e+01
  1.06642101e+02  1.29004741e+02  1.29004741e+02  1.29004741e+02
  4.83331623e+02  4.83331623e+02  4.83331623e+02  5.88371617e+02
  1.33515857e+03  1.33515857e+03  1.33515857e+03  2.65664320e+03
  3.02938837e+03  3.02938837e+03  3.02938837e+03  6.64981894e+03
  6.64981894e+03  6.64981894e+03  9.06200746e+03  2.54174996e+04
  7.61597314e+04]
E1 = -728.2850144178501  E_coul = 201.54804949001573
cycle= 4 E= -526.736964927834  delta_E= -1.9e-06  |g|= 0.0001  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.000116379
diis-c [-4.21296195e-09  7.45174391e-05 -1.05216428e-02 -6.87560713e-02
  1.07920320e+00]
  HOMO = -0.583025865983398  LUMO = 0.975979015457758
  mo_energy =
[-1.18578691e+02 -1.23104991e+01 -9.56197556e+00 -9.56197556e+00
 -9.56197556e+00 -1.27017269e+00 -5.83025866e-01 -5.83025866e-01
 -5.83025866e-01  9.75979015e-01  1.01495833e+00  1.01495833e+00
  1.01495833e+00  7.29591353e+00  7.29591353e+00  7.29591353e+00
  1.23689844e+01  3.34465959e+01  3.34465959e+01  3.34465959e+01
  1.06642151e+02  1.29004787e+02  1.29004787e+02  1.29004787e+02
  4.83331662e+02  4.83331662e+02  4.83331662e+02  5.88371649e+02
  1.33515860e+03  1.33515860e+03  1.33515860e+03  2.65664320e+03
  3.02938839e+03  3.02938839e+03  3.02938839e+03  6.64981895e+03
  6.64981895e+03  6.64981895e+03  9.06200746e+03  2.54174996e+04
  7.61597314e+04]
E1 = -728.2848033551066  E_coul = 201.54783842548014
cycle= 5 E= -526.736964929627  delta_E= -1.79e-09  |g|= 2.08e-05  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.91006e-05
diis-c [-7.83089574e-11  1.45925269e-05 -1.84930708e-03 -1.39755005e-02
  4.22834427e-02  9.73526772e-01]
  HOMO = -0.583033400081666  LUMO = 0.975975114628136
  mo_energy =
[-1.18578722e+02 -1.23105218e+01 -9.56200023e+00 -9.56200023e+00
 -9.56200023e+00 -1.27017866e+00 -5.83033400e-01 -5.83033400e-01
 -5.83033400e-01  9.75975115e-01  1.01495334e+00  1.01495334e+00
  1.01495334e+00  7.29589678e+00  7.29589678e+00  7.29589678e+00
  1.23689660e+01  3.34465720e+01  3.34465720e+01  3.34465720e+01
  1.06642124e+02  1.29004759e+02  1.29004759e+02  1.29004759e+02
  4.83331631e+02  4.83331631e+02  4.83331631e+02  5.88371617e+02
  1.33515857e+03  1.33515857e+03  1.33515857e+03  2.65664317e+03
  3.02938836e+03  3.02938836e+03  3.02938836e+03  6.64981892e+03
  6.64981892e+03  6.64981892e+03  9.06200742e+03  2.54174995e+04
  7.61597313e+04]
E1 = -728.284885086259  E_coul = 201.54792015656994
cycle= 6 E= -526.736964929689  delta_E= -6.25e-11  |g|= 1.77e-06  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.284885086259  E_coul = 201.54792015656994
  HOMO = -0.583033413277636  LUMO = 0.975975460282792
  mo_energy =
[-1.18578722e+02 -1.23105216e+01 -9.56200013e+00 -9.56200013e+00
 -9.56200013e+00 -1.27017827e+00 -5.83033413e-01 -5.83033413e-01
 -5.83033413e-01  9.75975460e-01  1.01495338e+00  1.01495338e+00
  1.01495338e+00  7.29589685e+00  7.29589685e+00  7.29589685e+00
  1.23689662e+01  3.34465721e+01  3.34465721e+01  3.34465721e+01
  1.06642124e+02  1.29004759e+02  1.29004759e+02  1.29004759e+02
  4.83331632e+02  4.83331632e+02  4.83331632e+02  5.88371618e+02
  1.33515857e+03  1.33515857e+03  1.33515857e+03  2.65664317e+03
  3.02938836e+03  3.02938836e+03  3.02938836e+03  6.64981892e+03
  6.64981892e+03  6.64981892e+03  9.06200742e+03  2.54174995e+04
  7.61597313e+04]
E1 = -728.2848838715555  E_coul = 201.54791894186644
Extra cycle  E= -526.736964929689  delta_E=    0  |g|= 3.66e-07  |ddm|= 3.12e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826563e+04 7.61752101e+03 3.61735130e+03 1.59780671e+03
 3.82856522e+02 1.08220202e+02 3.56453477e+01 8.10506638e+00
 3.18273410e+00 6.57532746e-01 2.40077559e-01 1.36278335e+03
 6.64744299e+02 3.00955469e+02 3.14036650e+02 6.16280073e+01
 7.33883373e+00 2.02328203e+01 7.75885611e-01 2.81904755e+00
 2.22829148e-01]
E = -526.7369649296891
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562732        1
[INPUT] 0    0    [1    /1   ]  7617.52100694        1
[INPUT] 0    0    [1    /1   ]  3617.35130455        1
[INPUT] 0    0    [1    /1   ]  1597.80670585        1
[INPUT] 0    0    [1    /1   ]  382.856521705        1
[INPUT] 0    0    [1    /1   ]  108.220201814        1
[INPUT] 0    0    [1    /1   ]  35.6453476948        1
[INPUT] 0    0    [1    /1   ]  8.10506637648        1
[INPUT] 0    0    [1    /1   ]  3.18273409595        1
[INPUT] 0    0    [1    /1   ]  0.657532745606       1
[INPUT] 0    0    [1    /1   ]  0.240077558951       1
[INPUT] 1    0    [1    /1   ]  1362.78334582        1
[INPUT] 1    0    [1    /1   ]  664.744298519        1
[INPUT] 1    0    [1    /1   ]  300.955468894        1
[INPUT] 1    0    [1    /1   ]  314.036650194        1
[INPUT] 1    0    [1    /1   ]  61.6280073386        1
[INPUT] 1    0    [1    /1   ]  7.33883373434        1
[INPUT] 1    0    [1    /1   ]  20.2328203417        1
[INPUT] 1    0    [1    /1   ]  0.775885610511       1
[INPUT] 1    0    [1    /1   ]  2.81904754846        1
[INPUT] 1    0    [1    /1   ]  0.222829147738       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656273205772, 1.0]], [0, [7617.521006943607, 1.0]], [0, [3617.351304553062, 1.0]], [0, [1597.8067058479492, 1.0]], [0, [382.8565217048176, 1.0]], [0, [108.22020181368029, 1.0]], [0, [35.645347694783865, 1.0]], [0, [8.105066376483745, 1.0]], [0, [3.182734095947288, 1.0]], [0, [0.6575327456060344, 1.0]], [0, [0.2400775589505028, 1.0]], [1, [1362.7833458229106, 1.0]], [1, [664.7442985186207, 1.0]], [1, [300.955468894289, 1.0]], [1, [314.036650194118, 1.0]], [1, [61.62800733858204, 1.0]], [1, [7.338833734336506, 1.0]], [1, [20.23282034166822, 1.0]], [1, [0.7758856105113556, 1.0]], [1, [2.8190475484639617, 1.0]], [1, [0.22282914773837265, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627321]
bas 1, expnt(s) = [7617.52100694]
bas 2, expnt(s) = [3617.35130455]
bas 3, expnt(s) = [1597.80670585]
bas 4, expnt(s) = [382.8565217]
bas 5, expnt(s) = [108.22020181]
bas 6, expnt(s) = [35.64534769]
bas 7, expnt(s) = [8.10506638]
bas 8, expnt(s) = [3.1827341]
bas 9, expnt(s) = [0.65753275]
bas 10, expnt(s) = [0.24007756]
bas 11, expnt(s) = [1362.78334582]
bas 12, expnt(s) = [664.74429852]
bas 13, expnt(s) = [300.95546889]
bas 14, expnt(s) = [314.03665019]
bas 15, expnt(s) = [61.62800734]
bas 16, expnt(s) = [7.33883373]
bas 17, expnt(s) = [20.23282034]
bas 18, expnt(s) = [0.77588561]
bas 19, expnt(s) = [2.81904755]
bas 20, expnt(s) = [0.22282915]
CPU time:       142.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752101e+03 2.06003818e+03
 3.61735130e+03 1.17844153e+03 1.59780671e+03 6.38496034e+02
 3.82856522e+02 2.18671438e+02 1.08220202e+02 8.47707994e+01
 3.56453477e+01 3.68567609e+01 8.10506638e+00 1.21361925e+01
 3.18273410e+00 6.02026061e+00 6.57532746e-01 1.84481603e+00
 2.40077559e-01 8.66520216e-01 1.36278335e+03 2.41556047e+04
 6.64744299e+02 9.84697123e+03 3.00955469e+02 3.65689249e+03
 3.14036650e+02 3.85664632e+03 6.16280073e+01 5.03740710e+02
 7.33883373e+00 3.52385641e+01 2.02328203e+01 1.25185758e+02
 7.75885611e-01 2.12437663e+00 2.81904755e+00 1.06564461e+01
 2.22829148e-01 4.46631543e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993637321447423
cond(S) = 103573.95611466763
E1 = -729.5219359000433  E_coul = 203.1765172429086
init E= -526.345418657135
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555773341033961  LUMO = 0.997049425713899
  mo_energy =
[-1.18327673e+02 -1.22050978e+01 -9.44702468e+00 -9.44702468e+00
 -9.44702468e+00 -1.24004816e+00 -5.55773341e-01 -5.55773341e-01
 -5.55773341e-01  9.97049426e-01  1.03363138e+00  1.03363138e+00
  1.03363138e+00  7.36676227e+00  7.36676227e+00  7.36676227e+00
  1.24529680e+01  3.35668778e+01  3.35668778e+01  3.35668778e+01
  1.06814678e+02  1.29186085e+02  1.29186085e+02  1.29186085e+02
  4.83581982e+02  4.83581982e+02  4.83581982e+02  5.88657899e+02
  1.33546207e+03  1.33546207e+03  1.33546207e+03  2.65707900e+03
  3.02975661e+03  3.02975661e+03  3.02975661e+03  6.65029933e+03
  6.65029933e+03  6.65029933e+03  9.06256272e+03  2.54181485e+04
  7.61604702e+04]
E1 = -727.8383824873243  E_coul = 201.10219996090743
cycle= 1 E= -526.736182526417  delta_E= -0.391  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540648
diis-c [-0.29230045  1.        ]
  HOMO = -0.590658703333606  LUMO = 0.969125106972842
  mo_energy =
[-1.18636516e+02 -1.23428127e+01 -9.59558246e+00 -9.59558246e+00
 -9.59558246e+00 -1.27943628e+00 -5.90658703e-01 -5.90658703e-01
 -5.90658703e-01  9.69125107e-01  1.00929375e+00  1.00929375e+00
  1.00929375e+00  7.27588397e+00  7.27588397e+00  7.27588397e+00
  1.23434997e+01  3.34126379e+01  3.34126379e+01  3.34126379e+01
  1.06594673e+02  1.28957171e+02  1.28957171e+02  1.28957171e+02
  4.83274535e+02  4.83274535e+02  4.83274535e+02  5.88312536e+02
  1.33509802e+03  1.33509802e+03  1.33509802e+03  2.65657997e+03
  3.02932597e+03  3.02932597e+03  3.02932597e+03  6.64975519e+03
  6.64975519e+03  6.64975519e+03  9.06194311e+03  2.54174348e+04
  7.61596665e+04]
E1 = -728.4125455369534  E_coul = 201.67564145556713
cycle= 2 E= -526.736904081386  delta_E= -0.000722  |g|= 0.0377  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752393
diis-c [-0.0032822   0.08317615  0.91682385]
  HOMO = -0.581552528646957  LUMO = 0.977164353880671
  mo_energy =
[-1.18568828e+02 -1.23047890e+01 -9.55590511e+00 -9.55590511e+00
 -9.55590511e+00 -1.26853385e+00 -5.81552529e-01 -5.81552529e-01
 -5.81552529e-01  9.77164354e-01  1.01601946e+00  1.01601946e+00
  1.01601946e+00  7.29963196e+00  7.29963196e+00  7.29963196e+00
  1.23735120e+01  3.34526848e+01  3.34526848e+01  3.34526848e+01
  1.06650316e+02  1.29013041e+02  1.29013041e+02  1.29013041e+02
  4.83341409e+02  4.83341409e+02  4.83341409e+02  5.88381753e+02
  1.33516894e+03  1.33516894e+03  1.33516894e+03  2.65665420e+03
  3.02939913e+03  3.02939913e+03  3.02939913e+03  6.64983009e+03
  6.64983009e+03  6.64983009e+03  9.06201882e+03  2.54175111e+04
  7.61597430e+04]
E1 = -728.2623754741625  E_coul = 201.5254124442759
cycle= 3 E= -526.736963029887  delta_E= -5.89e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130981
diis-c [-6.01298285e-07 -1.26387112e-03  1.43721728e-01  8.57542144e-01]
  HOMO = -0.583043827231811  LUMO = 0.975945272364388
  mo_energy =
[-1.18578730e+02 -1.23105628e+01 -9.56202547e+00 -9.56202547e+00
 -9.56202547e+00 -1.27021385e+00 -5.83043827e-01 -5.83043827e-01
 -5.83043827e-01  9.75945272e-01  1.01494273e+00  1.01494273e+00
  1.01494273e+00  7.29587260e+00  7.29587260e+00  7.29587260e+00
  1.23689255e+01  3.34465479e+01  3.34465479e+01  3.34465479e+01
  1.06642101e+02  1.29004741e+02  1.29004741e+02  1.29004741e+02
  4.83331623e+02  4.83331623e+02  4.83331623e+02  5.88371617e+02
  1.33515857e+03  1.33515857e+03  1.33515857e+03  2.65664320e+03
  3.02938837e+03  3.02938837e+03  3.02938837e+03  6.64981894e+03
  6.64981894e+03  6.64981894e+03  9.06200746e+03  2.54174996e+04
  7.61597314e+04]
E1 = -728.2850144178501  E_coul = 201.54804949001573
cycle= 4 E= -526.736964927834  delta_E= -1.9e-06  |g|= 0.0001  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116379
diis-c [-4.21296195e-09  7.45174391e-05 -1.05216428e-02 -6.87560713e-02
  1.07920320e+00]
  HOMO = -0.583025865983398  LUMO = 0.975979015457758
  mo_energy =
[-1.18578691e+02 -1.23104991e+01 -9.56197556e+00 -9.56197556e+00
 -9.56197556e+00 -1.27017269e+00 -5.83025866e-01 -5.83025866e-01
 -5.83025866e-01  9.75979015e-01  1.01495833e+00  1.01495833e+00
  1.01495833e+00  7.29591353e+00  7.29591353e+00  7.29591353e+00
  1.23689844e+01  3.34465959e+01  3.34465959e+01  3.34465959e+01
  1.06642151e+02  1.29004787e+02  1.29004787e+02  1.29004787e+02
  4.83331662e+02  4.83331662e+02  4.83331662e+02  5.88371649e+02
  1.33515860e+03  1.33515860e+03  1.33515860e+03  2.65664320e+03
  3.02938839e+03  3.02938839e+03  3.02938839e+03  6.64981895e+03
  6.64981895e+03  6.64981895e+03  9.06200746e+03  2.54174996e+04
  7.61597314e+04]
E1 = -728.2848033551066  E_coul = 201.54783842548014
cycle= 5 E= -526.736964929627  delta_E= -1.79e-09  |g|= 2.08e-05  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.91006e-05
diis-c [-7.83089574e-11  1.45925269e-05 -1.84930708e-03 -1.39755005e-02
  4.22834427e-02  9.73526772e-01]
  HOMO = -0.583033400081666  LUMO = 0.975975114628136
  mo_energy =
[-1.18578722e+02 -1.23105218e+01 -9.56200023e+00 -9.56200023e+00
 -9.56200023e+00 -1.27017866e+00 -5.83033400e-01 -5.83033400e-01
 -5.83033400e-01  9.75975115e-01  1.01495334e+00  1.01495334e+00
  1.01495334e+00  7.29589678e+00  7.29589678e+00  7.29589678e+00
  1.23689660e+01  3.34465720e+01  3.34465720e+01  3.34465720e+01
  1.06642124e+02  1.29004759e+02  1.29004759e+02  1.29004759e+02
  4.83331631e+02  4.83331631e+02  4.83331631e+02  5.88371617e+02
  1.33515857e+03  1.33515857e+03  1.33515857e+03  2.65664317e+03
  3.02938836e+03  3.02938836e+03  3.02938836e+03  6.64981892e+03
  6.64981892e+03  6.64981892e+03  9.06200742e+03  2.54174995e+04
  7.61597313e+04]
E1 = -728.284885086259  E_coul = 201.54792015656994
cycle= 6 E= -526.736964929689  delta_E= -6.25e-11  |g|= 1.77e-06  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.284885086259  E_coul = 201.54792015656994
  HOMO = -0.583033413277636  LUMO = 0.975975460282792
  mo_energy =
[-1.18578722e+02 -1.23105216e+01 -9.56200013e+00 -9.56200013e+00
 -9.56200013e+00 -1.27017827e+00 -5.83033413e-01 -5.83033413e-01
 -5.83033413e-01  9.75975460e-01  1.01495338e+00  1.01495338e+00
  1.01495338e+00  7.29589685e+00  7.29589685e+00  7.29589685e+00
  1.23689662e+01  3.34465721e+01  3.34465721e+01  3.34465721e+01
  1.06642124e+02  1.29004759e+02  1.29004759e+02  1.29004759e+02
  4.83331632e+02  4.83331632e+02  4.83331632e+02  5.88371618e+02
  1.33515857e+03  1.33515857e+03  1.33515857e+03  2.65664317e+03
  3.02938836e+03  3.02938836e+03  3.02938836e+03  6.64981892e+03
  6.64981892e+03  6.64981892e+03  9.06200742e+03  2.54174995e+04
  7.61597313e+04]
E1 = -728.2848838715555  E_coul = 201.54791894186644
Extra cycle  E= -526.736964929689  delta_E=    0  |g|= 3.66e-07  |ddm|= 3.12e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103573.95611466763
E1 = -728.2848838715555  E_coul = 201.54791894186644
init E= -526.736964929689
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583033449465766  LUMO = 0.975975503012173
  mo_energy =
[-1.18578722e+02 -1.23105217e+01 -9.56200023e+00 -9.56200023e+00
 -9.56200023e+00 -1.27017823e+00 -5.83033449e-01 -5.83033449e-01
 -5.83033449e-01  9.75975503e-01  1.01495337e+00  1.01495337e+00
  1.01495337e+00  7.29589678e+00  7.29589678e+00  7.29589678e+00
  1.23689662e+01  3.34465720e+01  3.34465720e+01  3.34465720e+01
  1.06642124e+02  1.29004759e+02  1.29004759e+02  1.29004759e+02
  4.83331632e+02  4.83331632e+02  4.83331632e+02  5.88371617e+02
  1.33515857e+03  1.33515857e+03  1.33515857e+03  2.65664317e+03
  3.02938836e+03  3.02938836e+03  3.02938836e+03  6.64981892e+03
  6.64981892e+03  6.64981892e+03  9.06200742e+03  2.54174995e+04
  7.61597313e+04]
E1 = -728.2848840881644  E_coul = 201.5479191584765
cycle= 1 E= -526.736964929688  delta_E= 1.14e-12  |g|= 7.76e-08  |ddm|= 6.09e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2848840881644  E_coul = 201.5479191584765
  HOMO = -0.583033448101177  LUMO = 0.975975519193597
  mo_energy =
[-1.18578722e+02 -1.23105217e+01 -9.56200022e+00 -9.56200022e+00
 -9.56200022e+00 -1.27017822e+00 -5.83033448e-01 -5.83033448e-01
 -5.83033448e-01  9.75975519e-01  1.01495337e+00  1.01495337e+00
  1.01495337e+00  7.29589679e+00  7.29589679e+00  7.29589679e+00
  1.23689662e+01  3.34465720e+01  3.34465720e+01  3.34465720e+01
  1.06642124e+02  1.29004759e+02  1.29004759e+02  1.29004759e+02
  4.83331632e+02  4.83331632e+02  4.83331632e+02  5.88371617e+02
  1.33515857e+03  1.33515857e+03  1.33515857e+03  2.65664317e+03
  3.02938836e+03  3.02938836e+03  3.02938836e+03  6.64981892e+03
  6.64981892e+03  6.64981892e+03  9.06200742e+03  2.54174995e+04
  7.61597313e+04]
E1 = -728.2848840014846  E_coul = 201.54791907179532
Extra cycle  E= -526.736964929689  delta_E= -1.36e-12  |g|= 1.58e-08  |ddm|= 1.3e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826563e+04 7.61752101e+03 3.61735130e+03 1.59780671e+03
 3.82856522e+02 1.08220202e+02 3.56453477e+01 8.10506638e+00
 3.18273410e+00 6.57532746e-01 2.40077559e-01 1.36278335e+03
 6.64744299e+02 3.00955469e+02 3.14036650e+02 6.16280073e+01
 7.33883373e+00 2.02328203e+01 7.75885611e-01 2.81904755e+00
 2.22829148e-01]
grad_E = [-1.50572037e-06  3.17870263e-06 -1.64534595e-06  6.41989993e-05
  1.38391211e-04 -1.75830209e-03  3.53759808e-04 -4.98784793e-04
  5.60363741e-04 -4.36605494e-04  7.56056508e-04 -5.07623192e-07
  4.99560295e-06  2.35467563e-05  2.03017144e-05 -1.04885086e-05
 -1.10418573e-04 -2.80909598e-05 -1.04609045e-03  4.39392164e-04
  3.31878865e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656278         1
[INPUT] 0    0    [1    /1   ]  7617.52099717        1
[INPUT] 0    0    [1    /1   ]  3617.35130996        1
[INPUT] 0    0    [1    /1   ]  1597.80651498        1
[INPUT] 0    0    [1    /1   ]  382.855628578        1
[INPUT] 0    0    [1    /1   ]  108.229799482        1
[INPUT] 0    0    [1    /1   ]  35.6344055065        1
[INPUT] 0    0    [1    /1   ]  8.1001505516         1
[INPUT] 0    0    [1    /1   ]  3.18091445612        1
[INPUT] 0    0    [1    /1   ]  0.656005129851       1
[INPUT] 0    0    [1    /1   ]  0.23954880905        1
[INPUT] 1    0    [1    /1   ]  1362.78334745        1
[INPUT] 1    0    [1    /1   ]  664.744282831        1
[INPUT] 1    0    [1    /1   ]  300.955395233        1
[INPUT] 1    0    [1    /1   ]  314.03658668         1
[INPUT] 1    0    [1    /1   ]  61.6278926148        1
[INPUT] 1    0    [1    /1   ]  7.3353573626         1
[INPUT] 1    0    [1    /1   ]  20.2341706065        1
[INPUT] 1    0    [1    /1   ]  0.776022471826       1
[INPUT] 1    0    [1    /1   ]  2.8217969088         1
[INPUT] 1    0    [1    /1   ]  0.222855620983       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656277967886, 1.0]], [0, [7617.5209971654085, 1.0]], [0, [3617.351309961769, 1.0]], [0, [1597.8065149804615, 1.0]], [0, [382.8556285784813, 1.0]], [0, [108.22979948156326, 1.0]], [0, [35.63440550647347, 1.0]], [0, [8.100150551599954, 1.0]], [0, [3.1809144561242, 1.0]], [0, [0.656005129851216, 1.0]], [0, [0.23954880905049808, 1.0]], [1, [1362.7833474537451, 1.0]], [1, [664.744282830586, 1.0]], [1, [300.95539523269827, 1.0]], [1, [314.0365866802108, 1.0]], [1, [61.62789261479242, 1.0]], [1, [7.33535736259988, 1.0]], [1, [20.2341706065193, 1.0]], [1, [0.7760224718259529, 1.0]], [1, [2.8217969088039556, 1.0]], [1, [0.22285562098339648, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627797]
bas 1, expnt(s) = [7617.52099717]
bas 2, expnt(s) = [3617.35130996]
bas 3, expnt(s) = [1597.80651498]
bas 4, expnt(s) = [382.85562858]
bas 5, expnt(s) = [108.22979948]
bas 6, expnt(s) = [35.63440551]
bas 7, expnt(s) = [8.10015055]
bas 8, expnt(s) = [3.18091446]
bas 9, expnt(s) = [0.65600513]
bas 10, expnt(s) = [0.23954881]
bas 11, expnt(s) = [1362.78334745]
bas 12, expnt(s) = [664.74428283]
bas 13, expnt(s) = [300.95539523]
bas 14, expnt(s) = [314.03658668]
bas 15, expnt(s) = [61.62789261]
bas 16, expnt(s) = [7.33535736]
bas 17, expnt(s) = [20.23417061]
bas 18, expnt(s) = [0.77602247]
bas 19, expnt(s) = [2.82179691]
bas 20, expnt(s) = [0.22285562]
CPU time:       148.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752100e+03 2.06003818e+03
 3.61735131e+03 1.17844153e+03 1.59780651e+03 6.38495977e+02
 3.82855629e+02 2.18671056e+02 1.08229799e+02 8.47764379e+01
 3.56344055e+01 3.68482751e+01 8.10015055e+00 1.21306715e+01
 3.18091446e+00 6.01767899e+00 6.56005130e-01 1.84160061e+00
 2.39548809e-01 8.65088495e-01 1.36278335e+03 2.41556048e+04
 6.64744283e+02 9.84697094e+03 3.00955395e+02 3.65689137e+03
 3.14036587e+02 3.85664534e+03 6.16278926e+01 5.03739537e+02
 7.33535736e+00 3.52176999e+01 2.02341706e+01 1.25196201e+02
 7.76022472e-01 2.12484505e+00 2.82179691e+00 1.06694390e+01
 2.22855621e-01 4.46697872e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99363704085213
cond(S) = 103566.3525453697
E1 = -729.5218569665242  E_coul = 203.1764129615505
init E= -526.345444004974
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555776877238876  LUMO = 0.993248248694731
  mo_energy =
[-1.18327691e+02 -1.22051026e+01 -9.44703245e+00 -9.44703245e+00
 -9.44703245e+00 -1.24005084e+00 -5.55776877e-01 -5.55776877e-01
 -5.55776877e-01  9.93248249e-01  1.03389520e+00  1.03389520e+00
  1.03389520e+00  7.37097581e+00  7.37097581e+00  7.37097581e+00
  1.24324797e+01  3.35698889e+01  3.35698889e+01  3.35698889e+01
  1.06761668e+02  1.29187236e+02  1.29187236e+02  1.29187236e+02
  4.83583092e+02  4.83583092e+02  4.83583092e+02  5.88608377e+02
  1.33546294e+03  1.33546294e+03  1.33546294e+03  2.65704248e+03
  3.02975720e+03  3.02975720e+03  3.02975720e+03  6.65029971e+03
  6.65029971e+03  6.65029971e+03  9.06253019e+03  2.54181177e+04
  7.61604415e+04]
E1 = -727.8383665585538  E_coul = 201.10217031089275
cycle= 1 E= -526.736196247661  delta_E= -0.391  |g|= 0.186  |ddm|= 0.317
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540783
diis-c [-0.29244634  1.        ]
  HOMO = -0.590668772345171  LUMO = 0.965410068371408
  mo_energy =
[-1.18636543e+02 -1.23427934e+01 -9.59557625e+00 -9.59557625e+00
 -9.59557625e+00 -1.27943889e+00 -5.90668772e-01 -5.90668772e-01
 -5.90668772e-01  9.65410068e-01  1.00954361e+00  1.00954361e+00
  1.00954361e+00  7.28009133e+00  7.28009133e+00  7.28009133e+00
  1.23230980e+01  3.34156649e+01  3.34156649e+01  3.34156649e+01
  1.06541665e+02  1.28958325e+02  1.28958325e+02  1.28958325e+02
  4.83275632e+02  4.83275632e+02  4.83275632e+02  5.88262991e+02
  1.33509887e+03  1.33509887e+03  1.33509887e+03  2.65654342e+03
  3.02932654e+03  3.02932654e+03  3.02932654e+03  6.64975554e+03
  6.64975554e+03  6.64975554e+03  9.06191056e+03  2.54174040e+04
  7.61596377e+04]
E1 = -728.4125002250478  E_coul = 201.67558227673413
cycle= 2 E= -526.736917948314  delta_E= -0.000722  |g|= 0.0377  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752531
diis-c [-0.00328185  0.08319568  0.91680432]
  HOMO = -0.581564342596204  LUMO = 0.973425419053415
  mo_energy =
[-1.18568854e+02 -1.23047726e+01 -9.55590224e+00 -9.55590224e+00
 -9.55590224e+00 -1.26853822e+00 -5.81564343e-01 -5.81564343e-01
 -5.81564343e-01  9.73425419e-01  1.01627068e+00  1.01627068e+00
  1.01627068e+00  7.30384178e+00  7.30384178e+00  7.30384178e+00
  1.23530964e+01  3.34557072e+01  3.34557072e+01  3.34557072e+01
  1.06597306e+02  1.29014194e+02  1.29014194e+02  1.29014194e+02
  4.83342507e+02  4.83342507e+02  4.83342507e+02  5.88332209e+02
  1.33516979e+03  1.33516979e+03  1.33516979e+03  2.65661766e+03
  3.02939970e+03  3.02939970e+03  3.02939970e+03  6.64983044e+03
  6.64983044e+03  6.64983044e+03  9.06198627e+03  2.54174803e+04
  7.61597143e+04]
E1 = -728.2623546268738  E_coul = 201.52537773964173
cycle= 3 E= -526.736976887232  delta_E= -5.89e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130962
diis-c [-6.03590439e-07 -1.26426382e-03  1.43674932e-01  8.57589331e-01]
  HOMO = -0.583055470021803  LUMO = 0.972210258414988
  mo_energy =
[-1.18578753e+02 -1.23105445e+01 -9.56202082e+00 -9.56202082e+00
 -9.56202082e+00 -1.27021771e+00 -5.83055470e-01 -5.83055470e-01
 -5.83055470e-01  9.72210258e-01  1.01519371e+00  1.01519371e+00
  1.01519371e+00  7.30008250e+00  7.30008250e+00  7.30008250e+00
  1.23485133e+01  3.34495724e+01  3.34495724e+01  3.34495724e+01
  1.06589093e+02  1.29005897e+02  1.29005897e+02  1.29005897e+02
  4.83332724e+02  4.83332724e+02  4.83332724e+02  5.88322076e+02
  1.33515942e+03  1.33515942e+03  1.33515942e+03  2.65660666e+03
  3.02938895e+03  3.02938895e+03  3.02938895e+03  6.64981930e+03
  6.64981930e+03  6.64981930e+03  9.06197491e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2849840493128  E_coul = 201.5480052655256
cycle= 4 E= -526.736978783787  delta_E= -1.9e-06  |g|= 0.0001  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116691
diis-c [-4.23357087e-09  7.47217151e-05 -1.05436414e-02 -6.89251917e-02
  1.07939411e+00]
  HOMO = -0.583037493594847  LUMO = 0.97224400648375
  mo_energy =
[-1.18578714e+02 -1.23104806e+01 -9.56197081e+00 -9.56197081e+00
 -9.56197081e+00 -1.27017645e+00 -5.83037494e-01 -5.83037494e-01
 -5.83037494e-01  9.72244006e-01  1.01520935e+00  1.01520935e+00
  1.01520935e+00  7.30012351e+00  7.30012351e+00  7.30012351e+00
  1.23485723e+01  3.34496205e+01  3.34496205e+01  3.34496205e+01
  1.06589144e+02  1.29005943e+02  1.29005943e+02  1.29005943e+02
  4.83332763e+02  4.83332763e+02  4.83332763e+02  5.88322108e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65660667e+03
  3.02938897e+03  3.02938897e+03  3.02938897e+03  6.64981930e+03
  6.64981930e+03  6.64981930e+03  9.06197491e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2847723401536  E_coul = 201.54779355456023
cycle= 5 E= -526.736978785593  delta_E= -1.81e-09  |g|= 2.08e-05  |ddm|= 0.000163
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.9188e-05
diis-c [-7.88554421e-11  1.46143402e-05 -1.85098024e-03 -1.39967846e-02
  4.23953136e-02  9.73437837e-01]
  HOMO = -0.583045052745367  LUMO = 0.972240105184009
  mo_energy =
[-1.18578745e+02 -1.23105034e+01 -9.56199555e+00 -9.56199555e+00
 -9.56199555e+00 -1.27018244e+00 -5.83045053e-01 -5.83045053e-01
 -5.83045053e-01  9.72240105e-01  1.01520433e+00  1.01520433e+00
  1.01520433e+00  7.30010670e+00  7.30010670e+00  7.30010670e+00
  1.23485539e+01  3.34495965e+01  3.34495965e+01  3.34495965e+01
  1.06589116e+02  1.29005915e+02  1.29005915e+02  1.29005915e+02
  4.83332732e+02  4.83332732e+02  4.83332732e+02  5.88322076e+02
  1.33515942e+03  1.33515942e+03  1.33515942e+03  2.65660663e+03
  3.02938894e+03  3.02938894e+03  3.02938894e+03  6.64981927e+03
  6.64981927e+03  6.64981927e+03  9.06197487e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2848542487742  E_coul = 201.54787546311925
cycle= 6 E= -526.736978785655  delta_E= -6.16e-11  |g|= 1.78e-06  |ddm|= 1.91e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2848542487742  E_coul = 201.54787546311925
  HOMO = -0.583045066962185  LUMO = 0.972240450568247
  mo_energy =
[-1.18578745e+02 -1.23105033e+01 -9.56199545e+00 -9.56199545e+00
 -9.56199545e+00 -1.27018206e+00 -5.83045067e-01 -5.83045067e-01
 -5.83045067e-01  9.72240451e-01  1.01520438e+00  1.01520438e+00
  1.01520438e+00  7.30010677e+00  7.30010677e+00  7.30010677e+00
  1.23485541e+01  3.34495966e+01  3.34495966e+01  3.34495966e+01
  1.06589117e+02  1.29005915e+02  1.29005915e+02  1.29005915e+02
  4.83332733e+02  4.83332733e+02  4.83332733e+02  5.88322076e+02
  1.33515942e+03  1.33515942e+03  1.33515942e+03  2.65660663e+03
  3.02938894e+03  3.02938894e+03  3.02938894e+03  6.64981927e+03
  6.64981927e+03  6.64981927e+03  9.06197487e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2848530273606  E_coul = 201.54787424170448
Extra cycle  E= -526.736978785656  delta_E= -1.14e-12  |g|= 3.67e-07  |ddm|= 3.13e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826563e+04 7.61752100e+03 3.61735131e+03 1.59780651e+03
 3.82855629e+02 1.08229799e+02 3.56344055e+01 8.10015055e+00
 3.18091446e+00 6.56005130e-01 2.39548809e-01 1.36278335e+03
 6.64744283e+02 3.00955395e+02 3.14036587e+02 6.16278926e+01
 7.33535736e+00 2.02341706e+01 7.76022472e-01 2.82179691e+00
 2.22855621e-01]
E = -526.7369787856561
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656278         1
[INPUT] 0    0    [1    /1   ]  7617.52099717        1
[INPUT] 0    0    [1    /1   ]  3617.35130996        1
[INPUT] 0    0    [1    /1   ]  1597.80651498        1
[INPUT] 0    0    [1    /1   ]  382.855628578        1
[INPUT] 0    0    [1    /1   ]  108.229799482        1
[INPUT] 0    0    [1    /1   ]  35.6344055065        1
[INPUT] 0    0    [1    /1   ]  8.1001505516         1
[INPUT] 0    0    [1    /1   ]  3.18091445612        1
[INPUT] 0    0    [1    /1   ]  0.656005129851       1
[INPUT] 0    0    [1    /1   ]  0.23954880905        1
[INPUT] 1    0    [1    /1   ]  1362.78334745        1
[INPUT] 1    0    [1    /1   ]  664.744282831        1
[INPUT] 1    0    [1    /1   ]  300.955395233        1
[INPUT] 1    0    [1    /1   ]  314.03658668         1
[INPUT] 1    0    [1    /1   ]  61.6278926148        1
[INPUT] 1    0    [1    /1   ]  7.3353573626         1
[INPUT] 1    0    [1    /1   ]  20.2341706065        1
[INPUT] 1    0    [1    /1   ]  0.776022471826       1
[INPUT] 1    0    [1    /1   ]  2.8217969088         1
[INPUT] 1    0    [1    /1   ]  0.222855620983       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656277967886, 1.0]], [0, [7617.5209971654085, 1.0]], [0, [3617.351309961769, 1.0]], [0, [1597.8065149804615, 1.0]], [0, [382.8556285784813, 1.0]], [0, [108.22979948156326, 1.0]], [0, [35.63440550647347, 1.0]], [0, [8.100150551599954, 1.0]], [0, [3.1809144561242, 1.0]], [0, [0.656005129851216, 1.0]], [0, [0.23954880905049808, 1.0]], [1, [1362.7833474537451, 1.0]], [1, [664.744282830586, 1.0]], [1, [300.95539523269827, 1.0]], [1, [314.0365866802108, 1.0]], [1, [61.62789261479242, 1.0]], [1, [7.33535736259988, 1.0]], [1, [20.2341706065193, 1.0]], [1, [0.7760224718259529, 1.0]], [1, [2.8217969088039556, 1.0]], [1, [0.22285562098339648, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65627797]
bas 1, expnt(s) = [7617.52099717]
bas 2, expnt(s) = [3617.35130996]
bas 3, expnt(s) = [1597.80651498]
bas 4, expnt(s) = [382.85562858]
bas 5, expnt(s) = [108.22979948]
bas 6, expnt(s) = [35.63440551]
bas 7, expnt(s) = [8.10015055]
bas 8, expnt(s) = [3.18091446]
bas 9, expnt(s) = [0.65600513]
bas 10, expnt(s) = [0.23954881]
bas 11, expnt(s) = [1362.78334745]
bas 12, expnt(s) = [664.74428283]
bas 13, expnt(s) = [300.95539523]
bas 14, expnt(s) = [314.03658668]
bas 15, expnt(s) = [61.62789261]
bas 16, expnt(s) = [7.33535736]
bas 17, expnt(s) = [20.23417061]
bas 18, expnt(s) = [0.77602247]
bas 19, expnt(s) = [2.82179691]
bas 20, expnt(s) = [0.22285562]
CPU time:       149.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752100e+03 2.06003818e+03
 3.61735131e+03 1.17844153e+03 1.59780651e+03 6.38495977e+02
 3.82855629e+02 2.18671056e+02 1.08229799e+02 8.47764379e+01
 3.56344055e+01 3.68482751e+01 8.10015055e+00 1.21306715e+01
 3.18091446e+00 6.01767899e+00 6.56005130e-01 1.84160061e+00
 2.39548809e-01 8.65088495e-01 1.36278335e+03 2.41556048e+04
 6.64744283e+02 9.84697094e+03 3.00955395e+02 3.65689137e+03
 3.14036587e+02 3.85664534e+03 6.16278926e+01 5.03739537e+02
 7.33535736e+00 3.52176999e+01 2.02341706e+01 1.25196201e+02
 7.76022472e-01 2.12484505e+00 2.82179691e+00 1.06694390e+01
 2.22855621e-01 4.46697872e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99363704085213
cond(S) = 103566.3525453697
E1 = -729.5218569665242  E_coul = 203.1764129615505
init E= -526.345444004974
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555776877238876  LUMO = 0.993248248694731
  mo_energy =
[-1.18327691e+02 -1.22051026e+01 -9.44703245e+00 -9.44703245e+00
 -9.44703245e+00 -1.24005084e+00 -5.55776877e-01 -5.55776877e-01
 -5.55776877e-01  9.93248249e-01  1.03389520e+00  1.03389520e+00
  1.03389520e+00  7.37097581e+00  7.37097581e+00  7.37097581e+00
  1.24324797e+01  3.35698889e+01  3.35698889e+01  3.35698889e+01
  1.06761668e+02  1.29187236e+02  1.29187236e+02  1.29187236e+02
  4.83583092e+02  4.83583092e+02  4.83583092e+02  5.88608377e+02
  1.33546294e+03  1.33546294e+03  1.33546294e+03  2.65704248e+03
  3.02975720e+03  3.02975720e+03  3.02975720e+03  6.65029971e+03
  6.65029971e+03  6.65029971e+03  9.06253019e+03  2.54181177e+04
  7.61604415e+04]
E1 = -727.8383665585538  E_coul = 201.10217031089275
cycle= 1 E= -526.736196247661  delta_E= -0.391  |g|= 0.186  |ddm|= 0.317
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540783
diis-c [-0.29244634  1.        ]
  HOMO = -0.590668772345171  LUMO = 0.965410068371408
  mo_energy =
[-1.18636543e+02 -1.23427934e+01 -9.59557625e+00 -9.59557625e+00
 -9.59557625e+00 -1.27943889e+00 -5.90668772e-01 -5.90668772e-01
 -5.90668772e-01  9.65410068e-01  1.00954361e+00  1.00954361e+00
  1.00954361e+00  7.28009133e+00  7.28009133e+00  7.28009133e+00
  1.23230980e+01  3.34156649e+01  3.34156649e+01  3.34156649e+01
  1.06541665e+02  1.28958325e+02  1.28958325e+02  1.28958325e+02
  4.83275632e+02  4.83275632e+02  4.83275632e+02  5.88262991e+02
  1.33509887e+03  1.33509887e+03  1.33509887e+03  2.65654342e+03
  3.02932654e+03  3.02932654e+03  3.02932654e+03  6.64975554e+03
  6.64975554e+03  6.64975554e+03  9.06191056e+03  2.54174040e+04
  7.61596377e+04]
E1 = -728.4125002250478  E_coul = 201.67558227673413
cycle= 2 E= -526.736917948314  delta_E= -0.000722  |g|= 0.0377  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752531
diis-c [-0.00328185  0.08319568  0.91680432]
  HOMO = -0.581564342596204  LUMO = 0.973425419053415
  mo_energy =
[-1.18568854e+02 -1.23047726e+01 -9.55590224e+00 -9.55590224e+00
 -9.55590224e+00 -1.26853822e+00 -5.81564343e-01 -5.81564343e-01
 -5.81564343e-01  9.73425419e-01  1.01627068e+00  1.01627068e+00
  1.01627068e+00  7.30384178e+00  7.30384178e+00  7.30384178e+00
  1.23530964e+01  3.34557072e+01  3.34557072e+01  3.34557072e+01
  1.06597306e+02  1.29014194e+02  1.29014194e+02  1.29014194e+02
  4.83342507e+02  4.83342507e+02  4.83342507e+02  5.88332209e+02
  1.33516979e+03  1.33516979e+03  1.33516979e+03  2.65661766e+03
  3.02939970e+03  3.02939970e+03  3.02939970e+03  6.64983044e+03
  6.64983044e+03  6.64983044e+03  9.06198627e+03  2.54174803e+04
  7.61597143e+04]
E1 = -728.2623546268738  E_coul = 201.52537773964173
cycle= 3 E= -526.736976887232  delta_E= -5.89e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130962
diis-c [-6.03590439e-07 -1.26426382e-03  1.43674932e-01  8.57589331e-01]
  HOMO = -0.583055470021803  LUMO = 0.972210258414988
  mo_energy =
[-1.18578753e+02 -1.23105445e+01 -9.56202082e+00 -9.56202082e+00
 -9.56202082e+00 -1.27021771e+00 -5.83055470e-01 -5.83055470e-01
 -5.83055470e-01  9.72210258e-01  1.01519371e+00  1.01519371e+00
  1.01519371e+00  7.30008250e+00  7.30008250e+00  7.30008250e+00
  1.23485133e+01  3.34495724e+01  3.34495724e+01  3.34495724e+01
  1.06589093e+02  1.29005897e+02  1.29005897e+02  1.29005897e+02
  4.83332724e+02  4.83332724e+02  4.83332724e+02  5.88322076e+02
  1.33515942e+03  1.33515942e+03  1.33515942e+03  2.65660666e+03
  3.02938895e+03  3.02938895e+03  3.02938895e+03  6.64981930e+03
  6.64981930e+03  6.64981930e+03  9.06197491e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2849840493128  E_coul = 201.5480052655256
cycle= 4 E= -526.736978783787  delta_E= -1.9e-06  |g|= 0.0001  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000116691
diis-c [-4.23357087e-09  7.47217151e-05 -1.05436414e-02 -6.89251917e-02
  1.07939411e+00]
  HOMO = -0.583037493594847  LUMO = 0.97224400648375
  mo_energy =
[-1.18578714e+02 -1.23104806e+01 -9.56197081e+00 -9.56197081e+00
 -9.56197081e+00 -1.27017645e+00 -5.83037494e-01 -5.83037494e-01
 -5.83037494e-01  9.72244006e-01  1.01520935e+00  1.01520935e+00
  1.01520935e+00  7.30012351e+00  7.30012351e+00  7.30012351e+00
  1.23485723e+01  3.34496205e+01  3.34496205e+01  3.34496205e+01
  1.06589144e+02  1.29005943e+02  1.29005943e+02  1.29005943e+02
  4.83332763e+02  4.83332763e+02  4.83332763e+02  5.88322108e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65660667e+03
  3.02938897e+03  3.02938897e+03  3.02938897e+03  6.64981930e+03
  6.64981930e+03  6.64981930e+03  9.06197491e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2847723401536  E_coul = 201.54779355456023
cycle= 5 E= -526.736978785593  delta_E= -1.81e-09  |g|= 2.08e-05  |ddm|= 0.000163
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.9188e-05
diis-c [-7.88554421e-11  1.46143402e-05 -1.85098024e-03 -1.39967846e-02
  4.23953136e-02  9.73437837e-01]
  HOMO = -0.583045052745367  LUMO = 0.972240105184009
  mo_energy =
[-1.18578745e+02 -1.23105034e+01 -9.56199555e+00 -9.56199555e+00
 -9.56199555e+00 -1.27018244e+00 -5.83045053e-01 -5.83045053e-01
 -5.83045053e-01  9.72240105e-01  1.01520433e+00  1.01520433e+00
  1.01520433e+00  7.30010670e+00  7.30010670e+00  7.30010670e+00
  1.23485539e+01  3.34495965e+01  3.34495965e+01  3.34495965e+01
  1.06589116e+02  1.29005915e+02  1.29005915e+02  1.29005915e+02
  4.83332732e+02  4.83332732e+02  4.83332732e+02  5.88322076e+02
  1.33515942e+03  1.33515942e+03  1.33515942e+03  2.65660663e+03
  3.02938894e+03  3.02938894e+03  3.02938894e+03  6.64981927e+03
  6.64981927e+03  6.64981927e+03  9.06197487e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2848542487742  E_coul = 201.54787546311925
cycle= 6 E= -526.736978785655  delta_E= -6.16e-11  |g|= 1.78e-06  |ddm|= 1.91e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2848542487742  E_coul = 201.54787546311925
  HOMO = -0.583045066962185  LUMO = 0.972240450568247
  mo_energy =
[-1.18578745e+02 -1.23105033e+01 -9.56199545e+00 -9.56199545e+00
 -9.56199545e+00 -1.27018206e+00 -5.83045067e-01 -5.83045067e-01
 -5.83045067e-01  9.72240451e-01  1.01520438e+00  1.01520438e+00
  1.01520438e+00  7.30010677e+00  7.30010677e+00  7.30010677e+00
  1.23485541e+01  3.34495966e+01  3.34495966e+01  3.34495966e+01
  1.06589117e+02  1.29005915e+02  1.29005915e+02  1.29005915e+02
  4.83332733e+02  4.83332733e+02  4.83332733e+02  5.88322076e+02
  1.33515942e+03  1.33515942e+03  1.33515942e+03  2.65660663e+03
  3.02938894e+03  3.02938894e+03  3.02938894e+03  6.64981927e+03
  6.64981927e+03  6.64981927e+03  9.06197487e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2848530273606  E_coul = 201.54787424170448
Extra cycle  E= -526.736978785656  delta_E= -1.14e-12  |g|= 3.67e-07  |ddm|= 3.13e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103566.3525453697
E1 = -728.2848530273606  E_coul = 201.54787424170448
init E= -526.736978785656
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583045103422249  LUMO = 0.972240493304454
  mo_energy =
[-1.18578745e+02 -1.23105033e+01 -9.56199556e+00 -9.56199556e+00
 -9.56199556e+00 -1.27018202e+00 -5.83045103e-01 -5.83045103e-01
 -5.83045103e-01  9.72240493e-01  1.01520436e+00  1.01520436e+00
  1.01520436e+00  7.30010671e+00  7.30010671e+00  7.30010671e+00
  1.23485541e+01  3.34495965e+01  3.34495965e+01  3.34495965e+01
  1.06589117e+02  1.29005915e+02  1.29005915e+02  1.29005915e+02
  4.83332733e+02  4.83332733e+02  4.83332733e+02  5.88322076e+02
  1.33515942e+03  1.33515942e+03  1.33515942e+03  2.65660663e+03
  3.02938894e+03  3.02938894e+03  3.02938894e+03  6.64981927e+03
  6.64981927e+03  6.64981927e+03  9.06197487e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2848532438967  E_coul = 201.54787445824124
cycle= 1 E= -526.736978785655  delta_E= 6.82e-13  |g|= 7.79e-08  |ddm|= 6.12e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2848532438967  E_coul = 201.54787445824124
  HOMO = -0.583045102091685  LUMO = 0.972240509490973
  mo_energy =
[-1.18578745e+02 -1.23105033e+01 -9.56199554e+00 -9.56199554e+00
 -9.56199554e+00 -1.27018200e+00 -5.83045102e-01 -5.83045102e-01
 -5.83045102e-01  9.72240509e-01  1.01520437e+00  1.01520437e+00
  1.01520437e+00  7.30010671e+00  7.30010671e+00  7.30010671e+00
  1.23485541e+01  3.34495965e+01  3.34495965e+01  3.34495965e+01
  1.06589117e+02  1.29005915e+02  1.29005915e+02  1.29005915e+02
  4.83332733e+02  4.83332733e+02  4.83332733e+02  5.88322076e+02
  1.33515942e+03  1.33515942e+03  1.33515942e+03  2.65660663e+03
  3.02938894e+03  3.02938894e+03  3.02938894e+03  6.64981927e+03
  6.64981927e+03  6.64981927e+03  9.06197487e+03  2.54174687e+04
  7.61597026e+04]
E1 = -728.2848531568267  E_coul = 201.54787437117147
Extra cycle  E= -526.736978785655  delta_E= 2.27e-13  |g|= 1.58e-08  |ddm|= 1.3e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826563e+04 7.61752100e+03 3.61735131e+03 1.59780651e+03
 3.82855629e+02 1.08229799e+02 3.56344055e+01 8.10015055e+00
 3.18091446e+00 6.56005130e-01 2.39548809e-01 1.36278335e+03
 6.64744283e+02 3.00955395e+02 3.14036587e+02 6.16278926e+01
 7.33535736e+00 2.02341706e+01 7.76022472e-01 2.82179691e+00
 2.22855621e-01]
grad_E = [-1.50610578e-06  3.18287523e-06 -1.64343688e-06  6.43621939e-05
  1.33275491e-04 -1.72179043e-03  2.77024380e-04 -5.23245837e-04
  5.97433604e-04 -6.87099763e-04  8.41709058e-04 -5.05293521e-07
  5.02763707e-06  2.37423192e-05  2.04694961e-05 -3.46472723e-05
 -9.30843670e-04  1.98599482e-04 -7.62827067e-04  1.49123201e-03
  2.62596918e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562981        1
[INPUT] 0    0    [1    /1   ]  7617.52095469        1
[INPUT] 0    0    [1    /1   ]  3617.35133194        1
[INPUT] 0    0    [1    /1   ]  1597.80565697        1
[INPUT] 0    0    [1    /1   ]  382.853788077        1
[INPUT] 0    0    [1    /1   ]  108.25319537         1
[INPUT] 0    0    [1    /1   ]  35.6298646319        1
[INPUT] 0    0    [1    /1   ]  8.10499285116        1
[INPUT] 0    0    [1    /1   ]  3.1801645266         1
[INPUT] 0    0    [1    /1   ]  0.653694227029       1
[INPUT] 0    0    [1    /1   ]  0.238684950385       1
[INPUT] 1    0    [1    /1   ]  1362.78335426        1
[INPUT] 1    0    [1    /1   ]  664.74421634         1
[INPUT] 1    0    [1    /1   ]  300.955082191        1
[INPUT] 1    0    [1    /1   ]  314.036316773        1
[INPUT] 1    0    [1    /1   ]  61.6278357725        1
[INPUT] 1    0    [1    /1   ]  7.33012086799        1
[INPUT] 1    0    [1    /1   ]  20.2364014713        1
[INPUT] 1    0    [1    /1   ]  0.776248585248       1
[INPUT] 1    0    [1    /1   ]  2.82520499085        1
[INPUT] 1    0    [1    /1   ]  0.222847509556       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656298087495, 1.0]], [0, [7617.520954687586, 1.0]], [0, [3617.3513319449225, 1.0]], [0, [1597.8056569706155, 1.0]], [0, [382.85378807674294, 1.0]], [0, [108.25319537009368, 1.0]], [0, [35.629864631877915, 1.0]], [0, [8.104992851158336, 1.0]], [0, [3.180164526597949, 1.0]], [0, [0.6536942270286391, 1.0]], [0, [0.2386849503848083, 1.0]], [1, [1362.7833542554206, 1.0]], [1, [664.7442163398765, 1.0]], [1, [300.9550821913231, 1.0]], [1, [314.03631677299387, 1.0]], [1, [61.62783577248513, 1.0]], [1, [7.330120867988895, 1.0]], [1, [20.23640147128842, 1.0]], [1, [0.7762485852477068, 1.0]], [1, [2.825204990853523, 1.0]], [1, [0.2228475095556676, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65629809]
bas 1, expnt(s) = [7617.52095469]
bas 2, expnt(s) = [3617.35133194]
bas 3, expnt(s) = [1597.80565697]
bas 4, expnt(s) = [382.85378808]
bas 5, expnt(s) = [108.25319537]
bas 6, expnt(s) = [35.62986463]
bas 7, expnt(s) = [8.10499285]
bas 8, expnt(s) = [3.18016453]
bas 9, expnt(s) = [0.65369423]
bas 10, expnt(s) = [0.23868495]
bas 11, expnt(s) = [1362.78335426]
bas 12, expnt(s) = [664.74421634]
bas 13, expnt(s) = [300.95508219]
bas 14, expnt(s) = [314.03631677]
bas 15, expnt(s) = [61.62783577]
bas 16, expnt(s) = [7.33012087]
bas 17, expnt(s) = [20.23640147]
bas 18, expnt(s) = [0.77624859]
bas 19, expnt(s) = [2.82520499]
bas 20, expnt(s) = [0.22284751]
CPU time:       154.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752095e+03 2.06003817e+03
 3.61735133e+03 1.17844154e+03 1.59780566e+03 6.38495719e+02
 3.82853788e+02 2.18670267e+02 1.08253195e+02 8.47901820e+01
 3.56298646e+01 3.68447533e+01 8.10499285e+00 1.21361099e+01
 3.18016453e+00 6.01661491e+00 6.53694227e-01 1.83673293e+00
 2.38684950e-01 8.62747683e-01 1.36278335e+03 2.41556049e+04
 6.64744216e+02 9.84696971e+03 3.00955082e+02 3.65688661e+03
 3.14036317e+02 3.85664120e+03 6.16278358e+01 5.03738957e+02
 7.33012087e+00 3.51862766e+01 2.02364015e+01 1.25213456e+02
 7.76248585e-01 2.12561898e+00 2.82520499e+00 1.06855492e+01
 2.22847510e-01 4.46677548e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993639638504114
cond(S) = 103558.86664105175
E1 = -729.5219575421013  E_coul = 203.1764047690156
init E= -526.345552773086
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555784515882993  LUMO = 0.987352345793017
  mo_energy =
[-1.18327701e+02 -1.22050999e+01 -9.44702654e+00 -9.44702654e+00
 -9.44702654e+00 -1.24005544e+00 -5.55784516e-01 -5.55784516e-01
 -5.55784516e-01  9.87352346e-01  1.03410999e+00  1.03410999e+00
  1.03410999e+00  7.37596748e+00  7.37596748e+00  7.37596748e+00
  1.24197897e+01  3.35718892e+01  3.35718892e+01  3.35718892e+01
  1.06765237e+02  1.29187118e+02  1.29187118e+02  1.29187118e+02
  4.83583674e+02  4.83583674e+02  4.83583674e+02  5.88655158e+02
  1.33546303e+03  1.33546303e+03  1.33546303e+03  2.65710966e+03
  3.02975645e+03  3.02975645e+03  3.02975645e+03  6.65029835e+03
  6.65029835e+03  6.65029835e+03  9.06259516e+03  2.54181790e+04
  7.61604984e+04]
E1 = -727.8372831696998  E_coul = 201.10106131763828
cycle= 1 E= -526.736221852062  delta_E= -0.391  |g|= 0.186  |ddm|= 0.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540983
diis-c [-0.29266264  1.        ]
  HOMO = -0.590723170674597  LUMO = 0.959610567113702
  mo_energy =
[-1.18636641e+02 -1.23428470e+01 -9.59564542e+00 -9.59564542e+00
 -9.59564542e+00 -1.27948498e+00 -5.90723171e-01 -5.90723171e-01
 -5.90723171e-01  9.59610567e-01  1.00971260e+00  1.00971260e+00
  1.00971260e+00  7.28500654e+00  7.28500654e+00  7.28500654e+00
  1.23103776e+01  3.34176024e+01  3.34176024e+01  3.34176024e+01
  1.06545108e+02  1.28958128e+02  1.28958128e+02  1.28958128e+02
  4.83276119e+02  4.83276119e+02  4.83276119e+02  5.88309674e+02
  1.33509887e+03  1.33509887e+03  1.33509887e+03  2.65661052e+03
  3.02932571e+03  3.02932571e+03  3.02932571e+03  6.64975410e+03
  6.64975410e+03  6.64975410e+03  9.06197544e+03  2.54174653e+04
  7.61596946e+04]
E1 = -728.4117138531692  E_coul = 201.67476941271366
cycle= 2 E= -526.736944440456  delta_E= -0.000723  |g|= 0.0377  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753001
diis-c [-0.00328389  0.08324797  0.91675203]
  HOMO = -0.58161457415774  LUMO = 0.967595948526455
  mo_energy =
[-1.18568921e+02 -1.23048077e+01 -9.55595359e+00 -9.55595359e+00
 -9.55595359e+00 -1.26857874e+00 -5.81614574e-01 -5.81614574e-01
 -5.81614574e-01  9.67595949e-01  1.01644599e+00  1.01644599e+00
  1.01644599e+00  7.30877416e+00  7.30877416e+00  7.30877416e+00
  1.23403947e+01  3.34576601e+01  3.34576601e+01  3.34576601e+01
  1.06600778e+02  1.29014023e+02  1.29014023e+02  1.29014023e+02
  4.83343025e+02  4.83343025e+02  4.83343025e+02  5.88378924e+02
  1.33516982e+03  1.33516982e+03  1.33516982e+03  2.65668478e+03
  3.02939890e+03  3.02939890e+03  3.02939890e+03  6.64982903e+03
  6.64982903e+03  6.64982903e+03  9.06205119e+03  2.54175416e+04
  7.61597712e+04]
E1 = -728.2614995132511  E_coul = 201.5244960734098
cycle= 3 E= -526.737003439841  delta_E= -5.9e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130996
diis-c [-6.07418225e-07 -1.26499602e-03  1.43624244e-01  8.57640752e-01]
  HOMO = -0.583106489303202  LUMO = 0.966385763401898
  mo_energy =
[-1.18578820e+02 -1.23105801e+01 -9.56207289e+00 -9.56207289e+00
 -9.56207289e+00 -1.27025867e+00 -5.83106489e-01 -5.83106489e-01
 -5.83106489e-01  9.66385763e-01  1.01536802e+00  1.01536802e+00
  1.01536802e+00  7.30501298e+00  7.30501298e+00  7.30501298e+00
  1.23358109e+01  3.34515251e+01  3.34515251e+01  3.34515251e+01
  1.06592565e+02  1.29005725e+02  1.29005725e+02  1.29005725e+02
  4.83333241e+02  4.83333241e+02  4.83333241e+02  5.88368790e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65667378e+03
  3.02938814e+03  3.02938814e+03  3.02938814e+03  6.64981788e+03
  6.64981788e+03  6.64981788e+03  9.06203983e+03  2.54175300e+04
  7.61597595e+04]
E1 = -728.2841302679308  E_coul = 201.54712493106894
cycle= 4 E= -526.737005336862  delta_E= -1.9e-06  |g|= 0.000101  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117391
diis-c [-4.26393873e-09  7.51368115e-05 -1.05887705e-02 -6.92633378e-02
  1.07977697e+00]
  HOMO = -0.583088552184233  LUMO = 0.966419471350899
  mo_energy =
[-1.18578781e+02 -1.23105162e+01 -9.56202292e+00 -9.56202292e+00
 -9.56202292e+00 -1.27021733e+00 -5.83088552e-01 -5.83088552e-01
 -5.83088552e-01  9.66419471e-01  1.01538365e+00  1.01538365e+00
  1.01538365e+00  7.30505397e+00  7.30505397e+00  7.30505397e+00
  1.23358700e+01  3.34515732e+01  3.34515732e+01  3.34515732e+01
  1.06592615e+02  1.29005771e+02  1.29005771e+02  1.29005771e+02
  4.83333280e+02  4.83333280e+02  4.83333280e+02  5.88368822e+02
  1.33515948e+03  1.33515948e+03  1.33515948e+03  2.65667379e+03
  3.02938816e+03  3.02938816e+03  3.02938816e+03  6.64981789e+03
  6.64981789e+03  6.64981789e+03  9.06203982e+03  2.54175300e+04
  7.61597595e+04]
E1 = -728.2839181495085  E_coul = 201.54691281081833
cycle= 5 E= -526.73700533869  delta_E= -1.83e-09  |g|= 2.09e-05  |ddm|= 0.000164
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.93027e-05
diis-c [-7.96759795e-11  1.46398805e-05 -1.85277352e-03 -1.40207494e-02
  4.24972124e-02  9.73361671e-01]
  HOMO = -0.583096147803322  LUMO = 0.966415570091027
  mo_energy =
[-1.18578812e+02 -1.23105391e+01 -9.56204776e+00 -9.56204776e+00
 -9.56204776e+00 -1.27022335e+00 -5.83096148e-01 -5.83096148e-01
 -5.83096148e-01  9.66415570e-01  1.01537860e+00  1.01537860e+00
  1.01537860e+00  7.30503709e+00  7.30503709e+00  7.30503709e+00
  1.23358515e+01  3.34515491e+01  3.34515491e+01  3.34515491e+01
  1.06592588e+02  1.29005743e+02  1.29005743e+02  1.29005743e+02
  4.83333249e+02  4.83333249e+02  4.83333249e+02  5.88368790e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65667376e+03
  3.02938813e+03  3.02938813e+03  3.02938813e+03  6.64981786e+03
  6.64981786e+03  6.64981786e+03  9.06203979e+03  2.54175300e+04
  7.61597594e+04]
E1 = -728.2840003178196  E_coul = 201.54699497906864
cycle= 6 E= -526.737005338751  delta_E= -6.08e-11  |g|= 1.79e-06  |ddm|= 1.92e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2840003178196  E_coul = 201.54699497906864
  HOMO = -0.583096162167016  LUMO = 0.966415916123361
  mo_energy =
[-1.18578812e+02 -1.23105389e+01 -9.56204765e+00 -9.56204765e+00
 -9.56204765e+00 -1.27022296e+00 -5.83096162e-01 -5.83096162e-01
 -5.83096162e-01  9.66415916e-01  1.01537865e+00  1.01537865e+00
  1.01537865e+00  7.30503716e+00  7.30503716e+00  7.30503716e+00
  1.23358517e+01  3.34515492e+01  3.34515492e+01  3.34515492e+01
  1.06592588e+02  1.29005743e+02  1.29005743e+02  1.29005743e+02
  4.83333250e+02  4.83333250e+02  4.83333250e+02  5.88368791e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65667376e+03
  3.02938813e+03  3.02938813e+03  3.02938813e+03  6.64981786e+03
  6.64981786e+03  6.64981786e+03  9.06203979e+03  2.54175300e+04
  7.61597594e+04]
E1 = -728.2839990709664  E_coul = 201.54699373221425
Extra cycle  E= -526.737005338752  delta_E= -1.14e-12  |g|= 3.69e-07  |ddm|= 3.15e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.29 sec
exp = [2.61826563e+04 7.61752095e+03 3.61735133e+03 1.59780566e+03
 3.82853788e+02 1.08253195e+02 3.56298646e+01 8.10499285e+00
 3.18016453e+00 6.53694227e-01 2.38684950e-01 1.36278335e+03
 6.64744216e+02 3.00955082e+02 3.14036317e+02 6.16278358e+01
 7.33012087e+00 2.02364015e+01 7.76248585e-01 2.82520499e+00
 2.22847510e-01]
E = -526.7370053387522
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6562981        1
[INPUT] 0    0    [1    /1   ]  7617.52095469        1
[INPUT] 0    0    [1    /1   ]  3617.35133194        1
[INPUT] 0    0    [1    /1   ]  1597.80565697        1
[INPUT] 0    0    [1    /1   ]  382.853788077        1
[INPUT] 0    0    [1    /1   ]  108.25319537         1
[INPUT] 0    0    [1    /1   ]  35.6298646319        1
[INPUT] 0    0    [1    /1   ]  8.10499285116        1
[INPUT] 0    0    [1    /1   ]  3.1801645266         1
[INPUT] 0    0    [1    /1   ]  0.653694227029       1
[INPUT] 0    0    [1    /1   ]  0.238684950385       1
[INPUT] 1    0    [1    /1   ]  1362.78335426        1
[INPUT] 1    0    [1    /1   ]  664.74421634         1
[INPUT] 1    0    [1    /1   ]  300.955082191        1
[INPUT] 1    0    [1    /1   ]  314.036316773        1
[INPUT] 1    0    [1    /1   ]  61.6278357725        1
[INPUT] 1    0    [1    /1   ]  7.33012086799        1
[INPUT] 1    0    [1    /1   ]  20.2364014713        1
[INPUT] 1    0    [1    /1   ]  0.776248585248       1
[INPUT] 1    0    [1    /1   ]  2.82520499085        1
[INPUT] 1    0    [1    /1   ]  0.222847509556       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656298087495, 1.0]], [0, [7617.520954687586, 1.0]], [0, [3617.3513319449225, 1.0]], [0, [1597.8056569706155, 1.0]], [0, [382.85378807674294, 1.0]], [0, [108.25319537009368, 1.0]], [0, [35.629864631877915, 1.0]], [0, [8.104992851158336, 1.0]], [0, [3.180164526597949, 1.0]], [0, [0.6536942270286391, 1.0]], [0, [0.2386849503848083, 1.0]], [1, [1362.7833542554206, 1.0]], [1, [664.7442163398765, 1.0]], [1, [300.9550821913231, 1.0]], [1, [314.03631677299387, 1.0]], [1, [61.62783577248513, 1.0]], [1, [7.330120867988895, 1.0]], [1, [20.23640147128842, 1.0]], [1, [0.7762485852477068, 1.0]], [1, [2.825204990853523, 1.0]], [1, [0.2228475095556676, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65629809]
bas 1, expnt(s) = [7617.52095469]
bas 2, expnt(s) = [3617.35133194]
bas 3, expnt(s) = [1597.80565697]
bas 4, expnt(s) = [382.85378808]
bas 5, expnt(s) = [108.25319537]
bas 6, expnt(s) = [35.62986463]
bas 7, expnt(s) = [8.10499285]
bas 8, expnt(s) = [3.18016453]
bas 9, expnt(s) = [0.65369423]
bas 10, expnt(s) = [0.23868495]
bas 11, expnt(s) = [1362.78335426]
bas 12, expnt(s) = [664.74421634]
bas 13, expnt(s) = [300.95508219]
bas 14, expnt(s) = [314.03631677]
bas 15, expnt(s) = [61.62783577]
bas 16, expnt(s) = [7.33012087]
bas 17, expnt(s) = [20.23640147]
bas 18, expnt(s) = [0.77624859]
bas 19, expnt(s) = [2.82520499]
bas 20, expnt(s) = [0.22284751]
CPU time:       155.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826563e+04 5.20026293e+03 7.61752095e+03 2.06003817e+03
 3.61735133e+03 1.17844154e+03 1.59780566e+03 6.38495719e+02
 3.82853788e+02 2.18670267e+02 1.08253195e+02 8.47901820e+01
 3.56298646e+01 3.68447533e+01 8.10499285e+00 1.21361099e+01
 3.18016453e+00 6.01661491e+00 6.53694227e-01 1.83673293e+00
 2.38684950e-01 8.62747683e-01 1.36278335e+03 2.41556049e+04
 6.64744216e+02 9.84696971e+03 3.00955082e+02 3.65688661e+03
 3.14036317e+02 3.85664120e+03 6.16278358e+01 5.03738957e+02
 7.33012087e+00 3.51862766e+01 2.02364015e+01 1.25213456e+02
 7.76248585e-01 2.12561898e+00 2.82520499e+00 1.06855492e+01
 2.22847510e-01 4.46677548e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993639638504114
cond(S) = 103558.86664105175
E1 = -729.5219575421013  E_coul = 203.1764047690156
init E= -526.345552773086
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555784515882993  LUMO = 0.987352345793017
  mo_energy =
[-1.18327701e+02 -1.22050999e+01 -9.44702654e+00 -9.44702654e+00
 -9.44702654e+00 -1.24005544e+00 -5.55784516e-01 -5.55784516e-01
 -5.55784516e-01  9.87352346e-01  1.03410999e+00  1.03410999e+00
  1.03410999e+00  7.37596748e+00  7.37596748e+00  7.37596748e+00
  1.24197897e+01  3.35718892e+01  3.35718892e+01  3.35718892e+01
  1.06765237e+02  1.29187118e+02  1.29187118e+02  1.29187118e+02
  4.83583674e+02  4.83583674e+02  4.83583674e+02  5.88655158e+02
  1.33546303e+03  1.33546303e+03  1.33546303e+03  2.65710966e+03
  3.02975645e+03  3.02975645e+03  3.02975645e+03  6.65029835e+03
  6.65029835e+03  6.65029835e+03  9.06259516e+03  2.54181790e+04
  7.61604984e+04]
E1 = -727.8372831696998  E_coul = 201.10106131763828
cycle= 1 E= -526.736221852062  delta_E= -0.391  |g|= 0.186  |ddm|= 0.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540983
diis-c [-0.29266264  1.        ]
  HOMO = -0.590723170674597  LUMO = 0.959610567113702
  mo_energy =
[-1.18636641e+02 -1.23428470e+01 -9.59564542e+00 -9.59564542e+00
 -9.59564542e+00 -1.27948498e+00 -5.90723171e-01 -5.90723171e-01
 -5.90723171e-01  9.59610567e-01  1.00971260e+00  1.00971260e+00
  1.00971260e+00  7.28500654e+00  7.28500654e+00  7.28500654e+00
  1.23103776e+01  3.34176024e+01  3.34176024e+01  3.34176024e+01
  1.06545108e+02  1.28958128e+02  1.28958128e+02  1.28958128e+02
  4.83276119e+02  4.83276119e+02  4.83276119e+02  5.88309674e+02
  1.33509887e+03  1.33509887e+03  1.33509887e+03  2.65661052e+03
  3.02932571e+03  3.02932571e+03  3.02932571e+03  6.64975410e+03
  6.64975410e+03  6.64975410e+03  9.06197544e+03  2.54174653e+04
  7.61596946e+04]
E1 = -728.4117138531692  E_coul = 201.67476941271366
cycle= 2 E= -526.736944440456  delta_E= -0.000723  |g|= 0.0377  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753001
diis-c [-0.00328389  0.08324797  0.91675203]
  HOMO = -0.58161457415774  LUMO = 0.967595948526455
  mo_energy =
[-1.18568921e+02 -1.23048077e+01 -9.55595359e+00 -9.55595359e+00
 -9.55595359e+00 -1.26857874e+00 -5.81614574e-01 -5.81614574e-01
 -5.81614574e-01  9.67595949e-01  1.01644599e+00  1.01644599e+00
  1.01644599e+00  7.30877416e+00  7.30877416e+00  7.30877416e+00
  1.23403947e+01  3.34576601e+01  3.34576601e+01  3.34576601e+01
  1.06600778e+02  1.29014023e+02  1.29014023e+02  1.29014023e+02
  4.83343025e+02  4.83343025e+02  4.83343025e+02  5.88378924e+02
  1.33516982e+03  1.33516982e+03  1.33516982e+03  2.65668478e+03
  3.02939890e+03  3.02939890e+03  3.02939890e+03  6.64982903e+03
  6.64982903e+03  6.64982903e+03  9.06205119e+03  2.54175416e+04
  7.61597712e+04]
E1 = -728.2614995132511  E_coul = 201.5244960734098
cycle= 3 E= -526.737003439841  delta_E= -5.9e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130996
diis-c [-6.07418225e-07 -1.26499602e-03  1.43624244e-01  8.57640752e-01]
  HOMO = -0.583106489303202  LUMO = 0.966385763401898
  mo_energy =
[-1.18578820e+02 -1.23105801e+01 -9.56207289e+00 -9.56207289e+00
 -9.56207289e+00 -1.27025867e+00 -5.83106489e-01 -5.83106489e-01
 -5.83106489e-01  9.66385763e-01  1.01536802e+00  1.01536802e+00
  1.01536802e+00  7.30501298e+00  7.30501298e+00  7.30501298e+00
  1.23358109e+01  3.34515251e+01  3.34515251e+01  3.34515251e+01
  1.06592565e+02  1.29005725e+02  1.29005725e+02  1.29005725e+02
  4.83333241e+02  4.83333241e+02  4.83333241e+02  5.88368790e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65667378e+03
  3.02938814e+03  3.02938814e+03  3.02938814e+03  6.64981788e+03
  6.64981788e+03  6.64981788e+03  9.06203983e+03  2.54175300e+04
  7.61597595e+04]
E1 = -728.2841302679308  E_coul = 201.54712493106894
cycle= 4 E= -526.737005336862  delta_E= -1.9e-06  |g|= 0.000101  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117391
diis-c [-4.26393873e-09  7.51368115e-05 -1.05887705e-02 -6.92633378e-02
  1.07977697e+00]
  HOMO = -0.583088552184233  LUMO = 0.966419471350899
  mo_energy =
[-1.18578781e+02 -1.23105162e+01 -9.56202292e+00 -9.56202292e+00
 -9.56202292e+00 -1.27021733e+00 -5.83088552e-01 -5.83088552e-01
 -5.83088552e-01  9.66419471e-01  1.01538365e+00  1.01538365e+00
  1.01538365e+00  7.30505397e+00  7.30505397e+00  7.30505397e+00
  1.23358700e+01  3.34515732e+01  3.34515732e+01  3.34515732e+01
  1.06592615e+02  1.29005771e+02  1.29005771e+02  1.29005771e+02
  4.83333280e+02  4.83333280e+02  4.83333280e+02  5.88368822e+02
  1.33515948e+03  1.33515948e+03  1.33515948e+03  2.65667379e+03
  3.02938816e+03  3.02938816e+03  3.02938816e+03  6.64981789e+03
  6.64981789e+03  6.64981789e+03  9.06203982e+03  2.54175300e+04
  7.61597595e+04]
E1 = -728.2839181495085  E_coul = 201.54691281081833
cycle= 5 E= -526.73700533869  delta_E= -1.83e-09  |g|= 2.09e-05  |ddm|= 0.000164
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.93027e-05
diis-c [-7.96759795e-11  1.46398805e-05 -1.85277352e-03 -1.40207494e-02
  4.24972124e-02  9.73361671e-01]
  HOMO = -0.583096147803322  LUMO = 0.966415570091027
  mo_energy =
[-1.18578812e+02 -1.23105391e+01 -9.56204776e+00 -9.56204776e+00
 -9.56204776e+00 -1.27022335e+00 -5.83096148e-01 -5.83096148e-01
 -5.83096148e-01  9.66415570e-01  1.01537860e+00  1.01537860e+00
  1.01537860e+00  7.30503709e+00  7.30503709e+00  7.30503709e+00
  1.23358515e+01  3.34515491e+01  3.34515491e+01  3.34515491e+01
  1.06592588e+02  1.29005743e+02  1.29005743e+02  1.29005743e+02
  4.83333249e+02  4.83333249e+02  4.83333249e+02  5.88368790e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65667376e+03
  3.02938813e+03  3.02938813e+03  3.02938813e+03  6.64981786e+03
  6.64981786e+03  6.64981786e+03  9.06203979e+03  2.54175300e+04
  7.61597594e+04]
E1 = -728.2840003178196  E_coul = 201.54699497906864
cycle= 6 E= -526.737005338751  delta_E= -6.08e-11  |g|= 1.79e-06  |ddm|= 1.92e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2840003178196  E_coul = 201.54699497906864
  HOMO = -0.583096162167016  LUMO = 0.966415916123361
  mo_energy =
[-1.18578812e+02 -1.23105389e+01 -9.56204765e+00 -9.56204765e+00
 -9.56204765e+00 -1.27022296e+00 -5.83096162e-01 -5.83096162e-01
 -5.83096162e-01  9.66415916e-01  1.01537865e+00  1.01537865e+00
  1.01537865e+00  7.30503716e+00  7.30503716e+00  7.30503716e+00
  1.23358517e+01  3.34515492e+01  3.34515492e+01  3.34515492e+01
  1.06592588e+02  1.29005743e+02  1.29005743e+02  1.29005743e+02
  4.83333250e+02  4.83333250e+02  4.83333250e+02  5.88368791e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65667376e+03
  3.02938813e+03  3.02938813e+03  3.02938813e+03  6.64981786e+03
  6.64981786e+03  6.64981786e+03  9.06203979e+03  2.54175300e+04
  7.61597594e+04]
E1 = -728.2839990709664  E_coul = 201.54699373221425
Extra cycle  E= -526.737005338752  delta_E= -1.14e-12  |g|= 3.69e-07  |ddm|= 3.15e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103558.86664105175
E1 = -728.2839990709664  E_coul = 201.54699373221425
init E= -526.737005338752
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.58309619933537  LUMO = 0.966415958593969
  mo_energy =
[-1.18578812e+02 -1.23105390e+01 -9.56204776e+00 -9.56204776e+00
 -9.56204776e+00 -1.27022292e+00 -5.83096199e-01 -5.83096199e-01
 -5.83096199e-01  9.66415959e-01  1.01537864e+00  1.01537864e+00
  1.01537864e+00  7.30503709e+00  7.30503709e+00  7.30503709e+00
  1.23358517e+01  3.34515491e+01  3.34515491e+01  3.34515491e+01
  1.06592588e+02  1.29005743e+02  1.29005743e+02  1.29005743e+02
  4.83333249e+02  4.83333249e+02  4.83333249e+02  5.88368790e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65667376e+03
  3.02938813e+03  3.02938813e+03  3.02938813e+03  6.64981786e+03
  6.64981786e+03  6.64981786e+03  9.06203979e+03  2.54175300e+04
  7.61597594e+04]
E1 = -728.2839992917998  E_coul = 201.5469939530494
cycle= 1 E= -526.73700533875  delta_E= 1.82e-12  |g|= 7.84e-08  |ddm|= 6.16e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2839992917998  E_coul = 201.5469939530494
  HOMO = -0.583096197972177  LUMO = 0.966415974856228
  mo_energy =
[-1.18578812e+02 -1.23105390e+01 -9.56204775e+00 -9.56204775e+00
 -9.56204775e+00 -1.27022290e+00 -5.83096198e-01 -5.83096198e-01
 -5.83096198e-01  9.66415975e-01  1.01537864e+00  1.01537864e+00
  1.01537864e+00  7.30503710e+00  7.30503710e+00  7.30503710e+00
  1.23358517e+01  3.34515491e+01  3.34515491e+01  3.34515491e+01
  1.06592588e+02  1.29005743e+02  1.29005743e+02  1.29005743e+02
  4.83333249e+02  4.83333249e+02  4.83333249e+02  5.88368790e+02
  1.33515945e+03  1.33515945e+03  1.33515945e+03  2.65667376e+03
  3.02938813e+03  3.02938813e+03  3.02938813e+03  6.64981786e+03
  6.64981786e+03  6.64981786e+03  9.06203979e+03  2.54175300e+04
  7.61597594e+04]
E1 = -728.2839992029607  E_coul = 201.54699386420842
Extra cycle  E= -526.737005338752  delta_E= -1.93e-12  |g|= 1.59e-08  |ddm|= 1.31e-07
    CPU time for scf_cycle      1.24 sec, wall time      0.58 sec
exp = [2.61826563e+04 7.61752095e+03 3.61735133e+03 1.59780566e+03
 3.82853788e+02 1.08253195e+02 3.56298646e+01 8.10499285e+00
 3.18016453e+00 6.53694227e-01 2.38684950e-01 1.36278335e+03
 6.64744216e+02 3.00955082e+02 3.14036317e+02 6.16278358e+01
 7.33012087e+00 2.02364015e+01 7.76248585e-01 2.82520499e+00
 2.22847510e-01]
grad_E = [-1.50664319e-06  3.18863252e-06 -1.64084203e-06  6.45850249e-05
  1.26644495e-04 -1.68155078e-03  2.10102537e-04 -4.35205880e-04
  3.76690997e-04 -9.81937014e-04  7.62460979e-04 -5.01887778e-07
  5.07420471e-06  2.40265254e-05  2.07133675e-05 -6.94822436e-05
 -2.08116259e-03  5.22584595e-04  7.93617405e-05  2.91934372e-03
  2.32328450e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656351         1
[INPUT] 0    0    [1    /1   ]  7617.52084236        1
[INPUT] 0    0    [1    /1   ]  3617.3513893         1
[INPUT] 0    0    [1    /1   ]  1597.80337316        1
[INPUT] 0    0    [1    /1   ]  382.849969118        1
[INPUT] 0    0    [1    /1   ]  108.305687418        1
[INPUT] 0    0    [1    /1   ]  35.6398173867        1
[INPUT] 0    0    [1    /1   ]  8.13068841276        1
[INPUT] 0    0    [1    /1   ]  3.18329004647        1
[INPUT] 0    0    [1    /1   ]  0.650974416975       1
[INPUT] 0    0    [1    /1   ]  0.237627196894       1
[INPUT] 1    0    [1    /1   ]  1362.78337209        1
[INPUT] 1    0    [1    /1   ]  664.744041316        1
[INPUT] 1    0    [1    /1   ]  300.954257664        1
[INPUT] 1    0    [1    /1   ]  314.035605864        1
[INPUT] 1    0    [1    /1   ]  61.6279469803        1
[INPUT] 1    0    [1    /1   ]  7.32235612044        1
[INPUT] 1    0    [1    /1   ]  20.2401232425        1
[INPUT] 1    0    [1    /1   ]  0.776525251107       1
[INPUT] 1    0    [1    /1   ]  2.82864749152        1
[INPUT] 1    0    [1    /1   ]  0.222792358237       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65635100058, 1.0]], [0, [7617.520842356958, 1.0]], [0, [3617.351389299277, 1.0]], [0, [1597.803373155624, 1.0]], [0, [382.8499691183153, 1.0]], [0, [108.30568741784296, 1.0]], [0, [35.63981738666599, 1.0]], [0, [8.130688412762739, 1.0]], [0, [3.183290046467931, 1.0]], [0, [0.6509744169752855, 1.0]], [0, [0.23762719689367442, 1.0]], [1, [1362.7833720930098, 1.0]], [1, [664.7440413164182, 1.0]], [1, [300.95425766391133, 1.0]], [1, [314.03560586370673, 1.0]], [1, [61.627946980251146, 1.0]], [1, [7.322356120442378, 1.0]], [1, [20.240123242480966, 1.0]], [1, [0.7765252511071886, 1.0]], [1, [2.8286474915243898, 1.0]], [1, [0.22279235823708554, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.656351]
bas 1, expnt(s) = [7617.52084236]
bas 2, expnt(s) = [3617.3513893]
bas 3, expnt(s) = [1597.80337316]
bas 4, expnt(s) = [382.84996912]
bas 5, expnt(s) = [108.30568742]
bas 6, expnt(s) = [35.63981739]
bas 7, expnt(s) = [8.13068841]
bas 8, expnt(s) = [3.18329005]
bas 9, expnt(s) = [0.65097442]
bas 10, expnt(s) = [0.2376272]
bas 11, expnt(s) = [1362.78337209]
bas 12, expnt(s) = [664.74404132]
bas 13, expnt(s) = [300.95425766]
bas 14, expnt(s) = [314.03560586]
bas 15, expnt(s) = [61.62794698]
bas 16, expnt(s) = [7.32235612]
bas 17, expnt(s) = [20.24012324]
bas 18, expnt(s) = [0.77652525]
bas 19, expnt(s) = [2.82864749]
bas 20, expnt(s) = [0.22279236]
CPU time:       161.36
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826564e+04 5.20026294e+03 7.61752084e+03 2.06003815e+03
 3.61735139e+03 1.17844155e+03 1.59780337e+03 6.38495035e+02
 3.82849969e+02 2.18668631e+02 1.08305687e+02 8.48210163e+01
 3.56398174e+01 3.68524722e+01 8.13068841e+00 1.21649552e+01
 3.18329005e+00 6.02104929e+00 6.50974417e-01 1.83099840e+00
 2.37627197e-01 8.59878585e-01 1.36278337e+03 2.41556053e+04
 6.64744041e+02 9.84696646e+03 3.00954258e+02 3.65687409e+03
 3.14035606e+02 3.85663029e+03 6.16279470e+01 5.03740093e+02
 7.32235612e+00 3.51396920e+01 2.02401232e+01 1.25242242e+02
 7.76525251e-01 2.12656602e+00 2.82864749e+00 1.07018271e+01
 2.22792358e-01 4.46539370e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993644390789136
cond(S) = 103556.67758446289
E1 = -729.5223908599105  E_coul = 203.17658213343623
init E= -526.345808726474
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555796386245442  LUMO = 0.980438319604146
  mo_energy =
[-1.18327710e+02 -1.22050807e+01 -9.44699632e+00 -9.44699632e+00
 -9.44699632e+00 -1.24005949e+00 -5.55796386e-01 -5.55796386e-01
 -5.55796386e-01  9.80438320e-01  1.03419039e+00  1.03419039e+00
  1.03419039e+00  7.38025163e+00  7.38025163e+00  7.38025163e+00
  1.24367401e+01  3.35690700e+01  3.35690700e+01  3.35690700e+01
  1.06905485e+02  1.29182609e+02  1.29182609e+02  1.29182609e+02
  4.83581823e+02  4.83581823e+02  4.83581823e+02  5.88921764e+02
  1.33546034e+03  1.33546034e+03  1.33546034e+03  2.65741035e+03
  3.02975179e+03  3.02975179e+03  3.02975179e+03  6.65029235e+03
  6.65029235e+03  6.65029235e+03  9.06287931e+03  2.54184475e+04
  7.61607480e+04]
E1 = -727.835148723608  E_coul = 201.09887599170807
cycle= 1 E= -526.7362727319  delta_E= -0.39  |g|= 0.186  |ddm|= 0.326
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541241
diis-c [-0.29294173  1.        ]
  HOMO = -0.590825982556409  LUMO = 0.952771922772132
  mo_energy =
[-1.18636801e+02 -1.23429748e+01 -9.59578868e+00 -9.59578868e+00
 -9.59578868e+00 -1.27957777e+00 -5.90825983e-01 -5.90825983e-01
 -5.90825983e-01  9.52771923e-01  1.00971505e+00  1.00971505e+00
  1.00971505e+00  7.28914556e+00  7.28914556e+00  7.28914556e+00
  1.23270904e+01  3.34146364e+01  3.34146364e+01  3.34146364e+01
  1.06685070e+02  1.28953455e+02  1.28953455e+02  1.28953455e+02
  4.83274097e+02  4.83274097e+02  4.83274097e+02  5.88576123e+02
  1.33509602e+03  1.33509602e+03  1.33509602e+03  2.65691110e+03
  3.02932092e+03  3.02932092e+03  3.02932092e+03  6.64974799e+03
  6.64974799e+03  6.64974799e+03  9.06225950e+03  2.54177337e+04
  7.61599440e+04]
E1 = -728.4102295341662  E_coul = 201.6732325636475
cycle= 2 E= -526.736996970519  delta_E= -0.000724  |g|= 0.0377  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753801
diis-c [-0.00328896  0.08332326  0.91667674]
  HOMO = -0.581706504374532  LUMO = 0.960729187704501
  mo_energy =
[-1.18569018e+02 -1.23048933e+01 -9.55605553e+00 -9.55605553e+00
 -9.55605553e+00 -1.26865758e+00 -5.81706504e-01 -5.81706504e-01
 -5.81706504e-01  9.60729188e-01  1.01645965e+00  1.01645965e+00
  1.01645965e+00  7.31294420e+00  7.31294420e+00  7.31294420e+00
  1.23571824e+01  3.34547318e+01  3.34547318e+01  3.34547318e+01
  1.06740803e+02  1.29009405e+02  1.29009405e+02  1.29009405e+02
  4.83341064e+02  4.83341064e+02  4.83341064e+02  5.88645436e+02
  1.33516704e+03  1.33516704e+03  1.33516704e+03  2.65698543e+03
  3.02939418e+03  3.02939418e+03  3.02939418e+03  6.64982298e+03
  6.64982298e+03  6.64982298e+03  9.06233531e+03  2.54178100e+04
  7.61600207e+04]
E1 = -728.2598380637028  E_coul = 201.52278195545017
cycle= 3 E= -526.737056108253  delta_E= -5.91e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131104
diis-c [-6.12627456e-07 -1.26594831e-03  1.43589796e-01  8.57676153e-01]
  HOMO = -0.583200431654265  LUMO = 0.959523654575618
  mo_energy =
[-1.18578922e+02 -1.23106693e+01 -9.56217906e+00 -9.56217906e+00
 -9.56217906e+00 -1.27033926e+00 -5.83200432e-01 -5.83200432e-01
 -5.83200432e-01  9.59523655e-01  1.01537979e+00  1.01537979e+00
  1.01537979e+00  7.30917889e+00  7.30917889e+00  7.30917889e+00
  1.23525899e+01  3.34485933e+01  3.34485933e+01  3.34485933e+01
  1.06732584e+02  1.29001102e+02  1.29001102e+02  1.29001102e+02
  4.83331276e+02  4.83331276e+02  4.83331276e+02  5.88635297e+02
  1.33515667e+03  1.33515667e+03  1.33515667e+03  2.65697442e+03
  3.02938342e+03  3.02938342e+03  3.02938342e+03  6.64981183e+03
  6.64981183e+03  6.64981183e+03  9.06232394e+03  2.54177985e+04
  7.61600090e+04]
E1 = -728.2824860216244  E_coul = 201.5454280132497
cycle= 4 E= -526.737058008375  delta_E= -1.9e-06  |g|= 0.000102  |ddm|= 0.00224
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.000118476
diis-c [-4.30342831e-09  7.57327194e-05 -1.06537346e-02 -6.97414829e-02
  1.08031948e+00]
  HOMO = -0.583182589334142  LUMO = 0.959557292259998
  mo_energy =
[-1.18578884e+02 -1.23106055e+01 -9.56212929e+00 -9.56212929e+00
 -9.56212929e+00 -1.27029786e+00 -5.83182589e-01 -5.83182589e-01
 -5.83182589e-01  9.59557292e-01  1.01539537e+00  1.01539537e+00
  1.01539537e+00  7.30921977e+00  7.30921977e+00  7.30921977e+00
  1.23526490e+01  3.34486411e+01  3.34486411e+01  3.34486411e+01
  1.06732635e+02  1.29001148e+02  1.29001148e+02  1.29001148e+02
  4.83331314e+02  4.83331314e+02  4.83331314e+02  5.88635328e+02
  1.33515670e+03  1.33515670e+03  1.33515670e+03  2.65697443e+03
  3.02938344e+03  3.02938344e+03  3.02938344e+03  6.64981184e+03
  6.64981184e+03  6.64981184e+03  9.06232393e+03  2.54177985e+04
  7.61600090e+04]
E1 = -728.2822738244381  E_coul = 201.54521581420755
cycle= 5 E= -526.737058010231  delta_E= -1.86e-09  |g|= 2.1e-05  |ddm|= 0.000166
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=3.94404e-05
diis-c [-8.06930726e-11  1.46649953e-05 -1.85468556e-03 -1.40449566e-02
  4.25839802e-02  9.73300997e-01]
  HOMO = -0.583190230150374  LUMO = 0.95955338876771
  mo_energy =
[-1.18578915e+02 -1.23106285e+01 -9.56215424e+00 -9.56215424e+00
 -9.56215424e+00 -1.27030391e+00 -5.83190230e-01 -5.83190230e-01
 -5.83190230e-01  9.59553389e-01  1.01539029e+00  1.01539029e+00
  1.01539029e+00  7.30920279e+00  7.30920279e+00  7.30920279e+00
  1.23526304e+01  3.34486169e+01  3.34486169e+01  3.34486169e+01
  1.06732607e+02  1.29001120e+02  1.29001120e+02  1.29001120e+02
  4.83331283e+02  4.83331283e+02  4.83331283e+02  5.88635297e+02
  1.33515666e+03  1.33515666e+03  1.33515666e+03  2.65697440e+03
  3.02938340e+03  3.02938340e+03  3.02938340e+03  6.64981180e+03
  6.64981180e+03  6.64981180e+03  9.06232390e+03  2.54177984e+04
  7.61600090e+04]
E1 = -728.2823563332247  E_coul = 201.54529832293275
cycle= 6 E= -526.737058010292  delta_E= -6.14e-11  |g|= 1.8e-06  |ddm|= 1.93e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2823563332247  E_coul = 201.54529832293275
  HOMO = -0.583190243517482  LUMO = 0.959553736603114
  mo_energy =
[-1.18578915e+02 -1.23106283e+01 -9.56215413e+00 -9.56215413e+00
 -9.56215413e+00 -1.27030352e+00 -5.83190244e-01 -5.83190244e-01
 -5.83190244e-01  9.59553737e-01  1.01539034e+00  1.01539034e+00
  1.01539034e+00  7.30920287e+00  7.30920287e+00  7.30920287e+00
  1.23526307e+01  3.34486171e+01  3.34486171e+01  3.34486171e+01
  1.06732607e+02  1.29001120e+02  1.29001120e+02  1.29001120e+02
  4.83331283e+02  4.83331283e+02  4.83331283e+02  5.88635297e+02
  1.33515666e+03  1.33515666e+03  1.33515666e+03  2.65697440e+03
  3.02938340e+03  3.02938340e+03  3.02938340e+03  6.64981180e+03
  6.64981180e+03  6.64981180e+03  9.06232390e+03  2.54177984e+04
  7.61600090e+04]
E1 = -728.2823550436782  E_coul = 201.54529703338466
Extra cycle  E= -526.737058010294  delta_E= -1.59e-12  |g|= 3.72e-07  |ddm|= 3.18e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
exp = [2.61826564e+04 7.61752084e+03 3.61735139e+03 1.59780337e+03
 3.82849969e+02 1.08305687e+02 3.56398174e+01 8.13068841e+00
 3.18329005e+00 6.50974417e-01 2.37627197e-01 1.36278337e+03
 6.64744041e+02 3.00954258e+02 3.14035606e+02 6.16279470e+01
 7.32235612e+00 2.02401232e+01 7.76525251e-01 2.82864749e+00
 2.22792358e-01]
E = -526.7370580102936
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:10:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.656351         1
[INPUT] 0    0    [1    /1   ]  7617.52084236        1
[INPUT] 0    0    [1    /1   ]  3617.3513893         1
[INPUT] 0    0    [1    /1   ]  1597.80337316        1
[INPUT] 0    0    [1    /1   ]  382.849969118        1
[INPUT] 0    0    [1    /1   ]  108.305687418        1
[INPUT] 0    0    [1    /1   ]  35.6398173867        1
[INPUT] 0    0    [1    /1   ]  8.13068841276        1
[INPUT] 0    0    [1    /1   ]  3.18329004647        1
[INPUT] 0    0    [1    /1   ]  0.650974416975       1
[INPUT] 0    0    [1    /1   ]  0.237627196894       1
[INPUT] 1    0    [1    /1   ]  1362.78337209        1
[INPUT] 1    0    [1    /1   ]  664.744041316        1
[INPUT] 1    0    [1    /1   ]  300.954257664        1
[INPUT] 1    0    [1    /1   ]  314.035605864        1
[INPUT] 1    0    [1    /1   ]  61.6279469803        1
[INPUT] 1    0    [1    /1   ]  7.32235612044        1
[INPUT] 1    0    [1    /1   ]  20.2401232425        1
[INPUT] 1    0    [1    /1   ]  0.776525251107       1
[INPUT] 1    0    [1    /1   ]  2.82864749152        1
[INPUT] 1    0    [1    /1   ]  0.222792358237       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65635100058, 1.0]], [0, [7617.520842356958, 1.0]], [0, [3617.351389299277, 1.0]], [0, [1597.803373155624, 1.0]], [0, [382.8499691183153, 1.0]], [0, [108.30568741784296, 1.0]], [0, [35.63981738666599, 1.0]], [0, [8.130688412762739, 1.0]], [0, [3.183290046467931, 1.0]], [0, [0.6509744169752855, 1.0]], [0, [0.23762719689367442, 1.0]], [1, [1362.7833720930098, 1.0]], [1, [664.7440413164182, 1.0]], [1, [300.95425766391133, 1.0]], [1, [314.03560586370673, 1.0]], [1, [61.627946980251146, 1.0]], [1, [7.322356120442378, 1.0]], [1, [20.240123242480966, 1.0]], [1, [0.7765252511071886, 1.0]], [1, [2.8286474915243898, 1.0]], [1, [0.22279235823708554, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.656351]
bas 1, expnt(s) = [7617.52084236]
bas 2, expnt(s) = [3617.3513893]
bas 3, expnt(s) = [1597.80337316]
bas 4, expnt(s) = [382.84996912]
bas 5, expnt(s) = [108.30568742]
bas 6, expnt(s) = [35.63981739]
bas 7, expnt(s) = [8.13068841]
bas 8, expnt(s) = [3.18329005]
bas 9, expnt(s) = [0.65097442]
bas 10, expnt(s) = [0.2376272]
bas 11, expnt(s) = [1362.78337209]
bas 12, expnt(s) = [664.74404132]
bas 13, expnt(s) = [300.95425766]
bas 14, expnt(s) = [314.03560586]
bas 15, expnt(s) = [61.62794698]
bas 16, expnt(s) = [7.32235612]
bas 17, expnt(s) = [20.24012324]
bas 18, expnt(s) = [0.77652525]
bas 19, expnt(s) = [2.82864749]
bas 20, expnt(s) = [0.22279236]
CPU time:       161.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826564e+04 5.20026294e+03 7.61752084e+03 2.06003815e+03
 3.61735139e+03 1.17844155e+03 1.59780337e+03 6.38495035e+02
 3.82849969e+02 2.18668631e+02 1.08305687e+02 8.48210163e+01
 3.56398174e+01 3.68524722e+01 8.13068841e+00 1.21649552e+01
 3.18329005e+00 6.02104929e+00 6.50974417e-01 1.83099840e+00
 2.37627197e-01 8.59878585e-01 1.36278337e+03 2.41556053e+04
 6.64744041e+02 9.84696646e+03 3.00954258e+02 3.65687409e+03
 3.14035606e+02 3.85663029e+03 6.16279470e+01 5.03740093e+02
 7.32235612e+00 3.51396920e+01 2.02401232e+01 1.25242242e+02
 7.76525251e-01 2.12656602e+00 2.82864749e+00 1.07018271e+01
 2.22792358e-01 4.46539370e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993644390789136
cond(S) = 103556.67758446289
E1 = -729.5223908599105  E_coul = 203.17658213343623
init E= -526.345808726474
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555796386245442  LUMO = 0.980438319604146
  mo_energy =
[-1.18327710e+02 -1.22050807e+01 -9.44699632e+00 -9.44699632e+00
 -9.44699632e+00 -1.24005949e+00 -5.55796386e-01 -5.55796386e-01
 -5.55796386e-01  9.80438320e-01  1.03419039e+00  1.03419039e+00
  1.03419039e+00  7.38025163e+00  7.38025163e+00  7.38025163e+00
  1.24367401e+01  3.35690700e+01  3.35690700e+01  3.35690700e+01
  1.06905485e+02  1.29182609e+02  1.29182609e+02  1.29182609e+02
  4.83581823e+02  4.83581823e+02  4.83581823e+02  5.88921764e+02
  1.33546034e+03  1.33546034e+03  1.33546034e+03  2.65741035e+03
  3.02975179e+03  3.02975179e+03  3.02975179e+03  6.65029235e+03
  6.65029235e+03  6.65029235e+03  9.06287931e+03  2.54184475e+04
  7.61607480e+04]
E1 = -727.835148723608  E_coul = 201.09887599170807
cycle= 1 E= -526.7362727319  delta_E= -0.39  |g|= 0.186  |ddm|= 0.326
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541241
diis-c [-0.29294173  1.        ]
  HOMO = -0.590825982556409  LUMO = 0.952771922772132
  mo_energy =
[-1.18636801e+02 -1.23429748e+01 -9.59578868e+00 -9.59578868e+00
 -9.59578868e+00 -1.27957777e+00 -5.90825983e-01 -5.90825983e-01
 -5.90825983e-01  9.52771923e-01  1.00971505e+00  1.00971505e+00
  1.00971505e+00  7.28914556e+00  7.28914556e+00  7.28914556e+00
  1.23270904e+01  3.34146364e+01  3.34146364e+01  3.34146364e+01
  1.06685070e+02  1.28953455e+02  1.28953455e+02  1.28953455e+02
  4.83274097e+02  4.83274097e+02  4.83274097e+02  5.88576123e+02
  1.33509602e+03  1.33509602e+03  1.33509602e+03  2.65691110e+03
  3.02932092e+03  3.02932092e+03  3.02932092e+03  6.64974799e+03
  6.64974799e+03  6.64974799e+03  9.06225950e+03  2.54177337e+04
  7.61599440e+04]
E1 = -728.4102295341662  E_coul = 201.6732325636475
cycle= 2 E= -526.736996970519  delta_E= -0.000724  |g|= 0.0377  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753801
diis-c [-0.00328896  0.08332326  0.91667674]
  HOMO = -0.581706504374532  LUMO = 0.960729187704501
  mo_energy =
[-1.18569018e+02 -1.23048933e+01 -9.55605553e+00 -9.55605553e+00
 -9.55605553e+00 -1.26865758e+00 -5.81706504e-01 -5.81706504e-01
 -5.81706504e-01  9.60729188e-01  1.01645965e+00  1.01645965e+00
  1.01645965e+00  7.31294420e+00  7.31294420e+00  7.31294420e+00
  1.23571824e+01  3.34547318e+01  3.34547318e+01  3.34547318e+01
  1.06740803e+02  1.29009405e+02  1.29009405e+02  1.29009405e+02
  4.83341064e+02  4.83341064e+02  4.83341064e+02  5.88645436e+02
  1.33516704e+03  1.33516704e+03  1.33516704e+03  2.65698543e+03
  3.02939418e+03  3.02939418e+03  3.02939418e+03  6.64982298e+03
  6.64982298e+03  6.64982298e+03  9.06233531e+03  2.54178100e+04
  7.61600207e+04]
E1 = -728.2598380637028  E_coul = 201.52278195545017
cycle= 3 E= -526.737056108253  delta_E= -5.91e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131104
diis-c [-6.12627456e-07 -1.26594831e-03  1.43589796e-01  8.57676153e-01]
  HOMO = -0.583200431654265  LUMO = 0.959523654575618
  mo_energy =
[-1.18578922e+02 -1.23106693e+01 -9.56217906e+00 -9.56217906e+00
 -9.56217906e+00 -1.27033926e+00 -5.83200432e-01 -5.83200432e-01
 -5.83200432e-01  9.59523655e-01  1.01537979e+00  1.01537979e+00
  1.01537979e+00  7.30917889e+00  7.30917889e+00  7.30917889e+00
  1.23525899e+01  3.34485933e+01  3.34485933e+01  3.34485933e+01
  1.06732584e+02  1.29001102e+02  1.29001102e+02  1.29001102e+02
  4.83331276e+02  4.83331276e+02  4.83331276e+02  5.88635297e+02
  1.33515667e+03  1.33515667e+03  1.33515667e+03  2.65697442e+03
  3.02938342e+03  3.02938342e+03  3.02938342e+03  6.64981183e+03
  6.64981183e+03  6.64981183e+03  9.06232394e+03  2.54177985e+04
  7.61600090e+04]
E1 = -728.2824860216244  E_coul = 201.5454280132497
cycle= 4 E= -526.737058008375  delta_E= -1.9e-06  |g|= 0.000102  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000118476
diis-c [-4.30342831e-09  7.57327194e-05 -1.06537346e-02 -6.97414829e-02
  1.08031948e+00]
  HOMO = -0.583182589334142  LUMO = 0.959557292259998
  mo_energy =
[-1.18578884e+02 -1.23106055e+01 -9.56212929e+00 -9.56212929e+00
 -9.56212929e+00 -1.27029786e+00 -5.83182589e-01 -5.83182589e-01
 -5.83182589e-01  9.59557292e-01  1.01539537e+00  1.01539537e+00
  1.01539537e+00  7.30921977e+00  7.30921977e+00  7.30921977e+00
  1.23526490e+01  3.34486411e+01  3.34486411e+01  3.34486411e+01
  1.06732635e+02  1.29001148e+02  1.29001148e+02  1.29001148e+02
  4.83331314e+02  4.83331314e+02  4.83331314e+02  5.88635328e+02
  1.33515670e+03  1.33515670e+03  1.33515670e+03  2.65697443e+03
  3.02938344e+03  3.02938344e+03  3.02938344e+03  6.64981184e+03
  6.64981184e+03  6.64981184e+03  9.06232393e+03  2.54177985e+04
  7.61600090e+04]
E1 = -728.2822738244381  E_coul = 201.54521581420755
cycle= 5 E= -526.737058010231  delta_E= -1.86e-09  |g|= 2.1e-05  |ddm|= 0.000166
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=3.94404e-05
diis-c [-8.06930726e-11  1.46649953e-05 -1.85468556e-03 -1.40449566e-02
  4.25839802e-02  9.73300997e-01]
  HOMO = -0.583190230150374  LUMO = 0.95955338876771
  mo_energy =
[-1.18578915e+02 -1.23106285e+01 -9.56215424e+00 -9.56215424e+00
 -9.56215424e+00 -1.27030391e+00 -5.83190230e-01 -5.83190230e-01
 -5.83190230e-01  9.59553389e-01  1.01539029e+00  1.01539029e+00
  1.01539029e+00  7.30920279e+00  7.30920279e+00  7.30920279e+00
  1.23526304e+01  3.34486169e+01  3.34486169e+01  3.34486169e+01
  1.06732607e+02  1.29001120e+02  1.29001120e+02  1.29001120e+02
  4.83331283e+02  4.83331283e+02  4.83331283e+02  5.88635297e+02
  1.33515666e+03  1.33515666e+03  1.33515666e+03  2.65697440e+03
  3.02938340e+03  3.02938340e+03  3.02938340e+03  6.64981180e+03
  6.64981180e+03  6.64981180e+03  9.06232390e+03  2.54177984e+04
  7.61600090e+04]
E1 = -728.2823563332247  E_coul = 201.54529832293275
cycle= 6 E= -526.737058010292  delta_E= -6.14e-11  |g|= 1.8e-06  |ddm|= 1.93e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2823563332247  E_coul = 201.54529832293275
  HOMO = -0.583190243517482  LUMO = 0.959553736603114
  mo_energy =
[-1.18578915e+02 -1.23106283e+01 -9.56215413e+00 -9.56215413e+00
 -9.56215413e+00 -1.27030352e+00 -5.83190244e-01 -5.83190244e-01
 -5.83190244e-01  9.59553737e-01  1.01539034e+00  1.01539034e+00
  1.01539034e+00  7.30920287e+00  7.30920287e+00  7.30920287e+00
  1.23526307e+01  3.34486171e+01  3.34486171e+01  3.34486171e+01
  1.06732607e+02  1.29001120e+02  1.29001120e+02  1.29001120e+02
  4.83331283e+02  4.83331283e+02  4.83331283e+02  5.88635297e+02
  1.33515666e+03  1.33515666e+03  1.33515666e+03  2.65697440e+03
  3.02938340e+03  3.02938340e+03  3.02938340e+03  6.64981180e+03
  6.64981180e+03  6.64981180e+03  9.06232390e+03  2.54177984e+04
  7.61600090e+04]
E1 = -728.2823550436782  E_coul = 201.54529703338466
Extra cycle  E= -526.737058010294  delta_E= -1.59e-12  |g|= 3.72e-07  |ddm|= 3.18e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103556.67758446289
E1 = -728.2823550436782  E_coul = 201.54529703338466
init E= -526.737058010294
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583190281769198  LUMO = 0.959553778564005
  mo_energy =
[-1.18578915e+02 -1.23106284e+01 -9.56215424e+00 -9.56215424e+00
 -9.56215424e+00 -1.27030348e+00 -5.83190282e-01 -5.83190282e-01
 -5.83190282e-01  9.59553779e-01  1.01539033e+00  1.01539033e+00
  1.01539033e+00  7.30920280e+00  7.30920280e+00  7.30920280e+00
  1.23526306e+01  3.34486169e+01  3.34486169e+01  3.34486169e+01
  1.06732607e+02  1.29001120e+02  1.29001120e+02  1.29001120e+02
  4.83331283e+02  4.83331283e+02  4.83331283e+02  5.88635297e+02
  1.33515666e+03  1.33515666e+03  1.33515666e+03  2.65697440e+03
  3.02938340e+03  3.02938340e+03  3.02938340e+03  6.64981180e+03
  6.64981180e+03  6.64981180e+03  9.06232390e+03  2.54177984e+04
  7.61600090e+04]
E1 = -728.2823552732849  E_coul = 201.54529726299333
cycle= 1 E= -526.737058010292  delta_E= 2.05e-12  |g|= 7.9e-08  |ddm|= 6.21e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2823552732849  E_coul = 201.54529726299333
  HOMO = -0.583190280295573  LUMO = 0.959553794978509
  mo_energy =
[-1.18578915e+02 -1.23106284e+01 -9.56215423e+00 -9.56215423e+00
 -9.56215423e+00 -1.27030346e+00 -5.83190280e-01 -5.83190280e-01
 -5.83190280e-01  9.59553795e-01  1.01539033e+00  1.01539033e+00
  1.01539033e+00  7.30920281e+00  7.30920281e+00  7.30920281e+00
  1.23526306e+01  3.34486170e+01  3.34486170e+01  3.34486170e+01
  1.06732607e+02  1.29001120e+02  1.29001120e+02  1.29001120e+02
  4.83331283e+02  4.83331283e+02  4.83331283e+02  5.88635297e+02
  1.33515666e+03  1.33515666e+03  1.33515666e+03  2.65697440e+03
  3.02938340e+03  3.02938340e+03  3.02938340e+03  6.64981180e+03
  6.64981180e+03  6.64981180e+03  9.06232390e+03  2.54177984e+04
  7.61600090e+04]
E1 = -728.2823551812481  E_coul = 201.54529717095534
Extra cycle  E= -526.737058010293  delta_E= -1.25e-12  |g|= 1.61e-08  |ddm|= 1.33e-07
    CPU time for scf_cycle      1.06 sec, wall time      0.39 sec
exp = [2.61826564e+04 7.61752084e+03 3.61735139e+03 1.59780337e+03
 3.82849969e+02 1.08305687e+02 3.56398174e+01 8.13068841e+00
 3.18329005e+00 6.50974417e-01 2.37627197e-01 1.36278337e+03
 6.64744041e+02 3.00954258e+02 3.14035606e+02 6.16279470e+01
 7.32235612e+00 2.02401232e+01 7.76525251e-01 2.82864749e+00
 2.22792358e-01]
grad_E = [-1.50749345e-06  3.19766124e-06 -1.63680116e-06  6.49308395e-05
  1.16909850e-04 -1.63360508e-03  1.59932212e-04 -1.69095791e-04
 -1.91863032e-04 -1.23076414e-03  4.26401391e-04 -4.97081743e-07
  5.13934302e-06  2.44238606e-05  2.10544041e-05 -1.17544638e-04
 -3.59114660e-03  9.62767131e-04  1.53155313e-03  4.70493013e-03
 -4.01494217e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564701        1
[INPUT] 0    0    [1    /1   ]  7617.52058901        1
[INPUT] 0    0    [1    /1   ]  3617.35151813        1
[INPUT] 0    0    [1    /1   ]  1597.79821237        1
[INPUT] 0    0    [1    /1   ]  382.842059609        1
[INPUT] 0    0    [1    /1   ]  108.417846623        1
[INPUT] 0    0    [1    /1   ]  35.6767039821        1
[INPUT] 0    0    [1    /1   ]  8.19630076972        1
[INPUT] 0    0    [1    /1   ]  3.19570857536        1
[INPUT] 0    0    [1    /1   ]  0.648417740144       1
[INPUT] 0    0    [1    /1   ]  0.236651939405       1
[INPUT] 1    0    [1    /1   ]  1362.78341222        1
[INPUT] 1    0    [1    /1   ]  664.74364703         1
[INPUT] 1    0    [1    /1   ]  300.952399725        1
[INPUT] 1    0    [1    /1   ]  314.034003951        1
[INPUT] 1    0    [1    /1   ]  61.6284432766        1
[INPUT] 1    0    [1    /1   ]  7.31100424876        1
[INPUT] 1    0    [1    /1   ]  20.246425355         1
[INPUT] 1    0    [1    /1   ]  0.776712534519       1
[INPUT] 1    0    [1    /1   ]  2.83024974213        1
[INPUT] 1    0    [1    /1   ]  0.222661881391       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656470140293, 1.0]], [0, [7617.520589013056, 1.0]], [0, [3617.3515181272383, 1.0]], [0, [1597.7982123691274, 1.0]], [0, [382.8420596093847, 1.0]], [0, [108.41784662257963, 1.0]], [0, [35.67670398209937, 1.0]], [0, [8.196300769720008, 1.0]], [0, [3.1957085753645083, 1.0]], [0, [0.6484177401442114, 1.0]], [0, [0.23665193940479173, 1.0]], [1, [1362.783412215138, 1.0]], [1, [664.7436470304247, 1.0]], [1, [300.9523997248728, 1.0]], [1, [314.03400395096253, 1.0]], [1, [61.62844327660138, 1.0]], [1, [7.3110042487593105, 1.0]], [1, [20.246425354958934, 1.0]], [1, [0.7767125345186164, 1.0]], [1, [2.830249742134402, 1.0]], [1, [0.22266188139148446, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65647014]
bas 1, expnt(s) = [7617.52058901]
bas 2, expnt(s) = [3617.35151813]
bas 3, expnt(s) = [1597.79821237]
bas 4, expnt(s) = [382.84205961]
bas 5, expnt(s) = [108.41784662]
bas 6, expnt(s) = [35.67670398]
bas 7, expnt(s) = [8.19630077]
bas 8, expnt(s) = [3.19570858]
bas 9, expnt(s) = [0.64841774]
bas 10, expnt(s) = [0.23665194]
bas 11, expnt(s) = [1362.78341222]
bas 12, expnt(s) = [664.74364703]
bas 13, expnt(s) = [300.95239972]
bas 14, expnt(s) = [314.03400395]
bas 15, expnt(s) = [61.62844328]
bas 16, expnt(s) = [7.31100425]
bas 17, expnt(s) = [20.24642535]
bas 18, expnt(s) = [0.77671253]
bas 19, expnt(s) = [2.83024974]
bas 20, expnt(s) = [0.22266188]
CPU time:       167.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752059e+03 2.06003810e+03
 3.61735152e+03 1.17844158e+03 1.59779821e+03 6.38493488e+02
 3.82842060e+02 2.18665243e+02 1.08417847e+02 8.48868870e+01
 3.56767040e+01 3.68810747e+01 8.19630077e+00 1.22385070e+01
 3.19570858e+00 6.03865753e+00 6.48417740e-01 1.82560237e+00
 2.36651939e-01 8.57230422e-01 1.36278341e+03 2.41556062e+04
 6.64743647e+02 9.84695916e+03 3.00952400e+02 3.65684587e+03
 3.14034004e+02 3.85660569e+03 6.16284433e+01 5.03745164e+02
 7.31100425e+00 3.50716088e+01 2.02464254e+01 1.25290989e+02
 7.76712535e-01 2.12720715e+00 2.83024974e+00 1.07094050e+01
 2.22661881e-01 4.46212503e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993652015252238
cond(S) = 103568.54355750863
E1 = -729.5233637618692  E_coul = 203.1770435645301
init E= -526.346320197339
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555812308817129  LUMO = 0.974398816460304
  mo_energy =
[-1.18327740e+02 -1.22050243e+01 -9.44693060e+00 -9.44693060e+00
 -9.44693060e+00 -1.24006036e+00 -5.55812309e-01 -5.55812309e-01
 -5.55812309e-01  9.74398816e-01  1.03389170e+00  1.03389170e+00
  1.03389170e+00  7.37970297e+00  7.37970297e+00  7.37970297e+00
  1.25224267e+01  3.35523865e+01  3.35523865e+01  3.35523865e+01
  1.07321252e+02  1.29166467e+02  1.29166467e+02  1.29166467e+02
  4.83572939e+02  4.83572939e+02  4.83572939e+02  5.89627764e+02
  1.33545018e+03  1.33545018e+03  1.33545018e+03  2.65817859e+03
  3.02973757e+03  3.02973757e+03  3.02973757e+03  6.65027546e+03
  6.65027546e+03  6.65027546e+03  9.06360244e+03  2.54191309e+04
  7.61613834e+04]
E1 = -727.8321204939407  E_coul = 201.09574475338584
cycle= 1 E= -526.736375740555  delta_E= -0.39  |g|= 0.186  |ddm|= 0.334
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541539
diis-c [-0.2932649  1.       ]
  HOMO = -0.590977335618928  LUMO = 0.946735380591336
  mo_energy =
[-1.18637019e+02 -1.23431617e+01 -9.59599512e+00 -9.59599512e+00
 -9.59599512e+00 -1.27971850e+00 -5.90977336e-01 -5.90977336e-01
 -5.90977336e-01  9.46735381e-01  1.00931361e+00  1.00931361e+00
  1.00931361e+00  7.28840543e+00  7.28840543e+00  7.28840543e+00
  1.24121833e+01  3.33977246e+01  3.33977246e+01  3.33977246e+01
  1.07100351e+02  1.28937077e+02  1.28937077e+02  1.28937077e+02
  4.83264985e+02  4.83264985e+02  4.83264985e+02  5.89281927e+02
  1.33508569e+03  1.33508569e+03  1.33508569e+03  2.65767924e+03
  3.02930656e+03  3.02930656e+03  3.02930656e+03  6.64973100e+03
  6.64973100e+03  6.64973100e+03  9.06298256e+03  2.54184169e+04
  7.61605793e+04]
E1 = -728.4082037633921  E_coul = 201.67110147073203
cycle= 2 E= -526.73710229266  delta_E= -0.000727  |g|= 0.0378  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0754854
diis-c [-0.00329772  0.08339552  0.91660448]
  HOMO = -0.581839537799597  LUMO = 0.95467971534881
  mo_energy =
[-1.18569141e+02 -1.23050132e+01 -9.55619607e+00 -9.55619607e+00
 -9.55619607e+00 -1.26877514e+00 -5.81839538e-01 -5.81839538e-01
 -5.81839538e-01  9.54679715e-01  1.01607277e+00  1.01607277e+00
  1.01607277e+00  7.31224336e+00  7.31224336e+00  7.31224336e+00
  1.24424444e+01  3.34378803e+01  3.34378803e+01  3.34378803e+01
  1.07156190e+02  1.28993112e+02  1.28993112e+02  1.28993112e+02
  4.83332047e+02  4.83332047e+02  4.83332047e+02  5.89351335e+02
  1.33515681e+03  1.33515681e+03  1.33515681e+03  2.65775367e+03
  3.02937992e+03  3.02937992e+03  3.02937992e+03  6.64980609e+03
  6.64980609e+03  6.64980609e+03  9.06305846e+03  2.54184934e+04
  7.61606561e+04]
E1 = -728.2575132154897  E_coul = 201.5203515666091
cycle= 3 E= -526.737161648881  delta_E= -5.94e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131307
diis-c [-6.18322651e-07 -1.26674890e-03  1.43608569e-01  8.57658179e-01]
  HOMO = -0.583337077670963  LUMO = 0.95347609252097
  mo_energy =
[-1.18579057e+02 -1.23107978e+01 -9.56232891e+00 -9.56232891e+00
 -9.56232891e+00 -1.27046048e+00 -5.83337078e-01 -5.83337078e-01
 -5.83337078e-01  9.53476093e-01  1.01499018e+00  1.01499018e+00
  1.01499018e+00  7.30847172e+00  7.30847172e+00  7.30847172e+00
  1.24378284e+01  3.34317333e+01  3.34317333e+01  3.34317333e+01
  1.07147957e+02  1.28984798e+02  1.28984798e+02  1.28984798e+02
  4.83322246e+02  4.83322246e+02  4.83322246e+02  5.89341183e+02
  1.33514642e+03  1.33514642e+03  1.33514642e+03  2.65774264e+03
  3.02936914e+03  3.02936914e+03  3.02936914e+03  6.64979492e+03
  6.64979492e+03  6.64979492e+03  9.06304708e+03  2.54184819e+04
  7.61606444e+04]
E1 = -728.2802022293074  E_coul = 201.5430386733996
cycle= 4 E= -526.737163555908  delta_E= -1.91e-06  |g|= 0.000102  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119769
diis-c [-4.34697637e-09  7.63565617e-05 -1.07217073e-02 -7.02286228e-02
  1.08087397e+00]
  HOMO = -0.583319370405115  LUMO = 0.953509653022016
  mo_energy =
[-1.18579020e+02 -1.23107342e+01 -9.56227943e+00 -9.56227943e+00
 -9.56227943e+00 -1.27041906e+00 -5.83319370e-01 -5.83319370e-01
 -5.83319370e-01  9.53509653e-01  1.01500568e+00  1.01500568e+00
  1.01500568e+00  7.30851239e+00  7.30851239e+00  7.30851239e+00
  1.24378875e+01  3.34317809e+01  3.34317809e+01  3.34317809e+01
  1.07148007e+02  1.28984844e+02  1.28984844e+02  1.28984844e+02
  4.83322284e+02  4.83322284e+02  4.83322284e+02  5.89341214e+02
  1.33514645e+03  1.33514645e+03  1.33514645e+03  2.65774265e+03
  3.02936916e+03  3.02936916e+03  3.02936916e+03  6.64979493e+03
  6.64979493e+03  6.64979493e+03  9.06304708e+03  2.54184818e+04
  7.61606444e+04]
E1 = -728.2799903275874  E_coul = 201.54282676979767
cycle= 5 E= -526.73716355779  delta_E= -1.88e-09  |g|= 2.11e-05  |ddm|= 0.000167
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.95816e-05
diis-c [-8.16789213e-11  1.46821999e-05 -1.85680601e-03 -1.40644735e-02
  4.26487120e-02  9.73257885e-01]
  HOMO = -0.583327056865431  LUMO = 0.953505741823712
  mo_energy =
[-1.18579051e+02 -1.23107573e+01 -9.56230451e+00 -9.56230451e+00
 -9.56230451e+00 -1.27042515e+00 -5.83327057e-01 -5.83327057e-01
 -5.83327057e-01  9.53505742e-01  1.01500057e+00  1.01500057e+00
  1.01500057e+00  7.30849533e+00  7.30849533e+00  7.30849533e+00
  1.24378687e+01  3.34317566e+01  3.34317566e+01  3.34317566e+01
  1.07147979e+02  1.28984815e+02  1.28984815e+02  1.28984815e+02
  4.83322253e+02  4.83322253e+02  4.83322253e+02  5.89341182e+02
  1.33514642e+03  1.33514642e+03  1.33514642e+03  2.65774262e+03
  3.02936913e+03  3.02936913e+03  3.02936913e+03  6.64979489e+03
  6.64979489e+03  6.64979489e+03  9.06304704e+03  2.54184818e+04
  7.61606444e+04]
E1 = -728.2800732202328  E_coul = 201.54290966238037
cycle= 6 E= -526.737163557852  delta_E= -6.28e-11  |g|= 1.81e-06  |ddm|= 1.94e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2800732202328  E_coul = 201.54290966238037
  HOMO = -0.583327068113131  LUMO = 0.953506092574895
  mo_energy =
[-1.18579051e+02 -1.23107571e+01 -9.56230438e+00 -9.56230438e+00
 -9.56230438e+00 -1.27042475e+00 -5.83327068e-01 -5.83327068e-01
 -5.83327068e-01  9.53506093e-01  1.01500062e+00  1.01500062e+00
  1.01500062e+00  7.30849541e+00  7.30849541e+00  7.30849541e+00
  1.24378690e+01  3.34317567e+01  3.34317567e+01  3.34317567e+01
  1.07147979e+02  1.28984816e+02  1.28984816e+02  1.28984816e+02
  4.83322253e+02  4.83322253e+02  4.83322253e+02  5.89341182e+02
  1.33514642e+03  1.33514642e+03  1.33514642e+03  2.65774262e+03
  3.02936913e+03  3.02936913e+03  3.02936913e+03  6.64979489e+03
  6.64979489e+03  6.64979489e+03  9.06304704e+03  2.54184818e+04
  7.61606444e+04]
E1 = -728.2800718805321  E_coul = 201.5429083226791
Extra cycle  E= -526.737163557853  delta_E= -5.68e-13  |g|= 3.74e-07  |ddm|= 3.21e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.28 sec
exp = [2.61826565e+04 7.61752059e+03 3.61735152e+03 1.59779821e+03
 3.82842060e+02 1.08417847e+02 3.56767040e+01 8.19630077e+00
 3.19570858e+00 6.48417740e-01 2.36651939e-01 1.36278341e+03
 6.64743647e+02 3.00952400e+02 3.14034004e+02 6.16284433e+01
 7.31100425e+00 2.02464254e+01 7.76712535e-01 2.83024974e+00
 2.22661881e-01]
E = -526.737163557853
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6564701        1
[INPUT] 0    0    [1    /1   ]  7617.52058901        1
[INPUT] 0    0    [1    /1   ]  3617.35151813        1
[INPUT] 0    0    [1    /1   ]  1597.79821237        1
[INPUT] 0    0    [1    /1   ]  382.842059609        1
[INPUT] 0    0    [1    /1   ]  108.417846623        1
[INPUT] 0    0    [1    /1   ]  35.6767039821        1
[INPUT] 0    0    [1    /1   ]  8.19630076972        1
[INPUT] 0    0    [1    /1   ]  3.19570857536        1
[INPUT] 0    0    [1    /1   ]  0.648417740144       1
[INPUT] 0    0    [1    /1   ]  0.236651939405       1
[INPUT] 1    0    [1    /1   ]  1362.78341222        1
[INPUT] 1    0    [1    /1   ]  664.74364703         1
[INPUT] 1    0    [1    /1   ]  300.952399725        1
[INPUT] 1    0    [1    /1   ]  314.034003951        1
[INPUT] 1    0    [1    /1   ]  61.6284432766        1
[INPUT] 1    0    [1    /1   ]  7.31100424876        1
[INPUT] 1    0    [1    /1   ]  20.246425355         1
[INPUT] 1    0    [1    /1   ]  0.776712534519       1
[INPUT] 1    0    [1    /1   ]  2.83024974213        1
[INPUT] 1    0    [1    /1   ]  0.222661881391       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656470140293, 1.0]], [0, [7617.520589013056, 1.0]], [0, [3617.3515181272383, 1.0]], [0, [1597.7982123691274, 1.0]], [0, [382.8420596093847, 1.0]], [0, [108.41784662257963, 1.0]], [0, [35.67670398209937, 1.0]], [0, [8.196300769720008, 1.0]], [0, [3.1957085753645083, 1.0]], [0, [0.6484177401442114, 1.0]], [0, [0.23665193940479173, 1.0]], [1, [1362.783412215138, 1.0]], [1, [664.7436470304247, 1.0]], [1, [300.9523997248728, 1.0]], [1, [314.03400395096253, 1.0]], [1, [61.62844327660138, 1.0]], [1, [7.3110042487593105, 1.0]], [1, [20.246425354958934, 1.0]], [1, [0.7767125345186164, 1.0]], [1, [2.830249742134402, 1.0]], [1, [0.22266188139148446, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65647014]
bas 1, expnt(s) = [7617.52058901]
bas 2, expnt(s) = [3617.35151813]
bas 3, expnt(s) = [1597.79821237]
bas 4, expnt(s) = [382.84205961]
bas 5, expnt(s) = [108.41784662]
bas 6, expnt(s) = [35.67670398]
bas 7, expnt(s) = [8.19630077]
bas 8, expnt(s) = [3.19570858]
bas 9, expnt(s) = [0.64841774]
bas 10, expnt(s) = [0.23665194]
bas 11, expnt(s) = [1362.78341222]
bas 12, expnt(s) = [664.74364703]
bas 13, expnt(s) = [300.95239972]
bas 14, expnt(s) = [314.03400395]
bas 15, expnt(s) = [61.62844328]
bas 16, expnt(s) = [7.31100425]
bas 17, expnt(s) = [20.24642535]
bas 18, expnt(s) = [0.77671253]
bas 19, expnt(s) = [2.83024974]
bas 20, expnt(s) = [0.22266188]
CPU time:       168.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826565e+04 5.20026296e+03 7.61752059e+03 2.06003810e+03
 3.61735152e+03 1.17844158e+03 1.59779821e+03 6.38493488e+02
 3.82842060e+02 2.18665243e+02 1.08417847e+02 8.48868870e+01
 3.56767040e+01 3.68810747e+01 8.19630077e+00 1.22385070e+01
 3.19570858e+00 6.03865753e+00 6.48417740e-01 1.82560237e+00
 2.36651939e-01 8.57230422e-01 1.36278341e+03 2.41556062e+04
 6.64743647e+02 9.84695916e+03 3.00952400e+02 3.65684587e+03
 3.14034004e+02 3.85660569e+03 6.16284433e+01 5.03745164e+02
 7.31100425e+00 3.50716088e+01 2.02464254e+01 1.25290989e+02
 7.76712535e-01 2.12720715e+00 2.83024974e+00 1.07094050e+01
 2.22661881e-01 4.46212503e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993652015252238
cond(S) = 103568.54355750863
E1 = -729.5233637618692  E_coul = 203.1770435645301
init E= -526.346320197339
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555812308817129  LUMO = 0.974398816460304
  mo_energy =
[-1.18327740e+02 -1.22050243e+01 -9.44693060e+00 -9.44693060e+00
 -9.44693060e+00 -1.24006036e+00 -5.55812309e-01 -5.55812309e-01
 -5.55812309e-01  9.74398816e-01  1.03389170e+00  1.03389170e+00
  1.03389170e+00  7.37970297e+00  7.37970297e+00  7.37970297e+00
  1.25224267e+01  3.35523865e+01  3.35523865e+01  3.35523865e+01
  1.07321252e+02  1.29166467e+02  1.29166467e+02  1.29166467e+02
  4.83572939e+02  4.83572939e+02  4.83572939e+02  5.89627764e+02
  1.33545018e+03  1.33545018e+03  1.33545018e+03  2.65817859e+03
  3.02973757e+03  3.02973757e+03  3.02973757e+03  6.65027546e+03
  6.65027546e+03  6.65027546e+03  9.06360244e+03  2.54191309e+04
  7.61613834e+04]
E1 = -727.8321204939407  E_coul = 201.09574475338584
cycle= 1 E= -526.736375740555  delta_E= -0.39  |g|= 0.186  |ddm|= 0.334
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541539
diis-c [-0.2932649  1.       ]
  HOMO = -0.590977335618928  LUMO = 0.946735380591336
  mo_energy =
[-1.18637019e+02 -1.23431617e+01 -9.59599512e+00 -9.59599512e+00
 -9.59599512e+00 -1.27971850e+00 -5.90977336e-01 -5.90977336e-01
 -5.90977336e-01  9.46735381e-01  1.00931361e+00  1.00931361e+00
  1.00931361e+00  7.28840543e+00  7.28840543e+00  7.28840543e+00
  1.24121833e+01  3.33977246e+01  3.33977246e+01  3.33977246e+01
  1.07100351e+02  1.28937077e+02  1.28937077e+02  1.28937077e+02
  4.83264985e+02  4.83264985e+02  4.83264985e+02  5.89281927e+02
  1.33508569e+03  1.33508569e+03  1.33508569e+03  2.65767924e+03
  3.02930656e+03  3.02930656e+03  3.02930656e+03  6.64973100e+03
  6.64973100e+03  6.64973100e+03  9.06298256e+03  2.54184169e+04
  7.61605793e+04]
E1 = -728.4082037633921  E_coul = 201.67110147073203
cycle= 2 E= -526.73710229266  delta_E= -0.000727  |g|= 0.0378  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0754854
diis-c [-0.00329772  0.08339552  0.91660448]
  HOMO = -0.581839537799597  LUMO = 0.95467971534881
  mo_energy =
[-1.18569141e+02 -1.23050132e+01 -9.55619607e+00 -9.55619607e+00
 -9.55619607e+00 -1.26877514e+00 -5.81839538e-01 -5.81839538e-01
 -5.81839538e-01  9.54679715e-01  1.01607277e+00  1.01607277e+00
  1.01607277e+00  7.31224336e+00  7.31224336e+00  7.31224336e+00
  1.24424444e+01  3.34378803e+01  3.34378803e+01  3.34378803e+01
  1.07156190e+02  1.28993112e+02  1.28993112e+02  1.28993112e+02
  4.83332047e+02  4.83332047e+02  4.83332047e+02  5.89351335e+02
  1.33515681e+03  1.33515681e+03  1.33515681e+03  2.65775367e+03
  3.02937992e+03  3.02937992e+03  3.02937992e+03  6.64980609e+03
  6.64980609e+03  6.64980609e+03  9.06305846e+03  2.54184934e+04
  7.61606561e+04]
E1 = -728.2575132154897  E_coul = 201.5203515666091
cycle= 3 E= -526.737161648881  delta_E= -5.94e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131307
diis-c [-6.18322651e-07 -1.26674890e-03  1.43608569e-01  8.57658179e-01]
  HOMO = -0.583337077670963  LUMO = 0.95347609252097
  mo_energy =
[-1.18579057e+02 -1.23107978e+01 -9.56232891e+00 -9.56232891e+00
 -9.56232891e+00 -1.27046048e+00 -5.83337078e-01 -5.83337078e-01
 -5.83337078e-01  9.53476093e-01  1.01499018e+00  1.01499018e+00
  1.01499018e+00  7.30847172e+00  7.30847172e+00  7.30847172e+00
  1.24378284e+01  3.34317333e+01  3.34317333e+01  3.34317333e+01
  1.07147957e+02  1.28984798e+02  1.28984798e+02  1.28984798e+02
  4.83322246e+02  4.83322246e+02  4.83322246e+02  5.89341183e+02
  1.33514642e+03  1.33514642e+03  1.33514642e+03  2.65774264e+03
  3.02936914e+03  3.02936914e+03  3.02936914e+03  6.64979492e+03
  6.64979492e+03  6.64979492e+03  9.06304708e+03  2.54184819e+04
  7.61606444e+04]
E1 = -728.2802022293074  E_coul = 201.5430386733996
cycle= 4 E= -526.737163555908  delta_E= -1.91e-06  |g|= 0.000102  |ddm|= 0.00224
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119769
diis-c [-4.34697637e-09  7.63565617e-05 -1.07217073e-02 -7.02286228e-02
  1.08087397e+00]
  HOMO = -0.583319370405115  LUMO = 0.953509653022016
  mo_energy =
[-1.18579020e+02 -1.23107342e+01 -9.56227943e+00 -9.56227943e+00
 -9.56227943e+00 -1.27041906e+00 -5.83319370e-01 -5.83319370e-01
 -5.83319370e-01  9.53509653e-01  1.01500568e+00  1.01500568e+00
  1.01500568e+00  7.30851239e+00  7.30851239e+00  7.30851239e+00
  1.24378875e+01  3.34317809e+01  3.34317809e+01  3.34317809e+01
  1.07148007e+02  1.28984844e+02  1.28984844e+02  1.28984844e+02
  4.83322284e+02  4.83322284e+02  4.83322284e+02  5.89341214e+02
  1.33514645e+03  1.33514645e+03  1.33514645e+03  2.65774265e+03
  3.02936916e+03  3.02936916e+03  3.02936916e+03  6.64979493e+03
  6.64979493e+03  6.64979493e+03  9.06304708e+03  2.54184818e+04
  7.61606444e+04]
E1 = -728.2799903275874  E_coul = 201.54282676979767
cycle= 5 E= -526.73716355779  delta_E= -1.88e-09  |g|= 2.11e-05  |ddm|= 0.000167
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.95816e-05
diis-c [-8.16789213e-11  1.46821999e-05 -1.85680601e-03 -1.40644735e-02
  4.26487120e-02  9.73257885e-01]
  HOMO = -0.583327056865431  LUMO = 0.953505741823712
  mo_energy =
[-1.18579051e+02 -1.23107573e+01 -9.56230451e+00 -9.56230451e+00
 -9.56230451e+00 -1.27042515e+00 -5.83327057e-01 -5.83327057e-01
 -5.83327057e-01  9.53505742e-01  1.01500057e+00  1.01500057e+00
  1.01500057e+00  7.30849533e+00  7.30849533e+00  7.30849533e+00
  1.24378687e+01  3.34317566e+01  3.34317566e+01  3.34317566e+01
  1.07147979e+02  1.28984815e+02  1.28984815e+02  1.28984815e+02
  4.83322253e+02  4.83322253e+02  4.83322253e+02  5.89341182e+02
  1.33514642e+03  1.33514642e+03  1.33514642e+03  2.65774262e+03
  3.02936913e+03  3.02936913e+03  3.02936913e+03  6.64979489e+03
  6.64979489e+03  6.64979489e+03  9.06304704e+03  2.54184818e+04
  7.61606444e+04]
E1 = -728.2800732202328  E_coul = 201.54290966238037
cycle= 6 E= -526.737163557852  delta_E= -6.28e-11  |g|= 1.81e-06  |ddm|= 1.94e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2800732202328  E_coul = 201.54290966238037
  HOMO = -0.583327068113131  LUMO = 0.953506092574895
  mo_energy =
[-1.18579051e+02 -1.23107571e+01 -9.56230438e+00 -9.56230438e+00
 -9.56230438e+00 -1.27042475e+00 -5.83327068e-01 -5.83327068e-01
 -5.83327068e-01  9.53506093e-01  1.01500062e+00  1.01500062e+00
  1.01500062e+00  7.30849541e+00  7.30849541e+00  7.30849541e+00
  1.24378690e+01  3.34317567e+01  3.34317567e+01  3.34317567e+01
  1.07147979e+02  1.28984816e+02  1.28984816e+02  1.28984816e+02
  4.83322253e+02  4.83322253e+02  4.83322253e+02  5.89341182e+02
  1.33514642e+03  1.33514642e+03  1.33514642e+03  2.65774262e+03
  3.02936913e+03  3.02936913e+03  3.02936913e+03  6.64979489e+03
  6.64979489e+03  6.64979489e+03  9.06304704e+03  2.54184818e+04
  7.61606444e+04]
E1 = -728.2800718805321  E_coul = 201.5429083226791
Extra cycle  E= -526.737163557853  delta_E= -5.68e-13  |g|= 3.74e-07  |ddm|= 3.21e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103568.54355750863
E1 = -728.2800718805321  E_coul = 201.5429083226791
init E= -526.737163557853
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583327107566154  LUMO = 0.953506133934053
  mo_energy =
[-1.18579051e+02 -1.23107572e+01 -9.56230450e+00 -9.56230450e+00
 -9.56230450e+00 -1.27042471e+00 -5.83327108e-01 -5.83327108e-01
 -5.83327108e-01  9.53506134e-01  1.01500061e+00  1.01500061e+00
  1.01500061e+00  7.30849534e+00  7.30849534e+00  7.30849534e+00
  1.24378689e+01  3.34317566e+01  3.34317566e+01  3.34317566e+01
  1.07147979e+02  1.28984816e+02  1.28984816e+02  1.28984816e+02
  4.83322253e+02  4.83322253e+02  4.83322253e+02  5.89341182e+02
  1.33514642e+03  1.33514642e+03  1.33514642e+03  2.65774262e+03
  3.02936913e+03  3.02936913e+03  3.02936913e+03  6.64979489e+03
  6.64979489e+03  6.64979489e+03  9.06304704e+03  2.54184818e+04
  7.61606444e+04]
E1 = -728.2800721215422  E_coul = 201.54290856368917
cycle= 1 E= -526.737163557853  delta_E=    0  |g|= 7.97e-08  |ddm|= 6.25e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2800721215422  E_coul = 201.54290856368917
  HOMO = -0.58332710592548  LUMO = 0.953506150555881
  mo_energy =
[-1.18579051e+02 -1.23107571e+01 -9.56230448e+00 -9.56230448e+00
 -9.56230448e+00 -1.27042469e+00 -5.83327106e-01 -5.83327106e-01
 -5.83327106e-01  9.53506151e-01  1.01500061e+00  1.01500061e+00
  1.01500061e+00  7.30849535e+00  7.30849535e+00  7.30849535e+00
  1.24378690e+01  3.34317566e+01  3.34317566e+01  3.34317566e+01
  1.07147979e+02  1.28984816e+02  1.28984816e+02  1.28984816e+02
  4.83322253e+02  4.83322253e+02  4.83322253e+02  5.89341182e+02
  1.33514642e+03  1.33514642e+03  1.33514642e+03  2.65774262e+03
  3.02936913e+03  3.02936913e+03  3.02936913e+03  6.64979489e+03
  6.64979489e+03  6.64979489e+03  9.06304704e+03  2.54184818e+04
  7.61606444e+04]
E1 = -728.2800720256826  E_coul = 201.54290846782874
Extra cycle  E= -526.737163557854  delta_E= -7.96e-13  |g|= 1.63e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826565e+04 7.61752059e+03 3.61735152e+03 1.59779821e+03
 3.82842060e+02 1.08417847e+02 3.56767040e+01 8.19630077e+00
 3.19570858e+00 6.48417740e-01 2.36651939e-01 1.36278341e+03
 6.64743647e+02 3.00952400e+02 3.14034004e+02 6.16284433e+01
 7.31100425e+00 2.02464254e+01 7.76712535e-01 2.83024974e+00
 2.22661881e-01]
grad_E = [-1.50904729e-06  3.21413270e-06 -1.62933014e-06  6.55578227e-05
  9.98722759e-05 -1.56088792e-03  1.15572498e-04  3.37666151e-04
 -1.13205275e-03 -1.30237390e-03 -2.76702259e-04 -4.90602423e-07
  5.22611076e-06  2.49526497e-05  2.15084458e-05 -1.80161914e-04
 -5.38504673e-03  1.51996517e-03  3.55481186e-03  6.63346855e-03
 -9.99362833e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6567086        1
[INPUT] 0    0    [1    /1   ]  7617.52008176        1
[INPUT] 0    0    [1    /1   ]  3617.3517758         1
[INPUT] 0    0    [1    /1   ]  1597.78787418        1
[INPUT] 0    0    [1    /1   ]  382.826576306        1
[INPUT] 0    0    [1    /1   ]  108.639455678        1
[INPUT] 0    0    [1    /1   ]  35.7570727737        1
[INPUT] 0    0    [1    /1   ]  8.32949529699        1
[INPUT] 0    0    [1    /1   ]  3.22648755151        1
[INPUT] 0    0    [1    /1   ]  0.647074986824       1
[INPUT] 0    0    [1    /1   ]  0.236370265933       1
[INPUT] 1    0    [1    /1   ]  1362.78349248        1
[INPUT] 1    0    [1    /1   ]  664.74285762         1
[INPUT] 1    0    [1    /1   ]  300.948679383        1
[INPUT] 1    0    [1    /1   ]  314.030796284        1
[INPUT] 1    0    [1    /1   ]  61.6297048714        1
[INPUT] 1    0    [1    /1   ]  7.29554850974        1
[INPUT] 1    0    [1    /1   ]  20.2567013649        1
[INPUT] 1    0    [1    /1   ]  0.776432901467       1
[INPUT] 1    0    [1    /1   ]  2.82564363958        1
[INPUT] 1    0    [1    /1   ]  0.222407415622       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656708582996, 1.0]], [0, [7617.520081761021, 1.0]], [0, [3617.35177579926, 1.0]], [0, [1597.787874181228, 1.0]], [0, [382.82657630633696, 1.0]], [0, [108.63945567771488, 1.0]], [0, [35.75707277369031, 1.0]], [0, [8.329495296993372, 1.0]], [0, [3.226487551509905, 1.0]], [0, [0.6470749868238679, 1.0]], [0, [0.2363702659325695, 1.0]], [1, [1362.7834924784709, 1.0]], [1, [664.7428576204956, 1.0]], [1, [300.9486793827725, 1.0]], [1, [314.03079628420073, 1.0]], [1, [61.629704871441, 1.0]], [1, [7.295548509735123, 1.0]], [1, [20.256701364887615, 1.0]], [1, [0.776432901466978, 1.0]], [1, [2.825643639575861, 1.0]], [1, [0.22240741562182165, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65670858]
bas 1, expnt(s) = [7617.52008176]
bas 2, expnt(s) = [3617.3517758]
bas 3, expnt(s) = [1597.78787418]
bas 4, expnt(s) = [382.82657631]
bas 5, expnt(s) = [108.63945568]
bas 6, expnt(s) = [35.75707277]
bas 7, expnt(s) = [8.3294953]
bas 8, expnt(s) = [3.22648755]
bas 9, expnt(s) = [0.64707499]
bas 10, expnt(s) = [0.23637027]
bas 11, expnt(s) = [1362.78349248]
bas 12, expnt(s) = [664.74285762]
bas 13, expnt(s) = [300.94867938]
bas 14, expnt(s) = [314.03079628]
bas 15, expnt(s) = [61.62970487]
bas 16, expnt(s) = [7.29554851]
bas 17, expnt(s) = [20.25670136]
bas 18, expnt(s) = [0.7764329]
bas 19, expnt(s) = [2.82564364]
bas 20, expnt(s) = [0.22240742]
CPU time:       173.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826567e+04 5.20026299e+03 7.61752008e+03 2.06003799e+03
 3.61735178e+03 1.17844165e+03 1.59778787e+03 6.38490390e+02
 3.82826576e+02 2.18658610e+02 1.08639456e+02 8.50169871e+01
 3.57570728e+01 3.69433686e+01 8.32949530e+00 1.23873680e+01
 3.22648755e+00 6.08222553e+00 6.47074987e-01 1.82276627e+00
 2.36370266e-01 8.56465073e-01 1.36278349e+03 2.41556080e+04
 6.64742858e+02 9.84694455e+03 3.00948679e+02 3.65678936e+03
 3.14030796e+02 3.85655645e+03 6.16297049e+01 5.03758054e+02
 7.29554851e+00 3.49789549e+01 2.02567014e+01 1.25370483e+02
 7.76432901e-01 2.12624990e+00 2.82564364e+00 1.06876231e+01
 2.22407416e-01 4.45575160e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993666596271876
cond(S) = 103608.3527424339
E1 = -729.525064326687  E_coul = 203.17782871612005
init E= -526.347235610567
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555830457542898  LUMO = 0.973039888975281
  mo_energy =
[-1.18327842e+02 -1.22048886e+01 -9.44682881e+00 -9.44682881e+00
 -9.44682881e+00 -1.24005551e+00 -5.55830458e-01 -5.55830458e-01
 -5.55830458e-01  9.73039889e-01  1.03266283e+00  1.03266283e+00
  1.03266283e+00  7.36519823e+00  7.36519823e+00  7.36519823e+00
  1.27397616e+01  3.35044765e+01  3.35044765e+01  3.35044765e+01
  1.08219757e+02  1.29125249e+02  1.29125249e+02  1.29125249e+02
  4.83548220e+02  4.83548220e+02  4.83548220e+02  5.91105574e+02
  1.33542387e+03  1.33542387e+03  1.33542387e+03  2.65977221e+03
  3.02970360e+03  3.02970360e+03  3.02970360e+03  6.65023666e+03
  6.65023666e+03  6.65023666e+03  9.06510105e+03  2.54205471e+04
  7.61627002e+04]
E1 = -727.8289990715627  E_coul = 201.09242612298087
cycle= 1 E= -526.736572948582  delta_E= -0.389  |g|= 0.186  |ddm|= 0.343
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541818
diis-c [-0.2935669  1.       ]
  HOMO = -0.591152875062527  LUMO = 0.945223543510719
  mo_energy =
[-1.18637267e+02 -1.23433315e+01 -9.59620985e+00 -9.59620985e+00
 -9.59620985e+00 -1.27988882e+00 -5.91152875e-01 -5.91152875e-01
 -5.91152875e-01  9.45223544e-01  1.00799214e+00  1.00799214e+00
  1.00799214e+00  7.27375054e+00  7.27375054e+00  7.27375054e+00
  1.26283794e+01  3.33495503e+01  3.33495503e+01  3.33495503e+01
  1.07998179e+02  1.28895607e+02  1.28895607e+02  1.28895607e+02
  4.83240056e+02  4.83240056e+02  4.83240056e+02  5.90759561e+02
  1.33505925e+03  1.33505925e+03  1.33505925e+03  2.65927288e+03
  3.02927254e+03  3.02927254e+03  3.02927254e+03  6.64969221e+03
  6.64969221e+03  6.64969221e+03  9.06448124e+03  2.54198333e+04
  7.61618963e+04]
E1 = -728.4062564911582  E_coul = 201.66895464647638
cycle= 2 E= -526.737301844682  delta_E= -0.000729  |g|= 0.0378  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755817
diis-c [-0.00330976  0.08339718  0.91660282]
  HOMO = -0.581991008221198  LUMO = 0.953193233512035
  mo_energy =
[-1.18569279e+02 -1.23051010e+01 -9.55632992e+00 -9.55632992e+00
 -9.55632992e+00 -1.26891562e+00 -5.81991008e-01 -5.81991008e-01
 -5.81991008e-01  9.53193234e-01  1.01476281e+00  1.01476281e+00
  1.01476281e+00  7.29761631e+00  7.29761631e+00  7.29761631e+00
  1.26589508e+01  3.33897798e+01  3.33897798e+01  3.33897798e+01
  1.08054162e+02  1.28951745e+02  1.28951745e+02  1.28951745e+02
  4.83307227e+02  4.83307227e+02  4.83307227e+02  5.90829080e+02
  1.33513048e+03  1.33513048e+03  1.33513048e+03  2.65934742e+03
  3.02934601e+03  3.02934601e+03  3.02934601e+03  6.64976742e+03
  6.64976742e+03  6.64976742e+03  9.06455726e+03  2.54199099e+04
  7.61619732e+04]
E1 = -728.2551731993609  E_coul = 201.51781173745192
cycle= 3 E= -526.737361461909  delta_E= -5.96e-05  |g|= 0.00627  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131606
diis-c [-6.21366069e-07 -1.26642108e-03  1.43744762e-01  8.57521659e-01]
  HOMO = -0.583493933653355  LUMO = 0.95198442380002
  mo_energy =
[-1.18579219e+02 -1.23109008e+01 -9.56247863e+00 -9.56247863e+00
 -9.56247863e+00 -1.27060717e+00 -5.83493934e-01 -5.83493934e-01
 -5.83493934e-01  9.51984424e-01  1.01367726e+00  1.01367726e+00
  1.01367726e+00  7.29383754e+00  7.29383754e+00  7.29383754e+00
  1.26542869e+01  3.33836177e+01  3.33836177e+01  3.33836177e+01
  1.08045901e+02  1.28943411e+02  1.28943411e+02  1.28943411e+02
  4.83297403e+02  4.83297403e+02  4.83297403e+02  5.90818904e+02
  1.33512006e+03  1.33512006e+03  1.33512006e+03  2.65933637e+03
  3.02933521e+03  3.02933521e+03  3.02933521e+03  6.64975622e+03
  6.64975622e+03  6.64975622e+03  9.06454585e+03  2.54198983e+04
  7.61619615e+04]
E1 = -728.2779356612315  E_coul = 201.540572280613
cycle= 4 E= -526.737363380618  delta_E= -1.92e-06  |g|= 0.000102  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000120547
diis-c [-4.37557250e-09  7.65145046e-05 -1.07381643e-02 -7.03140211e-02
  1.08097567e+00]
  HOMO = -0.583476327509685  LUMO = 0.952017945323385
  mo_energy =
[-1.18579182e+02 -1.23108373e+01 -9.56242935e+00 -9.56242935e+00
 -9.56242935e+00 -1.27056581e+00 -5.83476328e-01 -5.83476328e-01
 -5.83476328e-01  9.52017945e-01  1.01369269e+00  1.01369269e+00
  1.01369269e+00  7.29387803e+00  7.29387803e+00  7.29387803e+00
  1.26543460e+01  3.33836651e+01  3.33836651e+01  3.33836651e+01
  1.08045951e+02  1.28943456e+02  1.28943456e+02  1.28943456e+02
  4.83297441e+02  4.83297441e+02  4.83297441e+02  5.90818934e+02
  1.33512009e+03  1.33512009e+03  1.33512009e+03  2.65933638e+03
  3.02933523e+03  3.02933523e+03  3.02933523e+03  6.64975623e+03
  6.64975623e+03  6.64975623e+03  9.06454585e+03  2.54198983e+04
  7.61619614e+04]
E1 = -728.2777242028592  E_coul = 201.54036082034847
cycle= 5 E= -526.737363382511  delta_E= -1.89e-09  |g|= 2.11e-05  |ddm|= 0.000167
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.96626e-05
diis-c [-8.19967023e-11  1.46754382e-05 -1.85927714e-03 -1.40683601e-02
  4.26846540e-02  9.73228308e-01]
  HOMO = -0.583484036174603  LUMO = 0.952014018532077
  mo_energy =
[-1.18579213e+02 -1.23108605e+01 -9.56245449e+00 -9.56245449e+00
 -9.56245449e+00 -1.27057192e+00 -5.83484036e-01 -5.83484036e-01
 -5.83484036e-01  9.52014019e-01  1.01368757e+00  1.01368757e+00
  1.01368757e+00  7.29386094e+00  7.29386094e+00  7.29386094e+00
  1.26543271e+01  3.33836407e+01  3.33836407e+01  3.33836407e+01
  1.08045923e+02  1.28943427e+02  1.28943427e+02  1.28943427e+02
  4.83297410e+02  4.83297410e+02  4.83297410e+02  5.90818902e+02
  1.33512006e+03  1.33512006e+03  1.33512006e+03  2.65933634e+03
  3.02933519e+03  3.02933519e+03  3.02933519e+03  6.64975619e+03
  6.64975619e+03  6.64975619e+03  9.06454581e+03  2.54198982e+04
  7.61619614e+04]
E1 = -728.2778073710604  E_coul = 201.5404439884869
cycle= 6 E= -526.737363382573  delta_E= -6.28e-11  |g|= 1.81e-06  |ddm|= 1.95e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2778073710604  E_coul = 201.5404439884869
  HOMO = -0.583484045382659  LUMO = 0.952014372109315
  mo_energy =
[-1.18579213e+02 -1.23108603e+01 -9.56245436e+00 -9.56245436e+00
 -9.56245436e+00 -1.27057152e+00 -5.83484045e-01 -5.83484045e-01
 -5.83484045e-01  9.52014372e-01  1.01368762e+00  1.01368762e+00
  1.01368762e+00  7.29386103e+00  7.29386103e+00  7.29386103e+00
  1.26543273e+01  3.33836409e+01  3.33836409e+01  3.33836409e+01
  1.08045923e+02  1.28943428e+02  1.28943428e+02  1.28943428e+02
  4.83297410e+02  4.83297410e+02  4.83297410e+02  5.90818902e+02
  1.33512006e+03  1.33512006e+03  1.33512006e+03  2.65933634e+03
  3.02933519e+03  3.02933519e+03  3.02933519e+03  6.64975619e+03
  6.64975619e+03  6.64975619e+03  9.06454581e+03  2.54198982e+04
  7.61619614e+04]
E1 = -728.2778060085745  E_coul = 201.54044262600016
Extra cycle  E= -526.737363382574  delta_E= -9.09e-13  |g|= 3.75e-07  |ddm|= 3.22e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
exp = [2.61826567e+04 7.61752008e+03 3.61735178e+03 1.59778787e+03
 3.82826576e+02 1.08639456e+02 3.57570728e+01 8.32949530e+00
 3.22648755e+00 6.47074987e-01 2.36370266e-01 1.36278349e+03
 6.64742858e+02 3.00948679e+02 3.14030796e+02 6.16297049e+01
 7.29554851e+00 2.02567014e+01 7.76432901e-01 2.82564364e+00
 2.22407416e-01]
E = -526.7373633825744
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6567086        1
[INPUT] 0    0    [1    /1   ]  7617.52008176        1
[INPUT] 0    0    [1    /1   ]  3617.3517758         1
[INPUT] 0    0    [1    /1   ]  1597.78787418        1
[INPUT] 0    0    [1    /1   ]  382.826576306        1
[INPUT] 0    0    [1    /1   ]  108.639455678        1
[INPUT] 0    0    [1    /1   ]  35.7570727737        1
[INPUT] 0    0    [1    /1   ]  8.32949529699        1
[INPUT] 0    0    [1    /1   ]  3.22648755151        1
[INPUT] 0    0    [1    /1   ]  0.647074986824       1
[INPUT] 0    0    [1    /1   ]  0.236370265933       1
[INPUT] 1    0    [1    /1   ]  1362.78349248        1
[INPUT] 1    0    [1    /1   ]  664.74285762         1
[INPUT] 1    0    [1    /1   ]  300.948679383        1
[INPUT] 1    0    [1    /1   ]  314.030796284        1
[INPUT] 1    0    [1    /1   ]  61.6297048714        1
[INPUT] 1    0    [1    /1   ]  7.29554850974        1
[INPUT] 1    0    [1    /1   ]  20.2567013649        1
[INPUT] 1    0    [1    /1   ]  0.776432901467       1
[INPUT] 1    0    [1    /1   ]  2.82564363958        1
[INPUT] 1    0    [1    /1   ]  0.222407415622       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.656708582996, 1.0]], [0, [7617.520081761021, 1.0]], [0, [3617.35177579926, 1.0]], [0, [1597.787874181228, 1.0]], [0, [382.82657630633696, 1.0]], [0, [108.63945567771488, 1.0]], [0, [35.75707277369031, 1.0]], [0, [8.329495296993372, 1.0]], [0, [3.226487551509905, 1.0]], [0, [0.6470749868238679, 1.0]], [0, [0.2363702659325695, 1.0]], [1, [1362.7834924784709, 1.0]], [1, [664.7428576204956, 1.0]], [1, [300.9486793827725, 1.0]], [1, [314.03079628420073, 1.0]], [1, [61.629704871441, 1.0]], [1, [7.295548509735123, 1.0]], [1, [20.256701364887615, 1.0]], [1, [0.776432901466978, 1.0]], [1, [2.825643639575861, 1.0]], [1, [0.22240741562182165, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65670858]
bas 1, expnt(s) = [7617.52008176]
bas 2, expnt(s) = [3617.3517758]
bas 3, expnt(s) = [1597.78787418]
bas 4, expnt(s) = [382.82657631]
bas 5, expnt(s) = [108.63945568]
bas 6, expnt(s) = [35.75707277]
bas 7, expnt(s) = [8.3294953]
bas 8, expnt(s) = [3.22648755]
bas 9, expnt(s) = [0.64707499]
bas 10, expnt(s) = [0.23637027]
bas 11, expnt(s) = [1362.78349248]
bas 12, expnt(s) = [664.74285762]
bas 13, expnt(s) = [300.94867938]
bas 14, expnt(s) = [314.03079628]
bas 15, expnt(s) = [61.62970487]
bas 16, expnt(s) = [7.29554851]
bas 17, expnt(s) = [20.25670136]
bas 18, expnt(s) = [0.7764329]
bas 19, expnt(s) = [2.82564364]
bas 20, expnt(s) = [0.22240742]
CPU time:       174.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826567e+04 5.20026299e+03 7.61752008e+03 2.06003799e+03
 3.61735178e+03 1.17844165e+03 1.59778787e+03 6.38490390e+02
 3.82826576e+02 2.18658610e+02 1.08639456e+02 8.50169871e+01
 3.57570728e+01 3.69433686e+01 8.32949530e+00 1.23873680e+01
 3.22648755e+00 6.08222553e+00 6.47074987e-01 1.82276627e+00
 2.36370266e-01 8.56465073e-01 1.36278349e+03 2.41556080e+04
 6.64742858e+02 9.84694455e+03 3.00948679e+02 3.65678936e+03
 3.14030796e+02 3.85655645e+03 6.16297049e+01 5.03758054e+02
 7.29554851e+00 3.49789549e+01 2.02567014e+01 1.25370483e+02
 7.76432901e-01 2.12624990e+00 2.82564364e+00 1.06876231e+01
 2.22407416e-01 4.45575160e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993666596271876
cond(S) = 103608.3527424339
E1 = -729.525064326687  E_coul = 203.17782871612005
init E= -526.347235610567
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555830457542898  LUMO = 0.973039888975281
  mo_energy =
[-1.18327842e+02 -1.22048886e+01 -9.44682881e+00 -9.44682881e+00
 -9.44682881e+00 -1.24005551e+00 -5.55830458e-01 -5.55830458e-01
 -5.55830458e-01  9.73039889e-01  1.03266283e+00  1.03266283e+00
  1.03266283e+00  7.36519823e+00  7.36519823e+00  7.36519823e+00
  1.27397616e+01  3.35044765e+01  3.35044765e+01  3.35044765e+01
  1.08219757e+02  1.29125249e+02  1.29125249e+02  1.29125249e+02
  4.83548220e+02  4.83548220e+02  4.83548220e+02  5.91105574e+02
  1.33542387e+03  1.33542387e+03  1.33542387e+03  2.65977221e+03
  3.02970360e+03  3.02970360e+03  3.02970360e+03  6.65023666e+03
  6.65023666e+03  6.65023666e+03  9.06510105e+03  2.54205471e+04
  7.61627002e+04]
E1 = -727.8289990715627  E_coul = 201.09242612298087
cycle= 1 E= -526.736572948582  delta_E= -0.389  |g|= 0.186  |ddm|= 0.343
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541818
diis-c [-0.2935669  1.       ]
  HOMO = -0.591152875062527  LUMO = 0.945223543510719
  mo_energy =
[-1.18637267e+02 -1.23433315e+01 -9.59620985e+00 -9.59620985e+00
 -9.59620985e+00 -1.27988882e+00 -5.91152875e-01 -5.91152875e-01
 -5.91152875e-01  9.45223544e-01  1.00799214e+00  1.00799214e+00
  1.00799214e+00  7.27375054e+00  7.27375054e+00  7.27375054e+00
  1.26283794e+01  3.33495503e+01  3.33495503e+01  3.33495503e+01
  1.07998179e+02  1.28895607e+02  1.28895607e+02  1.28895607e+02
  4.83240056e+02  4.83240056e+02  4.83240056e+02  5.90759561e+02
  1.33505925e+03  1.33505925e+03  1.33505925e+03  2.65927288e+03
  3.02927254e+03  3.02927254e+03  3.02927254e+03  6.64969221e+03
  6.64969221e+03  6.64969221e+03  9.06448124e+03  2.54198333e+04
  7.61618963e+04]
E1 = -728.4062564911582  E_coul = 201.66895464647638
cycle= 2 E= -526.737301844682  delta_E= -0.000729  |g|= 0.0378  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755817
diis-c [-0.00330976  0.08339718  0.91660282]
  HOMO = -0.581991008221198  LUMO = 0.953193233512035
  mo_energy =
[-1.18569279e+02 -1.23051010e+01 -9.55632992e+00 -9.55632992e+00
 -9.55632992e+00 -1.26891562e+00 -5.81991008e-01 -5.81991008e-01
 -5.81991008e-01  9.53193234e-01  1.01476281e+00  1.01476281e+00
  1.01476281e+00  7.29761631e+00  7.29761631e+00  7.29761631e+00
  1.26589508e+01  3.33897798e+01  3.33897798e+01  3.33897798e+01
  1.08054162e+02  1.28951745e+02  1.28951745e+02  1.28951745e+02
  4.83307227e+02  4.83307227e+02  4.83307227e+02  5.90829080e+02
  1.33513048e+03  1.33513048e+03  1.33513048e+03  2.65934742e+03
  3.02934601e+03  3.02934601e+03  3.02934601e+03  6.64976742e+03
  6.64976742e+03  6.64976742e+03  9.06455726e+03  2.54199099e+04
  7.61619732e+04]
E1 = -728.2551731993609  E_coul = 201.51781173745192
cycle= 3 E= -526.737361461909  delta_E= -5.96e-05  |g|= 0.00627  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131606
diis-c [-6.21366069e-07 -1.26642108e-03  1.43744762e-01  8.57521659e-01]
  HOMO = -0.583493933653355  LUMO = 0.95198442380002
  mo_energy =
[-1.18579219e+02 -1.23109008e+01 -9.56247863e+00 -9.56247863e+00
 -9.56247863e+00 -1.27060717e+00 -5.83493934e-01 -5.83493934e-01
 -5.83493934e-01  9.51984424e-01  1.01367726e+00  1.01367726e+00
  1.01367726e+00  7.29383754e+00  7.29383754e+00  7.29383754e+00
  1.26542869e+01  3.33836177e+01  3.33836177e+01  3.33836177e+01
  1.08045901e+02  1.28943411e+02  1.28943411e+02  1.28943411e+02
  4.83297403e+02  4.83297403e+02  4.83297403e+02  5.90818904e+02
  1.33512006e+03  1.33512006e+03  1.33512006e+03  2.65933637e+03
  3.02933521e+03  3.02933521e+03  3.02933521e+03  6.64975622e+03
  6.64975622e+03  6.64975622e+03  9.06454585e+03  2.54198983e+04
  7.61619615e+04]
E1 = -728.2779356612315  E_coul = 201.540572280613
cycle= 4 E= -526.737363380618  delta_E= -1.92e-06  |g|= 0.000102  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000120547
diis-c [-4.37557250e-09  7.65145046e-05 -1.07381643e-02 -7.03140211e-02
  1.08097567e+00]
  HOMO = -0.583476327509685  LUMO = 0.952017945323385
  mo_energy =
[-1.18579182e+02 -1.23108373e+01 -9.56242935e+00 -9.56242935e+00
 -9.56242935e+00 -1.27056581e+00 -5.83476328e-01 -5.83476328e-01
 -5.83476328e-01  9.52017945e-01  1.01369269e+00  1.01369269e+00
  1.01369269e+00  7.29387803e+00  7.29387803e+00  7.29387803e+00
  1.26543460e+01  3.33836651e+01  3.33836651e+01  3.33836651e+01
  1.08045951e+02  1.28943456e+02  1.28943456e+02  1.28943456e+02
  4.83297441e+02  4.83297441e+02  4.83297441e+02  5.90818934e+02
  1.33512009e+03  1.33512009e+03  1.33512009e+03  2.65933638e+03
  3.02933523e+03  3.02933523e+03  3.02933523e+03  6.64975623e+03
  6.64975623e+03  6.64975623e+03  9.06454585e+03  2.54198983e+04
  7.61619614e+04]
E1 = -728.2777242028592  E_coul = 201.54036082034847
cycle= 5 E= -526.737363382511  delta_E= -1.89e-09  |g|= 2.11e-05  |ddm|= 0.000167
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.96626e-05
diis-c [-8.19967023e-11  1.46754382e-05 -1.85927714e-03 -1.40683601e-02
  4.26846540e-02  9.73228308e-01]
  HOMO = -0.583484036174603  LUMO = 0.952014018532077
  mo_energy =
[-1.18579213e+02 -1.23108605e+01 -9.56245449e+00 -9.56245449e+00
 -9.56245449e+00 -1.27057192e+00 -5.83484036e-01 -5.83484036e-01
 -5.83484036e-01  9.52014019e-01  1.01368757e+00  1.01368757e+00
  1.01368757e+00  7.29386094e+00  7.29386094e+00  7.29386094e+00
  1.26543271e+01  3.33836407e+01  3.33836407e+01  3.33836407e+01
  1.08045923e+02  1.28943427e+02  1.28943427e+02  1.28943427e+02
  4.83297410e+02  4.83297410e+02  4.83297410e+02  5.90818902e+02
  1.33512006e+03  1.33512006e+03  1.33512006e+03  2.65933634e+03
  3.02933519e+03  3.02933519e+03  3.02933519e+03  6.64975619e+03
  6.64975619e+03  6.64975619e+03  9.06454581e+03  2.54198982e+04
  7.61619614e+04]
E1 = -728.2778073710604  E_coul = 201.5404439884869
cycle= 6 E= -526.737363382573  delta_E= -6.28e-11  |g|= 1.81e-06  |ddm|= 1.95e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -728.2778073710604  E_coul = 201.5404439884869
  HOMO = -0.583484045382659  LUMO = 0.952014372109315
  mo_energy =
[-1.18579213e+02 -1.23108603e+01 -9.56245436e+00 -9.56245436e+00
 -9.56245436e+00 -1.27057152e+00 -5.83484045e-01 -5.83484045e-01
 -5.83484045e-01  9.52014372e-01  1.01368762e+00  1.01368762e+00
  1.01368762e+00  7.29386103e+00  7.29386103e+00  7.29386103e+00
  1.26543273e+01  3.33836409e+01  3.33836409e+01  3.33836409e+01
  1.08045923e+02  1.28943428e+02  1.28943428e+02  1.28943428e+02
  4.83297410e+02  4.83297410e+02  4.83297410e+02  5.90818902e+02
  1.33512006e+03  1.33512006e+03  1.33512006e+03  2.65933634e+03
  3.02933519e+03  3.02933519e+03  3.02933519e+03  6.64975619e+03
  6.64975619e+03  6.64975619e+03  9.06454581e+03  2.54198982e+04
  7.61619614e+04]
E1 = -728.2778060085745  E_coul = 201.54044262600016
Extra cycle  E= -526.737363382574  delta_E= -9.09e-13  |g|= 3.75e-07  |ddm|= 3.22e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103608.3527424339
E1 = -728.2778060085745  E_coul = 201.54044262600016
init E= -526.737363382574
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583484085329422  LUMO = 0.952014413295526
  mo_energy =
[-1.18579213e+02 -1.23108604e+01 -9.56245448e+00 -9.56245448e+00
 -9.56245448e+00 -1.27057148e+00 -5.83484085e-01 -5.83484085e-01
 -5.83484085e-01  9.52014413e-01  1.01368760e+00  1.01368760e+00
  1.01368760e+00  7.29386096e+00  7.29386096e+00  7.29386096e+00
  1.26543273e+01  3.33836407e+01  3.33836407e+01  3.33836407e+01
  1.08045923e+02  1.28943428e+02  1.28943428e+02  1.28943428e+02
  4.83297410e+02  4.83297410e+02  4.83297410e+02  5.90818902e+02
  1.33512006e+03  1.33512006e+03  1.33512006e+03  2.65933634e+03
  3.02933519e+03  3.02933519e+03  3.02933519e+03  6.64975619e+03
  6.64975619e+03  6.64975619e+03  9.06454581e+03  2.54198982e+04
  7.61619614e+04]
E1 = -728.2778062558649  E_coul = 201.54044287329083
cycle= 1 E= -526.737363382574  delta_E= 2.27e-13  |g|= 8.01e-08  |ddm|= 6.28e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2778062558649  E_coul = 201.54044287329083
  HOMO = -0.583484083580082  LUMO = 0.952014430069581
  mo_energy =
[-1.18579213e+02 -1.23108603e+01 -9.56245446e+00 -9.56245446e+00
 -9.56245446e+00 -1.27057146e+00 -5.83484084e-01 -5.83484084e-01
 -5.83484084e-01  9.52014430e-01  1.01368761e+00  1.01368761e+00
  1.01368761e+00  7.29386097e+00  7.29386097e+00  7.29386097e+00
  1.26543273e+01  3.33836408e+01  3.33836408e+01  3.33836408e+01
  1.08045923e+02  1.28943428e+02  1.28943428e+02  1.28943428e+02
  4.83297410e+02  4.83297410e+02  4.83297410e+02  5.90818902e+02
  1.33512006e+03  1.33512006e+03  1.33512006e+03  2.65933634e+03
  3.02933519e+03  3.02933519e+03  3.02933519e+03  6.64975619e+03
  6.64975619e+03  6.64975619e+03  9.06454581e+03  2.54198982e+04
  7.61619614e+04]
E1 = -728.2778061580825  E_coul = 201.5404427755083
Extra cycle  E= -526.737363382574  delta_E= -1.14e-13  |g|= 1.64e-08  |ddm|= 1.35e-07
    CPU time for scf_cycle      1.06 sec, wall time      0.39 sec
exp = [2.61826567e+04 7.61752008e+03 3.61735178e+03 1.59778787e+03
 3.82826576e+02 1.08639456e+02 3.57570728e+01 8.32949530e+00
 3.22648755e+00 6.47074987e-01 2.36370266e-01 1.36278349e+03
 6.64742858e+02 3.00948679e+02 3.14030796e+02 6.16297049e+01
 7.29554851e+00 2.02567014e+01 7.76432901e-01 2.82564364e+00
 2.22407416e-01]
grad_E = [-1.51200754e-06  3.24571339e-06 -1.61444848e-06  6.67575882e-05
  6.76820314e-05 -1.42563217e-03  2.77673590e-05  1.05499480e-03
 -2.16167147e-03 -1.03905349e-03 -1.37174312e-03 -4.82929289e-07
  5.32739499e-06  2.55689182e-05  2.20378651e-05 -2.50610654e-04
 -7.02510680e-03  2.10858356e-03  5.69849157e-03  7.96035732e-03
 -1.63614182e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6570974        1
[INPUT] 0    0    [1    /1   ]  7617.51925467        1
[INPUT] 0    0    [1    /1   ]  3617.35219599        1
[INPUT] 0    0    [1    /1   ]  1597.7710184         1
[INPUT] 0    0    [1    /1   ]  382.801239487        1
[INPUT] 0    0    [1    /1   ]  109.002076033        1
[INPUT] 0    0    [1    /1   ]  35.8842241942        1
[INPUT] 0    0    [1    /1   ]  8.5410601873         1
[INPUT] 0    0    [1    /1   ]  3.28182921108        1
[INPUT] 0    0    [1    /1   ]  0.648726210391       1
[INPUT] 0    0    [1    /1   ]  0.237845882221       1
[INPUT] 1    0    [1    /1   ]  1362.78362333        1
[INPUT] 1    0    [1    /1   ]  664.741569958        1
[INPUT] 1    0    [1    /1   ]  300.942610265        1
[INPUT] 1    0    [1    /1   ]  314.025563521        1
[INPUT] 1    0    [1    /1   ]  61.6320761328        1
[INPUT] 1    0    [1    /1   ]  7.27917564345        1
[INPUT] 1    0    [1    /1   ]  20.2706776869        1
[INPUT] 1    0    [1    /1   ]  0.775035239443       1
[INPUT] 1    0    [1    /1   ]  2.80848284212        1
[INPUT] 1    0    [1    /1   ]  0.221999833854       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657097389423, 1.0]], [0, [7617.5192546680855, 1.0]], [0, [3617.352195990136, 1.0]], [0, [1597.7710183993825, 1.0]], [0, [382.8012394872188, 1.0]], [0, [109.00207603291233, 1.0]], [0, [35.88422419416114, 1.0]], [0, [8.541060187304165, 1.0]], [0, [3.2818292110755007, 1.0]], [0, [0.6487262103911776, 1.0]], [0, [0.23784588222078276, 1.0]], [1, [1362.783623325023, 1.0]], [1, [664.7415699576138, 1.0]], [1, [300.94261026500203, 1.0]], [1, [314.025563520581, 1.0]], [1, [61.63207613279771, 1.0]], [1, [7.279175643448755, 1.0]], [1, [20.270677686857574, 1.0]], [1, [0.7750352394431302, 1.0]], [1, [2.808482842120446, 1.0]], [1, [0.22199983385409233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65709739]
bas 1, expnt(s) = [7617.51925467]
bas 2, expnt(s) = [3617.35219599]
bas 3, expnt(s) = [1597.7710184]
bas 4, expnt(s) = [382.80123949]
bas 5, expnt(s) = [109.00207603]
bas 6, expnt(s) = [35.88422419]
bas 7, expnt(s) = [8.54106019]
bas 8, expnt(s) = [3.28182921]
bas 9, expnt(s) = [0.64872621]
bas 10, expnt(s) = [0.23784588]
bas 11, expnt(s) = [1362.78362333]
bas 12, expnt(s) = [664.74156996]
bas 13, expnt(s) = [300.94261027]
bas 14, expnt(s) = [314.02556352]
bas 15, expnt(s) = [61.63207613]
bas 16, expnt(s) = [7.27917564]
bas 17, expnt(s) = [20.27067769]
bas 18, expnt(s) = [0.77503524]
bas 19, expnt(s) = [2.80848284]
bas 20, expnt(s) = [0.22199983]
CPU time:       180.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826571e+04 5.20026305e+03 7.61751925e+03 2.06003783e+03
 3.61735220e+03 1.17844175e+03 1.59777102e+03 6.38485338e+02
 3.82801239e+02 2.18647757e+02 1.09002076e+02 8.52297278e+01
 3.58842242e+01 3.70418523e+01 8.54106019e+00 1.26226012e+01
 3.28182921e+00 6.16030204e+00 6.48726210e-01 1.82625370e+00
 2.37845882e-01 8.60472018e-01 1.36278362e+03 2.41556109e+04
 6.64741570e+02 9.84692070e+03 3.00942610e+02 3.65669718e+03
 3.14025564e+02 3.85647613e+03 6.16320761e+01 5.03782282e+02
 7.27917564e+00 3.48808565e+01 2.02706777e+01 1.25478618e+02
 7.75035239e-01 2.12146663e+00 2.80848284e+00 1.06065492e+01
 2.21999834e-01 4.44554698e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993693964798553
cond(S) = 103686.88313749674
E1 = -729.5273827539751  E_coul = 203.17874970175205
init E= -526.348633052223
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555845688242378  LUMO = 0.982614153064205
  mo_energy =
[-1.18328072e+02 -1.22046360e+01 -9.44672372e+00 -9.44672372e+00
 -9.44672372e+00 -1.24004188e+00 -5.55845688e-01 -5.55845688e-01
 -5.55845688e-01  9.82614153e-01  1.02977023e+00  1.02977023e+00
  1.02977023e+00  7.32446886e+00  7.32446886e+00  7.32446886e+00
  1.31337012e+01  3.34076406e+01  3.34076406e+01  3.34076406e+01
  1.09699617e+02  1.29046484e+02  1.29046484e+02  1.29046484e+02
  4.83498948e+02  4.83498948e+02  4.83498948e+02  5.93520417e+02
  1.33537325e+03  1.33537325e+03  1.33537325e+03  2.66237613e+03
  3.02964111e+03  3.02964111e+03  3.02964111e+03  6.65016694e+03
  6.65016694e+03  6.65016694e+03  9.06755006e+03  2.54228616e+04
  7.61648524e+04]
E1 = -727.8281505301642  E_coul = 201.0912735737265
cycle= 1 E= -526.736876956438  delta_E= -0.388  |g|= 0.186  |ddm|= 0.345
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541904
diis-c [-0.29365979  1.        ]
  HOMO = -0.591260539170559  LUMO = 0.954405919078432
  mo_energy =
[-1.18637418e+02 -1.23432901e+01 -9.59626969e+00 -9.59626969e+00
 -9.59626969e+00 -1.28000609e+00 -5.91260539e-01 -5.91260539e-01
 -5.91260539e-01  9.54405919e-01  1.00510886e+00  1.00510886e+00
  1.00510886e+00  7.23311861e+00  7.23311861e+00  7.23311861e+00
  1.30206639e+01  3.32525783e+01  3.32525783e+01  3.32525783e+01
  1.09477396e+02  1.28816757e+02  1.28816757e+02  1.28816757e+02
  4.83190784e+02  4.83190784e+02  4.83190784e+02  5.93174402e+02
  1.33500869e+03  1.33500869e+03  1.33500869e+03  2.66187709e+03
  3.02921024e+03  3.02921024e+03  3.02921024e+03  6.64962276e+03
  6.64962276e+03  6.64962276e+03  9.06693060e+03  2.54221482e+04
  7.61640488e+04]
E1 = -728.4060811319957  E_coul = 201.6684747684637
cycle= 2 E= -526.737606363532  delta_E= -0.000729  |g|= 0.0379  |ddm|= 0.0541
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755775
diis-c [-0.00332061  0.08320362  0.91679638]
  HOMO = -0.582078800665604  LUMO = 0.962467214328287
  mo_energy =
[-1.18569367e+02 -1.23050046e+01 -9.55633501e+00 -9.55633501e+00
 -9.55633501e+00 -1.26900968e+00 -5.82078801e-01 -5.82078801e-01
 -5.82078801e-01  9.62467214e-01  1.01187262e+00  1.01187262e+00
  1.01187262e+00  7.25695690e+00  7.25695690e+00  7.25695690e+00
  1.30516727e+01  3.32928556e+01  3.32928556e+01  3.32928556e+01
  1.09533507e+02  1.28872960e+02  1.28872960e+02  1.28872960e+02
  4.83258018e+02  4.83258018e+02  4.83258018e+02  5.93243983e+02
  1.33507998e+03  1.33507998e+03  1.33507998e+03  2.66195169e+03
  3.02928377e+03  3.02928377e+03  3.02928377e+03  6.64969804e+03
  6.64969804e+03  6.64969804e+03  9.06700669e+03  2.54222248e+04
  7.61641258e+04]
E1 = -728.2546808944746  E_coul = 201.51701475900373
cycle= 3 E= -526.737666135471  delta_E= -5.98e-05  |g|= 0.00629  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013191
diis-c [-6.15166582e-07 -1.26335385e-03  1.44071646e-01  8.57191708e-01]
  HOMO = -0.583587619411819  LUMO = 0.961240673490075
  mo_energy =
[-1.18579339e+02 -1.23108250e+01 -9.56250413e+00 -9.56250413e+00
 -9.56250413e+00 -1.27070939e+00 -5.83587619e-01 -5.83587619e-01
 -5.83587619e-01  9.61240673e-01  1.01078597e+00  1.01078597e+00
  1.01078597e+00  7.25317492e+00  7.25317492e+00  7.25317492e+00
  1.30469342e+01  3.32866735e+01  3.32866735e+01  3.32866735e+01
  1.09525208e+02  1.28864598e+02  1.28864598e+02  1.28864598e+02
  4.83248162e+02  4.83248162e+02  4.83248162e+02  5.93233775e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66194061e+03
  3.02927294e+03  3.02927294e+03  3.02927294e+03  6.64968681e+03
  6.64968681e+03  6.64968681e+03  9.06699525e+03  2.54222132e+04
  7.61641140e+04]
E1 = -728.2775425971031  E_coul = 201.5398745282507
cycle= 4 E= -526.737668068852  delta_E= -1.93e-06  |g|= 0.000101  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119211
diis-c [-4.34447928e-09  7.52353100e-05 -1.05951101e-02 -6.92038403e-02
  1.07972372e+00]
  HOMO = -0.583569911436107  LUMO = 0.961274256533597
  mo_energy =
[-1.18579301e+02 -1.23107614e+01 -9.56245455e+00 -9.56245455e+00
 -9.56245455e+00 -1.27066821e+00 -5.83569911e-01 -5.83569911e-01
 -5.83569911e-01  9.61274257e-01  1.01080140e+00  1.01080140e+00
  1.01080140e+00  7.25321551e+00  7.25321551e+00  7.25321551e+00
  1.30469936e+01  3.32867210e+01  3.32867210e+01  3.32867210e+01
  1.09525258e+02  1.28864644e+02  1.28864644e+02  1.28864644e+02
  4.83248200e+02  4.83248200e+02  4.83248200e+02  5.93233805e+02
  1.33506956e+03  1.33506956e+03  1.33506956e+03  2.66194062e+03
  3.02927296e+03  3.02927296e+03  3.02927296e+03  6.64968682e+03
  6.64968682e+03  6.64968682e+03  9.06699525e+03  2.54222132e+04
  7.61641140e+04]
E1 = -728.2773311008887  E_coul = 201.539663030194
cycle= 5 E= -526.737668070695  delta_E= -1.84e-09  |g|= 2.1e-05  |ddm|= 0.000166
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.95374e-05
diis-c [-8.04104681e-11  1.46125178e-05 -1.86081664e-03 -1.40307088e-02
  4.26917085e-02  9.73185204e-01]
  HOMO = -0.583577569093564  LUMO = 0.961270309524554
  mo_energy =
[-1.18579332e+02 -1.23107844e+01 -9.56247955e+00 -9.56247955e+00
 -9.56247955e+00 -1.27067428e+00 -5.83577569e-01 -5.83577569e-01
 -5.83577569e-01  9.61270310e-01  1.01079633e+00  1.01079633e+00
  1.01079633e+00  7.25319856e+00  7.25319856e+00  7.25319856e+00
  1.30469746e+01  3.32866968e+01  3.32866968e+01  3.32866968e+01
  1.09525230e+02  1.28864616e+02  1.28864616e+02  1.28864616e+02
  4.83248169e+02  4.83248169e+02  4.83248169e+02  5.93233773e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66194058e+03
  3.02927293e+03  3.02927293e+03  3.02927293e+03  6.64968678e+03
  6.64968678e+03  6.64968678e+03  9.06699521e+03  2.54222131e+04
  7.61641140e+04]
E1 = -728.2774140599973  E_coul = 201.53974598924205
cycle= 6 E= -526.737668070755  delta_E= -6.06e-11  |g|= 1.8e-06  |ddm|= 1.93e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2774140599973  E_coul = 201.53974598924205
  HOMO = -0.583577579617545  LUMO = 0.961270662299249
  mo_energy =
[-1.18579332e+02 -1.23107842e+01 -9.56247943e+00 -9.56247943e+00
 -9.56247943e+00 -1.27067389e+00 -5.83577580e-01 -5.83577580e-01
 -5.83577580e-01  9.61270662e-01  1.01079638e+00  1.01079638e+00
  1.01079638e+00  7.25319864e+00  7.25319864e+00  7.25319864e+00
  1.30469748e+01  3.32866969e+01  3.32866969e+01  3.32866969e+01
  1.09525230e+02  1.28864616e+02  1.28864616e+02  1.28864616e+02
  4.83248169e+02  4.83248169e+02  4.83248169e+02  5.93233774e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66194058e+03
  3.02927293e+03  3.02927293e+03  3.02927293e+03  6.64968678e+03
  6.64968678e+03  6.64968678e+03  9.06699521e+03  2.54222131e+04
  7.61641140e+04]
E1 = -728.2774127738631  E_coul = 201.53974470310735
Extra cycle  E= -526.737668070756  delta_E= -5.68e-13  |g|= 3.73e-07  |ddm|= 3.2e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826571e+04 7.61751925e+03 3.61735220e+03 1.59777102e+03
 3.82801239e+02 1.09002076e+02 3.58842242e+01 8.54106019e+00
 3.28182921e+00 6.48726210e-01 2.37845882e-01 1.36278362e+03
 6.64741570e+02 3.00942610e+02 3.14025564e+02 6.16320761e+01
 7.27917564e+00 2.02706777e+01 7.75035239e-01 2.80848284e+00
 2.21999834e-01]
E = -526.7376680707558
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6570974        1
[INPUT] 0    0    [1    /1   ]  7617.51925467        1
[INPUT] 0    0    [1    /1   ]  3617.35219599        1
[INPUT] 0    0    [1    /1   ]  1597.7710184         1
[INPUT] 0    0    [1    /1   ]  382.801239487        1
[INPUT] 0    0    [1    /1   ]  109.002076033        1
[INPUT] 0    0    [1    /1   ]  35.8842241942        1
[INPUT] 0    0    [1    /1   ]  8.5410601873         1
[INPUT] 0    0    [1    /1   ]  3.28182921108        1
[INPUT] 0    0    [1    /1   ]  0.648726210391       1
[INPUT] 0    0    [1    /1   ]  0.237845882221       1
[INPUT] 1    0    [1    /1   ]  1362.78362333        1
[INPUT] 1    0    [1    /1   ]  664.741569958        1
[INPUT] 1    0    [1    /1   ]  300.942610265        1
[INPUT] 1    0    [1    /1   ]  314.025563521        1
[INPUT] 1    0    [1    /1   ]  61.6320761328        1
[INPUT] 1    0    [1    /1   ]  7.27917564345        1
[INPUT] 1    0    [1    /1   ]  20.2706776869        1
[INPUT] 1    0    [1    /1   ]  0.775035239443       1
[INPUT] 1    0    [1    /1   ]  2.80848284212        1
[INPUT] 1    0    [1    /1   ]  0.221999833854       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657097389423, 1.0]], [0, [7617.5192546680855, 1.0]], [0, [3617.352195990136, 1.0]], [0, [1597.7710183993825, 1.0]], [0, [382.8012394872188, 1.0]], [0, [109.00207603291233, 1.0]], [0, [35.88422419416114, 1.0]], [0, [8.541060187304165, 1.0]], [0, [3.2818292110755007, 1.0]], [0, [0.6487262103911776, 1.0]], [0, [0.23784588222078276, 1.0]], [1, [1362.783623325023, 1.0]], [1, [664.7415699576138, 1.0]], [1, [300.94261026500203, 1.0]], [1, [314.025563520581, 1.0]], [1, [61.63207613279771, 1.0]], [1, [7.279175643448755, 1.0]], [1, [20.270677686857574, 1.0]], [1, [0.7750352394431302, 1.0]], [1, [2.808482842120446, 1.0]], [1, [0.22199983385409233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65709739]
bas 1, expnt(s) = [7617.51925467]
bas 2, expnt(s) = [3617.35219599]
bas 3, expnt(s) = [1597.7710184]
bas 4, expnt(s) = [382.80123949]
bas 5, expnt(s) = [109.00207603]
bas 6, expnt(s) = [35.88422419]
bas 7, expnt(s) = [8.54106019]
bas 8, expnt(s) = [3.28182921]
bas 9, expnt(s) = [0.64872621]
bas 10, expnt(s) = [0.23784588]
bas 11, expnt(s) = [1362.78362333]
bas 12, expnt(s) = [664.74156996]
bas 13, expnt(s) = [300.94261027]
bas 14, expnt(s) = [314.02556352]
bas 15, expnt(s) = [61.63207613]
bas 16, expnt(s) = [7.27917564]
bas 17, expnt(s) = [20.27067769]
bas 18, expnt(s) = [0.77503524]
bas 19, expnt(s) = [2.80848284]
bas 20, expnt(s) = [0.22199983]
CPU time:       180.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826571e+04 5.20026305e+03 7.61751925e+03 2.06003783e+03
 3.61735220e+03 1.17844175e+03 1.59777102e+03 6.38485338e+02
 3.82801239e+02 2.18647757e+02 1.09002076e+02 8.52297278e+01
 3.58842242e+01 3.70418523e+01 8.54106019e+00 1.26226012e+01
 3.28182921e+00 6.16030204e+00 6.48726210e-01 1.82625370e+00
 2.37845882e-01 8.60472018e-01 1.36278362e+03 2.41556109e+04
 6.64741570e+02 9.84692070e+03 3.00942610e+02 3.65669718e+03
 3.14025564e+02 3.85647613e+03 6.16320761e+01 5.03782282e+02
 7.27917564e+00 3.48808565e+01 2.02706777e+01 1.25478618e+02
 7.75035239e-01 2.12146663e+00 2.80848284e+00 1.06065492e+01
 2.21999834e-01 4.44554698e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993693964798553
cond(S) = 103686.88313749674
E1 = -729.5273827539751  E_coul = 203.17874970175205
init E= -526.348633052223
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555845688242378  LUMO = 0.982614153064205
  mo_energy =
[-1.18328072e+02 -1.22046360e+01 -9.44672372e+00 -9.44672372e+00
 -9.44672372e+00 -1.24004188e+00 -5.55845688e-01 -5.55845688e-01
 -5.55845688e-01  9.82614153e-01  1.02977023e+00  1.02977023e+00
  1.02977023e+00  7.32446886e+00  7.32446886e+00  7.32446886e+00
  1.31337012e+01  3.34076406e+01  3.34076406e+01  3.34076406e+01
  1.09699617e+02  1.29046484e+02  1.29046484e+02  1.29046484e+02
  4.83498948e+02  4.83498948e+02  4.83498948e+02  5.93520417e+02
  1.33537325e+03  1.33537325e+03  1.33537325e+03  2.66237613e+03
  3.02964111e+03  3.02964111e+03  3.02964111e+03  6.65016694e+03
  6.65016694e+03  6.65016694e+03  9.06755006e+03  2.54228616e+04
  7.61648524e+04]
E1 = -727.8281505301642  E_coul = 201.0912735737265
cycle= 1 E= -526.736876956438  delta_E= -0.388  |g|= 0.186  |ddm|= 0.345
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541904
diis-c [-0.29365979  1.        ]
  HOMO = -0.591260539170559  LUMO = 0.954405919078432
  mo_energy =
[-1.18637418e+02 -1.23432901e+01 -9.59626969e+00 -9.59626969e+00
 -9.59626969e+00 -1.28000609e+00 -5.91260539e-01 -5.91260539e-01
 -5.91260539e-01  9.54405919e-01  1.00510886e+00  1.00510886e+00
  1.00510886e+00  7.23311861e+00  7.23311861e+00  7.23311861e+00
  1.30206639e+01  3.32525783e+01  3.32525783e+01  3.32525783e+01
  1.09477396e+02  1.28816757e+02  1.28816757e+02  1.28816757e+02
  4.83190784e+02  4.83190784e+02  4.83190784e+02  5.93174402e+02
  1.33500869e+03  1.33500869e+03  1.33500869e+03  2.66187709e+03
  3.02921024e+03  3.02921024e+03  3.02921024e+03  6.64962276e+03
  6.64962276e+03  6.64962276e+03  9.06693060e+03  2.54221482e+04
  7.61640488e+04]
E1 = -728.4060811319957  E_coul = 201.6684747684637
cycle= 2 E= -526.737606363532  delta_E= -0.000729  |g|= 0.0379  |ddm|= 0.0541
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755775
diis-c [-0.00332061  0.08320362  0.91679638]
  HOMO = -0.582078800665604  LUMO = 0.962467214328287
  mo_energy =
[-1.18569367e+02 -1.23050046e+01 -9.55633501e+00 -9.55633501e+00
 -9.55633501e+00 -1.26900968e+00 -5.82078801e-01 -5.82078801e-01
 -5.82078801e-01  9.62467214e-01  1.01187262e+00  1.01187262e+00
  1.01187262e+00  7.25695690e+00  7.25695690e+00  7.25695690e+00
  1.30516727e+01  3.32928556e+01  3.32928556e+01  3.32928556e+01
  1.09533507e+02  1.28872960e+02  1.28872960e+02  1.28872960e+02
  4.83258018e+02  4.83258018e+02  4.83258018e+02  5.93243983e+02
  1.33507998e+03  1.33507998e+03  1.33507998e+03  2.66195169e+03
  3.02928377e+03  3.02928377e+03  3.02928377e+03  6.64969804e+03
  6.64969804e+03  6.64969804e+03  9.06700669e+03  2.54222248e+04
  7.61641258e+04]
E1 = -728.2546808944746  E_coul = 201.51701475900373
cycle= 3 E= -526.737666135471  delta_E= -5.98e-05  |g|= 0.00629  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013191
diis-c [-6.15166582e-07 -1.26335385e-03  1.44071646e-01  8.57191708e-01]
  HOMO = -0.583587619411819  LUMO = 0.961240673490075
  mo_energy =
[-1.18579339e+02 -1.23108250e+01 -9.56250413e+00 -9.56250413e+00
 -9.56250413e+00 -1.27070939e+00 -5.83587619e-01 -5.83587619e-01
 -5.83587619e-01  9.61240673e-01  1.01078597e+00  1.01078597e+00
  1.01078597e+00  7.25317492e+00  7.25317492e+00  7.25317492e+00
  1.30469342e+01  3.32866735e+01  3.32866735e+01  3.32866735e+01
  1.09525208e+02  1.28864598e+02  1.28864598e+02  1.28864598e+02
  4.83248162e+02  4.83248162e+02  4.83248162e+02  5.93233775e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66194061e+03
  3.02927294e+03  3.02927294e+03  3.02927294e+03  6.64968681e+03
  6.64968681e+03  6.64968681e+03  9.06699525e+03  2.54222132e+04
  7.61641140e+04]
E1 = -728.2775425971031  E_coul = 201.5398745282507
cycle= 4 E= -526.737668068852  delta_E= -1.93e-06  |g|= 0.000101  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119211
diis-c [-4.34447928e-09  7.52353100e-05 -1.05951101e-02 -6.92038403e-02
  1.07972372e+00]
  HOMO = -0.583569911436107  LUMO = 0.961274256533597
  mo_energy =
[-1.18579301e+02 -1.23107614e+01 -9.56245455e+00 -9.56245455e+00
 -9.56245455e+00 -1.27066821e+00 -5.83569911e-01 -5.83569911e-01
 -5.83569911e-01  9.61274257e-01  1.01080140e+00  1.01080140e+00
  1.01080140e+00  7.25321551e+00  7.25321551e+00  7.25321551e+00
  1.30469936e+01  3.32867210e+01  3.32867210e+01  3.32867210e+01
  1.09525258e+02  1.28864644e+02  1.28864644e+02  1.28864644e+02
  4.83248200e+02  4.83248200e+02  4.83248200e+02  5.93233805e+02
  1.33506956e+03  1.33506956e+03  1.33506956e+03  2.66194062e+03
  3.02927296e+03  3.02927296e+03  3.02927296e+03  6.64968682e+03
  6.64968682e+03  6.64968682e+03  9.06699525e+03  2.54222132e+04
  7.61641140e+04]
E1 = -728.2773311008887  E_coul = 201.539663030194
cycle= 5 E= -526.737668070695  delta_E= -1.84e-09  |g|= 2.1e-05  |ddm|= 0.000166
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.95374e-05
diis-c [-8.04104681e-11  1.46125178e-05 -1.86081664e-03 -1.40307088e-02
  4.26917085e-02  9.73185204e-01]
  HOMO = -0.583577569093564  LUMO = 0.961270309524554
  mo_energy =
[-1.18579332e+02 -1.23107844e+01 -9.56247955e+00 -9.56247955e+00
 -9.56247955e+00 -1.27067428e+00 -5.83577569e-01 -5.83577569e-01
 -5.83577569e-01  9.61270310e-01  1.01079633e+00  1.01079633e+00
  1.01079633e+00  7.25319856e+00  7.25319856e+00  7.25319856e+00
  1.30469746e+01  3.32866968e+01  3.32866968e+01  3.32866968e+01
  1.09525230e+02  1.28864616e+02  1.28864616e+02  1.28864616e+02
  4.83248169e+02  4.83248169e+02  4.83248169e+02  5.93233773e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66194058e+03
  3.02927293e+03  3.02927293e+03  3.02927293e+03  6.64968678e+03
  6.64968678e+03  6.64968678e+03  9.06699521e+03  2.54222131e+04
  7.61641140e+04]
E1 = -728.2774140599973  E_coul = 201.53974598924205
cycle= 6 E= -526.737668070755  delta_E= -6.06e-11  |g|= 1.8e-06  |ddm|= 1.93e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2774140599973  E_coul = 201.53974598924205
  HOMO = -0.583577579617545  LUMO = 0.961270662299249
  mo_energy =
[-1.18579332e+02 -1.23107842e+01 -9.56247943e+00 -9.56247943e+00
 -9.56247943e+00 -1.27067389e+00 -5.83577580e-01 -5.83577580e-01
 -5.83577580e-01  9.61270662e-01  1.01079638e+00  1.01079638e+00
  1.01079638e+00  7.25319864e+00  7.25319864e+00  7.25319864e+00
  1.30469748e+01  3.32866969e+01  3.32866969e+01  3.32866969e+01
  1.09525230e+02  1.28864616e+02  1.28864616e+02  1.28864616e+02
  4.83248169e+02  4.83248169e+02  4.83248169e+02  5.93233774e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66194058e+03
  3.02927293e+03  3.02927293e+03  3.02927293e+03  6.64968678e+03
  6.64968678e+03  6.64968678e+03  9.06699521e+03  2.54222131e+04
  7.61641140e+04]
E1 = -728.2774127738631  E_coul = 201.53974470310735
Extra cycle  E= -526.737668070756  delta_E= -5.68e-13  |g|= 3.73e-07  |ddm|= 3.2e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103686.88313749674
E1 = -728.2774127738631  E_coul = 201.53974470310735
init E= -526.737668070756
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583577617702156  LUMO = 0.961270704769842
  mo_energy =
[-1.18579332e+02 -1.23107843e+01 -9.56247954e+00 -9.56247954e+00
 -9.56247954e+00 -1.27067385e+00 -5.83577618e-01 -5.83577618e-01
 -5.83577618e-01  9.61270705e-01  1.01079637e+00  1.01079637e+00
  1.01079637e+00  7.25319857e+00  7.25319857e+00  7.25319857e+00
  1.30469748e+01  3.32866968e+01  3.32866968e+01  3.32866968e+01
  1.09525230e+02  1.28864616e+02  1.28864616e+02  1.28864616e+02
  4.83248169e+02  4.83248169e+02  4.83248169e+02  5.93233774e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66194058e+03
  3.02927293e+03  3.02927293e+03  3.02927293e+03  6.64968678e+03
  6.64968678e+03  6.64968678e+03  9.06699521e+03  2.54222131e+04
  7.61641140e+04]
E1 = -728.2774130053436  E_coul = 201.53974493458685
cycle= 1 E= -526.737668070757  delta_E= -1.02e-12  |g|= 7.93e-08  |ddm|= 6.24e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2774130053436  E_coul = 201.53974493458685
  HOMO = -0.583577616163695  LUMO = 0.961270721369781
  mo_energy =
[-1.18579332e+02 -1.23107843e+01 -9.56247953e+00 -9.56247953e+00
 -9.56247953e+00 -1.27067383e+00 -5.83577616e-01 -5.83577616e-01
 -5.83577616e-01  9.61270721e-01  1.01079637e+00  1.01079637e+00
  1.01079637e+00  7.25319858e+00  7.25319858e+00  7.25319858e+00
  1.30469748e+01  3.32866968e+01  3.32866968e+01  3.32866968e+01
  1.09525230e+02  1.28864616e+02  1.28864616e+02  1.28864616e+02
  4.83248169e+02  4.83248169e+02  4.83248169e+02  5.93233774e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66194058e+03
  3.02927293e+03  3.02927293e+03  3.02927293e+03  6.64968678e+03
  6.64968678e+03  6.64968678e+03  9.06699521e+03  2.54222131e+04
  7.61641140e+04]
E1 = -728.2774129130789  E_coul = 201.53974484232242
Extra cycle  E= -526.737668070757  delta_E= 3.41e-13  |g|= 1.62e-08  |ddm|= 1.34e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826571e+04 7.61751925e+03 3.61735220e+03 1.59777102e+03
 3.82801239e+02 1.09002076e+02 3.58842242e+01 8.54106019e+00
 3.28182921e+00 6.48726210e-01 2.37845882e-01 1.36278362e+03
 6.64741570e+02 3.00942610e+02 3.14025564e+02 6.16320761e+01
 7.27917564e+00 2.02706777e+01 7.75035239e-01 2.80848284e+00
 2.21999834e-01]
grad_E = [-1.51693629e-06  3.29897323e-06 -1.58776458e-06  6.87805934e-05
  1.35967190e-05 -1.18563527e-03 -1.97287468e-04  1.70190747e-03
 -2.38255634e-03 -4.53249967e-04 -2.39752237e-03 -4.77096164e-07
  5.40345823e-06  2.60298534e-05  2.24340547e-05 -2.99087329e-04
 -7.30473967e-03  2.42316635e-03  6.51056884e-03  7.06805731e-03
 -1.89442936e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6574749        1
[INPUT] 0    0    [1    /1   ]  7617.51845196        1
[INPUT] 0    0    [1    /1   ]  3617.35260426        1
[INPUT] 0    0    [1    /1   ]  1597.75466893        1
[INPUT] 0    0    [1    /1   ]  382.775955925        1
[INPUT] 0    0    [1    /1   ]  109.361079274        1
[INPUT] 0    0    [1    /1   ]  35.9894853758        1
[INPUT] 0    0    [1    /1   ]  8.7319155559         1
[INPUT] 0    0    [1    /1   ]  3.33556778527        1
[INPUT] 0    0    [1    /1   ]  0.65465564509        1
[INPUT] 0    0    [1    /1   ]  0.241409058141       1
[INPUT] 1    0    [1    /1   ]  1362.78375035        1
[INPUT] 1    0    [1    /1   ]  664.740319084        1
[INPUT] 1    0    [1    /1   ]  300.936713894        1
[INPUT] 1    0    [1    /1   ]  314.020479711        1
[INPUT] 1    0    [1    /1   ]  61.6347164772        1
[INPUT] 1    0    [1    /1   ]  7.27247655173        1
[INPUT] 1    0    [1    /1   ]  20.2812849709        1
[INPUT] 1    0    [1    /1   ]  0.77265347303        1
[INPUT] 1    0    [1    /1   ]  2.78219927878        1
[INPUT] 1    0    [1    /1   ]  0.221617735863       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65747490816, 1.0]], [0, [7617.518451963469, 1.0]], [0, [3617.352604263669, 1.0]], [0, [1597.7546689318845, 1.0]], [0, [382.77595592543315, 1.0]], [0, [109.36107927437178, 1.0]], [0, [35.98948537575374, 1.0]], [0, [8.731915555902773, 1.0]], [0, [3.33556778527203, 1.0]], [0, [0.6546556450903999, 1.0]], [0, [0.2414090581406432, 1.0]], [1, [1362.783750351404, 1.0]], [1, [664.7403190835645, 1.0]], [1, [300.9367138944979, 1.0]], [1, [314.0204797108921, 1.0]], [1, [61.63471647721986, 1.0]], [1, [7.272476551725735, 1.0]], [1, [20.281284970895662, 1.0]], [1, [0.7726534730301619, 1.0]], [1, [2.782199278781879, 1.0]], [1, [0.22161773586290154, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65747491]
bas 1, expnt(s) = [7617.51845196]
bas 2, expnt(s) = [3617.35260426]
bas 3, expnt(s) = [1597.75466893]
bas 4, expnt(s) = [382.77595593]
bas 5, expnt(s) = [109.36107927]
bas 6, expnt(s) = [35.98948538]
bas 7, expnt(s) = [8.73191556]
bas 8, expnt(s) = [3.33556779]
bas 9, expnt(s) = [0.65465565]
bas 10, expnt(s) = [0.24140906]
bas 11, expnt(s) = [1362.78375035]
bas 12, expnt(s) = [664.74031908]
bas 13, expnt(s) = [300.93671389]
bas 14, expnt(s) = [314.02047971]
bas 15, expnt(s) = [61.63471648]
bas 16, expnt(s) = [7.27247655]
bas 17, expnt(s) = [20.28128497]
bas 18, expnt(s) = [0.77265347]
bas 19, expnt(s) = [2.78219928]
bas 20, expnt(s) = [0.22161774]
CPU time:       186.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026311e+03 7.61751845e+03 2.06003766e+03
 3.61735260e+03 1.17844185e+03 1.59775467e+03 6.38480438e+02
 3.82775956e+02 2.18636925e+02 1.09361079e+02 8.54401722e+01
 3.59894854e+01 3.71233151e+01 8.73191556e+00 1.28335607e+01
 3.33556779e+00 6.23580251e+00 6.54655645e-01 1.83875858e+00
 2.41409058e-01 8.70122092e-01 1.36278375e+03 2.41556137e+04
 6.64740319e+02 9.84689754e+03 3.00936714e+02 3.65660762e+03
 3.14020480e+02 3.85639808e+03 6.16347165e+01 5.03809260e+02
 7.27247655e+00 3.48407347e+01 2.02812850e+01 1.25560700e+02
 7.72653473e-01 2.11332039e+00 2.78219928e+00 1.04826162e+01
 2.21617736e-01 4.43598465e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993721086112647
cond(S) = 103772.05425498795
E1 = -729.5292912811518  E_coul = 203.17924732878083
init E= -526.350043952371
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555850038808118  LUMO = 1.00496658706121
  mo_energy =
[-1.18328335e+02 -1.22043953e+01 -9.44668086e+00 -9.44668086e+00
 -9.44668086e+00 -1.24001523e+00 -5.55850039e-01 -5.55850039e-01
 -5.55850039e-01  1.00496659e+00  1.02603091e+00  1.02603091e+00
  1.02603091e+00  7.26762995e+00  7.26762995e+00  7.26762995e+00
  1.35352049e+01  3.32954655e+01  3.32954655e+01  3.32954655e+01
  1.11071151e+02  1.28959263e+02  1.28959263e+02  1.28959263e+02
  4.83442733e+02  4.83442733e+02  4.83442733e+02  5.95779282e+02
  1.33531691e+03  1.33531691e+03  1.33531691e+03  2.66483095e+03
  3.02957383e+03  3.02957383e+03  3.02957383e+03  6.65009323e+03
  6.65009323e+03  6.65009323e+03  9.06986134e+03  2.54250461e+04
  7.61668835e+04]
E1 = -727.8318886248029  E_coul = 201.0947532800551
cycle= 1 E= -526.737135344748  delta_E= -0.387  |g|= 0.186  |ddm|= 0.332
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541662
diis-c [-0.29339781  1.        ]
  HOMO = -0.591160336268041  LUMO = 0.976242468087675
  mo_energy =
[-1.18637279e+02 -1.23429361e+01 -9.59602536e+00 -9.59602536e+00
 -9.59602536e+00 -1.27992033e+00 -5.91160336e-01 -5.91160336e-01
 -5.91160336e-01  9.76242468e-01  1.00156095e+00  1.00156095e+00
  1.00156095e+00  7.17674843e+00  7.17674843e+00  7.17674843e+00
  1.34208945e+01  3.31405763e+01  3.31405763e+01  3.31405763e+01
  1.10848781e+02  1.28729785e+02  1.28729785e+02  1.28729785e+02
  4.83134911e+02  4.83134911e+02  4.83134911e+02  5.95433544e+02
  1.33495267e+03  1.33495267e+03  1.33495267e+03  2.66433245e+03
  3.02914340e+03  3.02914340e+03  3.02914340e+03  6.64954957e+03
  6.64954957e+03  6.64954957e+03  9.06924248e+03  2.54243332e+04
  7.61660805e+04]
E1 = -728.4091750545631  E_coul = 201.67131314666582
cycle= 2 E= -526.737861907897  delta_E= -0.000727  |g|= 0.0378  |ddm|= 0.0542
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0754114
diis-c [-0.0033214   0.08282402  0.91717598]
  HOMO = -0.581980586008621  LUMO = 0.984445818722125
  mo_energy =
[-1.18569287e+02 -1.23046799e+01 -9.55611917e+00 -9.55611917e+00
 -9.55611917e+00 -1.26892953e+00 -5.81980586e-01 -5.81980586e-01
 -5.81980586e-01  9.84445819e-01  1.00829025e+00  1.00829025e+00
  1.00829025e+00  7.20048313e+00  7.20048313e+00  7.20048313e+00
  1.34522292e+01  3.31808239e+01  3.31808239e+01  3.31808239e+01
  1.10904907e+02  1.28785949e+02  1.28785949e+02  1.28785949e+02
  4.83202089e+02  4.83202089e+02  4.83202089e+02  5.95503066e+02
  1.33502390e+03  1.33502390e+03  1.33502390e+03  2.66440699e+03
  3.02921688e+03  3.02921688e+03  3.02921688e+03  6.64962479e+03
  6.64962479e+03  6.64962479e+03  9.06931851e+03  2.54244098e+04
  7.61661574e+04]
E1 = -728.257817184246  E_coul = 201.51989563906653
cycle= 3 E= -526.737921545179  delta_E= -5.96e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132018
diis-c [-5.99608725e-07 -1.25861257e-03  1.44488400e-01  8.56770213e-01]
  HOMO = -0.583491552775495  LUMO = 0.983192419431393
  mo_energy =
[-1.18579281e+02 -1.23105145e+01 -9.56230129e+00 -9.56230129e+00
 -9.56230129e+00 -1.27063450e+00 -5.83491553e-01 -5.83491553e-01
 -5.83491553e-01  9.83192419e-01  1.00720686e+00  1.00720686e+00
  1.00720686e+00  7.19670766e+00  7.19670766e+00  7.19670766e+00
  1.34474271e+01  3.31746281e+01  3.31746281e+01  3.31746281e+01
  1.10896578e+02  1.28777567e+02  1.28777567e+02  1.28777567e+02
  4.83192209e+02  4.83192209e+02  4.83192209e+02  5.95492834e+02
  1.33501343e+03  1.33501343e+03  1.33501343e+03  2.66439589e+03
  3.02920602e+03  3.02920602e+03  3.02920602e+03  6.64961354e+03
  6.64961354e+03  6.64961354e+03  9.06930705e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2807481641198  E_coul = 201.54282467666619
cycle= 4 E= -526.737923487454  delta_E= -1.94e-06  |g|= 9.88e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000115593
diis-c [-4.23334292e-09  7.24260317e-05 -1.02791849e-02 -6.68768814e-02
  1.07708364e+00]
  HOMO = -0.583473492857598  LUMO = 0.983226151507169
  mo_energy =
[-1.18579242e+02 -1.23104504e+01 -9.56225088e+00 -9.56225088e+00
 -9.56225088e+00 -1.27059363e+00 -5.83473493e-01 -5.83473493e-01
 -5.83473493e-01  9.83226152e-01  1.00722240e+00  1.00722240e+00
  1.00722240e+00  7.19674869e+00  7.19674869e+00  7.19674869e+00
  1.34474868e+01  3.31746764e+01  3.31746764e+01  3.31746764e+01
  1.10896629e+02  1.28777613e+02  1.28777613e+02  1.28777613e+02
  4.83192249e+02  4.83192249e+02  4.83192249e+02  5.95492866e+02
  1.33501346e+03  1.33501346e+03  1.33501346e+03  2.66439590e+03
  3.02920604e+03  3.02920604e+03  3.02920604e+03  6.64961355e+03
  6.64961355e+03  6.64961355e+03  9.06930704e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2805364615566  E_coul = 201.54261297237872
cycle= 5 E= -526.737923489178  delta_E= -1.72e-09  |g|= 2.07e-05  |ddm|= 0.00016
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.9127e-05
diis-c [-7.67191006e-11  1.44582864e-05 -1.85423098e-03 -1.39180497e-02
  4.29784709e-02  9.72779352e-01]
  HOMO = -0.583481007270467  LUMO = 0.983222185495068
  mo_energy =
[-1.18579273e+02 -1.23104731e+01 -9.56227550e+00 -9.56227550e+00
 -9.56227550e+00 -1.27059961e+00 -5.83481007e-01 -5.83481007e-01
 -5.83481007e-01  9.83222185e-01  1.00721744e+00  1.00721744e+00
  1.00721744e+00  7.19673207e+00  7.19673207e+00  7.19673207e+00
  1.34474679e+01  3.31746525e+01  3.31746525e+01  3.31746525e+01
  1.10896601e+02  1.28777585e+02  1.28777585e+02  1.28777585e+02
  4.83192218e+02  4.83192218e+02  4.83192218e+02  5.95492834e+02
  1.33501343e+03  1.33501343e+03  1.33501343e+03  2.66439586e+03
  3.02920601e+03  3.02920601e+03  3.02920601e+03  6.64961351e+03
  6.64961351e+03  6.64961351e+03  9.06930701e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2806185114956  E_coul = 201.54269502225972
cycle= 6 E= -526.737923489236  delta_E= -5.8e-11  |g|= 1.78e-06  |ddm|= 1.88e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2806185114956  E_coul = 201.54269502225972
  HOMO = -0.58348102483818  LUMO = 0.983222531231054
  mo_energy =
[-1.18579273e+02 -1.23104729e+01 -9.56227543e+00 -9.56227543e+00
 -9.56227543e+00 -1.27059923e+00 -5.83481025e-01 -5.83481025e-01
 -5.83481025e-01  9.83222531e-01  1.00721749e+00  1.00721749e+00
  1.00721749e+00  7.19673213e+00  7.19673213e+00  7.19673213e+00
  1.34474681e+01  3.31746526e+01  3.31746526e+01  3.31746526e+01
  1.10896601e+02  1.28777585e+02  1.28777585e+02  1.28777585e+02
  4.83192218e+02  4.83192218e+02  4.83192218e+02  5.95492835e+02
  1.33501343e+03  1.33501343e+03  1.33501343e+03  2.66439586e+03
  3.02920601e+03  3.02920601e+03  3.02920601e+03  6.64961351e+03
  6.64961351e+03  6.64961351e+03  9.06930701e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2806174263419  E_coul = 201.54269393710473
Extra cycle  E= -526.737923489237  delta_E= -1.25e-12  |g|= 3.67e-07  |ddm|= 3.13e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826575e+04 7.61751845e+03 3.61735260e+03 1.59775467e+03
 3.82775956e+02 1.09361079e+02 3.59894854e+01 8.73191556e+00
 3.33556779e+00 6.54655645e-01 2.41409058e-01 1.36278375e+03
 6.64740319e+02 3.00936714e+02 3.14020480e+02 6.16347165e+01
 7.27247655e+00 2.02812850e+01 7.72653473e-01 2.78219928e+00
 2.21617736e-01]
E = -526.7379234892371
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6574749        1
[INPUT] 0    0    [1    /1   ]  7617.51845196        1
[INPUT] 0    0    [1    /1   ]  3617.35260426        1
[INPUT] 0    0    [1    /1   ]  1597.75466893        1
[INPUT] 0    0    [1    /1   ]  382.775955925        1
[INPUT] 0    0    [1    /1   ]  109.361079274        1
[INPUT] 0    0    [1    /1   ]  35.9894853758        1
[INPUT] 0    0    [1    /1   ]  8.7319155559         1
[INPUT] 0    0    [1    /1   ]  3.33556778527        1
[INPUT] 0    0    [1    /1   ]  0.65465564509        1
[INPUT] 0    0    [1    /1   ]  0.241409058141       1
[INPUT] 1    0    [1    /1   ]  1362.78375035        1
[INPUT] 1    0    [1    /1   ]  664.740319084        1
[INPUT] 1    0    [1    /1   ]  300.936713894        1
[INPUT] 1    0    [1    /1   ]  314.020479711        1
[INPUT] 1    0    [1    /1   ]  61.6347164772        1
[INPUT] 1    0    [1    /1   ]  7.27247655173        1
[INPUT] 1    0    [1    /1   ]  20.2812849709        1
[INPUT] 1    0    [1    /1   ]  0.77265347303        1
[INPUT] 1    0    [1    /1   ]  2.78219927878        1
[INPUT] 1    0    [1    /1   ]  0.221617735863       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65747490816, 1.0]], [0, [7617.518451963469, 1.0]], [0, [3617.352604263669, 1.0]], [0, [1597.7546689318845, 1.0]], [0, [382.77595592543315, 1.0]], [0, [109.36107927437178, 1.0]], [0, [35.98948537575374, 1.0]], [0, [8.731915555902773, 1.0]], [0, [3.33556778527203, 1.0]], [0, [0.6546556450903999, 1.0]], [0, [0.2414090581406432, 1.0]], [1, [1362.783750351404, 1.0]], [1, [664.7403190835645, 1.0]], [1, [300.9367138944979, 1.0]], [1, [314.0204797108921, 1.0]], [1, [61.63471647721986, 1.0]], [1, [7.272476551725735, 1.0]], [1, [20.281284970895662, 1.0]], [1, [0.7726534730301619, 1.0]], [1, [2.782199278781879, 1.0]], [1, [0.22161773586290154, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65747491]
bas 1, expnt(s) = [7617.51845196]
bas 2, expnt(s) = [3617.35260426]
bas 3, expnt(s) = [1597.75466893]
bas 4, expnt(s) = [382.77595593]
bas 5, expnt(s) = [109.36107927]
bas 6, expnt(s) = [35.98948538]
bas 7, expnt(s) = [8.73191556]
bas 8, expnt(s) = [3.33556779]
bas 9, expnt(s) = [0.65465565]
bas 10, expnt(s) = [0.24140906]
bas 11, expnt(s) = [1362.78375035]
bas 12, expnt(s) = [664.74031908]
bas 13, expnt(s) = [300.93671389]
bas 14, expnt(s) = [314.02047971]
bas 15, expnt(s) = [61.63471648]
bas 16, expnt(s) = [7.27247655]
bas 17, expnt(s) = [20.28128497]
bas 18, expnt(s) = [0.77265347]
bas 19, expnt(s) = [2.78219928]
bas 20, expnt(s) = [0.22161774]
CPU time:       187.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026311e+03 7.61751845e+03 2.06003766e+03
 3.61735260e+03 1.17844185e+03 1.59775467e+03 6.38480438e+02
 3.82775956e+02 2.18636925e+02 1.09361079e+02 8.54401722e+01
 3.59894854e+01 3.71233151e+01 8.73191556e+00 1.28335607e+01
 3.33556779e+00 6.23580251e+00 6.54655645e-01 1.83875858e+00
 2.41409058e-01 8.70122092e-01 1.36278375e+03 2.41556137e+04
 6.64740319e+02 9.84689754e+03 3.00936714e+02 3.65660762e+03
 3.14020480e+02 3.85639808e+03 6.16347165e+01 5.03809260e+02
 7.27247655e+00 3.48407347e+01 2.02812850e+01 1.25560700e+02
 7.72653473e-01 2.11332039e+00 2.78219928e+00 1.04826162e+01
 2.21617736e-01 4.43598465e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993721086112647
cond(S) = 103772.05425498795
E1 = -729.5292912811518  E_coul = 203.17924732878083
init E= -526.350043952371
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555850038808118  LUMO = 1.00496658706121
  mo_energy =
[-1.18328335e+02 -1.22043953e+01 -9.44668086e+00 -9.44668086e+00
 -9.44668086e+00 -1.24001523e+00 -5.55850039e-01 -5.55850039e-01
 -5.55850039e-01  1.00496659e+00  1.02603091e+00  1.02603091e+00
  1.02603091e+00  7.26762995e+00  7.26762995e+00  7.26762995e+00
  1.35352049e+01  3.32954655e+01  3.32954655e+01  3.32954655e+01
  1.11071151e+02  1.28959263e+02  1.28959263e+02  1.28959263e+02
  4.83442733e+02  4.83442733e+02  4.83442733e+02  5.95779282e+02
  1.33531691e+03  1.33531691e+03  1.33531691e+03  2.66483095e+03
  3.02957383e+03  3.02957383e+03  3.02957383e+03  6.65009323e+03
  6.65009323e+03  6.65009323e+03  9.06986134e+03  2.54250461e+04
  7.61668835e+04]
E1 = -727.8318886248029  E_coul = 201.0947532800551
cycle= 1 E= -526.737135344748  delta_E= -0.387  |g|= 0.186  |ddm|= 0.332
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541662
diis-c [-0.29339781  1.        ]
  HOMO = -0.591160336268041  LUMO = 0.976242468087675
  mo_energy =
[-1.18637279e+02 -1.23429361e+01 -9.59602536e+00 -9.59602536e+00
 -9.59602536e+00 -1.27992033e+00 -5.91160336e-01 -5.91160336e-01
 -5.91160336e-01  9.76242468e-01  1.00156095e+00  1.00156095e+00
  1.00156095e+00  7.17674843e+00  7.17674843e+00  7.17674843e+00
  1.34208945e+01  3.31405763e+01  3.31405763e+01  3.31405763e+01
  1.10848781e+02  1.28729785e+02  1.28729785e+02  1.28729785e+02
  4.83134911e+02  4.83134911e+02  4.83134911e+02  5.95433544e+02
  1.33495267e+03  1.33495267e+03  1.33495267e+03  2.66433245e+03
  3.02914340e+03  3.02914340e+03  3.02914340e+03  6.64954957e+03
  6.64954957e+03  6.64954957e+03  9.06924248e+03  2.54243332e+04
  7.61660805e+04]
E1 = -728.4091750545631  E_coul = 201.67131314666582
cycle= 2 E= -526.737861907897  delta_E= -0.000727  |g|= 0.0378  |ddm|= 0.0542
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0754114
diis-c [-0.0033214   0.08282402  0.91717598]
  HOMO = -0.581980586008621  LUMO = 0.984445818722125
  mo_energy =
[-1.18569287e+02 -1.23046799e+01 -9.55611917e+00 -9.55611917e+00
 -9.55611917e+00 -1.26892953e+00 -5.81980586e-01 -5.81980586e-01
 -5.81980586e-01  9.84445819e-01  1.00829025e+00  1.00829025e+00
  1.00829025e+00  7.20048313e+00  7.20048313e+00  7.20048313e+00
  1.34522292e+01  3.31808239e+01  3.31808239e+01  3.31808239e+01
  1.10904907e+02  1.28785949e+02  1.28785949e+02  1.28785949e+02
  4.83202089e+02  4.83202089e+02  4.83202089e+02  5.95503066e+02
  1.33502390e+03  1.33502390e+03  1.33502390e+03  2.66440699e+03
  3.02921688e+03  3.02921688e+03  3.02921688e+03  6.64962479e+03
  6.64962479e+03  6.64962479e+03  9.06931851e+03  2.54244098e+04
  7.61661574e+04]
E1 = -728.257817184246  E_coul = 201.51989563906653
cycle= 3 E= -526.737921545179  delta_E= -5.96e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132018
diis-c [-5.99608725e-07 -1.25861257e-03  1.44488400e-01  8.56770213e-01]
  HOMO = -0.583491552775495  LUMO = 0.983192419431393
  mo_energy =
[-1.18579281e+02 -1.23105145e+01 -9.56230129e+00 -9.56230129e+00
 -9.56230129e+00 -1.27063450e+00 -5.83491553e-01 -5.83491553e-01
 -5.83491553e-01  9.83192419e-01  1.00720686e+00  1.00720686e+00
  1.00720686e+00  7.19670766e+00  7.19670766e+00  7.19670766e+00
  1.34474271e+01  3.31746281e+01  3.31746281e+01  3.31746281e+01
  1.10896578e+02  1.28777567e+02  1.28777567e+02  1.28777567e+02
  4.83192209e+02  4.83192209e+02  4.83192209e+02  5.95492834e+02
  1.33501343e+03  1.33501343e+03  1.33501343e+03  2.66439589e+03
  3.02920602e+03  3.02920602e+03  3.02920602e+03  6.64961354e+03
  6.64961354e+03  6.64961354e+03  9.06930705e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2807481641198  E_coul = 201.54282467666619
cycle= 4 E= -526.737923487454  delta_E= -1.94e-06  |g|= 9.88e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000115593
diis-c [-4.23334292e-09  7.24260317e-05 -1.02791849e-02 -6.68768814e-02
  1.07708364e+00]
  HOMO = -0.583473492857598  LUMO = 0.983226151507169
  mo_energy =
[-1.18579242e+02 -1.23104504e+01 -9.56225088e+00 -9.56225088e+00
 -9.56225088e+00 -1.27059363e+00 -5.83473493e-01 -5.83473493e-01
 -5.83473493e-01  9.83226152e-01  1.00722240e+00  1.00722240e+00
  1.00722240e+00  7.19674869e+00  7.19674869e+00  7.19674869e+00
  1.34474868e+01  3.31746764e+01  3.31746764e+01  3.31746764e+01
  1.10896629e+02  1.28777613e+02  1.28777613e+02  1.28777613e+02
  4.83192249e+02  4.83192249e+02  4.83192249e+02  5.95492866e+02
  1.33501346e+03  1.33501346e+03  1.33501346e+03  2.66439590e+03
  3.02920604e+03  3.02920604e+03  3.02920604e+03  6.64961355e+03
  6.64961355e+03  6.64961355e+03  9.06930704e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2805364615566  E_coul = 201.54261297237872
cycle= 5 E= -526.737923489178  delta_E= -1.72e-09  |g|= 2.07e-05  |ddm|= 0.00016
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.9127e-05
diis-c [-7.67191006e-11  1.44582864e-05 -1.85423098e-03 -1.39180497e-02
  4.29784709e-02  9.72779352e-01]
  HOMO = -0.583481007270467  LUMO = 0.983222185495068
  mo_energy =
[-1.18579273e+02 -1.23104731e+01 -9.56227550e+00 -9.56227550e+00
 -9.56227550e+00 -1.27059961e+00 -5.83481007e-01 -5.83481007e-01
 -5.83481007e-01  9.83222185e-01  1.00721744e+00  1.00721744e+00
  1.00721744e+00  7.19673207e+00  7.19673207e+00  7.19673207e+00
  1.34474679e+01  3.31746525e+01  3.31746525e+01  3.31746525e+01
  1.10896601e+02  1.28777585e+02  1.28777585e+02  1.28777585e+02
  4.83192218e+02  4.83192218e+02  4.83192218e+02  5.95492834e+02
  1.33501343e+03  1.33501343e+03  1.33501343e+03  2.66439586e+03
  3.02920601e+03  3.02920601e+03  3.02920601e+03  6.64961351e+03
  6.64961351e+03  6.64961351e+03  9.06930701e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2806185114956  E_coul = 201.54269502225972
cycle= 6 E= -526.737923489236  delta_E= -5.8e-11  |g|= 1.78e-06  |ddm|= 1.88e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2806185114956  E_coul = 201.54269502225972
  HOMO = -0.58348102483818  LUMO = 0.983222531231054
  mo_energy =
[-1.18579273e+02 -1.23104729e+01 -9.56227543e+00 -9.56227543e+00
 -9.56227543e+00 -1.27059923e+00 -5.83481025e-01 -5.83481025e-01
 -5.83481025e-01  9.83222531e-01  1.00721749e+00  1.00721749e+00
  1.00721749e+00  7.19673213e+00  7.19673213e+00  7.19673213e+00
  1.34474681e+01  3.31746526e+01  3.31746526e+01  3.31746526e+01
  1.10896601e+02  1.28777585e+02  1.28777585e+02  1.28777585e+02
  4.83192218e+02  4.83192218e+02  4.83192218e+02  5.95492835e+02
  1.33501343e+03  1.33501343e+03  1.33501343e+03  2.66439586e+03
  3.02920601e+03  3.02920601e+03  3.02920601e+03  6.64961351e+03
  6.64961351e+03  6.64961351e+03  9.06930701e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2806174263419  E_coul = 201.54269393710473
Extra cycle  E= -526.737923489237  delta_E= -1.25e-12  |g|= 3.67e-07  |ddm|= 3.13e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103772.05425498795
E1 = -728.2806174263419  E_coul = 201.54269393710473
init E= -526.737923489237
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583481058190199  LUMO = 0.983222576860327
  mo_energy =
[-1.18579273e+02 -1.23104730e+01 -9.56227553e+00 -9.56227553e+00
 -9.56227553e+00 -1.27059919e+00 -5.83481058e-01 -5.83481058e-01
 -5.83481058e-01  9.83222577e-01  1.00721748e+00  1.00721748e+00
  1.00721748e+00  7.19673207e+00  7.19673207e+00  7.19673207e+00
  1.34474681e+01  3.31746525e+01  3.31746525e+01  3.31746525e+01
  1.10896601e+02  1.28777585e+02  1.28777585e+02  1.28777585e+02
  4.83192218e+02  4.83192218e+02  4.83192218e+02  5.95492835e+02
  1.33501343e+03  1.33501343e+03  1.33501343e+03  2.66439586e+03
  3.02920601e+03  3.02920601e+03  3.02920601e+03  6.64961351e+03
  6.64961351e+03  6.64961351e+03  9.06930701e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.2806176125688  E_coul = 201.5426941233323
cycle= 1 E= -526.737923489236  delta_E= 6.82e-13  |g|= 7.73e-08  |ddm|= 6.14e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2806176125688  E_coul = 201.5426941233323
  HOMO = -0.583481057321705  LUMO = 0.983222592797182
  mo_energy =
[-1.18579273e+02 -1.23104730e+01 -9.56227552e+00 -9.56227552e+00
 -9.56227552e+00 -1.27059917e+00 -5.83481057e-01 -5.83481057e-01
 -5.83481057e-01  9.83222593e-01  1.00721748e+00  1.00721748e+00
  1.00721748e+00  7.19673208e+00  7.19673208e+00  7.19673208e+00
  1.34474681e+01  3.31746526e+01  3.31746526e+01  3.31746526e+01
  1.10896601e+02  1.28777585e+02  1.28777585e+02  1.28777585e+02
  4.83192218e+02  4.83192218e+02  4.83192218e+02  5.95492835e+02
  1.33501343e+03  1.33501343e+03  1.33501343e+03  2.66439586e+03
  3.02920601e+03  3.02920601e+03  3.02920601e+03  6.64961351e+03
  6.64961351e+03  6.64961351e+03  9.06930701e+03  2.54243981e+04
  7.61661456e+04]
E1 = -728.28061753538  E_coul = 201.54269404614183
Extra cycle  E= -526.737923489238  delta_E= -1.71e-12  |g|= 1.57e-08  |ddm|= 1.3e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826575e+04 7.61751845e+03 3.61735260e+03 1.59775467e+03
 3.82775956e+02 1.09361079e+02 3.59894854e+01 8.73191556e+00
 3.33556779e+00 6.54655645e-01 2.41409058e-01 1.36278375e+03
 6.64740319e+02 3.00936714e+02 3.14020480e+02 6.16347165e+01
 7.27247655e+00 2.02812850e+01 7.72653473e-01 2.78219928e+00
 2.21617736e-01]
grad_E = [-1.52214808e-06  3.35618962e-06 -1.55708812e-06  7.09565240e-05
 -4.48161642e-05 -9.02403909e-04 -5.60005214e-04  1.94773131e-03
 -1.50922050e-03  5.08426430e-06 -1.83060637e-03 -4.78668230e-07
  5.38336447e-06  2.59040646e-05  2.23260225e-05 -2.77612227e-04
 -5.02267111e-03  2.05431262e-03  4.25823671e-03  3.02650874e-03
 -1.30044092e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6575887        1
[INPUT] 0    0    [1    /1   ]  7617.51821043        1
[INPUT] 0    0    [1    /1   ]  3617.35272777        1
[INPUT] 0    0    [1    /1   ]  1597.74976231        1
[INPUT] 0    0    [1    /1   ]  382.767383421        1
[INPUT] 0    0    [1    /1   ]  109.478933664        1
[INPUT] 0    0    [1    /1   ]  35.9960164096        1
[INPUT] 0    0    [1    /1   ]  8.76999272148        1
[INPUT] 0    0    [1    /1   ]  3.34923302641        1
[INPUT] 0    0    [1    /1   ]  0.660183526267       1
[INPUT] 0    0    [1    /1   ]  0.244127420393       1
[INPUT] 1    0    [1    /1   ]  1362.78378864        1
[INPUT] 1    0    [1    /1   ]  664.739941272        1
[INPUT] 1    0    [1    /1   ]  300.934932359        1
[INPUT] 1    0    [1    /1   ]  314.018943696        1
[INPUT] 1    0    [1    /1   ]  61.6358260146        1
[INPUT] 1    0    [1    /1   ]  7.27771708039        1
[INPUT] 1    0    [1    /1   ]  20.2818688346        1
[INPUT] 1    0    [1    /1   ]  0.771343717587       1
[INPUT] 1    0    [1    /1   ]  2.76791015149        1
[INPUT] 1    0    [1    /1   ]  0.22157639215        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657588748414, 1.0]], [0, [7617.5182104311825, 1.0]], [0, [3617.352727765911, 1.0]], [0, [1597.7497623143302, 1.0]], [0, [382.7673834206173, 1.0]], [0, [109.47893366422652, 1.0]], [0, [35.99601640958929, 1.0]], [0, [8.769992721484924, 1.0]], [0, [3.349233026411673, 1.0]], [0, [0.660183526266764, 1.0]], [0, [0.24412742039335247, 1.0]], [1, [1362.7837886423351, 1.0]], [1, [664.7399412716194, 1.0]], [1, [300.93493235876775, 1.0]], [1, [314.0189436958047, 1.0]], [1, [61.63582601462599, 1.0]], [1, [7.277717080389735, 1.0]], [1, [20.28186883462311, 1.0]], [1, [0.7713437175874752, 1.0]], [1, [2.7679101514908457, 1.0]], [1, [0.22157639214950595, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65758875]
bas 1, expnt(s) = [7617.51821043]
bas 2, expnt(s) = [3617.35272777]
bas 3, expnt(s) = [1597.74976231]
bas 4, expnt(s) = [382.76738342]
bas 5, expnt(s) = [109.47893366]
bas 6, expnt(s) = [35.99601641]
bas 7, expnt(s) = [8.76999272]
bas 8, expnt(s) = [3.34923303]
bas 9, expnt(s) = [0.66018353]
bas 10, expnt(s) = [0.24412742]
bas 11, expnt(s) = [1362.78378864]
bas 12, expnt(s) = [664.73994127]
bas 13, expnt(s) = [300.93493236]
bas 14, expnt(s) = [314.0189437]
bas 15, expnt(s) = [61.63582601]
bas 16, expnt(s) = [7.27771708]
bas 17, expnt(s) = [20.28186883]
bas 18, expnt(s) = [0.77134372]
bas 19, expnt(s) = [2.76791015]
bas 20, expnt(s) = [0.22157639]
CPU time:       192.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826576e+04 5.20026313e+03 7.61751821e+03 2.06003761e+03
 3.61735273e+03 1.17844188e+03 1.59774976e+03 6.38478967e+02
 3.82767383e+02 2.18633253e+02 1.09478934e+02 8.55092197e+01
 3.59960164e+01 3.71283676e+01 8.76999272e+00 1.28755103e+01
 3.34923303e+00 6.25495296e+00 6.60183526e-01 1.85039112e+00
 2.44127420e-01 8.77460238e-01 1.36278379e+03 2.41556145e+04
 6.64739941e+02 9.84689055e+03 3.00934932e+02 3.65658057e+03
 3.14018944e+02 3.85637450e+03 6.16358260e+01 5.03820597e+02
 7.27771708e+00 3.48721202e+01 2.02818688e+01 1.25565218e+02
 7.71343718e-01 2.10884338e+00 2.76791015e+00 1.04153622e+01
 2.21576392e-01 4.43495023e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993720617788792
cond(S) = 103801.90967927269
E1 = -729.529785244456  E_coul = 203.17913094511798
init E= -526.350654299338
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555840828350462  LUMO = 1.02221148662774
  mo_energy =
[-1.18328443e+02 -1.22043666e+01 -9.44670443e+00 -9.44670443e+00
 -9.44670443e+00 -1.23999328e+00 -5.55840828e-01 -5.55840828e-01
 -5.55840828e-01  1.02221149e+00  1.02460724e+00  1.02460724e+00
  1.02460724e+00  7.23990302e+00  7.23990302e+00  7.23990302e+00
  1.36538750e+01  3.32525115e+01  3.32525115e+01  3.32525115e+01
  1.11374749e+02  1.28928632e+02  1.28928632e+02  1.28928632e+02
  4.83422162e+02  4.83422162e+02  4.83422162e+02  5.96323457e+02
  1.33529682e+03  1.33529682e+03  1.33529682e+03  2.66545136e+03
  3.02955068e+03  3.02955068e+03  3.02955068e+03  6.65006840e+03
  6.65006840e+03  6.65006840e+03  9.07044876e+03  2.54256011e+04
  7.61673994e+04]
E1 = -727.8367856699684  E_coul = 201.09955946933593
cycle= 1 E= -526.737226200632  delta_E= -0.387  |g|= 0.186  |ddm|= 0.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541402
diis-c [-0.29311575  1.        ]
  HOMO = -0.590953543097248  LUMO = 0.993243922969283
  mo_energy =
[-1.18637018e+02 -1.23426076e+01 -9.59571055e+00 -9.59571055e+00
 -9.59571055e+00 -1.27971497e+00 -5.90953543e-01 -5.90953543e-01
 -5.90953543e-01  9.93243923e-01  1.00033677e+00  1.00033677e+00
  1.00033677e+00  7.14945406e+00  7.14945406e+00  7.14945406e+00
  1.35395026e+01  3.30979125e+01  3.30979125e+01  3.30979125e+01
  1.11152694e+02  1.28699485e+02  1.28699485e+02  1.28699485e+02
  4.83114698e+02  4.83114698e+02  4.83114698e+02  5.95978010e+02
  1.33493287e+03  1.33493287e+03  1.33493287e+03  2.66495323e+03
  3.02912060e+03  3.02912060e+03  3.02912060e+03  6.64952510e+03
  6.64952510e+03  6.64952510e+03  9.06983026e+03  2.54248886e+04
  7.61665968e+04]
E1 = -728.4128238239814  E_coul = 201.67487437906823
cycle= 2 E= -526.737949444913  delta_E= -0.000723  |g|= 0.0377  |ddm|= 0.0541
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752429
diis-c [-0.0033136   0.08257668  0.91742332]
  HOMO = -0.581793376688935  LUMO = 1.00153000549958
  mo_energy =
[-1.18569135e+02 -1.23044280e+01 -9.55588071e+00 -9.55588071e+00
 -9.55588071e+00 -1.26875017e+00 -5.81793377e-01 -5.81793377e-01
 -5.81793377e-01  1.00153001e+00  1.00703523e+00  1.00703523e+00
  1.00703523e+00  7.17309751e+00  7.17309751e+00  7.17309751e+00
  1.35708447e+01  3.31380881e+01  3.31380881e+01  3.31380881e+01
  1.11208732e+02  1.28755555e+02  1.28755555e+02  1.28755555e+02
  4.83181768e+02  4.83181768e+02  4.83181768e+02  5.96047422e+02
  1.33500399e+03  1.33500399e+03  1.33500399e+03  2.66502766e+03
  3.02919396e+03  3.02919396e+03  3.02919396e+03  6.64960021e+03
  6.64960021e+03  6.64960021e+03  9.06990618e+03  2.54249651e+04
  7.61666736e+04]
E1 = -728.2617760223586  E_coul = 201.52376720827303
cycle= 3 E= -526.738008814086  delta_E= -5.94e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131904
diis-c [-5.90114492e-07 -1.25643496e-03  1.44673978e-01  8.56582457e-01]
  HOMO = -0.583301616379176  LUMO = 1.00026161954351
  mo_energy =
[-1.18579128e+02 -1.23102602e+01 -9.56205964e+00 -9.56205964e+00
 -9.56205964e+00 -1.27045379e+00 -5.83301616e-01 -5.83301616e-01
 -5.83301616e-01  1.00026162e+00  1.00595617e+00  1.00595617e+00
  1.00595617e+00  7.16933217e+00  7.16933217e+00  7.16933217e+00
  1.35660336e+01  3.31318945e+01  3.31318945e+01  3.31318945e+01
  1.11200404e+02  1.28747174e+02  1.28747174e+02  1.28747174e+02
  4.83171890e+02  4.83171890e+02  4.83171890e+02  5.96037192e+02
  1.33499352e+03  1.33499352e+03  1.33499352e+03  2.66501656e+03
  3.02918311e+03  3.02918311e+03  3.02918311e+03  6.64958896e+03
  6.64958896e+03  6.64958896e+03  9.06989472e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.2846975053956  E_coul = 201.5466867516769
cycle= 4 E= -526.738010753719  delta_E= -1.94e-06  |g|= 9.7e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113312
diis-c [-4.15011527e-09  7.06179211e-05 -1.00762535e-02 -6.54407898e-02
  1.07544643e+00]
  HOMO = -0.583283299344792  LUMO = 1.00029547462824
  mo_energy =
[-1.18579088e+02 -1.23101959e+01 -9.56200875e+00 -9.56200875e+00
 -9.56200875e+00 -1.27041312e+00 -5.83283299e-01 -5.83283299e-01
 -5.83283299e-01  1.00029547e+00  1.00597180e+00  1.00597180e+00
  1.00597180e+00  7.16937350e+00  7.16937350e+00  7.16937350e+00
  1.35660934e+01  3.31319432e+01  3.31319432e+01  3.31319432e+01
  1.11200455e+02  1.28747221e+02  1.28747221e+02  1.28747221e+02
  4.83171930e+02  4.83171930e+02  4.83171930e+02  5.96037224e+02
  1.33499355e+03  1.33499355e+03  1.33499355e+03  2.66501657e+03
  3.02918313e+03  3.02918313e+03  3.02918313e+03  6.64958897e+03
  6.64958897e+03  6.64958897e+03  9.06989472e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.284486114239  E_coul = 201.54647535887298
cycle= 5 E= -526.738010755366  delta_E= -1.65e-09  |g|= 2.05e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.88129e-05
diis-c [-7.42301778e-11  1.43328777e-05 -1.84443893e-03 -1.38221953e-02
  4.34769251e-02  9.72175376e-01]
  HOMO = -0.583290708217792  LUMO = 1.00029149576898
  mo_energy =
[-1.18579119e+02 -1.23102183e+01 -9.56203310e+00 -9.56203310e+00
 -9.56203310e+00 -1.27041903e+00 -5.83290708e-01 -5.83290708e-01
 -5.83290708e-01  1.00029150e+00  1.00596693e+00  1.00596693e+00
  1.00596693e+00  7.16935710e+00  7.16935710e+00  7.16935710e+00
  1.35660747e+01  3.31319196e+01  3.31319196e+01  3.31319196e+01
  1.11200427e+02  1.28747193e+02  1.28747193e+02  1.28747193e+02
  4.83171900e+02  4.83171900e+02  4.83171900e+02  5.96037193e+02
  1.33499352e+03  1.33499352e+03  1.33499352e+03  2.66501654e+03
  3.02918309e+03  3.02918309e+03  3.02918309e+03  6.64958893e+03
  6.64958893e+03  6.64958893e+03  9.06989468e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.2845674362651  E_coul = 201.54655668084217
cycle= 6 E= -526.738010755423  delta_E= -5.68e-11  |g|= 1.76e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2845674362651  E_coul = 201.54655668084217
  HOMO = -0.583290731935365  LUMO = 1.00029183528469
  mo_energy =
[-1.18579119e+02 -1.23102182e+01 -9.56203305e+00 -9.56203305e+00
 -9.56203305e+00 -1.27041867e+00 -5.83290732e-01 -5.83290732e-01
 -5.83290732e-01  1.00029184e+00  1.00596697e+00  1.00596697e+00
  1.00596697e+00  7.16935714e+00  7.16935714e+00  7.16935714e+00
  1.35660749e+01  3.31319197e+01  3.31319197e+01  3.31319197e+01
  1.11200427e+02  1.28747193e+02  1.28747193e+02  1.28747193e+02
  4.83171900e+02  4.83171900e+02  4.83171900e+02  5.96037193e+02
  1.33499352e+03  1.33499352e+03  1.33499352e+03  2.66501654e+03
  3.02918309e+03  3.02918309e+03  3.02918309e+03  6.64958893e+03
  6.64958893e+03  6.64958893e+03  9.06989468e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.2845664997577  E_coul = 201.5465557443346
Extra cycle  E= -526.738010755423  delta_E= -2.27e-13  |g|= 3.62e-07  |ddm|= 3.09e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826576e+04 7.61751821e+03 3.61735273e+03 1.59774976e+03
 3.82767383e+02 1.09478934e+02 3.59960164e+01 8.76999272e+00
 3.34923303e+00 6.60183526e-01 2.44127420e-01 1.36278379e+03
 6.64739941e+02 3.00934932e+02 3.14018944e+02 6.16358260e+01
 7.27771708e+00 2.02818688e+01 7.71343718e-01 2.76791015e+00
 2.21576392e-01]
E = -526.7380107554231
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6575887        1
[INPUT] 0    0    [1    /1   ]  7617.51821043        1
[INPUT] 0    0    [1    /1   ]  3617.35272777        1
[INPUT] 0    0    [1    /1   ]  1597.74976231        1
[INPUT] 0    0    [1    /1   ]  382.767383421        1
[INPUT] 0    0    [1    /1   ]  109.478933664        1
[INPUT] 0    0    [1    /1   ]  35.9960164096        1
[INPUT] 0    0    [1    /1   ]  8.76999272148        1
[INPUT] 0    0    [1    /1   ]  3.34923302641        1
[INPUT] 0    0    [1    /1   ]  0.660183526267       1
[INPUT] 0    0    [1    /1   ]  0.244127420393       1
[INPUT] 1    0    [1    /1   ]  1362.78378864        1
[INPUT] 1    0    [1    /1   ]  664.739941272        1
[INPUT] 1    0    [1    /1   ]  300.934932359        1
[INPUT] 1    0    [1    /1   ]  314.018943696        1
[INPUT] 1    0    [1    /1   ]  61.6358260146        1
[INPUT] 1    0    [1    /1   ]  7.27771708039        1
[INPUT] 1    0    [1    /1   ]  20.2818688346        1
[INPUT] 1    0    [1    /1   ]  0.771343717587       1
[INPUT] 1    0    [1    /1   ]  2.76791015149        1
[INPUT] 1    0    [1    /1   ]  0.22157639215        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657588748414, 1.0]], [0, [7617.5182104311825, 1.0]], [0, [3617.352727765911, 1.0]], [0, [1597.7497623143302, 1.0]], [0, [382.7673834206173, 1.0]], [0, [109.47893366422652, 1.0]], [0, [35.99601640958929, 1.0]], [0, [8.769992721484924, 1.0]], [0, [3.349233026411673, 1.0]], [0, [0.660183526266764, 1.0]], [0, [0.24412742039335247, 1.0]], [1, [1362.7837886423351, 1.0]], [1, [664.7399412716194, 1.0]], [1, [300.93493235876775, 1.0]], [1, [314.0189436958047, 1.0]], [1, [61.63582601462599, 1.0]], [1, [7.277717080389735, 1.0]], [1, [20.28186883462311, 1.0]], [1, [0.7713437175874752, 1.0]], [1, [2.7679101514908457, 1.0]], [1, [0.22157639214950595, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65758875]
bas 1, expnt(s) = [7617.51821043]
bas 2, expnt(s) = [3617.35272777]
bas 3, expnt(s) = [1597.74976231]
bas 4, expnt(s) = [382.76738342]
bas 5, expnt(s) = [109.47893366]
bas 6, expnt(s) = [35.99601641]
bas 7, expnt(s) = [8.76999272]
bas 8, expnt(s) = [3.34923303]
bas 9, expnt(s) = [0.66018353]
bas 10, expnt(s) = [0.24412742]
bas 11, expnt(s) = [1362.78378864]
bas 12, expnt(s) = [664.73994127]
bas 13, expnt(s) = [300.93493236]
bas 14, expnt(s) = [314.0189437]
bas 15, expnt(s) = [61.63582601]
bas 16, expnt(s) = [7.27771708]
bas 17, expnt(s) = [20.28186883]
bas 18, expnt(s) = [0.77134372]
bas 19, expnt(s) = [2.76791015]
bas 20, expnt(s) = [0.22157639]
CPU time:       193.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826576e+04 5.20026313e+03 7.61751821e+03 2.06003761e+03
 3.61735273e+03 1.17844188e+03 1.59774976e+03 6.38478967e+02
 3.82767383e+02 2.18633253e+02 1.09478934e+02 8.55092197e+01
 3.59960164e+01 3.71283676e+01 8.76999272e+00 1.28755103e+01
 3.34923303e+00 6.25495296e+00 6.60183526e-01 1.85039112e+00
 2.44127420e-01 8.77460238e-01 1.36278379e+03 2.41556145e+04
 6.64739941e+02 9.84689055e+03 3.00934932e+02 3.65658057e+03
 3.14018944e+02 3.85637450e+03 6.16358260e+01 5.03820597e+02
 7.27771708e+00 3.48721202e+01 2.02818688e+01 1.25565218e+02
 7.71343718e-01 2.10884338e+00 2.76791015e+00 1.04153622e+01
 2.21576392e-01 4.43495023e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993720617788792
cond(S) = 103801.90967927269
E1 = -729.529785244456  E_coul = 203.17913094511798
init E= -526.350654299338
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555840828350462  LUMO = 1.02221148662774
  mo_energy =
[-1.18328443e+02 -1.22043666e+01 -9.44670443e+00 -9.44670443e+00
 -9.44670443e+00 -1.23999328e+00 -5.55840828e-01 -5.55840828e-01
 -5.55840828e-01  1.02221149e+00  1.02460724e+00  1.02460724e+00
  1.02460724e+00  7.23990302e+00  7.23990302e+00  7.23990302e+00
  1.36538750e+01  3.32525115e+01  3.32525115e+01  3.32525115e+01
  1.11374749e+02  1.28928632e+02  1.28928632e+02  1.28928632e+02
  4.83422162e+02  4.83422162e+02  4.83422162e+02  5.96323457e+02
  1.33529682e+03  1.33529682e+03  1.33529682e+03  2.66545136e+03
  3.02955068e+03  3.02955068e+03  3.02955068e+03  6.65006840e+03
  6.65006840e+03  6.65006840e+03  9.07044876e+03  2.54256011e+04
  7.61673994e+04]
E1 = -727.8367856699684  E_coul = 201.09955946933593
cycle= 1 E= -526.737226200632  delta_E= -0.387  |g|= 0.186  |ddm|= 0.32
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541402
diis-c [-0.29311575  1.        ]
  HOMO = -0.590953543097248  LUMO = 0.993243922969283
  mo_energy =
[-1.18637018e+02 -1.23426076e+01 -9.59571055e+00 -9.59571055e+00
 -9.59571055e+00 -1.27971497e+00 -5.90953543e-01 -5.90953543e-01
 -5.90953543e-01  9.93243923e-01  1.00033677e+00  1.00033677e+00
  1.00033677e+00  7.14945406e+00  7.14945406e+00  7.14945406e+00
  1.35395026e+01  3.30979125e+01  3.30979125e+01  3.30979125e+01
  1.11152694e+02  1.28699485e+02  1.28699485e+02  1.28699485e+02
  4.83114698e+02  4.83114698e+02  4.83114698e+02  5.95978010e+02
  1.33493287e+03  1.33493287e+03  1.33493287e+03  2.66495323e+03
  3.02912060e+03  3.02912060e+03  3.02912060e+03  6.64952510e+03
  6.64952510e+03  6.64952510e+03  9.06983026e+03  2.54248886e+04
  7.61665968e+04]
E1 = -728.4128238239814  E_coul = 201.67487437906823
cycle= 2 E= -526.737949444913  delta_E= -0.000723  |g|= 0.0377  |ddm|= 0.0541
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752429
diis-c [-0.0033136   0.08257668  0.91742332]
  HOMO = -0.581793376688935  LUMO = 1.00153000549958
  mo_energy =
[-1.18569135e+02 -1.23044280e+01 -9.55588071e+00 -9.55588071e+00
 -9.55588071e+00 -1.26875017e+00 -5.81793377e-01 -5.81793377e-01
 -5.81793377e-01  1.00153001e+00  1.00703523e+00  1.00703523e+00
  1.00703523e+00  7.17309751e+00  7.17309751e+00  7.17309751e+00
  1.35708447e+01  3.31380881e+01  3.31380881e+01  3.31380881e+01
  1.11208732e+02  1.28755555e+02  1.28755555e+02  1.28755555e+02
  4.83181768e+02  4.83181768e+02  4.83181768e+02  5.96047422e+02
  1.33500399e+03  1.33500399e+03  1.33500399e+03  2.66502766e+03
  3.02919396e+03  3.02919396e+03  3.02919396e+03  6.64960021e+03
  6.64960021e+03  6.64960021e+03  9.06990618e+03  2.54249651e+04
  7.61666736e+04]
E1 = -728.2617760223586  E_coul = 201.52376720827303
cycle= 3 E= -526.738008814086  delta_E= -5.94e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131904
diis-c [-5.90114492e-07 -1.25643496e-03  1.44673978e-01  8.56582457e-01]
  HOMO = -0.583301616379176  LUMO = 1.00026161954351
  mo_energy =
[-1.18579128e+02 -1.23102602e+01 -9.56205964e+00 -9.56205964e+00
 -9.56205964e+00 -1.27045379e+00 -5.83301616e-01 -5.83301616e-01
 -5.83301616e-01  1.00026162e+00  1.00595617e+00  1.00595617e+00
  1.00595617e+00  7.16933217e+00  7.16933217e+00  7.16933217e+00
  1.35660336e+01  3.31318945e+01  3.31318945e+01  3.31318945e+01
  1.11200404e+02  1.28747174e+02  1.28747174e+02  1.28747174e+02
  4.83171890e+02  4.83171890e+02  4.83171890e+02  5.96037192e+02
  1.33499352e+03  1.33499352e+03  1.33499352e+03  2.66501656e+03
  3.02918311e+03  3.02918311e+03  3.02918311e+03  6.64958896e+03
  6.64958896e+03  6.64958896e+03  9.06989472e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.2846975053956  E_coul = 201.5466867516769
cycle= 4 E= -526.738010753719  delta_E= -1.94e-06  |g|= 9.7e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113312
diis-c [-4.15011527e-09  7.06179211e-05 -1.00762535e-02 -6.54407898e-02
  1.07544643e+00]
  HOMO = -0.583283299344792  LUMO = 1.00029547462824
  mo_energy =
[-1.18579088e+02 -1.23101959e+01 -9.56200875e+00 -9.56200875e+00
 -9.56200875e+00 -1.27041312e+00 -5.83283299e-01 -5.83283299e-01
 -5.83283299e-01  1.00029547e+00  1.00597180e+00  1.00597180e+00
  1.00597180e+00  7.16937350e+00  7.16937350e+00  7.16937350e+00
  1.35660934e+01  3.31319432e+01  3.31319432e+01  3.31319432e+01
  1.11200455e+02  1.28747221e+02  1.28747221e+02  1.28747221e+02
  4.83171930e+02  4.83171930e+02  4.83171930e+02  5.96037224e+02
  1.33499355e+03  1.33499355e+03  1.33499355e+03  2.66501657e+03
  3.02918313e+03  3.02918313e+03  3.02918313e+03  6.64958897e+03
  6.64958897e+03  6.64958897e+03  9.06989472e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.284486114239  E_coul = 201.54647535887298
cycle= 5 E= -526.738010755366  delta_E= -1.65e-09  |g|= 2.05e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.88129e-05
diis-c [-7.42301778e-11  1.43328777e-05 -1.84443893e-03 -1.38221953e-02
  4.34769251e-02  9.72175376e-01]
  HOMO = -0.583290708217792  LUMO = 1.00029149576898
  mo_energy =
[-1.18579119e+02 -1.23102183e+01 -9.56203310e+00 -9.56203310e+00
 -9.56203310e+00 -1.27041903e+00 -5.83290708e-01 -5.83290708e-01
 -5.83290708e-01  1.00029150e+00  1.00596693e+00  1.00596693e+00
  1.00596693e+00  7.16935710e+00  7.16935710e+00  7.16935710e+00
  1.35660747e+01  3.31319196e+01  3.31319196e+01  3.31319196e+01
  1.11200427e+02  1.28747193e+02  1.28747193e+02  1.28747193e+02
  4.83171900e+02  4.83171900e+02  4.83171900e+02  5.96037193e+02
  1.33499352e+03  1.33499352e+03  1.33499352e+03  2.66501654e+03
  3.02918309e+03  3.02918309e+03  3.02918309e+03  6.64958893e+03
  6.64958893e+03  6.64958893e+03  9.06989468e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.2845674362651  E_coul = 201.54655668084217
cycle= 6 E= -526.738010755423  delta_E= -5.68e-11  |g|= 1.76e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2845674362651  E_coul = 201.54655668084217
  HOMO = -0.583290731935365  LUMO = 1.00029183528469
  mo_energy =
[-1.18579119e+02 -1.23102182e+01 -9.56203305e+00 -9.56203305e+00
 -9.56203305e+00 -1.27041867e+00 -5.83290732e-01 -5.83290732e-01
 -5.83290732e-01  1.00029184e+00  1.00596697e+00  1.00596697e+00
  1.00596697e+00  7.16935714e+00  7.16935714e+00  7.16935714e+00
  1.35660749e+01  3.31319197e+01  3.31319197e+01  3.31319197e+01
  1.11200427e+02  1.28747193e+02  1.28747193e+02  1.28747193e+02
  4.83171900e+02  4.83171900e+02  4.83171900e+02  5.96037193e+02
  1.33499352e+03  1.33499352e+03  1.33499352e+03  2.66501654e+03
  3.02918309e+03  3.02918309e+03  3.02918309e+03  6.64958893e+03
  6.64958893e+03  6.64958893e+03  9.06989468e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.2845664997577  E_coul = 201.5465557443346
Extra cycle  E= -526.738010755423  delta_E= -2.27e-13  |g|= 3.62e-07  |ddm|= 3.09e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103801.90967927269
E1 = -728.2845664997577  E_coul = 201.5465557443346
init E= -526.738010755423
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.583290761828597  LUMO = 1.00029188329009
  mo_energy =
[-1.18579119e+02 -1.23102182e+01 -9.56203314e+00 -9.56203314e+00
 -9.56203314e+00 -1.27041862e+00 -5.83290762e-01 -5.83290762e-01
 -5.83290762e-01  1.00029188e+00  1.00596696e+00  1.00596696e+00
  1.00596696e+00  7.16935709e+00  7.16935709e+00  7.16935709e+00
  1.35660749e+01  3.31319196e+01  3.31319196e+01  3.31319196e+01
  1.11200427e+02  1.28747193e+02  1.28747193e+02  1.28747193e+02
  4.83171900e+02  4.83171900e+02  4.83171900e+02  5.96037193e+02
  1.33499352e+03  1.33499352e+03  1.33499352e+03  2.66501654e+03
  3.02918309e+03  3.02918309e+03  3.02918309e+03  6.64958893e+03
  6.64958893e+03  6.64958893e+03  9.06989468e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.2845666516862  E_coul = 201.54655589626378
cycle= 1 E= -526.738010755422  delta_E= 6.82e-13  |g|= 7.59e-08  |ddm|= 6.06e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2845666516862  E_coul = 201.54655589626378
  HOMO = -0.583290761481276  LUMO = 1.0002918986884
  mo_energy =
[-1.18579119e+02 -1.23102182e+01 -9.56203313e+00 -9.56203313e+00
 -9.56203313e+00 -1.27041860e+00 -5.83290761e-01 -5.83290761e-01
 -5.83290761e-01  1.00029190e+00  1.00596696e+00  1.00596696e+00
  1.00596696e+00  7.16935709e+00  7.16935709e+00  7.16935709e+00
  1.35660749e+01  3.31319196e+01  3.31319196e+01  3.31319196e+01
  1.11200427e+02  1.28747193e+02  1.28747193e+02  1.28747193e+02
  4.83171900e+02  4.83171900e+02  4.83171900e+02  5.96037193e+02
  1.33499352e+03  1.33499352e+03  1.33499352e+03  2.66501654e+03
  3.02918309e+03  3.02918309e+03  3.02918309e+03  6.64958893e+03
  6.64958893e+03  6.64958893e+03  9.06989468e+03  2.54249534e+04
  7.61666618e+04]
E1 = -728.2845665857831  E_coul = 201.54655583035873
Extra cycle  E= -526.738010755424  delta_E= -1.82e-12  |g|= 1.53e-08  |ddm|= 1.28e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61826576e+04 7.61751821e+03 3.61735273e+03 1.59774976e+03
 3.82767383e+02 1.09478934e+02 3.59960164e+01 8.76999272e+00
 3.34923303e+00 6.60183526e-01 2.44127420e-01 1.36278379e+03
 6.64739941e+02 3.00934932e+02 3.14018944e+02 6.16358260e+01
 7.27771708e+00 2.02818688e+01 7.71343718e-01 2.76791015e+00
 2.21576392e-01]
grad_E = [-1.52434144e-06  3.38062001e-06 -1.54339637e-06  7.18921755e-05
 -7.09111293e-05 -7.51597554e-04 -8.26201596e-04  1.87690353e-03
 -8.33922959e-04  1.50830949e-04 -2.32885721e-04 -4.84665562e-07
  5.30533467e-06  2.54270465e-05  2.19161422e-05 -2.18760482e-04
 -2.41142059e-03  1.43436489e-03  1.23246202e-03 -5.49328653e-04
 -4.48371355e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6575697        1
[INPUT] 0    0    [1    /1   ]  7617.51825147        1
[INPUT] 0    0    [1    /1   ]  3617.35270746        1
[INPUT] 0    0    [1    /1   ]  1597.75060967        1
[INPUT] 0    0    [1    /1   ]  382.767796115        1
[INPUT] 0    0    [1    /1   ]  109.470107057        1
[INPUT] 0    0    [1    /1   ]  35.965419238         1
[INPUT] 0    0    [1    /1   ]  8.73828603451        1
[INPUT] 0    0    [1    /1   ]  3.34643580182        1
[INPUT] 0    0    [1    /1   ]  0.661739066194       1
[INPUT] 0    0    [1    /1   ]  0.244826780386       1
[INPUT] 1    0    [1    /1   ]  1362.7837822         1
[INPUT] 1    0    [1    /1   ]  664.740003853        1
[INPUT] 1    0    [1    /1   ]  300.93522664         1
[INPUT] 1    0    [1    /1   ]  314.019197438        1
[INPUT] 1    0    [1    /1   ]  61.6360573662        1
[INPUT] 1    0    [1    /1   ]  7.28469873448        1
[INPUT] 1    0    [1    /1   ]  20.2784785258        1
[INPUT] 1    0    [1    /1   ]  0.771182880196       1
[INPUT] 1    0    [1    /1   ]  2.76548787198        1
[INPUT] 1    0    [1    /1   ]  0.221711678879       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657569659597, 1.0]], [0, [7617.518251472746, 1.0]], [0, [3617.3527074587487, 1.0]], [0, [1597.7506096744864, 1.0]], [0, [382.76779611457664, 1.0]], [0, [109.47010705679494, 1.0]], [0, [35.9654192380152, 1.0]], [0, [8.738286034508489, 1.0]], [0, [3.3464358018241227, 1.0]], [0, [0.6617390661940146, 1.0]], [0, [0.24482678038614683, 1.0]], [1, [1362.7837821970763, 1.0]], [1, [664.7400038531111, 1.0]], [1, [300.93522664037107, 1.0]], [1, [314.01919743812357, 1.0]], [1, [61.636057366230204, 1.0]], [1, [7.28469873447719, 1.0]], [1, [20.278478525841887, 1.0]], [1, [0.7711828801962985, 1.0]], [1, [2.765487871980977, 1.0]], [1, [0.2217116788786401, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65756966]
bas 1, expnt(s) = [7617.51825147]
bas 2, expnt(s) = [3617.35270746]
bas 3, expnt(s) = [1597.75060967]
bas 4, expnt(s) = [382.76779611]
bas 5, expnt(s) = [109.47010706]
bas 6, expnt(s) = [35.96541924]
bas 7, expnt(s) = [8.73828603]
bas 8, expnt(s) = [3.3464358]
bas 9, expnt(s) = [0.66173907]
bas 10, expnt(s) = [0.24482678]
bas 11, expnt(s) = [1362.7837822]
bas 12, expnt(s) = [664.74000385]
bas 13, expnt(s) = [300.93522664]
bas 14, expnt(s) = [314.01919744]
bas 15, expnt(s) = [61.63605737]
bas 16, expnt(s) = [7.28469873]
bas 17, expnt(s) = [20.27847853]
bas 18, expnt(s) = [0.77118288]
bas 19, expnt(s) = [2.76548787]
bas 20, expnt(s) = [0.22171168]
CPU time:       199.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826576e+04 5.20026312e+03 7.61751825e+03 2.06003762e+03
 3.61735271e+03 1.17844188e+03 1.59775061e+03 6.38479221e+02
 3.82767796e+02 2.18633430e+02 1.09470107e+02 8.55040491e+01
 3.59654192e+01 3.71046953e+01 8.73828603e+00 1.28405822e+01
 3.34643580e+00 6.25103453e+00 6.61739066e-01 1.85366011e+00
 2.44826780e-01 8.79344831e-01 1.36278378e+03 2.41556144e+04
 6.64740004e+02 9.84689171e+03 3.00935227e+02 3.65658504e+03
 3.14019197e+02 3.85637840e+03 6.16360574e+01 5.03822961e+02
 7.28469873e+00 3.49139421e+01 2.02784785e+01 1.25538982e+02
 7.71182880e-01 2.10829373e+00 2.76548787e+00 1.04039700e+01
 2.21711679e-01 4.43833527e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99370795869319
cond(S) = 103797.71467771463
E1 = -729.529610778099  E_coul = 203.17887962171355
init E= -526.350731156385
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555828958054594  LUMO = 1.02495123137774
  mo_energy =
[-1.18328473e+02 -1.22044101e+01 -9.44673919e+00 -9.44673919e+00
 -9.44673919e+00 -1.23999088e+00 -5.55828958e-01 -5.55828958e-01
 -5.55828958e-01  1.02495123e+00  1.02495123e+00  1.02495123e+00
  1.02657818e+00  7.23778658e+00  7.23778658e+00  7.23778658e+00
  1.36215425e+01  3.32579916e+01  3.32579916e+01  3.32579916e+01
  1.11185330e+02  1.28935600e+02  1.28935600e+02  1.28935600e+02
  4.83426369e+02  4.83426369e+02  4.83426369e+02  5.96061829e+02
  1.33530086e+03  1.33530086e+03  1.33530086e+03  2.66519764e+03
  3.02955516e+03  3.02955516e+03  3.02955516e+03  6.65007311e+03
  6.65007311e+03  6.65007311e+03  9.07021324e+03  2.54253784e+04
  7.61671921e+04]
E1 = -727.8403841802975  E_coul = 201.1031219587191
cycle= 1 E= -526.737262221578  delta_E= -0.387  |g|= 0.186  |ddm|= 0.316
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541192
diis-c [-0.29288906  1.        ]
  HOMO = -0.590813197864892  LUMO = 0.997633479090383
  mo_energy =
[-1.18636777e+02 -1.23423954e+01 -9.59545974e+00 -9.59545974e+00
 -9.59545974e+00 -1.27957635e+00 -5.90813198e-01 -5.90813198e-01
 -5.90813198e-01  9.97633479e-01  1.00077760e+00  1.00077760e+00
  1.00077760e+00  7.14755651e+00  7.14755651e+00  7.14755651e+00
  1.35075419e+01  3.31036397e+01  3.31036397e+01  3.31036397e+01
  1.10963682e+02  1.28706733e+02  1.28706733e+02  1.28706733e+02
  4.83119188e+02  4.83119188e+02  4.83119188e+02  5.95716616e+02
  1.33493714e+03  1.33493714e+03  1.33493714e+03  2.66469973e+03
  3.02912531e+03  3.02912531e+03  3.02912531e+03  6.64953002e+03
  6.64953002e+03  6.64953002e+03  9.06959496e+03  2.54246661e+04
  7.61663897e+04]
E1 = -728.415330625446  E_coul = 201.6773476066687
cycle= 2 E= -526.737983018777  delta_E= -0.000721  |g|= 0.0377  |ddm|= 0.0541
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0751265
diis-c [-0.00330526  0.0824573   0.9175427 ]
  HOMO = -0.581672393889244  LUMO = 1.00592464494128
  mo_energy =
[-1.18568996e+02 -1.23042865e+01 -9.55570063e+00 -9.55570063e+00
 -9.55570063e+00 -1.26863538e+00 -5.81672394e-01 -5.81672394e-01
 -5.81672394e-01  1.00592464e+00  1.00746114e+00  1.00746114e+00
  1.00746114e+00  7.17115163e+00  7.17115163e+00  7.17115163e+00
  1.35387777e+01  3.31437485e+01  3.31437485e+01  3.31437485e+01
  1.11019620e+02  1.28762714e+02  1.28762714e+02  1.28762714e+02
  4.83186158e+02  4.83186158e+02  4.83186158e+02  5.95785927e+02
  1.33500815e+03  1.33500815e+03  1.33500815e+03  2.66477405e+03
  3.02919857e+03  3.02919857e+03  3.02919857e+03  6.64960502e+03
  6.64960502e+03  6.64960502e+03  9.06967078e+03  2.54247424e+04
  7.61664664e+04]
E1 = -728.264599591562  E_coul = 201.52655744129385
cycle= 3 E= -526.738042150268  delta_E= -5.91e-05  |g|= 0.0063  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.0131732
diis-c [-5.85754051e-07 -1.25507123e-03  1.44706830e-01  8.56548241e-01]
  HOMO = -0.583177392619735  LUMO = 1.00465528095636
  mo_energy =
[-1.18578977e+02 -1.23101108e+01 -9.56187100e+00 -9.56187100e+00
 -9.56187100e+00 -1.27033558e+00 -5.83177393e-01 -5.83177393e-01
 -5.83177393e-01  1.00465528e+00  1.00638451e+00  1.00638451e+00
  1.00638451e+00  7.16739301e+00  7.16739301e+00  7.16739301e+00
  1.35339800e+01  3.31375628e+01  3.31375628e+01  3.31375628e+01
  1.11011303e+02  1.28754342e+02  1.28754342e+02  1.28754342e+02
  4.83176291e+02  4.83176291e+02  4.83176291e+02  5.95775708e+02
  1.33499769e+03  1.33499769e+03  1.33499769e+03  2.66476296e+03
  3.02918773e+03  3.02918773e+03  3.02918773e+03  6.64959379e+03
  6.64959379e+03  6.64959379e+03  9.06965933e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.2874820990905  E_coul = 201.549438015541
cycle= 4 E= -526.73804408355  delta_E= -1.93e-06  |g|= 9.66e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112436
diis-c [-4.11824133e-09  7.01706572e-05 -1.00335321e-02 -6.51145247e-02
  1.07507789e+00]
  HOMO = -0.583159000070968  LUMO = 1.00468918855142
  mo_energy =
[-1.18578937e+02 -1.23100464e+01 -9.56181996e+00 -9.56181996e+00
 -9.56181996e+00 -1.27029494e+00 -5.83159000e-01 -5.83159000e-01
 -5.83159000e-01  1.00468919e+00  1.00640017e+00  1.00640017e+00
  1.00640017e+00  7.16743445e+00  7.16743445e+00  7.16743445e+00
  1.35340398e+01  3.31376117e+01  3.31376117e+01  3.31376117e+01
  1.11011355e+02  1.28754390e+02  1.28754390e+02  1.28754390e+02
  4.83176331e+02  4.83176331e+02  4.83176331e+02  5.95775740e+02
  1.33499773e+03  1.33499773e+03  1.33499773e+03  2.66476297e+03
  3.02918775e+03  3.02918775e+03  3.02918775e+03  6.64959379e+03
  6.64959379e+03  6.64959379e+03  9.06965933e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.287270681632  E_coul = 201.54922659645285
cycle= 5 E= -526.738044085179  delta_E= -1.63e-09  |g|= 2.05e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8696e-05
diis-c [-7.36052108e-11  1.43193849e-05 -1.84424709e-03 -1.38113496e-02
  4.33782716e-02  9.72263006e-01]
  HOMO = -0.583166374989424  LUMO = 1.00468521805047
  mo_energy =
[-1.18578968e+02 -1.23100687e+01 -9.56184421e+00 -9.56184421e+00
 -9.56184421e+00 -1.27030082e+00 -5.83166375e-01 -5.83166375e-01
 -5.83166375e-01  1.00468522e+00  1.00639533e+00  1.00639533e+00
  1.00639533e+00  7.16741812e+00  7.16741812e+00  7.16741812e+00
  1.35340212e+01  3.31375881e+01  3.31375881e+01  3.31375881e+01
  1.11011327e+02  1.28754362e+02  1.28754362e+02  1.28754362e+02
  4.83176301e+02  4.83176301e+02  4.83176301e+02  5.95775709e+02
  1.33499769e+03  1.33499769e+03  1.33499769e+03  2.66476294e+03
  3.02918772e+03  3.02918772e+03  3.02918772e+03  6.64959376e+03
  6.64959376e+03  6.64959376e+03  9.06965929e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.2873516819255  E_coul = 201.54930759668895
cycle= 6 E= -526.738044085237  delta_E= -5.75e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2873516819255  E_coul = 201.54930759668895
  HOMO = -0.583166399875403  LUMO = 1.00468555554714
  mo_energy =
[-1.18578967e+02 -1.23100686e+01 -9.56184417e+00 -9.56184417e+00
 -9.56184417e+00 -1.27030046e+00 -5.83166400e-01 -5.83166400e-01
 -5.83166400e-01  1.00468556e+00  1.00639536e+00  1.00639536e+00
  1.00639536e+00  7.16741816e+00  7.16741816e+00  7.16741816e+00
  1.35340214e+01  3.31375882e+01  3.31375882e+01  3.31375882e+01
  1.11011327e+02  1.28754362e+02  1.28754362e+02  1.28754362e+02
  4.83176301e+02  4.83176301e+02  4.83176301e+02  5.95775710e+02
  1.33499770e+03  1.33499770e+03  1.33499770e+03  2.66476294e+03
  3.02918772e+03  3.02918772e+03  3.02918772e+03  6.64959376e+03
  6.64959376e+03  6.64959376e+03  9.06965929e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.2873507739514  E_coul = 201.5493066887149
Extra cycle  E= -526.738044085237  delta_E= 1.14e-13  |g|= 3.61e-07  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826576e+04 7.61751825e+03 3.61735271e+03 1.59775061e+03
 3.82767796e+02 1.09470107e+02 3.59654192e+01 8.73828603e+00
 3.34643580e+00 6.61739066e-01 2.44826780e-01 1.36278378e+03
 6.64740004e+02 3.00935227e+02 3.14019197e+02 6.16360574e+01
 7.28469873e+00 2.02784785e+01 7.71182880e-01 2.76548787e+00
 2.21711679e-01]
E = -526.7380440852365
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6575697        1
[INPUT] 0    0    [1    /1   ]  7617.51825147        1
[INPUT] 0    0    [1    /1   ]  3617.35270746        1
[INPUT] 0    0    [1    /1   ]  1597.75060967        1
[INPUT] 0    0    [1    /1   ]  382.767796115        1
[INPUT] 0    0    [1    /1   ]  109.470107057        1
[INPUT] 0    0    [1    /1   ]  35.965419238         1
[INPUT] 0    0    [1    /1   ]  8.73828603451        1
[INPUT] 0    0    [1    /1   ]  3.34643580182        1
[INPUT] 0    0    [1    /1   ]  0.661739066194       1
[INPUT] 0    0    [1    /1   ]  0.244826780386       1
[INPUT] 1    0    [1    /1   ]  1362.7837822         1
[INPUT] 1    0    [1    /1   ]  664.740003853        1
[INPUT] 1    0    [1    /1   ]  300.93522664         1
[INPUT] 1    0    [1    /1   ]  314.019197438        1
[INPUT] 1    0    [1    /1   ]  61.6360573662        1
[INPUT] 1    0    [1    /1   ]  7.28469873448        1
[INPUT] 1    0    [1    /1   ]  20.2784785258        1
[INPUT] 1    0    [1    /1   ]  0.771182880196       1
[INPUT] 1    0    [1    /1   ]  2.76548787198        1
[INPUT] 1    0    [1    /1   ]  0.221711678879       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657569659597, 1.0]], [0, [7617.518251472746, 1.0]], [0, [3617.3527074587487, 1.0]], [0, [1597.7506096744864, 1.0]], [0, [382.76779611457664, 1.0]], [0, [109.47010705679494, 1.0]], [0, [35.9654192380152, 1.0]], [0, [8.738286034508489, 1.0]], [0, [3.3464358018241227, 1.0]], [0, [0.6617390661940146, 1.0]], [0, [0.24482678038614683, 1.0]], [1, [1362.7837821970763, 1.0]], [1, [664.7400038531111, 1.0]], [1, [300.93522664037107, 1.0]], [1, [314.01919743812357, 1.0]], [1, [61.636057366230204, 1.0]], [1, [7.28469873447719, 1.0]], [1, [20.278478525841887, 1.0]], [1, [0.7711828801962985, 1.0]], [1, [2.765487871980977, 1.0]], [1, [0.2217116788786401, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65756966]
bas 1, expnt(s) = [7617.51825147]
bas 2, expnt(s) = [3617.35270746]
bas 3, expnt(s) = [1597.75060967]
bas 4, expnt(s) = [382.76779611]
bas 5, expnt(s) = [109.47010706]
bas 6, expnt(s) = [35.96541924]
bas 7, expnt(s) = [8.73828603]
bas 8, expnt(s) = [3.3464358]
bas 9, expnt(s) = [0.66173907]
bas 10, expnt(s) = [0.24482678]
bas 11, expnt(s) = [1362.7837822]
bas 12, expnt(s) = [664.74000385]
bas 13, expnt(s) = [300.93522664]
bas 14, expnt(s) = [314.01919744]
bas 15, expnt(s) = [61.63605737]
bas 16, expnt(s) = [7.28469873]
bas 17, expnt(s) = [20.27847853]
bas 18, expnt(s) = [0.77118288]
bas 19, expnt(s) = [2.76548787]
bas 20, expnt(s) = [0.22171168]
CPU time:       199.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826576e+04 5.20026312e+03 7.61751825e+03 2.06003762e+03
 3.61735271e+03 1.17844188e+03 1.59775061e+03 6.38479221e+02
 3.82767796e+02 2.18633430e+02 1.09470107e+02 8.55040491e+01
 3.59654192e+01 3.71046953e+01 8.73828603e+00 1.28405822e+01
 3.34643580e+00 6.25103453e+00 6.61739066e-01 1.85366011e+00
 2.44826780e-01 8.79344831e-01 1.36278378e+03 2.41556144e+04
 6.64740004e+02 9.84689171e+03 3.00935227e+02 3.65658504e+03
 3.14019197e+02 3.85637840e+03 6.16360574e+01 5.03822961e+02
 7.28469873e+00 3.49139421e+01 2.02784785e+01 1.25538982e+02
 7.71182880e-01 2.10829373e+00 2.76548787e+00 1.04039700e+01
 2.21711679e-01 4.43833527e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99370795869319
cond(S) = 103797.71467771463
E1 = -729.529610778099  E_coul = 203.17887962171355
init E= -526.350731156385
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555828958054594  LUMO = 1.02495123137774
  mo_energy =
[-1.18328473e+02 -1.22044101e+01 -9.44673919e+00 -9.44673919e+00
 -9.44673919e+00 -1.23999088e+00 -5.55828958e-01 -5.55828958e-01
 -5.55828958e-01  1.02495123e+00  1.02495123e+00  1.02495123e+00
  1.02657818e+00  7.23778658e+00  7.23778658e+00  7.23778658e+00
  1.36215425e+01  3.32579916e+01  3.32579916e+01  3.32579916e+01
  1.11185330e+02  1.28935600e+02  1.28935600e+02  1.28935600e+02
  4.83426369e+02  4.83426369e+02  4.83426369e+02  5.96061829e+02
  1.33530086e+03  1.33530086e+03  1.33530086e+03  2.66519764e+03
  3.02955516e+03  3.02955516e+03  3.02955516e+03  6.65007311e+03
  6.65007311e+03  6.65007311e+03  9.07021324e+03  2.54253784e+04
  7.61671921e+04]
E1 = -727.8403841802975  E_coul = 201.1031219587191
cycle= 1 E= -526.737262221578  delta_E= -0.387  |g|= 0.186  |ddm|= 0.316
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541192
diis-c [-0.29288906  1.        ]
  HOMO = -0.590813197864892  LUMO = 0.997633479090383
  mo_energy =
[-1.18636777e+02 -1.23423954e+01 -9.59545974e+00 -9.59545974e+00
 -9.59545974e+00 -1.27957635e+00 -5.90813198e-01 -5.90813198e-01
 -5.90813198e-01  9.97633479e-01  1.00077760e+00  1.00077760e+00
  1.00077760e+00  7.14755651e+00  7.14755651e+00  7.14755651e+00
  1.35075419e+01  3.31036397e+01  3.31036397e+01  3.31036397e+01
  1.10963682e+02  1.28706733e+02  1.28706733e+02  1.28706733e+02
  4.83119188e+02  4.83119188e+02  4.83119188e+02  5.95716616e+02
  1.33493714e+03  1.33493714e+03  1.33493714e+03  2.66469973e+03
  3.02912531e+03  3.02912531e+03  3.02912531e+03  6.64953002e+03
  6.64953002e+03  6.64953002e+03  9.06959496e+03  2.54246661e+04
  7.61663897e+04]
E1 = -728.415330625446  E_coul = 201.6773476066687
cycle= 2 E= -526.737983018777  delta_E= -0.000721  |g|= 0.0377  |ddm|= 0.0541
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0751265
diis-c [-0.00330526  0.0824573   0.9175427 ]
  HOMO = -0.581672393889244  LUMO = 1.00592464494128
  mo_energy =
[-1.18568996e+02 -1.23042865e+01 -9.55570063e+00 -9.55570063e+00
 -9.55570063e+00 -1.26863538e+00 -5.81672394e-01 -5.81672394e-01
 -5.81672394e-01  1.00592464e+00  1.00746114e+00  1.00746114e+00
  1.00746114e+00  7.17115163e+00  7.17115163e+00  7.17115163e+00
  1.35387777e+01  3.31437485e+01  3.31437485e+01  3.31437485e+01
  1.11019620e+02  1.28762714e+02  1.28762714e+02  1.28762714e+02
  4.83186158e+02  4.83186158e+02  4.83186158e+02  5.95785927e+02
  1.33500815e+03  1.33500815e+03  1.33500815e+03  2.66477405e+03
  3.02919857e+03  3.02919857e+03  3.02919857e+03  6.64960502e+03
  6.64960502e+03  6.64960502e+03  9.06967078e+03  2.54247424e+04
  7.61664664e+04]
E1 = -728.264599591562  E_coul = 201.52655744129385
cycle= 3 E= -526.738042150268  delta_E= -5.91e-05  |g|= 0.0063  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131732
diis-c [-5.85754051e-07 -1.25507123e-03  1.44706830e-01  8.56548241e-01]
  HOMO = -0.583177392619735  LUMO = 1.00465528095636
  mo_energy =
[-1.18578977e+02 -1.23101108e+01 -9.56187100e+00 -9.56187100e+00
 -9.56187100e+00 -1.27033558e+00 -5.83177393e-01 -5.83177393e-01
 -5.83177393e-01  1.00465528e+00  1.00638451e+00  1.00638451e+00
  1.00638451e+00  7.16739301e+00  7.16739301e+00  7.16739301e+00
  1.35339800e+01  3.31375628e+01  3.31375628e+01  3.31375628e+01
  1.11011303e+02  1.28754342e+02  1.28754342e+02  1.28754342e+02
  4.83176291e+02  4.83176291e+02  4.83176291e+02  5.95775708e+02
  1.33499769e+03  1.33499769e+03  1.33499769e+03  2.66476296e+03
  3.02918773e+03  3.02918773e+03  3.02918773e+03  6.64959379e+03
  6.64959379e+03  6.64959379e+03  9.06965933e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.2874820990905  E_coul = 201.549438015541
cycle= 4 E= -526.73804408355  delta_E= -1.93e-06  |g|= 9.66e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112436
diis-c [-4.11824133e-09  7.01706572e-05 -1.00335321e-02 -6.51145247e-02
  1.07507789e+00]
  HOMO = -0.583159000070968  LUMO = 1.00468918855142
  mo_energy =
[-1.18578937e+02 -1.23100464e+01 -9.56181996e+00 -9.56181996e+00
 -9.56181996e+00 -1.27029494e+00 -5.83159000e-01 -5.83159000e-01
 -5.83159000e-01  1.00468919e+00  1.00640017e+00  1.00640017e+00
  1.00640017e+00  7.16743445e+00  7.16743445e+00  7.16743445e+00
  1.35340398e+01  3.31376117e+01  3.31376117e+01  3.31376117e+01
  1.11011355e+02  1.28754390e+02  1.28754390e+02  1.28754390e+02
  4.83176331e+02  4.83176331e+02  4.83176331e+02  5.95775740e+02
  1.33499773e+03  1.33499773e+03  1.33499773e+03  2.66476297e+03
  3.02918775e+03  3.02918775e+03  3.02918775e+03  6.64959379e+03
  6.64959379e+03  6.64959379e+03  9.06965933e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.287270681632  E_coul = 201.54922659645285
cycle= 5 E= -526.738044085179  delta_E= -1.63e-09  |g|= 2.05e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8696e-05
diis-c [-7.36052108e-11  1.43193849e-05 -1.84424709e-03 -1.38113496e-02
  4.33782716e-02  9.72263006e-01]
  HOMO = -0.583166374989424  LUMO = 1.00468521805047
  mo_energy =
[-1.18578968e+02 -1.23100687e+01 -9.56184421e+00 -9.56184421e+00
 -9.56184421e+00 -1.27030082e+00 -5.83166375e-01 -5.83166375e-01
 -5.83166375e-01  1.00468522e+00  1.00639533e+00  1.00639533e+00
  1.00639533e+00  7.16741812e+00  7.16741812e+00  7.16741812e+00
  1.35340212e+01  3.31375881e+01  3.31375881e+01  3.31375881e+01
  1.11011327e+02  1.28754362e+02  1.28754362e+02  1.28754362e+02
  4.83176301e+02  4.83176301e+02  4.83176301e+02  5.95775709e+02
  1.33499769e+03  1.33499769e+03  1.33499769e+03  2.66476294e+03
  3.02918772e+03  3.02918772e+03  3.02918772e+03  6.64959376e+03
  6.64959376e+03  6.64959376e+03  9.06965929e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.2873516819255  E_coul = 201.54930759668895
cycle= 6 E= -526.738044085237  delta_E= -5.75e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2873516819255  E_coul = 201.54930759668895
  HOMO = -0.583166399875403  LUMO = 1.00468555554714
  mo_energy =
[-1.18578967e+02 -1.23100686e+01 -9.56184417e+00 -9.56184417e+00
 -9.56184417e+00 -1.27030046e+00 -5.83166400e-01 -5.83166400e-01
 -5.83166400e-01  1.00468556e+00  1.00639536e+00  1.00639536e+00
  1.00639536e+00  7.16741816e+00  7.16741816e+00  7.16741816e+00
  1.35340214e+01  3.31375882e+01  3.31375882e+01  3.31375882e+01
  1.11011327e+02  1.28754362e+02  1.28754362e+02  1.28754362e+02
  4.83176301e+02  4.83176301e+02  4.83176301e+02  5.95775710e+02
  1.33499770e+03  1.33499770e+03  1.33499770e+03  2.66476294e+03
  3.02918772e+03  3.02918772e+03  3.02918772e+03  6.64959376e+03
  6.64959376e+03  6.64959376e+03  9.06965929e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.2873507739514  E_coul = 201.5493066887149
Extra cycle  E= -526.738044085237  delta_E= 1.14e-13  |g|= 3.61e-07  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103797.71467771463
E1 = -728.2873507739514  E_coul = 201.5493066887149
init E= -526.738044085237
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.583166429063591  LUMO = 1.00468560386081
  mo_energy =
[-1.18578968e+02 -1.23100687e+01 -9.56184426e+00 -9.56184426e+00
 -9.56184426e+00 -1.27030041e+00 -5.83166429e-01 -5.83166429e-01
 -5.83166429e-01  1.00468560e+00  1.00639536e+00  1.00639536e+00
  1.00639536e+00  7.16741811e+00  7.16741811e+00  7.16741811e+00
  1.35340214e+01  3.31375881e+01  3.31375881e+01  3.31375881e+01
  1.11011327e+02  1.28754362e+02  1.28754362e+02  1.28754362e+02
  4.83176301e+02  4.83176301e+02  4.83176301e+02  5.95775709e+02
  1.33499769e+03  1.33499769e+03  1.33499769e+03  2.66476294e+03
  3.02918772e+03  3.02918772e+03  3.02918772e+03  6.64959376e+03
  6.64959376e+03  6.64959376e+03  9.06965929e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.2873509195839  E_coul = 201.54930683434637
cycle= 1 E= -526.738044085238  delta_E= -1.02e-12  |g|= 7.54e-08  |ddm|= 6.03e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2873509195839  E_coul = 201.54930683434637
  HOMO = -0.583166428803477  LUMO = 1.00468561912513
  mo_energy =
[-1.18578968e+02 -1.23100687e+01 -9.56184425e+00 -9.56184425e+00
 -9.56184425e+00 -1.27030039e+00 -5.83166429e-01 -5.83166429e-01
 -5.83166429e-01  1.00468562e+00  1.00639536e+00  1.00639536e+00
  1.00639536e+00  7.16741811e+00  7.16741811e+00  7.16741811e+00
  1.35340214e+01  3.31375881e+01  3.31375881e+01  3.31375881e+01
  1.11011327e+02  1.28754362e+02  1.28754362e+02  1.28754362e+02
  4.83176301e+02  4.83176301e+02  4.83176301e+02  5.95775709e+02
  1.33499769e+03  1.33499769e+03  1.33499769e+03  2.66476294e+03
  3.02918772e+03  3.02918772e+03  3.02918772e+03  6.64959376e+03
  6.64959376e+03  6.64959376e+03  9.06965929e+03  2.54247308e+04
  7.61664546e+04]
E1 = -728.2873508558718  E_coul = 201.54930677063453
Extra cycle  E= -526.738044085237  delta_E= 3.41e-13  |g|= 1.52e-08  |ddm|= 1.27e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.37 sec
exp = [2.61826576e+04 7.61751825e+03 3.61735271e+03 1.59775061e+03
 3.82767796e+02 1.09470107e+02 3.59654192e+01 8.73828603e+00
 3.34643580e+00 6.61739066e-01 2.44826780e-01 1.36278378e+03
 6.64740004e+02 3.00935227e+02 3.14019197e+02 6.16360574e+01
 7.28469873e+00 2.02784785e+01 7.71182880e-01 2.76548787e+00
 2.21711679e-01]
grad_E = [-1.52473040e-06  3.38508958e-06 -1.54081209e-06  7.20701884e-05
 -7.69384761e-05 -6.95732885e-04 -9.81824897e-04  1.61091068e-03
  3.02538830e-05  1.26262772e-04  2.26845098e-04 -4.89164553e-07
  5.24612508e-06  2.50663173e-05  2.16062188e-05 -1.76307395e-04
 -1.05279683e-03  1.04330013e-03 -4.95953699e-04 -2.08913091e-03
  8.83689196e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.657515         1
[INPUT] 0    0    [1    /1   ]  7617.51836824        1
[INPUT] 0    0    [1    /1   ]  3617.35264872        1
[INPUT] 0    0    [1    /1   ]  1597.75300129        1
[INPUT] 0    0    [1    /1   ]  382.770414668        1
[INPUT] 0    0    [1    /1   ]  109.429924995        1
[INPUT] 0    0    [1    /1   ]  35.9174874314        1
[INPUT] 0    0    [1    /1   ]  8.68109929482        1
[INPUT] 0    0    [1    /1   ]  3.33670273739        1
[INPUT] 0    0    [1    /1   ]  0.662346076034       1
[INPUT] 0    0    [1    /1   ]  0.244943828632       1
[INPUT] 1    0    [1    /1   ]  1362.78376377        1
[INPUT] 1    0    [1    /1   ]  664.740184135        1
[INPUT] 1    0    [1    /1   ]  300.936075502        1
[INPUT] 1    0    [1    /1   ]  314.019929341        1
[INPUT] 1    0    [1    /1   ]  61.6361545009        1
[INPUT] 1    0    [1    /1   ]  7.29237326636        1
[INPUT] 1    0    [1    /1   ]  20.2734038866        1
[INPUT] 1    0    [1    /1   ]  0.771517819876       1
[INPUT] 1    0    [1    /1   ]  2.76845441595        1
[INPUT] 1    0    [1    /1   ]  0.221887464701       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657514990762, 1.0]], [0, [7617.518368235502, 1.0]], [0, [3617.3526487226986, 1.0]], [0, [1597.7530012873008, 1.0]], [0, [382.7704146676481, 1.0]], [0, [109.42992499498945, 1.0]], [0, [35.9174874313638, 1.0]], [0, [8.681099294817184, 1.0]], [0, [3.3367027373949427, 1.0]], [0, [0.6623460760344294, 1.0]], [0, [0.24494382863196132, 1.0]], [1, [1362.7837637696027, 1.0]], [1, [664.7401841346771, 1.0]], [1, [300.9360755019893, 1.0]], [1, [314.0199293407218, 1.0]], [1, [61.636154500944606, 1.0]], [1, [7.292373266361136, 1.0]], [1, [20.27340388663402, 1.0]], [1, [0.7715178198759265, 1.0]], [1, [2.768454415948171, 1.0]], [1, [0.2218874647012443, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65751499]
bas 1, expnt(s) = [7617.51836824]
bas 2, expnt(s) = [3617.35264872]
bas 3, expnt(s) = [1597.75300129]
bas 4, expnt(s) = [382.77041467]
bas 5, expnt(s) = [109.42992499]
bas 6, expnt(s) = [35.91748743]
bas 7, expnt(s) = [8.68109929]
bas 8, expnt(s) = [3.33670274]
bas 9, expnt(s) = [0.66234608]
bas 10, expnt(s) = [0.24494383]
bas 11, expnt(s) = [1362.78376377]
bas 12, expnt(s) = [664.74018413]
bas 13, expnt(s) = [300.9360755]
bas 14, expnt(s) = [314.01992934]
bas 15, expnt(s) = [61.6361545]
bas 16, expnt(s) = [7.29237327]
bas 17, expnt(s) = [20.27340389]
bas 18, expnt(s) = [0.77151782]
bas 19, expnt(s) = [2.76845442]
bas 20, expnt(s) = [0.22188746]
CPU time:       205.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026311e+03 7.61751837e+03 2.06003765e+03
 3.61735265e+03 1.17844186e+03 1.59775300e+03 6.38479938e+02
 3.82770415e+02 2.18634552e+02 1.09429925e+02 8.54805092e+01
 3.59174874e+01 3.70676015e+01 8.68109929e+00 1.27775052e+01
 3.33670274e+00 6.23739377e+00 6.62346076e-01 1.85493523e+00
 2.44943829e-01 8.79660114e-01 1.36278376e+03 2.41556140e+04
 6.64740184e+02 9.84689504e+03 3.00936076e+02 3.65659793e+03
 3.14019929e+02 3.85638964e+03 6.16361545e+01 5.03823953e+02
 7.29237327e+00 3.49599261e+01 2.02734039e+01 1.25499713e+02
 7.71517820e-01 2.10943838e+00 2.76845442e+00 1.04179223e+01
 2.21887465e-01 4.44273442e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99369177017514
cond(S) = 103782.14397522448
E1 = -729.5292581156724  E_coul = 203.17859309397826
init E= -526.350665021694
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55581732244982  LUMO = 1.02592199509631
  mo_energy =
[-1.18328476e+02 -1.22044743e+01 -9.44677910e+00 -9.44677910e+00
 -9.44677910e+00 -1.23999313e+00 -5.55817322e-01 -5.55817322e-01
 -5.55817322e-01  1.02592200e+00  1.02592200e+00  1.02592200e+00
  1.02735121e+00  7.24703827e+00  7.24703827e+00  7.24703827e+00
  1.35346060e+01  3.32851090e+01  3.32851090e+01  3.32851090e+01
  1.10813311e+02  1.28959714e+02  1.28959714e+02  1.28959714e+02
  4.83442286e+02  4.83442286e+02  4.83442286e+02  5.95527719e+02
  1.33531573e+03  1.33531573e+03  1.33531573e+03  2.66466027e+03
  3.02957106e+03  3.02957106e+03  3.02957106e+03  6.65008936e+03
  6.65008936e+03  6.65008936e+03  9.06971205e+03  2.54249045e+04
  7.61667512e+04]
E1 = -727.8427795934367  E_coul = 201.10548967131828
cycle= 1 E= -526.737289922118  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541106
diis-c [-0.2927952  1.       ]
  HOMO = -0.590720660618129  LUMO = 0.998480166978609
  mo_energy =
[-1.18636626e+02 -1.23422628e+01 -9.59528645e+00 -9.59528645e+00
 -9.59528645e+00 -1.27948652e+00 -5.90720661e-01 -5.90720661e-01
 -5.90720661e-01  9.98480167e-01  1.00178906e+00  1.00178906e+00
  1.00178906e+00  7.15689482e+00  7.15689482e+00  7.15689482e+00
  1.34211048e+01  3.31309329e+01  3.31309329e+01  3.31309329e+01
  1.10592029e+02  1.28731042e+02  1.28731042e+02  1.28731042e+02
  4.83135279e+02  4.83135279e+02  4.83135279e+02  5.95182627e+02
  1.33495211e+03  1.33495211e+03  1.33495211e+03  2.66416243e+03
  3.02914131e+03  3.02914131e+03  3.02914131e+03  6.64954636e+03
  6.64954636e+03  6.64954636e+03  9.06909383e+03  2.54241922e+04
  7.61659488e+04]
E1 = -728.4169576194606  E_coul = 201.6789484491296
cycle= 2 E= -526.738009170331  delta_E= -0.000719  |g|= 0.0376  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750621
diis-c [-0.00329839  0.0824233   0.9175767 ]
  HOMO = -0.581595094870134  LUMO = 1.00675805209578
  mo_energy =
[-1.18568916e+02 -1.23042058e+01 -9.55557895e+00 -9.55557895e+00
 -9.55557895e+00 -1.26856389e+00 -5.81595095e-01 -5.81595095e-01
 -5.81595095e-01  1.00675805e+00  1.00846701e+00  1.00846701e+00
  1.00846701e+00  7.18047129e+00  7.18047129e+00  7.18047129e+00
  1.34522043e+01  3.31709935e+01  3.31709935e+01  3.31709935e+01
  1.10647886e+02  1.28786956e+02  1.28786956e+02  1.28786956e+02
  4.83202178e+02  4.83202178e+02  4.83202178e+02  5.95251866e+02
  1.33502306e+03  1.33502306e+03  1.33502306e+03  2.66423668e+03
  3.02921449e+03  3.02921449e+03  3.02921449e+03  6.64962128e+03
  6.64962128e+03  6.64962128e+03  9.06916957e+03  2.54242685e+04
  7.61660254e+04]
E1 = -728.2664675355521  E_coul = 201.52839939963062
cycle= 3 E= -526.738068135921  delta_E= -5.9e-05  |g|= 0.00629  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131579
diis-c [-5.84239095e-07 -1.25441400e-03  1.44664955e-01  8.56589459e-01]
  HOMO = -0.583097259309416  LUMO = 1.0054912086538
  mo_energy =
[-1.18578885e+02 -1.23100219e+01 -9.56174072e+00 -9.56174072e+00
 -9.56174072e+00 -1.27026072e+00 -5.83097259e-01 -5.83097259e-01
 -5.83097259e-01  1.00549121e+00  1.00739157e+00  1.00739157e+00
  1.00739157e+00  7.17671622e+00  7.17671622e+00  7.17671622e+00
  1.34474270e+01  3.31648159e+01  3.31648159e+01  3.31648159e+01
  1.10639582e+02  1.28778596e+02  1.28778596e+02  1.28778596e+02
  4.83192324e+02  4.83192324e+02  4.83192324e+02  5.95241660e+02
  1.33501261e+03  1.33501261e+03  1.33501261e+03  2.66422561e+03
  3.02920366e+03  3.02920366e+03  3.02920366e+03  6.64961006e+03
  6.64961006e+03  6.64961006e+03  9.06915814e+03  2.54242569e+04
  7.61660137e+04]
E1 = -728.2893102070302  E_coul = 201.55124014407158
cycle= 4 E= -526.738070062959  delta_E= -1.93e-06  |g|= 9.66e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112086
diis-c [-4.10759210e-09  7.01024406e-05 -1.00335495e-02 -6.51070645e-02
  1.07507051e+00]
  HOMO = -0.583078821971352  LUMO = 1.00552516798627
  mo_energy =
[-1.18578845e+02 -1.23099574e+01 -9.56168956e+00 -9.56168956e+00
 -9.56168956e+00 -1.27022002e+00 -5.83078822e-01 -5.83078822e-01
 -5.83078822e-01  1.00552517e+00  1.00740728e+00  1.00740728e+00
  1.00740728e+00  7.17675776e+00  7.17675776e+00  7.17675776e+00
  1.34474868e+01  3.31648649e+01  3.31648649e+01  3.31648649e+01
  1.10639634e+02  1.28778644e+02  1.28778644e+02  1.28778644e+02
  4.83192364e+02  4.83192364e+02  4.83192364e+02  5.95241693e+02
  1.33501264e+03  1.33501264e+03  1.33501264e+03  2.66422562e+03
  3.02920369e+03  3.02920369e+03  3.02920369e+03  6.64961007e+03
  6.64961007e+03  6.64961007e+03  9.06915813e+03  2.54242569e+04
  7.61660137e+04]
E1 = -728.2890984458246  E_coul = 201.55102838123372
cycle= 5 E= -526.738070064591  delta_E= -1.63e-09  |g|= 2.05e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86726e-05
diis-c [-7.35966622e-11  1.43315934e-05 -1.84530704e-03 -1.38213831e-02
  4.32629239e-02  9.72389435e-01]
  HOMO = -0.583086190589988  LUMO = 1.00552120445711
  mo_energy =
[-1.18578875e+02 -1.23099798e+01 -9.56171380e+00 -9.56171380e+00
 -9.56171380e+00 -1.27022589e+00 -5.83086191e-01 -5.83086191e-01
 -5.83086191e-01  1.00552120e+00  1.00740244e+00  1.00740244e+00
  1.00740244e+00  7.17674144e+00  7.17674144e+00  7.17674144e+00
  1.34474683e+01  3.31648414e+01  3.31648414e+01  3.31648414e+01
  1.10639606e+02  1.28778616e+02  1.28778616e+02  1.28778616e+02
  4.83192334e+02  4.83192334e+02  4.83192334e+02  5.95241662e+02
  1.33501261e+03  1.33501261e+03  1.33501261e+03  2.66422559e+03
  3.02920365e+03  3.02920365e+03  3.02920365e+03  6.64961003e+03
  6.64961003e+03  6.64961003e+03  9.06915810e+03  2.54242569e+04
  7.61660136e+04]
E1 = -728.2891793400249  E_coul = 201.55110927537558
cycle= 6 E= -526.738070064649  delta_E= -5.85e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2891793400249  E_coul = 201.55110927537558
  HOMO = -0.583086215840354  LUMO = 1.00552154115514
  mo_energy =
[-1.18578875e+02 -1.23099796e+01 -9.56171376e+00 -9.56171376e+00
 -9.56171376e+00 -1.27022553e+00 -5.83086216e-01 -5.83086216e-01
 -5.83086216e-01  1.00552154e+00  1.00740247e+00  1.00740247e+00
  1.00740247e+00  7.17674147e+00  7.17674147e+00  7.17674147e+00
  1.34474685e+01  3.31648415e+01  3.31648415e+01  3.31648415e+01
  1.10639607e+02  1.28778616e+02  1.28778616e+02  1.28778616e+02
  4.83192334e+02  4.83192334e+02  4.83192334e+02  5.95241662e+02
  1.33501261e+03  1.33501261e+03  1.33501261e+03  2.66422559e+03
  3.02920365e+03  3.02920365e+03  3.02920365e+03  6.64961003e+03
  6.64961003e+03  6.64961003e+03  9.06915810e+03  2.54242569e+04
  7.61660136e+04]
E1 = -728.2891784333276  E_coul = 201.55110836867954
Extra cycle  E= -526.738070064648  delta_E= 1.25e-12  |g|= 3.6e-07  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826575e+04 7.61751837e+03 3.61735265e+03 1.59775300e+03
 3.82770415e+02 1.09429925e+02 3.59174874e+01 8.68109929e+00
 3.33670274e+00 6.62346076e-01 2.44943829e-01 1.36278376e+03
 6.64740184e+02 3.00936076e+02 3.14019929e+02 6.16361545e+01
 7.29237327e+00 2.02734039e+01 7.71517820e-01 2.76845442e+00
 2.21887465e-01]
E = -526.7380700646481
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.657515         1
[INPUT] 0    0    [1    /1   ]  7617.51836824        1
[INPUT] 0    0    [1    /1   ]  3617.35264872        1
[INPUT] 0    0    [1    /1   ]  1597.75300129        1
[INPUT] 0    0    [1    /1   ]  382.770414668        1
[INPUT] 0    0    [1    /1   ]  109.429924995        1
[INPUT] 0    0    [1    /1   ]  35.9174874314        1
[INPUT] 0    0    [1    /1   ]  8.68109929482        1
[INPUT] 0    0    [1    /1   ]  3.33670273739        1
[INPUT] 0    0    [1    /1   ]  0.662346076034       1
[INPUT] 0    0    [1    /1   ]  0.244943828632       1
[INPUT] 1    0    [1    /1   ]  1362.78376377        1
[INPUT] 1    0    [1    /1   ]  664.740184135        1
[INPUT] 1    0    [1    /1   ]  300.936075502        1
[INPUT] 1    0    [1    /1   ]  314.019929341        1
[INPUT] 1    0    [1    /1   ]  61.6361545009        1
[INPUT] 1    0    [1    /1   ]  7.29237326636        1
[INPUT] 1    0    [1    /1   ]  20.2734038866        1
[INPUT] 1    0    [1    /1   ]  0.771517819876       1
[INPUT] 1    0    [1    /1   ]  2.76845441595        1
[INPUT] 1    0    [1    /1   ]  0.221887464701       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657514990762, 1.0]], [0, [7617.518368235502, 1.0]], [0, [3617.3526487226986, 1.0]], [0, [1597.7530012873008, 1.0]], [0, [382.7704146676481, 1.0]], [0, [109.42992499498945, 1.0]], [0, [35.9174874313638, 1.0]], [0, [8.681099294817184, 1.0]], [0, [3.3367027373949427, 1.0]], [0, [0.6623460760344294, 1.0]], [0, [0.24494382863196132, 1.0]], [1, [1362.7837637696027, 1.0]], [1, [664.7401841346771, 1.0]], [1, [300.9360755019893, 1.0]], [1, [314.0199293407218, 1.0]], [1, [61.636154500944606, 1.0]], [1, [7.292373266361136, 1.0]], [1, [20.27340388663402, 1.0]], [1, [0.7715178198759265, 1.0]], [1, [2.768454415948171, 1.0]], [1, [0.2218874647012443, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65751499]
bas 1, expnt(s) = [7617.51836824]
bas 2, expnt(s) = [3617.35264872]
bas 3, expnt(s) = [1597.75300129]
bas 4, expnt(s) = [382.77041467]
bas 5, expnt(s) = [109.42992499]
bas 6, expnt(s) = [35.91748743]
bas 7, expnt(s) = [8.68109929]
bas 8, expnt(s) = [3.33670274]
bas 9, expnt(s) = [0.66234608]
bas 10, expnt(s) = [0.24494383]
bas 11, expnt(s) = [1362.78376377]
bas 12, expnt(s) = [664.74018413]
bas 13, expnt(s) = [300.9360755]
bas 14, expnt(s) = [314.01992934]
bas 15, expnt(s) = [61.6361545]
bas 16, expnt(s) = [7.29237327]
bas 17, expnt(s) = [20.27340389]
bas 18, expnt(s) = [0.77151782]
bas 19, expnt(s) = [2.76845442]
bas 20, expnt(s) = [0.22188746]
CPU time:       205.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026311e+03 7.61751837e+03 2.06003765e+03
 3.61735265e+03 1.17844186e+03 1.59775300e+03 6.38479938e+02
 3.82770415e+02 2.18634552e+02 1.09429925e+02 8.54805092e+01
 3.59174874e+01 3.70676015e+01 8.68109929e+00 1.27775052e+01
 3.33670274e+00 6.23739377e+00 6.62346076e-01 1.85493523e+00
 2.44943829e-01 8.79660114e-01 1.36278376e+03 2.41556140e+04
 6.64740184e+02 9.84689504e+03 3.00936076e+02 3.65659793e+03
 3.14019929e+02 3.85638964e+03 6.16361545e+01 5.03823953e+02
 7.29237327e+00 3.49599261e+01 2.02734039e+01 1.25499713e+02
 7.71517820e-01 2.10943838e+00 2.76845442e+00 1.04179223e+01
 2.21887465e-01 4.44273442e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99369177017514
cond(S) = 103782.14397522448
E1 = -729.5292581156724  E_coul = 203.17859309397826
init E= -526.350665021694
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55581732244982  LUMO = 1.02592199509631
  mo_energy =
[-1.18328476e+02 -1.22044743e+01 -9.44677910e+00 -9.44677910e+00
 -9.44677910e+00 -1.23999313e+00 -5.55817322e-01 -5.55817322e-01
 -5.55817322e-01  1.02592200e+00  1.02592200e+00  1.02592200e+00
  1.02735121e+00  7.24703827e+00  7.24703827e+00  7.24703827e+00
  1.35346060e+01  3.32851090e+01  3.32851090e+01  3.32851090e+01
  1.10813311e+02  1.28959714e+02  1.28959714e+02  1.28959714e+02
  4.83442286e+02  4.83442286e+02  4.83442286e+02  5.95527719e+02
  1.33531573e+03  1.33531573e+03  1.33531573e+03  2.66466027e+03
  3.02957106e+03  3.02957106e+03  3.02957106e+03  6.65008936e+03
  6.65008936e+03  6.65008936e+03  9.06971205e+03  2.54249045e+04
  7.61667512e+04]
E1 = -727.8427795934367  E_coul = 201.10548967131828
cycle= 1 E= -526.737289922118  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541106
diis-c [-0.2927952  1.       ]
  HOMO = -0.590720660618129  LUMO = 0.998480166978609
  mo_energy =
[-1.18636626e+02 -1.23422628e+01 -9.59528645e+00 -9.59528645e+00
 -9.59528645e+00 -1.27948652e+00 -5.90720661e-01 -5.90720661e-01
 -5.90720661e-01  9.98480167e-01  1.00178906e+00  1.00178906e+00
  1.00178906e+00  7.15689482e+00  7.15689482e+00  7.15689482e+00
  1.34211048e+01  3.31309329e+01  3.31309329e+01  3.31309329e+01
  1.10592029e+02  1.28731042e+02  1.28731042e+02  1.28731042e+02
  4.83135279e+02  4.83135279e+02  4.83135279e+02  5.95182627e+02
  1.33495211e+03  1.33495211e+03  1.33495211e+03  2.66416243e+03
  3.02914131e+03  3.02914131e+03  3.02914131e+03  6.64954636e+03
  6.64954636e+03  6.64954636e+03  9.06909383e+03  2.54241922e+04
  7.61659488e+04]
E1 = -728.4169576194606  E_coul = 201.6789484491296
cycle= 2 E= -526.738009170331  delta_E= -0.000719  |g|= 0.0376  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750621
diis-c [-0.00329839  0.0824233   0.9175767 ]
  HOMO = -0.581595094870134  LUMO = 1.00675805209578
  mo_energy =
[-1.18568916e+02 -1.23042058e+01 -9.55557895e+00 -9.55557895e+00
 -9.55557895e+00 -1.26856389e+00 -5.81595095e-01 -5.81595095e-01
 -5.81595095e-01  1.00675805e+00  1.00846701e+00  1.00846701e+00
  1.00846701e+00  7.18047129e+00  7.18047129e+00  7.18047129e+00
  1.34522043e+01  3.31709935e+01  3.31709935e+01  3.31709935e+01
  1.10647886e+02  1.28786956e+02  1.28786956e+02  1.28786956e+02
  4.83202178e+02  4.83202178e+02  4.83202178e+02  5.95251866e+02
  1.33502306e+03  1.33502306e+03  1.33502306e+03  2.66423668e+03
  3.02921449e+03  3.02921449e+03  3.02921449e+03  6.64962128e+03
  6.64962128e+03  6.64962128e+03  9.06916957e+03  2.54242685e+04
  7.61660254e+04]
E1 = -728.2664675355521  E_coul = 201.52839939963062
cycle= 3 E= -526.738068135921  delta_E= -5.9e-05  |g|= 0.00629  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131579
diis-c [-5.84239095e-07 -1.25441400e-03  1.44664955e-01  8.56589459e-01]
  HOMO = -0.583097259309416  LUMO = 1.0054912086538
  mo_energy =
[-1.18578885e+02 -1.23100219e+01 -9.56174072e+00 -9.56174072e+00
 -9.56174072e+00 -1.27026072e+00 -5.83097259e-01 -5.83097259e-01
 -5.83097259e-01  1.00549121e+00  1.00739157e+00  1.00739157e+00
  1.00739157e+00  7.17671622e+00  7.17671622e+00  7.17671622e+00
  1.34474270e+01  3.31648159e+01  3.31648159e+01  3.31648159e+01
  1.10639582e+02  1.28778596e+02  1.28778596e+02  1.28778596e+02
  4.83192324e+02  4.83192324e+02  4.83192324e+02  5.95241660e+02
  1.33501261e+03  1.33501261e+03  1.33501261e+03  2.66422561e+03
  3.02920366e+03  3.02920366e+03  3.02920366e+03  6.64961006e+03
  6.64961006e+03  6.64961006e+03  9.06915814e+03  2.54242569e+04
  7.61660137e+04]
E1 = -728.2893102070302  E_coul = 201.55124014407158
cycle= 4 E= -526.738070062959  delta_E= -1.93e-06  |g|= 9.66e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112086
diis-c [-4.10759210e-09  7.01024406e-05 -1.00335495e-02 -6.51070645e-02
  1.07507051e+00]
  HOMO = -0.583078821971352  LUMO = 1.00552516798627
  mo_energy =
[-1.18578845e+02 -1.23099574e+01 -9.56168956e+00 -9.56168956e+00
 -9.56168956e+00 -1.27022002e+00 -5.83078822e-01 -5.83078822e-01
 -5.83078822e-01  1.00552517e+00  1.00740728e+00  1.00740728e+00
  1.00740728e+00  7.17675776e+00  7.17675776e+00  7.17675776e+00
  1.34474868e+01  3.31648649e+01  3.31648649e+01  3.31648649e+01
  1.10639634e+02  1.28778644e+02  1.28778644e+02  1.28778644e+02
  4.83192364e+02  4.83192364e+02  4.83192364e+02  5.95241693e+02
  1.33501264e+03  1.33501264e+03  1.33501264e+03  2.66422562e+03
  3.02920369e+03  3.02920369e+03  3.02920369e+03  6.64961007e+03
  6.64961007e+03  6.64961007e+03  9.06915813e+03  2.54242569e+04
  7.61660137e+04]
E1 = -728.2890984458246  E_coul = 201.55102838123372
cycle= 5 E= -526.738070064591  delta_E= -1.63e-09  |g|= 2.05e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86726e-05
diis-c [-7.35966622e-11  1.43315934e-05 -1.84530704e-03 -1.38213831e-02
  4.32629239e-02  9.72389435e-01]
  HOMO = -0.583086190589988  LUMO = 1.00552120445711
  mo_energy =
[-1.18578875e+02 -1.23099798e+01 -9.56171380e+00 -9.56171380e+00
 -9.56171380e+00 -1.27022589e+00 -5.83086191e-01 -5.83086191e-01
 -5.83086191e-01  1.00552120e+00  1.00740244e+00  1.00740244e+00
  1.00740244e+00  7.17674144e+00  7.17674144e+00  7.17674144e+00
  1.34474683e+01  3.31648414e+01  3.31648414e+01  3.31648414e+01
  1.10639606e+02  1.28778616e+02  1.28778616e+02  1.28778616e+02
  4.83192334e+02  4.83192334e+02  4.83192334e+02  5.95241662e+02
  1.33501261e+03  1.33501261e+03  1.33501261e+03  2.66422559e+03
  3.02920365e+03  3.02920365e+03  3.02920365e+03  6.64961003e+03
  6.64961003e+03  6.64961003e+03  9.06915810e+03  2.54242569e+04
  7.61660136e+04]
E1 = -728.2891793400249  E_coul = 201.55110927537558
cycle= 6 E= -526.738070064649  delta_E= -5.85e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2891793400249  E_coul = 201.55110927537558
  HOMO = -0.583086215840354  LUMO = 1.00552154115514
  mo_energy =
[-1.18578875e+02 -1.23099796e+01 -9.56171376e+00 -9.56171376e+00
 -9.56171376e+00 -1.27022553e+00 -5.83086216e-01 -5.83086216e-01
 -5.83086216e-01  1.00552154e+00  1.00740247e+00  1.00740247e+00
  1.00740247e+00  7.17674147e+00  7.17674147e+00  7.17674147e+00
  1.34474685e+01  3.31648415e+01  3.31648415e+01  3.31648415e+01
  1.10639607e+02  1.28778616e+02  1.28778616e+02  1.28778616e+02
  4.83192334e+02  4.83192334e+02  4.83192334e+02  5.95241662e+02
  1.33501261e+03  1.33501261e+03  1.33501261e+03  2.66422559e+03
  3.02920365e+03  3.02920365e+03  3.02920365e+03  6.64961003e+03
  6.64961003e+03  6.64961003e+03  9.06915810e+03  2.54242569e+04
  7.61660136e+04]
E1 = -728.2891784333276  E_coul = 201.55110836867954
Extra cycle  E= -526.738070064648  delta_E= 1.25e-12  |g|= 3.6e-07  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103782.14397522448
E1 = -728.2891784333276  E_coul = 201.55110836867954
init E= -526.738070064648
    CPU time for initialize scf      0.92 sec, wall time      0.24 sec
  HOMO = -0.583086244985576  LUMO = 1.00552158939091
  mo_energy =
[-1.18578875e+02 -1.23099797e+01 -9.56171385e+00 -9.56171385e+00
 -9.56171385e+00 -1.27022548e+00 -5.83086245e-01 -5.83086245e-01
 -5.83086245e-01  1.00552159e+00  1.00740247e+00  1.00740247e+00
  1.00740247e+00  7.17674142e+00  7.17674142e+00  7.17674142e+00
  1.34474684e+01  3.31648414e+01  3.31648414e+01  3.31648414e+01
  1.10639606e+02  1.28778616e+02  1.28778616e+02  1.28778616e+02
  4.83192334e+02  4.83192334e+02  4.83192334e+02  5.95241662e+02
  1.33501261e+03  1.33501261e+03  1.33501261e+03  2.66422559e+03
  3.02920365e+03  3.02920365e+03  3.02920365e+03  6.64961003e+03
  6.64961003e+03  6.64961003e+03  9.06915810e+03  2.54242569e+04
  7.61660136e+04]
E1 = -728.2891785785542  E_coul = 201.55110851390577
cycle= 1 E= -526.738070064648  delta_E= -3.41e-13  |g|= 7.53e-08  |ddm|= 6.02e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2891785785542  E_coul = 201.55110851390577
  HOMO = -0.583086244731659  LUMO = 1.00552160462359
  mo_energy =
[-1.18578875e+02 -1.23099797e+01 -9.56171384e+00 -9.56171384e+00
 -9.56171384e+00 -1.27022547e+00 -5.83086245e-01 -5.83086245e-01
 -5.83086245e-01  1.00552160e+00  1.00740247e+00  1.00740247e+00
  1.00740247e+00  7.17674142e+00  7.17674142e+00  7.17674142e+00
  1.34474685e+01  3.31648414e+01  3.31648414e+01  3.31648414e+01
  1.10639606e+02  1.28778616e+02  1.28778616e+02  1.28778616e+02
  4.83192334e+02  4.83192334e+02  4.83192334e+02  5.95241662e+02
  1.33501261e+03  1.33501261e+03  1.33501261e+03  2.66422559e+03
  3.02920365e+03  3.02920365e+03  3.02920365e+03  6.64961003e+03
  6.64961003e+03  6.64961003e+03  9.06915810e+03  2.54242569e+04
  7.61660136e+04]
E1 = -728.2891785149923  E_coul = 201.55110845034284
Extra cycle  E= -526.738070064649  delta_E= -1.02e-12  |g|= 1.52e-08  |ddm|= 1.26e-07
    CPU time for scf_cycle      1.24 sec, wall time      0.57 sec
exp = [2.61826575e+04 7.61751837e+03 3.61735265e+03 1.59775300e+03
 3.82770415e+02 1.09429925e+02 3.59174874e+01 8.68109929e+00
 3.33670274e+00 6.62346076e-01 2.44943829e-01 1.36278376e+03
 6.64740184e+02 3.00936076e+02 3.14019929e+02 6.16361545e+01
 7.29237327e+00 2.02734039e+01 7.71517820e-01 2.76845442e+00
 2.21887465e-01]
grad_E = [-1.52480834e-06  3.38615220e-06 -1.54013831e-06  7.21211572e-05
 -7.99548258e-05 -6.47297873e-04 -1.14642124e-03  1.28976546e-03
  8.57926482e-04  1.25731785e-04  3.44536491e-04 -4.92912249e-07
  5.19639819e-06  2.47642668e-05  2.13467004e-05 -1.42089280e-04
 -3.03059142e-04  7.64148798e-04 -1.40634012e-03 -2.66141945e-03
  3.94225420e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6574865        1
[INPUT] 0    0    [1    /1   ]  7617.51842892        1
[INPUT] 0    0    [1    /1   ]  3617.35261812        1
[INPUT] 0    0    [1    /1   ]  1597.7542434         1
[INPUT] 0    0    [1    /1   ]  382.771744999        1
[INPUT] 0    0    [1    /1   ]  109.411293169        1
[INPUT] 0    0    [1    /1   ]  35.8839838946        1
[INPUT] 0    0    [1    /1   ]  8.6393262922         1
[INPUT] 0    0    [1    /1   ]  3.32966029315        1
[INPUT] 0    0    [1    /1   ]  0.661499621438       1
[INPUT] 0    0    [1    /1   ]  0.244588472647       1
[INPUT] 1    0    [1    /1   ]  1362.78375414        1
[INPUT] 1    0    [1    /1   ]  664.740277466        1
[INPUT] 1    0    [1    /1   ]  300.936514278        1
[INPUT] 1    0    [1    /1   ]  314.020307674        1
[INPUT] 1    0    [1    /1   ]  61.6365374635        1
[INPUT] 1    0    [1    /1   ]  7.29868505761        1
[INPUT] 1    0    [1    /1   ]  20.2685620005        1
[INPUT] 1    0    [1    /1   ]  0.772037348803       1
[INPUT] 1    0    [1    /1   ]  2.77416111476        1
[INPUT] 1    0    [1    /1   ]  0.222021414573       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657486549386, 1.0]], [0, [7617.518428917377, 1.0]], [0, [3617.3526181151597, 1.0]], [0, [1597.754243401692, 1.0]], [0, [382.7717449989028, 1.0]], [0, [109.41129316880004, 1.0]], [0, [35.88398389463859, 1.0]], [0, [8.639326292196104, 1.0]], [0, [3.3296602931507246, 1.0]], [0, [0.6614996214383799, 1.0]], [0, [0.24458847264728467, 1.0]], [1, [1362.7837541433812, 1.0]], [1, [664.7402774656475, 1.0]], [1, [300.9365142784977, 1.0]], [1, [314.0203076741893, 1.0]], [1, [61.636537463545054, 1.0]], [1, [7.298685057614909, 1.0]], [1, [20.268562000516564, 1.0]], [1, [0.772037348802775, 1.0]], [1, [2.7741611147584915, 1.0]], [1, [0.22202141457339566, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65748655]
bas 1, expnt(s) = [7617.51842892]
bas 2, expnt(s) = [3617.35261812]
bas 3, expnt(s) = [1597.7542434]
bas 4, expnt(s) = [382.771745]
bas 5, expnt(s) = [109.41129317]
bas 6, expnt(s) = [35.88398389]
bas 7, expnt(s) = [8.63932629]
bas 8, expnt(s) = [3.32966029]
bas 9, expnt(s) = [0.66149962]
bas 10, expnt(s) = [0.24458847]
bas 11, expnt(s) = [1362.78375414]
bas 12, expnt(s) = [664.74027747]
bas 13, expnt(s) = [300.93651428]
bas 14, expnt(s) = [314.02030767]
bas 15, expnt(s) = [61.63653746]
bas 16, expnt(s) = [7.29868506]
bas 17, expnt(s) = [20.268562]
bas 18, expnt(s) = [0.77203735]
bas 19, expnt(s) = [2.77416111]
bas 20, expnt(s) = [0.22202141]
CPU time:       211.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026311e+03 7.61751843e+03 2.06003766e+03
 3.61735262e+03 1.17844185e+03 1.59775424e+03 6.38480310e+02
 3.82771745e+02 2.18635122e+02 1.09411293e+02 8.54695933e+01
 3.58839839e+01 3.70416662e+01 8.63932629e+00 1.27313639e+01
 3.32966029e+00 6.22751769e+00 6.61499621e-01 1.85315704e+00
 2.44588473e-01 8.78702806e-01 1.36278375e+03 2.41556138e+04
 6.64740277e+02 9.84689677e+03 3.00936514e+02 3.65660459e+03
 3.14020308e+02 3.85639544e+03 6.16365375e+01 5.03827866e+02
 7.29868506e+00 3.49977539e+01 2.02685620e+01 1.25462248e+02
 7.72037349e-01 2.11121412e+00 2.77416111e+00 1.04447727e+01
 2.22021415e-01 4.44608718e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99367881506542
cond(S) = 103768.7998381028
E1 = -729.5289088243361  E_coul = 203.17833747517898
init E= -526.350571349157
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555810763261431  LUMO = 1.02472702563888
  mo_energy =
[-1.18328484e+02 -1.22045136e+01 -9.44681335e+00 -9.44681335e+00
 -9.44681335e+00 -1.24000104e+00 -5.55810763e-01 -5.55810763e-01
 -5.55810763e-01  1.02472703e+00  1.02691892e+00  1.02691892e+00
  1.02691892e+00  7.26106892e+00  7.26106892e+00  7.26106892e+00
  1.34630577e+01  3.33194555e+01  3.33194555e+01  3.33194555e+01
  1.10541823e+02  1.28989573e+02  1.28989573e+02  1.28989573e+02
  4.83462891e+02  4.83462891e+02  4.83462891e+02  5.95164205e+02
  1.33533407e+03  1.33533407e+03  1.33533407e+03  2.66430529e+03
  3.02958908e+03  3.02958908e+03  3.02958908e+03  6.65010667e+03
  6.65010667e+03  6.65010667e+03  9.06938235e+03  2.54245928e+04
  7.61664611e+04]
E1 = -727.8438408380989  E_coul = 201.10652573417735
cycle= 1 E= -526.737315103922  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541124
diis-c [-0.2928153  1.       ]
  HOMO = -0.590686948803744  LUMO = 0.995952869360928
  mo_energy =
[-1.18636564e+02 -1.23421966e+01 -9.59520300e+00 -9.59520300e+00
 -9.59520300e+00 -1.27945987e+00 -5.90686949e-01 -5.90686949e-01
 -5.90686949e-01  9.95952869e-01  1.00278031e+00  1.00278031e+00
  1.00278031e+00  7.17090380e+00  7.17090380e+00  7.17090380e+00
  1.33498981e+01  3.31653695e+01  3.31653695e+01  3.31653695e+01
  1.10320759e+02  1.28761009e+02  1.28761009e+02  1.28761009e+02
  4.83155970e+02  4.83155970e+02  4.83155970e+02  5.94819153e+02
  1.33497049e+03  1.33497049e+03  1.33497049e+03  2.66380747e+03
  3.02915936e+03  3.02915936e+03  3.02915936e+03  6.64956368e+03
  6.64956368e+03  6.64956368e+03  9.06876413e+03  2.54238805e+04
  7.61656587e+04]
E1 = -728.4176196425897  E_coul = 201.6795860226063
cycle= 2 E= -526.738033619983  delta_E= -0.000719  |g|= 0.0376  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750394
diis-c [-0.00329457  0.08242694  0.91757306]
  HOMO = -0.581569567911164  LUMO = 1.00420527832639
  mo_energy =
[-1.18568893e+02 -1.23041675e+01 -9.55552312e+00 -9.55552312e+00
 -9.55552312e+00 -1.26854716e+00 -5.81569568e-01 -5.81569568e-01
 -5.81569568e-01  1.00420528e+00  1.00945973e+00  1.00945973e+00
  1.00945973e+00  7.19448547e+00  7.19448547e+00  7.19448547e+00
  1.33809066e+01  3.32054051e+01  3.32054051e+01  3.32054051e+01
  1.10376570e+02  1.28816887e+02  1.28816887e+02  1.28816887e+02
  4.83222830e+02  4.83222830e+02  4.83222830e+02  5.94888354e+02
  1.33504139e+03  1.33504139e+03  1.33504139e+03  2.66388168e+03
  3.02923250e+03  3.02923250e+03  3.02923250e+03  6.64963856e+03
  6.64963856e+03  6.64963856e+03  9.06883983e+03  2.54239568e+04
  7.61657353e+04]
E1 = -728.2672702157871  E_coul = 201.52917772130857
cycle= 3 E= -526.738092494479  delta_E= -5.89e-05  |g|= 0.00629  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131478
diis-c [-5.83459807e-07 -1.25381722e-03  1.44604215e-01  8.56649602e-01]
  HOMO = -0.583070059976575  LUMO = 1.00294286802671
  mo_energy =
[-1.18578853e+02 -1.23099780e+01 -9.56167887e+00 -9.56167887e+00
 -9.56167887e+00 -1.27024187e+00 -5.83070060e-01 -5.83070060e-01
 -5.83070060e-01  1.00294287e+00  1.00838434e+00  1.00838434e+00
  1.00838434e+00  7.19073068e+00  7.19073068e+00  7.19073068e+00
  1.33761440e+01  3.31992332e+01  3.31992332e+01  3.31992332e+01
  1.10368276e+02  1.28808535e+02  1.28808535e+02  1.28808535e+02
  4.83212985e+02  4.83212985e+02  4.83212985e+02  5.94878157e+02
  1.33503095e+03  1.33503095e+03  1.33503095e+03  2.66387062e+03
  3.02922168e+03  3.02922168e+03  3.02922168e+03  6.64962735e+03
  6.64962735e+03  6.64962735e+03  9.06882840e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.2900841492276  E_coul = 201.55198973218222
cycle= 4 E= -526.738094417045  delta_E= -1.92e-06  |g|= 9.66e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000111923
diis-c [-4.10401478e-09  7.01599170e-05 -1.00455104e-02 -6.51908230e-02
  1.07516617e+00]
  HOMO = -0.583051611992026  LUMO = 1.00297680838951
  mo_energy =
[-1.18578813e+02 -1.23099135e+01 -9.56162764e+00 -9.56162764e+00
 -9.56162764e+00 -1.27020112e+00 -5.83051612e-01 -5.83051612e-01
 -5.83051612e-01  1.00297681e+00  1.00840008e+00  1.00840008e+00
  1.00840008e+00  7.19077229e+00  7.19077229e+00  7.19077229e+00
  1.33762038e+01  3.31992823e+01  3.31992823e+01  3.31992823e+01
  1.10368328e+02  1.28808583e+02  1.28808583e+02  1.28808583e+02
  4.83213025e+02  4.83213025e+02  4.83213025e+02  5.94878190e+02
  1.33503099e+03  1.33503099e+03  1.33503099e+03  2.66387063e+03
  3.02922170e+03  3.02922170e+03  3.02922170e+03  6.64962736e+03
  6.64962736e+03  6.64962736e+03  9.06882840e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.2898719401531  E_coul = 201.5517775214696
cycle= 5 E= -526.738094418684  delta_E= -1.64e-09  |g|= 2.05e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86738e-05
diis-c [-7.37855641e-11  1.43481531e-05 -1.84681400e-03 -1.38368078e-02
  4.31954405e-02  9.72473833e-01]
  HOMO = -0.583058986051772  LUMO = 1.0029728544338
  mo_energy =
[-1.18578843e+02 -1.23099358e+01 -9.56165189e+00 -9.56165189e+00
 -9.56165189e+00 -1.27020700e+00 -5.83058986e-01 -5.83058986e-01
 -5.83058986e-01  1.00297285e+00  1.00839522e+00  1.00839522e+00
  1.00839522e+00  7.19075594e+00  7.19075594e+00  7.19075594e+00
  1.33761854e+01  3.31992588e+01  3.31992588e+01  3.31992588e+01
  1.10368300e+02  1.28808555e+02  1.28808555e+02  1.28808555e+02
  4.83212995e+02  4.83212995e+02  4.83212995e+02  5.94878159e+02
  1.33503096e+03  1.33503096e+03  1.33503096e+03  2.66387060e+03
  3.02922167e+03  3.02922167e+03  3.02922167e+03  6.64962732e+03
  6.64962732e+03  6.64962732e+03  9.06882837e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.2899527963968  E_coul = 201.55185837765634
cycle= 6 E= -526.738094418741  delta_E= -5.7e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2899527963968  E_coul = 201.55185837765634
  HOMO = -0.583059011873748  LUMO = 1.00297319033199
  mo_energy =
[-1.18578843e+02 -1.23099357e+01 -9.56165185e+00 -9.56165185e+00
 -9.56165185e+00 -1.27020663e+00 -5.83059012e-01 -5.83059012e-01
 -5.83059012e-01  1.00297319e+00  1.00839526e+00  1.00839526e+00
  1.00839526e+00  7.19075598e+00  7.19075598e+00  7.19075598e+00
  1.33761855e+01  3.31992588e+01  3.31992588e+01  3.31992588e+01
  1.10368301e+02  1.28808555e+02  1.28808555e+02  1.28808555e+02
  4.83212995e+02  4.83212995e+02  4.83212995e+02  5.94878159e+02
  1.33503096e+03  1.33503096e+03  1.33503096e+03  2.66387060e+03
  3.02922167e+03  3.02922167e+03  3.02922167e+03  6.64962732e+03
  6.64962732e+03  6.64962732e+03  9.06882837e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.289951882106  E_coul = 201.551857463365
Extra cycle  E= -526.738094418741  delta_E= -5.68e-13  |g|= 3.6e-07  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
exp = [2.61826575e+04 7.61751843e+03 3.61735262e+03 1.59775424e+03
 3.82771745e+02 1.09411293e+02 3.58839839e+01 8.63932629e+00
 3.32966029e+00 6.61499621e-01 2.44588473e-01 1.36278375e+03
 6.64740277e+02 3.00936514e+02 3.14020308e+02 6.16365375e+01
 7.29868506e+00 2.02685620e+01 7.72037349e-01 2.77416111e+00
 2.22021415e-01]
E = -526.7380944187411
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6574865        1
[INPUT] 0    0    [1    /1   ]  7617.51842892        1
[INPUT] 0    0    [1    /1   ]  3617.35261812        1
[INPUT] 0    0    [1    /1   ]  1597.7542434         1
[INPUT] 0    0    [1    /1   ]  382.771744999        1
[INPUT] 0    0    [1    /1   ]  109.411293169        1
[INPUT] 0    0    [1    /1   ]  35.8839838946        1
[INPUT] 0    0    [1    /1   ]  8.6393262922         1
[INPUT] 0    0    [1    /1   ]  3.32966029315        1
[INPUT] 0    0    [1    /1   ]  0.661499621438       1
[INPUT] 0    0    [1    /1   ]  0.244588472647       1
[INPUT] 1    0    [1    /1   ]  1362.78375414        1
[INPUT] 1    0    [1    /1   ]  664.740277466        1
[INPUT] 1    0    [1    /1   ]  300.936514278        1
[INPUT] 1    0    [1    /1   ]  314.020307674        1
[INPUT] 1    0    [1    /1   ]  61.6365374635        1
[INPUT] 1    0    [1    /1   ]  7.29868505761        1
[INPUT] 1    0    [1    /1   ]  20.2685620005        1
[INPUT] 1    0    [1    /1   ]  0.772037348803       1
[INPUT] 1    0    [1    /1   ]  2.77416111476        1
[INPUT] 1    0    [1    /1   ]  0.222021414573       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657486549386, 1.0]], [0, [7617.518428917377, 1.0]], [0, [3617.3526181151597, 1.0]], [0, [1597.754243401692, 1.0]], [0, [382.7717449989028, 1.0]], [0, [109.41129316880004, 1.0]], [0, [35.88398389463859, 1.0]], [0, [8.639326292196104, 1.0]], [0, [3.3296602931507246, 1.0]], [0, [0.6614996214383799, 1.0]], [0, [0.24458847264728467, 1.0]], [1, [1362.7837541433812, 1.0]], [1, [664.7402774656475, 1.0]], [1, [300.9365142784977, 1.0]], [1, [314.0203076741893, 1.0]], [1, [61.636537463545054, 1.0]], [1, [7.298685057614909, 1.0]], [1, [20.268562000516564, 1.0]], [1, [0.772037348802775, 1.0]], [1, [2.7741611147584915, 1.0]], [1, [0.22202141457339566, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65748655]
bas 1, expnt(s) = [7617.51842892]
bas 2, expnt(s) = [3617.35261812]
bas 3, expnt(s) = [1597.7542434]
bas 4, expnt(s) = [382.771745]
bas 5, expnt(s) = [109.41129317]
bas 6, expnt(s) = [35.88398389]
bas 7, expnt(s) = [8.63932629]
bas 8, expnt(s) = [3.32966029]
bas 9, expnt(s) = [0.66149962]
bas 10, expnt(s) = [0.24458847]
bas 11, expnt(s) = [1362.78375414]
bas 12, expnt(s) = [664.74027747]
bas 13, expnt(s) = [300.93651428]
bas 14, expnt(s) = [314.02030767]
bas 15, expnt(s) = [61.63653746]
bas 16, expnt(s) = [7.29868506]
bas 17, expnt(s) = [20.268562]
bas 18, expnt(s) = [0.77203735]
bas 19, expnt(s) = [2.77416111]
bas 20, expnt(s) = [0.22202141]
CPU time:       212.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026311e+03 7.61751843e+03 2.06003766e+03
 3.61735262e+03 1.17844185e+03 1.59775424e+03 6.38480310e+02
 3.82771745e+02 2.18635122e+02 1.09411293e+02 8.54695933e+01
 3.58839839e+01 3.70416662e+01 8.63932629e+00 1.27313639e+01
 3.32966029e+00 6.22751769e+00 6.61499621e-01 1.85315704e+00
 2.44588473e-01 8.78702806e-01 1.36278375e+03 2.41556138e+04
 6.64740277e+02 9.84689677e+03 3.00936514e+02 3.65660459e+03
 3.14020308e+02 3.85639544e+03 6.16365375e+01 5.03827866e+02
 7.29868506e+00 3.49977539e+01 2.02685620e+01 1.25462248e+02
 7.72037349e-01 2.11121412e+00 2.77416111e+00 1.04447727e+01
 2.22021415e-01 4.44608718e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99367881506542
cond(S) = 103768.7998381028
E1 = -729.5289088243361  E_coul = 203.17833747517898
init E= -526.350571349157
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555810763261431  LUMO = 1.02472702563888
  mo_energy =
[-1.18328484e+02 -1.22045136e+01 -9.44681335e+00 -9.44681335e+00
 -9.44681335e+00 -1.24000104e+00 -5.55810763e-01 -5.55810763e-01
 -5.55810763e-01  1.02472703e+00  1.02691892e+00  1.02691892e+00
  1.02691892e+00  7.26106892e+00  7.26106892e+00  7.26106892e+00
  1.34630577e+01  3.33194555e+01  3.33194555e+01  3.33194555e+01
  1.10541823e+02  1.28989573e+02  1.28989573e+02  1.28989573e+02
  4.83462891e+02  4.83462891e+02  4.83462891e+02  5.95164205e+02
  1.33533407e+03  1.33533407e+03  1.33533407e+03  2.66430529e+03
  3.02958908e+03  3.02958908e+03  3.02958908e+03  6.65010667e+03
  6.65010667e+03  6.65010667e+03  9.06938235e+03  2.54245928e+04
  7.61664611e+04]
E1 = -727.8438408380989  E_coul = 201.10652573417735
cycle= 1 E= -526.737315103922  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541124
diis-c [-0.2928153  1.       ]
  HOMO = -0.590686948803744  LUMO = 0.995952869360928
  mo_energy =
[-1.18636564e+02 -1.23421966e+01 -9.59520300e+00 -9.59520300e+00
 -9.59520300e+00 -1.27945987e+00 -5.90686949e-01 -5.90686949e-01
 -5.90686949e-01  9.95952869e-01  1.00278031e+00  1.00278031e+00
  1.00278031e+00  7.17090380e+00  7.17090380e+00  7.17090380e+00
  1.33498981e+01  3.31653695e+01  3.31653695e+01  3.31653695e+01
  1.10320759e+02  1.28761009e+02  1.28761009e+02  1.28761009e+02
  4.83155970e+02  4.83155970e+02  4.83155970e+02  5.94819153e+02
  1.33497049e+03  1.33497049e+03  1.33497049e+03  2.66380747e+03
  3.02915936e+03  3.02915936e+03  3.02915936e+03  6.64956368e+03
  6.64956368e+03  6.64956368e+03  9.06876413e+03  2.54238805e+04
  7.61656587e+04]
E1 = -728.4176196425897  E_coul = 201.6795860226063
cycle= 2 E= -526.738033619983  delta_E= -0.000719  |g|= 0.0376  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750394
diis-c [-0.00329457  0.08242694  0.91757306]
  HOMO = -0.581569567911164  LUMO = 1.00420527832639
  mo_energy =
[-1.18568893e+02 -1.23041675e+01 -9.55552312e+00 -9.55552312e+00
 -9.55552312e+00 -1.26854716e+00 -5.81569568e-01 -5.81569568e-01
 -5.81569568e-01  1.00420528e+00  1.00945973e+00  1.00945973e+00
  1.00945973e+00  7.19448547e+00  7.19448547e+00  7.19448547e+00
  1.33809066e+01  3.32054051e+01  3.32054051e+01  3.32054051e+01
  1.10376570e+02  1.28816887e+02  1.28816887e+02  1.28816887e+02
  4.83222830e+02  4.83222830e+02  4.83222830e+02  5.94888354e+02
  1.33504139e+03  1.33504139e+03  1.33504139e+03  2.66388168e+03
  3.02923250e+03  3.02923250e+03  3.02923250e+03  6.64963856e+03
  6.64963856e+03  6.64963856e+03  9.06883983e+03  2.54239568e+04
  7.61657353e+04]
E1 = -728.2672702157871  E_coul = 201.52917772130857
cycle= 3 E= -526.738092494479  delta_E= -5.89e-05  |g|= 0.00629  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131478
diis-c [-5.83459807e-07 -1.25381722e-03  1.44604215e-01  8.56649602e-01]
  HOMO = -0.583070059976575  LUMO = 1.00294286802671
  mo_energy =
[-1.18578853e+02 -1.23099780e+01 -9.56167887e+00 -9.56167887e+00
 -9.56167887e+00 -1.27024187e+00 -5.83070060e-01 -5.83070060e-01
 -5.83070060e-01  1.00294287e+00  1.00838434e+00  1.00838434e+00
  1.00838434e+00  7.19073068e+00  7.19073068e+00  7.19073068e+00
  1.33761440e+01  3.31992332e+01  3.31992332e+01  3.31992332e+01
  1.10368276e+02  1.28808535e+02  1.28808535e+02  1.28808535e+02
  4.83212985e+02  4.83212985e+02  4.83212985e+02  5.94878157e+02
  1.33503095e+03  1.33503095e+03  1.33503095e+03  2.66387062e+03
  3.02922168e+03  3.02922168e+03  3.02922168e+03  6.64962735e+03
  6.64962735e+03  6.64962735e+03  9.06882840e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.2900841492276  E_coul = 201.55198973218222
cycle= 4 E= -526.738094417045  delta_E= -1.92e-06  |g|= 9.66e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.000111923
diis-c [-4.10401478e-09  7.01599170e-05 -1.00455104e-02 -6.51908230e-02
  1.07516617e+00]
  HOMO = -0.583051611992026  LUMO = 1.00297680838951
  mo_energy =
[-1.18578813e+02 -1.23099135e+01 -9.56162764e+00 -9.56162764e+00
 -9.56162764e+00 -1.27020112e+00 -5.83051612e-01 -5.83051612e-01
 -5.83051612e-01  1.00297681e+00  1.00840008e+00  1.00840008e+00
  1.00840008e+00  7.19077229e+00  7.19077229e+00  7.19077229e+00
  1.33762038e+01  3.31992823e+01  3.31992823e+01  3.31992823e+01
  1.10368328e+02  1.28808583e+02  1.28808583e+02  1.28808583e+02
  4.83213025e+02  4.83213025e+02  4.83213025e+02  5.94878190e+02
  1.33503099e+03  1.33503099e+03  1.33503099e+03  2.66387063e+03
  3.02922170e+03  3.02922170e+03  3.02922170e+03  6.64962736e+03
  6.64962736e+03  6.64962736e+03  9.06882840e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.2898719401531  E_coul = 201.5517775214696
cycle= 5 E= -526.738094418684  delta_E= -1.64e-09  |g|= 2.05e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=3.86738e-05
diis-c [-7.37855641e-11  1.43481531e-05 -1.84681400e-03 -1.38368078e-02
  4.31954405e-02  9.72473833e-01]
  HOMO = -0.583058986051772  LUMO = 1.0029728544338
  mo_energy =
[-1.18578843e+02 -1.23099358e+01 -9.56165189e+00 -9.56165189e+00
 -9.56165189e+00 -1.27020700e+00 -5.83058986e-01 -5.83058986e-01
 -5.83058986e-01  1.00297285e+00  1.00839522e+00  1.00839522e+00
  1.00839522e+00  7.19075594e+00  7.19075594e+00  7.19075594e+00
  1.33761854e+01  3.31992588e+01  3.31992588e+01  3.31992588e+01
  1.10368300e+02  1.28808555e+02  1.28808555e+02  1.28808555e+02
  4.83212995e+02  4.83212995e+02  4.83212995e+02  5.94878159e+02
  1.33503096e+03  1.33503096e+03  1.33503096e+03  2.66387060e+03
  3.02922167e+03  3.02922167e+03  3.02922167e+03  6.64962732e+03
  6.64962732e+03  6.64962732e+03  9.06882837e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.2899527963968  E_coul = 201.55185837765634
cycle= 6 E= -526.738094418741  delta_E= -5.7e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2899527963968  E_coul = 201.55185837765634
  HOMO = -0.583059011873748  LUMO = 1.00297319033199
  mo_energy =
[-1.18578843e+02 -1.23099357e+01 -9.56165185e+00 -9.56165185e+00
 -9.56165185e+00 -1.27020663e+00 -5.83059012e-01 -5.83059012e-01
 -5.83059012e-01  1.00297319e+00  1.00839526e+00  1.00839526e+00
  1.00839526e+00  7.19075598e+00  7.19075598e+00  7.19075598e+00
  1.33761855e+01  3.31992588e+01  3.31992588e+01  3.31992588e+01
  1.10368301e+02  1.28808555e+02  1.28808555e+02  1.28808555e+02
  4.83212995e+02  4.83212995e+02  4.83212995e+02  5.94878159e+02
  1.33503096e+03  1.33503096e+03  1.33503096e+03  2.66387060e+03
  3.02922167e+03  3.02922167e+03  3.02922167e+03  6.64962732e+03
  6.64962732e+03  6.64962732e+03  9.06882837e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.289951882106  E_coul = 201.551857463365
Extra cycle  E= -526.738094418741  delta_E= -5.68e-13  |g|= 3.6e-07  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103768.7998381028
E1 = -728.289951882106  E_coul = 201.551857463365
init E= -526.738094418741
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583059041251747  LUMO = 1.00297323836505
  mo_energy =
[-1.18578843e+02 -1.23099358e+01 -9.56165194e+00 -9.56165194e+00
 -9.56165194e+00 -1.27020659e+00 -5.83059041e-01 -5.83059041e-01
 -5.83059041e-01  1.00297324e+00  1.00839525e+00  1.00839525e+00
  1.00839525e+00  7.19075593e+00  7.19075593e+00  7.19075593e+00
  1.33761855e+01  3.31992588e+01  3.31992588e+01  3.31992588e+01
  1.10368301e+02  1.28808555e+02  1.28808555e+02  1.28808555e+02
  4.83212995e+02  4.83212995e+02  4.83212995e+02  5.94878159e+02
  1.33503096e+03  1.33503096e+03  1.33503096e+03  2.66387060e+03
  3.02922167e+03  3.02922167e+03  3.02922167e+03  6.64962732e+03
  6.64962732e+03  6.64962732e+03  9.06882837e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.2899520280941  E_coul = 201.55185760935214
cycle= 1 E= -526.738094418742  delta_E= -9.09e-13  |g|= 7.54e-08  |ddm|= 6.02e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2899520280941  E_coul = 201.55185760935214
  HOMO = -0.583059041003901  LUMO = 1.00297325358481
  mo_energy =
[-1.18578843e+02 -1.23099357e+01 -9.56165193e+00 -9.56165193e+00
 -9.56165193e+00 -1.27020657e+00 -5.83059041e-01 -5.83059041e-01
 -5.83059041e-01  1.00297325e+00  1.00839525e+00  1.00839525e+00
  1.00839525e+00  7.19075593e+00  7.19075593e+00  7.19075593e+00
  1.33761855e+01  3.31992588e+01  3.31992588e+01  3.31992588e+01
  1.10368301e+02  1.28808555e+02  1.28808555e+02  1.28808555e+02
  4.83212995e+02  4.83212995e+02  4.83212995e+02  5.94878159e+02
  1.33503096e+03  1.33503096e+03  1.33503096e+03  2.66387060e+03
  3.02922167e+03  3.02922167e+03  3.02922167e+03  6.64962732e+03
  6.64962732e+03  6.64962732e+03  9.06882837e+03  2.54239451e+04
  7.61657235e+04]
E1 = -728.2899519640508  E_coul = 201.5518575453097
Extra cycle  E= -526.738094418741  delta_E= 7.96e-13  |g|= 1.52e-08  |ddm|= 1.26e-07
    CPU time for scf_cycle      1.06 sec, wall time      0.39 sec
exp = [2.61826575e+04 7.61751843e+03 3.61735262e+03 1.59775424e+03
 3.82771745e+02 1.09411293e+02 3.58839839e+01 8.63932629e+00
 3.32966029e+00 6.61499621e-01 2.44588473e-01 1.36278375e+03
 6.64740277e+02 3.00936514e+02 3.14020308e+02 6.16365375e+01
 7.29868506e+00 2.02685620e+01 7.72037349e-01 2.77416111e+00
 2.22021415e-01]
grad_E = [-1.52504017e-06  3.38890070e-06 -1.53849439e-06  7.22337048e-05
 -8.42118871e-05 -6.00480376e-04 -1.28500432e-03  1.03187143e-03
  1.53522497e-03 -3.87382021e-05  3.34067974e-04 -4.95322281e-07
  5.16426277e-06  2.45700003e-05  2.11797134e-05 -1.21311528e-04
 -1.21892803e-04  6.23196974e-04 -1.53819364e-03 -2.47301594e-03
  4.48542886e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6574918        1
[INPUT] 0    0    [1    /1   ]  7617.51841759        1
[INPUT] 0    0    [1    /1   ]  3617.3526236         1
[INPUT] 0    0    [1    /1   ]  1597.75401043        1
[INPUT] 0    0    [1    /1   ]  382.771191249        1
[INPUT] 0    0    [1    /1   ]  109.426046874        1
[INPUT] 0    0    [1    /1   ]  35.8494556495        1
[INPUT] 0    0    [1    /1   ]  8.59334871301        1
[INPUT] 0    0    [1    /1   ]  3.32144565589        1
[INPUT] 0    0    [1    /1   ]  0.659780772842       1
[INPUT] 0    0    [1    /1   ]  0.243931119773       1
[INPUT] 1    0    [1    /1   ]  1362.78375574        1
[INPUT] 1    0    [1    /1   ]  664.740258203        1
[INPUT] 1    0    [1    /1   ]  300.936420676        1
[INPUT] 1    0    [1    /1   ]  314.020227025        1
[INPUT] 1    0    [1    /1   ]  61.637964448         1
[INPUT] 1    0    [1    /1   ]  7.31029585633        1
[INPUT] 1    0    [1    /1   ]  20.2592910572        1
[INPUT] 1    0    [1    /1   ]  0.773184019657       1
[INPUT] 1    0    [1    /1   ]  2.78709727053        1
[INPUT] 1    0    [1    /1   ]  0.222245389745       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65749177854, 1.0]], [0, [7617.518417587686, 1.0]], [0, [3617.3526236009934, 1.0]], [0, [1597.7540104262448, 1.0]], [0, [382.77119124858046, 1.0]], [0, [109.42604687448058, 1.0]], [0, [35.84945564949415, 1.0]], [0, [8.593348713005165, 1.0]], [0, [3.321445655887368, 1.0]], [0, [0.6597807728424728, 1.0]], [0, [0.24393111977347726, 1.0]], [1, [1362.7837557411083, 1.0]], [1, [664.7402582033773, 1.0]], [1, [300.9364206762174, 1.0]], [1, [314.02022702495645, 1.0]], [1, [61.63796444795897, 1.0]], [1, [7.31029585633313, 1.0]], [1, [20.259291057175, 1.0]], [1, [0.7731840196573415, 1.0]], [1, [2.787097270528237, 1.0]], [1, [0.22224538974472333, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65749178]
bas 1, expnt(s) = [7617.51841759]
bas 2, expnt(s) = [3617.3526236]
bas 3, expnt(s) = [1597.75401043]
bas 4, expnt(s) = [382.77119125]
bas 5, expnt(s) = [109.42604687]
bas 6, expnt(s) = [35.84945565]
bas 7, expnt(s) = [8.59334871]
bas 8, expnt(s) = [3.32144566]
bas 9, expnt(s) = [0.65978077]
bas 10, expnt(s) = [0.24393112]
bas 11, expnt(s) = [1362.78375574]
bas 12, expnt(s) = [664.7402582]
bas 13, expnt(s) = [300.93642068]
bas 14, expnt(s) = [314.02022702]
bas 15, expnt(s) = [61.63796445]
bas 16, expnt(s) = [7.31029586]
bas 17, expnt(s) = [20.25929106]
bas 18, expnt(s) = [0.77318402]
bas 19, expnt(s) = [2.78709727]
bas 20, expnt(s) = [0.22224539]
CPU time:       218.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026311e+03 7.61751842e+03 2.06003766e+03
 3.61735262e+03 1.17844185e+03 1.59775401e+03 6.38480241e+02
 3.82771191e+02 2.18634884e+02 1.09426047e+02 8.54782371e+01
 3.58494556e+01 3.70149314e+01 8.59334871e+00 1.26805138e+01
 3.32144566e+00 6.21599115e+00 6.59780773e-01 1.84954442e+00
 2.43931120e-01 8.76931017e-01 1.36278376e+03 2.41556138e+04
 6.64740258e+02 9.84689641e+03 3.00936421e+02 3.65660317e+03
 3.14020227e+02 3.85639421e+03 6.16379644e+01 5.03842447e+02
 7.31029586e+00 3.50673610e+01 2.02592911e+01 1.25390518e+02
 7.73184020e-01 2.11513445e+00 2.78709727e+00 1.05056892e+01
 2.22245390e-01 4.45169440e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993651339555797
cond(S) = 103756.03522273237
E1 = -729.5285227457251  E_coul = 203.17803721355207
init E= -526.350485532173
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55580154705433  LUMO = 1.01988677268925
  mo_energy =
[-1.18328504e+02 -1.22045480e+01 -9.44685864e+00 -9.44685864e+00
 -9.44685864e+00 -1.24001220e+00 -5.55801547e-01 -5.55801547e-01
 -5.55801547e-01  1.01988677e+00  1.02885316e+00  1.02885316e+00
  1.02885316e+00  7.29165999e+00  7.29165999e+00  7.29165999e+00
  1.33780602e+01  3.33916981e+01  3.33916981e+01  3.33916981e+01
  1.10255451e+02  1.29052841e+02  1.29052841e+02  1.29052841e+02
  4.83507837e+02  4.83507837e+02  4.83507837e+02  5.94855106e+02
  1.33537264e+03  1.33537264e+03  1.33537264e+03  2.66403919e+03
  3.02962431e+03  3.02962431e+03  3.02962431e+03  6.65013849e+03
  6.65013849e+03  6.65013849e+03  9.06913986e+03  2.54243634e+04
  7.61662474e+04]
E1 = -727.844796090312  E_coul = 201.1074301407409
cycle= 1 E= -526.737365949571  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541295
diis-c [-0.29300006  1.        ]
  HOMO = -0.590663150240267  LUMO = 0.99125246045048
  mo_energy =
[-1.18636524e+02 -1.23421181e+01 -9.59512797e+00 -9.59512797e+00
 -9.59512797e+00 -1.27944764e+00 -5.90663150e-01 -5.90663150e-01
 -5.90663150e-01  9.91252460e-01  1.00467077e+00  1.00467077e+00
  1.00467077e+00  7.20135860e+00  7.20135860e+00  7.20135860e+00
  1.32652851e+01  3.32376940e+01  3.32376940e+01  3.32376940e+01
  1.10034595e+02  1.28824398e+02  1.28824398e+02  1.28824398e+02
  4.83200994e+02  4.83200994e+02  4.83200994e+02  5.94510064e+02
  1.33500906e+03  1.33500906e+03  1.33500906e+03  2.66354138e+03
  3.02919461e+03  3.02919461e+03  3.02919461e+03  6.64959550e+03
  6.64959550e+03  6.64959550e+03  9.06852163e+03  2.54236511e+04
  7.61654450e+04]
E1 = -728.4181649101145  E_coul = 201.6800810456215
cycle= 2 E= -526.738083864493  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750362
diis-c [-0.00329098  0.08245254  0.91754746]
  HOMO = -0.581554814557712  LUMO = 0.999465272045751
  mo_energy =
[-1.18568893e+02 -1.23041184e+01 -9.55547736e+00 -9.55547736e+00
 -9.55547736e+00 -1.26854592e+00 -5.81554815e-01 -5.81554815e-01
 -5.81554815e-01  9.99465272e-01  1.01135917e+00  1.01135917e+00
  1.01135917e+00  7.22497172e+00  7.22497172e+00  7.22497172e+00
  1.32961933e+01  3.32777050e+01  3.32777050e+01  3.32777050e+01
  1.10090361e+02  1.28880235e+02  1.28880235e+02  1.28880235e+02
  4.83267813e+02  4.83267813e+02  4.83267813e+02  5.94579226e+02
  1.33507992e+03  1.33507992e+03  1.33507992e+03  2.66361554e+03
  3.02926771e+03  3.02926771e+03  3.02926771e+03  6.64967034e+03
  6.64967034e+03  6.64967034e+03  9.06859729e+03  2.54237273e+04
  7.61655215e+04]
E1 = -728.2679823519458  E_coul = 201.52983971163727
cycle= 3 E= -526.738142640309  delta_E= -5.88e-05  |g|= 0.00628  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131368
diis-c [-5.83329436e-07 -1.25309238e-03  1.44498616e-01  8.56754477e-01]
  HOMO = -0.58305324142058  LUMO = 0.998209787551471
  mo_energy =
[-1.18578840e+02 -1.23099211e+01 -9.56162498e+00 -9.56162498e+00
 -9.56162498e+00 -1.27023795e+00 -5.83053241e-01 -5.83053241e-01
 -5.83053241e-01  9.98209788e-01  1.01028282e+00  1.01028282e+00
  1.01028282e+00  7.22121413e+00  7.22121413e+00  7.22121413e+00
  1.32914485e+01  3.32715406e+01  3.32715406e+01  3.32715406e+01
  1.10082080e+02  1.28871895e+02  1.28871895e+02  1.28871895e+02
  4.83257981e+02  4.83257981e+02  4.83257981e+02  5.94569041e+02
  1.33506950e+03  1.33506950e+03  1.33506950e+03  2.66360449e+03
  3.02925690e+03  3.02925690e+03  3.02925690e+03  6.64965914e+03
  6.64965914e+03  6.64965914e+03  9.06858588e+03  2.54237157e+04
  7.61655098e+04]
E1 = -728.2907563919537  E_coul = 201.5526118351553
cycle= 4 E= -526.738144556798  delta_E= -1.92e-06  |g|= 9.67e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000111919
diis-c [-4.10253088e-09  7.03252314e-05 -1.00714112e-02 -6.53907656e-02
  1.07539185e+00]
  HOMO = -0.583034800661375  LUMO = 0.998243664730684
  mo_energy =
[-1.18578800e+02 -1.23098565e+01 -9.56157370e+00 -9.56157370e+00
 -9.56157370e+00 -1.27019716e+00 -5.83034801e-01 -5.83034801e-01
 -5.83034801e-01  9.98243665e-01  1.01029859e+00  1.01029859e+00
  1.01029859e+00  7.22125581e+00  7.22125581e+00  7.22125581e+00
  1.32915083e+01  3.32715898e+01  3.32715898e+01  3.32715898e+01
  1.10082131e+02  1.28871942e+02  1.28871942e+02  1.28871942e+02
  4.83258021e+02  4.83258021e+02  4.83258021e+02  5.94569074e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66360450e+03
  3.02925692e+03  3.02925692e+03  3.02925692e+03  6.64965915e+03
  6.64965915e+03  6.64965915e+03  9.06858587e+03  2.54237157e+04
  7.61655097e+04]
E1 = -728.2905436539829  E_coul = 201.55239909553697
cycle= 5 E= -526.738144558446  delta_E= -1.65e-09  |g|= 2.05e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86909e-05
diis-c [-7.41453951e-11  1.43592411e-05 -1.84741498e-03 -1.38530580e-02
  4.32694925e-02  9.72416621e-01]
  HOMO = -0.583042188998655  LUMO = 0.998239720490381
  mo_energy =
[-1.18578831e+02 -1.23098789e+01 -9.56159798e+00 -9.56159798e+00
 -9.56159798e+00 -1.27020305e+00 -5.83042189e-01 -5.83042189e-01
 -5.83042189e-01  9.98239720e-01  1.01029371e+00  1.01029371e+00
  1.01029371e+00  7.22123941e+00  7.22123941e+00  7.22123941e+00
  1.32914898e+01  3.32715663e+01  3.32715663e+01  3.32715663e+01
  1.10082104e+02  1.28871915e+02  1.28871915e+02  1.28871915e+02
  4.83257991e+02  4.83257991e+02  4.83257991e+02  5.94569043e+02
  1.33506950e+03  1.33506950e+03  1.33506950e+03  2.66360447e+03
  3.02925689e+03  3.02925689e+03  3.02925689e+03  6.64965911e+03
  6.64965911e+03  6.64965911e+03  9.06858584e+03  2.54237157e+04
  7.61655097e+04]
E1 = -728.2906245032137  E_coul = 201.5524799447089
cycle= 6 E= -526.738144558505  delta_E= -5.89e-11  |g|= 1.75e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2906245032137  E_coul = 201.5524799447089
  HOMO = -0.583042216093327  LUMO = 0.998240055211334
  mo_energy =
[-1.18578830e+02 -1.23098788e+01 -9.56159794e+00 -9.56159794e+00
 -9.56159794e+00 -1.27020268e+00 -5.83042216e-01 -5.83042216e-01
 -5.83042216e-01  9.98240055e-01  1.01029375e+00  1.01029375e+00
  1.01029375e+00  7.22123944e+00  7.22123944e+00  7.22123944e+00
  1.32914900e+01  3.32715663e+01  3.32715663e+01  3.32715663e+01
  1.10082104e+02  1.28871915e+02  1.28871915e+02  1.28871915e+02
  4.83257991e+02  4.83257991e+02  4.83257991e+02  5.94569043e+02
  1.33506950e+03  1.33506950e+03  1.33506950e+03  2.66360447e+03
  3.02925689e+03  3.02925689e+03  3.02925689e+03  6.64965911e+03
  6.64965911e+03  6.64965911e+03  9.06858584e+03  2.54237157e+04
  7.61655097e+04]
E1 = -728.2906235774635  E_coul = 201.55247901895916
Extra cycle  E= -526.738144558504  delta_E= 4.55e-13  |g|= 3.61e-07  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826575e+04 7.61751842e+03 3.61735262e+03 1.59775401e+03
 3.82771191e+02 1.09426047e+02 3.58494556e+01 8.59334871e+00
 3.32144566e+00 6.59780773e-01 2.43931120e-01 1.36278376e+03
 6.64740258e+02 3.00936421e+02 3.14020227e+02 6.16379644e+01
 7.31029586e+00 2.02592911e+01 7.73184020e-01 2.78709727e+00
 2.22245390e-01]
E = -526.7381445585044
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6574918        1
[INPUT] 0    0    [1    /1   ]  7617.51841759        1
[INPUT] 0    0    [1    /1   ]  3617.3526236         1
[INPUT] 0    0    [1    /1   ]  1597.75401043        1
[INPUT] 0    0    [1    /1   ]  382.771191249        1
[INPUT] 0    0    [1    /1   ]  109.426046874        1
[INPUT] 0    0    [1    /1   ]  35.8494556495        1
[INPUT] 0    0    [1    /1   ]  8.59334871301        1
[INPUT] 0    0    [1    /1   ]  3.32144565589        1
[INPUT] 0    0    [1    /1   ]  0.659780772842       1
[INPUT] 0    0    [1    /1   ]  0.243931119773       1
[INPUT] 1    0    [1    /1   ]  1362.78375574        1
[INPUT] 1    0    [1    /1   ]  664.740258203        1
[INPUT] 1    0    [1    /1   ]  300.936420676        1
[INPUT] 1    0    [1    /1   ]  314.020227025        1
[INPUT] 1    0    [1    /1   ]  61.637964448         1
[INPUT] 1    0    [1    /1   ]  7.31029585633        1
[INPUT] 1    0    [1    /1   ]  20.2592910572        1
[INPUT] 1    0    [1    /1   ]  0.773184019657       1
[INPUT] 1    0    [1    /1   ]  2.78709727053        1
[INPUT] 1    0    [1    /1   ]  0.222245389745       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65749177854, 1.0]], [0, [7617.518417587686, 1.0]], [0, [3617.3526236009934, 1.0]], [0, [1597.7540104262448, 1.0]], [0, [382.77119124858046, 1.0]], [0, [109.42604687448058, 1.0]], [0, [35.84945564949415, 1.0]], [0, [8.593348713005165, 1.0]], [0, [3.321445655887368, 1.0]], [0, [0.6597807728424728, 1.0]], [0, [0.24393111977347726, 1.0]], [1, [1362.7837557411083, 1.0]], [1, [664.7402582033773, 1.0]], [1, [300.9364206762174, 1.0]], [1, [314.02022702495645, 1.0]], [1, [61.63796444795897, 1.0]], [1, [7.31029585633313, 1.0]], [1, [20.259291057175, 1.0]], [1, [0.7731840196573415, 1.0]], [1, [2.787097270528237, 1.0]], [1, [0.22224538974472333, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65749178]
bas 1, expnt(s) = [7617.51841759]
bas 2, expnt(s) = [3617.3526236]
bas 3, expnt(s) = [1597.75401043]
bas 4, expnt(s) = [382.77119125]
bas 5, expnt(s) = [109.42604687]
bas 6, expnt(s) = [35.84945565]
bas 7, expnt(s) = [8.59334871]
bas 8, expnt(s) = [3.32144566]
bas 9, expnt(s) = [0.65978077]
bas 10, expnt(s) = [0.24393112]
bas 11, expnt(s) = [1362.78375574]
bas 12, expnt(s) = [664.7402582]
bas 13, expnt(s) = [300.93642068]
bas 14, expnt(s) = [314.02022702]
bas 15, expnt(s) = [61.63796445]
bas 16, expnt(s) = [7.31029586]
bas 17, expnt(s) = [20.25929106]
bas 18, expnt(s) = [0.77318402]
bas 19, expnt(s) = [2.78709727]
bas 20, expnt(s) = [0.22224539]
CPU time:       218.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826575e+04 5.20026311e+03 7.61751842e+03 2.06003766e+03
 3.61735262e+03 1.17844185e+03 1.59775401e+03 6.38480241e+02
 3.82771191e+02 2.18634884e+02 1.09426047e+02 8.54782371e+01
 3.58494556e+01 3.70149314e+01 8.59334871e+00 1.26805138e+01
 3.32144566e+00 6.21599115e+00 6.59780773e-01 1.84954442e+00
 2.43931120e-01 8.76931017e-01 1.36278376e+03 2.41556138e+04
 6.64740258e+02 9.84689641e+03 3.00936421e+02 3.65660317e+03
 3.14020227e+02 3.85639421e+03 6.16379644e+01 5.03842447e+02
 7.31029586e+00 3.50673610e+01 2.02592911e+01 1.25390518e+02
 7.73184020e-01 2.11513445e+00 2.78709727e+00 1.05056892e+01
 2.22245390e-01 4.45169440e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993651339555797
cond(S) = 103756.03522273237
E1 = -729.5285227457251  E_coul = 203.17803721355207
init E= -526.350485532173
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55580154705433  LUMO = 1.01988677268925
  mo_energy =
[-1.18328504e+02 -1.22045480e+01 -9.44685864e+00 -9.44685864e+00
 -9.44685864e+00 -1.24001220e+00 -5.55801547e-01 -5.55801547e-01
 -5.55801547e-01  1.01988677e+00  1.02885316e+00  1.02885316e+00
  1.02885316e+00  7.29165999e+00  7.29165999e+00  7.29165999e+00
  1.33780602e+01  3.33916981e+01  3.33916981e+01  3.33916981e+01
  1.10255451e+02  1.29052841e+02  1.29052841e+02  1.29052841e+02
  4.83507837e+02  4.83507837e+02  4.83507837e+02  5.94855106e+02
  1.33537264e+03  1.33537264e+03  1.33537264e+03  2.66403919e+03
  3.02962431e+03  3.02962431e+03  3.02962431e+03  6.65013849e+03
  6.65013849e+03  6.65013849e+03  9.06913986e+03  2.54243634e+04
  7.61662474e+04]
E1 = -727.844796090312  E_coul = 201.1074301407409
cycle= 1 E= -526.737365949571  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541295
diis-c [-0.29300006  1.        ]
  HOMO = -0.590663150240267  LUMO = 0.99125246045048
  mo_energy =
[-1.18636524e+02 -1.23421181e+01 -9.59512797e+00 -9.59512797e+00
 -9.59512797e+00 -1.27944764e+00 -5.90663150e-01 -5.90663150e-01
 -5.90663150e-01  9.91252460e-01  1.00467077e+00  1.00467077e+00
  1.00467077e+00  7.20135860e+00  7.20135860e+00  7.20135860e+00
  1.32652851e+01  3.32376940e+01  3.32376940e+01  3.32376940e+01
  1.10034595e+02  1.28824398e+02  1.28824398e+02  1.28824398e+02
  4.83200994e+02  4.83200994e+02  4.83200994e+02  5.94510064e+02
  1.33500906e+03  1.33500906e+03  1.33500906e+03  2.66354138e+03
  3.02919461e+03  3.02919461e+03  3.02919461e+03  6.64959550e+03
  6.64959550e+03  6.64959550e+03  9.06852163e+03  2.54236511e+04
  7.61654450e+04]
E1 = -728.4181649101145  E_coul = 201.6800810456215
cycle= 2 E= -526.738083864493  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750362
diis-c [-0.00329098  0.08245254  0.91754746]
  HOMO = -0.581554814557712  LUMO = 0.999465272045751
  mo_energy =
[-1.18568893e+02 -1.23041184e+01 -9.55547736e+00 -9.55547736e+00
 -9.55547736e+00 -1.26854592e+00 -5.81554815e-01 -5.81554815e-01
 -5.81554815e-01  9.99465272e-01  1.01135917e+00  1.01135917e+00
  1.01135917e+00  7.22497172e+00  7.22497172e+00  7.22497172e+00
  1.32961933e+01  3.32777050e+01  3.32777050e+01  3.32777050e+01
  1.10090361e+02  1.28880235e+02  1.28880235e+02  1.28880235e+02
  4.83267813e+02  4.83267813e+02  4.83267813e+02  5.94579226e+02
  1.33507992e+03  1.33507992e+03  1.33507992e+03  2.66361554e+03
  3.02926771e+03  3.02926771e+03  3.02926771e+03  6.64967034e+03
  6.64967034e+03  6.64967034e+03  9.06859729e+03  2.54237273e+04
  7.61655215e+04]
E1 = -728.2679823519458  E_coul = 201.52983971163727
cycle= 3 E= -526.738142640309  delta_E= -5.88e-05  |g|= 0.00628  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131368
diis-c [-5.83329436e-07 -1.25309238e-03  1.44498616e-01  8.56754477e-01]
  HOMO = -0.58305324142058  LUMO = 0.998209787551471
  mo_energy =
[-1.18578840e+02 -1.23099211e+01 -9.56162498e+00 -9.56162498e+00
 -9.56162498e+00 -1.27023795e+00 -5.83053241e-01 -5.83053241e-01
 -5.83053241e-01  9.98209788e-01  1.01028282e+00  1.01028282e+00
  1.01028282e+00  7.22121413e+00  7.22121413e+00  7.22121413e+00
  1.32914485e+01  3.32715406e+01  3.32715406e+01  3.32715406e+01
  1.10082080e+02  1.28871895e+02  1.28871895e+02  1.28871895e+02
  4.83257981e+02  4.83257981e+02  4.83257981e+02  5.94569041e+02
  1.33506950e+03  1.33506950e+03  1.33506950e+03  2.66360449e+03
  3.02925690e+03  3.02925690e+03  3.02925690e+03  6.64965914e+03
  6.64965914e+03  6.64965914e+03  9.06858588e+03  2.54237157e+04
  7.61655098e+04]
E1 = -728.2907563919537  E_coul = 201.5526118351553
cycle= 4 E= -526.738144556798  delta_E= -1.92e-06  |g|= 9.67e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000111919
diis-c [-4.10253088e-09  7.03252314e-05 -1.00714112e-02 -6.53907656e-02
  1.07539185e+00]
  HOMO = -0.583034800661375  LUMO = 0.998243664730684
  mo_energy =
[-1.18578800e+02 -1.23098565e+01 -9.56157370e+00 -9.56157370e+00
 -9.56157370e+00 -1.27019716e+00 -5.83034801e-01 -5.83034801e-01
 -5.83034801e-01  9.98243665e-01  1.01029859e+00  1.01029859e+00
  1.01029859e+00  7.22125581e+00  7.22125581e+00  7.22125581e+00
  1.32915083e+01  3.32715898e+01  3.32715898e+01  3.32715898e+01
  1.10082131e+02  1.28871942e+02  1.28871942e+02  1.28871942e+02
  4.83258021e+02  4.83258021e+02  4.83258021e+02  5.94569074e+02
  1.33506953e+03  1.33506953e+03  1.33506953e+03  2.66360450e+03
  3.02925692e+03  3.02925692e+03  3.02925692e+03  6.64965915e+03
  6.64965915e+03  6.64965915e+03  9.06858587e+03  2.54237157e+04
  7.61655097e+04]
E1 = -728.2905436539829  E_coul = 201.55239909553697
cycle= 5 E= -526.738144558446  delta_E= -1.65e-09  |g|= 2.05e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86909e-05
diis-c [-7.41453951e-11  1.43592411e-05 -1.84741498e-03 -1.38530580e-02
  4.32694925e-02  9.72416621e-01]
  HOMO = -0.583042188998655  LUMO = 0.998239720490381
  mo_energy =
[-1.18578831e+02 -1.23098789e+01 -9.56159798e+00 -9.56159798e+00
 -9.56159798e+00 -1.27020305e+00 -5.83042189e-01 -5.83042189e-01
 -5.83042189e-01  9.98239720e-01  1.01029371e+00  1.01029371e+00
  1.01029371e+00  7.22123941e+00  7.22123941e+00  7.22123941e+00
  1.32914898e+01  3.32715663e+01  3.32715663e+01  3.32715663e+01
  1.10082104e+02  1.28871915e+02  1.28871915e+02  1.28871915e+02
  4.83257991e+02  4.83257991e+02  4.83257991e+02  5.94569043e+02
  1.33506950e+03  1.33506950e+03  1.33506950e+03  2.66360447e+03
  3.02925689e+03  3.02925689e+03  3.02925689e+03  6.64965911e+03
  6.64965911e+03  6.64965911e+03  9.06858584e+03  2.54237157e+04
  7.61655097e+04]
E1 = -728.2906245032137  E_coul = 201.5524799447089
cycle= 6 E= -526.738144558505  delta_E= -5.89e-11  |g|= 1.75e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2906245032137  E_coul = 201.5524799447089
  HOMO = -0.583042216093327  LUMO = 0.998240055211334
  mo_energy =
[-1.18578830e+02 -1.23098788e+01 -9.56159794e+00 -9.56159794e+00
 -9.56159794e+00 -1.27020268e+00 -5.83042216e-01 -5.83042216e-01
 -5.83042216e-01  9.98240055e-01  1.01029375e+00  1.01029375e+00
  1.01029375e+00  7.22123944e+00  7.22123944e+00  7.22123944e+00
  1.32914900e+01  3.32715663e+01  3.32715663e+01  3.32715663e+01
  1.10082104e+02  1.28871915e+02  1.28871915e+02  1.28871915e+02
  4.83257991e+02  4.83257991e+02  4.83257991e+02  5.94569043e+02
  1.33506950e+03  1.33506950e+03  1.33506950e+03  2.66360447e+03
  3.02925689e+03  3.02925689e+03  3.02925689e+03  6.64965911e+03
  6.64965911e+03  6.64965911e+03  9.06858584e+03  2.54237157e+04
  7.61655097e+04]
E1 = -728.2906235774635  E_coul = 201.55247901895916
Extra cycle  E= -526.738144558504  delta_E= 4.55e-13  |g|= 3.61e-07  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103756.03522273237
E1 = -728.2906235774635  E_coul = 201.55247901895916
init E= -526.738144558504
    CPU time for initialize scf      0.92 sec, wall time      0.24 sec
  HOMO = -0.58304224587103  LUMO = 0.998240102993154
  mo_energy =
[-1.18578830e+02 -1.23098788e+01 -9.56159803e+00 -9.56159803e+00
 -9.56159803e+00 -1.27020264e+00 -5.83042246e-01 -5.83042246e-01
 -5.83042246e-01  9.98240103e-01  1.01029374e+00  1.01029374e+00
  1.01029374e+00  7.22123939e+00  7.22123939e+00  7.22123939e+00
  1.32914900e+01  3.32715662e+01  3.32715662e+01  3.32715662e+01
  1.10082104e+02  1.28871915e+02  1.28871915e+02  1.28871915e+02
  4.83257991e+02  4.83257991e+02  4.83257991e+02  5.94569043e+02
  1.33506950e+03  1.33506950e+03  1.33506950e+03  2.66360447e+03
  3.02925689e+03  3.02925689e+03  3.02925689e+03  6.64965911e+03
  6.64965911e+03  6.64965911e+03  9.06858584e+03  2.54237157e+04
  7.61655097e+04]
E1 = -728.2906237239216  E_coul = 201.55247916541614
cycle= 1 E= -526.738144558505  delta_E= -1.14e-12  |g|= 7.56e-08  |ddm|= 6.04e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2906237239216  E_coul = 201.55247916541614
  HOMO = -0.583042245655257  LUMO = 0.998240118190731
  mo_energy =
[-1.18578830e+02 -1.23098788e+01 -9.56159802e+00 -9.56159802e+00
 -9.56159802e+00 -1.27020262e+00 -5.83042246e-01 -5.83042246e-01
 -5.83042246e-01  9.98240118e-01  1.01029374e+00  1.01029374e+00
  1.01029374e+00  7.22123940e+00  7.22123940e+00  7.22123940e+00
  1.32914900e+01  3.32715663e+01  3.32715663e+01  3.32715663e+01
  1.10082104e+02  1.28871915e+02  1.28871915e+02  1.28871915e+02
  4.83257991e+02  4.83257991e+02  4.83257991e+02  5.94569043e+02
  1.33506950e+03  1.33506950e+03  1.33506950e+03  2.66360447e+03
  3.02925689e+03  3.02925689e+03  3.02925689e+03  6.64965911e+03
  6.64965911e+03  6.64965911e+03  9.06858584e+03  2.54237157e+04
  7.61655097e+04]
E1 = -728.2906236592091  E_coul = 201.55247910070435
Extra cycle  E= -526.738144558505  delta_E= 6.82e-13  |g|= 1.53e-08  |ddm|= 1.27e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826575e+04 7.61751842e+03 3.61735262e+03 1.59775401e+03
 3.82771191e+02 1.09426047e+02 3.58494556e+01 8.59334871e+00
 3.32144566e+00 6.59780773e-01 2.43931120e-01 1.36278376e+03
 6.64740258e+02 3.00936421e+02 3.14020227e+02 6.16379644e+01
 7.31029586e+00 2.02592911e+01 7.73184020e-01 2.78709727e+00
 2.22245390e-01]
grad_E = [-1.52591227e-06  3.39886652e-06 -1.53265339e-06  7.26229653e-05
 -9.61934670e-05 -5.07928523e-04 -1.50247802e-03  7.44121180e-04
  2.27583750e-03 -3.41691415e-04  3.64951088e-04 -4.99226729e-07
  5.11196582e-06  2.42550065e-05  2.09088408e-05 -8.89352100e-05
 -1.20212268e-04  4.33762272e-04 -1.18774180e-03 -1.63411873e-03
  3.50500269e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6575898        1
[INPUT] 0    0    [1    /1   ]  7617.51820771        1
[INPUT] 0    0    [1    /1   ]  3617.35272838        1
[INPUT] 0    0    [1    /1   ]  1597.74970395        1
[INPUT] 0    0    [1    /1   ]  382.766134401        1
[INPUT] 0    0    [1    /1   ]  109.521271632        1
[INPUT] 0    0    [1    /1   ]  35.8482938021        1
[INPUT] 0    0    [1    /1   ]  8.57565558759        1
[INPUT] 0    0    [1    /1   ]  3.31907910752        1
[INPUT] 0    0    [1    /1   ]  0.657122803804       1
[INPUT] 0    0    [1    /1   ]  0.243060784672       1
[INPUT] 1    0    [1    /1   ]  1362.78378835        1
[INPUT] 1    0    [1    /1   ]  664.739930162        1
[INPUT] 1    0    [1    /1   ]  300.93486886         1
[INPUT] 1    0    [1    /1   ]  314.018889162        1
[INPUT] 1    0    [1    /1   ]  61.6413679179        1
[INPUT] 1    0    [1    /1   ]  7.32986477286        1
[INPUT] 1    0    [1    /1   ]  20.2438185049        1
[INPUT] 1    0    [1    /1   ]  0.775178152121       1
[INPUT] 1    0    [1    /1   ]  2.8094441905         1
[INPUT] 1    0    [1    /1   ]  0.222610309056       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657589755556, 1.0]], [0, [7617.518207708547, 1.0]], [0, [3617.3527283754843, 1.0]], [0, [1597.749703950737, 1.0]], [0, [382.76613440089943, 1.0]], [0, [109.52127163221927, 1.0]], [0, [35.84829380211266, 1.0]], [0, [8.575655587589795, 1.0]], [0, [3.3190791075178314, 1.0]], [0, [0.6571228038037785, 1.0]], [0, [0.24306078467219489, 1.0]], [1, [1362.7837883488878, 1.0]], [1, [664.7399301621217, 1.0]], [1, [300.93486885983526, 1.0]], [1, [314.0188891616303, 1.0]], [1, [61.64136791788109, 1.0]], [1, [7.329864772859099, 1.0]], [1, [20.243818504880277, 1.0]], [1, [0.7751781521213633, 1.0]], [1, [2.809444190500253, 1.0]], [1, [0.22261030905582352, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65758976]
bas 1, expnt(s) = [7617.51820771]
bas 2, expnt(s) = [3617.35272838]
bas 3, expnt(s) = [1597.74970395]
bas 4, expnt(s) = [382.7661344]
bas 5, expnt(s) = [109.52127163]
bas 6, expnt(s) = [35.8482938]
bas 7, expnt(s) = [8.57565559]
bas 8, expnt(s) = [3.31907911]
bas 9, expnt(s) = [0.6571228]
bas 10, expnt(s) = [0.24306078]
bas 11, expnt(s) = [1362.78378835]
bas 12, expnt(s) = [664.73993016]
bas 13, expnt(s) = [300.93486886]
bas 14, expnt(s) = [314.01888916]
bas 15, expnt(s) = [61.64136792]
bas 16, expnt(s) = [7.32986477]
bas 17, expnt(s) = [20.2438185]
bas 18, expnt(s) = [0.77517815]
bas 19, expnt(s) = [2.80944419]
bas 20, expnt(s) = [0.22261031]
CPU time:       224.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826576e+04 5.20026313e+03 7.61751821e+03 2.06003761e+03
 3.61735273e+03 1.17844188e+03 1.59774970e+03 6.38478950e+02
 3.82766134e+02 2.18632718e+02 1.09521272e+02 8.55340197e+01
 3.58482938e+01 3.70140316e+01 8.57565559e+00 1.26609275e+01
 3.31907911e+00 6.21266916e+00 6.57122804e-01 1.84395334e+00
 2.43060785e-01 8.74583331e-01 1.36278379e+03 2.41556145e+04
 6.64739930e+02 9.84689034e+03 3.00934869e+02 3.65657960e+03
 3.14018889e+02 3.85637367e+03 6.16413679e+01 5.03877223e+02
 7.32986477e+00 3.51847400e+01 2.02438185e+01 1.25270825e+02
 7.75178152e-01 2.12195562e+00 2.80944419e+00 1.06110877e+01
 2.22610309e-01 4.46083319e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993596298060616
cond(S) = 103759.15474664838
E1 = -729.5283884889768  E_coul = 203.17788400295436
init E= -526.350504486022
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555787632978396  LUMO = 1.01338128319788
  mo_energy =
[-1.18328548e+02 -1.22045435e+01 -9.44689466e+00 -9.44689466e+00
 -9.44689466e+00 -1.24002351e+00 -5.55787633e-01 -5.55787633e-01
 -5.55787633e-01  1.01338128e+00  1.03212667e+00  1.03212667e+00
  1.03212667e+00  7.34436581e+00  7.34436581e+00  7.34436581e+00
  1.33352008e+01  3.35156065e+01  3.35156065e+01  3.35156065e+01
  1.10197872e+02  1.29162874e+02  1.29162874e+02  1.29162874e+02
  4.83587700e+02  4.83587700e+02  4.83587700e+02  5.94997699e+02
  1.33543925e+03  1.33543925e+03  1.33543925e+03  2.66428281e+03
  3.02968156e+03  3.02968156e+03  3.02968156e+03  6.65018722e+03
  6.65018722e+03  6.65018722e+03  9.06937987e+03  2.54245901e+04
  7.61664576e+04]
E1 = -727.846244553472  E_coul = 201.108792675799
cycle= 1 E= -526.737451877673  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54161
diis-c [-0.29334113  1.        ]
  HOMO = -0.590636231259508  LUMO = 0.984920174166326
  mo_energy =
[-1.18636428e+02 -1.23419795e+01 -9.59502432e+00 -9.59502432e+00
 -9.59502432e+00 -1.27943493e+00 -5.90636231e-01 -5.90636231e-01
 -5.90636231e-01  9.84920174e-01  1.00786058e+00  1.00786058e+00
  1.00786058e+00  7.25379409e+00  7.25379409e+00  7.25379409e+00
  1.32226575e+01  3.33617016e+01  3.33617016e+01  3.33617016e+01
  1.09977164e+02  1.28934630e+02  1.28934630e+02  1.28934630e+02
  4.83281009e+02  4.83281009e+02  4.83281009e+02  5.94652733e+02
  1.33507577e+03  1.33507577e+03  1.33507577e+03  2.66378513e+03
  3.02925199e+03  3.02925199e+03  3.02925199e+03  6.64964436e+03
  6.64964436e+03  6.64964436e+03  9.06876177e+03  2.54238779e+04
  7.61656553e+04]
E1 = -728.4190036562119  E_coul = 201.68083472744726
cycle= 2 E= -526.738168928765  delta_E= -0.000717  |g|= 0.0376  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750323
diis-c [-0.00328803  0.08244591  0.91755409]
  HOMO = -0.581539992321668  LUMO = 0.993082954188913
  mo_energy =
[-1.18568857e+02 -1.23040206e+01 -9.55541577e+00 -9.55541577e+00
 -9.55541577e+00 -1.26854776e+00 -5.81539992e-01 -5.81539992e-01
 -5.81539992e-01  9.93082954e-01  1.01456666e+00  1.01456666e+00
  1.01456666e+00  7.27746736e+00  7.27746736e+00  7.27746736e+00
  1.32535048e+01  3.34016787e+01  3.34016787e+01  3.34016787e+01
  1.10032883e+02  1.28990406e+02  1.28990406e+02  1.28990406e+02
  4.83347767e+02  4.83347767e+02  4.83347767e+02  5.94721837e+02
  1.33514657e+03  1.33514657e+03  1.33514657e+03  2.66385923e+03
  3.02932502e+03  3.02932502e+03  3.02932502e+03  6.64971913e+03
  6.64971913e+03  6.64971913e+03  9.06883736e+03  2.54239540e+04
  7.61657318e+04]
E1 = -728.2690689959082  E_coul = 201.53084144122522
cycle= 3 E= -526.738227554683  delta_E= -5.86e-05  |g|= 0.00627  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131254
diis-c [-5.83089901e-07 -1.25177631e-03  1.44392566e-01  8.56859210e-01]
  HOMO = -0.583035769449232  LUMO = 0.991836174725626
  mo_energy =
[-1.18578788e+02 -1.23098129e+01 -9.56155259e+00 -9.56155259e+00
 -9.56155259e+00 -1.27023637e+00 -5.83035769e-01 -5.83035769e-01
 -5.83035769e-01  9.91836175e-01  1.01348802e+00  1.01348802e+00
  1.01348802e+00  7.27370296e+00  7.27370296e+00  7.27370296e+00
  1.32487729e+01  3.33955241e+01  3.33955241e+01  3.33955241e+01
  1.10024616e+02  1.28982081e+02  1.28982081e+02  1.28982081e+02
  4.83337951e+02  4.83337951e+02  4.83337951e+02  5.94711668e+02
  1.33513617e+03  1.33513617e+03  1.33513617e+03  2.66384819e+03
  3.02931423e+03  3.02931423e+03  3.02931423e+03  6.64970795e+03
  6.64970795e+03  6.64970795e+03  9.06882596e+03  2.54239425e+04
  7.61657200e+04]
E1 = -728.2917881698382  E_coul = 201.55355870674683
cycle= 4 E= -526.738229463091  delta_E= -1.91e-06  |g|= 9.69e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112189
diis-c [-4.09800759e-09  7.06917398e-05 -1.01238741e-02 -6.57778788e-02
  1.07583106e+00]
  HOMO = -0.583017405241045  LUMO = 0.991869914536614
  mo_energy =
[-1.18578748e+02 -1.23097484e+01 -9.56150145e+00 -9.56150145e+00
 -9.56150145e+00 -1.27019560e+00 -5.83017405e-01 -5.83017405e-01
 -5.83017405e-01  9.91869915e-01  1.01350379e+00  1.01350379e+00
  1.01350379e+00  7.27374463e+00  7.27374463e+00  7.27374463e+00
  1.32488326e+01  3.33955732e+01  3.33955732e+01  3.33955732e+01
  1.10024667e+02  1.28982129e+02  1.28982129e+02  1.28982129e+02
  4.83337991e+02  4.83337991e+02  4.83337991e+02  5.94711701e+02
  1.33513620e+03  1.33513620e+03  1.33513620e+03  2.66384820e+03
  3.02931425e+03  3.02931425e+03  3.02931425e+03  6.64970796e+03
  6.64970796e+03  6.64970796e+03  9.06882596e+03  2.54239425e+04
  7.61657200e+04]
E1 = -728.2915753894849  E_coul = 201.55334592473437
cycle= 5 E= -526.738229464751  delta_E= -1.66e-09  |g|= 2.05e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86924e-05
diis-c [-7.45640660e-11  1.43554116e-05 -1.84729972e-03 -1.38655095e-02
  4.34418326e-02  9.72256621e-01]
  HOMO = -0.58302481094182  LUMO = 0.991865980709965
  mo_energy =
[-1.18578778e+02 -1.23097708e+01 -9.56152576e+00 -9.56152576e+00
 -9.56152576e+00 -1.27020150e+00 -5.83024811e-01 -5.83024811e-01
 -5.83024811e-01  9.91865981e-01  1.01349888e+00  1.01349888e+00
  1.01349888e+00  7.27372815e+00  7.27372815e+00  7.27372815e+00
  1.32488142e+01  3.33955496e+01  3.33955496e+01  3.33955496e+01
  1.10024640e+02  1.28982101e+02  1.28982101e+02  1.28982101e+02
  4.83337961e+02  4.83337961e+02  4.83337961e+02  5.94711670e+02
  1.33513617e+03  1.33513617e+03  1.33513617e+03  2.66384817e+03
  3.02931422e+03  3.02931422e+03  3.02931422e+03  6.64970792e+03
  6.64970792e+03  6.64970792e+03  9.06882593e+03  2.54239424e+04
  7.61657200e+04]
E1 = -728.291656192041  E_coul = 201.55342672723413
cycle= 6 E= -526.738229464807  delta_E= -5.63e-11  |g|= 1.76e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.291656192041  E_coul = 201.55342672723413
  HOMO = -0.583024839133403  LUMO = 0.991866314362802
  mo_energy =
[-1.18578778e+02 -1.23097707e+01 -9.56152572e+00 -9.56152572e+00
 -9.56152572e+00 -1.27020113e+00 -5.83024839e-01 -5.83024839e-01
 -5.83024839e-01  9.91866314e-01  1.01349892e+00  1.01349892e+00
  1.01349892e+00  7.27372818e+00  7.27372818e+00  7.27372818e+00
  1.32488143e+01  3.33955497e+01  3.33955497e+01  3.33955497e+01
  1.10024640e+02  1.28982101e+02  1.28982101e+02  1.28982101e+02
  4.83337961e+02  4.83337961e+02  4.83337961e+02  5.94711670e+02
  1.33513617e+03  1.33513617e+03  1.33513617e+03  2.66384817e+03
  3.02931422e+03  3.02931422e+03  3.02931422e+03  6.64970792e+03
  6.64970792e+03  6.64970792e+03  9.06882593e+03  2.54239424e+04
  7.61657200e+04]
E1 = -728.2916552416565  E_coul = 201.55342577684763
Extra cycle  E= -526.738229464809  delta_E= -2.05e-12  |g|= 3.62e-07  |ddm|= 3.08e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826576e+04 7.61751821e+03 3.61735273e+03 1.59774970e+03
 3.82766134e+02 1.09521272e+02 3.58482938e+01 8.57565559e+00
 3.31907911e+00 6.57122804e-01 2.43060785e-01 1.36278379e+03
 6.64739930e+02 3.00934869e+02 3.14018889e+02 6.16413679e+01
 7.32986477e+00 2.02438185e+01 7.75178152e-01 2.80944419e+00
 2.22610309e-01]
E = -526.7382294648089
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6575898        1
[INPUT] 0    0    [1    /1   ]  7617.51820771        1
[INPUT] 0    0    [1    /1   ]  3617.35272838        1
[INPUT] 0    0    [1    /1   ]  1597.74970395        1
[INPUT] 0    0    [1    /1   ]  382.766134401        1
[INPUT] 0    0    [1    /1   ]  109.521271632        1
[INPUT] 0    0    [1    /1   ]  35.8482938021        1
[INPUT] 0    0    [1    /1   ]  8.57565558759        1
[INPUT] 0    0    [1    /1   ]  3.31907910752        1
[INPUT] 0    0    [1    /1   ]  0.657122803804       1
[INPUT] 0    0    [1    /1   ]  0.243060784672       1
[INPUT] 1    0    [1    /1   ]  1362.78378835        1
[INPUT] 1    0    [1    /1   ]  664.739930162        1
[INPUT] 1    0    [1    /1   ]  300.93486886         1
[INPUT] 1    0    [1    /1   ]  314.018889162        1
[INPUT] 1    0    [1    /1   ]  61.6413679179        1
[INPUT] 1    0    [1    /1   ]  7.32986477286        1
[INPUT] 1    0    [1    /1   ]  20.2438185049        1
[INPUT] 1    0    [1    /1   ]  0.775178152121       1
[INPUT] 1    0    [1    /1   ]  2.8094441905         1
[INPUT] 1    0    [1    /1   ]  0.222610309056       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657589755556, 1.0]], [0, [7617.518207708547, 1.0]], [0, [3617.3527283754843, 1.0]], [0, [1597.749703950737, 1.0]], [0, [382.76613440089943, 1.0]], [0, [109.52127163221927, 1.0]], [0, [35.84829380211266, 1.0]], [0, [8.575655587589795, 1.0]], [0, [3.3190791075178314, 1.0]], [0, [0.6571228038037785, 1.0]], [0, [0.24306078467219489, 1.0]], [1, [1362.7837883488878, 1.0]], [1, [664.7399301621217, 1.0]], [1, [300.93486885983526, 1.0]], [1, [314.0188891616303, 1.0]], [1, [61.64136791788109, 1.0]], [1, [7.329864772859099, 1.0]], [1, [20.243818504880277, 1.0]], [1, [0.7751781521213633, 1.0]], [1, [2.809444190500253, 1.0]], [1, [0.22261030905582352, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65758976]
bas 1, expnt(s) = [7617.51820771]
bas 2, expnt(s) = [3617.35272838]
bas 3, expnt(s) = [1597.74970395]
bas 4, expnt(s) = [382.7661344]
bas 5, expnt(s) = [109.52127163]
bas 6, expnt(s) = [35.8482938]
bas 7, expnt(s) = [8.57565559]
bas 8, expnt(s) = [3.31907911]
bas 9, expnt(s) = [0.6571228]
bas 10, expnt(s) = [0.24306078]
bas 11, expnt(s) = [1362.78378835]
bas 12, expnt(s) = [664.73993016]
bas 13, expnt(s) = [300.93486886]
bas 14, expnt(s) = [314.01888916]
bas 15, expnt(s) = [61.64136792]
bas 16, expnt(s) = [7.32986477]
bas 17, expnt(s) = [20.2438185]
bas 18, expnt(s) = [0.77517815]
bas 19, expnt(s) = [2.80944419]
bas 20, expnt(s) = [0.22261031]
CPU time:       224.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826576e+04 5.20026313e+03 7.61751821e+03 2.06003761e+03
 3.61735273e+03 1.17844188e+03 1.59774970e+03 6.38478950e+02
 3.82766134e+02 2.18632718e+02 1.09521272e+02 8.55340197e+01
 3.58482938e+01 3.70140316e+01 8.57565559e+00 1.26609275e+01
 3.31907911e+00 6.21266916e+00 6.57122804e-01 1.84395334e+00
 2.43060785e-01 8.74583331e-01 1.36278379e+03 2.41556145e+04
 6.64739930e+02 9.84689034e+03 3.00934869e+02 3.65657960e+03
 3.14018889e+02 3.85637367e+03 6.16413679e+01 5.03877223e+02
 7.32986477e+00 3.51847400e+01 2.02438185e+01 1.25270825e+02
 7.75178152e-01 2.12195562e+00 2.80944419e+00 1.06110877e+01
 2.22610309e-01 4.46083319e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993596298060616
cond(S) = 103759.15474664838
E1 = -729.5283884889768  E_coul = 203.17788400295436
init E= -526.350504486022
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555787632978396  LUMO = 1.01338128319788
  mo_energy =
[-1.18328548e+02 -1.22045435e+01 -9.44689466e+00 -9.44689466e+00
 -9.44689466e+00 -1.24002351e+00 -5.55787633e-01 -5.55787633e-01
 -5.55787633e-01  1.01338128e+00  1.03212667e+00  1.03212667e+00
  1.03212667e+00  7.34436581e+00  7.34436581e+00  7.34436581e+00
  1.33352008e+01  3.35156065e+01  3.35156065e+01  3.35156065e+01
  1.10197872e+02  1.29162874e+02  1.29162874e+02  1.29162874e+02
  4.83587700e+02  4.83587700e+02  4.83587700e+02  5.94997699e+02
  1.33543925e+03  1.33543925e+03  1.33543925e+03  2.66428281e+03
  3.02968156e+03  3.02968156e+03  3.02968156e+03  6.65018722e+03
  6.65018722e+03  6.65018722e+03  9.06937987e+03  2.54245901e+04
  7.61664576e+04]
E1 = -727.846244553472  E_coul = 201.108792675799
cycle= 1 E= -526.737451877673  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54161
diis-c [-0.29334113  1.        ]
  HOMO = -0.590636231259508  LUMO = 0.984920174166326
  mo_energy =
[-1.18636428e+02 -1.23419795e+01 -9.59502432e+00 -9.59502432e+00
 -9.59502432e+00 -1.27943493e+00 -5.90636231e-01 -5.90636231e-01
 -5.90636231e-01  9.84920174e-01  1.00786058e+00  1.00786058e+00
  1.00786058e+00  7.25379409e+00  7.25379409e+00  7.25379409e+00
  1.32226575e+01  3.33617016e+01  3.33617016e+01  3.33617016e+01
  1.09977164e+02  1.28934630e+02  1.28934630e+02  1.28934630e+02
  4.83281009e+02  4.83281009e+02  4.83281009e+02  5.94652733e+02
  1.33507577e+03  1.33507577e+03  1.33507577e+03  2.66378513e+03
  3.02925199e+03  3.02925199e+03  3.02925199e+03  6.64964436e+03
  6.64964436e+03  6.64964436e+03  9.06876177e+03  2.54238779e+04
  7.61656553e+04]
E1 = -728.4190036562119  E_coul = 201.68083472744726
cycle= 2 E= -526.738168928765  delta_E= -0.000717  |g|= 0.0376  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750323
diis-c [-0.00328803  0.08244591  0.91755409]
  HOMO = -0.581539992321668  LUMO = 0.993082954188913
  mo_energy =
[-1.18568857e+02 -1.23040206e+01 -9.55541577e+00 -9.55541577e+00
 -9.55541577e+00 -1.26854776e+00 -5.81539992e-01 -5.81539992e-01
 -5.81539992e-01  9.93082954e-01  1.01456666e+00  1.01456666e+00
  1.01456666e+00  7.27746736e+00  7.27746736e+00  7.27746736e+00
  1.32535048e+01  3.34016787e+01  3.34016787e+01  3.34016787e+01
  1.10032883e+02  1.28990406e+02  1.28990406e+02  1.28990406e+02
  4.83347767e+02  4.83347767e+02  4.83347767e+02  5.94721837e+02
  1.33514657e+03  1.33514657e+03  1.33514657e+03  2.66385923e+03
  3.02932502e+03  3.02932502e+03  3.02932502e+03  6.64971913e+03
  6.64971913e+03  6.64971913e+03  9.06883736e+03  2.54239540e+04
  7.61657318e+04]
E1 = -728.2690689959082  E_coul = 201.53084144122522
cycle= 3 E= -526.738227554683  delta_E= -5.86e-05  |g|= 0.00627  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131254
diis-c [-5.83089901e-07 -1.25177631e-03  1.44392566e-01  8.56859210e-01]
  HOMO = -0.583035769449232  LUMO = 0.991836174725626
  mo_energy =
[-1.18578788e+02 -1.23098129e+01 -9.56155259e+00 -9.56155259e+00
 -9.56155259e+00 -1.27023637e+00 -5.83035769e-01 -5.83035769e-01
 -5.83035769e-01  9.91836175e-01  1.01348802e+00  1.01348802e+00
  1.01348802e+00  7.27370296e+00  7.27370296e+00  7.27370296e+00
  1.32487729e+01  3.33955241e+01  3.33955241e+01  3.33955241e+01
  1.10024616e+02  1.28982081e+02  1.28982081e+02  1.28982081e+02
  4.83337951e+02  4.83337951e+02  4.83337951e+02  5.94711668e+02
  1.33513617e+03  1.33513617e+03  1.33513617e+03  2.66384819e+03
  3.02931423e+03  3.02931423e+03  3.02931423e+03  6.64970795e+03
  6.64970795e+03  6.64970795e+03  9.06882596e+03  2.54239425e+04
  7.61657200e+04]
E1 = -728.2917881698382  E_coul = 201.55355870674683
cycle= 4 E= -526.738229463091  delta_E= -1.91e-06  |g|= 9.69e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112189
diis-c [-4.09800759e-09  7.06917398e-05 -1.01238741e-02 -6.57778788e-02
  1.07583106e+00]
  HOMO = -0.583017405241045  LUMO = 0.991869914536614
  mo_energy =
[-1.18578748e+02 -1.23097484e+01 -9.56150145e+00 -9.56150145e+00
 -9.56150145e+00 -1.27019560e+00 -5.83017405e-01 -5.83017405e-01
 -5.83017405e-01  9.91869915e-01  1.01350379e+00  1.01350379e+00
  1.01350379e+00  7.27374463e+00  7.27374463e+00  7.27374463e+00
  1.32488326e+01  3.33955732e+01  3.33955732e+01  3.33955732e+01
  1.10024667e+02  1.28982129e+02  1.28982129e+02  1.28982129e+02
  4.83337991e+02  4.83337991e+02  4.83337991e+02  5.94711701e+02
  1.33513620e+03  1.33513620e+03  1.33513620e+03  2.66384820e+03
  3.02931425e+03  3.02931425e+03  3.02931425e+03  6.64970796e+03
  6.64970796e+03  6.64970796e+03  9.06882596e+03  2.54239425e+04
  7.61657200e+04]
E1 = -728.2915753894849  E_coul = 201.55334592473437
cycle= 5 E= -526.738229464751  delta_E= -1.66e-09  |g|= 2.05e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86924e-05
diis-c [-7.45640660e-11  1.43554116e-05 -1.84729972e-03 -1.38655095e-02
  4.34418326e-02  9.72256621e-01]
  HOMO = -0.58302481094182  LUMO = 0.991865980709965
  mo_energy =
[-1.18578778e+02 -1.23097708e+01 -9.56152576e+00 -9.56152576e+00
 -9.56152576e+00 -1.27020150e+00 -5.83024811e-01 -5.83024811e-01
 -5.83024811e-01  9.91865981e-01  1.01349888e+00  1.01349888e+00
  1.01349888e+00  7.27372815e+00  7.27372815e+00  7.27372815e+00
  1.32488142e+01  3.33955496e+01  3.33955496e+01  3.33955496e+01
  1.10024640e+02  1.28982101e+02  1.28982101e+02  1.28982101e+02
  4.83337961e+02  4.83337961e+02  4.83337961e+02  5.94711670e+02
  1.33513617e+03  1.33513617e+03  1.33513617e+03  2.66384817e+03
  3.02931422e+03  3.02931422e+03  3.02931422e+03  6.64970792e+03
  6.64970792e+03  6.64970792e+03  9.06882593e+03  2.54239424e+04
  7.61657200e+04]
E1 = -728.291656192041  E_coul = 201.55342672723413
cycle= 6 E= -526.738229464807  delta_E= -5.63e-11  |g|= 1.76e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.291656192041  E_coul = 201.55342672723413
  HOMO = -0.583024839133403  LUMO = 0.991866314362802
  mo_energy =
[-1.18578778e+02 -1.23097707e+01 -9.56152572e+00 -9.56152572e+00
 -9.56152572e+00 -1.27020113e+00 -5.83024839e-01 -5.83024839e-01
 -5.83024839e-01  9.91866314e-01  1.01349892e+00  1.01349892e+00
  1.01349892e+00  7.27372818e+00  7.27372818e+00  7.27372818e+00
  1.32488143e+01  3.33955497e+01  3.33955497e+01  3.33955497e+01
  1.10024640e+02  1.28982101e+02  1.28982101e+02  1.28982101e+02
  4.83337961e+02  4.83337961e+02  4.83337961e+02  5.94711670e+02
  1.33513617e+03  1.33513617e+03  1.33513617e+03  2.66384817e+03
  3.02931422e+03  3.02931422e+03  3.02931422e+03  6.64970792e+03
  6.64970792e+03  6.64970792e+03  9.06882593e+03  2.54239424e+04
  7.61657200e+04]
E1 = -728.2916552416565  E_coul = 201.55342577684763
Extra cycle  E= -526.738229464809  delta_E= -2.05e-12  |g|= 3.62e-07  |ddm|= 3.08e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103759.15474664838
E1 = -728.2916552416565  E_coul = 201.55342577684763
init E= -526.738229464809
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583024869650647  LUMO = 0.991866361623441
  mo_energy =
[-1.18578778e+02 -1.23097708e+01 -9.56152580e+00 -9.56152580e+00
 -9.56152580e+00 -1.27020109e+00 -5.83024870e-01 -5.83024870e-01
 -5.83024870e-01  9.91866362e-01  1.01349891e+00  1.01349891e+00
  1.01349891e+00  7.27372813e+00  7.27372813e+00  7.27372813e+00
  1.32488143e+01  3.33955496e+01  3.33955496e+01  3.33955496e+01
  1.10024640e+02  1.28982101e+02  1.28982101e+02  1.28982101e+02
  4.83337961e+02  4.83337961e+02  4.83337961e+02  5.94711670e+02
  1.33513617e+03  1.33513617e+03  1.33513617e+03  2.66384817e+03
  3.02931422e+03  3.02931422e+03  3.02931422e+03  6.64970792e+03
  6.64970792e+03  6.64970792e+03  9.06882593e+03  2.54239424e+04
  7.61657200e+04]
E1 = -728.291655391011  E_coul = 201.5534259262026
cycle= 1 E= -526.738229464808  delta_E= 5.68e-13  |g|= 7.59e-08  |ddm|= 6.06e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.291655391011  E_coul = 201.5534259262026
  HOMO = -0.583024869437262  LUMO = 0.99186637682567
  mo_energy =
[-1.18578778e+02 -1.23097708e+01 -9.56152580e+00 -9.56152580e+00
 -9.56152580e+00 -1.27020107e+00 -5.83024869e-01 -5.83024869e-01
 -5.83024869e-01  9.91866377e-01  1.01349891e+00  1.01349891e+00
  1.01349891e+00  7.27372813e+00  7.27372813e+00  7.27372813e+00
  1.32488143e+01  3.33955496e+01  3.33955496e+01  3.33955496e+01
  1.10024640e+02  1.28982101e+02  1.28982101e+02  1.28982101e+02
  4.83337961e+02  4.83337961e+02  4.83337961e+02  5.94711670e+02
  1.33513617e+03  1.33513617e+03  1.33513617e+03  2.66384817e+03
  3.02931422e+03  3.02931422e+03  3.02931422e+03  6.64970792e+03
  6.64970792e+03  6.64970792e+03  9.06882593e+03  2.54239424e+04
  7.61657200e+04]
E1 = -728.2916553247366  E_coul = 201.55342585992707
Extra cycle  E= -526.738229464809  delta_E= -1.14e-12  |g|= 1.53e-08  |ddm|= 1.28e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826576e+04 7.61751821e+03 3.61735273e+03 1.59774970e+03
 3.82766134e+02 1.09521272e+02 3.58482938e+01 8.57565559e+00
 3.31907911e+00 6.57122804e-01 2.43060785e-01 1.36278379e+03
 6.64739930e+02 3.00934869e+02 3.14018889e+02 6.16413679e+01
 7.32986477e+00 2.02438185e+01 7.75178152e-01 2.80944419e+00
 2.22610309e-01]
grad_E = [-1.52770349e-06  3.41911634e-06 -1.52072256e-06  7.33988198e-05
 -1.17746597e-04 -3.80982905e-04 -1.72503980e-03  5.82057569e-04
  2.79422265e-03 -7.99827017e-04  4.00695774e-04 -5.05524188e-07
  5.02675612e-06  2.37425328e-05  2.04681505e-05 -3.66172511e-05
 -2.08168662e-04  1.40896199e-04 -3.41122028e-04 -1.13852693e-04
  9.48114773e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6578098        1
[INPUT] 0    0    [1    /1   ]  7617.51773617        1
[INPUT] 0    0    [1    /1   ]  3617.35296355        1
[INPUT] 0    0    [1    /1   ]  1597.74002003        1
[INPUT] 0    0    [1    /1   ]  382.755877939        1
[INPUT] 0    0    [1    /1   ]  109.714020628        1
[INPUT] 0    0    [1    /1   ]  35.914380395         1
[INPUT] 0    0    [1    /1   ]  8.61673924766        1
[INPUT] 0    0    [1    /1   ]  3.32728950147        1
[INPUT] 0    0    [1    /1   ]  0.655635863957       1
[INPUT] 0    0    [1    /1   ]  0.242680185017       1
[INPUT] 1    0    [1    /1   ]  1362.78386179        1
[INPUT] 1    0    [1    /1   ]  664.739196406        1
[INPUT] 1    0    [1    /1   ]  300.931401767        1
[INPUT] 1    0    [1    /1   ]  314.015900009        1
[INPUT] 1    0    [1    /1   ]  61.6470145773        1
[INPUT] 1    0    [1    /1   ]  7.35767778133        1
[INPUT] 1    0    [1    /1   ]  20.2225245763        1
[INPUT] 1    0    [1    /1   ]  0.777926719876       1
[INPUT] 1    0    [1    /1   ]  2.83913261694        1
[INPUT] 1    0    [1    /1   ]  0.223132889432       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657809792032, 1.0]], [0, [7617.517736172147, 1.0]], [0, [3617.352963549284, 1.0]], [0, [1597.7400200342383, 1.0]], [0, [382.75587793920226, 1.0]], [0, [109.71402062808562, 1.0]], [0, [35.91438039500444, 1.0]], [0, [8.61673924765843, 1.0]], [0, [3.3272895014691426, 1.0]], [0, [0.6556358639570915, 1.0]], [0, [0.24268018501729793, 1.0]], [1, [1362.7838617938123, 1.0]], [1, [664.7391964057789, 1.0]], [1, [300.9314017672496, 1.0]], [1, [314.01590000894413, 1.0]], [1, [61.647014577253245, 1.0]], [1, [7.357677781332008, 1.0]], [1, [20.22252457626342, 1.0]], [1, [0.7779267198758144, 1.0]], [1, [2.8391326169438944, 1.0]], [1, [0.22313288943158444, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65780979]
bas 1, expnt(s) = [7617.51773617]
bas 2, expnt(s) = [3617.35296355]
bas 3, expnt(s) = [1597.74002003]
bas 4, expnt(s) = [382.75587794]
bas 5, expnt(s) = [109.71402063]
bas 6, expnt(s) = [35.9143804]
bas 7, expnt(s) = [8.61673925]
bas 8, expnt(s) = [3.3272895]
bas 9, expnt(s) = [0.65563586]
bas 10, expnt(s) = [0.24268019]
bas 11, expnt(s) = [1362.78386179]
bas 12, expnt(s) = [664.73919641]
bas 13, expnt(s) = [300.93140177]
bas 14, expnt(s) = [314.01590001]
bas 15, expnt(s) = [61.64701458]
bas 16, expnt(s) = [7.35767778]
bas 17, expnt(s) = [20.22252458]
bas 18, expnt(s) = [0.77792672]
bas 19, expnt(s) = [2.83913262]
bas 20, expnt(s) = [0.22313289]
CPU time:       230.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826578e+04 5.20026316e+03 7.61751774e+03 2.06003752e+03
 3.61735296e+03 1.17844194e+03 1.59774002e+03 6.38476048e+02
 3.82755878e+02 2.18628324e+02 1.09714021e+02 8.56468949e+01
 3.59143804e+01 3.70651966e+01 8.61673925e+00 1.27063916e+01
 3.32728950e+00 6.22419179e+00 6.55635864e-01 1.84082308e+00
 2.42680185e-01 8.73556023e-01 1.36278386e+03 2.41556162e+04
 6.64739196e+02 9.84687675e+03 3.00931402e+02 3.65652694e+03
 3.14015900e+02 3.85632778e+03 6.16470146e+01 5.03934921e+02
 7.35767778e+00 3.53517037e+01 2.02225246e+01 1.25106135e+02
 7.77926720e-01 2.13136463e+00 2.83913262e+00 1.07514364e+01
 2.23132889e-01 4.47392685e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993504180436148
cond(S) = 103795.41053976571
E1 = -729.529028501848  E_coul = 203.17823890741118
init E= -526.350789594437
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555765545630364  LUMO = 1.01051938942697
  mo_energy =
[-1.18328597e+02 -1.22044785e+01 -9.44688098e+00 -9.44688098e+00
 -9.44688098e+00 -1.24002070e+00 -5.55765546e-01 -5.55765546e-01
 -5.55765546e-01  1.01051939e+00  1.03671049e+00  1.03671049e+00
  1.03671049e+00  7.41554481e+00  7.41554481e+00  7.41554481e+00
  1.33952831e+01  3.36843195e+01  3.36843195e+01  3.36843195e+01
  1.10593576e+02  1.29314935e+02  1.29314935e+02  1.29314935e+02
  4.83699701e+02  4.83699701e+02  4.83699701e+02  5.95905585e+02
  1.33553090e+03  1.33553090e+03  1.33553090e+03  2.66534673e+03
  3.02975686e+03  3.02975686e+03  3.02975686e+03  6.65024832e+03
  6.65024832e+03  6.65024832e+03  9.07039165e+03  2.54255464e+04
  7.61673463e+04]
E1 = -727.8487526847588  E_coul = 201.1111912734069
cycle= 1 E= -526.737561411352  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541995
diis-c [-0.29375811  1.        ]
  HOMO = -0.590580580287095  LUMO = 0.98216019600176
  mo_energy =
[-1.18636202e+02 -1.23417601e+01 -9.59486324e+00 -9.59486324e+00
 -9.59486324e+00 -1.27938534e+00 -5.90580580e-01 -5.90580580e-01
 -5.90580580e-01  9.82160196e-01  1.01234245e+00  1.01234245e+00
  1.01234245e+00  7.32460525e+00  7.32460525e+00  7.32460525e+00
  1.32826207e+01  3.35305382e+01  3.35305382e+01  3.35305382e+01
  1.10372879e+02  1.29086987e+02  1.29086987e+02  1.29086987e+02
  4.83393283e+02  4.83393283e+02  4.83393283e+02  5.95560847e+02
  1.33516770e+03  1.33516770e+03  1.33516770e+03  2.66484942e+03
  3.02932763e+03  3.02932763e+03  3.02932763e+03  6.64970582e+03
  6.64970582e+03  6.64970582e+03  9.06977395e+03  2.54248346e+04
  7.61665444e+04]
E1 = -728.4206203914422  E_coul = 201.68234325191742
cycle= 2 E= -526.738277139525  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750107
diis-c [-0.00328663  0.08236164  0.91763836]
  HOMO = -0.58150054352808  LUMO = 0.990294894069362
  mo_energy =
[-1.18568716e+02 -1.23038561e+01 -9.55531336e+00 -9.55531336e+00
 -9.55531336e+00 -1.26851701e+00 -5.81500544e-01 -5.81500544e-01
 -5.81500544e-01  9.90294894e-01  1.01907271e+00  1.01907271e+00
  1.01907271e+00  7.34835776e+00  7.34835776e+00  7.34835776e+00
  1.33134941e+01  3.35704686e+01  3.35704686e+01  3.35704686e+01
  1.10428557e+02  1.29142677e+02  1.29142677e+02  1.29142677e+02
  4.83459953e+02  4.83459953e+02  4.83459953e+02  5.95629866e+02
  1.33523841e+03  1.33523841e+03  1.33523841e+03  2.66492343e+03
  3.02940057e+03  3.02940057e+03  3.02940057e+03  6.64978050e+03
  6.64978050e+03  6.64978050e+03  9.06984944e+03  2.54249106e+04
  7.61666208e+04]
E1 = -728.2710182971621  E_coul = 201.5326827406829
cycle= 3 E= -526.738335556479  delta_E= -5.84e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131178
diis-c [-5.83313579e-07 -1.25025571e-03  1.44356223e-01  8.56894033e-01]
  HOMO = -0.58299318487889  LUMO = 0.989053357819611
  mo_energy =
[-1.18578630e+02 -1.23096367e+01 -9.56143828e+00 -9.56143828e+00
 -9.56143828e+00 -1.27020165e+00 -5.82993185e-01 -5.82993185e-01
 -5.82993185e-01  9.89053358e-01  1.01799058e+00  1.01799058e+00
  1.01799058e+00  7.34458294e+00  7.34458294e+00  7.34458294e+00
  1.33087617e+01  3.35643243e+01  3.35643243e+01  3.35643243e+01
  1.10420300e+02  1.29134368e+02  1.29134368e+02  1.29134368e+02
  4.83450155e+02  4.83450155e+02  4.83450155e+02  5.95619714e+02
  1.33522802e+03  1.33522802e+03  1.33522802e+03  2.66491241e+03
  3.02938980e+03  3.02938980e+03  3.02938980e+03  6.64976934e+03
  6.64976934e+03  6.64976934e+03  9.06983806e+03  2.54248991e+04
  7.61666091e+04]
E1 = -728.2936754017885  E_coul = 201.55533794552778
cycle= 4 E= -526.738337456261  delta_E= -1.9e-06  |g|= 9.71e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113003
diis-c [-4.09086927e-09  7.13212063e-05 -1.02097728e-02 -6.63880711e-02
  1.07652652e+00]
  HOMO = -0.582974990259857  LUMO = 0.989086969503146
  mo_energy =
[-1.18578590e+02 -1.23095726e+01 -9.56138759e+00 -9.56138759e+00
 -9.56138759e+00 -1.27016099e+00 -5.82974990e-01 -5.82974990e-01
 -5.82974990e-01  9.89086970e-01  1.01800630e+00  1.01800630e+00
  1.01800630e+00  7.34462440e+00  7.34462440e+00  7.34462440e+00
  1.33088212e+01  3.35643730e+01  3.35643730e+01  3.35643730e+01
  1.10420351e+02  1.29134416e+02  1.29134416e+02  1.29134416e+02
  4.83450195e+02  4.83450195e+02  4.83450195e+02  5.95619747e+02
  1.33522805e+03  1.33522805e+03  1.33522805e+03  2.66491242e+03
  3.02938982e+03  3.02938982e+03  3.02938982e+03  6.64976934e+03
  6.64976934e+03  6.64976934e+03  9.06983806e+03  2.54248991e+04
  7.61666091e+04]
E1 = -728.2934638508316  E_coul = 201.55512639290225
cycle= 5 E= -526.738337457929  delta_E= -1.67e-09  |g|= 2.05e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86703e-05
diis-c [-7.48310010e-11  1.43201814e-05 -1.84516618e-03 -1.38600995e-02
  4.36826850e-02  9.72008260e-01]
  HOMO = -0.582982406694017  LUMO = 0.989083033441482
  mo_energy =
[-1.18578621e+02 -1.23095951e+01 -9.56141192e+00 -9.56141192e+00
 -9.56141192e+00 -1.27016690e+00 -5.82982407e-01 -5.82982407e-01
 -5.82982407e-01  9.89083033e-01  1.01800135e+00  1.01800135e+00
  1.01800135e+00  7.34460783e+00  7.34460783e+00  7.34460783e+00
  1.33088027e+01  3.35643494e+01  3.35643494e+01  3.35643494e+01
  1.10420324e+02  1.29134388e+02  1.29134388e+02  1.29134388e+02
  4.83450164e+02  4.83450164e+02  4.83450164e+02  5.95619716e+02
  1.33522802e+03  1.33522802e+03  1.33522802e+03  2.66491239e+03
  3.02938979e+03  3.02938979e+03  3.02938979e+03  6.64976931e+03
  6.64976931e+03  6.64976931e+03  9.06983803e+03  2.54248990e+04
  7.61666090e+04]
E1 = -728.2935445750256  E_coul = 201.55520711703898
cycle= 6 E= -526.738337457987  delta_E= -5.73e-11  |g|= 1.76e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2935445750256  E_coul = 201.55520711703898
  HOMO = -0.58298243392083  LUMO = 0.989083367858363
  mo_energy =
[-1.18578621e+02 -1.23095949e+01 -9.56141187e+00 -9.56141187e+00
 -9.56141187e+00 -1.27016654e+00 -5.82982434e-01 -5.82982434e-01
 -5.82982434e-01  9.89083368e-01  1.01800139e+00  1.01800139e+00
  1.01800139e+00  7.34460787e+00  7.34460787e+00  7.34460787e+00
  1.33088029e+01  3.35643495e+01  3.35643495e+01  3.35643495e+01
  1.10420324e+02  1.29134388e+02  1.29134388e+02  1.29134388e+02
  4.83450165e+02  4.83450165e+02  4.83450165e+02  5.95619716e+02
  1.33522802e+03  1.33522802e+03  1.33522802e+03  2.66491239e+03
  3.02938979e+03  3.02938979e+03  3.02938979e+03  6.64976931e+03
  6.64976931e+03  6.64976931e+03  9.06983803e+03  2.54248990e+04
  7.61666090e+04]
E1 = -728.2935435834532  E_coul = 201.55520612546638
Extra cycle  E= -526.738337457987  delta_E= -2.27e-13  |g|= 3.63e-07  |ddm|= 3.09e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826578e+04 7.61751774e+03 3.61735296e+03 1.59774002e+03
 3.82755878e+02 1.09714021e+02 3.59143804e+01 8.61673925e+00
 3.32728950e+00 6.55635864e-01 2.42680185e-01 1.36278386e+03
 6.64739196e+02 3.00931402e+02 3.14015900e+02 6.16470146e+01
 7.35767778e+00 2.02225246e+01 7.77926720e-01 2.83913262e+00
 2.23132889e-01]
E = -526.7383374579869
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6578098        1
[INPUT] 0    0    [1    /1   ]  7617.51773617        1
[INPUT] 0    0    [1    /1   ]  3617.35296355        1
[INPUT] 0    0    [1    /1   ]  1597.74002003        1
[INPUT] 0    0    [1    /1   ]  382.755877939        1
[INPUT] 0    0    [1    /1   ]  109.714020628        1
[INPUT] 0    0    [1    /1   ]  35.914380395         1
[INPUT] 0    0    [1    /1   ]  8.61673924766        1
[INPUT] 0    0    [1    /1   ]  3.32728950147        1
[INPUT] 0    0    [1    /1   ]  0.655635863957       1
[INPUT] 0    0    [1    /1   ]  0.242680185017       1
[INPUT] 1    0    [1    /1   ]  1362.78386179        1
[INPUT] 1    0    [1    /1   ]  664.739196406        1
[INPUT] 1    0    [1    /1   ]  300.931401767        1
[INPUT] 1    0    [1    /1   ]  314.015900009        1
[INPUT] 1    0    [1    /1   ]  61.6470145773        1
[INPUT] 1    0    [1    /1   ]  7.35767778133        1
[INPUT] 1    0    [1    /1   ]  20.2225245763        1
[INPUT] 1    0    [1    /1   ]  0.777926719876       1
[INPUT] 1    0    [1    /1   ]  2.83913261694        1
[INPUT] 1    0    [1    /1   ]  0.223132889432       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.657809792032, 1.0]], [0, [7617.517736172147, 1.0]], [0, [3617.352963549284, 1.0]], [0, [1597.7400200342383, 1.0]], [0, [382.75587793920226, 1.0]], [0, [109.71402062808562, 1.0]], [0, [35.91438039500444, 1.0]], [0, [8.61673924765843, 1.0]], [0, [3.3272895014691426, 1.0]], [0, [0.6556358639570915, 1.0]], [0, [0.24268018501729793, 1.0]], [1, [1362.7838617938123, 1.0]], [1, [664.7391964057789, 1.0]], [1, [300.9314017672496, 1.0]], [1, [314.01590000894413, 1.0]], [1, [61.647014577253245, 1.0]], [1, [7.357677781332008, 1.0]], [1, [20.22252457626342, 1.0]], [1, [0.7779267198758144, 1.0]], [1, [2.8391326169438944, 1.0]], [1, [0.22313288943158444, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65780979]
bas 1, expnt(s) = [7617.51773617]
bas 2, expnt(s) = [3617.35296355]
bas 3, expnt(s) = [1597.74002003]
bas 4, expnt(s) = [382.75587794]
bas 5, expnt(s) = [109.71402063]
bas 6, expnt(s) = [35.9143804]
bas 7, expnt(s) = [8.61673925]
bas 8, expnt(s) = [3.3272895]
bas 9, expnt(s) = [0.65563586]
bas 10, expnt(s) = [0.24268019]
bas 11, expnt(s) = [1362.78386179]
bas 12, expnt(s) = [664.73919641]
bas 13, expnt(s) = [300.93140177]
bas 14, expnt(s) = [314.01590001]
bas 15, expnt(s) = [61.64701458]
bas 16, expnt(s) = [7.35767778]
bas 17, expnt(s) = [20.22252458]
bas 18, expnt(s) = [0.77792672]
bas 19, expnt(s) = [2.83913262]
bas 20, expnt(s) = [0.22313289]
CPU time:       231.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826578e+04 5.20026316e+03 7.61751774e+03 2.06003752e+03
 3.61735296e+03 1.17844194e+03 1.59774002e+03 6.38476048e+02
 3.82755878e+02 2.18628324e+02 1.09714021e+02 8.56468949e+01
 3.59143804e+01 3.70651966e+01 8.61673925e+00 1.27063916e+01
 3.32728950e+00 6.22419179e+00 6.55635864e-01 1.84082308e+00
 2.42680185e-01 8.73556023e-01 1.36278386e+03 2.41556162e+04
 6.64739196e+02 9.84687675e+03 3.00931402e+02 3.65652694e+03
 3.14015900e+02 3.85632778e+03 6.16470146e+01 5.03934921e+02
 7.35767778e+00 3.53517037e+01 2.02225246e+01 1.25106135e+02
 7.77926720e-01 2.13136463e+00 2.83913262e+00 1.07514364e+01
 2.23132889e-01 4.47392685e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993504180436148
cond(S) = 103795.41053976571
E1 = -729.529028501848  E_coul = 203.17823890741118
init E= -526.350789594437
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555765545630364  LUMO = 1.01051938942697
  mo_energy =
[-1.18328597e+02 -1.22044785e+01 -9.44688098e+00 -9.44688098e+00
 -9.44688098e+00 -1.24002070e+00 -5.55765546e-01 -5.55765546e-01
 -5.55765546e-01  1.01051939e+00  1.03671049e+00  1.03671049e+00
  1.03671049e+00  7.41554481e+00  7.41554481e+00  7.41554481e+00
  1.33952831e+01  3.36843195e+01  3.36843195e+01  3.36843195e+01
  1.10593576e+02  1.29314935e+02  1.29314935e+02  1.29314935e+02
  4.83699701e+02  4.83699701e+02  4.83699701e+02  5.95905585e+02
  1.33553090e+03  1.33553090e+03  1.33553090e+03  2.66534673e+03
  3.02975686e+03  3.02975686e+03  3.02975686e+03  6.65024832e+03
  6.65024832e+03  6.65024832e+03  9.07039165e+03  2.54255464e+04
  7.61673463e+04]
E1 = -727.8487526847588  E_coul = 201.1111912734069
cycle= 1 E= -526.737561411352  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541995
diis-c [-0.29375811  1.        ]
  HOMO = -0.590580580287095  LUMO = 0.98216019600176
  mo_energy =
[-1.18636202e+02 -1.23417601e+01 -9.59486324e+00 -9.59486324e+00
 -9.59486324e+00 -1.27938534e+00 -5.90580580e-01 -5.90580580e-01
 -5.90580580e-01  9.82160196e-01  1.01234245e+00  1.01234245e+00
  1.01234245e+00  7.32460525e+00  7.32460525e+00  7.32460525e+00
  1.32826207e+01  3.35305382e+01  3.35305382e+01  3.35305382e+01
  1.10372879e+02  1.29086987e+02  1.29086987e+02  1.29086987e+02
  4.83393283e+02  4.83393283e+02  4.83393283e+02  5.95560847e+02
  1.33516770e+03  1.33516770e+03  1.33516770e+03  2.66484942e+03
  3.02932763e+03  3.02932763e+03  3.02932763e+03  6.64970582e+03
  6.64970582e+03  6.64970582e+03  9.06977395e+03  2.54248346e+04
  7.61665444e+04]
E1 = -728.4206203914422  E_coul = 201.68234325191742
cycle= 2 E= -526.738277139525  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750107
diis-c [-0.00328663  0.08236164  0.91763836]
  HOMO = -0.58150054352808  LUMO = 0.990294894069362
  mo_energy =
[-1.18568716e+02 -1.23038561e+01 -9.55531336e+00 -9.55531336e+00
 -9.55531336e+00 -1.26851701e+00 -5.81500544e-01 -5.81500544e-01
 -5.81500544e-01  9.90294894e-01  1.01907271e+00  1.01907271e+00
  1.01907271e+00  7.34835776e+00  7.34835776e+00  7.34835776e+00
  1.33134941e+01  3.35704686e+01  3.35704686e+01  3.35704686e+01
  1.10428557e+02  1.29142677e+02  1.29142677e+02  1.29142677e+02
  4.83459953e+02  4.83459953e+02  4.83459953e+02  5.95629866e+02
  1.33523841e+03  1.33523841e+03  1.33523841e+03  2.66492343e+03
  3.02940057e+03  3.02940057e+03  3.02940057e+03  6.64978050e+03
  6.64978050e+03  6.64978050e+03  9.06984944e+03  2.54249106e+04
  7.61666208e+04]
E1 = -728.2710182971621  E_coul = 201.5326827406829
cycle= 3 E= -526.738335556479  delta_E= -5.84e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131178
diis-c [-5.83313579e-07 -1.25025571e-03  1.44356223e-01  8.56894033e-01]
  HOMO = -0.58299318487889  LUMO = 0.989053357819611
  mo_energy =
[-1.18578630e+02 -1.23096367e+01 -9.56143828e+00 -9.56143828e+00
 -9.56143828e+00 -1.27020165e+00 -5.82993185e-01 -5.82993185e-01
 -5.82993185e-01  9.89053358e-01  1.01799058e+00  1.01799058e+00
  1.01799058e+00  7.34458294e+00  7.34458294e+00  7.34458294e+00
  1.33087617e+01  3.35643243e+01  3.35643243e+01  3.35643243e+01
  1.10420300e+02  1.29134368e+02  1.29134368e+02  1.29134368e+02
  4.83450155e+02  4.83450155e+02  4.83450155e+02  5.95619714e+02
  1.33522802e+03  1.33522802e+03  1.33522802e+03  2.66491241e+03
  3.02938980e+03  3.02938980e+03  3.02938980e+03  6.64976934e+03
  6.64976934e+03  6.64976934e+03  9.06983806e+03  2.54248991e+04
  7.61666091e+04]
E1 = -728.2936754017885  E_coul = 201.55533794552778
cycle= 4 E= -526.738337456261  delta_E= -1.9e-06  |g|= 9.71e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113003
diis-c [-4.09086927e-09  7.13212063e-05 -1.02097728e-02 -6.63880711e-02
  1.07652652e+00]
  HOMO = -0.582974990259857  LUMO = 0.989086969503146
  mo_energy =
[-1.18578590e+02 -1.23095726e+01 -9.56138759e+00 -9.56138759e+00
 -9.56138759e+00 -1.27016099e+00 -5.82974990e-01 -5.82974990e-01
 -5.82974990e-01  9.89086970e-01  1.01800630e+00  1.01800630e+00
  1.01800630e+00  7.34462440e+00  7.34462440e+00  7.34462440e+00
  1.33088212e+01  3.35643730e+01  3.35643730e+01  3.35643730e+01
  1.10420351e+02  1.29134416e+02  1.29134416e+02  1.29134416e+02
  4.83450195e+02  4.83450195e+02  4.83450195e+02  5.95619747e+02
  1.33522805e+03  1.33522805e+03  1.33522805e+03  2.66491242e+03
  3.02938982e+03  3.02938982e+03  3.02938982e+03  6.64976934e+03
  6.64976934e+03  6.64976934e+03  9.06983806e+03  2.54248991e+04
  7.61666091e+04]
E1 = -728.2934638508316  E_coul = 201.55512639290225
cycle= 5 E= -526.738337457929  delta_E= -1.67e-09  |g|= 2.05e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86703e-05
diis-c [-7.48310010e-11  1.43201814e-05 -1.84516618e-03 -1.38600995e-02
  4.36826850e-02  9.72008260e-01]
  HOMO = -0.582982406694017  LUMO = 0.989083033441482
  mo_energy =
[-1.18578621e+02 -1.23095951e+01 -9.56141192e+00 -9.56141192e+00
 -9.56141192e+00 -1.27016690e+00 -5.82982407e-01 -5.82982407e-01
 -5.82982407e-01  9.89083033e-01  1.01800135e+00  1.01800135e+00
  1.01800135e+00  7.34460783e+00  7.34460783e+00  7.34460783e+00
  1.33088027e+01  3.35643494e+01  3.35643494e+01  3.35643494e+01
  1.10420324e+02  1.29134388e+02  1.29134388e+02  1.29134388e+02
  4.83450164e+02  4.83450164e+02  4.83450164e+02  5.95619716e+02
  1.33522802e+03  1.33522802e+03  1.33522802e+03  2.66491239e+03
  3.02938979e+03  3.02938979e+03  3.02938979e+03  6.64976931e+03
  6.64976931e+03  6.64976931e+03  9.06983803e+03  2.54248990e+04
  7.61666090e+04]
E1 = -728.2935445750256  E_coul = 201.55520711703898
cycle= 6 E= -526.738337457987  delta_E= -5.73e-11  |g|= 1.76e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2935445750256  E_coul = 201.55520711703898
  HOMO = -0.58298243392083  LUMO = 0.989083367858363
  mo_energy =
[-1.18578621e+02 -1.23095949e+01 -9.56141187e+00 -9.56141187e+00
 -9.56141187e+00 -1.27016654e+00 -5.82982434e-01 -5.82982434e-01
 -5.82982434e-01  9.89083368e-01  1.01800139e+00  1.01800139e+00
  1.01800139e+00  7.34460787e+00  7.34460787e+00  7.34460787e+00
  1.33088029e+01  3.35643495e+01  3.35643495e+01  3.35643495e+01
  1.10420324e+02  1.29134388e+02  1.29134388e+02  1.29134388e+02
  4.83450165e+02  4.83450165e+02  4.83450165e+02  5.95619716e+02
  1.33522802e+03  1.33522802e+03  1.33522802e+03  2.66491239e+03
  3.02938979e+03  3.02938979e+03  3.02938979e+03  6.64976931e+03
  6.64976931e+03  6.64976931e+03  9.06983803e+03  2.54248990e+04
  7.61666090e+04]
E1 = -728.2935435834532  E_coul = 201.55520612546638
Extra cycle  E= -526.738337457987  delta_E= -2.27e-13  |g|= 3.63e-07  |ddm|= 3.09e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103795.41053976571
E1 = -728.2935435834532  E_coul = 201.55520612546638
init E= -526.738337457987
    CPU time for initialize scf      0.91 sec, wall time      0.24 sec
  HOMO = -0.582982465434967  LUMO = 0.98908341428882
  mo_energy =
[-1.18578621e+02 -1.23095950e+01 -9.56141196e+00 -9.56141196e+00
 -9.56141196e+00 -1.27016649e+00 -5.82982465e-01 -5.82982465e-01
 -5.82982465e-01  9.89083414e-01  1.01800138e+00  1.01800138e+00
  1.01800138e+00  7.34460781e+00  7.34460781e+00  7.34460781e+00
  1.33088028e+01  3.35643494e+01  3.35643494e+01  3.35643494e+01
  1.10420324e+02  1.29134388e+02  1.29134388e+02  1.29134388e+02
  4.83450164e+02  4.83450164e+02  4.83450164e+02  5.95619716e+02
  1.33522802e+03  1.33522802e+03  1.33522802e+03  2.66491239e+03
  3.02938979e+03  3.02938979e+03  3.02938979e+03  6.64976931e+03
  6.64976931e+03  6.64976931e+03  9.06983802e+03  2.54248990e+04
  7.61666090e+04]
E1 = -728.2935437411505  E_coul = 201.55520628316327
cycle= 1 E= -526.738337457987  delta_E= -3.41e-13  |g|= 7.61e-08  |ddm|= 6.07e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2935437411505  E_coul = 201.55520628316327
  HOMO = -0.582982465106332  LUMO = 0.989083429590791
  mo_energy =
[-1.18578621e+02 -1.23095950e+01 -9.56141195e+00 -9.56141195e+00
 -9.56141195e+00 -1.27016647e+00 -5.82982465e-01 -5.82982465e-01
 -5.82982465e-01  9.89083430e-01  1.01800138e+00  1.01800138e+00
  1.01800138e+00  7.34460782e+00  7.34460782e+00  7.34460782e+00
  1.33088029e+01  3.35643494e+01  3.35643494e+01  3.35643494e+01
  1.10420324e+02  1.29134388e+02  1.29134388e+02  1.29134388e+02
  4.83450164e+02  4.83450164e+02  4.83450164e+02  5.95619716e+02
  1.33522802e+03  1.33522802e+03  1.33522802e+03  2.66491239e+03
  3.02938979e+03  3.02938979e+03  3.02938979e+03  6.64976931e+03
  6.64976931e+03  6.64976931e+03  9.06983802e+03  2.54248990e+04
  7.61666090e+04]
E1 = -728.2935436719508  E_coul = 201.55520621396306
Extra cycle  E= -526.738337457988  delta_E= -5.68e-13  |g|= 1.54e-08  |ddm|= 1.28e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826578e+04 7.61751774e+03 3.61735296e+03 1.59774002e+03
 3.82755878e+02 1.09714021e+02 3.59143804e+01 8.61673925e+00
 3.32728950e+00 6.55635864e-01 2.42680185e-01 1.36278386e+03
 6.64739196e+02 3.00931402e+02 3.14015900e+02 6.16470146e+01
 7.35767778e+00 2.02225246e+01 7.77926720e-01 2.83913262e+00
 2.23132889e-01]
grad_E = [-1.53010618e-06  3.44614256e-06 -1.50454803e-06  7.44188019e-05
 -1.43610847e-04 -2.73822446e-04 -1.79902101e-03  7.89815698e-04
  2.42248966e-03 -1.01595026e-03  3.54984117e-04 -5.14438886e-07
  4.90396217e-06  2.30036989e-05  1.98331218e-05  4.03844088e-05
 -1.10566246e-04 -3.06913286e-04  7.19286470e-04  1.63406830e-03
 -2.22081110e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6580236        1
[INPUT] 0    0    [1    /1   ]  7617.51727746        1
[INPUT] 0    0    [1    /1   ]  3617.3531916         1
[INPUT] 0    0    [1    /1   ]  1597.73058434        1
[INPUT] 0    0    [1    /1   ]  382.747156441        1
[INPUT] 0    0    [1    /1   ]  109.886145073        1
[INPUT] 0    0    [1    /1   ]  36.0217115472        1
[INPUT] 0    0    [1    /1   ]  8.69761819509        1
[INPUT] 0    0    [1    /1   ]  3.3426386841         1
[INPUT] 0    0    [1    /1   ]  0.656678174304       1
[INPUT] 0    0    [1    /1   ]  0.24320332241        1
[INPUT] 1    0    [1    /1   ]  1362.78393322        1
[INPUT] 1    0    [1    /1   ]  664.738484935        1
[INPUT] 1    0    [1    /1   ]  300.928041646        1
[INPUT] 1    0    [1    /1   ]  314.013003049        1
[INPUT] 1    0    [1    /1   ]  61.6516674128        1
[INPUT] 1    0    [1    /1   ]  7.37873897113        1
[INPUT] 1    0    [1    /1   ]  20.2073519215        1
[INPUT] 1    0    [1    /1   ]  0.779789511618       1
[INPUT] 1    0    [1    /1   ]  2.85793263247        1
[INPUT] 1    0    [1    /1   ]  0.223538733749       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65802357191, 1.0]], [0, [7617.517277462996, 1.0]], [0, [3617.353191603867, 1.0]], [0, [1597.7305843354152, 1.0]], [0, [382.74715644095596, 1.0]], [0, [109.88614507324613, 1.0]], [0, [36.021711547238915, 1.0]], [0, [8.697618195092568, 1.0]], [0, [3.3426386841043443, 1.0]], [0, [0.6566781743035629, 1.0]], [0, [0.24320332240957246, 1.0]], [1, [1362.7839332217718, 1.0]], [1, [664.7384849349298, 1.0]], [1, [300.92804164620804, 1.0]], [1, [314.0130030490659, 1.0]], [1, [61.65166741275396, 1.0]], [1, [7.378738971133684, 1.0]], [1, [20.207351921486328, 1.0]], [1, [0.7797895116184805, 1.0]], [1, [2.8579326324690224, 1.0]], [1, [0.2235387337485997, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65802357]
bas 1, expnt(s) = [7617.51727746]
bas 2, expnt(s) = [3617.3531916]
bas 3, expnt(s) = [1597.73058434]
bas 4, expnt(s) = [382.74715644]
bas 5, expnt(s) = [109.88614507]
bas 6, expnt(s) = [36.02171155]
bas 7, expnt(s) = [8.6976182]
bas 8, expnt(s) = [3.34263868]
bas 9, expnt(s) = [0.65667817]
bas 10, expnt(s) = [0.24320332]
bas 11, expnt(s) = [1362.78393322]
bas 12, expnt(s) = [664.73848493]
bas 13, expnt(s) = [300.92804165]
bas 14, expnt(s) = [314.01300305]
bas 15, expnt(s) = [61.65166741]
bas 16, expnt(s) = [7.37873897]
bas 17, expnt(s) = [20.20735192]
bas 18, expnt(s) = [0.77978951]
bas 19, expnt(s) = [2.85793263]
bas 20, expnt(s) = [0.22353873]
CPU time:       236.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826580e+04 5.20026319e+03 7.61751728e+03 2.06003742e+03
 3.61735319e+03 1.17844199e+03 1.59773058e+03 6.38473220e+02
 3.82747156e+02 2.18624588e+02 1.09886145e+02 8.57476502e+01
 3.60217115e+01 3.71482434e+01 8.69761820e+00 1.27957362e+01
 3.34263868e+00 6.24571410e+00 6.56678174e-01 1.84301751e+00
 2.43203322e-01 8.74967964e-01 1.36278393e+03 2.41556177e+04
 6.64738485e+02 9.84686358e+03 3.00928042e+02 3.65647591e+03
 3.14013003e+02 3.85628331e+03 6.16516674e+01 5.03982465e+02
 7.37873897e+00 3.54782407e+01 2.02073519e+01 1.24988814e+02
 7.79789512e-01 2.13774613e+00 2.85793263e+00 1.08405016e+01
 2.23538734e-01 4.48410089e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993424901138205
cond(S) = 103847.9143090048
E1 = -729.5300998647716  E_coul = 203.1789426406842
init E= -526.351157224087
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55574429603299  LUMO = 1.01432412610593
  mo_energy =
[-1.18328632e+02 -1.22043793e+01 -9.44682441e+00 -9.44682441e+00
 -9.44682441e+00 -1.24000102e+00 -5.55744296e-01 -5.55744296e-01
 -5.55744296e-01  1.01432413e+00  1.04000510e+00  1.04000510e+00
  1.04000510e+00  7.46249665e+00  7.46249665e+00  7.46249665e+00
  1.35367929e+01  3.37987357e+01  3.37987357e+01  3.37987357e+01
  1.11261696e+02  1.29420203e+02  1.29420203e+02  1.29420203e+02
  4.83778356e+02  4.83778356e+02  4.83778356e+02  5.97108084e+02
  1.33559397e+03  1.33559397e+03  1.33559397e+03  2.66666138e+03
  3.02980617e+03  3.02980617e+03  3.02980617e+03  6.65028602e+03
  6.65028602e+03  6.65028602e+03  9.07163178e+03  2.54267187e+04
  7.61684364e+04]
E1 = -727.8514921133263  E_coul = 201.11385753454482
cycle= 1 E= -526.737634578782  delta_E= -0.386  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542159
diis-c [-0.29393644  1.        ]
  HOMO = -0.590500546809126  LUMO = 0.985926635950999
  mo_energy =
[-1.18635935e+02 -1.23415445e+01 -9.59470098e+00 -9.59470098e+00
 -9.59470098e+00 -1.27929677e+00 -5.90500547e-01 -5.90500547e-01
 -5.90500547e-01  9.85926636e-01  1.01559563e+00  1.01559563e+00
  1.01559563e+00  7.37134514e+00  7.37134514e+00  7.37134514e+00
  1.34237188e+01  3.36450687e+01  3.36450687e+01  3.36450687e+01
  1.11040904e+02  1.29192520e+02  1.29192520e+02  1.29192520e+02
  4.83472226e+02  4.83472226e+02  4.83472226e+02  5.96763657e+02
  1.33523114e+03  1.33523114e+03  1.33523114e+03  2.66616452e+03
  3.02937735e+03  3.02937735e+03  3.02937735e+03  6.64974398e+03
  6.64974398e+03  6.64974398e+03  9.07101457e+03  2.54260074e+04
  7.61676350e+04]
E1 = -728.4225109884541  E_coul = 201.68416211471117
cycle= 2 E= -526.738348873743  delta_E= -0.000714  |g|= 0.0375  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0749622
diis-c [-0.00328677  0.08221875  0.91778125]
  HOMO = -0.581434660866995  LUMO = 0.994077025527538
  mo_energy =
[-1.18568530e+02 -1.23036898e+01 -9.55520456e+00 -9.55520456e+00
 -9.55520456e+00 -1.26844439e+00 -5.81434661e-01 -5.81434661e-01
 -5.81434661e-01  9.94077026e-01  1.02233973e+00  1.02233973e+00
  1.02233973e+00  7.39514008e+00  7.39514008e+00  7.39514008e+00
  1.34546885e+01  3.36849552e+01  3.36849552e+01  3.36849552e+01
  1.11096554e+02  1.29248134e+02  1.29248134e+02  1.29248134e+02
  4.83538814e+02  4.83538814e+02  4.83538814e+02  5.96832596e+02
  1.33530176e+03  1.33530176e+03  1.33530176e+03  2.66623844e+03
  3.02945020e+03  3.02945020e+03  3.02945020e+03  6.64981857e+03
  6.64981857e+03  6.64981857e+03  9.07108997e+03  2.54260834e+04
  7.61677112e+04]
E1 = -728.2731858622595  E_coul = 201.5347787582963
cycle= 3 E= -526.738407103963  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131164
diis-c [-5.83147876e-07 -1.24921866e-03  1.44429043e-01  8.56820175e-01]
  HOMO = -0.582925030994312  LUMO = 0.992833377716424
  mo_energy =
[-1.18578434e+02 -1.23094631e+01 -9.56132231e+00 -9.56132231e+00
 -9.56132231e+00 -1.27012626e+00 -5.82925031e-01 -5.82925031e-01
 -5.82925031e-01  9.92833378e-01  1.02125535e+00  1.02125535e+00
  1.02125535e+00  7.39135843e+00  7.39135843e+00  7.39135843e+00
  1.34499423e+01  3.36788168e+01  3.36788168e+01  3.36788168e+01
  1.11088300e+02  1.29239835e+02  1.29239835e+02  1.29239835e+02
  4.83529025e+02  4.83529025e+02  4.83529025e+02  5.96822453e+02
  1.33529138e+03  1.33529138e+03  1.33529138e+03  2.66622743e+03
  3.02943944e+03  3.02943944e+03  3.02943944e+03  6.64980742e+03
  6.64980742e+03  6.64980742e+03  9.07107860e+03  2.54260718e+04
  7.61676996e+04]
E1 = -728.2958044997891  E_coul = 201.55739550097888
cycle= 4 E= -526.73840899881  delta_E= -1.89e-06  |g|= 9.73e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113826
diis-c [-4.08247632e-09  7.18543532e-05 -1.02807715e-02 -6.68634476e-02
  1.07707236e+00]
  HOMO = -0.582907002091956  LUMO = 0.992866975402016
  mo_energy =
[-1.18578395e+02 -1.23093995e+01 -9.56127216e+00 -9.56127216e+00
 -9.56127216e+00 -1.27008575e+00 -5.82907002e-01 -5.82907002e-01
 -5.82907002e-01  9.92866975e-01  1.02127100e+00  1.02127100e+00
  1.02127100e+00  7.39139958e+00  7.39139958e+00  7.39139958e+00
  1.34500014e+01  3.36788650e+01  3.36788650e+01  3.36788650e+01
  1.11088350e+02  1.29239881e+02  1.29239881e+02  1.29239881e+02
  4.83529065e+02  4.83529065e+02  4.83529065e+02  5.96822485e+02
  1.33529141e+03  1.33529141e+03  1.33529141e+03  2.66622744e+03
  3.02943946e+03  3.02943946e+03  3.02943946e+03  6.64980742e+03
  6.64980742e+03  6.64980742e+03  9.07107860e+03  2.54260718e+04
  7.61676996e+04]
E1 = -728.2955948593202  E_coul = 201.55718585883767
cycle= 5 E= -526.738409000483  delta_E= -1.67e-09  |g|= 2.05e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86255e-05
diis-c [-7.47054414e-11  1.42794212e-05 -1.84321280e-03 -1.38431032e-02
  4.37252971e-02  9.71946739e-01]
  HOMO = -0.58291441124085  LUMO = 0.992863026318913
  mo_energy =
[-1.18578426e+02 -1.23094220e+01 -9.56129647e+00 -9.56129647e+00
 -9.56129647e+00 -1.27009166e+00 -5.82914411e-01 -5.82914411e-01
 -5.82914411e-01  9.92863026e-01  1.02126605e+00  1.02126605e+00
  1.02126605e+00  7.39138298e+00  7.39138298e+00  7.39138298e+00
  1.34499828e+01  3.36788414e+01  3.36788414e+01  3.36788414e+01
  1.11088323e+02  1.29239854e+02  1.29239854e+02  1.29239854e+02
  4.83529034e+02  4.83529034e+02  4.83529034e+02  5.96822454e+02
  1.33529138e+03  1.33529138e+03  1.33529138e+03  2.66622741e+03
  3.02943943e+03  3.02943943e+03  3.02943943e+03  6.64980739e+03
  6.64980739e+03  6.64980739e+03  9.07107857e+03  2.54260718e+04
  7.61676995e+04]
E1 = -728.2956754781471  E_coul = 201.5572664776056
cycle= 6 E= -526.738409000542  delta_E= -5.9e-11  |g|= 1.76e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2956754781471  E_coul = 201.5572664776056
  HOMO = -0.582914435262523  LUMO = 0.992863363258407
  mo_energy =
[-1.18578426e+02 -1.23094218e+01 -9.56129641e+00 -9.56129641e+00
 -9.56129641e+00 -1.27009129e+00 -5.82914435e-01 -5.82914435e-01
 -5.82914435e-01  9.92863363e-01  1.02126609e+00  1.02126609e+00
  1.02126609e+00  7.39138303e+00  7.39138303e+00  7.39138303e+00
  1.34499830e+01  3.36788415e+01  3.36788415e+01  3.36788415e+01
  1.11088323e+02  1.29239854e+02  1.29239854e+02  1.29239854e+02
  4.83529035e+02  4.83529035e+02  4.83529035e+02  5.96822454e+02
  1.33529138e+03  1.33529138e+03  1.33529138e+03  2.66622741e+03
  3.02943943e+03  3.02943943e+03  3.02943943e+03  6.64980739e+03
  6.64980739e+03  6.64980739e+03  9.07107857e+03  2.54260718e+04
  7.61676995e+04]
E1 = -728.2956744490658  E_coul = 201.5572654485244
Extra cycle  E= -526.738409000541  delta_E= 1.14e-13  |g|= 3.62e-07  |ddm|= 3.09e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826580e+04 7.61751728e+03 3.61735319e+03 1.59773058e+03
 3.82747156e+02 1.09886145e+02 3.60217115e+01 8.69761820e+00
 3.34263868e+00 6.56678174e-01 2.43203322e-01 1.36278393e+03
 6.64738485e+02 3.00928042e+02 3.14013003e+02 6.16516674e+01
 7.37873897e+00 2.02073519e+01 7.79789512e-01 2.85793263e+00
 2.23538734e-01]
E = -526.7384090005414
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6580236        1
[INPUT] 0    0    [1    /1   ]  7617.51727746        1
[INPUT] 0    0    [1    /1   ]  3617.3531916         1
[INPUT] 0    0    [1    /1   ]  1597.73058434        1
[INPUT] 0    0    [1    /1   ]  382.747156441        1
[INPUT] 0    0    [1    /1   ]  109.886145073        1
[INPUT] 0    0    [1    /1   ]  36.0217115472        1
[INPUT] 0    0    [1    /1   ]  8.69761819509        1
[INPUT] 0    0    [1    /1   ]  3.3426386841         1
[INPUT] 0    0    [1    /1   ]  0.656678174304       1
[INPUT] 0    0    [1    /1   ]  0.24320332241        1
[INPUT] 1    0    [1    /1   ]  1362.78393322        1
[INPUT] 1    0    [1    /1   ]  664.738484935        1
[INPUT] 1    0    [1    /1   ]  300.928041646        1
[INPUT] 1    0    [1    /1   ]  314.013003049        1
[INPUT] 1    0    [1    /1   ]  61.6516674128        1
[INPUT] 1    0    [1    /1   ]  7.37873897113        1
[INPUT] 1    0    [1    /1   ]  20.2073519215        1
[INPUT] 1    0    [1    /1   ]  0.779789511618       1
[INPUT] 1    0    [1    /1   ]  2.85793263247        1
[INPUT] 1    0    [1    /1   ]  0.223538733749       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65802357191, 1.0]], [0, [7617.517277462996, 1.0]], [0, [3617.353191603867, 1.0]], [0, [1597.7305843354152, 1.0]], [0, [382.74715644095596, 1.0]], [0, [109.88614507324613, 1.0]], [0, [36.021711547238915, 1.0]], [0, [8.697618195092568, 1.0]], [0, [3.3426386841043443, 1.0]], [0, [0.6566781743035629, 1.0]], [0, [0.24320332240957246, 1.0]], [1, [1362.7839332217718, 1.0]], [1, [664.7384849349298, 1.0]], [1, [300.92804164620804, 1.0]], [1, [314.0130030490659, 1.0]], [1, [61.65166741275396, 1.0]], [1, [7.378738971133684, 1.0]], [1, [20.207351921486328, 1.0]], [1, [0.7797895116184805, 1.0]], [1, [2.8579326324690224, 1.0]], [1, [0.2235387337485997, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65802357]
bas 1, expnt(s) = [7617.51727746]
bas 2, expnt(s) = [3617.3531916]
bas 3, expnt(s) = [1597.73058434]
bas 4, expnt(s) = [382.74715644]
bas 5, expnt(s) = [109.88614507]
bas 6, expnt(s) = [36.02171155]
bas 7, expnt(s) = [8.6976182]
bas 8, expnt(s) = [3.34263868]
bas 9, expnt(s) = [0.65667817]
bas 10, expnt(s) = [0.24320332]
bas 11, expnt(s) = [1362.78393322]
bas 12, expnt(s) = [664.73848493]
bas 13, expnt(s) = [300.92804165]
bas 14, expnt(s) = [314.01300305]
bas 15, expnt(s) = [61.65166741]
bas 16, expnt(s) = [7.37873897]
bas 17, expnt(s) = [20.20735192]
bas 18, expnt(s) = [0.77978951]
bas 19, expnt(s) = [2.85793263]
bas 20, expnt(s) = [0.22353873]
CPU time:       237.43
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826580e+04 5.20026319e+03 7.61751728e+03 2.06003742e+03
 3.61735319e+03 1.17844199e+03 1.59773058e+03 6.38473220e+02
 3.82747156e+02 2.18624588e+02 1.09886145e+02 8.57476502e+01
 3.60217115e+01 3.71482434e+01 8.69761820e+00 1.27957362e+01
 3.34263868e+00 6.24571410e+00 6.56678174e-01 1.84301751e+00
 2.43203322e-01 8.74967964e-01 1.36278393e+03 2.41556177e+04
 6.64738485e+02 9.84686358e+03 3.00928042e+02 3.65647591e+03
 3.14013003e+02 3.85628331e+03 6.16516674e+01 5.03982465e+02
 7.37873897e+00 3.54782407e+01 2.02073519e+01 1.24988814e+02
 7.79789512e-01 2.13774613e+00 2.85793263e+00 1.08405016e+01
 2.23538734e-01 4.48410089e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993424901138205
cond(S) = 103847.9143090048
E1 = -729.5300998647716  E_coul = 203.1789426406842
init E= -526.351157224087
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55574429603299  LUMO = 1.01432412610593
  mo_energy =
[-1.18328632e+02 -1.22043793e+01 -9.44682441e+00 -9.44682441e+00
 -9.44682441e+00 -1.24000102e+00 -5.55744296e-01 -5.55744296e-01
 -5.55744296e-01  1.01432413e+00  1.04000510e+00  1.04000510e+00
  1.04000510e+00  7.46249665e+00  7.46249665e+00  7.46249665e+00
  1.35367929e+01  3.37987357e+01  3.37987357e+01  3.37987357e+01
  1.11261696e+02  1.29420203e+02  1.29420203e+02  1.29420203e+02
  4.83778356e+02  4.83778356e+02  4.83778356e+02  5.97108084e+02
  1.33559397e+03  1.33559397e+03  1.33559397e+03  2.66666138e+03
  3.02980617e+03  3.02980617e+03  3.02980617e+03  6.65028602e+03
  6.65028602e+03  6.65028602e+03  9.07163178e+03  2.54267187e+04
  7.61684364e+04]
E1 = -727.8514921133263  E_coul = 201.11385753454482
cycle= 1 E= -526.737634578782  delta_E= -0.386  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542159
diis-c [-0.29393644  1.        ]
  HOMO = -0.590500546809126  LUMO = 0.985926635950999
  mo_energy =
[-1.18635935e+02 -1.23415445e+01 -9.59470098e+00 -9.59470098e+00
 -9.59470098e+00 -1.27929677e+00 -5.90500547e-01 -5.90500547e-01
 -5.90500547e-01  9.85926636e-01  1.01559563e+00  1.01559563e+00
  1.01559563e+00  7.37134514e+00  7.37134514e+00  7.37134514e+00
  1.34237188e+01  3.36450687e+01  3.36450687e+01  3.36450687e+01
  1.11040904e+02  1.29192520e+02  1.29192520e+02  1.29192520e+02
  4.83472226e+02  4.83472226e+02  4.83472226e+02  5.96763657e+02
  1.33523114e+03  1.33523114e+03  1.33523114e+03  2.66616452e+03
  3.02937735e+03  3.02937735e+03  3.02937735e+03  6.64974398e+03
  6.64974398e+03  6.64974398e+03  9.07101457e+03  2.54260074e+04
  7.61676350e+04]
E1 = -728.4225109884541  E_coul = 201.68416211471117
cycle= 2 E= -526.738348873743  delta_E= -0.000714  |g|= 0.0375  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0749622
diis-c [-0.00328677  0.08221875  0.91778125]
  HOMO = -0.581434660866995  LUMO = 0.994077025527538
  mo_energy =
[-1.18568530e+02 -1.23036898e+01 -9.55520456e+00 -9.55520456e+00
 -9.55520456e+00 -1.26844439e+00 -5.81434661e-01 -5.81434661e-01
 -5.81434661e-01  9.94077026e-01  1.02233973e+00  1.02233973e+00
  1.02233973e+00  7.39514008e+00  7.39514008e+00  7.39514008e+00
  1.34546885e+01  3.36849552e+01  3.36849552e+01  3.36849552e+01
  1.11096554e+02  1.29248134e+02  1.29248134e+02  1.29248134e+02
  4.83538814e+02  4.83538814e+02  4.83538814e+02  5.96832596e+02
  1.33530176e+03  1.33530176e+03  1.33530176e+03  2.66623844e+03
  3.02945020e+03  3.02945020e+03  3.02945020e+03  6.64981857e+03
  6.64981857e+03  6.64981857e+03  9.07108997e+03  2.54260834e+04
  7.61677112e+04]
E1 = -728.2731858622595  E_coul = 201.5347787582963
cycle= 3 E= -526.738407103963  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131164
diis-c [-5.83147876e-07 -1.24921866e-03  1.44429043e-01  8.56820175e-01]
  HOMO = -0.582925030994312  LUMO = 0.992833377716424
  mo_energy =
[-1.18578434e+02 -1.23094631e+01 -9.56132231e+00 -9.56132231e+00
 -9.56132231e+00 -1.27012626e+00 -5.82925031e-01 -5.82925031e-01
 -5.82925031e-01  9.92833378e-01  1.02125535e+00  1.02125535e+00
  1.02125535e+00  7.39135843e+00  7.39135843e+00  7.39135843e+00
  1.34499423e+01  3.36788168e+01  3.36788168e+01  3.36788168e+01
  1.11088300e+02  1.29239835e+02  1.29239835e+02  1.29239835e+02
  4.83529025e+02  4.83529025e+02  4.83529025e+02  5.96822453e+02
  1.33529138e+03  1.33529138e+03  1.33529138e+03  2.66622743e+03
  3.02943944e+03  3.02943944e+03  3.02943944e+03  6.64980742e+03
  6.64980742e+03  6.64980742e+03  9.07107860e+03  2.54260718e+04
  7.61676996e+04]
E1 = -728.2958044997891  E_coul = 201.55739550097888
cycle= 4 E= -526.73840899881  delta_E= -1.89e-06  |g|= 9.73e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113826
diis-c [-4.08247632e-09  7.18543532e-05 -1.02807715e-02 -6.68634476e-02
  1.07707236e+00]
  HOMO = -0.582907002091956  LUMO = 0.992866975402016
  mo_energy =
[-1.18578395e+02 -1.23093995e+01 -9.56127216e+00 -9.56127216e+00
 -9.56127216e+00 -1.27008575e+00 -5.82907002e-01 -5.82907002e-01
 -5.82907002e-01  9.92866975e-01  1.02127100e+00  1.02127100e+00
  1.02127100e+00  7.39139958e+00  7.39139958e+00  7.39139958e+00
  1.34500014e+01  3.36788650e+01  3.36788650e+01  3.36788650e+01
  1.11088350e+02  1.29239881e+02  1.29239881e+02  1.29239881e+02
  4.83529065e+02  4.83529065e+02  4.83529065e+02  5.96822485e+02
  1.33529141e+03  1.33529141e+03  1.33529141e+03  2.66622744e+03
  3.02943946e+03  3.02943946e+03  3.02943946e+03  6.64980742e+03
  6.64980742e+03  6.64980742e+03  9.07107860e+03  2.54260718e+04
  7.61676996e+04]
E1 = -728.2955948593202  E_coul = 201.55718585883767
cycle= 5 E= -526.738409000483  delta_E= -1.67e-09  |g|= 2.05e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86255e-05
diis-c [-7.47054414e-11  1.42794212e-05 -1.84321280e-03 -1.38431032e-02
  4.37252971e-02  9.71946739e-01]
  HOMO = -0.58291441124085  LUMO = 0.992863026318913
  mo_energy =
[-1.18578426e+02 -1.23094220e+01 -9.56129647e+00 -9.56129647e+00
 -9.56129647e+00 -1.27009166e+00 -5.82914411e-01 -5.82914411e-01
 -5.82914411e-01  9.92863026e-01  1.02126605e+00  1.02126605e+00
  1.02126605e+00  7.39138298e+00  7.39138298e+00  7.39138298e+00
  1.34499828e+01  3.36788414e+01  3.36788414e+01  3.36788414e+01
  1.11088323e+02  1.29239854e+02  1.29239854e+02  1.29239854e+02
  4.83529034e+02  4.83529034e+02  4.83529034e+02  5.96822454e+02
  1.33529138e+03  1.33529138e+03  1.33529138e+03  2.66622741e+03
  3.02943943e+03  3.02943943e+03  3.02943943e+03  6.64980739e+03
  6.64980739e+03  6.64980739e+03  9.07107857e+03  2.54260718e+04
  7.61676995e+04]
E1 = -728.2956754781471  E_coul = 201.5572664776056
cycle= 6 E= -526.738409000542  delta_E= -5.9e-11  |g|= 1.76e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2956754781471  E_coul = 201.5572664776056
  HOMO = -0.582914435262523  LUMO = 0.992863363258407
  mo_energy =
[-1.18578426e+02 -1.23094218e+01 -9.56129641e+00 -9.56129641e+00
 -9.56129641e+00 -1.27009129e+00 -5.82914435e-01 -5.82914435e-01
 -5.82914435e-01  9.92863363e-01  1.02126609e+00  1.02126609e+00
  1.02126609e+00  7.39138303e+00  7.39138303e+00  7.39138303e+00
  1.34499830e+01  3.36788415e+01  3.36788415e+01  3.36788415e+01
  1.11088323e+02  1.29239854e+02  1.29239854e+02  1.29239854e+02
  4.83529035e+02  4.83529035e+02  4.83529035e+02  5.96822454e+02
  1.33529138e+03  1.33529138e+03  1.33529138e+03  2.66622741e+03
  3.02943943e+03  3.02943943e+03  3.02943943e+03  6.64980739e+03
  6.64980739e+03  6.64980739e+03  9.07107857e+03  2.54260718e+04
  7.61676995e+04]
E1 = -728.2956744490658  E_coul = 201.5572654485244
Extra cycle  E= -526.738409000541  delta_E= 1.14e-13  |g|= 3.62e-07  |ddm|= 3.09e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103847.9143090048
E1 = -728.2956744490658  E_coul = 201.5572654485244
init E= -526.738409000541
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582914467475171  LUMO = 0.992863408913501
  mo_energy =
[-1.18578426e+02 -1.23094219e+01 -9.56129650e+00 -9.56129650e+00
 -9.56129650e+00 -1.27009125e+00 -5.82914467e-01 -5.82914467e-01
 -5.82914467e-01  9.92863409e-01  1.02126607e+00  1.02126607e+00
  1.02126607e+00  7.39138297e+00  7.39138297e+00  7.39138297e+00
  1.34499830e+01  3.36788414e+01  3.36788414e+01  3.36788414e+01
  1.11088323e+02  1.29239854e+02  1.29239854e+02  1.29239854e+02
  4.83529034e+02  4.83529034e+02  4.83529034e+02  5.96822454e+02
  1.33529138e+03  1.33529138e+03  1.33529138e+03  2.66622741e+03
  3.02943943e+03  3.02943943e+03  3.02943943e+03  6.64980739e+03
  6.64980739e+03  6.64980739e+03  9.07107857e+03  2.54260718e+04
  7.61676995e+04]
E1 = -728.2956746173312  E_coul = 201.5572656167887
cycle= 1 E= -526.738409000543  delta_E= -1.14e-12  |g|= 7.6e-08  |ddm|= 6.05e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2956746173312  E_coul = 201.5572656167887
  HOMO = -0.582914466937479  LUMO = 0.992863424373199
  mo_energy =
[-1.18578426e+02 -1.23094219e+01 -9.56129649e+00 -9.56129649e+00
 -9.56129649e+00 -1.27009123e+00 -5.82914467e-01 -5.82914467e-01
 -5.82914467e-01  9.92863424e-01  1.02126608e+00  1.02126608e+00
  1.02126608e+00  7.39138297e+00  7.39138297e+00  7.39138297e+00
  1.34499830e+01  3.36788414e+01  3.36788414e+01  3.36788414e+01
  1.11088323e+02  1.29239854e+02  1.29239854e+02  1.29239854e+02
  4.83529034e+02  4.83529034e+02  4.83529034e+02  5.96822454e+02
  1.33529138e+03  1.33529138e+03  1.33529138e+03  2.66622741e+03
  3.02943943e+03  3.02943943e+03  3.02943943e+03  6.64980739e+03
  6.64980739e+03  6.64980739e+03  9.07107857e+03  2.54260718e+04
  7.61676995e+04]
E1 = -728.2956745452257  E_coul = 201.5572655446834
Extra cycle  E= -526.738409000542  delta_E= 2.27e-13  |g|= 1.54e-08  |ddm|= 1.28e-07
    CPU time for scf_cycle      1.24 sec, wall time      0.57 sec
exp = [2.61826580e+04 7.61751728e+03 3.61735319e+03 1.59773058e+03
 3.82747156e+02 1.09886145e+02 3.60217115e+01 8.69761820e+00
 3.34263868e+00 6.56678174e-01 2.43203322e-01 1.36278393e+03
 6.64738485e+02 3.00928042e+02 3.14013003e+02 6.16516674e+01
 7.37873897e+00 2.02073519e+01 7.79789512e-01 2.85793263e+00
 2.23538734e-01]
grad_E = [-1.53138156e-06  3.46030769e-06 -1.49593666e-06  7.49374248e-05
 -1.54178220e-04 -2.82024417e-04 -1.60795957e-03  1.24240119e-03
  1.34527054e-03 -7.70205778e-04  1.73141239e-04 -5.21518445e-07
  4.80435488e-06  2.24031534e-05  1.93173654e-05  1.05591495e-04
  3.82932166e-04 -7.25758333e-04  1.03663802e-03  2.24203338e-03
 -2.91825427e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6581308        1
[INPUT] 0    0    [1    /1   ]  7617.5170468         1
[INPUT] 0    0    [1    /1   ]  3617.35330558        1
[INPUT] 0    0    [1    /1   ]  1597.72582607        1
[INPUT] 0    0    [1    /1   ]  382.743773524        1
[INPUT] 0    0    [1    /1   ]  109.962577981        1
[INPUT] 0    0    [1    /1   ]  36.1013466806        1
[INPUT] 0    0    [1    /1   ]  8.75866999928        1
[INPUT] 0    0    [1    /1   ]  3.35429321037        1
[INPUT] 0    0    [1    /1   ]  0.658860257631       1
[INPUT] 0    0    [1    /1   ]  0.244093161692       1
[INPUT] 1    0    [1    /1   ]  1362.78396909        1
[INPUT] 1    0    [1    /1   ]  664.738128947        1
[INPUT] 1    0    [1    /1   ]  300.926361354        1
[INPUT] 1    0    [1    /1   ]  314.011554352        1
[INPUT] 1    0    [1    /1   ]  61.6535238074        1
[INPUT] 1    0    [1    /1   ]  7.38623886632        1
[INPUT] 1    0    [1    /1   ]  20.202833582         1
[INPUT] 1    0    [1    /1   ]  0.780184276161       1
[INPUT] 1    0    [1    /1   ]  2.86109149041        1
[INPUT] 1    0    [1    /1   ]  0.223673156926       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65813081179, 1.0]], [0, [7617.5170468016895, 1.0]], [0, [3617.35330558424, 1.0]], [0, [1597.725826074869, 1.0]], [0, [382.7437735244358, 1.0]], [0, [109.96257798084596, 1.0]], [0, [36.1013466805826, 1.0]], [0, [8.758669999283912, 1.0]], [0, [3.3542932103717003, 1.0]], [0, [0.6588602576311865, 1.0]], [0, [0.24409316169213857, 1.0]], [1, [1362.783969085685, 1.0]], [1, [664.7381289467398, 1.0]], [1, [300.9263613538805, 1.0]], [1, [314.01155435212075, 1.0]], [1, [61.65352380743767, 1.0]], [1, [7.3862388663183, 1.0]], [1, [20.202833581963514, 1.0]], [1, [0.7801842761609369, 1.0]], [1, [2.8610914904076408, 1.0]], [1, [0.2236731569258701, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65813081]
bas 1, expnt(s) = [7617.5170468]
bas 2, expnt(s) = [3617.35330558]
bas 3, expnt(s) = [1597.72582607]
bas 4, expnt(s) = [382.74377352]
bas 5, expnt(s) = [109.96257798]
bas 6, expnt(s) = [36.10134668]
bas 7, expnt(s) = [8.75867]
bas 8, expnt(s) = [3.35429321]
bas 9, expnt(s) = [0.65886026]
bas 10, expnt(s) = [0.24409316]
bas 11, expnt(s) = [1362.78396909]
bas 12, expnt(s) = [664.73812895]
bas 13, expnt(s) = [300.92636135]
bas 14, expnt(s) = [314.01155435]
bas 15, expnt(s) = [61.65352381]
bas 16, expnt(s) = [7.38623887]
bas 17, expnt(s) = [20.20283358]
bas 18, expnt(s) = [0.78018428]
bas 19, expnt(s) = [2.86109149]
bas 20, expnt(s) = [0.22367316]
CPU time:       243.40
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826581e+04 5.20026321e+03 7.61751705e+03 2.06003738e+03
 3.61735331e+03 1.17844202e+03 1.59772583e+03 6.38471794e+02
 3.82743774e+02 2.18623139e+02 1.09962578e+02 8.57923786e+01
 3.61013467e+01 3.72098206e+01 8.75867000e+00 1.28630408e+01
 3.35429321e+00 6.26203934e+00 6.58860258e-01 1.84760874e+00
 2.44093162e-01 8.77367886e-01 1.36278397e+03 2.41556185e+04
 6.64738129e+02 9.84685699e+03 3.00926361e+02 3.65645039e+03
 3.14011554e+02 3.85626107e+03 6.16535238e+01 5.04001434e+02
 7.38623887e+00 3.55233224e+01 2.02028336e+01 1.24953881e+02
 7.80184276e-01 2.13909900e+00 2.86109149e+00 1.08554811e+01
 2.23673157e-01 4.48747174e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99339337854705
cond(S) = 103883.90611613537
E1 = -729.5307986776387  E_coul = 203.17944222001665
init E= -526.351356457622
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555733103225824  LUMO = 1.02072543888774
  mo_energy =
[-1.18328651e+02 -1.22043090e+01 -9.44678154e+00 -9.44678154e+00
 -9.44678154e+00 -1.23997983e+00 -5.55733103e-01 -5.55733103e-01
 -5.55733103e-01  1.02072544e+00  1.04087569e+00  1.04087569e+00
  1.04087569e+00  7.47219301e+00  7.47219301e+00  7.47219301e+00
  1.36535221e+01  3.38265101e+01  3.38265101e+01  3.38265101e+01
  1.11749256e+02  1.29447652e+02  1.29447652e+02  1.29447652e+02
  4.83799699e+02  4.83799699e+02  4.83799699e+02  5.97884489e+02
  1.33560999e+03  1.33560999e+03  1.33560999e+03  2.66747214e+03
  3.02981656e+03  3.02981656e+03  3.02981656e+03  6.65029191e+03
  6.65029191e+03  6.65029191e+03  9.07239228e+03  2.54274378e+04
  7.61691052e+04]
E1 = -727.8530734475152  E_coul = 201.11540662766552
cycle= 1 E= -526.73766681985  delta_E= -0.386  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542121
diis-c [-0.29389474  1.        ]
  HOMO = -0.59043860070595  LUMO = 0.992219344264936
  mo_energy =
[-1.18635791e+02 -1.23414310e+01 -9.59462041e+00 -9.59462041e+00
 -9.59462041e+00 -1.27922311e+00 -5.90438601e-01 -5.90438601e-01
 -5.90438601e-01  9.92219344e-01  1.01648599e+00  1.01648599e+00
  1.01648599e+00  7.38102771e+00  7.38102771e+00  7.38102771e+00
  1.35400894e+01  3.36729002e+01  3.36729002e+01  3.36729002e+01
  1.11528361e+02  1.29220087e+02  1.29220087e+02  1.29220087e+02
  4.83493721e+02  4.83493721e+02  4.83493721e+02  5.97540259e+02
  1.33524739e+03  1.33524739e+03  1.33524739e+03  2.66697555e+03
  3.02938798e+03  3.02938798e+03  3.02938798e+03  6.64975014e+03
  6.64975014e+03  6.64975014e+03  9.07177537e+03  2.54267268e+04
  7.61683041e+04]
E1 = -728.4236723810554  E_coul = 201.68529210690596
cycle= 2 E= -526.738380274149  delta_E= -0.000713  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0749227
diis-c [-0.00328763  0.08211462  0.91788538]
  HOMO = -0.581379008034563  LUMO = 1.0004056874957
  mo_energy =
[-1.18568424e+02 -1.23035993e+01 -9.55514914e+00 -9.55514914e+00
 -9.55514914e+00 -1.26837773e+00 -5.81379008e-01 -5.81379008e-01
 -5.81379008e-01  1.00040569e+00  1.02323055e+00  1.02323055e+00
  1.02323055e+00  7.40482312e+00  7.40482312e+00  7.40482312e+00
  1.35711429e+01  3.37127655e+01  3.37127655e+01  3.37127655e+01
  1.11584006e+02  1.29275666e+02  1.29275666e+02  1.29275666e+02
  4.83560271e+02  4.83560271e+02  4.83560271e+02  5.97609160e+02
  1.33531797e+03  1.33531797e+03  1.33531797e+03  2.66704943e+03
  3.02946079e+03  3.02946079e+03  3.02946079e+03  6.64982469e+03
  6.64982469e+03  6.64982469e+03  9.07185073e+03  2.54268027e+04
  7.61683803e+04]
E1 = -728.2744625949281  E_coul = 201.53602417697977
cycle= 3 E= -526.738438417948  delta_E= -5.81e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131185
diis-c [-5.82164236e-07 -1.24882863e-03  1.44521351e-01  8.56727478e-01]
  HOMO = -0.582868553645181  LUMO = 0.999156292875268
  mo_energy =
[-1.18578328e+02 -1.23093712e+01 -9.56126563e+00 -9.56126563e+00
 -9.56126563e+00 -1.27005881e+00 -5.82868554e-01 -5.82868554e-01
 -5.82868554e-01  9.99156293e-01  1.02214592e+00  1.02214592e+00
  1.02214592e+00  7.40104020e+00  7.40104020e+00  7.40104020e+00
  1.35663828e+01  3.37066278e+01  3.37066278e+01  3.37066278e+01
  1.11575749e+02  1.29267369e+02  1.29267369e+02  1.29267369e+02
  4.83550483e+02  4.83550483e+02  4.83550483e+02  5.97599018e+02
  1.33530759e+03  1.33530759e+03  1.33530759e+03  2.66703843e+03
  3.02945003e+03  3.02945003e+03  3.02945003e+03  6.64981354e+03
  6.64981354e+03  6.64981354e+03  9.07183937e+03  2.54267912e+04
  7.61683687e+04]
E1 = -728.2970739572334  E_coul = 201.5586336451306
cycle= 4 E= -526.738440312103  delta_E= -1.89e-06  |g|= 9.73e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000114083
diis-c [-4.07246972e-09  7.19626234e-05 -1.02949806e-02 -6.69401005e-02
  1.07716312e+00]
  HOMO = -0.58285058597299  LUMO = 0.999189949888076
  mo_energy =
[-1.18578289e+02 -1.23093078e+01 -9.56121575e+00 -9.56121575e+00
 -9.56121575e+00 -1.27001839e+00 -5.82850586e-01 -5.82850586e-01
 -5.82850586e-01  9.99189950e-01  1.02216153e+00  1.02216153e+00
  1.02216153e+00  7.40108119e+00  7.40108119e+00  7.40108119e+00
  1.35664418e+01  3.37066757e+01  3.37066757e+01  3.37066757e+01
  1.11575799e+02  1.29267415e+02  1.29267415e+02  1.29267415e+02
  4.83550522e+02  4.83550522e+02  4.83550522e+02  5.97599049e+02
  1.33530762e+03  1.33530762e+03  1.33530762e+03  2.66703844e+03
  3.02945005e+03  3.02945005e+03  3.02945005e+03  6.64981354e+03
  6.64981354e+03  6.64981354e+03  9.07183936e+03  2.54267912e+04
  7.61683686e+04]
E1 = -728.2968656141434  E_coul = 201.5584253003745
cycle= 5 E= -526.738440313769  delta_E= -1.67e-09  |g|= 2.04e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85731e-05
diis-c [-7.42727568e-11  1.42493958e-05 -1.84165152e-03 -1.38233224e-02
  4.36820651e-02  9.71968659e-01]
  HOMO = -0.582857975636925  LUMO = 0.99918598797501
  mo_energy =
[-1.18578320e+02 -1.23093302e+01 -9.56124001e+00 -9.56124001e+00
 -9.56124001e+00 -1.27002429e+00 -5.82857976e-01 -5.82857976e-01
 -5.82857976e-01  9.99185988e-01  1.02215658e+00  1.02215658e+00
  1.02215658e+00  7.40106462e+00  7.40106462e+00  7.40106462e+00
  1.35664232e+01  3.37066521e+01  3.37066521e+01  3.37066521e+01
  1.11575771e+02  1.29267387e+02  1.29267387e+02  1.29267387e+02
  4.83550492e+02  4.83550492e+02  4.83550492e+02  5.97599018e+02
  1.33530759e+03  1.33530759e+03  1.33530759e+03  2.66703840e+03
  3.02945002e+03  3.02945002e+03  3.02945002e+03  6.64981351e+03
  6.64981351e+03  6.64981351e+03  9.07183933e+03  2.54267911e+04
  7.61683686e+04]
E1 = -728.2969461230618  E_coul = 201.55850580923513
cycle= 6 E= -526.738440313827  delta_E= -5.78e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2969461230618  E_coul = 201.55850580923513
  HOMO = -0.582857997370516  LUMO = 0.999186326599936
  mo_energy =
[-1.18578319e+02 -1.23093300e+01 -9.56123995e+00 -9.56123995e+00
 -9.56123995e+00 -1.27002392e+00 -5.82857997e-01 -5.82857997e-01
 -5.82857997e-01  9.99186327e-01  1.02215662e+00  1.02215662e+00
  1.02215662e+00  7.40106466e+00  7.40106466e+00  7.40106466e+00
  1.35664234e+01  3.37066522e+01  3.37066522e+01  3.37066522e+01
  1.11575771e+02  1.29267387e+02  1.29267387e+02  1.29267387e+02
  4.83550492e+02  4.83550492e+02  4.83550492e+02  5.97599018e+02
  1.33530759e+03  1.33530759e+03  1.33530759e+03  2.66703840e+03
  3.02945002e+03  3.02945002e+03  3.02945002e+03  6.64981351e+03
  6.64981351e+03  6.64981351e+03  9.07183933e+03  2.54267911e+04
  7.61683686e+04]
E1 = -728.2969450874388  E_coul = 201.55850477361201
Extra cycle  E= -526.738440313827  delta_E=    0  |g|= 3.6e-07  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61826581e+04 7.61751705e+03 3.61735331e+03 1.59772583e+03
 3.82743774e+02 1.09962578e+02 3.61013467e+01 8.75867000e+00
 3.35429321e+00 6.58860258e-01 2.44093162e-01 1.36278397e+03
 6.64738129e+02 3.00926361e+02 3.14011554e+02 6.16535238e+01
 7.38623887e+00 2.02028336e+01 7.80184276e-01 2.86109149e+00
 2.23673157e-01]
E = -526.7384403138267
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:11:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6581308        1
[INPUT] 0    0    [1    /1   ]  7617.5170468         1
[INPUT] 0    0    [1    /1   ]  3617.35330558        1
[INPUT] 0    0    [1    /1   ]  1597.72582607        1
[INPUT] 0    0    [1    /1   ]  382.743773524        1
[INPUT] 0    0    [1    /1   ]  109.962577981        1
[INPUT] 0    0    [1    /1   ]  36.1013466806        1
[INPUT] 0    0    [1    /1   ]  8.75866999928        1
[INPUT] 0    0    [1    /1   ]  3.35429321037        1
[INPUT] 0    0    [1    /1   ]  0.658860257631       1
[INPUT] 0    0    [1    /1   ]  0.244093161692       1
[INPUT] 1    0    [1    /1   ]  1362.78396909        1
[INPUT] 1    0    [1    /1   ]  664.738128947        1
[INPUT] 1    0    [1    /1   ]  300.926361354        1
[INPUT] 1    0    [1    /1   ]  314.011554352        1
[INPUT] 1    0    [1    /1   ]  61.6535238074        1
[INPUT] 1    0    [1    /1   ]  7.38623886632        1
[INPUT] 1    0    [1    /1   ]  20.202833582         1
[INPUT] 1    0    [1    /1   ]  0.780184276161       1
[INPUT] 1    0    [1    /1   ]  2.86109149041        1
[INPUT] 1    0    [1    /1   ]  0.223673156926       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65813081179, 1.0]], [0, [7617.5170468016895, 1.0]], [0, [3617.35330558424, 1.0]], [0, [1597.725826074869, 1.0]], [0, [382.7437735244358, 1.0]], [0, [109.96257798084596, 1.0]], [0, [36.1013466805826, 1.0]], [0, [8.758669999283912, 1.0]], [0, [3.3542932103717003, 1.0]], [0, [0.6588602576311865, 1.0]], [0, [0.24409316169213857, 1.0]], [1, [1362.783969085685, 1.0]], [1, [664.7381289467398, 1.0]], [1, [300.9263613538805, 1.0]], [1, [314.01155435212075, 1.0]], [1, [61.65352380743767, 1.0]], [1, [7.3862388663183, 1.0]], [1, [20.202833581963514, 1.0]], [1, [0.7801842761609369, 1.0]], [1, [2.8610914904076408, 1.0]], [1, [0.2236731569258701, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65813081]
bas 1, expnt(s) = [7617.5170468]
bas 2, expnt(s) = [3617.35330558]
bas 3, expnt(s) = [1597.72582607]
bas 4, expnt(s) = [382.74377352]
bas 5, expnt(s) = [109.96257798]
bas 6, expnt(s) = [36.10134668]
bas 7, expnt(s) = [8.75867]
bas 8, expnt(s) = [3.35429321]
bas 9, expnt(s) = [0.65886026]
bas 10, expnt(s) = [0.24409316]
bas 11, expnt(s) = [1362.78396909]
bas 12, expnt(s) = [664.73812895]
bas 13, expnt(s) = [300.92636135]
bas 14, expnt(s) = [314.01155435]
bas 15, expnt(s) = [61.65352381]
bas 16, expnt(s) = [7.38623887]
bas 17, expnt(s) = [20.20283358]
bas 18, expnt(s) = [0.78018428]
bas 19, expnt(s) = [2.86109149]
bas 20, expnt(s) = [0.22367316]
CPU time:       243.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826581e+04 5.20026321e+03 7.61751705e+03 2.06003738e+03
 3.61735331e+03 1.17844202e+03 1.59772583e+03 6.38471794e+02
 3.82743774e+02 2.18623139e+02 1.09962578e+02 8.57923786e+01
 3.61013467e+01 3.72098206e+01 8.75867000e+00 1.28630408e+01
 3.35429321e+00 6.26203934e+00 6.58860258e-01 1.84760874e+00
 2.44093162e-01 8.77367886e-01 1.36278397e+03 2.41556185e+04
 6.64738129e+02 9.84685699e+03 3.00926361e+02 3.65645039e+03
 3.14011554e+02 3.85626107e+03 6.16535238e+01 5.04001434e+02
 7.38623887e+00 3.55233224e+01 2.02028336e+01 1.24953881e+02
 7.80184276e-01 2.13909900e+00 2.86109149e+00 1.08554811e+01
 2.23673157e-01 4.48747174e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99339337854705
cond(S) = 103883.90611613537
E1 = -729.5307986776387  E_coul = 203.17944222001665
init E= -526.351356457622
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555733103225824  LUMO = 1.02072543888774
  mo_energy =
[-1.18328651e+02 -1.22043090e+01 -9.44678154e+00 -9.44678154e+00
 -9.44678154e+00 -1.23997983e+00 -5.55733103e-01 -5.55733103e-01
 -5.55733103e-01  1.02072544e+00  1.04087569e+00  1.04087569e+00
  1.04087569e+00  7.47219301e+00  7.47219301e+00  7.47219301e+00
  1.36535221e+01  3.38265101e+01  3.38265101e+01  3.38265101e+01
  1.11749256e+02  1.29447652e+02  1.29447652e+02  1.29447652e+02
  4.83799699e+02  4.83799699e+02  4.83799699e+02  5.97884489e+02
  1.33560999e+03  1.33560999e+03  1.33560999e+03  2.66747214e+03
  3.02981656e+03  3.02981656e+03  3.02981656e+03  6.65029191e+03
  6.65029191e+03  6.65029191e+03  9.07239228e+03  2.54274378e+04
  7.61691052e+04]
E1 = -727.8530734475152  E_coul = 201.11540662766552
cycle= 1 E= -526.73766681985  delta_E= -0.386  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542121
diis-c [-0.29389474  1.        ]
  HOMO = -0.59043860070595  LUMO = 0.992219344264936
  mo_energy =
[-1.18635791e+02 -1.23414310e+01 -9.59462041e+00 -9.59462041e+00
 -9.59462041e+00 -1.27922311e+00 -5.90438601e-01 -5.90438601e-01
 -5.90438601e-01  9.92219344e-01  1.01648599e+00  1.01648599e+00
  1.01648599e+00  7.38102771e+00  7.38102771e+00  7.38102771e+00
  1.35400894e+01  3.36729002e+01  3.36729002e+01  3.36729002e+01
  1.11528361e+02  1.29220087e+02  1.29220087e+02  1.29220087e+02
  4.83493721e+02  4.83493721e+02  4.83493721e+02  5.97540259e+02
  1.33524739e+03  1.33524739e+03  1.33524739e+03  2.66697555e+03
  3.02938798e+03  3.02938798e+03  3.02938798e+03  6.64975014e+03
  6.64975014e+03  6.64975014e+03  9.07177537e+03  2.54267268e+04
  7.61683041e+04]
E1 = -728.4236723810554  E_coul = 201.68529210690596
cycle= 2 E= -526.738380274149  delta_E= -0.000713  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0749227
diis-c [-0.00328763  0.08211462  0.91788538]
  HOMO = -0.581379008034563  LUMO = 1.0004056874957
  mo_energy =
[-1.18568424e+02 -1.23035993e+01 -9.55514914e+00 -9.55514914e+00
 -9.55514914e+00 -1.26837773e+00 -5.81379008e-01 -5.81379008e-01
 -5.81379008e-01  1.00040569e+00  1.02323055e+00  1.02323055e+00
  1.02323055e+00  7.40482312e+00  7.40482312e+00  7.40482312e+00
  1.35711429e+01  3.37127655e+01  3.37127655e+01  3.37127655e+01
  1.11584006e+02  1.29275666e+02  1.29275666e+02  1.29275666e+02
  4.83560271e+02  4.83560271e+02  4.83560271e+02  5.97609160e+02
  1.33531797e+03  1.33531797e+03  1.33531797e+03  2.66704943e+03
  3.02946079e+03  3.02946079e+03  3.02946079e+03  6.64982469e+03
  6.64982469e+03  6.64982469e+03  9.07185073e+03  2.54268027e+04
  7.61683803e+04]
E1 = -728.2744625949281  E_coul = 201.53602417697977
cycle= 3 E= -526.738438417948  delta_E= -5.81e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131185
diis-c [-5.82164236e-07 -1.24882863e-03  1.44521351e-01  8.56727478e-01]
  HOMO = -0.582868553645181  LUMO = 0.999156292875268
  mo_energy =
[-1.18578328e+02 -1.23093712e+01 -9.56126563e+00 -9.56126563e+00
 -9.56126563e+00 -1.27005881e+00 -5.82868554e-01 -5.82868554e-01
 -5.82868554e-01  9.99156293e-01  1.02214592e+00  1.02214592e+00
  1.02214592e+00  7.40104020e+00  7.40104020e+00  7.40104020e+00
  1.35663828e+01  3.37066278e+01  3.37066278e+01  3.37066278e+01
  1.11575749e+02  1.29267369e+02  1.29267369e+02  1.29267369e+02
  4.83550483e+02  4.83550483e+02  4.83550483e+02  5.97599018e+02
  1.33530759e+03  1.33530759e+03  1.33530759e+03  2.66703843e+03
  3.02945003e+03  3.02945003e+03  3.02945003e+03  6.64981354e+03
  6.64981354e+03  6.64981354e+03  9.07183937e+03  2.54267912e+04
  7.61683687e+04]
E1 = -728.2970739572334  E_coul = 201.5586336451306
cycle= 4 E= -526.738440312103  delta_E= -1.89e-06  |g|= 9.73e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000114083
diis-c [-4.07246972e-09  7.19626234e-05 -1.02949806e-02 -6.69401005e-02
  1.07716312e+00]
  HOMO = -0.58285058597299  LUMO = 0.999189949888076
  mo_energy =
[-1.18578289e+02 -1.23093078e+01 -9.56121575e+00 -9.56121575e+00
 -9.56121575e+00 -1.27001839e+00 -5.82850586e-01 -5.82850586e-01
 -5.82850586e-01  9.99189950e-01  1.02216153e+00  1.02216153e+00
  1.02216153e+00  7.40108119e+00  7.40108119e+00  7.40108119e+00
  1.35664418e+01  3.37066757e+01  3.37066757e+01  3.37066757e+01
  1.11575799e+02  1.29267415e+02  1.29267415e+02  1.29267415e+02
  4.83550522e+02  4.83550522e+02  4.83550522e+02  5.97599049e+02
  1.33530762e+03  1.33530762e+03  1.33530762e+03  2.66703844e+03
  3.02945005e+03  3.02945005e+03  3.02945005e+03  6.64981354e+03
  6.64981354e+03  6.64981354e+03  9.07183936e+03  2.54267912e+04
  7.61683686e+04]
E1 = -728.2968656141434  E_coul = 201.5584253003745
cycle= 5 E= -526.738440313769  delta_E= -1.67e-09  |g|= 2.04e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85731e-05
diis-c [-7.42727568e-11  1.42493958e-05 -1.84165152e-03 -1.38233224e-02
  4.36820651e-02  9.71968659e-01]
  HOMO = -0.582857975636925  LUMO = 0.99918598797501
  mo_energy =
[-1.18578320e+02 -1.23093302e+01 -9.56124001e+00 -9.56124001e+00
 -9.56124001e+00 -1.27002429e+00 -5.82857976e-01 -5.82857976e-01
 -5.82857976e-01  9.99185988e-01  1.02215658e+00  1.02215658e+00
  1.02215658e+00  7.40106462e+00  7.40106462e+00  7.40106462e+00
  1.35664232e+01  3.37066521e+01  3.37066521e+01  3.37066521e+01
  1.11575771e+02  1.29267387e+02  1.29267387e+02  1.29267387e+02
  4.83550492e+02  4.83550492e+02  4.83550492e+02  5.97599018e+02
  1.33530759e+03  1.33530759e+03  1.33530759e+03  2.66703840e+03
  3.02945002e+03  3.02945002e+03  3.02945002e+03  6.64981351e+03
  6.64981351e+03  6.64981351e+03  9.07183933e+03  2.54267911e+04
  7.61683686e+04]
E1 = -728.2969461230618  E_coul = 201.55850580923513
cycle= 6 E= -526.738440313827  delta_E= -5.78e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2969461230618  E_coul = 201.55850580923513
  HOMO = -0.582857997370516  LUMO = 0.999186326599936
  mo_energy =
[-1.18578319e+02 -1.23093300e+01 -9.56123995e+00 -9.56123995e+00
 -9.56123995e+00 -1.27002392e+00 -5.82857997e-01 -5.82857997e-01
 -5.82857997e-01  9.99186327e-01  1.02215662e+00  1.02215662e+00
  1.02215662e+00  7.40106466e+00  7.40106466e+00  7.40106466e+00
  1.35664234e+01  3.37066522e+01  3.37066522e+01  3.37066522e+01
  1.11575771e+02  1.29267387e+02  1.29267387e+02  1.29267387e+02
  4.83550492e+02  4.83550492e+02  4.83550492e+02  5.97599018e+02
  1.33530759e+03  1.33530759e+03  1.33530759e+03  2.66703840e+03
  3.02945002e+03  3.02945002e+03  3.02945002e+03  6.64981351e+03
  6.64981351e+03  6.64981351e+03  9.07183933e+03  2.54267911e+04
  7.61683686e+04]
E1 = -728.2969450874388  E_coul = 201.55850477361201
Extra cycle  E= -526.738440313827  delta_E=    0  |g|= 3.6e-07  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103883.90611613537
E1 = -728.2969450874388  E_coul = 201.55850477361201
init E= -526.738440313827
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.582858029543129  LUMO = 0.999186372051401
  mo_energy =
[-1.18578320e+02 -1.23093301e+01 -9.56124004e+00 -9.56124004e+00
 -9.56124004e+00 -1.27002388e+00 -5.82858030e-01 -5.82858030e-01
 -5.82858030e-01  9.99186372e-01  1.02215661e+00  1.02215661e+00
  1.02215661e+00  7.40106461e+00  7.40106461e+00  7.40106461e+00
  1.35664233e+01  3.37066521e+01  3.37066521e+01  3.37066521e+01
  1.11575771e+02  1.29267387e+02  1.29267387e+02  1.29267387e+02
  4.83550492e+02  4.83550492e+02  4.83550492e+02  5.97599018e+02
  1.33530759e+03  1.33530759e+03  1.33530759e+03  2.66703840e+03
  3.02945002e+03  3.02945002e+03  3.02945002e+03  6.64981351e+03
  6.64981351e+03  6.64981351e+03  9.07183933e+03  2.54267911e+04
  7.61683686e+04]
E1 = -728.2969452597101  E_coul = 201.55850494588373
cycle= 1 E= -526.738440313826  delta_E= 2.27e-13  |g|= 7.57e-08  |ddm|= 6.01e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2969452597101  E_coul = 201.55850494588373
  HOMO = -0.582858028892343  LUMO = 0.999186387581459
  mo_energy =
[-1.18578320e+02 -1.23093301e+01 -9.56124003e+00 -9.56124003e+00
 -9.56124003e+00 -1.27002386e+00 -5.82858029e-01 -5.82858029e-01
 -5.82858029e-01  9.99186388e-01  1.02215662e+00  1.02215662e+00
  1.02215662e+00  7.40106461e+00  7.40106461e+00  7.40106461e+00
  1.35664233e+01  3.37066521e+01  3.37066521e+01  3.37066521e+01
  1.11575771e+02  1.29267387e+02  1.29267387e+02  1.29267387e+02
  4.83550492e+02  4.83550492e+02  4.83550492e+02  5.97599018e+02
  1.33530759e+03  1.33530759e+03  1.33530759e+03  2.66703840e+03
  3.02945002e+03  3.02945002e+03  3.02945002e+03  6.64981351e+03
  6.64981351e+03  6.64981351e+03  9.07183933e+03  2.54267911e+04
  7.61683686e+04]
E1 = -728.2969451869731  E_coul = 201.55850487314544
Extra cycle  E= -526.738440313828  delta_E= -1.14e-12  |g|= 1.53e-08  |ddm|= 1.27e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826581e+04 7.61751705e+03 3.61735331e+03 1.59772583e+03
 3.82743774e+02 1.09962578e+02 3.61013467e+01 8.75867000e+00
 3.35429321e+00 6.58860258e-01 2.44093162e-01 1.36278397e+03
 6.64738129e+02 3.00926361e+02 3.14011554e+02 6.16535238e+01
 7.38623887e+00 2.02028336e+01 7.80184276e-01 2.86109149e+00
 2.23673157e-01]
grad_E = [-1.53138215e-06  3.46006753e-06 -1.49607516e-06  7.49114032e-05
 -1.50784340e-04 -3.51847562e-04 -1.36030824e-03  1.57343297e-03
  4.65344439e-04 -4.05741779e-04  1.18400258e-04 -5.24597107e-07
  4.76033282e-06  2.21365274e-05  1.90885995e-05  1.36564021e-04
  9.81838624e-04 -9.64046134e-04  6.44537521e-04  1.77322546e-03
 -1.53372545e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6581772        1
[INPUT] 0    0    [1    /1   ]  7617.51694661        1
[INPUT] 0    0    [1    /1   ]  3617.35335453        1
[INPUT] 0    0    [1    /1   ]  1597.72374913        1
[INPUT] 0    0    [1    /1   ]  382.742991289        1
[INPUT] 0    0    [1    /1   ]  109.990277685        1
[INPUT] 0    0    [1    /1   ]  36.1477304344        1
[INPUT] 0    0    [1    /1   ]  8.79124809915        1
[INPUT] 0    0    [1    /1   ]  3.36097382972        1
[INPUT] 0    0    [1    /1   ]  0.660659715939       1
[INPUT] 0    0    [1    /1   ]  0.244810910367       1
[INPUT] 1    0    [1    /1   ]  1362.78398462        1
[INPUT] 1    0    [1    /1   ]  664.737975727        1
[INPUT] 1    0    [1    /1   ]  300.925638878        1
[INPUT] 1    0    [1    /1   ]  314.010931445        1
[INPUT] 1    0    [1    /1   ]  61.6539656306        1
[INPUT] 1    0    [1    /1   ]  7.38698140018        1
[INPUT] 1    0    [1    /1   ]  20.2032022404        1
[INPUT] 1    0    [1    /1   ]  0.779959645182       1
[INPUT] 1    0    [1    /1   ]  2.85834618354        1
[INPUT] 1    0    [1    /1   ]  0.22366543591        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.658177184665, 1.0]], [0, [7617.516946614547, 1.0]], [0, [3617.3533545303826, 1.0]], [0, [1597.7237491272144, 1.0]], [0, [382.74299128906307, 1.0]], [0, [109.9902776849754, 1.0]], [0, [36.147730434353356, 1.0]], [0, [8.791248099147799, 1.0]], [0, [3.3609738297157716, 1.0]], [0, [0.660659715938931, 1.0]], [0, [0.24481091036659358, 1.0]], [1, [1362.7839846183026, 1.0]], [1, [664.7379757274313, 1.0]], [1, [300.9256388775114, 1.0]], [1, [314.0109314447021, 1.0]], [1, [61.653965630643526, 1.0]], [1, [7.386981400184377, 1.0]], [1, [20.203202240428215, 1.0]], [1, [0.7799596451821328, 1.0]], [1, [2.858346183544902, 1.0]], [1, [0.2236654359100958, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65817718]
bas 1, expnt(s) = [7617.51694661]
bas 2, expnt(s) = [3617.35335453]
bas 3, expnt(s) = [1597.72374913]
bas 4, expnt(s) = [382.74299129]
bas 5, expnt(s) = [109.99027768]
bas 6, expnt(s) = [36.14773043]
bas 7, expnt(s) = [8.7912481]
bas 8, expnt(s) = [3.36097383]
bas 9, expnt(s) = [0.66065972]
bas 10, expnt(s) = [0.24481091]
bas 11, expnt(s) = [1362.78398462]
bas 12, expnt(s) = [664.73797573]
bas 13, expnt(s) = [300.92563888]
bas 14, expnt(s) = [314.01093144]
bas 15, expnt(s) = [61.65396563]
bas 16, expnt(s) = [7.3869814]
bas 17, expnt(s) = [20.20320224]
bas 18, expnt(s) = [0.77995965]
bas 19, expnt(s) = [2.85834618]
bas 20, expnt(s) = [0.22366544]
CPU time:       249.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826582e+04 5.20026321e+03 7.61751695e+03 2.06003736e+03
 3.61735335e+03 1.17844203e+03 1.59772375e+03 6.38471171e+02
 3.82742991e+02 2.18622804e+02 1.09990278e+02 8.58085865e+01
 3.61477304e+01 3.72456708e+01 8.79124810e+00 1.28989074e+01
 3.36097383e+00 6.27139091e+00 6.60659716e-01 1.85139205e+00
 2.44810910e-01 8.79302081e-01 1.36278398e+03 2.41556189e+04
 6.64737976e+02 9.84685415e+03 3.00925639e+02 3.65643941e+03
 3.14010931e+02 3.85625151e+03 6.16539656e+01 5.04005949e+02
 7.38698140e+00 3.55277864e+01 2.02032022e+01 1.24956731e+02
 7.79959645e-01 2.13832916e+00 2.85834618e+00 1.08424624e+01
 2.23665436e-01 4.48727811e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993388762667408
cond(S) = 103902.2536778353
E1 = -729.5311149767816  E_coul = 203.17968582626014
init E= -526.351429150521
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555729387392188  LUMO = 1.02584216982124
  mo_energy =
[-1.18328663e+02 -1.22042737e+01 -9.44675979e+00 -9.44675979e+00
 -9.44675979e+00 -1.23996587e+00 -5.55729387e-01 -5.55729387e-01
 -5.55729387e-01  1.02584217e+00  1.04062452e+00  1.04062452e+00
  1.04062452e+00  7.46689893e+00  7.46689893e+00  7.46689893e+00
  1.37217803e+01  3.38179530e+01  3.38179530e+01  3.38179530e+01
  1.12017064e+02  1.29441778e+02  1.29441778e+02  1.29441778e+02
  4.83796249e+02  4.83796249e+02  4.83796249e+02  5.98285464e+02
  1.33560599e+03  1.33560599e+03  1.33560599e+03  2.66787906e+03
  3.02981100e+03  3.02981100e+03  3.02981100e+03  6.65028533e+03
  6.65028533e+03  6.65028533e+03  9.07277265e+03  2.54277975e+04
  7.61694398e+04]
E1 = -727.853724534929  E_coul = 201.1160392432645
cycle= 1 E= -526.737685291665  delta_E= -0.386  |g|= 0.185  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542028
diis-c [-0.293794  1.      ]
  HOMO = -0.590406578003813  LUMO = 0.997237575837064
  mo_energy =
[-1.18635736e+02 -1.23413919e+01 -9.59459421e+00 -9.59459421e+00
 -9.59459421e+00 -1.27918394e+00 -5.90406578e-01 -5.90406578e-01
 -5.90406578e-01  9.97237576e-01  1.01626614e+00  1.01626614e+00
  1.01626614e+00  7.37578269e+00  7.37578269e+00  7.37578269e+00
  1.36081294e+01  3.36643626e+01  3.36643626e+01  3.36643626e+01
  1.11796101e+02  1.29214247e+02  1.29214247e+02  1.29214247e+02
  4.83490332e+02  4.83490332e+02  4.83490332e+02  5.97941329e+02
  1.33524350e+03  1.33524350e+03  1.33524350e+03  2.66738261e+03
  3.02938253e+03  3.02938253e+03  3.02938253e+03  6.64974369e+03
  6.64974369e+03  6.64974369e+03  9.07215588e+03  2.54270866e+04
  7.61686389e+04]
E1 = -728.424195418071  E_coul = 201.68579704650259
cycle= 2 E= -526.738398371568  delta_E= -0.000713  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748999
diis-c [-0.00328851  0.0820581   0.9179419 ]
  HOMO = -0.581348195077636  LUMO = 1.00545465994554
  mo_energy =
[-1.18568381e+02 -1.23035663e+01 -9.55512956e+00 -9.55512956e+00
 -9.55512956e+00 -1.26833994e+00 -5.81348195e-01 -5.81348195e-01
 -5.81348195e-01  1.00545466e+00  1.02300686e+00  1.02300686e+00
  1.02300686e+00  7.39956657e+00  7.39956657e+00  7.39956657e+00
  1.36392339e+01  3.37042220e+01  3.37042220e+01  3.37042220e+01
  1.11851750e+02  1.29269817e+02  1.29269817e+02  1.29269817e+02
  4.83556871e+02  4.83556871e+02  4.83556871e+02  5.98010218e+02
  1.33531407e+03  1.33531407e+03  1.33531407e+03  2.66745648e+03
  3.02945534e+03  3.02945534e+03  3.02945534e+03  6.64981823e+03
  6.64981823e+03  6.64981823e+03  9.07223123e+03  2.54271625e+04
  7.61687151e+04]
E1 = -728.2750061421368  E_coul = 201.53654965023387
cycle= 3 E= -526.738456491903  delta_E= -5.81e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131211
diis-c [-5.80752632e-07 -1.24860087e-03  1.44589642e-01  8.56658959e-01]
  HOMO = -0.582837709244515  LUMO = 1.00420017218603
  mo_energy =
[-1.18578288e+02 -1.23093393e+01 -9.56124728e+00 -9.56124728e+00
 -9.56124728e+00 -1.27002124e+00 -5.82837709e-01 -5.82837709e-01
 -5.82837709e-01  1.00420017e+00  1.02192267e+00  1.02192267e+00
  1.02192267e+00  7.39578437e+00  7.39578437e+00  7.39578437e+00
  1.36344645e+01  3.36980829e+01  3.36980829e+01  3.36980829e+01
  1.11843488e+02  1.29261517e+02  1.29261517e+02  1.29261517e+02
  4.83547080e+02  4.83547080e+02  4.83547080e+02  5.98000074e+02
  1.33530369e+03  1.33530369e+03  1.33530369e+03  2.66744547e+03
  3.02944457e+03  3.02944457e+03  3.02944457e+03  6.64980708e+03
  6.64980708e+03  6.64980708e+03  9.07221986e+03  2.54271510e+04
  7.61687034e+04]
E1 = -728.2976237012085  E_coul = 201.55916531415428
cycle= 4 E= -526.738458387054  delta_E= -1.9e-06  |g|= 9.71e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113973
diis-c [-4.06203196e-09  7.18477413e-05 -1.02803630e-02 -6.68211612e-02
  1.07702968e+00]
  HOMO = -0.582819743033705  LUMO = 1.00423388300177
  mo_energy =
[-1.18578249e+02 -1.23092760e+01 -9.56119747e+00 -9.56119747e+00
 -9.56119747e+00 -1.26998088e+00 -5.82819743e-01 -5.82819743e-01
 -5.82819743e-01  1.00423388e+00  1.02193827e+00  1.02193827e+00
  1.02193827e+00  7.39582530e+00  7.39582530e+00  7.39582530e+00
  1.36345234e+01  3.36981307e+01  3.36981307e+01  3.36981307e+01
  1.11843538e+02  1.29261563e+02  1.29261563e+02  1.29261563e+02
  4.83547118e+02  4.83547118e+02  4.83547118e+02  5.98000105e+02
  1.33530372e+03  1.33530372e+03  1.33530372e+03  2.66744548e+03
  3.02944459e+03  3.02944459e+03  3.02944459e+03  6.64980708e+03
  6.64980708e+03  6.64980708e+03  9.07221986e+03  2.54271510e+04
  7.61687034e+04]
E1 = -728.2974159891223  E_coul = 201.55895760041003
cycle= 5 E= -526.738458388712  delta_E= -1.66e-09  |g|= 2.04e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85244e-05
diis-c [-7.38149724e-11  1.42300597e-05 -1.84058536e-03 -1.38073180e-02
  4.36380347e-02  9.71995639e-01]
  HOMO = -0.582827113104444  LUMO = 1.00422991363739
  mo_energy =
[-1.18578280e+02 -1.23092984e+01 -9.56122168e+00 -9.56122168e+00
 -9.56122168e+00 -1.26998676e+00 -5.82827113e-01 -5.82827113e-01
 -5.82827113e-01  1.00422991e+00  1.02193334e+00  1.02193334e+00
  1.02193334e+00  7.39580876e+00  7.39580876e+00  7.39580876e+00
  1.36345048e+01  3.36981072e+01  3.36981072e+01  3.36981072e+01
  1.11843511e+02  1.29261536e+02  1.29261536e+02  1.29261536e+02
  4.83547088e+02  4.83547088e+02  4.83547088e+02  5.98000074e+02
  1.33530369e+03  1.33530369e+03  1.33530369e+03  2.66744544e+03
  3.02944456e+03  3.02944456e+03  3.02944456e+03  6.64980705e+03
  6.64980705e+03  6.64980705e+03  9.07221983e+03  2.54271509e+04
  7.61687034e+04]
E1 = -728.2974963982889  E_coul = 201.55903800951967
cycle= 6 E= -526.738458388769  delta_E= -5.7e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2974963982889  E_coul = 201.55903800951967
  HOMO = -0.582827133874271  LUMO = 1.0042302527886
  mo_energy =
[-1.18578279e+02 -1.23092982e+01 -9.56122162e+00 -9.56122162e+00
 -9.56122162e+00 -1.26998639e+00 -5.82827134e-01 -5.82827134e-01
 -5.82827134e-01  1.00423025e+00  1.02193338e+00  1.02193338e+00
  1.02193338e+00  7.39580881e+00  7.39580881e+00  7.39580881e+00
  1.36345050e+01  3.36981073e+01  3.36981073e+01  3.36981073e+01
  1.11843511e+02  1.29261536e+02  1.29261536e+02  1.29261536e+02
  4.83547089e+02  4.83547089e+02  4.83547089e+02  5.98000074e+02
  1.33530369e+03  1.33530369e+03  1.33530369e+03  2.66744544e+03
  3.02944456e+03  3.02944456e+03  3.02944456e+03  6.64980705e+03
  6.64980705e+03  6.64980705e+03  9.07221983e+03  2.54271509e+04
  7.61687034e+04]
E1 = -728.2974953721339  E_coul = 201.5590369833642
Extra cycle  E= -526.73845838877  delta_E= -4.55e-13  |g|= 3.59e-07  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826582e+04 7.61751695e+03 3.61735335e+03 1.59772375e+03
 3.82742991e+02 1.09990278e+02 3.61477304e+01 8.79124810e+00
 3.36097383e+00 6.60659716e-01 2.44810910e-01 1.36278398e+03
 6.64737976e+02 3.00925639e+02 3.14010931e+02 6.16539656e+01
 7.38698140e+00 2.02032022e+01 7.79959645e-01 2.85834618e+00
 2.23665436e-01]
E = -526.7384583887697
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6581772        1
[INPUT] 0    0    [1    /1   ]  7617.51694661        1
[INPUT] 0    0    [1    /1   ]  3617.35335453        1
[INPUT] 0    0    [1    /1   ]  1597.72374913        1
[INPUT] 0    0    [1    /1   ]  382.742991289        1
[INPUT] 0    0    [1    /1   ]  109.990277685        1
[INPUT] 0    0    [1    /1   ]  36.1477304344        1
[INPUT] 0    0    [1    /1   ]  8.79124809915        1
[INPUT] 0    0    [1    /1   ]  3.36097382972        1
[INPUT] 0    0    [1    /1   ]  0.660659715939       1
[INPUT] 0    0    [1    /1   ]  0.244810910367       1
[INPUT] 1    0    [1    /1   ]  1362.78398462        1
[INPUT] 1    0    [1    /1   ]  664.737975727        1
[INPUT] 1    0    [1    /1   ]  300.925638878        1
[INPUT] 1    0    [1    /1   ]  314.010931445        1
[INPUT] 1    0    [1    /1   ]  61.6539656306        1
[INPUT] 1    0    [1    /1   ]  7.38698140018        1
[INPUT] 1    0    [1    /1   ]  20.2032022404        1
[INPUT] 1    0    [1    /1   ]  0.779959645182       1
[INPUT] 1    0    [1    /1   ]  2.85834618354        1
[INPUT] 1    0    [1    /1   ]  0.22366543591        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.658177184665, 1.0]], [0, [7617.516946614547, 1.0]], [0, [3617.3533545303826, 1.0]], [0, [1597.7237491272144, 1.0]], [0, [382.74299128906307, 1.0]], [0, [109.9902776849754, 1.0]], [0, [36.147730434353356, 1.0]], [0, [8.791248099147799, 1.0]], [0, [3.3609738297157716, 1.0]], [0, [0.660659715938931, 1.0]], [0, [0.24481091036659358, 1.0]], [1, [1362.7839846183026, 1.0]], [1, [664.7379757274313, 1.0]], [1, [300.9256388775114, 1.0]], [1, [314.0109314447021, 1.0]], [1, [61.653965630643526, 1.0]], [1, [7.386981400184377, 1.0]], [1, [20.203202240428215, 1.0]], [1, [0.7799596451821328, 1.0]], [1, [2.858346183544902, 1.0]], [1, [0.2236654359100958, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65817718]
bas 1, expnt(s) = [7617.51694661]
bas 2, expnt(s) = [3617.35335453]
bas 3, expnt(s) = [1597.72374913]
bas 4, expnt(s) = [382.74299129]
bas 5, expnt(s) = [109.99027768]
bas 6, expnt(s) = [36.14773043]
bas 7, expnt(s) = [8.7912481]
bas 8, expnt(s) = [3.36097383]
bas 9, expnt(s) = [0.66065972]
bas 10, expnt(s) = [0.24481091]
bas 11, expnt(s) = [1362.78398462]
bas 12, expnt(s) = [664.73797573]
bas 13, expnt(s) = [300.92563888]
bas 14, expnt(s) = [314.01093144]
bas 15, expnt(s) = [61.65396563]
bas 16, expnt(s) = [7.3869814]
bas 17, expnt(s) = [20.20320224]
bas 18, expnt(s) = [0.77995965]
bas 19, expnt(s) = [2.85834618]
bas 20, expnt(s) = [0.22366544]
CPU time:       250.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826582e+04 5.20026321e+03 7.61751695e+03 2.06003736e+03
 3.61735335e+03 1.17844203e+03 1.59772375e+03 6.38471171e+02
 3.82742991e+02 2.18622804e+02 1.09990278e+02 8.58085865e+01
 3.61477304e+01 3.72456708e+01 8.79124810e+00 1.28989074e+01
 3.36097383e+00 6.27139091e+00 6.60659716e-01 1.85139205e+00
 2.44810910e-01 8.79302081e-01 1.36278398e+03 2.41556189e+04
 6.64737976e+02 9.84685415e+03 3.00925639e+02 3.65643941e+03
 3.14010931e+02 3.85625151e+03 6.16539656e+01 5.04005949e+02
 7.38698140e+00 3.55277864e+01 2.02032022e+01 1.24956731e+02
 7.79959645e-01 2.13832916e+00 2.85834618e+00 1.08424624e+01
 2.23665436e-01 4.48727811e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993388762667408
cond(S) = 103902.2536778353
E1 = -729.5311149767816  E_coul = 203.17968582626014
init E= -526.351429150521
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555729387392188  LUMO = 1.02584216982124
  mo_energy =
[-1.18328663e+02 -1.22042737e+01 -9.44675979e+00 -9.44675979e+00
 -9.44675979e+00 -1.23996587e+00 -5.55729387e-01 -5.55729387e-01
 -5.55729387e-01  1.02584217e+00  1.04062452e+00  1.04062452e+00
  1.04062452e+00  7.46689893e+00  7.46689893e+00  7.46689893e+00
  1.37217803e+01  3.38179530e+01  3.38179530e+01  3.38179530e+01
  1.12017064e+02  1.29441778e+02  1.29441778e+02  1.29441778e+02
  4.83796249e+02  4.83796249e+02  4.83796249e+02  5.98285464e+02
  1.33560599e+03  1.33560599e+03  1.33560599e+03  2.66787906e+03
  3.02981100e+03  3.02981100e+03  3.02981100e+03  6.65028533e+03
  6.65028533e+03  6.65028533e+03  9.07277265e+03  2.54277975e+04
  7.61694398e+04]
E1 = -727.853724534929  E_coul = 201.1160392432645
cycle= 1 E= -526.737685291665  delta_E= -0.386  |g|= 0.185  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542028
diis-c [-0.293794  1.      ]
  HOMO = -0.590406578003813  LUMO = 0.997237575837064
  mo_energy =
[-1.18635736e+02 -1.23413919e+01 -9.59459421e+00 -9.59459421e+00
 -9.59459421e+00 -1.27918394e+00 -5.90406578e-01 -5.90406578e-01
 -5.90406578e-01  9.97237576e-01  1.01626614e+00  1.01626614e+00
  1.01626614e+00  7.37578269e+00  7.37578269e+00  7.37578269e+00
  1.36081294e+01  3.36643626e+01  3.36643626e+01  3.36643626e+01
  1.11796101e+02  1.29214247e+02  1.29214247e+02  1.29214247e+02
  4.83490332e+02  4.83490332e+02  4.83490332e+02  5.97941329e+02
  1.33524350e+03  1.33524350e+03  1.33524350e+03  2.66738261e+03
  3.02938253e+03  3.02938253e+03  3.02938253e+03  6.64974369e+03
  6.64974369e+03  6.64974369e+03  9.07215588e+03  2.54270866e+04
  7.61686389e+04]
E1 = -728.424195418071  E_coul = 201.68579704650259
cycle= 2 E= -526.738398371568  delta_E= -0.000713  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748999
diis-c [-0.00328851  0.0820581   0.9179419 ]
  HOMO = -0.581348195077636  LUMO = 1.00545465994554
  mo_energy =
[-1.18568381e+02 -1.23035663e+01 -9.55512956e+00 -9.55512956e+00
 -9.55512956e+00 -1.26833994e+00 -5.81348195e-01 -5.81348195e-01
 -5.81348195e-01  1.00545466e+00  1.02300686e+00  1.02300686e+00
  1.02300686e+00  7.39956657e+00  7.39956657e+00  7.39956657e+00
  1.36392339e+01  3.37042220e+01  3.37042220e+01  3.37042220e+01
  1.11851750e+02  1.29269817e+02  1.29269817e+02  1.29269817e+02
  4.83556871e+02  4.83556871e+02  4.83556871e+02  5.98010218e+02
  1.33531407e+03  1.33531407e+03  1.33531407e+03  2.66745648e+03
  3.02945534e+03  3.02945534e+03  3.02945534e+03  6.64981823e+03
  6.64981823e+03  6.64981823e+03  9.07223123e+03  2.54271625e+04
  7.61687151e+04]
E1 = -728.2750061421368  E_coul = 201.53654965023387
cycle= 3 E= -526.738456491903  delta_E= -5.81e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131211
diis-c [-5.80752632e-07 -1.24860087e-03  1.44589642e-01  8.56658959e-01]
  HOMO = -0.582837709244515  LUMO = 1.00420017218603
  mo_energy =
[-1.18578288e+02 -1.23093393e+01 -9.56124728e+00 -9.56124728e+00
 -9.56124728e+00 -1.27002124e+00 -5.82837709e-01 -5.82837709e-01
 -5.82837709e-01  1.00420017e+00  1.02192267e+00  1.02192267e+00
  1.02192267e+00  7.39578437e+00  7.39578437e+00  7.39578437e+00
  1.36344645e+01  3.36980829e+01  3.36980829e+01  3.36980829e+01
  1.11843488e+02  1.29261517e+02  1.29261517e+02  1.29261517e+02
  4.83547080e+02  4.83547080e+02  4.83547080e+02  5.98000074e+02
  1.33530369e+03  1.33530369e+03  1.33530369e+03  2.66744547e+03
  3.02944457e+03  3.02944457e+03  3.02944457e+03  6.64980708e+03
  6.64980708e+03  6.64980708e+03  9.07221986e+03  2.54271510e+04
  7.61687034e+04]
E1 = -728.2976237012085  E_coul = 201.55916531415428
cycle= 4 E= -526.738458387054  delta_E= -1.9e-06  |g|= 9.71e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113973
diis-c [-4.06203196e-09  7.18477413e-05 -1.02803630e-02 -6.68211612e-02
  1.07702968e+00]
  HOMO = -0.582819743033705  LUMO = 1.00423388300177
  mo_energy =
[-1.18578249e+02 -1.23092760e+01 -9.56119747e+00 -9.56119747e+00
 -9.56119747e+00 -1.26998088e+00 -5.82819743e-01 -5.82819743e-01
 -5.82819743e-01  1.00423388e+00  1.02193827e+00  1.02193827e+00
  1.02193827e+00  7.39582530e+00  7.39582530e+00  7.39582530e+00
  1.36345234e+01  3.36981307e+01  3.36981307e+01  3.36981307e+01
  1.11843538e+02  1.29261563e+02  1.29261563e+02  1.29261563e+02
  4.83547118e+02  4.83547118e+02  4.83547118e+02  5.98000105e+02
  1.33530372e+03  1.33530372e+03  1.33530372e+03  2.66744548e+03
  3.02944459e+03  3.02944459e+03  3.02944459e+03  6.64980708e+03
  6.64980708e+03  6.64980708e+03  9.07221986e+03  2.54271510e+04
  7.61687034e+04]
E1 = -728.2974159891223  E_coul = 201.55895760041003
cycle= 5 E= -526.738458388712  delta_E= -1.66e-09  |g|= 2.04e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85244e-05
diis-c [-7.38149724e-11  1.42300597e-05 -1.84058536e-03 -1.38073180e-02
  4.36380347e-02  9.71995639e-01]
  HOMO = -0.582827113104444  LUMO = 1.00422991363739
  mo_energy =
[-1.18578280e+02 -1.23092984e+01 -9.56122168e+00 -9.56122168e+00
 -9.56122168e+00 -1.26998676e+00 -5.82827113e-01 -5.82827113e-01
 -5.82827113e-01  1.00422991e+00  1.02193334e+00  1.02193334e+00
  1.02193334e+00  7.39580876e+00  7.39580876e+00  7.39580876e+00
  1.36345048e+01  3.36981072e+01  3.36981072e+01  3.36981072e+01
  1.11843511e+02  1.29261536e+02  1.29261536e+02  1.29261536e+02
  4.83547088e+02  4.83547088e+02  4.83547088e+02  5.98000074e+02
  1.33530369e+03  1.33530369e+03  1.33530369e+03  2.66744544e+03
  3.02944456e+03  3.02944456e+03  3.02944456e+03  6.64980705e+03
  6.64980705e+03  6.64980705e+03  9.07221983e+03  2.54271509e+04
  7.61687034e+04]
E1 = -728.2974963982889  E_coul = 201.55903800951967
cycle= 6 E= -526.738458388769  delta_E= -5.7e-11  |g|= 1.75e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2974963982889  E_coul = 201.55903800951967
  HOMO = -0.582827133874271  LUMO = 1.0042302527886
  mo_energy =
[-1.18578279e+02 -1.23092982e+01 -9.56122162e+00 -9.56122162e+00
 -9.56122162e+00 -1.26998639e+00 -5.82827134e-01 -5.82827134e-01
 -5.82827134e-01  1.00423025e+00  1.02193338e+00  1.02193338e+00
  1.02193338e+00  7.39580881e+00  7.39580881e+00  7.39580881e+00
  1.36345050e+01  3.36981073e+01  3.36981073e+01  3.36981073e+01
  1.11843511e+02  1.29261536e+02  1.29261536e+02  1.29261536e+02
  4.83547089e+02  4.83547089e+02  4.83547089e+02  5.98000074e+02
  1.33530369e+03  1.33530369e+03  1.33530369e+03  2.66744544e+03
  3.02944456e+03  3.02944456e+03  3.02944456e+03  6.64980705e+03
  6.64980705e+03  6.64980705e+03  9.07221983e+03  2.54271509e+04
  7.61687034e+04]
E1 = -728.2974953721339  E_coul = 201.5590369833642
Extra cycle  E= -526.73845838877  delta_E= -4.55e-13  |g|= 3.59e-07  |ddm|= 3.06e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103902.2536778353
E1 = -728.2974953721339  E_coul = 201.5590369833642
init E= -526.73845838877
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582827165703962  LUMO = 1.00423029833942
  mo_energy =
[-1.18578279e+02 -1.23092983e+01 -9.56122171e+00 -9.56122171e+00
 -9.56122171e+00 -1.26998635e+00 -5.82827166e-01 -5.82827166e-01
 -5.82827166e-01  1.00423030e+00  1.02193337e+00  1.02193337e+00
  1.02193337e+00  7.39580875e+00  7.39580875e+00  7.39580875e+00
  1.36345050e+01  3.36981072e+01  3.36981072e+01  3.36981072e+01
  1.11843511e+02  1.29261536e+02  1.29261536e+02  1.29261536e+02
  4.83547088e+02  4.83547088e+02  4.83547088e+02  5.98000074e+02
  1.33530369e+03  1.33530369e+03  1.33530369e+03  2.66744544e+03
  3.02944456e+03  3.02944456e+03  3.02944456e+03  6.64980705e+03
  6.64980705e+03  6.64980705e+03  9.07221983e+03  2.54271509e+04
  7.61687034e+04]
E1 = -728.297495543928  E_coul = 201.55903715515709
cycle= 1 E= -526.738458388771  delta_E= -1.25e-12  |g|= 7.54e-08  |ddm|= 5.99e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.297495543928  E_coul = 201.55903715515709
  HOMO = -0.582827165026231  LUMO = 1.00423031386771
  mo_energy =
[-1.18578279e+02 -1.23092983e+01 -9.56122170e+00 -9.56122170e+00
 -9.56122170e+00 -1.26998633e+00 -5.82827165e-01 -5.82827165e-01
 -5.82827165e-01  1.00423031e+00  1.02193337e+00  1.02193337e+00
  1.02193337e+00  7.39580876e+00  7.39580876e+00  7.39580876e+00
  1.36345050e+01  3.36981072e+01  3.36981072e+01  3.36981072e+01
  1.11843511e+02  1.29261536e+02  1.29261536e+02  1.29261536e+02
  4.83547089e+02  4.83547089e+02  4.83547089e+02  5.98000074e+02
  1.33530369e+03  1.33530369e+03  1.33530369e+03  2.66744544e+03
  3.02944456e+03  3.02944456e+03  3.02944456e+03  6.64980705e+03
  6.64980705e+03  6.64980705e+03  9.07221983e+03  2.54271509e+04
  7.61687034e+04]
E1 = -728.2974954717945  E_coul = 201.55903708302404
Extra cycle  E= -526.73845838877  delta_E= 4.55e-13  |g|= 1.52e-08  |ddm|= 1.26e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826582e+04 7.61751695e+03 3.61735335e+03 1.59772375e+03
 3.82742991e+02 1.09990278e+02 3.61477304e+01 8.79124810e+00
 3.36097383e+00 6.60659716e-01 2.44810910e-01 1.36278398e+03
 6.64737976e+02 3.00925639e+02 3.14010931e+02 6.16539656e+01
 7.38698140e+00 2.02032022e+01 7.79959645e-01 2.85834618e+00
 2.23665436e-01]
grad_E = [-1.53107430e-06  3.45642935e-06 -1.49827564e-06  7.47627205e-05
 -1.45177508e-04 -4.12565031e-04 -1.18491310e-03  1.73403087e-03
  1.82086072e-05 -1.50528381e-04  1.40695007e-04 -5.25444620e-07
  4.74807924e-06  2.20615272e-05  1.90243364e-05  1.46510482e-04
  1.41536704e-03 -1.06718673e-03  1.61417664e-04  1.13214189e-03
 -8.44081733e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6582319        1
[INPUT] 0    0    [1    /1   ]  7617.51682788        1
[INPUT] 0    0    [1    /1   ]  3617.35341198        1
[INPUT] 0    0    [1    /1   ]  1597.72127867        1
[INPUT] 0    0    [1    /1   ]  382.74255344         1
[INPUT] 0    0    [1    /1   ]  110.021908191        1
[INPUT] 0    0    [1    /1   ]  36.200148488         1
[INPUT] 0    0    [1    /1   ]  8.81942366843        1
[INPUT] 0    0    [1    /1   ]  3.36693980036        1
[INPUT] 0    0    [1    /1   ]  0.662994705934       1
[INPUT] 0    0    [1    /1   ]  0.24569554854        1
[INPUT] 1    0    [1    /1   ]  1362.78400297        1
[INPUT] 1    0    [1    /1   ]  664.737795378        1
[INPUT] 1    0    [1    /1   ]  300.92478897         1
[INPUT] 1    0    [1    /1   ]  314.010198666        1
[INPUT] 1    0    [1    /1   ]  61.6542456842        1
[INPUT] 1    0    [1    /1   ]  7.38591185392        1
[INPUT] 1    0    [1    /1   ]  20.2051608565        1
[INPUT] 1    0    [1    /1   ]  0.779513932797       1
[INPUT] 1    0    [1    /1   ]  2.85333102888        1
[INPUT] 1    0    [1    /1   ]  0.223614167336       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.658231940186, 1.0]], [0, [7617.5168278813335, 1.0]], [0, [3617.3534119809374, 1.0]], [0, [1597.7212786712826, 1.0]], [0, [382.7425534397618, 1.0]], [0, [110.02190819142444, 1.0]], [0, [36.20014848800379, 1.0]], [0, [8.819423668434245, 1.0]], [0, [3.3669398003593436, 1.0]], [0, [0.6629947059337807, 1.0]], [0, [0.24569554854017595, 1.0]], [1, [1362.7840029703723, 1.0]], [1, [664.7377953778104, 1.0]], [1, [300.9247889697397, 1.0]], [1, [314.01019866592486, 1.0]], [1, [61.65424568423314, 1.0]], [1, [7.385911853924668, 1.0]], [1, [20.205160856485037, 1.0]], [1, [0.7795139327972506, 1.0]], [1, [2.8533310288764726, 1.0]], [1, [0.22361416733611833, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65823194]
bas 1, expnt(s) = [7617.51682788]
bas 2, expnt(s) = [3617.35341198]
bas 3, expnt(s) = [1597.72127867]
bas 4, expnt(s) = [382.74255344]
bas 5, expnt(s) = [110.02190819]
bas 6, expnt(s) = [36.20014849]
bas 7, expnt(s) = [8.81942367]
bas 8, expnt(s) = [3.3669398]
bas 9, expnt(s) = [0.66299471]
bas 10, expnt(s) = [0.24569555]
bas 11, expnt(s) = [1362.78400297]
bas 12, expnt(s) = [664.73779538]
bas 13, expnt(s) = [300.92478897]
bas 14, expnt(s) = [314.01019867]
bas 15, expnt(s) = [61.65424568]
bas 16, expnt(s) = [7.38591185]
bas 17, expnt(s) = [20.20516086]
bas 18, expnt(s) = [0.77951393]
bas 19, expnt(s) = [2.85333103]
bas 20, expnt(s) = [0.22361417]
CPU time:       255.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826582e+04 5.20026322e+03 7.61751683e+03 2.06003733e+03
 3.61735341e+03 1.17844205e+03 1.59772128e+03 6.38470431e+02
 3.82742553e+02 2.18622616e+02 1.10021908e+02 8.58270932e+01
 3.62001485e+01 3.72861711e+01 8.81942367e+00 1.29299004e+01
 3.36693980e+00 6.27973819e+00 6.62994706e-01 1.85629746e+00
 2.45695549e-01 8.81684062e-01 1.36278400e+03 2.41556193e+04
 6.64737795e+02 9.84685081e+03 3.00924789e+02 3.65642650e+03
 3.14010199e+02 3.85624026e+03 6.16542457e+01 5.04008811e+02
 7.38591185e+00 3.55213565e+01 2.02051609e+01 1.24971874e+02
 7.79513933e-01 2.13680182e+00 2.85333103e+00 1.08186879e+01
 2.23614167e-01 4.48599243e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993390403184353
cond(S) = 103918.96538718454
E1 = -729.5313988167261  E_coul = 203.17991571544087
init E= -526.351483101285
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555727045210002  LUMO = 1.0322137764338
  mo_energy =
[-1.18328680e+02 -1.22042447e+01 -9.44673833e+00 -9.44673833e+00
 -9.44673833e+00 -1.23994972e+00 -5.55727045e-01 -5.55727045e-01
 -5.55727045e-01  1.03221378e+00  1.03999761e+00  1.03999761e+00
  1.03999761e+00  7.45619115e+00  7.45619115e+00  7.45619115e+00
  1.37871858e+01  3.37971899e+01  3.37971899e+01  3.37971899e+01
  1.12280652e+02  1.29425462e+02  1.29425462e+02  1.29425462e+02
  4.83785505e+02  4.83785505e+02  4.83785505e+02  5.98701150e+02
  1.33559552e+03  1.33559552e+03  1.33559552e+03  2.66830753e+03
  3.02979915e+03  3.02979915e+03  3.02979915e+03  6.65027276e+03
  6.65027276e+03  6.65027276e+03  9.07317416e+03  2.54281771e+04
  7.61697930e+04]
E1 = -727.8542240338708  E_coul = 201.11650956424134
cycle= 1 E= -526.737714469629  delta_E= -0.386  |g|= 0.185  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541905
diis-c [-0.29366129  1.        ]
  HOMO = -0.590377327910887  LUMO = 1.00348096867618
  mo_energy =
[-1.18635702e+02 -1.23413716e+01 -9.59458061e+00 -9.59458061e+00
 -9.59458061e+00 -1.27914651e+00 -5.90377328e-01 -5.90377328e-01
 -5.90377328e-01  1.00348097e+00  1.01567979e+00  1.01567979e+00
  1.01567979e+00  7.36514983e+00  7.36514983e+00  7.36514983e+00
  1.36733237e+01  3.36436090e+01  3.36436090e+01  3.36436090e+01
  1.12059603e+02  1.29197944e+02  1.29197944e+02  1.29197944e+02
  4.83479634e+02  4.83479634e+02  4.83479634e+02  5.98357097e+02
  1.33523313e+03  1.33523313e+03  1.33523313e+03  2.66781118e+03
  3.02937079e+03  3.02937079e+03  3.02937079e+03  6.64973123e+03
  6.64973123e+03  6.64973123e+03  9.07255752e+03  2.54274664e+04
  7.61689922e+04]
E1 = -728.4246465573599  E_coul = 201.68621928012448
cycle= 2 E= -526.738427277235  delta_E= -0.000713  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748796
diis-c [-0.00328976  0.08200587  0.91799413]
  HOMO = -0.581318685388973  LUMO = 1.01173691458369
  mo_energy =
[-1.18568351e+02 -1.23035469e+01 -9.55511704e+00 -9.55511704e+00
 -9.55511704e+00 -1.26830223e+00 -5.81318685e-01 -5.81318685e-01
 -5.81318685e-01  1.01173691e+00  1.02241482e+00  1.02241482e+00
  1.02241482e+00  7.38891723e+00  7.38891723e+00  7.38891723e+00
  1.37044774e+01  3.36834674e+01  3.36834674e+01  3.36834674e+01
  1.12115264e+02  1.29253512e+02  1.29253512e+02  1.29253512e+02
  4.83546169e+02  4.83546169e+02  4.83546169e+02  5.98425982e+02
  1.33530370e+03  1.33530370e+03  1.33530370e+03  2.66788505e+03
  3.02944359e+03  3.02944359e+03  3.02944359e+03  6.64980577e+03
  6.64980577e+03  6.64980577e+03  9.07263287e+03  2.54275423e+04
  7.61690684e+04]
E1 = -728.2754462456904  E_coul = 201.53696085214432
cycle= 3 E= -526.738485393546  delta_E= -5.81e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131251
diis-c [-5.79035071e-07 -1.24839005e-03  1.44667494e-01  8.56580896e-01]
  HOMO = -0.582808443989803  LUMO = 1.0104759361307
  mo_energy =
[-1.18578262e+02 -1.23093224e+01 -9.56123726e+00 -9.56123726e+00
 -9.56123726e+00 -1.26998415e+00 -5.82808444e-01 -5.82808444e-01
 -5.82808444e-01  1.01047594e+00  1.02133134e+00  1.02133134e+00
  1.02133134e+00  7.38513626e+00  7.38513626e+00  7.38513626e+00
  1.36996985e+01  3.36773256e+01  3.36773256e+01  3.36773256e+01
  1.12106995e+02  1.29245209e+02  1.29245209e+02  1.29245209e+02
  4.83536374e+02  4.83536374e+02  4.83536374e+02  5.98415833e+02
  1.33529331e+03  1.33529331e+03  1.33529331e+03  2.66787404e+03
  3.02943282e+03  3.02943282e+03  3.02943282e+03  6.64979461e+03
  6.64979461e+03  6.64979461e+03  9.07262149e+03  2.54275308e+04
  7.61690567e+04]
E1 = -728.2980768294944  E_coul = 201.55958953884388
cycle= 4 E= -526.738487290651  delta_E= -1.9e-06  |g|= 9.69e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113742
diis-c [-4.04942975e-09  7.16356909e-05 -1.02532493e-02 -6.66140837e-02
  1.07679570e+00]
  HOMO = -0.582790457572727  LUMO = 1.0105097212374
  mo_energy =
[-1.18578223e+02 -1.23092592e+01 -9.56118748e+00 -9.56118748e+00
 -9.56118748e+00 -1.26994386e+00 -5.82790458e-01 -5.82790458e-01
 -5.82790458e-01  1.01050972e+00  1.02134694e+00  1.02134694e+00
  1.02134694e+00  7.38517716e+00  7.38517716e+00  7.38517716e+00
  1.36997574e+01  3.36773734e+01  3.36773734e+01  3.36773734e+01
  1.12107045e+02  1.29245255e+02  1.29245255e+02  1.29245255e+02
  4.83536412e+02  4.83536412e+02  4.83536412e+02  5.98415864e+02
  1.33529334e+03  1.33529334e+03  1.33529334e+03  2.66787405e+03
  3.02943284e+03  3.02943284e+03  3.02943284e+03  6.64979462e+03
  6.64979462e+03  6.64979462e+03  9.07262149e+03  2.54275308e+04
  7.61690567e+04]
E1 = -728.2978696948189  E_coul = 201.55938240252425
cycle= 5 E= -526.738487292295  delta_E= -1.64e-09  |g|= 2.03e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.84694e-05
diis-c [-7.32331932e-11  1.42073691e-05 -1.83918272e-03 -1.37875673e-02
  4.36052691e-02  9.72007274e-01]
  HOMO = -0.582797803479225  LUMO = 1.01050574255106
  mo_energy =
[-1.18578254e+02 -1.23092814e+01 -9.56121164e+00 -9.56121164e+00
 -9.56121164e+00 -1.26994972e+00 -5.82797803e-01 -5.82797803e-01
 -5.82797803e-01  1.01050574e+00  1.02134203e+00  1.02134203e+00
  1.02134203e+00  7.38516068e+00  7.38516068e+00  7.38516068e+00
  1.36997388e+01  3.36773500e+01  3.36773500e+01  3.36773500e+01
  1.12107018e+02  1.29245227e+02  1.29245227e+02  1.29245227e+02
  4.83536382e+02  4.83536382e+02  4.83536382e+02  5.98415834e+02
  1.33529331e+03  1.33529331e+03  1.33529331e+03  2.66787401e+03
  3.02943281e+03  3.02943281e+03  3.02943281e+03  6.64979459e+03
  6.64979459e+03  6.64979459e+03  9.07262146e+03  2.54275307e+04
  7.61690567e+04]
E1 = -728.2979499959422  E_coul = 201.55946270359078
cycle= 6 E= -526.738487292351  delta_E= -5.68e-11  |g|= 1.74e-06  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2979499959422  E_coul = 201.55946270359078
  HOMO = -0.58279782348396  LUMO = 1.01050608202629
  mo_energy =
[-1.18578253e+02 -1.23092813e+01 -9.56121157e+00 -9.56121157e+00
 -9.56121157e+00 -1.26994936e+00 -5.82797823e-01 -5.82797823e-01
 -5.82797823e-01  1.01050608e+00  1.02134207e+00  1.02134207e+00
  1.02134207e+00  7.38516072e+00  7.38516072e+00  7.38516072e+00
  1.36997390e+01  3.36773501e+01  3.36773501e+01  3.36773501e+01
  1.12107018e+02  1.29245228e+02  1.29245228e+02  1.29245228e+02
  4.83536382e+02  4.83536382e+02  4.83536382e+02  5.98415834e+02
  1.33529331e+03  1.33529331e+03  1.33529331e+03  2.66787401e+03
  3.02943281e+03  3.02943281e+03  3.02943281e+03  6.64979459e+03
  6.64979459e+03  6.64979459e+03  9.07262146e+03  2.54275307e+04
  7.61690567e+04]
E1 = -728.2979489879593  E_coul = 201.55946169560846
Extra cycle  E= -526.738487292351  delta_E= 5.68e-13  |g|= 3.58e-07  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
exp = [2.61826582e+04 7.61751683e+03 3.61735341e+03 1.59772128e+03
 3.82742553e+02 1.10021908e+02 3.62001485e+01 8.81942367e+00
 3.36693980e+00 6.62994706e-01 2.45695549e-01 1.36278400e+03
 6.64737795e+02 3.00924789e+02 3.14010199e+02 6.16542457e+01
 7.38591185e+00 2.02051609e+01 7.79513933e-01 2.85333103e+00
 2.23614167e-01]
E = -526.7384872923509
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6582319        1
[INPUT] 0    0    [1    /1   ]  7617.51682788        1
[INPUT] 0    0    [1    /1   ]  3617.35341198        1
[INPUT] 0    0    [1    /1   ]  1597.72127867        1
[INPUT] 0    0    [1    /1   ]  382.74255344         1
[INPUT] 0    0    [1    /1   ]  110.021908191        1
[INPUT] 0    0    [1    /1   ]  36.200148488         1
[INPUT] 0    0    [1    /1   ]  8.81942366843        1
[INPUT] 0    0    [1    /1   ]  3.36693980036        1
[INPUT] 0    0    [1    /1   ]  0.662994705934       1
[INPUT] 0    0    [1    /1   ]  0.24569554854        1
[INPUT] 1    0    [1    /1   ]  1362.78400297        1
[INPUT] 1    0    [1    /1   ]  664.737795378        1
[INPUT] 1    0    [1    /1   ]  300.92478897         1
[INPUT] 1    0    [1    /1   ]  314.010198666        1
[INPUT] 1    0    [1    /1   ]  61.6542456842        1
[INPUT] 1    0    [1    /1   ]  7.38591185392        1
[INPUT] 1    0    [1    /1   ]  20.2051608565        1
[INPUT] 1    0    [1    /1   ]  0.779513932797       1
[INPUT] 1    0    [1    /1   ]  2.85333102888        1
[INPUT] 1    0    [1    /1   ]  0.223614167336       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.658231940186, 1.0]], [0, [7617.5168278813335, 1.0]], [0, [3617.3534119809374, 1.0]], [0, [1597.7212786712826, 1.0]], [0, [382.7425534397618, 1.0]], [0, [110.02190819142444, 1.0]], [0, [36.20014848800379, 1.0]], [0, [8.819423668434245, 1.0]], [0, [3.3669398003593436, 1.0]], [0, [0.6629947059337807, 1.0]], [0, [0.24569554854017595, 1.0]], [1, [1362.7840029703723, 1.0]], [1, [664.7377953778104, 1.0]], [1, [300.9247889697397, 1.0]], [1, [314.01019866592486, 1.0]], [1, [61.65424568423314, 1.0]], [1, [7.385911853924668, 1.0]], [1, [20.205160856485037, 1.0]], [1, [0.7795139327972506, 1.0]], [1, [2.8533310288764726, 1.0]], [1, [0.22361416733611833, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65823194]
bas 1, expnt(s) = [7617.51682788]
bas 2, expnt(s) = [3617.35341198]
bas 3, expnt(s) = [1597.72127867]
bas 4, expnt(s) = [382.74255344]
bas 5, expnt(s) = [110.02190819]
bas 6, expnt(s) = [36.20014849]
bas 7, expnt(s) = [8.81942367]
bas 8, expnt(s) = [3.3669398]
bas 9, expnt(s) = [0.66299471]
bas 10, expnt(s) = [0.24569555]
bas 11, expnt(s) = [1362.78400297]
bas 12, expnt(s) = [664.73779538]
bas 13, expnt(s) = [300.92478897]
bas 14, expnt(s) = [314.01019867]
bas 15, expnt(s) = [61.65424568]
bas 16, expnt(s) = [7.38591185]
bas 17, expnt(s) = [20.20516086]
bas 18, expnt(s) = [0.77951393]
bas 19, expnt(s) = [2.85333103]
bas 20, expnt(s) = [0.22361417]
CPU time:       256.42
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826582e+04 5.20026322e+03 7.61751683e+03 2.06003733e+03
 3.61735341e+03 1.17844205e+03 1.59772128e+03 6.38470431e+02
 3.82742553e+02 2.18622616e+02 1.10021908e+02 8.58270932e+01
 3.62001485e+01 3.72861711e+01 8.81942367e+00 1.29299004e+01
 3.36693980e+00 6.27973819e+00 6.62994706e-01 1.85629746e+00
 2.45695549e-01 8.81684062e-01 1.36278400e+03 2.41556193e+04
 6.64737795e+02 9.84685081e+03 3.00924789e+02 3.65642650e+03
 3.14010199e+02 3.85624026e+03 6.16542457e+01 5.04008811e+02
 7.38591185e+00 3.55213565e+01 2.02051609e+01 1.24971874e+02
 7.79513933e-01 2.13680182e+00 2.85333103e+00 1.08186879e+01
 2.23614167e-01 4.48599243e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993390403184353
cond(S) = 103918.96538718454
E1 = -729.5313988167261  E_coul = 203.17991571544087
init E= -526.351483101285
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555727045210002  LUMO = 1.0322137764338
  mo_energy =
[-1.18328680e+02 -1.22042447e+01 -9.44673833e+00 -9.44673833e+00
 -9.44673833e+00 -1.23994972e+00 -5.55727045e-01 -5.55727045e-01
 -5.55727045e-01  1.03221378e+00  1.03999761e+00  1.03999761e+00
  1.03999761e+00  7.45619115e+00  7.45619115e+00  7.45619115e+00
  1.37871858e+01  3.37971899e+01  3.37971899e+01  3.37971899e+01
  1.12280652e+02  1.29425462e+02  1.29425462e+02  1.29425462e+02
  4.83785505e+02  4.83785505e+02  4.83785505e+02  5.98701150e+02
  1.33559552e+03  1.33559552e+03  1.33559552e+03  2.66830753e+03
  3.02979915e+03  3.02979915e+03  3.02979915e+03  6.65027276e+03
  6.65027276e+03  6.65027276e+03  9.07317416e+03  2.54281771e+04
  7.61697930e+04]
E1 = -727.8542240338708  E_coul = 201.11650956424134
cycle= 1 E= -526.737714469629  delta_E= -0.386  |g|= 0.185  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541905
diis-c [-0.29366129  1.        ]
  HOMO = -0.590377327910887  LUMO = 1.00348096867618
  mo_energy =
[-1.18635702e+02 -1.23413716e+01 -9.59458061e+00 -9.59458061e+00
 -9.59458061e+00 -1.27914651e+00 -5.90377328e-01 -5.90377328e-01
 -5.90377328e-01  1.00348097e+00  1.01567979e+00  1.01567979e+00
  1.01567979e+00  7.36514983e+00  7.36514983e+00  7.36514983e+00
  1.36733237e+01  3.36436090e+01  3.36436090e+01  3.36436090e+01
  1.12059603e+02  1.29197944e+02  1.29197944e+02  1.29197944e+02
  4.83479634e+02  4.83479634e+02  4.83479634e+02  5.98357097e+02
  1.33523313e+03  1.33523313e+03  1.33523313e+03  2.66781118e+03
  3.02937079e+03  3.02937079e+03  3.02937079e+03  6.64973123e+03
  6.64973123e+03  6.64973123e+03  9.07255752e+03  2.54274664e+04
  7.61689922e+04]
E1 = -728.4246465573599  E_coul = 201.68621928012448
cycle= 2 E= -526.738427277235  delta_E= -0.000713  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748796
diis-c [-0.00328976  0.08200587  0.91799413]
  HOMO = -0.581318685388973  LUMO = 1.01173691458369
  mo_energy =
[-1.18568351e+02 -1.23035469e+01 -9.55511704e+00 -9.55511704e+00
 -9.55511704e+00 -1.26830223e+00 -5.81318685e-01 -5.81318685e-01
 -5.81318685e-01  1.01173691e+00  1.02241482e+00  1.02241482e+00
  1.02241482e+00  7.38891723e+00  7.38891723e+00  7.38891723e+00
  1.37044774e+01  3.36834674e+01  3.36834674e+01  3.36834674e+01
  1.12115264e+02  1.29253512e+02  1.29253512e+02  1.29253512e+02
  4.83546169e+02  4.83546169e+02  4.83546169e+02  5.98425982e+02
  1.33530370e+03  1.33530370e+03  1.33530370e+03  2.66788505e+03
  3.02944359e+03  3.02944359e+03  3.02944359e+03  6.64980577e+03
  6.64980577e+03  6.64980577e+03  9.07263287e+03  2.54275423e+04
  7.61690684e+04]
E1 = -728.2754462456904  E_coul = 201.53696085214432
cycle= 3 E= -526.738485393546  delta_E= -5.81e-05  |g|= 0.00625  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131251
diis-c [-5.79035071e-07 -1.24839005e-03  1.44667494e-01  8.56580896e-01]
  HOMO = -0.582808443989803  LUMO = 1.0104759361307
  mo_energy =
[-1.18578262e+02 -1.23093224e+01 -9.56123726e+00 -9.56123726e+00
 -9.56123726e+00 -1.26998415e+00 -5.82808444e-01 -5.82808444e-01
 -5.82808444e-01  1.01047594e+00  1.02133134e+00  1.02133134e+00
  1.02133134e+00  7.38513626e+00  7.38513626e+00  7.38513626e+00
  1.36996985e+01  3.36773256e+01  3.36773256e+01  3.36773256e+01
  1.12106995e+02  1.29245209e+02  1.29245209e+02  1.29245209e+02
  4.83536374e+02  4.83536374e+02  4.83536374e+02  5.98415833e+02
  1.33529331e+03  1.33529331e+03  1.33529331e+03  2.66787404e+03
  3.02943282e+03  3.02943282e+03  3.02943282e+03  6.64979461e+03
  6.64979461e+03  6.64979461e+03  9.07262149e+03  2.54275308e+04
  7.61690567e+04]
E1 = -728.2980768294944  E_coul = 201.55958953884388
cycle= 4 E= -526.738487290651  delta_E= -1.9e-06  |g|= 9.69e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113742
diis-c [-4.04942975e-09  7.16356909e-05 -1.02532493e-02 -6.66140837e-02
  1.07679570e+00]
  HOMO = -0.582790457572727  LUMO = 1.0105097212374
  mo_energy =
[-1.18578223e+02 -1.23092592e+01 -9.56118748e+00 -9.56118748e+00
 -9.56118748e+00 -1.26994386e+00 -5.82790458e-01 -5.82790458e-01
 -5.82790458e-01  1.01050972e+00  1.02134694e+00  1.02134694e+00
  1.02134694e+00  7.38517716e+00  7.38517716e+00  7.38517716e+00
  1.36997574e+01  3.36773734e+01  3.36773734e+01  3.36773734e+01
  1.12107045e+02  1.29245255e+02  1.29245255e+02  1.29245255e+02
  4.83536412e+02  4.83536412e+02  4.83536412e+02  5.98415864e+02
  1.33529334e+03  1.33529334e+03  1.33529334e+03  2.66787405e+03
  3.02943284e+03  3.02943284e+03  3.02943284e+03  6.64979462e+03
  6.64979462e+03  6.64979462e+03  9.07262149e+03  2.54275308e+04
  7.61690567e+04]
E1 = -728.2978696948189  E_coul = 201.55938240252425
cycle= 5 E= -526.738487292295  delta_E= -1.64e-09  |g|= 2.03e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.84694e-05
diis-c [-7.32331932e-11  1.42073691e-05 -1.83918272e-03 -1.37875673e-02
  4.36052691e-02  9.72007274e-01]
  HOMO = -0.582797803479225  LUMO = 1.01050574255106
  mo_energy =
[-1.18578254e+02 -1.23092814e+01 -9.56121164e+00 -9.56121164e+00
 -9.56121164e+00 -1.26994972e+00 -5.82797803e-01 -5.82797803e-01
 -5.82797803e-01  1.01050574e+00  1.02134203e+00  1.02134203e+00
  1.02134203e+00  7.38516068e+00  7.38516068e+00  7.38516068e+00
  1.36997388e+01  3.36773500e+01  3.36773500e+01  3.36773500e+01
  1.12107018e+02  1.29245227e+02  1.29245227e+02  1.29245227e+02
  4.83536382e+02  4.83536382e+02  4.83536382e+02  5.98415834e+02
  1.33529331e+03  1.33529331e+03  1.33529331e+03  2.66787401e+03
  3.02943281e+03  3.02943281e+03  3.02943281e+03  6.64979459e+03
  6.64979459e+03  6.64979459e+03  9.07262146e+03  2.54275307e+04
  7.61690567e+04]
E1 = -728.2979499959422  E_coul = 201.55946270359078
cycle= 6 E= -526.738487292351  delta_E= -5.68e-11  |g|= 1.74e-06  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2979499959422  E_coul = 201.55946270359078
  HOMO = -0.58279782348396  LUMO = 1.01050608202629
  mo_energy =
[-1.18578253e+02 -1.23092813e+01 -9.56121157e+00 -9.56121157e+00
 -9.56121157e+00 -1.26994936e+00 -5.82797823e-01 -5.82797823e-01
 -5.82797823e-01  1.01050608e+00  1.02134207e+00  1.02134207e+00
  1.02134207e+00  7.38516072e+00  7.38516072e+00  7.38516072e+00
  1.36997390e+01  3.36773501e+01  3.36773501e+01  3.36773501e+01
  1.12107018e+02  1.29245228e+02  1.29245228e+02  1.29245228e+02
  4.83536382e+02  4.83536382e+02  4.83536382e+02  5.98415834e+02
  1.33529331e+03  1.33529331e+03  1.33529331e+03  2.66787401e+03
  3.02943281e+03  3.02943281e+03  3.02943281e+03  6.64979459e+03
  6.64979459e+03  6.64979459e+03  9.07262146e+03  2.54275307e+04
  7.61690567e+04]
E1 = -728.2979489879593  E_coul = 201.55946169560846
Extra cycle  E= -526.738487292351  delta_E= 5.68e-13  |g|= 3.58e-07  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103918.96538718454
E1 = -728.2979489879593  E_coul = 201.55946169560846
init E= -526.738487292351
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582797854757508  LUMO = 1.01050612782959
  mo_energy =
[-1.18578254e+02 -1.23092814e+01 -9.56121167e+00 -9.56121167e+00
 -9.56121167e+00 -1.26994931e+00 -5.82797855e-01 -5.82797855e-01
 -5.82797855e-01  1.01050613e+00  1.02134206e+00  1.02134206e+00
  1.02134206e+00  7.38516067e+00  7.38516067e+00  7.38516067e+00
  1.36997390e+01  3.36773500e+01  3.36773500e+01  3.36773500e+01
  1.12107018e+02  1.29245227e+02  1.29245227e+02  1.29245227e+02
  4.83536382e+02  4.83536382e+02  4.83536382e+02  5.98415834e+02
  1.33529331e+03  1.33529331e+03  1.33529331e+03  2.66787401e+03
  3.02943281e+03  3.02943281e+03  3.02943281e+03  6.64979459e+03
  6.64979459e+03  6.64979459e+03  9.07262146e+03  2.54275307e+04
  7.61690567e+04]
E1 = -728.2979491574746  E_coul = 201.55946186512298
cycle= 1 E= -526.738487292352  delta_E= -6.82e-13  |g|= 7.5e-08  |ddm|= 5.96e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2979491574746  E_coul = 201.55946186512298
  HOMO = -0.582797854077654  LUMO = 1.01050614333117
  mo_energy =
[-1.18578254e+02 -1.23092813e+01 -9.56121166e+00 -9.56121166e+00
 -9.56121166e+00 -1.26994930e+00 -5.82797854e-01 -5.82797854e-01
 -5.82797854e-01  1.01050614e+00  1.02134206e+00  1.02134206e+00
  1.02134206e+00  7.38516067e+00  7.38516067e+00  7.38516067e+00
  1.36997390e+01  3.36773500e+01  3.36773500e+01  3.36773500e+01
  1.12107018e+02  1.29245227e+02  1.29245227e+02  1.29245227e+02
  4.83536382e+02  4.83536382e+02  4.83536382e+02  5.98415834e+02
  1.33529331e+03  1.33529331e+03  1.33529331e+03  2.66787401e+03
  3.02943281e+03  3.02943281e+03  3.02943281e+03  6.64979459e+03
  6.64979459e+03  6.64979459e+03  9.07262146e+03  2.54275307e+04
  7.61690567e+04]
E1 = -728.2979490865481  E_coul = 201.5594617941954
Extra cycle  E= -526.738487292353  delta_E= -1.14e-12  |g|= 1.51e-08  |ddm|= 1.26e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61826582e+04 7.61751683e+03 3.61735341e+03 1.59772128e+03
 3.82742553e+02 1.10021908e+02 3.62001485e+01 8.81942367e+00
 3.36693980e+00 6.62994706e-01 2.45695549e-01 1.36278400e+03
 6.64737795e+02 3.00924789e+02 3.14010199e+02 6.16542457e+01
 7.38591185e+00 2.02051609e+01 7.79513933e-01 2.85333103e+00
 2.23614167e-01]
grad_E = [-1.53072225e-06  3.45229256e-06 -1.50074109e-06  7.45938516e-05
 -1.38821953e-04 -4.80778926e-04 -9.88429481e-04  1.87654331e-03
 -4.24378757e-04  1.66472807e-04  1.90515127e-04 -5.25820064e-07
  4.74260578e-06  2.20272958e-05  1.89950658e-05  1.52239882e-04
  1.88933614e-03 -1.15118946e-03 -4.31043305e-04  3.10104402e-04
  1.61455154e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6583574        1
[INPUT] 0    0    [1    /1   ]  7617.51655564        1
[INPUT] 0    0    [1    /1   ]  3617.35354337        1
[INPUT] 0    0    [1    /1   ]  1597.7156104         1
[INPUT] 0    0    [1    /1   ]  382.741540846        1
[INPUT] 0    0    [1    /1   ]  110.100440906        1
[INPUT] 0    0    [1    /1   ]  36.2962658641        1
[INPUT] 0    0    [1    /1   ]  8.85164053677        1
[INPUT] 0    0    [1    /1   ]  3.37434934711        1
[INPUT] 0    0    [1    /1   ]  0.66672690741        1
[INPUT] 0    0    [1    /1   ]  0.247062783264       1
[INPUT] 1    0    [1    /1   ]  1362.784045          1
[INPUT] 1    0    [1    /1   ]  664.737382385        1
[INPUT] 1    0    [1    /1   ]  300.922842701        1
[INPUT] 1    0    [1    /1   ]  314.008520631        1
[INPUT] 1    0    [1    /1   ]  61.6549010502        1
[INPUT] 1    0    [1    /1   ]  7.38285560735        1
[INPUT] 1    0    [1    /1   ]  20.2095024206        1
[INPUT] 1    0    [1    /1   ]  0.778709969812       1
[INPUT] 1    0    [1    /1   ]  2.84435104595        1
[INPUT] 1    0    [1    /1   ]  0.223509442742       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65835737289, 1.0]], [0, [7617.516555636733, 1.0]], [0, [3617.3535433739085, 1.0]], [0, [1597.715610404361, 1.0]], [0, [382.74154084615935, 1.0]], [0, [110.1004409061347, 1.0]], [0, [36.29626586407289, 1.0]], [0, [8.85164053677281, 1.0]], [0, [3.3743493471095856, 1.0]], [0, [0.6667269074102282, 1.0]], [0, [0.24706278326397355, 1.0]], [1, [1362.7840450011174, 1.0]], [1, [664.737382385179, 1.0]], [1, [300.9228427010569, 1.0]], [1, [314.00852063088104, 1.0]], [1, [61.6549010501822, 1.0]], [1, [7.382855607345319, 1.0]], [1, [20.209502420589214, 1.0]], [1, [0.7787099698124542, 1.0]], [1, [2.844351045946893, 1.0]], [1, [0.22350944274160575, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65835737]
bas 1, expnt(s) = [7617.51655564]
bas 2, expnt(s) = [3617.35354337]
bas 3, expnt(s) = [1597.7156104]
bas 4, expnt(s) = [382.74154085]
bas 5, expnt(s) = [110.10044091]
bas 6, expnt(s) = [36.29626586]
bas 7, expnt(s) = [8.85164054]
bas 8, expnt(s) = [3.37434935]
bas 9, expnt(s) = [0.66672691]
bas 10, expnt(s) = [0.24706278]
bas 11, expnt(s) = [1362.784045]
bas 12, expnt(s) = [664.73738239]
bas 13, expnt(s) = [300.9228427]
bas 14, expnt(s) = [314.00852063]
bas 15, expnt(s) = [61.65490105]
bas 16, expnt(s) = [7.38285561]
bas 17, expnt(s) = [20.20950242]
bas 18, expnt(s) = [0.77870997]
bas 19, expnt(s) = [2.84435105]
bas 20, expnt(s) = [0.22350944]
CPU time:       262.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826584e+04 5.20026324e+03 7.61751656e+03 2.06003728e+03
 3.61735354e+03 1.17844208e+03 1.59771561e+03 6.38468732e+02
 3.82741541e+02 2.18622182e+02 1.10100441e+02 8.58730361e+01
 3.62962659e+01 3.73603972e+01 8.85164054e+00 1.29653084e+01
 3.37434935e+00 6.29010010e+00 6.66726907e-01 1.86412921e+00
 2.47062783e-01 8.85361273e-01 1.36278405e+03 2.41556202e+04
 6.64737382e+02 9.84684316e+03 3.00922843e+02 3.65639694e+03
 3.14008521e+02 3.85621450e+03 6.16549011e+01 5.04015507e+02
 7.38285561e+00 3.55029843e+01 2.02095024e+01 1.25005442e+02
 7.78709970e-01 2.13404740e+00 2.84435105e+00 1.07761440e+01
 2.23509443e-01 4.48336645e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99339704428695
cond(S) = 103940.04991984017
E1 = -729.5317545501437  E_coul = 203.1802200685062
init E= -526.351534481637
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555725128013128  LUMO = 1.03882332643598
  mo_energy =
[-1.18328716e+02 -1.22042130e+01 -9.44670780e+00 -9.44670780e+00
 -9.44670780e+00 -1.23992535e+00 -5.55725128e-01 -5.55725128e-01
 -5.55725128e-01  1.03882333e+00  1.03882333e+00  1.03882333e+00
  1.04217137e+00  7.43658465e+00  7.43658465e+00  7.43658465e+00
  1.38725865e+01  3.37577898e+01  3.37577898e+01  3.37577898e+01
  1.12677695e+02  1.29394661e+02  1.29394661e+02  1.29394661e+02
  4.83765677e+02  4.83765677e+02  4.83765677e+02  5.99422657e+02
  1.33557568e+03  1.33557568e+03  1.33557568e+03  2.66908524e+03
  3.02977580e+03  3.02977580e+03  3.02977580e+03  6.65024739e+03
  6.65024739e+03  6.65024739e+03  9.07390752e+03  2.54288706e+04
  7.61704378e+04]
E1 = -727.8549181873116  E_coul = 201.117132690692
cycle= 1 E= -526.73778549662  delta_E= -0.386  |g|= 0.185  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.5417
diis-c [-0.29343858  1.        ]
  HOMO = -0.590336953920917  LUMO = 1.01323761863578
  mo_energy =
[-1.18635663e+02 -1.23413570e+01 -9.59456459e+00 -9.59456459e+00
 -9.59456459e+00 -1.27909332e+00 -5.90336954e-01 -5.90336954e-01
 -5.90336954e-01  1.01323762e+00  1.01457132e+00  1.01457132e+00
  1.01457132e+00  7.34567562e+00  7.34567562e+00  7.34567562e+00
  1.37584507e+01  3.36042221e+01  3.36042221e+01  3.36042221e+01
  1.12456494e+02  1.29167158e+02  1.29167158e+02  1.29167158e+02
  4.83459878e+02  4.83459878e+02  4.83459878e+02  5.99078720e+02
  1.33521345e+03  1.33521345e+03  1.33521345e+03  2.66858909e+03
  3.02934760e+03  3.02934760e+03  3.02934760e+03  6.64970606e+03
  6.64970606e+03  6.64970606e+03  9.07329109e+03  2.54281601e+04
  7.61696372e+04]
E1 = -728.4253062925104  E_coul = 201.68680836174423
cycle= 2 E= -526.738497930766  delta_E= -0.000712  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748485
diis-c [-0.00329178  0.08192627  0.91807373]
  HOMO = -0.58127719931046  LUMO = 1.02129656945088
  mo_energy =
[-1.18568314e+02 -1.23035311e+01 -9.55509972e+00 -9.55509972e+00
 -9.55509972e+00 -1.26824779e+00 -5.81277199e-01 -5.81277199e-01
 -5.81277199e-01  1.02129657e+00  1.02129657e+00  1.02129657e+00
  1.02155398e+00  7.36941436e+00  7.36941436e+00  7.36941436e+00
  1.37896671e+01  3.36440811e+01  3.36440811e+01  3.36440811e+01
  1.12512180e+02  1.29222728e+02  1.29222728e+02  1.29222728e+02
  4.83526411e+02  4.83526411e+02  4.83526411e+02  5.99147605e+02
  1.33528401e+03  1.33528401e+03  1.33528401e+03  2.66866296e+03
  3.02942040e+03  3.02942040e+03  3.02942040e+03  6.64978060e+03
  6.64978060e+03  6.64978060e+03  9.07336644e+03  2.54282360e+04
  7.61697134e+04]
E1 = -728.2760718461775  E_coul = 201.53751579557002
cycle= 3 E= -526.738556050607  delta_E= -5.81e-05  |g|= 0.00626  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131317
diis-c [-5.76097336e-07 -1.24787625e-03  1.44794076e-01  8.56453801e-01]
  HOMO = -0.582767520272119  LUMO = 1.0202142889028
  mo_energy =
[-1.18578233e+02 -1.23093110e+01 -9.56122457e+00 -9.56122457e+00
 -9.56122457e+00 -1.26993094e+00 -5.82767520e-01 -5.82767520e-01
 -5.82767520e-01  1.02021429e+00  1.02021429e+00  1.02021429e+00
  1.02028281e+00  7.36563561e+00  7.36563561e+00  7.36563561e+00
  1.37848751e+01  3.36379347e+01  3.36379347e+01  3.36379347e+01
  1.12503901e+02  1.29214417e+02  1.29214417e+02  1.29214417e+02
  4.83516607e+02  4.83516607e+02  4.83516607e+02  5.99137448e+02
  1.33527362e+03  1.33527362e+03  1.33527362e+03  2.66865194e+03
  3.02940962e+03  3.02940962e+03  3.02940962e+03  6.64976944e+03
  6.64976944e+03  6.64976944e+03  9.07335506e+03  2.54282245e+04
  7.61697017e+04]
E1 = -728.2987264318749  E_coul = 201.5601684805932
cycle= 4 E= -526.738557951282  delta_E= -1.9e-06  |g|= 9.65e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113307
diis-c [-4.02900807e-09  7.12746147e-05 -1.02074448e-02 -6.62614015e-02
  1.07639757e+00]
  HOMO = -0.582749492769466  LUMO = 1.02022987878998
  mo_energy =
[-1.18578195e+02 -1.23092479e+01 -9.56117479e+00 -9.56117479e+00
 -9.56117479e+00 -1.26989073e+00 -5.82749493e-01 -5.82749493e-01
 -5.82749493e-01  1.02022988e+00  1.02022988e+00  1.02022988e+00
  1.02031671e+00  7.36567648e+00  7.36567648e+00  7.36567648e+00
  1.37849339e+01  3.36379825e+01  3.36379825e+01  3.36379825e+01
  1.12503951e+02  1.29214463e+02  1.29214463e+02  1.29214463e+02
  4.83516646e+02  4.83516646e+02  4.83516646e+02  5.99137479e+02
  1.33527365e+03  1.33527365e+03  1.33527365e+03  2.66865195e+03
  3.02940964e+03  3.02940964e+03  3.02940964e+03  6.64976944e+03
  6.64976944e+03  6.64976944e+03  9.07335506e+03  2.54282244e+04
  7.61697017e+04]
E1 = -728.2985200911908  E_coul = 201.55996213828743
cycle= 5 E= -526.738557952903  delta_E= -1.62e-09  |g|= 2.03e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83834e-05
diis-c [-7.22979187e-11  1.41746500e-05 -1.83747950e-03 -1.37588349e-02
  4.35447028e-02  9.72037437e-01]
  HOMO = -0.582756800366351  LUMO = 1.02022500072349
  mo_energy =
[-1.18578225e+02 -1.23092701e+01 -9.56119886e+00 -9.56119886e+00
 -9.56119886e+00 -1.26989657e+00 -5.82756800e-01 -5.82756800e-01
 -5.82756800e-01  1.02022500e+00  1.02022500e+00  1.02022500e+00
  1.02031272e+00  7.36566009e+00  7.36566009e+00  7.36566009e+00
  1.37849154e+01  3.36379591e+01  3.36379591e+01  3.36379591e+01
  1.12503924e+02  1.29214436e+02  1.29214436e+02  1.29214436e+02
  4.83516616e+02  4.83516616e+02  4.83516616e+02  5.99137448e+02
  1.33527362e+03  1.33527362e+03  1.33527362e+03  2.66865191e+03
  3.02940961e+03  3.02940961e+03  3.02940961e+03  6.64976941e+03
  6.64976941e+03  6.64976941e+03  9.07335503e+03  2.54282244e+04
  7.61697017e+04]
E1 = -728.2986002235527  E_coul = 201.56004227059495
cycle= 6 E= -526.738557952958  delta_E= -5.45e-11  |g|= 1.73e-06  |ddm|= 1.8e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2986002235527  E_coul = 201.56004227059495
  HOMO = -0.582756819379392  LUMO = 1.02022504308381
  mo_energy =
[-1.18578225e+02 -1.23092699e+01 -9.56119880e+00 -9.56119880e+00
 -9.56119880e+00 -1.26989620e+00 -5.82756819e-01 -5.82756819e-01
 -5.82756819e-01  1.02022504e+00  1.02022504e+00  1.02022504e+00
  1.02031306e+00  7.36566014e+00  7.36566014e+00  7.36566014e+00
  1.37849156e+01  3.36379592e+01  3.36379592e+01  3.36379592e+01
  1.12503924e+02  1.29214436e+02  1.29214436e+02  1.29214436e+02
  4.83516616e+02  4.83516616e+02  4.83516616e+02  5.99137448e+02
  1.33527362e+03  1.33527362e+03  1.33527362e+03  2.66865191e+03
  3.02940961e+03  3.02940961e+03  3.02940961e+03  6.64976941e+03
  6.64976941e+03  6.64976941e+03  9.07335503e+03  2.54282244e+04
  7.61697017e+04]
E1 = -728.2985992470171  E_coul = 201.56004129405764
Extra cycle  E= -526.738557952959  delta_E= -1.71e-12  |g|= 3.55e-07  |ddm|= 3.02e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826584e+04 7.61751656e+03 3.61735354e+03 1.59771561e+03
 3.82741541e+02 1.10100441e+02 3.62962659e+01 8.85164054e+00
 3.37434935e+00 6.66726907e-01 2.47062783e-01 1.36278405e+03
 6.64737382e+02 3.00922843e+02 3.14008521e+02 6.16549011e+01
 7.38285561e+00 2.02095024e+01 7.78709970e-01 2.84435105e+00
 2.23509443e-01]
E = -526.7385579529595
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6583574        1
[INPUT] 0    0    [1    /1   ]  7617.51655564        1
[INPUT] 0    0    [1    /1   ]  3617.35354337        1
[INPUT] 0    0    [1    /1   ]  1597.7156104         1
[INPUT] 0    0    [1    /1   ]  382.741540846        1
[INPUT] 0    0    [1    /1   ]  110.100440906        1
[INPUT] 0    0    [1    /1   ]  36.2962658641        1
[INPUT] 0    0    [1    /1   ]  8.85164053677        1
[INPUT] 0    0    [1    /1   ]  3.37434934711        1
[INPUT] 0    0    [1    /1   ]  0.66672690741        1
[INPUT] 0    0    [1    /1   ]  0.247062783264       1
[INPUT] 1    0    [1    /1   ]  1362.784045          1
[INPUT] 1    0    [1    /1   ]  664.737382385        1
[INPUT] 1    0    [1    /1   ]  300.922842701        1
[INPUT] 1    0    [1    /1   ]  314.008520631        1
[INPUT] 1    0    [1    /1   ]  61.6549010502        1
[INPUT] 1    0    [1    /1   ]  7.38285560735        1
[INPUT] 1    0    [1    /1   ]  20.2095024206        1
[INPUT] 1    0    [1    /1   ]  0.778709969812       1
[INPUT] 1    0    [1    /1   ]  2.84435104595        1
[INPUT] 1    0    [1    /1   ]  0.223509442742       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.65835737289, 1.0]], [0, [7617.516555636733, 1.0]], [0, [3617.3535433739085, 1.0]], [0, [1597.715610404361, 1.0]], [0, [382.74154084615935, 1.0]], [0, [110.1004409061347, 1.0]], [0, [36.29626586407289, 1.0]], [0, [8.85164053677281, 1.0]], [0, [3.3743493471095856, 1.0]], [0, [0.6667269074102282, 1.0]], [0, [0.24706278326397355, 1.0]], [1, [1362.7840450011174, 1.0]], [1, [664.737382385179, 1.0]], [1, [300.9228427010569, 1.0]], [1, [314.00852063088104, 1.0]], [1, [61.6549010501822, 1.0]], [1, [7.382855607345319, 1.0]], [1, [20.209502420589214, 1.0]], [1, [0.7787099698124542, 1.0]], [1, [2.844351045946893, 1.0]], [1, [0.22350944274160575, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65835737]
bas 1, expnt(s) = [7617.51655564]
bas 2, expnt(s) = [3617.35354337]
bas 3, expnt(s) = [1597.7156104]
bas 4, expnt(s) = [382.74154085]
bas 5, expnt(s) = [110.10044091]
bas 6, expnt(s) = [36.29626586]
bas 7, expnt(s) = [8.85164054]
bas 8, expnt(s) = [3.37434935]
bas 9, expnt(s) = [0.66672691]
bas 10, expnt(s) = [0.24706278]
bas 11, expnt(s) = [1362.784045]
bas 12, expnt(s) = [664.73738239]
bas 13, expnt(s) = [300.9228427]
bas 14, expnt(s) = [314.00852063]
bas 15, expnt(s) = [61.65490105]
bas 16, expnt(s) = [7.38285561]
bas 17, expnt(s) = [20.20950242]
bas 18, expnt(s) = [0.77870997]
bas 19, expnt(s) = [2.84435105]
bas 20, expnt(s) = [0.22350944]
CPU time:       262.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826584e+04 5.20026324e+03 7.61751656e+03 2.06003728e+03
 3.61735354e+03 1.17844208e+03 1.59771561e+03 6.38468732e+02
 3.82741541e+02 2.18622182e+02 1.10100441e+02 8.58730361e+01
 3.62962659e+01 3.73603972e+01 8.85164054e+00 1.29653084e+01
 3.37434935e+00 6.29010010e+00 6.66726907e-01 1.86412921e+00
 2.47062783e-01 8.85361273e-01 1.36278405e+03 2.41556202e+04
 6.64737382e+02 9.84684316e+03 3.00922843e+02 3.65639694e+03
 3.14008521e+02 3.85621450e+03 6.16549011e+01 5.04015507e+02
 7.38285561e+00 3.55029843e+01 2.02095024e+01 1.25005442e+02
 7.78709970e-01 2.13404740e+00 2.84435105e+00 1.07761440e+01
 2.23509443e-01 4.48336645e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99339704428695
cond(S) = 103940.04991984017
E1 = -729.5317545501437  E_coul = 203.1802200685062
init E= -526.351534481637
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555725128013128  LUMO = 1.03882332643598
  mo_energy =
[-1.18328716e+02 -1.22042130e+01 -9.44670780e+00 -9.44670780e+00
 -9.44670780e+00 -1.23992535e+00 -5.55725128e-01 -5.55725128e-01
 -5.55725128e-01  1.03882333e+00  1.03882333e+00  1.03882333e+00
  1.04217137e+00  7.43658465e+00  7.43658465e+00  7.43658465e+00
  1.38725865e+01  3.37577898e+01  3.37577898e+01  3.37577898e+01
  1.12677695e+02  1.29394661e+02  1.29394661e+02  1.29394661e+02
  4.83765677e+02  4.83765677e+02  4.83765677e+02  5.99422657e+02
  1.33557568e+03  1.33557568e+03  1.33557568e+03  2.66908524e+03
  3.02977580e+03  3.02977580e+03  3.02977580e+03  6.65024739e+03
  6.65024739e+03  6.65024739e+03  9.07390752e+03  2.54288706e+04
  7.61704378e+04]
E1 = -727.8549181873116  E_coul = 201.117132690692
cycle= 1 E= -526.73778549662  delta_E= -0.386  |g|= 0.185  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.5417
diis-c [-0.29343858  1.        ]
  HOMO = -0.590336953920917  LUMO = 1.01323761863578
  mo_energy =
[-1.18635663e+02 -1.23413570e+01 -9.59456459e+00 -9.59456459e+00
 -9.59456459e+00 -1.27909332e+00 -5.90336954e-01 -5.90336954e-01
 -5.90336954e-01  1.01323762e+00  1.01457132e+00  1.01457132e+00
  1.01457132e+00  7.34567562e+00  7.34567562e+00  7.34567562e+00
  1.37584507e+01  3.36042221e+01  3.36042221e+01  3.36042221e+01
  1.12456494e+02  1.29167158e+02  1.29167158e+02  1.29167158e+02
  4.83459878e+02  4.83459878e+02  4.83459878e+02  5.99078720e+02
  1.33521345e+03  1.33521345e+03  1.33521345e+03  2.66858909e+03
  3.02934760e+03  3.02934760e+03  3.02934760e+03  6.64970606e+03
  6.64970606e+03  6.64970606e+03  9.07329109e+03  2.54281601e+04
  7.61696372e+04]
E1 = -728.4253062925104  E_coul = 201.68680836174423
cycle= 2 E= -526.738497930766  delta_E= -0.000712  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748485
diis-c [-0.00329178  0.08192627  0.91807373]
  HOMO = -0.58127719931046  LUMO = 1.02129656945088
  mo_energy =
[-1.18568314e+02 -1.23035311e+01 -9.55509972e+00 -9.55509972e+00
 -9.55509972e+00 -1.26824779e+00 -5.81277199e-01 -5.81277199e-01
 -5.81277199e-01  1.02129657e+00  1.02129657e+00  1.02129657e+00
  1.02155398e+00  7.36941436e+00  7.36941436e+00  7.36941436e+00
  1.37896671e+01  3.36440811e+01  3.36440811e+01  3.36440811e+01
  1.12512180e+02  1.29222728e+02  1.29222728e+02  1.29222728e+02
  4.83526411e+02  4.83526411e+02  4.83526411e+02  5.99147605e+02
  1.33528401e+03  1.33528401e+03  1.33528401e+03  2.66866296e+03
  3.02942040e+03  3.02942040e+03  3.02942040e+03  6.64978060e+03
  6.64978060e+03  6.64978060e+03  9.07336644e+03  2.54282360e+04
  7.61697134e+04]
E1 = -728.2760718461775  E_coul = 201.53751579557002
cycle= 3 E= -526.738556050607  delta_E= -5.81e-05  |g|= 0.00626  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131317
diis-c [-5.76097336e-07 -1.24787625e-03  1.44794076e-01  8.56453801e-01]
  HOMO = -0.582767520272119  LUMO = 1.0202142889028
  mo_energy =
[-1.18578233e+02 -1.23093110e+01 -9.56122457e+00 -9.56122457e+00
 -9.56122457e+00 -1.26993094e+00 -5.82767520e-01 -5.82767520e-01
 -5.82767520e-01  1.02021429e+00  1.02021429e+00  1.02021429e+00
  1.02028281e+00  7.36563561e+00  7.36563561e+00  7.36563561e+00
  1.37848751e+01  3.36379347e+01  3.36379347e+01  3.36379347e+01
  1.12503901e+02  1.29214417e+02  1.29214417e+02  1.29214417e+02
  4.83516607e+02  4.83516607e+02  4.83516607e+02  5.99137448e+02
  1.33527362e+03  1.33527362e+03  1.33527362e+03  2.66865194e+03
  3.02940962e+03  3.02940962e+03  3.02940962e+03  6.64976944e+03
  6.64976944e+03  6.64976944e+03  9.07335506e+03  2.54282245e+04
  7.61697017e+04]
E1 = -728.2987264318749  E_coul = 201.5601684805932
cycle= 4 E= -526.738557951282  delta_E= -1.9e-06  |g|= 9.65e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113307
diis-c [-4.02900807e-09  7.12746147e-05 -1.02074448e-02 -6.62614015e-02
  1.07639757e+00]
  HOMO = -0.582749492769466  LUMO = 1.02022987878998
  mo_energy =
[-1.18578195e+02 -1.23092479e+01 -9.56117479e+00 -9.56117479e+00
 -9.56117479e+00 -1.26989073e+00 -5.82749493e-01 -5.82749493e-01
 -5.82749493e-01  1.02022988e+00  1.02022988e+00  1.02022988e+00
  1.02031671e+00  7.36567648e+00  7.36567648e+00  7.36567648e+00
  1.37849339e+01  3.36379825e+01  3.36379825e+01  3.36379825e+01
  1.12503951e+02  1.29214463e+02  1.29214463e+02  1.29214463e+02
  4.83516646e+02  4.83516646e+02  4.83516646e+02  5.99137479e+02
  1.33527365e+03  1.33527365e+03  1.33527365e+03  2.66865195e+03
  3.02940964e+03  3.02940964e+03  3.02940964e+03  6.64976944e+03
  6.64976944e+03  6.64976944e+03  9.07335506e+03  2.54282244e+04
  7.61697017e+04]
E1 = -728.2985200911908  E_coul = 201.55996213828743
cycle= 5 E= -526.738557952903  delta_E= -1.62e-09  |g|= 2.03e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83834e-05
diis-c [-7.22979187e-11  1.41746500e-05 -1.83747950e-03 -1.37588349e-02
  4.35447028e-02  9.72037437e-01]
  HOMO = -0.582756800366351  LUMO = 1.02022500072349
  mo_energy =
[-1.18578225e+02 -1.23092701e+01 -9.56119886e+00 -9.56119886e+00
 -9.56119886e+00 -1.26989657e+00 -5.82756800e-01 -5.82756800e-01
 -5.82756800e-01  1.02022500e+00  1.02022500e+00  1.02022500e+00
  1.02031272e+00  7.36566009e+00  7.36566009e+00  7.36566009e+00
  1.37849154e+01  3.36379591e+01  3.36379591e+01  3.36379591e+01
  1.12503924e+02  1.29214436e+02  1.29214436e+02  1.29214436e+02
  4.83516616e+02  4.83516616e+02  4.83516616e+02  5.99137448e+02
  1.33527362e+03  1.33527362e+03  1.33527362e+03  2.66865191e+03
  3.02940961e+03  3.02940961e+03  3.02940961e+03  6.64976941e+03
  6.64976941e+03  6.64976941e+03  9.07335503e+03  2.54282244e+04
  7.61697017e+04]
E1 = -728.2986002235527  E_coul = 201.56004227059495
cycle= 6 E= -526.738557952958  delta_E= -5.45e-11  |g|= 1.73e-06  |ddm|= 1.8e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2986002235527  E_coul = 201.56004227059495
  HOMO = -0.582756819379392  LUMO = 1.02022504308381
  mo_energy =
[-1.18578225e+02 -1.23092699e+01 -9.56119880e+00 -9.56119880e+00
 -9.56119880e+00 -1.26989620e+00 -5.82756819e-01 -5.82756819e-01
 -5.82756819e-01  1.02022504e+00  1.02022504e+00  1.02022504e+00
  1.02031306e+00  7.36566014e+00  7.36566014e+00  7.36566014e+00
  1.37849156e+01  3.36379592e+01  3.36379592e+01  3.36379592e+01
  1.12503924e+02  1.29214436e+02  1.29214436e+02  1.29214436e+02
  4.83516616e+02  4.83516616e+02  4.83516616e+02  5.99137448e+02
  1.33527362e+03  1.33527362e+03  1.33527362e+03  2.66865191e+03
  3.02940961e+03  3.02940961e+03  3.02940961e+03  6.64976941e+03
  6.64976941e+03  6.64976941e+03  9.07335503e+03  2.54282244e+04
  7.61697017e+04]
E1 = -728.2985992470171  E_coul = 201.56004129405764
Extra cycle  E= -526.738557952959  delta_E= -1.71e-12  |g|= 3.55e-07  |ddm|= 3.02e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103940.04991984017
E1 = -728.2985992470171  E_coul = 201.56004129405764
init E= -526.738557952959
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.582756849721094  LUMO = 1.02022503297199
  mo_energy =
[-1.18578225e+02 -1.23092700e+01 -9.56119889e+00 -9.56119889e+00
 -9.56119889e+00 -1.26989616e+00 -5.82756850e-01 -5.82756850e-01
 -5.82756850e-01  1.02022503e+00  1.02022503e+00  1.02022503e+00
  1.02031311e+00  7.36566008e+00  7.36566008e+00  7.36566008e+00
  1.37849156e+01  3.36379591e+01  3.36379591e+01  3.36379591e+01
  1.12503924e+02  1.29214436e+02  1.29214436e+02  1.29214436e+02
  4.83516616e+02  4.83516616e+02  4.83516616e+02  5.99137448e+02
  1.33527362e+03  1.33527362e+03  1.33527362e+03  2.66865191e+03
  3.02940961e+03  3.02940961e+03  3.02940961e+03  6.64976941e+03
  6.64976941e+03  6.64976941e+03  9.07335503e+03  2.54282244e+04
  7.61697017e+04]
E1 = -728.2985994121998  E_coul = 201.56004145923896
cycle= 1 E= -526.738557952961  delta_E= -1.36e-12  |g|= 7.44e-08  |ddm|= 5.9e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2985994121998  E_coul = 201.56004145923896
  HOMO = -0.582756849048623  LUMO = 1.02022503589255
  mo_energy =
[-1.18578225e+02 -1.23092700e+01 -9.56119888e+00 -9.56119888e+00
 -9.56119888e+00 -1.26989614e+00 -5.82756849e-01 -5.82756849e-01
 -5.82756849e-01  1.02022504e+00  1.02022504e+00  1.02022504e+00
  1.02031312e+00  7.36566009e+00  7.36566009e+00  7.36566009e+00
  1.37849156e+01  3.36379592e+01  3.36379592e+01  3.36379592e+01
  1.12503924e+02  1.29214436e+02  1.29214436e+02  1.29214436e+02
  4.83516616e+02  4.83516616e+02  4.83516616e+02  5.99137448e+02
  1.33527362e+03  1.33527362e+03  1.33527362e+03  2.66865191e+03
  3.02940961e+03  3.02940961e+03  3.02940961e+03  6.64976941e+03
  6.64976941e+03  6.64976941e+03  9.07335503e+03  2.54282244e+04
  7.61697017e+04]
E1 = -728.2985993433848  E_coul = 201.56004139042477
Extra cycle  E= -526.73855795296  delta_E= 7.96e-13  |g|= 1.5e-08  |ddm|= 1.24e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61826584e+04 7.61751656e+03 3.61735354e+03 1.59771561e+03
 3.82741541e+02 1.10100441e+02 3.62962659e+01 8.85164054e+00
 3.37434935e+00 6.66726907e-01 2.47062783e-01 1.36278405e+03
 6.64737382e+02 3.00922843e+02 3.14008521e+02 6.16549011e+01
 7.38285561e+00 2.02095024e+01 7.78709970e-01 2.84435105e+00
 2.23509443e-01]
grad_E = [-1.53042735e-06  3.44873932e-06 -1.50273829e-06  7.44385439e-05
 -1.31396457e-04 -5.80514599e-04 -6.72784404e-04  2.04574965e-03
 -1.03375467e-03  6.46740485e-04  2.71953845e-04 -5.25934124e-07
  4.74094897e-06  2.20157148e-05  1.89852243e-05  1.56319717e-04
  2.58750336e-03 -1.25003662e-03 -1.35830507e-03 -9.99153941e-04
  4.23792686e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6586503        1
[INPUT] 0    0    [1    /1   ]  7617.51591986        1
[INPUT] 0    0    [1    /1   ]  3617.35385012        1
[INPUT] 0    0    [1    /1   ]  1597.70237509        1
[INPUT] 0    0    [1    /1   ]  382.738639538        1
[INPUT] 0    0    [1    /1   ]  110.297449558        1
[INPUT] 0    0    [1    /1   ]  36.4739794564        1
[INPUT] 0    0    [1    /1   ]  8.87189171089        1
[INPUT] 0    0    [1    /1   ]  3.38014747935        1
[INPUT] 0    0    [1    /1   ]  0.672359636543       1
[INPUT] 0    0    [1    /1   ]  0.248984256378       1
[INPUT] 1    0    [1    /1   ]  1362.78414312        1
[INPUT] 1    0    [1    /1   ]  664.73641771         1
[INPUT] 1    0    [1    /1   ]  300.918296016        1
[INPUT] 1    0    [1    /1   ]  314.004600592        1
[INPUT] 1    0    [1    /1   ]  61.65671356          1
[INPUT] 1    0    [1    /1   ]  7.37658319814        1
[INPUT] 1    0    [1    /1   ]  20.2177366164        1
[INPUT] 1    0    [1    /1   ]  0.777457523579       1
[INPUT] 1    0    [1    /1   ]  2.83021813371        1
[INPUT] 1    0    [1    /1   ]  0.223334293163       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.658650272067, 1.0]], [0, [7617.515919858239, 1.0]], [0, [3617.353850116168, 1.0]], [0, [1597.7023750851035, 1.0]], [0, [382.7386395377864, 1.0]], [0, [110.29744955784028, 1.0]], [0, [36.47397945637293, 1.0]], [0, [8.871891710889502, 1.0]], [0, [3.3801474793457493, 1.0]], [0, [0.672359636542562, 1.0]], [0, [0.24898425637796853, 1.0]], [1, [1362.7841431155794, 1.0]], [1, [664.7364177099313, 1.0]], [1, [300.9182960155018, 1.0]], [1, [314.0046005918101, 1.0]], [1, [61.656713559969404, 1.0]], [1, [7.376583198140507, 1.0]], [1, [20.217736616398316, 1.0]], [1, [0.7774575235786904, 1.0]], [1, [2.8302181337080645, 1.0]], [1, [0.22333429316321407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65865027]
bas 1, expnt(s) = [7617.51591986]
bas 2, expnt(s) = [3617.35385012]
bas 3, expnt(s) = [1597.70237509]
bas 4, expnt(s) = [382.73863954]
bas 5, expnt(s) = [110.29744956]
bas 6, expnt(s) = [36.47397946]
bas 7, expnt(s) = [8.87189171]
bas 8, expnt(s) = [3.38014748]
bas 9, expnt(s) = [0.67235964]
bas 10, expnt(s) = [0.24898426]
bas 11, expnt(s) = [1362.78414312]
bas 12, expnt(s) = [664.73641771]
bas 13, expnt(s) = [300.91829602]
bas 14, expnt(s) = [314.00460059]
bas 15, expnt(s) = [61.65671356]
bas 16, expnt(s) = [7.3765832]
bas 17, expnt(s) = [20.21773662]
bas 18, expnt(s) = [0.77745752]
bas 19, expnt(s) = [2.83021813]
bas 20, expnt(s) = [0.22333429]
CPU time:       268.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826587e+04 5.20026328e+03 7.61751592e+03 2.06003715e+03
 3.61735385e+03 1.17844215e+03 1.59770238e+03 6.38464765e+02
 3.82738640e+02 2.18620939e+02 1.10297450e+02 8.59882533e+01
 3.64739795e+01 3.74975062e+01 8.87189171e+00 1.29875490e+01
 3.38014748e+00 6.29820455e+00 6.72359637e-01 1.87592836e+00
 2.48984256e-01 8.90520537e-01 1.36278414e+03 2.41556224e+04
 6.64736418e+02 9.84682530e+03 3.00918296e+02 3.65632789e+03
 3.14004601e+02 3.85615433e+03 6.16567136e+01 5.04034029e+02
 7.37658320e+00 3.54652846e+01 2.02177366e+01 1.25069110e+02
 7.77457524e-01 2.12975787e+00 2.83021813e+00 1.07092555e+01
 2.23334293e-01 4.47897523e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993411026691554
cond(S) = 103960.1210200431
E1 = -729.5321684135755  E_coul = 203.1805836345676
init E= -526.351584779008
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555724862491842  LUMO = 1.03695104673346
  mo_energy =
[-1.18328787e+02 -1.22041989e+01 -9.44666694e+00 -9.44666694e+00
 -9.44666694e+00 -1.23989154e+00 -5.55724862e-01 -5.55724862e-01
 -5.55724862e-01  1.03695105e+00  1.03695105e+00  1.03695105e+00
  1.05650524e+00  7.40527096e+00  7.40527096e+00  7.40527096e+00
  1.39570358e+01  3.36932252e+01  3.36932252e+01  3.36932252e+01
  1.13237531e+02  1.29345679e+02  1.29345679e+02  1.29345679e+02
  4.83735901e+02  4.83735901e+02  4.83735901e+02  6.00695830e+02
  1.33554361e+03  1.33554361e+03  1.33554361e+03  2.67053897e+03
  3.02973435e+03  3.02973435e+03  3.02973435e+03  6.65020003e+03
  6.65020003e+03  6.65020003e+03  9.07528873e+03  2.54301765e+04
  7.61716516e+04]
E1 = -727.8557727360527  E_coul = 201.11782301626926
cycle= 1 E= -526.737949719784  delta_E= -0.386  |g|= 0.185  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541403
diis-c [-0.29311728  1.        ]
  HOMO = -0.590287493788612  LUMO = 1.01279387867692
  mo_energy =
[-1.18635630e+02 -1.23413746e+01 -9.59455445e+00 -9.59455445e+00
 -9.59455445e+00 -1.27902427e+00 -5.90287494e-01 -5.90287494e-01
 -5.90287494e-01  1.01279388e+00  1.01279388e+00  1.01279388e+00
  1.02728478e+00  7.31456653e+00  7.31456653e+00  7.31456653e+00
  1.38426332e+01  3.35396692e+01  3.35396692e+01  3.35396692e+01
  1.13016053e+02  1.29118185e+02  1.29118185e+02  1.29118185e+02
  4.83430206e+02  4.83430206e+02  4.83430206e+02  6.00352043e+02
  1.33518162e+03  1.33518162e+03  1.33518162e+03  2.67004315e+03
  3.02930643e+03  3.02930643e+03  3.02930643e+03  6.64965904e+03
  6.64965904e+03  6.64965904e+03  9.07467266e+03  2.54294664e+04
  7.61708515e+04]
E1 = -728.4261884668513  E_coul = 201.68752670026268
cycle= 2 E= -526.738661766589  delta_E= -0.000712  |g|= 0.0374  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748076
diis-c [-0.003295    0.08181608  0.91818392]
  HOMO = -0.581225112311278  LUMO = 1.01950451015254
  mo_energy =
[-1.18568277e+02 -1.23035420e+01 -9.55508212e+00 -9.55508212e+00
 -9.55508212e+00 -1.26817563e+00 -5.81225112e-01 -5.81225112e-01
 -5.81225112e-01  1.01950451e+00  1.01950451e+00  1.01950451e+00
  1.03568701e+00  7.33826178e+00  7.33826178e+00  7.33826178e+00
  1.38739079e+01  3.35795341e+01  3.35795341e+01  3.35795341e+01
  1.13071793e+02  1.29173766e+02  1.29173766e+02  1.29173766e+02
  4.83496744e+02  4.83496744e+02  4.83496744e+02  6.00420938e+02
  1.33525220e+03  1.33525220e+03  1.33525220e+03  2.67011702e+03
  3.02937924e+03  3.02937924e+03  3.02937924e+03  6.64973358e+03
  6.64973358e+03  6.64973358e+03  9.07474802e+03  2.54295424e+04
  7.61709277e+04]
E1 = -728.2768757285734  E_coul = 201.5381558179987
cycle= 3 E= -526.738719910575  delta_E= -5.81e-05  |g|= 0.00627  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131428
diis-c [-5.71946914e-07 -1.24681802e-03  1.44985616e-01  8.56261202e-01]
  HOMO = -0.582716520206241  LUMO = 1.01842396805217
  mo_energy =
[-1.18578210e+02 -1.23093294e+01 -9.56121478e+00 -9.56121478e+00
 -9.56121478e+00 -1.26986085e+00 -5.82716520e-01 -5.82716520e-01
 -5.82716520e-01  1.01842397e+00  1.01842397e+00  1.01842397e+00
  1.03440123e+00  7.33448637e+00  7.33448637e+00  7.33448637e+00
  1.38691015e+01  3.35733799e+01  3.35733799e+01  3.35733799e+01
  1.13063496e+02  1.29165443e+02  1.29165443e+02  1.29165443e+02
  4.83486927e+02  4.83486927e+02  4.83486927e+02  6.00410767e+02
  1.33524179e+03  1.33524179e+03  1.33524179e+03  2.67010599e+03
  3.02936845e+03  3.02936845e+03  3.02936845e+03  6.64972240e+03
  6.64972240e+03  6.64972240e+03  9.07473663e+03  2.54295308e+04
  7.61709160e+04]
E1 = -728.2995704734333  E_coul = 201.56084865615995
cycle= 4 E= -526.738721817273  delta_E= -1.91e-06  |g|= 9.6e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112705
diis-c [-4.00107343e-09  7.07902812e-05 -1.01461386e-02 -6.57785154e-02
  1.07585386e+00]
  HOMO = -0.582698430810587  LUMO = 1.01843955199816
  mo_energy =
[-1.18578171e+02 -1.23092662e+01 -9.56116501e+00 -9.56116501e+00
 -9.56116501e+00 -1.26982075e+00 -5.82698431e-01 -5.82698431e-01
 -5.82698431e-01  1.01843955e+00  1.01843955e+00  1.01843955e+00
  1.03443530e+00  7.33452720e+00  7.33452720e+00  7.33452720e+00
  1.38691603e+01  3.35734277e+01  3.35734277e+01  3.35734277e+01
  1.13063545e+02  1.29165489e+02  1.29165489e+02  1.29165489e+02
  4.83486966e+02  4.83486966e+02  4.83486966e+02  6.00410798e+02
  1.33524182e+03  1.33524182e+03  1.33524182e+03  2.67010600e+03
  3.02936847e+03  3.02936847e+03  3.02936847e+03  6.64972241e+03
  6.64972241e+03  6.64972241e+03  9.07473662e+03  2.54295308e+04
  7.61709160e+04]
E1 = -728.2993652174059  E_coul = 201.56064339853893
cycle= 5 E= -526.738721818867  delta_E= -1.59e-09  |g|= 2.02e-05  |ddm|= 0.000154
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.827e-05
diis-c [-7.09730082e-11  1.41326202e-05 -1.83596427e-03 -1.37227967e-02
  4.34680529e-02  9.72076575e-01]
  HOMO = -0.582705685252837  LUMO = 1.01843472155449
  mo_energy =
[-1.18578201e+02 -1.23092883e+01 -9.56118896e+00 -9.56118896e+00
 -9.56118896e+00 -1.26982655e+00 -5.82705685e-01 -5.82705685e-01
 -5.82705685e-01  1.01843472e+00  1.01843472e+00  1.01843472e+00
  1.03443129e+00  7.33451093e+00  7.33451093e+00  7.33451093e+00
  1.38691418e+01  3.35734044e+01  3.35734044e+01  3.35734044e+01
  1.13063518e+02  1.29165462e+02  1.29165462e+02  1.29165462e+02
  4.83486936e+02  4.83486936e+02  4.83486936e+02  6.00410767e+02
  1.33524179e+03  1.33524179e+03  1.33524179e+03  2.67010596e+03
  3.02936844e+03  3.02936844e+03  3.02936844e+03  6.64972238e+03
  6.64972238e+03  6.64972238e+03  9.07473659e+03  2.54295307e+04
  7.61709159e+04]
E1 = -728.2994451339321  E_coul = 201.56072331501014
cycle= 6 E= -526.738721818922  delta_E= -5.49e-11  |g|= 1.72e-06  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.04 sec
E1 = -728.2994451339321  E_coul = 201.56072331501014
  HOMO = -0.582705702987612  LUMO = 1.01843476438151
  mo_energy =
[-1.18578201e+02 -1.23092882e+01 -9.56118890e+00 -9.56118890e+00
 -9.56118890e+00 -1.26982619e+00 -5.82705703e-01 -5.82705703e-01
 -5.82705703e-01  1.01843476e+00  1.01843476e+00  1.01843476e+00
  1.03443163e+00  7.33451098e+00  7.33451098e+00  7.33451098e+00
  1.38691420e+01  3.35734045e+01  3.35734045e+01  3.35734045e+01
  1.13063519e+02  1.29165462e+02  1.29165462e+02  1.29165462e+02
  4.83486936e+02  4.83486936e+02  4.83486936e+02  6.00410768e+02
  1.33524179e+03  1.33524179e+03  1.33524179e+03  2.67010596e+03
  3.02936844e+03  3.02936844e+03  3.02936844e+03  6.64972238e+03
  6.64972238e+03  6.64972238e+03  9.07473659e+03  2.54295307e+04
  7.61709159e+04]
E1 = -728.2994442041601  E_coul = 201.5607223852379
Extra cycle  E= -526.738721818922  delta_E= -2.27e-13  |g|= 3.52e-07  |ddm|= 2.99e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826587e+04 7.61751592e+03 3.61735385e+03 1.59770238e+03
 3.82738640e+02 1.10297450e+02 3.64739795e+01 8.87189171e+00
 3.38014748e+00 6.72359637e-01 2.48984256e-01 1.36278414e+03
 6.64736418e+02 3.00918296e+02 3.14004601e+02 6.16567136e+01
 7.37658320e+00 2.02177366e+01 7.77457524e-01 2.83021813e+00
 2.23334293e-01]
E = -526.7387218189222
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6586503        1
[INPUT] 0    0    [1    /1   ]  7617.51591986        1
[INPUT] 0    0    [1    /1   ]  3617.35385012        1
[INPUT] 0    0    [1    /1   ]  1597.70237509        1
[INPUT] 0    0    [1    /1   ]  382.738639538        1
[INPUT] 0    0    [1    /1   ]  110.297449558        1
[INPUT] 0    0    [1    /1   ]  36.4739794564        1
[INPUT] 0    0    [1    /1   ]  8.87189171089        1
[INPUT] 0    0    [1    /1   ]  3.38014747935        1
[INPUT] 0    0    [1    /1   ]  0.672359636543       1
[INPUT] 0    0    [1    /1   ]  0.248984256378       1
[INPUT] 1    0    [1    /1   ]  1362.78414312        1
[INPUT] 1    0    [1    /1   ]  664.73641771         1
[INPUT] 1    0    [1    /1   ]  300.918296016        1
[INPUT] 1    0    [1    /1   ]  314.004600592        1
[INPUT] 1    0    [1    /1   ]  61.65671356          1
[INPUT] 1    0    [1    /1   ]  7.37658319814        1
[INPUT] 1    0    [1    /1   ]  20.2177366164        1
[INPUT] 1    0    [1    /1   ]  0.777457523579       1
[INPUT] 1    0    [1    /1   ]  2.83021813371        1
[INPUT] 1    0    [1    /1   ]  0.223334293163       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.658650272067, 1.0]], [0, [7617.515919858239, 1.0]], [0, [3617.353850116168, 1.0]], [0, [1597.7023750851035, 1.0]], [0, [382.7386395377864, 1.0]], [0, [110.29744955784028, 1.0]], [0, [36.47397945637293, 1.0]], [0, [8.871891710889502, 1.0]], [0, [3.3801474793457493, 1.0]], [0, [0.672359636542562, 1.0]], [0, [0.24898425637796853, 1.0]], [1, [1362.7841431155794, 1.0]], [1, [664.7364177099313, 1.0]], [1, [300.9182960155018, 1.0]], [1, [314.0046005918101, 1.0]], [1, [61.656713559969404, 1.0]], [1, [7.376583198140507, 1.0]], [1, [20.217736616398316, 1.0]], [1, [0.7774575235786904, 1.0]], [1, [2.8302181337080645, 1.0]], [1, [0.22333429316321407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65865027]
bas 1, expnt(s) = [7617.51591986]
bas 2, expnt(s) = [3617.35385012]
bas 3, expnt(s) = [1597.70237509]
bas 4, expnt(s) = [382.73863954]
bas 5, expnt(s) = [110.29744956]
bas 6, expnt(s) = [36.47397946]
bas 7, expnt(s) = [8.87189171]
bas 8, expnt(s) = [3.38014748]
bas 9, expnt(s) = [0.67235964]
bas 10, expnt(s) = [0.24898426]
bas 11, expnt(s) = [1362.78414312]
bas 12, expnt(s) = [664.73641771]
bas 13, expnt(s) = [300.91829602]
bas 14, expnt(s) = [314.00460059]
bas 15, expnt(s) = [61.65671356]
bas 16, expnt(s) = [7.3765832]
bas 17, expnt(s) = [20.21773662]
bas 18, expnt(s) = [0.77745752]
bas 19, expnt(s) = [2.83021813]
bas 20, expnt(s) = [0.22333429]
CPU time:       269.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826587e+04 5.20026328e+03 7.61751592e+03 2.06003715e+03
 3.61735385e+03 1.17844215e+03 1.59770238e+03 6.38464765e+02
 3.82738640e+02 2.18620939e+02 1.10297450e+02 8.59882533e+01
 3.64739795e+01 3.74975062e+01 8.87189171e+00 1.29875490e+01
 3.38014748e+00 6.29820455e+00 6.72359637e-01 1.87592836e+00
 2.48984256e-01 8.90520537e-01 1.36278414e+03 2.41556224e+04
 6.64736418e+02 9.84682530e+03 3.00918296e+02 3.65632789e+03
 3.14004601e+02 3.85615433e+03 6.16567136e+01 5.04034029e+02
 7.37658320e+00 3.54652846e+01 2.02177366e+01 1.25069110e+02
 7.77457524e-01 2.12975787e+00 2.83021813e+00 1.07092555e+01
 2.23334293e-01 4.47897523e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993411026691554
cond(S) = 103960.1210200431
E1 = -729.5321684135755  E_coul = 203.1805836345676
init E= -526.351584779008
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555724862491842  LUMO = 1.03695104673346
  mo_energy =
[-1.18328787e+02 -1.22041989e+01 -9.44666694e+00 -9.44666694e+00
 -9.44666694e+00 -1.23989154e+00 -5.55724862e-01 -5.55724862e-01
 -5.55724862e-01  1.03695105e+00  1.03695105e+00  1.03695105e+00
  1.05650524e+00  7.40527096e+00  7.40527096e+00  7.40527096e+00
  1.39570358e+01  3.36932252e+01  3.36932252e+01  3.36932252e+01
  1.13237531e+02  1.29345679e+02  1.29345679e+02  1.29345679e+02
  4.83735901e+02  4.83735901e+02  4.83735901e+02  6.00695830e+02
  1.33554361e+03  1.33554361e+03  1.33554361e+03  2.67053897e+03
  3.02973435e+03  3.02973435e+03  3.02973435e+03  6.65020003e+03
  6.65020003e+03  6.65020003e+03  9.07528873e+03  2.54301765e+04
  7.61716516e+04]
E1 = -727.8557727360527  E_coul = 201.11782301626926
cycle= 1 E= -526.737949719784  delta_E= -0.386  |g|= 0.185  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541403
diis-c [-0.29311728  1.        ]
  HOMO = -0.590287493788612  LUMO = 1.01279387867692
  mo_energy =
[-1.18635630e+02 -1.23413746e+01 -9.59455445e+00 -9.59455445e+00
 -9.59455445e+00 -1.27902427e+00 -5.90287494e-01 -5.90287494e-01
 -5.90287494e-01  1.01279388e+00  1.01279388e+00  1.01279388e+00
  1.02728478e+00  7.31456653e+00  7.31456653e+00  7.31456653e+00
  1.38426332e+01  3.35396692e+01  3.35396692e+01  3.35396692e+01
  1.13016053e+02  1.29118185e+02  1.29118185e+02  1.29118185e+02
  4.83430206e+02  4.83430206e+02  4.83430206e+02  6.00352043e+02
  1.33518162e+03  1.33518162e+03  1.33518162e+03  2.67004315e+03
  3.02930643e+03  3.02930643e+03  3.02930643e+03  6.64965904e+03
  6.64965904e+03  6.64965904e+03  9.07467266e+03  2.54294664e+04
  7.61708515e+04]
E1 = -728.4261884668513  E_coul = 201.68752670026268
cycle= 2 E= -526.738661766589  delta_E= -0.000712  |g|= 0.0374  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748076
diis-c [-0.003295    0.08181608  0.91818392]
  HOMO = -0.581225112311278  LUMO = 1.01950451015254
  mo_energy =
[-1.18568277e+02 -1.23035420e+01 -9.55508212e+00 -9.55508212e+00
 -9.55508212e+00 -1.26817563e+00 -5.81225112e-01 -5.81225112e-01
 -5.81225112e-01  1.01950451e+00  1.01950451e+00  1.01950451e+00
  1.03568701e+00  7.33826178e+00  7.33826178e+00  7.33826178e+00
  1.38739079e+01  3.35795341e+01  3.35795341e+01  3.35795341e+01
  1.13071793e+02  1.29173766e+02  1.29173766e+02  1.29173766e+02
  4.83496744e+02  4.83496744e+02  4.83496744e+02  6.00420938e+02
  1.33525220e+03  1.33525220e+03  1.33525220e+03  2.67011702e+03
  3.02937924e+03  3.02937924e+03  3.02937924e+03  6.64973358e+03
  6.64973358e+03  6.64973358e+03  9.07474802e+03  2.54295424e+04
  7.61709277e+04]
E1 = -728.2768757285734  E_coul = 201.5381558179987
cycle= 3 E= -526.738719910575  delta_E= -5.81e-05  |g|= 0.00627  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131428
diis-c [-5.71946914e-07 -1.24681802e-03  1.44985616e-01  8.56261202e-01]
  HOMO = -0.582716520206241  LUMO = 1.01842396805217
  mo_energy =
[-1.18578210e+02 -1.23093294e+01 -9.56121478e+00 -9.56121478e+00
 -9.56121478e+00 -1.26986085e+00 -5.82716520e-01 -5.82716520e-01
 -5.82716520e-01  1.01842397e+00  1.01842397e+00  1.01842397e+00
  1.03440123e+00  7.33448637e+00  7.33448637e+00  7.33448637e+00
  1.38691015e+01  3.35733799e+01  3.35733799e+01  3.35733799e+01
  1.13063496e+02  1.29165443e+02  1.29165443e+02  1.29165443e+02
  4.83486927e+02  4.83486927e+02  4.83486927e+02  6.00410767e+02
  1.33524179e+03  1.33524179e+03  1.33524179e+03  2.67010599e+03
  3.02936845e+03  3.02936845e+03  3.02936845e+03  6.64972240e+03
  6.64972240e+03  6.64972240e+03  9.07473663e+03  2.54295308e+04
  7.61709160e+04]
E1 = -728.2995704734333  E_coul = 201.56084865615995
cycle= 4 E= -526.738721817273  delta_E= -1.91e-06  |g|= 9.6e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112705
diis-c [-4.00107343e-09  7.07902812e-05 -1.01461386e-02 -6.57785154e-02
  1.07585386e+00]
  HOMO = -0.582698430810587  LUMO = 1.01843955199816
  mo_energy =
[-1.18578171e+02 -1.23092662e+01 -9.56116501e+00 -9.56116501e+00
 -9.56116501e+00 -1.26982075e+00 -5.82698431e-01 -5.82698431e-01
 -5.82698431e-01  1.01843955e+00  1.01843955e+00  1.01843955e+00
  1.03443530e+00  7.33452720e+00  7.33452720e+00  7.33452720e+00
  1.38691603e+01  3.35734277e+01  3.35734277e+01  3.35734277e+01
  1.13063545e+02  1.29165489e+02  1.29165489e+02  1.29165489e+02
  4.83486966e+02  4.83486966e+02  4.83486966e+02  6.00410798e+02
  1.33524182e+03  1.33524182e+03  1.33524182e+03  2.67010600e+03
  3.02936847e+03  3.02936847e+03  3.02936847e+03  6.64972241e+03
  6.64972241e+03  6.64972241e+03  9.07473662e+03  2.54295308e+04
  7.61709160e+04]
E1 = -728.2993652174059  E_coul = 201.56064339853893
cycle= 5 E= -526.738721818867  delta_E= -1.59e-09  |g|= 2.02e-05  |ddm|= 0.000154
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.827e-05
diis-c [-7.09730082e-11  1.41326202e-05 -1.83596427e-03 -1.37227967e-02
  4.34680529e-02  9.72076575e-01]
  HOMO = -0.582705685252837  LUMO = 1.01843472155449
  mo_energy =
[-1.18578201e+02 -1.23092883e+01 -9.56118896e+00 -9.56118896e+00
 -9.56118896e+00 -1.26982655e+00 -5.82705685e-01 -5.82705685e-01
 -5.82705685e-01  1.01843472e+00  1.01843472e+00  1.01843472e+00
  1.03443129e+00  7.33451093e+00  7.33451093e+00  7.33451093e+00
  1.38691418e+01  3.35734044e+01  3.35734044e+01  3.35734044e+01
  1.13063518e+02  1.29165462e+02  1.29165462e+02  1.29165462e+02
  4.83486936e+02  4.83486936e+02  4.83486936e+02  6.00410767e+02
  1.33524179e+03  1.33524179e+03  1.33524179e+03  2.67010596e+03
  3.02936844e+03  3.02936844e+03  3.02936844e+03  6.64972238e+03
  6.64972238e+03  6.64972238e+03  9.07473659e+03  2.54295307e+04
  7.61709159e+04]
E1 = -728.2994451339321  E_coul = 201.56072331501014
cycle= 6 E= -526.738721818922  delta_E= -5.49e-11  |g|= 1.72e-06  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2994451339321  E_coul = 201.56072331501014
  HOMO = -0.582705702987612  LUMO = 1.01843476438151
  mo_energy =
[-1.18578201e+02 -1.23092882e+01 -9.56118890e+00 -9.56118890e+00
 -9.56118890e+00 -1.26982619e+00 -5.82705703e-01 -5.82705703e-01
 -5.82705703e-01  1.01843476e+00  1.01843476e+00  1.01843476e+00
  1.03443163e+00  7.33451098e+00  7.33451098e+00  7.33451098e+00
  1.38691420e+01  3.35734045e+01  3.35734045e+01  3.35734045e+01
  1.13063519e+02  1.29165462e+02  1.29165462e+02  1.29165462e+02
  4.83486936e+02  4.83486936e+02  4.83486936e+02  6.00410768e+02
  1.33524179e+03  1.33524179e+03  1.33524179e+03  2.67010596e+03
  3.02936844e+03  3.02936844e+03  3.02936844e+03  6.64972238e+03
  6.64972238e+03  6.64972238e+03  9.07473659e+03  2.54295307e+04
  7.61709159e+04]
E1 = -728.2994442041601  E_coul = 201.5607223852379
Extra cycle  E= -526.738721818922  delta_E= -2.27e-13  |g|= 3.52e-07  |ddm|= 2.99e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103960.1210200431
E1 = -728.2994442041601  E_coul = 201.5607223852379
init E= -526.738721818922
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.582705731959381  LUMO = 1.01843475519968
  mo_energy =
[-1.18578201e+02 -1.23092882e+01 -9.56118899e+00 -9.56118899e+00
 -9.56118899e+00 -1.26982614e+00 -5.82705732e-01 -5.82705732e-01
 -5.82705732e-01  1.01843476e+00  1.01843476e+00  1.01843476e+00
  1.03443168e+00  7.33451093e+00  7.33451093e+00  7.33451093e+00
  1.38691419e+01  3.35734044e+01  3.35734044e+01  3.35734044e+01
  1.13063518e+02  1.29165462e+02  1.29165462e+02  1.29165462e+02
  4.83486936e+02  4.83486936e+02  4.83486936e+02  6.00410767e+02
  1.33524179e+03  1.33524179e+03  1.33524179e+03  2.67010596e+03
  3.02936844e+03  3.02936844e+03  3.02936844e+03  6.64972238e+03
  6.64972238e+03  6.64972238e+03  9.07473659e+03  2.54295307e+04
  7.61709159e+04]
E1 = -728.2994443626354  E_coul = 201.56072254371395
cycle= 1 E= -526.738721818921  delta_E= 6.82e-13  |g|= 7.35e-08  |ddm|= 5.83e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2994443626354  E_coul = 201.56072254371395
  HOMO = -0.582705731310441  LUMO = 1.01843475807258
  mo_energy =
[-1.18578201e+02 -1.23092882e+01 -9.56118898e+00 -9.56118898e+00
 -9.56118898e+00 -1.26982613e+00 -5.82705731e-01 -5.82705731e-01
 -5.82705731e-01  1.01843476e+00  1.01843476e+00  1.01843476e+00
  1.03443169e+00  7.33451093e+00  7.33451093e+00  7.33451093e+00
  1.38691420e+01  3.35734044e+01  3.35734044e+01  3.35734044e+01
  1.13063518e+02  1.29165462e+02  1.29165462e+02  1.29165462e+02
  4.83486936e+02  4.83486936e+02  4.83486936e+02  6.00410767e+02
  1.33524179e+03  1.33524179e+03  1.33524179e+03  2.67010596e+03
  3.02936844e+03  3.02936844e+03  3.02936844e+03  6.64972238e+03
  6.64972238e+03  6.64972238e+03  9.07473659e+03  2.54295307e+04
  7.61709159e+04]
E1 = -728.2994442969967  E_coul = 201.56072247807532
Extra cycle  E= -526.738721818921  delta_E=    0  |g|= 1.48e-08  |ddm|= 1.22e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826587e+04 7.61751592e+03 3.61735385e+03 1.59770238e+03
 3.82738640e+02 1.10297450e+02 3.64739795e+01 8.87189171e+00
 3.38014748e+00 6.72359637e-01 2.48984256e-01 1.36278414e+03
 6.64736418e+02 3.00918296e+02 3.14004601e+02 6.16567136e+01
 7.37658320e+00 2.02177366e+01 7.77457524e-01 2.83021813e+00
 2.23334293e-01]
grad_E = [-1.53075598e-06  3.45216947e-06 -1.50025545e-06  7.45337988e-05
 -1.28114825e-04 -7.03317547e-04 -1.91127711e-04  2.21034662e-03
 -1.88079071e-03  1.33411654e-03  4.04781735e-04 -5.25378944e-07
  4.74917877e-06  2.20639531e-05  1.90265749e-05  1.54257855e-04
  3.48763791e-03 -1.33505095e-03 -2.63361637e-03 -2.84905395e-03
  7.82655137e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6592742        1
[INPUT] 0    0    [1    /1   ]  7617.51456559        1
[INPUT] 0    0    [1    /1   ]  3617.3545035         1
[INPUT] 0    0    [1    /1   ]  1597.67418781        1
[INPUT] 0    0    [1    /1   ]  382.731506588        1
[INPUT] 0    0    [1    /1   ]  110.738282719        1
[INPUT] 0    0    [1    /1   ]  36.7814949843        1
[INPUT] 0    0    [1    /1   ]  8.83393358641        1
[INPUT] 0    0    [1    /1   ]  3.37577045953        1
[INPUT] 0    0    [1    /1   ]  0.679189149355       1
[INPUT] 0    0    [1    /1   ]  0.250992419064       1
[INPUT] 1    0    [1    /1   ]  1362.78435206        1
[INPUT] 1    0    [1    /1   ]  664.734362212        1
[INPUT] 1    0    [1    /1   ]  300.908607097        1
[INPUT] 1    0    [1    /1   ]  313.996247087        1
[INPUT] 1    0    [1    /1   ]  61.6610734896        1
[INPUT] 1    0    [1    /1   ]  7.36508909948        1
[INPUT] 1    0    [1    /1   ]  20.2319384897        1
[INPUT] 1    0    [1    /1   ]  0.775778426545       1
[INPUT] 1    0    [1    /1   ]  2.81100627771        1
[INPUT] 1    0    [1    /1   ]  0.22307674413        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.659274189835, 1.0]], [0, [7617.514565585109, 1.0]], [0, [3617.35450349617, 1.0]], [0, [1597.6741878084085, 1.0]], [0, [382.73150658817616, 1.0]], [0, [110.7382827189904, 1.0]], [0, [36.78149498426462, 1.0]], [0, [8.833933586413641, 1.0]], [0, [3.3757704595276365, 1.0]], [0, [0.6791891493549019, 1.0]], [0, [0.2509924190638167, 1.0]], [1, [1362.7843520615568, 1.0]], [1, [664.7343622115447, 1.0]], [1, [300.908607097027, 1.0]], [1, [313.9962470865874, 1.0]], [1, [61.66107348960078, 1.0]], [1, [7.365089099483751, 1.0]], [1, [20.23193848969233, 1.0]], [1, [0.7757784265446728, 1.0]], [1, [2.8110062777148794, 1.0]], [1, [0.2230767441295365, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65927419]
bas 1, expnt(s) = [7617.51456559]
bas 2, expnt(s) = [3617.3545035]
bas 3, expnt(s) = [1597.67418781]
bas 4, expnt(s) = [382.73150659]
bas 5, expnt(s) = [110.73828272]
bas 6, expnt(s) = [36.78149498]
bas 7, expnt(s) = [8.83393359]
bas 8, expnt(s) = [3.37577046]
bas 9, expnt(s) = [0.67918915]
bas 10, expnt(s) = [0.25099242]
bas 11, expnt(s) = [1362.78435206]
bas 12, expnt(s) = [664.73436221]
bas 13, expnt(s) = [300.9086071]
bas 14, expnt(s) = [313.99624709]
bas 15, expnt(s) = [61.66107349]
bas 16, expnt(s) = [7.3650891]
bas 17, expnt(s) = [20.23193849]
bas 18, expnt(s) = [0.77577843]
bas 19, expnt(s) = [2.81100628]
bas 20, expnt(s) = [0.22307674]
CPU time:       274.79
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826593e+04 5.20026338e+03 7.61751457e+03 2.06003687e+03
 3.61735450e+03 1.17844231e+03 1.59767419e+03 6.38456317e+02
 3.82731507e+02 2.18617884e+02 1.10738283e+02 8.62458809e+01
 3.67814950e+01 3.77343660e+01 8.83393359e+00 1.29458515e+01
 3.37577046e+00 6.29208681e+00 6.79189149e-01 1.89020139e+00
 2.50992419e-01 8.95901941e-01 1.36278435e+03 2.41556270e+04
 6.64734362e+02 9.84678724e+03 3.00908607e+02 3.65618073e+03
 3.13996247e+02 3.85602610e+03 6.16610735e+01 5.04078581e+02
 7.36508910e+00 3.53962211e+01 2.02319385e+01 1.25178938e+02
 7.75778427e-01 2.12400980e+00 2.81100628e+00 1.06184631e+01
 2.23076744e-01 4.47251972e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993439853868644
cond(S) = 103958.7646076999
E1 = -729.5325559186883  E_coul = 203.18088608095167
init E= -526.351669837737
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55572923176334  LUMO = 1.03436110097876
  mo_energy =
[-1.18328889e+02 -1.22042630e+01 -9.44662364e+00 -9.44662364e+00
 -9.44662364e+00 -1.23985925e+00 -5.55729232e-01 -5.55729232e-01
 -5.55729232e-01  1.03436110e+00  1.03436110e+00  1.03436110e+00
  1.07224858e+00  7.36179416e+00  7.36179416e+00  7.36179416e+00
  1.39630137e+01  3.36003677e+01  3.36003677e+01  3.36003677e+01
  1.13882418e+02  1.29278794e+02  1.29278794e+02  1.29278794e+02
  4.83699418e+02  4.83699418e+02  4.83699418e+02  6.02792610e+02
  1.33549854e+03  1.33549854e+03  1.33549854e+03  2.67309512e+03
  3.02966742e+03  3.02966742e+03  3.02966742e+03  6.65011853e+03
  6.65011853e+03  6.65011853e+03  9.07773714e+03  2.54324915e+04
  7.61738024e+04]
E1 = -727.8565228431679  E_coul = 201.11823480049213
cycle= 1 E= -526.738288042676  delta_E= -0.387  |g|= 0.185  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541007
diis-c [-0.29268894  1.        ]
  HOMO = -0.59025222304844  LUMO = 1.0103122812405
  mo_energy =
[-1.18635597e+02 -1.23414958e+01 -9.59456697e+00 -9.59456697e+00
 -9.59456697e+00 -1.27896745e+00 -5.90252223e-01 -5.90252223e-01
 -5.90252223e-01  1.01031228e+00  1.01031228e+00  1.01031228e+00
  1.04271632e+00  7.27135775e+00  7.27135775e+00  7.27135775e+00
  1.38485917e+01  3.34468142e+01  3.34468142e+01  3.34468142e+01
  1.13660476e+02  1.29051298e+02  1.29051298e+02  1.29051298e+02
  4.83393876e+02  4.83393876e+02  4.83393876e+02  6.02448985e+02
  1.33513692e+03  1.33513692e+03  1.33513692e+03  2.67259982e+03
  3.02923994e+03  3.02923994e+03  3.02923994e+03  6.64957807e+03
  6.64957807e+03  6.64957807e+03  9.07712168e+03  2.54317821e+04
  7.61730030e+04]
E1 = -728.4271158908111  E_coul = 201.68811602170433
cycle= 2 E= -526.738999869107  delta_E= -0.000712  |g|= 0.0374  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.074761
diis-c [-0.00329939  0.08168641  0.91831359]
  HOMO = -0.581184347465962  LUMO = 1.01700473900701
  mo_energy =
[-1.18568226e+02 -1.23036452e+01 -9.55507483e+00 -9.55507483e+00
 -9.55507483e+00 -1.26811207e+00 -5.81184347e-01 -5.81184347e-01
 -5.81184347e-01  1.01700474e+00  1.01700474e+00  1.01700474e+00
  1.05121123e+00  7.29499680e+00  7.29499680e+00  7.29499680e+00
  1.38798588e+01  3.34866955e+01  3.34866955e+01  3.34866955e+01
  1.13716319e+02  1.29106905e+02  1.29106905e+02  1.29106905e+02
  4.83460432e+02  4.83460432e+02  4.83460432e+02  6.02517914e+02
  1.33520751e+03  1.33520751e+03  1.33520751e+03  2.67267372e+03
  3.02931277e+03  3.02931277e+03  3.02931277e+03  6.64965264e+03
  6.64965264e+03  6.64965264e+03  9.07719707e+03  2.54318581e+04
  7.61730792e+04]
E1 = -728.277652732105  E_coul = 201.53859465556206
cycle= 3 E= -526.739058076543  delta_E= -5.82e-05  |g|= 0.00629  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131587
diis-c [-5.66582553e-07 -1.24440797e-03  1.45242305e-01  8.56002103e-01]
  HOMO = -0.582677720556808  LUMO = 1.01592621626726
  mo_energy =
[-1.18578178e+02 -1.23094439e+01 -9.56121930e+00 -9.56121930e+00
 -9.56121930e+00 -1.26980037e+00 -5.82677721e-01 -5.82677721e-01
 -5.82677721e-01  1.01592622e+00  1.01592622e+00  1.01592622e+00
  1.04990938e+00  7.29122554e+00  7.29122554e+00  7.29122554e+00
  1.38750459e+01  3.34805298e+01  3.34805298e+01  3.34805298e+01
  1.13707993e+02  1.29098565e+02  1.29098565e+02  1.29098565e+02
  4.83450596e+02  4.83450596e+02  4.83450596e+02  6.02507721e+02
  1.33519709e+03  1.33519709e+03  1.33519709e+03  2.67266266e+03
  3.02930196e+03  3.02930196e+03  3.02930196e+03  6.64964144e+03
  6.64964144e+03  6.64964144e+03  9.07718565e+03  2.54318465e+04
  7.61730675e+04]
E1 = -728.3004068738497  E_coul = 201.5613468815467
cycle= 4 E= -526.739059992303  delta_E= -1.92e-06  |g|= 9.55e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112063
diis-c [-3.97054894e-09  7.04013183e-05 -1.00980822e-02 -6.53429295e-02
  1.07537061e+00]
  HOMO = -0.582659578888819  LUMO = 1.0159417794059
  mo_energy =
[-1.18578140e+02 -1.23093809e+01 -9.56116959e+00 -9.56116959e+00
 -9.56116959e+00 -1.26976038e+00 -5.82659579e-01 -5.82659579e-01
 -5.82659579e-01  1.01594178e+00  1.01594178e+00  1.01594178e+00
  1.04994364e+00  7.29126628e+00  7.29126628e+00  7.29126628e+00
  1.38751044e+01  3.34805775e+01  3.34805775e+01  3.34805775e+01
  1.13708043e+02  1.29098611e+02  1.29098611e+02  1.29098611e+02
  4.83450635e+02  4.83450635e+02  4.83450635e+02  6.02507752e+02
  1.33519712e+03  1.33519712e+03  1.33519712e+03  2.67266267e+03
  3.02930198e+03  3.02930198e+03  3.02930198e+03  6.64964145e+03
  6.64964145e+03  6.64964145e+03  9.07718565e+03  2.54318465e+04
  7.61730675e+04]
E1 = -728.3002028673825  E_coul = 201.56114287351548
cycle= 5 E= -526.739059993867  delta_E= -1.56e-09  |g|= 2.01e-05  |ddm|= 0.000153
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.81538e-05
diis-c [-6.95063213e-11  1.41079817e-05 -1.83836711e-03 -1.37027759e-02
  4.32630490e-02  9.72263986e-01]
  HOMO = -0.582666776107642  LUMO = 1.01593700362802
  mo_energy =
[-1.18578170e+02 -1.23094029e+01 -9.56119341e+00 -9.56119341e+00
 -9.56119341e+00 -1.26976614e+00 -5.82666776e-01 -5.82666776e-01
 -5.82666776e-01  1.01593700e+00  1.01593700e+00  1.01593700e+00
  1.04993961e+00  7.29125015e+00  7.29125015e+00  7.29125015e+00
  1.38750861e+01  3.34805544e+01  3.34805544e+01  3.34805544e+01
  1.13708016e+02  1.29098584e+02  1.29098584e+02  1.29098584e+02
  4.83450605e+02  4.83450605e+02  4.83450605e+02  6.02507722e+02
  1.33519709e+03  1.33519709e+03  1.33519709e+03  2.67266264e+03
  3.02930195e+03  3.02930195e+03  3.02930195e+03  6.64964142e+03
  6.64964142e+03  6.64964142e+03  9.07718562e+03  2.54318464e+04
  7.61730675e+04]
E1 = -728.3002825718571  E_coul = 201.5612225779354
cycle= 6 E= -526.739059993922  delta_E= -5.47e-11  |g|= 1.7e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3002825718571  E_coul = 201.5612225779354
  HOMO = -0.582666791918306  LUMO = 1.01593704726331
  mo_energy =
[-1.18578170e+02 -1.23094027e+01 -9.56119336e+00 -9.56119336e+00
 -9.56119336e+00 -1.26976578e+00 -5.82666792e-01 -5.82666792e-01
 -5.82666792e-01  1.01593705e+00  1.01593705e+00  1.01593705e+00
  1.04993995e+00  7.29125020e+00  7.29125020e+00  7.29125020e+00
  1.38750863e+01  3.34805545e+01  3.34805545e+01  3.34805545e+01
  1.13708016e+02  1.29098584e+02  1.29098584e+02  1.29098584e+02
  4.83450605e+02  4.83450605e+02  4.83450605e+02  6.02507722e+02
  1.33519709e+03  1.33519709e+03  1.33519709e+03  2.67266264e+03
  3.02930195e+03  3.02930195e+03  3.02930195e+03  6.64964142e+03
  6.64964142e+03  6.64964142e+03  9.07718562e+03  2.54318464e+04
  7.61730675e+04]
E1 = -728.3002816886336  E_coul = 201.56122169471143
Extra cycle  E= -526.739059993922  delta_E= -4.55e-13  |g|= 3.48e-07  |ddm|= 2.94e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826593e+04 7.61751457e+03 3.61735450e+03 1.59767419e+03
 3.82731507e+02 1.10738283e+02 3.67814950e+01 8.83393359e+00
 3.37577046e+00 6.79189149e-01 2.50992419e-01 1.36278435e+03
 6.64734362e+02 3.00908607e+02 3.13996247e+02 6.16610735e+01
 7.36508910e+00 2.02319385e+01 7.75778427e-01 2.81100628e+00
 2.23076744e-01]
E = -526.7390599939222
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6592742        1
[INPUT] 0    0    [1    /1   ]  7617.51456559        1
[INPUT] 0    0    [1    /1   ]  3617.3545035         1
[INPUT] 0    0    [1    /1   ]  1597.67418781        1
[INPUT] 0    0    [1    /1   ]  382.731506588        1
[INPUT] 0    0    [1    /1   ]  110.738282719        1
[INPUT] 0    0    [1    /1   ]  36.7814949843        1
[INPUT] 0    0    [1    /1   ]  8.83393358641        1
[INPUT] 0    0    [1    /1   ]  3.37577045953        1
[INPUT] 0    0    [1    /1   ]  0.679189149355       1
[INPUT] 0    0    [1    /1   ]  0.250992419064       1
[INPUT] 1    0    [1    /1   ]  1362.78435206        1
[INPUT] 1    0    [1    /1   ]  664.734362212        1
[INPUT] 1    0    [1    /1   ]  300.908607097        1
[INPUT] 1    0    [1    /1   ]  313.996247087        1
[INPUT] 1    0    [1    /1   ]  61.6610734896        1
[INPUT] 1    0    [1    /1   ]  7.36508909948        1
[INPUT] 1    0    [1    /1   ]  20.2319384897        1
[INPUT] 1    0    [1    /1   ]  0.775778426545       1
[INPUT] 1    0    [1    /1   ]  2.81100627771        1
[INPUT] 1    0    [1    /1   ]  0.22307674413        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.659274189835, 1.0]], [0, [7617.514565585109, 1.0]], [0, [3617.35450349617, 1.0]], [0, [1597.6741878084085, 1.0]], [0, [382.73150658817616, 1.0]], [0, [110.7382827189904, 1.0]], [0, [36.78149498426462, 1.0]], [0, [8.833933586413641, 1.0]], [0, [3.3757704595276365, 1.0]], [0, [0.6791891493549019, 1.0]], [0, [0.2509924190638167, 1.0]], [1, [1362.7843520615568, 1.0]], [1, [664.7343622115447, 1.0]], [1, [300.908607097027, 1.0]], [1, [313.9962470865874, 1.0]], [1, [61.66107348960078, 1.0]], [1, [7.365089099483751, 1.0]], [1, [20.23193848969233, 1.0]], [1, [0.7757784265446728, 1.0]], [1, [2.8110062777148794, 1.0]], [1, [0.2230767441295365, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.65927419]
bas 1, expnt(s) = [7617.51456559]
bas 2, expnt(s) = [3617.3545035]
bas 3, expnt(s) = [1597.67418781]
bas 4, expnt(s) = [382.73150659]
bas 5, expnt(s) = [110.73828272]
bas 6, expnt(s) = [36.78149498]
bas 7, expnt(s) = [8.83393359]
bas 8, expnt(s) = [3.37577046]
bas 9, expnt(s) = [0.67918915]
bas 10, expnt(s) = [0.25099242]
bas 11, expnt(s) = [1362.78435206]
bas 12, expnt(s) = [664.73436221]
bas 13, expnt(s) = [300.9086071]
bas 14, expnt(s) = [313.99624709]
bas 15, expnt(s) = [61.66107349]
bas 16, expnt(s) = [7.3650891]
bas 17, expnt(s) = [20.23193849]
bas 18, expnt(s) = [0.77577843]
bas 19, expnt(s) = [2.81100628]
bas 20, expnt(s) = [0.22307674]
CPU time:       275.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826593e+04 5.20026338e+03 7.61751457e+03 2.06003687e+03
 3.61735450e+03 1.17844231e+03 1.59767419e+03 6.38456317e+02
 3.82731507e+02 2.18617884e+02 1.10738283e+02 8.62458809e+01
 3.67814950e+01 3.77343660e+01 8.83393359e+00 1.29458515e+01
 3.37577046e+00 6.29208681e+00 6.79189149e-01 1.89020139e+00
 2.50992419e-01 8.95901941e-01 1.36278435e+03 2.41556270e+04
 6.64734362e+02 9.84678724e+03 3.00908607e+02 3.65618073e+03
 3.13996247e+02 3.85602610e+03 6.16610735e+01 5.04078581e+02
 7.36508910e+00 3.53962211e+01 2.02319385e+01 1.25178938e+02
 7.75778427e-01 2.12400980e+00 2.81100628e+00 1.06184631e+01
 2.23076744e-01 4.47251972e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993439853868644
cond(S) = 103958.7646076999
E1 = -729.5325559186883  E_coul = 203.18088608095167
init E= -526.351669837737
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55572923176334  LUMO = 1.03436110097876
  mo_energy =
[-1.18328889e+02 -1.22042630e+01 -9.44662364e+00 -9.44662364e+00
 -9.44662364e+00 -1.23985925e+00 -5.55729232e-01 -5.55729232e-01
 -5.55729232e-01  1.03436110e+00  1.03436110e+00  1.03436110e+00
  1.07224858e+00  7.36179416e+00  7.36179416e+00  7.36179416e+00
  1.39630137e+01  3.36003677e+01  3.36003677e+01  3.36003677e+01
  1.13882418e+02  1.29278794e+02  1.29278794e+02  1.29278794e+02
  4.83699418e+02  4.83699418e+02  4.83699418e+02  6.02792610e+02
  1.33549854e+03  1.33549854e+03  1.33549854e+03  2.67309512e+03
  3.02966742e+03  3.02966742e+03  3.02966742e+03  6.65011853e+03
  6.65011853e+03  6.65011853e+03  9.07773714e+03  2.54324915e+04
  7.61738024e+04]
E1 = -727.8565228431679  E_coul = 201.11823480049213
cycle= 1 E= -526.738288042676  delta_E= -0.387  |g|= 0.185  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541007
diis-c [-0.29268894  1.        ]
  HOMO = -0.59025222304844  LUMO = 1.0103122812405
  mo_energy =
[-1.18635597e+02 -1.23414958e+01 -9.59456697e+00 -9.59456697e+00
 -9.59456697e+00 -1.27896745e+00 -5.90252223e-01 -5.90252223e-01
 -5.90252223e-01  1.01031228e+00  1.01031228e+00  1.01031228e+00
  1.04271632e+00  7.27135775e+00  7.27135775e+00  7.27135775e+00
  1.38485917e+01  3.34468142e+01  3.34468142e+01  3.34468142e+01
  1.13660476e+02  1.29051298e+02  1.29051298e+02  1.29051298e+02
  4.83393876e+02  4.83393876e+02  4.83393876e+02  6.02448985e+02
  1.33513692e+03  1.33513692e+03  1.33513692e+03  2.67259982e+03
  3.02923994e+03  3.02923994e+03  3.02923994e+03  6.64957807e+03
  6.64957807e+03  6.64957807e+03  9.07712168e+03  2.54317821e+04
  7.61730030e+04]
E1 = -728.4271158908111  E_coul = 201.68811602170433
cycle= 2 E= -526.738999869107  delta_E= -0.000712  |g|= 0.0374  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.074761
diis-c [-0.00329939  0.08168641  0.91831359]
  HOMO = -0.581184347465962  LUMO = 1.01700473900701
  mo_energy =
[-1.18568226e+02 -1.23036452e+01 -9.55507483e+00 -9.55507483e+00
 -9.55507483e+00 -1.26811207e+00 -5.81184347e-01 -5.81184347e-01
 -5.81184347e-01  1.01700474e+00  1.01700474e+00  1.01700474e+00
  1.05121123e+00  7.29499680e+00  7.29499680e+00  7.29499680e+00
  1.38798588e+01  3.34866955e+01  3.34866955e+01  3.34866955e+01
  1.13716319e+02  1.29106905e+02  1.29106905e+02  1.29106905e+02
  4.83460432e+02  4.83460432e+02  4.83460432e+02  6.02517914e+02
  1.33520751e+03  1.33520751e+03  1.33520751e+03  2.67267372e+03
  3.02931277e+03  3.02931277e+03  3.02931277e+03  6.64965264e+03
  6.64965264e+03  6.64965264e+03  9.07719707e+03  2.54318581e+04
  7.61730792e+04]
E1 = -728.277652732105  E_coul = 201.53859465556206
cycle= 3 E= -526.739058076543  delta_E= -5.82e-05  |g|= 0.00629  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131587
diis-c [-5.66582553e-07 -1.24440797e-03  1.45242305e-01  8.56002103e-01]
  HOMO = -0.582677720556808  LUMO = 1.01592621626726
  mo_energy =
[-1.18578178e+02 -1.23094439e+01 -9.56121930e+00 -9.56121930e+00
 -9.56121930e+00 -1.26980037e+00 -5.82677721e-01 -5.82677721e-01
 -5.82677721e-01  1.01592622e+00  1.01592622e+00  1.01592622e+00
  1.04990938e+00  7.29122554e+00  7.29122554e+00  7.29122554e+00
  1.38750459e+01  3.34805298e+01  3.34805298e+01  3.34805298e+01
  1.13707993e+02  1.29098565e+02  1.29098565e+02  1.29098565e+02
  4.83450596e+02  4.83450596e+02  4.83450596e+02  6.02507721e+02
  1.33519709e+03  1.33519709e+03  1.33519709e+03  2.67266266e+03
  3.02930196e+03  3.02930196e+03  3.02930196e+03  6.64964144e+03
  6.64964144e+03  6.64964144e+03  9.07718565e+03  2.54318465e+04
  7.61730675e+04]
E1 = -728.3004068738497  E_coul = 201.5613468815467
cycle= 4 E= -526.739059992303  delta_E= -1.92e-06  |g|= 9.55e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112063
diis-c [-3.97054894e-09  7.04013183e-05 -1.00980822e-02 -6.53429295e-02
  1.07537061e+00]
  HOMO = -0.582659578888819  LUMO = 1.0159417794059
  mo_energy =
[-1.18578140e+02 -1.23093809e+01 -9.56116959e+00 -9.56116959e+00
 -9.56116959e+00 -1.26976038e+00 -5.82659579e-01 -5.82659579e-01
 -5.82659579e-01  1.01594178e+00  1.01594178e+00  1.01594178e+00
  1.04994364e+00  7.29126628e+00  7.29126628e+00  7.29126628e+00
  1.38751044e+01  3.34805775e+01  3.34805775e+01  3.34805775e+01
  1.13708043e+02  1.29098611e+02  1.29098611e+02  1.29098611e+02
  4.83450635e+02  4.83450635e+02  4.83450635e+02  6.02507752e+02
  1.33519712e+03  1.33519712e+03  1.33519712e+03  2.67266267e+03
  3.02930198e+03  3.02930198e+03  3.02930198e+03  6.64964145e+03
  6.64964145e+03  6.64964145e+03  9.07718565e+03  2.54318465e+04
  7.61730675e+04]
E1 = -728.3002028673825  E_coul = 201.56114287351548
cycle= 5 E= -526.739059993867  delta_E= -1.56e-09  |g|= 2.01e-05  |ddm|= 0.000153
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.81538e-05
diis-c [-6.95063213e-11  1.41079817e-05 -1.83836711e-03 -1.37027759e-02
  4.32630490e-02  9.72263986e-01]
  HOMO = -0.582666776107642  LUMO = 1.01593700362802
  mo_energy =
[-1.18578170e+02 -1.23094029e+01 -9.56119341e+00 -9.56119341e+00
 -9.56119341e+00 -1.26976614e+00 -5.82666776e-01 -5.82666776e-01
 -5.82666776e-01  1.01593700e+00  1.01593700e+00  1.01593700e+00
  1.04993961e+00  7.29125015e+00  7.29125015e+00  7.29125015e+00
  1.38750861e+01  3.34805544e+01  3.34805544e+01  3.34805544e+01
  1.13708016e+02  1.29098584e+02  1.29098584e+02  1.29098584e+02
  4.83450605e+02  4.83450605e+02  4.83450605e+02  6.02507722e+02
  1.33519709e+03  1.33519709e+03  1.33519709e+03  2.67266264e+03
  3.02930195e+03  3.02930195e+03  3.02930195e+03  6.64964142e+03
  6.64964142e+03  6.64964142e+03  9.07718562e+03  2.54318464e+04
  7.61730675e+04]
E1 = -728.3002825718571  E_coul = 201.5612225779354
cycle= 6 E= -526.739059993922  delta_E= -5.47e-11  |g|= 1.7e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3002825718571  E_coul = 201.5612225779354
  HOMO = -0.582666791918306  LUMO = 1.01593704726331
  mo_energy =
[-1.18578170e+02 -1.23094027e+01 -9.56119336e+00 -9.56119336e+00
 -9.56119336e+00 -1.26976578e+00 -5.82666792e-01 -5.82666792e-01
 -5.82666792e-01  1.01593705e+00  1.01593705e+00  1.01593705e+00
  1.04993995e+00  7.29125020e+00  7.29125020e+00  7.29125020e+00
  1.38750863e+01  3.34805545e+01  3.34805545e+01  3.34805545e+01
  1.13708016e+02  1.29098584e+02  1.29098584e+02  1.29098584e+02
  4.83450605e+02  4.83450605e+02  4.83450605e+02  6.02507722e+02
  1.33519709e+03  1.33519709e+03  1.33519709e+03  2.67266264e+03
  3.02930195e+03  3.02930195e+03  3.02930195e+03  6.64964142e+03
  6.64964142e+03  6.64964142e+03  9.07718562e+03  2.54318464e+04
  7.61730675e+04]
E1 = -728.3002816886336  E_coul = 201.56122169471143
Extra cycle  E= -526.739059993922  delta_E= -4.55e-13  |g|= 3.48e-07  |ddm|= 2.94e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103958.7646076999
E1 = -728.3002816886336  E_coul = 201.56122169471143
init E= -526.739059993922
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.582666819455031  LUMO = 1.01593703904276
  mo_energy =
[-1.18578170e+02 -1.23094028e+01 -9.56119344e+00 -9.56119344e+00
 -9.56119344e+00 -1.26976574e+00 -5.82666819e-01 -5.82666819e-01
 -5.82666819e-01  1.01593704e+00  1.01593704e+00  1.01593704e+00
  1.04994000e+00  7.29125015e+00  7.29125015e+00  7.29125015e+00
  1.38750862e+01  3.34805544e+01  3.34805544e+01  3.34805544e+01
  1.13708016e+02  1.29098584e+02  1.29098584e+02  1.29098584e+02
  4.83450605e+02  4.83450605e+02  4.83450605e+02  6.02507722e+02
  1.33519709e+03  1.33519709e+03  1.33519709e+03  2.67266264e+03
  3.02930195e+03  3.02930195e+03  3.02930195e+03  6.64964142e+03
  6.64964142e+03  6.64964142e+03  9.07718562e+03  2.54318464e+04
  7.61730675e+04]
E1 = -728.3002818413543  E_coul = 201.56122184743157
cycle= 1 E= -526.739059993923  delta_E= -4.55e-13  |g|= 7.24e-08  |ddm|= 5.74e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3002818413543  E_coul = 201.56122184743157
  HOMO = -0.582666818798038  LUMO = 1.01593704188573
  mo_energy =
[-1.18578170e+02 -1.23094028e+01 -9.56119343e+00 -9.56119343e+00
 -9.56119343e+00 -1.26976572e+00 -5.82666819e-01 -5.82666819e-01
 -5.82666819e-01  1.01593704e+00  1.01593704e+00  1.01593704e+00
  1.04994002e+00  7.29125015e+00  7.29125015e+00  7.29125015e+00
  1.38750863e+01  3.34805544e+01  3.34805544e+01  3.34805544e+01
  1.13708016e+02  1.29098584e+02  1.29098584e+02  1.29098584e+02
  4.83450605e+02  4.83450605e+02  4.83450605e+02  6.02507722e+02
  1.33519709e+03  1.33519709e+03  1.33519709e+03  2.67266264e+03
  3.02930195e+03  3.02930195e+03  3.02930195e+03  6.64964142e+03
  6.64964142e+03  6.64964142e+03  9.07718562e+03  2.54318464e+04
  7.61730675e+04]
E1 = -728.3002817787816  E_coul = 201.5612217848577
Extra cycle  E= -526.739059993924  delta_E= -1.25e-12  |g|= 1.45e-08  |ddm|= 1.2e-07
    CPU time for scf_cycle      1.06 sec, wall time      0.38 sec
exp = [2.61826593e+04 7.61751457e+03 3.61735450e+03 1.59767419e+03
 3.82731507e+02 1.10738283e+02 3.67814950e+01 8.83393359e+00
 3.37577046e+00 6.79189149e-01 2.50992419e-01 1.36278435e+03
 6.64734362e+02 3.00908607e+02 3.13996247e+02 6.16610735e+01
 7.36508910e+00 2.02319385e+01 7.75778427e-01 2.81100628e+00
 2.23076744e-01]
grad_E = [-1.53293369e-06  3.47655669e-06 -1.48439780e-06  7.54028067e-05
 -1.41457956e-04 -8.04479439e-04  4.66206913e-04  2.21740964e-03
 -2.76395624e-03  2.13573322e-03  4.19671262e-04 -5.23090953e-07
  4.78285438e-06  2.22676095e-05  1.92008536e-05  1.33789427e-04
  4.28641451e-03 -1.30285757e-03 -4.00283494e-03 -4.91376585e-03
  1.17037434e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6602735        1
[INPUT] 0    0    [1    /1   ]  7617.5123963         1
[INPUT] 0    0    [1    /1   ]  3617.3555498         1
[INPUT] 0    0    [1    /1   ]  1597.62904016        1
[INPUT] 0    0    [1    /1   ]  382.718992989        1
[INPUT] 0    0    [1    /1   ]  111.47320502         1
[INPUT] 0    0    [1    /1   ]  37.1743457241        1
[INPUT] 0    0    [1    /1   ]  8.6573450255         1
[INPUT] 0    0    [1    /1   ]  3.34356610698        1
[INPUT] 0    0    [1    /1   ]  0.683558416598       1
[INPUT] 0    0    [1    /1   ]  0.251523001901       1
[INPUT] 1    0    [1    /1   ]  1362.78468665        1
[INPUT] 1    0    [1    /1   ]  664.731069325        1
[INPUT] 1    0    [1    /1   ]  300.893084321        1
[INPUT] 1    0    [1    /1   ]  313.982863853        1
[INPUT] 1    0    [1    /1   ]  61.66868409          1
[INPUT] 1    0    [1    /1   ]  7.34916221998        1
[INPUT] 1    0    [1    /1   ]  20.250407046         1
[INPUT] 1    0    [1    /1   ]  0.774311598803       1
[INPUT] 1    0    [1    /1   ]  2.79397955295        1
[INPUT] 1    0    [1    /1   ]  0.22279549007        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.660273507634, 1.0]], [0, [7617.512396296865, 1.0]], [0, [3617.355549796543, 1.0]], [0, [1597.6290401565352, 1.0]], [0, [382.7189929888512, 1.0]], [0, [111.47320501962999, 1.0]], [0, [37.17434572408551, 1.0]], [0, [8.657345025502945, 1.0]], [0, [3.3435661069776956, 1.0]], [0, [0.6835584165981289, 1.0]], [0, [0.25152300190080834, 1.0]], [1, [1362.7846866549937, 1.0]], [1, [664.7310693248614, 1.0]], [1, [300.8930843206616, 1.0]], [1, [313.9828638532119, 1.0]], [1, [61.66868409003762, 1.0]], [1, [7.349162219978182, 1.0]], [1, [20.250407046034336, 1.0]], [1, [0.7743115988034284, 1.0]], [1, [2.7939795529530063, 1.0]], [1, [0.22279549006956345, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66027351]
bas 1, expnt(s) = [7617.5123963]
bas 2, expnt(s) = [3617.3555498]
bas 3, expnt(s) = [1597.62904016]
bas 4, expnt(s) = [382.71899299]
bas 5, expnt(s) = [111.47320502]
bas 6, expnt(s) = [37.17434572]
bas 7, expnt(s) = [8.65734503]
bas 8, expnt(s) = [3.34356611]
bas 9, expnt(s) = [0.68355842]
bas 10, expnt(s) = [0.251523]
bas 11, expnt(s) = [1362.78468665]
bas 12, expnt(s) = [664.73106932]
bas 13, expnt(s) = [300.89308432]
bas 14, expnt(s) = [313.98286385]
bas 15, expnt(s) = [61.66868409]
bas 16, expnt(s) = [7.34916222]
bas 17, expnt(s) = [20.25040705]
bas 18, expnt(s) = [0.7743116]
bas 19, expnt(s) = [2.79397955]
bas 20, expnt(s) = [0.22279549]
CPU time:       281.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826603e+04 5.20026353e+03 7.61751240e+03 2.06003643e+03
 3.61735555e+03 1.17844257e+03 1.59762904e+03 6.38442786e+02
 3.82718993e+02 2.18612523e+02 1.11473205e+02 8.66748084e+01
 3.71743457e+01 3.80362352e+01 8.65734503e+00 1.27512737e+01
 3.34356611e+00 6.24701372e+00 6.83558417e-01 1.89931392e+00
 2.51523002e-01 8.97321978e-01 1.36278469e+03 2.41556344e+04
 6.64731069e+02 9.84672627e+03 3.00893084e+02 3.65594497e+03
 3.13982864e+02 3.85582066e+03 6.16686841e+01 5.04156353e+02
 7.34916222e+00 3.53005673e+01 2.02504070e+01 1.25321790e+02
 7.74311599e-01 2.11899093e+00 2.79397955e+00 1.05381268e+01
 2.22795490e-01 4.46547217e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993493281931496
cond(S) = 103895.16107216348
E1 = -729.5326466364914  E_coul = 203.18078528301996
init E= -526.351861353471
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555740255481498  LUMO = 1.03189720137901
  mo_energy =
[-1.18328934e+02 -1.22045154e+01 -9.44661529e+00 -9.44661529e+00
 -9.44661529e+00 -1.23986361e+00 -5.55740255e-01 -5.55740255e-01
 -5.55740255e-01  1.03189720e+00  1.03189720e+00  1.03189720e+00
  1.07812171e+00  7.32139484e+00  7.32139484e+00  7.32139484e+00
  1.37251727e+01  3.35081654e+01  3.35081654e+01  3.35081654e+01
  1.14132501e+02  1.29219009e+02  1.29219009e+02  1.29219009e+02
  4.83674983e+02  4.83674983e+02  4.83674983e+02  6.05273434e+02
  1.33545569e+03  1.33545569e+03  1.33545569e+03  2.67641869e+03
  3.02958713e+03  3.02958713e+03  3.02958713e+03  6.65001242e+03
  6.65001242e+03  6.65001242e+03  9.08095564e+03  2.54355349e+04
  7.61766285e+04]
E1 = -727.856008263693  E_coul = 201.1172013863695
cycle= 1 E= -526.738806877323  delta_E= -0.387  |g|= 0.186  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540638
diis-c [-0.29228981  1.        ]
  HOMO = -0.59029763413158  LUMO = 1.00789396446522
  mo_energy =
[-1.18635573e+02 -1.23418512e+01 -9.59465480e+00 -9.59465480e+00
 -9.59465480e+00 -1.27901235e+00 -5.90297634e-01 -5.90297634e-01
 -5.90297634e-01  1.00789396e+00  1.00789396e+00  1.00789396e+00
  1.04846638e+00  7.23115110e+00  7.23115110e+00  7.23115110e+00
  1.36114952e+01  3.33545671e+01  3.33545671e+01  3.33545671e+01
  1.13909977e+02  1.28991449e+02  1.28991449e+02  1.28991449e+02
  4.83369569e+02  4.83369569e+02  4.83369569e+02  6.04929841e+02
  1.33509442e+03  1.33509442e+03  1.33509442e+03  2.67592402e+03
  3.02916015e+03  3.02916015e+03  3.02916015e+03  6.64947260e+03
  6.64947260e+03  6.64947260e+03  9.08034092e+03  2.54348262e+04
  7.61758299e+04]
E1 = -728.4271584827653  E_coul = 201.68763919107118
cycle= 2 E= -526.739519291694  delta_E= -0.000712  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747477
diis-c [-0.00330372  0.08163516  0.91836484]
  HOMO = -0.581218711839598  LUMO = 1.01457506570112
  mo_energy =
[-1.18568154e+02 -1.23039602e+01 -9.55511799e+00 -9.55511799e+00
 -9.55511799e+00 -1.26814328e+00 -5.81218712e-01 -5.81218712e-01
 -5.81218712e-01  1.01457507e+00  1.01457507e+00  1.01457507e+00
  1.05699417e+00  7.25475222e+00  7.25475222e+00  7.25475222e+00
  1.36425610e+01  3.33944873e+01  3.33944873e+01  3.33944873e+01
  1.13965977e+02  1.29047114e+02  1.29047114e+02  1.29047114e+02
  4.83436176e+02  4.83436176e+02  4.83436176e+02  6.04998846e+02
  1.33516506e+03  1.33516506e+03  1.33516506e+03  2.67599797e+03
  3.02923303e+03  3.02923303e+03  3.02923303e+03  6.64954722e+03
  6.64954722e+03  6.64954722e+03  9.08041636e+03  2.54349023e+04
  7.61759062e+04]
E1 = -728.277435988653  E_coul = 201.53785834517933
cycle= 3 E= -526.739577643474  delta_E= -5.84e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131748
diis-c [-5.61856453e-07 -1.24012253e-03  1.45448431e-01  8.55791692e-01]
  HOMO = -0.582715124575401  LUMO = 1.01349748103135
  mo_energy =
[-1.18578127e+02 -1.23097720e+01 -9.56127618e+00 -9.56127618e+00
 -9.56127618e+00 -1.26983516e+00 -5.82715125e-01 -5.82715125e-01
 -5.82715125e-01  1.01349748e+00  1.01349748e+00  1.01349748e+00
  1.05568597e+00  7.25098304e+00  7.25098304e+00  7.25098304e+00
  1.36377715e+01  3.33883087e+01  3.33883087e+01  3.33883087e+01
  1.13957618e+02  1.29038754e+02  1.29038754e+02  1.29038754e+02
  4.83426319e+02  4.83426319e+02  4.83426319e+02  6.04988629e+02
  1.33515461e+03  1.33515461e+03  1.33515461e+03  2.67598690e+03
  3.02922220e+03  3.02922220e+03  3.02922220e+03  6.64953600e+03
  6.64953600e+03  6.64953600e+03  9.08040493e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3002569236833  E_coul = 201.5606773540829
cycle= 4 E= -526.7395795696  delta_E= -1.93e-06  |g|= 9.56e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000111703
diis-c [-3.95767305e-09  7.05891672e-05 -1.01262240e-02 -6.53871208e-02
  1.07544276e+00]
  HOMO = -0.582696984713335  LUMO = 1.01351301419549
  mo_energy =
[-1.18578089e+02 -1.23097090e+01 -9.56122654e+00 -9.56122654e+00
 -9.56122654e+00 -1.26979516e+00 -5.82696985e-01 -5.82696985e-01
 -5.82696985e-01  1.01351301e+00  1.01351301e+00  1.01351301e+00
  1.05572034e+00  7.25102366e+00  7.25102366e+00  7.25102366e+00
  1.36378298e+01  3.33883563e+01  3.33883563e+01  3.33883563e+01
  1.13957668e+02  1.29038800e+02  1.29038800e+02  1.29038800e+02
  4.83426357e+02  4.83426357e+02  4.83426357e+02  6.04988660e+02
  1.33515464e+03  1.33515464e+03  1.33515464e+03  2.67598691e+03
  3.02922222e+03  3.02922222e+03  3.02922222e+03  6.64953601e+03
  6.64953601e+03  6.64953601e+03  9.08040493e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3000532991609  E_coul = 201.5604737279923
cycle= 5 E= -526.739579571169  delta_E= -1.57e-09  |g|= 2.01e-05  |ddm|= 0.000152
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.81369e-05
diis-c [-6.88575397e-11  1.41664738e-05 -1.85125268e-03 -1.37542275e-02
  4.27445074e-02  9.72846806e-01]
  HOMO = -0.582704162211097  LUMO = 1.01350826723834
  mo_energy =
[-1.18578119e+02 -1.23097309e+01 -9.56125032e+00 -9.56125032e+00
 -9.56125032e+00 -1.26980089e+00 -5.82704162e-01 -5.82704162e-01
 -5.82704162e-01  1.01350827e+00  1.01350827e+00  1.01350827e+00
  1.05571633e+00  7.25100761e+00  7.25100761e+00  7.25100761e+00
  1.36378116e+01  3.33883332e+01  3.33883332e+01  3.33883332e+01
  1.13957641e+02  1.29038773e+02  1.29038773e+02  1.29038773e+02
  4.83426328e+02  4.83426328e+02  4.83426328e+02  6.04988630e+02
  1.33515461e+03  1.33515461e+03  1.33515461e+03  2.67598688e+03
  3.02922219e+03  3.02922219e+03  3.02922219e+03  6.64953598e+03
  6.64953598e+03  6.64953598e+03  9.08040489e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3001329960462  E_coul = 201.5605534248234
cycle= 6 E= -526.739579571223  delta_E= -5.41e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3001329960462  E_coul = 201.5605534248234
  HOMO = -0.582704175544865  LUMO = 1.01350831219685
  mo_energy =
[-1.18578118e+02 -1.23097308e+01 -9.56125026e+00 -9.56125026e+00
 -9.56125026e+00 -1.26980053e+00 -5.82704176e-01 -5.82704176e-01
 -5.82704176e-01  1.01350831e+00  1.01350831e+00  1.01350831e+00
  1.05571667e+00  7.25100766e+00  7.25100766e+00  7.25100766e+00
  1.36378118e+01  3.33883333e+01  3.33883333e+01  3.33883333e+01
  1.13957641e+02  1.29038773e+02  1.29038773e+02  1.29038773e+02
  4.83426328e+02  4.83426328e+02  4.83426328e+02  6.04988630e+02
  1.33515461e+03  1.33515461e+03  1.33515461e+03  2.67598688e+03
  3.02922219e+03  3.02922219e+03  3.02922219e+03  6.64953598e+03
  6.64953598e+03  6.64953598e+03  9.08040489e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3001321169531  E_coul = 201.56055254572863
Extra cycle  E= -526.739579571225  delta_E= -1.82e-12  |g|= 3.45e-07  |ddm|= 2.91e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826603e+04 7.61751240e+03 3.61735555e+03 1.59762904e+03
 3.82718993e+02 1.11473205e+02 3.71743457e+01 8.65734503e+00
 3.34356611e+00 6.83558417e-01 2.51523002e-01 1.36278469e+03
 6.64731069e+02 3.00893084e+02 3.13982864e+02 6.16686841e+01
 7.34916222e+00 2.02504070e+01 7.74311599e-01 2.79397955e+00
 2.22795490e-01]
E = -526.7395795712246
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6602735        1
[INPUT] 0    0    [1    /1   ]  7617.5123963         1
[INPUT] 0    0    [1    /1   ]  3617.3555498         1
[INPUT] 0    0    [1    /1   ]  1597.62904016        1
[INPUT] 0    0    [1    /1   ]  382.718992989        1
[INPUT] 0    0    [1    /1   ]  111.47320502         1
[INPUT] 0    0    [1    /1   ]  37.1743457241        1
[INPUT] 0    0    [1    /1   ]  8.6573450255         1
[INPUT] 0    0    [1    /1   ]  3.34356610698        1
[INPUT] 0    0    [1    /1   ]  0.683558416598       1
[INPUT] 0    0    [1    /1   ]  0.251523001901       1
[INPUT] 1    0    [1    /1   ]  1362.78468665        1
[INPUT] 1    0    [1    /1   ]  664.731069325        1
[INPUT] 1    0    [1    /1   ]  300.893084321        1
[INPUT] 1    0    [1    /1   ]  313.982863853        1
[INPUT] 1    0    [1    /1   ]  61.66868409          1
[INPUT] 1    0    [1    /1   ]  7.34916221998        1
[INPUT] 1    0    [1    /1   ]  20.250407046         1
[INPUT] 1    0    [1    /1   ]  0.774311598803       1
[INPUT] 1    0    [1    /1   ]  2.79397955295        1
[INPUT] 1    0    [1    /1   ]  0.22279549007        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.660273507634, 1.0]], [0, [7617.512396296865, 1.0]], [0, [3617.355549796543, 1.0]], [0, [1597.6290401565352, 1.0]], [0, [382.7189929888512, 1.0]], [0, [111.47320501962999, 1.0]], [0, [37.17434572408551, 1.0]], [0, [8.657345025502945, 1.0]], [0, [3.3435661069776956, 1.0]], [0, [0.6835584165981289, 1.0]], [0, [0.25152300190080834, 1.0]], [1, [1362.7846866549937, 1.0]], [1, [664.7310693248614, 1.0]], [1, [300.8930843206616, 1.0]], [1, [313.9828638532119, 1.0]], [1, [61.66868409003762, 1.0]], [1, [7.349162219978182, 1.0]], [1, [20.250407046034336, 1.0]], [1, [0.7743115988034284, 1.0]], [1, [2.7939795529530063, 1.0]], [1, [0.22279549006956345, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66027351]
bas 1, expnt(s) = [7617.5123963]
bas 2, expnt(s) = [3617.3555498]
bas 3, expnt(s) = [1597.62904016]
bas 4, expnt(s) = [382.71899299]
bas 5, expnt(s) = [111.47320502]
bas 6, expnt(s) = [37.17434572]
bas 7, expnt(s) = [8.65734503]
bas 8, expnt(s) = [3.34356611]
bas 9, expnt(s) = [0.68355842]
bas 10, expnt(s) = [0.251523]
bas 11, expnt(s) = [1362.78468665]
bas 12, expnt(s) = [664.73106932]
bas 13, expnt(s) = [300.89308432]
bas 14, expnt(s) = [313.98286385]
bas 15, expnt(s) = [61.66868409]
bas 16, expnt(s) = [7.34916222]
bas 17, expnt(s) = [20.25040705]
bas 18, expnt(s) = [0.7743116]
bas 19, expnt(s) = [2.79397955]
bas 20, expnt(s) = [0.22279549]
CPU time:       281.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826603e+04 5.20026353e+03 7.61751240e+03 2.06003643e+03
 3.61735555e+03 1.17844257e+03 1.59762904e+03 6.38442786e+02
 3.82718993e+02 2.18612523e+02 1.11473205e+02 8.66748084e+01
 3.71743457e+01 3.80362352e+01 8.65734503e+00 1.27512737e+01
 3.34356611e+00 6.24701372e+00 6.83558417e-01 1.89931392e+00
 2.51523002e-01 8.97321978e-01 1.36278469e+03 2.41556344e+04
 6.64731069e+02 9.84672627e+03 3.00893084e+02 3.65594497e+03
 3.13982864e+02 3.85582066e+03 6.16686841e+01 5.04156353e+02
 7.34916222e+00 3.53005673e+01 2.02504070e+01 1.25321790e+02
 7.74311599e-01 2.11899093e+00 2.79397955e+00 1.05381268e+01
 2.22795490e-01 4.46547217e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993493281931496
cond(S) = 103895.16107216348
E1 = -729.5326466364914  E_coul = 203.18078528301996
init E= -526.351861353471
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555740255481498  LUMO = 1.03189720137901
  mo_energy =
[-1.18328934e+02 -1.22045154e+01 -9.44661529e+00 -9.44661529e+00
 -9.44661529e+00 -1.23986361e+00 -5.55740255e-01 -5.55740255e-01
 -5.55740255e-01  1.03189720e+00  1.03189720e+00  1.03189720e+00
  1.07812171e+00  7.32139484e+00  7.32139484e+00  7.32139484e+00
  1.37251727e+01  3.35081654e+01  3.35081654e+01  3.35081654e+01
  1.14132501e+02  1.29219009e+02  1.29219009e+02  1.29219009e+02
  4.83674983e+02  4.83674983e+02  4.83674983e+02  6.05273434e+02
  1.33545569e+03  1.33545569e+03  1.33545569e+03  2.67641869e+03
  3.02958713e+03  3.02958713e+03  3.02958713e+03  6.65001242e+03
  6.65001242e+03  6.65001242e+03  9.08095564e+03  2.54355349e+04
  7.61766285e+04]
E1 = -727.856008263693  E_coul = 201.1172013863695
cycle= 1 E= -526.738806877323  delta_E= -0.387  |g|= 0.186  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540638
diis-c [-0.29228981  1.        ]
  HOMO = -0.59029763413158  LUMO = 1.00789396446522
  mo_energy =
[-1.18635573e+02 -1.23418512e+01 -9.59465480e+00 -9.59465480e+00
 -9.59465480e+00 -1.27901235e+00 -5.90297634e-01 -5.90297634e-01
 -5.90297634e-01  1.00789396e+00  1.00789396e+00  1.00789396e+00
  1.04846638e+00  7.23115110e+00  7.23115110e+00  7.23115110e+00
  1.36114952e+01  3.33545671e+01  3.33545671e+01  3.33545671e+01
  1.13909977e+02  1.28991449e+02  1.28991449e+02  1.28991449e+02
  4.83369569e+02  4.83369569e+02  4.83369569e+02  6.04929841e+02
  1.33509442e+03  1.33509442e+03  1.33509442e+03  2.67592402e+03
  3.02916015e+03  3.02916015e+03  3.02916015e+03  6.64947260e+03
  6.64947260e+03  6.64947260e+03  9.08034092e+03  2.54348262e+04
  7.61758299e+04]
E1 = -728.4271584827653  E_coul = 201.68763919107118
cycle= 2 E= -526.739519291694  delta_E= -0.000712  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747477
diis-c [-0.00330372  0.08163516  0.91836484]
  HOMO = -0.581218711839598  LUMO = 1.01457506570112
  mo_energy =
[-1.18568154e+02 -1.23039602e+01 -9.55511799e+00 -9.55511799e+00
 -9.55511799e+00 -1.26814328e+00 -5.81218712e-01 -5.81218712e-01
 -5.81218712e-01  1.01457507e+00  1.01457507e+00  1.01457507e+00
  1.05699417e+00  7.25475222e+00  7.25475222e+00  7.25475222e+00
  1.36425610e+01  3.33944873e+01  3.33944873e+01  3.33944873e+01
  1.13965977e+02  1.29047114e+02  1.29047114e+02  1.29047114e+02
  4.83436176e+02  4.83436176e+02  4.83436176e+02  6.04998846e+02
  1.33516506e+03  1.33516506e+03  1.33516506e+03  2.67599797e+03
  3.02923303e+03  3.02923303e+03  3.02923303e+03  6.64954722e+03
  6.64954722e+03  6.64954722e+03  9.08041636e+03  2.54349023e+04
  7.61759062e+04]
E1 = -728.277435988653  E_coul = 201.53785834517933
cycle= 3 E= -526.739577643474  delta_E= -5.84e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131748
diis-c [-5.61856453e-07 -1.24012253e-03  1.45448431e-01  8.55791692e-01]
  HOMO = -0.582715124575401  LUMO = 1.01349748103135
  mo_energy =
[-1.18578127e+02 -1.23097720e+01 -9.56127618e+00 -9.56127618e+00
 -9.56127618e+00 -1.26983516e+00 -5.82715125e-01 -5.82715125e-01
 -5.82715125e-01  1.01349748e+00  1.01349748e+00  1.01349748e+00
  1.05568597e+00  7.25098304e+00  7.25098304e+00  7.25098304e+00
  1.36377715e+01  3.33883087e+01  3.33883087e+01  3.33883087e+01
  1.13957618e+02  1.29038754e+02  1.29038754e+02  1.29038754e+02
  4.83426319e+02  4.83426319e+02  4.83426319e+02  6.04988629e+02
  1.33515461e+03  1.33515461e+03  1.33515461e+03  2.67598690e+03
  3.02922220e+03  3.02922220e+03  3.02922220e+03  6.64953600e+03
  6.64953600e+03  6.64953600e+03  9.08040493e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3002569236833  E_coul = 201.5606773540829
cycle= 4 E= -526.7395795696  delta_E= -1.93e-06  |g|= 9.56e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000111703
diis-c [-3.95767305e-09  7.05891672e-05 -1.01262240e-02 -6.53871208e-02
  1.07544276e+00]
  HOMO = -0.582696984713335  LUMO = 1.01351301419549
  mo_energy =
[-1.18578089e+02 -1.23097090e+01 -9.56122654e+00 -9.56122654e+00
 -9.56122654e+00 -1.26979516e+00 -5.82696985e-01 -5.82696985e-01
 -5.82696985e-01  1.01351301e+00  1.01351301e+00  1.01351301e+00
  1.05572034e+00  7.25102366e+00  7.25102366e+00  7.25102366e+00
  1.36378298e+01  3.33883563e+01  3.33883563e+01  3.33883563e+01
  1.13957668e+02  1.29038800e+02  1.29038800e+02  1.29038800e+02
  4.83426357e+02  4.83426357e+02  4.83426357e+02  6.04988660e+02
  1.33515464e+03  1.33515464e+03  1.33515464e+03  2.67598691e+03
  3.02922222e+03  3.02922222e+03  3.02922222e+03  6.64953601e+03
  6.64953601e+03  6.64953601e+03  9.08040493e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3000532991609  E_coul = 201.5604737279923
cycle= 5 E= -526.739579571169  delta_E= -1.57e-09  |g|= 2.01e-05  |ddm|= 0.000152
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.81369e-05
diis-c [-6.88575397e-11  1.41664738e-05 -1.85125268e-03 -1.37542275e-02
  4.27445074e-02  9.72846806e-01]
  HOMO = -0.582704162211097  LUMO = 1.01350826723834
  mo_energy =
[-1.18578119e+02 -1.23097309e+01 -9.56125032e+00 -9.56125032e+00
 -9.56125032e+00 -1.26980089e+00 -5.82704162e-01 -5.82704162e-01
 -5.82704162e-01  1.01350827e+00  1.01350827e+00  1.01350827e+00
  1.05571633e+00  7.25100761e+00  7.25100761e+00  7.25100761e+00
  1.36378116e+01  3.33883332e+01  3.33883332e+01  3.33883332e+01
  1.13957641e+02  1.29038773e+02  1.29038773e+02  1.29038773e+02
  4.83426328e+02  4.83426328e+02  4.83426328e+02  6.04988630e+02
  1.33515461e+03  1.33515461e+03  1.33515461e+03  2.67598688e+03
  3.02922219e+03  3.02922219e+03  3.02922219e+03  6.64953598e+03
  6.64953598e+03  6.64953598e+03  9.08040489e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3001329960462  E_coul = 201.5605534248234
cycle= 6 E= -526.739579571223  delta_E= -5.41e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3001329960462  E_coul = 201.5605534248234
  HOMO = -0.582704175544865  LUMO = 1.01350831219685
  mo_energy =
[-1.18578118e+02 -1.23097308e+01 -9.56125026e+00 -9.56125026e+00
 -9.56125026e+00 -1.26980053e+00 -5.82704176e-01 -5.82704176e-01
 -5.82704176e-01  1.01350831e+00  1.01350831e+00  1.01350831e+00
  1.05571667e+00  7.25100766e+00  7.25100766e+00  7.25100766e+00
  1.36378118e+01  3.33883333e+01  3.33883333e+01  3.33883333e+01
  1.13957641e+02  1.29038773e+02  1.29038773e+02  1.29038773e+02
  4.83426328e+02  4.83426328e+02  4.83426328e+02  6.04988630e+02
  1.33515461e+03  1.33515461e+03  1.33515461e+03  2.67598688e+03
  3.02922219e+03  3.02922219e+03  3.02922219e+03  6.64953598e+03
  6.64953598e+03  6.64953598e+03  9.08040489e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3001321169531  E_coul = 201.56055254572863
Extra cycle  E= -526.739579571225  delta_E= -1.82e-12  |g|= 3.45e-07  |ddm|= 2.91e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103895.16107216348
E1 = -728.3001321169531  E_coul = 201.56055254572863
init E= -526.739579571225
    CPU time for initialize scf      0.93 sec, wall time      0.25 sec
  HOMO = -0.582704202706126  LUMO = 1.01350830419957
  mo_energy =
[-1.18578119e+02 -1.23097309e+01 -9.56125034e+00 -9.56125034e+00
 -9.56125034e+00 -1.26980049e+00 -5.82704203e-01 -5.82704203e-01
 -5.82704203e-01  1.01350830e+00  1.01350830e+00  1.01350830e+00
  1.05571671e+00  7.25100761e+00  7.25100761e+00  7.25100761e+00
  1.36378118e+01  3.33883332e+01  3.33883332e+01  3.33883332e+01
  1.13957641e+02  1.29038773e+02  1.29038773e+02  1.29038773e+02
  4.83426328e+02  4.83426328e+02  4.83426328e+02  6.04988630e+02
  1.33515461e+03  1.33515461e+03  1.33515461e+03  2.67598688e+03
  3.02922219e+03  3.02922219e+03  3.02922219e+03  6.64953598e+03
  6.64953598e+03  6.64953598e+03  9.08040489e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.300132272397  E_coul = 201.5605527011737
cycle= 1 E= -526.739579571223  delta_E= 1.25e-12  |g|= 7.18e-08  |ddm|= 5.67e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.300132272397  E_coul = 201.5605527011737
  HOMO = -0.582704201939513  LUMO = 1.01350830709696
  mo_energy =
[-1.18578119e+02 -1.23097308e+01 -9.56125033e+00 -9.56125033e+00
 -9.56125033e+00 -1.26980047e+00 -5.82704202e-01 -5.82704202e-01
 -5.82704202e-01  1.01350831e+00  1.01350831e+00  1.01350831e+00
  1.05571673e+00  7.25100761e+00  7.25100761e+00  7.25100761e+00
  1.36378118e+01  3.33883332e+01  3.33883332e+01  3.33883332e+01
  1.13957641e+02  1.29038773e+02  1.29038773e+02  1.29038773e+02
  4.83426328e+02  4.83426328e+02  4.83426328e+02  6.04988630e+02
  1.33515461e+03  1.33515461e+03  1.33515461e+03  2.67598688e+03
  3.02922219e+03  3.02922219e+03  3.02922219e+03  6.64953598e+03
  6.64953598e+03  6.64953598e+03  9.08040489e+03  2.54348906e+04
  7.61758944e+04]
E1 = -728.3001322097589  E_coul = 201.56055263853483
Extra cycle  E= -526.739579571224  delta_E= -7.96e-13  |g|= 1.44e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826603e+04 7.61751240e+03 3.61735555e+03 1.59762904e+03
 3.82718993e+02 1.11473205e+02 3.71743457e+01 8.65734503e+00
 3.34356611e+00 6.83558417e-01 2.51523002e-01 1.36278469e+03
 6.64731069e+02 3.00893084e+02 3.13982864e+02 6.16686841e+01
 7.34916222e+00 2.02504070e+01 7.74311599e-01 2.79397955e+00
 2.22795490e-01]
grad_E = [-1.53827460e-06  3.53757526e-06 -1.44405367e-06  7.76468160e-05
 -1.88074477e-04 -7.67163515e-04  1.06518677e-03  1.71340996e-03
 -2.87838080e-03  2.70243093e-03 -1.52416043e-04 -5.17994503e-07
  4.85696192e-06  2.27198974e-05  1.95877949e-05  8.12063239e-05
  4.11212755e-03 -9.82630578e-04 -4.44907538e-03 -5.81092865e-03
  1.31074326e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6611931        1
[INPUT] 0    0    [1    /1   ]  7617.51040076        1
[INPUT] 0    0    [1    /1   ]  3617.35651299        1
[INPUT] 0    0    [1    /1   ]  1597.58753062        1
[INPUT] 0    0    [1    /1   ]  382.7050641          1
[INPUT] 0    0    [1    /1   ]  112.18970476         1
[INPUT] 0    0    [1    /1   ]  37.4089181712        1
[INPUT] 0    0    [1    /1   ]  8.36631245475        1
[INPUT] 0    0    [1    /1   ]  3.28323995207        1
[INPUT] 0    0    [1    /1   ]  0.679845095862       1
[INPUT] 0    0    [1    /1   ]  0.249038622006       1
[INPUT] 1    0    [1    /1   ]  1362.78499449        1
[INPUT] 1    0    [1    /1   ]  664.728038113        1
[INPUT] 1    0    [1    /1   ]  300.878793605        1
[INPUT] 1    0    [1    /1   ]  313.970542925        1
[INPUT] 1    0    [1    /1   ]  61.6764426946        1
[INPUT] 1    0    [1    /1   ]  7.33789495377        1
[INPUT] 1    0    [1    /1   ]  20.2623110938        1
[INPUT] 1    0    [1    /1   ]  0.77419865894        1
[INPUT] 1    0    [1    /1   ]  2.79326502458        1
[INPUT] 1    0    [1    /1   ]  0.222640881603       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661193076394, 1.0]], [0, [7617.510400761931, 1.0]], [0, [3617.3565129900358, 1.0]], [0, [1597.587530618164, 1.0]], [0, [382.70506409970915, 1.0]], [0, [112.18970476009066, 1.0]], [0, [37.40891817115701, 1.0]], [0, [8.366312454749794, 1.0]], [0, [3.283239952065497, 1.0]], [0, [0.6798450958622685, 1.0]], [0, [0.24903862200560942, 1.0]], [1, [1362.7849944920408, 1.0]], [1, [664.7280381129469, 1.0]], [1, [300.878793605478, 1.0]], [1, [313.970542925011, 1.0]], [1, [61.6764426945958, 1.0]], [1, [7.337894953774522, 1.0]], [1, [20.262311093846627, 1.0]], [1, [0.774198658939571, 1.0]], [1, [2.7932650245837816, 1.0]], [1, [0.22264088160328913, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66119308]
bas 1, expnt(s) = [7617.51040076]
bas 2, expnt(s) = [3617.35651299]
bas 3, expnt(s) = [1597.58753062]
bas 4, expnt(s) = [382.7050641]
bas 5, expnt(s) = [112.18970476]
bas 6, expnt(s) = [37.40891817]
bas 7, expnt(s) = [8.36631245]
bas 8, expnt(s) = [3.28323995]
bas 9, expnt(s) = [0.6798451]
bas 10, expnt(s) = [0.24903862]
bas 11, expnt(s) = [1362.78499449]
bas 12, expnt(s) = [664.72803811]
bas 13, expnt(s) = [300.87879361]
bas 14, expnt(s) = [313.97054293]
bas 15, expnt(s) = [61.67644269]
bas 16, expnt(s) = [7.33789495]
bas 17, expnt(s) = [20.26231109]
bas 18, expnt(s) = [0.77419866]
bas 19, expnt(s) = [2.79326502]
bas 20, expnt(s) = [0.22264088]
CPU time:       287.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826612e+04 5.20026366e+03 7.61751040e+03 2.06003603e+03
 3.61735651e+03 1.17844281e+03 1.59758753e+03 6.38430345e+02
 3.82705064e+02 2.18606555e+02 1.12189705e+02 8.70923037e+01
 3.74089182e+01 3.82161019e+01 8.36631245e+00 1.24284104e+01
 3.28323995e+00 6.16228801e+00 6.79845096e-01 1.89157036e+00
 2.49038622e-01 8.90666366e-01 1.36278499e+03 2.41556413e+04
 6.64728038e+02 9.84667014e+03 3.00878794e+02 3.65572793e+03
 3.13970543e+02 3.85563152e+03 6.16764427e+01 5.04235640e+02
 7.33789495e+00 3.52329295e+01 2.02623111e+01 1.25413884e+02
 7.74198659e-01 2.11860460e+00 2.79326502e+00 1.05347582e+01
 2.22640882e-01 4.46159900e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99355761964152
cond(S) = 103766.23944522756
E1 = -729.5315797380824  E_coul = 203.1797632982192
init E= -526.351816439863
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555755022991706  LUMO = 1.03122600562738
  mo_energy =
[-1.18328913e+02 -1.22048937e+01 -9.44670532e+00 -9.44670532e+00
 -9.44670532e+00 -1.23992927e+00 -5.55755023e-01 -5.55755023e-01
 -5.55755023e-01  1.03122601e+00  1.03122601e+00  1.03122601e+00
  1.06144300e+00  7.31572115e+00  7.31572115e+00  7.31572115e+00
  1.32240874e+01  3.34857934e+01  3.34857934e+01  3.34857934e+01
  1.13445314e+02  1.29216262e+02  1.29216262e+02  1.29216262e+02
  4.83689836e+02  4.83689836e+02  4.83689836e+02  6.06533572e+02
  1.33544846e+03  1.33544846e+03  1.33544846e+03  2.67857991e+03
  3.02954279e+03  3.02954279e+03  3.02954279e+03  6.64994158e+03
  6.64994158e+03  6.64994158e+03  9.08309854e+03  2.54375614e+04
  7.61785083e+04]
E1 = -727.8528748655878  E_coul = 201.1136172405411
cycle= 1 E= -526.739257625047  delta_E= -0.387  |g|= 0.186  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540745
diis-c [-0.29240477  1.        ]
  HOMO = -0.59046072605148  LUMO = 1.00712177418581
  mo_energy =
[-1.18635785e+02 -1.23423524e+01 -9.59485926e+00 -9.59485926e+00
 -9.59485926e+00 -1.27921617e+00 -5.90460726e-01 -5.90460726e-01
 -5.90460726e-01  1.00712177e+00  1.00712177e+00  1.00712177e+00
  1.03209636e+00  7.22537486e+00  7.22537486e+00  7.22537486e+00
  1.31120125e+01  3.33320619e+01  3.33320619e+01  3.33320619e+01
  1.13222396e+02  1.28988497e+02  1.28988497e+02  1.28988497e+02
  4.83384295e+02  4.83384295e+02  4.83384295e+02  6.06189593e+02
  1.33508708e+03  1.33508708e+03  1.33508708e+03  2.67808535e+03
  3.02911586e+03  3.02911586e+03  3.02911586e+03  6.64940187e+03
  6.64940187e+03  6.64940187e+03  9.08248399e+03  2.54368529e+04
  7.61777098e+04]
E1 = -728.4250345453892  E_coul = 201.68506250147018
cycle= 2 E= -526.739972043919  delta_E= -0.000714  |g|= 0.0375  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748316
diis-c [-0.0033054  0.0817986  0.9182014]
  HOMO = -0.581366504001223  LUMO = 1.01381257467777
  mo_energy =
[-1.18568277e+02 -1.23044003e+01 -9.55525506e+00 -9.55525506e+00
 -9.55525506e+00 -1.26832866e+00 -5.81366504e-01 -5.81366504e-01
 -5.81366504e-01  1.01381257e+00  1.01381257e+00  1.01381257e+00
  1.04052384e+00  7.24900620e+00  7.24900620e+00  7.24900620e+00
  1.31426696e+01  3.33720438e+01  3.33720438e+01  3.33720438e+01
  1.13278547e+02  1.29044247e+02  1.29044247e+02  1.29044247e+02
  4.83450990e+02  4.83450990e+02  4.83450990e+02  6.06258716e+02
  1.33515781e+03  1.33515781e+03  1.33515781e+03  2.67815940e+03
  3.02918883e+03  3.02918883e+03  3.02918883e+03  6.64947659e+03
  6.64947659e+03  6.64947659e+03  9.08255952e+03  2.54369290e+04
  7.61777862e+04]
E1 = -728.2750012390756  E_coul = 201.5349706226691
cycle= 3 E= -526.740030616406  delta_E= -5.86e-05  |g|= 0.0063  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131792
diis-c [-5.62240254e-07 -1.23627341e-03  1.45358994e-01  8.55877280e-01]
  HOMO = -0.582865973535324  LUMO = 1.01273324808716
  mo_energy =
[-1.18578259e+02 -1.23102200e+01 -9.56142120e+00 -9.56142120e+00
 -9.56142120e+00 -1.27002292e+00 -5.82865974e-01 -5.82865974e-01
 -5.82865974e-01  1.01273325e+00  1.01273325e+00  1.01273325e+00
  1.03923161e+00  7.24523290e+00  7.24523290e+00  7.24523290e+00
  1.31379415e+01  3.33658583e+01  3.33658583e+01  3.33658583e+01
  1.13270172e+02  1.29035878e+02  1.29035878e+02  1.29035878e+02
  4.83441124e+02  4.83441124e+02  4.83441124e+02  6.06248486e+02
  1.33514736e+03  1.33514736e+03  1.33514736e+03  2.67814832e+03
  3.02917799e+03  3.02917799e+03  3.02917799e+03  6.64946536e+03
  6.64946536e+03  6.64946536e+03  9.08254808e+03  2.54369174e+04
  7.61777745e+04]
E1 = -728.2978574546956  E_coul = 201.5578249067821
cycle= 4 E= -526.740032547914  delta_E= -1.93e-06  |g|= 9.64e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000111644
diis-c [-3.98647215e-09  7.12941626e-05 -1.02233384e-02 -6.59572846e-02
  1.07610933e+00]
  HOMO = -0.582847822315894  LUMO = 1.01274882579672
  mo_energy =
[-1.18578220e+02 -1.23101567e+01 -9.56137126e+00 -9.56137126e+00
 -9.56137126e+00 -1.26998261e+00 -5.82847822e-01 -5.82847822e-01
 -5.82847822e-01  1.01274883e+00  1.01274883e+00  1.01274883e+00
  1.03926590e+00  7.24527369e+00  7.24527369e+00  7.24527369e+00
  1.31380000e+01  3.33659063e+01  3.33659063e+01  3.33659063e+01
  1.13270222e+02  1.29035924e+02  1.29035924e+02  1.29035924e+02
  4.83441164e+02  4.83441164e+02  4.83441164e+02  6.06248518e+02
  1.33514739e+03  1.33514739e+03  1.33514739e+03  2.67814833e+03
  3.02917801e+03  3.02917801e+03  3.02917801e+03  6.64946536e+03
  6.64946536e+03  6.64946536e+03  9.08254808e+03  2.54369174e+04
  7.61777744e+04]
E1 = -728.2976512261483  E_coul = 201.55761867661988
cycle= 5 E= -526.740032549528  delta_E= -1.61e-09  |g|= 2.02e-05  |ddm|= 0.000154
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83418e-05
diis-c [-7.00991266e-11  1.43228385e-05 -1.87137200e-03 -1.38892887e-02
  4.21617153e-02  9.73584623e-01]
  HOMO = -0.582855064667297  LUMO = 1.0127440392888
  mo_energy =
[-1.18578250e+02 -1.23101788e+01 -9.56139520e+00 -9.56139520e+00
 -9.56139520e+00 -1.26998837e+00 -5.82855065e-01 -5.82855065e-01
 -5.82855065e-01  1.01274404e+00  1.01274404e+00  1.01274404e+00
  1.03926193e+00  7.24525753e+00  7.24525753e+00  7.24525753e+00
  1.31379819e+01  3.33658830e+01  3.33658830e+01  3.33658830e+01
  1.13270195e+02  1.29035897e+02  1.29035897e+02  1.29035897e+02
  4.83441134e+02  4.83441134e+02  4.83441134e+02  6.06248487e+02
  1.33514736e+03  1.33514736e+03  1.33514736e+03  2.67814830e+03
  3.02917798e+03  3.02917798e+03  3.02917798e+03  6.64946533e+03
  6.64946533e+03  6.64946533e+03  9.08254805e+03  2.54369174e+04
  7.61777744e+04]
E1 = -728.2977313364436  E_coul = 201.55769878685865
cycle= 6 E= -526.740032549585  delta_E= -5.65e-11  |g|= 1.69e-06  |ddm|= 1.8e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2977313364436  E_coul = 201.55769878685865
  HOMO = -0.582855078593877  LUMO = 1.01274408399821
  mo_energy =
[-1.18578250e+02 -1.23101786e+01 -9.56139514e+00 -9.56139514e+00
 -9.56139514e+00 -1.26998801e+00 -5.82855079e-01 -5.82855079e-01
 -5.82855079e-01  1.01274408e+00  1.01274408e+00  1.01274408e+00
  1.03926226e+00  7.24525758e+00  7.24525758e+00  7.24525758e+00
  1.31379821e+01  3.33658831e+01  3.33658831e+01  3.33658831e+01
  1.13270195e+02  1.29035897e+02  1.29035897e+02  1.29035897e+02
  4.83441134e+02  4.83441134e+02  4.83441134e+02  6.06248487e+02
  1.33514736e+03  1.33514736e+03  1.33514736e+03  2.67814830e+03
  3.02917798e+03  3.02917798e+03  3.02917798e+03  6.64946533e+03
  6.64946533e+03  6.64946533e+03  9.08254805e+03  2.54369174e+04
  7.61777744e+04]
E1 = -728.2977304106872  E_coul = 201.55769786110224
Extra cycle  E= -526.740032549585  delta_E=    0  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826612e+04 7.61751040e+03 3.61735651e+03 1.59758753e+03
 3.82705064e+02 1.12189705e+02 3.74089182e+01 8.36631245e+00
 3.28323995e+00 6.79845096e-01 2.49038622e-01 1.36278499e+03
 6.64728038e+02 3.00878794e+02 3.13970543e+02 6.16764427e+01
 7.33789495e+00 2.02623111e+01 7.74198659e-01 2.79326502e+00
 2.22640882e-01]
E = -526.740032549585
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6611931        1
[INPUT] 0    0    [1    /1   ]  7617.51040076        1
[INPUT] 0    0    [1    /1   ]  3617.35651299        1
[INPUT] 0    0    [1    /1   ]  1597.58753062        1
[INPUT] 0    0    [1    /1   ]  382.7050641          1
[INPUT] 0    0    [1    /1   ]  112.18970476         1
[INPUT] 0    0    [1    /1   ]  37.4089181712        1
[INPUT] 0    0    [1    /1   ]  8.36631245475        1
[INPUT] 0    0    [1    /1   ]  3.28323995207        1
[INPUT] 0    0    [1    /1   ]  0.679845095862       1
[INPUT] 0    0    [1    /1   ]  0.249038622006       1
[INPUT] 1    0    [1    /1   ]  1362.78499449        1
[INPUT] 1    0    [1    /1   ]  664.728038113        1
[INPUT] 1    0    [1    /1   ]  300.878793605        1
[INPUT] 1    0    [1    /1   ]  313.970542925        1
[INPUT] 1    0    [1    /1   ]  61.6764426946        1
[INPUT] 1    0    [1    /1   ]  7.33789495377        1
[INPUT] 1    0    [1    /1   ]  20.2623110938        1
[INPUT] 1    0    [1    /1   ]  0.77419865894        1
[INPUT] 1    0    [1    /1   ]  2.79326502458        1
[INPUT] 1    0    [1    /1   ]  0.222640881603       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661193076394, 1.0]], [0, [7617.510400761931, 1.0]], [0, [3617.3565129900358, 1.0]], [0, [1597.587530618164, 1.0]], [0, [382.70506409970915, 1.0]], [0, [112.18970476009066, 1.0]], [0, [37.40891817115701, 1.0]], [0, [8.366312454749794, 1.0]], [0, [3.283239952065497, 1.0]], [0, [0.6798450958622685, 1.0]], [0, [0.24903862200560942, 1.0]], [1, [1362.7849944920408, 1.0]], [1, [664.7280381129469, 1.0]], [1, [300.878793605478, 1.0]], [1, [313.970542925011, 1.0]], [1, [61.6764426945958, 1.0]], [1, [7.337894953774522, 1.0]], [1, [20.262311093846627, 1.0]], [1, [0.774198658939571, 1.0]], [1, [2.7932650245837816, 1.0]], [1, [0.22264088160328913, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66119308]
bas 1, expnt(s) = [7617.51040076]
bas 2, expnt(s) = [3617.35651299]
bas 3, expnt(s) = [1597.58753062]
bas 4, expnt(s) = [382.7050641]
bas 5, expnt(s) = [112.18970476]
bas 6, expnt(s) = [37.40891817]
bas 7, expnt(s) = [8.36631245]
bas 8, expnt(s) = [3.28323995]
bas 9, expnt(s) = [0.6798451]
bas 10, expnt(s) = [0.24903862]
bas 11, expnt(s) = [1362.78499449]
bas 12, expnt(s) = [664.72803811]
bas 13, expnt(s) = [300.87879361]
bas 14, expnt(s) = [313.97054293]
bas 15, expnt(s) = [61.67644269]
bas 16, expnt(s) = [7.33789495]
bas 17, expnt(s) = [20.26231109]
bas 18, expnt(s) = [0.77419866]
bas 19, expnt(s) = [2.79326502]
bas 20, expnt(s) = [0.22264088]
CPU time:       287.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826612e+04 5.20026366e+03 7.61751040e+03 2.06003603e+03
 3.61735651e+03 1.17844281e+03 1.59758753e+03 6.38430345e+02
 3.82705064e+02 2.18606555e+02 1.12189705e+02 8.70923037e+01
 3.74089182e+01 3.82161019e+01 8.36631245e+00 1.24284104e+01
 3.28323995e+00 6.16228801e+00 6.79845096e-01 1.89157036e+00
 2.49038622e-01 8.90666366e-01 1.36278499e+03 2.41556413e+04
 6.64728038e+02 9.84667014e+03 3.00878794e+02 3.65572793e+03
 3.13970543e+02 3.85563152e+03 6.16764427e+01 5.04235640e+02
 7.33789495e+00 3.52329295e+01 2.02623111e+01 1.25413884e+02
 7.74198659e-01 2.11860460e+00 2.79326502e+00 1.05347582e+01
 2.22640882e-01 4.46159900e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99355761964152
cond(S) = 103766.23944522756
E1 = -729.5315797380824  E_coul = 203.1797632982192
init E= -526.351816439863
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555755022991706  LUMO = 1.03122600562738
  mo_energy =
[-1.18328913e+02 -1.22048937e+01 -9.44670532e+00 -9.44670532e+00
 -9.44670532e+00 -1.23992927e+00 -5.55755023e-01 -5.55755023e-01
 -5.55755023e-01  1.03122601e+00  1.03122601e+00  1.03122601e+00
  1.06144300e+00  7.31572115e+00  7.31572115e+00  7.31572115e+00
  1.32240874e+01  3.34857934e+01  3.34857934e+01  3.34857934e+01
  1.13445314e+02  1.29216262e+02  1.29216262e+02  1.29216262e+02
  4.83689836e+02  4.83689836e+02  4.83689836e+02  6.06533572e+02
  1.33544846e+03  1.33544846e+03  1.33544846e+03  2.67857991e+03
  3.02954279e+03  3.02954279e+03  3.02954279e+03  6.64994158e+03
  6.64994158e+03  6.64994158e+03  9.08309854e+03  2.54375614e+04
  7.61785083e+04]
E1 = -727.8528748655878  E_coul = 201.1136172405411
cycle= 1 E= -526.739257625047  delta_E= -0.387  |g|= 0.186  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540745
diis-c [-0.29240477  1.        ]
  HOMO = -0.59046072605148  LUMO = 1.00712177418581
  mo_energy =
[-1.18635785e+02 -1.23423524e+01 -9.59485926e+00 -9.59485926e+00
 -9.59485926e+00 -1.27921617e+00 -5.90460726e-01 -5.90460726e-01
 -5.90460726e-01  1.00712177e+00  1.00712177e+00  1.00712177e+00
  1.03209636e+00  7.22537486e+00  7.22537486e+00  7.22537486e+00
  1.31120125e+01  3.33320619e+01  3.33320619e+01  3.33320619e+01
  1.13222396e+02  1.28988497e+02  1.28988497e+02  1.28988497e+02
  4.83384295e+02  4.83384295e+02  4.83384295e+02  6.06189593e+02
  1.33508708e+03  1.33508708e+03  1.33508708e+03  2.67808535e+03
  3.02911586e+03  3.02911586e+03  3.02911586e+03  6.64940187e+03
  6.64940187e+03  6.64940187e+03  9.08248399e+03  2.54368529e+04
  7.61777098e+04]
E1 = -728.4250345453892  E_coul = 201.68506250147018
cycle= 2 E= -526.739972043919  delta_E= -0.000714  |g|= 0.0375  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0748316
diis-c [-0.0033054  0.0817986  0.9182014]
  HOMO = -0.581366504001223  LUMO = 1.01381257467777
  mo_energy =
[-1.18568277e+02 -1.23044003e+01 -9.55525506e+00 -9.55525506e+00
 -9.55525506e+00 -1.26832866e+00 -5.81366504e-01 -5.81366504e-01
 -5.81366504e-01  1.01381257e+00  1.01381257e+00  1.01381257e+00
  1.04052384e+00  7.24900620e+00  7.24900620e+00  7.24900620e+00
  1.31426696e+01  3.33720438e+01  3.33720438e+01  3.33720438e+01
  1.13278547e+02  1.29044247e+02  1.29044247e+02  1.29044247e+02
  4.83450990e+02  4.83450990e+02  4.83450990e+02  6.06258716e+02
  1.33515781e+03  1.33515781e+03  1.33515781e+03  2.67815940e+03
  3.02918883e+03  3.02918883e+03  3.02918883e+03  6.64947659e+03
  6.64947659e+03  6.64947659e+03  9.08255952e+03  2.54369290e+04
  7.61777862e+04]
E1 = -728.2750012390756  E_coul = 201.5349706226691
cycle= 3 E= -526.740030616406  delta_E= -5.86e-05  |g|= 0.0063  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131792
diis-c [-5.62240254e-07 -1.23627341e-03  1.45358994e-01  8.55877280e-01]
  HOMO = -0.582865973535324  LUMO = 1.01273324808716
  mo_energy =
[-1.18578259e+02 -1.23102200e+01 -9.56142120e+00 -9.56142120e+00
 -9.56142120e+00 -1.27002292e+00 -5.82865974e-01 -5.82865974e-01
 -5.82865974e-01  1.01273325e+00  1.01273325e+00  1.01273325e+00
  1.03923161e+00  7.24523290e+00  7.24523290e+00  7.24523290e+00
  1.31379415e+01  3.33658583e+01  3.33658583e+01  3.33658583e+01
  1.13270172e+02  1.29035878e+02  1.29035878e+02  1.29035878e+02
  4.83441124e+02  4.83441124e+02  4.83441124e+02  6.06248486e+02
  1.33514736e+03  1.33514736e+03  1.33514736e+03  2.67814832e+03
  3.02917799e+03  3.02917799e+03  3.02917799e+03  6.64946536e+03
  6.64946536e+03  6.64946536e+03  9.08254808e+03  2.54369174e+04
  7.61777745e+04]
E1 = -728.2978574546956  E_coul = 201.5578249067821
cycle= 4 E= -526.740032547914  delta_E= -1.93e-06  |g|= 9.64e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000111644
diis-c [-3.98647215e-09  7.12941626e-05 -1.02233384e-02 -6.59572846e-02
  1.07610933e+00]
  HOMO = -0.582847822315894  LUMO = 1.01274882579672
  mo_energy =
[-1.18578220e+02 -1.23101567e+01 -9.56137126e+00 -9.56137126e+00
 -9.56137126e+00 -1.26998261e+00 -5.82847822e-01 -5.82847822e-01
 -5.82847822e-01  1.01274883e+00  1.01274883e+00  1.01274883e+00
  1.03926590e+00  7.24527369e+00  7.24527369e+00  7.24527369e+00
  1.31380000e+01  3.33659063e+01  3.33659063e+01  3.33659063e+01
  1.13270222e+02  1.29035924e+02  1.29035924e+02  1.29035924e+02
  4.83441164e+02  4.83441164e+02  4.83441164e+02  6.06248518e+02
  1.33514739e+03  1.33514739e+03  1.33514739e+03  2.67814833e+03
  3.02917801e+03  3.02917801e+03  3.02917801e+03  6.64946536e+03
  6.64946536e+03  6.64946536e+03  9.08254808e+03  2.54369174e+04
  7.61777744e+04]
E1 = -728.2976512261483  E_coul = 201.55761867661988
cycle= 5 E= -526.740032549528  delta_E= -1.61e-09  |g|= 2.02e-05  |ddm|= 0.000154
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83418e-05
diis-c [-7.00991266e-11  1.43228385e-05 -1.87137200e-03 -1.38892887e-02
  4.21617153e-02  9.73584623e-01]
  HOMO = -0.582855064667297  LUMO = 1.0127440392888
  mo_energy =
[-1.18578250e+02 -1.23101788e+01 -9.56139520e+00 -9.56139520e+00
 -9.56139520e+00 -1.26998837e+00 -5.82855065e-01 -5.82855065e-01
 -5.82855065e-01  1.01274404e+00  1.01274404e+00  1.01274404e+00
  1.03926193e+00  7.24525753e+00  7.24525753e+00  7.24525753e+00
  1.31379819e+01  3.33658830e+01  3.33658830e+01  3.33658830e+01
  1.13270195e+02  1.29035897e+02  1.29035897e+02  1.29035897e+02
  4.83441134e+02  4.83441134e+02  4.83441134e+02  6.06248487e+02
  1.33514736e+03  1.33514736e+03  1.33514736e+03  2.67814830e+03
  3.02917798e+03  3.02917798e+03  3.02917798e+03  6.64946533e+03
  6.64946533e+03  6.64946533e+03  9.08254805e+03  2.54369174e+04
  7.61777744e+04]
E1 = -728.2977313364436  E_coul = 201.55769878685865
cycle= 6 E= -526.740032549585  delta_E= -5.65e-11  |g|= 1.69e-06  |ddm|= 1.8e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2977313364436  E_coul = 201.55769878685865
  HOMO = -0.582855078593877  LUMO = 1.01274408399821
  mo_energy =
[-1.18578250e+02 -1.23101786e+01 -9.56139514e+00 -9.56139514e+00
 -9.56139514e+00 -1.26998801e+00 -5.82855079e-01 -5.82855079e-01
 -5.82855079e-01  1.01274408e+00  1.01274408e+00  1.01274408e+00
  1.03926226e+00  7.24525758e+00  7.24525758e+00  7.24525758e+00
  1.31379821e+01  3.33658831e+01  3.33658831e+01  3.33658831e+01
  1.13270195e+02  1.29035897e+02  1.29035897e+02  1.29035897e+02
  4.83441134e+02  4.83441134e+02  4.83441134e+02  6.06248487e+02
  1.33514736e+03  1.33514736e+03  1.33514736e+03  2.67814830e+03
  3.02917798e+03  3.02917798e+03  3.02917798e+03  6.64946533e+03
  6.64946533e+03  6.64946533e+03  9.08254805e+03  2.54369174e+04
  7.61777744e+04]
E1 = -728.2977304106872  E_coul = 201.55769786110224
Extra cycle  E= -526.740032549585  delta_E=    0  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103766.23944522756
E1 = -728.2977304106872  E_coul = 201.55769786110224
init E= -526.740032549585
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.582855107007894  LUMO = 1.01274407516377
  mo_energy =
[-1.18578250e+02 -1.23101787e+01 -9.56139523e+00 -9.56139523e+00
 -9.56139523e+00 -1.26998797e+00 -5.82855107e-01 -5.82855107e-01
 -5.82855107e-01  1.01274408e+00  1.01274408e+00  1.01274408e+00
  1.03926231e+00  7.24525753e+00  7.24525753e+00  7.24525753e+00
  1.31379820e+01  3.33658831e+01  3.33658831e+01  3.33658831e+01
  1.13270195e+02  1.29035897e+02  1.29035897e+02  1.29035897e+02
  4.83441134e+02  4.83441134e+02  4.83441134e+02  6.06248487e+02
  1.33514736e+03  1.33514736e+03  1.33514736e+03  2.67814830e+03
  3.02917798e+03  3.02917798e+03  3.02917798e+03  6.64946533e+03
  6.64946533e+03  6.64946533e+03  9.08254805e+03  2.54369174e+04
  7.61777744e+04]
E1 = -728.2977305741906  E_coul = 201.5576980246056
cycle= 1 E= -526.740032549585  delta_E= -1.14e-13  |g|= 7.24e-08  |ddm|= 5.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2977305741906  E_coul = 201.5576980246056
  HOMO = -0.582855106177283  LUMO = 1.01274407812606
  mo_energy =
[-1.18578250e+02 -1.23101787e+01 -9.56139522e+00 -9.56139522e+00
 -9.56139522e+00 -1.26998795e+00 -5.82855106e-01 -5.82855106e-01
 -5.82855106e-01  1.01274408e+00  1.01274408e+00  1.01274408e+00
  1.03926233e+00  7.24525753e+00  7.24525753e+00  7.24525753e+00
  1.31379820e+01  3.33658831e+01  3.33658831e+01  3.33658831e+01
  1.13270195e+02  1.29035897e+02  1.29035897e+02  1.29035897e+02
  4.83441134e+02  4.83441134e+02  4.83441134e+02  6.06248487e+02
  1.33514736e+03  1.33514736e+03  1.33514736e+03  2.67814830e+03
  3.02917798e+03  3.02917798e+03  3.02917798e+03  6.64946533e+03
  6.64946533e+03  6.64946533e+03  9.08254805e+03  2.54369174e+04
  7.61777744e+04]
E1 = -728.297730508169  E_coul = 201.55769795858345
Extra cycle  E= -526.740032549586  delta_E= -4.55e-13  |g|= 1.46e-08  |ddm|= 1.2e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826612e+04 7.61751040e+03 3.61735651e+03 1.59758753e+03
 3.82705064e+02 1.12189705e+02 3.74089182e+01 8.36631245e+00
 3.28323995e+00 6.79845096e-01 2.49038622e-01 1.36278499e+03
 6.64728038e+02 3.00878794e+02 3.13970543e+02 6.16764427e+01
 7.33789495e+00 2.02623111e+01 7.74198659e-01 2.79326502e+00
 2.22640882e-01]
grad_E = [-1.54565962e-06  3.62401838e-06 -1.38402145e-06  8.08805074e-05
 -2.64190956e-04 -4.81731176e-04  1.02490332e-03  4.57039803e-04
 -1.21960233e-03  2.37275443e-03 -1.22892849e-03 -5.12107814e-07
  4.94132863e-06  2.32381185e-05  2.00310920e-05  1.58895136e-05
  2.43392333e-03 -4.31131587e-04 -2.98677400e-03 -4.08224941e-03
  9.04457879e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6614333        1
[INPUT] 0    0    [1    /1   ]  7617.50988359        1
[INPUT] 0    0    [1    /1   ]  3617.35676765        1
[INPUT] 0    0    [1    /1   ]  1597.57686638        1
[INPUT] 0    0    [1    /1   ]  382.695099064        1
[INPUT] 0    0    [1    /1   ]  112.426798303        1
[INPUT] 0    0    [1    /1   ]  37.3579090502        1
[INPUT] 0    0    [1    /1   ]  8.24434137335        1
[INPUT] 0    0    [1    /1   ]  3.25268004727        1
[INPUT] 0    0    [1    /1   ]  0.670758904117       1
[INPUT] 0    0    [1    /1   ]  0.245864490895       1
[INPUT] 1    0    [1    /1   ]  1362.78507494        1
[INPUT] 1    0    [1    /1   ]  664.727243279        1
[INPUT] 1    0    [1    /1   ]  300.875044285        1
[INPUT] 1    0    [1    /1   ]  313.967310431        1
[INPUT] 1    0    [1    /1   ]  61.6794840601        1
[INPUT] 1    0    [1    /1   ]  7.33987136467        1
[INPUT] 1    0    [1    /1   ]  20.2592422012        1
[INPUT] 1    0    [1    /1   ]  0.775329770461       1
[INPUT] 1    0    [1    /1   ]  2.80782725209        1
[INPUT] 1    0    [1    /1   ]  0.222697154309       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661433274017, 1.0]], [0, [7617.509883593309, 1.0]], [0, [3617.356767646395, 1.0]], [0, [1597.576866378884, 1.0]], [0, [382.69509906372014, 1.0]], [0, [112.42679830311793, 1.0]], [0, [37.35790905019257, 1.0]], [0, [8.244341373347776, 1.0]], [0, [3.252680047272463, 1.0]], [0, [0.6707589041168592, 1.0]], [0, [0.2458644908946665, 1.0]], [1, [1362.7850749393501, 1.0]], [1, [664.7272432791964, 1.0]], [1, [300.875044284632, 1.0]], [1, [313.9673104311202, 1.0]], [1, [61.679484060093735, 1.0]], [1, [7.339871364665304, 1.0]], [1, [20.259242201240117, 1.0]], [1, [0.7753297704607169, 1.0]], [1, [2.807827252093946, 1.0]], [1, [0.22269715430911624, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66143327]
bas 1, expnt(s) = [7617.50988359]
bas 2, expnt(s) = [3617.35676765]
bas 3, expnt(s) = [1597.57686638]
bas 4, expnt(s) = [382.69509906]
bas 5, expnt(s) = [112.4267983]
bas 6, expnt(s) = [37.35790905]
bas 7, expnt(s) = [8.24434137]
bas 8, expnt(s) = [3.25268005]
bas 9, expnt(s) = [0.6707589]
bas 10, expnt(s) = [0.24586449]
bas 11, expnt(s) = [1362.78507494]
bas 12, expnt(s) = [664.72724328]
bas 13, expnt(s) = [300.87504428]
bas 14, expnt(s) = [313.96731043]
bas 15, expnt(s) = [61.67948406]
bas 16, expnt(s) = [7.33987136]
bas 17, expnt(s) = [20.2592422]
bas 18, expnt(s) = [0.77532977]
bas 19, expnt(s) = [2.80782725]
bas 20, expnt(s) = [0.22269715]
CPU time:       293.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026370e+03 7.61750988e+03 2.06003592e+03
 3.61735677e+03 1.17844287e+03 1.59757687e+03 6.38427148e+02
 3.82695099e+02 2.18602286e+02 1.12426798e+02 8.72303081e+01
 3.73579091e+01 3.81770129e+01 8.24434137e+00 1.22922674e+01
 3.25268005e+00 6.11921952e+00 6.70758904e-01 1.87257775e+00
 2.45864491e-01 8.82138713e-01 1.36278507e+03 2.41556430e+04
 6.64727243e+02 9.84665543e+03 3.00875044e+02 3.65567098e+03
 3.13967310e+02 3.85558190e+03 6.16794841e+01 5.04266721e+02
 7.33987136e+00 3.52447921e+01 2.02592422e+01 1.25390140e+02
 7.75329770e-01 2.12247443e+00 2.80782725e+00 1.06034544e+01
 2.22697154e-01 4.46300863e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99357867112736
cond(S) = 103692.79226612799
E1 = -729.5304829566866  E_coul = 203.17870580779987
init E= -526.351777148887
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555765694763286  LUMO = 1.03254643500815
  mo_energy =
[-1.18328983e+02 -1.22050160e+01 -9.44681268e+00 -9.44681268e+00
 -9.44681268e+00 -1.23999167e+00 -5.55765695e-01 -5.55765695e-01
 -5.55765695e-01  1.03254644e+00  1.03254644e+00  1.03254644e+00
  1.03719332e+00  7.34546214e+00  7.34546214e+00  7.34546214e+00
  1.29472325e+01  3.35443945e+01  3.35443945e+01  3.35443945e+01
  1.12777829e+02  1.29269510e+02  1.29269510e+02  1.29269510e+02
  4.83732129e+02  4.83732129e+02  4.83732129e+02  6.06301328e+02
  1.33547974e+03  1.33547974e+03  1.33547974e+03  2.67866000e+03
  3.02956164e+03  3.02956164e+03  3.02956164e+03  6.64995068e+03
  6.64995068e+03  6.64995068e+03  9.08321579e+03  2.54376721e+04
  7.61786094e+04]
E1 = -727.8494233819745  E_coul = 201.1100119995617
cycle= 1 E= -526.739411382413  delta_E= -0.388  |g|= 0.186  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541524
diis-c [-0.29324792  1.        ]
  HOMO = -0.590583793685501  LUMO = 1.00830267606714
  mo_energy =
[-1.18636273e+02 -1.23425524e+01 -9.59507955e+00 -9.59507955e+00
 -9.59507955e+00 -1.27937840e+00 -5.90583794e-01 -5.90583794e-01
 -5.90583794e-01  1.00830268e+00  1.00830268e+00  1.00830268e+00
  1.00832257e+00  7.25482372e+00  7.25482372e+00  7.25482372e+00
  1.28359978e+01  3.33904843e+01  3.33904843e+01  3.33904843e+01
  1.12554734e+02  1.29041487e+02  1.29041487e+02  1.29041487e+02
  4.83426202e+02  4.83426202e+02  4.83426202e+02  6.05956740e+02
  1.33511779e+03  1.33511779e+03  1.33511779e+03  2.67816489e+03
  3.02913419e+03  3.02913419e+03  3.02913419e+03  6.64941039e+03
  6.64941039e+03  6.64941039e+03  9.08260064e+03  2.54369630e+04
  7.61778102e+04]
E1 = -728.4223819502071  E_coul = 201.68225382936015
cycle= 2 E= -526.740128120847  delta_E= -0.000717  |g|= 0.0375  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0749711
diis-c [-0.00330564  0.08202636  0.91797364]
  HOMO = -0.581480345003488  LUMO = 1.01501507768195
  mo_energy =
[-1.18568681e+02 -1.23045572e+01 -9.55543020e+00 -9.55543020e+00
 -9.55543020e+00 -1.26848108e+00 -5.81480345e-01 -5.81480345e-01
 -5.81480345e-01  1.01501508e+00  1.01501508e+00  1.01501508e+00
  1.01660813e+00  7.27852833e+00  7.27852833e+00  7.27852833e+00
  1.28664644e+01  3.34305121e+01  3.34305121e+01  3.34305121e+01
  1.12610955e+02  1.29097302e+02  1.29097302e+02  1.29097302e+02
  4.83492979e+02  4.83492979e+02  4.83492979e+02  6.06025957e+02
  1.33518861e+03  1.33518861e+03  1.33518861e+03  2.67823903e+03
  3.02920725e+03  3.02920725e+03  3.02920725e+03  6.64948519e+03
  6.64948519e+03  6.64948519e+03  9.08267626e+03  2.54370392e+04
  7.61778867e+04]
E1 = -728.2722139794149  E_coul = 201.53202714467642
cycle= 3 E= -526.740186834739  delta_E= -5.87e-05  |g|= 0.0063  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131746
diis-c [-5.68708799e-07 -1.23675321e-03  1.45059195e-01  8.56177558e-01]
  HOMO = -0.582980444613491  LUMO = 1.013933045308
  mo_energy =
[-1.18578655e+02 -1.23103737e+01 -9.56159329e+00 -9.56159329e+00
 -9.56159329e+00 -1.27017514e+00 -5.82980445e-01 -5.82980445e-01
 -5.82980445e-01  1.01393305e+00  1.01393305e+00  1.01393305e+00
  1.01533930e+00  7.27474840e+00  7.27474840e+00  7.27474840e+00
  1.28617727e+01  3.34243300e+01  3.34243300e+01  3.34243300e+01
  1.12602587e+02  1.29088940e+02  1.29088940e+02  1.29088940e+02
  4.83483121e+02  4.83483121e+02  4.83483121e+02  6.06015733e+02
  1.33517816e+03  1.33517816e+03  1.33517816e+03  2.67822795e+03
  3.02919641e+03  3.02919641e+03  3.02919641e+03  6.64947397e+03
  6.64947397e+03  6.64947397e+03  9.08266482e+03  2.54370276e+04
  7.61778749e+04]
E1 = -728.2950485802158  E_coul = 201.55485981747472
cycle= 4 E= -526.740188762741  delta_E= -1.93e-06  |g|= 9.7e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112254
diis-c [-4.02871962e-09  7.16582003e-05 -1.02680485e-02 -6.63797741e-02
  1.07657616e+00]
  HOMO = -0.582962278364198  LUMO = 1.01394867858187
  mo_energy =
[-1.18578616e+02 -1.23103101e+01 -9.56154306e+00 -9.56154306e+00
 -9.56154306e+00 -1.27013462e+00 -5.82962278e-01 -5.82962278e-01
 -5.82962278e-01  1.01394868e+00  1.01394868e+00  1.01394868e+00
  1.01537328e+00  7.27478944e+00  7.27478944e+00  7.27478944e+00
  1.28618314e+01  3.34243782e+01  3.34243782e+01  3.34243782e+01
  1.12602638e+02  1.29088986e+02  1.29088986e+02  1.29088986e+02
  4.83483161e+02  4.83483161e+02  4.83483161e+02  6.06015765e+02
  1.33517819e+03  1.33517819e+03  1.33517819e+03  2.67822796e+03
  3.02919643e+03  3.02919643e+03  3.02919643e+03  6.64947398e+03
  6.64947398e+03  6.64947398e+03  9.08266482e+03  2.54370276e+04
  7.61778749e+04]
E1 = -728.2948397745771  E_coul = 201.55465101018834
cycle= 5 E= -526.740188764389  delta_E= -1.65e-09  |g|= 2.04e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85583e-05
diis-c [-7.18698101e-11  1.43805352e-05 -1.87400194e-03 -1.39488458e-02
  4.28265046e-02  9.72981963e-01]
  HOMO = -0.582969606002844  LUMO = 1.01394382335892
  mo_energy =
[-1.18578646e+02 -1.23103324e+01 -9.56156721e+00 -9.56156721e+00
 -9.56156721e+00 -1.27014045e+00 -5.82969606e-01 -5.82969606e-01
 -5.82969606e-01  1.01394382e+00  1.01394382e+00  1.01394382e+00
  1.01536934e+00  7.27477309e+00  7.27477309e+00  7.27477309e+00
  1.28618132e+01  3.34243548e+01  3.34243548e+01  3.34243548e+01
  1.12602610e+02  1.29088959e+02  1.29088959e+02  1.29088959e+02
  4.83483131e+02  4.83483131e+02  4.83483131e+02  6.06015734e+02
  1.33517816e+03  1.33517816e+03  1.33517816e+03  2.67822793e+03
  3.02919640e+03  3.02919640e+03  3.02919640e+03  6.64947394e+03
  6.64947394e+03  6.64947394e+03  9.08266479e+03  2.54370275e+04
  7.61778749e+04]
E1 = -728.2949203090178  E_coul = 201.55473154457113
cycle= 6 E= -526.740188764447  delta_E= -5.79e-11  |g|= 1.72e-06  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2949203090178  E_coul = 201.55473154457113
  HOMO = -0.582969627530918  LUMO = 1.01394386351924
  mo_energy =
[-1.18578646e+02 -1.23103322e+01 -9.56156716e+00 -9.56156716e+00
 -9.56156716e+00 -1.27014009e+00 -5.82969628e-01 -5.82969628e-01
 -5.82969628e-01  1.01394386e+00  1.01394386e+00  1.01394386e+00
  1.01536967e+00  7.27477313e+00  7.27477313e+00  7.27477313e+00
  1.28618134e+01  3.34243549e+01  3.34243549e+01  3.34243549e+01
  1.12602610e+02  1.29088959e+02  1.29088959e+02  1.29088959e+02
  4.83483131e+02  4.83483131e+02  4.83483131e+02  6.06015735e+02
  1.33517816e+03  1.33517816e+03  1.33517816e+03  2.67822793e+03
  3.02919640e+03  3.02919640e+03  3.02919640e+03  6.64947394e+03
  6.64947394e+03  6.64947394e+03  9.08266479e+03  2.54370275e+04
  7.61778749e+04]
E1 = -728.2949193781807  E_coul = 201.55473061373345
Extra cycle  E= -526.740188764447  delta_E= -5.68e-13  |g|= 3.53e-07  |ddm|= 2.98e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826614e+04 7.61750988e+03 3.61735677e+03 1.59757687e+03
 3.82695099e+02 1.12426798e+02 3.73579091e+01 8.24434137e+00
 3.25268005e+00 6.70758904e-01 2.45864491e-01 1.36278507e+03
 6.64727243e+02 3.00875044e+02 3.13967310e+02 6.16794841e+01
 7.33987136e+00 2.02592422e+01 7.75329770e-01 2.80782725e+00
 2.22697154e-01]
E = -526.7401887644472
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6614333        1
[INPUT] 0    0    [1    /1   ]  7617.50988359        1
[INPUT] 0    0    [1    /1   ]  3617.35676765        1
[INPUT] 0    0    [1    /1   ]  1597.57686638        1
[INPUT] 0    0    [1    /1   ]  382.695099064        1
[INPUT] 0    0    [1    /1   ]  112.426798303        1
[INPUT] 0    0    [1    /1   ]  37.3579090502        1
[INPUT] 0    0    [1    /1   ]  8.24434137335        1
[INPUT] 0    0    [1    /1   ]  3.25268004727        1
[INPUT] 0    0    [1    /1   ]  0.670758904117       1
[INPUT] 0    0    [1    /1   ]  0.245864490895       1
[INPUT] 1    0    [1    /1   ]  1362.78507494        1
[INPUT] 1    0    [1    /1   ]  664.727243279        1
[INPUT] 1    0    [1    /1   ]  300.875044285        1
[INPUT] 1    0    [1    /1   ]  313.967310431        1
[INPUT] 1    0    [1    /1   ]  61.6794840601        1
[INPUT] 1    0    [1    /1   ]  7.33987136467        1
[INPUT] 1    0    [1    /1   ]  20.2592422012        1
[INPUT] 1    0    [1    /1   ]  0.775329770461       1
[INPUT] 1    0    [1    /1   ]  2.80782725209        1
[INPUT] 1    0    [1    /1   ]  0.222697154309       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661433274017, 1.0]], [0, [7617.509883593309, 1.0]], [0, [3617.356767646395, 1.0]], [0, [1597.576866378884, 1.0]], [0, [382.69509906372014, 1.0]], [0, [112.42679830311793, 1.0]], [0, [37.35790905019257, 1.0]], [0, [8.244341373347776, 1.0]], [0, [3.252680047272463, 1.0]], [0, [0.6707589041168592, 1.0]], [0, [0.2458644908946665, 1.0]], [1, [1362.7850749393501, 1.0]], [1, [664.7272432791964, 1.0]], [1, [300.875044284632, 1.0]], [1, [313.9673104311202, 1.0]], [1, [61.679484060093735, 1.0]], [1, [7.339871364665304, 1.0]], [1, [20.259242201240117, 1.0]], [1, [0.7753297704607169, 1.0]], [1, [2.807827252093946, 1.0]], [1, [0.22269715430911624, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66143327]
bas 1, expnt(s) = [7617.50988359]
bas 2, expnt(s) = [3617.35676765]
bas 3, expnt(s) = [1597.57686638]
bas 4, expnt(s) = [382.69509906]
bas 5, expnt(s) = [112.4267983]
bas 6, expnt(s) = [37.35790905]
bas 7, expnt(s) = [8.24434137]
bas 8, expnt(s) = [3.25268005]
bas 9, expnt(s) = [0.6707589]
bas 10, expnt(s) = [0.24586449]
bas 11, expnt(s) = [1362.78507494]
bas 12, expnt(s) = [664.72724328]
bas 13, expnt(s) = [300.87504428]
bas 14, expnt(s) = [313.96731043]
bas 15, expnt(s) = [61.67948406]
bas 16, expnt(s) = [7.33987136]
bas 17, expnt(s) = [20.2592422]
bas 18, expnt(s) = [0.77532977]
bas 19, expnt(s) = [2.80782725]
bas 20, expnt(s) = [0.22269715]
CPU time:       294.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026370e+03 7.61750988e+03 2.06003592e+03
 3.61735677e+03 1.17844287e+03 1.59757687e+03 6.38427148e+02
 3.82695099e+02 2.18602286e+02 1.12426798e+02 8.72303081e+01
 3.73579091e+01 3.81770129e+01 8.24434137e+00 1.22922674e+01
 3.25268005e+00 6.11921952e+00 6.70758904e-01 1.87257775e+00
 2.45864491e-01 8.82138713e-01 1.36278507e+03 2.41556430e+04
 6.64727243e+02 9.84665543e+03 3.00875044e+02 3.65567098e+03
 3.13967310e+02 3.85558190e+03 6.16794841e+01 5.04266721e+02
 7.33987136e+00 3.52447921e+01 2.02592422e+01 1.25390140e+02
 7.75329770e-01 2.12247443e+00 2.80782725e+00 1.06034544e+01
 2.22697154e-01 4.46300863e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99357867112736
cond(S) = 103692.79226612799
E1 = -729.5304829566866  E_coul = 203.17870580779987
init E= -526.351777148887
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555765694763286  LUMO = 1.03254643500815
  mo_energy =
[-1.18328983e+02 -1.22050160e+01 -9.44681268e+00 -9.44681268e+00
 -9.44681268e+00 -1.23999167e+00 -5.55765695e-01 -5.55765695e-01
 -5.55765695e-01  1.03254644e+00  1.03254644e+00  1.03254644e+00
  1.03719332e+00  7.34546214e+00  7.34546214e+00  7.34546214e+00
  1.29472325e+01  3.35443945e+01  3.35443945e+01  3.35443945e+01
  1.12777829e+02  1.29269510e+02  1.29269510e+02  1.29269510e+02
  4.83732129e+02  4.83732129e+02  4.83732129e+02  6.06301328e+02
  1.33547974e+03  1.33547974e+03  1.33547974e+03  2.67866000e+03
  3.02956164e+03  3.02956164e+03  3.02956164e+03  6.64995068e+03
  6.64995068e+03  6.64995068e+03  9.08321579e+03  2.54376721e+04
  7.61786094e+04]
E1 = -727.8494233819745  E_coul = 201.1100119995617
cycle= 1 E= -526.739411382413  delta_E= -0.388  |g|= 0.186  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541524
diis-c [-0.29324792  1.        ]
  HOMO = -0.590583793685501  LUMO = 1.00830267606714
  mo_energy =
[-1.18636273e+02 -1.23425524e+01 -9.59507955e+00 -9.59507955e+00
 -9.59507955e+00 -1.27937840e+00 -5.90583794e-01 -5.90583794e-01
 -5.90583794e-01  1.00830268e+00  1.00830268e+00  1.00830268e+00
  1.00832257e+00  7.25482372e+00  7.25482372e+00  7.25482372e+00
  1.28359978e+01  3.33904843e+01  3.33904843e+01  3.33904843e+01
  1.12554734e+02  1.29041487e+02  1.29041487e+02  1.29041487e+02
  4.83426202e+02  4.83426202e+02  4.83426202e+02  6.05956740e+02
  1.33511779e+03  1.33511779e+03  1.33511779e+03  2.67816489e+03
  3.02913419e+03  3.02913419e+03  3.02913419e+03  6.64941039e+03
  6.64941039e+03  6.64941039e+03  9.08260064e+03  2.54369630e+04
  7.61778102e+04]
E1 = -728.4223819502071  E_coul = 201.68225382936015
cycle= 2 E= -526.740128120847  delta_E= -0.000717  |g|= 0.0375  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0749711
diis-c [-0.00330564  0.08202636  0.91797364]
  HOMO = -0.581480345003488  LUMO = 1.01501507768195
  mo_energy =
[-1.18568681e+02 -1.23045572e+01 -9.55543020e+00 -9.55543020e+00
 -9.55543020e+00 -1.26848108e+00 -5.81480345e-01 -5.81480345e-01
 -5.81480345e-01  1.01501508e+00  1.01501508e+00  1.01501508e+00
  1.01660813e+00  7.27852833e+00  7.27852833e+00  7.27852833e+00
  1.28664644e+01  3.34305121e+01  3.34305121e+01  3.34305121e+01
  1.12610955e+02  1.29097302e+02  1.29097302e+02  1.29097302e+02
  4.83492979e+02  4.83492979e+02  4.83492979e+02  6.06025957e+02
  1.33518861e+03  1.33518861e+03  1.33518861e+03  2.67823903e+03
  3.02920725e+03  3.02920725e+03  3.02920725e+03  6.64948519e+03
  6.64948519e+03  6.64948519e+03  9.08267626e+03  2.54370392e+04
  7.61778867e+04]
E1 = -728.2722139794149  E_coul = 201.53202714467642
cycle= 3 E= -526.740186834739  delta_E= -5.87e-05  |g|= 0.0063  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131746
diis-c [-5.68708799e-07 -1.23675321e-03  1.45059195e-01  8.56177558e-01]
  HOMO = -0.582980444613491  LUMO = 1.013933045308
  mo_energy =
[-1.18578655e+02 -1.23103737e+01 -9.56159329e+00 -9.56159329e+00
 -9.56159329e+00 -1.27017514e+00 -5.82980445e-01 -5.82980445e-01
 -5.82980445e-01  1.01393305e+00  1.01393305e+00  1.01393305e+00
  1.01533930e+00  7.27474840e+00  7.27474840e+00  7.27474840e+00
  1.28617727e+01  3.34243300e+01  3.34243300e+01  3.34243300e+01
  1.12602587e+02  1.29088940e+02  1.29088940e+02  1.29088940e+02
  4.83483121e+02  4.83483121e+02  4.83483121e+02  6.06015733e+02
  1.33517816e+03  1.33517816e+03  1.33517816e+03  2.67822795e+03
  3.02919641e+03  3.02919641e+03  3.02919641e+03  6.64947397e+03
  6.64947397e+03  6.64947397e+03  9.08266482e+03  2.54370276e+04
  7.61778749e+04]
E1 = -728.2950485802158  E_coul = 201.55485981747472
cycle= 4 E= -526.740188762741  delta_E= -1.93e-06  |g|= 9.7e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000112254
diis-c [-4.02871962e-09  7.16582003e-05 -1.02680485e-02 -6.63797741e-02
  1.07657616e+00]
  HOMO = -0.582962278364198  LUMO = 1.01394867858187
  mo_energy =
[-1.18578616e+02 -1.23103101e+01 -9.56154306e+00 -9.56154306e+00
 -9.56154306e+00 -1.27013462e+00 -5.82962278e-01 -5.82962278e-01
 -5.82962278e-01  1.01394868e+00  1.01394868e+00  1.01394868e+00
  1.01537328e+00  7.27478944e+00  7.27478944e+00  7.27478944e+00
  1.28618314e+01  3.34243782e+01  3.34243782e+01  3.34243782e+01
  1.12602638e+02  1.29088986e+02  1.29088986e+02  1.29088986e+02
  4.83483161e+02  4.83483161e+02  4.83483161e+02  6.06015765e+02
  1.33517819e+03  1.33517819e+03  1.33517819e+03  2.67822796e+03
  3.02919643e+03  3.02919643e+03  3.02919643e+03  6.64947398e+03
  6.64947398e+03  6.64947398e+03  9.08266482e+03  2.54370276e+04
  7.61778749e+04]
E1 = -728.2948397745771  E_coul = 201.55465101018834
cycle= 5 E= -526.740188764389  delta_E= -1.65e-09  |g|= 2.04e-05  |ddm|= 0.000156
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85583e-05
diis-c [-7.18698101e-11  1.43805352e-05 -1.87400194e-03 -1.39488458e-02
  4.28265046e-02  9.72981963e-01]
  HOMO = -0.582969606002844  LUMO = 1.01394382335892
  mo_energy =
[-1.18578646e+02 -1.23103324e+01 -9.56156721e+00 -9.56156721e+00
 -9.56156721e+00 -1.27014045e+00 -5.82969606e-01 -5.82969606e-01
 -5.82969606e-01  1.01394382e+00  1.01394382e+00  1.01394382e+00
  1.01536934e+00  7.27477309e+00  7.27477309e+00  7.27477309e+00
  1.28618132e+01  3.34243548e+01  3.34243548e+01  3.34243548e+01
  1.12602610e+02  1.29088959e+02  1.29088959e+02  1.29088959e+02
  4.83483131e+02  4.83483131e+02  4.83483131e+02  6.06015734e+02
  1.33517816e+03  1.33517816e+03  1.33517816e+03  2.67822793e+03
  3.02919640e+03  3.02919640e+03  3.02919640e+03  6.64947394e+03
  6.64947394e+03  6.64947394e+03  9.08266479e+03  2.54370275e+04
  7.61778749e+04]
E1 = -728.2949203090178  E_coul = 201.55473154457113
cycle= 6 E= -526.740188764447  delta_E= -5.79e-11  |g|= 1.72e-06  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2949203090178  E_coul = 201.55473154457113
  HOMO = -0.582969627530918  LUMO = 1.01394386351924
  mo_energy =
[-1.18578646e+02 -1.23103322e+01 -9.56156716e+00 -9.56156716e+00
 -9.56156716e+00 -1.27014009e+00 -5.82969628e-01 -5.82969628e-01
 -5.82969628e-01  1.01394386e+00  1.01394386e+00  1.01394386e+00
  1.01536967e+00  7.27477313e+00  7.27477313e+00  7.27477313e+00
  1.28618134e+01  3.34243549e+01  3.34243549e+01  3.34243549e+01
  1.12602610e+02  1.29088959e+02  1.29088959e+02  1.29088959e+02
  4.83483131e+02  4.83483131e+02  4.83483131e+02  6.06015735e+02
  1.33517816e+03  1.33517816e+03  1.33517816e+03  2.67822793e+03
  3.02919640e+03  3.02919640e+03  3.02919640e+03  6.64947394e+03
  6.64947394e+03  6.64947394e+03  9.08266479e+03  2.54370275e+04
  7.61778749e+04]
E1 = -728.2949193781807  E_coul = 201.55473061373345
Extra cycle  E= -526.740188764447  delta_E= -5.68e-13  |g|= 3.53e-07  |ddm|= 2.98e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103692.79226612799
E1 = -728.2949193781807  E_coul = 201.55473061373345
init E= -526.740188764447
    CPU time for initialize scf      0.93 sec, wall time      0.25 sec
  HOMO = -0.582969656773704  LUMO = 1.01394385426267
  mo_energy =
[-1.18578646e+02 -1.23103323e+01 -9.56156725e+00 -9.56156725e+00
 -9.56156725e+00 -1.27014005e+00 -5.82969657e-01 -5.82969657e-01
 -5.82969657e-01  1.01394385e+00  1.01394385e+00  1.01394385e+00
  1.01536972e+00  7.27477308e+00  7.27477308e+00  7.27477308e+00
  1.28618134e+01  3.34243548e+01  3.34243548e+01  3.34243548e+01
  1.12602610e+02  1.29088959e+02  1.29088959e+02  1.29088959e+02
  4.83483131e+02  4.83483131e+02  4.83483131e+02  6.06015735e+02
  1.33517816e+03  1.33517816e+03  1.33517816e+03  2.67822793e+03
  3.02919640e+03  3.02919640e+03  3.02919640e+03  6.64947394e+03
  6.64947394e+03  6.64947394e+03  9.08266479e+03  2.54370275e+04
  7.61778749e+04]
E1 = -728.2949195330207  E_coul = 201.55473076857297
cycle= 1 E= -526.740188764448  delta_E= -4.55e-13  |g|= 7.38e-08  |ddm|= 5.84e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2949195330207  E_coul = 201.55473076857297
  HOMO = -0.582969656272131  LUMO = 1.01394385704066
  mo_energy =
[-1.18578646e+02 -1.23103323e+01 -9.56156724e+00 -9.56156724e+00
 -9.56156724e+00 -1.27014003e+00 -5.82969656e-01 -5.82969656e-01
 -5.82969656e-01  1.01394386e+00  1.01394386e+00  1.01394386e+00
  1.01536973e+00  7.27477308e+00  7.27477308e+00  7.27477308e+00
  1.28618134e+01  3.34243548e+01  3.34243548e+01  3.34243548e+01
  1.12602610e+02  1.29088959e+02  1.29088959e+02  1.29088959e+02
  4.83483131e+02  4.83483131e+02  4.83483131e+02  6.06015735e+02
  1.33517816e+03  1.33517816e+03  1.33517816e+03  2.67822793e+03
  3.02919640e+03  3.02919640e+03  3.02919640e+03  6.64947394e+03
  6.64947394e+03  6.64947394e+03  9.08266479e+03  2.54370275e+04
  7.61778749e+04]
E1 = -728.2949194673754  E_coul = 201.55473070292825
Extra cycle  E= -526.740188764447  delta_E= 5.68e-13  |g|= 1.49e-08  |ddm|= 1.23e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826614e+04 7.61750988e+03 3.61735677e+03 1.59757687e+03
 3.82695099e+02 1.12426798e+02 3.73579091e+01 8.24434137e+00
 3.25268005e+00 6.70758904e-01 2.45864491e-01 1.36278507e+03
 6.64727243e+02 3.00875044e+02 3.13967310e+02 6.16794841e+01
 7.33987136e+00 2.02592422e+01 7.75329770e-01 2.80782725e+00
 2.22697154e-01]
grad_E = [-1.55041421e-06  3.68092739e-06 -1.34305052e-06  8.30489750e-05
 -3.21671612e-04 -1.35427317e-04  3.58106035e-04 -1.62836291e-04
 -8.49109464e-05  9.87694028e-04 -3.53064576e-04 -5.10430204e-07
  4.96550688e-06  2.33900974e-05  2.01607698e-05 -8.21085528e-06
  7.87026711e-04 -1.18958962e-04 -9.81256133e-04 -1.40814160e-03
  2.97990140e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613879        1
[INPUT] 0    0    [1    /1   ]  7617.50998555        1
[INPUT] 0    0    [1    /1   ]  3617.35672268        1
[INPUT] 0    0    [1    /1   ]  1597.57906282        1
[INPUT] 0    0    [1    /1   ]  382.691030058        1
[INPUT] 0    0    [1    /1   ]  112.420351987        1
[INPUT] 0    0    [1    /1   ]  37.2959637106        1
[INPUT] 0    0    [1    /1   ]  8.27252088144        1
[INPUT] 0    0    [1    /1   ]  3.25755232379        1
[INPUT] 0    0    [1    /1   ]  0.664233851972       1
[INPUT] 0    0    [1    /1   ]  0.243998058613       1
[INPUT] 1    0    [1    /1   ]  1362.78505979        1
[INPUT] 1    0    [1    /1   ]  664.727390566        1
[INPUT] 1    0    [1    /1   ]  300.875737341        1
[INPUT] 1    0    [1    /1   ]  313.967907966        1
[INPUT] 1    0    [1    /1   ]  61.6797465526        1
[INPUT] 1    0    [1    /1   ]  7.34303487312        1
[INPUT] 1    0    [1    /1   ]  20.2550084752        1
[INPUT] 1    0    [1    /1   ]  0.776022884017       1
[INPUT] 1    0    [1    /1   ]  2.81678925959        1
[INPUT] 1    0    [1    /1   ]  0.222767626834       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661387872547, 1.0]], [0, [7617.50998554584, 1.0]], [0, [3617.3567226788787, 1.0]], [0, [1597.5790628178895, 1.0]], [0, [382.69103005779345, 1.0]], [0, [112.42035198738091, 1.0]], [0, [37.29596371056607, 1.0]], [0, [8.272520881444201, 1.0]], [0, [3.2575523237902972, 1.0]], [0, [0.6642338519722336, 1.0]], [0, [0.24399805861332313, 1.0]], [1, [1362.7850597946551, 1.0]], [1, [664.7273905657221, 1.0]], [1, [300.87573734149, 1.0]], [1, [313.96790796588186, 1.0]], [1, [61.679746552576574, 1.0]], [1, [7.343034873115407, 1.0]], [1, [20.25500847524983, 1.0]], [1, [0.7760228840171339, 1.0]], [1, [2.8167892595931043, 1.0]], [1, [0.22276762683419898, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66138787]
bas 1, expnt(s) = [7617.50998555]
bas 2, expnt(s) = [3617.35672268]
bas 3, expnt(s) = [1597.57906282]
bas 4, expnt(s) = [382.69103006]
bas 5, expnt(s) = [112.42035199]
bas 6, expnt(s) = [37.29596371]
bas 7, expnt(s) = [8.27252088]
bas 8, expnt(s) = [3.25755232]
bas 9, expnt(s) = [0.66423385]
bas 10, expnt(s) = [0.24399806]
bas 11, expnt(s) = [1362.78505979]
bas 12, expnt(s) = [664.72739057]
bas 13, expnt(s) = [300.87573734]
bas 14, expnt(s) = [313.96790797]
bas 15, expnt(s) = [61.67974655]
bas 16, expnt(s) = [7.34303487]
bas 17, expnt(s) = [20.25500848]
bas 18, expnt(s) = [0.77602288]
bas 19, expnt(s) = [2.81678926]
bas 20, expnt(s) = [0.22276763]
CPU time:       300.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026369e+03 7.61750999e+03 2.06003595e+03
 3.61735672e+03 1.17844286e+03 1.59757906e+03 6.38427807e+02
 3.82691030e+02 2.18600543e+02 1.12420352e+02 8.72265569e+01
 3.72959637e+01 3.81295254e+01 8.27252088e+00 1.23237656e+01
 3.25755232e+00 6.12609284e+00 6.64233852e-01 1.85889893e+00
 2.43998059e-01 8.77111494e-01 1.36278506e+03 2.41556427e+04
 6.64727391e+02 9.84665815e+03 3.00875737e+02 3.65568151e+03
 3.13967908e+02 3.85559108e+03 6.16797466e+01 5.04269403e+02
 7.34303487e+00 3.52637814e+01 2.02550085e+01 1.25357386e+02
 7.76022884e-01 2.12484646e+00 2.81678926e+00 1.06457763e+01
 2.22767627e-01 4.46477410e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993577087765065
cond(S) = 103687.05458167658
E1 = -729.5304670330424  E_coul = 203.1784767546004
init E= -526.351990278442
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.5557703390585  LUMO = 1.02263762692094
  mo_energy =
[-1.18329036e+02 -1.22049714e+01 -9.44683826e+00 -9.44683826e+00
 -9.44683826e+00 -1.24001960e+00 -5.55770339e-01 -5.55770339e-01
 -5.55770339e-01  1.02263763e+00  1.03349159e+00  1.03349159e+00
  1.03349159e+00  7.36448460e+00  7.36448460e+00  7.36448460e+00
  1.29471022e+01  3.35836644e+01  3.35836644e+01  3.35836644e+01
  1.12754327e+02  1.29301315e+02  1.29301315e+02  1.29301315e+02
  4.83753971e+02  4.83753971e+02  4.83753971e+02  6.06155469e+02
  1.33549960e+03  1.33549960e+03  1.33549960e+03  2.67848804e+03
  3.02958174e+03  3.02958174e+03  3.02958174e+03  6.64997042e+03
  6.64997042e+03  6.64997042e+03  9.08305058e+03  2.54375158e+04
  7.61784641e+04]
E1 = -727.8482007267999  E_coul = 201.10876893752274
cycle= 1 E= -526.739431789277  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541927
diis-c [-0.29368524  1.        ]
  HOMO = -0.590626647650811  LUMO = 0.994053423505096
  mo_energy =
[-1.18636461e+02 -1.23425533e+01 -9.59516568e+00 -9.59516568e+00
 -9.59516568e+00 -1.27943501e+00 -5.90626648e-01 -5.90626648e-01
 -5.90626648e-01  9.94053424e-01  1.00918351e+00  1.00918351e+00
  1.00918351e+00  7.27368735e+00  7.27368735e+00  7.27368735e+00
  1.28357454e+01  3.34296735e+01  3.34296735e+01  3.34296735e+01
  1.12531151e+02  1.29073211e+02  1.29073211e+02  1.29073211e+02
  4.83447888e+02  4.83447888e+02  4.83447888e+02  6.05810678e+02
  1.33513741e+03  1.33513741e+03  1.33513741e+03  2.67799267e+03
  3.02915405e+03  3.02915405e+03  3.02915405e+03  6.64942986e+03
  6.64942986e+03  6.64942986e+03  9.08243514e+03  2.54368063e+04
  7.61776646e+04]
E1 = -728.4213241431762  E_coul = 201.6811748390515
cycle= 2 E= -526.740149304125  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750194
diis-c [-0.00330603  0.08208066  0.91791934]
  HOMO = -0.581520702681192  LUMO = 1.00225863223945
  mo_energy =
[-1.18568847e+02 -1.23045499e+01 -9.55550959e+00 -9.55550959e+00
 -9.55550959e+00 -1.26853525e+00 -5.81520703e-01 -5.81520703e-01
 -5.81520703e-01  1.00225863e+00  1.01590703e+00  1.01590703e+00
  1.01590703e+00  7.29742690e+00  7.29742690e+00  7.29742690e+00
  1.28662579e+01  3.34697101e+01  3.34697101e+01  3.34697101e+01
  1.12587379e+02  1.29129039e+02  1.29129039e+02  1.29129039e+02
  4.83514685e+02  4.83514685e+02  4.83514685e+02  6.05879914e+02
  1.33520825e+03  1.33520825e+03  1.33520825e+03  2.67806683e+03
  3.02922713e+03  3.02922713e+03  3.02922713e+03  6.64950469e+03
  6.64950469e+03  6.64950469e+03  9.08251078e+03  2.54368825e+04
  7.61777411e+04]
E1 = -728.2711799897374  E_coul = 201.53097196595536
cycle= 3 E= -526.740208023782  delta_E= -5.87e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131718
diis-c [-5.71929215e-07 -1.23734223e-03  1.44940739e-01  8.56296603e-01]
  HOMO = -0.583020576965812  LUMO = 1.00100321558676
  mo_energy =
[-1.18578815e+02 -1.23103625e+01 -9.56166871e+00 -9.56166871e+00
 -9.56166871e+00 -1.27022851e+00 -5.83020577e-01 -5.83020577e-01
 -5.83020577e-01  1.00100322e+00  1.01482372e+00  1.01482372e+00
  1.01482372e+00  7.29364423e+00  7.29364423e+00  7.29364423e+00
  1.28615643e+01  3.34635318e+01  3.34635318e+01  3.34635318e+01
  1.12579018e+02  1.29120682e+02  1.29120682e+02  1.29120682e+02
  4.83504834e+02  4.83504834e+02  4.83504834e+02  6.05869697e+02
  1.33519781e+03  1.33519781e+03  1.33519781e+03  2.67805576e+03
  3.02921630e+03  3.02921630e+03  3.02921630e+03  6.64949347e+03
  6.64949347e+03  6.64949347e+03  9.08249936e+03  2.54368709e+04
  7.61777293e+04]
E1 = -728.2939891614394  E_coul = 201.55377921334298
cycle= 4 E= -526.740209948096  delta_E= -1.92e-06  |g|= 9.73e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113077
diis-c [-4.04813654e-09  7.21031650e-05 -1.03206187e-02 -6.68111726e-02
  1.07705969e+00]
  HOMO = -0.583002536425518  LUMO = 1.0010369078454
  mo_energy =
[-1.18578776e+02 -1.23102990e+01 -9.56161874e+00 -9.56161874e+00
 -9.56161874e+00 -1.27018801e+00 -5.83002536e-01 -5.83002536e-01
 -5.83002536e-01  1.00103691e+00  1.01483929e+00  1.01483929e+00
  1.01483929e+00  7.29368512e+00  7.29368512e+00  7.29368512e+00
  1.28616229e+01  3.34635798e+01  3.34635798e+01  3.34635798e+01
  1.12579069e+02  1.29120729e+02  1.29120729e+02  1.29120729e+02
  4.83504873e+02  4.83504873e+02  4.83504873e+02  6.05869728e+02
  1.33519784e+03  1.33519784e+03  1.33519784e+03  2.67805577e+03
  3.02921632e+03  3.02921632e+03  3.02921632e+03  6.64949348e+03
  6.64949348e+03  6.64949348e+03  9.08249935e+03  2.54368709e+04
  7.61777293e+04]
E1 = -728.2937803827101  E_coul = 201.5535704329471
cycle= 5 E= -526.740209949763  delta_E= -1.67e-09  |g|= 2.04e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.861e-05
diis-c [-7.28802964e-11  1.43971508e-05 -1.87422761e-03 -1.39673950e-02
  4.31535151e-02  9.72673710e-01]
  HOMO = -0.583009904339529  LUMO = 1.00103298201756
  mo_energy =
[-1.18578806e+02 -1.23103214e+01 -9.56164296e+00 -9.56164296e+00
 -9.56164296e+00 -1.27019388e+00 -5.83009904e-01 -5.83009904e-01
 -5.83009904e-01  1.00103298e+00  1.01483440e+00  1.01483440e+00
  1.01483440e+00  7.29366869e+00  7.29366869e+00  7.29366869e+00
  1.28616047e+01  3.34635563e+01  3.34635563e+01  3.34635563e+01
  1.12579041e+02  1.29120701e+02  1.29120701e+02  1.29120701e+02
  4.83504843e+02  4.83504843e+02  4.83504843e+02  6.05869698e+02
  1.33519781e+03  1.33519781e+03  1.33519781e+03  2.67805573e+03
  3.02921629e+03  3.02921629e+03  3.02921629e+03  6.64949344e+03
  6.64949344e+03  6.64949344e+03  9.08249932e+03  2.54368708e+04
  7.61777293e+04]
E1 = -728.2938610032359  E_coul = 201.5536510534152
cycle= 6 E= -526.740209949821  delta_E= -5.76e-11  |g|= 1.73e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2938610032359  E_coul = 201.5536510534152
  HOMO = -0.583009928367383  LUMO = 1.00103331442791
  mo_energy =
[-1.18578806e+02 -1.23103212e+01 -9.56164291e+00 -9.56164291e+00
 -9.56164291e+00 -1.27019352e+00 -5.83009928e-01 -5.83009928e-01
 -5.83009928e-01  1.00103331e+00  1.01483444e+00  1.01483444e+00
  1.01483444e+00  7.29366873e+00  7.29366873e+00  7.29366873e+00
  1.28616049e+01  3.34635564e+01  3.34635564e+01  3.34635564e+01
  1.12579041e+02  1.29120701e+02  1.29120701e+02  1.29120701e+02
  4.83504843e+02  4.83504843e+02  4.83504843e+02  6.05869698e+02
  1.33519781e+03  1.33519781e+03  1.33519781e+03  2.67805573e+03
  3.02921629e+03  3.02921629e+03  3.02921629e+03  6.64949344e+03
  6.64949344e+03  6.64949344e+03  9.08249932e+03  2.54368708e+04
  7.61777293e+04]
E1 = -728.2938600421159  E_coul = 201.55365009229467
Extra cycle  E= -526.740209949821  delta_E= -5.68e-13  |g|= 3.56e-07  |ddm|= 3.02e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826614e+04 7.61750999e+03 3.61735672e+03 1.59757906e+03
 3.82691030e+02 1.12420352e+02 3.72959637e+01 8.27252088e+00
 3.25755232e+00 6.64233852e-01 2.43998059e-01 1.36278506e+03
 6.64727391e+02 3.00875737e+02 3.13967908e+02 6.16797466e+01
 7.34303487e+00 2.02550085e+01 7.76022884e-01 2.81678926e+00
 2.22767627e-01]
E = -526.7402099498212
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613879        1
[INPUT] 0    0    [1    /1   ]  7617.50998555        1
[INPUT] 0    0    [1    /1   ]  3617.35672268        1
[INPUT] 0    0    [1    /1   ]  1597.57906282        1
[INPUT] 0    0    [1    /1   ]  382.691030058        1
[INPUT] 0    0    [1    /1   ]  112.420351987        1
[INPUT] 0    0    [1    /1   ]  37.2959637106        1
[INPUT] 0    0    [1    /1   ]  8.27252088144        1
[INPUT] 0    0    [1    /1   ]  3.25755232379        1
[INPUT] 0    0    [1    /1   ]  0.664233851972       1
[INPUT] 0    0    [1    /1   ]  0.243998058613       1
[INPUT] 1    0    [1    /1   ]  1362.78505979        1
[INPUT] 1    0    [1    /1   ]  664.727390566        1
[INPUT] 1    0    [1    /1   ]  300.875737341        1
[INPUT] 1    0    [1    /1   ]  313.967907966        1
[INPUT] 1    0    [1    /1   ]  61.6797465526        1
[INPUT] 1    0    [1    /1   ]  7.34303487312        1
[INPUT] 1    0    [1    /1   ]  20.2550084752        1
[INPUT] 1    0    [1    /1   ]  0.776022884017       1
[INPUT] 1    0    [1    /1   ]  2.81678925959        1
[INPUT] 1    0    [1    /1   ]  0.222767626834       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661387872547, 1.0]], [0, [7617.50998554584, 1.0]], [0, [3617.3567226788787, 1.0]], [0, [1597.5790628178895, 1.0]], [0, [382.69103005779345, 1.0]], [0, [112.42035198738091, 1.0]], [0, [37.29596371056607, 1.0]], [0, [8.272520881444201, 1.0]], [0, [3.2575523237902972, 1.0]], [0, [0.6642338519722336, 1.0]], [0, [0.24399805861332313, 1.0]], [1, [1362.7850597946551, 1.0]], [1, [664.7273905657221, 1.0]], [1, [300.87573734149, 1.0]], [1, [313.96790796588186, 1.0]], [1, [61.679746552576574, 1.0]], [1, [7.343034873115407, 1.0]], [1, [20.25500847524983, 1.0]], [1, [0.7760228840171339, 1.0]], [1, [2.8167892595931043, 1.0]], [1, [0.22276762683419898, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66138787]
bas 1, expnt(s) = [7617.50998555]
bas 2, expnt(s) = [3617.35672268]
bas 3, expnt(s) = [1597.57906282]
bas 4, expnt(s) = [382.69103006]
bas 5, expnt(s) = [112.42035199]
bas 6, expnt(s) = [37.29596371]
bas 7, expnt(s) = [8.27252088]
bas 8, expnt(s) = [3.25755232]
bas 9, expnt(s) = [0.66423385]
bas 10, expnt(s) = [0.24399806]
bas 11, expnt(s) = [1362.78505979]
bas 12, expnt(s) = [664.72739057]
bas 13, expnt(s) = [300.87573734]
bas 14, expnt(s) = [313.96790797]
bas 15, expnt(s) = [61.67974655]
bas 16, expnt(s) = [7.34303487]
bas 17, expnt(s) = [20.25500848]
bas 18, expnt(s) = [0.77602288]
bas 19, expnt(s) = [2.81678926]
bas 20, expnt(s) = [0.22276763]
CPU time:       300.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026369e+03 7.61750999e+03 2.06003595e+03
 3.61735672e+03 1.17844286e+03 1.59757906e+03 6.38427807e+02
 3.82691030e+02 2.18600543e+02 1.12420352e+02 8.72265569e+01
 3.72959637e+01 3.81295254e+01 8.27252088e+00 1.23237656e+01
 3.25755232e+00 6.12609284e+00 6.64233852e-01 1.85889893e+00
 2.43998059e-01 8.77111494e-01 1.36278506e+03 2.41556427e+04
 6.64727391e+02 9.84665815e+03 3.00875737e+02 3.65568151e+03
 3.13967908e+02 3.85559108e+03 6.16797466e+01 5.04269403e+02
 7.34303487e+00 3.52637814e+01 2.02550085e+01 1.25357386e+02
 7.76022884e-01 2.12484646e+00 2.81678926e+00 1.06457763e+01
 2.22767627e-01 4.46477410e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993577087765065
cond(S) = 103687.05458167658
E1 = -729.5304670330424  E_coul = 203.1784767546004
init E= -526.351990278442
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.5557703390585  LUMO = 1.02263762692094
  mo_energy =
[-1.18329036e+02 -1.22049714e+01 -9.44683826e+00 -9.44683826e+00
 -9.44683826e+00 -1.24001960e+00 -5.55770339e-01 -5.55770339e-01
 -5.55770339e-01  1.02263763e+00  1.03349159e+00  1.03349159e+00
  1.03349159e+00  7.36448460e+00  7.36448460e+00  7.36448460e+00
  1.29471022e+01  3.35836644e+01  3.35836644e+01  3.35836644e+01
  1.12754327e+02  1.29301315e+02  1.29301315e+02  1.29301315e+02
  4.83753971e+02  4.83753971e+02  4.83753971e+02  6.06155469e+02
  1.33549960e+03  1.33549960e+03  1.33549960e+03  2.67848804e+03
  3.02958174e+03  3.02958174e+03  3.02958174e+03  6.64997042e+03
  6.64997042e+03  6.64997042e+03  9.08305058e+03  2.54375158e+04
  7.61784641e+04]
E1 = -727.8482007267999  E_coul = 201.10876893752274
cycle= 1 E= -526.739431789277  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541927
diis-c [-0.29368524  1.        ]
  HOMO = -0.590626647650811  LUMO = 0.994053423505096
  mo_energy =
[-1.18636461e+02 -1.23425533e+01 -9.59516568e+00 -9.59516568e+00
 -9.59516568e+00 -1.27943501e+00 -5.90626648e-01 -5.90626648e-01
 -5.90626648e-01  9.94053424e-01  1.00918351e+00  1.00918351e+00
  1.00918351e+00  7.27368735e+00  7.27368735e+00  7.27368735e+00
  1.28357454e+01  3.34296735e+01  3.34296735e+01  3.34296735e+01
  1.12531151e+02  1.29073211e+02  1.29073211e+02  1.29073211e+02
  4.83447888e+02  4.83447888e+02  4.83447888e+02  6.05810678e+02
  1.33513741e+03  1.33513741e+03  1.33513741e+03  2.67799267e+03
  3.02915405e+03  3.02915405e+03  3.02915405e+03  6.64942986e+03
  6.64942986e+03  6.64942986e+03  9.08243514e+03  2.54368063e+04
  7.61776646e+04]
E1 = -728.4213241431762  E_coul = 201.6811748390515
cycle= 2 E= -526.740149304125  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750194
diis-c [-0.00330603  0.08208066  0.91791934]
  HOMO = -0.581520702681192  LUMO = 1.00225863223945
  mo_energy =
[-1.18568847e+02 -1.23045499e+01 -9.55550959e+00 -9.55550959e+00
 -9.55550959e+00 -1.26853525e+00 -5.81520703e-01 -5.81520703e-01
 -5.81520703e-01  1.00225863e+00  1.01590703e+00  1.01590703e+00
  1.01590703e+00  7.29742690e+00  7.29742690e+00  7.29742690e+00
  1.28662579e+01  3.34697101e+01  3.34697101e+01  3.34697101e+01
  1.12587379e+02  1.29129039e+02  1.29129039e+02  1.29129039e+02
  4.83514685e+02  4.83514685e+02  4.83514685e+02  6.05879914e+02
  1.33520825e+03  1.33520825e+03  1.33520825e+03  2.67806683e+03
  3.02922713e+03  3.02922713e+03  3.02922713e+03  6.64950469e+03
  6.64950469e+03  6.64950469e+03  9.08251078e+03  2.54368825e+04
  7.61777411e+04]
E1 = -728.2711799897374  E_coul = 201.53097196595536
cycle= 3 E= -526.740208023782  delta_E= -5.87e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131718
diis-c [-5.71929215e-07 -1.23734223e-03  1.44940739e-01  8.56296603e-01]
  HOMO = -0.583020576965812  LUMO = 1.00100321558676
  mo_energy =
[-1.18578815e+02 -1.23103625e+01 -9.56166871e+00 -9.56166871e+00
 -9.56166871e+00 -1.27022851e+00 -5.83020577e-01 -5.83020577e-01
 -5.83020577e-01  1.00100322e+00  1.01482372e+00  1.01482372e+00
  1.01482372e+00  7.29364423e+00  7.29364423e+00  7.29364423e+00
  1.28615643e+01  3.34635318e+01  3.34635318e+01  3.34635318e+01
  1.12579018e+02  1.29120682e+02  1.29120682e+02  1.29120682e+02
  4.83504834e+02  4.83504834e+02  4.83504834e+02  6.05869697e+02
  1.33519781e+03  1.33519781e+03  1.33519781e+03  2.67805576e+03
  3.02921630e+03  3.02921630e+03  3.02921630e+03  6.64949347e+03
  6.64949347e+03  6.64949347e+03  9.08249936e+03  2.54368709e+04
  7.61777293e+04]
E1 = -728.2939891614394  E_coul = 201.55377921334298
cycle= 4 E= -526.740209948096  delta_E= -1.92e-06  |g|= 9.73e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113077
diis-c [-4.04813654e-09  7.21031650e-05 -1.03206187e-02 -6.68111726e-02
  1.07705969e+00]
  HOMO = -0.583002536425518  LUMO = 1.0010369078454
  mo_energy =
[-1.18578776e+02 -1.23102990e+01 -9.56161874e+00 -9.56161874e+00
 -9.56161874e+00 -1.27018801e+00 -5.83002536e-01 -5.83002536e-01
 -5.83002536e-01  1.00103691e+00  1.01483929e+00  1.01483929e+00
  1.01483929e+00  7.29368512e+00  7.29368512e+00  7.29368512e+00
  1.28616229e+01  3.34635798e+01  3.34635798e+01  3.34635798e+01
  1.12579069e+02  1.29120729e+02  1.29120729e+02  1.29120729e+02
  4.83504873e+02  4.83504873e+02  4.83504873e+02  6.05869728e+02
  1.33519784e+03  1.33519784e+03  1.33519784e+03  2.67805577e+03
  3.02921632e+03  3.02921632e+03  3.02921632e+03  6.64949348e+03
  6.64949348e+03  6.64949348e+03  9.08249935e+03  2.54368709e+04
  7.61777293e+04]
E1 = -728.2937803827101  E_coul = 201.5535704329471
cycle= 5 E= -526.740209949763  delta_E= -1.67e-09  |g|= 2.04e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.861e-05
diis-c [-7.28802964e-11  1.43971508e-05 -1.87422761e-03 -1.39673950e-02
  4.31535151e-02  9.72673710e-01]
  HOMO = -0.583009904339529  LUMO = 1.00103298201756
  mo_energy =
[-1.18578806e+02 -1.23103214e+01 -9.56164296e+00 -9.56164296e+00
 -9.56164296e+00 -1.27019388e+00 -5.83009904e-01 -5.83009904e-01
 -5.83009904e-01  1.00103298e+00  1.01483440e+00  1.01483440e+00
  1.01483440e+00  7.29366869e+00  7.29366869e+00  7.29366869e+00
  1.28616047e+01  3.34635563e+01  3.34635563e+01  3.34635563e+01
  1.12579041e+02  1.29120701e+02  1.29120701e+02  1.29120701e+02
  4.83504843e+02  4.83504843e+02  4.83504843e+02  6.05869698e+02
  1.33519781e+03  1.33519781e+03  1.33519781e+03  2.67805573e+03
  3.02921629e+03  3.02921629e+03  3.02921629e+03  6.64949344e+03
  6.64949344e+03  6.64949344e+03  9.08249932e+03  2.54368708e+04
  7.61777293e+04]
E1 = -728.2938610032359  E_coul = 201.5536510534152
cycle= 6 E= -526.740209949821  delta_E= -5.76e-11  |g|= 1.73e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2938610032359  E_coul = 201.5536510534152
  HOMO = -0.583009928367383  LUMO = 1.00103331442791
  mo_energy =
[-1.18578806e+02 -1.23103212e+01 -9.56164291e+00 -9.56164291e+00
 -9.56164291e+00 -1.27019352e+00 -5.83009928e-01 -5.83009928e-01
 -5.83009928e-01  1.00103331e+00  1.01483444e+00  1.01483444e+00
  1.01483444e+00  7.29366873e+00  7.29366873e+00  7.29366873e+00
  1.28616049e+01  3.34635564e+01  3.34635564e+01  3.34635564e+01
  1.12579041e+02  1.29120701e+02  1.29120701e+02  1.29120701e+02
  4.83504843e+02  4.83504843e+02  4.83504843e+02  6.05869698e+02
  1.33519781e+03  1.33519781e+03  1.33519781e+03  2.67805573e+03
  3.02921629e+03  3.02921629e+03  3.02921629e+03  6.64949344e+03
  6.64949344e+03  6.64949344e+03  9.08249932e+03  2.54368708e+04
  7.61777293e+04]
E1 = -728.2938600421159  E_coul = 201.55365009229467
Extra cycle  E= -526.740209949821  delta_E= -5.68e-13  |g|= 3.56e-07  |ddm|= 3.02e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103687.05458167658
E1 = -728.2938600421159  E_coul = 201.55365009229467
init E= -526.740209949821
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583009958657106  LUMO = 1.00103336071998
  mo_energy =
[-1.18578806e+02 -1.23103213e+01 -9.56164300e+00 -9.56164300e+00
 -9.56164300e+00 -1.27019347e+00 -5.83009959e-01 -5.83009959e-01
 -5.83009959e-01  1.00103336e+00  1.01483443e+00  1.01483443e+00
  1.01483443e+00  7.29366867e+00  7.29366867e+00  7.29366867e+00
  1.28616048e+01  3.34635563e+01  3.34635563e+01  3.34635563e+01
  1.12579041e+02  1.29120701e+02  1.29120701e+02  1.29120701e+02
  4.83504843e+02  4.83504843e+02  4.83504843e+02  6.05869698e+02
  1.33519781e+03  1.33519781e+03  1.33519781e+03  2.67805573e+03
  3.02921629e+03  3.02921629e+03  3.02921629e+03  6.64949344e+03
  6.64949344e+03  6.64949344e+03  9.08249932e+03  2.54368708e+04
  7.61777293e+04]
E1 = -728.2938601991533  E_coul = 201.55365024933317
cycle= 1 E= -526.74020994982  delta_E= 1.02e-12  |g|= 7.47e-08  |ddm|= 5.93e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2938601991533  E_coul = 201.55365024933317
  HOMO = -0.58300995821721  LUMO = 1.00103337588645
  mo_energy =
[-1.18578806e+02 -1.23103213e+01 -9.56164299e+00 -9.56164299e+00
 -9.56164299e+00 -1.27019346e+00 -5.83009958e-01 -5.83009958e-01
 -5.83009958e-01  1.00103338e+00  1.01483443e+00  1.01483443e+00
  1.01483443e+00  7.29366868e+00  7.29366868e+00  7.29366868e+00
  1.28616048e+01  3.34635563e+01  3.34635563e+01  3.34635563e+01
  1.12579041e+02  1.29120701e+02  1.29120701e+02  1.29120701e+02
  4.83504843e+02  4.83504843e+02  4.83504843e+02  6.05869698e+02
  1.33519781e+03  1.33519781e+03  1.33519781e+03  2.67805573e+03
  3.02921629e+03  3.02921629e+03  3.02921629e+03  6.64949344e+03
  6.64949344e+03  6.64949344e+03  9.08249932e+03  2.54368708e+04
  7.61777293e+04]
E1 = -728.2938601316151  E_coul = 201.55365018179577
Extra cycle  E= -526.740209949819  delta_E= 7.96e-13  |g|= 1.51e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826614e+04 7.61750999e+03 3.61735672e+03 1.59757906e+03
 3.82691030e+02 1.12420352e+02 3.72959637e+01 8.27252088e+00
 3.25755232e+00 6.64233852e-01 2.43998059e-01 1.36278506e+03
 6.64727391e+02 3.00875737e+02 3.13967908e+02 6.16797466e+01
 7.34303487e+00 2.02550085e+01 7.76022884e-01 2.81678926e+00
 2.22767627e-01]
grad_E = [-1.55153830e-06  3.69446134e-06 -1.33344364e-06  8.35758923e-05
 -3.37538018e-04 -9.79775232e-06  2.25521766e-05 -2.97556045e-05
 -1.24764200e-05 -2.00847000e-05  2.73457287e-04 -5.10487851e-07
  4.96481575e-06  2.33878583e-05  2.01586659e-05 -1.09388763e-05
  1.07910952e-04 -3.07481424e-05 -1.24216955e-04 -1.13555565e-04
  3.26782122e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613718        1
[INPUT] 0    0    [1    /1   ]  7617.51002011        1
[INPUT] 0    0    [1    /1   ]  3617.35670545        1
[INPUT] 0    0    [1    /1   ]  1597.57977347        1
[INPUT] 0    0    [1    /1   ]  382.691710467        1
[INPUT] 0    0    [1    /1   ]  112.406640938        1
[INPUT] 0    0    [1    /1   ]  37.290222249         1
[INPUT] 0    0    [1    /1   ]  8.27580315255        1
[INPUT] 0    0    [1    /1   ]  3.25831565475        1
[INPUT] 0    0    [1    /1   ]  0.663693133251       1
[INPUT] 0    0    [1    /1   ]  0.243761739651       1
[INPUT] 1    0    [1    /1   ]  1362.7850544         1
[INPUT] 1    0    [1    /1   ]  664.727443955        1
[INPUT] 1    0    [1    /1   ]  300.875989182        1
[INPUT] 1    0    [1    /1   ]  313.968125099        1
[INPUT] 1    0    [1    /1   ]  61.6795508538        1
[INPUT] 1    0    [1    /1   ]  7.34247094159        1
[INPUT] 1    0    [1    /1   ]  20.2551999152        1
[INPUT] 1    0    [1    /1   ]  0.776036402234       1
[INPUT] 1    0    [1    /1   ]  2.81689139725        1
[INPUT] 1    0    [1    /1   ]  0.222763400387       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661371759204, 1.0]], [0, [7617.510020107629, 1.0]], [0, [3617.356705445355, 1.0]], [0, [1597.5797734686428, 1.0]], [0, [382.69171046661165, 1.0]], [0, [112.40664093797714, 1.0]], [0, [37.29022224896099, 1.0]], [0, [8.275803152554053, 1.0]], [0, [3.258315654750684, 1.0]], [0, [0.6636931332509903, 1.0]], [0, [0.24376173965137382, 1.0]], [1, [1362.7850543954269, 1.0]], [1, [664.7274439547144, 1.0]], [1, [300.87598918200024, 1.0]], [1, [313.9681250986484, 1.0]], [1, [61.67955085383785, 1.0]], [1, [7.342470941586148, 1.0]], [1, [20.25519991524276, 1.0]], [1, [0.7760364022339751, 1.0]], [1, [2.816891397246209, 1.0]], [1, [0.22276340038652334, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66137176]
bas 1, expnt(s) = [7617.51002011]
bas 2, expnt(s) = [3617.35670545]
bas 3, expnt(s) = [1597.57977347]
bas 4, expnt(s) = [382.69171047]
bas 5, expnt(s) = [112.40664094]
bas 6, expnt(s) = [37.29022225]
bas 7, expnt(s) = [8.27580315]
bas 8, expnt(s) = [3.25831565]
bas 9, expnt(s) = [0.66369313]
bas 10, expnt(s) = [0.24376174]
bas 11, expnt(s) = [1362.7850544]
bas 12, expnt(s) = [664.72744395]
bas 13, expnt(s) = [300.87598918]
bas 14, expnt(s) = [313.9681251]
bas 15, expnt(s) = [61.67955085]
bas 16, expnt(s) = [7.34247094]
bas 17, expnt(s) = [20.25519992]
bas 18, expnt(s) = [0.7760364]
bas 19, expnt(s) = [2.8168914]
bas 20, expnt(s) = [0.2227634]
CPU time:       306.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026369e+03 7.61751002e+03 2.06003595e+03
 3.61735671e+03 1.17844285e+03 1.59757977e+03 6.38428020e+02
 3.82691710e+02 2.18600834e+02 1.12406641e+02 8.72185780e+01
 3.72902222e+01 3.81251230e+01 8.27580315e+00 1.23274326e+01
 3.25831565e+00 6.12716944e+00 6.63693133e-01 1.85776389e+00
 2.43761740e-01 8.76474287e-01 1.36278505e+03 2.41556426e+04
 6.64727444e+02 9.84665914e+03 3.00875989e+02 3.65568533e+03
 3.13968125e+02 3.85559441e+03 6.16795509e+01 5.04267404e+02
 7.34247094e+00 3.52603962e+01 2.02551999e+01 1.25358867e+02
 7.76036402e-01 2.12489272e+00 2.81689140e+00 1.06462589e+01
 2.22763400e-01 4.46466822e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99357862726984
cond(S) = 103686.25342296198
E1 = -729.5305057291127  E_coul = 203.17851173443572
init E= -526.351993994677
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555770818274876  LUMO = 1.02116429398382
  mo_energy =
[-1.18329035e+02 -1.22049628e+01 -9.44683446e+00 -9.44683446e+00
 -9.44683446e+00 -1.24002129e+00 -5.55770818e-01 -5.55770818e-01
 -5.55770818e-01  1.02116429e+00  1.03348881e+00  1.03348881e+00
  1.03348881e+00  7.36452586e+00  7.36452586e+00  7.36452586e+00
  1.29486833e+01  3.35828606e+01  3.35828606e+01  3.35828606e+01
  1.12750709e+02  1.29300074e+02  1.29300074e+02  1.29300074e+02
  4.83752810e+02  4.83752810e+02  4.83752810e+02  6.06113675e+02
  1.33549895e+03  1.33549895e+03  1.33549895e+03  2.67843146e+03
  3.02958180e+03  3.02958180e+03  3.02958180e+03  6.64997101e+03
  6.64997101e+03  6.64997101e+03  9.08299584e+03  2.54374640e+04
  7.61784160e+04]
E1 = -727.8479540119614  E_coul = 201.10852211120843
cycle= 1 E= -526.739431900753  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541929
diis-c [-0.29368676  1.        ]
  HOMO = -0.590639848373774  LUMO = 0.992601509869939
  mo_energy =
[-1.18636478e+02 -1.23425646e+01 -9.59518024e+00 -9.59518024e+00
 -9.59518024e+00 -1.27944748e+00 -5.90639848e-01 -5.90639848e-01
 -5.90639848e-01  9.92601510e-01  1.00917142e+00  1.00917142e+00
  1.00917142e+00  7.27371175e+00  7.27371175e+00  7.27371175e+00
  1.28372916e+01  3.34288528e+01  3.34288528e+01  3.34288528e+01
  1.12527523e+02  1.29071952e+02  1.29071952e+02  1.29071952e+02
  4.83446708e+02  4.83446708e+02  4.83446708e+02  6.05768870e+02
  1.33513674e+03  1.33513674e+03  1.33513674e+03  2.67793607e+03
  3.02915409e+03  3.02915409e+03  3.02915409e+03  6.64943043e+03
  6.64943043e+03  6.64943043e+03  9.08238038e+03  2.54367545e+04
  7.61776165e+04]
E1 = -728.4211358030132  E_coul = 201.68098623816962
cycle= 2 E= -526.740149564843  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750241
diis-c [-0.00330635  0.08208681  0.91791319]
  HOMO = -0.581532669774075  LUMO = 1.00080023611025
  mo_energy =
[-1.18568859e+02 -1.23045574e+01 -9.55552047e+00 -9.55552047e+00
 -9.55552047e+00 -1.26854593e+00 -5.81532670e-01 -5.81532670e-01
 -5.81532670e-01  1.00080024e+00  1.01589605e+00  1.01589605e+00
  1.01589605e+00  7.29745379e+00  7.29745379e+00  7.29745379e+00
  1.28678125e+01  3.34688927e+01  3.34688927e+01  3.34688927e+01
  1.12583754e+02  1.29127784e+02  1.29127784e+02  1.29127784e+02
  4.83513510e+02  4.83513510e+02  4.83513510e+02  6.05838110e+02
  1.33520759e+03  1.33520759e+03  1.33520759e+03  2.67801023e+03
  3.02922717e+03  3.02922717e+03  3.02922717e+03  6.64950526e+03
  6.64950526e+03  6.64950526e+03  9.08245602e+03  2.54368307e+04
  7.61776930e+04]
E1 = -728.270975424797  E_coul = 201.53076712796698
cycle= 3 E= -526.74020829683  delta_E= -5.87e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131725
diis-c [-5.72576250e-07 -1.23744591e-03  1.44939764e-01  8.56297682e-01]
  HOMO = -0.583032783867842  LUMO = 0.999545990432895
  mo_energy =
[-1.18578827e+02 -1.23103704e+01 -9.56167998e+00 -9.56167998e+00
 -9.56167998e+00 -1.27023927e+00 -5.83032784e-01 -5.83032784e-01
 -5.83032784e-01  9.99545990e-01  1.01481257e+00  1.01481257e+00
  1.01481257e+00  7.29367080e+00  7.29367080e+00  7.29367080e+00
  1.28631178e+01  3.34627140e+01  3.34627140e+01  3.34627140e+01
  1.12575393e+02  1.29119427e+02  1.29119427e+02  1.29119427e+02
  4.83503658e+02  4.83503658e+02  4.83503658e+02  6.05827892e+02
  1.33519715e+03  1.33519715e+03  1.33519715e+03  2.67799916e+03
  3.02921634e+03  3.02921634e+03  3.02921634e+03  6.64949405e+03
  6.64949405e+03  6.64949405e+03  9.08244459e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.2937857456674  E_coul = 201.5535755242168
cycle= 4 E= -526.740210221451  delta_E= -1.92e-06  |g|= 9.75e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113274
diis-c [-4.05463923e-09  7.22771288e-05 -1.03421676e-02 -6.69517642e-02
  1.07722165e+00]
  HOMO = -0.583014775541491  LUMO = 0.99957967724077
  mo_energy =
[-1.18578788e+02 -1.23103070e+01 -9.56163008e+00 -9.56163008e+00
 -9.56163008e+00 -1.27019876e+00 -5.83014776e-01 -5.83014776e-01
 -5.83014776e-01  9.99579677e-01  1.01482812e+00  1.01482812e+00
  1.01482812e+00  7.29371165e+00  7.29371165e+00  7.29371165e+00
  1.28631764e+01  3.34627620e+01  3.34627620e+01  3.34627620e+01
  1.12575443e+02  1.29119473e+02  1.29119473e+02  1.29119473e+02
  4.83503697e+02  4.83503697e+02  4.83503697e+02  6.05827924e+02
  1.33519718e+03  1.33519718e+03  1.33519718e+03  2.67799917e+03
  3.02921636e+03  3.02921636e+03  3.02921636e+03  6.64949405e+03
  6.64949405e+03  6.64949405e+03  9.08244459e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.2935770242437  E_coul = 201.5533668011176
cycle= 5 E= -526.740210223126  delta_E= -1.68e-09  |g|= 2.04e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86316e-05
diis-c [-7.31277467e-11  1.44119706e-05 -1.87575829e-03 -1.39776181e-02
  4.30097011e-02  9.72829263e-01]
  HOMO = -0.583022151772623  LUMO = 0.999575754499553
  mo_energy =
[-1.18578819e+02 -1.23103293e+01 -9.56165432e+00 -9.56165432e+00
 -9.56165432e+00 -1.27020463e+00 -5.83022152e-01 -5.83022152e-01
 -5.83022152e-01  9.99575754e-01  1.01482323e+00  1.01482323e+00
  1.01482323e+00  7.29369520e+00  7.29369520e+00  7.29369520e+00
  1.28631582e+01  3.34627385e+01  3.34627385e+01  3.34627385e+01
  1.12575416e+02  1.29119446e+02  1.29119446e+02  1.29119446e+02
  4.83503667e+02  4.83503667e+02  4.83503667e+02  6.05827893e+02
  1.33519715e+03  1.33519715e+03  1.33519715e+03  2.67799913e+03
  3.02921633e+03  3.02921633e+03  3.02921633e+03  6.64949402e+03
  6.64949402e+03  6.64949402e+03  9.08244456e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.2936576927016  E_coul = 201.55344746951852
cycle= 6 E= -526.740210223183  delta_E= -5.7e-11  |g|= 1.73e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2936576927016  E_coul = 201.55344746951852
  HOMO = -0.583022174623128  LUMO = 0.999576087902253
  mo_energy =
[-1.18578819e+02 -1.23103292e+01 -9.56165427e+00 -9.56165427e+00
 -9.56165427e+00 -1.27020427e+00 -5.83022175e-01 -5.83022175e-01
 -5.83022175e-01  9.99576088e-01  1.01482327e+00  1.01482327e+00
  1.01482327e+00  7.29369524e+00  7.29369524e+00  7.29369524e+00
  1.28631584e+01  3.34627385e+01  3.34627385e+01  3.34627385e+01
  1.12575416e+02  1.29119446e+02  1.29119446e+02  1.29119446e+02
  4.83503667e+02  4.83503667e+02  4.83503667e+02  6.05827893e+02
  1.33519715e+03  1.33519715e+03  1.33519715e+03  2.67799914e+03
  3.02921633e+03  3.02921633e+03  3.02921633e+03  6.64949402e+03
  6.64949402e+03  6.64949402e+03  9.08244456e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.293656711499  E_coul = 201.55344648831417
Extra cycle  E= -526.740210223185  delta_E= -1.71e-12  |g|= 3.57e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826614e+04 7.61751002e+03 3.61735671e+03 1.59757977e+03
 3.82691710e+02 1.12406641e+02 3.72902222e+01 8.27580315e+00
 3.25831565e+00 6.63693133e-01 2.43761740e-01 1.36278505e+03
 6.64727444e+02 3.00875989e+02 3.13968125e+02 6.16795509e+01
 7.34247094e+00 2.02551999e+01 7.76036402e-01 2.81689140e+00
 2.22763400e-01]
E = -526.7402102231848
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613718        1
[INPUT] 0    0    [1    /1   ]  7617.51002011        1
[INPUT] 0    0    [1    /1   ]  3617.35670545        1
[INPUT] 0    0    [1    /1   ]  1597.57977347        1
[INPUT] 0    0    [1    /1   ]  382.691710467        1
[INPUT] 0    0    [1    /1   ]  112.406640938        1
[INPUT] 0    0    [1    /1   ]  37.290222249         1
[INPUT] 0    0    [1    /1   ]  8.27580315255        1
[INPUT] 0    0    [1    /1   ]  3.25831565475        1
[INPUT] 0    0    [1    /1   ]  0.663693133251       1
[INPUT] 0    0    [1    /1   ]  0.243761739651       1
[INPUT] 1    0    [1    /1   ]  1362.7850544         1
[INPUT] 1    0    [1    /1   ]  664.727443955        1
[INPUT] 1    0    [1    /1   ]  300.875989182        1
[INPUT] 1    0    [1    /1   ]  313.968125099        1
[INPUT] 1    0    [1    /1   ]  61.6795508538        1
[INPUT] 1    0    [1    /1   ]  7.34247094159        1
[INPUT] 1    0    [1    /1   ]  20.2551999152        1
[INPUT] 1    0    [1    /1   ]  0.776036402234       1
[INPUT] 1    0    [1    /1   ]  2.81689139725        1
[INPUT] 1    0    [1    /1   ]  0.222763400387       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661371759204, 1.0]], [0, [7617.510020107629, 1.0]], [0, [3617.356705445355, 1.0]], [0, [1597.5797734686428, 1.0]], [0, [382.69171046661165, 1.0]], [0, [112.40664093797714, 1.0]], [0, [37.29022224896099, 1.0]], [0, [8.275803152554053, 1.0]], [0, [3.258315654750684, 1.0]], [0, [0.6636931332509903, 1.0]], [0, [0.24376173965137382, 1.0]], [1, [1362.7850543954269, 1.0]], [1, [664.7274439547144, 1.0]], [1, [300.87598918200024, 1.0]], [1, [313.9681250986484, 1.0]], [1, [61.67955085383785, 1.0]], [1, [7.342470941586148, 1.0]], [1, [20.25519991524276, 1.0]], [1, [0.7760364022339751, 1.0]], [1, [2.816891397246209, 1.0]], [1, [0.22276340038652334, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66137176]
bas 1, expnt(s) = [7617.51002011]
bas 2, expnt(s) = [3617.35670545]
bas 3, expnt(s) = [1597.57977347]
bas 4, expnt(s) = [382.69171047]
bas 5, expnt(s) = [112.40664094]
bas 6, expnt(s) = [37.29022225]
bas 7, expnt(s) = [8.27580315]
bas 8, expnt(s) = [3.25831565]
bas 9, expnt(s) = [0.66369313]
bas 10, expnt(s) = [0.24376174]
bas 11, expnt(s) = [1362.7850544]
bas 12, expnt(s) = [664.72744395]
bas 13, expnt(s) = [300.87598918]
bas 14, expnt(s) = [313.9681251]
bas 15, expnt(s) = [61.67955085]
bas 16, expnt(s) = [7.34247094]
bas 17, expnt(s) = [20.25519992]
bas 18, expnt(s) = [0.7760364]
bas 19, expnt(s) = [2.8168914]
bas 20, expnt(s) = [0.2227634]
CPU time:       306.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026369e+03 7.61751002e+03 2.06003595e+03
 3.61735671e+03 1.17844285e+03 1.59757977e+03 6.38428020e+02
 3.82691710e+02 2.18600834e+02 1.12406641e+02 8.72185780e+01
 3.72902222e+01 3.81251230e+01 8.27580315e+00 1.23274326e+01
 3.25831565e+00 6.12716944e+00 6.63693133e-01 1.85776389e+00
 2.43761740e-01 8.76474287e-01 1.36278505e+03 2.41556426e+04
 6.64727444e+02 9.84665914e+03 3.00875989e+02 3.65568533e+03
 3.13968125e+02 3.85559441e+03 6.16795509e+01 5.04267404e+02
 7.34247094e+00 3.52603962e+01 2.02551999e+01 1.25358867e+02
 7.76036402e-01 2.12489272e+00 2.81689140e+00 1.06462589e+01
 2.22763400e-01 4.46466822e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99357862726984
cond(S) = 103686.25342296198
E1 = -729.5305057291127  E_coul = 203.17851173443572
init E= -526.351993994677
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555770818274876  LUMO = 1.02116429398382
  mo_energy =
[-1.18329035e+02 -1.22049628e+01 -9.44683446e+00 -9.44683446e+00
 -9.44683446e+00 -1.24002129e+00 -5.55770818e-01 -5.55770818e-01
 -5.55770818e-01  1.02116429e+00  1.03348881e+00  1.03348881e+00
  1.03348881e+00  7.36452586e+00  7.36452586e+00  7.36452586e+00
  1.29486833e+01  3.35828606e+01  3.35828606e+01  3.35828606e+01
  1.12750709e+02  1.29300074e+02  1.29300074e+02  1.29300074e+02
  4.83752810e+02  4.83752810e+02  4.83752810e+02  6.06113675e+02
  1.33549895e+03  1.33549895e+03  1.33549895e+03  2.67843146e+03
  3.02958180e+03  3.02958180e+03  3.02958180e+03  6.64997101e+03
  6.64997101e+03  6.64997101e+03  9.08299584e+03  2.54374640e+04
  7.61784160e+04]
E1 = -727.8479540119614  E_coul = 201.10852211120843
cycle= 1 E= -526.739431900753  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541929
diis-c [-0.29368676  1.        ]
  HOMO = -0.590639848373774  LUMO = 0.992601509869939
  mo_energy =
[-1.18636478e+02 -1.23425646e+01 -9.59518024e+00 -9.59518024e+00
 -9.59518024e+00 -1.27944748e+00 -5.90639848e-01 -5.90639848e-01
 -5.90639848e-01  9.92601510e-01  1.00917142e+00  1.00917142e+00
  1.00917142e+00  7.27371175e+00  7.27371175e+00  7.27371175e+00
  1.28372916e+01  3.34288528e+01  3.34288528e+01  3.34288528e+01
  1.12527523e+02  1.29071952e+02  1.29071952e+02  1.29071952e+02
  4.83446708e+02  4.83446708e+02  4.83446708e+02  6.05768870e+02
  1.33513674e+03  1.33513674e+03  1.33513674e+03  2.67793607e+03
  3.02915409e+03  3.02915409e+03  3.02915409e+03  6.64943043e+03
  6.64943043e+03  6.64943043e+03  9.08238038e+03  2.54367545e+04
  7.61776165e+04]
E1 = -728.4211358030132  E_coul = 201.68098623816962
cycle= 2 E= -526.740149564843  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750241
diis-c [-0.00330635  0.08208681  0.91791319]
  HOMO = -0.581532669774075  LUMO = 1.00080023611025
  mo_energy =
[-1.18568859e+02 -1.23045574e+01 -9.55552047e+00 -9.55552047e+00
 -9.55552047e+00 -1.26854593e+00 -5.81532670e-01 -5.81532670e-01
 -5.81532670e-01  1.00080024e+00  1.01589605e+00  1.01589605e+00
  1.01589605e+00  7.29745379e+00  7.29745379e+00  7.29745379e+00
  1.28678125e+01  3.34688927e+01  3.34688927e+01  3.34688927e+01
  1.12583754e+02  1.29127784e+02  1.29127784e+02  1.29127784e+02
  4.83513510e+02  4.83513510e+02  4.83513510e+02  6.05838110e+02
  1.33520759e+03  1.33520759e+03  1.33520759e+03  2.67801023e+03
  3.02922717e+03  3.02922717e+03  3.02922717e+03  6.64950526e+03
  6.64950526e+03  6.64950526e+03  9.08245602e+03  2.54368307e+04
  7.61776930e+04]
E1 = -728.270975424797  E_coul = 201.53076712796698
cycle= 3 E= -526.74020829683  delta_E= -5.87e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131725
diis-c [-5.72576250e-07 -1.23744591e-03  1.44939764e-01  8.56297682e-01]
  HOMO = -0.583032783867842  LUMO = 0.999545990432895
  mo_energy =
[-1.18578827e+02 -1.23103704e+01 -9.56167998e+00 -9.56167998e+00
 -9.56167998e+00 -1.27023927e+00 -5.83032784e-01 -5.83032784e-01
 -5.83032784e-01  9.99545990e-01  1.01481257e+00  1.01481257e+00
  1.01481257e+00  7.29367080e+00  7.29367080e+00  7.29367080e+00
  1.28631178e+01  3.34627140e+01  3.34627140e+01  3.34627140e+01
  1.12575393e+02  1.29119427e+02  1.29119427e+02  1.29119427e+02
  4.83503658e+02  4.83503658e+02  4.83503658e+02  6.05827892e+02
  1.33519715e+03  1.33519715e+03  1.33519715e+03  2.67799916e+03
  3.02921634e+03  3.02921634e+03  3.02921634e+03  6.64949405e+03
  6.64949405e+03  6.64949405e+03  9.08244459e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.2937857456674  E_coul = 201.5535755242168
cycle= 4 E= -526.740210221451  delta_E= -1.92e-06  |g|= 9.75e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113274
diis-c [-4.05463923e-09  7.22771288e-05 -1.03421676e-02 -6.69517642e-02
  1.07722165e+00]
  HOMO = -0.583014775541491  LUMO = 0.99957967724077
  mo_energy =
[-1.18578788e+02 -1.23103070e+01 -9.56163008e+00 -9.56163008e+00
 -9.56163008e+00 -1.27019876e+00 -5.83014776e-01 -5.83014776e-01
 -5.83014776e-01  9.99579677e-01  1.01482812e+00  1.01482812e+00
  1.01482812e+00  7.29371165e+00  7.29371165e+00  7.29371165e+00
  1.28631764e+01  3.34627620e+01  3.34627620e+01  3.34627620e+01
  1.12575443e+02  1.29119473e+02  1.29119473e+02  1.29119473e+02
  4.83503697e+02  4.83503697e+02  4.83503697e+02  6.05827924e+02
  1.33519718e+03  1.33519718e+03  1.33519718e+03  2.67799917e+03
  3.02921636e+03  3.02921636e+03  3.02921636e+03  6.64949405e+03
  6.64949405e+03  6.64949405e+03  9.08244459e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.2935770242437  E_coul = 201.5533668011176
cycle= 5 E= -526.740210223126  delta_E= -1.68e-09  |g|= 2.04e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86316e-05
diis-c [-7.31277467e-11  1.44119706e-05 -1.87575829e-03 -1.39776181e-02
  4.30097011e-02  9.72829263e-01]
  HOMO = -0.583022151772623  LUMO = 0.999575754499553
  mo_energy =
[-1.18578819e+02 -1.23103293e+01 -9.56165432e+00 -9.56165432e+00
 -9.56165432e+00 -1.27020463e+00 -5.83022152e-01 -5.83022152e-01
 -5.83022152e-01  9.99575754e-01  1.01482323e+00  1.01482323e+00
  1.01482323e+00  7.29369520e+00  7.29369520e+00  7.29369520e+00
  1.28631582e+01  3.34627385e+01  3.34627385e+01  3.34627385e+01
  1.12575416e+02  1.29119446e+02  1.29119446e+02  1.29119446e+02
  4.83503667e+02  4.83503667e+02  4.83503667e+02  6.05827893e+02
  1.33519715e+03  1.33519715e+03  1.33519715e+03  2.67799913e+03
  3.02921633e+03  3.02921633e+03  3.02921633e+03  6.64949402e+03
  6.64949402e+03  6.64949402e+03  9.08244456e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.2936576927016  E_coul = 201.55344746951852
cycle= 6 E= -526.740210223183  delta_E= -5.7e-11  |g|= 1.73e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2936576927016  E_coul = 201.55344746951852
  HOMO = -0.583022174623128  LUMO = 0.999576087902253
  mo_energy =
[-1.18578819e+02 -1.23103292e+01 -9.56165427e+00 -9.56165427e+00
 -9.56165427e+00 -1.27020427e+00 -5.83022175e-01 -5.83022175e-01
 -5.83022175e-01  9.99576088e-01  1.01482327e+00  1.01482327e+00
  1.01482327e+00  7.29369524e+00  7.29369524e+00  7.29369524e+00
  1.28631584e+01  3.34627385e+01  3.34627385e+01  3.34627385e+01
  1.12575416e+02  1.29119446e+02  1.29119446e+02  1.29119446e+02
  4.83503667e+02  4.83503667e+02  4.83503667e+02  6.05827893e+02
  1.33519715e+03  1.33519715e+03  1.33519715e+03  2.67799914e+03
  3.02921633e+03  3.02921633e+03  3.02921633e+03  6.64949402e+03
  6.64949402e+03  6.64949402e+03  9.08244456e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.293656711499  E_coul = 201.55344648831417
Extra cycle  E= -526.740210223185  delta_E= -1.71e-12  |g|= 3.57e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103686.25342296198
E1 = -728.293656711499  E_coul = 201.55344648831417
init E= -526.740210223185
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583022205343381  LUMO = 0.999576133848811
  mo_energy =
[-1.18578819e+02 -1.23103293e+01 -9.56165436e+00 -9.56165436e+00
 -9.56165436e+00 -1.27020422e+00 -5.83022205e-01 -5.83022205e-01
 -5.83022205e-01  9.99576134e-01  1.01482326e+00  1.01482326e+00
  1.01482326e+00  7.29369518e+00  7.29369518e+00  7.29369518e+00
  1.28631583e+01  3.34627385e+01  3.34627385e+01  3.34627385e+01
  1.12575416e+02  1.29119446e+02  1.29119446e+02  1.29119446e+02
  4.83503667e+02  4.83503667e+02  4.83503667e+02  6.05827893e+02
  1.33519715e+03  1.33519715e+03  1.33519715e+03  2.67799913e+03
  3.02921633e+03  3.02921633e+03  3.02921633e+03  6.64949402e+03
  6.64949402e+03  6.64949402e+03  9.08244456e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.293656873662  E_coul = 201.55344665047838
cycle= 1 E= -526.740210223184  delta_E= 1.14e-12  |g|= 7.48e-08  |ddm|= 5.93e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.293656873662  E_coul = 201.55344665047838
  HOMO = -0.583022204815965  LUMO = 0.999576149094787
  mo_energy =
[-1.18578819e+02 -1.23103292e+01 -9.56165435e+00 -9.56165435e+00
 -9.56165435e+00 -1.27020421e+00 -5.83022205e-01 -5.83022205e-01
 -5.83022205e-01  9.99576149e-01  1.01482326e+00  1.01482326e+00
  1.01482326e+00  7.29369519e+00  7.29369519e+00  7.29369519e+00
  1.28631584e+01  3.34627385e+01  3.34627385e+01  3.34627385e+01
  1.12575416e+02  1.29119446e+02  1.29119446e+02  1.29119446e+02
  4.83503667e+02  4.83503667e+02  4.83503667e+02  6.05827893e+02
  1.33519715e+03  1.33519715e+03  1.33519715e+03  2.67799913e+03
  3.02921633e+03  3.02921633e+03  3.02921633e+03  6.64949402e+03
  6.64949402e+03  6.64949402e+03  9.08244456e+03  2.54368191e+04
  7.61776812e+04]
E1 = -728.2936568045614  E_coul = 201.5534465813778
Extra cycle  E= -526.740210223184  delta_E= 1.14e-13  |g|= 1.51e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826614e+04 7.61751002e+03 3.61735671e+03 1.59757977e+03
 3.82691710e+02 1.12406641e+02 3.72902222e+01 8.27580315e+00
 3.25831565e+00 6.63693133e-01 2.43761740e-01 1.36278505e+03
 6.64727444e+02 3.00875989e+02 3.13968125e+02 6.16795509e+01
 7.34247094e+00 2.02551999e+01 7.76036402e-01 2.81689140e+00
 2.22763400e-01]
grad_E = [-1.55141652e-06  3.69300756e-06 -1.33454072e-06  8.35222394e-05
 -3.36388573e-04 -1.28413743e-05  1.77460848e-05 -2.09922221e-05
  1.14123375e-05 -9.40179866e-07 -1.52245718e-05 -5.10182719e-07
  4.96902215e-06  2.34133966e-05  2.01805941e-05 -1.39572899e-05
  1.92945466e-05 -4.04275323e-06 -3.24890208e-05 -1.34436071e-05
  9.15309807e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613609        1
[INPUT] 0    0    [1    /1   ]  7617.51004278        1
[INPUT] 0    0    [1    /1   ]  3617.35669337        1
[INPUT] 0    0    [1    /1   ]  1597.58022803        1
[INPUT] 0    0    [1    /1   ]  382.692792979        1
[INPUT] 0    0    [1    /1   ]  112.395350102        1
[INPUT] 0    0    [1    /1   ]  37.2857042318        1
[INPUT] 0    0    [1    /1   ]  8.27710303497        1
[INPUT] 0    0    [1    /1   ]  3.25844333588        1
[INPUT] 0    0    [1    /1   ]  0.663463255011       1
[INPUT] 0    0    [1    /1   ]  0.243655573609       1
[INPUT] 1    0    [1    /1   ]  1362.78505075        1
[INPUT] 1    0    [1    /1   ]  664.72748013         1
[INPUT] 1    0    [1    /1   ]  300.876159889        1
[INPUT] 1    0    [1    /1   ]  313.968272288        1
[INPUT] 1    0    [1    /1   ]  61.6793988596        1
[INPUT] 1    0    [1    /1   ]  7.34192146024        1
[INPUT] 1    0    [1    /1   ]  20.2554349929        1
[INPUT] 1    0    [1    /1   ]  0.776042153707       1
[INPUT] 1    0    [1    /1   ]  2.81685585838        1
[INPUT] 1    0    [1    /1   ]  0.22275729407        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661360926104, 1.0]], [0, [7617.510042783228, 1.0]], [0, [3617.3566933702177, 1.0]], [0, [1597.5802280286064, 1.0]], [0, [382.6927929790974, 1.0]], [0, [112.39535010157199, 1.0]], [0, [37.28570423176288, 1.0]], [0, [8.277103034974305, 1.0]], [0, [3.2584433358766915, 1.0]], [0, [0.6634632550114566, 1.0]], [0, [0.24365557360921786, 1.0]], [1, [1362.7850507515082, 1.0]], [1, [664.727480130401, 1.0]], [1, [300.8761598893373, 1.0]], [1, [313.9682722879891, 1.0]], [1, [61.67939885956179, 1.0]], [1, [7.341921460242558, 1.0]], [1, [20.255434992919014, 1.0]], [1, [0.776042153707037, 1.0]], [1, [2.8168558583760466, 1.0]], [1, [0.22275729407024766, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66136093]
bas 1, expnt(s) = [7617.51004278]
bas 2, expnt(s) = [3617.35669337]
bas 3, expnt(s) = [1597.58022803]
bas 4, expnt(s) = [382.69279298]
bas 5, expnt(s) = [112.3953501]
bas 6, expnt(s) = [37.28570423]
bas 7, expnt(s) = [8.27710303]
bas 8, expnt(s) = [3.25844334]
bas 9, expnt(s) = [0.66346326]
bas 10, expnt(s) = [0.24365557]
bas 11, expnt(s) = [1362.78505075]
bas 12, expnt(s) = [664.72748013]
bas 13, expnt(s) = [300.87615989]
bas 14, expnt(s) = [313.96827229]
bas 15, expnt(s) = [61.67939886]
bas 16, expnt(s) = [7.34192146]
bas 17, expnt(s) = [20.25543499]
bas 18, expnt(s) = [0.77604215]
bas 19, expnt(s) = [2.81685586]
bas 20, expnt(s) = [0.22275729]
CPU time:       312.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026369e+03 7.61751004e+03 2.06003596e+03
 3.61735669e+03 1.17844285e+03 1.59758023e+03 6.38428156e+02
 3.82692793e+02 2.18601298e+02 1.12395350e+02 8.72120073e+01
 3.72857042e+01 3.81216585e+01 8.27710303e+00 1.23288848e+01
 3.25844334e+00 6.12734952e+00 6.63463255e-01 1.85728128e+00
 2.43655574e-01 8.76187972e-01 1.36278505e+03 2.41556425e+04
 6.64727480e+02 9.84665981e+03 3.00876160e+02 3.65568793e+03
 3.13968272e+02 3.85559667e+03 6.16793989e+01 5.04265850e+02
 7.34192146e+00 3.52570978e+01 2.02554350e+01 1.25360686e+02
 7.76042154e-01 2.12491241e+00 2.81685586e+00 1.06460910e+01
 2.22757294e-01 4.46451524e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993579797501564
cond(S) = 103685.5004639074
E1 = -729.5305279727734  E_coul = 203.17852889454642
init E= -526.351999078227
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555771461772641  LUMO = 1.02050715272448
  mo_energy =
[-1.18329034e+02 -1.22049596e+01 -9.44683233e+00 -9.44683233e+00
 -9.44683233e+00 -1.24002202e+00 -5.55771462e-01 -5.55771462e-01
 -5.55771462e-01  1.02050715e+00  1.03347078e+00  1.03347078e+00
  1.03347078e+00  7.36429939e+00  7.36429939e+00  7.36429939e+00
  1.29486088e+01  3.35815947e+01  3.35815947e+01  3.35815947e+01
  1.12741634e+02  1.29298552e+02  1.29298552e+02  1.29298552e+02
  4.83751523e+02  4.83751523e+02  4.83751523e+02  6.06074052e+02
  1.33549807e+03  1.33549807e+03  1.33549807e+03  2.67838140e+03
  3.02958144e+03  3.02958144e+03  3.02958144e+03  6.64997105e+03
  6.64997105e+03  6.64997105e+03  9.08294796e+03  2.54374187e+04
  7.61783739e+04]
E1 = -727.847754342556  E_coul = 201.10832235347613
cycle= 1 E= -526.73943198908  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541933
diis-c [-0.29369091  1.        ]
  HOMO = -0.590648885747089  LUMO = 0.991951572053712
  mo_energy =
[-1.18636493e+02 -1.23425757e+01 -9.59519295e+00 -9.59519295e+00
 -9.59519295e+00 -1.27945609e+00 -5.90648886e-01 -5.90648886e-01
 -5.90648886e-01  9.91951572e-01  1.00914740e+00  1.00914740e+00
  1.00914740e+00  7.27347499e+00  7.27347499e+00  7.27347499e+00
  1.28372003e+01  3.34275735e+01  3.34275735e+01  3.34275735e+01
  1.12518439e+02  1.29070414e+02  1.29070414e+02  1.29070414e+02
  4.83445404e+02  4.83445404e+02  4.83445404e+02  6.05729232e+02
  1.33513585e+03  1.33513585e+03  1.33513585e+03  2.67788599e+03
  3.02915371e+03  3.02915371e+03  3.02915371e+03  6.64943045e+03
  6.64943045e+03  6.64943045e+03  9.08233248e+03  2.54367092e+04
  7.61775744e+04]
E1 = -728.4209923291183  E_coul = 201.6808425435251
cycle= 2 E= -526.740149785593  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750294
diis-c [-0.00330665  0.08209453  0.91790547]
  HOMO = -0.58154070347894  LUMO = 1.00014773911594
  mo_energy =
[-1.18568869e+02 -1.23045649e+01 -9.55552963e+00 -9.55552963e+00
 -9.55552963e+00 -1.26855320e+00 -5.81540703e-01 -5.81540703e-01
 -5.81540703e-01  1.00014774e+00  1.01587279e+00  1.01587279e+00
  1.01587279e+00  7.29721882e+00  7.29721882e+00  7.29721882e+00
  1.28677257e+01  3.34676167e+01  3.34676167e+01  3.34676167e+01
  1.12574673e+02  1.29126251e+02  1.29126251e+02  1.29126251e+02
  4.83512211e+02  4.83512211e+02  4.83512211e+02  6.05798477e+02
  1.33520670e+03  1.33520670e+03  1.33520670e+03  2.67796016e+03
  3.02922680e+03  3.02922680e+03  3.02922680e+03  6.64950528e+03
  6.64950528e+03  6.64950528e+03  9.08240813e+03  2.54367854e+04
  7.61776509e+04]
E1 = -728.2708156085549  E_coul = 201.53060707855138
cycle= 3 E= -526.740208530004  delta_E= -5.87e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131733
diis-c [-5.73003460e-07 -1.23756890e-03  1.44936997e-01  8.56300572e-01]
  HOMO = -0.583040995872469  LUMO = 0.998893957267605
  mo_energy =
[-1.18578838e+02 -1.23103783e+01 -9.56168953e+00 -9.56168953e+00
 -9.56168953e+00 -1.27024667e+00 -5.83040996e-01 -5.83040996e-01
 -5.83040996e-01  9.98893957e-01  1.01478919e+00  1.01478919e+00
  1.01478919e+00  7.29343562e+00  7.29343562e+00  7.29343562e+00
  1.28630305e+01  3.34614376e+01  3.34614376e+01  3.34614376e+01
  1.12566312e+02  1.29117894e+02  1.29117894e+02  1.29117894e+02
  4.83502358e+02  4.83502358e+02  4.83502358e+02  6.05788259e+02
  1.33519626e+03  1.33519626e+03  1.33519626e+03  2.67794908e+03
  3.02921597e+03  3.02921597e+03  3.02921597e+03  6.64949406e+03
  6.64949406e+03  6.64949406e+03  9.08239670e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.2936275263644  E_coul = 201.5534170714424
cycle= 4 E= -526.740210454922  delta_E= -1.92e-06  |g|= 9.76e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113371
diis-c [-4.05821904e-09  7.23492267e-05 -1.03506866e-02 -6.70094522e-02
  1.07728779e+00]
  HOMO = -0.583022999907889  LUMO = 0.998927641741484
  mo_energy =
[-1.18578799e+02 -1.23103149e+01 -9.56163965e+00 -9.56163965e+00
 -9.56163965e+00 -1.27020615e+00 -5.83023000e-01 -5.83023000e-01
 -5.83023000e-01  9.98927642e-01  1.01480473e+00  1.01480473e+00
  1.01480473e+00  7.29347644e+00  7.29347644e+00  7.29347644e+00
  1.28630891e+01  3.34614856e+01  3.34614856e+01  3.34614856e+01
  1.12566362e+02  1.29117940e+02  1.29117940e+02  1.29117940e+02
  4.83502397e+02  4.83502397e+02  4.83502397e+02  6.05788291e+02
  1.33519629e+03  1.33519629e+03  1.33519629e+03  2.67794909e+03
  3.02921599e+03  3.02921599e+03  3.02921599e+03  6.64949407e+03
  6.64949407e+03  6.64949407e+03  9.08239670e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.293418809605  E_coul = 201.55320835300336
cycle= 5 E= -526.740210456602  delta_E= -1.68e-09  |g|= 2.05e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86441e-05
diis-c [-7.32403642e-11  1.44176712e-05 -1.87625072e-03 -1.39814608e-02
  4.29623052e-02  9.72880989e-01]
  HOMO = -0.583030380362372  LUMO = 0.998923719745592
  mo_energy =
[-1.18578829e+02 -1.23103373e+01 -9.56166391e+00 -9.56166391e+00
 -9.56166391e+00 -1.27021202e+00 -5.83030380e-01 -5.83030380e-01
 -5.83030380e-01  9.98923720e-01  1.01479984e+00  1.01479984e+00
  1.01479984e+00  7.29345999e+00  7.29345999e+00  7.29345999e+00
  1.28630709e+01  3.34614620e+01  3.34614620e+01  3.34614620e+01
  1.12566334e+02  1.29117912e+02  1.29117912e+02  1.29117912e+02
  4.83502367e+02  4.83502367e+02  4.83502367e+02  6.05788260e+02
  1.33519626e+03  1.33519626e+03  1.33519626e+03  2.67794906e+03
  3.02921596e+03  3.02921596e+03  3.02921596e+03  6.64949404e+03
  6.64949404e+03  6.64949404e+03  9.08239666e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.2934995078513  E_coul = 201.55328905119265
cycle= 6 E= -526.740210456659  delta_E= -5.7e-11  |g|= 1.73e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2934995078513  E_coul = 201.55328905119265
  HOMO = -0.583030402768501  LUMO = 0.99892405356645
  mo_energy =
[-1.18578829e+02 -1.23103371e+01 -9.56166385e+00 -9.56166385e+00
 -9.56166385e+00 -1.27021165e+00 -5.83030403e-01 -5.83030403e-01
 -5.83030403e-01  9.98924054e-01  1.01479988e+00  1.01479988e+00
  1.01479988e+00  7.29346003e+00  7.29346003e+00  7.29346003e+00
  1.28630711e+01  3.34614621e+01  3.34614621e+01  3.34614621e+01
  1.12566334e+02  1.29117912e+02  1.29117912e+02  1.29117912e+02
  4.83502367e+02  4.83502367e+02  4.83502367e+02  6.05788260e+02
  1.33519626e+03  1.33519626e+03  1.33519626e+03  2.67794906e+03
  3.02921596e+03  3.02921596e+03  3.02921596e+03  6.64949404e+03
  6.64949404e+03  6.64949404e+03  9.08239666e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.2934985187574  E_coul = 201.55328806209707
Extra cycle  E= -526.74021045666  delta_E= -1.71e-12  |g|= 3.57e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826614e+04 7.61751004e+03 3.61735669e+03 1.59758023e+03
 3.82692793e+02 1.12395350e+02 3.72857042e+01 8.27710303e+00
 3.25844334e+00 6.63463255e-01 2.43655574e-01 1.36278505e+03
 6.64727480e+02 3.00876160e+02 3.13968272e+02 6.16793989e+01
 7.34192146e+00 2.02554350e+01 7.76042154e-01 2.81685586e+00
 2.22757294e-01]
E = -526.7402104566603
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613609        1
[INPUT] 0    0    [1    /1   ]  7617.51004278        1
[INPUT] 0    0    [1    /1   ]  3617.35669337        1
[INPUT] 0    0    [1    /1   ]  1597.58022803        1
[INPUT] 0    0    [1    /1   ]  382.692792979        1
[INPUT] 0    0    [1    /1   ]  112.395350102        1
[INPUT] 0    0    [1    /1   ]  37.2857042318        1
[INPUT] 0    0    [1    /1   ]  8.27710303497        1
[INPUT] 0    0    [1    /1   ]  3.25844333588        1
[INPUT] 0    0    [1    /1   ]  0.663463255011       1
[INPUT] 0    0    [1    /1   ]  0.243655573609       1
[INPUT] 1    0    [1    /1   ]  1362.78505075        1
[INPUT] 1    0    [1    /1   ]  664.72748013         1
[INPUT] 1    0    [1    /1   ]  300.876159889        1
[INPUT] 1    0    [1    /1   ]  313.968272288        1
[INPUT] 1    0    [1    /1   ]  61.6793988596        1
[INPUT] 1    0    [1    /1   ]  7.34192146024        1
[INPUT] 1    0    [1    /1   ]  20.2554349929        1
[INPUT] 1    0    [1    /1   ]  0.776042153707       1
[INPUT] 1    0    [1    /1   ]  2.81685585838        1
[INPUT] 1    0    [1    /1   ]  0.22275729407        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661360926104, 1.0]], [0, [7617.510042783228, 1.0]], [0, [3617.3566933702177, 1.0]], [0, [1597.5802280286064, 1.0]], [0, [382.6927929790974, 1.0]], [0, [112.39535010157199, 1.0]], [0, [37.28570423176288, 1.0]], [0, [8.277103034974305, 1.0]], [0, [3.2584433358766915, 1.0]], [0, [0.6634632550114566, 1.0]], [0, [0.24365557360921786, 1.0]], [1, [1362.7850507515082, 1.0]], [1, [664.727480130401, 1.0]], [1, [300.8761598893373, 1.0]], [1, [313.9682722879891, 1.0]], [1, [61.67939885956179, 1.0]], [1, [7.341921460242558, 1.0]], [1, [20.255434992919014, 1.0]], [1, [0.776042153707037, 1.0]], [1, [2.8168558583760466, 1.0]], [1, [0.22275729407024766, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66136093]
bas 1, expnt(s) = [7617.51004278]
bas 2, expnt(s) = [3617.35669337]
bas 3, expnt(s) = [1597.58022803]
bas 4, expnt(s) = [382.69279298]
bas 5, expnt(s) = [112.3953501]
bas 6, expnt(s) = [37.28570423]
bas 7, expnt(s) = [8.27710303]
bas 8, expnt(s) = [3.25844334]
bas 9, expnt(s) = [0.66346326]
bas 10, expnt(s) = [0.24365557]
bas 11, expnt(s) = [1362.78505075]
bas 12, expnt(s) = [664.72748013]
bas 13, expnt(s) = [300.87615989]
bas 14, expnt(s) = [313.96827229]
bas 15, expnt(s) = [61.67939886]
bas 16, expnt(s) = [7.34192146]
bas 17, expnt(s) = [20.25543499]
bas 18, expnt(s) = [0.77604215]
bas 19, expnt(s) = [2.81685586]
bas 20, expnt(s) = [0.22275729]
CPU time:       313.22
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026369e+03 7.61751004e+03 2.06003596e+03
 3.61735669e+03 1.17844285e+03 1.59758023e+03 6.38428156e+02
 3.82692793e+02 2.18601298e+02 1.12395350e+02 8.72120073e+01
 3.72857042e+01 3.81216585e+01 8.27710303e+00 1.23288848e+01
 3.25844334e+00 6.12734952e+00 6.63463255e-01 1.85728128e+00
 2.43655574e-01 8.76187972e-01 1.36278505e+03 2.41556425e+04
 6.64727480e+02 9.84665981e+03 3.00876160e+02 3.65568793e+03
 3.13968272e+02 3.85559667e+03 6.16793989e+01 5.04265850e+02
 7.34192146e+00 3.52570978e+01 2.02554350e+01 1.25360686e+02
 7.76042154e-01 2.12491241e+00 2.81685586e+00 1.06460910e+01
 2.22757294e-01 4.46451524e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993579797501564
cond(S) = 103685.5004639074
E1 = -729.5305279727734  E_coul = 203.17852889454642
init E= -526.351999078227
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555771461772641  LUMO = 1.02050715272448
  mo_energy =
[-1.18329034e+02 -1.22049596e+01 -9.44683233e+00 -9.44683233e+00
 -9.44683233e+00 -1.24002202e+00 -5.55771462e-01 -5.55771462e-01
 -5.55771462e-01  1.02050715e+00  1.03347078e+00  1.03347078e+00
  1.03347078e+00  7.36429939e+00  7.36429939e+00  7.36429939e+00
  1.29486088e+01  3.35815947e+01  3.35815947e+01  3.35815947e+01
  1.12741634e+02  1.29298552e+02  1.29298552e+02  1.29298552e+02
  4.83751523e+02  4.83751523e+02  4.83751523e+02  6.06074052e+02
  1.33549807e+03  1.33549807e+03  1.33549807e+03  2.67838140e+03
  3.02958144e+03  3.02958144e+03  3.02958144e+03  6.64997105e+03
  6.64997105e+03  6.64997105e+03  9.08294796e+03  2.54374187e+04
  7.61783739e+04]
E1 = -727.847754342556  E_coul = 201.10832235347613
cycle= 1 E= -526.73943198908  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541933
diis-c [-0.29369091  1.        ]
  HOMO = -0.590648885747089  LUMO = 0.991951572053712
  mo_energy =
[-1.18636493e+02 -1.23425757e+01 -9.59519295e+00 -9.59519295e+00
 -9.59519295e+00 -1.27945609e+00 -5.90648886e-01 -5.90648886e-01
 -5.90648886e-01  9.91951572e-01  1.00914740e+00  1.00914740e+00
  1.00914740e+00  7.27347499e+00  7.27347499e+00  7.27347499e+00
  1.28372003e+01  3.34275735e+01  3.34275735e+01  3.34275735e+01
  1.12518439e+02  1.29070414e+02  1.29070414e+02  1.29070414e+02
  4.83445404e+02  4.83445404e+02  4.83445404e+02  6.05729232e+02
  1.33513585e+03  1.33513585e+03  1.33513585e+03  2.67788599e+03
  3.02915371e+03  3.02915371e+03  3.02915371e+03  6.64943045e+03
  6.64943045e+03  6.64943045e+03  9.08233248e+03  2.54367092e+04
  7.61775744e+04]
E1 = -728.4209923291183  E_coul = 201.6808425435251
cycle= 2 E= -526.740149785593  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750294
diis-c [-0.00330665  0.08209453  0.91790547]
  HOMO = -0.58154070347894  LUMO = 1.00014773911594
  mo_energy =
[-1.18568869e+02 -1.23045649e+01 -9.55552963e+00 -9.55552963e+00
 -9.55552963e+00 -1.26855320e+00 -5.81540703e-01 -5.81540703e-01
 -5.81540703e-01  1.00014774e+00  1.01587279e+00  1.01587279e+00
  1.01587279e+00  7.29721882e+00  7.29721882e+00  7.29721882e+00
  1.28677257e+01  3.34676167e+01  3.34676167e+01  3.34676167e+01
  1.12574673e+02  1.29126251e+02  1.29126251e+02  1.29126251e+02
  4.83512211e+02  4.83512211e+02  4.83512211e+02  6.05798477e+02
  1.33520670e+03  1.33520670e+03  1.33520670e+03  2.67796016e+03
  3.02922680e+03  3.02922680e+03  3.02922680e+03  6.64950528e+03
  6.64950528e+03  6.64950528e+03  9.08240813e+03  2.54367854e+04
  7.61776509e+04]
E1 = -728.2708156085549  E_coul = 201.53060707855138
cycle= 3 E= -526.740208530004  delta_E= -5.87e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131733
diis-c [-5.73003460e-07 -1.23756890e-03  1.44936997e-01  8.56300572e-01]
  HOMO = -0.583040995872469  LUMO = 0.998893957267605
  mo_energy =
[-1.18578838e+02 -1.23103783e+01 -9.56168953e+00 -9.56168953e+00
 -9.56168953e+00 -1.27024667e+00 -5.83040996e-01 -5.83040996e-01
 -5.83040996e-01  9.98893957e-01  1.01478919e+00  1.01478919e+00
  1.01478919e+00  7.29343562e+00  7.29343562e+00  7.29343562e+00
  1.28630305e+01  3.34614376e+01  3.34614376e+01  3.34614376e+01
  1.12566312e+02  1.29117894e+02  1.29117894e+02  1.29117894e+02
  4.83502358e+02  4.83502358e+02  4.83502358e+02  6.05788259e+02
  1.33519626e+03  1.33519626e+03  1.33519626e+03  2.67794908e+03
  3.02921597e+03  3.02921597e+03  3.02921597e+03  6.64949406e+03
  6.64949406e+03  6.64949406e+03  9.08239670e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.2936275263644  E_coul = 201.5534170714424
cycle= 4 E= -526.740210454922  delta_E= -1.92e-06  |g|= 9.76e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113371
diis-c [-4.05821904e-09  7.23492267e-05 -1.03506866e-02 -6.70094522e-02
  1.07728779e+00]
  HOMO = -0.583022999907889  LUMO = 0.998927641741484
  mo_energy =
[-1.18578799e+02 -1.23103149e+01 -9.56163965e+00 -9.56163965e+00
 -9.56163965e+00 -1.27020615e+00 -5.83023000e-01 -5.83023000e-01
 -5.83023000e-01  9.98927642e-01  1.01480473e+00  1.01480473e+00
  1.01480473e+00  7.29347644e+00  7.29347644e+00  7.29347644e+00
  1.28630891e+01  3.34614856e+01  3.34614856e+01  3.34614856e+01
  1.12566362e+02  1.29117940e+02  1.29117940e+02  1.29117940e+02
  4.83502397e+02  4.83502397e+02  4.83502397e+02  6.05788291e+02
  1.33519629e+03  1.33519629e+03  1.33519629e+03  2.67794909e+03
  3.02921599e+03  3.02921599e+03  3.02921599e+03  6.64949407e+03
  6.64949407e+03  6.64949407e+03  9.08239670e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.293418809605  E_coul = 201.55320835300336
cycle= 5 E= -526.740210456602  delta_E= -1.68e-09  |g|= 2.05e-05  |ddm|= 0.000157
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86441e-05
diis-c [-7.32403642e-11  1.44176712e-05 -1.87625072e-03 -1.39814608e-02
  4.29623052e-02  9.72880989e-01]
  HOMO = -0.583030380362372  LUMO = 0.998923719745592
  mo_energy =
[-1.18578829e+02 -1.23103373e+01 -9.56166391e+00 -9.56166391e+00
 -9.56166391e+00 -1.27021202e+00 -5.83030380e-01 -5.83030380e-01
 -5.83030380e-01  9.98923720e-01  1.01479984e+00  1.01479984e+00
  1.01479984e+00  7.29345999e+00  7.29345999e+00  7.29345999e+00
  1.28630709e+01  3.34614620e+01  3.34614620e+01  3.34614620e+01
  1.12566334e+02  1.29117912e+02  1.29117912e+02  1.29117912e+02
  4.83502367e+02  4.83502367e+02  4.83502367e+02  6.05788260e+02
  1.33519626e+03  1.33519626e+03  1.33519626e+03  2.67794906e+03
  3.02921596e+03  3.02921596e+03  3.02921596e+03  6.64949404e+03
  6.64949404e+03  6.64949404e+03  9.08239666e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.2934995078513  E_coul = 201.55328905119265
cycle= 6 E= -526.740210456659  delta_E= -5.7e-11  |g|= 1.73e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2934995078513  E_coul = 201.55328905119265
  HOMO = -0.583030402768501  LUMO = 0.99892405356645
  mo_energy =
[-1.18578829e+02 -1.23103371e+01 -9.56166385e+00 -9.56166385e+00
 -9.56166385e+00 -1.27021165e+00 -5.83030403e-01 -5.83030403e-01
 -5.83030403e-01  9.98924054e-01  1.01479988e+00  1.01479988e+00
  1.01479988e+00  7.29346003e+00  7.29346003e+00  7.29346003e+00
  1.28630711e+01  3.34614621e+01  3.34614621e+01  3.34614621e+01
  1.12566334e+02  1.29117912e+02  1.29117912e+02  1.29117912e+02
  4.83502367e+02  4.83502367e+02  4.83502367e+02  6.05788260e+02
  1.33519626e+03  1.33519626e+03  1.33519626e+03  2.67794906e+03
  3.02921596e+03  3.02921596e+03  3.02921596e+03  6.64949404e+03
  6.64949404e+03  6.64949404e+03  9.08239666e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.2934985187574  E_coul = 201.55328806209707
Extra cycle  E= -526.74021045666  delta_E= -1.71e-12  |g|= 3.57e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103685.5004639074
E1 = -728.2934985187574  E_coul = 201.55328806209707
init E= -526.74021045666
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583030433661445  LUMO = 0.998924099385671
  mo_energy =
[-1.18578829e+02 -1.23103372e+01 -9.56166394e+00 -9.56166394e+00
 -9.56166394e+00 -1.27021161e+00 -5.83030434e-01 -5.83030434e-01
 -5.83030434e-01  9.98924099e-01  1.01479987e+00  1.01479987e+00
  1.01479987e+00  7.29345998e+00  7.29345998e+00  7.29345998e+00
  1.28630710e+01  3.34614620e+01  3.34614620e+01  3.34614620e+01
  1.12566334e+02  1.29117912e+02  1.29117912e+02  1.29117912e+02
  4.83502367e+02  4.83502367e+02  4.83502367e+02  6.05788260e+02
  1.33519626e+03  1.33519626e+03  1.33519626e+03  2.67794906e+03
  3.02921596e+03  3.02921596e+03  3.02921596e+03  6.64949404e+03
  6.64949404e+03  6.64949404e+03  9.08239666e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.2934986828908  E_coul = 201.55328822623142
cycle= 1 E= -526.740210456659  delta_E= 9.09e-13  |g|= 7.48e-08  |ddm|= 5.93e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2934986828908  E_coul = 201.55328822623142
  HOMO = -0.583030433101497  LUMO = 0.998924114663703
  mo_energy =
[-1.18578829e+02 -1.23103372e+01 -9.56166393e+00 -9.56166393e+00
 -9.56166393e+00 -1.27021159e+00 -5.83030433e-01 -5.83030433e-01
 -5.83030433e-01  9.98924115e-01  1.01479987e+00  1.01479987e+00
  1.01479987e+00  7.29345998e+00  7.29345998e+00  7.29345998e+00
  1.28630711e+01  3.34614620e+01  3.34614620e+01  3.34614620e+01
  1.12566334e+02  1.29117912e+02  1.29117912e+02  1.29117912e+02
  4.83502367e+02  4.83502367e+02  4.83502367e+02  6.05788260e+02
  1.33519626e+03  1.33519626e+03  1.33519626e+03  2.67794906e+03
  3.02921596e+03  3.02921596e+03  3.02921596e+03  6.64949404e+03
  6.64949404e+03  6.64949404e+03  9.08239666e+03  2.54367738e+04
  7.61776391e+04]
E1 = -728.2934986131719  E_coul = 201.55328815651347
Extra cycle  E= -526.740210456658  delta_E= 1.02e-12  |g|= 1.51e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826614e+04 7.61751004e+03 3.61735669e+03 1.59758023e+03
 3.82692793e+02 1.12395350e+02 3.72857042e+01 8.27710303e+00
 3.25844334e+00 6.63463255e-01 2.43655574e-01 1.36278505e+03
 6.64727480e+02 3.00876160e+02 3.13968272e+02 6.16793989e+01
 7.34192146e+00 2.02554350e+01 7.76042154e-01 2.81685586e+00
 2.22757294e-01]
grad_E = [-1.55130436e-06  3.69166976e-06 -1.33554712e-06  8.34728094e-05
 -3.35304498e-04 -1.63543632e-05  1.70143126e-05 -1.17632232e-05
  1.69997313e-06  8.24958985e-06 -1.28146972e-04 -5.09910662e-07
  4.97277812e-06  2.34361888e-05  2.02001631e-05 -1.66228108e-05
 -5.10637855e-05  1.87084549e-05  5.89620321e-05  5.80461724e-05
 -1.52144783e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613494        1
[INPUT] 0    0    [1    /1   ]  7617.51006511        1
[INPUT] 0    0    [1    /1   ]  3617.35667898        1
[INPUT] 0    0    [1    /1   ]  1597.58063807        1
[INPUT] 0    0    [1    /1   ]  382.695894456        1
[INPUT] 0    0    [1    /1   ]  112.376919362        1
[INPUT] 0    0    [1    /1   ]  37.2785541096        1
[INPUT] 0    0    [1    /1   ]  8.27876123745        1
[INPUT] 0    0    [1    /1   ]  3.25852317357        1
[INPUT] 0    0    [1    /1   ]  0.663075180775       1
[INPUT] 0    0    [1    /1   ]  0.243478702432       1
[INPUT] 1    0    [1    /1   ]  1362.78504683        1
[INPUT] 1    0    [1    /1   ]  664.727519413        1
[INPUT] 1    0    [1    /1   ]  300.876345404        1
[INPUT] 1    0    [1    /1   ]  313.968432273        1
[INPUT] 1    0    [1    /1   ]  61.6792012761        1
[INPUT] 1    0    [1    /1   ]  7.34094961046        1
[INPUT] 1    0    [1    /1   ]  20.2558602551        1
[INPUT] 1    0    [1    /1   ]  0.776045225051       1
[INPUT] 1    0    [1    /1   ]  2.81675820675        1
[INPUT] 1    0    [1    /1   ]  0.222744956651       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.66134941569, 1.0]], [0, [7617.510065113252, 1.0]], [0, [3617.356678983123, 1.0]], [0, [1597.5806380654847, 1.0]], [0, [382.6958944556307, 1.0]], [0, [112.37691936217891, 1.0]], [0, [37.278554109647956, 1.0]], [0, [8.278761237446773, 1.0]], [0, [3.258523173571938, 1.0]], [0, [0.6630751807746761, 1.0]], [0, [0.24347870243225656, 1.0]], [1, [1362.7850468338868, 1.0]], [1, [664.7275194130535, 1.0]], [1, [300.876345404348, 1.0]], [1, [313.96843227291055, 1.0]], [1, [61.679201276144596, 1.0]], [1, [7.340949610458977, 1.0]], [1, [20.255860255078336, 1.0]], [1, [0.7760452250505324, 1.0]], [1, [2.8167582067458583, 1.0]], [1, [0.2227449566507181, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66134942]
bas 1, expnt(s) = [7617.51006511]
bas 2, expnt(s) = [3617.35667898]
bas 3, expnt(s) = [1597.58063807]
bas 4, expnt(s) = [382.69589446]
bas 5, expnt(s) = [112.37691936]
bas 6, expnt(s) = [37.27855411]
bas 7, expnt(s) = [8.27876124]
bas 8, expnt(s) = [3.25852317]
bas 9, expnt(s) = [0.66307518]
bas 10, expnt(s) = [0.2434787]
bas 11, expnt(s) = [1362.78504683]
bas 12, expnt(s) = [664.72751941]
bas 13, expnt(s) = [300.8763454]
bas 14, expnt(s) = [313.96843227]
bas 15, expnt(s) = [61.67920128]
bas 16, expnt(s) = [7.34094961]
bas 17, expnt(s) = [20.25586026]
bas 18, expnt(s) = [0.77604523]
bas 19, expnt(s) = [2.81675821]
bas 20, expnt(s) = [0.22274496]
CPU time:       319.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826613e+04 5.20026369e+03 7.61751007e+03 2.06003596e+03
 3.61735668e+03 1.17844285e+03 1.59758064e+03 6.38428279e+02
 3.82695894e+02 2.18602627e+02 1.12376919e+02 8.72012812e+01
 3.72785541e+01 3.81161756e+01 8.27876124e+00 1.23307372e+01
 3.25852317e+00 6.12746211e+00 6.63075181e-01 1.85646644e+00
 2.43478702e-01 8.75710906e-01 1.36278505e+03 2.41556424e+04
 6.64727519e+02 9.84666054e+03 3.00876345e+02 3.65569074e+03
 3.13968432e+02 3.85559913e+03 6.16792013e+01 5.04263831e+02
 7.34094961e+00 3.52512642e+01 2.02558603e+01 1.25363976e+02
 7.76045225e-01 2.12492292e+00 2.81675821e+00 1.06456296e+01
 2.22744957e-01 4.46420616e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99358208792614
cond(S) = 103683.76629823959
E1 = -729.5305574096026  E_coul = 203.1785521530958
init E= -526.352005256507
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555772670723917  LUMO = 1.01939977223099
  mo_energy =
[-1.18329032e+02 -1.22049553e+01 -9.44682916e+00 -9.44682916e+00
 -9.44682916e+00 -1.24002341e+00 -5.55772671e-01 -5.55772671e-01
 -5.55772671e-01  1.01939977e+00  1.03342659e+00  1.03342659e+00
  1.03342659e+00  7.36380655e+00  7.36380655e+00  7.36380655e+00
  1.29475727e+01  3.35792073e+01  3.35792073e+01  3.35792073e+01
  1.12724783e+02  1.29295812e+02  1.29295812e+02  1.29295812e+02
  4.83749290e+02  4.83749290e+02  4.83749290e+02  6.06008769e+02
  1.33549639e+03  1.33549639e+03  1.33549639e+03  2.67830181e+03
  3.02958037e+03  3.02958037e+03  3.02958037e+03  6.64997047e+03
  6.64997047e+03  6.64997047e+03  9.08287269e+03  2.54373476e+04
  7.61783077e+04]
E1 = -727.8474016029212  E_coul = 201.10796925509487
cycle= 1 E= -526.739432347826  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541938
diis-c [-0.29369709  1.        ]
  HOMO = -0.590664370244988  LUMO = 0.990856280199467
  mo_energy =
[-1.18636519e+02 -1.23425963e+01 -9.59521568e+00 -9.59521568e+00
 -9.59521568e+00 -1.27947106e+00 -5.90664370e-01 -5.90664370e-01
 -5.90664370e-01  9.90856280e-01  1.00909329e+00  1.00909329e+00
  1.00909329e+00  7.27296502e+00  7.27296502e+00  7.27296502e+00
  1.28361388e+01  3.34251628e+01  3.34251628e+01  3.34251628e+01
  1.12501570e+02  1.29067645e+02  1.29067645e+02  1.29067645e+02
  4.83443140e+02  4.83443140e+02  4.83443140e+02  6.05663925e+02
  1.33513413e+03  1.33513413e+03  1.33513413e+03  2.67780637e+03
  3.02915260e+03  3.02915260e+03  3.02915260e+03  6.64942983e+03
  6.64942983e+03  6.64942983e+03  9.08225718e+03  2.54366380e+04
  7.61775081e+04]
E1 = -728.4207391717288  E_coul = 201.68058879652992
cycle= 2 E= -526.740150375199  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750389
diis-c [-0.00330718  0.0821083   0.9178917 ]
  HOMO = -0.581554407986624  LUMO = 0.999048117616477
  mo_energy =
[-1.18568887e+02 -1.23045792e+01 -9.55554606e+00 -9.55554606e+00
 -9.55554606e+00 -1.26856585e+00 -5.81554408e-01 -5.81554408e-01
 -5.81554408e-01  9.99048118e-01  1.01581993e+00  1.01581993e+00
  1.01581993e+00  7.29671193e+00  7.29671193e+00  7.29671193e+00
  1.28666711e+01  3.34652117e+01  3.34652117e+01  3.34652117e+01
  1.12557810e+02  1.29123490e+02  1.29123490e+02  1.29123490e+02
  4.83509957e+02  4.83509957e+02  4.83509957e+02  6.05733179e+02
  1.33520499e+03  1.33520499e+03  1.33520499e+03  2.67788054e+03
  3.02922570e+03  3.02922570e+03  3.02922570e+03  6.64950467e+03
  6.64950467e+03  6.64950467e+03  9.08233284e+03  2.54367142e+04
  7.61775846e+04]
E1 = -728.2705336022779  E_coul = 201.5303244608202
cycle= 3 E= -526.740209141458  delta_E= -5.88e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131744
diis-c [-5.73681088e-07 -1.23777142e-03  1.44931777e-01  8.56305994e-01]
  HOMO = -0.583055007235334  LUMO = 0.997795113943749
  mo_energy =
[-1.18578856e+02 -1.23103931e+01 -9.56170664e+00 -9.56170664e+00
 -9.56170664e+00 -1.27025954e+00 -5.83055007e-01 -5.83055007e-01
 -5.83055007e-01  9.97795114e-01  1.01473613e+00  1.01473613e+00
  1.01473613e+00  7.29292837e+00  7.29292837e+00  7.29292837e+00
  1.28619751e+01  3.34590321e+01  3.34590321e+01  3.34590321e+01
  1.12549448e+02  1.29115132e+02  1.29115132e+02  1.29115132e+02
  4.83500103e+02  4.83500103e+02  4.83500103e+02  6.05722959e+02
  1.33519455e+03  1.33519455e+03  1.33519455e+03  2.67786947e+03
  3.02921487e+03  3.02921487e+03  3.02921487e+03  6.64949345e+03
  6.64949345e+03  6.64949345e+03  9.08232141e+03  2.54367026e+04
  7.61775729e+04]
E1 = -728.2933483697816  E_coul = 201.55313730288782
cycle= 4 E= -526.740211066894  delta_E= -1.93e-06  |g|= 9.77e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113524
diis-c [-4.06388197e-09  7.24624440e-05 -1.03639080e-02 -6.70994878e-02
  1.07739093e+00]
  HOMO = -0.583037030918189  LUMO = 0.997828792583131
  mo_energy =
[-1.18578818e+02 -1.23103298e+01 -9.56165679e+00 -9.56165679e+00
 -9.56165679e+00 -1.27021901e+00 -5.83037031e-01 -5.83037031e-01
 -5.83037031e-01  9.97828793e-01  1.01475167e+00  1.01475167e+00
  1.01475167e+00  7.29296916e+00  7.29296916e+00  7.29296916e+00
  1.28620337e+01  3.34590800e+01  3.34590800e+01  3.34590800e+01
  1.12549498e+02  1.29115178e+02  1.29115178e+02  1.29115178e+02
  4.83500142e+02  4.83500142e+02  4.83500142e+02  6.05722991e+02
  1.33519458e+03  1.33519458e+03  1.33519458e+03  2.67786948e+03
  3.02921489e+03  3.02921489e+03  3.02921489e+03  6.64949346e+03
  6.64949346e+03  6.64949346e+03  9.08232140e+03  2.54367026e+04
  7.61775729e+04]
E1 = -728.2931396570115  E_coul = 201.55292858843265
cycle= 5 E= -526.740211068579  delta_E= -1.68e-09  |g|= 2.05e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86637e-05
diis-c [-7.34179128e-11  1.44267726e-05 -1.87700137e-03 -1.39874277e-02
  4.28906403e-02  9.72959362e-01]
  HOMO = -0.583044418104031  LUMO = 0.997824871900155
  mo_energy =
[-1.18578848e+02 -1.23103522e+01 -9.56168107e+00 -9.56168107e+00
 -9.56168107e+00 -1.27022488e+00 -5.83044418e-01 -5.83044418e-01
 -5.83044418e-01  9.97824872e-01  1.01474676e+00  1.01474676e+00
  1.01474676e+00  7.29295269e+00  7.29295269e+00  7.29295269e+00
  1.28620154e+01  3.34590564e+01  3.34590564e+01  3.34590564e+01
  1.12549471e+02  1.29115150e+02  1.29115150e+02  1.29115150e+02
  4.83500112e+02  4.83500112e+02  4.83500112e+02  6.05722960e+02
  1.33519455e+03  1.33519455e+03  1.33519455e+03  2.67786945e+03
  3.02921486e+03  3.02921486e+03  3.02921486e+03  6.64949343e+03
  6.64949343e+03  6.64949343e+03  9.08232137e+03  2.54367026e+04
  7.61775728e+04]
E1 = -728.2932204024129  E_coul = 201.55300933377552
cycle= 6 E= -526.740211068637  delta_E= -5.85e-11  |g|= 1.73e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2932204024129  E_coul = 201.55300933377552
  HOMO = -0.583044439839525  LUMO = 0.997825206354116
  mo_energy =
[-1.18578848e+02 -1.23103520e+01 -9.56168101e+00 -9.56168101e+00
 -9.56168101e+00 -1.27022451e+00 -5.83044440e-01 -5.83044440e-01
 -5.83044440e-01  9.97825206e-01  1.01474680e+00  1.01474680e+00
  1.01474680e+00  7.29295274e+00  7.29295274e+00  7.29295274e+00
  1.28620156e+01  3.34590565e+01  3.34590565e+01  3.34590565e+01
  1.12549471e+02  1.29115150e+02  1.29115150e+02  1.29115150e+02
  4.83500112e+02  4.83500112e+02  4.83500112e+02  6.05722960e+02
  1.33519455e+03  1.33519455e+03  1.33519455e+03  2.67786945e+03
  3.02921486e+03  3.02921486e+03  3.02921486e+03  6.64949343e+03
  6.64949343e+03  6.64949343e+03  9.08232137e+03  2.54367026e+04
  7.61775728e+04]
E1 = -728.2932194010374  E_coul = 201.55300833239977
Extra cycle  E= -526.740211068638  delta_E= -2.27e-13  |g|= 3.57e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826613e+04 7.61751007e+03 3.61735668e+03 1.59758064e+03
 3.82695894e+02 1.12376919e+02 3.72785541e+01 8.27876124e+00
 3.25852317e+00 6.63075181e-01 2.43478702e-01 1.36278505e+03
 6.64727519e+02 3.00876345e+02 3.13968432e+02 6.16792013e+01
 7.34094961e+00 2.02558603e+01 7.76045225e-01 2.81675821e+00
 2.22744957e-01]
E = -526.7402110686376
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:12:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613494        1
[INPUT] 0    0    [1    /1   ]  7617.51006511        1
[INPUT] 0    0    [1    /1   ]  3617.35667898        1
[INPUT] 0    0    [1    /1   ]  1597.58063807        1
[INPUT] 0    0    [1    /1   ]  382.695894456        1
[INPUT] 0    0    [1    /1   ]  112.376919362        1
[INPUT] 0    0    [1    /1   ]  37.2785541096        1
[INPUT] 0    0    [1    /1   ]  8.27876123745        1
[INPUT] 0    0    [1    /1   ]  3.25852317357        1
[INPUT] 0    0    [1    /1   ]  0.663075180775       1
[INPUT] 0    0    [1    /1   ]  0.243478702432       1
[INPUT] 1    0    [1    /1   ]  1362.78504683        1
[INPUT] 1    0    [1    /1   ]  664.727519413        1
[INPUT] 1    0    [1    /1   ]  300.876345404        1
[INPUT] 1    0    [1    /1   ]  313.968432273        1
[INPUT] 1    0    [1    /1   ]  61.6792012761        1
[INPUT] 1    0    [1    /1   ]  7.34094961046        1
[INPUT] 1    0    [1    /1   ]  20.2558602551        1
[INPUT] 1    0    [1    /1   ]  0.776045225051       1
[INPUT] 1    0    [1    /1   ]  2.81675820675        1
[INPUT] 1    0    [1    /1   ]  0.222744956651       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.66134941569, 1.0]], [0, [7617.510065113252, 1.0]], [0, [3617.356678983123, 1.0]], [0, [1597.5806380654847, 1.0]], [0, [382.6958944556307, 1.0]], [0, [112.37691936217891, 1.0]], [0, [37.278554109647956, 1.0]], [0, [8.278761237446773, 1.0]], [0, [3.258523173571938, 1.0]], [0, [0.6630751807746761, 1.0]], [0, [0.24347870243225656, 1.0]], [1, [1362.7850468338868, 1.0]], [1, [664.7275194130535, 1.0]], [1, [300.876345404348, 1.0]], [1, [313.96843227291055, 1.0]], [1, [61.679201276144596, 1.0]], [1, [7.340949610458977, 1.0]], [1, [20.255860255078336, 1.0]], [1, [0.7760452250505324, 1.0]], [1, [2.8167582067458583, 1.0]], [1, [0.2227449566507181, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66134942]
bas 1, expnt(s) = [7617.51006511]
bas 2, expnt(s) = [3617.35667898]
bas 3, expnt(s) = [1597.58063807]
bas 4, expnt(s) = [382.69589446]
bas 5, expnt(s) = [112.37691936]
bas 6, expnt(s) = [37.27855411]
bas 7, expnt(s) = [8.27876124]
bas 8, expnt(s) = [3.25852317]
bas 9, expnt(s) = [0.66307518]
bas 10, expnt(s) = [0.2434787]
bas 11, expnt(s) = [1362.78504683]
bas 12, expnt(s) = [664.72751941]
bas 13, expnt(s) = [300.8763454]
bas 14, expnt(s) = [313.96843227]
bas 15, expnt(s) = [61.67920128]
bas 16, expnt(s) = [7.34094961]
bas 17, expnt(s) = [20.25586026]
bas 18, expnt(s) = [0.77604523]
bas 19, expnt(s) = [2.81675821]
bas 20, expnt(s) = [0.22274496]
CPU time:       319.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826613e+04 5.20026369e+03 7.61751007e+03 2.06003596e+03
 3.61735668e+03 1.17844285e+03 1.59758064e+03 6.38428279e+02
 3.82695894e+02 2.18602627e+02 1.12376919e+02 8.72012812e+01
 3.72785541e+01 3.81161756e+01 8.27876124e+00 1.23307372e+01
 3.25852317e+00 6.12746211e+00 6.63075181e-01 1.85646644e+00
 2.43478702e-01 8.75710906e-01 1.36278505e+03 2.41556424e+04
 6.64727519e+02 9.84666054e+03 3.00876345e+02 3.65569074e+03
 3.13968432e+02 3.85559913e+03 6.16792013e+01 5.04263831e+02
 7.34094961e+00 3.52512642e+01 2.02558603e+01 1.25363976e+02
 7.76045225e-01 2.12492292e+00 2.81675821e+00 1.06456296e+01
 2.22744957e-01 4.46420616e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99358208792614
cond(S) = 103683.76629823959
E1 = -729.5305574096026  E_coul = 203.1785521530958
init E= -526.352005256507
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555772670723917  LUMO = 1.01939977223099
  mo_energy =
[-1.18329032e+02 -1.22049553e+01 -9.44682916e+00 -9.44682916e+00
 -9.44682916e+00 -1.24002341e+00 -5.55772671e-01 -5.55772671e-01
 -5.55772671e-01  1.01939977e+00  1.03342659e+00  1.03342659e+00
  1.03342659e+00  7.36380655e+00  7.36380655e+00  7.36380655e+00
  1.29475727e+01  3.35792073e+01  3.35792073e+01  3.35792073e+01
  1.12724783e+02  1.29295812e+02  1.29295812e+02  1.29295812e+02
  4.83749290e+02  4.83749290e+02  4.83749290e+02  6.06008769e+02
  1.33549639e+03  1.33549639e+03  1.33549639e+03  2.67830181e+03
  3.02958037e+03  3.02958037e+03  3.02958037e+03  6.64997047e+03
  6.64997047e+03  6.64997047e+03  9.08287269e+03  2.54373476e+04
  7.61783077e+04]
E1 = -727.8474016029212  E_coul = 201.10796925509487
cycle= 1 E= -526.739432347826  delta_E= -0.387  |g|= 0.186  |ddm|= 0.314
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541938
diis-c [-0.29369709  1.        ]
  HOMO = -0.590664370244988  LUMO = 0.990856280199467
  mo_energy =
[-1.18636519e+02 -1.23425963e+01 -9.59521568e+00 -9.59521568e+00
 -9.59521568e+00 -1.27947106e+00 -5.90664370e-01 -5.90664370e-01
 -5.90664370e-01  9.90856280e-01  1.00909329e+00  1.00909329e+00
  1.00909329e+00  7.27296502e+00  7.27296502e+00  7.27296502e+00
  1.28361388e+01  3.34251628e+01  3.34251628e+01  3.34251628e+01
  1.12501570e+02  1.29067645e+02  1.29067645e+02  1.29067645e+02
  4.83443140e+02  4.83443140e+02  4.83443140e+02  6.05663925e+02
  1.33513413e+03  1.33513413e+03  1.33513413e+03  2.67780637e+03
  3.02915260e+03  3.02915260e+03  3.02915260e+03  6.64942983e+03
  6.64942983e+03  6.64942983e+03  9.08225718e+03  2.54366380e+04
  7.61775081e+04]
E1 = -728.4207391717288  E_coul = 201.68058879652992
cycle= 2 E= -526.740150375199  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750389
diis-c [-0.00330718  0.0821083   0.9178917 ]
  HOMO = -0.581554407986624  LUMO = 0.999048117616477
  mo_energy =
[-1.18568887e+02 -1.23045792e+01 -9.55554606e+00 -9.55554606e+00
 -9.55554606e+00 -1.26856585e+00 -5.81554408e-01 -5.81554408e-01
 -5.81554408e-01  9.99048118e-01  1.01581993e+00  1.01581993e+00
  1.01581993e+00  7.29671193e+00  7.29671193e+00  7.29671193e+00
  1.28666711e+01  3.34652117e+01  3.34652117e+01  3.34652117e+01
  1.12557810e+02  1.29123490e+02  1.29123490e+02  1.29123490e+02
  4.83509957e+02  4.83509957e+02  4.83509957e+02  6.05733179e+02
  1.33520499e+03  1.33520499e+03  1.33520499e+03  2.67788054e+03
  3.02922570e+03  3.02922570e+03  3.02922570e+03  6.64950467e+03
  6.64950467e+03  6.64950467e+03  9.08233284e+03  2.54367142e+04
  7.61775846e+04]
E1 = -728.2705336022779  E_coul = 201.5303244608202
cycle= 3 E= -526.740209141458  delta_E= -5.88e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131744
diis-c [-5.73681088e-07 -1.23777142e-03  1.44931777e-01  8.56305994e-01]
  HOMO = -0.583055007235334  LUMO = 0.997795113943749
  mo_energy =
[-1.18578856e+02 -1.23103931e+01 -9.56170664e+00 -9.56170664e+00
 -9.56170664e+00 -1.27025954e+00 -5.83055007e-01 -5.83055007e-01
 -5.83055007e-01  9.97795114e-01  1.01473613e+00  1.01473613e+00
  1.01473613e+00  7.29292837e+00  7.29292837e+00  7.29292837e+00
  1.28619751e+01  3.34590321e+01  3.34590321e+01  3.34590321e+01
  1.12549448e+02  1.29115132e+02  1.29115132e+02  1.29115132e+02
  4.83500103e+02  4.83500103e+02  4.83500103e+02  6.05722959e+02
  1.33519455e+03  1.33519455e+03  1.33519455e+03  2.67786947e+03
  3.02921487e+03  3.02921487e+03  3.02921487e+03  6.64949345e+03
  6.64949345e+03  6.64949345e+03  9.08232141e+03  2.54367026e+04
  7.61775729e+04]
E1 = -728.2933483697816  E_coul = 201.55313730288782
cycle= 4 E= -526.740211066894  delta_E= -1.93e-06  |g|= 9.77e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113524
diis-c [-4.06388197e-09  7.24624440e-05 -1.03639080e-02 -6.70994878e-02
  1.07739093e+00]
  HOMO = -0.583037030918189  LUMO = 0.997828792583131
  mo_energy =
[-1.18578818e+02 -1.23103298e+01 -9.56165679e+00 -9.56165679e+00
 -9.56165679e+00 -1.27021901e+00 -5.83037031e-01 -5.83037031e-01
 -5.83037031e-01  9.97828793e-01  1.01475167e+00  1.01475167e+00
  1.01475167e+00  7.29296916e+00  7.29296916e+00  7.29296916e+00
  1.28620337e+01  3.34590800e+01  3.34590800e+01  3.34590800e+01
  1.12549498e+02  1.29115178e+02  1.29115178e+02  1.29115178e+02
  4.83500142e+02  4.83500142e+02  4.83500142e+02  6.05722991e+02
  1.33519458e+03  1.33519458e+03  1.33519458e+03  2.67786948e+03
  3.02921489e+03  3.02921489e+03  3.02921489e+03  6.64949346e+03
  6.64949346e+03  6.64949346e+03  9.08232140e+03  2.54367026e+04
  7.61775729e+04]
E1 = -728.2931396570115  E_coul = 201.55292858843265
cycle= 5 E= -526.740211068579  delta_E= -1.68e-09  |g|= 2.05e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86637e-05
diis-c [-7.34179128e-11  1.44267726e-05 -1.87700137e-03 -1.39874277e-02
  4.28906403e-02  9.72959362e-01]
  HOMO = -0.583044418104031  LUMO = 0.997824871900155
  mo_energy =
[-1.18578848e+02 -1.23103522e+01 -9.56168107e+00 -9.56168107e+00
 -9.56168107e+00 -1.27022488e+00 -5.83044418e-01 -5.83044418e-01
 -5.83044418e-01  9.97824872e-01  1.01474676e+00  1.01474676e+00
  1.01474676e+00  7.29295269e+00  7.29295269e+00  7.29295269e+00
  1.28620154e+01  3.34590564e+01  3.34590564e+01  3.34590564e+01
  1.12549471e+02  1.29115150e+02  1.29115150e+02  1.29115150e+02
  4.83500112e+02  4.83500112e+02  4.83500112e+02  6.05722960e+02
  1.33519455e+03  1.33519455e+03  1.33519455e+03  2.67786945e+03
  3.02921486e+03  3.02921486e+03  3.02921486e+03  6.64949343e+03
  6.64949343e+03  6.64949343e+03  9.08232137e+03  2.54367026e+04
  7.61775728e+04]
E1 = -728.2932204024129  E_coul = 201.55300933377552
cycle= 6 E= -526.740211068637  delta_E= -5.85e-11  |g|= 1.73e-06  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2932204024129  E_coul = 201.55300933377552
  HOMO = -0.583044439839525  LUMO = 0.997825206354116
  mo_energy =
[-1.18578848e+02 -1.23103520e+01 -9.56168101e+00 -9.56168101e+00
 -9.56168101e+00 -1.27022451e+00 -5.83044440e-01 -5.83044440e-01
 -5.83044440e-01  9.97825206e-01  1.01474680e+00  1.01474680e+00
  1.01474680e+00  7.29295274e+00  7.29295274e+00  7.29295274e+00
  1.28620156e+01  3.34590565e+01  3.34590565e+01  3.34590565e+01
  1.12549471e+02  1.29115150e+02  1.29115150e+02  1.29115150e+02
  4.83500112e+02  4.83500112e+02  4.83500112e+02  6.05722960e+02
  1.33519455e+03  1.33519455e+03  1.33519455e+03  2.67786945e+03
  3.02921486e+03  3.02921486e+03  3.02921486e+03  6.64949343e+03
  6.64949343e+03  6.64949343e+03  9.08232137e+03  2.54367026e+04
  7.61775728e+04]
E1 = -728.2932194010374  E_coul = 201.55300833239977
Extra cycle  E= -526.740211068638  delta_E= -2.27e-13  |g|= 3.57e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103683.76629823959
E1 = -728.2932194010374  E_coul = 201.55300833239977
init E= -526.740211068638
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583044471002551  LUMO = 0.997825251976007
  mo_energy =
[-1.18578848e+02 -1.23103521e+01 -9.56168110e+00 -9.56168110e+00
 -9.56168110e+00 -1.27022447e+00 -5.83044471e-01 -5.83044471e-01
 -5.83044471e-01  9.97825252e-01  1.01474679e+00  1.01474679e+00
  1.01474679e+00  7.29295268e+00  7.29295268e+00  7.29295268e+00
  1.28620156e+01  3.34590564e+01  3.34590564e+01  3.34590564e+01
  1.12549471e+02  1.29115150e+02  1.29115150e+02  1.29115150e+02
  4.83500112e+02  4.83500112e+02  4.83500112e+02  6.05722960e+02
  1.33519455e+03  1.33519455e+03  1.33519455e+03  2.67786945e+03
  3.02921486e+03  3.02921486e+03  3.02921486e+03  6.64949343e+03
  6.64949343e+03  6.64949343e+03  9.08232137e+03  2.54367026e+04
  7.61775728e+04]
E1 = -728.2932195682138  E_coul = 201.55300849957553
cycle= 1 E= -526.740211068638  delta_E= -6.82e-13  |g|= 7.49e-08  |ddm|= 5.94e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2932195682138  E_coul = 201.55300849957553
  HOMO = -0.58304447039284  LUMO = 0.997825267303083
  mo_energy =
[-1.18578848e+02 -1.23103521e+01 -9.56168109e+00 -9.56168109e+00
 -9.56168109e+00 -1.27022445e+00 -5.83044470e-01 -5.83044470e-01
 -5.83044470e-01  9.97825267e-01  1.01474680e+00  1.01474680e+00
  1.01474680e+00  7.29295269e+00  7.29295269e+00  7.29295269e+00
  1.28620156e+01  3.34590565e+01  3.34590565e+01  3.34590565e+01
  1.12549471e+02  1.29115150e+02  1.29115150e+02  1.29115150e+02
  4.83500112e+02  4.83500112e+02  4.83500112e+02  6.05722960e+02
  1.33519455e+03  1.33519455e+03  1.33519455e+03  2.67786945e+03
  3.02921486e+03  3.02921486e+03  3.02921486e+03  6.64949343e+03
  6.64949343e+03  6.64949343e+03  9.08232137e+03  2.54367026e+04
  7.61775728e+04]
E1 = -728.2932194975646  E_coul = 201.55300842892595
Extra cycle  E= -526.740211068639  delta_E= -3.41e-13  |g|= 1.52e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826613e+04 7.61751007e+03 3.61735668e+03 1.59758064e+03
 3.82695894e+02 1.12376919e+02 3.72785541e+01 8.27876124e+00
 3.25852317e+00 6.63075181e-01 2.43478702e-01 1.36278505e+03
 6.64727519e+02 3.00876345e+02 3.13968432e+02 6.16792013e+01
 7.34094961e+00 2.02558603e+01 7.76045225e-01 2.81675821e+00
 2.22744957e-01]
grad_E = [-1.55110488e-06  3.68929099e-06 -1.33734348e-06  8.33851614e-05
 -3.33385350e-04 -2.29559927e-05  1.78811577e-05  1.95219044e-06
 -1.65083064e-05  1.68054696e-05 -2.98268244e-04 -5.09444076e-07
  4.97922516e-06  2.34753436e-05  2.02337731e-05 -2.12216407e-05
 -1.70872424e-04  5.78922236e-05  2.13161569e-04  1.77718386e-04
 -5.74628585e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613477        1
[INPUT] 0    0    [1    /1   ]  7617.51006153        1
[INPUT] 0    0    [1    /1   ]  3617.35667075        1
[INPUT] 0    0    [1    /1   ]  1597.58041361        1
[INPUT] 0    0    [1    /1   ]  382.703972474        1
[INPUT] 0    0    [1    /1   ]  112.349204442        1
[INPUT] 0    0    [1    /1   ]  37.2676986033        1
[INPUT] 0    0    [1    /1   ]  8.28122723813        1
[INPUT] 0    0    [1    /1   ]  3.25858891205        1
[INPUT] 0    0    [1    /1   ]  0.662479174262       1
[INPUT] 0    0    [1    /1   ]  0.243205153486       1
[INPUT] 1    0    [1    /1   ]  1362.78504607        1
[INPUT] 1    0    [1    /1   ]  664.727528519        1
[INPUT] 1    0    [1    /1   ]  300.876388941        1
[INPUT] 1    0    [1    /1   ]  313.968469926        1
[INPUT] 1    0    [1    /1   ]  61.6790463442        1
[INPUT] 1    0    [1    /1   ]  7.33940812135        1
[INPUT] 1    0    [1    /1   ]  20.2565150077        1
[INPUT] 1    0    [1    /1   ]  0.776048092772       1
[INPUT] 1    0    [1    /1   ]  2.81659226556        1
[INPUT] 1    0    [1    /1   ]  0.222724957686       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661347709793, 1.0]], [0, [7617.51006152579, 1.0]], [0, [3617.3566707510445, 1.0]], [0, [1597.5804136060535, 1.0]], [0, [382.70397247369596, 1.0]], [0, [112.34920444153356, 1.0]], [0, [37.26769860326852, 1.0]], [0, [8.281227238132523, 1.0]], [0, [3.2585889120479177, 1.0]], [0, [0.6624791742615063, 1.0]], [0, [0.24320515348626032, 1.0]], [1, [1362.7850460728046, 1.0]], [1, [664.7275285191884, 1.0]], [1, [300.8763889408533, 1.0]], [1, [313.9684699261617, 1.0]], [1, [61.67904634415571, 1.0]], [1, [7.33940812134505, 1.0]], [1, [20.256515007721035, 1.0]], [1, [0.7760480927720412, 1.0]], [1, [2.8165922655637536, 1.0]], [1, [0.22272495768605638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66134771]
bas 1, expnt(s) = [7617.51006153]
bas 2, expnt(s) = [3617.35667075]
bas 3, expnt(s) = [1597.58041361]
bas 4, expnt(s) = [382.70397247]
bas 5, expnt(s) = [112.34920444]
bas 6, expnt(s) = [37.2676986]
bas 7, expnt(s) = [8.28122724]
bas 8, expnt(s) = [3.25858891]
bas 9, expnt(s) = [0.66247917]
bas 10, expnt(s) = [0.24320515]
bas 11, expnt(s) = [1362.78504607]
bas 12, expnt(s) = [664.72752852]
bas 13, expnt(s) = [300.87638894]
bas 14, expnt(s) = [313.96846993]
bas 15, expnt(s) = [61.67904634]
bas 16, expnt(s) = [7.33940812]
bas 17, expnt(s) = [20.25651501]
bas 18, expnt(s) = [0.77604809]
bas 19, expnt(s) = [2.81659227]
bas 20, expnt(s) = [0.22272496]
CPU time:       325.39
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826613e+04 5.20026369e+03 7.61751006e+03 2.06003596e+03
 3.61735667e+03 1.17844284e+03 1.59758041e+03 6.38428212e+02
 3.82703972e+02 2.18606088e+02 1.12349204e+02 8.71851513e+01
 3.72676986e+01 3.81078507e+01 8.28122724e+00 1.23334918e+01
 3.25858891e+00 6.12755483e+00 6.62479174e-01 1.85521479e+00
 2.43205153e-01 8.74972904e-01 1.36278505e+03 2.41556424e+04
 6.64727529e+02 9.84666071e+03 3.00876389e+02 3.65569141e+03
 3.13968470e+02 3.85559970e+03 6.16790463e+01 5.04262248e+02
 7.33940812e+00 3.52420116e+01 2.02565150e+01 1.25369041e+02
 7.76048093e-01 2.12493274e+00 2.81659227e+00 1.06448457e+01
 2.22724958e-01 4.46370514e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993585731278433
cond(S) = 103680.38932402755
E1 = -729.5306030433374  E_coul = 203.17858809921034
init E= -526.352014944127
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555774591507921  LUMO = 1.01768988878093
  mo_energy =
[-1.18329028e+02 -1.22049489e+01 -9.44682419e+00 -9.44682419e+00
 -9.44682419e+00 -1.24002554e+00 -5.55774592e-01 -5.55774592e-01
 -5.55774592e-01  1.01768989e+00  1.03335301e+00  1.03335301e+00
  1.03335301e+00  7.36299739e+00  7.36299739e+00  7.36299739e+00
  1.29457359e+01  3.35753588e+01  3.35753588e+01  3.35753588e+01
  1.12698818e+02  1.29291511e+02  1.29291511e+02  1.29291511e+02
  4.83745924e+02  4.83745924e+02  4.83745924e+02  6.05912201e+02
  1.33549348e+03  1.33549348e+03  1.33549348e+03  2.67819000e+03
  3.02957779e+03  3.02957779e+03  3.02957779e+03  6.64996821e+03
  6.64996821e+03  6.64996821e+03  9.08276907e+03  2.54372496e+04
  7.61782165e+04]
E1 = -727.8468406045073  E_coul = 201.10740711702982
cycle= 1 E= -526.739433487478  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541948
diis-c [-0.29370713  1.        ]
  HOMO = -0.590688704077646  LUMO = 0.989164820584338
  mo_energy =
[-1.18636563e+02 -1.23426293e+01 -9.59525207e+00 -9.59525207e+00
 -9.59525207e+00 -1.27949459e+00 -5.90688704e-01 -5.90688704e-01
 -5.90688704e-01  9.89164821e-01  1.00900419e+00  1.00900419e+00
  1.00900419e+00  7.27212890e+00  7.27212890e+00  7.27212890e+00
  1.28342628e+01  3.34212772e+01  3.34212772e+01  3.34212772e+01
  1.12475577e+02  1.29063299e+02  1.29063299e+02  1.29063299e+02
  4.83439726e+02  4.83439726e+02  4.83439726e+02  6.05567316e+02
  1.33513118e+03  1.33513118e+03  1.33513118e+03  2.67769450e+03
  3.02914997e+03  3.02914997e+03  3.02914997e+03  6.64942751e+03
  6.64942751e+03  6.64942751e+03  9.08215350e+03  2.54365400e+04
  7.61774168e+04]
E1 = -728.4203373964839  E_coul = 201.68018551284516
cycle= 2 E= -526.740151883639  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.075054
diis-c [-0.00330801  0.08213041  0.91786959]
  HOMO = -0.581575906556668  LUMO = 0.99735001971308
  mo_energy =
[-1.18568916e+02 -1.23046022e+01 -9.55557239e+00 -9.55557239e+00
 -9.55557239e+00 -1.26858568e+00 -5.81575907e-01 -5.81575907e-01
 -5.81575907e-01  9.97350020e-01  1.01573279e+00  1.01573279e+00
  1.01573279e+00  7.29588070e+00  7.29588070e+00  7.29588070e+00
  1.28648057e+01  3.34613353e+01  3.34613353e+01  3.34613353e+01
  1.12531825e+02  1.29119156e+02  1.29119156e+02  1.29119156e+02
  4.83506556e+02  4.83506556e+02  4.83506556e+02  6.05636583e+02
  1.33520205e+03  1.33520205e+03  1.33520205e+03  2.67776869e+03
  3.02922308e+03  3.02922308e+03  3.02922308e+03  6.64950237e+03
  6.64950237e+03  6.64950237e+03  9.08222917e+03  2.54366163e+04
  7.61774933e+04]
E1 = -728.2700857610464  E_coul = 201.52987507621395
cycle= 3 E= -526.740210684832  delta_E= -5.88e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131763
diis-c [-5.74749235e-07 -1.23809405e-03  1.44923300e-01  8.56314794e-01]
  HOMO = -0.583076989710583  LUMO = 0.996098212094198
  mo_energy =
[-1.18578887e+02 -1.23104172e+01 -9.56173403e+00 -9.56173403e+00
 -9.56173403e+00 -1.27027974e+00 -5.83076990e-01 -5.83076990e-01
 -5.83076990e-01  9.96098212e-01  1.01464869e+00  1.01464869e+00
  1.01464869e+00  7.29209657e+00  7.29209657e+00  7.29209657e+00
  1.28601087e+01  3.34551548e+01  3.34551548e+01  3.34551548e+01
  1.12523463e+02  1.29110797e+02  1.29110797e+02  1.29110797e+02
  4.83496701e+02  4.83496701e+02  4.83496701e+02  6.05626362e+02
  1.33519161e+03  1.33519161e+03  1.33519161e+03  2.67775761e+03
  3.02921225e+03  3.02921225e+03  3.02921225e+03  6.64949115e+03
  6.64949115e+03  6.64949115e+03  9.08221774e+03  2.54366047e+04
  7.61774816e+04]
E1 = -728.2929050814703  E_coul = 201.55269247037967
cycle= 4 E= -526.740212611091  delta_E= -1.93e-06  |g|= 9.79e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113762
diis-c [-4.07271572e-09  7.26372759e-05 -1.03842661e-02 -6.72386336e-02
  1.07755026e+00]
  HOMO = -0.583059043826405  LUMO = 0.996131881361355
  mo_energy =
[-1.18578848e+02 -1.23103539e+01 -9.56168425e+00 -9.56168425e+00
 -9.56168425e+00 -1.27023919e+00 -5.83059044e-01 -5.83059044e-01
 -5.83059044e-01  9.96131881e-01  1.01466422e+00  1.01466422e+00
  1.01466422e+00  7.29213732e+00  7.29213732e+00  7.29213732e+00
  1.28601672e+01  3.34552026e+01  3.34552026e+01  3.34552026e+01
  1.12523513e+02  1.29110843e+02  1.29110843e+02  1.29110843e+02
  4.83496740e+02  4.83496740e+02  4.83496740e+02  6.05626393e+02
  1.33519164e+03  1.33519164e+03  1.33519164e+03  2.67775762e+03
  3.02921227e+03  3.02921227e+03  3.02921227e+03  6.64949116e+03
  6.64949116e+03  6.64949116e+03  9.08221774e+03  2.54366046e+04
  7.61774816e+04]
E1 = -728.2926963769627  E_coul = 201.552483764179
cycle= 5 E= -526.740212612784  delta_E= -1.69e-09  |g|= 2.05e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86941e-05
diis-c [-7.36923273e-11  1.44404890e-05 -1.87811732e-03 -1.39964391e-02
  4.27830668e-02  9.73077049e-01]
  HOMO = -0.583066441455881  LUMO = 0.99612796263092
  mo_energy =
[-1.18578879e+02 -1.23103763e+01 -9.56170855e+00 -9.56170855e+00
 -9.56170855e+00 -1.27024507e+00 -5.83066441e-01 -5.83066441e-01
 -5.83066441e-01  9.96127963e-01  1.01465931e+00  1.01465931e+00
  1.01465931e+00  7.29212083e+00  7.29212083e+00  7.29212083e+00
  1.28601489e+01  3.34551790e+01  3.34551790e+01  3.34551790e+01
  1.12523485e+02  1.29110816e+02  1.29110816e+02  1.29110816e+02
  4.83496710e+02  4.83496710e+02  4.83496710e+02  6.05626363e+02
  1.33519161e+03  1.33519161e+03  1.33519161e+03  2.67775759e+03
  3.02921224e+03  3.02921224e+03  3.02921224e+03  6.64949113e+03
  6.64949113e+03  6.64949113e+03  9.08221770e+03  2.54366046e+04
  7.61774815e+04]
E1 = -728.2927771959918  E_coul = 201.55256458314983
cycle= 6 E= -526.740212612842  delta_E= -5.83e-11  |g|= 1.74e-06  |ddm|= 1.85e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2927771959918  E_coul = 201.55256458314983
  HOMO = -0.58306646216198  LUMO = 0.996128298058768
  mo_energy =
[-1.18578878e+02 -1.23103761e+01 -9.56170849e+00 -9.56170849e+00
 -9.56170849e+00 -1.27024470e+00 -5.83066462e-01 -5.83066462e-01
 -5.83066462e-01  9.96128298e-01  1.01465935e+00  1.01465935e+00
  1.01465935e+00  7.29212088e+00  7.29212088e+00  7.29212088e+00
  1.28601491e+01  3.34551791e+01  3.34551791e+01  3.34551791e+01
  1.12523486e+02  1.29110816e+02  1.29110816e+02  1.29110816e+02
  4.83496710e+02  4.83496710e+02  4.83496710e+02  6.05626363e+02
  1.33519161e+03  1.33519161e+03  1.33519161e+03  2.67775759e+03
  3.02921224e+03  3.02921224e+03  3.02921224e+03  6.64949113e+03
  6.64949113e+03  6.64949113e+03  9.08221770e+03  2.54366046e+04
  7.61774815e+04]
E1 = -728.2927761757518  E_coul = 201.55256356290926
Extra cycle  E= -526.740212612842  delta_E= -4.55e-13  |g|= 3.57e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.31 sec, wall time      0.26 sec
exp = [2.61826613e+04 7.61751006e+03 3.61735667e+03 1.59758041e+03
 3.82703972e+02 1.12349204e+02 3.72676986e+01 8.28122724e+00
 3.25858891e+00 6.62479174e-01 2.43205153e-01 1.36278505e+03
 6.64727529e+02 3.00876389e+02 3.13968470e+02 6.16790463e+01
 7.33940812e+00 2.02565150e+01 7.76048093e-01 2.81659227e+00
 2.22724958e-01]
E = -526.7402126128425
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613477        1
[INPUT] 0    0    [1    /1   ]  7617.51006153        1
[INPUT] 0    0    [1    /1   ]  3617.35667075        1
[INPUT] 0    0    [1    /1   ]  1597.58041361        1
[INPUT] 0    0    [1    /1   ]  382.703972474        1
[INPUT] 0    0    [1    /1   ]  112.349204442        1
[INPUT] 0    0    [1    /1   ]  37.2676986033        1
[INPUT] 0    0    [1    /1   ]  8.28122723813        1
[INPUT] 0    0    [1    /1   ]  3.25858891205        1
[INPUT] 0    0    [1    /1   ]  0.662479174262       1
[INPUT] 0    0    [1    /1   ]  0.243205153486       1
[INPUT] 1    0    [1    /1   ]  1362.78504607        1
[INPUT] 1    0    [1    /1   ]  664.727528519        1
[INPUT] 1    0    [1    /1   ]  300.876388941        1
[INPUT] 1    0    [1    /1   ]  313.968469926        1
[INPUT] 1    0    [1    /1   ]  61.6790463442        1
[INPUT] 1    0    [1    /1   ]  7.33940812135        1
[INPUT] 1    0    [1    /1   ]  20.2565150077        1
[INPUT] 1    0    [1    /1   ]  0.776048092772       1
[INPUT] 1    0    [1    /1   ]  2.81659226556        1
[INPUT] 1    0    [1    /1   ]  0.222724957686       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661347709793, 1.0]], [0, [7617.51006152579, 1.0]], [0, [3617.3566707510445, 1.0]], [0, [1597.5804136060535, 1.0]], [0, [382.70397247369596, 1.0]], [0, [112.34920444153356, 1.0]], [0, [37.26769860326852, 1.0]], [0, [8.281227238132523, 1.0]], [0, [3.2585889120479177, 1.0]], [0, [0.6624791742615063, 1.0]], [0, [0.24320515348626032, 1.0]], [1, [1362.7850460728046, 1.0]], [1, [664.7275285191884, 1.0]], [1, [300.8763889408533, 1.0]], [1, [313.9684699261617, 1.0]], [1, [61.67904634415571, 1.0]], [1, [7.33940812134505, 1.0]], [1, [20.256515007721035, 1.0]], [1, [0.7760480927720412, 1.0]], [1, [2.8165922655637536, 1.0]], [1, [0.22272495768605638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66134771]
bas 1, expnt(s) = [7617.51006153]
bas 2, expnt(s) = [3617.35667075]
bas 3, expnt(s) = [1597.58041361]
bas 4, expnt(s) = [382.70397247]
bas 5, expnt(s) = [112.34920444]
bas 6, expnt(s) = [37.2676986]
bas 7, expnt(s) = [8.28122724]
bas 8, expnt(s) = [3.25858891]
bas 9, expnt(s) = [0.66247917]
bas 10, expnt(s) = [0.24320515]
bas 11, expnt(s) = [1362.78504607]
bas 12, expnt(s) = [664.72752852]
bas 13, expnt(s) = [300.87638894]
bas 14, expnt(s) = [313.96846993]
bas 15, expnt(s) = [61.67904634]
bas 16, expnt(s) = [7.33940812]
bas 17, expnt(s) = [20.25651501]
bas 18, expnt(s) = [0.77604809]
bas 19, expnt(s) = [2.81659227]
bas 20, expnt(s) = [0.22272496]
CPU time:       325.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826613e+04 5.20026369e+03 7.61751006e+03 2.06003596e+03
 3.61735667e+03 1.17844284e+03 1.59758041e+03 6.38428212e+02
 3.82703972e+02 2.18606088e+02 1.12349204e+02 8.71851513e+01
 3.72676986e+01 3.81078507e+01 8.28122724e+00 1.23334918e+01
 3.25858891e+00 6.12755483e+00 6.62479174e-01 1.85521479e+00
 2.43205153e-01 8.74972904e-01 1.36278505e+03 2.41556424e+04
 6.64727529e+02 9.84666071e+03 3.00876389e+02 3.65569141e+03
 3.13968470e+02 3.85559970e+03 6.16790463e+01 5.04262248e+02
 7.33940812e+00 3.52420116e+01 2.02565150e+01 1.25369041e+02
 7.76048093e-01 2.12493274e+00 2.81659227e+00 1.06448457e+01
 2.22724958e-01 4.46370514e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993585731278433
cond(S) = 103680.38932402755
E1 = -729.5306030433374  E_coul = 203.17858809921034
init E= -526.352014944127
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555774591507921  LUMO = 1.01768988878093
  mo_energy =
[-1.18329028e+02 -1.22049489e+01 -9.44682419e+00 -9.44682419e+00
 -9.44682419e+00 -1.24002554e+00 -5.55774592e-01 -5.55774592e-01
 -5.55774592e-01  1.01768989e+00  1.03335301e+00  1.03335301e+00
  1.03335301e+00  7.36299739e+00  7.36299739e+00  7.36299739e+00
  1.29457359e+01  3.35753588e+01  3.35753588e+01  3.35753588e+01
  1.12698818e+02  1.29291511e+02  1.29291511e+02  1.29291511e+02
  4.83745924e+02  4.83745924e+02  4.83745924e+02  6.05912201e+02
  1.33549348e+03  1.33549348e+03  1.33549348e+03  2.67819000e+03
  3.02957779e+03  3.02957779e+03  3.02957779e+03  6.64996821e+03
  6.64996821e+03  6.64996821e+03  9.08276907e+03  2.54372496e+04
  7.61782165e+04]
E1 = -727.8468406045073  E_coul = 201.10740711702982
cycle= 1 E= -526.739433487478  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.541948
diis-c [-0.29370713  1.        ]
  HOMO = -0.590688704077646  LUMO = 0.989164820584338
  mo_energy =
[-1.18636563e+02 -1.23426293e+01 -9.59525207e+00 -9.59525207e+00
 -9.59525207e+00 -1.27949459e+00 -5.90688704e-01 -5.90688704e-01
 -5.90688704e-01  9.89164821e-01  1.00900419e+00  1.00900419e+00
  1.00900419e+00  7.27212890e+00  7.27212890e+00  7.27212890e+00
  1.28342628e+01  3.34212772e+01  3.34212772e+01  3.34212772e+01
  1.12475577e+02  1.29063299e+02  1.29063299e+02  1.29063299e+02
  4.83439726e+02  4.83439726e+02  4.83439726e+02  6.05567316e+02
  1.33513118e+03  1.33513118e+03  1.33513118e+03  2.67769450e+03
  3.02914997e+03  3.02914997e+03  3.02914997e+03  6.64942751e+03
  6.64942751e+03  6.64942751e+03  9.08215350e+03  2.54365400e+04
  7.61774168e+04]
E1 = -728.4203373964839  E_coul = 201.68018551284516
cycle= 2 E= -526.740151883639  delta_E= -0.000718  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.075054
diis-c [-0.00330801  0.08213041  0.91786959]
  HOMO = -0.581575906556668  LUMO = 0.99735001971308
  mo_energy =
[-1.18568916e+02 -1.23046022e+01 -9.55557239e+00 -9.55557239e+00
 -9.55557239e+00 -1.26858568e+00 -5.81575907e-01 -5.81575907e-01
 -5.81575907e-01  9.97350020e-01  1.01573279e+00  1.01573279e+00
  1.01573279e+00  7.29588070e+00  7.29588070e+00  7.29588070e+00
  1.28648057e+01  3.34613353e+01  3.34613353e+01  3.34613353e+01
  1.12531825e+02  1.29119156e+02  1.29119156e+02  1.29119156e+02
  4.83506556e+02  4.83506556e+02  4.83506556e+02  6.05636583e+02
  1.33520205e+03  1.33520205e+03  1.33520205e+03  2.67776869e+03
  3.02922308e+03  3.02922308e+03  3.02922308e+03  6.64950237e+03
  6.64950237e+03  6.64950237e+03  9.08222917e+03  2.54366163e+04
  7.61774933e+04]
E1 = -728.2700857610464  E_coul = 201.52987507621395
cycle= 3 E= -526.740210684832  delta_E= -5.88e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131763
diis-c [-5.74749235e-07 -1.23809405e-03  1.44923300e-01  8.56314794e-01]
  HOMO = -0.583076989710583  LUMO = 0.996098212094198
  mo_energy =
[-1.18578887e+02 -1.23104172e+01 -9.56173403e+00 -9.56173403e+00
 -9.56173403e+00 -1.27027974e+00 -5.83076990e-01 -5.83076990e-01
 -5.83076990e-01  9.96098212e-01  1.01464869e+00  1.01464869e+00
  1.01464869e+00  7.29209657e+00  7.29209657e+00  7.29209657e+00
  1.28601087e+01  3.34551548e+01  3.34551548e+01  3.34551548e+01
  1.12523463e+02  1.29110797e+02  1.29110797e+02  1.29110797e+02
  4.83496701e+02  4.83496701e+02  4.83496701e+02  6.05626362e+02
  1.33519161e+03  1.33519161e+03  1.33519161e+03  2.67775761e+03
  3.02921225e+03  3.02921225e+03  3.02921225e+03  6.64949115e+03
  6.64949115e+03  6.64949115e+03  9.08221774e+03  2.54366047e+04
  7.61774816e+04]
E1 = -728.2929050814703  E_coul = 201.55269247037967
cycle= 4 E= -526.740212611091  delta_E= -1.93e-06  |g|= 9.79e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000113762
diis-c [-4.07271572e-09  7.26372759e-05 -1.03842661e-02 -6.72386336e-02
  1.07755026e+00]
  HOMO = -0.583059043826405  LUMO = 0.996131881361355
  mo_energy =
[-1.18578848e+02 -1.23103539e+01 -9.56168425e+00 -9.56168425e+00
 -9.56168425e+00 -1.27023919e+00 -5.83059044e-01 -5.83059044e-01
 -5.83059044e-01  9.96131881e-01  1.01466422e+00  1.01466422e+00
  1.01466422e+00  7.29213732e+00  7.29213732e+00  7.29213732e+00
  1.28601672e+01  3.34552026e+01  3.34552026e+01  3.34552026e+01
  1.12523513e+02  1.29110843e+02  1.29110843e+02  1.29110843e+02
  4.83496740e+02  4.83496740e+02  4.83496740e+02  6.05626393e+02
  1.33519164e+03  1.33519164e+03  1.33519164e+03  2.67775762e+03
  3.02921227e+03  3.02921227e+03  3.02921227e+03  6.64949116e+03
  6.64949116e+03  6.64949116e+03  9.08221774e+03  2.54366046e+04
  7.61774816e+04]
E1 = -728.2926963769627  E_coul = 201.552483764179
cycle= 5 E= -526.740212612784  delta_E= -1.69e-09  |g|= 2.05e-05  |ddm|= 0.000158
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.86941e-05
diis-c [-7.36923273e-11  1.44404890e-05 -1.87811732e-03 -1.39964391e-02
  4.27830668e-02  9.73077049e-01]
  HOMO = -0.583066441455881  LUMO = 0.99612796263092
  mo_energy =
[-1.18578879e+02 -1.23103763e+01 -9.56170855e+00 -9.56170855e+00
 -9.56170855e+00 -1.27024507e+00 -5.83066441e-01 -5.83066441e-01
 -5.83066441e-01  9.96127963e-01  1.01465931e+00  1.01465931e+00
  1.01465931e+00  7.29212083e+00  7.29212083e+00  7.29212083e+00
  1.28601489e+01  3.34551790e+01  3.34551790e+01  3.34551790e+01
  1.12523485e+02  1.29110816e+02  1.29110816e+02  1.29110816e+02
  4.83496710e+02  4.83496710e+02  4.83496710e+02  6.05626363e+02
  1.33519161e+03  1.33519161e+03  1.33519161e+03  2.67775759e+03
  3.02921224e+03  3.02921224e+03  3.02921224e+03  6.64949113e+03
  6.64949113e+03  6.64949113e+03  9.08221770e+03  2.54366046e+04
  7.61774815e+04]
E1 = -728.2927771959918  E_coul = 201.55256458314983
cycle= 6 E= -526.740212612842  delta_E= -5.83e-11  |g|= 1.74e-06  |ddm|= 1.85e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2927771959918  E_coul = 201.55256458314983
  HOMO = -0.58306646216198  LUMO = 0.996128298058768
  mo_energy =
[-1.18578878e+02 -1.23103761e+01 -9.56170849e+00 -9.56170849e+00
 -9.56170849e+00 -1.27024470e+00 -5.83066462e-01 -5.83066462e-01
 -5.83066462e-01  9.96128298e-01  1.01465935e+00  1.01465935e+00
  1.01465935e+00  7.29212088e+00  7.29212088e+00  7.29212088e+00
  1.28601491e+01  3.34551791e+01  3.34551791e+01  3.34551791e+01
  1.12523486e+02  1.29110816e+02  1.29110816e+02  1.29110816e+02
  4.83496710e+02  4.83496710e+02  4.83496710e+02  6.05626363e+02
  1.33519161e+03  1.33519161e+03  1.33519161e+03  2.67775759e+03
  3.02921224e+03  3.02921224e+03  3.02921224e+03  6.64949113e+03
  6.64949113e+03  6.64949113e+03  9.08221770e+03  2.54366046e+04
  7.61774815e+04]
E1 = -728.2927761757518  E_coul = 201.55256356290926
Extra cycle  E= -526.740212612842  delta_E= -4.55e-13  |g|= 3.57e-07  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.31 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103680.38932402755
E1 = -728.2927761757518  E_coul = 201.55256356290926
init E= -526.740212612842
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583066493740058  LUMO = 0.996128343379014
  mo_energy =
[-1.18578878e+02 -1.23103762e+01 -9.56170858e+00 -9.56170858e+00
 -9.56170858e+00 -1.27024466e+00 -5.83066494e-01 -5.83066494e-01
 -5.83066494e-01  9.96128343e-01  1.01465934e+00  1.01465934e+00
  1.01465934e+00  7.29212082e+00  7.29212082e+00  7.29212082e+00
  1.28601491e+01  3.34551790e+01  3.34551790e+01  3.34551790e+01
  1.12523485e+02  1.29110816e+02  1.29110816e+02  1.29110816e+02
  4.83496710e+02  4.83496710e+02  4.83496710e+02  6.05626363e+02
  1.33519161e+03  1.33519161e+03  1.33519161e+03  2.67775759e+03
  3.02921224e+03  3.02921224e+03  3.02921224e+03  6.64949113e+03
  6.64949113e+03  6.64949113e+03  9.08221770e+03  2.54366046e+04
  7.61774815e+04]
E1 = -728.2927763476157  E_coul = 201.55256373477297
cycle= 1 E= -526.740212612843  delta_E= -2.27e-13  |g|= 7.51e-08  |ddm|= 5.94e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.2927763476157  E_coul = 201.55256373477297
  HOMO = -0.583066493053789  LUMO = 0.996128358782059
  mo_energy =
[-1.18578878e+02 -1.23103762e+01 -9.56170857e+00 -9.56170857e+00
 -9.56170857e+00 -1.27024464e+00 -5.83066493e-01 -5.83066493e-01
 -5.83066493e-01  9.96128359e-01  1.01465934e+00  1.01465934e+00
  1.01465934e+00  7.29212083e+00  7.29212083e+00  7.29212083e+00
  1.28601491e+01  3.34551790e+01  3.34551790e+01  3.34551790e+01
  1.12523486e+02  1.29110816e+02  1.29110816e+02  1.29110816e+02
  4.83496710e+02  4.83496710e+02  4.83496710e+02  6.05626363e+02
  1.33519161e+03  1.33519161e+03  1.33519161e+03  2.67775759e+03
  3.02921224e+03  3.02921224e+03  3.02921224e+03  6.64949113e+03
  6.64949113e+03  6.64949113e+03  9.08221770e+03  2.54366046e+04
  7.61774815e+04]
E1 = -728.2927762755088  E_coul = 201.55256366266485
Extra cycle  E= -526.740212612844  delta_E= -1.25e-12  |g|= 1.52e-08  |ddm|= 1.25e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826613e+04 7.61751006e+03 3.61735667e+03 1.59758041e+03
 3.82703972e+02 1.12349204e+02 3.72676986e+01 8.28122724e+00
 3.25858891e+00 6.62479174e-01 2.43205153e-01 1.36278505e+03
 6.64727529e+02 3.00876389e+02 3.13968470e+02 6.16790463e+01
 7.33940812e+00 2.02565150e+01 7.76048093e-01 2.81659227e+00
 2.22724958e-01]
grad_E = [-1.55077795e-06  3.68539367e-06 -1.34031402e-06  8.32425236e-05
 -3.30328345e-04 -3.34454828e-05  1.98835620e-05  2.41725423e-05
 -5.02742268e-05  2.97868040e-05 -5.57078945e-04 -5.08730258e-07
  4.98910340e-06  2.35354303e-05  2.02853309e-05 -2.83530207e-05
 -3.58245106e-04  1.19080577e-04  4.55357847e-04  3.64249394e-04
 -1.24219262e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613878        1
[INPUT] 0    0    [1    /1   ]  7617.50995432        1
[INPUT] 0    0    [1    /1   ]  3617.35669474        1
[INPUT] 0    0    [1    /1   ]  1597.57776714        1
[INPUT] 0    0    [1    /1   ]  382.72574548         1
[INPUT] 0    0    [1    /1   ]  112.306570078        1
[INPUT] 0    0    [1    /1   ]  37.250607438         1
[INPUT] 0    0    [1    /1   ]  8.28527343405        1
[INPUT] 0    0    [1    /1   ]  3.25869894061        1
[INPUT] 0    0    [1    /1   ]  0.661497495761       1
[INPUT] 0    0    [1    /1   ]  0.24275483679        1
[INPUT] 1    0    [1    /1   ]  1362.78505894        1
[INPUT] 1    0    [1    /1   ]  664.727405839        1
[INPUT] 1    0    [1    /1   ]  300.875811845        1
[INPUT] 1    0    [1    /1   ]  313.967972711        1
[INPUT] 1    0    [1    /1   ]  61.679199264         1
[INPUT] 1    0    [1    /1   ]  7.33683286765        1
[INPUT] 1    0    [1    /1   ]  20.2575503328        1
[INPUT] 1    0    [1    /1   ]  0.776050293113       1
[INPUT] 1    0    [1    /1   ]  2.81629974299        1
[INPUT] 1    0    [1    /1   ]  0.222691556454       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661387770302, 1.0]], [0, [7617.509954323748, 1.0]], [0, [3617.356694743326, 1.0]], [0, [1597.5777671386195, 1.0]], [0, [382.72574547988586, 1.0]], [0, [112.30657007831607, 1.0]], [0, [37.25060743799731, 1.0]], [0, [8.285273434053098, 1.0]], [0, [3.258698940606635, 1.0]], [0, [0.661497495761099, 1.0]], [0, [0.24275483678963386, 1.0]], [1, [1362.7850589359555, 1.0]], [1, [664.7274058386889, 1.0]], [1, [300.8758118448924, 1.0]], [1, [313.96797271119885, 1.0]], [1, [61.67919926396187, 1.0]], [1, [7.336832867652182, 1.0]], [1, [20.257550332825367, 1.0]], [1, [0.7760502931127644, 1.0]], [1, [2.8162997429890377, 1.0]], [1, [0.22269155645392053, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66138777]
bas 1, expnt(s) = [7617.50995432]
bas 2, expnt(s) = [3617.35669474]
bas 3, expnt(s) = [1597.57776714]
bas 4, expnt(s) = [382.72574548]
bas 5, expnt(s) = [112.30657008]
bas 6, expnt(s) = [37.25060744]
bas 7, expnt(s) = [8.28527343]
bas 8, expnt(s) = [3.25869894]
bas 9, expnt(s) = [0.6614975]
bas 10, expnt(s) = [0.24275484]
bas 11, expnt(s) = [1362.78505894]
bas 12, expnt(s) = [664.72740584]
bas 13, expnt(s) = [300.87581184]
bas 14, expnt(s) = [313.96797271]
bas 15, expnt(s) = [61.67919926]
bas 16, expnt(s) = [7.33683287]
bas 17, expnt(s) = [20.25755033]
bas 18, expnt(s) = [0.77605029]
bas 19, expnt(s) = [2.81629974]
bas 20, expnt(s) = [0.22269156]
CPU time:       331.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026369e+03 7.61750995e+03 2.06003594e+03
 3.61735669e+03 1.17844285e+03 1.59757777e+03 6.38427418e+02
 3.82725745e+02 2.18615415e+02 1.12306570e+02 8.71603363e+01
 3.72506074e+01 3.80947426e+01 8.28527343e+00 1.23380112e+01
 3.25869894e+00 6.12771000e+00 6.61497496e-01 1.85315258e+00
 2.42754837e-01 8.73757553e-01 1.36278506e+03 2.41556427e+04
 6.64727406e+02 9.84665844e+03 3.00875812e+02 3.65568264e+03
 3.13967973e+02 3.85559207e+03 6.16791993e+01 5.04263810e+02
 7.33683287e+00 3.52265552e+01 2.02575503e+01 1.25377051e+02
 7.76050293e-01 2.12494027e+00 2.81629974e+00 1.06434638e+01
 2.22691556e-01 4.46286840e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99359172449092
cond(S) = 103673.1784319185
E1 = -729.5306756736749  E_coul = 203.1786459822243
init E= -526.352029691451
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555777769518525  LUMO = 1.0148760942888
  mo_energy =
[-1.18329024e+02 -1.22049386e+01 -9.44681601e+00 -9.44681601e+00
 -9.44681601e+00 -1.24002901e+00 -5.55777770e-01 -5.55777770e-01
 -5.55777770e-01  1.01487609e+00  1.03322776e+00  1.03322776e+00
  1.03322776e+00  7.36161175e+00  7.36161175e+00  7.36161175e+00
  1.29427298e+01  3.35688246e+01  3.35688246e+01  3.35688246e+01
  1.12658780e+02  1.29284484e+02  1.29284484e+02  1.29284484e+02
  4.83740776e+02  4.83740776e+02  4.83740776e+02  6.05769365e+02
  1.33548805e+03  1.33548805e+03  1.33548805e+03  2.67804066e+03
  3.02957123e+03  3.02957123e+03  3.02957123e+03  6.64996099e+03
  6.64996099e+03  6.64996099e+03  9.08263686e+03  2.54371248e+04
  7.61780997e+04]
E1 = -727.8459190534223  E_coul = 201.10648214113866
cycle= 1 E= -526.739436912284  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541962
diis-c [-0.29372282  1.        ]
  HOMO = -0.590728635230378  LUMO = 0.986381566198662
  mo_energy =
[-1.18636634e+02 -1.23426840e+01 -9.59531193e+00 -9.59531193e+00
 -9.59531193e+00 -1.27953321e+00 -5.90728635e-01 -5.90728635e-01
 -5.90728635e-01  9.86381566e-01  1.00885359e+00  1.00885359e+00
  1.00885359e+00  7.27069936e+00  7.27069936e+00  7.27069936e+00
  1.28311920e+01  3.34146821e+01  3.34146821e+01  3.34146821e+01
  1.12435489e+02  1.29056196e+02  1.29056196e+02  1.29056196e+02
  4.83434498e+02  4.83434498e+02  4.83434498e+02  6.05424410e+02
  1.33512568e+03  1.33512568e+03  1.33512568e+03  2.67754506e+03
  3.02914331e+03  3.02914331e+03  3.02914331e+03  6.64942020e+03
  6.64942020e+03  6.64942020e+03  9.08202118e+03  2.54364151e+04
  7.61772999e+04]
E1 = -728.419677431647  E_coul = 201.67952151701303
cycle= 2 E= -526.740155914634  delta_E= -0.000719  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750789
diis-c [-0.00330938  0.08216684  0.91783316]
  HOMO = -0.581611179256459  LUMO = 0.994555791810458
  mo_energy =
[-1.18568964e+02 -1.23046404e+01 -9.55561573e+00 -9.55561573e+00
 -9.55561573e+00 -1.26861822e+00 -5.81611179e-01 -5.81611179e-01
 -5.81611179e-01  9.94555792e-01  1.01558540e+00  1.01558540e+00
  1.01558540e+00  7.29445910e+00  7.29445910e+00  7.29445910e+00
  1.28617526e+01  3.34547552e+01  3.34547552e+01  3.34547552e+01
  1.12491753e+02  1.29112074e+02  1.29112074e+02  1.29112074e+02
  4.83501351e+02  4.83501351e+02  4.83501351e+02  6.05493700e+02
  1.33519657e+03  1.33519657e+03  1.33519657e+03  2.67761927e+03
  3.02921645e+03  3.02921645e+03  3.02921645e+03  6.64949509e+03
  6.64949509e+03  6.64949509e+03  9.08209688e+03  2.54364914e+04
  7.61773765e+04]
E1 = -728.2693502029455  E_coul = 201.52913542975793
cycle= 3 E= -526.740214773188  delta_E= -5.89e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131794
diis-c [-5.76496606e-07 -1.23861906e-03  1.44909172e-01  8.56329447e-01]
  HOMO = -0.583113055569256  LUMO = 0.993305958122119
  mo_energy =
[-1.18578937e+02 -1.23104570e+01 -9.56177913e+00 -9.56177913e+00
 -9.56177913e+00 -1.27031289e+00 -5.83113056e-01 -5.83113056e-01
 -5.83113056e-01  9.93305958e-01  1.01450081e+00  1.01450081e+00
  1.01450081e+00  7.29067405e+00  7.29067405e+00  7.29067405e+00
  1.28570536e+01  3.34485731e+01  3.34485731e+01  3.34485731e+01
  1.12483389e+02  1.29103713e+02  1.29103713e+02  1.29103713e+02
  4.83491495e+02  4.83491495e+02  4.83491495e+02  6.05483477e+02
  1.33518612e+03  1.33518612e+03  1.33518612e+03  2.67760819e+03
  3.02920562e+03  3.02920562e+03  3.02920562e+03  6.64948387e+03
  6.64948387e+03  6.64948387e+03  9.08208545e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2921769606954  E_coul = 201.5519602599062
cycle= 4 E= -526.740216700789  delta_E= -1.93e-06  |g|= 9.82e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000114153
diis-c [-4.08720754e-09  7.29229007e-05 -1.04174825e-02 -6.74659046e-02
  1.07781046e+00]
  HOMO = -0.583095159732962  LUMO = 0.993339611233123
  mo_energy =
[-1.18578899e+02 -1.23103937e+01 -9.56172945e+00 -9.56172945e+00
 -9.56172945e+00 -1.27027230e+00 -5.83095160e-01 -5.83095160e-01
 -5.83095160e-01  9.93339611e-01  1.01451631e+00  1.01451631e+00
  1.01451631e+00  7.29071473e+00  7.29071473e+00  7.29071473e+00
  1.28571122e+01  3.34486209e+01  3.34486209e+01  3.34486209e+01
  1.12483439e+02  1.29103759e+02  1.29103759e+02  1.29103759e+02
  4.83491533e+02  4.83491533e+02  4.83491533e+02  6.05483509e+02
  1.33518615e+03  1.33518615e+03  1.33518615e+03  2.67760820e+03
  3.02920564e+03  3.02920564e+03  3.02920564e+03  6.64948387e+03
  6.64948387e+03  6.64948387e+03  9.08208544e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2919682694204  E_coul = 201.5517515669237
cycle= 5 E= -526.740216702497  delta_E= -1.71e-09  |g|= 2.05e-05  |ddm|= 0.000159
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.87436e-05
diis-c [-7.41409277e-11  1.44629153e-05 -1.87992096e-03 -1.40110615e-02
  4.26077001e-02  9.73268819e-01]
  HOMO = -0.583102574459189  LUMO = 0.993335695745643
  mo_energy =
[-1.18578930e+02 -1.23104162e+01 -9.56175379e+00 -9.56175379e+00
 -9.56175379e+00 -1.27027818e+00 -5.83102574e-01 -5.83102574e-01
 -5.83102574e-01  9.93335696e-01  1.01451139e+00  1.01451139e+00
  1.01451139e+00  7.29069821e+00  7.29069821e+00  7.29069821e+00
  1.28570938e+01  3.34485972e+01  3.34485972e+01  3.34485972e+01
  1.12483412e+02  1.29103731e+02  1.29103731e+02  1.29103731e+02
  4.83491503e+02  4.83491503e+02  4.83491503e+02  6.05483478e+02
  1.33518612e+03  1.33518612e+03  1.33518612e+03  2.67760817e+03
  3.02920561e+03  3.02920561e+03  3.02920561e+03  6.64948384e+03
  6.64948384e+03  6.64948384e+03  9.08208541e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2920492085385  E_coul = 201.55183250598273
cycle= 6 E= -526.740216702556  delta_E= -5.91e-11  |g|= 1.74e-06  |ddm|= 1.86e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2920492085385  E_coul = 201.55183250598273
  HOMO = -0.583102593481695  LUMO = 0.993336032754264
  mo_energy =
[-1.18578929e+02 -1.23104160e+01 -9.56175372e+00 -9.56175372e+00
 -9.56175372e+00 -1.27027781e+00 -5.83102593e-01 -5.83102593e-01
 -5.83102593e-01  9.93336033e-01  1.01451143e+00  1.01451143e+00
  1.01451143e+00  7.29069826e+00  7.29069826e+00  7.29069826e+00
  1.28570941e+01  3.34485973e+01  3.34485973e+01  3.34485973e+01
  1.12483412e+02  1.29103732e+02  1.29103732e+02  1.29103732e+02
  4.83491503e+02  4.83491503e+02  4.83491503e+02  6.05483478e+02
  1.33518612e+03  1.33518612e+03  1.33518612e+03  2.67760817e+03
  3.02920561e+03  3.02920561e+03  3.02920561e+03  6.64948384e+03
  6.64948384e+03  6.64948384e+03  9.08208541e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2920481573914  E_coul = 201.55183145483414
Extra cycle  E= -526.740216702557  delta_E= -1.48e-12  |g|= 3.58e-07  |ddm|= 3.04e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
exp = [2.61826614e+04 7.61750995e+03 3.61735669e+03 1.59757777e+03
 3.82725745e+02 1.12306570e+02 3.72506074e+01 8.28527343e+00
 3.25869894e+00 6.61497496e-01 2.42754837e-01 1.36278506e+03
 6.64727406e+02 3.00875812e+02 3.13967973e+02 6.16791993e+01
 7.33683287e+00 2.02575503e+01 7.76050293e-01 2.81629974e+00
 2.22691556e-01]
E = -526.7402167025573
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6613878        1
[INPUT] 0    0    [1    /1   ]  7617.50995432        1
[INPUT] 0    0    [1    /1   ]  3617.35669474        1
[INPUT] 0    0    [1    /1   ]  1597.57776714        1
[INPUT] 0    0    [1    /1   ]  382.72574548         1
[INPUT] 0    0    [1    /1   ]  112.306570078        1
[INPUT] 0    0    [1    /1   ]  37.250607438         1
[INPUT] 0    0    [1    /1   ]  8.28527343405        1
[INPUT] 0    0    [1    /1   ]  3.25869894061        1
[INPUT] 0    0    [1    /1   ]  0.661497495761       1
[INPUT] 0    0    [1    /1   ]  0.24275483679        1
[INPUT] 1    0    [1    /1   ]  1362.78505894        1
[INPUT] 1    0    [1    /1   ]  664.727405839        1
[INPUT] 1    0    [1    /1   ]  300.875811845        1
[INPUT] 1    0    [1    /1   ]  313.967972711        1
[INPUT] 1    0    [1    /1   ]  61.679199264         1
[INPUT] 1    0    [1    /1   ]  7.33683286765        1
[INPUT] 1    0    [1    /1   ]  20.2575503328        1
[INPUT] 1    0    [1    /1   ]  0.776050293113       1
[INPUT] 1    0    [1    /1   ]  2.81629974299        1
[INPUT] 1    0    [1    /1   ]  0.222691556454       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.661387770302, 1.0]], [0, [7617.509954323748, 1.0]], [0, [3617.356694743326, 1.0]], [0, [1597.5777671386195, 1.0]], [0, [382.72574547988586, 1.0]], [0, [112.30657007831607, 1.0]], [0, [37.25060743799731, 1.0]], [0, [8.285273434053098, 1.0]], [0, [3.258698940606635, 1.0]], [0, [0.661497495761099, 1.0]], [0, [0.24275483678963386, 1.0]], [1, [1362.7850589359555, 1.0]], [1, [664.7274058386889, 1.0]], [1, [300.8758118448924, 1.0]], [1, [313.96797271119885, 1.0]], [1, [61.67919926396187, 1.0]], [1, [7.336832867652182, 1.0]], [1, [20.257550332825367, 1.0]], [1, [0.7760502931127644, 1.0]], [1, [2.8162997429890377, 1.0]], [1, [0.22269155645392053, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66138777]
bas 1, expnt(s) = [7617.50995432]
bas 2, expnt(s) = [3617.35669474]
bas 3, expnt(s) = [1597.57776714]
bas 4, expnt(s) = [382.72574548]
bas 5, expnt(s) = [112.30657008]
bas 6, expnt(s) = [37.25060744]
bas 7, expnt(s) = [8.28527343]
bas 8, expnt(s) = [3.25869894]
bas 9, expnt(s) = [0.6614975]
bas 10, expnt(s) = [0.24275484]
bas 11, expnt(s) = [1362.78505894]
bas 12, expnt(s) = [664.72740584]
bas 13, expnt(s) = [300.87581184]
bas 14, expnt(s) = [313.96797271]
bas 15, expnt(s) = [61.67919926]
bas 16, expnt(s) = [7.33683287]
bas 17, expnt(s) = [20.25755033]
bas 18, expnt(s) = [0.77605029]
bas 19, expnt(s) = [2.81629974]
bas 20, expnt(s) = [0.22269156]
CPU time:       332.20
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826614e+04 5.20026369e+03 7.61750995e+03 2.06003594e+03
 3.61735669e+03 1.17844285e+03 1.59757777e+03 6.38427418e+02
 3.82725745e+02 2.18615415e+02 1.12306570e+02 8.71603363e+01
 3.72506074e+01 3.80947426e+01 8.28527343e+00 1.23380112e+01
 3.25869894e+00 6.12771000e+00 6.61497496e-01 1.85315258e+00
 2.42754837e-01 8.73757553e-01 1.36278506e+03 2.41556427e+04
 6.64727406e+02 9.84665844e+03 3.00875812e+02 3.65568264e+03
 3.13967973e+02 3.85559207e+03 6.16791993e+01 5.04263810e+02
 7.33683287e+00 3.52265552e+01 2.02575503e+01 1.25377051e+02
 7.76050293e-01 2.12494027e+00 2.81629974e+00 1.06434638e+01
 2.22691556e-01 4.46286840e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99359172449092
cond(S) = 103673.1784319185
E1 = -729.5306756736749  E_coul = 203.1786459822243
init E= -526.352029691451
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555777769518525  LUMO = 1.0148760942888
  mo_energy =
[-1.18329024e+02 -1.22049386e+01 -9.44681601e+00 -9.44681601e+00
 -9.44681601e+00 -1.24002901e+00 -5.55777770e-01 -5.55777770e-01
 -5.55777770e-01  1.01487609e+00  1.03322776e+00  1.03322776e+00
  1.03322776e+00  7.36161175e+00  7.36161175e+00  7.36161175e+00
  1.29427298e+01  3.35688246e+01  3.35688246e+01  3.35688246e+01
  1.12658780e+02  1.29284484e+02  1.29284484e+02  1.29284484e+02
  4.83740776e+02  4.83740776e+02  4.83740776e+02  6.05769365e+02
  1.33548805e+03  1.33548805e+03  1.33548805e+03  2.67804066e+03
  3.02957123e+03  3.02957123e+03  3.02957123e+03  6.64996099e+03
  6.64996099e+03  6.64996099e+03  9.08263686e+03  2.54371248e+04
  7.61780997e+04]
E1 = -727.8459190534223  E_coul = 201.10648214113866
cycle= 1 E= -526.739436912284  delta_E= -0.387  |g|= 0.186  |ddm|= 0.315
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541962
diis-c [-0.29372282  1.        ]
  HOMO = -0.590728635230378  LUMO = 0.986381566198662
  mo_energy =
[-1.18636634e+02 -1.23426840e+01 -9.59531193e+00 -9.59531193e+00
 -9.59531193e+00 -1.27953321e+00 -5.90728635e-01 -5.90728635e-01
 -5.90728635e-01  9.86381566e-01  1.00885359e+00  1.00885359e+00
  1.00885359e+00  7.27069936e+00  7.27069936e+00  7.27069936e+00
  1.28311920e+01  3.34146821e+01  3.34146821e+01  3.34146821e+01
  1.12435489e+02  1.29056196e+02  1.29056196e+02  1.29056196e+02
  4.83434498e+02  4.83434498e+02  4.83434498e+02  6.05424410e+02
  1.33512568e+03  1.33512568e+03  1.33512568e+03  2.67754506e+03
  3.02914331e+03  3.02914331e+03  3.02914331e+03  6.64942020e+03
  6.64942020e+03  6.64942020e+03  9.08202118e+03  2.54364151e+04
  7.61772999e+04]
E1 = -728.419677431647  E_coul = 201.67952151701303
cycle= 2 E= -526.740155914634  delta_E= -0.000719  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0750789
diis-c [-0.00330938  0.08216684  0.91783316]
  HOMO = -0.581611179256459  LUMO = 0.994555791810458
  mo_energy =
[-1.18568964e+02 -1.23046404e+01 -9.55561573e+00 -9.55561573e+00
 -9.55561573e+00 -1.26861822e+00 -5.81611179e-01 -5.81611179e-01
 -5.81611179e-01  9.94555792e-01  1.01558540e+00  1.01558540e+00
  1.01558540e+00  7.29445910e+00  7.29445910e+00  7.29445910e+00
  1.28617526e+01  3.34547552e+01  3.34547552e+01  3.34547552e+01
  1.12491753e+02  1.29112074e+02  1.29112074e+02  1.29112074e+02
  4.83501351e+02  4.83501351e+02  4.83501351e+02  6.05493700e+02
  1.33519657e+03  1.33519657e+03  1.33519657e+03  2.67761927e+03
  3.02921645e+03  3.02921645e+03  3.02921645e+03  6.64949509e+03
  6.64949509e+03  6.64949509e+03  9.08209688e+03  2.54364914e+04
  7.61773765e+04]
E1 = -728.2693502029455  E_coul = 201.52913542975793
cycle= 3 E= -526.740214773188  delta_E= -5.89e-05  |g|= 0.00629  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131794
diis-c [-5.76496606e-07 -1.23861906e-03  1.44909172e-01  8.56329447e-01]
  HOMO = -0.583113055569256  LUMO = 0.993305958122119
  mo_energy =
[-1.18578937e+02 -1.23104570e+01 -9.56177913e+00 -9.56177913e+00
 -9.56177913e+00 -1.27031289e+00 -5.83113056e-01 -5.83113056e-01
 -5.83113056e-01  9.93305958e-01  1.01450081e+00  1.01450081e+00
  1.01450081e+00  7.29067405e+00  7.29067405e+00  7.29067405e+00
  1.28570536e+01  3.34485731e+01  3.34485731e+01  3.34485731e+01
  1.12483389e+02  1.29103713e+02  1.29103713e+02  1.29103713e+02
  4.83491495e+02  4.83491495e+02  4.83491495e+02  6.05483477e+02
  1.33518612e+03  1.33518612e+03  1.33518612e+03  2.67760819e+03
  3.02920562e+03  3.02920562e+03  3.02920562e+03  6.64948387e+03
  6.64948387e+03  6.64948387e+03  9.08208545e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2921769606954  E_coul = 201.5519602599062
cycle= 4 E= -526.740216700789  delta_E= -1.93e-06  |g|= 9.82e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000114153
diis-c [-4.08720754e-09  7.29229007e-05 -1.04174825e-02 -6.74659046e-02
  1.07781046e+00]
  HOMO = -0.583095159732962  LUMO = 0.993339611233123
  mo_energy =
[-1.18578899e+02 -1.23103937e+01 -9.56172945e+00 -9.56172945e+00
 -9.56172945e+00 -1.27027230e+00 -5.83095160e-01 -5.83095160e-01
 -5.83095160e-01  9.93339611e-01  1.01451631e+00  1.01451631e+00
  1.01451631e+00  7.29071473e+00  7.29071473e+00  7.29071473e+00
  1.28571122e+01  3.34486209e+01  3.34486209e+01  3.34486209e+01
  1.12483439e+02  1.29103759e+02  1.29103759e+02  1.29103759e+02
  4.83491533e+02  4.83491533e+02  4.83491533e+02  6.05483509e+02
  1.33518615e+03  1.33518615e+03  1.33518615e+03  2.67760820e+03
  3.02920564e+03  3.02920564e+03  3.02920564e+03  6.64948387e+03
  6.64948387e+03  6.64948387e+03  9.08208544e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2919682694204  E_coul = 201.5517515669237
cycle= 5 E= -526.740216702497  delta_E= -1.71e-09  |g|= 2.05e-05  |ddm|= 0.000159
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.87436e-05
diis-c [-7.41409277e-11  1.44629153e-05 -1.87992096e-03 -1.40110615e-02
  4.26077001e-02  9.73268819e-01]
  HOMO = -0.583102574459189  LUMO = 0.993335695745643
  mo_energy =
[-1.18578930e+02 -1.23104162e+01 -9.56175379e+00 -9.56175379e+00
 -9.56175379e+00 -1.27027818e+00 -5.83102574e-01 -5.83102574e-01
 -5.83102574e-01  9.93335696e-01  1.01451139e+00  1.01451139e+00
  1.01451139e+00  7.29069821e+00  7.29069821e+00  7.29069821e+00
  1.28570938e+01  3.34485972e+01  3.34485972e+01  3.34485972e+01
  1.12483412e+02  1.29103731e+02  1.29103731e+02  1.29103731e+02
  4.83491503e+02  4.83491503e+02  4.83491503e+02  6.05483478e+02
  1.33518612e+03  1.33518612e+03  1.33518612e+03  2.67760817e+03
  3.02920561e+03  3.02920561e+03  3.02920561e+03  6.64948384e+03
  6.64948384e+03  6.64948384e+03  9.08208541e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2920492085385  E_coul = 201.55183250598273
cycle= 6 E= -526.740216702556  delta_E= -5.91e-11  |g|= 1.74e-06  |ddm|= 1.86e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2920492085385  E_coul = 201.55183250598273
  HOMO = -0.583102593481695  LUMO = 0.993336032754264
  mo_energy =
[-1.18578929e+02 -1.23104160e+01 -9.56175372e+00 -9.56175372e+00
 -9.56175372e+00 -1.27027781e+00 -5.83102593e-01 -5.83102593e-01
 -5.83102593e-01  9.93336033e-01  1.01451143e+00  1.01451143e+00
  1.01451143e+00  7.29069826e+00  7.29069826e+00  7.29069826e+00
  1.28570941e+01  3.34485973e+01  3.34485973e+01  3.34485973e+01
  1.12483412e+02  1.29103732e+02  1.29103732e+02  1.29103732e+02
  4.83491503e+02  4.83491503e+02  4.83491503e+02  6.05483478e+02
  1.33518612e+03  1.33518612e+03  1.33518612e+03  2.67760817e+03
  3.02920561e+03  3.02920561e+03  3.02920561e+03  6.64948384e+03
  6.64948384e+03  6.64948384e+03  9.08208541e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2920481573914  E_coul = 201.55183145483414
Extra cycle  E= -526.740216702557  delta_E= -1.48e-12  |g|= 3.58e-07  |ddm|= 3.04e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103673.1784319185
E1 = -728.2920481573914  E_coul = 201.55183145483414
init E= -526.740216702557
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.58310262574321  LUMO = 0.993336077580329
  mo_energy =
[-1.18578929e+02 -1.23104161e+01 -9.56175382e+00 -9.56175382e+00
 -9.56175382e+00 -1.27027777e+00 -5.83102626e-01 -5.83102626e-01
 -5.83102626e-01  9.93336078e-01  1.01451142e+00  1.01451142e+00
  1.01451142e+00  7.29069821e+00  7.29069821e+00  7.29069821e+00
  1.28570940e+01  3.34485972e+01  3.34485972e+01  3.34485972e+01
  1.12483412e+02  1.29103731e+02  1.29103731e+02  1.29103731e+02
  4.83491503e+02  4.83491503e+02  4.83491503e+02  6.05483478e+02
  1.33518612e+03  1.33518612e+03  1.33518612e+03  2.67760817e+03
  3.02920561e+03  3.02920561e+03  3.02920561e+03  6.64948384e+03
  6.64948384e+03  6.64948384e+03  9.08208541e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2920483369254  E_coul = 201.55183163436917
cycle= 1 E= -526.740216702556  delta_E= 1.02e-12  |g|= 7.53e-08  |ddm|= 5.95e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2920483369254  E_coul = 201.55183163436917
  HOMO = -0.583102624929701  LUMO = 0.993336093106805
  mo_energy =
[-1.18578929e+02 -1.23104161e+01 -9.56175381e+00 -9.56175381e+00
 -9.56175381e+00 -1.27027776e+00 -5.83102625e-01 -5.83102625e-01
 -5.83102625e-01  9.93336093e-01  1.01451142e+00  1.01451142e+00
  1.01451142e+00  7.29069821e+00  7.29069821e+00  7.29069821e+00
  1.28570940e+01  3.34485973e+01  3.34485973e+01  3.34485973e+01
  1.12483412e+02  1.29103731e+02  1.29103731e+02  1.29103731e+02
  4.83491503e+02  4.83491503e+02  4.83491503e+02  6.05483478e+02
  1.33518612e+03  1.33518612e+03  1.33518612e+03  2.67760817e+03
  3.02920561e+03  3.02920561e+03  3.02920561e+03  6.64948384e+03
  6.64948384e+03  6.64948384e+03  9.08208541e+03  2.54364797e+04
  7.61773647e+04]
E1 = -728.2920482624213  E_coul = 201.5518315598645
Extra cycle  E= -526.740216702557  delta_E= -5.68e-13  |g|= 1.53e-08  |ddm|= 1.26e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826614e+04 7.61750995e+03 3.61735669e+03 1.59757777e+03
 3.82725745e+02 1.12306570e+02 3.72506074e+01 8.28527343e+00
 3.25869894e+00 6.61497496e-01 2.42754837e-01 1.36278506e+03
 6.64727406e+02 3.00875812e+02 3.13967973e+02 6.16791993e+01
 7.33683287e+00 2.02575503e+01 7.76050293e-01 2.81629974e+00
 2.22691556e-01]
grad_E = [-1.55020440e-06  3.67856097e-06 -1.34559023e-06  8.29949715e-05
 -3.25204517e-04 -5.07286061e-05  2.35616334e-05  6.07709656e-05
 -1.07507245e-04  4.88105093e-05 -9.78043098e-04 -5.07604979e-07
  5.00471984e-06  2.36306753e-05  2.03670022e-05 -3.98624822e-05
 -6.65849479e-04  2.19080722e-04  8.52690693e-04  6.69683832e-04
 -2.33883849e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6615636        1
[INPUT] 0    0    [1    /1   ]  7617.50951839        1
[INPUT] 0    0    [1    /1   ]  3617.35683076        1
[INPUT] 0    0    [1    /1   ]  1597.56758382        1
[INPUT] 0    0    [1    /1   ]  382.78300239         1
[INPUT] 0    0    [1    /1   ]  112.24511344         1
[INPUT] 0    0    [1    /1   ]  37.2247773831        1
[INPUT] 0    0    [1    /1   ]  8.29195682864        1
[INPUT] 0    0    [1    /1   ]  3.2589427571         1
[INPUT] 0    0    [1    /1   ]  0.659927346684       1
[INPUT] 0    0    [1    /1   ]  0.242032166911       1
[INPUT] 1    0    [1    /1   ]  1362.78511631        1
[INPUT] 1    0    [1    /1   ]  664.726850731        1
[INPUT] 1    0    [1    /1   ]  300.873197599        1
[INPUT] 1    0    [1    /1   ]  313.965719718        1
[INPUT] 1    0    [1    /1   ]  61.6805047118        1
[INPUT] 1    0    [1    /1   ]  7.33258112696        1
[INPUT] 1    0    [1    /1   ]  20.2591037325        1
[INPUT] 1    0    [1    /1   ]  0.776049340529       1
[INPUT] 1    0    [1    /1   ]  2.81578804849        1
[INPUT] 1    0    [1    /1   ]  0.222636962554       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.66156364101, 1.0]], [0, [7617.509518391795, 1.0]], [0, [3617.3568307604255, 1.0]], [0, [1597.567583815712, 1.0]], [0, [382.7830023900088, 1.0]], [0, [112.24511343982859, 1.0]], [0, [37.22477738305122, 1.0]], [0, [8.291956828643382, 1.0]], [0, [3.2589427570987843, 1.0]], [0, [0.6599273466837118, 1.0]], [0, [0.24203216691087684, 1.0]], [1, [1362.7851163146984, 1.0]], [1, [664.7268507305755, 1.0]], [1, [300.8731975987089, 1.0]], [1, [313.9657197177292, 1.0]], [1, [61.68050471182808, 1.0]], [1, [7.332581126959302, 1.0]], [1, [20.25910373247283, 1.0]], [1, [0.7760493405289028, 1.0]], [1, [2.815788048493654, 1.0]], [1, [0.22263696255429363, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66156364]
bas 1, expnt(s) = [7617.50951839]
bas 2, expnt(s) = [3617.35683076]
bas 3, expnt(s) = [1597.56758382]
bas 4, expnt(s) = [382.78300239]
bas 5, expnt(s) = [112.24511344]
bas 6, expnt(s) = [37.22477738]
bas 7, expnt(s) = [8.29195683]
bas 8, expnt(s) = [3.25894276]
bas 9, expnt(s) = [0.65992735]
bas 10, expnt(s) = [0.24203217]
bas 11, expnt(s) = [1362.78511631]
bas 12, expnt(s) = [664.72685073]
bas 13, expnt(s) = [300.8731976]
bas 14, expnt(s) = [313.96571972]
bas 15, expnt(s) = [61.68050471]
bas 16, expnt(s) = [7.33258113]
bas 17, expnt(s) = [20.25910373]
bas 18, expnt(s) = [0.77604934]
bas 19, expnt(s) = [2.81578805]
bas 20, expnt(s) = [0.22263696]
CPU time:       338.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826616e+04 5.20026372e+03 7.61750952e+03 2.06003585e+03
 3.61735683e+03 1.17844288e+03 1.59756758e+03 6.38424366e+02
 3.82783002e+02 2.18639944e+02 1.12245113e+02 8.71245618e+01
 3.72247774e+01 3.80749293e+01 8.29195683e+00 1.23454748e+01
 3.25894276e+00 6.12805386e+00 6.59927347e-01 1.84985257e+00
 2.42032167e-01 8.71805975e-01 1.36278512e+03 2.41556440e+04
 6.64726851e+02 9.84664816e+03 3.00873198e+02 3.65564294e+03
 3.13965720e+02 3.85555749e+03 6.16805047e+01 5.04277152e+02
 7.33258113e+00 3.52010395e+01 2.02591037e+01 1.25389069e+02
 7.76049341e-01 2.12493701e+00 2.81578805e+00 1.06410466e+01
 2.22636963e-01 4.46150083e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993601241382994
cond(S) = 103657.35981591947
E1 = -729.5307891833843  E_coul = 203.17873857211745
init E= -526.352050611267
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555782895534165  LUMO = 1.01037448338225
  mo_energy =
[-1.18329020e+02 -1.22049220e+01 -9.44680264e+00 -9.44680264e+00
 -9.44680264e+00 -1.24003439e+00 -5.55782896e-01 -5.55782896e-01
 -5.55782896e-01  1.01037448e+00  1.03301889e+00  1.03301889e+00
  1.03301889e+00  7.35926521e+00  7.35926521e+00  7.35926521e+00
  1.29383765e+01  3.35578099e+01  3.35578099e+01  3.35578099e+01
  1.12601590e+02  1.29273306e+02  1.29273306e+02  1.29273306e+02
  4.83733504e+02  4.83733504e+02  4.83733504e+02  6.05579827e+02
  1.33547763e+03  1.33547763e+03  1.33547763e+03  2.67788848e+03
  3.02955463e+03  3.02955463e+03  3.02955463e+03  6.64994028e+03
  6.64994028e+03  6.64994028e+03  9.08252188e+03  2.54370166e+04
  7.61779969e+04]
E1 = -727.8444450608775  E_coul = 201.10499857378633
cycle= 1 E= -526.739446487091  delta_E= -0.387  |g|= 0.186  |ddm|= 0.316
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541983
diis-c [-0.29374569  1.        ]
  HOMO = -0.590792724467749  LUMO = 0.981928900681894
  mo_energy =
[-1.18636753e+02 -1.23427717e+01 -9.59540768e+00 -9.59540768e+00
 -9.59540768e+00 -1.27959507e+00 -5.90792724e-01 -5.90792724e-01
 -5.90792724e-01  9.81928901e-01  1.00860429e+00  1.00860429e+00
  1.00860429e+00  7.26828334e+00  7.26828334e+00  7.26828334e+00
  1.28267329e+01  3.34035704e+01  3.34035704e+01  3.34035704e+01
  1.12378216e+02  1.29044897e+02  1.29044897e+02  1.29044897e+02
  4.83427099e+02  4.83427099e+02  4.83427099e+02  6.05234756e+02
  1.33511513e+03  1.33511513e+03  1.33511513e+03  2.67739273e+03
  3.02912657e+03  3.02912657e+03  3.02912657e+03  6.64939935e+03
  6.64939935e+03  6.64939935e+03  9.08190605e+03  2.54363067e+04
  7.61771970e+04]
E1 = -728.4186224932675  E_coul = 201.67845603186692
cycle= 2 E= -526.740166461401  delta_E= -0.00072  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0751185
diis-c [-0.00331154  0.08222546  0.91777454]
  HOMO = -0.581667806726892  LUMO = 0.99008551919793
  mo_energy =
[-1.18569045e+02 -1.23047017e+01 -9.55568501e+00 -9.55568501e+00
 -9.55568501e+00 -1.26867034e+00 -5.81667807e-01 -5.81667807e-01
 -5.81667807e-01  9.90085519e-01  1.01534116e+00  1.01534116e+00
  1.01534116e+00  7.29205553e+00  7.29205553e+00  7.29205553e+00
  1.28573222e+01  3.34436674e+01  3.34436674e+01  3.34436674e+01
  1.12434504e+02  1.29100809e+02  1.29100809e+02  1.29100809e+02
  4.83493989e+02  4.83493989e+02  4.83493989e+02  6.05304082e+02
  1.33518606e+03  1.33518606e+03  1.33518606e+03  2.67746698e+03
  3.02919975e+03  3.02919975e+03  3.02919975e+03  6.64947427e+03
  6.64947427e+03  6.64947427e+03  9.08198179e+03  2.54363830e+04
  7.61772736e+04]
E1 = -728.2681741575733  E_coul = 201.52794874566237
cycle= 3 E= -526.740225411911  delta_E= -5.9e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131843
diis-c [-5.79296295e-07 -1.23945128e-03  1.44886223e-01  8.56353228e-01]
  HOMO = -0.58317095438814  LUMO = 0.988838847980189
  mo_energy =
[-1.18579022e+02 -1.23105209e+01 -9.56185121e+00 -9.56185121e+00
 -9.56185121e+00 -1.27036598e+00 -5.83170954e-01 -5.83170954e-01
 -5.83170954e-01  9.88838848e-01  1.01425579e+00  1.01425579e+00
  1.01425579e+00  7.28826906e+00  7.28826906e+00  7.28826906e+00
  1.28526202e+01  3.34374829e+01  3.34374829e+01  3.34374829e+01
  1.12426139e+02  1.29092445e+02  1.29092445e+02  1.29092445e+02
  4.83484129e+02  4.83484129e+02  4.83484129e+02  6.05293856e+02
  1.33517561e+03  1.33517561e+03  1.33517561e+03  2.67745590e+03
  3.02918892e+03  3.02918892e+03  3.02918892e+03  6.64946304e+03
  6.64946304e+03  6.64946304e+03  9.08197035e+03  2.54363714e+04
  7.61772619e+04]
E1 = -728.2910127908701  E_coul = 201.55078544920949
cycle= 4 E= -526.740227341661  delta_E= -1.93e-06  |g|= 9.87e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000114776
diis-c [-4.11057142e-09  7.33783151e-05 -1.04704021e-02 -6.78283028e-02
  1.07822533e+00]
  HOMO = -0.583153138829946  LUMO = 0.988872474787622
  mo_energy =
[-1.18578984e+02 -1.23104577e+01 -9.56180169e+00 -9.56180169e+00
 -9.56180169e+00 -1.27032534e+00 -5.83153139e-01 -5.83153139e-01
 -5.83153139e-01  9.88872475e-01  1.01427125e+00  1.01427125e+00
  1.01427125e+00  7.28830962e+00  7.28830962e+00  7.28830962e+00
  1.28526787e+01  3.34375305e+01  3.34375305e+01  3.34375305e+01
  1.12426189e+02  1.29092491e+02  1.29092491e+02  1.29092491e+02
  4.83484167e+02  4.83484167e+02  4.83484167e+02  6.05293887e+02
  1.33517564e+03  1.33517564e+03  1.33517564e+03  2.67745591e+03
  3.02918893e+03  3.02918893e+03  3.02918893e+03  6.64946305e+03
  6.64946305e+03  6.64946305e+03  9.08197034e+03  2.54363714e+04
  7.61772618e+04]
E1 = -728.2908041157157  E_coul = 201.55057677232287
cycle= 5 E= -526.740227343393  delta_E= -1.73e-09  |g|= 2.06e-05  |ddm|= 0.00016
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.88226e-05
diis-c [-7.48589124e-11  1.44983344e-05 -1.88277578e-03 -1.40342755e-02
  4.23270335e-02  9.73575519e-01]
  HOMO = -0.583160580969284  LUMO = 0.988868564493817
  mo_energy =
[-1.18579014e+02 -1.23104802e+01 -9.56182611e+00 -9.56182611e+00
 -9.56182611e+00 -1.27033124e+00 -5.83160581e-01 -5.83160581e-01
 -5.83160581e-01  9.88868564e-01  1.01426632e+00  1.01426632e+00
  1.01426632e+00  7.28829305e+00  7.28829305e+00  7.28829305e+00
  1.28526603e+01  3.34375068e+01  3.34375068e+01  3.34375068e+01
  1.12426161e+02  1.29092463e+02  1.29092463e+02  1.29092463e+02
  4.83484137e+02  4.83484137e+02  4.83484137e+02  6.05293856e+02
  1.33517561e+03  1.33517561e+03  1.33517561e+03  2.67745588e+03
  3.02918890e+03  3.02918890e+03  3.02918890e+03  6.64946301e+03
  6.64946301e+03  6.64946301e+03  9.08197031e+03  2.54363714e+04
  7.61772618e+04]
E1 = -728.2908852469734  E_coul = 201.5506579035218
cycle= 6 E= -526.740227343452  delta_E= -5.88e-11  |g|= 1.74e-06  |ddm|= 1.87e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2908852469734  E_coul = 201.5506579035218
  HOMO = -0.583160597284285  LUMO = 0.988868904014788
  mo_energy =
[-1.18579014e+02 -1.23104801e+01 -9.56182602e+00 -9.56182602e+00
 -9.56182602e+00 -1.27033087e+00 -5.83160597e-01 -5.83160597e-01
 -5.83160597e-01  9.88868904e-01  1.01426636e+00  1.01426636e+00
  1.01426636e+00  7.28829311e+00  7.28829311e+00  7.28829311e+00
  1.28526606e+01  3.34375069e+01  3.34375069e+01  3.34375069e+01
  1.12426161e+02  1.29092463e+02  1.29092463e+02  1.29092463e+02
  4.83484137e+02  4.83484137e+02  4.83484137e+02  6.05293856e+02
  1.33517561e+03  1.33517561e+03  1.33517561e+03  2.67745588e+03
  3.02918890e+03  3.02918890e+03  3.02918890e+03  6.64946301e+03
  6.64946301e+03  6.64946301e+03  9.08197031e+03  2.54363714e+04
  7.61772618e+04]
E1 = -728.2908841462139  E_coul = 201.55065680276294
Extra cycle  E= -526.740227343451  delta_E= 6.82e-13  |g|= 3.59e-07  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61826616e+04 7.61750952e+03 3.61735683e+03 1.59756758e+03
 3.82783002e+02 1.12245113e+02 3.72247774e+01 8.29195683e+00
 3.25894276e+00 6.59927347e-01 2.42032167e-01 1.36278512e+03
 6.64726851e+02 3.00873198e+02 3.13965720e+02 6.16805047e+01
 7.33258113e+00 2.02591037e+01 7.76049341e-01 2.81578805e+00
 2.22636963e-01]
E = -526.7402273434509
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6615636        1
[INPUT] 0    0    [1    /1   ]  7617.50951839        1
[INPUT] 0    0    [1    /1   ]  3617.35683076        1
[INPUT] 0    0    [1    /1   ]  1597.56758382        1
[INPUT] 0    0    [1    /1   ]  382.78300239         1
[INPUT] 0    0    [1    /1   ]  112.24511344         1
[INPUT] 0    0    [1    /1   ]  37.2247773831        1
[INPUT] 0    0    [1    /1   ]  8.29195682864        1
[INPUT] 0    0    [1    /1   ]  3.2589427571         1
[INPUT] 0    0    [1    /1   ]  0.659927346684       1
[INPUT] 0    0    [1    /1   ]  0.242032166911       1
[INPUT] 1    0    [1    /1   ]  1362.78511631        1
[INPUT] 1    0    [1    /1   ]  664.726850731        1
[INPUT] 1    0    [1    /1   ]  300.873197599        1
[INPUT] 1    0    [1    /1   ]  313.965719718        1
[INPUT] 1    0    [1    /1   ]  61.6805047118        1
[INPUT] 1    0    [1    /1   ]  7.33258112696        1
[INPUT] 1    0    [1    /1   ]  20.2591037325        1
[INPUT] 1    0    [1    /1   ]  0.776049340529       1
[INPUT] 1    0    [1    /1   ]  2.81578804849        1
[INPUT] 1    0    [1    /1   ]  0.222636962554       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.66156364101, 1.0]], [0, [7617.509518391795, 1.0]], [0, [3617.3568307604255, 1.0]], [0, [1597.567583815712, 1.0]], [0, [382.7830023900088, 1.0]], [0, [112.24511343982859, 1.0]], [0, [37.22477738305122, 1.0]], [0, [8.291956828643382, 1.0]], [0, [3.2589427570987843, 1.0]], [0, [0.6599273466837118, 1.0]], [0, [0.24203216691087684, 1.0]], [1, [1362.7851163146984, 1.0]], [1, [664.7268507305755, 1.0]], [1, [300.8731975987089, 1.0]], [1, [313.9657197177292, 1.0]], [1, [61.68050471182808, 1.0]], [1, [7.332581126959302, 1.0]], [1, [20.25910373247283, 1.0]], [1, [0.7760493405289028, 1.0]], [1, [2.815788048493654, 1.0]], [1, [0.22263696255429363, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66156364]
bas 1, expnt(s) = [7617.50951839]
bas 2, expnt(s) = [3617.35683076]
bas 3, expnt(s) = [1597.56758382]
bas 4, expnt(s) = [382.78300239]
bas 5, expnt(s) = [112.24511344]
bas 6, expnt(s) = [37.22477738]
bas 7, expnt(s) = [8.29195683]
bas 8, expnt(s) = [3.25894276]
bas 9, expnt(s) = [0.65992735]
bas 10, expnt(s) = [0.24203217]
bas 11, expnt(s) = [1362.78511631]
bas 12, expnt(s) = [664.72685073]
bas 13, expnt(s) = [300.8731976]
bas 14, expnt(s) = [313.96571972]
bas 15, expnt(s) = [61.68050471]
bas 16, expnt(s) = [7.33258113]
bas 17, expnt(s) = [20.25910373]
bas 18, expnt(s) = [0.77604934]
bas 19, expnt(s) = [2.81578805]
bas 20, expnt(s) = [0.22263696]
CPU time:       338.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826616e+04 5.20026372e+03 7.61750952e+03 2.06003585e+03
 3.61735683e+03 1.17844288e+03 1.59756758e+03 6.38424366e+02
 3.82783002e+02 2.18639944e+02 1.12245113e+02 8.71245618e+01
 3.72247774e+01 3.80749293e+01 8.29195683e+00 1.23454748e+01
 3.25894276e+00 6.12805386e+00 6.59927347e-01 1.84985257e+00
 2.42032167e-01 8.71805975e-01 1.36278512e+03 2.41556440e+04
 6.64726851e+02 9.84664816e+03 3.00873198e+02 3.65564294e+03
 3.13965720e+02 3.85555749e+03 6.16805047e+01 5.04277152e+02
 7.33258113e+00 3.52010395e+01 2.02591037e+01 1.25389069e+02
 7.76049341e-01 2.12493701e+00 2.81578805e+00 1.06410466e+01
 2.22636963e-01 4.46150083e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993601241382994
cond(S) = 103657.35981591947
E1 = -729.5307891833843  E_coul = 203.17873857211745
init E= -526.352050611267
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555782895534165  LUMO = 1.01037448338225
  mo_energy =
[-1.18329020e+02 -1.22049220e+01 -9.44680264e+00 -9.44680264e+00
 -9.44680264e+00 -1.24003439e+00 -5.55782896e-01 -5.55782896e-01
 -5.55782896e-01  1.01037448e+00  1.03301889e+00  1.03301889e+00
  1.03301889e+00  7.35926521e+00  7.35926521e+00  7.35926521e+00
  1.29383765e+01  3.35578099e+01  3.35578099e+01  3.35578099e+01
  1.12601590e+02  1.29273306e+02  1.29273306e+02  1.29273306e+02
  4.83733504e+02  4.83733504e+02  4.83733504e+02  6.05579827e+02
  1.33547763e+03  1.33547763e+03  1.33547763e+03  2.67788848e+03
  3.02955463e+03  3.02955463e+03  3.02955463e+03  6.64994028e+03
  6.64994028e+03  6.64994028e+03  9.08252188e+03  2.54370166e+04
  7.61779969e+04]
E1 = -727.8444450608775  E_coul = 201.10499857378633
cycle= 1 E= -526.739446487091  delta_E= -0.387  |g|= 0.186  |ddm|= 0.316
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541983
diis-c [-0.29374569  1.        ]
  HOMO = -0.590792724467749  LUMO = 0.981928900681894
  mo_energy =
[-1.18636753e+02 -1.23427717e+01 -9.59540768e+00 -9.59540768e+00
 -9.59540768e+00 -1.27959507e+00 -5.90792724e-01 -5.90792724e-01
 -5.90792724e-01  9.81928901e-01  1.00860429e+00  1.00860429e+00
  1.00860429e+00  7.26828334e+00  7.26828334e+00  7.26828334e+00
  1.28267329e+01  3.34035704e+01  3.34035704e+01  3.34035704e+01
  1.12378216e+02  1.29044897e+02  1.29044897e+02  1.29044897e+02
  4.83427099e+02  4.83427099e+02  4.83427099e+02  6.05234756e+02
  1.33511513e+03  1.33511513e+03  1.33511513e+03  2.67739273e+03
  3.02912657e+03  3.02912657e+03  3.02912657e+03  6.64939935e+03
  6.64939935e+03  6.64939935e+03  9.08190605e+03  2.54363067e+04
  7.61771970e+04]
E1 = -728.4186224932675  E_coul = 201.67845603186692
cycle= 2 E= -526.740166461401  delta_E= -0.00072  |g|= 0.0376  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0751185
diis-c [-0.00331154  0.08222546  0.91777454]
  HOMO = -0.581667806726892  LUMO = 0.99008551919793
  mo_energy =
[-1.18569045e+02 -1.23047017e+01 -9.55568501e+00 -9.55568501e+00
 -9.55568501e+00 -1.26867034e+00 -5.81667807e-01 -5.81667807e-01
 -5.81667807e-01  9.90085519e-01  1.01534116e+00  1.01534116e+00
  1.01534116e+00  7.29205553e+00  7.29205553e+00  7.29205553e+00
  1.28573222e+01  3.34436674e+01  3.34436674e+01  3.34436674e+01
  1.12434504e+02  1.29100809e+02  1.29100809e+02  1.29100809e+02
  4.83493989e+02  4.83493989e+02  4.83493989e+02  6.05304082e+02
  1.33518606e+03  1.33518606e+03  1.33518606e+03  2.67746698e+03
  3.02919975e+03  3.02919975e+03  3.02919975e+03  6.64947427e+03
  6.64947427e+03  6.64947427e+03  9.08198179e+03  2.54363830e+04
  7.61772736e+04]
E1 = -728.2681741575733  E_coul = 201.52794874566237
cycle= 3 E= -526.740225411911  delta_E= -5.9e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131843
diis-c [-5.79296295e-07 -1.23945128e-03  1.44886223e-01  8.56353228e-01]
  HOMO = -0.58317095438814  LUMO = 0.988838847980189
  mo_energy =
[-1.18579022e+02 -1.23105209e+01 -9.56185121e+00 -9.56185121e+00
 -9.56185121e+00 -1.27036598e+00 -5.83170954e-01 -5.83170954e-01
 -5.83170954e-01  9.88838848e-01  1.01425579e+00  1.01425579e+00
  1.01425579e+00  7.28826906e+00  7.28826906e+00  7.28826906e+00
  1.28526202e+01  3.34374829e+01  3.34374829e+01  3.34374829e+01
  1.12426139e+02  1.29092445e+02  1.29092445e+02  1.29092445e+02
  4.83484129e+02  4.83484129e+02  4.83484129e+02  6.05293856e+02
  1.33517561e+03  1.33517561e+03  1.33517561e+03  2.67745590e+03
  3.02918892e+03  3.02918892e+03  3.02918892e+03  6.64946304e+03
  6.64946304e+03  6.64946304e+03  9.08197035e+03  2.54363714e+04
  7.61772619e+04]
E1 = -728.2910127908701  E_coul = 201.55078544920949
cycle= 4 E= -526.740227341661  delta_E= -1.93e-06  |g|= 9.87e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000114776
diis-c [-4.11057142e-09  7.33783151e-05 -1.04704021e-02 -6.78283028e-02
  1.07822533e+00]
  HOMO = -0.583153138829946  LUMO = 0.988872474787622
  mo_energy =
[-1.18578984e+02 -1.23104577e+01 -9.56180169e+00 -9.56180169e+00
 -9.56180169e+00 -1.27032534e+00 -5.83153139e-01 -5.83153139e-01
 -5.83153139e-01  9.88872475e-01  1.01427125e+00  1.01427125e+00
  1.01427125e+00  7.28830962e+00  7.28830962e+00  7.28830962e+00
  1.28526787e+01  3.34375305e+01  3.34375305e+01  3.34375305e+01
  1.12426189e+02  1.29092491e+02  1.29092491e+02  1.29092491e+02
  4.83484167e+02  4.83484167e+02  4.83484167e+02  6.05293887e+02
  1.33517564e+03  1.33517564e+03  1.33517564e+03  2.67745591e+03
  3.02918893e+03  3.02918893e+03  3.02918893e+03  6.64946305e+03
  6.64946305e+03  6.64946305e+03  9.08197034e+03  2.54363714e+04
  7.61772618e+04]
E1 = -728.2908041157157  E_coul = 201.55057677232287
cycle= 5 E= -526.740227343393  delta_E= -1.73e-09  |g|= 2.06e-05  |ddm|= 0.00016
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.88226e-05
diis-c [-7.48589124e-11  1.44983344e-05 -1.88277578e-03 -1.40342755e-02
  4.23270335e-02  9.73575519e-01]
  HOMO = -0.583160580969284  LUMO = 0.988868564493817
  mo_energy =
[-1.18579014e+02 -1.23104802e+01 -9.56182611e+00 -9.56182611e+00
 -9.56182611e+00 -1.27033124e+00 -5.83160581e-01 -5.83160581e-01
 -5.83160581e-01  9.88868564e-01  1.01426632e+00  1.01426632e+00
  1.01426632e+00  7.28829305e+00  7.28829305e+00  7.28829305e+00
  1.28526603e+01  3.34375068e+01  3.34375068e+01  3.34375068e+01
  1.12426161e+02  1.29092463e+02  1.29092463e+02  1.29092463e+02
  4.83484137e+02  4.83484137e+02  4.83484137e+02  6.05293856e+02
  1.33517561e+03  1.33517561e+03  1.33517561e+03  2.67745588e+03
  3.02918890e+03  3.02918890e+03  3.02918890e+03  6.64946301e+03
  6.64946301e+03  6.64946301e+03  9.08197031e+03  2.54363714e+04
  7.61772618e+04]
E1 = -728.2908852469734  E_coul = 201.5506579035218
cycle= 6 E= -526.740227343452  delta_E= -5.88e-11  |g|= 1.74e-06  |ddm|= 1.87e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2908852469734  E_coul = 201.5506579035218
  HOMO = -0.583160597284285  LUMO = 0.988868904014788
  mo_energy =
[-1.18579014e+02 -1.23104801e+01 -9.56182602e+00 -9.56182602e+00
 -9.56182602e+00 -1.27033087e+00 -5.83160597e-01 -5.83160597e-01
 -5.83160597e-01  9.88868904e-01  1.01426636e+00  1.01426636e+00
  1.01426636e+00  7.28829311e+00  7.28829311e+00  7.28829311e+00
  1.28526606e+01  3.34375069e+01  3.34375069e+01  3.34375069e+01
  1.12426161e+02  1.29092463e+02  1.29092463e+02  1.29092463e+02
  4.83484137e+02  4.83484137e+02  4.83484137e+02  6.05293856e+02
  1.33517561e+03  1.33517561e+03  1.33517561e+03  2.67745588e+03
  3.02918890e+03  3.02918890e+03  3.02918890e+03  6.64946301e+03
  6.64946301e+03  6.64946301e+03  9.08197031e+03  2.54363714e+04
  7.61772618e+04]
E1 = -728.2908841462139  E_coul = 201.55065680276294
Extra cycle  E= -526.740227343451  delta_E= 6.82e-13  |g|= 3.59e-07  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103657.35981591947
E1 = -728.2908841462139  E_coul = 201.55065680276294
init E= -526.740227343451
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583160630640393  LUMO = 0.988868948048573
  mo_energy =
[-1.18579014e+02 -1.23104801e+01 -9.56182612e+00 -9.56182612e+00
 -9.56182612e+00 -1.27033082e+00 -5.83160631e-01 -5.83160631e-01
 -5.83160631e-01  9.88868948e-01  1.01426635e+00  1.01426635e+00
  1.01426635e+00  7.28829305e+00  7.28829305e+00  7.28829305e+00
  1.28526605e+01  3.34375068e+01  3.34375068e+01  3.34375068e+01
  1.12426161e+02  1.29092463e+02  1.29092463e+02  1.29092463e+02
  4.83484137e+02  4.83484137e+02  4.83484137e+02  6.05293856e+02
  1.33517561e+03  1.33517561e+03  1.33517561e+03  2.67745588e+03
  3.02918890e+03  3.02918890e+03  3.02918890e+03  6.64946301e+03
  6.64946301e+03  6.64946301e+03  9.08197031e+03  2.54363714e+04
  7.61772618e+04]
E1 = -728.2908843380721  E_coul = 201.55065699462045
cycle= 1 E= -526.740227343452  delta_E= -7.96e-13  |g|= 7.58e-08  |ddm|= 5.97e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2908843380721  E_coul = 201.55065699462045
  HOMO = -0.5831606296225  LUMO = 0.988868963771846
  mo_energy =
[-1.18579014e+02 -1.23104801e+01 -9.56182611e+00 -9.56182611e+00
 -9.56182611e+00 -1.27033081e+00 -5.83160630e-01 -5.83160630e-01
 -5.83160630e-01  9.88868964e-01  1.01426635e+00  1.01426635e+00
  1.01426635e+00  7.28829306e+00  7.28829306e+00  7.28829306e+00
  1.28526605e+01  3.34375068e+01  3.34375068e+01  3.34375068e+01
  1.12426161e+02  1.29092463e+02  1.29092463e+02  1.29092463e+02
  4.83484137e+02  4.83484137e+02  4.83484137e+02  6.05293856e+02
  1.33517561e+03  1.33517561e+03  1.33517561e+03  2.67745588e+03
  3.02918890e+03  3.02918890e+03  3.02918890e+03  6.64946301e+03
  6.64946301e+03  6.64946301e+03  9.08197031e+03  2.54363714e+04
  7.61772618e+04]
E1 = -728.2908842597184  E_coul = 201.55065691626805
Extra cycle  E= -526.74022734345  delta_E= 1.36e-12  |g|= 1.54e-08  |ddm|= 1.27e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826616e+04 7.61750952e+03 3.61735683e+03 1.59756758e+03
 3.82783002e+02 1.12245113e+02 3.72247774e+01 8.29195683e+00
 3.25894276e+00 6.59927347e-01 2.42032167e-01 1.36278512e+03
 6.64726851e+02 3.00873198e+02 3.13965720e+02 6.16805047e+01
 7.33258113e+00 2.02591037e+01 7.76049341e-01 2.81578805e+00
 2.22636963e-01]
grad_E = [-1.54918464e-06  3.66642972e-06 -1.35511349e-06  8.25616510e-05
 -3.16694087e-04 -7.85032581e-05  2.96077320e-05  1.19962093e-04
 -2.01249932e-04  7.87447675e-05 -1.65423945e-03 -5.05919716e-07
  5.02824275e-06  2.37748346e-05  2.04904673e-05 -5.78453965e-05
 -1.16107272e-03  3.78734787e-04  1.49164888e-03  1.15999500e-03
 -4.10292998e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6621387        1
[INPUT] 0    0    [1    /1   ]  7617.50812616        1
[INPUT] 0    0    [1    /1   ]  3617.35730487        1
[INPUT] 0    0    [1    /1   ]  1597.5356589         1
[INPUT] 0    0    [1    /1   ]  382.933554147        1
[INPUT] 0    0    [1    /1   ]  112.164427767        1
[INPUT] 0    0    [1    /1   ]  37.1873768724        1
[INPUT] 0    0    [1    /1   ]  8.30325870811        1
[INPUT] 0    0    [1    /1   ]  3.25955026551        1
[INPUT] 0    0    [1    /1   ]  0.657425209658       1
[INPUT] 0    0    [1    /1   ]  0.240874395834       1
[INPUT] 1    0    [1    /1   ]  1362.7853048         1
[INPUT] 1    0    [1    /1   ]  664.725019809        1
[INPUT] 1    0    [1    /1   ]  300.864572219        1
[INPUT] 1    0    [1    /1   ]  313.958285683        1
[INPUT] 1    0    [1    /1   ]  61.6853806016        1
[INPUT] 1    0    [1    /1   ]  7.32544757108        1
[INPUT] 1    0    [1    /1   ]  20.2613105606        1
[INPUT] 1    0    [1    /1   ]  0.776037243771       1
[INPUT] 1    0    [1    /1   ]  2.81486641882        1
[INPUT] 1    0    [1    /1   ]  0.22254703137        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.662138709467, 1.0]], [0, [7617.508126162571, 1.0]], [0, [3617.357304874497, 1.0]], [0, [1597.5356589003698, 1.0]], [0, [382.9335541465902, 1.0]], [0, [112.1644277667976, 1.0]], [0, [37.18737687240063, 1.0]], [0, [8.303258708107357, 1.0]], [0, [3.259550265508881, 1.0]], [0, [0.6574252096579842, 1.0]], [0, [0.240874395833568, 1.0]], [1, [1362.7853048025443, 1.0]], [1, [664.725019809181, 1.0]], [1, [300.8645722194205, 1.0]], [1, [313.9582856830205, 1.0]], [1, [61.6853806016233, 1.0]], [1, [7.325447571079451, 1.0]], [1, [20.261310560594353, 1.0]], [1, [0.7760372437706518, 1.0]], [1, [2.814866418819253, 1.0]], [1, [0.22254703137014845, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66213871]
bas 1, expnt(s) = [7617.50812616]
bas 2, expnt(s) = [3617.35730487]
bas 3, expnt(s) = [1597.5356589]
bas 4, expnt(s) = [382.93355415]
bas 5, expnt(s) = [112.16442777]
bas 6, expnt(s) = [37.18737687]
bas 7, expnt(s) = [8.30325871]
bas 8, expnt(s) = [3.25955027]
bas 9, expnt(s) = [0.65742521]
bas 10, expnt(s) = [0.2408744]
bas 11, expnt(s) = [1362.7853048]
bas 12, expnt(s) = [664.72501981]
bas 13, expnt(s) = [300.86457222]
bas 14, expnt(s) = [313.95828568]
bas 15, expnt(s) = [61.6853806]
bas 16, expnt(s) = [7.32544757]
bas 17, expnt(s) = [20.26131056]
bas 18, expnt(s) = [0.77603724]
bas 19, expnt(s) = [2.81486642]
bas 20, expnt(s) = [0.22254703]
CPU time:       344.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826621e+04 5.20026380e+03 7.61750813e+03 2.06003557e+03
 3.61735730e+03 1.17844300e+03 1.59753566e+03 6.38414798e+02
 3.82933554e+02 2.18704436e+02 1.12164428e+02 8.70775864e+01
 3.71873769e+01 3.80462347e+01 8.30325871e+00 1.23580928e+01
 3.25955027e+00 6.12891060e+00 6.57425210e-01 1.84458974e+00
 2.40874396e-01 8.68676360e-01 1.36278530e+03 2.41556481e+04
 6.64725020e+02 9.84661425e+03 3.00864572e+02 3.65551194e+03
 3.13958286e+02 3.85544337e+03 6.16853806e+01 5.04326981e+02
 7.32544757e+00 3.51582377e+01 2.02613106e+01 1.25406143e+02
 7.76037244e-01 2.12489560e+00 2.81486642e+00 1.06366931e+01
 2.22547031e-01 4.45924824e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993616184054748
cond(S) = 103620.88619218096
E1 = -729.5309630490228  E_coul = 203.17888665476323
init E= -526.35207639426
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555791177692214  LUMO = 1.00320025029421
  mo_energy =
[-1.18329021e+02 -1.22048953e+01 -9.44678045e+00 -9.44678045e+00
 -9.44678045e+00 -1.24004254e+00 -5.55791178e-01 -5.55791178e-01
 -5.55791178e-01  1.00320025e+00  1.03266529e+00  1.03266529e+00
  1.03266529e+00  7.35520118e+00  7.35520118e+00  7.35520118e+00
  1.29328413e+01  3.35387912e+01  3.35387912e+01  3.35387912e+01
  1.12528431e+02  1.29255672e+02  1.29255672e+02  1.29255672e+02
  4.83724456e+02  4.83724456e+02  4.83724456e+02  6.05378992e+02
  1.33545643e+03  1.33545643e+03  1.33545643e+03  2.67787284e+03
  3.02951210e+03  3.02951210e+03  3.02951210e+03  6.64988309e+03
  6.64988309e+03  6.64988309e+03  9.08259147e+03  2.54370838e+04
  7.61780535e+04]
E1 = -727.8420993218541  E_coul = 201.10262674898868
cycle= 1 E= -526.739472572865  delta_E= -0.387  |g|= 0.186  |ddm|= 0.318
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542011
diis-c [-0.29377592  1.        ]
  HOMO = -0.590895551083167  LUMO = 0.974832707053764
  mo_energy =
[-1.18636949e+02 -1.23429119e+01 -9.59555981e+00 -9.59555981e+00
 -9.59555981e+00 -1.27969403e+00 -5.90895551e-01 -5.90895551e-01
 -5.90895551e-01  9.74832707e-01  1.00818641e+00  1.00818641e+00
  1.00818641e+00  7.26411040e+00  7.26411040e+00  7.26411040e+00
  1.28210226e+01  3.33843983e+01  3.33843983e+01  3.33843983e+01
  1.12304911e+02  1.29027067e+02  1.29027067e+02  1.29027067e+02
  4.83417849e+02  4.83417849e+02  4.83417849e+02  6.05033723e+02
  1.33509373e+03  1.33509373e+03  1.33509373e+03  2.67737685e+03
  3.02908382e+03  3.02908382e+03  3.02908382e+03  6.64934193e+03
  6.64934193e+03  6.64934193e+03  9.08197541e+03  2.54363737e+04
  7.61772533e+04]
E1 = -728.4169454003885  E_coul = 201.6767513006157
cycle= 2 E= -526.740194099773  delta_E= -0.000722  |g|= 0.0376  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0751812
diis-c [-0.00331492  0.08231974  0.91768026]
  HOMO = -0.581758726659587  LUMO = 0.982961146211482
  mo_energy =
[-1.18569182e+02 -1.23047998e+01 -9.55579497e+00 -9.55579497e+00
 -9.55579497e+00 -1.26875374e+00 -5.81758727e-01 -5.81758727e-01
 -5.81758727e-01  9.82961146e-01  1.01493122e+00  1.01493122e+00
  1.01493122e+00  7.28790182e+00  7.28790182e+00  7.28790182e+00
  1.28516594e+01  3.34245330e+01  3.34245330e+01  3.34245330e+01
  1.12361242e+02  1.29083033e+02  1.29083033e+02  1.29083033e+02
  4.83484798e+02  4.83484798e+02  4.83484798e+02  6.05103108e+02
  1.33516472e+03  1.33516472e+03  1.33516472e+03  2.67745116e+03
  3.02915706e+03  3.02915706e+03  3.02915706e+03  6.64941691e+03
  6.64941691e+03  6.64941691e+03  9.08205120e+03  2.54364501e+04
  7.61773300e+04]
E1 = -728.2663036815937  E_coul = 201.52605048435532
cycle= 3 E= -526.740253197238  delta_E= -5.91e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131919
diis-c [-5.83765417e-07 -1.24075599e-03  1.44848816e-01  8.56391940e-01]
  HOMO = -0.583263909003484  LUMO = 0.981719522523518
  mo_energy =
[-1.18579164e+02 -1.23106231e+01 -9.56196561e+00 -9.56196561e+00
 -9.56196561e+00 -1.27045094e+00 -5.83263909e-01 -5.83263909e-01
 -5.83263909e-01  9.81719523e-01  1.01384463e+00  1.01384463e+00
  1.01384463e+00  7.28411317e+00  7.28411317e+00  7.28411317e+00
  1.28469523e+01  3.34183448e+01  3.34183448e+01  3.34183448e+01
  1.12352873e+02  1.29074663e+02  1.29074663e+02  1.29074663e+02
  4.83474933e+02  4.83474933e+02  4.83474933e+02  6.05092876e+02
  1.33515426e+03  1.33515426e+03  1.33515426e+03  2.67744007e+03
  3.02914621e+03  3.02914621e+03  3.02914621e+03  6.64940568e+03
  6.64940568e+03  6.64940568e+03  9.08203976e+03  2.54364385e+04
  7.61773182e+04]
E1 = -728.2891611999819  E_coul = 201.5489060695802
cycle= 4 E= -526.740255130402  delta_E= -1.93e-06  |g|= 9.95e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000115767
diis-c [-4.14831368e-09  7.40999985e-05 -1.05541519e-02 -6.84024275e-02
  1.07888248e+00]
  HOMO = -0.583246221679195  LUMO = 0.981753106727079
  mo_energy =
[-1.18579126e+02 -1.23105601e+01 -9.56191634e+00 -9.56191634e+00
 -9.56191634e+00 -1.27041021e+00 -5.83246222e-01 -5.83246222e-01
 -5.83246222e-01  9.81753107e-01  1.01386003e+00  1.01386003e+00
  1.01386003e+00  7.28415355e+00  7.28415355e+00  7.28415355e+00
  1.28470107e+01  3.34183921e+01  3.34183921e+01  3.34183921e+01
  1.12352923e+02  1.29074709e+02  1.29074709e+02  1.29074709e+02
  4.83474971e+02  4.83474971e+02  4.83474971e+02  6.05092907e+02
  1.33515429e+03  1.33515429e+03  1.33515429e+03  2.67744008e+03
  3.02914623e+03  3.02914623e+03  3.02914623e+03  6.64940568e+03
  6.64940568e+03  6.64940568e+03  9.08203975e+03  2.54364385e+04
  7.61773182e+04]
E1 = -728.2889525318645  E_coul = 201.54869739969354
cycle= 5 E= -526.740255132171  delta_E= -1.77e-09  |g|= 2.07e-05  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.89482e-05
diis-c [-7.60044567e-11  1.45542591e-05 -1.88725309e-03 -1.40708684e-02
  4.18764185e-02  9.74067149e-01]
  HOMO = -0.583253707723486  LUMO = 0.981749204714504
  mo_energy =
[-1.18579157e+02 -1.23105827e+01 -9.56194087e+00 -9.56194087e+00
 -9.56194087e+00 -1.27041613e+00 -5.83253708e-01 -5.83253708e-01
 -5.83253708e-01  9.81749205e-01  1.01385506e+00  1.01385506e+00
  1.01385506e+00  7.28413690e+00  7.28413690e+00  7.28413690e+00
  1.28469923e+01  3.34183683e+01  3.34183683e+01  3.34183683e+01
  1.12352895e+02  1.29074681e+02  1.29074681e+02  1.29074681e+02
  4.83474940e+02  4.83474940e+02  4.83474940e+02  6.05092876e+02
  1.33515426e+03  1.33515426e+03  1.33515426e+03  2.67744005e+03
  3.02914620e+03  3.02914620e+03  3.02914620e+03  6.64940565e+03
  6.64940565e+03  6.64940565e+03  9.08203972e+03  2.54364384e+04
  7.61773182e+04]
E1 = -728.2890339701006  E_coul = 201.5487788378686
cycle= 6 E= -526.740255132232  delta_E= -6.1e-11  |g|= 1.75e-06  |ddm|= 1.89e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2890339701006  E_coul = 201.5487788378686
  HOMO = -0.583253719668509  LUMO = 0.981749548208859
  mo_energy =
[-1.18579156e+02 -1.23105825e+01 -9.56194077e+00 -9.56194077e+00
 -9.56194077e+00 -1.27041575e+00 -5.83253720e-01 -5.83253720e-01
 -5.83253720e-01  9.81749548e-01  1.01385511e+00  1.01385511e+00
  1.01385511e+00  7.28413698e+00  7.28413698e+00  7.28413698e+00
  1.28469925e+01  3.34183684e+01  3.34183684e+01  3.34183684e+01
  1.12352895e+02  1.29074681e+02  1.29074681e+02  1.29074681e+02
  4.83474941e+02  4.83474941e+02  4.83474941e+02  6.05092876e+02
  1.33515426e+03  1.33515426e+03  1.33515426e+03  2.67744005e+03
  3.02914620e+03  3.02914620e+03  3.02914620e+03  6.64940565e+03
  6.64940565e+03  6.64940565e+03  9.08203972e+03  2.54364384e+04
  7.61773182e+04]
E1 = -728.2890327897034  E_coul = 201.54877765747239
Extra cycle  E= -526.740255132231  delta_E= 1.14e-12  |g|= 3.61e-07  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61826621e+04 7.61750813e+03 3.61735730e+03 1.59753566e+03
 3.82933554e+02 1.12164428e+02 3.71873769e+01 8.30325871e+00
 3.25955027e+00 6.57425210e-01 2.40874396e-01 1.36278530e+03
 6.64725020e+02 3.00864572e+02 3.13958286e+02 6.16853806e+01
 7.32544757e+00 2.02613106e+01 7.76037244e-01 2.81486642e+00
 2.22547031e-01]
E = -526.7402551322309
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6621387        1
[INPUT] 0    0    [1    /1   ]  7617.50812616        1
[INPUT] 0    0    [1    /1   ]  3617.35730487        1
[INPUT] 0    0    [1    /1   ]  1597.5356589         1
[INPUT] 0    0    [1    /1   ]  382.933554147        1
[INPUT] 0    0    [1    /1   ]  112.164427767        1
[INPUT] 0    0    [1    /1   ]  37.1873768724        1
[INPUT] 0    0    [1    /1   ]  8.30325870811        1
[INPUT] 0    0    [1    /1   ]  3.25955026551        1
[INPUT] 0    0    [1    /1   ]  0.657425209658       1
[INPUT] 0    0    [1    /1   ]  0.240874395834       1
[INPUT] 1    0    [1    /1   ]  1362.7853048         1
[INPUT] 1    0    [1    /1   ]  664.725019809        1
[INPUT] 1    0    [1    /1   ]  300.864572219        1
[INPUT] 1    0    [1    /1   ]  313.958285683        1
[INPUT] 1    0    [1    /1   ]  61.6853806016        1
[INPUT] 1    0    [1    /1   ]  7.32544757108        1
[INPUT] 1    0    [1    /1   ]  20.2613105606        1
[INPUT] 1    0    [1    /1   ]  0.776037243771       1
[INPUT] 1    0    [1    /1   ]  2.81486641882        1
[INPUT] 1    0    [1    /1   ]  0.22254703137        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.662138709467, 1.0]], [0, [7617.508126162571, 1.0]], [0, [3617.357304874497, 1.0]], [0, [1597.5356589003698, 1.0]], [0, [382.9335541465902, 1.0]], [0, [112.1644277667976, 1.0]], [0, [37.18737687240063, 1.0]], [0, [8.303258708107357, 1.0]], [0, [3.259550265508881, 1.0]], [0, [0.6574252096579842, 1.0]], [0, [0.240874395833568, 1.0]], [1, [1362.7853048025443, 1.0]], [1, [664.725019809181, 1.0]], [1, [300.8645722194205, 1.0]], [1, [313.9582856830205, 1.0]], [1, [61.6853806016233, 1.0]], [1, [7.325447571079451, 1.0]], [1, [20.261310560594353, 1.0]], [1, [0.7760372437706518, 1.0]], [1, [2.814866418819253, 1.0]], [1, [0.22254703137014845, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66213871]
bas 1, expnt(s) = [7617.50812616]
bas 2, expnt(s) = [3617.35730487]
bas 3, expnt(s) = [1597.5356589]
bas 4, expnt(s) = [382.93355415]
bas 5, expnt(s) = [112.16442777]
bas 6, expnt(s) = [37.18737687]
bas 7, expnt(s) = [8.30325871]
bas 8, expnt(s) = [3.25955027]
bas 9, expnt(s) = [0.65742521]
bas 10, expnt(s) = [0.2408744]
bas 11, expnt(s) = [1362.7853048]
bas 12, expnt(s) = [664.72501981]
bas 13, expnt(s) = [300.86457222]
bas 14, expnt(s) = [313.95828568]
bas 15, expnt(s) = [61.6853806]
bas 16, expnt(s) = [7.32544757]
bas 17, expnt(s) = [20.26131056]
bas 18, expnt(s) = [0.77603724]
bas 19, expnt(s) = [2.81486642]
bas 20, expnt(s) = [0.22254703]
CPU time:       344.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826621e+04 5.20026380e+03 7.61750813e+03 2.06003557e+03
 3.61735730e+03 1.17844300e+03 1.59753566e+03 6.38414798e+02
 3.82933554e+02 2.18704436e+02 1.12164428e+02 8.70775864e+01
 3.71873769e+01 3.80462347e+01 8.30325871e+00 1.23580928e+01
 3.25955027e+00 6.12891060e+00 6.57425210e-01 1.84458974e+00
 2.40874396e-01 8.68676360e-01 1.36278530e+03 2.41556481e+04
 6.64725020e+02 9.84661425e+03 3.00864572e+02 3.65551194e+03
 3.13958286e+02 3.85544337e+03 6.16853806e+01 5.04326981e+02
 7.32544757e+00 3.51582377e+01 2.02613106e+01 1.25406143e+02
 7.76037244e-01 2.12489560e+00 2.81486642e+00 1.06366931e+01
 2.22547031e-01 4.45924824e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993616184054748
cond(S) = 103620.88619218096
E1 = -729.5309630490228  E_coul = 203.17888665476323
init E= -526.35207639426
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555791177692214  LUMO = 1.00320025029421
  mo_energy =
[-1.18329021e+02 -1.22048953e+01 -9.44678045e+00 -9.44678045e+00
 -9.44678045e+00 -1.24004254e+00 -5.55791178e-01 -5.55791178e-01
 -5.55791178e-01  1.00320025e+00  1.03266529e+00  1.03266529e+00
  1.03266529e+00  7.35520118e+00  7.35520118e+00  7.35520118e+00
  1.29328413e+01  3.35387912e+01  3.35387912e+01  3.35387912e+01
  1.12528431e+02  1.29255672e+02  1.29255672e+02  1.29255672e+02
  4.83724456e+02  4.83724456e+02  4.83724456e+02  6.05378992e+02
  1.33545643e+03  1.33545643e+03  1.33545643e+03  2.67787284e+03
  3.02951210e+03  3.02951210e+03  3.02951210e+03  6.64988309e+03
  6.64988309e+03  6.64988309e+03  9.08259147e+03  2.54370838e+04
  7.61780535e+04]
E1 = -727.8420993218541  E_coul = 201.10262674898868
cycle= 1 E= -526.739472572865  delta_E= -0.387  |g|= 0.186  |ddm|= 0.318
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.542011
diis-c [-0.29377592  1.        ]
  HOMO = -0.590895551083167  LUMO = 0.974832707053764
  mo_energy =
[-1.18636949e+02 -1.23429119e+01 -9.59555981e+00 -9.59555981e+00
 -9.59555981e+00 -1.27969403e+00 -5.90895551e-01 -5.90895551e-01
 -5.90895551e-01  9.74832707e-01  1.00818641e+00  1.00818641e+00
  1.00818641e+00  7.26411040e+00  7.26411040e+00  7.26411040e+00
  1.28210226e+01  3.33843983e+01  3.33843983e+01  3.33843983e+01
  1.12304911e+02  1.29027067e+02  1.29027067e+02  1.29027067e+02
  4.83417849e+02  4.83417849e+02  4.83417849e+02  6.05033723e+02
  1.33509373e+03  1.33509373e+03  1.33509373e+03  2.67737685e+03
  3.02908382e+03  3.02908382e+03  3.02908382e+03  6.64934193e+03
  6.64934193e+03  6.64934193e+03  9.08197541e+03  2.54363737e+04
  7.61772533e+04]
E1 = -728.4169454003885  E_coul = 201.6767513006157
cycle= 2 E= -526.740194099773  delta_E= -0.000722  |g|= 0.0376  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0751812
diis-c [-0.00331492  0.08231974  0.91768026]
  HOMO = -0.581758726659587  LUMO = 0.982961146211482
  mo_energy =
[-1.18569182e+02 -1.23047998e+01 -9.55579497e+00 -9.55579497e+00
 -9.55579497e+00 -1.26875374e+00 -5.81758727e-01 -5.81758727e-01
 -5.81758727e-01  9.82961146e-01  1.01493122e+00  1.01493122e+00
  1.01493122e+00  7.28790182e+00  7.28790182e+00  7.28790182e+00
  1.28516594e+01  3.34245330e+01  3.34245330e+01  3.34245330e+01
  1.12361242e+02  1.29083033e+02  1.29083033e+02  1.29083033e+02
  4.83484798e+02  4.83484798e+02  4.83484798e+02  6.05103108e+02
  1.33516472e+03  1.33516472e+03  1.33516472e+03  2.67745116e+03
  3.02915706e+03  3.02915706e+03  3.02915706e+03  6.64941691e+03
  6.64941691e+03  6.64941691e+03  9.08205120e+03  2.54364501e+04
  7.61773300e+04]
E1 = -728.2663036815937  E_coul = 201.52605048435532
cycle= 3 E= -526.740253197238  delta_E= -5.91e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131919
diis-c [-5.83765417e-07 -1.24075599e-03  1.44848816e-01  8.56391940e-01]
  HOMO = -0.583263909003484  LUMO = 0.981719522523518
  mo_energy =
[-1.18579164e+02 -1.23106231e+01 -9.56196561e+00 -9.56196561e+00
 -9.56196561e+00 -1.27045094e+00 -5.83263909e-01 -5.83263909e-01
 -5.83263909e-01  9.81719523e-01  1.01384463e+00  1.01384463e+00
  1.01384463e+00  7.28411317e+00  7.28411317e+00  7.28411317e+00
  1.28469523e+01  3.34183448e+01  3.34183448e+01  3.34183448e+01
  1.12352873e+02  1.29074663e+02  1.29074663e+02  1.29074663e+02
  4.83474933e+02  4.83474933e+02  4.83474933e+02  6.05092876e+02
  1.33515426e+03  1.33515426e+03  1.33515426e+03  2.67744007e+03
  3.02914621e+03  3.02914621e+03  3.02914621e+03  6.64940568e+03
  6.64940568e+03  6.64940568e+03  9.08203976e+03  2.54364385e+04
  7.61773182e+04]
E1 = -728.2891611999819  E_coul = 201.5489060695802
cycle= 4 E= -526.740255130402  delta_E= -1.93e-06  |g|= 9.95e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000115767
diis-c [-4.14831368e-09  7.40999985e-05 -1.05541519e-02 -6.84024275e-02
  1.07888248e+00]
  HOMO = -0.583246221679195  LUMO = 0.981753106727079
  mo_energy =
[-1.18579126e+02 -1.23105601e+01 -9.56191634e+00 -9.56191634e+00
 -9.56191634e+00 -1.27041021e+00 -5.83246222e-01 -5.83246222e-01
 -5.83246222e-01  9.81753107e-01  1.01386003e+00  1.01386003e+00
  1.01386003e+00  7.28415355e+00  7.28415355e+00  7.28415355e+00
  1.28470107e+01  3.34183921e+01  3.34183921e+01  3.34183921e+01
  1.12352923e+02  1.29074709e+02  1.29074709e+02  1.29074709e+02
  4.83474971e+02  4.83474971e+02  4.83474971e+02  6.05092907e+02
  1.33515429e+03  1.33515429e+03  1.33515429e+03  2.67744008e+03
  3.02914623e+03  3.02914623e+03  3.02914623e+03  6.64940568e+03
  6.64940568e+03  6.64940568e+03  9.08203975e+03  2.54364385e+04
  7.61773182e+04]
E1 = -728.2889525318645  E_coul = 201.54869739969354
cycle= 5 E= -526.740255132171  delta_E= -1.77e-09  |g|= 2.07e-05  |ddm|= 0.000162
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.89482e-05
diis-c [-7.60044567e-11  1.45542591e-05 -1.88725309e-03 -1.40708684e-02
  4.18764185e-02  9.74067149e-01]
  HOMO = -0.583253707723486  LUMO = 0.981749204714504
  mo_energy =
[-1.18579157e+02 -1.23105827e+01 -9.56194087e+00 -9.56194087e+00
 -9.56194087e+00 -1.27041613e+00 -5.83253708e-01 -5.83253708e-01
 -5.83253708e-01  9.81749205e-01  1.01385506e+00  1.01385506e+00
  1.01385506e+00  7.28413690e+00  7.28413690e+00  7.28413690e+00
  1.28469923e+01  3.34183683e+01  3.34183683e+01  3.34183683e+01
  1.12352895e+02  1.29074681e+02  1.29074681e+02  1.29074681e+02
  4.83474940e+02  4.83474940e+02  4.83474940e+02  6.05092876e+02
  1.33515426e+03  1.33515426e+03  1.33515426e+03  2.67744005e+03
  3.02914620e+03  3.02914620e+03  3.02914620e+03  6.64940565e+03
  6.64940565e+03  6.64940565e+03  9.08203972e+03  2.54364384e+04
  7.61773182e+04]
E1 = -728.2890339701006  E_coul = 201.5487788378686
cycle= 6 E= -526.740255132232  delta_E= -6.1e-11  |g|= 1.75e-06  |ddm|= 1.89e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2890339701006  E_coul = 201.5487788378686
  HOMO = -0.583253719668509  LUMO = 0.981749548208859
  mo_energy =
[-1.18579156e+02 -1.23105825e+01 -9.56194077e+00 -9.56194077e+00
 -9.56194077e+00 -1.27041575e+00 -5.83253720e-01 -5.83253720e-01
 -5.83253720e-01  9.81749548e-01  1.01385511e+00  1.01385511e+00
  1.01385511e+00  7.28413698e+00  7.28413698e+00  7.28413698e+00
  1.28469925e+01  3.34183684e+01  3.34183684e+01  3.34183684e+01
  1.12352895e+02  1.29074681e+02  1.29074681e+02  1.29074681e+02
  4.83474941e+02  4.83474941e+02  4.83474941e+02  6.05092876e+02
  1.33515426e+03  1.33515426e+03  1.33515426e+03  2.67744005e+03
  3.02914620e+03  3.02914620e+03  3.02914620e+03  6.64940565e+03
  6.64940565e+03  6.64940565e+03  9.08203972e+03  2.54364384e+04
  7.61773182e+04]
E1 = -728.2890327897034  E_coul = 201.54877765747239
Extra cycle  E= -526.740255132231  delta_E= 1.14e-12  |g|= 3.61e-07  |ddm|= 3.07e-06
    CPU time for scf_cycle      0.31 sec, wall time      0.26 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103620.88619218096
E1 = -728.2890327897034  E_coul = 201.54877765747239
init E= -526.740255132231
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583253754780924  LUMO = 0.981749590971658
  mo_energy =
[-1.18579157e+02 -1.23105826e+01 -9.56194087e+00 -9.56194087e+00
 -9.56194087e+00 -1.27041571e+00 -5.83253755e-01 -5.83253755e-01
 -5.83253755e-01  9.81749591e-01  1.01385510e+00  1.01385510e+00
  1.01385510e+00  7.28413691e+00  7.28413691e+00  7.28413691e+00
  1.28469924e+01  3.34183683e+01  3.34183683e+01  3.34183683e+01
  1.12352895e+02  1.29074681e+02  1.29074681e+02  1.29074681e+02
  4.83474940e+02  4.83474940e+02  4.83474940e+02  6.05092876e+02
  1.33515426e+03  1.33515426e+03  1.33515426e+03  2.67744005e+03
  3.02914620e+03  3.02914620e+03  3.02914620e+03  6.64940565e+03
  6.64940565e+03  6.64940565e+03  9.08203972e+03  2.54364384e+04
  7.61773182e+04]
E1 = -728.289033001364  E_coul = 201.548777869132
cycle= 1 E= -526.740255132232  delta_E= -1.14e-12  |g|= 7.64e-08  |ddm|= 5.99e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.289033001364  E_coul = 201.548777869132
  HOMO = -0.583253753437419  LUMO = 0.981749607007103
  mo_energy =
[-1.18579157e+02 -1.23105826e+01 -9.56194086e+00 -9.56194086e+00
 -9.56194086e+00 -1.27041569e+00 -5.83253753e-01 -5.83253753e-01
 -5.83253753e-01  9.81749607e-01  1.01385510e+00  1.01385510e+00
  1.01385510e+00  7.28413692e+00  7.28413692e+00  7.28413692e+00
  1.28469925e+01  3.34183683e+01  3.34183683e+01  3.34183683e+01
  1.12352895e+02  1.29074681e+02  1.29074681e+02  1.29074681e+02
  4.83474941e+02  4.83474941e+02  4.83474941e+02  6.05092876e+02
  1.33515426e+03  1.33515426e+03  1.33515426e+03  2.67744005e+03
  3.02914620e+03  3.02914620e+03  3.02914620e+03  6.64940565e+03
  6.64940565e+03  6.64940565e+03  9.08203972e+03  2.54364384e+04
  7.61773182e+04]
E1 = -728.2890329168465  E_coul = 201.54877778461503
Extra cycle  E= -526.740255132231  delta_E= 5.68e-13  |g|= 1.55e-08  |ddm|= 1.28e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826621e+04 7.61750813e+03 3.61735730e+03 1.59753566e+03
 3.82933554e+02 1.12164428e+02 3.71873769e+01 8.30325871e+00
 3.25955027e+00 6.57425210e-01 2.40874396e-01 1.36278530e+03
 6.64725020e+02 3.00864572e+02 3.13958286e+02 6.16853806e+01
 7.32544757e+00 2.02613106e+01 7.76037244e-01 2.81486642e+00
 2.22547031e-01]
grad_E = [-1.54728406e-06  3.64388628e-06 -1.37312066e-06  8.17711197e-05
 -3.02275583e-04 -1.23144172e-04  3.92836219e-05  2.15510713e-04
 -3.52973249e-04  1.26539720e-04 -2.74434054e-03 -5.03536701e-07
  5.06194682e-06  2.39833365e-05  2.06686093e-05 -8.54433593e-05
 -1.96125527e-03  6.33072817e-04  2.52147040e-03  1.94908321e-03
 -6.94640358e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6638128        1
[INPUT] 0    0    [1    /1   ]  7617.50411584        1
[INPUT] 0    0    [1    /1   ]  3617.35872279        1
[INPUT] 0    0    [1    /1   ]  1597.44448452        1
[INPUT] 0    0    [1    /1   ]  383.324743046        1
[INPUT] 0    0    [1    /1   ]  112.083960668        1
[INPUT] 0    0    [1    /1   ]  37.1389641599        1
[INPUT] 0    0    [1    /1   ]  8.32261469357        1
[INPUT] 0    0    [1    /1   ]  3.26109041159        1
[INPUT] 0    0    [1    /1   ]  0.653537483551       1
[INPUT] 0    0    [1    /1   ]  0.239058864978       1
[INPUT] 1    0    [1    /1   ]  1362.78585463        1
[INPUT] 1    0    [1    /1   ]  664.719669471        1
[INPUT] 1    0    [1    /1   ]  300.839363517        1
[INPUT] 1    0    [1    /1   ]  313.936558111        1
[INPUT] 1    0    [1    /1   ]  61.7003543659        1
[INPUT] 1    0    [1    /1   ]  7.31341159326        1
[INPUT] 1    0    [1    /1   ]  20.2640319255        1
[INPUT] 1    0    [1    /1   ]  0.775991980695       1
[INPUT] 1    0    [1    /1   ]  2.81316698937        1
[INPUT] 1    0    [1    /1   ]  0.222399608121       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.663812806255, 1.0]], [0, [7617.504115840895, 1.0]], [0, [3617.3587227885887, 1.0]], [0, [1597.444484515151, 1.0]], [0, [383.32474304588357, 1.0]], [0, [112.08396066790893, 1.0]], [0, [37.13896415987959, 1.0]], [0, [8.322614693566866, 1.0]], [0, [3.261090411586828, 1.0]], [0, [0.6535374835508937, 1.0]], [0, [0.23905886497823442, 1.0]], [1, [1362.7858546306575, 1.0]], [1, [664.719669470728, 1.0]], [1, [300.83936351722804, 1.0]], [1, [313.9365581112901, 1.0]], [1, [61.70035436591088, 1.0]], [1, [7.313411593257091, 1.0]], [1, [20.264031925512096, 1.0]], [1, [0.7759919806948843, 1.0]], [1, [2.813166989369858, 1.0]], [1, [0.2223996081212262, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66381281]
bas 1, expnt(s) = [7617.50411584]
bas 2, expnt(s) = [3617.35872279]
bas 3, expnt(s) = [1597.44448452]
bas 4, expnt(s) = [383.32474305]
bas 5, expnt(s) = [112.08396067]
bas 6, expnt(s) = [37.13896416]
bas 7, expnt(s) = [8.32261469]
bas 8, expnt(s) = [3.26109041]
bas 9, expnt(s) = [0.65353748]
bas 10, expnt(s) = [0.23905886]
bas 11, expnt(s) = [1362.78585463]
bas 12, expnt(s) = [664.71966947]
bas 13, expnt(s) = [300.83936352]
bas 14, expnt(s) = [313.93655811]
bas 15, expnt(s) = [61.70035437]
bas 16, expnt(s) = [7.31341159]
bas 17, expnt(s) = [20.26403193]
bas 18, expnt(s) = [0.77599198]
bas 19, expnt(s) = [2.81316699]
bas 20, expnt(s) = [0.22239961]
CPU time:       350.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826638e+04 5.20026405e+03 7.61750412e+03 2.06003475e+03
 3.61735872e+03 1.17844335e+03 1.59744448e+03 6.38387471e+02
 3.83324743e+02 2.18871979e+02 1.12083961e+02 8.70307299e+01
 3.71389642e+01 3.80090806e+01 8.32261469e+00 1.23796927e+01
 3.26109041e+00 6.13108241e+00 6.53537484e-01 1.83640261e+00
 2.39058865e-01 8.63761145e-01 1.36278585e+03 2.41556603e+04
 6.64719669e+02 9.84651519e+03 3.00839364e+02 3.65512908e+03
 3.13936558e+02 3.85510985e+03 6.17003544e+01 5.04480014e+02
 7.31341159e+00 3.50860447e+01 2.02640319e+01 1.25427198e+02
 7.75991981e-01 2.12474069e+00 2.81316699e+00 1.06286666e+01
 2.22399608e-01 4.45555608e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9936388440195
cond(S) = 103534.44681726127
E1 = -729.5312161082054  E_coul = 203.17911987899734
init E= -526.352096229208
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555804347380247  LUMO = 0.992048169668453
  mo_energy =
[-1.18329045e+02 -1.22048527e+01 -9.44674358e+00 -9.44674358e+00
 -9.44674358e+00 -1.24005409e+00 -5.55804347e-01 -5.55804347e-01
 -5.55804347e-01  9.92048170e-01  1.03206274e+00  1.03206274e+00
  1.03206274e+00  7.34805572e+00  7.34805572e+00  7.34805572e+00
  1.29280711e+01  3.35054064e+01  3.35054064e+01  3.35054064e+01
  1.12461851e+02  1.29228786e+02  1.29228786e+02  1.29228786e+02
  4.83717152e+02  4.83717152e+02  4.83717152e+02  6.05332517e+02
  1.33541134e+03  1.33541134e+03  1.33541134e+03  2.67844617e+03
  3.02940345e+03  3.02940345e+03  3.02940345e+03  6.64973024e+03
  6.64973024e+03  6.64973024e+03  9.08336628e+03  2.54378204e+04
  7.61787222e+04]
E1 = -727.8384591708093  E_coul = 201.09891742760934
cycle= 1 E= -526.7395417432  delta_E= -0.387  |g|= 0.186  |ddm|= 0.322
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54204
diis-c [-0.293807  1.      ]
  HOMO = -0.591057515521536  LUMO = 0.963801604568695
  mo_energy =
[-1.18637274e+02 -1.23431308e+01 -9.59579519e+00 -9.59579519e+00
 -9.59579519e+00 -1.27984917e+00 -5.91057516e-01 -5.91057516e-01
 -5.91057516e-01  9.63801605e-01  1.00748406e+00  1.00748406e+00
  1.00748406e+00  7.25679999e+00  7.25679999e+00  7.25679999e+00
  1.28159619e+01  3.33507779e+01  3.33507779e+01  3.33507779e+01
  1.12238075e+02  1.28999869e+02  1.28999869e+02  1.28999869e+02
  4.83410233e+02  4.83410233e+02  4.83410233e+02  6.04986902e+02
  1.33504834e+03  1.33504834e+03  1.33504834e+03  2.67794980e+03
  3.02897482e+03  3.02897482e+03  3.02897482e+03  6.64918873e+03
  6.64918873e+03  6.64918873e+03  9.08274987e+03  2.54371100e+04
  7.61779217e+04]
E1 = -728.4143480728643  E_coul = 201.6740823777374
cycle= 2 E= -526.740265695127  delta_E= -0.000724  |g|= 0.0377  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752778
diis-c [-0.00332002  0.08246863  0.91753137]
  HOMO = -0.581902118093786  LUMO = 0.971886004035138
  mo_energy =
[-1.18569415e+02 -1.23049531e+01 -9.55596466e+00 -9.55596466e+00
 -9.55596466e+00 -1.26888453e+00 -5.81902118e-01 -5.81902118e-01
 -5.81902118e-01  9.71886004e-01  1.01424089e+00  1.01424089e+00
  1.01424089e+00  7.28061975e+00  7.28061975e+00  7.28061975e+00
  1.28466774e+01  3.33909704e+01  3.33909704e+01  3.33909704e+01
  1.12294476e+02  1.29055920e+02  1.29055920e+02  1.29055920e+02
  4.83477274e+02  4.83477274e+02  4.83477274e+02  6.05056380e+02
  1.33511943e+03  1.33511943e+03  1.33511943e+03  2.67802420e+03
  3.02904816e+03  3.02904816e+03  3.02904816e+03  6.64926381e+03
  6.64926381e+03  6.64926381e+03  9.08282576e+03  2.54371865e+04
  7.61779985e+04]
E1 = -728.263404224036  E_coul = 201.5230792016214
cycle= 3 E= -526.740325022415  delta_E= -5.93e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132033
diis-c [-5.90737875e-07 -1.24273129e-03  1.44788591e-01  8.56454140e-01]
  HOMO = -0.583410493423183  LUMO = 0.970652234946279
  mo_energy =
[-1.18579405e+02 -1.23107827e+01 -9.56214216e+00 -9.56214216e+00
 -9.56214216e+00 -1.27058419e+00 -5.83410493e-01 -5.83410493e-01
 -5.83410493e-01  9.70652235e-01  1.01315245e+00  1.01315245e+00
  1.01315245e+00  7.27682797e+00  7.27682797e+00  7.27682797e+00
  1.28419616e+01  3.33847765e+01  3.33847765e+01  3.33847765e+01
  1.12286101e+02  1.29047543e+02  1.29047543e+02  1.29047543e+02
  4.83467400e+02  4.83467400e+02  4.83467400e+02  6.05046140e+02
  1.33510896e+03  1.33510896e+03  1.33510896e+03  2.67801311e+03
  3.02903731e+03  3.02903731e+03  3.02903731e+03  6.64925257e+03
  6.64925257e+03  6.64925257e+03  9.08281431e+03  2.54371749e+04
  7.61779867e+04]
E1 = -728.2862910992238  E_coul = 201.54596413833943
cycle= 4 E= -526.740326960884  delta_E= -1.94e-06  |g|= 0.000101  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117298
diis-c [-4.20840908e-09  7.52121158e-05 -1.06829687e-02 -6.92868407e-02
  1.07989460e+00]
  HOMO = -0.583393005924068  LUMO = 0.970685752091229
  mo_energy =
[-1.18579367e+02 -1.23107200e+01 -9.56209328e+00 -9.56209328e+00
 -9.56209328e+00 -1.27054332e+00 -5.83393006e-01 -5.83393006e-01
 -5.83393006e-01  9.70685752e-01  1.01316774e+00  1.01316774e+00
  1.01316774e+00  7.27686806e+00  7.27686806e+00  7.27686806e+00
  1.28420200e+01  3.33848235e+01  3.33848235e+01  3.33848235e+01
  1.12286150e+02  1.29047588e+02  1.29047588e+02  1.29047588e+02
  4.83467438e+02  4.83467438e+02  4.83467438e+02  6.05046170e+02
  1.33510899e+03  1.33510899e+03  1.33510899e+03  2.67801312e+03
  3.02903732e+03  3.02903732e+03  3.02903732e+03  6.64925257e+03
  6.64925257e+03  6.64925257e+03  9.08281430e+03  2.54371748e+04
  7.61779867e+04]
E1 = -728.2860823893877  E_coul = 201.54575542667337
cycle= 5 E= -526.740326962714  delta_E= -1.83e-09  |g|= 2.08e-05  |ddm|= 0.000164
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.91438e-05
diis-c [-7.77905764e-11  1.46400650e-05 -1.89407705e-03 -1.41270494e-02
  4.11656505e-02  9.74840836e-01]
  HOMO = -0.58340056090608  LUMO = 0.97068186291692
  mo_energy =
[-1.18579398e+02 -1.23107428e+01 -9.56211798e+00 -9.56211798e+00
 -9.56211798e+00 -1.27054928e+00 -5.83400561e-01 -5.83400561e-01
 -5.83400561e-01  9.70681863e-01  1.01316274e+00  1.01316274e+00
  1.01316274e+00  7.27685130e+00  7.27685130e+00  7.27685130e+00
  1.28420013e+01  3.33847995e+01  3.33847995e+01  3.33847995e+01
  1.12286122e+02  1.29047560e+02  1.29047560e+02  1.29047560e+02
  4.83467407e+02  4.83467407e+02  4.83467407e+02  6.05046139e+02
  1.33510896e+03  1.33510896e+03  1.33510896e+03  2.67801308e+03
  3.02903729e+03  3.02903729e+03  3.02903729e+03  6.64925254e+03
  6.64925254e+03  6.64925254e+03  9.08281427e+03  2.54371748e+04
  7.61779867e+04]
E1 = -728.286164308395  E_coul = 201.54583734561962
cycle= 6 E= -526.740326962775  delta_E= -6.1e-11  |g|= 1.76e-06  |ddm|= 1.92e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.286164308395  E_coul = 201.54583734561962
  HOMO = -0.583400565911929  LUMO = 0.97068221252226
  mo_energy =
[-1.18579398e+02 -1.23107425e+01 -9.56211785e+00 -9.56211785e+00
 -9.56211785e+00 -1.27054889e+00 -5.83400566e-01 -5.83400566e-01
 -5.83400566e-01  9.70682213e-01  1.01316279e+00  1.01316279e+00
  1.01316279e+00  7.27685139e+00  7.27685139e+00  7.27685139e+00
  1.28420016e+01  3.33847997e+01  3.33847997e+01  3.33847997e+01
  1.12286123e+02  1.29047560e+02  1.29047560e+02  1.29047560e+02
  4.83467408e+02  4.83467408e+02  4.83467408e+02  6.05046139e+02
  1.33510896e+03  1.33510896e+03  1.33510896e+03  2.67801308e+03
  3.02903729e+03  3.02903729e+03  3.02903729e+03  6.64925254e+03
  6.64925254e+03  6.64925254e+03  9.08281427e+03  2.54371748e+04
  7.61779867e+04]
E1 = -728.2861630026003  E_coul = 201.54583603982582
Extra cycle  E= -526.740326962775  delta_E= 7.96e-13  |g|= 3.64e-07  |ddm|= 3.1e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61826638e+04 7.61750412e+03 3.61735872e+03 1.59744448e+03
 3.83324743e+02 1.12083961e+02 3.71389642e+01 8.32261469e+00
 3.26109041e+00 6.53537484e-01 2.39058865e-01 1.36278585e+03
 6.64719669e+02 3.00839364e+02 3.13936558e+02 6.17003544e+01
 7.31341159e+00 2.02640319e+01 7.75991981e-01 2.81316699e+00
 2.22399608e-01]
E = -526.7403269627746
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:20 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6638128        1
[INPUT] 0    0    [1    /1   ]  7617.50411584        1
[INPUT] 0    0    [1    /1   ]  3617.35872279        1
[INPUT] 0    0    [1    /1   ]  1597.44448452        1
[INPUT] 0    0    [1    /1   ]  383.324743046        1
[INPUT] 0    0    [1    /1   ]  112.083960668        1
[INPUT] 0    0    [1    /1   ]  37.1389641599        1
[INPUT] 0    0    [1    /1   ]  8.32261469357        1
[INPUT] 0    0    [1    /1   ]  3.26109041159        1
[INPUT] 0    0    [1    /1   ]  0.653537483551       1
[INPUT] 0    0    [1    /1   ]  0.239058864978       1
[INPUT] 1    0    [1    /1   ]  1362.78585463        1
[INPUT] 1    0    [1    /1   ]  664.719669471        1
[INPUT] 1    0    [1    /1   ]  300.839363517        1
[INPUT] 1    0    [1    /1   ]  313.936558111        1
[INPUT] 1    0    [1    /1   ]  61.7003543659        1
[INPUT] 1    0    [1    /1   ]  7.31341159326        1
[INPUT] 1    0    [1    /1   ]  20.2640319255        1
[INPUT] 1    0    [1    /1   ]  0.775991980695       1
[INPUT] 1    0    [1    /1   ]  2.81316698937        1
[INPUT] 1    0    [1    /1   ]  0.222399608121       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.663812806255, 1.0]], [0, [7617.504115840895, 1.0]], [0, [3617.3587227885887, 1.0]], [0, [1597.444484515151, 1.0]], [0, [383.32474304588357, 1.0]], [0, [112.08396066790893, 1.0]], [0, [37.13896415987959, 1.0]], [0, [8.322614693566866, 1.0]], [0, [3.261090411586828, 1.0]], [0, [0.6535374835508937, 1.0]], [0, [0.23905886497823442, 1.0]], [1, [1362.7858546306575, 1.0]], [1, [664.719669470728, 1.0]], [1, [300.83936351722804, 1.0]], [1, [313.9365581112901, 1.0]], [1, [61.70035436591088, 1.0]], [1, [7.313411593257091, 1.0]], [1, [20.264031925512096, 1.0]], [1, [0.7759919806948843, 1.0]], [1, [2.813166989369858, 1.0]], [1, [0.2223996081212262, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66381281]
bas 1, expnt(s) = [7617.50411584]
bas 2, expnt(s) = [3617.35872279]
bas 3, expnt(s) = [1597.44448452]
bas 4, expnt(s) = [383.32474305]
bas 5, expnt(s) = [112.08396067]
bas 6, expnt(s) = [37.13896416]
bas 7, expnt(s) = [8.32261469]
bas 8, expnt(s) = [3.26109041]
bas 9, expnt(s) = [0.65353748]
bas 10, expnt(s) = [0.23905886]
bas 11, expnt(s) = [1362.78585463]
bas 12, expnt(s) = [664.71966947]
bas 13, expnt(s) = [300.83936352]
bas 14, expnt(s) = [313.93655811]
bas 15, expnt(s) = [61.70035437]
bas 16, expnt(s) = [7.31341159]
bas 17, expnt(s) = [20.26403193]
bas 18, expnt(s) = [0.77599198]
bas 19, expnt(s) = [2.81316699]
bas 20, expnt(s) = [0.22239961]
CPU time:       351.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826638e+04 5.20026405e+03 7.61750412e+03 2.06003475e+03
 3.61735872e+03 1.17844335e+03 1.59744448e+03 6.38387471e+02
 3.83324743e+02 2.18871979e+02 1.12083961e+02 8.70307299e+01
 3.71389642e+01 3.80090806e+01 8.32261469e+00 1.23796927e+01
 3.26109041e+00 6.13108241e+00 6.53537484e-01 1.83640261e+00
 2.39058865e-01 8.63761145e-01 1.36278585e+03 2.41556603e+04
 6.64719669e+02 9.84651519e+03 3.00839364e+02 3.65512908e+03
 3.13936558e+02 3.85510985e+03 6.17003544e+01 5.04480014e+02
 7.31341159e+00 3.50860447e+01 2.02640319e+01 1.25427198e+02
 7.75991981e-01 2.12474069e+00 2.81316699e+00 1.06286666e+01
 2.22399608e-01 4.45555608e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9936388440195
cond(S) = 103534.44681726127
E1 = -729.5312161082054  E_coul = 203.17911987899734
init E= -526.352096229208
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555804347380247  LUMO = 0.992048169668453
  mo_energy =
[-1.18329045e+02 -1.22048527e+01 -9.44674358e+00 -9.44674358e+00
 -9.44674358e+00 -1.24005409e+00 -5.55804347e-01 -5.55804347e-01
 -5.55804347e-01  9.92048170e-01  1.03206274e+00  1.03206274e+00
  1.03206274e+00  7.34805572e+00  7.34805572e+00  7.34805572e+00
  1.29280711e+01  3.35054064e+01  3.35054064e+01  3.35054064e+01
  1.12461851e+02  1.29228786e+02  1.29228786e+02  1.29228786e+02
  4.83717152e+02  4.83717152e+02  4.83717152e+02  6.05332517e+02
  1.33541134e+03  1.33541134e+03  1.33541134e+03  2.67844617e+03
  3.02940345e+03  3.02940345e+03  3.02940345e+03  6.64973024e+03
  6.64973024e+03  6.64973024e+03  9.08336628e+03  2.54378204e+04
  7.61787222e+04]
E1 = -727.8384591708093  E_coul = 201.09891742760934
cycle= 1 E= -526.7395417432  delta_E= -0.387  |g|= 0.186  |ddm|= 0.322
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.54204
diis-c [-0.293807  1.      ]
  HOMO = -0.591057515521536  LUMO = 0.963801604568695
  mo_energy =
[-1.18637274e+02 -1.23431308e+01 -9.59579519e+00 -9.59579519e+00
 -9.59579519e+00 -1.27984917e+00 -5.91057516e-01 -5.91057516e-01
 -5.91057516e-01  9.63801605e-01  1.00748406e+00  1.00748406e+00
  1.00748406e+00  7.25679999e+00  7.25679999e+00  7.25679999e+00
  1.28159619e+01  3.33507779e+01  3.33507779e+01  3.33507779e+01
  1.12238075e+02  1.28999869e+02  1.28999869e+02  1.28999869e+02
  4.83410233e+02  4.83410233e+02  4.83410233e+02  6.04986902e+02
  1.33504834e+03  1.33504834e+03  1.33504834e+03  2.67794980e+03
  3.02897482e+03  3.02897482e+03  3.02897482e+03  6.64918873e+03
  6.64918873e+03  6.64918873e+03  9.08274987e+03  2.54371100e+04
  7.61779217e+04]
E1 = -728.4143480728643  E_coul = 201.6740823777374
cycle= 2 E= -526.740265695127  delta_E= -0.000724  |g|= 0.0377  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0752778
diis-c [-0.00332002  0.08246863  0.91753137]
  HOMO = -0.581902118093786  LUMO = 0.971886004035138
  mo_energy =
[-1.18569415e+02 -1.23049531e+01 -9.55596466e+00 -9.55596466e+00
 -9.55596466e+00 -1.26888453e+00 -5.81902118e-01 -5.81902118e-01
 -5.81902118e-01  9.71886004e-01  1.01424089e+00  1.01424089e+00
  1.01424089e+00  7.28061975e+00  7.28061975e+00  7.28061975e+00
  1.28466774e+01  3.33909704e+01  3.33909704e+01  3.33909704e+01
  1.12294476e+02  1.29055920e+02  1.29055920e+02  1.29055920e+02
  4.83477274e+02  4.83477274e+02  4.83477274e+02  6.05056380e+02
  1.33511943e+03  1.33511943e+03  1.33511943e+03  2.67802420e+03
  3.02904816e+03  3.02904816e+03  3.02904816e+03  6.64926381e+03
  6.64926381e+03  6.64926381e+03  9.08282576e+03  2.54371865e+04
  7.61779985e+04]
E1 = -728.263404224036  E_coul = 201.5230792016214
cycle= 3 E= -526.740325022415  delta_E= -5.93e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132033
diis-c [-5.90737875e-07 -1.24273129e-03  1.44788591e-01  8.56454140e-01]
  HOMO = -0.583410493423183  LUMO = 0.970652234946279
  mo_energy =
[-1.18579405e+02 -1.23107827e+01 -9.56214216e+00 -9.56214216e+00
 -9.56214216e+00 -1.27058419e+00 -5.83410493e-01 -5.83410493e-01
 -5.83410493e-01  9.70652235e-01  1.01315245e+00  1.01315245e+00
  1.01315245e+00  7.27682797e+00  7.27682797e+00  7.27682797e+00
  1.28419616e+01  3.33847765e+01  3.33847765e+01  3.33847765e+01
  1.12286101e+02  1.29047543e+02  1.29047543e+02  1.29047543e+02
  4.83467400e+02  4.83467400e+02  4.83467400e+02  6.05046140e+02
  1.33510896e+03  1.33510896e+03  1.33510896e+03  2.67801311e+03
  3.02903731e+03  3.02903731e+03  3.02903731e+03  6.64925257e+03
  6.64925257e+03  6.64925257e+03  9.08281431e+03  2.54371749e+04
  7.61779867e+04]
E1 = -728.2862910992238  E_coul = 201.54596413833943
cycle= 4 E= -526.740326960884  delta_E= -1.94e-06  |g|= 0.000101  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117298
diis-c [-4.20840908e-09  7.52121158e-05 -1.06829687e-02 -6.92868407e-02
  1.07989460e+00]
  HOMO = -0.583393005924068  LUMO = 0.970685752091229
  mo_energy =
[-1.18579367e+02 -1.23107200e+01 -9.56209328e+00 -9.56209328e+00
 -9.56209328e+00 -1.27054332e+00 -5.83393006e-01 -5.83393006e-01
 -5.83393006e-01  9.70685752e-01  1.01316774e+00  1.01316774e+00
  1.01316774e+00  7.27686806e+00  7.27686806e+00  7.27686806e+00
  1.28420200e+01  3.33848235e+01  3.33848235e+01  3.33848235e+01
  1.12286150e+02  1.29047588e+02  1.29047588e+02  1.29047588e+02
  4.83467438e+02  4.83467438e+02  4.83467438e+02  6.05046170e+02
  1.33510899e+03  1.33510899e+03  1.33510899e+03  2.67801312e+03
  3.02903732e+03  3.02903732e+03  3.02903732e+03  6.64925257e+03
  6.64925257e+03  6.64925257e+03  9.08281430e+03  2.54371748e+04
  7.61779867e+04]
E1 = -728.2860823893877  E_coul = 201.54575542667337
cycle= 5 E= -526.740326962714  delta_E= -1.83e-09  |g|= 2.08e-05  |ddm|= 0.000164
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.91438e-05
diis-c [-7.77905764e-11  1.46400650e-05 -1.89407705e-03 -1.41270494e-02
  4.11656505e-02  9.74840836e-01]
  HOMO = -0.58340056090608  LUMO = 0.97068186291692
  mo_energy =
[-1.18579398e+02 -1.23107428e+01 -9.56211798e+00 -9.56211798e+00
 -9.56211798e+00 -1.27054928e+00 -5.83400561e-01 -5.83400561e-01
 -5.83400561e-01  9.70681863e-01  1.01316274e+00  1.01316274e+00
  1.01316274e+00  7.27685130e+00  7.27685130e+00  7.27685130e+00
  1.28420013e+01  3.33847995e+01  3.33847995e+01  3.33847995e+01
  1.12286122e+02  1.29047560e+02  1.29047560e+02  1.29047560e+02
  4.83467407e+02  4.83467407e+02  4.83467407e+02  6.05046139e+02
  1.33510896e+03  1.33510896e+03  1.33510896e+03  2.67801308e+03
  3.02903729e+03  3.02903729e+03  3.02903729e+03  6.64925254e+03
  6.64925254e+03  6.64925254e+03  9.08281427e+03  2.54371748e+04
  7.61779867e+04]
E1 = -728.286164308395  E_coul = 201.54583734561962
cycle= 6 E= -526.740326962775  delta_E= -6.1e-11  |g|= 1.76e-06  |ddm|= 1.92e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.286164308395  E_coul = 201.54583734561962
  HOMO = -0.583400565911929  LUMO = 0.97068221252226
  mo_energy =
[-1.18579398e+02 -1.23107425e+01 -9.56211785e+00 -9.56211785e+00
 -9.56211785e+00 -1.27054889e+00 -5.83400566e-01 -5.83400566e-01
 -5.83400566e-01  9.70682213e-01  1.01316279e+00  1.01316279e+00
  1.01316279e+00  7.27685139e+00  7.27685139e+00  7.27685139e+00
  1.28420016e+01  3.33847997e+01  3.33847997e+01  3.33847997e+01
  1.12286123e+02  1.29047560e+02  1.29047560e+02  1.29047560e+02
  4.83467408e+02  4.83467408e+02  4.83467408e+02  6.05046139e+02
  1.33510896e+03  1.33510896e+03  1.33510896e+03  2.67801308e+03
  3.02903729e+03  3.02903729e+03  3.02903729e+03  6.64925254e+03
  6.64925254e+03  6.64925254e+03  9.08281427e+03  2.54371748e+04
  7.61779867e+04]
E1 = -728.2861630026003  E_coul = 201.54583603982582
Extra cycle  E= -526.740326962775  delta_E= 7.96e-13  |g|= 3.64e-07  |ddm|= 3.1e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103534.44681726127
E1 = -728.2861630026003  E_coul = 201.54583603982582
init E= -526.740326962775
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.583400603787312  LUMO = 0.970682253286985
  mo_energy =
[-1.18579398e+02 -1.23107426e+01 -9.56211797e+00 -9.56211797e+00
 -9.56211797e+00 -1.27054885e+00 -5.83400604e-01 -5.83400604e-01
 -5.83400604e-01  9.70682253e-01  1.01316277e+00  1.01316277e+00
  1.01316277e+00  7.27685132e+00  7.27685132e+00  7.27685132e+00
  1.28420015e+01  3.33847996e+01  3.33847996e+01  3.33847996e+01
  1.12286123e+02  1.29047560e+02  1.29047560e+02  1.29047560e+02
  4.83467408e+02  4.83467408e+02  4.83467408e+02  6.05046139e+02
  1.33510896e+03  1.33510896e+03  1.33510896e+03  2.67801308e+03
  3.02903729e+03  3.02903729e+03  3.02903729e+03  6.64925254e+03
  6.64925254e+03  6.64925254e+03  9.08281427e+03  2.54371748e+04
  7.61779867e+04]
E1 = -728.28616324554  E_coul = 201.545836282764
cycle= 1 E= -526.740326962776  delta_E= -1.48e-12  |g|= 7.74e-08  |ddm|= 6.03e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.28616324554  E_coul = 201.545836282764
  HOMO = -0.583400601925534  LUMO = 0.970682269806109
  mo_energy =
[-1.18579398e+02 -1.23107426e+01 -9.56211795e+00 -9.56211795e+00
 -9.56211795e+00 -1.27054884e+00 -5.83400602e-01 -5.83400602e-01
 -5.83400602e-01  9.70682270e-01  1.01316278e+00  1.01316278e+00
  1.01316278e+00  7.27685133e+00  7.27685133e+00  7.27685133e+00
  1.28420016e+01  3.33847996e+01  3.33847996e+01  3.33847996e+01
  1.12286123e+02  1.29047560e+02  1.29047560e+02  1.29047560e+02
  4.83467408e+02  4.83467408e+02  4.83467408e+02  6.05046139e+02
  1.33510896e+03  1.33510896e+03  1.33510896e+03  2.67801308e+03
  3.02903729e+03  3.02903729e+03  3.02903729e+03  6.64925254e+03
  6.64925254e+03  6.64925254e+03  9.08281427e+03  2.54371748e+04
  7.61779867e+04]
E1 = -728.2861631512638  E_coul = 201.545836188488
Extra cycle  E= -526.740326962776  delta_E= 2.27e-13  |g|= 1.58e-08  |ddm|= 1.29e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61826638e+04 7.61750412e+03 3.61735872e+03 1.59744448e+03
 3.83324743e+02 1.12083961e+02 3.71389642e+01 8.32261469e+00
 3.26109041e+00 6.53537484e-01 2.39058865e-01 1.36278585e+03
 6.64719669e+02 3.00839364e+02 3.13936558e+02 6.17003544e+01
 7.31341159e+00 2.02640319e+01 7.75991981e-01 2.81316699e+00
 2.22399608e-01]
grad_E = [-1.54359250e-06  3.60037061e-06 -1.40830702e-06  8.02784586e-05
 -2.77617509e-04 -1.93481162e-04  5.39754573e-05  3.67037008e-04
 -5.92627578e-04  2.04473771e-04 -4.47970470e-03 -5.00652844e-07
  5.10428700e-06  2.42510307e-05  2.08960284e-05 -1.25592263e-04
 -3.23691916e-03  1.02895930e-03  4.15596604e-03  3.19938110e-03
 -1.14594442e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6683688        1
[INPUT] 0    0    [1    /1   ]  7617.49326239        1
[INPUT] 0    0    [1    /1   ]  3617.36263499        1
[INPUT] 0    0    [1    /1   ]  1597.19885659        1
[INPUT] 0    0    [1    /1   ]  384.322643112        1
[INPUT] 0    0    [1    /1   ]  112.083640992        1
[INPUT] 0    0    [1    /1   ]  37.0930834976        1
[INPUT] 0    0    [1    /1   ]  8.35600568824        1
[INPUT] 0    0    [1    /1   ]  3.26494059892        1
[INPUT] 0    0    [1    /1   ]  0.647786745334       1
[INPUT] 0    0    [1    /1   ]  0.236333022033       1
[INPUT] 1    0    [1    /1   ]  1362.78735254        1
[INPUT] 1    0    [1    /1   ]  664.705080097        1
[INPUT] 1    0    [1    /1   ]  300.770619133        1
[INPUT] 1    0    [1    /1   ]  313.877305796        1
[INPUT] 1    0    [1    /1   ]  61.742206744         1
[INPUT] 1    0    [1    /1   ]  7.29312484451        1
[INPUT] 1    0    [1    /1   ]  20.266159452         1
[INPUT] 1    0    [1    /1   ]  0.775856571645       1
[INPUT] 1    0    [1    /1   ]  2.80996896791        1
[INPUT] 1    0    [1    /1   ]  0.222161631156       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.668368763745, 1.0]], [0, [7617.49326238838, 1.0]], [0, [3617.362634994144, 1.0]], [0, [1597.1988565929105, 1.0]], [0, [384.3226431123468, 1.0]], [0, [112.08364099207098, 1.0]], [0, [37.0930834975977, 1.0]], [0, [8.356005688243583, 1.0]], [0, [3.2649405989226055, 1.0]], [0, [0.6477867453337404, 1.0]], [0, [0.2363330220329307, 1.0]], [1, [1362.7873525391128, 1.0]], [1, [664.7050800971722, 1.0]], [1, [300.77061913304186, 1.0]], [1, [313.8773057960477, 1.0]], [1, [61.74220674401064, 1.0]], [1, [7.293124844507427, 1.0]], [1, [20.266159452027754, 1.0]], [1, [0.7758565716454771, 1.0]], [1, [2.8099689679131905, 1.0]], [1, [0.2221616311558987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66836876]
bas 1, expnt(s) = [7617.49326239]
bas 2, expnt(s) = [3617.36263499]
bas 3, expnt(s) = [1597.19885659]
bas 4, expnt(s) = [384.32264311]
bas 5, expnt(s) = [112.08364099]
bas 6, expnt(s) = [37.0930835]
bas 7, expnt(s) = [8.35600569]
bas 8, expnt(s) = [3.2649406]
bas 9, expnt(s) = [0.64778675]
bas 10, expnt(s) = [0.23633302]
bas 11, expnt(s) = [1362.78735254]
bas 12, expnt(s) = [664.7050801]
bas 13, expnt(s) = [300.77061913]
bas 14, expnt(s) = [313.8773058]
bas 15, expnt(s) = [61.74220674]
bas 16, expnt(s) = [7.29312484]
bas 17, expnt(s) = [20.26615945]
bas 18, expnt(s) = [0.77585657]
bas 19, expnt(s) = [2.80996897]
bas 20, expnt(s) = [0.22216163]
CPU time:       357.14
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826684e+04 5.20026473e+03 7.61749326e+03 2.06003255e+03
 3.61736263e+03 1.17844430e+03 1.59719886e+03 6.38313849e+02
 3.84322643e+02 2.19299178e+02 1.12083641e+02 8.70305438e+01
 3.70930835e+01 3.79738584e+01 8.35600569e+00 1.24169253e+01
 3.26494060e+00 6.13651058e+00 6.47786745e-01 1.82426979e+00
 2.36333022e-01 8.56363859e-01 1.36278735e+03 2.41556935e+04
 6.64705080e+02 9.84624505e+03 3.00770619e+02 3.65408508e+03
 3.13877306e+02 3.85420036e+03 6.17422067e+01 5.04907797e+02
 7.29312484e+00 3.49644300e+01 2.02661595e+01 1.25443659e+02
 7.75856572e-01 2.12427724e+00 2.80996897e+00 1.06135653e+01
 2.22161631e-01 4.44959734e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993671184393015
cond(S) = 103327.63657354952
E1 = -729.5315515624868  E_coul = 203.17947770997517
init E= -526.352073852512
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555824589381528  LUMO = 0.97553770998557
  mo_energy =
[-1.18329136e+02 -1.22047855e+01 -9.44668271e+00 -9.44668271e+00
 -9.44668271e+00 -1.24006861e+00 -5.55824589e-01 -5.55824589e-01
 -5.55824589e-01  9.75537710e-01  1.03103415e+00  1.03103415e+00
  1.03103415e+00  7.33534794e+00  7.33534794e+00  7.33534794e+00
  1.29312126e+01  3.34460348e+01  3.34460348e+01  3.34460348e+01
  1.12488026e+02  1.29190624e+02  1.29190624e+02  1.29190624e+02
  4.83724510e+02  4.83724510e+02  4.83724510e+02  6.05968597e+02
  1.33531246e+03  1.33531246e+03  1.33531246e+03  2.68088198e+03
  3.02912947e+03  3.02912947e+03  3.02912947e+03  6.64933377e+03
  6.64933377e+03  6.64933377e+03  9.08628518e+03  2.54405915e+04
  7.61812568e+04]
E1 = -727.8330855159073  E_coul = 201.0933656063602
cycle= 1 E= -526.739719909547  delta_E= -0.388  |g|= 0.186  |ddm|= 0.329
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542045
diis-c [-0.29381276  1.        ]
  HOMO = -0.591303302835934  LUMO = 0.947468287913255
  mo_energy =
[-1.18637807e+02 -1.23434567e+01 -9.59614088e+00 -9.59614088e+00
 -9.59614088e+00 -1.28008295e+00 -5.91303303e-01 -5.91303303e-01
 -5.91303303e-01  9.47468288e-01  1.00630772e+00  1.00630772e+00
  1.00630772e+00  7.24385864e+00  7.24385864e+00  7.24385864e+00
  1.28186250e+01  3.32910650e+01  3.32910650e+01  3.32910650e+01
  1.12263788e+02  1.28961228e+02  1.28961228e+02  1.28961228e+02
  4.83417133e+02  4.83417133e+02  4.83417133e+02  6.05622373e+02
  1.33494903e+03  1.33494903e+03  1.33494903e+03  2.68038504e+03
  3.02870035e+03  3.02870035e+03  3.02870035e+03  6.64879177e+03
  6.64879177e+03  6.64879177e+03  9.08566831e+03  2.54398807e+04
  7.61804559e+04]
E1 = -728.4105299693165  E_coul = 201.67008248599032
cycle= 2 E= -526.740447483326  delta_E= -0.000728  |g|= 0.0378  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0754187
diis-c [-0.0033272   0.08269495  0.91730505]
  HOMO = -0.582120174093244  LUMO = 0.955487130482597
  mo_energy =
[-1.18569812e+02 -1.23051813e+01 -9.55621259e+00 -9.55621259e+00
 -9.55621259e+00 -1.26908182e+00 -5.82120174e-01 -5.82120174e-01
 -5.82120174e-01  9.55487130e-01  1.01308160e+00  1.01308160e+00
  1.01308160e+00  7.26771655e+00  7.26771655e+00  7.26771655e+00
  1.28494693e+01  3.33313410e+01  3.33313410e+01  3.33313410e+01
  1.12320307e+02  1.29017409e+02  1.29017409e+02  1.29017409e+02
  4.83484311e+02  4.83484311e+02  4.83484311e+02  6.05691996e+02
  1.33502026e+03  1.33502026e+03  1.33502026e+03  2.68045959e+03
  3.02877383e+03  3.02877383e+03  3.02877383e+03  6.64886699e+03
  6.64886699e+03  6.64886699e+03  9.08574435e+03  2.54399573e+04
  7.61805328e+04]
E1 = -728.2591336544366  E_coul = 201.5186264994018
cycle= 3 E= -526.740507155035  delta_E= -5.97e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132193
diis-c [-6.01112803e-07 -1.24551774e-03  1.44694874e-01  8.56550644e-01]
  HOMO = -0.583633373626132  LUMO = 0.954264974844319
  mo_energy =
[-1.18579814e+02 -1.23110204e+01 -9.56240022e+00 -9.56240022e+00
 -9.56240022e+00 -1.27078523e+00 -5.83633374e-01 -5.83633374e-01
 -5.83633374e-01  9.54264975e-01  1.01199049e+00  1.01199049e+00
  1.01199049e+00  7.26392070e+00  7.26392070e+00  7.26392070e+00
  1.28447391e+01  3.33251391e+01  3.33251391e+01  3.33251391e+01
  1.12311922e+02  1.29009019e+02  1.29009019e+02  1.29009019e+02
  4.83474425e+02  4.83474425e+02  4.83474425e+02  6.05681743e+02
  1.33500978e+03  1.33500978e+03  1.33500978e+03  2.68044848e+03
  3.02876296e+03  3.02876296e+03  3.02876296e+03  6.64885574e+03
  6.64885574e+03  6.64885574e+03  9.08573288e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2820643173778  E_coul = 201.54155521596203
cycle= 4 E= -526.740509101416  delta_E= -1.95e-06  |g|= 0.000102  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119541
diis-c [-4.30107689e-09  7.68341668e-05 -1.08705120e-02 -7.05771501e-02
  1.08137083e+00]
  HOMO = -0.5836161822608  LUMO = 0.954298392930083
  mo_energy =
[-1.18579777e+02 -1.23109579e+01 -9.56235189e+00 -9.56235189e+00
 -9.56235189e+00 -1.27074415e+00 -5.83616182e-01 -5.83616182e-01
 -5.83616182e-01  9.54298393e-01  1.01200563e+00  1.01200563e+00
  1.01200563e+00  7.26396037e+00  7.26396037e+00  7.26396037e+00
  1.28447973e+01  3.33251855e+01  3.33251855e+01  3.33251855e+01
  1.12311970e+02  1.29009064e+02  1.29009064e+02  1.29009064e+02
  4.83474462e+02  4.83474462e+02  4.83474462e+02  6.05681772e+02
  1.33500981e+03  1.33500981e+03  1.33500981e+03  2.68044849e+03
  3.02876298e+03  3.02876298e+03  3.02876298e+03  6.64885574e+03
  6.64885574e+03  6.64885574e+03  9.08573287e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2818554063542  E_coul = 201.54134630301903
cycle= 5 E= -526.740509103335  delta_E= -1.92e-09  |g|= 2.1e-05  |ddm|= 0.000168
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.9436e-05
diis-c [-8.04505364e-11  1.47653195e-05 -1.90400981e-03 -1.42095472e-02
  4.00835286e-02  9.76015263e-01]
  HOMO = -0.58362384125102  LUMO = 0.954294522582006
  mo_energy =
[-1.18579808e+02 -1.23109809e+01 -9.56237685e+00 -9.56237685e+00
 -9.56237685e+00 -1.27075016e+00 -5.83623841e-01 -5.83623841e-01
 -5.83623841e-01  9.54294523e-01  1.01200056e+00  1.01200056e+00
  1.01200056e+00  7.26394343e+00  7.26394343e+00  7.26394343e+00
  1.28447784e+01  3.33251613e+01  3.33251613e+01  3.33251613e+01
  1.12311942e+02  1.29009035e+02  1.29009035e+02  1.29009035e+02
  4.83474431e+02  4.83474431e+02  4.83474431e+02  6.05681740e+02
  1.33500978e+03  1.33500978e+03  1.33500978e+03  2.68044846e+03
  3.02876295e+03  3.02876295e+03  3.02876295e+03  6.64885571e+03
  6.64885571e+03  6.64885571e+03  9.08573284e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2819380499857  E_coul = 201.54142894658807
cycle= 6 E= -526.740509103398  delta_E= -6.24e-11  |g|= 1.77e-06  |ddm|= 1.96e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2819380499857  E_coul = 201.54142894658807
  HOMO = -0.583623835619018  LUMO = 0.954294881116668
  mo_energy =
[-1.18579808e+02 -1.23109807e+01 -9.56237668e+00 -9.56237668e+00
 -9.56237668e+00 -1.27074976e+00 -5.83623836e-01 -5.83623836e-01
 -5.83623836e-01  9.54294881e-01  1.01200062e+00  1.01200062e+00
  1.01200062e+00  7.26394356e+00  7.26394356e+00  7.26394356e+00
  1.28447787e+01  3.33251615e+01  3.33251615e+01  3.33251615e+01
  1.12311942e+02  1.29009035e+02  1.29009035e+02  1.29009035e+02
  4.83474431e+02  4.83474431e+02  4.83474431e+02  6.05681741e+02
  1.33500978e+03  1.33500978e+03  1.33500978e+03  2.68044846e+03
  3.02876295e+03  3.02876295e+03  3.02876295e+03  6.64885571e+03
  6.64885571e+03  6.64885571e+03  9.08573284e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2819365547692  E_coul = 201.54142745137082
Extra cycle  E= -526.740509103398  delta_E= -7.96e-13  |g|= 3.68e-07  |ddm|= 3.14e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61826684e+04 7.61749326e+03 3.61736263e+03 1.59719886e+03
 3.84322643e+02 1.12083641e+02 3.70930835e+01 8.35600569e+00
 3.26494060e+00 6.47786745e-01 2.36333022e-01 1.36278735e+03
 6.64705080e+02 3.00770619e+02 3.13877306e+02 6.17422067e+01
 7.29312484e+00 2.02661595e+01 7.75856572e-01 2.80996897e+00
 2.22161631e-01]
E = -526.7405091033984
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6683688        1
[INPUT] 0    0    [1    /1   ]  7617.49326239        1
[INPUT] 0    0    [1    /1   ]  3617.36263499        1
[INPUT] 0    0    [1    /1   ]  1597.19885659        1
[INPUT] 0    0    [1    /1   ]  384.322643112        1
[INPUT] 0    0    [1    /1   ]  112.083640992        1
[INPUT] 0    0    [1    /1   ]  37.0930834976        1
[INPUT] 0    0    [1    /1   ]  8.35600568824        1
[INPUT] 0    0    [1    /1   ]  3.26494059892        1
[INPUT] 0    0    [1    /1   ]  0.647786745334       1
[INPUT] 0    0    [1    /1   ]  0.236333022033       1
[INPUT] 1    0    [1    /1   ]  1362.78735254        1
[INPUT] 1    0    [1    /1   ]  664.705080097        1
[INPUT] 1    0    [1    /1   ]  300.770619133        1
[INPUT] 1    0    [1    /1   ]  313.877305796        1
[INPUT] 1    0    [1    /1   ]  61.742206744         1
[INPUT] 1    0    [1    /1   ]  7.29312484451        1
[INPUT] 1    0    [1    /1   ]  20.266159452         1
[INPUT] 1    0    [1    /1   ]  0.775856571645       1
[INPUT] 1    0    [1    /1   ]  2.80996896791        1
[INPUT] 1    0    [1    /1   ]  0.222161631156       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.668368763745, 1.0]], [0, [7617.49326238838, 1.0]], [0, [3617.362634994144, 1.0]], [0, [1597.1988565929105, 1.0]], [0, [384.3226431123468, 1.0]], [0, [112.08364099207098, 1.0]], [0, [37.0930834975977, 1.0]], [0, [8.356005688243583, 1.0]], [0, [3.2649405989226055, 1.0]], [0, [0.6477867453337404, 1.0]], [0, [0.2363330220329307, 1.0]], [1, [1362.7873525391128, 1.0]], [1, [664.7050800971722, 1.0]], [1, [300.77061913304186, 1.0]], [1, [313.8773057960477, 1.0]], [1, [61.74220674401064, 1.0]], [1, [7.293124844507427, 1.0]], [1, [20.266159452027754, 1.0]], [1, [0.7758565716454771, 1.0]], [1, [2.8099689679131905, 1.0]], [1, [0.2221616311558987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.66836876]
bas 1, expnt(s) = [7617.49326239]
bas 2, expnt(s) = [3617.36263499]
bas 3, expnt(s) = [1597.19885659]
bas 4, expnt(s) = [384.32264311]
bas 5, expnt(s) = [112.08364099]
bas 6, expnt(s) = [37.0930835]
bas 7, expnt(s) = [8.35600569]
bas 8, expnt(s) = [3.2649406]
bas 9, expnt(s) = [0.64778675]
bas 10, expnt(s) = [0.23633302]
bas 11, expnt(s) = [1362.78735254]
bas 12, expnt(s) = [664.7050801]
bas 13, expnt(s) = [300.77061913]
bas 14, expnt(s) = [313.8773058]
bas 15, expnt(s) = [61.74220674]
bas 16, expnt(s) = [7.29312484]
bas 17, expnt(s) = [20.26615945]
bas 18, expnt(s) = [0.77585657]
bas 19, expnt(s) = [2.80996897]
bas 20, expnt(s) = [0.22216163]
CPU time:       357.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826684e+04 5.20026473e+03 7.61749326e+03 2.06003255e+03
 3.61736263e+03 1.17844430e+03 1.59719886e+03 6.38313849e+02
 3.84322643e+02 2.19299178e+02 1.12083641e+02 8.70305438e+01
 3.70930835e+01 3.79738584e+01 8.35600569e+00 1.24169253e+01
 3.26494060e+00 6.13651058e+00 6.47786745e-01 1.82426979e+00
 2.36333022e-01 8.56363859e-01 1.36278735e+03 2.41556935e+04
 6.64705080e+02 9.84624505e+03 3.00770619e+02 3.65408508e+03
 3.13877306e+02 3.85420036e+03 6.17422067e+01 5.04907797e+02
 7.29312484e+00 3.49644300e+01 2.02661595e+01 1.25443659e+02
 7.75856572e-01 2.12427724e+00 2.80996897e+00 1.06135653e+01
 2.22161631e-01 4.44959734e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993671184393015
cond(S) = 103327.63657354952
E1 = -729.5315515624868  E_coul = 203.17947770997517
init E= -526.352073852512
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555824589381528  LUMO = 0.97553770998557
  mo_energy =
[-1.18329136e+02 -1.22047855e+01 -9.44668271e+00 -9.44668271e+00
 -9.44668271e+00 -1.24006861e+00 -5.55824589e-01 -5.55824589e-01
 -5.55824589e-01  9.75537710e-01  1.03103415e+00  1.03103415e+00
  1.03103415e+00  7.33534794e+00  7.33534794e+00  7.33534794e+00
  1.29312126e+01  3.34460348e+01  3.34460348e+01  3.34460348e+01
  1.12488026e+02  1.29190624e+02  1.29190624e+02  1.29190624e+02
  4.83724510e+02  4.83724510e+02  4.83724510e+02  6.05968597e+02
  1.33531246e+03  1.33531246e+03  1.33531246e+03  2.68088198e+03
  3.02912947e+03  3.02912947e+03  3.02912947e+03  6.64933377e+03
  6.64933377e+03  6.64933377e+03  9.08628518e+03  2.54405915e+04
  7.61812568e+04]
E1 = -727.8330855159073  E_coul = 201.0933656063602
cycle= 1 E= -526.739719909547  delta_E= -0.388  |g|= 0.186  |ddm|= 0.329
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.542045
diis-c [-0.29381276  1.        ]
  HOMO = -0.591303302835934  LUMO = 0.947468287913255
  mo_energy =
[-1.18637807e+02 -1.23434567e+01 -9.59614088e+00 -9.59614088e+00
 -9.59614088e+00 -1.28008295e+00 -5.91303303e-01 -5.91303303e-01
 -5.91303303e-01  9.47468288e-01  1.00630772e+00  1.00630772e+00
  1.00630772e+00  7.24385864e+00  7.24385864e+00  7.24385864e+00
  1.28186250e+01  3.32910650e+01  3.32910650e+01  3.32910650e+01
  1.12263788e+02  1.28961228e+02  1.28961228e+02  1.28961228e+02
  4.83417133e+02  4.83417133e+02  4.83417133e+02  6.05622373e+02
  1.33494903e+03  1.33494903e+03  1.33494903e+03  2.68038504e+03
  3.02870035e+03  3.02870035e+03  3.02870035e+03  6.64879177e+03
  6.64879177e+03  6.64879177e+03  9.08566831e+03  2.54398807e+04
  7.61804559e+04]
E1 = -728.4105299693165  E_coul = 201.67008248599032
cycle= 2 E= -526.740447483326  delta_E= -0.000728  |g|= 0.0378  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0754187
diis-c [-0.0033272   0.08269495  0.91730505]
  HOMO = -0.582120174093244  LUMO = 0.955487130482597
  mo_energy =
[-1.18569812e+02 -1.23051813e+01 -9.55621259e+00 -9.55621259e+00
 -9.55621259e+00 -1.26908182e+00 -5.82120174e-01 -5.82120174e-01
 -5.82120174e-01  9.55487130e-01  1.01308160e+00  1.01308160e+00
  1.01308160e+00  7.26771655e+00  7.26771655e+00  7.26771655e+00
  1.28494693e+01  3.33313410e+01  3.33313410e+01  3.33313410e+01
  1.12320307e+02  1.29017409e+02  1.29017409e+02  1.29017409e+02
  4.83484311e+02  4.83484311e+02  4.83484311e+02  6.05691996e+02
  1.33502026e+03  1.33502026e+03  1.33502026e+03  2.68045959e+03
  3.02877383e+03  3.02877383e+03  3.02877383e+03  6.64886699e+03
  6.64886699e+03  6.64886699e+03  9.08574435e+03  2.54399573e+04
  7.61805328e+04]
E1 = -728.2591336544366  E_coul = 201.5186264994018
cycle= 3 E= -526.740507155035  delta_E= -5.97e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132193
diis-c [-6.01112803e-07 -1.24551774e-03  1.44694874e-01  8.56550644e-01]
  HOMO = -0.583633373626132  LUMO = 0.954264974844319
  mo_energy =
[-1.18579814e+02 -1.23110204e+01 -9.56240022e+00 -9.56240022e+00
 -9.56240022e+00 -1.27078523e+00 -5.83633374e-01 -5.83633374e-01
 -5.83633374e-01  9.54264975e-01  1.01199049e+00  1.01199049e+00
  1.01199049e+00  7.26392070e+00  7.26392070e+00  7.26392070e+00
  1.28447391e+01  3.33251391e+01  3.33251391e+01  3.33251391e+01
  1.12311922e+02  1.29009019e+02  1.29009019e+02  1.29009019e+02
  4.83474425e+02  4.83474425e+02  4.83474425e+02  6.05681743e+02
  1.33500978e+03  1.33500978e+03  1.33500978e+03  2.68044848e+03
  3.02876296e+03  3.02876296e+03  3.02876296e+03  6.64885574e+03
  6.64885574e+03  6.64885574e+03  9.08573288e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2820643173778  E_coul = 201.54155521596203
cycle= 4 E= -526.740509101416  delta_E= -1.95e-06  |g|= 0.000102  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000119541
diis-c [-4.30107689e-09  7.68341668e-05 -1.08705120e-02 -7.05771501e-02
  1.08137083e+00]
  HOMO = -0.5836161822608  LUMO = 0.954298392930083
  mo_energy =
[-1.18579777e+02 -1.23109579e+01 -9.56235189e+00 -9.56235189e+00
 -9.56235189e+00 -1.27074415e+00 -5.83616182e-01 -5.83616182e-01
 -5.83616182e-01  9.54298393e-01  1.01200563e+00  1.01200563e+00
  1.01200563e+00  7.26396037e+00  7.26396037e+00  7.26396037e+00
  1.28447973e+01  3.33251855e+01  3.33251855e+01  3.33251855e+01
  1.12311970e+02  1.29009064e+02  1.29009064e+02  1.29009064e+02
  4.83474462e+02  4.83474462e+02  4.83474462e+02  6.05681772e+02
  1.33500981e+03  1.33500981e+03  1.33500981e+03  2.68044849e+03
  3.02876298e+03  3.02876298e+03  3.02876298e+03  6.64885574e+03
  6.64885574e+03  6.64885574e+03  9.08573287e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2818554063542  E_coul = 201.54134630301903
cycle= 5 E= -526.740509103335  delta_E= -1.92e-09  |g|= 2.1e-05  |ddm|= 0.000168
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.9436e-05
diis-c [-8.04505364e-11  1.47653195e-05 -1.90400981e-03 -1.42095472e-02
  4.00835286e-02  9.76015263e-01]
  HOMO = -0.58362384125102  LUMO = 0.954294522582006
  mo_energy =
[-1.18579808e+02 -1.23109809e+01 -9.56237685e+00 -9.56237685e+00
 -9.56237685e+00 -1.27075016e+00 -5.83623841e-01 -5.83623841e-01
 -5.83623841e-01  9.54294523e-01  1.01200056e+00  1.01200056e+00
  1.01200056e+00  7.26394343e+00  7.26394343e+00  7.26394343e+00
  1.28447784e+01  3.33251613e+01  3.33251613e+01  3.33251613e+01
  1.12311942e+02  1.29009035e+02  1.29009035e+02  1.29009035e+02
  4.83474431e+02  4.83474431e+02  4.83474431e+02  6.05681740e+02
  1.33500978e+03  1.33500978e+03  1.33500978e+03  2.68044846e+03
  3.02876295e+03  3.02876295e+03  3.02876295e+03  6.64885571e+03
  6.64885571e+03  6.64885571e+03  9.08573284e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2819380499857  E_coul = 201.54142894658807
cycle= 6 E= -526.740509103398  delta_E= -6.24e-11  |g|= 1.77e-06  |ddm|= 1.96e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2819380499857  E_coul = 201.54142894658807
  HOMO = -0.583623835619018  LUMO = 0.954294881116668
  mo_energy =
[-1.18579808e+02 -1.23109807e+01 -9.56237668e+00 -9.56237668e+00
 -9.56237668e+00 -1.27074976e+00 -5.83623836e-01 -5.83623836e-01
 -5.83623836e-01  9.54294881e-01  1.01200062e+00  1.01200062e+00
  1.01200062e+00  7.26394356e+00  7.26394356e+00  7.26394356e+00
  1.28447787e+01  3.33251615e+01  3.33251615e+01  3.33251615e+01
  1.12311942e+02  1.29009035e+02  1.29009035e+02  1.29009035e+02
  4.83474431e+02  4.83474431e+02  4.83474431e+02  6.05681741e+02
  1.33500978e+03  1.33500978e+03  1.33500978e+03  2.68044846e+03
  3.02876295e+03  3.02876295e+03  3.02876295e+03  6.64885571e+03
  6.64885571e+03  6.64885571e+03  9.08573284e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2819365547692  E_coul = 201.54142745137082
Extra cycle  E= -526.740509103398  delta_E= -7.96e-13  |g|= 3.68e-07  |ddm|= 3.14e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 103327.63657354952
E1 = -728.2819365547692  E_coul = 201.54142745137082
init E= -526.740509103398
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.58362387766274  LUMO = 0.954294918872585
  mo_energy =
[-1.18579808e+02 -1.23109808e+01 -9.56237680e+00 -9.56237680e+00
 -9.56237680e+00 -1.27074973e+00 -5.83623878e-01 -5.83623878e-01
 -5.83623878e-01  9.54294919e-01  1.01200060e+00  1.01200060e+00
  1.01200060e+00  7.26394348e+00  7.26394348e+00  7.26394348e+00
  1.28447787e+01  3.33251614e+01  3.33251614e+01  3.33251614e+01
  1.12311942e+02  1.29009035e+02  1.29009035e+02  1.29009035e+02
  4.83474431e+02  4.83474431e+02  4.83474431e+02  6.05681740e+02
  1.33500978e+03  1.33500978e+03  1.33500978e+03  2.68044846e+03
  3.02876295e+03  3.02876295e+03  3.02876295e+03  6.64885571e+03
  6.64885571e+03  6.64885571e+03  9.08573284e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2819368451321  E_coul = 201.54142774173383
cycle= 1 E= -526.740509103398  delta_E= 1.14e-13  |g|= 7.9e-08  |ddm|= 6.08e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2819368451321  E_coul = 201.54142774173383
  HOMO = -0.583623875011578  LUMO = 0.954294936102176
  mo_energy =
[-1.18579808e+02 -1.23109808e+01 -9.56237678e+00 -9.56237678e+00
 -9.56237678e+00 -1.27074971e+00 -5.83623875e-01 -5.83623875e-01
 -5.83623875e-01  9.54294936e-01  1.01200061e+00  1.01200061e+00
  1.01200061e+00  7.26394349e+00  7.26394349e+00  7.26394349e+00
  1.28447787e+01  3.33251614e+01  3.33251614e+01  3.33251614e+01
  1.12311942e+02  1.29009035e+02  1.29009035e+02  1.29009035e+02
  4.83474431e+02  4.83474431e+02  4.83474431e+02  6.05681741e+02
  1.33500978e+03  1.33500978e+03  1.33500978e+03  2.68044846e+03
  3.02876295e+03  3.02876295e+03  3.02876295e+03  6.64885571e+03
  6.64885571e+03  6.64885571e+03  9.08573284e+03  2.54399456e+04
  7.61805210e+04]
E1 = -728.2819367361275  E_coul = 201.54142763272932
Extra cycle  E= -526.740509103398  delta_E= 1.14e-13  |g|= 1.62e-08  |ddm|= 1.32e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61826684e+04 7.61749326e+03 3.61736263e+03 1.59719886e+03
 3.84322643e+02 1.12083641e+02 3.70930835e+01 8.35600569e+00
 3.26494060e+00 6.47786745e-01 2.36333022e-01 1.36278735e+03
 6.64705080e+02 3.00770619e+02 3.13877306e+02 6.17422067e+01
 7.29312484e+00 2.02661595e+01 7.75856572e-01 2.80996897e+00
 2.22161631e-01]
grad_E = [-1.53615696e-06  3.51387065e-06 -1.47787854e-06  7.73830381e-05
 -2.35456588e-04 -2.99360969e-04  7.37592942e-05  5.98324814e-04
 -9.52205251e-04  3.37367060e-04 -7.17093041e-03 -4.98658864e-07
  5.13965746e-06  2.44938371e-05  2.10979727e-05 -1.77579595e-04
 -5.20904062e-03  1.61599382e-03  6.66347017e-03  5.11359634e-03
 -1.83811034e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6799138        1
[INPUT] 0    0    [1    /1   ]  7617.46584691        1
[INPUT] 0    0    [1    /1   ]  3617.37262642        1
[INPUT] 0    0    [1    /1   ]  1596.58005122        1
[INPUT] 0    0    [1    /1   ]  386.754496771        1
[INPUT] 0    0    [1    /1   ]  112.400217054        1
[INPUT] 0    0    [1    /1   ]  37.1024066654        1
[INPUT] 0    0    [1    /1   ]  8.41199896627        1
[INPUT] 0    0    [1    /1   ]  3.2740377929         1
[INPUT] 0    0    [1    /1   ]  0.640271962692       1
[INPUT] 0    0    [1    /1   ]  0.232685771059       1
[INPUT] 1    0    [1    /1   ]  1362.79115063        1
[INPUT] 1    0    [1    /1   ]  664.668068076        1
[INPUT] 1    0    [1    /1   ]  300.596213207        1
[INPUT] 1    0    [1    /1   ]  313.726979989        1
[INPUT] 1    0    [1    /1   ]  61.849861777         1
[INPUT] 1    0    [1    /1   ]  7.26015406308        1
[INPUT] 1    0    [1    /1   ]  20.2637718085        1
[INPUT] 1    0    [1    /1   ]  0.775495673296       1
[INPUT] 1    0    [1    /1   ]  2.80399204692        1
[INPUT] 1    0    [1    /1   ]  0.221798722992       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.679913818964, 1.0]], [0, [7617.4658469102615, 1.0]], [0, [3617.3726264191555, 1.0]], [0, [1596.580051222697, 1.0]], [0, [386.7544967708231, 1.0]], [0, [112.40021705448312, 1.0]], [0, [37.102406665373465, 1.0]], [0, [8.411998966273389, 1.0]], [0, [3.2740377929027815, 1.0]], [0, [0.6402719626917401, 1.0]], [0, [0.23268577105872218, 1.0]], [1, [1362.79115062858, 1.0]], [1, [664.668068075804, 1.0]], [1, [300.59621320728667, 1.0]], [1, [313.7269799888007, 1.0]], [1, [61.84986177695975, 1.0]], [1, [7.260154063077911, 1.0]], [1, [20.2637718085141, 1.0]], [1, [0.7754956732956845, 1.0]], [1, [2.8039920469208943, 1.0]], [1, [0.22179872299151585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.67991382]
bas 1, expnt(s) = [7617.46584691]
bas 2, expnt(s) = [3617.37262642]
bas 3, expnt(s) = [1596.58005122]
bas 4, expnt(s) = [386.75449677]
bas 5, expnt(s) = [112.40021705]
bas 6, expnt(s) = [37.10240667]
bas 7, expnt(s) = [8.41199897]
bas 8, expnt(s) = [3.27403779]
bas 9, expnt(s) = [0.64027196]
bas 10, expnt(s) = [0.23268577]
bas 11, expnt(s) = [1362.79115063]
bas 12, expnt(s) = [664.66806808]
bas 13, expnt(s) = [300.59621321]
bas 14, expnt(s) = [313.72697999]
bas 15, expnt(s) = [61.84986178]
bas 16, expnt(s) = [7.26015406]
bas 17, expnt(s) = [20.26377181]
bas 18, expnt(s) = [0.77549567]
bas 19, expnt(s) = [2.80399205]
bas 20, expnt(s) = [0.22179872]
CPU time:       363.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826799e+04 5.20026645e+03 7.61746585e+03 2.06002699e+03
 3.61737263e+03 1.17844674e+03 1.59658005e+03 6.38128363e+02
 3.86754497e+02 2.20339091e+02 1.12400217e+02 8.72148397e+01
 3.71024067e+01 3.79810166e+01 8.41199897e+00 1.24792772e+01
 3.27403779e+00 6.14932987e+00 6.40271963e-01 1.80837456e+00
 2.32685771e-01 8.46432624e-01 1.36279115e+03 2.41557777e+04
 6.64668068e+02 9.84555973e+03 3.00596213e+02 3.65143668e+03
 3.13726980e+02 3.85189313e+03 6.18498618e+01 5.06008497e+02
 7.26015406e+00 3.47669576e+01 2.02637718e+01 1.25425185e+02
 7.75495673e-01 2.12304215e+00 2.80399205e+00 1.05853535e+01
 2.21798723e-01 4.44051350e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99371219591231
cond(S) = 102846.9071959311
E1 = -729.5319357106255  E_coul = 203.18000353350885
init E= -526.351932177117
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555852945622517  LUMO = 0.953936479538885
  mo_energy =
[-1.18329389e+02 -1.22046831e+01 -9.44658632e+00 -9.44658632e+00
 -9.44658632e+00 -1.24008233e+00 -5.55852946e-01 -5.55852946e-01
 -5.55852946e-01  9.53936480e-01  1.02932766e+00  1.02932766e+00
  1.02932766e+00  7.31314177e+00  7.31314177e+00  7.31314177e+00
  1.29621760e+01  3.33422202e+01  3.33422202e+01  3.33422202e+01
  1.12854576e+02  1.29145733e+02  1.29145733e+02  1.29145733e+02
  4.83783349e+02  4.83783349e+02  4.83783349e+02  6.08687378e+02
  1.33509709e+03  1.33509709e+03  1.33509709e+03  2.68831789e+03
  3.02846731e+03  3.02846731e+03  3.02846731e+03  6.64835802e+03
  6.64835802e+03  6.64835802e+03  9.09485632e+03  2.54487277e+04
  7.61887196e+04]
E1 = -727.8260870925048  E_coul = 201.0859333237393
cycle= 1 E= -526.740153768766  delta_E= -0.388  |g|= 0.186  |ddm|= 0.34
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541958
diis-c [-0.29371824  1.        ]
  HOMO = -0.591642483887027  LUMO = 0.926088455316742
  mo_energy =
[-1.18638636e+02 -1.23438864e+01 -9.59658766e+00 -9.59658766e+00
 -9.59658766e+00 -1.28040256e+00 -5.91642484e-01 -5.91642484e-01
 -5.91642484e-01  9.26088455e-01  1.00440675e+00  1.00440675e+00
  1.00440675e+00  7.22137172e+00  7.22137172e+00  7.22137172e+00
  1.28488309e+01  3.31868215e+01  3.31868215e+01  3.31868215e+01
  1.12629512e+02  1.28915660e+02  1.28915660e+02  1.28915660e+02
  4.83475381e+02  4.83475381e+02  4.83475381e+02  6.08340095e+02
  1.33473313e+03  1.33473313e+03  1.33473313e+03  2.68782022e+03
  3.02803759e+03  3.02803759e+03  3.02803759e+03  6.64781547e+03
  6.64781547e+03  6.64781547e+03  9.09423898e+03  2.54480164e+04
  7.61879183e+04]
E1 = -728.4056142223965  E_coul = 201.66472804785465
cycle= 2 E= -526.740886174542  delta_E= -0.000732  |g|= 0.0379  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755977
diis-c [-0.00333568  0.08300576  0.91699424]
  HOMO = -0.582422049886175  LUMO = 0.934021924458604
  mo_energy =
[-1.18570461e+02 -1.23054803e+01 -9.55652880e+00 -9.55652880e+00
 -9.55652880e+00 -1.26935197e+00 -5.82422050e-01 -5.82422050e-01
 -5.82422050e-01  9.34021924e-01  1.01120121e+00  1.01120121e+00
  1.01120121e+00  7.24527042e+00  7.24527042e+00  7.24527042e+00
  1.28798778e+01  3.32272026e+01  3.32272026e+01  3.32272026e+01
  1.12686225e+02  1.28972020e+02  1.28972020e+02  1.28972020e+02
  4.83542738e+02  4.83542738e+02  4.83542738e+02  6.08409926e+02
  1.33480454e+03  1.33480454e+03  1.33480454e+03  2.68789496e+03
  3.02811125e+03  3.02811125e+03  3.02811125e+03  6.64789088e+03
  6.64789088e+03  6.64789088e+03  9.09431520e+03  2.54480932e+04
  7.61879954e+04]
E1 = -728.2536053110387  E_coul = 201.51265899967484
cycle= 3 E= -526.740946311364  delta_E= -6.01e-05  |g|= 0.00632  |ddm|= 0.0166
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132384
diis-c [-6.14742657e-07 -1.24879994e-03  1.44565405e-01  8.56683395e-01]
  HOMO = -0.583941907177197  LUMO = 0.932814740453619
  mo_energy =
[-1.18580479e+02 -1.23113322e+01 -9.56272999e+00 -9.56272999e+00
 -9.56272999e+00 -1.27106068e+00 -5.83941907e-01 -5.83941907e-01
 -5.83941907e-01  9.32814740e-01  1.01010675e+00  1.01010675e+00
  1.01010675e+00  7.24147052e+00  7.24147052e+00  7.24147052e+00
  1.28751236e+01  3.32209909e+01  3.32209909e+01  3.32209909e+01
  1.12677821e+02  1.28963614e+02  1.28963614e+02  1.28963614e+02
  4.83532836e+02  4.83532836e+02  4.83532836e+02  6.08399652e+02
  1.33479405e+03  1.33479405e+03  1.33479405e+03  2.68788383e+03
  3.02810037e+03  3.02810037e+03  3.02810037e+03  6.64787960e+03
  6.64787960e+03  6.64787960e+03  9.09430371e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2765958947793  E_coul = 201.53564762629853
cycle= 4 E= -526.740948268481  delta_E= -1.96e-06  |g|= 0.000105  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122425
diis-c [-4.43150960e-09  7.89054499e-05 -1.11099092e-02 -7.22273886e-02
  1.08325839e+00]
  HOMO = -0.58392510133721  LUMO = 0.932848039501323
  mo_energy =
[-1.18580443e+02 -1.23112701e+01 -9.56268229e+00 -9.56268229e+00
 -9.56268229e+00 -1.27101931e+00 -5.83925101e-01 -5.83925101e-01
 -5.83925101e-01  9.32848040e-01  1.01012169e+00  1.01012169e+00
  1.01012169e+00  7.24150967e+00  7.24150967e+00  7.24150967e+00
  1.28751818e+01  3.32210367e+01  3.32210367e+01  3.32210367e+01
  1.12677869e+02  1.28963657e+02  1.28963657e+02  1.28963657e+02
  4.83532872e+02  4.83532872e+02  4.83532872e+02  6.08399680e+02
  1.33479407e+03  1.33479407e+03  1.33479407e+03  2.68788383e+03
  3.02810039e+03  3.02810039e+03  3.02810039e+03  6.64787960e+03
  6.64787960e+03  6.64787960e+03  9.09430370e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2763863780067  E_coul = 201.5354381074793
cycle= 5 E= -526.740948270527  delta_E= -2.05e-09  |g|= 2.13e-05  |ddm|= 0.000174
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.98328e-05
diis-c [-8.39750668e-11  1.49306049e-05 -1.91733097e-03 -1.43203970e-02
  3.85678263e-02  9.77654971e-01]
  HOMO = -0.583932901947093  LUMO = 0.932844193036331
  mo_energy =
[-1.18580475e+02 -1.23112935e+01 -9.56270761e+00 -9.56270761e+00
 -9.56270761e+00 -1.27102540e+00 -5.83932902e-01 -5.83932902e-01
 -5.83932902e-01  9.32844193e-01  1.01011654e+00  1.01011654e+00
  1.01011654e+00  7.24149250e+00  7.24149250e+00  7.24149250e+00
  1.28751626e+01  3.32210122e+01  3.32210122e+01  3.32210122e+01
  1.12677840e+02  1.28963628e+02  1.28963628e+02  1.28963628e+02
  4.83532841e+02  4.83532841e+02  4.83532841e+02  6.08399648e+02
  1.33479404e+03  1.33479404e+03  1.33479404e+03  2.68788380e+03
  3.02810035e+03  3.02810035e+03  3.02810035e+03  6.64787957e+03
  6.64787957e+03  6.64787957e+03  9.09430366e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2764700172011  E_coul = 201.535521746608
cycle= 6 E= -526.740948270593  delta_E= -6.57e-11  |g|= 1.79e-06  |ddm|= 2.03e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2764700172011  E_coul = 201.535521746608
  HOMO = -0.5839328814417  LUMO = 0.932844563227742
  mo_energy =
[-1.18580474e+02 -1.23112931e+01 -9.56270738e+00 -9.56270738e+00
 -9.56270738e+00 -1.27102497e+00 -5.83932881e-01 -5.83932881e-01
 -5.83932881e-01  9.32844563e-01  1.01011661e+00  1.01011661e+00
  1.01011661e+00  7.24149266e+00  7.24149266e+00  7.24149266e+00
  1.28751630e+01  3.32210124e+01  3.32210124e+01  3.32210124e+01
  1.12677840e+02  1.28963629e+02  1.28963629e+02  1.28963629e+02
  4.83532841e+02  4.83532841e+02  4.83532841e+02  6.08399649e+02
  1.33479404e+03  1.33479404e+03  1.33479404e+03  2.68788380e+03
  3.02810035e+03  3.02810035e+03  3.02810035e+03  6.64787957e+03
  6.64787957e+03  6.64787957e+03  9.09430366e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2764682646584  E_coul = 201.53551999406557
Extra cycle  E= -526.740948270593  delta_E= 2.27e-13  |g|= 3.73e-07  |ddm|= 3.19e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.26 sec
exp = [2.61826799e+04 7.61746585e+03 3.61737263e+03 1.59658005e+03
 3.86754497e+02 1.12400217e+02 3.71024067e+01 8.41199897e+00
 3.27403779e+00 6.40271963e-01 2.32685771e-01 1.36279115e+03
 6.64668068e+02 3.00596213e+02 3.13726980e+02 6.18498618e+01
 7.26015406e+00 2.02637718e+01 7.75495673e-01 2.80399205e+00
 2.21798723e-01]
E = -526.7409482705929
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:29 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.6799138        1
[INPUT] 0    0    [1    /1   ]  7617.46584691        1
[INPUT] 0    0    [1    /1   ]  3617.37262642        1
[INPUT] 0    0    [1    /1   ]  1596.58005122        1
[INPUT] 0    0    [1    /1   ]  386.754496771        1
[INPUT] 0    0    [1    /1   ]  112.400217054        1
[INPUT] 0    0    [1    /1   ]  37.1024066654        1
[INPUT] 0    0    [1    /1   ]  8.41199896627        1
[INPUT] 0    0    [1    /1   ]  3.2740377929         1
[INPUT] 0    0    [1    /1   ]  0.640271962692       1
[INPUT] 0    0    [1    /1   ]  0.232685771059       1
[INPUT] 1    0    [1    /1   ]  1362.79115063        1
[INPUT] 1    0    [1    /1   ]  664.668068076        1
[INPUT] 1    0    [1    /1   ]  300.596213207        1
[INPUT] 1    0    [1    /1   ]  313.726979989        1
[INPUT] 1    0    [1    /1   ]  61.849861777         1
[INPUT] 1    0    [1    /1   ]  7.26015406308        1
[INPUT] 1    0    [1    /1   ]  20.2637718085        1
[INPUT] 1    0    [1    /1   ]  0.775495673296       1
[INPUT] 1    0    [1    /1   ]  2.80399204692        1
[INPUT] 1    0    [1    /1   ]  0.221798722992       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.679913818964, 1.0]], [0, [7617.4658469102615, 1.0]], [0, [3617.3726264191555, 1.0]], [0, [1596.580051222697, 1.0]], [0, [386.7544967708231, 1.0]], [0, [112.40021705448312, 1.0]], [0, [37.102406665373465, 1.0]], [0, [8.411998966273389, 1.0]], [0, [3.2740377929027815, 1.0]], [0, [0.6402719626917401, 1.0]], [0, [0.23268577105872218, 1.0]], [1, [1362.79115062858, 1.0]], [1, [664.668068075804, 1.0]], [1, [300.59621320728667, 1.0]], [1, [313.7269799888007, 1.0]], [1, [61.84986177695975, 1.0]], [1, [7.260154063077911, 1.0]], [1, [20.2637718085141, 1.0]], [1, [0.7754956732956845, 1.0]], [1, [2.8039920469208943, 1.0]], [1, [0.22179872299151585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.67991382]
bas 1, expnt(s) = [7617.46584691]
bas 2, expnt(s) = [3617.37262642]
bas 3, expnt(s) = [1596.58005122]
bas 4, expnt(s) = [386.75449677]
bas 5, expnt(s) = [112.40021705]
bas 6, expnt(s) = [37.10240667]
bas 7, expnt(s) = [8.41199897]
bas 8, expnt(s) = [3.27403779]
bas 9, expnt(s) = [0.64027196]
bas 10, expnt(s) = [0.23268577]
bas 11, expnt(s) = [1362.79115063]
bas 12, expnt(s) = [664.66806808]
bas 13, expnt(s) = [300.59621321]
bas 14, expnt(s) = [313.72697999]
bas 15, expnt(s) = [61.84986178]
bas 16, expnt(s) = [7.26015406]
bas 17, expnt(s) = [20.26377181]
bas 18, expnt(s) = [0.77549567]
bas 19, expnt(s) = [2.80399205]
bas 20, expnt(s) = [0.22179872]
CPU time:       364.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61826799e+04 5.20026645e+03 7.61746585e+03 2.06002699e+03
 3.61737263e+03 1.17844674e+03 1.59658005e+03 6.38128363e+02
 3.86754497e+02 2.20339091e+02 1.12400217e+02 8.72148397e+01
 3.71024067e+01 3.79810166e+01 8.41199897e+00 1.24792772e+01
 3.27403779e+00 6.14932987e+00 6.40271963e-01 1.80837456e+00
 2.32685771e-01 8.46432624e-01 1.36279115e+03 2.41557777e+04
 6.64668068e+02 9.84555973e+03 3.00596213e+02 3.65143668e+03
 3.13726980e+02 3.85189313e+03 6.18498618e+01 5.06008497e+02
 7.26015406e+00 3.47669576e+01 2.02637718e+01 1.25425185e+02
 7.75495673e-01 2.12304215e+00 2.80399205e+00 1.05853535e+01
 2.21798723e-01 4.44051350e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99371219591231
cond(S) = 102846.9071959311
E1 = -729.5319357106255  E_coul = 203.18000353350885
init E= -526.351932177117
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555852945622517  LUMO = 0.953936479538885
  mo_energy =
[-1.18329389e+02 -1.22046831e+01 -9.44658632e+00 -9.44658632e+00
 -9.44658632e+00 -1.24008233e+00 -5.55852946e-01 -5.55852946e-01
 -5.55852946e-01  9.53936480e-01  1.02932766e+00  1.02932766e+00
  1.02932766e+00  7.31314177e+00  7.31314177e+00  7.31314177e+00
  1.29621760e+01  3.33422202e+01  3.33422202e+01  3.33422202e+01
  1.12854576e+02  1.29145733e+02  1.29145733e+02  1.29145733e+02
  4.83783349e+02  4.83783349e+02  4.83783349e+02  6.08687378e+02
  1.33509709e+03  1.33509709e+03  1.33509709e+03  2.68831789e+03
  3.02846731e+03  3.02846731e+03  3.02846731e+03  6.64835802e+03
  6.64835802e+03  6.64835802e+03  9.09485632e+03  2.54487277e+04
  7.61887196e+04]
E1 = -727.8260870925048  E_coul = 201.0859333237393
cycle= 1 E= -526.740153768766  delta_E= -0.388  |g|= 0.186  |ddm|= 0.34
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.541958
diis-c [-0.29371824  1.        ]
  HOMO = -0.591642483887027  LUMO = 0.926088455316742
  mo_energy =
[-1.18638636e+02 -1.23438864e+01 -9.59658766e+00 -9.59658766e+00
 -9.59658766e+00 -1.28040256e+00 -5.91642484e-01 -5.91642484e-01
 -5.91642484e-01  9.26088455e-01  1.00440675e+00  1.00440675e+00
  1.00440675e+00  7.22137172e+00  7.22137172e+00  7.22137172e+00
  1.28488309e+01  3.31868215e+01  3.31868215e+01  3.31868215e+01
  1.12629512e+02  1.28915660e+02  1.28915660e+02  1.28915660e+02
  4.83475381e+02  4.83475381e+02  4.83475381e+02  6.08340095e+02
  1.33473313e+03  1.33473313e+03  1.33473313e+03  2.68782022e+03
  3.02803759e+03  3.02803759e+03  3.02803759e+03  6.64781547e+03
  6.64781547e+03  6.64781547e+03  9.09423898e+03  2.54480164e+04
  7.61879183e+04]
E1 = -728.4056142223965  E_coul = 201.66472804785465
cycle= 2 E= -526.740886174542  delta_E= -0.000732  |g|= 0.0379  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0755977
diis-c [-0.00333568  0.08300576  0.91699424]
  HOMO = -0.582422049886175  LUMO = 0.934021924458604
  mo_energy =
[-1.18570461e+02 -1.23054803e+01 -9.55652880e+00 -9.55652880e+00
 -9.55652880e+00 -1.26935197e+00 -5.82422050e-01 -5.82422050e-01
 -5.82422050e-01  9.34021924e-01  1.01120121e+00  1.01120121e+00
  1.01120121e+00  7.24527042e+00  7.24527042e+00  7.24527042e+00
  1.28798778e+01  3.32272026e+01  3.32272026e+01  3.32272026e+01
  1.12686225e+02  1.28972020e+02  1.28972020e+02  1.28972020e+02
  4.83542738e+02  4.83542738e+02  4.83542738e+02  6.08409926e+02
  1.33480454e+03  1.33480454e+03  1.33480454e+03  2.68789496e+03
  3.02811125e+03  3.02811125e+03  3.02811125e+03  6.64789088e+03
  6.64789088e+03  6.64789088e+03  9.09431520e+03  2.54480932e+04
  7.61879954e+04]
E1 = -728.2536053110387  E_coul = 201.51265899967484
cycle= 3 E= -526.740946311364  delta_E= -6.01e-05  |g|= 0.00632  |ddm|= 0.0166
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132384
diis-c [-6.14742657e-07 -1.24879994e-03  1.44565405e-01  8.56683395e-01]
  HOMO = -0.583941907177197  LUMO = 0.932814740453619
  mo_energy =
[-1.18580479e+02 -1.23113322e+01 -9.56272999e+00 -9.56272999e+00
 -9.56272999e+00 -1.27106068e+00 -5.83941907e-01 -5.83941907e-01
 -5.83941907e-01  9.32814740e-01  1.01010675e+00  1.01010675e+00
  1.01010675e+00  7.24147052e+00  7.24147052e+00  7.24147052e+00
  1.28751236e+01  3.32209909e+01  3.32209909e+01  3.32209909e+01
  1.12677821e+02  1.28963614e+02  1.28963614e+02  1.28963614e+02
  4.83532836e+02  4.83532836e+02  4.83532836e+02  6.08399652e+02
  1.33479405e+03  1.33479405e+03  1.33479405e+03  2.68788383e+03
  3.02810037e+03  3.02810037e+03  3.02810037e+03  6.64787960e+03
  6.64787960e+03  6.64787960e+03  9.09430371e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2765958947793  E_coul = 201.53564762629853
cycle= 4 E= -526.740948268481  delta_E= -1.96e-06  |g|= 0.000105  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000122425
diis-c [-4.43150960e-09  7.89054499e-05 -1.11099092e-02 -7.22273886e-02
  1.08325839e+00]
  HOMO = -0.58392510133721  LUMO = 0.932848039501323
  mo_energy =
[-1.18580443e+02 -1.23112701e+01 -9.56268229e+00 -9.56268229e+00
 -9.56268229e+00 -1.27101931e+00 -5.83925101e-01 -5.83925101e-01
 -5.83925101e-01  9.32848040e-01  1.01012169e+00  1.01012169e+00
  1.01012169e+00  7.24150967e+00  7.24150967e+00  7.24150967e+00
  1.28751818e+01  3.32210367e+01  3.32210367e+01  3.32210367e+01
  1.12677869e+02  1.28963657e+02  1.28963657e+02  1.28963657e+02
  4.83532872e+02  4.83532872e+02  4.83532872e+02  6.08399680e+02
  1.33479407e+03  1.33479407e+03  1.33479407e+03  2.68788383e+03
  3.02810039e+03  3.02810039e+03  3.02810039e+03  6.64787960e+03
  6.64787960e+03  6.64787960e+03  9.09430370e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2763863780067  E_coul = 201.5354381074793
cycle= 5 E= -526.740948270527  delta_E= -2.05e-09  |g|= 2.13e-05  |ddm|= 0.000174
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.98328e-05
diis-c [-8.39750668e-11  1.49306049e-05 -1.91733097e-03 -1.43203970e-02
  3.85678263e-02  9.77654971e-01]
  HOMO = -0.583932901947093  LUMO = 0.932844193036331
  mo_energy =
[-1.18580475e+02 -1.23112935e+01 -9.56270761e+00 -9.56270761e+00
 -9.56270761e+00 -1.27102540e+00 -5.83932902e-01 -5.83932902e-01
 -5.83932902e-01  9.32844193e-01  1.01011654e+00  1.01011654e+00
  1.01011654e+00  7.24149250e+00  7.24149250e+00  7.24149250e+00
  1.28751626e+01  3.32210122e+01  3.32210122e+01  3.32210122e+01
  1.12677840e+02  1.28963628e+02  1.28963628e+02  1.28963628e+02
  4.83532841e+02  4.83532841e+02  4.83532841e+02  6.08399648e+02
  1.33479404e+03  1.33479404e+03  1.33479404e+03  2.68788380e+03
  3.02810035e+03  3.02810035e+03  3.02810035e+03  6.64787957e+03
  6.64787957e+03  6.64787957e+03  9.09430366e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2764700172011  E_coul = 201.535521746608
cycle= 6 E= -526.740948270593  delta_E= -6.57e-11  |g|= 1.79e-06  |ddm|= 2.03e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2764700172011  E_coul = 201.535521746608
  HOMO = -0.5839328814417  LUMO = 0.932844563227742
  mo_energy =
[-1.18580474e+02 -1.23112931e+01 -9.56270738e+00 -9.56270738e+00
 -9.56270738e+00 -1.27102497e+00 -5.83932881e-01 -5.83932881e-01
 -5.83932881e-01  9.32844563e-01  1.01011661e+00  1.01011661e+00
  1.01011661e+00  7.24149266e+00  7.24149266e+00  7.24149266e+00
  1.28751630e+01  3.32210124e+01  3.32210124e+01  3.32210124e+01
  1.12677840e+02  1.28963629e+02  1.28963629e+02  1.28963629e+02
  4.83532841e+02  4.83532841e+02  4.83532841e+02  6.08399649e+02
  1.33479404e+03  1.33479404e+03  1.33479404e+03  2.68788380e+03
  3.02810035e+03  3.02810035e+03  3.02810035e+03  6.64787957e+03
  6.64787957e+03  6.64787957e+03  9.09430366e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2764682646584  E_coul = 201.53551999406557
Extra cycle  E= -526.740948270593  delta_E= 2.27e-13  |g|= 3.73e-07  |ddm|= 3.19e-06
    CPU time for scf_cycle      0.30 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102846.9071959311
E1 = -728.2764682646584  E_coul = 201.53551999406557
init E= -526.740948270593
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.58393292912168  LUMO = 0.932844596910071
  mo_energy =
[-1.18580475e+02 -1.23112933e+01 -9.56270752e+00 -9.56270752e+00
 -9.56270752e+00 -1.27102494e+00 -5.83932929e-01 -5.83932929e-01
 -5.83932929e-01  9.32844597e-01  1.01011659e+00  1.01011659e+00
  1.01011659e+00  7.24149257e+00  7.24149257e+00  7.24149257e+00
  1.28751629e+01  3.32210123e+01  3.32210123e+01  3.32210123e+01
  1.12677840e+02  1.28963629e+02  1.28963629e+02  1.28963629e+02
  4.83532841e+02  4.83532841e+02  4.83532841e+02  6.08399648e+02
  1.33479404e+03  1.33479404e+03  1.33479404e+03  2.68788380e+03
  3.02810035e+03  3.02810035e+03  3.02810035e+03  6.64787957e+03
  6.64787957e+03  6.64787957e+03  9.09430366e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.276468620042  E_coul = 201.53552034944792
cycle= 1 E= -526.740948270594  delta_E= -1.25e-12  |g|= 8.12e-08  |ddm|= 6.15e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -728.276468620042  E_coul = 201.53552034944792
  HOMO = -0.58393292537911  LUMO = 0.932844615075109
  mo_energy =
[-1.18580475e+02 -1.23112932e+01 -9.56270750e+00 -9.56270750e+00
 -9.56270750e+00 -1.27102492e+00 -5.83932925e-01 -5.83932925e-01
 -5.83932925e-01  9.32844615e-01  1.01011659e+00  1.01011659e+00
  1.01011659e+00  7.24149258e+00  7.24149258e+00  7.24149258e+00
  1.28751629e+01  3.32210123e+01  3.32210123e+01  3.32210123e+01
  1.12677840e+02  1.28963629e+02  1.28963629e+02  1.28963629e+02
  4.83532841e+02  4.83532841e+02  4.83532841e+02  6.08399648e+02
  1.33479404e+03  1.33479404e+03  1.33479404e+03  2.68788380e+03
  3.02810035e+03  3.02810035e+03  3.02810035e+03  6.64787957e+03
  6.64787957e+03  6.64787957e+03  9.09430366e+03  2.54480815e+04
  7.61879836e+04]
E1 = -728.2764684908973  E_coul = 201.53552022030354
Extra cycle  E= -526.740948270594  delta_E= 3.41e-13  |g|= 1.68e-08  |ddm|= 1.35e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.37 sec
exp = [2.61826799e+04 7.61746585e+03 3.61737263e+03 1.59658005e+03
 3.86754497e+02 1.12400217e+02 3.71024067e+01 8.41199897e+00
 3.27403779e+00 6.40271963e-01 2.32685771e-01 1.36279115e+03
 6.64668068e+02 3.00596213e+02 3.13726980e+02 6.18498618e+01
 7.26015406e+00 2.02637718e+01 7.75495673e-01 2.80399205e+00
 2.21798723e-01]
grad_E = [-1.52114455e-06  3.34396664e-06 -1.60824301e-06  7.18422724e-05
 -1.66592659e-04 -4.39618136e-04  9.21684400e-05  9.16813381e-04
 -1.42149408e-03  5.90137131e-04 -1.10658038e-02 -5.02362995e-07
  5.11086106e-06  2.43884995e-05  2.09910160e-05 -2.24885594e-04
 -7.99397215e-03  2.38013475e-03  1.01580020e-02  7.77740852e-03
 -2.80146390e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7059041        1
[INPUT] 0    0    [1    /1   ]  7617.40425221        1
[INPUT] 0    0    [1    /1   ]  3617.39522809        1
[INPUT] 0    0    [1    /1   ]  1595.19208337        1
[INPUT] 0    0    [1    /1   ]  392.093388797        1
[INPUT] 0    0    [1    /1   ]  113.556781642        1
[INPUT] 0    0    [1    /1   ]  37.3018698987        1
[INPUT] 0    0    [1    /1   ]  8.49470744985        1
[INPUT] 0    0    [1    /1   ]  3.2927486062         1
[INPUT] 0    0    [1    /1   ]  0.633349007245       1
[INPUT] 0    0    [1    /1   ]  0.22920632164        1
[INPUT] 1    0    [1    /1   ]  1362.79970414        1
[INPUT] 1    0    [1    /1   ]  664.584688155        1
[INPUT] 1    0    [1    /1   ]  300.203305165        1
[INPUT] 1    0    [1    /1   ]  313.388318492        1
[INPUT] 1    0    [1    /1   ]  62.0944442424        1
[INPUT] 1    0    [1    /1   ]  7.21268193609        1
[INPUT] 1    0    [1    /1   ]  20.2472232023        1
[INPUT] 1    0    [1    /1   ]  0.774626458444       1
[INPUT] 1    0    [1    /1   ]  2.79341182822        1
[INPUT] 1    0    [1    /1   ]  0.221323165687       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.70590407271, 1.0]], [0, [7617.4042522123755, 1.0]], [0, [3617.3952280875096, 1.0]], [0, [1595.1920833679558, 1.0]], [0, [392.0933887973523, 1.0]], [0, [113.5567816424987, 1.0]], [0, [37.30186989868931, 1.0]], [0, [8.49470744984745, 1.0]], [0, [3.292748606196294, 1.0]], [0, [0.6333490072447957, 1.0]], [0, [0.22920632164023166, 1.0]], [1, [1362.7997041363665, 1.0]], [1, [664.5846881547649, 1.0]], [1, [300.2033051654058, 1.0]], [1, [313.388318492275, 1.0]], [1, [62.094444242365554, 1.0]], [1, [7.212681936089561, 1.0]], [1, [20.24722320228239, 1.0]], [1, [0.7746264584436122, 1.0]], [1, [2.7934118282193343, 1.0]], [1, [0.22132316568739094, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.70590407]
bas 1, expnt(s) = [7617.40425221]
bas 2, expnt(s) = [3617.39522809]
bas 3, expnt(s) = [1595.19208337]
bas 4, expnt(s) = [392.0933888]
bas 5, expnt(s) = [113.55678164]
bas 6, expnt(s) = [37.3018699]
bas 7, expnt(s) = [8.49470745]
bas 8, expnt(s) = [3.29274861]
bas 9, expnt(s) = [0.63334901]
bas 10, expnt(s) = [0.22920632]
bas 11, expnt(s) = [1362.79970414]
bas 12, expnt(s) = [664.58468815]
bas 13, expnt(s) = [300.20330517]
bas 14, expnt(s) = [313.38831849]
bas 15, expnt(s) = [62.09444424]
bas 16, expnt(s) = [7.21268194]
bas 17, expnt(s) = [20.2472232]
bas 18, expnt(s) = [0.77462646]
bas 19, expnt(s) = [2.79341183]
bas 20, expnt(s) = [0.22132317]
CPU time:       369.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827059e+04 5.20027032e+03 7.61740425e+03 2.06001450e+03
 3.61739523e+03 1.17845226e+03 1.59519208e+03 6.37712256e+02
 3.92093389e+02 2.22616404e+02 1.13556782e+02 8.78870386e+01
 3.73018699e+01 3.81340539e+01 8.49470745e+00 1.25711887e+01
 3.29274861e+00 6.17566821e+00 6.33349007e-01 1.79368983e+00
 2.29206322e-01 8.36921969e-01 1.36279970e+03 2.41559672e+04
 6.64584688e+02 9.84401590e+03 3.00203305e+02 3.64547168e+03
 3.13388318e+02 3.84669628e+03 6.20944442e+01 5.08510966e+02
 7.21268194e+00 3.44830260e+01 2.02472232e+01 1.25297161e+02
 7.74626458e-01 2.12006805e+00 2.79341183e+00 1.05354503e+01
 2.21323166e-01 4.42861559e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993755467316376
cond(S) = 101833.3193236008
E1 = -729.532379247422  E_coul = 203.1807310095384
init E= -526.351648237884
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555884287294868  LUMO = 0.934127846829245
  mo_energy =
[-1.18329944e+02 -1.22045400e+01 -9.44645348e+00 -9.44645348e+00
 -9.44645348e+00 -1.24008650e+00 -5.55884287e-01 -5.55884287e-01
 -5.55884287e-01  9.34127847e-01  1.02673806e+00  1.02673806e+00
  1.02673806e+00  7.27717712e+00  7.27717712e+00  7.27717712e+00
  1.30605582e+01  3.31754398e+01  3.31754398e+01  3.31754398e+01
  1.14092698e+02  1.29118924e+02  1.29118924e+02  1.29118924e+02
  4.83972924e+02  4.83972924e+02  4.83972924e+02  6.16347640e+02
  1.33466255e+03  1.33466255e+03  1.33466255e+03  2.70678161e+03
  3.02702275e+03  3.02702275e+03  3.02702275e+03  6.64620329e+03
  6.64620329e+03  6.64620329e+03  9.11578128e+03  2.54686059e+04
  7.62069842e+04]
E1 = -727.8196836333542  E_coul = 201.07859306796456
cycle= 1 E= -526.74109056539  delta_E= -0.389  |g|= 0.186  |ddm|= 0.348
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541621
diis-c [-0.29335366  1.        ]
  HOMO = -0.592007650868232  LUMO = 0.906435055061336
  mo_energy =
[-1.18639717e+02 -1.23442911e+01 -9.59699441e+00 -9.59699441e+00
 -9.59699441e+00 -1.28074299e+00 -5.92007651e-01 -5.92007651e-01
 -5.92007651e-01  9.06435055e-01  1.00163266e+00  1.00163266e+00
  1.00163266e+00  7.18520739e+00  7.18520739e+00  7.18520739e+00
  1.29461602e+01  3.30196851e+01  3.30196851e+01  3.30196851e+01
  1.13866268e+02  1.28888087e+02  1.28888087e+02  1.28888087e+02
  4.83664429e+02  4.83664429e+02  4.83664429e+02  6.15998663e+02
  1.33429820e+03  1.33429820e+03  1.33429820e+03  2.70628324e+03
  3.02659258e+03  3.02659258e+03  3.02659258e+03  6.64566043e+03
  6.64566043e+03  6.64566043e+03  9.11516382e+03  2.54678946e+04
  7.62061829e+04]
E1 = -728.4013317952948  E_coul = 201.65950408147586
cycle= 2 E= -526.741827713819  delta_E= -0.000737  |g|= 0.038  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0757506
diis-c [-0.00334149  0.08333109  0.91666891]
  HOMO = -0.58274830546799  LUMO = 0.914296590763801
  mo_energy =
[-1.18571366e+02 -1.23057518e+01 -9.55680262e+00 -9.55680262e+00
 -9.55680262e+00 -1.26964036e+00 -5.82748305e-01 -5.82748305e-01
 -5.82748305e-01  9.14296591e-01  1.00844219e+00  1.00844219e+00
  1.00844219e+00  7.20912245e+00  7.20912245e+00  7.20912245e+00
  1.29774853e+01  3.30601570e+01  3.30601570e+01  3.30601570e+01
  1.13923271e+02  1.28944643e+02  1.28944643e+02  1.28944643e+02
  4.83731962e+02  4.83731962e+02  4.83731962e+02  6.16068740e+02
  1.33436978e+03  1.33436978e+03  1.33436978e+03  2.70635817e+03
  3.02666642e+03  3.02666642e+03  3.02666642e+03  6.64573601e+03
  6.64573601e+03  6.64573601e+03  9.11524022e+03  2.54679716e+04
  7.62062602e+04]
E1 = -728.248673094194  E_coul = 201.506784760517
cycle= 3 E= -526.741888333677  delta_E= -6.06e-05  |g|= 0.00633  |ddm|= 0.0167
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132536
diis-c [-6.26967492e-07 -1.25081642e-03  1.44447943e-01  8.56802874e-01]
  HOMO = -0.584275546319697  LUMO = 0.913101833570429
  mo_energy =
[-1.18581401e+02 -1.23116179e+01 -9.56301853e+00 -9.56301853e+00
 -9.56301853e+00 -1.27135529e+00 -5.84275546e-01 -5.84275546e-01
 -5.84275546e-01  9.13101834e-01  1.00734494e+00  1.00734494e+00
  1.00734494e+00  7.20532145e+00  7.20532145e+00  7.20532145e+00
  1.29726952e+01  3.30539367e+01  3.30539367e+01  3.30539367e+01
  1.13914833e+02  1.28936216e+02  1.28936216e+02  1.28936216e+02
  4.83722043e+02  4.83722043e+02  4.83722043e+02  6.16058439e+02
  1.33435927e+03  1.33435927e+03  1.33435927e+03  2.70634702e+03
  3.02665552e+03  3.02665552e+03  3.02665552e+03  6.64572472e+03
  6.64572472e+03  6.64572472e+03  9.11522871e+03  2.54679599e+04
  7.62062483e+04]
E1 = -728.2717330667197  E_coul = 201.52984276394199
cycle= 4 E= -526.741890302778  delta_E= -1.97e-06  |g|= 0.000107  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012499
diis-c [-4.57166806e-09  8.07098597e-05 -1.13213158e-02 -7.36800400e-02
  1.08492065e+00]
  HOMO = -0.584259083817478  LUMO = 0.913135081724216
  mo_energy =
[-1.18581366e+02 -1.23115560e+01 -9.56297128e+00 -9.56297128e+00
 -9.56297128e+00 -1.27131357e+00 -5.84259084e-01 -5.84259084e-01
 -5.84259084e-01  9.13135082e-01  1.00735970e+00  1.00735970e+00
  1.00735970e+00  7.20536019e+00  7.20536019e+00  7.20536019e+00
  1.29727534e+01  3.30539820e+01  3.30539820e+01  3.30539820e+01
  1.13914880e+02  1.28936259e+02  1.28936259e+02  1.28936259e+02
  4.83722079e+02  4.83722079e+02  4.83722079e+02  6.16058466e+02
  1.33435930e+03  1.33435930e+03  1.33435930e+03  2.70634702e+03
  3.02665553e+03  3.02665553e+03  3.02665553e+03  6.64572472e+03
  6.64572472e+03  6.64572472e+03  9.11522870e+03  2.54679598e+04
  7.62062483e+04]
E1 = -728.271522258812  E_coul = 201.52963195385757
cycle= 5 E= -526.741890304954  delta_E= -2.18e-09  |g|= 2.16e-05  |ddm|= 0.000179
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.02572e-05
diis-c [-8.73176943e-11  1.51041731e-05 -1.93293285e-03 -1.44445466e-02
  3.68296461e-02  9.79532729e-01]
  HOMO = -0.584267029055484  LUMO = 0.91313125465608
  mo_energy =
[-1.18581398e+02 -1.23115797e+01 -9.56299697e+00 -9.56299697e+00
 -9.56299697e+00 -1.27131973e+00 -5.84267029e-01 -5.84267029e-01
 -5.84267029e-01  9.13131255e-01  1.00735446e+00  1.00735446e+00
  1.00735446e+00  7.20534279e+00  7.20534279e+00  7.20534279e+00
  1.29727339e+01  3.30539571e+01  3.30539571e+01  3.30539571e+01
  1.13914851e+02  1.28936230e+02  1.28936230e+02  1.28936230e+02
  4.83722047e+02  4.83722047e+02  4.83722047e+02  6.16058433e+02
  1.33435926e+03  1.33435926e+03  1.33435926e+03  2.70634699e+03
  3.02665550e+03  3.02665550e+03  3.02665550e+03  6.64572468e+03
  6.64572468e+03  6.64572468e+03  9.11522867e+03  2.54679598e+04
  7.62062483e+04]
E1 = -728.271606973627  E_coul = 201.52971666860512
cycle= 6 E= -526.741890305022  delta_E= -6.74e-11  |g|= 1.8e-06  |ddm|= 2.09e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.271606973627  E_coul = 201.52971666860512
  HOMO = -0.584266992394356  LUMO = 0.913131636501855
  mo_energy =
[-1.18581397e+02 -1.23115793e+01 -9.56299667e+00 -9.56299667e+00
 -9.56299667e+00 -1.27131928e+00 -5.84266992e-01 -5.84266992e-01
 -5.84266992e-01  9.13131637e-01  1.00735454e+00  1.00735454e+00
  1.00735454e+00  7.20534299e+00  7.20534299e+00  7.20534299e+00
  1.29727343e+01  3.30539574e+01  3.30539574e+01  3.30539574e+01
  1.13914852e+02  1.28936230e+02  1.28936230e+02  1.28936230e+02
  4.83722048e+02  4.83722048e+02  4.83722048e+02  6.16058434e+02
  1.33435926e+03  1.33435926e+03  1.33435926e+03  2.70634699e+03
  3.02665550e+03  3.02665550e+03  3.02665550e+03  6.64572468e+03
  6.64572468e+03  6.64572468e+03  9.11522867e+03  2.54679598e+04
  7.62062483e+04]
E1 = -728.2716049619321  E_coul = 201.52971465690788
Extra cycle  E= -526.741890305024  delta_E= -2.39e-12  |g|= 3.78e-07  |ddm|= 3.23e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61827059e+04 7.61740425e+03 3.61739523e+03 1.59519208e+03
 3.92093389e+02 1.13556782e+02 3.73018699e+01 8.49470745e+00
 3.29274861e+00 6.33349007e-01 2.29206322e-01 1.36279970e+03
 6.64584688e+02 3.00203305e+02 3.13388318e+02 6.20944442e+01
 7.21268194e+00 2.02472232e+01 7.74626458e-01 2.79341183e+00
 2.21323166e-01]
E = -526.7418903050242
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7059041        1
[INPUT] 0    0    [1    /1   ]  7617.40425221        1
[INPUT] 0    0    [1    /1   ]  3617.39522809        1
[INPUT] 0    0    [1    /1   ]  1595.19208337        1
[INPUT] 0    0    [1    /1   ]  392.093388797        1
[INPUT] 0    0    [1    /1   ]  113.556781642        1
[INPUT] 0    0    [1    /1   ]  37.3018698987        1
[INPUT] 0    0    [1    /1   ]  8.49470744985        1
[INPUT] 0    0    [1    /1   ]  3.2927486062         1
[INPUT] 0    0    [1    /1   ]  0.633349007245       1
[INPUT] 0    0    [1    /1   ]  0.22920632164        1
[INPUT] 1    0    [1    /1   ]  1362.79970414        1
[INPUT] 1    0    [1    /1   ]  664.584688155        1
[INPUT] 1    0    [1    /1   ]  300.203305165        1
[INPUT] 1    0    [1    /1   ]  313.388318492        1
[INPUT] 1    0    [1    /1   ]  62.0944442424        1
[INPUT] 1    0    [1    /1   ]  7.21268193609        1
[INPUT] 1    0    [1    /1   ]  20.2472232023        1
[INPUT] 1    0    [1    /1   ]  0.774626458444       1
[INPUT] 1    0    [1    /1   ]  2.79341182822        1
[INPUT] 1    0    [1    /1   ]  0.221323165687       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.70590407271, 1.0]], [0, [7617.4042522123755, 1.0]], [0, [3617.3952280875096, 1.0]], [0, [1595.1920833679558, 1.0]], [0, [392.0933887973523, 1.0]], [0, [113.5567816424987, 1.0]], [0, [37.30186989868931, 1.0]], [0, [8.49470744984745, 1.0]], [0, [3.292748606196294, 1.0]], [0, [0.6333490072447957, 1.0]], [0, [0.22920632164023166, 1.0]], [1, [1362.7997041363665, 1.0]], [1, [664.5846881547649, 1.0]], [1, [300.2033051654058, 1.0]], [1, [313.388318492275, 1.0]], [1, [62.094444242365554, 1.0]], [1, [7.212681936089561, 1.0]], [1, [20.24722320228239, 1.0]], [1, [0.7746264584436122, 1.0]], [1, [2.7934118282193343, 1.0]], [1, [0.22132316568739094, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.70590407]
bas 1, expnt(s) = [7617.40425221]
bas 2, expnt(s) = [3617.39522809]
bas 3, expnt(s) = [1595.19208337]
bas 4, expnt(s) = [392.0933888]
bas 5, expnt(s) = [113.55678164]
bas 6, expnt(s) = [37.3018699]
bas 7, expnt(s) = [8.49470745]
bas 8, expnt(s) = [3.29274861]
bas 9, expnt(s) = [0.63334901]
bas 10, expnt(s) = [0.22920632]
bas 11, expnt(s) = [1362.79970414]
bas 12, expnt(s) = [664.58468815]
bas 13, expnt(s) = [300.20330517]
bas 14, expnt(s) = [313.38831849]
bas 15, expnt(s) = [62.09444424]
bas 16, expnt(s) = [7.21268194]
bas 17, expnt(s) = [20.2472232]
bas 18, expnt(s) = [0.77462646]
bas 19, expnt(s) = [2.79341183]
bas 20, expnt(s) = [0.22132317]
CPU time:       370.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827059e+04 5.20027032e+03 7.61740425e+03 2.06001450e+03
 3.61739523e+03 1.17845226e+03 1.59519208e+03 6.37712256e+02
 3.92093389e+02 2.22616404e+02 1.13556782e+02 8.78870386e+01
 3.73018699e+01 3.81340539e+01 8.49470745e+00 1.25711887e+01
 3.29274861e+00 6.17566821e+00 6.33349007e-01 1.79368983e+00
 2.29206322e-01 8.36921969e-01 1.36279970e+03 2.41559672e+04
 6.64584688e+02 9.84401590e+03 3.00203305e+02 3.64547168e+03
 3.13388318e+02 3.84669628e+03 6.20944442e+01 5.08510966e+02
 7.21268194e+00 3.44830260e+01 2.02472232e+01 1.25297161e+02
 7.74626458e-01 2.12006805e+00 2.79341183e+00 1.05354503e+01
 2.21323166e-01 4.42861559e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993755467316376
cond(S) = 101833.3193236008
E1 = -729.532379247422  E_coul = 203.1807310095384
init E= -526.351648237884
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555884287294868  LUMO = 0.934127846829245
  mo_energy =
[-1.18329944e+02 -1.22045400e+01 -9.44645348e+00 -9.44645348e+00
 -9.44645348e+00 -1.24008650e+00 -5.55884287e-01 -5.55884287e-01
 -5.55884287e-01  9.34127847e-01  1.02673806e+00  1.02673806e+00
  1.02673806e+00  7.27717712e+00  7.27717712e+00  7.27717712e+00
  1.30605582e+01  3.31754398e+01  3.31754398e+01  3.31754398e+01
  1.14092698e+02  1.29118924e+02  1.29118924e+02  1.29118924e+02
  4.83972924e+02  4.83972924e+02  4.83972924e+02  6.16347640e+02
  1.33466255e+03  1.33466255e+03  1.33466255e+03  2.70678161e+03
  3.02702275e+03  3.02702275e+03  3.02702275e+03  6.64620329e+03
  6.64620329e+03  6.64620329e+03  9.11578128e+03  2.54686059e+04
  7.62069842e+04]
E1 = -727.8196836333542  E_coul = 201.07859306796456
cycle= 1 E= -526.74109056539  delta_E= -0.389  |g|= 0.186  |ddm|= 0.348
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.541621
diis-c [-0.29335366  1.        ]
  HOMO = -0.592007650868232  LUMO = 0.906435055061336
  mo_energy =
[-1.18639717e+02 -1.23442911e+01 -9.59699441e+00 -9.59699441e+00
 -9.59699441e+00 -1.28074299e+00 -5.92007651e-01 -5.92007651e-01
 -5.92007651e-01  9.06435055e-01  1.00163266e+00  1.00163266e+00
  1.00163266e+00  7.18520739e+00  7.18520739e+00  7.18520739e+00
  1.29461602e+01  3.30196851e+01  3.30196851e+01  3.30196851e+01
  1.13866268e+02  1.28888087e+02  1.28888087e+02  1.28888087e+02
  4.83664429e+02  4.83664429e+02  4.83664429e+02  6.15998663e+02
  1.33429820e+03  1.33429820e+03  1.33429820e+03  2.70628324e+03
  3.02659258e+03  3.02659258e+03  3.02659258e+03  6.64566043e+03
  6.64566043e+03  6.64566043e+03  9.11516382e+03  2.54678946e+04
  7.62061829e+04]
E1 = -728.4013317952948  E_coul = 201.65950408147586
cycle= 2 E= -526.741827713819  delta_E= -0.000737  |g|= 0.038  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0757506
diis-c [-0.00334149  0.08333109  0.91666891]
  HOMO = -0.58274830546799  LUMO = 0.914296590763801
  mo_energy =
[-1.18571366e+02 -1.23057518e+01 -9.55680262e+00 -9.55680262e+00
 -9.55680262e+00 -1.26964036e+00 -5.82748305e-01 -5.82748305e-01
 -5.82748305e-01  9.14296591e-01  1.00844219e+00  1.00844219e+00
  1.00844219e+00  7.20912245e+00  7.20912245e+00  7.20912245e+00
  1.29774853e+01  3.30601570e+01  3.30601570e+01  3.30601570e+01
  1.13923271e+02  1.28944643e+02  1.28944643e+02  1.28944643e+02
  4.83731962e+02  4.83731962e+02  4.83731962e+02  6.16068740e+02
  1.33436978e+03  1.33436978e+03  1.33436978e+03  2.70635817e+03
  3.02666642e+03  3.02666642e+03  3.02666642e+03  6.64573601e+03
  6.64573601e+03  6.64573601e+03  9.11524022e+03  2.54679716e+04
  7.62062602e+04]
E1 = -728.248673094194  E_coul = 201.506784760517
cycle= 3 E= -526.741888333677  delta_E= -6.06e-05  |g|= 0.00633  |ddm|= 0.0167
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132536
diis-c [-6.26967492e-07 -1.25081642e-03  1.44447943e-01  8.56802874e-01]
  HOMO = -0.584275546319697  LUMO = 0.913101833570429
  mo_energy =
[-1.18581401e+02 -1.23116179e+01 -9.56301853e+00 -9.56301853e+00
 -9.56301853e+00 -1.27135529e+00 -5.84275546e-01 -5.84275546e-01
 -5.84275546e-01  9.13101834e-01  1.00734494e+00  1.00734494e+00
  1.00734494e+00  7.20532145e+00  7.20532145e+00  7.20532145e+00
  1.29726952e+01  3.30539367e+01  3.30539367e+01  3.30539367e+01
  1.13914833e+02  1.28936216e+02  1.28936216e+02  1.28936216e+02
  4.83722043e+02  4.83722043e+02  4.83722043e+02  6.16058439e+02
  1.33435927e+03  1.33435927e+03  1.33435927e+03  2.70634702e+03
  3.02665552e+03  3.02665552e+03  3.02665552e+03  6.64572472e+03
  6.64572472e+03  6.64572472e+03  9.11522871e+03  2.54679599e+04
  7.62062483e+04]
E1 = -728.2717330667197  E_coul = 201.52984276394199
cycle= 4 E= -526.741890302778  delta_E= -1.97e-06  |g|= 0.000107  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00012499
diis-c [-4.57166806e-09  8.07098597e-05 -1.13213158e-02 -7.36800400e-02
  1.08492065e+00]
  HOMO = -0.584259083817478  LUMO = 0.913135081724216
  mo_energy =
[-1.18581366e+02 -1.23115560e+01 -9.56297128e+00 -9.56297128e+00
 -9.56297128e+00 -1.27131357e+00 -5.84259084e-01 -5.84259084e-01
 -5.84259084e-01  9.13135082e-01  1.00735970e+00  1.00735970e+00
  1.00735970e+00  7.20536019e+00  7.20536019e+00  7.20536019e+00
  1.29727534e+01  3.30539820e+01  3.30539820e+01  3.30539820e+01
  1.13914880e+02  1.28936259e+02  1.28936259e+02  1.28936259e+02
  4.83722079e+02  4.83722079e+02  4.83722079e+02  6.16058466e+02
  1.33435930e+03  1.33435930e+03  1.33435930e+03  2.70634702e+03
  3.02665553e+03  3.02665553e+03  3.02665553e+03  6.64572472e+03
  6.64572472e+03  6.64572472e+03  9.11522870e+03  2.54679598e+04
  7.62062483e+04]
E1 = -728.271522258812  E_coul = 201.52963195385757
cycle= 5 E= -526.741890304954  delta_E= -2.18e-09  |g|= 2.16e-05  |ddm|= 0.000179
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.02572e-05
diis-c [-8.73176943e-11  1.51041731e-05 -1.93293285e-03 -1.44445466e-02
  3.68296461e-02  9.79532729e-01]
  HOMO = -0.584267029055484  LUMO = 0.91313125465608
  mo_energy =
[-1.18581398e+02 -1.23115797e+01 -9.56299697e+00 -9.56299697e+00
 -9.56299697e+00 -1.27131973e+00 -5.84267029e-01 -5.84267029e-01
 -5.84267029e-01  9.13131255e-01  1.00735446e+00  1.00735446e+00
  1.00735446e+00  7.20534279e+00  7.20534279e+00  7.20534279e+00
  1.29727339e+01  3.30539571e+01  3.30539571e+01  3.30539571e+01
  1.13914851e+02  1.28936230e+02  1.28936230e+02  1.28936230e+02
  4.83722047e+02  4.83722047e+02  4.83722047e+02  6.16058433e+02
  1.33435926e+03  1.33435926e+03  1.33435926e+03  2.70634699e+03
  3.02665550e+03  3.02665550e+03  3.02665550e+03  6.64572468e+03
  6.64572468e+03  6.64572468e+03  9.11522867e+03  2.54679598e+04
  7.62062483e+04]
E1 = -728.271606973627  E_coul = 201.52971666860512
cycle= 6 E= -526.741890305022  delta_E= -6.74e-11  |g|= 1.8e-06  |ddm|= 2.09e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.271606973627  E_coul = 201.52971666860512
  HOMO = -0.584266992394356  LUMO = 0.913131636501855
  mo_energy =
[-1.18581397e+02 -1.23115793e+01 -9.56299667e+00 -9.56299667e+00
 -9.56299667e+00 -1.27131928e+00 -5.84266992e-01 -5.84266992e-01
 -5.84266992e-01  9.13131637e-01  1.00735454e+00  1.00735454e+00
  1.00735454e+00  7.20534299e+00  7.20534299e+00  7.20534299e+00
  1.29727343e+01  3.30539574e+01  3.30539574e+01  3.30539574e+01
  1.13914852e+02  1.28936230e+02  1.28936230e+02  1.28936230e+02
  4.83722048e+02  4.83722048e+02  4.83722048e+02  6.16058434e+02
  1.33435926e+03  1.33435926e+03  1.33435926e+03  2.70634699e+03
  3.02665550e+03  3.02665550e+03  3.02665550e+03  6.64572468e+03
  6.64572468e+03  6.64572468e+03  9.11522867e+03  2.54679598e+04
  7.62062483e+04]
E1 = -728.2716049619321  E_coul = 201.52971465690788
Extra cycle  E= -526.741890305024  delta_E= -2.39e-12  |g|= 3.78e-07  |ddm|= 3.23e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 101833.3193236008
E1 = -728.2716049619321  E_coul = 201.52971465690788
init E= -526.741890305024
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.584267045660609  LUMO = 0.913131666060554
  mo_energy =
[-1.18581397e+02 -1.23115795e+01 -9.56299683e+00 -9.56299683e+00
 -9.56299683e+00 -1.27131926e+00 -5.84267046e-01 -5.84267046e-01
 -5.84267046e-01  9.13131666e-01  1.00735452e+00  1.00735452e+00
  1.00735452e+00  7.20534289e+00  7.20534289e+00  7.20534289e+00
  1.29727342e+01  3.30539572e+01  3.30539572e+01  3.30539572e+01
  1.13914852e+02  1.28936230e+02  1.28936230e+02  1.28936230e+02
  4.83722047e+02  4.83722047e+02  4.83722047e+02  6.16058434e+02
  1.33435926e+03  1.33435926e+03  1.33435926e+03  2.70634699e+03
  3.02665550e+03  3.02665550e+03  3.02665550e+03  6.64572468e+03
  6.64572468e+03  6.64572468e+03  9.11522867e+03  2.54679598e+04
  7.62062483e+04]
E1 = -728.2716053843576  E_coul = 201.52971507933353
cycle= 1 E= -526.741890305024  delta_E= 1.14e-13  |g|= 8.34e-08  |ddm|= 6.19e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2716053843576  E_coul = 201.52971507933353
  HOMO = -0.584267040764101  LUMO = 0.913131685154521
  mo_energy =
[-1.18581397e+02 -1.23115794e+01 -9.56299681e+00 -9.56299681e+00
 -9.56299681e+00 -1.27131924e+00 -5.84267041e-01 -5.84267041e-01
 -5.84267041e-01  9.13131685e-01  1.00735452e+00  1.00735452e+00
  1.00735452e+00  7.20534291e+00  7.20534291e+00  7.20534291e+00
  1.29727343e+01  3.30539573e+01  3.30539573e+01  3.30539573e+01
  1.13914852e+02  1.28936230e+02  1.28936230e+02  1.28936230e+02
  4.83722047e+02  4.83722047e+02  4.83722047e+02  6.16058434e+02
  1.33435926e+03  1.33435926e+03  1.33435926e+03  2.70634699e+03
  3.02665550e+03  3.02665550e+03  3.02665550e+03  6.64572468e+03
  6.64572468e+03  6.64572468e+03  9.11522867e+03  2.54679598e+04
  7.62062483e+04]
E1 = -728.2716052347338  E_coul = 201.52971492970943
Extra cycle  E= -526.741890305024  delta_E= -2.27e-13  |g|= 1.75e-08  |ddm|= 1.38e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61827059e+04 7.61740425e+03 3.61739523e+03 1.59519208e+03
 3.92093389e+02 1.13556782e+02 3.73018699e+01 8.49470745e+00
 3.29274861e+00 6.33349007e-01 2.29206322e-01 1.36279970e+03
 6.64584688e+02 3.00203305e+02 3.13388318e+02 6.20944442e+01
 7.21268194e+00 2.02472232e+01 7.74626458e-01 2.79341183e+00
 2.21323166e-01]
grad_E = [-1.49296335e-06  3.04160051e-06 -1.81032359e-06  6.22662191e-05
 -7.01235698e-05 -5.68344226e-04  9.32876091e-05  1.24978513e-03
 -1.83768167e-03  1.11245985e-03 -1.57319157e-02 -5.22739315e-07
  4.87678190e-06  2.31179626e-05  1.98651088e-05 -2.09076419e-04
 -1.10043538e-02  3.03547467e-03  1.38495413e-02  1.06058301e-02
 -3.81313764e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7521542        1
[INPUT] 0    0    [1    /1   ]  7617.2947952         1
[INPUT] 0    0    [1    /1   ]  3617.43558267        1
[INPUT] 0    0    [1    /1   ]  1592.72844474        1
[INPUT] 0    0    [1    /1   ]  401.426909203        1
[INPUT] 0    0    [1    /1   ]  116.160680638        1
[INPUT] 0    0    [1    /1   ]  37.8802067398        1
[INPUT] 0    0    [1    /1   ]  8.57514883534        1
[INPUT] 0    0    [1    /1   ]  3.32064992972        1
[INPUT] 0    0    [1    /1   ]  0.633583093733       1
[INPUT] 0    0    [1    /1   ]  0.229365732185       1
[INPUT] 1    0    [1    /1   ]  1362.81492929        1
[INPUT] 1    0    [1    /1   ]  664.436240525        1
[INPUT] 1    0    [1    /1   ]  299.503769207        1
[INPUT] 1    0    [1    /1   ]  312.785360957        1
[INPUT] 1    0    [1    /1   ]  62.5322797551        1
[INPUT] 1    0    [1    /1   ]  7.1625339982         1
[INPUT] 1    0    [1    /1   ]  20.2041320858        1
[INPUT] 1    0    [1    /1   ]  0.772781336689       1
[INPUT] 1    0    [1    /1   ]  2.77650180454        1
[INPUT] 1    0    [1    /1   ]  0.220883529763       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.75215420026, 1.0]], [0, [7617.294795196739, 1.0]], [0, [3617.4355826686106, 1.0]], [0, [1592.7284447375953, 1.0]], [0, [401.42690920333683, 1.0]], [0, [116.16068063806028, 1.0]], [0, [37.880206739764965, 1.0]], [0, [8.57514883533631, 1.0]], [0, [3.3206499297160974, 1.0]], [0, [0.6335830937333973, 1.0]], [0, [0.229365732185458, 1.0]], [1, [1362.814929292474, 1.0]], [1, [664.4362405253372, 1.0]], [1, [299.5037692067192, 1.0]], [1, [312.7853609572227, 1.0]], [1, [62.532279755116, 1.0]], [1, [7.16253399819994, 1.0]], [1, [20.204132085759717, 1.0]], [1, [0.7727813366889392, 1.0]], [1, [2.776501804541477, 1.0]], [1, [0.22088352976292405, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.7521542]
bas 1, expnt(s) = [7617.2947952]
bas 2, expnt(s) = [3617.43558267]
bas 3, expnt(s) = [1592.72844474]
bas 4, expnt(s) = [401.4269092]
bas 5, expnt(s) = [116.16068064]
bas 6, expnt(s) = [37.88020674]
bas 7, expnt(s) = [8.57514884]
bas 8, expnt(s) = [3.32064993]
bas 9, expnt(s) = [0.63358309]
bas 10, expnt(s) = [0.22936573]
bas 11, expnt(s) = [1362.81492929]
bas 12, expnt(s) = [664.43624053]
bas 13, expnt(s) = [299.50376921]
bas 14, expnt(s) = [312.78536096]
bas 15, expnt(s) = [62.53227976]
bas 16, expnt(s) = [7.162534]
bas 17, expnt(s) = [20.20413209]
bas 18, expnt(s) = [0.77278134]
bas 19, expnt(s) = [2.7765018]
bas 20, expnt(s) = [0.22088353]
CPU time:       376.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827522e+04 5.20027721e+03 7.61729480e+03 2.05999230e+03
 3.61743558e+03 1.17846212e+03 1.59272844e+03 6.36973444e+02
 4.01426909e+02 2.26579120e+02 1.16160681e+02 8.93942089e+01
 3.78802067e+01 3.85766295e+01 8.57514884e+00 1.26603664e+01
 3.32064993e+00 6.21487423e+00 6.33583094e-01 1.79418702e+00
 2.29365732e-01 8.37358483e-01 1.36281493e+03 2.41563045e+04
 6.64436241e+02 9.84126741e+03 2.99503769e+02 3.63485640e+03
 3.12785361e+02 3.83744723e+03 6.25322798e+01 5.12996876e+02
 7.16253400e+00 3.41835973e+01 2.02041321e+01 1.24963920e+02
 7.72781337e-01 2.11375756e+00 2.77650180e+00 1.04557898e+01
 2.20883530e-01 4.41762208e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993796975882823
cond(S) = 100132.08667084301
E1 = -729.532972859007  E_coul = 203.1814316737865
init E= -526.351541185221
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555903521619089  LUMO = 0.936088675639884
  mo_energy =
[-1.18330784e+02 -1.22044108e+01 -9.44634413e+00 -9.44634413e+00
 -9.44634413e+00 -1.24007405e+00 -5.55903522e-01 -5.55903522e-01
 -5.55903522e-01  9.36088676e-01  1.02341020e+00  1.02341020e+00
  1.02341020e+00  7.22724677e+00  7.22724677e+00  7.22724677e+00
  1.32529298e+01  3.29580155e+01  3.29580155e+01  3.29580155e+01
  1.16761712e+02  1.29160293e+02  1.29160293e+02  1.29160293e+02
  4.84377741e+02  4.84377741e+02  4.84377741e+02  6.31811510e+02
  1.33394968e+03  1.33394968e+03  1.33394968e+03  2.74160185e+03
  3.02450800e+03  3.02450800e+03  3.02450800e+03  6.64242067e+03
  6.64242067e+03  6.64242067e+03  9.15495908e+03  2.55058901e+04
  7.62412950e+04]
E1 = -727.8199074624063  E_coul = 201.07726558188165
cycle= 1 E= -526.742641880525  delta_E= -0.391  |g|= 0.186  |ddm|= 0.332
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540797
diis-c [-0.29246135  1.        ]
  HOMO = -0.592150410021558  LUMO = 0.908197086297172
  mo_energy =
[-1.18640547e+02 -1.23443273e+01 -9.59699971e+00 -9.59699971e+00
 -9.59699971e+00 -1.28087300e+00 -5.92150410e-01 -5.92150410e-01
 -5.92150410e-01  9.08197086e-01  9.98309077e-01  9.98309077e-01
  9.98309077e-01  7.13548289e+00  7.13548289e+00  7.13548289e+00
  1.31375509e+01  3.28023808e+01  3.28023808e+01  3.28023808e+01
  1.16533487e+02  1.28929035e+02  1.28929035e+02  1.28929035e+02
  4.84069296e+02  4.84069296e+02  4.84069296e+02  6.31460423e+02
  1.33358561e+03  1.33358561e+03  1.33358561e+03  2.74110343e+03
  3.02407815e+03  3.02407815e+03  3.02407815e+03  6.64187839e+03
  6.64187839e+03  6.64187839e+03  9.15434260e+03  2.55051799e+04
  7.62404949e+04]
E1 = -728.4022549263705  E_coul = 201.65887514896554
cycle= 2 E= -526.743379777405  delta_E= -0.000738  |g|= 0.038  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.075713
diis-c [-0.00333586  0.08344734  0.91655266]
  HOMO = -0.582874977704102  LUMO = 0.916095768266654
  mo_energy =
[-1.18572157e+02 -1.23057435e+01 -9.55676305e+00 -9.55676305e+00
 -9.55676305e+00 -1.26974957e+00 -5.82874978e-01 -5.82874978e-01
 -5.82874978e-01  9.16095768e-01  1.00510586e+00  1.00510586e+00
  1.00510586e+00  7.15933511e+00  7.15933511e+00  7.15933511e+00
  1.31691312e+01  3.28428424e+01  3.28428424e+01  3.28428424e+01
  1.16590827e+02  1.28985693e+02  1.28985693e+02  1.28985693e+02
  4.84136870e+02  4.84136870e+02  4.84136870e+02  6.31530673e+02
  1.33365722e+03  1.33365722e+03  1.33365722e+03  2.74117841e+03
  3.02415202e+03  3.02415202e+03  3.02415202e+03  6.64195402e+03
  6.64195402e+03  6.64195402e+03  9.15441904e+03  2.55052569e+04
  7.62405722e+04]
E1 = -728.2493051213683  E_coul = 201.5058645470983
cycle= 3 E= -526.74344057427  delta_E= -6.08e-05  |g|= 0.00633  |ddm|= 0.0167
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132495
diis-c [-6.23201644e-07 -1.24748995e-03  1.44486707e-01  8.56760783e-01]
  HOMO = -0.584405972626957  LUMO = 0.914894420793843
  mo_energy =
[-1.18582201e+02 -1.23116185e+01 -9.56298743e+00 -9.56298743e+00
 -9.56298743e+00 -1.27146879e+00 -5.84405973e-01 -5.84405973e-01
 -5.84405973e-01  9.14894421e-01  1.00400988e+00  1.00400988e+00
  1.00400988e+00  7.15554193e+00  7.15554193e+00  7.15554193e+00
  1.31643017e+01  3.28366213e+01  3.28366213e+01  3.28366213e+01
  1.16582339e+02  1.28977249e+02  1.28977249e+02  1.28977249e+02
  4.84126942e+02  4.84126942e+02  4.84126942e+02  6.31520342e+02
  1.33364671e+03  1.33364671e+03  1.33364671e+03  2.74116725e+03
  3.02414111e+03  3.02414111e+03  3.02414111e+03  6.64194271e+03
  6.64194271e+03  6.64194271e+03  9.15440753e+03  2.55052452e+04
  7.62405604e+04]
E1 = -728.2724175865504  E_coul = 201.52897503579086
cycle= 4 E= -526.74344255076  delta_E= -1.98e-06  |g|= 0.000107  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000124488
diis-c [-4.59989058e-09  8.01595855e-05 -1.12672620e-02 -7.32977317e-02
  1.08448483e+00]
  HOMO = -0.584389429631411  LUMO = 0.914927858637049
  mo_energy =
[-1.18582166e+02 -1.23115563e+01 -9.56293978e+00 -9.56293978e+00
 -9.56293978e+00 -1.27142691e+00 -5.84389430e-01 -5.84389430e-01
 -5.84389430e-01  9.14927859e-01  1.00402467e+00  1.00402467e+00
  1.00402467e+00  7.15558083e+00  7.15558083e+00  7.15558083e+00
  1.31643603e+01  3.28366670e+01  3.28366670e+01  3.28366670e+01
  1.16582386e+02  1.28977292e+02  1.28977292e+02  1.28977292e+02
  4.84126977e+02  4.84126977e+02  4.84126977e+02  6.31520369e+02
  1.33364673e+03  1.33364673e+03  1.33364673e+03  2.74116725e+03
  3.02414112e+03  3.02414112e+03  3.02414112e+03  6.64194272e+03
  6.64194272e+03  6.64194272e+03  9.15440752e+03  2.55052452e+04
  7.62405604e+04]
E1 = -728.2722052867177  E_coul = 201.52876273376683
cycle= 5 E= -526.743442552951  delta_E= -2.19e-09  |g|= 2.17e-05  |ddm|= 0.00018
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.04008e-05
diis-c [-8.70822368e-11  1.51731151e-05 -1.94448062e-03 -1.45161374e-02
  3.59167496e-02  9.80528695e-01]
  HOMO = -0.584397394211485  LUMO = 0.914924023605875
  mo_energy =
[-1.18582198e+02 -1.23115800e+01 -9.56296553e+00 -9.56296553e+00
 -9.56296553e+00 -1.27143306e+00 -5.84397394e-01 -5.84397394e-01
 -5.84397394e-01  9.14924024e-01  1.00401944e+00  1.00401944e+00
  1.00401944e+00  7.15556345e+00  7.15556345e+00  7.15556345e+00
  1.31643407e+01  3.28366420e+01  3.28366420e+01  3.28366420e+01
  1.16582357e+02  1.28977263e+02  1.28977263e+02  1.28977263e+02
  4.84126946e+02  4.84126946e+02  4.84126946e+02  6.31520336e+02
  1.33364670e+03  1.33364670e+03  1.33364670e+03  2.74116722e+03
  3.02414109e+03  3.02414109e+03  3.02414109e+03  6.64194268e+03
  6.64194268e+03  6.64194268e+03  9.15440748e+03  2.55052451e+04
  7.62405604e+04]
E1 = -728.2722903638467  E_coul = 201.52884781082753
cycle= 6 E= -526.743442553019  delta_E= -6.82e-11  |g|= 1.8e-06  |ddm|= 2.1e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2722903638467  E_coul = 201.52884781082753
  HOMO = -0.584397353286091  LUMO = 0.914924408046513
  mo_energy =
[-1.18582197e+02 -1.23115796e+01 -9.56296522e+00 -9.56296522e+00
 -9.56296522e+00 -1.27143261e+00 -5.84397353e-01 -5.84397353e-01
 -5.84397353e-01  9.14924408e-01  1.00401953e+00  1.00401953e+00
  1.00401953e+00  7.15556366e+00  7.15556366e+00  7.15556366e+00
  1.31643411e+01  3.28366424e+01  3.28366424e+01  3.28366424e+01
  1.16582358e+02  1.28977264e+02  1.28977264e+02  1.28977264e+02
  4.84126946e+02  4.84126946e+02  4.84126946e+02  6.31520337e+02
  1.33364670e+03  1.33364670e+03  1.33364670e+03  2.74116722e+03
  3.02414109e+03  3.02414109e+03  3.02414109e+03  6.64194268e+03
  6.64194268e+03  6.64194268e+03  9.15440748e+03  2.55052451e+04
  7.62405604e+04]
E1 = -728.2722883308888  E_coul = 201.52884577786858
Extra cycle  E= -526.74344255302  delta_E= -1.14e-12  |g|= 3.76e-07  |ddm|= 3.21e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61827522e+04 7.61729480e+03 3.61743558e+03 1.59272844e+03
 4.01426909e+02 1.16160681e+02 3.78802067e+01 8.57514884e+00
 3.32064993e+00 6.33583094e-01 2.29365732e-01 1.36281493e+03
 6.64436241e+02 2.99503769e+02 3.12785361e+02 6.25322798e+01
 7.16253400e+00 2.02041321e+01 7.72781337e-01 2.77650180e+00
 2.20883530e-01]
E = -526.7434425530203
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.7521542        1
[INPUT] 0    0    [1    /1   ]  7617.2947952         1
[INPUT] 0    0    [1    /1   ]  3617.43558267        1
[INPUT] 0    0    [1    /1   ]  1592.72844474        1
[INPUT] 0    0    [1    /1   ]  401.426909203        1
[INPUT] 0    0    [1    /1   ]  116.160680638        1
[INPUT] 0    0    [1    /1   ]  37.8802067398        1
[INPUT] 0    0    [1    /1   ]  8.57514883534        1
[INPUT] 0    0    [1    /1   ]  3.32064992972        1
[INPUT] 0    0    [1    /1   ]  0.633583093733       1
[INPUT] 0    0    [1    /1   ]  0.229365732185       1
[INPUT] 1    0    [1    /1   ]  1362.81492929        1
[INPUT] 1    0    [1    /1   ]  664.436240525        1
[INPUT] 1    0    [1    /1   ]  299.503769207        1
[INPUT] 1    0    [1    /1   ]  312.785360957        1
[INPUT] 1    0    [1    /1   ]  62.5322797551        1
[INPUT] 1    0    [1    /1   ]  7.1625339982         1
[INPUT] 1    0    [1    /1   ]  20.2041320858        1
[INPUT] 1    0    [1    /1   ]  0.772781336689       1
[INPUT] 1    0    [1    /1   ]  2.77650180454        1
[INPUT] 1    0    [1    /1   ]  0.220883529763       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.75215420026, 1.0]], [0, [7617.294795196739, 1.0]], [0, [3617.4355826686106, 1.0]], [0, [1592.7284447375953, 1.0]], [0, [401.42690920333683, 1.0]], [0, [116.16068063806028, 1.0]], [0, [37.880206739764965, 1.0]], [0, [8.57514883533631, 1.0]], [0, [3.3206499297160974, 1.0]], [0, [0.6335830937333973, 1.0]], [0, [0.229365732185458, 1.0]], [1, [1362.814929292474, 1.0]], [1, [664.4362405253372, 1.0]], [1, [299.5037692067192, 1.0]], [1, [312.7853609572227, 1.0]], [1, [62.532279755116, 1.0]], [1, [7.16253399819994, 1.0]], [1, [20.204132085759717, 1.0]], [1, [0.7727813366889392, 1.0]], [1, [2.776501804541477, 1.0]], [1, [0.22088352976292405, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.7521542]
bas 1, expnt(s) = [7617.2947952]
bas 2, expnt(s) = [3617.43558267]
bas 3, expnt(s) = [1592.72844474]
bas 4, expnt(s) = [401.4269092]
bas 5, expnt(s) = [116.16068064]
bas 6, expnt(s) = [37.88020674]
bas 7, expnt(s) = [8.57514884]
bas 8, expnt(s) = [3.32064993]
bas 9, expnt(s) = [0.63358309]
bas 10, expnt(s) = [0.22936573]
bas 11, expnt(s) = [1362.81492929]
bas 12, expnt(s) = [664.43624053]
bas 13, expnt(s) = [299.50376921]
bas 14, expnt(s) = [312.78536096]
bas 15, expnt(s) = [62.53227976]
bas 16, expnt(s) = [7.162534]
bas 17, expnt(s) = [20.20413209]
bas 18, expnt(s) = [0.77278134]
bas 19, expnt(s) = [2.7765018]
bas 20, expnt(s) = [0.22088353]
CPU time:       376.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61827522e+04 5.20027721e+03 7.61729480e+03 2.05999230e+03
 3.61743558e+03 1.17846212e+03 1.59272844e+03 6.36973444e+02
 4.01426909e+02 2.26579120e+02 1.16160681e+02 8.93942089e+01
 3.78802067e+01 3.85766295e+01 8.57514884e+00 1.26603664e+01
 3.32064993e+00 6.21487423e+00 6.33583094e-01 1.79418702e+00
 2.29365732e-01 8.37358483e-01 1.36281493e+03 2.41563045e+04
 6.64436241e+02 9.84126741e+03 2.99503769e+02 3.63485640e+03
 3.12785361e+02 3.83744723e+03 6.25322798e+01 5.12996876e+02
 7.16253400e+00 3.41835973e+01 2.02041321e+01 1.24963920e+02
 7.72781337e-01 2.11375756e+00 2.77650180e+00 1.04557898e+01
 2.20883530e-01 4.41762208e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993796975882823
cond(S) = 100132.08667084301
E1 = -729.532972859007  E_coul = 203.1814316737865
init E= -526.351541185221
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555903521619089  LUMO = 0.936088675639884
  mo_energy =
[-1.18330784e+02 -1.22044108e+01 -9.44634413e+00 -9.44634413e+00
 -9.44634413e+00 -1.24007405e+00 -5.55903522e-01 -5.55903522e-01
 -5.55903522e-01  9.36088676e-01  1.02341020e+00  1.02341020e+00
  1.02341020e+00  7.22724677e+00  7.22724677e+00  7.22724677e+00
  1.32529298e+01  3.29580155e+01  3.29580155e+01  3.29580155e+01
  1.16761712e+02  1.29160293e+02  1.29160293e+02  1.29160293e+02
  4.84377741e+02  4.84377741e+02  4.84377741e+02  6.31811510e+02
  1.33394968e+03  1.33394968e+03  1.33394968e+03  2.74160185e+03
  3.02450800e+03  3.02450800e+03  3.02450800e+03  6.64242067e+03
  6.64242067e+03  6.64242067e+03  9.15495908e+03  2.55058901e+04
  7.62412950e+04]
E1 = -727.8199074624063  E_coul = 201.07726558188165
cycle= 1 E= -526.742641880525  delta_E= -0.391  |g|= 0.186  |ddm|= 0.332
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.540797
diis-c [-0.29246135  1.        ]
  HOMO = -0.592150410021558  LUMO = 0.908197086297172
  mo_energy =
[-1.18640547e+02 -1.23443273e+01 -9.59699971e+00 -9.59699971e+00
 -9.59699971e+00 -1.28087300e+00 -5.92150410e-01 -5.92150410e-01
 -5.92150410e-01  9.08197086e-01  9.98309077e-01  9.98309077e-01
  9.98309077e-01  7.13548289e+00  7.13548289e+00  7.13548289e+00
  1.31375509e+01  3.28023808e+01  3.28023808e+01  3.28023808e+01
  1.16533487e+02  1.28929035e+02  1.28929035e+02  1.28929035e+02
  4.84069296e+02  4.84069296e+02  4.84069296e+02  6.31460423e+02
  1.33358561e+03  1.33358561e+03  1.33358561e+03  2.74110343e+03
  3.02407815e+03  3.02407815e+03  3.02407815e+03  6.64187839e+03
  6.64187839e+03  6.64187839e+03  9.15434260e+03  2.55051799e+04
  7.62404949e+04]
E1 = -728.4022549263705  E_coul = 201.65887514896554
cycle= 2 E= -526.743379777405  delta_E= -0.000738  |g|= 0.038  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.075713
diis-c [-0.00333586  0.08344734  0.91655266]
  HOMO = -0.582874977704102  LUMO = 0.916095768266654
  mo_energy =
[-1.18572157e+02 -1.23057435e+01 -9.55676305e+00 -9.55676305e+00
 -9.55676305e+00 -1.26974957e+00 -5.82874978e-01 -5.82874978e-01
 -5.82874978e-01  9.16095768e-01  1.00510586e+00  1.00510586e+00
  1.00510586e+00  7.15933511e+00  7.15933511e+00  7.15933511e+00
  1.31691312e+01  3.28428424e+01  3.28428424e+01  3.28428424e+01
  1.16590827e+02  1.28985693e+02  1.28985693e+02  1.28985693e+02
  4.84136870e+02  4.84136870e+02  4.84136870e+02  6.31530673e+02
  1.33365722e+03  1.33365722e+03  1.33365722e+03  2.74117841e+03
  3.02415202e+03  3.02415202e+03  3.02415202e+03  6.64195402e+03
  6.64195402e+03  6.64195402e+03  9.15441904e+03  2.55052569e+04
  7.62405722e+04]
E1 = -728.2493051213683  E_coul = 201.5058645470983
cycle= 3 E= -526.74344057427  delta_E= -6.08e-05  |g|= 0.00633  |ddm|= 0.0167
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132495
diis-c [-6.23201644e-07 -1.24748995e-03  1.44486707e-01  8.56760783e-01]
  HOMO = -0.584405972626957  LUMO = 0.914894420793843
  mo_energy =
[-1.18582201e+02 -1.23116185e+01 -9.56298743e+00 -9.56298743e+00
 -9.56298743e+00 -1.27146879e+00 -5.84405973e-01 -5.84405973e-01
 -5.84405973e-01  9.14894421e-01  1.00400988e+00  1.00400988e+00
  1.00400988e+00  7.15554193e+00  7.15554193e+00  7.15554193e+00
  1.31643017e+01  3.28366213e+01  3.28366213e+01  3.28366213e+01
  1.16582339e+02  1.28977249e+02  1.28977249e+02  1.28977249e+02
  4.84126942e+02  4.84126942e+02  4.84126942e+02  6.31520342e+02
  1.33364671e+03  1.33364671e+03  1.33364671e+03  2.74116725e+03
  3.02414111e+03  3.02414111e+03  3.02414111e+03  6.64194271e+03
  6.64194271e+03  6.64194271e+03  9.15440753e+03  2.55052452e+04
  7.62405604e+04]
E1 = -728.2724175865504  E_coul = 201.52897503579086
cycle= 4 E= -526.74344255076  delta_E= -1.98e-06  |g|= 0.000107  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000124488
diis-c [-4.59989058e-09  8.01595855e-05 -1.12672620e-02 -7.32977317e-02
  1.08448483e+00]
  HOMO = -0.584389429631411  LUMO = 0.914927858637049
  mo_energy =
[-1.18582166e+02 -1.23115563e+01 -9.56293978e+00 -9.56293978e+00
 -9.56293978e+00 -1.27142691e+00 -5.84389430e-01 -5.84389430e-01
 -5.84389430e-01  9.14927859e-01  1.00402467e+00  1.00402467e+00
  1.00402467e+00  7.15558083e+00  7.15558083e+00  7.15558083e+00
  1.31643603e+01  3.28366670e+01  3.28366670e+01  3.28366670e+01
  1.16582386e+02  1.28977292e+02  1.28977292e+02  1.28977292e+02
  4.84126977e+02  4.84126977e+02  4.84126977e+02  6.31520369e+02
  1.33364673e+03  1.33364673e+03  1.33364673e+03  2.74116725e+03
  3.02414112e+03  3.02414112e+03  3.02414112e+03  6.64194272e+03
  6.64194272e+03  6.64194272e+03  9.15440752e+03  2.55052452e+04
  7.62405604e+04]
E1 = -728.2722052867177  E_coul = 201.52876273376683
cycle= 5 E= -526.743442552951  delta_E= -2.19e-09  |g|= 2.17e-05  |ddm|= 0.00018
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.04008e-05
diis-c [-8.70822368e-11  1.51731151e-05 -1.94448062e-03 -1.45161374e-02
  3.59167496e-02  9.80528695e-01]
  HOMO = -0.584397394211485  LUMO = 0.914924023605875
  mo_energy =
[-1.18582198e+02 -1.23115800e+01 -9.56296553e+00 -9.56296553e+00
 -9.56296553e+00 -1.27143306e+00 -5.84397394e-01 -5.84397394e-01
 -5.84397394e-01  9.14924024e-01  1.00401944e+00  1.00401944e+00
  1.00401944e+00  7.15556345e+00  7.15556345e+00  7.15556345e+00
  1.31643407e+01  3.28366420e+01  3.28366420e+01  3.28366420e+01
  1.16582357e+02  1.28977263e+02  1.28977263e+02  1.28977263e+02
  4.84126946e+02  4.84126946e+02  4.84126946e+02  6.31520336e+02
  1.33364670e+03  1.33364670e+03  1.33364670e+03  2.74116722e+03
  3.02414109e+03  3.02414109e+03  3.02414109e+03  6.64194268e+03
  6.64194268e+03  6.64194268e+03  9.15440748e+03  2.55052451e+04
  7.62405604e+04]
E1 = -728.2722903638467  E_coul = 201.52884781082753
cycle= 6 E= -526.743442553019  delta_E= -6.82e-11  |g|= 1.8e-06  |ddm|= 2.1e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2722903638467  E_coul = 201.52884781082753
  HOMO = -0.584397353286091  LUMO = 0.914924408046513
  mo_energy =
[-1.18582197e+02 -1.23115796e+01 -9.56296522e+00 -9.56296522e+00
 -9.56296522e+00 -1.27143261e+00 -5.84397353e-01 -5.84397353e-01
 -5.84397353e-01  9.14924408e-01  1.00401953e+00  1.00401953e+00
  1.00401953e+00  7.15556366e+00  7.15556366e+00  7.15556366e+00
  1.31643411e+01  3.28366424e+01  3.28366424e+01  3.28366424e+01
  1.16582358e+02  1.28977264e+02  1.28977264e+02  1.28977264e+02
  4.84126946e+02  4.84126946e+02  4.84126946e+02  6.31520337e+02
  1.33364670e+03  1.33364670e+03  1.33364670e+03  2.74116722e+03
  3.02414109e+03  3.02414109e+03  3.02414109e+03  6.64194268e+03
  6.64194268e+03  6.64194268e+03  9.15440748e+03  2.55052451e+04
  7.62405604e+04]
E1 = -728.2722883308888  E_coul = 201.52884577786858
Extra cycle  E= -526.74344255302  delta_E= -1.14e-12  |g|= 3.76e-07  |ddm|= 3.21e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 100132.08667084301
E1 = -728.2722883308888  E_coul = 201.52884577786858
init E= -526.74344255302
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.584397406754737  LUMO = 0.914924437115735
  mo_energy =
[-1.18582198e+02 -1.23115798e+01 -9.56296539e+00 -9.56296539e+00
 -9.56296539e+00 -1.27143259e+00 -5.84397407e-01 -5.84397407e-01
 -5.84397407e-01  9.14924437e-01  1.00401950e+00  1.00401950e+00
  1.00401950e+00  7.15556356e+00  7.15556356e+00  7.15556356e+00
  1.31643410e+01  3.28366422e+01  3.28366422e+01  3.28366422e+01
  1.16582358e+02  1.28977263e+02  1.28977263e+02  1.28977263e+02
  4.84126946e+02  4.84126946e+02  4.84126946e+02  6.31520337e+02
  1.33364670e+03  1.33364670e+03  1.33364670e+03  2.74116722e+03
  3.02414109e+03  3.02414109e+03  3.02414109e+03  6.64194268e+03
  6.64194268e+03  6.64194268e+03  9.15440748e+03  2.55052451e+04
  7.62405604e+04]
E1 = -728.2722887627515  E_coul = 201.5288462097312
cycle= 1 E= -526.74344255302  delta_E=    0  |g|= 8.32e-08  |ddm|= 6.15e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2722887627515  E_coul = 201.5288462097312
  HOMO = -0.584397401633426  LUMO = 0.914924456369237
  mo_energy =
[-1.18582198e+02 -1.23115797e+01 -9.56296536e+00 -9.56296536e+00
 -9.56296536e+00 -1.27143257e+00 -5.84397402e-01 -5.84397402e-01
 -5.84397402e-01  9.14924456e-01  1.00401951e+00  1.00401951e+00
  1.00401951e+00  7.15556358e+00  7.15556358e+00  7.15556358e+00
  1.31643410e+01  3.28366422e+01  3.28366422e+01  3.28366422e+01
  1.16582358e+02  1.28977263e+02  1.28977263e+02  1.28977263e+02
  4.84126946e+02  4.84126946e+02  4.84126946e+02  6.31520337e+02
  1.33364670e+03  1.33364670e+03  1.33364670e+03  2.74116722e+03
  3.02414109e+03  3.02414109e+03  3.02414109e+03  6.64194268e+03
  6.64194268e+03  6.64194268e+03  9.15440748e+03  2.55052451e+04
  7.62405604e+04]
E1 = -728.2722886109217  E_coul = 201.52884605790175
Extra cycle  E= -526.74344255302  delta_E= 3.41e-13  |g|= 1.75e-08  |ddm|= 1.37e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.37 sec
exp = [2.61827522e+04 7.61729480e+03 3.61743558e+03 1.59272844e+03
 4.01426909e+02 1.16160681e+02 3.78802067e+01 8.57514884e+00
 3.32064993e+00 6.33583094e-01 2.29365732e-01 1.36281493e+03
 6.64436241e+02 2.99503769e+02 3.12785361e+02 6.25322798e+01
 7.16253400e+00 2.02041321e+01 7.72781337e-01 2.77650180e+00
 2.20883530e-01]
grad_E = [-1.45061387e-06  2.62495631e-06 -2.01173164e-06  4.95589042e-05
  2.27971393e-05 -5.76463306e-04  1.07305569e-04  1.36244173e-03
 -1.91493837e-03  1.73949022e-03 -1.80748221e-02 -5.69028324e-07
  4.26454052e-06  1.96469377e-05  1.68383052e-05 -2.21559663e-05
 -1.18358835e-02  2.73096686e-03  1.47473636e-02  1.13661280e-02
 -4.04207032e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.802774         1
[INPUT] 0    0    [1    /1   ]  7617.17514007        1
[INPUT] 0    0    [1    /1   ]  3617.47987675        1
[INPUT] 0    0    [1    /1   ]  1590.03796029        1
[INPUT] 0    0    [1    /1   ]  411.484909372        1
[INPUT] 0    0    [1    /1   ]  119.526811928        1
[INPUT] 0    0    [1    /1   ]  38.7126291432        1
[INPUT] 0    0    [1    /1   ]  8.57247992191        1
[INPUT] 0    0    [1    /1   ]  3.34036976794        1
[INPUT] 0    0    [1    /1   ]  0.646874223367       1
[INPUT] 0    0    [1    /1   ]  0.236646440272       1
[INPUT] 1    0    [1    /1   ]  1362.83159683        1
[INPUT] 1    0    [1    /1   ]  664.273702028        1
[INPUT] 1    0    [1    /1   ]  298.737823076        1
[INPUT] 1    0    [1    /1   ]  312.125159596        1
[INPUT] 1    0    [1    /1   ]  63.0131214632        1
[INPUT] 1    0    [1    /1   ]  7.13769167617        1
[INPUT] 1    0    [1    /1   ]  20.1478482401        1
[INPUT] 1    0    [1    /1   ]  0.76973017891        1
[INPUT] 1    0    [1    /1   ]  2.75319949497        1
[INPUT] 1    0    [1    /1   ]  0.22067580661        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.80277397844, 1.0]], [0, [7617.175140069906, 1.0]], [0, [3617.4798767516645, 1.0]], [0, [1590.0379602853193, 1.0]], [0, [411.4849093719952, 1.0]], [0, [119.52681192808777, 1.0]], [0, [38.712629143190696, 1.0]], [0, [8.572479921905204, 1.0]], [0, [3.3403697679387614, 1.0]], [0, [0.6468742233667323, 1.0]], [0, [0.23664644027160933, 1.0]], [1, [1362.8315968348868, 1.0]], [1, [664.2737020282294, 1.0]], [1, [298.7378230759123, 1.0]], [1, [312.1251595961064, 1.0]], [1, [63.01312146315042, 1.0]], [1, [7.137691676173337, 1.0]], [1, [20.147848240131175, 1.0]], [1, [0.7697301789095028, 1.0]], [1, [2.7531994949657164, 1.0]], [1, [0.22067580660990077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80277398]
bas 1, expnt(s) = [7617.17514007]
bas 2, expnt(s) = [3617.47987675]
bas 3, expnt(s) = [1590.03796029]
bas 4, expnt(s) = [411.48490937]
bas 5, expnt(s) = [119.52681193]
bas 6, expnt(s) = [38.71262914]
bas 7, expnt(s) = [8.57247992]
bas 8, expnt(s) = [3.34036977]
bas 9, expnt(s) = [0.64687422]
bas 10, expnt(s) = [0.23664644]
bas 11, expnt(s) = [1362.83159683]
bas 12, expnt(s) = [664.27370203]
bas 13, expnt(s) = [298.73782308]
bas 14, expnt(s) = [312.1251596]
bas 15, expnt(s) = [63.01312146]
bas 16, expnt(s) = [7.13769168]
bas 17, expnt(s) = [20.14784824]
bas 18, expnt(s) = [0.76973018]
bas 19, expnt(s) = [2.75319949]
bas 20, expnt(s) = [0.22067581]
CPU time:       382.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828028e+04 5.20028475e+03 7.61717514e+03 2.05996803e+03
 3.61747988e+03 1.17847295e+03 1.59003796e+03 6.36166277e+02
 4.11484909e+02 2.30823732e+02 1.19526812e+02 9.13301196e+01
 3.87126291e+01 3.92106936e+01 8.57247992e+00 1.26574110e+01
 3.34036977e+00 6.24253423e+00 6.46874223e-01 1.82234210e+00
 2.36646440e-01 8.57215482e-01 1.36283160e+03 2.41566738e+04
 6.64273702e+02 9.83825822e+03 2.98737823e+02 3.62324046e+03
 3.12125160e+02 3.82732519e+03 6.30131215e+01 5.17932465e+02
 7.13769168e+00 3.40354598e+01 2.01478482e+01 1.24528923e+02
 7.69730179e-01 2.10333058e+00 2.75319949e+00 1.03462149e+01
 2.20675807e-01 4.41242967e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993833380834896
cond(S) = 98370.46517669265
E1 = -729.5324736699729  E_coul = 203.18086358437046
init E= -526.351610085602
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555903164546602  LUMO = 0.978797631080842
  mo_energy =
[-1.18331511e+02 -1.22045160e+01 -9.44640764e+00 -9.44640764e+00
 -9.44640764e+00 -1.24004740e+00 -5.55903165e-01 -5.55903165e-01
 -5.55903165e-01  9.78797631e-01  1.01986391e+00  1.01986391e+00
  1.01986391e+00  7.17072091e+00  7.17072091e+00  7.17072091e+00
  1.34429834e+01  3.27654588e+01  3.27654588e+01  3.27654588e+01
  1.19993820e+02  1.29265325e+02  1.29265325e+02  1.29265325e+02
  4.84866370e+02  4.84866370e+02  4.84866370e+02  6.50290047e+02
  1.33321161e+03  1.33321161e+03  1.33321161e+03  2.78133289e+03
  3.02179515e+03  3.02179515e+03  3.02179515e+03  6.63831833e+03
  6.63831833e+03  6.63831833e+03  9.19952522e+03  2.55484023e+04
  7.62804786e+04]
E1 = -727.8315737418632  E_coul = 201.08749928675087
cycle= 1 E= -526.744074455112  delta_E= -0.392  |g|= 0.186  |ddm|=  0.3
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.539509
diis-c [-0.29106956  1.        ]
  HOMO = -0.591754149257044  LUMO = 0.950187565831232
  mo_energy =
[-1.18640330e+02 -1.23437583e+01 -9.59631431e+00 -9.59631431e+00
 -9.59631431e+00 -1.28049830e+00 -5.91754149e-01 -5.91754149e-01
 -5.91754149e-01  9.50187566e-01  9.95168433e-01  9.95168433e-01
  9.95168433e-01  7.07990836e+00  7.07990836e+00  7.07990836e+00
  1.33276563e+01  3.26107429e+01  3.26107429e+01  3.26107429e+01
  1.19764352e+02  1.29034543e+02  1.29034543e+02  1.29034543e+02
  4.84558963e+02  4.84558963e+02  4.84558963e+02  6.49937616e+02
  1.33284884e+03  1.33284884e+03  1.33284884e+03  2.78083561e+03
  3.02136676e+03  3.02136676e+03  3.02136676e+03  6.63777786e+03
  6.63777786e+03  6.63777786e+03  9.19891100e+03  2.55476944e+04
  7.62796809e+04]
E1 = -728.411619905281  E_coul = 201.66681464897343
cycle= 2 E= -526.744805256308  delta_E= -0.000731  |g|= 0.0379  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753579
diis-c [-0.00331246  0.08314335  0.91685665]
  HOMO = -0.582514972084156  LUMO = 0.958303084723641
  mo_energy =
[-1.18572167e+02 -1.23053201e+01 -9.55622106e+00 -9.55622106e+00
 -9.55622106e+00 -1.26942802e+00 -5.82514972e-01 -5.82514972e-01
 -5.82514972e-01  9.58303085e-01  1.00190140e+00  1.00190140e+00
  1.00190140e+00  7.10357346e+00  7.10357346e+00  7.10357346e+00
  1.33592283e+01  3.26510204e+01  3.26510204e+01  3.26510204e+01
  1.19821868e+02  1.29091070e+02  1.29091070e+02  1.29091070e+02
  4.84626314e+02  4.84626314e+02  4.84626314e+02  6.50007788e+02
  1.33292021e+03  1.33292021e+03  1.33292021e+03  2.78091037e+03
  3.02144040e+03  3.02144040e+03  3.02144040e+03  6.63785325e+03
  6.63785325e+03  6.63785325e+03  9.19898721e+03  2.55477712e+04
  7.62797580e+04]
E1 = -728.2592341573471  E_coul = 201.5143686077671
cycle= 3 E= -526.74486554958  delta_E= -6.03e-05  |g|= 0.00633  |ddm|= 0.0166
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132076
diis-c [-5.89002653e-07 -1.23661709e-03  1.44729145e-01  8.56507472e-01]
  HOMO = -0.584039530801304  LUMO = 0.957063386853048
  mo_energy =
[-1.18582199e+02 -1.23111868e+01 -9.56243518e+00 -9.56243518e+00
 -9.56243518e+00 -1.27114508e+00 -5.84039531e-01 -5.84039531e-01
 -5.84039531e-01  9.57063387e-01  1.00081522e+00  1.00081522e+00
  1.00081522e+00  7.09980415e+00  7.09980415e+00  7.09980415e+00
  1.33543882e+01  3.26448150e+01  3.26448150e+01  3.26448150e+01
  1.19813338e+02  1.29082628e+02  1.29082628e+02  1.29082628e+02
  4.84616398e+02  4.84616398e+02  4.84616398e+02  6.49997448e+02
  1.33290971e+03  1.33290971e+03  1.33290971e+03  2.78089922e+03
  3.02142951e+03  3.02142951e+03  3.02142951e+03  6.63784197e+03
  6.63784197e+03  6.63784197e+03  9.19897572e+03  2.55477595e+04
  7.62797462e+04]
E1 = -728.282328350619  E_coul = 201.53746083230357
cycle= 4 E= -526.744867518315  delta_E= -1.97e-06  |g|= 0.000102  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117618
diis-c [-4.35350753e-09  7.46012686e-05 -1.06189935e-02 -6.89296476e-02
  1.07947404e+00]
  HOMO = -0.584022060951913  LUMO = 0.957097135258745
  mo_energy =
[-1.18582161e+02 -1.23111233e+01 -9.56238562e+00 -9.56238562e+00
 -9.56238562e+00 -1.27110371e+00 -5.84022061e-01 -5.84022061e-01
 -5.84022061e-01  9.57097135e-01  1.00083042e+00  1.00083042e+00
  1.00083042e+00  7.09984431e+00  7.09984431e+00  7.09984431e+00
  1.33544475e+01  3.26448625e+01  3.26448625e+01  3.26448625e+01
  1.19813387e+02  1.29082673e+02  1.29082673e+02  1.29082673e+02
  4.84616436e+02  4.84616436e+02  4.84616436e+02  6.49997478e+02
  1.33290974e+03  1.33290974e+03  1.33290974e+03  2.78089923e+03
  3.02142952e+03  3.02142952e+03  3.02142952e+03  6.63784197e+03
  6.63784197e+03  6.63784197e+03  9.19897571e+03  2.55477595e+04
  7.62797462e+04]
E1 = -728.2821152904604  E_coul = 201.53724777022651
cycle= 5 E= -526.744867520234  delta_E= -1.92e-09  |g|= 2.12e-05  |ddm|= 0.000168
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.97399e-05
diis-c [-7.92589094e-11  1.49066208e-05 -1.92911075e-03 -1.43689303e-02
  3.80407125e-02  9.78242422e-01]
  HOMO = -0.584029748499446  LUMO = 0.957093251623749
  mo_energy =
[-1.18582192e+02 -1.23111464e+01 -9.56241070e+00 -9.56241070e+00
 -9.56241070e+00 -1.27110972e+00 -5.84029748e-01 -5.84029748e-01
 -5.84029748e-01  9.57093252e-01  1.00082540e+00  1.00082540e+00
  1.00082540e+00  7.09982749e+00  7.09982749e+00  7.09982749e+00
  1.33544283e+01  3.26448382e+01  3.26448382e+01  3.26448382e+01
  1.19813359e+02  1.29082645e+02  1.29082645e+02  1.29082645e+02
  4.84616405e+02  4.84616405e+02  4.84616405e+02  6.49997446e+02
  1.33290971e+03  1.33290971e+03  1.33290971e+03  2.78089920e+03
  3.02142949e+03  3.02142949e+03  3.02142949e+03  6.63784194e+03
  6.63784194e+03  6.63784194e+03  9.19897568e+03  2.55477594e+04
  7.62797461e+04]
E1 = -728.2821987285662  E_coul = 201.53733120826777
cycle= 6 E= -526.744867520298  delta_E= -6.45e-11  |g|= 1.75e-06  |ddm|= 1.99e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2821987285662  E_coul = 201.53733120826777
  HOMO = -0.584029737643425  LUMO = 0.957093612657305
  mo_energy =
[-1.18582192e+02 -1.23111461e+01 -9.56241052e+00 -9.56241052e+00
 -9.56241052e+00 -1.27110931e+00 -5.84029738e-01 -5.84029738e-01
 -5.84029738e-01  9.57093613e-01  1.00082546e+00  1.00082546e+00
  1.00082546e+00  7.09982762e+00  7.09982762e+00  7.09982762e+00
  1.33544286e+01  3.26448385e+01  3.26448385e+01  3.26448385e+01
  1.19813359e+02  1.29082645e+02  1.29082645e+02  1.29082645e+02
  4.84616406e+02  4.84616406e+02  4.84616406e+02  6.49997446e+02
  1.33290971e+03  1.33290971e+03  1.33290971e+03  2.78089920e+03
  3.02142949e+03  3.02142949e+03  3.02142949e+03  6.63784194e+03
  6.63784194e+03  6.63784194e+03  9.19897568e+03  2.55477594e+04
  7.62797461e+04]
E1 = -728.2821972497709  E_coul = 201.53732972947216
Extra cycle  E= -526.744867520299  delta_E= -3.41e-13  |g|= 3.64e-07  |ddm|= 3.11e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828028e+04 7.61717514e+03 3.61747988e+03 1.59003796e+03
 4.11484909e+02 1.19526812e+02 3.87126291e+01 8.57247992e+00
 3.34036977e+00 6.46874223e-01 2.36646440e-01 1.36283160e+03
 6.64273702e+02 2.98737823e+02 3.12125160e+02 6.30131215e+01
 7.13769168e+00 2.01478482e+01 7.69730179e-01 2.75319949e+00
 2.20675807e-01]
E = -526.7448675202987
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.802774         1
[INPUT] 0    0    [1    /1   ]  7617.17514007        1
[INPUT] 0    0    [1    /1   ]  3617.47987675        1
[INPUT] 0    0    [1    /1   ]  1590.03796029        1
[INPUT] 0    0    [1    /1   ]  411.484909372        1
[INPUT] 0    0    [1    /1   ]  119.526811928        1
[INPUT] 0    0    [1    /1   ]  38.7126291432        1
[INPUT] 0    0    [1    /1   ]  8.57247992191        1
[INPUT] 0    0    [1    /1   ]  3.34036976794        1
[INPUT] 0    0    [1    /1   ]  0.646874223367       1
[INPUT] 0    0    [1    /1   ]  0.236646440272       1
[INPUT] 1    0    [1    /1   ]  1362.83159683        1
[INPUT] 1    0    [1    /1   ]  664.273702028        1
[INPUT] 1    0    [1    /1   ]  298.737823076        1
[INPUT] 1    0    [1    /1   ]  312.125159596        1
[INPUT] 1    0    [1    /1   ]  63.0131214632        1
[INPUT] 1    0    [1    /1   ]  7.13769167617        1
[INPUT] 1    0    [1    /1   ]  20.1478482401        1
[INPUT] 1    0    [1    /1   ]  0.76973017891        1
[INPUT] 1    0    [1    /1   ]  2.75319949497        1
[INPUT] 1    0    [1    /1   ]  0.22067580661        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.80277397844, 1.0]], [0, [7617.175140069906, 1.0]], [0, [3617.4798767516645, 1.0]], [0, [1590.0379602853193, 1.0]], [0, [411.4849093719952, 1.0]], [0, [119.52681192808777, 1.0]], [0, [38.712629143190696, 1.0]], [0, [8.572479921905204, 1.0]], [0, [3.3403697679387614, 1.0]], [0, [0.6468742233667323, 1.0]], [0, [0.23664644027160933, 1.0]], [1, [1362.8315968348868, 1.0]], [1, [664.2737020282294, 1.0]], [1, [298.7378230759123, 1.0]], [1, [312.1251595961064, 1.0]], [1, [63.01312146315042, 1.0]], [1, [7.137691676173337, 1.0]], [1, [20.147848240131175, 1.0]], [1, [0.7697301789095028, 1.0]], [1, [2.7531994949657164, 1.0]], [1, [0.22067580660990077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80277398]
bas 1, expnt(s) = [7617.17514007]
bas 2, expnt(s) = [3617.47987675]
bas 3, expnt(s) = [1590.03796029]
bas 4, expnt(s) = [411.48490937]
bas 5, expnt(s) = [119.52681193]
bas 6, expnt(s) = [38.71262914]
bas 7, expnt(s) = [8.57247992]
bas 8, expnt(s) = [3.34036977]
bas 9, expnt(s) = [0.64687422]
bas 10, expnt(s) = [0.23664644]
bas 11, expnt(s) = [1362.83159683]
bas 12, expnt(s) = [664.27370203]
bas 13, expnt(s) = [298.73782308]
bas 14, expnt(s) = [312.1251596]
bas 15, expnt(s) = [63.01312146]
bas 16, expnt(s) = [7.13769168]
bas 17, expnt(s) = [20.14784824]
bas 18, expnt(s) = [0.76973018]
bas 19, expnt(s) = [2.75319949]
bas 20, expnt(s) = [0.22067581]
CPU time:       383.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828028e+04 5.20028475e+03 7.61717514e+03 2.05996803e+03
 3.61747988e+03 1.17847295e+03 1.59003796e+03 6.36166277e+02
 4.11484909e+02 2.30823732e+02 1.19526812e+02 9.13301196e+01
 3.87126291e+01 3.92106936e+01 8.57247992e+00 1.26574110e+01
 3.34036977e+00 6.24253423e+00 6.46874223e-01 1.82234210e+00
 2.36646440e-01 8.57215482e-01 1.36283160e+03 2.41566738e+04
 6.64273702e+02 9.83825822e+03 2.98737823e+02 3.62324046e+03
 3.12125160e+02 3.82732519e+03 6.30131215e+01 5.17932465e+02
 7.13769168e+00 3.40354598e+01 2.01478482e+01 1.24528923e+02
 7.69730179e-01 2.10333058e+00 2.75319949e+00 1.03462149e+01
 2.20675807e-01 4.41242967e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993833380834896
cond(S) = 98370.46517669265
E1 = -729.5324736699729  E_coul = 203.18086358437046
init E= -526.351610085602
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555903164546602  LUMO = 0.978797631080842
  mo_energy =
[-1.18331511e+02 -1.22045160e+01 -9.44640764e+00 -9.44640764e+00
 -9.44640764e+00 -1.24004740e+00 -5.55903165e-01 -5.55903165e-01
 -5.55903165e-01  9.78797631e-01  1.01986391e+00  1.01986391e+00
  1.01986391e+00  7.17072091e+00  7.17072091e+00  7.17072091e+00
  1.34429834e+01  3.27654588e+01  3.27654588e+01  3.27654588e+01
  1.19993820e+02  1.29265325e+02  1.29265325e+02  1.29265325e+02
  4.84866370e+02  4.84866370e+02  4.84866370e+02  6.50290047e+02
  1.33321161e+03  1.33321161e+03  1.33321161e+03  2.78133289e+03
  3.02179515e+03  3.02179515e+03  3.02179515e+03  6.63831833e+03
  6.63831833e+03  6.63831833e+03  9.19952522e+03  2.55484023e+04
  7.62804786e+04]
E1 = -727.8315737418632  E_coul = 201.08749928675087
cycle= 1 E= -526.744074455112  delta_E= -0.392  |g|= 0.186  |ddm|=  0.3
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.539509
diis-c [-0.29106956  1.        ]
  HOMO = -0.591754149257044  LUMO = 0.950187565831232
  mo_energy =
[-1.18640330e+02 -1.23437583e+01 -9.59631431e+00 -9.59631431e+00
 -9.59631431e+00 -1.28049830e+00 -5.91754149e-01 -5.91754149e-01
 -5.91754149e-01  9.50187566e-01  9.95168433e-01  9.95168433e-01
  9.95168433e-01  7.07990836e+00  7.07990836e+00  7.07990836e+00
  1.33276563e+01  3.26107429e+01  3.26107429e+01  3.26107429e+01
  1.19764352e+02  1.29034543e+02  1.29034543e+02  1.29034543e+02
  4.84558963e+02  4.84558963e+02  4.84558963e+02  6.49937616e+02
  1.33284884e+03  1.33284884e+03  1.33284884e+03  2.78083561e+03
  3.02136676e+03  3.02136676e+03  3.02136676e+03  6.63777786e+03
  6.63777786e+03  6.63777786e+03  9.19891100e+03  2.55476944e+04
  7.62796809e+04]
E1 = -728.411619905281  E_coul = 201.66681464897343
cycle= 2 E= -526.744805256308  delta_E= -0.000731  |g|= 0.0379  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0753579
diis-c [-0.00331246  0.08314335  0.91685665]
  HOMO = -0.582514972084156  LUMO = 0.958303084723641
  mo_energy =
[-1.18572167e+02 -1.23053201e+01 -9.55622106e+00 -9.55622106e+00
 -9.55622106e+00 -1.26942802e+00 -5.82514972e-01 -5.82514972e-01
 -5.82514972e-01  9.58303085e-01  1.00190140e+00  1.00190140e+00
  1.00190140e+00  7.10357346e+00  7.10357346e+00  7.10357346e+00
  1.33592283e+01  3.26510204e+01  3.26510204e+01  3.26510204e+01
  1.19821868e+02  1.29091070e+02  1.29091070e+02  1.29091070e+02
  4.84626314e+02  4.84626314e+02  4.84626314e+02  6.50007788e+02
  1.33292021e+03  1.33292021e+03  1.33292021e+03  2.78091037e+03
  3.02144040e+03  3.02144040e+03  3.02144040e+03  6.63785325e+03
  6.63785325e+03  6.63785325e+03  9.19898721e+03  2.55477712e+04
  7.62797580e+04]
E1 = -728.2592341573471  E_coul = 201.5143686077671
cycle= 3 E= -526.74486554958  delta_E= -6.03e-05  |g|= 0.00633  |ddm|= 0.0166
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0132076
diis-c [-5.89002653e-07 -1.23661709e-03  1.44729145e-01  8.56507472e-01]
  HOMO = -0.584039530801304  LUMO = 0.957063386853048
  mo_energy =
[-1.18582199e+02 -1.23111868e+01 -9.56243518e+00 -9.56243518e+00
 -9.56243518e+00 -1.27114508e+00 -5.84039531e-01 -5.84039531e-01
 -5.84039531e-01  9.57063387e-01  1.00081522e+00  1.00081522e+00
  1.00081522e+00  7.09980415e+00  7.09980415e+00  7.09980415e+00
  1.33543882e+01  3.26448150e+01  3.26448150e+01  3.26448150e+01
  1.19813338e+02  1.29082628e+02  1.29082628e+02  1.29082628e+02
  4.84616398e+02  4.84616398e+02  4.84616398e+02  6.49997448e+02
  1.33290971e+03  1.33290971e+03  1.33290971e+03  2.78089922e+03
  3.02142951e+03  3.02142951e+03  3.02142951e+03  6.63784197e+03
  6.63784197e+03  6.63784197e+03  9.19897572e+03  2.55477595e+04
  7.62797462e+04]
E1 = -728.282328350619  E_coul = 201.53746083230357
cycle= 4 E= -526.744867518315  delta_E= -1.97e-06  |g|= 0.000102  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000117618
diis-c [-4.35350753e-09  7.46012686e-05 -1.06189935e-02 -6.89296476e-02
  1.07947404e+00]
  HOMO = -0.584022060951913  LUMO = 0.957097135258745
  mo_energy =
[-1.18582161e+02 -1.23111233e+01 -9.56238562e+00 -9.56238562e+00
 -9.56238562e+00 -1.27110371e+00 -5.84022061e-01 -5.84022061e-01
 -5.84022061e-01  9.57097135e-01  1.00083042e+00  1.00083042e+00
  1.00083042e+00  7.09984431e+00  7.09984431e+00  7.09984431e+00
  1.33544475e+01  3.26448625e+01  3.26448625e+01  3.26448625e+01
  1.19813387e+02  1.29082673e+02  1.29082673e+02  1.29082673e+02
  4.84616436e+02  4.84616436e+02  4.84616436e+02  6.49997478e+02
  1.33290974e+03  1.33290974e+03  1.33290974e+03  2.78089923e+03
  3.02142952e+03  3.02142952e+03  3.02142952e+03  6.63784197e+03
  6.63784197e+03  6.63784197e+03  9.19897571e+03  2.55477595e+04
  7.62797462e+04]
E1 = -728.2821152904604  E_coul = 201.53724777022651
cycle= 5 E= -526.744867520234  delta_E= -1.92e-09  |g|= 2.12e-05  |ddm|= 0.000168
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.97399e-05
diis-c [-7.92589094e-11  1.49066208e-05 -1.92911075e-03 -1.43689303e-02
  3.80407125e-02  9.78242422e-01]
  HOMO = -0.584029748499446  LUMO = 0.957093251623749
  mo_energy =
[-1.18582192e+02 -1.23111464e+01 -9.56241070e+00 -9.56241070e+00
 -9.56241070e+00 -1.27110972e+00 -5.84029748e-01 -5.84029748e-01
 -5.84029748e-01  9.57093252e-01  1.00082540e+00  1.00082540e+00
  1.00082540e+00  7.09982749e+00  7.09982749e+00  7.09982749e+00
  1.33544283e+01  3.26448382e+01  3.26448382e+01  3.26448382e+01
  1.19813359e+02  1.29082645e+02  1.29082645e+02  1.29082645e+02
  4.84616405e+02  4.84616405e+02  4.84616405e+02  6.49997446e+02
  1.33290971e+03  1.33290971e+03  1.33290971e+03  2.78089920e+03
  3.02142949e+03  3.02142949e+03  3.02142949e+03  6.63784194e+03
  6.63784194e+03  6.63784194e+03  9.19897568e+03  2.55477594e+04
  7.62797461e+04]
E1 = -728.2821987285662  E_coul = 201.53733120826777
cycle= 6 E= -526.744867520298  delta_E= -6.45e-11  |g|= 1.75e-06  |ddm|= 1.99e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2821987285662  E_coul = 201.53733120826777
  HOMO = -0.584029737643425  LUMO = 0.957093612657305
  mo_energy =
[-1.18582192e+02 -1.23111461e+01 -9.56241052e+00 -9.56241052e+00
 -9.56241052e+00 -1.27110931e+00 -5.84029738e-01 -5.84029738e-01
 -5.84029738e-01  9.57093613e-01  1.00082546e+00  1.00082546e+00
  1.00082546e+00  7.09982762e+00  7.09982762e+00  7.09982762e+00
  1.33544286e+01  3.26448385e+01  3.26448385e+01  3.26448385e+01
  1.19813359e+02  1.29082645e+02  1.29082645e+02  1.29082645e+02
  4.84616406e+02  4.84616406e+02  4.84616406e+02  6.49997446e+02
  1.33290971e+03  1.33290971e+03  1.33290971e+03  2.78089920e+03
  3.02142949e+03  3.02142949e+03  3.02142949e+03  6.63784194e+03
  6.63784194e+03  6.63784194e+03  9.19897568e+03  2.55477594e+04
  7.62797461e+04]
E1 = -728.2821972497709  E_coul = 201.53732972947216
Extra cycle  E= -526.744867520299  delta_E= -3.41e-13  |g|= 3.64e-07  |ddm|= 3.11e-06
    CPU time for scf_cycle      0.31 sec, wall time      0.25 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98370.46517669265
E1 = -728.2821972497709  E_coul = 201.53732972947216
init E= -526.744867520299
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.58402977885386  LUMO = 0.95709365055666
  mo_energy =
[-1.18582192e+02 -1.23111462e+01 -9.56241064e+00 -9.56241064e+00
 -9.56241064e+00 -1.27110928e+00 -5.84029779e-01 -5.84029779e-01
 -5.84029779e-01  9.57093651e-01  1.00082544e+00  1.00082544e+00
  1.00082544e+00  7.09982754e+00  7.09982754e+00  7.09982754e+00
  1.33544286e+01  3.26448383e+01  3.26448383e+01  3.26448383e+01
  1.19813359e+02  1.29082645e+02  1.29082645e+02  1.29082645e+02
  4.84616405e+02  4.84616405e+02  4.84616405e+02  6.49997446e+02
  1.33290971e+03  1.33290971e+03  1.33290971e+03  2.78089920e+03
  3.02142949e+03  3.02142949e+03  3.02142949e+03  6.63784194e+03
  6.63784194e+03  6.63784194e+03  9.19897568e+03  2.55477594e+04
  7.62797461e+04]
E1 = -728.2821975437729  E_coul = 201.53733002347494
cycle= 1 E= -526.744867520298  delta_E= 7.96e-13  |g|= 7.84e-08  |ddm|= 6.02e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2821975437729  E_coul = 201.53733002347494
  HOMO = -0.584029776026496  LUMO = 0.957093667888468
  mo_energy =
[-1.18582192e+02 -1.23111462e+01 -9.56241062e+00 -9.56241062e+00
 -9.56241062e+00 -1.27110926e+00 -5.84029776e-01 -5.84029776e-01
 -5.84029776e-01  9.57093668e-01  1.00082545e+00  1.00082545e+00
  1.00082545e+00  7.09982755e+00  7.09982755e+00  7.09982755e+00
  1.33544286e+01  3.26448384e+01  3.26448384e+01  3.26448384e+01
  1.19813359e+02  1.29082645e+02  1.29082645e+02  1.29082645e+02
  4.84616405e+02  4.84616405e+02  4.84616405e+02  6.49997446e+02
  1.33290971e+03  1.33290971e+03  1.33290971e+03  2.78089920e+03
  3.02142949e+03  3.02142949e+03  3.02142949e+03  6.63784194e+03
  6.63784194e+03  6.63784194e+03  9.19897568e+03  2.55477594e+04
  7.62797461e+04]
E1 = -728.2821974348907  E_coul = 201.53732991459268
Extra cycle  E= -526.744867520298  delta_E= -1.14e-13  |g|= 1.61e-08  |ddm|= 1.31e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.37 sec
exp = [2.61828028e+04 7.61717514e+03 3.61747988e+03 1.59003796e+03
 4.11484909e+02 1.19526812e+02 3.87126291e+01 8.57247992e+00
 3.34036977e+00 6.46874223e-01 2.36646440e-01 1.36283160e+03
 6.64273702e+02 2.98737823e+02 3.12125160e+02 6.30131215e+01
 7.13769168e+00 2.01478482e+01 7.69730179e-01 2.75319949e+00
 2.20675807e-01]
grad_E = [-1.41264054e-06  2.28640610e-06 -2.10130565e-06  3.98006430e-05
  5.75640675e-05 -4.20309969e-04  2.37509858e-04  9.84349516e-04
 -1.68177757e-03  9.83642670e-04 -1.17035461e-02 -6.17858628e-07
  3.46415380e-06  1.50195025e-05  1.28509775e-05  3.30371104e-04
 -7.82283907e-03  8.64638214e-04  9.54619183e-03  7.37273116e-03
 -2.61621376e-02]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8231281        1
[INPUT] 0    0    [1    /1   ]  7617.12713017        1
[INPUT] 0    0    [1    /1   ]  3617.49777843        1
[INPUT] 0    0    [1    /1   ]  1588.96038173        1
[INPUT] 0    0    [1    /1   ]  415.415780019        1
[INPUT] 0    0    [1    /1   ]  121.260474839        1
[INPUT] 0    0    [1    /1   ]  39.1553026639        1
[INPUT] 0    0    [1    /1   ]  8.50283332678        1
[INPUT] 0    0    [1    /1   ]  3.34195118633        1
[INPUT] 0    0    [1    /1   ]  0.663666114877       1
[INPUT] 0    0    [1    /1   ]  0.245206577074       1
[INPUT] 1    0    [1    /1   ]  1362.83830185        1
[INPUT] 1    0    [1    /1   ]  664.208300713        1
[INPUT] 1    0    [1    /1   ]  298.429622283        1
[INPUT] 1    0    [1    /1   ]  311.859506693        1
[INPUT] 1    0    [1    /1   ]  63.2064510439        1
[INPUT] 1    0    [1    /1   ]  7.1421705117         1
[INPUT] 1    0    [1    /1   ]  20.1250733739        1
[INPUT] 1    0    [1    /1   ]  0.767197745213       1
[INPUT] 1    0    [1    /1   ]  2.73398273812        1
[INPUT] 1    0    [1    /1   ]  0.220670619424       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.823128108703, 1.0]], [0, [7617.127130170086, 1.0]], [0, [3617.4977784294906, 1.0]], [0, [1588.960381732553, 1.0]], [0, [415.4157800190658, 1.0]], [0, [121.26047483897638, 1.0]], [0, [39.15530266390198, 1.0]], [0, [8.50283332677951, 1.0]], [0, [3.3419511863270963, 1.0]], [0, [0.6636661148773393, 1.0]], [0, [0.24520657707363258, 1.0]], [1, [1362.8383018509367, 1.0]], [1, [664.2083007134712, 1.0]], [1, [298.4296222832513, 1.0]], [1, [311.85950669271494, 1.0]], [1, [63.206451043887526, 1.0]], [1, [7.142170511704314, 1.0]], [1, [20.125073373948293, 1.0]], [1, [0.7671977452129395, 1.0]], [1, [2.7339827381248316, 1.0]], [1, [0.22067061942416288, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.82312811]
bas 1, expnt(s) = [7617.12713017]
bas 2, expnt(s) = [3617.49777843]
bas 3, expnt(s) = [1588.96038173]
bas 4, expnt(s) = [415.41578002]
bas 5, expnt(s) = [121.26047484]
bas 6, expnt(s) = [39.15530266]
bas 7, expnt(s) = [8.50283333]
bas 8, expnt(s) = [3.34195119]
bas 9, expnt(s) = [0.66366611]
bas 10, expnt(s) = [0.24520658]
bas 11, expnt(s) = [1362.83830185]
bas 12, expnt(s) = [664.20830071]
bas 13, expnt(s) = [298.42962228]
bas 14, expnt(s) = [311.85950669]
bas 15, expnt(s) = [63.20645104]
bas 16, expnt(s) = [7.14217051]
bas 17, expnt(s) = [20.12507337]
bas 18, expnt(s) = [0.76719775]
bas 19, expnt(s) = [2.73398274]
bas 20, expnt(s) = [0.22067062]
CPU time:       388.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828231e+04 5.20028778e+03 7.61712713e+03 2.05995829e+03
 3.61749778e+03 1.17847732e+03 1.58896038e+03 6.35842900e+02
 4.15415780e+02 2.32475541e+02 1.21260475e+02 9.23218445e+01
 3.91553027e+01 3.95464918e+01 8.50283333e+00 1.25802066e+01
 3.34195119e+00 6.24475064e+00 6.63666115e-01 1.85770717e+00
 2.45206577e-01 8.80367721e-01 1.36283830e+03 2.41568224e+04
 6.64208301e+02 9.83704744e+03 2.98429622e+02 3.61856855e+03
 3.11859507e+02 3.82325378e+03 6.32064510e+01 5.19919552e+02
 7.14217051e+00 3.40621581e+01 2.01250734e+01 1.24352990e+02
 7.67197745e-01 2.09468412e+00 2.73398274e+00 1.02560258e+01
 2.20670619e-01 4.41230002e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99382628260445
cond(S) = 97708.38525538756
E1 = -729.5310791566918  E_coul = 203.17940955675957
init E= -526.351669599932
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555890729429754  LUMO = 1.01753106158503
  mo_energy =
[-1.18331828e+02 -1.22047767e+01 -9.44656067e+00 -9.44656067e+00
 -9.44656067e+00 -1.24000034e+00 -5.55890729e-01 -5.55890729e-01
 -5.55890729e-01  1.01753106e+00  1.01753106e+00  1.01753106e+00
  1.03024187e+00  7.13100053e+00  7.13100053e+00  7.13100053e+00
  1.35130986e+01  3.26826956e+01  3.26826956e+01  3.26826956e+01
  1.21446444e+02  1.29320279e+02  1.29320279e+02  1.29320279e+02
  4.85075915e+02  4.85075915e+02  4.85075915e+02  6.58745027e+02
  1.33292719e+03  1.33292719e+03  1.33292719e+03  2.79849225e+03
  3.02071563e+03  3.02071563e+03  3.02071563e+03  6.63667934e+03
  6.63667934e+03  6.63667934e+03  9.21860026e+03  2.55666204e+04
  7.62972942e+04]
E1 = -727.8454903212274  E_coul = 201.1009417974343
cycle= 1 E= -526.744548523793  delta_E= -0.393  |g|= 0.186  |ddm|= 0.299
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538588
diis-c [-0.29007729  1.        ]
  HOMO = -0.591169681879449  LUMO = 0.99333525998633
  mo_energy =
[-1.18639517e+02 -1.23430390e+01 -9.59543352e+00 -9.59543352e+00
 -9.59543352e+00 -1.27993651e+00 -5.91169682e-01 -5.91169682e-01
 -5.91169682e-01  9.93335260e-01  9.93335260e-01  9.93335260e-01
  1.00092857e+00  7.04126362e+00  7.04126362e+00  7.04126362e+00
  1.33986965e+01  3.25290057e+01  3.25290057e+01  3.25290057e+01
  1.21217130e+02  1.29090428e+02  1.29090428e+02  1.29090428e+02
  4.84769714e+02  4.84769714e+02  4.84769714e+02  6.58392761e+02
  1.33256570e+03  1.33256570e+03  1.33256570e+03  2.79799632e+03
  3.02028868e+03  3.02028868e+03  3.02028868e+03  6.63614047e+03
  6.63614047e+03  6.63614047e+03  9.21798786e+03  2.55659143e+04
  7.62964984e+04]
E1 = -728.4220963386507  E_coul = 201.67682620501853
cycle= 2 E= -526.745270133632  delta_E= -0.000722  |g|= 0.0377  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0749525
diis-c [-0.00328723  0.08269342  0.91730658]
  HOMO = -0.581990552292895  LUMO = 0.999994429426911
  mo_energy =
[-1.18571665e+02 -1.23048197e+01 -9.55555680e+00 -9.55555680e+00
 -9.55555680e+00 -1.26895025e+00 -5.81990552e-01 -5.81990552e-01
 -5.81990552e-01  9.99994429e-01  9.99994429e-01  9.99994429e-01
  1.00927027e+00  7.06472754e+00  7.06472754e+00  7.06472754e+00
  1.34300373e+01  3.25690623e+01  3.25690623e+01  3.25690623e+01
  1.21274546e+02  1.29146708e+02  1.29146708e+02  1.29146708e+02
  4.84836757e+02  4.84836757e+02  4.84836757e+02  6.58462687e+02
  1.33263675e+03  1.33263675e+03  1.33263675e+03  2.79807076e+03
  3.02036199e+03  3.02036199e+03  3.02036199e+03  6.63621554e+03
  6.63621554e+03  6.63621554e+03  9.21806375e+03  2.55659908e+04
  7.62965752e+04]
E1 = -728.270640394737  E_coul = 201.52531072598063
cycle= 3 E= -526.745329668756  delta_E= -5.95e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131557
diis-c [-5.53814854e-07 -1.22712530e-03  1.44952328e-01  8.56274798e-01]
  HOMO = -0.58350444967073  LUMO = 0.998919634843142
  mo_energy =
[-1.18581673e+02 -1.23106686e+01 -9.56175092e+00 -9.56175092e+00
 -9.56175092e+00 -1.27066176e+00 -5.83504450e-01 -5.83504450e-01
 -5.83504450e-01  9.98919635e-01  9.98919635e-01  9.98919635e-01
  1.00798925e+00  7.06098403e+00  7.06098403e+00  7.06098403e+00
  1.34252177e+01  3.25628772e+01  3.25628772e+01  3.25628772e+01
  1.21266013e+02  1.29138283e+02  1.29138283e+02  1.29138283e+02
  4.84826864e+02  4.84826864e+02  4.84826864e+02  6.58452361e+02
  1.33262627e+03  1.33262627e+03  1.33262627e+03  2.79805965e+03
  3.02035113e+03  3.02035113e+03  3.02035113e+03  6.63620429e+03
  6.63620429e+03  6.63620429e+03  9.21805228e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.2936684250898  E_coul = 201.54833680325072
cycle= 4 E= -526.745331621839  delta_E= -1.95e-06  |g|= 9.56e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109237
diis-c [-4.05879973e-09  6.78880798e-05 -9.81667720e-03 -6.35498244e-02
  1.07329861e+00]
  HOMO = -0.583485870031813  LUMO = 0.998935314357357
  mo_energy =
[-1.18581632e+02 -1.23106036e+01 -9.56169901e+00 -9.56169901e+00
 -9.56169901e+00 -1.27062111e+00 -5.83485870e-01 -5.83485870e-01
 -5.83485870e-01  9.98935314e-01  9.98935314e-01  9.98935314e-01
  1.00802319e+00  7.06102576e+00  7.06102576e+00  7.06102576e+00
  1.34252778e+01  3.25629269e+01  3.25629269e+01  3.25629269e+01
  1.21266065e+02  1.29138331e+02  1.29138331e+02  1.29138331e+02
  4.84826905e+02  4.84826905e+02  4.84826905e+02  6.58452395e+02
  1.33262631e+03  1.33262631e+03  1.33262631e+03  2.79805966e+03
  3.02035115e+03  3.02035115e+03  3.02035115e+03  6.63620430e+03
  6.63620430e+03  6.63620430e+03  9.21805229e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.293453981925  E_coul = 201.5481223584849
cycle= 5 E= -526.74533162344  delta_E= -1.6e-09  |g|= 2.05e-05  |ddm|= 0.000154
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8767e-05
diis-c [-7.00152028e-11  1.44398898e-05 -1.88855201e-03 -1.40542282e-02
  4.16055158e-02  9.74322825e-01]
  HOMO = -0.583493210064847  LUMO = 0.998930530573262
  mo_energy =
[-1.18581663e+02 -1.23106259e+01 -9.56172319e+00 -9.56172319e+00
 -9.56172319e+00 -1.27062695e+00 -5.83493210e-01 -5.83493210e-01
 -5.83493210e-01  9.98930531e-01  9.98930531e-01  9.98930531e-01
  1.00801925e+00  7.06100962e+00  7.06100962e+00  7.06100962e+00
  1.34252594e+01  3.25629035e+01  3.25629035e+01  3.25629035e+01
  1.21266037e+02  1.29138304e+02  1.29138304e+02  1.29138304e+02
  4.84826875e+02  4.84826875e+02  4.84826875e+02  6.58452364e+02
  1.33262628e+03  1.33262628e+03  1.33262628e+03  2.79805963e+03
  3.02035112e+03  3.02035112e+03  3.02035112e+03  6.63620426e+03
  6.63620426e+03  6.63620426e+03  9.21805225e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.2935351044606  E_coul = 201.54820348096302
cycle= 6 E= -526.745331623498  delta_E= -5.74e-11  |g|= 1.71e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2935351044606  E_coul = 201.54820348096302
  HOMO = -0.583493238196317  LUMO = 0.998930566060552
  mo_energy =
[-1.18581662e+02 -1.23106258e+01 -9.56172318e+00 -9.56172318e+00
 -9.56172318e+00 -1.27062660e+00 -5.83493238e-01 -5.83493238e-01
 -5.83493238e-01  9.98930566e-01  9.98930566e-01  9.98930566e-01
  1.00801958e+00  7.06100964e+00  7.06100964e+00  7.06100964e+00
  1.34252595e+01  3.25629036e+01  3.25629036e+01  3.25629036e+01
  1.21266037e+02  1.29138304e+02  1.29138304e+02  1.29138304e+02
  4.84826875e+02  4.84826875e+02  4.84826875e+02  6.58452364e+02
  1.33262628e+03  1.33262628e+03  1.33262628e+03  2.79805963e+03
  3.02035112e+03  3.02035112e+03  3.02035112e+03  6.63620426e+03
  6.63620426e+03  6.63620426e+03  9.21805225e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.2935343116833  E_coul = 201.54820268818517
Extra cycle  E= -526.745331623498  delta_E= -5.68e-13  |g|= 3.52e-07  |ddm|= 2.98e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828231e+04 7.61712713e+03 3.61749778e+03 1.58896038e+03
 4.15415780e+02 1.21260475e+02 3.91553027e+01 8.50283333e+00
 3.34195119e+00 6.63666115e-01 2.45206577e-01 1.36283830e+03
 6.64208301e+02 2.98429622e+02 3.11859507e+02 6.32064510e+01
 7.14217051e+00 2.01250734e+01 7.67197745e-01 2.73398274e+00
 2.20670619e-01]
E = -526.7453316234981
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8231281        1
[INPUT] 0    0    [1    /1   ]  7617.12713017        1
[INPUT] 0    0    [1    /1   ]  3617.49777843        1
[INPUT] 0    0    [1    /1   ]  1588.96038173        1
[INPUT] 0    0    [1    /1   ]  415.415780019        1
[INPUT] 0    0    [1    /1   ]  121.260474839        1
[INPUT] 0    0    [1    /1   ]  39.1553026639        1
[INPUT] 0    0    [1    /1   ]  8.50283332678        1
[INPUT] 0    0    [1    /1   ]  3.34195118633        1
[INPUT] 0    0    [1    /1   ]  0.663666114877       1
[INPUT] 0    0    [1    /1   ]  0.245206577074       1
[INPUT] 1    0    [1    /1   ]  1362.83830185        1
[INPUT] 1    0    [1    /1   ]  664.208300713        1
[INPUT] 1    0    [1    /1   ]  298.429622283        1
[INPUT] 1    0    [1    /1   ]  311.859506693        1
[INPUT] 1    0    [1    /1   ]  63.2064510439        1
[INPUT] 1    0    [1    /1   ]  7.1421705117         1
[INPUT] 1    0    [1    /1   ]  20.1250733739        1
[INPUT] 1    0    [1    /1   ]  0.767197745213       1
[INPUT] 1    0    [1    /1   ]  2.73398273812        1
[INPUT] 1    0    [1    /1   ]  0.220670619424       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.823128108703, 1.0]], [0, [7617.127130170086, 1.0]], [0, [3617.4977784294906, 1.0]], [0, [1588.960381732553, 1.0]], [0, [415.4157800190658, 1.0]], [0, [121.26047483897638, 1.0]], [0, [39.15530266390198, 1.0]], [0, [8.50283332677951, 1.0]], [0, [3.3419511863270963, 1.0]], [0, [0.6636661148773393, 1.0]], [0, [0.24520657707363258, 1.0]], [1, [1362.8383018509367, 1.0]], [1, [664.2083007134712, 1.0]], [1, [298.4296222832513, 1.0]], [1, [311.85950669271494, 1.0]], [1, [63.206451043887526, 1.0]], [1, [7.142170511704314, 1.0]], [1, [20.125073373948293, 1.0]], [1, [0.7671977452129395, 1.0]], [1, [2.7339827381248316, 1.0]], [1, [0.22067061942416288, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.82312811]
bas 1, expnt(s) = [7617.12713017]
bas 2, expnt(s) = [3617.49777843]
bas 3, expnt(s) = [1588.96038173]
bas 4, expnt(s) = [415.41578002]
bas 5, expnt(s) = [121.26047484]
bas 6, expnt(s) = [39.15530266]
bas 7, expnt(s) = [8.50283333]
bas 8, expnt(s) = [3.34195119]
bas 9, expnt(s) = [0.66366611]
bas 10, expnt(s) = [0.24520658]
bas 11, expnt(s) = [1362.83830185]
bas 12, expnt(s) = [664.20830071]
bas 13, expnt(s) = [298.42962228]
bas 14, expnt(s) = [311.85950669]
bas 15, expnt(s) = [63.20645104]
bas 16, expnt(s) = [7.14217051]
bas 17, expnt(s) = [20.12507337]
bas 18, expnt(s) = [0.76719775]
bas 19, expnt(s) = [2.73398274]
bas 20, expnt(s) = [0.22067062]
CPU time:       389.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828231e+04 5.20028778e+03 7.61712713e+03 2.05995829e+03
 3.61749778e+03 1.17847732e+03 1.58896038e+03 6.35842900e+02
 4.15415780e+02 2.32475541e+02 1.21260475e+02 9.23218445e+01
 3.91553027e+01 3.95464918e+01 8.50283333e+00 1.25802066e+01
 3.34195119e+00 6.24475064e+00 6.63666115e-01 1.85770717e+00
 2.45206577e-01 8.80367721e-01 1.36283830e+03 2.41568224e+04
 6.64208301e+02 9.83704744e+03 2.98429622e+02 3.61856855e+03
 3.11859507e+02 3.82325378e+03 6.32064510e+01 5.19919552e+02
 7.14217051e+00 3.40621581e+01 2.01250734e+01 1.24352990e+02
 7.67197745e-01 2.09468412e+00 2.73398274e+00 1.02560258e+01
 2.20670619e-01 4.41230002e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99382628260445
cond(S) = 97708.38525538756
E1 = -729.5310791566918  E_coul = 203.17940955675957
init E= -526.351669599932
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555890729429754  LUMO = 1.01753106158503
  mo_energy =
[-1.18331828e+02 -1.22047767e+01 -9.44656067e+00 -9.44656067e+00
 -9.44656067e+00 -1.24000034e+00 -5.55890729e-01 -5.55890729e-01
 -5.55890729e-01  1.01753106e+00  1.01753106e+00  1.01753106e+00
  1.03024187e+00  7.13100053e+00  7.13100053e+00  7.13100053e+00
  1.35130986e+01  3.26826956e+01  3.26826956e+01  3.26826956e+01
  1.21446444e+02  1.29320279e+02  1.29320279e+02  1.29320279e+02
  4.85075915e+02  4.85075915e+02  4.85075915e+02  6.58745027e+02
  1.33292719e+03  1.33292719e+03  1.33292719e+03  2.79849225e+03
  3.02071563e+03  3.02071563e+03  3.02071563e+03  6.63667934e+03
  6.63667934e+03  6.63667934e+03  9.21860026e+03  2.55666204e+04
  7.62972942e+04]
E1 = -727.8454903212274  E_coul = 201.1009417974343
cycle= 1 E= -526.744548523793  delta_E= -0.393  |g|= 0.186  |ddm|= 0.299
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538588
diis-c [-0.29007729  1.        ]
  HOMO = -0.591169681879449  LUMO = 0.99333525998633
  mo_energy =
[-1.18639517e+02 -1.23430390e+01 -9.59543352e+00 -9.59543352e+00
 -9.59543352e+00 -1.27993651e+00 -5.91169682e-01 -5.91169682e-01
 -5.91169682e-01  9.93335260e-01  9.93335260e-01  9.93335260e-01
  1.00092857e+00  7.04126362e+00  7.04126362e+00  7.04126362e+00
  1.33986965e+01  3.25290057e+01  3.25290057e+01  3.25290057e+01
  1.21217130e+02  1.29090428e+02  1.29090428e+02  1.29090428e+02
  4.84769714e+02  4.84769714e+02  4.84769714e+02  6.58392761e+02
  1.33256570e+03  1.33256570e+03  1.33256570e+03  2.79799632e+03
  3.02028868e+03  3.02028868e+03  3.02028868e+03  6.63614047e+03
  6.63614047e+03  6.63614047e+03  9.21798786e+03  2.55659143e+04
  7.62964984e+04]
E1 = -728.4220963386507  E_coul = 201.67682620501853
cycle= 2 E= -526.745270133632  delta_E= -0.000722  |g|= 0.0377  |ddm|= 0.054
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0749525
diis-c [-0.00328723  0.08269342  0.91730658]
  HOMO = -0.581990552292895  LUMO = 0.999994429426911
  mo_energy =
[-1.18571665e+02 -1.23048197e+01 -9.55555680e+00 -9.55555680e+00
 -9.55555680e+00 -1.26895025e+00 -5.81990552e-01 -5.81990552e-01
 -5.81990552e-01  9.99994429e-01  9.99994429e-01  9.99994429e-01
  1.00927027e+00  7.06472754e+00  7.06472754e+00  7.06472754e+00
  1.34300373e+01  3.25690623e+01  3.25690623e+01  3.25690623e+01
  1.21274546e+02  1.29146708e+02  1.29146708e+02  1.29146708e+02
  4.84836757e+02  4.84836757e+02  4.84836757e+02  6.58462687e+02
  1.33263675e+03  1.33263675e+03  1.33263675e+03  2.79807076e+03
  3.02036199e+03  3.02036199e+03  3.02036199e+03  6.63621554e+03
  6.63621554e+03  6.63621554e+03  9.21806375e+03  2.55659908e+04
  7.62965752e+04]
E1 = -728.270640394737  E_coul = 201.52531072598063
cycle= 3 E= -526.745329668756  delta_E= -5.95e-05  |g|= 0.00631  |ddm|= 0.0165
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131557
diis-c [-5.53814854e-07 -1.22712530e-03  1.44952328e-01  8.56274798e-01]
  HOMO = -0.58350444967073  LUMO = 0.998919634843142
  mo_energy =
[-1.18581673e+02 -1.23106686e+01 -9.56175092e+00 -9.56175092e+00
 -9.56175092e+00 -1.27066176e+00 -5.83504450e-01 -5.83504450e-01
 -5.83504450e-01  9.98919635e-01  9.98919635e-01  9.98919635e-01
  1.00798925e+00  7.06098403e+00  7.06098403e+00  7.06098403e+00
  1.34252177e+01  3.25628772e+01  3.25628772e+01  3.25628772e+01
  1.21266013e+02  1.29138283e+02  1.29138283e+02  1.29138283e+02
  4.84826864e+02  4.84826864e+02  4.84826864e+02  6.58452361e+02
  1.33262627e+03  1.33262627e+03  1.33262627e+03  2.79805965e+03
  3.02035113e+03  3.02035113e+03  3.02035113e+03  6.63620429e+03
  6.63620429e+03  6.63620429e+03  9.21805228e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.2936684250898  E_coul = 201.54833680325072
cycle= 4 E= -526.745331621839  delta_E= -1.95e-06  |g|= 9.56e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109237
diis-c [-4.05879973e-09  6.78880798e-05 -9.81667720e-03 -6.35498244e-02
  1.07329861e+00]
  HOMO = -0.583485870031813  LUMO = 0.998935314357357
  mo_energy =
[-1.18581632e+02 -1.23106036e+01 -9.56169901e+00 -9.56169901e+00
 -9.56169901e+00 -1.27062111e+00 -5.83485870e-01 -5.83485870e-01
 -5.83485870e-01  9.98935314e-01  9.98935314e-01  9.98935314e-01
  1.00802319e+00  7.06102576e+00  7.06102576e+00  7.06102576e+00
  1.34252778e+01  3.25629269e+01  3.25629269e+01  3.25629269e+01
  1.21266065e+02  1.29138331e+02  1.29138331e+02  1.29138331e+02
  4.84826905e+02  4.84826905e+02  4.84826905e+02  6.58452395e+02
  1.33262631e+03  1.33262631e+03  1.33262631e+03  2.79805966e+03
  3.02035115e+03  3.02035115e+03  3.02035115e+03  6.63620430e+03
  6.63620430e+03  6.63620430e+03  9.21805229e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.293453981925  E_coul = 201.5481223584849
cycle= 5 E= -526.74533162344  delta_E= -1.6e-09  |g|= 2.05e-05  |ddm|= 0.000154
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8767e-05
diis-c [-7.00152028e-11  1.44398898e-05 -1.88855201e-03 -1.40542282e-02
  4.16055158e-02  9.74322825e-01]
  HOMO = -0.583493210064847  LUMO = 0.998930530573262
  mo_energy =
[-1.18581663e+02 -1.23106259e+01 -9.56172319e+00 -9.56172319e+00
 -9.56172319e+00 -1.27062695e+00 -5.83493210e-01 -5.83493210e-01
 -5.83493210e-01  9.98930531e-01  9.98930531e-01  9.98930531e-01
  1.00801925e+00  7.06100962e+00  7.06100962e+00  7.06100962e+00
  1.34252594e+01  3.25629035e+01  3.25629035e+01  3.25629035e+01
  1.21266037e+02  1.29138304e+02  1.29138304e+02  1.29138304e+02
  4.84826875e+02  4.84826875e+02  4.84826875e+02  6.58452364e+02
  1.33262628e+03  1.33262628e+03  1.33262628e+03  2.79805963e+03
  3.02035112e+03  3.02035112e+03  3.02035112e+03  6.63620426e+03
  6.63620426e+03  6.63620426e+03  9.21805225e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.2935351044606  E_coul = 201.54820348096302
cycle= 6 E= -526.745331623498  delta_E= -5.74e-11  |g|= 1.71e-06  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2935351044606  E_coul = 201.54820348096302
  HOMO = -0.583493238196317  LUMO = 0.998930566060552
  mo_energy =
[-1.18581662e+02 -1.23106258e+01 -9.56172318e+00 -9.56172318e+00
 -9.56172318e+00 -1.27062660e+00 -5.83493238e-01 -5.83493238e-01
 -5.83493238e-01  9.98930566e-01  9.98930566e-01  9.98930566e-01
  1.00801958e+00  7.06100964e+00  7.06100964e+00  7.06100964e+00
  1.34252595e+01  3.25629036e+01  3.25629036e+01  3.25629036e+01
  1.21266037e+02  1.29138304e+02  1.29138304e+02  1.29138304e+02
  4.84826875e+02  4.84826875e+02  4.84826875e+02  6.58452364e+02
  1.33262628e+03  1.33262628e+03  1.33262628e+03  2.79805963e+03
  3.02035112e+03  3.02035112e+03  3.02035112e+03  6.63620426e+03
  6.63620426e+03  6.63620426e+03  9.21805225e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.2935343116833  E_coul = 201.54820268818517
Extra cycle  E= -526.745331623498  delta_E= -5.68e-13  |g|= 3.52e-07  |ddm|= 2.98e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97708.38525538756
E1 = -728.2935343116833  E_coul = 201.54820268818517
init E= -526.745331623498
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.583493264476665  LUMO = 0.998930559223375
  mo_energy =
[-1.18581663e+02 -1.23106258e+01 -9.56172325e+00 -9.56172325e+00
 -9.56172325e+00 -1.27062655e+00 -5.83493264e-01 -5.83493264e-01
 -5.83493264e-01  9.98930559e-01  9.98930559e-01  9.98930559e-01
  1.00801963e+00  7.06100960e+00  7.06100960e+00  7.06100960e+00
  1.34252595e+01  3.25629035e+01  3.25629035e+01  3.25629035e+01
  1.21266037e+02  1.29138304e+02  1.29138304e+02  1.29138304e+02
  4.84826875e+02  4.84826875e+02  4.84826875e+02  6.58452364e+02
  1.33262628e+03  1.33262628e+03  1.33262628e+03  2.79805963e+03
  3.02035112e+03  3.02035112e+03  3.02035112e+03  6.63620426e+03
  6.63620426e+03  6.63620426e+03  9.21805225e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.2935344322739  E_coul = 201.5482028087751
cycle= 1 E= -526.745331623499  delta_E= -5.68e-13  |g|= 7.34e-08  |ddm|= 5.88e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2935344322739  E_coul = 201.5482028087751
  HOMO = -0.583493264572729  LUMO = 0.998930561567904
  mo_energy =
[-1.18581663e+02 -1.23106258e+01 -9.56172325e+00 -9.56172325e+00
 -9.56172325e+00 -1.27062653e+00 -5.83493265e-01 -5.83493265e-01
 -5.83493265e-01  9.98930562e-01  9.98930562e-01  9.98930562e-01
  1.00801964e+00  7.06100960e+00  7.06100960e+00  7.06100960e+00
  1.34252595e+01  3.25629035e+01  3.25629035e+01  3.25629035e+01
  1.21266037e+02  1.29138304e+02  1.29138304e+02  1.29138304e+02
  4.84826875e+02  4.84826875e+02  4.84826875e+02  6.58452364e+02
  1.33262628e+03  1.33262628e+03  1.33262628e+03  2.79805963e+03
  3.02035112e+03  3.02035112e+03  3.02035112e+03  6.63620426e+03
  6.63620426e+03  6.63620426e+03  9.21805225e+03  2.55659791e+04
  7.62965634e+04]
E1 = -728.2935343768627  E_coul = 201.54820275336354
Extra cycle  E= -526.745331623499  delta_E= -4.55e-13  |g|= 1.48e-08  |ddm|= 1.23e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828231e+04 7.61712713e+03 3.61749778e+03 1.58896038e+03
 4.15415780e+02 1.21260475e+02 3.91553027e+01 8.50283333e+00
 3.34195119e+00 6.63666115e-01 2.45206577e-01 1.36283830e+03
 6.64208301e+02 2.98429622e+02 3.11859507e+02 6.32064510e+01
 7.14217051e+00 2.01250734e+01 7.67197745e-01 2.73398274e+00
 2.20670619e-01]
grad_E = [-1.40352927e-06  2.20989829e-06 -2.12334643e-06  3.80340363e-05
  3.09143386e-05 -1.96921421e-04  1.90295851e-04  3.64868252e-04
 -9.29685187e-04 -2.07645189e-04 -2.34666329e-03 -6.35737576e-07
  3.07824047e-06  1.27522160e-05  1.09182377e-05  5.53337646e-04
 -2.88727498e-03 -8.00440716e-04  2.96108619e-03  2.02065661e-03
 -8.55886621e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8210189        1
[INPUT] 0    0    [1    /1   ]  7617.13220512        1
[INPUT] 0    0    [1    /1   ]  3617.49601125        1
[INPUT] 0    0    [1    /1   ]  1589.07616382        1
[INPUT] 0    0    [1    /1   ]  414.899126388        1
[INPUT] 0    0    [1    /1   ]  121.446195336        1
[INPUT] 0    0    [1    /1   ]  39.2143838978        1
[INPUT] 0    0    [1    /1   ]  8.46759894606        1
[INPUT] 0    0    [1    /1   ]  3.34110793566        1
[INPUT] 0    0    [1    /1   ]  0.670689313179       1
[INPUT] 0    0    [1    /1   ]  0.248273039896       1
[INPUT] 1    0    [1    /1   ]  1362.83761001        1
[INPUT] 1    0    [1    /1   ]  664.215035558        1
[INPUT] 1    0    [1    /1   ]  298.461357101        1
[INPUT] 1    0    [1    /1   ]  311.886858921        1
[INPUT] 1    0    [1    /1   ]  63.1861495147        1
[INPUT] 1    0    [1    /1   ]  7.15392422182        1
[INPUT] 1    0    [1    /1   ]  20.1281498822        1
[INPUT] 1    0    [1    /1   ]  0.766725541612       1
[INPUT] 1    0    [1    /1   ]  2.7300927277         1
[INPUT] 1    0    [1    /1   ]  0.220804217058       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.821018856597, 1.0]], [0, [7617.132205117966, 1.0]], [0, [3617.496011250214, 1.0]], [0, [1589.076163823311, 1.0]], [0, [414.8991263884689, 1.0]], [0, [121.44619533611677, 1.0]], [0, [39.21438389780701, 1.0]], [0, [8.467598946060928, 1.0]], [0, [3.3411079356597635, 1.0]], [0, [0.670689313179275, 1.0]], [0, [0.24827303989585783, 1.0]], [1, [1362.8376100111586, 1.0]], [1, [664.2150355583061, 1.0]], [1, [298.4613571008842, 1.0]], [1, [311.886858920928, 1.0]], [1, [63.186149514728136, 1.0]], [1, [7.153924221817381, 1.0]], [1, [20.128149882154027, 1.0]], [1, [0.7667255416118279, 1.0]], [1, [2.730092727702752, 1.0]], [1, [0.22080421705756856, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.82101886]
bas 1, expnt(s) = [7617.13220512]
bas 2, expnt(s) = [3617.49601125]
bas 3, expnt(s) = [1589.07616382]
bas 4, expnt(s) = [414.89912639]
bas 5, expnt(s) = [121.44619534]
bas 6, expnt(s) = [39.2143839]
bas 7, expnt(s) = [8.46759895]
bas 8, expnt(s) = [3.34110794]
bas 9, expnt(s) = [0.67068931]
bas 10, expnt(s) = [0.24827304]
bas 11, expnt(s) = [1362.83761001]
bas 12, expnt(s) = [664.21503556]
bas 13, expnt(s) = [298.4613571]
bas 14, expnt(s) = [311.88685892]
bas 15, expnt(s) = [63.18614951]
bas 16, expnt(s) = [7.15392422]
bas 17, expnt(s) = [20.12814988]
bas 18, expnt(s) = [0.76672554]
bas 19, expnt(s) = [2.73009273]
bas 20, expnt(s) = [0.22080422]
CPU time:       395.25
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828210e+04 5.20028747e+03 7.61713221e+03 2.05995932e+03
 3.61749601e+03 1.17847689e+03 1.58907616e+03 6.35877648e+02
 4.14899126e+02 2.32258659e+02 1.21446195e+02 9.24278731e+01
 3.92143839e+01 3.95912370e+01 8.46759895e+00 1.25410886e+01
 3.34110794e+00 6.24356883e+00 6.70689313e-01 1.87243204e+00
 2.48273040e-01 8.88612045e-01 1.36283761e+03 2.41568070e+04
 6.64215036e+02 9.83717212e+03 2.98461357e+02 3.61904955e+03
 3.11886859e+02 3.82367295e+03 6.31861495e+01 5.19710817e+02
 7.15392422e+00 3.41322417e+01 2.01281499e+01 1.24376753e+02
 7.66725542e-01 2.09307267e+00 2.73009273e+00 1.02377882e+01
 2.20804217e-01 4.41563937e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993797843288448
cond(S) = 97810.06665506843
E1 = -729.5309947716045  E_coul = 203.1789403309308
init E= -526.352054440674
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555876776926577  LUMO = 1.01759248271013
  mo_energy =
[-1.18331901e+02 -1.22048658e+01 -9.44661917e+00 -9.44661917e+00
 -9.44661917e+00 -1.23997085e+00 -5.55876777e-01 -5.55876777e-01
 -5.55876777e-01  1.01759248e+00  1.01759248e+00  1.01759248e+00
  1.05008961e+00  7.12648849e+00  7.12648849e+00  7.12648849e+00
  1.35228469e+01  3.26975344e+01  3.26975344e+01  3.26975344e+01
  1.21538242e+02  1.29337379e+02  1.29337379e+02  1.29337379e+02
  4.85075800e+02  4.85075800e+02  4.85075800e+02  6.58969043e+02
  1.33297568e+03  1.33297568e+03  1.33297568e+03  2.79801858e+03
  3.02084453e+03  3.02084453e+03  3.02084453e+03  6.63686424e+03
  6.63686424e+03  6.63686424e+03  9.21783456e+03  2.55658756e+04
  7.62966168e+04]
E1 = -727.8517930163351  E_coul = 201.10716766345428
cycle= 1 E= -526.744625352881  delta_E= -0.393  |g|= 0.185  |ddm|= 0.304
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538368
diis-c [-0.28984034  1.        ]
  HOMO = -0.590919017228523  LUMO = 0.993580629512902
  mo_energy =
[-1.18639066e+02 -1.23426786e+01 -9.59501317e+00 -9.59501317e+00
 -9.59501317e+00 -1.27968353e+00 -5.90919017e-01 -5.90919017e-01
 -5.90919017e-01  9.93580630e-01  9.93580630e-01  9.93580630e-01
  1.02054325e+00  7.03713303e+00  7.03713303e+00  7.03713303e+00
  1.34089415e+01  3.25442566e+01  3.25442566e+01  3.25442566e+01
  1.21309400e+02  1.29108046e+02  1.29108046e+02  1.29108046e+02
  4.84770142e+02  4.84770142e+02  4.84770142e+02  6.58617316e+02
  1.33261468e+03  1.33261468e+03  1.33261468e+03  2.79752327e+03
  3.02041814e+03  3.02041814e+03  3.02041814e+03  6.63632594e+03
  6.63632594e+03  6.63632594e+03  9.21722275e+03  2.55651701e+04
  7.62958216e+04]
E1 = -728.4266814818166  E_coul = 201.68133865136195
cycle= 2 E= -526.745342830455  delta_E= -0.000717  |g|= 0.0376  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747744
diis-c [-0.00327709  0.08245375  0.91754625]
  HOMO = -0.581770407643712  LUMO = 1.00021307781624
  mo_energy =
[-1.18571369e+02 -1.23045676e+01 -9.55524429e+00 -9.55524429e+00
 -9.55524429e+00 -1.26873682e+00 -5.81770408e-01 -5.81770408e-01
 -5.81770408e-01  1.00021308e+00  1.00021308e+00  1.00021308e+00
  1.02896404e+00  7.06052331e+00  7.06052331e+00  7.06052331e+00
  1.34401494e+01  3.25842160e+01  3.25842160e+01  3.25842160e+01
  1.21366693e+02  1.29164187e+02  1.29164187e+02  1.29164187e+02
  4.84837031e+02  4.84837031e+02  4.84837031e+02  6.58687085e+02
  1.33268558e+03  1.33268558e+03  1.33268558e+03  2.79759755e+03
  3.02049129e+03  3.02049129e+03  3.02049129e+03  6.63640085e+03
  6.63640085e+03  6.63640085e+03  9.21729848e+03  2.55652464e+04
  7.62958982e+04]
E1 = -728.2756950490377  E_coul = 201.53029305224885
cycle= 3 E= -526.745401996789  delta_E= -5.92e-05  |g|= 0.00631  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131354
diis-c [-5.43190059e-07 -1.22394312e-03  1.45070060e-01  8.56153883e-01]
  HOMO = -0.583279499882802  LUMO = 0.999142143595302
  mo_energy =
[-1.18581365e+02 -1.23104075e+01 -9.56142848e+00 -9.56142848e+00
 -9.56142848e+00 -1.27044486e+00 -5.83279500e-01 -5.83279500e-01
 -5.83279500e-01  9.99142144e-01  9.99142144e-01  9.99142144e-01
  1.02766852e+00  7.05678830e+00  7.05678830e+00  7.05678830e+00
  1.34353429e+01  3.25780391e+01  3.25780391e+01  3.25780391e+01
  1.21358170e+02  1.29155773e+02  1.29155773e+02  1.29155773e+02
  4.84827151e+02  4.84827151e+02  4.84827151e+02  6.58676772e+02
  1.33267511e+03  1.33267511e+03  1.33267511e+03  2.79758645e+03
  3.02048044e+03  3.02048044e+03  3.02048044e+03  6.63638961e+03
  6.63638961e+03  6.63638961e+03  9.21728703e+03  2.55652348e+04
  7.62958865e+04]
E1 = -728.2986839279732  E_coul = 201.55327998555185
cycle= 4 E= -526.745403942421  delta_E= -1.95e-06  |g|= 9.36e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106497
diis-c [-3.96548944e-09  6.58456493e-05 -9.57860224e-03 -6.19063744e-02
  1.07141913e+00]
  HOMO = -0.583260566594971  LUMO = 0.999157989802465
  mo_energy =
[-1.18581323e+02 -1.23103420e+01 -9.56137580e+00 -9.56137580e+00
 -9.56137580e+00 -1.27040440e+00 -5.83260567e-01 -5.83260567e-01
 -5.83260567e-01  9.99157990e-01  9.99157990e-01  9.99157990e-01
  1.02770261e+00  7.05683055e+00  7.05683055e+00  7.05683055e+00
  1.34354034e+01  3.25780896e+01  3.25780896e+01  3.25780896e+01
  1.21358222e+02  1.29155822e+02  1.29155822e+02  1.29155822e+02
  4.84827193e+02  4.84827193e+02  4.84827193e+02  6.58676807e+02
  1.33267515e+03  1.33267515e+03  1.33267515e+03  2.79758646e+03
  3.02048046e+03  3.02048046e+03  3.02048046e+03  6.63638962e+03
  6.63638962e+03  6.63638962e+03  9.21728703e+03  2.55652348e+04
  7.62958865e+04]
E1 = -728.2984689652187  E_coul = 201.55306502128664
cycle= 5 E= -526.745403943932  delta_E= -1.51e-09  |g|= 2.02e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.84285e-05
diis-c [-6.71858323e-11  1.42765572e-05 -1.87436811e-03 -1.39390999e-02
  4.25709452e-02  9.73228246e-01]
  HOMO = -0.583267791357513  LUMO = 0.999153281895776
  mo_energy =
[-1.18581353e+02 -1.23103640e+01 -9.56139969e+00 -9.56139969e+00
 -9.56139969e+00 -1.27041017e+00 -5.83267791e-01 -5.83267791e-01
 -5.83267791e-01  9.99153282e-01  9.99153282e-01  9.99153282e-01
  1.02769865e+00  7.05681463e+00  7.05681463e+00  7.05681463e+00
  1.34353851e+01  3.25780665e+01  3.25780665e+01  3.25780665e+01
  1.21358195e+02  1.29155795e+02  1.29155795e+02  1.29155795e+02
  4.84827163e+02  4.84827163e+02  4.84827163e+02  6.58676776e+02
  1.33267511e+03  1.33267511e+03  1.33267511e+03  2.79758643e+03
  3.02048043e+03  3.02048043e+03  3.02048043e+03  6.63638959e+03
  6.63638959e+03  6.63638959e+03  9.21728700e+03  2.55652348e+04
  7.62958864e+04]
E1 = -728.2985492850419  E_coul = 201.55314534105455
cycle= 6 E= -526.745403943987  delta_E= -5.53e-11  |g|= 1.69e-06  |ddm|= 1.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2985492850419  E_coul = 201.55314534105455
  HOMO = -0.583267829473109  LUMO = 0.999153309809617
  mo_energy =
[-1.18581353e+02 -1.23103639e+01 -9.56139972e+00 -9.56139972e+00
 -9.56139972e+00 -1.27040984e+00 -5.83267829e-01 -5.83267829e-01
 -5.83267829e-01  9.99153310e-01  9.99153310e-01  9.99153310e-01
  1.02769896e+00  7.05681462e+00  7.05681462e+00  7.05681462e+00
  1.34353853e+01  3.25780665e+01  3.25780665e+01  3.25780665e+01
  1.21358195e+02  1.29155795e+02  1.29155795e+02  1.29155795e+02
  4.84827163e+02  4.84827163e+02  4.84827163e+02  6.58676776e+02
  1.33267511e+03  1.33267511e+03  1.33267511e+03  2.79758643e+03
  3.02048043e+03  3.02048043e+03  3.02048043e+03  6.63638959e+03
  6.63638959e+03  6.63638959e+03  9.21728700e+03  2.55652348e+04
  7.62958864e+04]
E1 = -728.2985486878601  E_coul = 201.55314474387112
Extra cycle  E= -526.745403943989  delta_E= -1.71e-12  |g|= 3.48e-07  |ddm|= 2.93e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
exp = [2.61828210e+04 7.61713221e+03 3.61749601e+03 1.58907616e+03
 4.14899126e+02 1.21446195e+02 3.92143839e+01 8.46759895e+00
 3.34110794e+00 6.70689313e-01 2.48273040e-01 1.36283761e+03
 6.64215036e+02 2.98461357e+02 3.11886859e+02 6.31861495e+01
 7.15392422e+00 2.01281499e+01 7.66725542e-01 2.73009273e+00
 2.20804217e-01]
E = -526.745403943989
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8210189        1
[INPUT] 0    0    [1    /1   ]  7617.13220512        1
[INPUT] 0    0    [1    /1   ]  3617.49601125        1
[INPUT] 0    0    [1    /1   ]  1589.07616382        1
[INPUT] 0    0    [1    /1   ]  414.899126388        1
[INPUT] 0    0    [1    /1   ]  121.446195336        1
[INPUT] 0    0    [1    /1   ]  39.2143838978        1
[INPUT] 0    0    [1    /1   ]  8.46759894606        1
[INPUT] 0    0    [1    /1   ]  3.34110793566        1
[INPUT] 0    0    [1    /1   ]  0.670689313179       1
[INPUT] 0    0    [1    /1   ]  0.248273039896       1
[INPUT] 1    0    [1    /1   ]  1362.83761001        1
[INPUT] 1    0    [1    /1   ]  664.215035558        1
[INPUT] 1    0    [1    /1   ]  298.461357101        1
[INPUT] 1    0    [1    /1   ]  311.886858921        1
[INPUT] 1    0    [1    /1   ]  63.1861495147        1
[INPUT] 1    0    [1    /1   ]  7.15392422182        1
[INPUT] 1    0    [1    /1   ]  20.1281498822        1
[INPUT] 1    0    [1    /1   ]  0.766725541612       1
[INPUT] 1    0    [1    /1   ]  2.7300927277         1
[INPUT] 1    0    [1    /1   ]  0.220804217058       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.821018856597, 1.0]], [0, [7617.132205117966, 1.0]], [0, [3617.496011250214, 1.0]], [0, [1589.076163823311, 1.0]], [0, [414.8991263884689, 1.0]], [0, [121.44619533611677, 1.0]], [0, [39.21438389780701, 1.0]], [0, [8.467598946060928, 1.0]], [0, [3.3411079356597635, 1.0]], [0, [0.670689313179275, 1.0]], [0, [0.24827303989585783, 1.0]], [1, [1362.8376100111586, 1.0]], [1, [664.2150355583061, 1.0]], [1, [298.4613571008842, 1.0]], [1, [311.886858920928, 1.0]], [1, [63.186149514728136, 1.0]], [1, [7.153924221817381, 1.0]], [1, [20.128149882154027, 1.0]], [1, [0.7667255416118279, 1.0]], [1, [2.730092727702752, 1.0]], [1, [0.22080421705756856, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.82101886]
bas 1, expnt(s) = [7617.13220512]
bas 2, expnt(s) = [3617.49601125]
bas 3, expnt(s) = [1589.07616382]
bas 4, expnt(s) = [414.89912639]
bas 5, expnt(s) = [121.44619534]
bas 6, expnt(s) = [39.2143839]
bas 7, expnt(s) = [8.46759895]
bas 8, expnt(s) = [3.34110794]
bas 9, expnt(s) = [0.67068931]
bas 10, expnt(s) = [0.24827304]
bas 11, expnt(s) = [1362.83761001]
bas 12, expnt(s) = [664.21503556]
bas 13, expnt(s) = [298.4613571]
bas 14, expnt(s) = [311.88685892]
bas 15, expnt(s) = [63.18614951]
bas 16, expnt(s) = [7.15392422]
bas 17, expnt(s) = [20.12814988]
bas 18, expnt(s) = [0.76672554]
bas 19, expnt(s) = [2.73009273]
bas 20, expnt(s) = [0.22080422]
CPU time:       395.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828210e+04 5.20028747e+03 7.61713221e+03 2.05995932e+03
 3.61749601e+03 1.17847689e+03 1.58907616e+03 6.35877648e+02
 4.14899126e+02 2.32258659e+02 1.21446195e+02 9.24278731e+01
 3.92143839e+01 3.95912370e+01 8.46759895e+00 1.25410886e+01
 3.34110794e+00 6.24356883e+00 6.70689313e-01 1.87243204e+00
 2.48273040e-01 8.88612045e-01 1.36283761e+03 2.41568070e+04
 6.64215036e+02 9.83717212e+03 2.98461357e+02 3.61904955e+03
 3.11886859e+02 3.82367295e+03 6.31861495e+01 5.19710817e+02
 7.15392422e+00 3.41322417e+01 2.01281499e+01 1.24376753e+02
 7.66725542e-01 2.09307267e+00 2.73009273e+00 1.02377882e+01
 2.20804217e-01 4.41563937e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993797843288448
cond(S) = 97810.06665506843
E1 = -729.5309947716045  E_coul = 203.1789403309308
init E= -526.352054440674
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555876776926577  LUMO = 1.01759248271013
  mo_energy =
[-1.18331901e+02 -1.22048658e+01 -9.44661917e+00 -9.44661917e+00
 -9.44661917e+00 -1.23997085e+00 -5.55876777e-01 -5.55876777e-01
 -5.55876777e-01  1.01759248e+00  1.01759248e+00  1.01759248e+00
  1.05008961e+00  7.12648849e+00  7.12648849e+00  7.12648849e+00
  1.35228469e+01  3.26975344e+01  3.26975344e+01  3.26975344e+01
  1.21538242e+02  1.29337379e+02  1.29337379e+02  1.29337379e+02
  4.85075800e+02  4.85075800e+02  4.85075800e+02  6.58969043e+02
  1.33297568e+03  1.33297568e+03  1.33297568e+03  2.79801858e+03
  3.02084453e+03  3.02084453e+03  3.02084453e+03  6.63686424e+03
  6.63686424e+03  6.63686424e+03  9.21783456e+03  2.55658756e+04
  7.62966168e+04]
E1 = -727.8517930163351  E_coul = 201.10716766345428
cycle= 1 E= -526.744625352881  delta_E= -0.393  |g|= 0.185  |ddm|= 0.304
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538368
diis-c [-0.28984034  1.        ]
  HOMO = -0.590919017228523  LUMO = 0.993580629512902
  mo_energy =
[-1.18639066e+02 -1.23426786e+01 -9.59501317e+00 -9.59501317e+00
 -9.59501317e+00 -1.27968353e+00 -5.90919017e-01 -5.90919017e-01
 -5.90919017e-01  9.93580630e-01  9.93580630e-01  9.93580630e-01
  1.02054325e+00  7.03713303e+00  7.03713303e+00  7.03713303e+00
  1.34089415e+01  3.25442566e+01  3.25442566e+01  3.25442566e+01
  1.21309400e+02  1.29108046e+02  1.29108046e+02  1.29108046e+02
  4.84770142e+02  4.84770142e+02  4.84770142e+02  6.58617316e+02
  1.33261468e+03  1.33261468e+03  1.33261468e+03  2.79752327e+03
  3.02041814e+03  3.02041814e+03  3.02041814e+03  6.63632594e+03
  6.63632594e+03  6.63632594e+03  9.21722275e+03  2.55651701e+04
  7.62958216e+04]
E1 = -728.4266814818166  E_coul = 201.68133865136195
cycle= 2 E= -526.745342830455  delta_E= -0.000717  |g|= 0.0376  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747744
diis-c [-0.00327709  0.08245375  0.91754625]
  HOMO = -0.581770407643712  LUMO = 1.00021307781624
  mo_energy =
[-1.18571369e+02 -1.23045676e+01 -9.55524429e+00 -9.55524429e+00
 -9.55524429e+00 -1.26873682e+00 -5.81770408e-01 -5.81770408e-01
 -5.81770408e-01  1.00021308e+00  1.00021308e+00  1.00021308e+00
  1.02896404e+00  7.06052331e+00  7.06052331e+00  7.06052331e+00
  1.34401494e+01  3.25842160e+01  3.25842160e+01  3.25842160e+01
  1.21366693e+02  1.29164187e+02  1.29164187e+02  1.29164187e+02
  4.84837031e+02  4.84837031e+02  4.84837031e+02  6.58687085e+02
  1.33268558e+03  1.33268558e+03  1.33268558e+03  2.79759755e+03
  3.02049129e+03  3.02049129e+03  3.02049129e+03  6.63640085e+03
  6.63640085e+03  6.63640085e+03  9.21729848e+03  2.55652464e+04
  7.62958982e+04]
E1 = -728.2756950490377  E_coul = 201.53029305224885
cycle= 3 E= -526.745401996789  delta_E= -5.92e-05  |g|= 0.00631  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131354
diis-c [-5.43190059e-07 -1.22394312e-03  1.45070060e-01  8.56153883e-01]
  HOMO = -0.583279499882802  LUMO = 0.999142143595302
  mo_energy =
[-1.18581365e+02 -1.23104075e+01 -9.56142848e+00 -9.56142848e+00
 -9.56142848e+00 -1.27044486e+00 -5.83279500e-01 -5.83279500e-01
 -5.83279500e-01  9.99142144e-01  9.99142144e-01  9.99142144e-01
  1.02766852e+00  7.05678830e+00  7.05678830e+00  7.05678830e+00
  1.34353429e+01  3.25780391e+01  3.25780391e+01  3.25780391e+01
  1.21358170e+02  1.29155773e+02  1.29155773e+02  1.29155773e+02
  4.84827151e+02  4.84827151e+02  4.84827151e+02  6.58676772e+02
  1.33267511e+03  1.33267511e+03  1.33267511e+03  2.79758645e+03
  3.02048044e+03  3.02048044e+03  3.02048044e+03  6.63638961e+03
  6.63638961e+03  6.63638961e+03  9.21728703e+03  2.55652348e+04
  7.62958865e+04]
E1 = -728.2986839279732  E_coul = 201.55327998555185
cycle= 4 E= -526.745403942421  delta_E= -1.95e-06  |g|= 9.36e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106497
diis-c [-3.96548944e-09  6.58456493e-05 -9.57860224e-03 -6.19063744e-02
  1.07141913e+00]
  HOMO = -0.583260566594971  LUMO = 0.999157989802465
  mo_energy =
[-1.18581323e+02 -1.23103420e+01 -9.56137580e+00 -9.56137580e+00
 -9.56137580e+00 -1.27040440e+00 -5.83260567e-01 -5.83260567e-01
 -5.83260567e-01  9.99157990e-01  9.99157990e-01  9.99157990e-01
  1.02770261e+00  7.05683055e+00  7.05683055e+00  7.05683055e+00
  1.34354034e+01  3.25780896e+01  3.25780896e+01  3.25780896e+01
  1.21358222e+02  1.29155822e+02  1.29155822e+02  1.29155822e+02
  4.84827193e+02  4.84827193e+02  4.84827193e+02  6.58676807e+02
  1.33267515e+03  1.33267515e+03  1.33267515e+03  2.79758646e+03
  3.02048046e+03  3.02048046e+03  3.02048046e+03  6.63638962e+03
  6.63638962e+03  6.63638962e+03  9.21728703e+03  2.55652348e+04
  7.62958865e+04]
E1 = -728.2984689652187  E_coul = 201.55306502128664
cycle= 5 E= -526.745403943932  delta_E= -1.51e-09  |g|= 2.02e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.84285e-05
diis-c [-6.71858323e-11  1.42765572e-05 -1.87436811e-03 -1.39390999e-02
  4.25709452e-02  9.73228246e-01]
  HOMO = -0.583267791357513  LUMO = 0.999153281895776
  mo_energy =
[-1.18581353e+02 -1.23103640e+01 -9.56139969e+00 -9.56139969e+00
 -9.56139969e+00 -1.27041017e+00 -5.83267791e-01 -5.83267791e-01
 -5.83267791e-01  9.99153282e-01  9.99153282e-01  9.99153282e-01
  1.02769865e+00  7.05681463e+00  7.05681463e+00  7.05681463e+00
  1.34353851e+01  3.25780665e+01  3.25780665e+01  3.25780665e+01
  1.21358195e+02  1.29155795e+02  1.29155795e+02  1.29155795e+02
  4.84827163e+02  4.84827163e+02  4.84827163e+02  6.58676776e+02
  1.33267511e+03  1.33267511e+03  1.33267511e+03  2.79758643e+03
  3.02048043e+03  3.02048043e+03  3.02048043e+03  6.63638959e+03
  6.63638959e+03  6.63638959e+03  9.21728700e+03  2.55652348e+04
  7.62958864e+04]
E1 = -728.2985492850419  E_coul = 201.55314534105455
cycle= 6 E= -526.745403943987  delta_E= -5.53e-11  |g|= 1.69e-06  |ddm|= 1.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.2985492850419  E_coul = 201.55314534105455
  HOMO = -0.583267829473109  LUMO = 0.999153309809617
  mo_energy =
[-1.18581353e+02 -1.23103639e+01 -9.56139972e+00 -9.56139972e+00
 -9.56139972e+00 -1.27040984e+00 -5.83267829e-01 -5.83267829e-01
 -5.83267829e-01  9.99153310e-01  9.99153310e-01  9.99153310e-01
  1.02769896e+00  7.05681462e+00  7.05681462e+00  7.05681462e+00
  1.34353853e+01  3.25780665e+01  3.25780665e+01  3.25780665e+01
  1.21358195e+02  1.29155795e+02  1.29155795e+02  1.29155795e+02
  4.84827163e+02  4.84827163e+02  4.84827163e+02  6.58676776e+02
  1.33267511e+03  1.33267511e+03  1.33267511e+03  2.79758643e+03
  3.02048043e+03  3.02048043e+03  3.02048043e+03  6.63638959e+03
  6.63638959e+03  6.63638959e+03  9.21728700e+03  2.55652348e+04
  7.62958864e+04]
E1 = -728.2985486878601  E_coul = 201.55314474387112
Extra cycle  E= -526.745403943989  delta_E= -1.71e-12  |g|= 3.48e-07  |ddm|= 2.93e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97810.06665506843
E1 = -728.2985486878601  E_coul = 201.55314474387112
init E= -526.745403943989
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.583267851386818  LUMO = 0.999153305954642
  mo_energy =
[-1.18581353e+02 -1.23103640e+01 -9.56139978e+00 -9.56139978e+00
 -9.56139978e+00 -1.27040979e+00 -5.83267851e-01 -5.83267851e-01
 -5.83267851e-01  9.99153306e-01  9.99153306e-01  9.99153306e-01
  1.02769901e+00  7.05681459e+00  7.05681459e+00  7.05681459e+00
  1.34353853e+01  3.25780664e+01  3.25780664e+01  3.25780664e+01
  1.21358195e+02  1.29155795e+02  1.29155795e+02  1.29155795e+02
  4.84827163e+02  4.84827163e+02  4.84827163e+02  6.58676776e+02
  1.33267511e+03  1.33267511e+03  1.33267511e+03  2.79758643e+03
  3.02048043e+03  3.02048043e+03  3.02048043e+03  6.63638959e+03
  6.63638959e+03  6.63638959e+03  9.21728700e+03  2.55652348e+04
  7.62958864e+04]
E1 = -728.2985487605699  E_coul = 201.55314481658107
cycle= 1 E= -526.745403943989  delta_E= 1.14e-13  |g|= 7.19e-08  |ddm|= 5.81e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.2985487605699  E_coul = 201.55314481658107
  HOMO = -0.583267852257254  LUMO = 0.999153307710292
  mo_energy =
[-1.18581353e+02 -1.23103640e+01 -9.56139978e+00 -9.56139978e+00
 -9.56139978e+00 -1.27040977e+00 -5.83267852e-01 -5.83267852e-01
 -5.83267852e-01  9.99153308e-01  9.99153308e-01  9.99153308e-01
  1.02769903e+00  7.05681459e+00  7.05681459e+00  7.05681459e+00
  1.34353853e+01  3.25780664e+01  3.25780664e+01  3.25780664e+01
  1.21358195e+02  1.29155795e+02  1.29155795e+02  1.29155795e+02
  4.84827163e+02  4.84827163e+02  4.84827163e+02  6.58676776e+02
  1.33267511e+03  1.33267511e+03  1.33267511e+03  2.79758643e+03
  3.02048043e+03  3.02048043e+03  3.02048043e+03  6.63638959e+03
  6.63638959e+03  6.63638959e+03  9.21728700e+03  2.55652348e+04
  7.62958864e+04]
E1 = -728.298548720303  E_coul = 201.5531447763146
Extra cycle  E= -526.745403943988  delta_E= 5.68e-13  |g|= 1.45e-08  |ddm|= 1.2e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828210e+04 7.61713221e+03 3.61749601e+03 1.58907616e+03
 4.14899126e+02 1.21446195e+02 3.92143839e+01 8.46759895e+00
 3.34110794e+00 6.70689313e-01 2.48273040e-01 1.36283761e+03
 6.64215036e+02 2.98461357e+02 3.11886859e+02 6.31861495e+01
 7.15392422e+00 2.01281499e+01 7.66725542e-01 2.73009273e+00
 2.20804217e-01]
grad_E = [-1.40988264e-06  2.26326350e-06 -2.13032691e-06  3.98999352e-05
 -3.26792232e-06 -5.25012247e-05  3.79506249e-05  3.10859850e-05
 -1.53175745e-04 -2.34585395e-04  1.26540035e-04 -6.36364060e-07
  3.05314771e-06  1.25843058e-05  1.07796086e-05  5.91597750e-04
 -9.67934924e-04 -1.29348321e-03  2.64622768e-04 -1.49079290e-04
 -1.06771654e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8164166        1
[INPUT] 0    0    [1    /1   ]  7617.14313736        1
[INPUT] 0    0    [1    /1   ]  3617.49203106        1
[INPUT] 0    0    [1    /1   ]  1589.32297154        1
[INPUT] 0    0    [1    /1   ]  413.927037358        1
[INPUT] 0    0    [1    /1   ]  121.329297473        1
[INPUT] 0    0    [1    /1   ]  39.2048445074        1
[INPUT] 0    0    [1    /1   ]  8.4594953011         1
[INPUT] 0    0    [1    /1   ]  3.34106894912        1
[INPUT] 0    0    [1    /1   ]  0.672753778722       1
[INPUT] 0    0    [1    /1   ]  0.248981730997       1
[INPUT] 1    0    [1    /1   ]  1362.8360963         1
[INPUT] 1    0    [1    /1   ]  664.22979187         1
[INPUT] 1    0    [1    /1   ]  298.530894326        1
[INPUT] 1    0    [1    /1   ]  311.946795241        1
[INPUT] 1    0    [1    /1   ]  63.1419407827        1
[INPUT] 1    0    [1    /1   ]  7.16255613152        1
[INPUT] 1    0    [1    /1   ]  20.1342465756        1
[INPUT] 1    0    [1    /1   ]  0.767018621563       1
[INPUT] 1    0    [1    /1   ]  2.73234956345        1
[INPUT] 1    0    [1    /1   ]  0.22093130007        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.816416560636, 1.0]], [0, [7617.143137361286, 1.0]], [0, [3617.4920310642474, 1.0]], [0, [1589.3229715370537, 1.0]], [0, [413.9270373579403, 1.0]], [0, [121.32929747333591, 1.0]], [0, [39.20484450736232, 1.0]], [0, [8.459495301097666, 1.0]], [0, [3.34106894912035, 1.0]], [0, [0.6727537787220587, 1.0]], [0, [0.24898173099715162, 1.0]], [1, [1362.836096300505, 1.0]], [1, [664.2297918696772, 1.0]], [1, [298.53089432633595, 1.0]], [1, [311.9467952407182, 1.0]], [1, [63.14194078272413, 1.0]], [1, [7.162556131520866, 1.0]], [1, [20.134246575588115, 1.0]], [1, [0.7670186215631762, 1.0]], [1, [2.7323495634484627, 1.0]], [1, [0.22093130006969244, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.81641656]
bas 1, expnt(s) = [7617.14313736]
bas 2, expnt(s) = [3617.49203106]
bas 3, expnt(s) = [1589.32297154]
bas 4, expnt(s) = [413.92703736]
bas 5, expnt(s) = [121.32929747]
bas 6, expnt(s) = [39.20484451]
bas 7, expnt(s) = [8.4594953]
bas 8, expnt(s) = [3.34106895]
bas 9, expnt(s) = [0.67275378]
bas 10, expnt(s) = [0.24898173]
bas 11, expnt(s) = [1362.8360963]
bas 12, expnt(s) = [664.22979187]
bas 13, expnt(s) = [298.53089433]
bas 14, expnt(s) = [311.94679524]
bas 15, expnt(s) = [63.14194078]
bas 16, expnt(s) = [7.16255613]
bas 17, expnt(s) = [20.13424658]
bas 18, expnt(s) = [0.76701862]
bas 19, expnt(s) = [2.73234956]
bas 20, expnt(s) = [0.2209313]
CPU time:       401.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828164e+04 5.20028678e+03 7.61714314e+03 2.05996154e+03
 3.61749203e+03 1.17847592e+03 1.58932297e+03 6.35951718e+02
 4.13927037e+02 2.31850411e+02 1.21329297e+02 9.23611404e+01
 3.92048445e+01 3.95840135e+01 8.45949530e+00 1.25320859e+01
 3.34106895e+00 6.24351419e+00 6.72753779e-01 1.87675306e+00
 2.48981731e-01 8.90513763e-01 1.36283610e+03 2.41567735e+04
 6.64229792e+02 9.83744531e+03 2.98530894e+02 3.62010356e+03
 3.11946795e+02 3.82459148e+03 6.31419408e+01 5.19256332e+02
 7.16255613e+00 3.41837293e+01 2.01342466e+01 1.24423846e+02
 7.67018622e-01 2.09407281e+00 2.73234956e+00 1.02483681e+01
 2.20931300e-01 4.41881635e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993776225188135
cond(S) = 97987.350452343
E1 = -729.5313231785572  E_coul = 203.17895446351898
init E= -526.352368715038
    CPU time for initialize scf      0.11 sec, wall time      0.05 sec
  HOMO = -0.55586835112093  LUMO = 1.01833396117493
  mo_energy =
[-1.18331896e+02 -1.22048754e+01 -9.44662952e+00 -9.44662952e+00
 -9.44662952e+00 -1.23995908e+00 -5.55868351e-01 -5.55868351e-01
 -5.55868351e-01  1.01833396e+00  1.01833396e+00  1.01833396e+00
  1.05527141e+00  7.13417736e+00  7.13417736e+00  7.13417736e+00
  1.35266198e+01  3.27317100e+01  3.27317100e+01  3.27317100e+01
  1.21446282e+02  1.29353102e+02  1.29353102e+02  1.29353102e+02
  4.85053320e+02  4.85053320e+02  4.85053320e+02  6.57958366e+02
  1.33306167e+03  1.33306167e+03  1.33306167e+03  2.79518905e+03
  3.02110817e+03  3.02110817e+03  3.02110817e+03  6.63725224e+03
  6.63725224e+03  6.63725224e+03  9.21449464e+03  2.55626745e+04
  7.62936700e+04]
E1 = -727.8538248393605  E_coul = 201.10918391670728
cycle= 1 E= -526.744640922653  delta_E= -0.392  |g|= 0.185  |ddm|= 0.305
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538391
diis-c [-0.28986504  1.        ]
  HOMO = -0.590848338220361  LUMO = 0.994353375611718
  mo_energy =
[-1.18638878e+02 -1.23425534e+01 -9.59488009e+00 -9.59488009e+00
 -9.59488009e+00 -1.27960704e+00 -5.90848338e-01 -5.90848338e-01
 -5.90848338e-01  9.94353376e-01  9.94353376e-01  9.94353376e-01
  1.02567082e+00  7.04486924e+00  7.04486924e+00  7.04486924e+00
  1.34128567e+01  3.25785336e+01  3.25785336e+01  3.25785336e+01
  1.21217685e+02  1.29123972e+02  1.29123972e+02  1.29123972e+02
  4.84747846e+02  4.84747846e+02  4.84747846e+02  6.57606991e+02
  1.33270083e+03  1.33270083e+03  1.33270083e+03  2.79469398e+03
  3.02068197e+03  3.02068197e+03  3.02068197e+03  6.63671413e+03
  6.63671413e+03  6.63671413e+03  9.21388300e+03  2.55619691e+04
  7.62928749e+04]
E1 = -728.4281291478284  E_coul = 201.68277199543792
cycle= 2 E= -526.74535715239  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747256
diis-c [-0.00327515  0.08236288  0.91763712]
  HOMO = -0.581710279881847  LUMO = 1.00098246499811
  mo_energy =
[-1.18571233e+02 -1.23044783e+01 -9.55514748e+00 -9.55514748e+00
 -9.55514748e+00 -1.26867289e+00 -5.81710280e-01 -5.81710280e-01
 -5.81710280e-01  1.00098246e+00  1.00098246e+00  1.00098246e+00
  1.03411107e+00  7.06825051e+00  7.06825051e+00  7.06825051e+00
  1.34440227e+01  3.26184658e+01  3.26184658e+01  3.26184658e+01
  1.21274920e+02  1.29180060e+02  1.29180060e+02  1.29180060e+02
  4.84814682e+02  4.84814682e+02  4.84814682e+02  6.57676697e+02
  1.33277167e+03  1.33277167e+03  1.33277167e+03  2.79476821e+03
  3.02075506e+03  3.02075506e+03  3.02075506e+03  6.63678899e+03
  6.63678899e+03  6.63678899e+03  9.21395867e+03  2.55620454e+04
  7.62929515e+04]
E1 = -728.277304272305  E_coul = 201.5318880752137
cycle= 3 E= -526.745416197091  delta_E= -5.9e-05  |g|= 0.00631  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131319
diis-c [-5.41743903e-07 -1.22317227e-03  1.45121846e-01  8.56101326e-01]
  HOMO = -0.58321791473326  LUMO = 0.9999118658202
  mo_energy =
[-1.18581226e+02 -1.23103152e+01 -9.56132844e+00 -9.56132844e+00
 -9.56132844e+00 -1.27037947e+00 -5.83217915e-01 -5.83217915e-01
 -5.83217915e-01  9.99911866e-01  9.99911866e-01  9.99911866e-01
  1.03281217e+00  7.06451579e+00  7.06451579e+00  7.06451579e+00
  1.34392205e+01  3.26122908e+01  3.26122908e+01  3.26122908e+01
  1.21266401e+02  1.29171651e+02  1.29171651e+02  1.29171651e+02
  4.84804805e+02  4.84804805e+02  4.84804805e+02  6.57666390e+02
  1.33276121e+03  1.33276121e+03  1.33276121e+03  2.79475711e+03
  3.02074422e+03  3.02074422e+03  3.02074422e+03  6.63677775e+03
  6.63677775e+03  6.63677775e+03  9.21394723e+03  2.55620338e+04
  7.62929397e+04]
E1 = -728.3002782319554  E_coul = 201.55486009150206
cycle= 4 E= -526.745418140453  delta_E= -1.94e-06  |g|= 9.34e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106163
diis-c [-3.95074142e-09  6.56796535e-05 -9.56376012e-03 -6.17733235e-02
  1.07127140e+00]
  HOMO = -0.583198938095226  LUMO = 0.999927744641234
  mo_energy =
[-1.18581183e+02 -1.23102497e+01 -9.56127569e+00 -9.56127569e+00
 -9.56127569e+00 -1.27033901e+00 -5.83198938e-01 -5.83198938e-01
 -5.83198938e-01  9.99927745e-01  9.99927745e-01  9.99927745e-01
  1.03284634e+00  7.06455810e+00  7.06455810e+00  7.06455810e+00
  1.34392809e+01  3.26123414e+01  3.26123414e+01  3.26123414e+01
  1.21266454e+02  1.29171701e+02  1.29171701e+02  1.29171701e+02
  4.84804848e+02  4.84804848e+02  4.84804848e+02  6.57666424e+02
  1.33276124e+03  1.33276124e+03  1.33276124e+03  2.79475713e+03
  3.02074424e+03  3.02074424e+03  3.02074424e+03  6.63677776e+03
  6.63677776e+03  6.63677776e+03  9.21394723e+03  2.55620338e+04
  7.62929397e+04]
E1 = -728.3000633718585  E_coul = 201.5546452299034
cycle= 5 E= -526.745418141955  delta_E= -1.5e-09  |g|= 2.02e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83806e-05
diis-c [-6.68312808e-11  1.42547247e-05 -1.87329373e-03 -1.39251064e-02
  4.26046465e-02  9.73179499e-01]
  HOMO = -0.583206144228889  LUMO = 0.999923045884945
  mo_energy =
[-1.18581213e+02 -1.23102716e+01 -9.56129953e+00 -9.56129953e+00
 -9.56129953e+00 -1.27034477e+00 -5.83206144e-01 -5.83206144e-01
 -5.83206144e-01  9.99923046e-01  9.99923046e-01  9.99923046e-01
  1.03284238e+00  7.06454220e+00  7.06454220e+00  7.06454220e+00
  1.34392627e+01  3.26123183e+01  3.26123183e+01  3.26123183e+01
  1.21266427e+02  1.29171673e+02  1.29171673e+02  1.29171673e+02
  4.84804818e+02  4.84804818e+02  4.84804818e+02  6.57666394e+02
  1.33276121e+03  1.33276121e+03  1.33276121e+03  2.79475710e+03
  3.02074421e+03  3.02074421e+03  3.02074421e+03  6.63677773e+03
  6.63677773e+03  6.63677773e+03  9.21394719e+03  2.55620337e+04
  7.62929397e+04]
E1 = -728.3001435668793  E_coul = 201.5547254248684
cycle= 6 E= -526.745418142011  delta_E= -5.58e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3001435668793  E_coul = 201.5547254248684
  HOMO = -0.583206182485977  LUMO = 0.999923073530415
  mo_energy =
[-1.18581213e+02 -1.23102716e+01 -9.56129956e+00 -9.56129956e+00
 -9.56129956e+00 -1.27034444e+00 -5.83206182e-01 -5.83206182e-01
 -5.83206182e-01  9.99923074e-01  9.99923074e-01  9.99923074e-01
  1.03284269e+00  7.06454220e+00  7.06454220e+00  7.06454220e+00
  1.34392628e+01  3.26123183e+01  3.26123183e+01  3.26123183e+01
  1.21266427e+02  1.29171673e+02  1.29171673e+02  1.29171673e+02
  4.84804818e+02  4.84804818e+02  4.84804818e+02  6.57666394e+02
  1.33276121e+03  1.33276121e+03  1.33276121e+03  2.79475710e+03
  3.02074421e+03  3.02074421e+03  3.02074421e+03  6.63677773e+03
  6.63677773e+03  6.63677773e+03  9.21394719e+03  2.55620337e+04
  7.62929397e+04]
E1 = -728.3001429862014  E_coul = 201.5547248441887
Extra cycle  E= -526.745418142013  delta_E= -1.71e-12  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.34 sec, wall time      0.28 sec
exp = [2.61828164e+04 7.61714314e+03 3.61749203e+03 1.58932297e+03
 4.13927037e+02 1.21329297e+02 3.92048445e+01 8.45949530e+00
 3.34106895e+00 6.72753779e-01 2.48981731e-01 1.36283610e+03
 6.64229792e+02 2.98530894e+02 3.11946795e+02 6.31419408e+01
 7.16255613e+00 2.01342466e+01 7.67018622e-01 2.73234956e+00
 2.20931300e-01]
E = -526.7454181420127
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:13:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8164166        1
[INPUT] 0    0    [1    /1   ]  7617.14313736        1
[INPUT] 0    0    [1    /1   ]  3617.49203106        1
[INPUT] 0    0    [1    /1   ]  1589.32297154        1
[INPUT] 0    0    [1    /1   ]  413.927037358        1
[INPUT] 0    0    [1    /1   ]  121.329297473        1
[INPUT] 0    0    [1    /1   ]  39.2048445074        1
[INPUT] 0    0    [1    /1   ]  8.4594953011         1
[INPUT] 0    0    [1    /1   ]  3.34106894912        1
[INPUT] 0    0    [1    /1   ]  0.672753778722       1
[INPUT] 0    0    [1    /1   ]  0.248981730997       1
[INPUT] 1    0    [1    /1   ]  1362.8360963         1
[INPUT] 1    0    [1    /1   ]  664.22979187         1
[INPUT] 1    0    [1    /1   ]  298.530894326        1
[INPUT] 1    0    [1    /1   ]  311.946795241        1
[INPUT] 1    0    [1    /1   ]  63.1419407827        1
[INPUT] 1    0    [1    /1   ]  7.16255613152        1
[INPUT] 1    0    [1    /1   ]  20.1342465756        1
[INPUT] 1    0    [1    /1   ]  0.767018621563       1
[INPUT] 1    0    [1    /1   ]  2.73234956345        1
[INPUT] 1    0    [1    /1   ]  0.22093130007        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.816416560636, 1.0]], [0, [7617.143137361286, 1.0]], [0, [3617.4920310642474, 1.0]], [0, [1589.3229715370537, 1.0]], [0, [413.9270373579403, 1.0]], [0, [121.32929747333591, 1.0]], [0, [39.20484450736232, 1.0]], [0, [8.459495301097666, 1.0]], [0, [3.34106894912035, 1.0]], [0, [0.6727537787220587, 1.0]], [0, [0.24898173099715162, 1.0]], [1, [1362.836096300505, 1.0]], [1, [664.2297918696772, 1.0]], [1, [298.53089432633595, 1.0]], [1, [311.9467952407182, 1.0]], [1, [63.14194078272413, 1.0]], [1, [7.162556131520866, 1.0]], [1, [20.134246575588115, 1.0]], [1, [0.7670186215631762, 1.0]], [1, [2.7323495634484627, 1.0]], [1, [0.22093130006969244, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.81641656]
bas 1, expnt(s) = [7617.14313736]
bas 2, expnt(s) = [3617.49203106]
bas 3, expnt(s) = [1589.32297154]
bas 4, expnt(s) = [413.92703736]
bas 5, expnt(s) = [121.32929747]
bas 6, expnt(s) = [39.20484451]
bas 7, expnt(s) = [8.4594953]
bas 8, expnt(s) = [3.34106895]
bas 9, expnt(s) = [0.67275378]
bas 10, expnt(s) = [0.24898173]
bas 11, expnt(s) = [1362.8360963]
bas 12, expnt(s) = [664.22979187]
bas 13, expnt(s) = [298.53089433]
bas 14, expnt(s) = [311.94679524]
bas 15, expnt(s) = [63.14194078]
bas 16, expnt(s) = [7.16255613]
bas 17, expnt(s) = [20.13424658]
bas 18, expnt(s) = [0.76701862]
bas 19, expnt(s) = [2.73234956]
bas 20, expnt(s) = [0.2209313]
CPU time:       402.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828164e+04 5.20028678e+03 7.61714314e+03 2.05996154e+03
 3.61749203e+03 1.17847592e+03 1.58932297e+03 6.35951718e+02
 4.13927037e+02 2.31850411e+02 1.21329297e+02 9.23611404e+01
 3.92048445e+01 3.95840135e+01 8.45949530e+00 1.25320859e+01
 3.34106895e+00 6.24351419e+00 6.72753779e-01 1.87675306e+00
 2.48981731e-01 8.90513763e-01 1.36283610e+03 2.41567735e+04
 6.64229792e+02 9.83744531e+03 2.98530894e+02 3.62010356e+03
 3.11946795e+02 3.82459148e+03 6.31419408e+01 5.19256332e+02
 7.16255613e+00 3.41837293e+01 2.01342466e+01 1.24423846e+02
 7.67018622e-01 2.09407281e+00 2.73234956e+00 1.02483681e+01
 2.20931300e-01 4.41881635e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993776225188135
cond(S) = 97987.350452343
E1 = -729.5313231785572  E_coul = 203.17895446351898
init E= -526.352368715038
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.55586835112093  LUMO = 1.01833396117493
  mo_energy =
[-1.18331896e+02 -1.22048754e+01 -9.44662952e+00 -9.44662952e+00
 -9.44662952e+00 -1.23995908e+00 -5.55868351e-01 -5.55868351e-01
 -5.55868351e-01  1.01833396e+00  1.01833396e+00  1.01833396e+00
  1.05527141e+00  7.13417736e+00  7.13417736e+00  7.13417736e+00
  1.35266198e+01  3.27317100e+01  3.27317100e+01  3.27317100e+01
  1.21446282e+02  1.29353102e+02  1.29353102e+02  1.29353102e+02
  4.85053320e+02  4.85053320e+02  4.85053320e+02  6.57958366e+02
  1.33306167e+03  1.33306167e+03  1.33306167e+03  2.79518905e+03
  3.02110817e+03  3.02110817e+03  3.02110817e+03  6.63725224e+03
  6.63725224e+03  6.63725224e+03  9.21449464e+03  2.55626745e+04
  7.62936700e+04]
E1 = -727.8538248393605  E_coul = 201.10918391670728
cycle= 1 E= -526.744640922653  delta_E= -0.392  |g|= 0.185  |ddm|= 0.305
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538391
diis-c [-0.28986504  1.        ]
  HOMO = -0.590848338220361  LUMO = 0.994353375611718
  mo_energy =
[-1.18638878e+02 -1.23425534e+01 -9.59488009e+00 -9.59488009e+00
 -9.59488009e+00 -1.27960704e+00 -5.90848338e-01 -5.90848338e-01
 -5.90848338e-01  9.94353376e-01  9.94353376e-01  9.94353376e-01
  1.02567082e+00  7.04486924e+00  7.04486924e+00  7.04486924e+00
  1.34128567e+01  3.25785336e+01  3.25785336e+01  3.25785336e+01
  1.21217685e+02  1.29123972e+02  1.29123972e+02  1.29123972e+02
  4.84747846e+02  4.84747846e+02  4.84747846e+02  6.57606991e+02
  1.33270083e+03  1.33270083e+03  1.33270083e+03  2.79469398e+03
  3.02068197e+03  3.02068197e+03  3.02068197e+03  6.63671413e+03
  6.63671413e+03  6.63671413e+03  9.21388300e+03  2.55619691e+04
  7.62928749e+04]
E1 = -728.4281291478284  E_coul = 201.68277199543792
cycle= 2 E= -526.74535715239  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747256
diis-c [-0.00327515  0.08236288  0.91763712]
  HOMO = -0.581710279881847  LUMO = 1.00098246499811
  mo_energy =
[-1.18571233e+02 -1.23044783e+01 -9.55514748e+00 -9.55514748e+00
 -9.55514748e+00 -1.26867289e+00 -5.81710280e-01 -5.81710280e-01
 -5.81710280e-01  1.00098246e+00  1.00098246e+00  1.00098246e+00
  1.03411107e+00  7.06825051e+00  7.06825051e+00  7.06825051e+00
  1.34440227e+01  3.26184658e+01  3.26184658e+01  3.26184658e+01
  1.21274920e+02  1.29180060e+02  1.29180060e+02  1.29180060e+02
  4.84814682e+02  4.84814682e+02  4.84814682e+02  6.57676697e+02
  1.33277167e+03  1.33277167e+03  1.33277167e+03  2.79476821e+03
  3.02075506e+03  3.02075506e+03  3.02075506e+03  6.63678899e+03
  6.63678899e+03  6.63678899e+03  9.21395867e+03  2.55620454e+04
  7.62929515e+04]
E1 = -728.277304272305  E_coul = 201.5318880752137
cycle= 3 E= -526.745416197091  delta_E= -5.9e-05  |g|= 0.00631  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131319
diis-c [-5.41743903e-07 -1.22317227e-03  1.45121846e-01  8.56101326e-01]
  HOMO = -0.58321791473326  LUMO = 0.9999118658202
  mo_energy =
[-1.18581226e+02 -1.23103152e+01 -9.56132844e+00 -9.56132844e+00
 -9.56132844e+00 -1.27037947e+00 -5.83217915e-01 -5.83217915e-01
 -5.83217915e-01  9.99911866e-01  9.99911866e-01  9.99911866e-01
  1.03281217e+00  7.06451579e+00  7.06451579e+00  7.06451579e+00
  1.34392205e+01  3.26122908e+01  3.26122908e+01  3.26122908e+01
  1.21266401e+02  1.29171651e+02  1.29171651e+02  1.29171651e+02
  4.84804805e+02  4.84804805e+02  4.84804805e+02  6.57666390e+02
  1.33276121e+03  1.33276121e+03  1.33276121e+03  2.79475711e+03
  3.02074422e+03  3.02074422e+03  3.02074422e+03  6.63677775e+03
  6.63677775e+03  6.63677775e+03  9.21394723e+03  2.55620338e+04
  7.62929397e+04]
E1 = -728.3002782319554  E_coul = 201.55486009150206
cycle= 4 E= -526.745418140453  delta_E= -1.94e-06  |g|= 9.34e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106163
diis-c [-3.95074142e-09  6.56796535e-05 -9.56376012e-03 -6.17733235e-02
  1.07127140e+00]
  HOMO = -0.583198938095226  LUMO = 0.999927744641234
  mo_energy =
[-1.18581183e+02 -1.23102497e+01 -9.56127569e+00 -9.56127569e+00
 -9.56127569e+00 -1.27033901e+00 -5.83198938e-01 -5.83198938e-01
 -5.83198938e-01  9.99927745e-01  9.99927745e-01  9.99927745e-01
  1.03284634e+00  7.06455810e+00  7.06455810e+00  7.06455810e+00
  1.34392809e+01  3.26123414e+01  3.26123414e+01  3.26123414e+01
  1.21266454e+02  1.29171701e+02  1.29171701e+02  1.29171701e+02
  4.84804848e+02  4.84804848e+02  4.84804848e+02  6.57666424e+02
  1.33276124e+03  1.33276124e+03  1.33276124e+03  2.79475713e+03
  3.02074424e+03  3.02074424e+03  3.02074424e+03  6.63677776e+03
  6.63677776e+03  6.63677776e+03  9.21394723e+03  2.55620338e+04
  7.62929397e+04]
E1 = -728.3000633718585  E_coul = 201.5546452299034
cycle= 5 E= -526.745418141955  delta_E= -1.5e-09  |g|= 2.02e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83806e-05
diis-c [-6.68312808e-11  1.42547247e-05 -1.87329373e-03 -1.39251064e-02
  4.26046465e-02  9.73179499e-01]
  HOMO = -0.583206144228889  LUMO = 0.999923045884945
  mo_energy =
[-1.18581213e+02 -1.23102716e+01 -9.56129953e+00 -9.56129953e+00
 -9.56129953e+00 -1.27034477e+00 -5.83206144e-01 -5.83206144e-01
 -5.83206144e-01  9.99923046e-01  9.99923046e-01  9.99923046e-01
  1.03284238e+00  7.06454220e+00  7.06454220e+00  7.06454220e+00
  1.34392627e+01  3.26123183e+01  3.26123183e+01  3.26123183e+01
  1.21266427e+02  1.29171673e+02  1.29171673e+02  1.29171673e+02
  4.84804818e+02  4.84804818e+02  4.84804818e+02  6.57666394e+02
  1.33276121e+03  1.33276121e+03  1.33276121e+03  2.79475710e+03
  3.02074421e+03  3.02074421e+03  3.02074421e+03  6.63677773e+03
  6.63677773e+03  6.63677773e+03  9.21394719e+03  2.55620337e+04
  7.62929397e+04]
E1 = -728.3001435668793  E_coul = 201.5547254248684
cycle= 6 E= -526.745418142011  delta_E= -5.58e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3001435668793  E_coul = 201.5547254248684
  HOMO = -0.583206182485977  LUMO = 0.999923073530415
  mo_energy =
[-1.18581213e+02 -1.23102716e+01 -9.56129956e+00 -9.56129956e+00
 -9.56129956e+00 -1.27034444e+00 -5.83206182e-01 -5.83206182e-01
 -5.83206182e-01  9.99923074e-01  9.99923074e-01  9.99923074e-01
  1.03284269e+00  7.06454220e+00  7.06454220e+00  7.06454220e+00
  1.34392628e+01  3.26123183e+01  3.26123183e+01  3.26123183e+01
  1.21266427e+02  1.29171673e+02  1.29171673e+02  1.29171673e+02
  4.84804818e+02  4.84804818e+02  4.84804818e+02  6.57666394e+02
  1.33276121e+03  1.33276121e+03  1.33276121e+03  2.79475710e+03
  3.02074421e+03  3.02074421e+03  3.02074421e+03  6.63677773e+03
  6.63677773e+03  6.63677773e+03  9.21394719e+03  2.55620337e+04
  7.62929397e+04]
E1 = -728.3001429862014  E_coul = 201.5547248441887
Extra cycle  E= -526.745418142013  delta_E= -1.71e-12  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97987.350452343
E1 = -728.3001429862014  E_coul = 201.5547248441887
init E= -526.745418142013
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.583206203954109  LUMO = 0.99992306994356
  mo_energy =
[-1.18581213e+02 -1.23102716e+01 -9.56129962e+00 -9.56129962e+00
 -9.56129962e+00 -1.27034439e+00 -5.83206204e-01 -5.83206204e-01
 -5.83206204e-01  9.99923070e-01  9.99923070e-01  9.99923070e-01
  1.03284274e+00  7.06454216e+00  7.06454216e+00  7.06454216e+00
  1.34392628e+01  3.26123182e+01  3.26123182e+01  3.26123182e+01
  1.21266427e+02  1.29171673e+02  1.29171673e+02  1.29171673e+02
  4.84804818e+02  4.84804818e+02  4.84804818e+02  6.57666394e+02
  1.33276121e+03  1.33276121e+03  1.33276121e+03  2.79475710e+03
  3.02074421e+03  3.02074421e+03  3.02074421e+03  6.63677773e+03
  6.63677773e+03  6.63677773e+03  9.21394719e+03  2.55620337e+04
  7.62929397e+04]
E1 = -728.3001430558529  E_coul = 201.5547249138412
cycle= 1 E= -526.745418142012  delta_E= 1.02e-12  |g|= 7.16e-08  |ddm|= 5.78e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3001430558529  E_coul = 201.5547249138412
  HOMO = -0.583206204853423  LUMO = 0.99992307166803
  mo_energy =
[-1.18581213e+02 -1.23102716e+01 -9.56129962e+00 -9.56129962e+00
 -9.56129962e+00 -1.27034437e+00 -5.83206205e-01 -5.83206205e-01
 -5.83206205e-01  9.99923072e-01  9.99923072e-01  9.99923072e-01
  1.03284276e+00  7.06454216e+00  7.06454216e+00  7.06454216e+00
  1.34392628e+01  3.26123182e+01  3.26123182e+01  3.26123182e+01
  1.21266427e+02  1.29171673e+02  1.29171673e+02  1.29171673e+02
  4.84804818e+02  4.84804818e+02  4.84804818e+02  6.57666394e+02
  1.33276121e+03  1.33276121e+03  1.33276121e+03  2.79475710e+03
  3.02074421e+03  3.02074421e+03  3.02074421e+03  6.63677773e+03
  6.63677773e+03  6.63677773e+03  9.21394719e+03  2.55620337e+04
  7.62929397e+04]
E1 = -728.3001430168011  E_coul = 201.55472487479017
Extra cycle  E= -526.745418142011  delta_E= 6.82e-13  |g|= 1.44e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828164e+04 7.61714314e+03 3.61749203e+03 1.58932297e+03
 4.13927037e+02 1.21329297e+02 3.92048445e+01 8.45949530e+00
 3.34106895e+00 6.72753779e-01 2.48981731e-01 1.36283610e+03
 6.64229792e+02 2.98530894e+02 3.11946795e+02 6.31419408e+01
 7.16255613e+00 2.01342466e+01 7.67018622e-01 2.73234956e+00
 2.20931300e-01]
grad_E = [-1.41574784e-06  2.31315627e-06 -2.12974428e-06  4.15020861e-05
 -2.32717292e-05  3.58828788e-06 -7.74398457e-06 -5.60307130e-05
  1.07976453e-04 -2.37009159e-05  1.70319322e-04 -6.34326538e-07
  3.09572938e-06  1.28207531e-05  1.09834291e-05  5.81844223e-04
 -5.52087338e-04 -1.35247923e-03 -3.30383738e-04 -5.71121979e-04
  8.25118416e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8144984        1
[INPUT] 0    0    [1    /1   ]  7617.14769015        1
[INPUT] 0    0    [1    /1   ]  3617.49036913        1
[INPUT] 0    0    [1    /1   ]  1589.42568152        1
[INPUT] 0    0    [1    /1   ]  413.526635365        1
[INPUT] 0    0    [1    /1   ]  121.263235096        1
[INPUT] 0    0    [1    /1   ]  39.1980866762        1
[INPUT] 0    0    [1    /1   ]  8.46144375153        1
[INPUT] 0    0    [1    /1   ]  3.34140407585        1
[INPUT] 0    0    [1    /1   ]  0.67307297784        1
[INPUT] 0    0    [1    /1   ]  0.249074429769       1
[INPUT] 1    0    [1    /1   ]  1362.83546546        1
[INPUT] 1    0    [1    /1   ]  664.235945304        1
[INPUT] 1    0    [1    /1   ]  298.559893484        1
[INPUT] 1    0    [1    /1   ]  311.971790665        1
[INPUT] 1    0    [1    /1   ]  63.1229429559        1
[INPUT] 1    0    [1    /1   ]  7.16622459148        1
[INPUT] 1    0    [1    /1   ]  20.1380203416        1
[INPUT] 1    0    [1    /1   ]  0.76725717347        1
[INPUT] 1    0    [1    /1   ]  2.73444062094        1
[INPUT] 1    0    [1    /1   ]  0.220980896463       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.81449844049, 1.0]], [0, [7617.147690149628, 1.0]], [0, [3617.4903691270674, 1.0]], [0, [1589.4256815239542, 1.0]], [0, [413.5266353653012, 1.0]], [0, [121.26323509559629, 1.0]], [0, [39.198086676178434, 1.0]], [0, [8.46144375152821, 1.0]], [0, [3.341404075846962, 1.0]], [0, [0.6730729778398689, 1.0]], [0, [0.24907442976941244, 1.0]], [1, [1362.8354654576972, 1.0]], [1, [664.2359453040731, 1.0]], [1, [298.55989348440045, 1.0]], [1, [311.9717906653343, 1.0]], [1, [63.12294295592454, 1.0]], [1, [7.166224591480772, 1.0]], [1, [20.138020341649423, 1.0]], [1, [0.7672571734704678, 1.0]], [1, [2.734440620943369, 1.0]], [1, [0.2209808964632101, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.81449844]
bas 1, expnt(s) = [7617.14769015]
bas 2, expnt(s) = [3617.49036913]
bas 3, expnt(s) = [1589.42568152]
bas 4, expnt(s) = [413.52663537]
bas 5, expnt(s) = [121.2632351]
bas 6, expnt(s) = [39.19808668]
bas 7, expnt(s) = [8.46144375]
bas 8, expnt(s) = [3.34140408]
bas 9, expnt(s) = [0.67307298]
bas 10, expnt(s) = [0.24907443]
bas 11, expnt(s) = [1362.83546546]
bas 12, expnt(s) = [664.2359453]
bas 13, expnt(s) = [298.55989348]
bas 14, expnt(s) = [311.97179067]
bas 15, expnt(s) = [63.12294296]
bas 16, expnt(s) = [7.16622459]
bas 17, expnt(s) = [20.13802034]
bas 18, expnt(s) = [0.76725717]
bas 19, expnt(s) = [2.73444062]
bas 20, expnt(s) = [0.2209809]
CPU time:       408.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828145e+04 5.20028650e+03 7.61714769e+03 2.05996246e+03
 3.61749037e+03 1.17847551e+03 1.58942568e+03 6.35982541e+02
 4.13526635e+02 2.31682185e+02 1.21263235e+02 9.23234206e+01
 3.91980867e+01 3.95788960e+01 8.46144375e+00 1.25342507e+01
 3.34140408e+00 6.24398387e+00 6.73072978e-01 1.87742087e+00
 2.49074430e-01 8.90762412e-01 1.36283547e+03 2.41567595e+04
 6.64235945e+02 9.83755922e+03 2.98559893e+02 3.62054314e+03
 3.11971791e+02 3.82497455e+03 6.31229430e+01 5.19061050e+02
 7.16622459e+00 3.42056156e+01 2.01380203e+01 1.24452998e+02
 7.67257173e-01 2.09488694e+00 2.73444062e+00 1.02581729e+01
 2.20980896e-01 4.42005635e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99376748184074
cond(S) = 98062.10226662483
E1 = -729.5315115606461  E_coul = 203.17900721200309
init E= -526.352504348643
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555865986850832  LUMO = 1.01873916833552
  mo_energy =
[-1.18331885e+02 -1.22048709e+01 -9.44662962e+00 -9.44662962e+00
 -9.44662962e+00 -1.23995636e+00 -5.55865987e-01 -5.55865987e-01
 -5.55865987e-01  1.01873917e+00  1.01873917e+00  1.01873917e+00
  1.05602579e+00  7.13974541e+00  7.13974541e+00  7.13974541e+00
  1.35313920e+01  3.27514419e+01  3.27514419e+01  3.27514419e+01
  1.21414877e+02  1.29366896e+02  1.29366896e+02  1.29366896e+02
  4.85049908e+02  4.85049908e+02  4.85049908e+02  6.57506116e+02
  1.33310251e+03  1.33310251e+03  1.33310251e+03  2.79396612e+03
  3.02122261e+03  3.02122261e+03  3.02122261e+03  6.63741810e+03
  6.63741810e+03  6.63741810e+03  9.21306203e+03  2.55613022e+04
  7.62924064e+04]
E1 = -727.8541273332872  E_coul = 201.10948194464305
cycle= 1 E= -526.744645388644  delta_E= -0.392  |g|= 0.185  |ddm|= 0.305
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538442
diis-c [-0.28991999  1.        ]
  HOMO = -0.590839482143451  LUMO = 0.994752792284932
  mo_energy =
[-1.18638834e+02 -1.23425320e+01 -9.59486493e+00 -9.59486493e+00
 -9.59486493e+00 -1.27959681e+00 -5.90839482e-01 -5.90839482e-01
 -5.90839482e-01  9.94752792e-01  9.94752792e-01  9.94752792e-01
  1.02641575e+00  7.05041048e+00  7.05041048e+00  7.05041048e+00
  1.34176335e+01  3.25982643e+01  3.25982643e+01  3.25982643e+01
  1.21186332e+02  1.29137808e+02  1.29137808e+02  1.29137808e+02
  4.84744464e+02  4.84744464e+02  4.84744464e+02  6.57154852e+02
  1.33274170e+03  1.33274170e+03  1.33274170e+03  2.79347112e+03
  3.02079644e+03  3.02079644e+03  3.02079644e+03  6.63688003e+03
  6.63688003e+03  6.63688003e+03  9.21245041e+03  2.55605969e+04
  7.62916114e+04]
E1 = -728.4283413660629  E_coul = 201.68297989320095
cycle= 2 E= -526.745361472862  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747247
diis-c [-0.00327553  0.08234719  0.91765281]
  HOMO = -0.581703212436713  LUMO = 1.00138365184078
  mo_energy =
[-1.18571198e+02 -1.23044623e+01 -9.55513785e+00 -9.55513785e+00
 -9.55513785e+00 -1.26866466e+00 -5.81703212e-01 -5.81703212e-01
 -5.81703212e-01  1.00138365e+00  1.00138365e+00  1.00138365e+00
  1.03485892e+00  7.07379805e+00  7.07379805e+00  7.07379805e+00
  1.34487975e+01  3.26381954e+01  3.26381954e+01  3.26381954e+01
  1.21243555e+02  1.29193887e+02  1.29193887e+02  1.29193887e+02
  4.84811293e+02  4.84811293e+02  4.84811293e+02  6.57224546e+02
  1.33281253e+03  1.33281253e+03  1.33281253e+03  2.79354534e+03
  3.02086953e+03  3.02086953e+03  3.02086953e+03  6.63695487e+03
  6.63695487e+03  6.63695487e+03  9.21252608e+03  2.55606732e+04
  7.62916879e+04]
E1 = -728.2775440635315  E_coul = 201.53212356441665
cycle= 3 E= -526.745420499115  delta_E= -5.9e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131326
diis-c [-5.41930977e-07 -1.22312568e-03  1.45130242e-01  8.56092883e-01]
  HOMO = -0.583210608276055  LUMO = 1.00031273301985
  mo_energy =
[-1.18581189e+02 -1.23102985e+01 -9.56131820e+00 -9.56131820e+00
 -9.56131820e+00 -1.27037095e+00 -5.83210608e-01 -5.83210608e-01
 -5.83210608e-01  1.00031273e+00  1.00031273e+00  1.00031273e+00
  1.03355955e+00  7.07006222e+00  7.07006222e+00  7.07006222e+00
  1.34439954e+01  3.26320204e+01  3.26320204e+01  3.26320204e+01
  1.21235037e+02  1.29185478e+02  1.29185478e+02  1.29185478e+02
  4.84801416e+02  4.84801416e+02  4.84801416e+02  6.57214240e+02
  1.33280207e+03  1.33280207e+03  1.33280207e+03  2.79353424e+03
  3.02085868e+03  3.02085868e+03  3.02085868e+03  6.63694364e+03
  6.63694364e+03  6.63694364e+03  9.21251464e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3005147597029  E_coul = 201.55509231762684
cycle= 4 E= -526.745422442076  delta_E= -1.94e-06  |g|= 9.34e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106226
diis-c [-3.95033276e-09  6.57350685e-05 -9.57088373e-03 -6.18172966e-02
  1.07132245e+00]
  HOMO = -0.583191637971783  LUMO = 1.00032861381305
  mo_energy =
[-1.18581147e+02 -1.23102330e+01 -9.56126548e+00 -9.56126548e+00
 -9.56126548e+00 -1.27033050e+00 -5.83191638e-01 -5.83191638e-01
 -5.83191638e-01  1.00032861e+00  1.00032861e+00  1.00032861e+00
  1.03359374e+00  7.07010453e+00  7.07010453e+00  7.07010453e+00
  1.34440558e+01  3.26320709e+01  3.26320709e+01  3.26320709e+01
  1.21235090e+02  1.29185528e+02  1.29185528e+02  1.29185528e+02
  4.84801459e+02  4.84801459e+02  4.84801459e+02  6.57214274e+02
  1.33280211e+03  1.33280211e+03  1.33280211e+03  2.79353426e+03
  3.02085871e+03  3.02085871e+03  3.02085871e+03  6.63694365e+03
  6.63694365e+03  6.63694365e+03  9.21251464e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3003000131888  E_coul = 201.55487756960963
cycle= 5 E= -526.745422443579  delta_E= -1.5e-09  |g|= 2.02e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83813e-05
diis-c [-6.68340722e-11  1.42503004e-05 -1.87300558e-03 -1.39228956e-02
  4.26354093e-02  9.73146242e-01]
  HOMO = -0.583198843681041  LUMO = 1.00032391305038
  mo_energy =
[-1.18581177e+02 -1.23102550e+01 -9.56128932e+00 -9.56128932e+00
 -9.56128932e+00 -1.27033626e+00 -5.83198844e-01 -5.83198844e-01
 -5.83198844e-01  1.00032391e+00  1.00032391e+00  1.00032391e+00
  1.03358977e+00  7.07008863e+00  7.07008863e+00  7.07008863e+00
  1.34440376e+01  3.26320478e+01  3.26320478e+01  3.26320478e+01
  1.21235063e+02  1.29185500e+02  1.29185500e+02  1.29185500e+02
  4.84801429e+02  4.84801429e+02  4.84801429e+02  6.57214244e+02
  1.33280208e+03  1.33280208e+03  1.33280208e+03  2.79353422e+03
  3.02085868e+03  3.02085868e+03  3.02085868e+03  6.63694362e+03
  6.63694362e+03  6.63694362e+03  9.21251461e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3003802082951  E_coul = 201.5549577646608
cycle= 6 E= -526.745422443634  delta_E= -5.51e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3003802082951  E_coul = 201.5549577646608
  HOMO = -0.583198881744517  LUMO = 1.00032394081466
  mo_energy =
[-1.18581177e+02 -1.23102549e+01 -9.56128935e+00 -9.56128935e+00
 -9.56128935e+00 -1.27033593e+00 -5.83198882e-01 -5.83198882e-01
 -5.83198882e-01  1.00032394e+00  1.00032394e+00  1.00032394e+00
  1.03359008e+00  7.07008862e+00  7.07008862e+00  7.07008862e+00
  1.34440378e+01  3.26320478e+01  3.26320478e+01  3.26320478e+01
  1.21235063e+02  1.29185500e+02  1.29185500e+02  1.29185500e+02
  4.84801429e+02  4.84801429e+02  4.84801429e+02  6.57214244e+02
  1.33280208e+03  1.33280208e+03  1.33280208e+03  2.79353422e+03
  3.02085868e+03  3.02085868e+03  3.02085868e+03  6.63694362e+03
  6.63694362e+03  6.63694362e+03  9.21251461e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3003796260823  E_coul = 201.55495718244663
Extra cycle  E= -526.745422443636  delta_E= -1.36e-12  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828145e+04 7.61714769e+03 3.61749037e+03 1.58942568e+03
 4.13526635e+02 1.21263235e+02 3.91980867e+01 8.46144375e+00
 3.34140408e+00 6.73072978e-01 2.49074430e-01 1.36283547e+03
 6.64235945e+02 2.98559893e+02 3.11971791e+02 6.31229430e+01
 7.16622459e+00 2.01380203e+01 7.67257173e-01 2.73444062e+00
 2.20980896e-01]
E = -526.7454224436357
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:03 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8144984        1
[INPUT] 0    0    [1    /1   ]  7617.14769015        1
[INPUT] 0    0    [1    /1   ]  3617.49036913        1
[INPUT] 0    0    [1    /1   ]  1589.42568152        1
[INPUT] 0    0    [1    /1   ]  413.526635365        1
[INPUT] 0    0    [1    /1   ]  121.263235096        1
[INPUT] 0    0    [1    /1   ]  39.1980866762        1
[INPUT] 0    0    [1    /1   ]  8.46144375153        1
[INPUT] 0    0    [1    /1   ]  3.34140407585        1
[INPUT] 0    0    [1    /1   ]  0.67307297784        1
[INPUT] 0    0    [1    /1   ]  0.249074429769       1
[INPUT] 1    0    [1    /1   ]  1362.83546546        1
[INPUT] 1    0    [1    /1   ]  664.235945304        1
[INPUT] 1    0    [1    /1   ]  298.559893484        1
[INPUT] 1    0    [1    /1   ]  311.971790665        1
[INPUT] 1    0    [1    /1   ]  63.1229429559        1
[INPUT] 1    0    [1    /1   ]  7.16622459148        1
[INPUT] 1    0    [1    /1   ]  20.1380203416        1
[INPUT] 1    0    [1    /1   ]  0.76725717347        1
[INPUT] 1    0    [1    /1   ]  2.73444062094        1
[INPUT] 1    0    [1    /1   ]  0.220980896463       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.81449844049, 1.0]], [0, [7617.147690149628, 1.0]], [0, [3617.4903691270674, 1.0]], [0, [1589.4256815239542, 1.0]], [0, [413.5266353653012, 1.0]], [0, [121.26323509559629, 1.0]], [0, [39.198086676178434, 1.0]], [0, [8.46144375152821, 1.0]], [0, [3.341404075846962, 1.0]], [0, [0.6730729778398689, 1.0]], [0, [0.24907442976941244, 1.0]], [1, [1362.8354654576972, 1.0]], [1, [664.2359453040731, 1.0]], [1, [298.55989348440045, 1.0]], [1, [311.9717906653343, 1.0]], [1, [63.12294295592454, 1.0]], [1, [7.166224591480772, 1.0]], [1, [20.138020341649423, 1.0]], [1, [0.7672571734704678, 1.0]], [1, [2.734440620943369, 1.0]], [1, [0.2209808964632101, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.81449844]
bas 1, expnt(s) = [7617.14769015]
bas 2, expnt(s) = [3617.49036913]
bas 3, expnt(s) = [1589.42568152]
bas 4, expnt(s) = [413.52663537]
bas 5, expnt(s) = [121.2632351]
bas 6, expnt(s) = [39.19808668]
bas 7, expnt(s) = [8.46144375]
bas 8, expnt(s) = [3.34140408]
bas 9, expnt(s) = [0.67307298]
bas 10, expnt(s) = [0.24907443]
bas 11, expnt(s) = [1362.83546546]
bas 12, expnt(s) = [664.2359453]
bas 13, expnt(s) = [298.55989348]
bas 14, expnt(s) = [311.97179067]
bas 15, expnt(s) = [63.12294296]
bas 16, expnt(s) = [7.16622459]
bas 17, expnt(s) = [20.13802034]
bas 18, expnt(s) = [0.76725717]
bas 19, expnt(s) = [2.73444062]
bas 20, expnt(s) = [0.2209809]
CPU time:       408.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828145e+04 5.20028650e+03 7.61714769e+03 2.05996246e+03
 3.61749037e+03 1.17847551e+03 1.58942568e+03 6.35982541e+02
 4.13526635e+02 2.31682185e+02 1.21263235e+02 9.23234206e+01
 3.91980867e+01 3.95788960e+01 8.46144375e+00 1.25342507e+01
 3.34140408e+00 6.24398387e+00 6.73072978e-01 1.87742087e+00
 2.49074430e-01 8.90762412e-01 1.36283547e+03 2.41567595e+04
 6.64235945e+02 9.83755922e+03 2.98559893e+02 3.62054314e+03
 3.11971791e+02 3.82497455e+03 6.31229430e+01 5.19061050e+02
 7.16622459e+00 3.42056156e+01 2.01380203e+01 1.24452998e+02
 7.67257173e-01 2.09488694e+00 2.73444062e+00 1.02581729e+01
 2.20980896e-01 4.42005635e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99376748184074
cond(S) = 98062.10226662483
E1 = -729.5315115606461  E_coul = 203.17900721200309
init E= -526.352504348643
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555865986850832  LUMO = 1.01873916833552
  mo_energy =
[-1.18331885e+02 -1.22048709e+01 -9.44662962e+00 -9.44662962e+00
 -9.44662962e+00 -1.23995636e+00 -5.55865987e-01 -5.55865987e-01
 -5.55865987e-01  1.01873917e+00  1.01873917e+00  1.01873917e+00
  1.05602579e+00  7.13974541e+00  7.13974541e+00  7.13974541e+00
  1.35313920e+01  3.27514419e+01  3.27514419e+01  3.27514419e+01
  1.21414877e+02  1.29366896e+02  1.29366896e+02  1.29366896e+02
  4.85049908e+02  4.85049908e+02  4.85049908e+02  6.57506116e+02
  1.33310251e+03  1.33310251e+03  1.33310251e+03  2.79396612e+03
  3.02122261e+03  3.02122261e+03  3.02122261e+03  6.63741810e+03
  6.63741810e+03  6.63741810e+03  9.21306203e+03  2.55613022e+04
  7.62924064e+04]
E1 = -727.8541273332872  E_coul = 201.10948194464305
cycle= 1 E= -526.744645388644  delta_E= -0.392  |g|= 0.185  |ddm|= 0.305
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538442
diis-c [-0.28991999  1.        ]
  HOMO = -0.590839482143451  LUMO = 0.994752792284932
  mo_energy =
[-1.18638834e+02 -1.23425320e+01 -9.59486493e+00 -9.59486493e+00
 -9.59486493e+00 -1.27959681e+00 -5.90839482e-01 -5.90839482e-01
 -5.90839482e-01  9.94752792e-01  9.94752792e-01  9.94752792e-01
  1.02641575e+00  7.05041048e+00  7.05041048e+00  7.05041048e+00
  1.34176335e+01  3.25982643e+01  3.25982643e+01  3.25982643e+01
  1.21186332e+02  1.29137808e+02  1.29137808e+02  1.29137808e+02
  4.84744464e+02  4.84744464e+02  4.84744464e+02  6.57154852e+02
  1.33274170e+03  1.33274170e+03  1.33274170e+03  2.79347112e+03
  3.02079644e+03  3.02079644e+03  3.02079644e+03  6.63688003e+03
  6.63688003e+03  6.63688003e+03  9.21245041e+03  2.55605969e+04
  7.62916114e+04]
E1 = -728.4283413660629  E_coul = 201.68297989320095
cycle= 2 E= -526.745361472862  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747247
diis-c [-0.00327553  0.08234719  0.91765281]
  HOMO = -0.581703212436713  LUMO = 1.00138365184078
  mo_energy =
[-1.18571198e+02 -1.23044623e+01 -9.55513785e+00 -9.55513785e+00
 -9.55513785e+00 -1.26866466e+00 -5.81703212e-01 -5.81703212e-01
 -5.81703212e-01  1.00138365e+00  1.00138365e+00  1.00138365e+00
  1.03485892e+00  7.07379805e+00  7.07379805e+00  7.07379805e+00
  1.34487975e+01  3.26381954e+01  3.26381954e+01  3.26381954e+01
  1.21243555e+02  1.29193887e+02  1.29193887e+02  1.29193887e+02
  4.84811293e+02  4.84811293e+02  4.84811293e+02  6.57224546e+02
  1.33281253e+03  1.33281253e+03  1.33281253e+03  2.79354534e+03
  3.02086953e+03  3.02086953e+03  3.02086953e+03  6.63695487e+03
  6.63695487e+03  6.63695487e+03  9.21252608e+03  2.55606732e+04
  7.62916879e+04]
E1 = -728.2775440635315  E_coul = 201.53212356441665
cycle= 3 E= -526.745420499115  delta_E= -5.9e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131326
diis-c [-5.41930977e-07 -1.22312568e-03  1.45130242e-01  8.56092883e-01]
  HOMO = -0.583210608276055  LUMO = 1.00031273301985
  mo_energy =
[-1.18581189e+02 -1.23102985e+01 -9.56131820e+00 -9.56131820e+00
 -9.56131820e+00 -1.27037095e+00 -5.83210608e-01 -5.83210608e-01
 -5.83210608e-01  1.00031273e+00  1.00031273e+00  1.00031273e+00
  1.03355955e+00  7.07006222e+00  7.07006222e+00  7.07006222e+00
  1.34439954e+01  3.26320204e+01  3.26320204e+01  3.26320204e+01
  1.21235037e+02  1.29185478e+02  1.29185478e+02  1.29185478e+02
  4.84801416e+02  4.84801416e+02  4.84801416e+02  6.57214240e+02
  1.33280207e+03  1.33280207e+03  1.33280207e+03  2.79353424e+03
  3.02085868e+03  3.02085868e+03  3.02085868e+03  6.63694364e+03
  6.63694364e+03  6.63694364e+03  9.21251464e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3005147597029  E_coul = 201.55509231762684
cycle= 4 E= -526.745422442076  delta_E= -1.94e-06  |g|= 9.34e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106226
diis-c [-3.95033276e-09  6.57350685e-05 -9.57088373e-03 -6.18172966e-02
  1.07132245e+00]
  HOMO = -0.583191637971783  LUMO = 1.00032861381305
  mo_energy =
[-1.18581147e+02 -1.23102330e+01 -9.56126548e+00 -9.56126548e+00
 -9.56126548e+00 -1.27033050e+00 -5.83191638e-01 -5.83191638e-01
 -5.83191638e-01  1.00032861e+00  1.00032861e+00  1.00032861e+00
  1.03359374e+00  7.07010453e+00  7.07010453e+00  7.07010453e+00
  1.34440558e+01  3.26320709e+01  3.26320709e+01  3.26320709e+01
  1.21235090e+02  1.29185528e+02  1.29185528e+02  1.29185528e+02
  4.84801459e+02  4.84801459e+02  4.84801459e+02  6.57214274e+02
  1.33280211e+03  1.33280211e+03  1.33280211e+03  2.79353426e+03
  3.02085871e+03  3.02085871e+03  3.02085871e+03  6.63694365e+03
  6.63694365e+03  6.63694365e+03  9.21251464e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3003000131888  E_coul = 201.55487756960963
cycle= 5 E= -526.745422443579  delta_E= -1.5e-09  |g|= 2.02e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83813e-05
diis-c [-6.68340722e-11  1.42503004e-05 -1.87300558e-03 -1.39228956e-02
  4.26354093e-02  9.73146242e-01]
  HOMO = -0.583198843681041  LUMO = 1.00032391305038
  mo_energy =
[-1.18581177e+02 -1.23102550e+01 -9.56128932e+00 -9.56128932e+00
 -9.56128932e+00 -1.27033626e+00 -5.83198844e-01 -5.83198844e-01
 -5.83198844e-01  1.00032391e+00  1.00032391e+00  1.00032391e+00
  1.03358977e+00  7.07008863e+00  7.07008863e+00  7.07008863e+00
  1.34440376e+01  3.26320478e+01  3.26320478e+01  3.26320478e+01
  1.21235063e+02  1.29185500e+02  1.29185500e+02  1.29185500e+02
  4.84801429e+02  4.84801429e+02  4.84801429e+02  6.57214244e+02
  1.33280208e+03  1.33280208e+03  1.33280208e+03  2.79353422e+03
  3.02085868e+03  3.02085868e+03  3.02085868e+03  6.63694362e+03
  6.63694362e+03  6.63694362e+03  9.21251461e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3003802082951  E_coul = 201.5549577646608
cycle= 6 E= -526.745422443634  delta_E= -5.51e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3003802082951  E_coul = 201.5549577646608
  HOMO = -0.583198881744517  LUMO = 1.00032394081466
  mo_energy =
[-1.18581177e+02 -1.23102549e+01 -9.56128935e+00 -9.56128935e+00
 -9.56128935e+00 -1.27033593e+00 -5.83198882e-01 -5.83198882e-01
 -5.83198882e-01  1.00032394e+00  1.00032394e+00  1.00032394e+00
  1.03359008e+00  7.07008862e+00  7.07008862e+00  7.07008862e+00
  1.34440378e+01  3.26320478e+01  3.26320478e+01  3.26320478e+01
  1.21235063e+02  1.29185500e+02  1.29185500e+02  1.29185500e+02
  4.84801429e+02  4.84801429e+02  4.84801429e+02  6.57214244e+02
  1.33280208e+03  1.33280208e+03  1.33280208e+03  2.79353422e+03
  3.02085868e+03  3.02085868e+03  3.02085868e+03  6.63694362e+03
  6.63694362e+03  6.63694362e+03  9.21251461e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3003796260823  E_coul = 201.55495718244663
Extra cycle  E= -526.745422443636  delta_E= -1.36e-12  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98062.10226662483
E1 = -728.3003796260823  E_coul = 201.55495718244663
init E= -526.745422443636
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.583198903234885  LUMO = 1.00032393720255
  mo_energy =
[-1.18581177e+02 -1.23102549e+01 -9.56128941e+00 -9.56128941e+00
 -9.56128941e+00 -1.27033587e+00 -5.83198903e-01 -5.83198903e-01
 -5.83198903e-01  1.00032394e+00  1.00032394e+00  1.00032394e+00
  1.03359013e+00  7.07008859e+00  7.07008859e+00  7.07008859e+00
  1.34440377e+01  3.26320478e+01  3.26320478e+01  3.26320478e+01
  1.21235063e+02  1.29185500e+02  1.29185500e+02  1.29185500e+02
  4.84801429e+02  4.84801429e+02  4.84801429e+02  6.57214244e+02
  1.33280208e+03  1.33280208e+03  1.33280208e+03  2.79353422e+03
  3.02085868e+03  3.02085868e+03  3.02085868e+03  6.63694362e+03
  6.63694362e+03  6.63694362e+03  9.21251461e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3003796962521  E_coul = 201.55495725261508
cycle= 1 E= -526.745422443637  delta_E= -1.36e-12  |g|= 7.16e-08  |ddm|= 5.78e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3003796962521  E_coul = 201.55495725261508
  HOMO = -0.583198904122233  LUMO = 1.00032393893466
  mo_energy =
[-1.18581177e+02 -1.23102549e+01 -9.56128941e+00 -9.56128941e+00
 -9.56128941e+00 -1.27033586e+00 -5.83198904e-01 -5.83198904e-01
 -5.83198904e-01  1.00032394e+00  1.00032394e+00  1.00032394e+00
  1.03359015e+00  7.07008859e+00  7.07008859e+00  7.07008859e+00
  1.34440378e+01  3.26320478e+01  3.26320478e+01  3.26320478e+01
  1.21235063e+02  1.29185500e+02  1.29185500e+02  1.29185500e+02
  4.84801429e+02  4.84801429e+02  4.84801429e+02  6.57214244e+02
  1.33280208e+03  1.33280208e+03  1.33280208e+03  2.79353422e+03
  3.02085868e+03  3.02085868e+03  3.02085868e+03  6.63694362e+03
  6.63694362e+03  6.63694362e+03  9.21251461e+03  2.55606615e+04
  7.62916761e+04]
E1 = -728.3003796570704  E_coul = 201.55495721343402
Extra cycle  E= -526.745422443636  delta_E= 6.82e-13  |g|= 1.44e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828145e+04 7.61714769e+03 3.61749037e+03 1.58942568e+03
 4.13526635e+02 1.21263235e+02 3.91980867e+01 8.46144375e+00
 3.34140408e+00 6.73072978e-01 2.49074430e-01 1.36283547e+03
 6.64235945e+02 2.98559893e+02 3.11971791e+02 6.31229430e+01
 7.16622459e+00 2.01380203e+01 7.67257173e-01 2.73444062e+00
 2.20980896e-01]
grad_E = [-1.41789653e-06  2.33159127e-06 -2.12856764e-06  4.20811124e-05
 -2.95262111e-05  1.52216796e-05 -7.06925555e-06 -4.14573083e-05
  8.31029695e-05  3.53106304e-05  1.30254324e-04 -6.33185181e-07
  3.12085723e-06  1.29643155e-05  1.11063482e-05  5.71697246e-04
 -5.84217539e-04 -1.32061680e-03 -2.75564241e-04 -4.92113744e-04
  7.25526726e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8119307        1
[INPUT] 0    0    [1    /1   ]  7617.15378892        1
[INPUT] 0    0    [1    /1   ]  3617.4881478         1
[INPUT] 0    0    [1    /1   ]  1589.56331856        1
[INPUT] 0    0    [1    /1   ]  412.988705778        1
[INPUT] 0    0    [1    /1   ]  121.178053209        1
[INPUT] 0    0    [1    /1   ]  39.1918297492        1
[INPUT] 0    0    [1    /1   ]  8.46718589377        1
[INPUT] 0    0    [1    /1   ]  3.34234414901        1
[INPUT] 0    0    [1    /1   ]  0.673288624709       1
[INPUT] 0    0    [1    /1   ]  0.249131855341       1
[INPUT] 1    0    [1    /1   ]  1362.83462147        1
[INPUT] 1    0    [1    /1   ]  664.244186432        1
[INPUT] 1    0    [1    /1   ]  298.598736217        1
[INPUT] 1    0    [1    /1   ]  312.0052708          1
[INPUT] 1    0    [1    /1   ]  63.0958366524        1
[INPUT] 1    0    [1    /1   ]  7.17302148297        1
[INPUT] 1    0    [1    /1   ]  20.1468541909        1
[INPUT] 1    0    [1    /1   ]  0.767694708598       1
[INPUT] 1    0    [1    /1   ]  2.73843520436        1
[INPUT] 1    0    [1    /1   ]  0.221060492503       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.811930679898, 1.0]], [0, [7617.153788922891, 1.0]], [0, [3617.488147803906, 1.0]], [0, [1589.5633185556476, 1.0]], [0, [412.98870577820503, 1.0]], [0, [121.17805320908825, 1.0]], [0, [39.191829749214286, 1.0]], [0, [8.467185893769816, 1.0]], [0, [3.3423441490141177, 1.0]], [0, [0.6732886247092255, 1.0]], [0, [0.24913185534062926, 1.0]], [1, [1362.8346214657092, 1.0]], [1, [664.2441864322232, 1.0]], [1, [298.5987362172078, 1.0]], [1, [312.0052708003006, 1.0]], [1, [63.095836652423735, 1.0]], [1, [7.173021482974426, 1.0]], [1, [20.14685419092555, 1.0]], [1, [0.7676947085978536, 1.0]], [1, [2.7384352043615174, 1.0]], [1, [0.2210604925026865, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.81193068]
bas 1, expnt(s) = [7617.15378892]
bas 2, expnt(s) = [3617.4881478]
bas 3, expnt(s) = [1589.56331856]
bas 4, expnt(s) = [412.98870578]
bas 5, expnt(s) = [121.17805321]
bas 6, expnt(s) = [39.19182975]
bas 7, expnt(s) = [8.46718589]
bas 8, expnt(s) = [3.34234415]
bas 9, expnt(s) = [0.67328862]
bas 10, expnt(s) = [0.24913186]
bas 11, expnt(s) = [1362.83462147]
bas 12, expnt(s) = [664.24418643]
bas 13, expnt(s) = [298.59873622]
bas 14, expnt(s) = [312.0052708]
bas 15, expnt(s) = [63.09583665]
bas 16, expnt(s) = [7.17302148]
bas 17, expnt(s) = [20.14685419]
bas 18, expnt(s) = [0.76769471]
bas 19, expnt(s) = [2.7384352]
bas 20, expnt(s) = [0.22106049]
CPU time:       414.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828119e+04 5.20028612e+03 7.61715379e+03 2.05996370e+03
 3.61748815e+03 1.17847497e+03 1.58956332e+03 6.36023846e+02
 4.12988706e+02 2.31456113e+02 1.21178053e+02 9.22747766e+01
 3.91918297e+01 3.95741576e+01 8.46718589e+00 1.25406297e+01
 3.34234415e+00 6.24530134e+00 6.73288625e-01 1.87787198e+00
 2.49131855e-01 8.90916436e-01 1.36283462e+03 2.41567408e+04
 6.64244186e+02 9.83771179e+03 2.98598736e+02 3.62113194e+03
 3.12005271e+02 3.82548767e+03 6.30958367e+01 5.18782445e+02
 7.17302148e+00 3.42461738e+01 2.01468542e+01 1.24521243e+02
 7.67694709e-01 2.09638033e+00 2.73843520e+00 1.02769082e+01
 2.21060493e-01 4.42204654e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993753185510077
cond(S) = 98166.67856131766
E1 = -729.5318021338064  E_coul = 203.17910191543413
init E= -526.352700218372
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555862595389197  LUMO = 1.01944074189926
  mo_energy =
[-1.18331868e+02 -1.22048594e+01 -9.44662922e+00 -9.44662922e+00
 -9.44662922e+00 -1.23995359e+00 -5.55862595e-01 -5.55862595e-01
 -5.55862595e-01  1.01944074e+00  1.01944074e+00  1.01944074e+00
  1.05654766e+00  7.15019858e+00  7.15019858e+00  7.15019858e+00
  1.35414029e+01  3.27895345e+01  3.27895345e+01  3.27895345e+01
  1.21393282e+02  1.29405081e+02  1.29405081e+02  1.29405081e+02
  4.85062306e+02  4.85062306e+02  4.85062306e+02  6.56930645e+02
  1.33317150e+03  1.33317150e+03  1.33317150e+03  2.79235688e+03
  3.02138878e+03  3.02138878e+03  3.02138878e+03  6.63765187e+03
  6.63765187e+03  6.63765187e+03  9.21116961e+03  2.55594893e+04
  7.62907374e+04]
E1 = -727.8544252501134  E_coul = 201.10977016984242
cycle= 1 E= -526.744655080271  delta_E= -0.392  |g|= 0.185  |ddm|= 0.304
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538529
diis-c [-0.29001298  1.        ]
  HOMO = -0.590832143892701  LUMO = 0.995437968960504
  mo_energy =
[-1.18638776e+02 -1.23425082e+01 -9.59485592e+00 -9.59485592e+00
 -9.59485592e+00 -1.27958860e+00 -5.90832144e-01 -5.90832144e-01
 -5.90832144e-01  9.95437969e-01  9.95437969e-01  9.95437969e-01
  1.02693123e+00  7.06079856e+00  7.06079856e+00  7.06079856e+00
  1.34276252e+01  3.26363323e+01  3.26363323e+01  3.26363323e+01
  1.21164789e+02  1.29176044e+02  1.29176044e+02  1.29176044e+02
  4.84756900e+02  4.84756900e+02  4.84756900e+02  6.56579530e+02
  1.33281073e+03  1.33281073e+03  1.33281073e+03  2.79186196e+03
  3.02096266e+03  3.02096266e+03  3.02096266e+03  6.63711385e+03
  6.63711385e+03  6.63711385e+03  9.21055803e+03  2.55587840e+04
  7.62899424e+04]
E1 = -728.428540363144  E_coul = 201.68316932094038
cycle= 2 E= -526.745371042204  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747291
diis-c [-0.00327644  0.08233077  0.91766923]
  HOMO = -0.581697866613425  LUMO = 1.00207294048798
  mo_energy =
[-1.18571148e+02 -1.23044441e+01 -9.55513498e+00 -9.55513498e+00
 -9.55513498e+00 -1.26865865e+00 -5.81697867e-01 -5.81697867e-01
 -5.81697867e-01  1.00207294e+00  1.00207294e+00  1.00207294e+00
  1.03537612e+00  7.08420106e+00  7.08420106e+00  7.08420106e+00
  1.34587928e+01  3.26762665e+01  3.26762665e+01  3.26762665e+01
  1.21221998e+02  1.29232111e+02  1.29232111e+02  1.29232111e+02
  4.84823720e+02  4.84823720e+02  4.84823720e+02  6.56649209e+02
  1.33288156e+03  1.33288156e+03  1.33288156e+03  2.79193617e+03
  3.02103574e+03  3.02103574e+03  3.02103574e+03  6.63718869e+03
  6.63718869e+03  6.63718869e+03  9.21063369e+03  2.55588603e+04
  7.62900189e+04]
E1 = -728.2777774526087  E_coul = 201.5323474050955
cycle= 3 E= -526.745430047513  delta_E= -5.9e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131341
diis-c [-5.42340401e-07 -1.22309288e-03  1.45137098e-01  8.56085995e-01]
  HOMO = -0.583204949259071  LUMO = 1.00100135663208
  mo_energy =
[-1.18581138e+02 -1.23102793e+01 -9.56131437e+00 -9.56131437e+00
 -9.56131437e+00 -1.27036454e+00 -5.83204949e-01 -5.83204949e-01
 -5.83204949e-01  1.00100136e+00  1.00100136e+00  1.00100136e+00
  1.03407655e+00  7.08046294e+00  7.08046294e+00  7.08046294e+00
  1.34539904e+01  3.26700912e+01  3.26700912e+01  3.26700912e+01
  1.21213483e+02  1.29223705e+02  1.29223705e+02  1.29223705e+02
  4.84813845e+02  4.84813845e+02  4.84813845e+02  6.56638905e+02
  1.33287110e+03  1.33287110e+03  1.33287110e+03  2.79192507e+03
  3.02102490e+03  3.02102490e+03  3.02102490e+03  6.63717745e+03
  6.63717745e+03  6.63717745e+03  9.21062224e+03  2.55588486e+04
  7.62900072e+04]
E1 = -728.3007427953678  E_coul = 201.5553108055269
cycle= 4 E= -526.745431989841  delta_E= -1.94e-06  |g|= 9.35e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106392
diis-c [-3.95022380e-09  6.58671062e-05 -9.58680950e-03 -6.19233855e-02
  1.07144433e+00]
  HOMO = -0.583186003535026  LUMO = 1.00101723233395
  mo_energy =
[-1.18581096e+02 -1.23102139e+01 -9.56126173e+00 -9.56126173e+00
 -9.56126173e+00 -1.27032410e+00 -5.83186004e-01 -5.83186004e-01
 -5.83186004e-01  1.00101723e+00  1.00101723e+00  1.00101723e+00
  1.03411075e+00  7.08050522e+00  7.08050522e+00  7.08050522e+00
  1.34540507e+01  3.26701416e+01  3.26701416e+01  3.26701416e+01
  1.21213535e+02  1.29223754e+02  1.29223754e+02  1.29223754e+02
  4.84813887e+02  4.84813887e+02  4.84813887e+02  6.56638939e+02
  1.33287113e+03  1.33287113e+03  1.33287113e+03  2.79192508e+03
  3.02102492e+03  3.02102492e+03  3.02102492e+03  6.63717746e+03
  6.63717746e+03  6.63717746e+03  9.21062225e+03  2.55588486e+04
  7.62900071e+04]
E1 = -728.3005283170364  E_coul = 201.5550963256915
cycle= 5 E= -526.745431991345  delta_E= -1.5e-09  |g|= 2.02e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83826e-05
diis-c [-6.68784682e-11  1.42434776e-05 -1.87243967e-03 -1.39194874e-02
  4.26917091e-02  9.73085974e-01]
  HOMO = -0.583193210102936  LUMO = 1.00101252683315
  mo_energy =
[-1.18581126e+02 -1.23102358e+01 -9.56128558e+00 -9.56128558e+00
 -9.56128558e+00 -1.27032986e+00 -5.83193210e-01 -5.83193210e-01
 -5.83193210e-01  1.00101253e+00  1.00101253e+00  1.00101253e+00
  1.03410677e+00  7.08048930e+00  7.08048930e+00  7.08048930e+00
  1.34540325e+01  3.26701185e+01  3.26701185e+01  3.26701185e+01
  1.21213508e+02  1.29223727e+02  1.29223727e+02  1.29223727e+02
  4.84813857e+02  4.84813857e+02  4.84813857e+02  6.56638909e+02
  1.33287110e+03  1.33287110e+03  1.33287110e+03  2.79192505e+03
  3.02102489e+03  3.02102489e+03  3.02102489e+03  6.63717743e+03
  6.63717743e+03  6.63717743e+03  9.21062221e+03  2.55588486e+04
  7.62900071e+04]
E1 = -728.3006085140047  E_coul = 201.55517652260446
cycle= 6 E= -526.7454319914  delta_E= -5.53e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3006085140047  E_coul = 201.55517652260446
  HOMO = -0.583193247786625  LUMO = 1.00101255485047
  mo_energy =
[-1.18581126e+02 -1.23102358e+01 -9.56128561e+00 -9.56128561e+00
 -9.56128561e+00 -1.27032953e+00 -5.83193248e-01 -5.83193248e-01
 -5.83193248e-01  1.00101255e+00  1.00101255e+00  1.00101255e+00
  1.03410709e+00  7.08048929e+00  7.08048929e+00  7.08048929e+00
  1.34540326e+01  3.26701185e+01  3.26701185e+01  3.26701185e+01
  1.21213508e+02  1.29223727e+02  1.29223727e+02  1.29223727e+02
  4.84813858e+02  4.84813858e+02  4.84813858e+02  6.56638909e+02
  1.33287110e+03  1.33287110e+03  1.33287110e+03  2.79192505e+03
  3.02102489e+03  3.02102489e+03  3.02102489e+03  6.63717743e+03
  6.63717743e+03  6.63717743e+03  9.21062221e+03  2.55588486e+04
  7.62900071e+04]
E1 = -728.300607926021  E_coul = 201.5551759346203
Extra cycle  E= -526.745431991401  delta_E= -4.55e-13  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
exp = [2.61828119e+04 7.61715379e+03 3.61748815e+03 1.58956332e+03
 4.12988706e+02 1.21178053e+02 3.91918297e+01 8.46718589e+00
 3.34234415e+00 6.73288625e-01 2.49131855e-01 1.36283462e+03
 6.64244186e+02 2.98598736e+02 3.12005271e+02 6.30958367e+01
 7.17302148e+00 2.01468542e+01 7.67694709e-01 2.73843520e+00
 2.21060493e-01]
E = -526.7454319914007
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8119307        1
[INPUT] 0    0    [1    /1   ]  7617.15378892        1
[INPUT] 0    0    [1    /1   ]  3617.4881478         1
[INPUT] 0    0    [1    /1   ]  1589.56331856        1
[INPUT] 0    0    [1    /1   ]  412.988705778        1
[INPUT] 0    0    [1    /1   ]  121.178053209        1
[INPUT] 0    0    [1    /1   ]  39.1918297492        1
[INPUT] 0    0    [1    /1   ]  8.46718589377        1
[INPUT] 0    0    [1    /1   ]  3.34234414901        1
[INPUT] 0    0    [1    /1   ]  0.673288624709       1
[INPUT] 0    0    [1    /1   ]  0.249131855341       1
[INPUT] 1    0    [1    /1   ]  1362.83462147        1
[INPUT] 1    0    [1    /1   ]  664.244186432        1
[INPUT] 1    0    [1    /1   ]  298.598736217        1
[INPUT] 1    0    [1    /1   ]  312.0052708          1
[INPUT] 1    0    [1    /1   ]  63.0958366524        1
[INPUT] 1    0    [1    /1   ]  7.17302148297        1
[INPUT] 1    0    [1    /1   ]  20.1468541909        1
[INPUT] 1    0    [1    /1   ]  0.767694708598       1
[INPUT] 1    0    [1    /1   ]  2.73843520436        1
[INPUT] 1    0    [1    /1   ]  0.221060492503       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.811930679898, 1.0]], [0, [7617.153788922891, 1.0]], [0, [3617.488147803906, 1.0]], [0, [1589.5633185556476, 1.0]], [0, [412.98870577820503, 1.0]], [0, [121.17805320908825, 1.0]], [0, [39.191829749214286, 1.0]], [0, [8.467185893769816, 1.0]], [0, [3.3423441490141177, 1.0]], [0, [0.6732886247092255, 1.0]], [0, [0.24913185534062926, 1.0]], [1, [1362.8346214657092, 1.0]], [1, [664.2441864322232, 1.0]], [1, [298.5987362172078, 1.0]], [1, [312.0052708003006, 1.0]], [1, [63.095836652423735, 1.0]], [1, [7.173021482974426, 1.0]], [1, [20.14685419092555, 1.0]], [1, [0.7676947085978536, 1.0]], [1, [2.7384352043615174, 1.0]], [1, [0.2210604925026865, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.81193068]
bas 1, expnt(s) = [7617.15378892]
bas 2, expnt(s) = [3617.4881478]
bas 3, expnt(s) = [1589.56331856]
bas 4, expnt(s) = [412.98870578]
bas 5, expnt(s) = [121.17805321]
bas 6, expnt(s) = [39.19182975]
bas 7, expnt(s) = [8.46718589]
bas 8, expnt(s) = [3.34234415]
bas 9, expnt(s) = [0.67328862]
bas 10, expnt(s) = [0.24913186]
bas 11, expnt(s) = [1362.83462147]
bas 12, expnt(s) = [664.24418643]
bas 13, expnt(s) = [298.59873622]
bas 14, expnt(s) = [312.0052708]
bas 15, expnt(s) = [63.09583665]
bas 16, expnt(s) = [7.17302148]
bas 17, expnt(s) = [20.14685419]
bas 18, expnt(s) = [0.76769471]
bas 19, expnt(s) = [2.7384352]
bas 20, expnt(s) = [0.22106049]
CPU time:       415.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828119e+04 5.20028612e+03 7.61715379e+03 2.05996370e+03
 3.61748815e+03 1.17847497e+03 1.58956332e+03 6.36023846e+02
 4.12988706e+02 2.31456113e+02 1.21178053e+02 9.22747766e+01
 3.91918297e+01 3.95741576e+01 8.46718589e+00 1.25406297e+01
 3.34234415e+00 6.24530134e+00 6.73288625e-01 1.87787198e+00
 2.49131855e-01 8.90916436e-01 1.36283462e+03 2.41567408e+04
 6.64244186e+02 9.83771179e+03 2.98598736e+02 3.62113194e+03
 3.12005271e+02 3.82548767e+03 6.30958367e+01 5.18782445e+02
 7.17302148e+00 3.42461738e+01 2.01468542e+01 1.24521243e+02
 7.67694709e-01 2.09638033e+00 2.73843520e+00 1.02769082e+01
 2.21060493e-01 4.42204654e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993753185510077
cond(S) = 98166.67856131766
E1 = -729.5318021338064  E_coul = 203.17910191543413
init E= -526.352700218372
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555862595389197  LUMO = 1.01944074189926
  mo_energy =
[-1.18331868e+02 -1.22048594e+01 -9.44662922e+00 -9.44662922e+00
 -9.44662922e+00 -1.23995359e+00 -5.55862595e-01 -5.55862595e-01
 -5.55862595e-01  1.01944074e+00  1.01944074e+00  1.01944074e+00
  1.05654766e+00  7.15019858e+00  7.15019858e+00  7.15019858e+00
  1.35414029e+01  3.27895345e+01  3.27895345e+01  3.27895345e+01
  1.21393282e+02  1.29405081e+02  1.29405081e+02  1.29405081e+02
  4.85062306e+02  4.85062306e+02  4.85062306e+02  6.56930645e+02
  1.33317150e+03  1.33317150e+03  1.33317150e+03  2.79235688e+03
  3.02138878e+03  3.02138878e+03  3.02138878e+03  6.63765187e+03
  6.63765187e+03  6.63765187e+03  9.21116961e+03  2.55594893e+04
  7.62907374e+04]
E1 = -727.8544252501134  E_coul = 201.10977016984242
cycle= 1 E= -526.744655080271  delta_E= -0.392  |g|= 0.185  |ddm|= 0.304
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538529
diis-c [-0.29001298  1.        ]
  HOMO = -0.590832143892701  LUMO = 0.995437968960504
  mo_energy =
[-1.18638776e+02 -1.23425082e+01 -9.59485592e+00 -9.59485592e+00
 -9.59485592e+00 -1.27958860e+00 -5.90832144e-01 -5.90832144e-01
 -5.90832144e-01  9.95437969e-01  9.95437969e-01  9.95437969e-01
  1.02693123e+00  7.06079856e+00  7.06079856e+00  7.06079856e+00
  1.34276252e+01  3.26363323e+01  3.26363323e+01  3.26363323e+01
  1.21164789e+02  1.29176044e+02  1.29176044e+02  1.29176044e+02
  4.84756900e+02  4.84756900e+02  4.84756900e+02  6.56579530e+02
  1.33281073e+03  1.33281073e+03  1.33281073e+03  2.79186196e+03
  3.02096266e+03  3.02096266e+03  3.02096266e+03  6.63711385e+03
  6.63711385e+03  6.63711385e+03  9.21055803e+03  2.55587840e+04
  7.62899424e+04]
E1 = -728.428540363144  E_coul = 201.68316932094038
cycle= 2 E= -526.745371042204  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747291
diis-c [-0.00327644  0.08233077  0.91766923]
  HOMO = -0.581697866613425  LUMO = 1.00207294048798
  mo_energy =
[-1.18571148e+02 -1.23044441e+01 -9.55513498e+00 -9.55513498e+00
 -9.55513498e+00 -1.26865865e+00 -5.81697867e-01 -5.81697867e-01
 -5.81697867e-01  1.00207294e+00  1.00207294e+00  1.00207294e+00
  1.03537612e+00  7.08420106e+00  7.08420106e+00  7.08420106e+00
  1.34587928e+01  3.26762665e+01  3.26762665e+01  3.26762665e+01
  1.21221998e+02  1.29232111e+02  1.29232111e+02  1.29232111e+02
  4.84823720e+02  4.84823720e+02  4.84823720e+02  6.56649209e+02
  1.33288156e+03  1.33288156e+03  1.33288156e+03  2.79193617e+03
  3.02103574e+03  3.02103574e+03  3.02103574e+03  6.63718869e+03
  6.63718869e+03  6.63718869e+03  9.21063369e+03  2.55588603e+04
  7.62900189e+04]
E1 = -728.2777774526087  E_coul = 201.5323474050955
cycle= 3 E= -526.745430047513  delta_E= -5.9e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131341
diis-c [-5.42340401e-07 -1.22309288e-03  1.45137098e-01  8.56085995e-01]
  HOMO = -0.583204949259071  LUMO = 1.00100135663208
  mo_energy =
[-1.18581138e+02 -1.23102793e+01 -9.56131437e+00 -9.56131437e+00
 -9.56131437e+00 -1.27036454e+00 -5.83204949e-01 -5.83204949e-01
 -5.83204949e-01  1.00100136e+00  1.00100136e+00  1.00100136e+00
  1.03407655e+00  7.08046294e+00  7.08046294e+00  7.08046294e+00
  1.34539904e+01  3.26700912e+01  3.26700912e+01  3.26700912e+01
  1.21213483e+02  1.29223705e+02  1.29223705e+02  1.29223705e+02
  4.84813845e+02  4.84813845e+02  4.84813845e+02  6.56638905e+02
  1.33287110e+03  1.33287110e+03  1.33287110e+03  2.79192507e+03
  3.02102490e+03  3.02102490e+03  3.02102490e+03  6.63717745e+03
  6.63717745e+03  6.63717745e+03  9.21062224e+03  2.55588486e+04
  7.62900072e+04]
E1 = -728.3007427953678  E_coul = 201.5553108055269
cycle= 4 E= -526.745431989841  delta_E= -1.94e-06  |g|= 9.35e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106392
diis-c [-3.95022380e-09  6.58671062e-05 -9.58680950e-03 -6.19233855e-02
  1.07144433e+00]
  HOMO = -0.583186003535026  LUMO = 1.00101723233395
  mo_energy =
[-1.18581096e+02 -1.23102139e+01 -9.56126173e+00 -9.56126173e+00
 -9.56126173e+00 -1.27032410e+00 -5.83186004e-01 -5.83186004e-01
 -5.83186004e-01  1.00101723e+00  1.00101723e+00  1.00101723e+00
  1.03411075e+00  7.08050522e+00  7.08050522e+00  7.08050522e+00
  1.34540507e+01  3.26701416e+01  3.26701416e+01  3.26701416e+01
  1.21213535e+02  1.29223754e+02  1.29223754e+02  1.29223754e+02
  4.84813887e+02  4.84813887e+02  4.84813887e+02  6.56638939e+02
  1.33287113e+03  1.33287113e+03  1.33287113e+03  2.79192508e+03
  3.02102492e+03  3.02102492e+03  3.02102492e+03  6.63717746e+03
  6.63717746e+03  6.63717746e+03  9.21062225e+03  2.55588486e+04
  7.62900071e+04]
E1 = -728.3005283170364  E_coul = 201.5550963256915
cycle= 5 E= -526.745431991345  delta_E= -1.5e-09  |g|= 2.02e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83826e-05
diis-c [-6.68784682e-11  1.42434776e-05 -1.87243967e-03 -1.39194874e-02
  4.26917091e-02  9.73085974e-01]
  HOMO = -0.583193210102936  LUMO = 1.00101252683315
  mo_energy =
[-1.18581126e+02 -1.23102358e+01 -9.56128558e+00 -9.56128558e+00
 -9.56128558e+00 -1.27032986e+00 -5.83193210e-01 -5.83193210e-01
 -5.83193210e-01  1.00101253e+00  1.00101253e+00  1.00101253e+00
  1.03410677e+00  7.08048930e+00  7.08048930e+00  7.08048930e+00
  1.34540325e+01  3.26701185e+01  3.26701185e+01  3.26701185e+01
  1.21213508e+02  1.29223727e+02  1.29223727e+02  1.29223727e+02
  4.84813857e+02  4.84813857e+02  4.84813857e+02  6.56638909e+02
  1.33287110e+03  1.33287110e+03  1.33287110e+03  2.79192505e+03
  3.02102489e+03  3.02102489e+03  3.02102489e+03  6.63717743e+03
  6.63717743e+03  6.63717743e+03  9.21062221e+03  2.55588486e+04
  7.62900071e+04]
E1 = -728.3006085140047  E_coul = 201.55517652260446
cycle= 6 E= -526.7454319914  delta_E= -5.53e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3006085140047  E_coul = 201.55517652260446
  HOMO = -0.583193247786625  LUMO = 1.00101255485047
  mo_energy =
[-1.18581126e+02 -1.23102358e+01 -9.56128561e+00 -9.56128561e+00
 -9.56128561e+00 -1.27032953e+00 -5.83193248e-01 -5.83193248e-01
 -5.83193248e-01  1.00101255e+00  1.00101255e+00  1.00101255e+00
  1.03410709e+00  7.08048929e+00  7.08048929e+00  7.08048929e+00
  1.34540326e+01  3.26701185e+01  3.26701185e+01  3.26701185e+01
  1.21213508e+02  1.29223727e+02  1.29223727e+02  1.29223727e+02
  4.84813858e+02  4.84813858e+02  4.84813858e+02  6.56638909e+02
  1.33287110e+03  1.33287110e+03  1.33287110e+03  2.79192505e+03
  3.02102489e+03  3.02102489e+03  3.02102489e+03  6.63717743e+03
  6.63717743e+03  6.63717743e+03  9.21062221e+03  2.55588486e+04
  7.62900071e+04]
E1 = -728.300607926021  E_coul = 201.5551759346203
Extra cycle  E= -526.745431991401  delta_E= -4.55e-13  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98166.67856131766
E1 = -728.300607926021  E_coul = 201.5551759346203
init E= -526.745431991401
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.5831932693973  LUMO = 1.00101255114034
  mo_energy =
[-1.18581126e+02 -1.23102358e+01 -9.56128567e+00 -9.56128567e+00
 -9.56128567e+00 -1.27032948e+00 -5.83193269e-01 -5.83193269e-01
 -5.83193269e-01  1.00101255e+00  1.00101255e+00  1.00101255e+00
  1.03410714e+00  7.08048926e+00  7.08048926e+00  7.08048926e+00
  1.34540326e+01  3.26701185e+01  3.26701185e+01  3.26701185e+01
  1.21213508e+02  1.29223727e+02  1.29223727e+02  1.29223727e+02
  4.84813857e+02  4.84813857e+02  4.84813857e+02  6.56638909e+02
  1.33287110e+03  1.33287110e+03  1.33287110e+03  2.79192505e+03
  3.02102489e+03  3.02102489e+03  3.02102489e+03  6.63717743e+03
  6.63717743e+03  6.63717743e+03  9.21062221e+03  2.55588486e+04
  7.62900071e+04]
E1 = -728.3006079976667  E_coul = 201.55517600626644
cycle= 1 E= -526.7454319914  delta_E= 4.55e-13  |g|= 7.16e-08  |ddm|= 5.78e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3006079976667  E_coul = 201.55517600626644
  HOMO = -0.583193270257647  LUMO = 1.00101255289184
  mo_energy =
[-1.18581126e+02 -1.23102358e+01 -9.56128567e+00 -9.56128567e+00
 -9.56128567e+00 -1.27032946e+00 -5.83193270e-01 -5.83193270e-01
 -5.83193270e-01  1.00101255e+00  1.00101255e+00  1.00101255e+00
  1.03410715e+00  7.08048926e+00  7.08048926e+00  7.08048926e+00
  1.34540326e+01  3.26701185e+01  3.26701185e+01  3.26701185e+01
  1.21213508e+02  1.29223727e+02  1.29223727e+02  1.29223727e+02
  4.84813857e+02  4.84813857e+02  4.84813857e+02  6.56638909e+02
  1.33287110e+03  1.33287110e+03  1.33287110e+03  2.79192505e+03
  3.02102489e+03  3.02102489e+03  3.02102489e+03  6.63717743e+03
  6.63717743e+03  6.63717743e+03  9.21062221e+03  2.55588486e+04
  7.62900071e+04]
E1 = -728.3006079580555  E_coul = 201.55517596665445
Extra cycle  E= -526.745431991401  delta_E= -7.96e-13  |g|= 1.44e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828119e+04 7.61715379e+03 3.61748815e+03 1.58956332e+03
 4.12988706e+02 1.21178053e+02 3.91918297e+01 8.46718589e+00
 3.34234415e+00 6.73288625e-01 2.49131855e-01 1.36283462e+03
 6.64244186e+02 2.98598736e+02 3.12005271e+02 6.30958367e+01
 7.17302148e+00 2.01468542e+01 7.67694709e-01 2.73843520e+00
 2.21060493e-01]
grad_E = [-1.42079327e-06  2.35658440e-06 -2.12654706e-06  4.28664668e-05
 -3.79728649e-05  2.92454628e-05  1.65635784e-06 -3.06731619e-07
 -3.08935037e-06  9.57931656e-05  6.50349796e-05 -6.31261971e-07
  3.16369638e-06  1.32114470e-05  1.13174393e-05  5.52220454e-04
 -7.03015776e-04 -1.24580536e-03 -9.77681811e-05 -2.85565971e-04
  2.47529659e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8087222        1
[INPUT] 0    0    [1    /1   ]  7617.16142087        1
[INPUT] 0    0    [1    /1   ]  3617.48538222        1
[INPUT] 0    0    [1    /1   ]  1589.73570332        1
[INPUT] 0    0    [1    /1   ]  412.310626821        1
[INPUT] 0    0    [1    /1   ]  121.083693593        1
[INPUT] 0    0    [1    /1   ]  39.1894134747        1
[INPUT] 0    0    [1    /1   ]  8.47794969019        1
[INPUT] 0    0    [1    /1   ]  3.34422383005        1
[INPUT] 0    0    [1    /1   ]  0.673501472405       1
[INPUT] 0    0    [1    /1   ]  0.249191196503       1
[INPUT] 1    0    [1    /1   ]  1362.83356828        1
[INPUT] 1    0    [1    /1   ]  664.254493188        1
[INPUT] 1    0    [1    /1   ]  298.647328062        1
[INPUT] 1    0    [1    /1   ]  312.047154559        1
[INPUT] 1    0    [1    /1   ]  63.0574818605        1
[INPUT] 1    0    [1    /1   ]  7.18710567004        1
[INPUT] 1    0    [1    /1   ]  20.1679221242        1
[INPUT] 1    0    [1    /1   ]  0.76853139331        1
[INPUT] 1    0    [1    /1   ]  2.74605417975        1
[INPUT] 1    0    [1    /1   ]  0.221212514749       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.808722242375, 1.0]], [0, [7617.161420872965, 1.0]], [0, [3617.48538222052, 1.0]], [0, [1589.7357033168132, 1.0]], [0, [412.3106268212642, 1.0]], [0, [121.08369359278528, 1.0]], [0, [39.18941347472833, 1.0]], [0, [8.477949690189536, 1.0]], [0, [3.3442238300542915, 1.0]], [0, [0.673501472404645, 1.0]], [0, [0.24919119650345262, 1.0]], [1, [1362.8335682765041, 1.0]], [1, [664.2544931876437, 1.0]], [1, [298.64732806199396, 1.0]], [1, [312.04715455926873, 1.0]], [1, [63.05748186053232, 1.0]], [1, [7.187105670044417, 1.0]], [1, [20.167922124150028, 1.0]], [1, [0.7685313933099253, 1.0]], [1, [2.746054179751817, 1.0]], [1, [0.2212125147485775, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80872224]
bas 1, expnt(s) = [7617.16142087]
bas 2, expnt(s) = [3617.48538222]
bas 3, expnt(s) = [1589.73570332]
bas 4, expnt(s) = [412.31062682]
bas 5, expnt(s) = [121.08369359]
bas 6, expnt(s) = [39.18941347]
bas 7, expnt(s) = [8.47794969]
bas 8, expnt(s) = [3.34422383]
bas 9, expnt(s) = [0.67350147]
bas 10, expnt(s) = [0.2491912]
bas 11, expnt(s) = [1362.83356828]
bas 12, expnt(s) = [664.25449319]
bas 13, expnt(s) = [298.64732806]
bas 14, expnt(s) = [312.04715456]
bas 15, expnt(s) = [63.05748186]
bas 16, expnt(s) = [7.18710567]
bas 17, expnt(s) = [20.16792212]
bas 18, expnt(s) = [0.76853139]
bas 19, expnt(s) = [2.74605418]
bas 20, expnt(s) = [0.22121251]
CPU time:       420.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828087e+04 5.20028564e+03 7.61716142e+03 2.05996525e+03
 3.61748538e+03 1.17847429e+03 1.58973570e+03 6.36075577e+02
 4.12310627e+02 2.31171037e+02 1.21083694e+02 9.22208816e+01
 3.91894135e+01 3.95723277e+01 8.47794969e+00 1.25525844e+01
 3.34422383e+00 6.24793535e+00 6.73501472e-01 1.87831720e+00
 2.49191197e-01 8.91075588e-01 1.36283357e+03 2.41567175e+04
 6.64254493e+02 9.83790260e+03 2.98647328e+02 3.62186855e+03
 3.12047155e+02 3.82612960e+03 6.30574819e+01 5.18388277e+02
 7.18710567e+00 3.43302472e+01 2.01679221e+01 1.24684032e+02
 7.68531393e-01 2.09923669e+00 2.74605418e+00 1.03126617e+01
 2.21212515e-01 4.42584814e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993725988227848
cond(S) = 98309.12457664647
E1 = -729.5322298608638  E_coul = 203.17925914311758
init E= -526.352970717746
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555856274676692  LUMO = 1.02078080220321
  mo_energy =
[-1.18331842e+02 -1.22048374e+01 -9.44663007e+00 -9.44663007e+00
 -9.44663007e+00 -1.23995011e+00 -5.55856275e-01 -5.55856275e-01
 -5.55856275e-01  1.02078080e+00  1.02078080e+00  1.02078080e+00
  1.05711456e+00  7.17046223e+00  7.17046223e+00  7.17046223e+00
  1.35597524e+01  3.28675325e+01  3.28675325e+01  3.28675325e+01
  1.21399263e+02  1.29505258e+02  1.29505258e+02  1.29505258e+02
  4.85123027e+02  4.85123027e+02  4.85123027e+02  6.56273574e+02
  1.33329587e+03  1.33329587e+03  1.33329587e+03  2.79040736e+03
  3.02163100e+03  3.02163100e+03  3.02163100e+03  6.63797525e+03
  6.63797525e+03  6.63797525e+03  9.20886039e+03  2.55572764e+04
  7.62887008e+04]
E1 = -727.8549822378294  E_coul = 201.11030431132107
cycle= 1 E= -526.744677926508  delta_E= -0.392  |g|= 0.185  |ddm|= 0.304
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538655
diis-c [-0.29014941  1.        ]
  HOMO = -0.590817185445943  LUMO = 0.996747354532224
  mo_energy =
[-1.18638672e+02 -1.23424634e+01 -9.59484017e+00 -9.59484017e+00
 -9.59484017e+00 -1.27957350e+00 -5.90817185e-01 -5.90817185e-01
 -5.90817185e-01  9.96747355e-01  9.96747355e-01  9.96747355e-01
  1.02749615e+00  7.08093519e+00  7.08093519e+00  7.08093519e+00
  1.34459356e+01  3.27142715e+01  3.27142715e+01  3.27142715e+01
  1.21170834e+02  1.29276306e+02  1.29276306e+02  1.29276306e+02
  4.84817698e+02  4.84817698e+02  4.84817698e+02  6.55922670e+02
  1.33293518e+03  1.33293518e+03  1.33293518e+03  2.78991258e+03
  3.02120498e+03  3.02120498e+03  3.02120498e+03  6.63743732e+03
  6.63743732e+03  6.63743732e+03  9.20824890e+03  2.55565712e+04
  7.62879059e+04]
E1 = -728.4288969941282  E_coul = 201.6835033660324
cycle= 2 E= -526.745393628096  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747347
diis-c [-0.00327761  0.08230755  0.91769245]
  HOMO = -0.581686872266398  LUMO = 1.00339006064034
  mo_energy =
[-1.18571062e+02 -1.23044113e+01 -9.55513215e+00 -9.55513215e+00
 -9.55513215e+00 -1.26864798e+00 -5.81686872e-01 -5.81686872e-01
 -5.81686872e-01  1.00339006e+00  1.00339006e+00  1.00339006e+00
  1.03594167e+00  7.10436648e+00  7.10436648e+00  7.10436648e+00
  1.34771102e+01  3.27542133e+01  3.27542133e+01  3.27542133e+01
  1.21228021e+02  1.29332352e+02  1.29332352e+02  1.29332352e+02
  4.84884498e+02  4.84884498e+02  4.84884498e+02  6.55992323e+02
  1.33300599e+03  1.33300599e+03  1.33300599e+03  2.78998677e+03
  3.02127804e+03  3.02127804e+03  3.02127804e+03  6.63751214e+03
  6.63751214e+03  6.63751214e+03  9.20832453e+03  2.55566474e+04
  7.62879824e+04]
E1 = -728.2782065853789  E_coul = 201.53275399553954
cycle= 3 E= -526.745452589839  delta_E= -5.9e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131354
diis-c [-5.42945258e-07 -1.22302568e-03  1.45140624e-01  8.56082402e-01]
  HOMO = -0.583193207801411  LUMO = 1.00231731198654
  mo_energy =
[-1.18581049e+02 -1.23102441e+01 -9.56130911e+00 -9.56130911e+00
 -9.56130911e+00 -1.27035293e+00 -5.83193208e-01 -5.83193208e-01
 -5.83193208e-01  1.00231731e+00  1.00231731e+00  1.00231731e+00
  1.03464223e+00  7.10062424e+00  7.10062424e+00  7.10062424e+00
  1.34723073e+01  3.27480375e+01  3.27480375e+01  3.27480375e+01
  1.21219509e+02  1.29323949e+02  1.29323949e+02  1.29323949e+02
  4.84874626e+02  4.84874626e+02  4.84874626e+02  6.55982024e+02
  1.33299553e+03  1.33299553e+03  1.33299553e+03  2.78997568e+03
  3.02126720e+03  3.02126720e+03  3.02126720e+03  6.63750091e+03
  6.63750091e+03  6.63750091e+03  9.20831309e+03  2.55566358e+04
  7.62879707e+04]
E1 = -728.3011589428188  E_coul = 201.55570441231197
cycle= 4 E= -526.745454530507  delta_E= -1.94e-06  |g|= 9.36e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106705
diis-c [-3.94841116e-09  6.61154625e-05 -9.61652949e-03 -6.21275561e-02
  1.07167797e+00]
  HOMO = -0.583174317658073  LUMO = 1.00233317154799
  mo_energy =
[-1.18581007e+02 -1.23101788e+01 -9.56125664e+00 -9.56125664e+00
 -9.56125664e+00 -1.27031253e+00 -5.83174318e-01 -5.83174318e-01
 -5.83174318e-01  1.00233317e+00  1.00233317e+00  1.00233317e+00
  1.03467641e+00  7.10066643e+00  7.10066643e+00  7.10066643e+00
  1.34723676e+01  3.27480878e+01  3.27480878e+01  3.27480878e+01
  1.21219562e+02  1.29323998e+02  1.29323998e+02  1.29323998e+02
  4.84874668e+02  4.84874668e+02  4.84874668e+02  6.55982058e+02
  1.33299557e+03  1.33299557e+03  1.33299557e+03  2.78997569e+03
  3.02126722e+03  3.02126722e+03  3.02126722e+03  6.63750092e+03
  6.63750092e+03  6.63750092e+03  9.20831309e+03  2.55566358e+04
  7.62879707e+04]
E1 = -728.300945048898  E_coul = 201.5554905168845
cycle= 5 E= -526.745454532014  delta_E= -1.51e-09  |g|= 2.02e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83768e-05
diis-c [-6.69625089e-11  1.42298697e-05 -1.87109996e-03 -1.39120203e-02
  4.27849172e-02  9.72983973e-01]
  HOMO = -0.583181524935044  LUMO = 1.00232845762853
  mo_energy =
[-1.18581037e+02 -1.23102008e+01 -9.56128049e+00 -9.56128049e+00
 -9.56128049e+00 -1.27031829e+00 -5.83181525e-01 -5.83181525e-01
 -5.83181525e-01  1.00232846e+00  1.00232846e+00  1.00232846e+00
  1.03467243e+00  7.10065049e+00  7.10065049e+00  7.10065049e+00
  1.34723494e+01  3.27480647e+01  3.27480647e+01  3.27480647e+01
  1.21219534e+02  1.29323971e+02  1.29323971e+02  1.29323971e+02
  4.84874639e+02  4.84874639e+02  4.84874639e+02  6.55982027e+02
  1.33299554e+03  1.33299554e+03  1.33299554e+03  2.78997566e+03
  3.02126719e+03  3.02126719e+03  3.02126719e+03  6.63750089e+03
  6.63750089e+03  6.63750089e+03  9.20831306e+03  2.55566358e+04
  7.62879706e+04]
E1 = -728.3010252284689  E_coul = 201.55557069640025
cycle= 6 E= -526.745454532069  delta_E= -5.5e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3010252284689  E_coul = 201.55557069640025
  HOMO = -0.583181561877587  LUMO = 1.00232848614413
  mo_energy =
[-1.18581037e+02 -1.23102007e+01 -9.56128052e+00 -9.56128052e+00
 -9.56128052e+00 -1.27031796e+00 -5.83181562e-01 -5.83181562e-01
 -5.83181562e-01  1.00232849e+00  1.00232849e+00  1.00232849e+00
  1.03467275e+00  7.10065049e+00  7.10065049e+00  7.10065049e+00
  1.34723495e+01  3.27480647e+01  3.27480647e+01  3.27480647e+01
  1.21219534e+02  1.29323971e+02  1.29323971e+02  1.29323971e+02
  4.84874639e+02  4.84874639e+02  4.84874639e+02  6.55982027e+02
  1.33299554e+03  1.33299554e+03  1.33299554e+03  2.78997566e+03
  3.02126719e+03  3.02126719e+03  3.02126719e+03  6.63750089e+03
  6.63750089e+03  6.63750089e+03  9.20831306e+03  2.55566358e+04
  7.62879706e+04]
E1 = -728.301024627901  E_coul = 201.55557009583126
Extra cycle  E= -526.74545453207  delta_E= -1.14e-12  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828087e+04 7.61716142e+03 3.61748538e+03 1.58973570e+03
 4.12310627e+02 1.21083694e+02 3.91894135e+01 8.47794969e+00
 3.34422383e+00 6.73501472e-01 2.49191197e-01 1.36283357e+03
 6.64254493e+02 2.98647328e+02 3.12047155e+02 6.30574819e+01
 7.18710567e+00 2.01679221e+01 7.68531393e-01 2.74605418e+00
 2.21212515e-01]
E = -526.7454545320697
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8087222        1
[INPUT] 0    0    [1    /1   ]  7617.16142087        1
[INPUT] 0    0    [1    /1   ]  3617.48538222        1
[INPUT] 0    0    [1    /1   ]  1589.73570332        1
[INPUT] 0    0    [1    /1   ]  412.310626821        1
[INPUT] 0    0    [1    /1   ]  121.083693593        1
[INPUT] 0    0    [1    /1   ]  39.1894134747        1
[INPUT] 0    0    [1    /1   ]  8.47794969019        1
[INPUT] 0    0    [1    /1   ]  3.34422383005        1
[INPUT] 0    0    [1    /1   ]  0.673501472405       1
[INPUT] 0    0    [1    /1   ]  0.249191196503       1
[INPUT] 1    0    [1    /1   ]  1362.83356828        1
[INPUT] 1    0    [1    /1   ]  664.254493188        1
[INPUT] 1    0    [1    /1   ]  298.647328062        1
[INPUT] 1    0    [1    /1   ]  312.047154559        1
[INPUT] 1    0    [1    /1   ]  63.0574818605        1
[INPUT] 1    0    [1    /1   ]  7.18710567004        1
[INPUT] 1    0    [1    /1   ]  20.1679221242        1
[INPUT] 1    0    [1    /1   ]  0.76853139331        1
[INPUT] 1    0    [1    /1   ]  2.74605417975        1
[INPUT] 1    0    [1    /1   ]  0.221212514749       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.808722242375, 1.0]], [0, [7617.161420872965, 1.0]], [0, [3617.48538222052, 1.0]], [0, [1589.7357033168132, 1.0]], [0, [412.3106268212642, 1.0]], [0, [121.08369359278528, 1.0]], [0, [39.18941347472833, 1.0]], [0, [8.477949690189536, 1.0]], [0, [3.3442238300542915, 1.0]], [0, [0.673501472404645, 1.0]], [0, [0.24919119650345262, 1.0]], [1, [1362.8335682765041, 1.0]], [1, [664.2544931876437, 1.0]], [1, [298.64732806199396, 1.0]], [1, [312.04715455926873, 1.0]], [1, [63.05748186053232, 1.0]], [1, [7.187105670044417, 1.0]], [1, [20.167922124150028, 1.0]], [1, [0.7685313933099253, 1.0]], [1, [2.746054179751817, 1.0]], [1, [0.2212125147485775, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80872224]
bas 1, expnt(s) = [7617.16142087]
bas 2, expnt(s) = [3617.48538222]
bas 3, expnt(s) = [1589.73570332]
bas 4, expnt(s) = [412.31062682]
bas 5, expnt(s) = [121.08369359]
bas 6, expnt(s) = [39.18941347]
bas 7, expnt(s) = [8.47794969]
bas 8, expnt(s) = [3.34422383]
bas 9, expnt(s) = [0.67350147]
bas 10, expnt(s) = [0.2491912]
bas 11, expnt(s) = [1362.83356828]
bas 12, expnt(s) = [664.25449319]
bas 13, expnt(s) = [298.64732806]
bas 14, expnt(s) = [312.04715456]
bas 15, expnt(s) = [63.05748186]
bas 16, expnt(s) = [7.18710567]
bas 17, expnt(s) = [20.16792212]
bas 18, expnt(s) = [0.76853139]
bas 19, expnt(s) = [2.74605418]
bas 20, expnt(s) = [0.22121251]
CPU time:       421.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828087e+04 5.20028564e+03 7.61716142e+03 2.05996525e+03
 3.61748538e+03 1.17847429e+03 1.58973570e+03 6.36075577e+02
 4.12310627e+02 2.31171037e+02 1.21083694e+02 9.22208816e+01
 3.91894135e+01 3.95723277e+01 8.47794969e+00 1.25525844e+01
 3.34422383e+00 6.24793535e+00 6.73501472e-01 1.87831720e+00
 2.49191197e-01 8.91075588e-01 1.36283357e+03 2.41567175e+04
 6.64254493e+02 9.83790260e+03 2.98647328e+02 3.62186855e+03
 3.12047155e+02 3.82612960e+03 6.30574819e+01 5.18388277e+02
 7.18710567e+00 3.43302472e+01 2.01679221e+01 1.24684032e+02
 7.68531393e-01 2.09923669e+00 2.74605418e+00 1.03126617e+01
 2.21212515e-01 4.42584814e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993725988227848
cond(S) = 98309.12457664647
E1 = -729.5322298608638  E_coul = 203.17925914311758
init E= -526.352970717746
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555856274676692  LUMO = 1.02078080220321
  mo_energy =
[-1.18331842e+02 -1.22048374e+01 -9.44663007e+00 -9.44663007e+00
 -9.44663007e+00 -1.23995011e+00 -5.55856275e-01 -5.55856275e-01
 -5.55856275e-01  1.02078080e+00  1.02078080e+00  1.02078080e+00
  1.05711456e+00  7.17046223e+00  7.17046223e+00  7.17046223e+00
  1.35597524e+01  3.28675325e+01  3.28675325e+01  3.28675325e+01
  1.21399263e+02  1.29505258e+02  1.29505258e+02  1.29505258e+02
  4.85123027e+02  4.85123027e+02  4.85123027e+02  6.56273574e+02
  1.33329587e+03  1.33329587e+03  1.33329587e+03  2.79040736e+03
  3.02163100e+03  3.02163100e+03  3.02163100e+03  6.63797525e+03
  6.63797525e+03  6.63797525e+03  9.20886039e+03  2.55572764e+04
  7.62887008e+04]
E1 = -727.8549822378294  E_coul = 201.11030431132107
cycle= 1 E= -526.744677926508  delta_E= -0.392  |g|= 0.185  |ddm|= 0.304
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538655
diis-c [-0.29014941  1.        ]
  HOMO = -0.590817185445943  LUMO = 0.996747354532224
  mo_energy =
[-1.18638672e+02 -1.23424634e+01 -9.59484017e+00 -9.59484017e+00
 -9.59484017e+00 -1.27957350e+00 -5.90817185e-01 -5.90817185e-01
 -5.90817185e-01  9.96747355e-01  9.96747355e-01  9.96747355e-01
  1.02749615e+00  7.08093519e+00  7.08093519e+00  7.08093519e+00
  1.34459356e+01  3.27142715e+01  3.27142715e+01  3.27142715e+01
  1.21170834e+02  1.29276306e+02  1.29276306e+02  1.29276306e+02
  4.84817698e+02  4.84817698e+02  4.84817698e+02  6.55922670e+02
  1.33293518e+03  1.33293518e+03  1.33293518e+03  2.78991258e+03
  3.02120498e+03  3.02120498e+03  3.02120498e+03  6.63743732e+03
  6.63743732e+03  6.63743732e+03  9.20824890e+03  2.55565712e+04
  7.62879059e+04]
E1 = -728.4288969941282  E_coul = 201.6835033660324
cycle= 2 E= -526.745393628096  delta_E= -0.000716  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747347
diis-c [-0.00327761  0.08230755  0.91769245]
  HOMO = -0.581686872266398  LUMO = 1.00339006064034
  mo_energy =
[-1.18571062e+02 -1.23044113e+01 -9.55513215e+00 -9.55513215e+00
 -9.55513215e+00 -1.26864798e+00 -5.81686872e-01 -5.81686872e-01
 -5.81686872e-01  1.00339006e+00  1.00339006e+00  1.00339006e+00
  1.03594167e+00  7.10436648e+00  7.10436648e+00  7.10436648e+00
  1.34771102e+01  3.27542133e+01  3.27542133e+01  3.27542133e+01
  1.21228021e+02  1.29332352e+02  1.29332352e+02  1.29332352e+02
  4.84884498e+02  4.84884498e+02  4.84884498e+02  6.55992323e+02
  1.33300599e+03  1.33300599e+03  1.33300599e+03  2.78998677e+03
  3.02127804e+03  3.02127804e+03  3.02127804e+03  6.63751214e+03
  6.63751214e+03  6.63751214e+03  9.20832453e+03  2.55566474e+04
  7.62879824e+04]
E1 = -728.2782065853789  E_coul = 201.53275399553954
cycle= 3 E= -526.745452589839  delta_E= -5.9e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131354
diis-c [-5.42945258e-07 -1.22302568e-03  1.45140624e-01  8.56082402e-01]
  HOMO = -0.583193207801411  LUMO = 1.00231731198654
  mo_energy =
[-1.18581049e+02 -1.23102441e+01 -9.56130911e+00 -9.56130911e+00
 -9.56130911e+00 -1.27035293e+00 -5.83193208e-01 -5.83193208e-01
 -5.83193208e-01  1.00231731e+00  1.00231731e+00  1.00231731e+00
  1.03464223e+00  7.10062424e+00  7.10062424e+00  7.10062424e+00
  1.34723073e+01  3.27480375e+01  3.27480375e+01  3.27480375e+01
  1.21219509e+02  1.29323949e+02  1.29323949e+02  1.29323949e+02
  4.84874626e+02  4.84874626e+02  4.84874626e+02  6.55982024e+02
  1.33299553e+03  1.33299553e+03  1.33299553e+03  2.78997568e+03
  3.02126720e+03  3.02126720e+03  3.02126720e+03  6.63750091e+03
  6.63750091e+03  6.63750091e+03  9.20831309e+03  2.55566358e+04
  7.62879707e+04]
E1 = -728.3011589428188  E_coul = 201.55570441231197
cycle= 4 E= -526.745454530507  delta_E= -1.94e-06  |g|= 9.36e-05  |ddm|= 0.00229
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106705
diis-c [-3.94841116e-09  6.61154625e-05 -9.61652949e-03 -6.21275561e-02
  1.07167797e+00]
  HOMO = -0.583174317658073  LUMO = 1.00233317154799
  mo_energy =
[-1.18581007e+02 -1.23101788e+01 -9.56125664e+00 -9.56125664e+00
 -9.56125664e+00 -1.27031253e+00 -5.83174318e-01 -5.83174318e-01
 -5.83174318e-01  1.00233317e+00  1.00233317e+00  1.00233317e+00
  1.03467641e+00  7.10066643e+00  7.10066643e+00  7.10066643e+00
  1.34723676e+01  3.27480878e+01  3.27480878e+01  3.27480878e+01
  1.21219562e+02  1.29323998e+02  1.29323998e+02  1.29323998e+02
  4.84874668e+02  4.84874668e+02  4.84874668e+02  6.55982058e+02
  1.33299557e+03  1.33299557e+03  1.33299557e+03  2.78997569e+03
  3.02126722e+03  3.02126722e+03  3.02126722e+03  6.63750092e+03
  6.63750092e+03  6.63750092e+03  9.20831309e+03  2.55566358e+04
  7.62879707e+04]
E1 = -728.300945048898  E_coul = 201.5554905168845
cycle= 5 E= -526.745454532014  delta_E= -1.51e-09  |g|= 2.02e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83768e-05
diis-c [-6.69625089e-11  1.42298697e-05 -1.87109996e-03 -1.39120203e-02
  4.27849172e-02  9.72983973e-01]
  HOMO = -0.583181524935044  LUMO = 1.00232845762853
  mo_energy =
[-1.18581037e+02 -1.23102008e+01 -9.56128049e+00 -9.56128049e+00
 -9.56128049e+00 -1.27031829e+00 -5.83181525e-01 -5.83181525e-01
 -5.83181525e-01  1.00232846e+00  1.00232846e+00  1.00232846e+00
  1.03467243e+00  7.10065049e+00  7.10065049e+00  7.10065049e+00
  1.34723494e+01  3.27480647e+01  3.27480647e+01  3.27480647e+01
  1.21219534e+02  1.29323971e+02  1.29323971e+02  1.29323971e+02
  4.84874639e+02  4.84874639e+02  4.84874639e+02  6.55982027e+02
  1.33299554e+03  1.33299554e+03  1.33299554e+03  2.78997566e+03
  3.02126719e+03  3.02126719e+03  3.02126719e+03  6.63750089e+03
  6.63750089e+03  6.63750089e+03  9.20831306e+03  2.55566358e+04
  7.62879706e+04]
E1 = -728.3010252284689  E_coul = 201.55557069640025
cycle= 6 E= -526.745454532069  delta_E= -5.5e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3010252284689  E_coul = 201.55557069640025
  HOMO = -0.583181561877587  LUMO = 1.00232848614413
  mo_energy =
[-1.18581037e+02 -1.23102007e+01 -9.56128052e+00 -9.56128052e+00
 -9.56128052e+00 -1.27031796e+00 -5.83181562e-01 -5.83181562e-01
 -5.83181562e-01  1.00232849e+00  1.00232849e+00  1.00232849e+00
  1.03467275e+00  7.10065049e+00  7.10065049e+00  7.10065049e+00
  1.34723495e+01  3.27480647e+01  3.27480647e+01  3.27480647e+01
  1.21219534e+02  1.29323971e+02  1.29323971e+02  1.29323971e+02
  4.84874639e+02  4.84874639e+02  4.84874639e+02  6.55982027e+02
  1.33299554e+03  1.33299554e+03  1.33299554e+03  2.78997566e+03
  3.02126719e+03  3.02126719e+03  3.02126719e+03  6.63750089e+03
  6.63750089e+03  6.63750089e+03  9.20831306e+03  2.55566358e+04
  7.62879706e+04]
E1 = -728.301024627901  E_coul = 201.55557009583126
Extra cycle  E= -526.74545453207  delta_E= -1.14e-12  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98309.12457664647
E1 = -728.301024627901  E_coul = 201.55557009583126
init E= -526.74545453207
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.583181583758402  LUMO = 1.00232848221878
  mo_energy =
[-1.18581037e+02 -1.23102007e+01 -9.56128058e+00 -9.56128058e+00
 -9.56128058e+00 -1.27031791e+00 -5.83181584e-01 -5.83181584e-01
 -5.83181584e-01  1.00232848e+00  1.00232848e+00  1.00232848e+00
  1.03467280e+00  7.10065045e+00  7.10065045e+00  7.10065045e+00
  1.34723495e+01  3.27480646e+01  3.27480646e+01  3.27480646e+01
  1.21219534e+02  1.29323971e+02  1.29323971e+02  1.29323971e+02
  4.84874639e+02  4.84874639e+02  4.84874639e+02  6.55982027e+02
  1.33299554e+03  1.33299554e+03  1.33299554e+03  2.78997566e+03
  3.02126719e+03  3.02126719e+03  3.02126719e+03  6.63750089e+03
  6.63750089e+03  6.63750089e+03  9.20831306e+03  2.55566358e+04
  7.62879706e+04]
E1 = -728.3010247026782  E_coul = 201.555570170608
cycle= 1 E= -526.74545453207  delta_E= -4.55e-13  |g|= 7.16e-08  |ddm|= 5.77e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3010247026782  E_coul = 201.555570170608
  HOMO = -0.583181584564211  LUMO = 1.00232848400746
  mo_energy =
[-1.18581037e+02 -1.23102007e+01 -9.56128058e+00 -9.56128058e+00
 -9.56128058e+00 -1.27031789e+00 -5.83181585e-01 -5.83181585e-01
 -5.83181585e-01  1.00232848e+00  1.00232848e+00  1.00232848e+00
  1.03467281e+00  7.10065045e+00  7.10065045e+00  7.10065045e+00
  1.34723495e+01  3.27480646e+01  3.27480646e+01  3.27480646e+01
  1.21219534e+02  1.29323971e+02  1.29323971e+02  1.29323971e+02
  4.84874639e+02  4.84874639e+02  4.84874639e+02  6.55982027e+02
  1.33299554e+03  1.33299554e+03  1.33299554e+03  2.78997566e+03
  3.02126719e+03  3.02126719e+03  3.02126719e+03  6.63750089e+03
  6.63750089e+03  6.63750089e+03  9.20831306e+03  2.55566358e+04
  7.62879706e+04]
E1 = -728.3010246621151  E_coul = 201.5555701300452
Extra cycle  E= -526.74545453207  delta_E= 3.41e-13  |g|= 1.44e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.37 sec
exp = [2.61828087e+04 7.61716142e+03 3.61748538e+03 1.58973570e+03
 4.12310627e+02 1.21083694e+02 3.91894135e+01 8.47794969e+00
 3.34422383e+00 6.73501472e-01 2.49191197e-01 1.36283357e+03
 6.64254493e+02 2.98647328e+02 3.12047155e+02 6.30574819e+01
 7.18710567e+00 2.01679221e+01 7.68531393e-01 2.74605418e+00
 2.21212515e-01]
grad_E = [-1.42457441e-06  2.38946172e-06 -2.12336174e-06  4.39067142e-05
 -4.95985751e-05  4.96038939e-05  1.55752684e-05  7.21880093e-05
 -1.59202451e-04  1.70638357e-04 -3.15859958e-05 -6.27920650e-07
  3.23784429e-06  1.36425070e-05  1.16849750e-05  5.16051652e-04
 -8.99734283e-04 -1.10776315e-03  2.07364366e-04  5.53082489e-05
 -6.08057056e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8051926        1
[INPUT] 0    0    [1    /1   ]  7617.16984886        1
[INPUT] 0    0    [1    /1   ]  3617.48236748        1
[INPUT] 0    0    [1    /1   ]  1589.92646706        1
[INPUT] 0    0    [1    /1   ]  411.549096304        1
[INPUT] 0    0    [1    /1   ]  121.009542186        1
[INPUT] 0    0    [1    /1   ]  39.1998283932        1
[INPUT] 0    0    [1    /1   ]  8.49701466552        1
[INPUT] 0    0    [1    /1   ]  3.34792168318        1
[INPUT] 0    0    [1    /1   ]  0.673766768103       1
[INPUT] 0    0    [1    /1   ]  0.249281468887       1
[INPUT] 1    0    [1    /1   ]  1362.83241364        1
[INPUT] 1    0    [1    /1   ]  664.265859931        1
[INPUT] 1    0    [1    /1   ]  298.700955876        1
[INPUT] 1    0    [1    /1   ]  312.093380464        1
[INPUT] 1    0    [1    /1   ]  63.0022269102        1
[INPUT] 1    0    [1    /1   ]  7.21917684246        1
[INPUT] 1    0    [1    /1   ]  20.2201584419        1
[INPUT] 1    0    [1    /1   ]  0.770288631291       1
[INPUT] 1    0    [1    /1   ]  2.76187546563        1
[INPUT] 1    0    [1    /1   ]  0.221542827295       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.8051925798, 1.0]], [0, [7617.169848858578, 1.0]], [0, [3617.482367483591, 1.0]], [0, [1589.9264670633572, 1.0]], [0, [411.5490963037592, 1.0]], [0, [121.009542185575, 1.0]], [0, [39.19982839315249, 1.0]], [0, [8.49701466551907, 1.0]], [0, [3.3479216831821814, 1.0]], [0, [0.6737667681031125, 1.0]], [0, [0.24928146888660058, 1.0]], [1, [1362.832413638474, 1.0]], [1, [664.2658599305817, 1.0]], [1, [298.70095587623484, 1.0]], [1, [312.0933804642407, 1.0]], [1, [63.00222691017767, 1.0]], [1, [7.219176842463761, 1.0]], [1, [20.220158441932277, 1.0]], [1, [0.7702886312910119, 1.0]], [1, [2.761875465629876, 1.0]], [1, [0.22154282729492714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80519258]
bas 1, expnt(s) = [7617.16984886]
bas 2, expnt(s) = [3617.48236748]
bas 3, expnt(s) = [1589.92646706]
bas 4, expnt(s) = [411.5490963]
bas 5, expnt(s) = [121.00954219]
bas 6, expnt(s) = [39.19982839]
bas 7, expnt(s) = [8.49701467]
bas 8, expnt(s) = [3.34792168]
bas 9, expnt(s) = [0.67376677]
bas 10, expnt(s) = [0.24928147]
bas 11, expnt(s) = [1362.83241364]
bas 12, expnt(s) = [664.26585993]
bas 13, expnt(s) = [298.70095588]
bas 14, expnt(s) = [312.09338046]
bas 15, expnt(s) = [63.00222691]
bas 16, expnt(s) = [7.21917684]
bas 17, expnt(s) = [20.22015844]
bas 18, expnt(s) = [0.77028863]
bas 19, expnt(s) = [2.76187547]
bas 20, expnt(s) = [0.22154283]
CPU time:       427.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828052e+04 5.20028511e+03 7.61716985e+03 2.05996696e+03
 3.61748237e+03 1.17847356e+03 1.58992647e+03 6.36132821e+02
 4.11549096e+02 2.30850736e+02 1.21009542e+02 9.21785214e+01
 3.91998284e+01 3.95802150e+01 8.49701467e+00 1.25737494e+01
 3.34792168e+00 6.25311609e+00 6.73766768e-01 1.87887209e+00
 2.49281469e-01 8.91317679e-01 1.36283241e+03 2.41566919e+04
 6.64265860e+02 9.83811303e+03 2.98700956e+02 3.62268154e+03
 3.12093380e+02 3.82683810e+03 6.30022269e+01 5.17820534e+02
 7.21917684e+00 3.45218446e+01 2.02201584e+01 1.25087838e+02
 7.70288631e-01 2.10523825e+00 2.76187547e+00 1.03869851e+01
 2.21542827e-01 4.43411048e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993667542122438
cond(S) = 98499.16618644401
E1 = -729.5328407283915  E_coul = 203.1795254309701
init E= -526.353315297421
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555842496977086  LUMO = 1.02363602545812
  mo_energy =
[-1.18331804e+02 -1.22047957e+01 -9.44663597e+00 -9.44663597e+00
 -9.44663597e+00 -1.23994551e+00 -5.55842497e-01 -5.55842497e-01
 -5.55842497e-01  1.02363603e+00  1.02363603e+00  1.02363603e+00
  1.05794243e+00  7.21351316e+00  7.21351316e+00  7.21351316e+00
  1.35933338e+01  3.30417203e+01  3.30417203e+01  3.30417203e+01
  1.21480485e+02  1.29768103e+02  1.29768103e+02  1.29768103e+02
  4.85321511e+02  4.85321511e+02  4.85321511e+02  6.55695957e+02
  1.33354382e+03  1.33354382e+03  1.33354382e+03  2.78840596e+03
  3.02199820e+03  3.02199820e+03  3.02199820e+03  6.63842209e+03
  6.63842209e+03  6.63842209e+03  9.20644778e+03  2.55549621e+04
  7.62865723e+04]
E1 = -727.856384350042  E_coul = 201.11165041467308
cycle= 1 E= -526.744733935369  delta_E= -0.391  |g|= 0.185  |ddm|= 0.303
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538825
diis-c [-0.29033191  1.        ]
  HOMO = -0.590775160282405  LUMO = 0.999545251493336
  mo_energy =
[-1.18638452e+02 -1.23423565e+01 -9.59478932e+00 -9.59478932e+00
 -9.59478932e+00 -1.27953350e+00 -5.90775160e-01 -5.90775160e-01
 -5.90775160e-01  9.99545251e-01  9.99545251e-01  9.99545251e-01
  1.02833745e+00  7.12373010e+00  7.12373010e+00  7.12373010e+00
  1.34794632e+01  3.28883329e+01  3.28883329e+01  3.28883329e+01
  1.21252160e+02  1.29539326e+02  1.29539326e+02  1.29539326e+02
  4.85016373e+02  4.85016373e+02  4.85016373e+02  6.55345386e+02
  1.33318333e+03  1.33318333e+03  1.33318333e+03  2.78791146e+03
  3.02157240e+03  3.02157240e+03  3.02157240e+03  6.63788438e+03
  6.63788438e+03  6.63788438e+03  9.20583651e+03  2.55542571e+04
  7.62857776e+04]
E1 = -728.4297783514044  E_coul = 201.6843294858243
cycle= 2 E= -526.74544886558  delta_E= -0.000715  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.074733
diis-c [-0.00327839  0.08226659  0.91773341]
  HOMO = -0.581654919678129  LUMO = 1.00620296194416
  mo_energy =
[-1.18570891e+02 -1.23043370e+01 -9.55511578e+00 -9.55511578e+00
 -9.55511578e+00 -1.26861951e+00 -5.81654920e-01 -5.81654920e-01
 -5.81654920e-01  1.00620296e+00  1.00620296e+00  1.00620296e+00
  1.03678023e+00  7.14721875e+00  7.14721875e+00  7.14721875e+00
  1.35106425e+01  3.29282891e+01  3.29282891e+01  3.29282891e+01
  1.21309302e+02  1.29595323e+02  1.29595323e+02  1.29595323e+02
  4.85083120e+02  4.85083120e+02  4.85083120e+02  6.55414981e+02
  1.33325409e+03  1.33325409e+03  1.33325409e+03  2.78798559e+03
  3.02164540e+03  3.02164540e+03  3.02164540e+03  6.63795915e+03
  6.63795915e+03  6.63795915e+03  9.20591209e+03  2.55543333e+04
  7.62858541e+04]
E1 = -728.2792744685167  E_coul = 201.53376675545962
cycle= 3 E= -526.745507713057  delta_E= -5.88e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131342
diis-c [-5.43638312e-07 -1.22279270e-03  1.45131960e-01  8.56090833e-01]
  HOMO = -0.583159195021486  LUMO = 1.0051281125686
  mo_energy =
[-1.18580869e+02 -1.23101629e+01 -9.56128586e+00 -9.56128586e+00
 -9.56128586e+00 -1.27032191e+00 -5.83159195e-01 -5.83159195e-01
 -5.83159195e-01  1.00512811e+00  1.00512811e+00  1.00512811e+00
  1.03548187e+00  7.14346879e+00  7.14346879e+00  7.14346879e+00
  1.35058408e+01  3.29221132e+01  3.29221132e+01  3.29221132e+01
  1.21300799e+02  1.29586929e+02  1.29586929e+02  1.29586929e+02
  4.85073259e+02  4.85073259e+02  4.85073259e+02  6.55404692e+02
  1.33324364e+03  1.33324364e+03  1.33324364e+03  2.78797451e+03
  3.02163457e+03  3.02163457e+03  3.02163457e+03  6.63794793e+03
  6.63794793e+03  6.63794793e+03  9.20590066e+03  2.55543217e+04
  7.62858423e+04]
E1 = -728.3021919197781  E_coul = 201.5566822707828
cycle= 4 E= -526.745509648995  delta_E= -1.94e-06  |g|= 9.37e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107284
diis-c [-3.94018097e-09  6.65967483e-05 -9.67439108e-03 -6.25333751e-02
  1.07214117e+00]
  HOMO = -0.58314042877455  LUMO = 1.00514393199779
  mo_energy =
[-1.18580827e+02 -1.23100979e+01 -9.56123378e+00 -9.56123378e+00
 -9.56123378e+00 -1.27028161e+00 -5.83140429e-01 -5.83140429e-01
 -5.83140429e-01  1.00514393e+00  1.00514393e+00  1.00514393e+00
  1.03551600e+00  7.14351078e+00  7.14351078e+00  7.14351078e+00
  1.35059008e+01  3.29221631e+01  3.29221631e+01  3.29221631e+01
  1.21300850e+02  1.29586978e+02  1.29586978e+02  1.29586978e+02
  4.85073301e+02  4.85073301e+02  4.85073301e+02  6.55404726e+02
  1.33324367e+03  1.33324367e+03  1.33324367e+03  2.78797452e+03
  3.02163459e+03  3.02163459e+03  3.02163459e+03  6.63794794e+03
  6.63794794e+03  6.63794794e+03  9.20590066e+03  2.55543217e+04
  7.62858423e+04]
E1 = -728.3019793242635  E_coul = 201.5564696737581
cycle= 5 E= -526.745509650505  delta_E= -1.51e-09  |g|= 2.02e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83451e-05
diis-c [-6.71016962e-11  1.42007594e-05 -1.86793506e-03 -1.38948681e-02
  4.29258092e-02  9.72822793e-01]
  HOMO = -0.583147633956682  LUMO = 1.00513920285322
  mo_energy =
[-1.18580857e+02 -1.23101199e+01 -9.56125762e+00 -9.56125762e+00
 -9.56125762e+00 -1.27028738e+00 -5.83147634e-01 -5.83147634e-01
 -5.83147634e-01  1.00513920e+00  1.00513920e+00  1.00513920e+00
  1.03551202e+00  7.14349480e+00  7.14349480e+00  7.14349480e+00
  1.35058826e+01  3.29221400e+01  3.29221400e+01  3.29221400e+01
  1.21300823e+02  1.29586951e+02  1.29586951e+02  1.29586951e+02
  4.85073271e+02  4.85073271e+02  4.85073271e+02  6.55404695e+02
  1.33324364e+03  1.33324364e+03  1.33324364e+03  2.78797449e+03
  3.02163456e+03  3.02163456e+03  3.02163456e+03  6.63794790e+03
  6.63794790e+03  6.63794790e+03  9.20590063e+03  2.55543216e+04
  7.62858423e+04]
E1 = -728.3020594139176  E_coul = 201.55654976335742
cycle= 6 E= -526.74550965056  delta_E= -5.48e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3020594139176  E_coul = 201.55654976335742
  HOMO = -0.583147669306159  LUMO = 1.0051392324234
  mo_energy =
[-1.18580857e+02 -1.23101198e+01 -9.56125765e+00 -9.56125765e+00
 -9.56125765e+00 -1.27028704e+00 -5.83147669e-01 -5.83147669e-01
 -5.83147669e-01  1.00513923e+00  1.00513923e+00  1.00513923e+00
  1.03551233e+00  7.14349480e+00  7.14349480e+00  7.14349480e+00
  1.35058827e+01  3.29221400e+01  3.29221400e+01  3.29221400e+01
  1.21300823e+02  1.29586951e+02  1.29586951e+02  1.29586951e+02
  4.85073271e+02  4.85073271e+02  4.85073271e+02  6.55404695e+02
  1.33324364e+03  1.33324364e+03  1.33324364e+03  2.78797449e+03
  3.02163456e+03  3.02163456e+03  3.02163456e+03  6.63794790e+03
  6.63794790e+03  6.63794790e+03  9.20590063e+03  2.55543216e+04
  7.62858423e+04]
E1 = -728.3020587853431  E_coul = 201.55654913478156
Extra cycle  E= -526.745509650562  delta_E= -1.36e-12  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828052e+04 7.61716985e+03 3.61748237e+03 1.58992647e+03
 4.11549096e+02 1.21009542e+02 3.91998284e+01 8.49701467e+00
 3.34792168e+00 6.73766768e-01 2.49281469e-01 1.36283241e+03
 6.64265860e+02 2.98700956e+02 3.12093380e+02 6.30022269e+01
 7.21917684e+00 2.02201584e+01 7.70288631e-01 2.76187547e+00
 2.21542827e-01]
E = -526.7455096505615
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8051926        1
[INPUT] 0    0    [1    /1   ]  7617.16984886        1
[INPUT] 0    0    [1    /1   ]  3617.48236748        1
[INPUT] 0    0    [1    /1   ]  1589.92646706        1
[INPUT] 0    0    [1    /1   ]  411.549096304        1
[INPUT] 0    0    [1    /1   ]  121.009542186        1
[INPUT] 0    0    [1    /1   ]  39.1998283932        1
[INPUT] 0    0    [1    /1   ]  8.49701466552        1
[INPUT] 0    0    [1    /1   ]  3.34792168318        1
[INPUT] 0    0    [1    /1   ]  0.673766768103       1
[INPUT] 0    0    [1    /1   ]  0.249281468887       1
[INPUT] 1    0    [1    /1   ]  1362.83241364        1
[INPUT] 1    0    [1    /1   ]  664.265859931        1
[INPUT] 1    0    [1    /1   ]  298.700955876        1
[INPUT] 1    0    [1    /1   ]  312.093380464        1
[INPUT] 1    0    [1    /1   ]  63.0022269102        1
[INPUT] 1    0    [1    /1   ]  7.21917684246        1
[INPUT] 1    0    [1    /1   ]  20.2201584419        1
[INPUT] 1    0    [1    /1   ]  0.770288631291       1
[INPUT] 1    0    [1    /1   ]  2.76187546563        1
[INPUT] 1    0    [1    /1   ]  0.221542827295       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.8051925798, 1.0]], [0, [7617.169848858578, 1.0]], [0, [3617.482367483591, 1.0]], [0, [1589.9264670633572, 1.0]], [0, [411.5490963037592, 1.0]], [0, [121.009542185575, 1.0]], [0, [39.19982839315249, 1.0]], [0, [8.49701466551907, 1.0]], [0, [3.3479216831821814, 1.0]], [0, [0.6737667681031125, 1.0]], [0, [0.24928146888660058, 1.0]], [1, [1362.832413638474, 1.0]], [1, [664.2658599305817, 1.0]], [1, [298.70095587623484, 1.0]], [1, [312.0933804642407, 1.0]], [1, [63.00222691017767, 1.0]], [1, [7.219176842463761, 1.0]], [1, [20.220158441932277, 1.0]], [1, [0.7702886312910119, 1.0]], [1, [2.761875465629876, 1.0]], [1, [0.22154282729492714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80519258]
bas 1, expnt(s) = [7617.16984886]
bas 2, expnt(s) = [3617.48236748]
bas 3, expnt(s) = [1589.92646706]
bas 4, expnt(s) = [411.5490963]
bas 5, expnt(s) = [121.00954219]
bas 6, expnt(s) = [39.19982839]
bas 7, expnt(s) = [8.49701467]
bas 8, expnt(s) = [3.34792168]
bas 9, expnt(s) = [0.67376677]
bas 10, expnt(s) = [0.24928147]
bas 11, expnt(s) = [1362.83241364]
bas 12, expnt(s) = [664.26585993]
bas 13, expnt(s) = [298.70095588]
bas 14, expnt(s) = [312.09338046]
bas 15, expnt(s) = [63.00222691]
bas 16, expnt(s) = [7.21917684]
bas 17, expnt(s) = [20.22015844]
bas 18, expnt(s) = [0.77028863]
bas 19, expnt(s) = [2.76187547]
bas 20, expnt(s) = [0.22154283]
CPU time:       427.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828052e+04 5.20028511e+03 7.61716985e+03 2.05996696e+03
 3.61748237e+03 1.17847356e+03 1.58992647e+03 6.36132821e+02
 4.11549096e+02 2.30850736e+02 1.21009542e+02 9.21785214e+01
 3.91998284e+01 3.95802150e+01 8.49701467e+00 1.25737494e+01
 3.34792168e+00 6.25311609e+00 6.73766768e-01 1.87887209e+00
 2.49281469e-01 8.91317679e-01 1.36283241e+03 2.41566919e+04
 6.64265860e+02 9.83811303e+03 2.98700956e+02 3.62268154e+03
 3.12093380e+02 3.82683810e+03 6.30022269e+01 5.17820534e+02
 7.21917684e+00 3.45218446e+01 2.02201584e+01 1.25087838e+02
 7.70288631e-01 2.10523825e+00 2.76187547e+00 1.03869851e+01
 2.21542827e-01 4.43411048e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993667542122438
cond(S) = 98499.16618644401
E1 = -729.5328407283915  E_coul = 203.1795254309701
init E= -526.353315297421
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555842496977086  LUMO = 1.02363602545812
  mo_energy =
[-1.18331804e+02 -1.22047957e+01 -9.44663597e+00 -9.44663597e+00
 -9.44663597e+00 -1.23994551e+00 -5.55842497e-01 -5.55842497e-01
 -5.55842497e-01  1.02363603e+00  1.02363603e+00  1.02363603e+00
  1.05794243e+00  7.21351316e+00  7.21351316e+00  7.21351316e+00
  1.35933338e+01  3.30417203e+01  3.30417203e+01  3.30417203e+01
  1.21480485e+02  1.29768103e+02  1.29768103e+02  1.29768103e+02
  4.85321511e+02  4.85321511e+02  4.85321511e+02  6.55695957e+02
  1.33354382e+03  1.33354382e+03  1.33354382e+03  2.78840596e+03
  3.02199820e+03  3.02199820e+03  3.02199820e+03  6.63842209e+03
  6.63842209e+03  6.63842209e+03  9.20644778e+03  2.55549621e+04
  7.62865723e+04]
E1 = -727.856384350042  E_coul = 201.11165041467308
cycle= 1 E= -526.744733935369  delta_E= -0.391  |g|= 0.185  |ddm|= 0.303
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538825
diis-c [-0.29033191  1.        ]
  HOMO = -0.590775160282405  LUMO = 0.999545251493336
  mo_energy =
[-1.18638452e+02 -1.23423565e+01 -9.59478932e+00 -9.59478932e+00
 -9.59478932e+00 -1.27953350e+00 -5.90775160e-01 -5.90775160e-01
 -5.90775160e-01  9.99545251e-01  9.99545251e-01  9.99545251e-01
  1.02833745e+00  7.12373010e+00  7.12373010e+00  7.12373010e+00
  1.34794632e+01  3.28883329e+01  3.28883329e+01  3.28883329e+01
  1.21252160e+02  1.29539326e+02  1.29539326e+02  1.29539326e+02
  4.85016373e+02  4.85016373e+02  4.85016373e+02  6.55345386e+02
  1.33318333e+03  1.33318333e+03  1.33318333e+03  2.78791146e+03
  3.02157240e+03  3.02157240e+03  3.02157240e+03  6.63788438e+03
  6.63788438e+03  6.63788438e+03  9.20583651e+03  2.55542571e+04
  7.62857776e+04]
E1 = -728.4297783514044  E_coul = 201.6843294858243
cycle= 2 E= -526.74544886558  delta_E= -0.000715  |g|= 0.0375  |ddm|= 0.0539
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.074733
diis-c [-0.00327839  0.08226659  0.91773341]
  HOMO = -0.581654919678129  LUMO = 1.00620296194416
  mo_energy =
[-1.18570891e+02 -1.23043370e+01 -9.55511578e+00 -9.55511578e+00
 -9.55511578e+00 -1.26861951e+00 -5.81654920e-01 -5.81654920e-01
 -5.81654920e-01  1.00620296e+00  1.00620296e+00  1.00620296e+00
  1.03678023e+00  7.14721875e+00  7.14721875e+00  7.14721875e+00
  1.35106425e+01  3.29282891e+01  3.29282891e+01  3.29282891e+01
  1.21309302e+02  1.29595323e+02  1.29595323e+02  1.29595323e+02
  4.85083120e+02  4.85083120e+02  4.85083120e+02  6.55414981e+02
  1.33325409e+03  1.33325409e+03  1.33325409e+03  2.78798559e+03
  3.02164540e+03  3.02164540e+03  3.02164540e+03  6.63795915e+03
  6.63795915e+03  6.63795915e+03  9.20591209e+03  2.55543333e+04
  7.62858541e+04]
E1 = -728.2792744685167  E_coul = 201.53376675545962
cycle= 3 E= -526.745507713057  delta_E= -5.88e-05  |g|= 0.0063  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131342
diis-c [-5.43638312e-07 -1.22279270e-03  1.45131960e-01  8.56090833e-01]
  HOMO = -0.583159195021486  LUMO = 1.0051281125686
  mo_energy =
[-1.18580869e+02 -1.23101629e+01 -9.56128586e+00 -9.56128586e+00
 -9.56128586e+00 -1.27032191e+00 -5.83159195e-01 -5.83159195e-01
 -5.83159195e-01  1.00512811e+00  1.00512811e+00  1.00512811e+00
  1.03548187e+00  7.14346879e+00  7.14346879e+00  7.14346879e+00
  1.35058408e+01  3.29221132e+01  3.29221132e+01  3.29221132e+01
  1.21300799e+02  1.29586929e+02  1.29586929e+02  1.29586929e+02
  4.85073259e+02  4.85073259e+02  4.85073259e+02  6.55404692e+02
  1.33324364e+03  1.33324364e+03  1.33324364e+03  2.78797451e+03
  3.02163457e+03  3.02163457e+03  3.02163457e+03  6.63794793e+03
  6.63794793e+03  6.63794793e+03  9.20590066e+03  2.55543217e+04
  7.62858423e+04]
E1 = -728.3021919197781  E_coul = 201.5566822707828
cycle= 4 E= -526.745509648995  delta_E= -1.94e-06  |g|= 9.37e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107284
diis-c [-3.94018097e-09  6.65967483e-05 -9.67439108e-03 -6.25333751e-02
  1.07214117e+00]
  HOMO = -0.58314042877455  LUMO = 1.00514393199779
  mo_energy =
[-1.18580827e+02 -1.23100979e+01 -9.56123378e+00 -9.56123378e+00
 -9.56123378e+00 -1.27028161e+00 -5.83140429e-01 -5.83140429e-01
 -5.83140429e-01  1.00514393e+00  1.00514393e+00  1.00514393e+00
  1.03551600e+00  7.14351078e+00  7.14351078e+00  7.14351078e+00
  1.35059008e+01  3.29221631e+01  3.29221631e+01  3.29221631e+01
  1.21300850e+02  1.29586978e+02  1.29586978e+02  1.29586978e+02
  4.85073301e+02  4.85073301e+02  4.85073301e+02  6.55404726e+02
  1.33324367e+03  1.33324367e+03  1.33324367e+03  2.78797452e+03
  3.02163459e+03  3.02163459e+03  3.02163459e+03  6.63794794e+03
  6.63794794e+03  6.63794794e+03  9.20590066e+03  2.55543217e+04
  7.62858423e+04]
E1 = -728.3019793242635  E_coul = 201.5564696737581
cycle= 5 E= -526.745509650505  delta_E= -1.51e-09  |g|= 2.02e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.83451e-05
diis-c [-6.71016962e-11  1.42007594e-05 -1.86793506e-03 -1.38948681e-02
  4.29258092e-02  9.72822793e-01]
  HOMO = -0.583147633956682  LUMO = 1.00513920285322
  mo_energy =
[-1.18580857e+02 -1.23101199e+01 -9.56125762e+00 -9.56125762e+00
 -9.56125762e+00 -1.27028738e+00 -5.83147634e-01 -5.83147634e-01
 -5.83147634e-01  1.00513920e+00  1.00513920e+00  1.00513920e+00
  1.03551202e+00  7.14349480e+00  7.14349480e+00  7.14349480e+00
  1.35058826e+01  3.29221400e+01  3.29221400e+01  3.29221400e+01
  1.21300823e+02  1.29586951e+02  1.29586951e+02  1.29586951e+02
  4.85073271e+02  4.85073271e+02  4.85073271e+02  6.55404695e+02
  1.33324364e+03  1.33324364e+03  1.33324364e+03  2.78797449e+03
  3.02163456e+03  3.02163456e+03  3.02163456e+03  6.63794790e+03
  6.63794790e+03  6.63794790e+03  9.20590063e+03  2.55543216e+04
  7.62858423e+04]
E1 = -728.3020594139176  E_coul = 201.55654976335742
cycle= 6 E= -526.74550965056  delta_E= -5.48e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3020594139176  E_coul = 201.55654976335742
  HOMO = -0.583147669306159  LUMO = 1.0051392324234
  mo_energy =
[-1.18580857e+02 -1.23101198e+01 -9.56125765e+00 -9.56125765e+00
 -9.56125765e+00 -1.27028704e+00 -5.83147669e-01 -5.83147669e-01
 -5.83147669e-01  1.00513923e+00  1.00513923e+00  1.00513923e+00
  1.03551233e+00  7.14349480e+00  7.14349480e+00  7.14349480e+00
  1.35058827e+01  3.29221400e+01  3.29221400e+01  3.29221400e+01
  1.21300823e+02  1.29586951e+02  1.29586951e+02  1.29586951e+02
  4.85073271e+02  4.85073271e+02  4.85073271e+02  6.55404695e+02
  1.33324364e+03  1.33324364e+03  1.33324364e+03  2.78797449e+03
  3.02163456e+03  3.02163456e+03  3.02163456e+03  6.63794790e+03
  6.63794790e+03  6.63794790e+03  9.20590063e+03  2.55543216e+04
  7.62858423e+04]
E1 = -728.3020587853431  E_coul = 201.55654913478156
Extra cycle  E= -526.745509650562  delta_E= -1.36e-12  |g|= 3.47e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98499.16618644401
E1 = -728.3020587853431  E_coul = 201.55654913478156
init E= -526.745509650562
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.583147691791587  LUMO = 1.00513922801242
  mo_energy =
[-1.18580857e+02 -1.23101198e+01 -9.56125771e+00 -9.56125771e+00
 -9.56125771e+00 -1.27028699e+00 -5.83147692e-01 -5.83147692e-01
 -5.83147692e-01  1.00513923e+00  1.00513923e+00  1.00513923e+00
  1.03551239e+00  7.14349476e+00  7.14349476e+00  7.14349476e+00
  1.35058827e+01  3.29221400e+01  3.29221400e+01  3.29221400e+01
  1.21300823e+02  1.29586951e+02  1.29586951e+02  1.29586951e+02
  4.85073271e+02  4.85073271e+02  4.85073271e+02  6.55404695e+02
  1.33324364e+03  1.33324364e+03  1.33324364e+03  2.78797449e+03
  3.02163456e+03  3.02163456e+03  3.02163456e+03  6.63794790e+03
  6.63794790e+03  6.63794790e+03  9.20590063e+03  2.55543216e+04
  7.62858423e+04]
E1 = -728.3020588670626  E_coul = 201.55654921650225
cycle= 1 E= -526.74550965056  delta_E= 1.25e-12  |g|= 7.16e-08  |ddm|= 5.77e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3020588670626  E_coul = 201.55654921650225
  HOMO = -0.583147692475232  LUMO = 1.00513922988669
  mo_energy =
[-1.18580857e+02 -1.23101198e+01 -9.56125771e+00 -9.56125771e+00
 -9.56125771e+00 -1.27028698e+00 -5.83147692e-01 -5.83147692e-01
 -5.83147692e-01  1.00513923e+00  1.00513923e+00  1.00513923e+00
  1.03551240e+00  7.14349477e+00  7.14349477e+00  7.14349477e+00
  1.35058827e+01  3.29221400e+01  3.29221400e+01  3.29221400e+01
  1.21300823e+02  1.29586951e+02  1.29586951e+02  1.29586951e+02
  4.85073271e+02  4.85073271e+02  4.85073271e+02  6.55404695e+02
  1.33324364e+03  1.33324364e+03  1.33324364e+03  2.78797449e+03
  3.02163456e+03  3.02163456e+03  3.02163456e+03  6.63794790e+03
  6.63794790e+03  6.63794790e+03  9.20590063e+03  2.55543216e+04
  7.62858423e+04]
E1 = -728.3020588243755  E_coul = 201.5565491738144
Extra cycle  E= -526.745509650561  delta_E= -9.09e-13  |g|= 1.44e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.38 sec
exp = [2.61828052e+04 7.61716985e+03 3.61748237e+03 1.58992647e+03
 4.11549096e+02 1.21009542e+02 3.91998284e+01 8.49701467e+00
 3.34792168e+00 6.73766768e-01 2.49281469e-01 1.36283241e+03
 6.64265860e+02 2.98700956e+02 3.12093380e+02 6.30022269e+01
 7.21917684e+00 2.02201584e+01 7.70288631e-01 2.76187547e+00
 2.21542827e-01]
grad_E = [-1.42913379e-06  2.42948790e-06 -2.11888974e-06  4.51893109e-05
 -6.49511439e-05  7.91519437e-05  3.70543941e-05  1.87062290e-04
 -4.06462123e-04  2.68731484e-04 -1.87168338e-04 -6.21457161e-07
  3.37750897e-06  1.44606470e-05  1.23815693e-05  4.44385885e-04
 -1.18914592e-03 -8.48585353e-04  6.97639553e-04  5.97148617e-04
 -1.98892611e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8039173        1
[INPUT] 0    0    [1    /1   ]  7617.1729947         1
[INPUT] 0    0    [1    /1   ]  3617.4813656         1
[INPUT] 0    0    [1    /1   ]  1589.9989069         1
[INPUT] 0    0    [1    /1   ]  411.226572654        1
[INPUT] 0    0    [1    /1   ]  121.069020275        1
[INPUT] 0    0    [1    /1   ]  39.2414856052        1
[INPUT] 0    0    [1    /1   ]  8.5244020363         1
[INPUT] 0    0    [1    /1   ]  3.35397708102        1
[INPUT] 0    0    [1    /1   ]  0.674133497199       1
[INPUT] 0    0    [1    /1   ]  0.249447463859       1
[INPUT] 1    0    [1    /1   ]  1362.8320093         1
[INPUT] 1    0    [1    /1   ]  664.270059019        1
[INPUT] 1    0    [1    /1   ]  298.720891668        1
[INPUT] 1    0    [1    /1   ]  312.110569184        1
[INPUT] 1    0    [1    /1   ]  62.9400164338        1
[INPUT] 1    0    [1    /1   ]  7.2845310001         1
[INPUT] 1    0    [1    /1   ]  20.3328852369        1
[INPUT] 1    0    [1    /1   ]  0.773603491446       1
[INPUT] 1    0    [1    /1   ]  2.79138938717        1
[INPUT] 1    0    [1    /1   ]  0.222191642789       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.80391725308, 1.0]], [0, [7617.172994703476, 1.0]], [0, [3617.481365604138, 1.0]], [0, [1589.998906896554, 1.0]], [0, [411.22657265437954, 1.0]], [0, [121.0690202751658, 1.0]], [0, [39.241485605214095, 1.0]], [0, [8.524402036298254, 1.0]], [0, [3.353977081015341, 1.0]], [0, [0.6741334971987153, 1.0]], [0, [0.2494474638590514, 1.0]], [1, [1362.8320093034845, 1.0]], [1, [664.2700590190542, 1.0]], [1, [298.7208916675381, 1.0]], [1, [312.1105691836453, 1.0]], [1, [62.94001643378111, 1.0]], [1, [7.28453100009999, 1.0]], [1, [20.332885236902015, 1.0]], [1, [0.7736034914463691, 1.0]], [1, [2.791389387167868, 1.0]], [1, [0.2221916427892722, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80391725]
bas 1, expnt(s) = [7617.1729947]
bas 2, expnt(s) = [3617.4813656]
bas 3, expnt(s) = [1589.9989069]
bas 4, expnt(s) = [411.22657265]
bas 5, expnt(s) = [121.06902028]
bas 6, expnt(s) = [39.24148561]
bas 7, expnt(s) = [8.52440204]
bas 8, expnt(s) = [3.35397708]
bas 9, expnt(s) = [0.6741335]
bas 10, expnt(s) = [0.24944746]
bas 11, expnt(s) = [1362.8320093]
bas 12, expnt(s) = [664.27005902]
bas 13, expnt(s) = [298.72089167]
bas 14, expnt(s) = [312.11056918]
bas 15, expnt(s) = [62.94001643]
bas 16, expnt(s) = [7.284531]
bas 17, expnt(s) = [20.33288524]
bas 18, expnt(s) = [0.77360349]
bas 19, expnt(s) = [2.79138939]
bas 20, expnt(s) = [0.22219164]
CPU time:       433.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828039e+04 5.20028492e+03 7.61717299e+03 2.05996759e+03
 3.61748137e+03 1.17847331e+03 1.58999891e+03 6.36154558e+02
 4.11226573e+02 2.30715038e+02 1.21069020e+02 9.22124997e+01
 3.92414856e+01 3.96117569e+01 8.52440204e+00 1.26041327e+01
 3.35397708e+00 6.26159670e+00 6.74133497e-01 1.87963903e+00
 2.49447464e-01 8.91762784e-01 1.36283201e+03 2.41566829e+04
 6.64270059e+02 9.83819077e+03 2.98720892e+02 3.62298377e+03
 3.12110569e+02 3.82710156e+03 6.29400164e+01 5.17181472e+02
 7.28453100e+00 3.49129372e+01 2.03328852e+01 1.25960146e+02
 7.73603491e-01 2.11656894e+00 2.79138939e+00 1.05259165e+01
 2.22191643e-01 4.45034872e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99355337513819
cond(S) = 98673.91622285875
E1 = -729.5334765222348  E_coul = 203.17990518931512
init E= -526.35357133292
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555815044954857  LUMO = 1.02912516160758
  mo_energy =
[-1.18331772e+02 -1.22047299e+01 -9.44665243e+00 -9.44665243e+00
 -9.44665243e+00 -1.23994086e+00 -5.55815045e-01 -5.55815045e-01
 -5.55815045e-01  1.02912516e+00  1.02912516e+00  1.02912516e+00
  1.05928253e+00  7.29588852e+00  7.29588852e+00  7.29588852e+00
  1.36450035e+01  3.33898029e+01  3.33898029e+01  3.33898029e+01
  1.21725545e+02  1.30355761e+02  1.30355761e+02  1.30355761e+02
  4.85818927e+02  4.85818927e+02  4.85818927e+02  6.55907235e+02
  1.33399277e+03  1.33399277e+03  1.33399277e+03  2.78809634e+03
  3.02245661e+03  3.02245661e+03  3.02245661e+03  6.63887810e+03
  6.63887810e+03  6.63887810e+03  9.20594080e+03  2.55544668e+04
  7.62861204e+04]
E1 = -727.859576525001  E_coul = 201.11472483743248
cycle= 1 E= -526.744851687568  delta_E= -0.391  |g|= 0.185  |ddm|= 0.304
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538964
diis-c [-0.29048177  1.        ]
  HOMO = -0.590671971422063  LUMO = 1.00494224923556
  mo_energy =
[-1.18638033e+02 -1.23421252e+01 -9.59464785e+00 -9.59464785e+00
 -9.59464785e+00 -1.27943783e+00 -5.90671971e-01 -5.90671971e-01
 -5.90671971e-01  1.00494225e+00  1.00494225e+00  1.00494225e+00
  1.02972967e+00  7.20565120e+00  7.20565120e+00  7.20565120e+00
  1.35311063e+01  3.32361843e+01  3.32361843e+01  3.32361843e+01
  1.21497387e+02  1.30127321e+02  1.30127321e+02  1.30127321e+02
  4.85514213e+02  4.85514213e+02  4.85514213e+02  6.55557108e+02
  1.33363272e+03  1.33363272e+03  1.33363272e+03  2.78760233e+03
  3.02203126e+03  3.02203126e+03  3.02203126e+03  6.63834087e+03
  6.63834087e+03  6.63834087e+03  9.20533000e+03  2.55537624e+04
  7.62853262e+04]
E1 = -728.4317735137532  E_coul = 201.6862088255694
cycle= 2 E= -526.745564688184  delta_E= -0.000713  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747015
diis-c [-0.00327657  0.08219962  0.91780038]
  HOMO = -0.581574650337938  LUMO = 1.01162543977424
  mo_energy =
[-1.18570589e+02 -1.23041823e+01 -9.55505475e+00 -9.55505475e+00
 -9.55505475e+00 -1.26855049e+00 -5.81574650e-01 -5.81574650e-01
 -5.81574650e-01  1.01162544e+00  1.01162544e+00  1.01162544e+00
  1.03816154e+00  7.22924038e+00  7.22924038e+00  7.22924038e+00
  1.35622713e+01  3.32761621e+01  3.32761621e+01  3.32761621e+01
  1.21554438e+02  1.30183212e+02  1.30183212e+02  1.30183212e+02
  4.85580836e+02  4.85580836e+02  4.85580836e+02  6.55626581e+02
  1.33370335e+03  1.33370335e+03  1.33370335e+03  2.78767633e+03
  3.02210414e+03  3.02210414e+03  3.02210414e+03  6.63841550e+03
  6.63841550e+03  6.63841550e+03  9.20540546e+03  2.55538384e+04
  7.62854025e+04]
E1 = -728.2816916104824  E_coul = 201.53606833741767
cycle= 3 E= -526.745623273065  delta_E= -5.86e-05  |g|= 0.00628  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131241
diis-c [-5.43867388e-07 -1.22216545e-03  1.45086843e-01  8.56135322e-01]
  HOMO = -0.583074081012763  LUMO = 1.01054731189017
  mo_energy =
[-1.18580543e+02 -1.23099921e+01 -9.56120856e+00 -9.56120856e+00
 -9.56120856e+00 -1.27024701e+00 -5.83074081e-01 -5.83074081e-01
 -5.83074081e-01  1.01054731e+00  1.01054731e+00  1.01054731e+00
  1.03686636e+00  7.22547774e+00  7.22547774e+00  7.22547774e+00
  1.35574760e+01  3.32699879e+01  3.32699879e+01  3.32699879e+01
  1.21545953e+02  1.30174839e+02  1.30174839e+02  1.30174839e+02
  4.85570999e+02  4.85570999e+02  4.85570999e+02  6.55616316e+02
  1.33369292e+03  1.33369292e+03  1.33369292e+03  2.78766527e+03
  3.02209334e+03  3.02209334e+03  3.02209334e+03  6.63840431e+03
  6.63840431e+03  6.63840431e+03  9.20539405e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.304528912247  E_coul = 201.55890371449408
cycle= 4 E= -526.745625197753  delta_E= -1.92e-06  |g|= 9.39e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010818
diis-c [-3.91689484e-09  6.73920968e-05 -9.77078745e-03 -6.32253428e-02
  1.07292874e+00]
  HOMO = -0.583055547434552  LUMO = 1.01056305275412
  mo_energy =
[-1.18580503e+02 -1.23099278e+01 -9.56115722e+00 -9.56115722e+00
 -9.56115722e+00 -1.27020693e+00 -5.83055547e-01 -5.83055547e-01
 -5.83055547e-01  1.01056305e+00  1.01056305e+00  1.01056305e+00
  1.03690036e+00  7.22551937e+00  7.22551937e+00  7.22551937e+00
  1.35575354e+01  3.32700372e+01  3.32700372e+01  3.32700372e+01
  1.21546004e+02  1.30174887e+02  1.30174887e+02  1.30174887e+02
  4.85571040e+02  4.85571040e+02  4.85571040e+02  6.55616348e+02
  1.33369296e+03  1.33369296e+03  1.33369296e+03  2.78766529e+03
  3.02209336e+03  3.02209336e+03  3.02209336e+03  6.63840432e+03
  6.63840432e+03  6.63840432e+03  9.20539405e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.3043187696982  E_coul = 201.5586935704284
cycle= 5 E= -526.74562519927  delta_E= -1.52e-09  |g|= 2.01e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8252e-05
diis-c [-6.72648364e-11  1.41438176e-05 -1.86130774e-03 -1.38597611e-02
  4.30945234e-02  9.72612402e-01]
  HOMO = -0.583062741603936  LUMO = 1.0105582997202
  mo_energy =
[-1.18580533e+02 -1.23099498e+01 -9.56118102e+00 -9.56118102e+00
 -9.56118102e+00 -1.27021269e+00 -5.83062742e-01 -5.83062742e-01
 -5.83062742e-01  1.01055830e+00  1.01055830e+00  1.01055830e+00
  1.03689638e+00  7.22550332e+00  7.22550332e+00  7.22550332e+00
  1.35575172e+01  3.32700141e+01  3.32700141e+01  3.32700141e+01
  1.21545977e+02  1.30174860e+02  1.30174860e+02  1.30174860e+02
  4.85571010e+02  4.85571010e+02  4.85571010e+02  6.55616318e+02
  1.33369293e+03  1.33369293e+03  1.33369293e+03  2.78766525e+03
  3.02209333e+03  3.02209333e+03  3.02209333e+03  6.63840428e+03
  6.63840428e+03  6.63840428e+03  9.20539402e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.304398596679  E_coul = 201.5587733973546
cycle= 6 E= -526.745625199324  delta_E= -5.47e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.304398596679  E_coul = 201.5587733973546
  HOMO = -0.583062774039867  LUMO = 1.01055833118642
  mo_energy =
[-1.18580532e+02 -1.23099497e+01 -9.56118103e+00 -9.56118103e+00
 -9.56118103e+00 -1.27021235e+00 -5.83062774e-01 -5.83062774e-01
 -5.83062774e-01  1.01055833e+00  1.01055833e+00  1.01055833e+00
  1.03689670e+00  7.22550333e+00  7.22550333e+00  7.22550333e+00
  1.35575174e+01  3.32700141e+01  3.32700141e+01  3.32700141e+01
  1.21545977e+02  1.30174860e+02  1.30174860e+02  1.30174860e+02
  4.85571010e+02  4.85571010e+02  4.85571010e+02  6.55616318e+02
  1.33369293e+03  1.33369293e+03  1.33369293e+03  2.78766525e+03
  3.02209333e+03  3.02209333e+03  3.02209333e+03  6.63840428e+03
  6.63840428e+03  6.63840428e+03  9.20539402e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.3043979159512  E_coul = 201.55877271662524
Extra cycle  E= -526.745625199326  delta_E= -1.59e-12  |g|= 3.46e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
exp = [2.61828039e+04 7.61717299e+03 3.61748137e+03 1.58999891e+03
 4.11226573e+02 1.21069020e+02 3.92414856e+01 8.52440204e+00
 3.35397708e+00 6.74133497e-01 2.49447464e-01 1.36283201e+03
 6.64270059e+02 2.98720892e+02 3.12110569e+02 6.29400164e+01
 7.28453100e+00 2.03328852e+01 7.73603491e-01 2.79138939e+00
 2.22191643e-01]
E = -526.745625199326
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8039173        1
[INPUT] 0    0    [1    /1   ]  7617.1729947         1
[INPUT] 0    0    [1    /1   ]  3617.4813656         1
[INPUT] 0    0    [1    /1   ]  1589.9989069         1
[INPUT] 0    0    [1    /1   ]  411.226572654        1
[INPUT] 0    0    [1    /1   ]  121.069020275        1
[INPUT] 0    0    [1    /1   ]  39.2414856052        1
[INPUT] 0    0    [1    /1   ]  8.5244020363         1
[INPUT] 0    0    [1    /1   ]  3.35397708102        1
[INPUT] 0    0    [1    /1   ]  0.674133497199       1
[INPUT] 0    0    [1    /1   ]  0.249447463859       1
[INPUT] 1    0    [1    /1   ]  1362.8320093         1
[INPUT] 1    0    [1    /1   ]  664.270059019        1
[INPUT] 1    0    [1    /1   ]  298.720891668        1
[INPUT] 1    0    [1    /1   ]  312.110569184        1
[INPUT] 1    0    [1    /1   ]  62.9400164338        1
[INPUT] 1    0    [1    /1   ]  7.2845310001         1
[INPUT] 1    0    [1    /1   ]  20.3328852369        1
[INPUT] 1    0    [1    /1   ]  0.773603491446       1
[INPUT] 1    0    [1    /1   ]  2.79138938717        1
[INPUT] 1    0    [1    /1   ]  0.222191642789       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.80391725308, 1.0]], [0, [7617.172994703476, 1.0]], [0, [3617.481365604138, 1.0]], [0, [1589.998906896554, 1.0]], [0, [411.22657265437954, 1.0]], [0, [121.0690202751658, 1.0]], [0, [39.241485605214095, 1.0]], [0, [8.524402036298254, 1.0]], [0, [3.353977081015341, 1.0]], [0, [0.6741334971987153, 1.0]], [0, [0.2494474638590514, 1.0]], [1, [1362.8320093034845, 1.0]], [1, [664.2700590190542, 1.0]], [1, [298.7208916675381, 1.0]], [1, [312.1105691836453, 1.0]], [1, [62.94001643378111, 1.0]], [1, [7.28453100009999, 1.0]], [1, [20.332885236902015, 1.0]], [1, [0.7736034914463691, 1.0]], [1, [2.791389387167868, 1.0]], [1, [0.2221916427892722, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80391725]
bas 1, expnt(s) = [7617.1729947]
bas 2, expnt(s) = [3617.4813656]
bas 3, expnt(s) = [1589.9989069]
bas 4, expnt(s) = [411.22657265]
bas 5, expnt(s) = [121.06902028]
bas 6, expnt(s) = [39.24148561]
bas 7, expnt(s) = [8.52440204]
bas 8, expnt(s) = [3.35397708]
bas 9, expnt(s) = [0.6741335]
bas 10, expnt(s) = [0.24944746]
bas 11, expnt(s) = [1362.8320093]
bas 12, expnt(s) = [664.27005902]
bas 13, expnt(s) = [298.72089167]
bas 14, expnt(s) = [312.11056918]
bas 15, expnt(s) = [62.94001643]
bas 16, expnt(s) = [7.284531]
bas 17, expnt(s) = [20.33288524]
bas 18, expnt(s) = [0.77360349]
bas 19, expnt(s) = [2.79138939]
bas 20, expnt(s) = [0.22219164]
CPU time:       434.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828039e+04 5.20028492e+03 7.61717299e+03 2.05996759e+03
 3.61748137e+03 1.17847331e+03 1.58999891e+03 6.36154558e+02
 4.11226573e+02 2.30715038e+02 1.21069020e+02 9.22124997e+01
 3.92414856e+01 3.96117569e+01 8.52440204e+00 1.26041327e+01
 3.35397708e+00 6.26159670e+00 6.74133497e-01 1.87963903e+00
 2.49447464e-01 8.91762784e-01 1.36283201e+03 2.41566829e+04
 6.64270059e+02 9.83819077e+03 2.98720892e+02 3.62298377e+03
 3.12110569e+02 3.82710156e+03 6.29400164e+01 5.17181472e+02
 7.28453100e+00 3.49129372e+01 2.03328852e+01 1.25960146e+02
 7.73603491e-01 2.11656894e+00 2.79138939e+00 1.05259165e+01
 2.22191643e-01 4.45034872e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99355337513819
cond(S) = 98673.91622285875
E1 = -729.5334765222348  E_coul = 203.17990518931512
init E= -526.35357133292
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555815044954857  LUMO = 1.02912516160758
  mo_energy =
[-1.18331772e+02 -1.22047299e+01 -9.44665243e+00 -9.44665243e+00
 -9.44665243e+00 -1.23994086e+00 -5.55815045e-01 -5.55815045e-01
 -5.55815045e-01  1.02912516e+00  1.02912516e+00  1.02912516e+00
  1.05928253e+00  7.29588852e+00  7.29588852e+00  7.29588852e+00
  1.36450035e+01  3.33898029e+01  3.33898029e+01  3.33898029e+01
  1.21725545e+02  1.30355761e+02  1.30355761e+02  1.30355761e+02
  4.85818927e+02  4.85818927e+02  4.85818927e+02  6.55907235e+02
  1.33399277e+03  1.33399277e+03  1.33399277e+03  2.78809634e+03
  3.02245661e+03  3.02245661e+03  3.02245661e+03  6.63887810e+03
  6.63887810e+03  6.63887810e+03  9.20594080e+03  2.55544668e+04
  7.62861204e+04]
E1 = -727.859576525001  E_coul = 201.11472483743248
cycle= 1 E= -526.744851687568  delta_E= -0.391  |g|= 0.185  |ddm|= 0.304
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538964
diis-c [-0.29048177  1.        ]
  HOMO = -0.590671971422063  LUMO = 1.00494224923556
  mo_energy =
[-1.18638033e+02 -1.23421252e+01 -9.59464785e+00 -9.59464785e+00
 -9.59464785e+00 -1.27943783e+00 -5.90671971e-01 -5.90671971e-01
 -5.90671971e-01  1.00494225e+00  1.00494225e+00  1.00494225e+00
  1.02972967e+00  7.20565120e+00  7.20565120e+00  7.20565120e+00
  1.35311063e+01  3.32361843e+01  3.32361843e+01  3.32361843e+01
  1.21497387e+02  1.30127321e+02  1.30127321e+02  1.30127321e+02
  4.85514213e+02  4.85514213e+02  4.85514213e+02  6.55557108e+02
  1.33363272e+03  1.33363272e+03  1.33363272e+03  2.78760233e+03
  3.02203126e+03  3.02203126e+03  3.02203126e+03  6.63834087e+03
  6.63834087e+03  6.63834087e+03  9.20533000e+03  2.55537624e+04
  7.62853262e+04]
E1 = -728.4317735137532  E_coul = 201.6862088255694
cycle= 2 E= -526.745564688184  delta_E= -0.000713  |g|= 0.0374  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0747015
diis-c [-0.00327657  0.08219962  0.91780038]
  HOMO = -0.581574650337938  LUMO = 1.01162543977424
  mo_energy =
[-1.18570589e+02 -1.23041823e+01 -9.55505475e+00 -9.55505475e+00
 -9.55505475e+00 -1.26855049e+00 -5.81574650e-01 -5.81574650e-01
 -5.81574650e-01  1.01162544e+00  1.01162544e+00  1.01162544e+00
  1.03816154e+00  7.22924038e+00  7.22924038e+00  7.22924038e+00
  1.35622713e+01  3.32761621e+01  3.32761621e+01  3.32761621e+01
  1.21554438e+02  1.30183212e+02  1.30183212e+02  1.30183212e+02
  4.85580836e+02  4.85580836e+02  4.85580836e+02  6.55626581e+02
  1.33370335e+03  1.33370335e+03  1.33370335e+03  2.78767633e+03
  3.02210414e+03  3.02210414e+03  3.02210414e+03  6.63841550e+03
  6.63841550e+03  6.63841550e+03  9.20540546e+03  2.55538384e+04
  7.62854025e+04]
E1 = -728.2816916104824  E_coul = 201.53606833741767
cycle= 3 E= -526.745623273065  delta_E= -5.86e-05  |g|= 0.00628  |ddm|= 0.0164
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0131241
diis-c [-5.43867388e-07 -1.22216545e-03  1.45086843e-01  8.56135322e-01]
  HOMO = -0.583074081012763  LUMO = 1.01054731189017
  mo_energy =
[-1.18580543e+02 -1.23099921e+01 -9.56120856e+00 -9.56120856e+00
 -9.56120856e+00 -1.27024701e+00 -5.83074081e-01 -5.83074081e-01
 -5.83074081e-01  1.01054731e+00  1.01054731e+00  1.01054731e+00
  1.03686636e+00  7.22547774e+00  7.22547774e+00  7.22547774e+00
  1.35574760e+01  3.32699879e+01  3.32699879e+01  3.32699879e+01
  1.21545953e+02  1.30174839e+02  1.30174839e+02  1.30174839e+02
  4.85570999e+02  4.85570999e+02  4.85570999e+02  6.55616316e+02
  1.33369292e+03  1.33369292e+03  1.33369292e+03  2.78766527e+03
  3.02209334e+03  3.02209334e+03  3.02209334e+03  6.63840431e+03
  6.63840431e+03  6.63840431e+03  9.20539405e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.304528912247  E_coul = 201.55890371449408
cycle= 4 E= -526.745625197753  delta_E= -1.92e-06  |g|= 9.39e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010818
diis-c [-3.91689484e-09  6.73920968e-05 -9.77078745e-03 -6.32253428e-02
  1.07292874e+00]
  HOMO = -0.583055547434552  LUMO = 1.01056305275412
  mo_energy =
[-1.18580503e+02 -1.23099278e+01 -9.56115722e+00 -9.56115722e+00
 -9.56115722e+00 -1.27020693e+00 -5.83055547e-01 -5.83055547e-01
 -5.83055547e-01  1.01056305e+00  1.01056305e+00  1.01056305e+00
  1.03690036e+00  7.22551937e+00  7.22551937e+00  7.22551937e+00
  1.35575354e+01  3.32700372e+01  3.32700372e+01  3.32700372e+01
  1.21546004e+02  1.30174887e+02  1.30174887e+02  1.30174887e+02
  4.85571040e+02  4.85571040e+02  4.85571040e+02  6.55616348e+02
  1.33369296e+03  1.33369296e+03  1.33369296e+03  2.78766529e+03
  3.02209336e+03  3.02209336e+03  3.02209336e+03  6.63840432e+03
  6.63840432e+03  6.63840432e+03  9.20539405e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.3043187696982  E_coul = 201.5586935704284
cycle= 5 E= -526.74562519927  delta_E= -1.52e-09  |g|= 2.01e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8252e-05
diis-c [-6.72648364e-11  1.41438176e-05 -1.86130774e-03 -1.38597611e-02
  4.30945234e-02  9.72612402e-01]
  HOMO = -0.583062741603936  LUMO = 1.0105582997202
  mo_energy =
[-1.18580533e+02 -1.23099498e+01 -9.56118102e+00 -9.56118102e+00
 -9.56118102e+00 -1.27021269e+00 -5.83062742e-01 -5.83062742e-01
 -5.83062742e-01  1.01055830e+00  1.01055830e+00  1.01055830e+00
  1.03689638e+00  7.22550332e+00  7.22550332e+00  7.22550332e+00
  1.35575172e+01  3.32700141e+01  3.32700141e+01  3.32700141e+01
  1.21545977e+02  1.30174860e+02  1.30174860e+02  1.30174860e+02
  4.85571010e+02  4.85571010e+02  4.85571010e+02  6.55616318e+02
  1.33369293e+03  1.33369293e+03  1.33369293e+03  2.78766525e+03
  3.02209333e+03  3.02209333e+03  3.02209333e+03  6.63840428e+03
  6.63840428e+03  6.63840428e+03  9.20539402e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.304398596679  E_coul = 201.5587733973546
cycle= 6 E= -526.745625199324  delta_E= -5.47e-11  |g|= 1.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.304398596679  E_coul = 201.5587733973546
  HOMO = -0.583062774039867  LUMO = 1.01055833118642
  mo_energy =
[-1.18580532e+02 -1.23099497e+01 -9.56118103e+00 -9.56118103e+00
 -9.56118103e+00 -1.27021235e+00 -5.83062774e-01 -5.83062774e-01
 -5.83062774e-01  1.01055833e+00  1.01055833e+00  1.01055833e+00
  1.03689670e+00  7.22550333e+00  7.22550333e+00  7.22550333e+00
  1.35575174e+01  3.32700141e+01  3.32700141e+01  3.32700141e+01
  1.21545977e+02  1.30174860e+02  1.30174860e+02  1.30174860e+02
  4.85571010e+02  4.85571010e+02  4.85571010e+02  6.55616318e+02
  1.33369293e+03  1.33369293e+03  1.33369293e+03  2.78766525e+03
  3.02209333e+03  3.02209333e+03  3.02209333e+03  6.63840428e+03
  6.63840428e+03  6.63840428e+03  9.20539402e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.3043979159512  E_coul = 201.55877271662524
Extra cycle  E= -526.745625199326  delta_E= -1.59e-12  |g|= 3.46e-07  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98673.91622285875
E1 = -728.3043979159512  E_coul = 201.55877271662524
init E= -526.745625199326
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.583062797648443  LUMO = 1.01055832585384
  mo_energy =
[-1.18580533e+02 -1.23099497e+01 -9.56118110e+00 -9.56118110e+00
 -9.56118110e+00 -1.27021230e+00 -5.83062798e-01 -5.83062798e-01
 -5.83062798e-01  1.01055833e+00  1.01055833e+00  1.01055833e+00
  1.03689675e+00  7.22550329e+00  7.22550329e+00  7.22550329e+00
  1.35575173e+01  3.32700140e+01  3.32700140e+01  3.32700140e+01
  1.21545977e+02  1.30174860e+02  1.30174860e+02  1.30174860e+02
  4.85571010e+02  4.85571010e+02  4.85571010e+02  6.55616318e+02
  1.33369293e+03  1.33369293e+03  1.33369293e+03  2.78766525e+03
  3.02209333e+03  3.02209333e+03  3.02209333e+03  6.63840428e+03
  6.63840428e+03  6.63840428e+03  9.20539402e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.30439801052  E_coul = 201.55877281119584
cycle= 1 E= -526.745625199324  delta_E= 1.82e-12  |g|= 7.16e-08  |ddm|= 5.75e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.30439801052  E_coul = 201.55877281119584
  HOMO = -0.583062798107658  LUMO = 1.01055832788438
  mo_energy =
[-1.18580533e+02 -1.23099497e+01 -9.56118109e+00 -9.56118109e+00
 -9.56118109e+00 -1.27021228e+00 -5.83062798e-01 -5.83062798e-01
 -5.83062798e-01  1.01055833e+00  1.01055833e+00  1.01055833e+00
  1.03689676e+00  7.22550329e+00  7.22550329e+00  7.22550329e+00
  1.35575173e+01  3.32700140e+01  3.32700140e+01  3.32700140e+01
  1.21545977e+02  1.30174860e+02  1.30174860e+02  1.30174860e+02
  4.85571010e+02  4.85571010e+02  4.85571010e+02  6.55616318e+02
  1.33369293e+03  1.33369293e+03  1.33369293e+03  2.78766525e+03
  3.02209333e+03  3.02209333e+03  3.02209333e+03  6.63840428e+03
  6.63840428e+03  6.63840428e+03  9.20539402e+03  2.55538268e+04
  7.62853908e+04]
E1 = -728.3043979639152  E_coul = 201.55877276458844
Extra cycle  E= -526.745625199327  delta_E= -2.61e-12  |g|= 1.44e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.38 sec
exp = [2.61828039e+04 7.61717299e+03 3.61748137e+03 1.58999891e+03
 4.11226573e+02 1.21069020e+02 3.92414856e+01 8.52440204e+00
 3.35397708e+00 6.74133497e-01 2.49447464e-01 1.36283201e+03
 6.64270059e+02 2.98720892e+02 3.12110569e+02 6.29400164e+01
 7.28453100e+00 2.03328852e+01 7.73603491e-01 2.79138939e+00
 2.22191643e-01]
grad_E = [-1.43194828e-06  2.45437078e-06 -2.11700648e-06  4.60269821e-05
 -7.76058332e-05  1.10226279e-04  6.29139195e-05  3.25568221e-04
 -7.02885555e-04  3.67103117e-04 -3.77885111e-04 -6.09857139e-07
  3.61420660e-06  1.58583678e-05  1.35704052e-05  3.19127245e-04
 -1.49462532e-03 -4.29749457e-04  1.33392071e-03  1.29750023e-03
 -3.74497307e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8098558        1
[INPUT] 0    0    [1    /1   ]  7617.15910884        1
[INPUT] 0    0    [1    /1   ]  3617.48669292        1
[INPUT] 0    0    [1    /1   ]  1589.68818557        1
[INPUT] 0    0    [1    /1   ]  412.372147044        1
[INPUT] 0    0    [1    /1   ]  121.434465393        1
[INPUT] 0    0    [1    /1   ]  39.3292878677        1
[INPUT] 0    0    [1    /1   ]  8.5489270354         1
[INPUT] 0    0    [1    /1   ]  3.36087502127        1
[INPUT] 0    0    [1    /1   ]  0.674567288966       1
[INPUT] 0    0    [1    /1   ]  0.249706677155       1
[INPUT] 1    0    [1    /1   ]  1362.83398988        1
[INPUT] 1    0    [1    /1   ]  664.251209245        1
[INPUT] 1    0    [1    /1   ]  298.632328377        1
[INPUT] 1    0    [1    /1   ]  312.03424325         1
[INPUT] 1    0    [1    /1   ]  62.907954544         1
[INPUT] 1    0    [1    /1   ]  7.38951826076        1
[INPUT] 1    0    [1    /1   ]  20.5227151436        1
[INPUT] 1    0    [1    /1   ]  0.778460467626       1
[INPUT] 1    0    [1    /1   ]  2.83429938521        1
[INPUT] 1    0    [1    /1   ]  0.22318727658        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.80985579494, 1.0]], [0, [7617.15910883533, 1.0]], [0, [3617.4866929242635, 1.0]], [0, [1589.688185569794, 1.0]], [0, [412.37214704431597, 1.0]], [0, [121.43446539330223, 1.0]], [0, [39.32928786768705, 1.0]], [0, [8.548927035399599, 1.0]], [0, [3.360875021267096, 1.0]], [0, [0.674567288965581, 1.0]], [0, [0.2497066771550339, 1.0]], [1, [1362.8339898841639, 1.0]], [1, [664.2512092448407, 1.0]], [1, [298.63232837650463, 1.0]], [1, [312.03424325032046, 1.0]], [1, [62.90795454398094, 1.0]], [1, [7.389518260760812, 1.0]], [1, [20.52271514356329, 1.0]], [1, [0.7784604676258063, 1.0]], [1, [2.834299385205318, 1.0]], [1, [0.22318727658003898, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80985579]
bas 1, expnt(s) = [7617.15910884]
bas 2, expnt(s) = [3617.48669292]
bas 3, expnt(s) = [1589.68818557]
bas 4, expnt(s) = [412.37214704]
bas 5, expnt(s) = [121.43446539]
bas 6, expnt(s) = [39.32928787]
bas 7, expnt(s) = [8.54892704]
bas 8, expnt(s) = [3.36087502]
bas 9, expnt(s) = [0.67456729]
bas 10, expnt(s) = [0.24970668]
bas 11, expnt(s) = [1362.83398988]
bas 12, expnt(s) = [664.25120924]
bas 13, expnt(s) = [298.63232838]
bas 14, expnt(s) = [312.03424325]
bas 15, expnt(s) = [62.90795454]
bas 16, expnt(s) = [7.38951826]
bas 17, expnt(s) = [20.52271514]
bas 18, expnt(s) = [0.77846047]
bas 19, expnt(s) = [2.83429939]
bas 20, expnt(s) = [0.22318728]
CPU time:       440.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828099e+04 5.20028581e+03 7.61715911e+03 2.05996478e+03
 3.61748669e+03 1.17847461e+03 1.58968819e+03 6.36061317e+02
 4.12372147e+02 2.31196906e+02 1.21434465e+02 9.24211777e+01
 3.93292879e+01 3.96782113e+01 8.54892704e+00 1.26313198e+01
 3.36087502e+00 6.27125263e+00 6.74567289e-01 1.88054609e+00
 2.49706677e-01 8.92457700e-01 1.36283399e+03 2.41567268e+04
 6.64251209e+02 9.83784180e+03 2.98632328e+02 3.62164117e+03
 3.12034243e+02 3.82593171e+03 6.29079545e+01 5.16852175e+02
 7.38951826e+00 3.55430384e+01 2.05227151e+01 1.27431828e+02
 7.78460468e-01 2.13319274e+00 2.83429939e+00 1.07285628e+01
 2.23187277e-01 4.47529001e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993378446250887
cond(S) = 98664.96804694674
E1 = -729.5336437704141  E_coul = 203.1802659750697
init E= -526.353377795344
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555771435227487  LUMO = 1.0373597091526
  mo_energy =
[-1.18331789e+02 -1.22046597e+01 -9.44668246e+00 -9.44668246e+00
 -9.44668246e+00 -1.23994014e+00 -5.55771435e-01 -5.55771435e-01
 -5.55771435e-01  1.03735971e+00  1.03735971e+00  1.03735971e+00
  1.06108944e+00  7.41948186e+00  7.41948186e+00  7.41948186e+00
  1.36988081e+01  3.39366956e+01  3.39366956e+01  3.39366956e+01
  1.22188470e+02  1.31367086e+02  1.31367086e+02  1.31367086e+02
  4.86742719e+02  4.86742719e+02  4.86742719e+02  6.58045547e+02
  1.33463766e+03  1.33463766e+03  1.33463766e+03  2.79260679e+03
  3.02280155e+03  3.02280155e+03  3.02280155e+03  6.63899691e+03
  6.63899691e+03  6.63899691e+03  9.21100396e+03  2.55592977e+04
  7.62905729e+04]
E1 = -727.8651591876227  E_coul = 201.1201209020419
cycle= 1 E= -526.745038285581  delta_E= -0.392  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538886
diis-c [-0.29039841  1.        ]
  HOMO = -0.590478790452671  LUMO = 1.01306970247018
  mo_energy =
[-1.18637420e+02 -1.23417415e+01 -9.59436277e+00 -9.59436277e+00
 -9.59436277e+00 -1.27926202e+00 -5.90478790e-01 -5.90478790e-01
 -5.90478790e-01  1.01306970e+00  1.01306970e+00  1.01306970e+00
  1.03165483e+00  7.32862520e+00  7.32862520e+00  7.32862520e+00
  1.35850091e+01  3.37827499e+01  3.37827499e+01  3.37827499e+01
  1.21960536e+02  1.31139154e+02  1.31139154e+02  1.31139154e+02
  4.86438721e+02  4.86438721e+02  4.86438721e+02  6.57695811e+02
  1.33427834e+03  1.33427834e+03  1.33427834e+03  2.79211344e+03
  3.02237693e+03  3.02237693e+03  3.02237693e+03  6.63846042e+03
  6.63846042e+03  6.63846042e+03  9.21039396e+03  2.55585940e+04
  7.62897795e+04]
E1 = -728.435248455609  E_coul = 201.68950076211723
cycle= 2 E= -526.745747693492  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746102
diis-c [-0.0032687   0.08211504  0.91788496]
  HOMO = -0.581421640040809  LUMO = 1.01978538342213
  mo_energy =
[-1.18570183e+02 -1.23039360e+01 -9.55491277e+00 -9.55491277e+00
 -9.55491277e+00 -1.26842196e+00 -5.81421640e-01 -5.81421640e-01
 -5.81421640e-01  1.01978538e+00  1.01978538e+00  1.01978538e+00
  1.04006215e+00  7.35234926e+00  7.35234926e+00  7.35234926e+00
  1.36161110e+01  3.38227501e+01  3.38227501e+01  3.38227501e+01
  1.22017444e+02  1.31194867e+02  1.31194867e+02  1.31194867e+02
  4.86505124e+02  4.86505124e+02  4.86505124e+02  6.57765087e+02
  1.33434875e+03  1.33434875e+03  1.33434875e+03  2.79218722e+03
  3.02244958e+03  3.02244958e+03  3.02244958e+03  6.63853483e+03
  6.63853483e+03  6.63853483e+03  9.21046918e+03  2.55586698e+04
  7.62898556e+04]
E1 = -728.2858996682593  E_coul = 201.54009385079925
cycle= 3 E= -526.74580581746  delta_E= -5.81e-05  |g|= 0.00626  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130966
diis-c [-5.42493192e-07 -1.22091864e-03  1.44973612e-01  8.56247307e-01]
  HOMO = -0.582912428064443  LUMO = 1.01870358250461
  mo_energy =
[-1.18580096e+02 -1.23097176e+01 -9.56103748e+00 -9.56103748e+00
 -9.56103748e+00 -1.27010813e+00 -5.82912428e-01 -5.82912428e-01
 -5.82912428e-01  1.01870358e+00  1.01870358e+00  1.01870358e+00
  1.03877328e+00  7.34857108e+00  7.34857108e+00  7.34857108e+00
  1.36113321e+01  3.38165815e+01  3.38165815e+01  3.38165815e+01
  1.22008991e+02  1.31186531e+02  1.31186531e+02  1.31186531e+02
  4.86495329e+02  4.86495329e+02  4.86495329e+02  6.57754861e+02
  1.33433837e+03  1.33433837e+03  1.33433837e+03  2.79217621e+03
  3.02243882e+03  3.02243882e+03  3.02243882e+03  6.63852368e+03
  6.63852368e+03  6.63852368e+03  9.21045782e+03  2.55586583e+04
  7.62898439e+04]
E1 = -728.3085966513695  E_coul = 201.5627889293762
cycle= 4 E= -526.745807721993  delta_E= -1.9e-06  |g|= 9.4e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109145
diis-c [-3.87150518e-09  6.83628652e-05 -9.88988458e-03 -6.41089864e-02
  1.07393051e+00]
  HOMO = -0.582894224203186  LUMO = 1.01871920935502
  mo_energy =
[-1.18580057e+02 -1.23096542e+01 -9.56098717e+00 -9.56098717e+00
 -9.56098717e+00 -1.27006837e+00 -5.82894224e-01 -5.82894224e-01
 -5.82894224e-01  1.01871921e+00  1.01871921e+00  1.01871921e+00
  1.03880708e+00  7.34861218e+00  7.34861218e+00  7.34861218e+00
  1.36113908e+01  3.38166298e+01  3.38166298e+01  3.38166298e+01
  1.22009041e+02  1.31186578e+02  1.31186578e+02  1.31186578e+02
  4.86495369e+02  4.86495369e+02  4.86495369e+02  6.57754892e+02
  1.33433840e+03  1.33433840e+03  1.33433840e+03  2.79217622e+03
  3.02243884e+03  3.02243884e+03  3.02243884e+03  6.63852369e+03
  6.63852369e+03  6.63852369e+03  9.21045782e+03  2.55586583e+04
  7.62898439e+04]
E1 = -728.3083900051175  E_coul = 201.56258228160243
cycle= 5 E= -526.745807723515  delta_E= -1.52e-09  |g|= 2e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.80661e-05
diis-c [-6.73346683e-11  1.40585296e-05 -1.85069310e-03 -1.38049373e-02
  4.31784241e-02  9.72463148e-01]
  HOMO = -0.582901391291948  LUMO = 1.01871442895376
  mo_energy =
[-1.18580087e+02 -1.23096761e+01 -9.56101088e+00 -9.56101088e+00
 -9.56101088e+00 -1.27007410e+00 -5.82901391e-01 -5.82901391e-01
 -5.82901391e-01  1.01871443e+00  1.01871443e+00  1.01871443e+00
  1.03880311e+00  7.34859606e+00  7.34859606e+00  7.34859606e+00
  1.36113726e+01  3.38166067e+01  3.38166067e+01  3.38166067e+01
  1.22009014e+02  1.31186550e+02  1.31186550e+02  1.31186550e+02
  4.86495339e+02  4.86495339e+02  4.86495339e+02  6.57754862e+02
  1.33433837e+03  1.33433837e+03  1.33433837e+03  2.79217619e+03
  3.02243881e+03  3.02243881e+03  3.02243881e+03  6.63852365e+03
  6.63852365e+03  6.63852365e+03  9.21045779e+03  2.55586582e+04
  7.62898439e+04]
E1 = -728.3084693057436  E_coul = 201.5626615821745
cycle= 6 E= -526.745807723569  delta_E= -5.4e-11  |g|= 1.68e-06  |ddm|= 1.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3084693057436  E_coul = 201.5626615821745
  HOMO = -0.582901419663497  LUMO = 1.01871446301293
  mo_energy =
[-1.18580086e+02 -1.23096760e+01 -9.56101087e+00 -9.56101087e+00
 -9.56101087e+00 -1.27007376e+00 -5.82901420e-01 -5.82901420e-01
 -5.82901420e-01  1.01871446e+00  1.01871446e+00  1.01871446e+00
  1.03880343e+00  7.34859608e+00  7.34859608e+00  7.34859608e+00
  1.36113728e+01  3.38166068e+01  3.38166068e+01  3.38166068e+01
  1.22009014e+02  1.31186551e+02  1.31186551e+02  1.31186551e+02
  4.86495339e+02  4.86495339e+02  4.86495339e+02  6.57754862e+02
  1.33433837e+03  1.33433837e+03  1.33433837e+03  2.79217619e+03
  3.02243881e+03  3.02243881e+03  3.02243881e+03  6.63852365e+03
  6.63852365e+03  6.63852365e+03  9.21045779e+03  2.55586582e+04
  7.62898439e+04]
E1 = -728.3084685512579  E_coul = 201.56266082768815
Extra cycle  E= -526.74580772357  delta_E= -5.68e-13  |g|= 3.45e-07  |ddm|= 2.91e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828099e+04 7.61715911e+03 3.61748669e+03 1.58968819e+03
 4.12372147e+02 1.21434465e+02 3.93292879e+01 8.54892704e+00
 3.36087502e+00 6.74567289e-01 2.49706677e-01 1.36283399e+03
 6.64251209e+02 2.98632328e+02 3.12034243e+02 6.29079545e+01
 7.38951826e+00 2.05227151e+01 7.78460468e-01 2.83429939e+00
 2.23187277e-01]
E = -526.7458077235697
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8098558        1
[INPUT] 0    0    [1    /1   ]  7617.15910884        1
[INPUT] 0    0    [1    /1   ]  3617.48669292        1
[INPUT] 0    0    [1    /1   ]  1589.68818557        1
[INPUT] 0    0    [1    /1   ]  412.372147044        1
[INPUT] 0    0    [1    /1   ]  121.434465393        1
[INPUT] 0    0    [1    /1   ]  39.3292878677        1
[INPUT] 0    0    [1    /1   ]  8.5489270354         1
[INPUT] 0    0    [1    /1   ]  3.36087502127        1
[INPUT] 0    0    [1    /1   ]  0.674567288966       1
[INPUT] 0    0    [1    /1   ]  0.249706677155       1
[INPUT] 1    0    [1    /1   ]  1362.83398988        1
[INPUT] 1    0    [1    /1   ]  664.251209245        1
[INPUT] 1    0    [1    /1   ]  298.632328377        1
[INPUT] 1    0    [1    /1   ]  312.03424325         1
[INPUT] 1    0    [1    /1   ]  62.907954544         1
[INPUT] 1    0    [1    /1   ]  7.38951826076        1
[INPUT] 1    0    [1    /1   ]  20.5227151436        1
[INPUT] 1    0    [1    /1   ]  0.778460467626       1
[INPUT] 1    0    [1    /1   ]  2.83429938521        1
[INPUT] 1    0    [1    /1   ]  0.22318727658        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.80985579494, 1.0]], [0, [7617.15910883533, 1.0]], [0, [3617.4866929242635, 1.0]], [0, [1589.688185569794, 1.0]], [0, [412.37214704431597, 1.0]], [0, [121.43446539330223, 1.0]], [0, [39.32928786768705, 1.0]], [0, [8.548927035399599, 1.0]], [0, [3.360875021267096, 1.0]], [0, [0.674567288965581, 1.0]], [0, [0.2497066771550339, 1.0]], [1, [1362.8339898841639, 1.0]], [1, [664.2512092448407, 1.0]], [1, [298.63232837650463, 1.0]], [1, [312.03424325032046, 1.0]], [1, [62.90795454398094, 1.0]], [1, [7.389518260760812, 1.0]], [1, [20.52271514356329, 1.0]], [1, [0.7784604676258063, 1.0]], [1, [2.834299385205318, 1.0]], [1, [0.22318727658003898, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.80985579]
bas 1, expnt(s) = [7617.15910884]
bas 2, expnt(s) = [3617.48669292]
bas 3, expnt(s) = [1589.68818557]
bas 4, expnt(s) = [412.37214704]
bas 5, expnt(s) = [121.43446539]
bas 6, expnt(s) = [39.32928787]
bas 7, expnt(s) = [8.54892704]
bas 8, expnt(s) = [3.36087502]
bas 9, expnt(s) = [0.67456729]
bas 10, expnt(s) = [0.24970668]
bas 11, expnt(s) = [1362.83398988]
bas 12, expnt(s) = [664.25120924]
bas 13, expnt(s) = [298.63232838]
bas 14, expnt(s) = [312.03424325]
bas 15, expnt(s) = [62.90795454]
bas 16, expnt(s) = [7.38951826]
bas 17, expnt(s) = [20.52271514]
bas 18, expnt(s) = [0.77846047]
bas 19, expnt(s) = [2.83429939]
bas 20, expnt(s) = [0.22318728]
CPU time:       440.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828099e+04 5.20028581e+03 7.61715911e+03 2.05996478e+03
 3.61748669e+03 1.17847461e+03 1.58968819e+03 6.36061317e+02
 4.12372147e+02 2.31196906e+02 1.21434465e+02 9.24211777e+01
 3.93292879e+01 3.96782113e+01 8.54892704e+00 1.26313198e+01
 3.36087502e+00 6.27125263e+00 6.74567289e-01 1.88054609e+00
 2.49706677e-01 8.92457700e-01 1.36283399e+03 2.41567268e+04
 6.64251209e+02 9.83784180e+03 2.98632328e+02 3.62164117e+03
 3.12034243e+02 3.82593171e+03 6.29079545e+01 5.16852175e+02
 7.38951826e+00 3.55430384e+01 2.05227151e+01 1.27431828e+02
 7.78460468e-01 2.13319274e+00 2.83429939e+00 1.07285628e+01
 2.23187277e-01 4.47529001e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993378446250887
cond(S) = 98664.96804694674
E1 = -729.5336437704141  E_coul = 203.1802659750697
init E= -526.353377795344
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555771435227487  LUMO = 1.0373597091526
  mo_energy =
[-1.18331789e+02 -1.22046597e+01 -9.44668246e+00 -9.44668246e+00
 -9.44668246e+00 -1.23994014e+00 -5.55771435e-01 -5.55771435e-01
 -5.55771435e-01  1.03735971e+00  1.03735971e+00  1.03735971e+00
  1.06108944e+00  7.41948186e+00  7.41948186e+00  7.41948186e+00
  1.36988081e+01  3.39366956e+01  3.39366956e+01  3.39366956e+01
  1.22188470e+02  1.31367086e+02  1.31367086e+02  1.31367086e+02
  4.86742719e+02  4.86742719e+02  4.86742719e+02  6.58045547e+02
  1.33463766e+03  1.33463766e+03  1.33463766e+03  2.79260679e+03
  3.02280155e+03  3.02280155e+03  3.02280155e+03  6.63899691e+03
  6.63899691e+03  6.63899691e+03  9.21100396e+03  2.55592977e+04
  7.62905729e+04]
E1 = -727.8651591876227  E_coul = 201.1201209020419
cycle= 1 E= -526.745038285581  delta_E= -0.392  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538886
diis-c [-0.29039841  1.        ]
  HOMO = -0.590478790452671  LUMO = 1.01306970247018
  mo_energy =
[-1.18637420e+02 -1.23417415e+01 -9.59436277e+00 -9.59436277e+00
 -9.59436277e+00 -1.27926202e+00 -5.90478790e-01 -5.90478790e-01
 -5.90478790e-01  1.01306970e+00  1.01306970e+00  1.01306970e+00
  1.03165483e+00  7.32862520e+00  7.32862520e+00  7.32862520e+00
  1.35850091e+01  3.37827499e+01  3.37827499e+01  3.37827499e+01
  1.21960536e+02  1.31139154e+02  1.31139154e+02  1.31139154e+02
  4.86438721e+02  4.86438721e+02  4.86438721e+02  6.57695811e+02
  1.33427834e+03  1.33427834e+03  1.33427834e+03  2.79211344e+03
  3.02237693e+03  3.02237693e+03  3.02237693e+03  6.63846042e+03
  6.63846042e+03  6.63846042e+03  9.21039396e+03  2.55585940e+04
  7.62897795e+04]
E1 = -728.435248455609  E_coul = 201.68950076211723
cycle= 2 E= -526.745747693492  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746102
diis-c [-0.0032687   0.08211504  0.91788496]
  HOMO = -0.581421640040809  LUMO = 1.01978538342213
  mo_energy =
[-1.18570183e+02 -1.23039360e+01 -9.55491277e+00 -9.55491277e+00
 -9.55491277e+00 -1.26842196e+00 -5.81421640e-01 -5.81421640e-01
 -5.81421640e-01  1.01978538e+00  1.01978538e+00  1.01978538e+00
  1.04006215e+00  7.35234926e+00  7.35234926e+00  7.35234926e+00
  1.36161110e+01  3.38227501e+01  3.38227501e+01  3.38227501e+01
  1.22017444e+02  1.31194867e+02  1.31194867e+02  1.31194867e+02
  4.86505124e+02  4.86505124e+02  4.86505124e+02  6.57765087e+02
  1.33434875e+03  1.33434875e+03  1.33434875e+03  2.79218722e+03
  3.02244958e+03  3.02244958e+03  3.02244958e+03  6.63853483e+03
  6.63853483e+03  6.63853483e+03  9.21046918e+03  2.55586698e+04
  7.62898556e+04]
E1 = -728.2858996682593  E_coul = 201.54009385079925
cycle= 3 E= -526.74580581746  delta_E= -5.81e-05  |g|= 0.00626  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130966
diis-c [-5.42493192e-07 -1.22091864e-03  1.44973612e-01  8.56247307e-01]
  HOMO = -0.582912428064443  LUMO = 1.01870358250461
  mo_energy =
[-1.18580096e+02 -1.23097176e+01 -9.56103748e+00 -9.56103748e+00
 -9.56103748e+00 -1.27010813e+00 -5.82912428e-01 -5.82912428e-01
 -5.82912428e-01  1.01870358e+00  1.01870358e+00  1.01870358e+00
  1.03877328e+00  7.34857108e+00  7.34857108e+00  7.34857108e+00
  1.36113321e+01  3.38165815e+01  3.38165815e+01  3.38165815e+01
  1.22008991e+02  1.31186531e+02  1.31186531e+02  1.31186531e+02
  4.86495329e+02  4.86495329e+02  4.86495329e+02  6.57754861e+02
  1.33433837e+03  1.33433837e+03  1.33433837e+03  2.79217621e+03
  3.02243882e+03  3.02243882e+03  3.02243882e+03  6.63852368e+03
  6.63852368e+03  6.63852368e+03  9.21045782e+03  2.55586583e+04
  7.62898439e+04]
E1 = -728.3085966513695  E_coul = 201.5627889293762
cycle= 4 E= -526.745807721993  delta_E= -1.9e-06  |g|= 9.4e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109145
diis-c [-3.87150518e-09  6.83628652e-05 -9.88988458e-03 -6.41089864e-02
  1.07393051e+00]
  HOMO = -0.582894224203186  LUMO = 1.01871920935502
  mo_energy =
[-1.18580057e+02 -1.23096542e+01 -9.56098717e+00 -9.56098717e+00
 -9.56098717e+00 -1.27006837e+00 -5.82894224e-01 -5.82894224e-01
 -5.82894224e-01  1.01871921e+00  1.01871921e+00  1.01871921e+00
  1.03880708e+00  7.34861218e+00  7.34861218e+00  7.34861218e+00
  1.36113908e+01  3.38166298e+01  3.38166298e+01  3.38166298e+01
  1.22009041e+02  1.31186578e+02  1.31186578e+02  1.31186578e+02
  4.86495369e+02  4.86495369e+02  4.86495369e+02  6.57754892e+02
  1.33433840e+03  1.33433840e+03  1.33433840e+03  2.79217622e+03
  3.02243884e+03  3.02243884e+03  3.02243884e+03  6.63852369e+03
  6.63852369e+03  6.63852369e+03  9.21045782e+03  2.55586583e+04
  7.62898439e+04]
E1 = -728.3083900051175  E_coul = 201.56258228160243
cycle= 5 E= -526.745807723515  delta_E= -1.52e-09  |g|= 2e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.80661e-05
diis-c [-6.73346683e-11  1.40585296e-05 -1.85069310e-03 -1.38049373e-02
  4.31784241e-02  9.72463148e-01]
  HOMO = -0.582901391291948  LUMO = 1.01871442895376
  mo_energy =
[-1.18580087e+02 -1.23096761e+01 -9.56101088e+00 -9.56101088e+00
 -9.56101088e+00 -1.27007410e+00 -5.82901391e-01 -5.82901391e-01
 -5.82901391e-01  1.01871443e+00  1.01871443e+00  1.01871443e+00
  1.03880311e+00  7.34859606e+00  7.34859606e+00  7.34859606e+00
  1.36113726e+01  3.38166067e+01  3.38166067e+01  3.38166067e+01
  1.22009014e+02  1.31186550e+02  1.31186550e+02  1.31186550e+02
  4.86495339e+02  4.86495339e+02  4.86495339e+02  6.57754862e+02
  1.33433837e+03  1.33433837e+03  1.33433837e+03  2.79217619e+03
  3.02243881e+03  3.02243881e+03  3.02243881e+03  6.63852365e+03
  6.63852365e+03  6.63852365e+03  9.21045779e+03  2.55586582e+04
  7.62898439e+04]
E1 = -728.3084693057436  E_coul = 201.5626615821745
cycle= 6 E= -526.745807723569  delta_E= -5.4e-11  |g|= 1.68e-06  |ddm|= 1.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3084693057436  E_coul = 201.5626615821745
  HOMO = -0.582901419663497  LUMO = 1.01871446301293
  mo_energy =
[-1.18580086e+02 -1.23096760e+01 -9.56101087e+00 -9.56101087e+00
 -9.56101087e+00 -1.27007376e+00 -5.82901420e-01 -5.82901420e-01
 -5.82901420e-01  1.01871446e+00  1.01871446e+00  1.01871446e+00
  1.03880343e+00  7.34859608e+00  7.34859608e+00  7.34859608e+00
  1.36113728e+01  3.38166068e+01  3.38166068e+01  3.38166068e+01
  1.22009014e+02  1.31186551e+02  1.31186551e+02  1.31186551e+02
  4.86495339e+02  4.86495339e+02  4.86495339e+02  6.57754862e+02
  1.33433837e+03  1.33433837e+03  1.33433837e+03  2.79217619e+03
  3.02243881e+03  3.02243881e+03  3.02243881e+03  6.63852365e+03
  6.63852365e+03  6.63852365e+03  9.21045779e+03  2.55586582e+04
  7.62898439e+04]
E1 = -728.3084685512579  E_coul = 201.56266082768815
Extra cycle  E= -526.74580772357  delta_E= -5.68e-13  |g|= 3.45e-07  |ddm|= 2.91e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98664.96804694674
E1 = -728.3084685512579  E_coul = 201.56266082768815
init E= -526.74580772357
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.582901444853246  LUMO = 1.0187144563383
  mo_energy =
[-1.18580087e+02 -1.23096760e+01 -9.56101094e+00 -9.56101094e+00
 -9.56101094e+00 -1.27007371e+00 -5.82901445e-01 -5.82901445e-01
 -5.82901445e-01  1.01871446e+00  1.01871446e+00  1.01871446e+00
  1.03880348e+00  7.34859604e+00  7.34859604e+00  7.34859604e+00
  1.36113727e+01  3.38166067e+01  3.38166067e+01  3.38166067e+01
  1.22009014e+02  1.31186550e+02  1.31186550e+02  1.31186550e+02
  4.86495339e+02  4.86495339e+02  4.86495339e+02  6.57754862e+02
  1.33433837e+03  1.33433837e+03  1.33433837e+03  2.79217619e+03
  3.02243881e+03  3.02243881e+03  3.02243881e+03  6.63852365e+03
  6.63852365e+03  6.63852365e+03  9.21045778e+03  2.55586582e+04
  7.62898439e+04]
E1 = -728.3084686639181  E_coul = 201.56266094034817
cycle= 1 E= -526.74580772357  delta_E= -2.27e-13  |g|= 7.15e-08  |ddm|= 5.72e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3084686639181  E_coul = 201.56266094034817
  HOMO = -0.582901444995344  LUMO = 1.01871445858893
  mo_energy =
[-1.18580087e+02 -1.23096760e+01 -9.56101094e+00 -9.56101094e+00
 -9.56101094e+00 -1.27007370e+00 -5.82901445e-01 -5.82901445e-01
 -5.82901445e-01  1.01871446e+00  1.01871446e+00  1.01871446e+00
  1.03880349e+00  7.34859604e+00  7.34859604e+00  7.34859604e+00
  1.36113727e+01  3.38166067e+01  3.38166067e+01  3.38166067e+01
  1.22009014e+02  1.31186550e+02  1.31186550e+02  1.31186550e+02
  4.86495339e+02  4.86495339e+02  4.86495339e+02  6.57754862e+02
  1.33433837e+03  1.33433837e+03  1.33433837e+03  2.79217619e+03
  3.02243881e+03  3.02243881e+03  3.02243881e+03  6.63852365e+03
  6.63852365e+03  6.63852365e+03  9.21045778e+03  2.55586582e+04
  7.62898439e+04]
E1 = -728.3084686117876  E_coul = 201.5626608882169
Extra cycle  E= -526.745807723571  delta_E= -7.96e-13  |g|= 1.44e-08  |ddm|= 1.19e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61828099e+04 7.61715911e+03 3.61748669e+03 1.58968819e+03
 4.12372147e+02 1.21434465e+02 3.93292879e+01 8.54892704e+00
 3.36087502e+00 6.74567289e-01 2.49706677e-01 1.36283399e+03
 6.64251209e+02 2.98632328e+02 3.12034243e+02 6.29079545e+01
 7.38951826e+00 2.05227151e+01 7.78460468e-01 2.83429939e+00
 2.23187277e-01]
grad_E = [-1.42758652e-06  2.41569507e-06 -2.12644471e-06  4.48989566e-05
 -7.14576658e-05  1.17650508e-04  7.76284231e-05  4.01997791e-04
 -8.56158340e-04  3.90559863e-04 -4.90153705e-04 -5.93497657e-07
  3.92485704e-06  1.77103583e-05  1.51432373e-05  1.52344687e-04
 -1.54766305e-03  6.41518229e-05  1.77719503e-03  1.78562335e-03
 -4.85551057e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8237097        1
[INPUT] 0    0    [1    /1   ]  7617.12643425        1
[INPUT] 0    0    [1    /1   ]  3617.49887738        1
[INPUT] 0    0    [1    /1   ]  1588.953487          1
[INPUT] 0    0    [1    /1   ]  415.179812292        1
[INPUT] 0    0    [1    /1   ]  122.033148182        1
[INPUT] 0    0    [1    /1   ]  39.4217018526        1
[INPUT] 0    0    [1    /1   ]  8.54447530477        1
[INPUT] 0    0    [1    /1   ]  3.36269913013        1
[INPUT] 0    0    [1    /1   ]  0.67477308078        1
[INPUT] 0    0    [1    /1   ]  0.249901732564       1
[INPUT] 1    0    [1    /1   ]  1362.83857502        1
[INPUT] 1    0    [1    /1   ]  664.206984919        1
[INPUT] 1    0    [1    /1   ]  298.424199821        1
[INPUT] 1    0    [1    /1   ]  311.854860606        1
[INPUT] 1    0    [1    /1   ]  62.9488742744        1
[INPUT] 1    0    [1    /1   ]  7.48697458096        1
[INPUT] 1    0    [1    /1   ]  20.7084076456        1
[INPUT] 1    0    [1    /1   ]  0.782293378395       1
[INPUT] 1    0    [1    /1   ]  2.86824751908        1
[INPUT] 1    0    [1    /1   ]  0.224031987941       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.82370972112, 1.0]], [0, [7617.126434245631, 1.0]], [0, [3617.4988773827395, 1.0]], [0, [1588.9534869997342, 1.0]], [0, [415.17981229214377, 1.0]], [0, [122.03314818181072, 1.0]], [0, [39.421701852617986, 1.0]], [0, [8.544475304767344, 1.0]], [0, [3.3626991301349287, 1.0]], [0, [0.6747730807797684, 1.0]], [0, [0.24990173256442794, 1.0]], [1, [1362.8385750178845, 1.0]], [1, [664.2069849185577, 1.0]], [1, [298.42419982110994, 1.0]], [1, [311.8548606059114, 1.0]], [1, [62.94887427443187, 1.0]], [1, [7.486974580957521, 1.0]], [1, [20.70840764563161, 1.0]], [1, [0.7822933783952443, 1.0]], [1, [2.8682475190775647, 1.0]], [1, [0.22403198794121912, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.82370972]
bas 1, expnt(s) = [7617.12643425]
bas 2, expnt(s) = [3617.49887738]
bas 3, expnt(s) = [1588.953487]
bas 4, expnt(s) = [415.17981229]
bas 5, expnt(s) = [122.03314818]
bas 6, expnt(s) = [39.42170185]
bas 7, expnt(s) = [8.5444753]
bas 8, expnt(s) = [3.36269913]
bas 9, expnt(s) = [0.67477308]
bas 10, expnt(s) = [0.24990173]
bas 11, expnt(s) = [1362.83857502]
bas 12, expnt(s) = [664.20698492]
bas 13, expnt(s) = [298.42419982]
bas 14, expnt(s) = [311.85486061]
bas 15, expnt(s) = [62.94887427]
bas 16, expnt(s) = [7.48697458]
bas 17, expnt(s) = [20.70840765]
bas 18, expnt(s) = [0.78229338]
bas 19, expnt(s) = [2.86824752]
bas 20, expnt(s) = [0.22403199]
CPU time:       446.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828237e+04 5.20028787e+03 7.61712643e+03 2.05995815e+03
 3.61749888e+03 1.17847759e+03 1.58895349e+03 6.35840830e+02
 4.15179812e+02 2.32376494e+02 1.22033148e+02 9.27627010e+01
 3.94217019e+01 3.97481162e+01 8.54447530e+00 1.26263863e+01
 3.36269913e+00 6.27380524e+00 6.74773081e-01 1.88097635e+00
 2.49901733e-01 8.92980498e-01 1.36283858e+03 2.41568284e+04
 6.64206985e+02 9.83702308e+03 2.98424200e+02 3.61848636e+03
 3.11854861e+02 3.82318259e+03 6.29488743e+01 5.17272455e+02
 7.48697458e+00 3.61299484e+01 2.07084076e+01 1.28874732e+02
 7.82293378e-01 2.14632982e+00 2.86824752e+00 1.08894307e+01
 2.24031988e-01 4.49647241e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993233031482553
cond(S) = 98351.47026120531
E1 = -729.5328692069023  E_coul = 203.1802803029845
init E= -526.352588903918
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555730545462246  LUMO = 1.04409531639855
  mo_energy =
[-1.18331856e+02 -1.22046456e+01 -9.44672550e+00 -9.44672550e+00
 -9.44672550e+00 -1.23994823e+00 -5.55730545e-01 -5.55730545e-01
 -5.55730545e-01  1.04409532e+00  1.04409532e+00  1.04409532e+00
  1.06214476e+00  7.52217255e+00  7.52217255e+00  7.52217255e+00
  1.37050717e+01  3.44269750e+01  3.44269750e+01  3.44269750e+01
  1.22625242e+02  1.32372290e+02  1.32372290e+02  1.32372290e+02
  4.87727592e+02  4.87727592e+02  4.87727592e+02  6.61782570e+02
  1.33515420e+03  1.33515420e+03  1.33515420e+03  2.80187665e+03
  3.02271066e+03  3.02271066e+03  3.02271066e+03  6.63846423e+03
  6.63846423e+03  6.63846423e+03  9.22171527e+03  2.55695442e+04
  7.63000104e+04]
E1 = -727.8705232018115  E_coul = 201.1253213550813
cycle= 1 E= -526.74520184673  delta_E= -0.393  |g|= 0.185  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538507
diis-c [-0.28998951  1.        ]
  HOMO = -0.590268273513481  LUMO = 1.01975754579087
  mo_energy =
[-1.18636935e+02 -1.23414063e+01 -9.59406824e+00 -9.59406824e+00
 -9.59406824e+00 -1.27907621e+00 -5.90268274e-01 -5.90268274e-01
 -5.90268274e-01  1.01975755e+00  1.01975755e+00  1.01975755e+00
  1.03286406e+00  7.43086131e+00  7.43086131e+00  7.43086131e+00
  1.35915405e+01  3.42727493e+01  3.42727493e+01  3.42727493e+01
  1.22397471e+02  1.32144759e+02  1.32144759e+02  1.32144759e+02
  4.87424255e+02  4.87424255e+02  4.87424255e+02  6.61432820e+02
  1.33479553e+03  1.33479553e+03  1.33479553e+03  2.80138375e+03
  3.02228664e+03  3.02228664e+03  3.02228664e+03  6.63792838e+03
  6.63792838e+03  6.63792838e+03  9.22110597e+03  2.55688413e+04
  7.62992177e+04]
E1 = -728.4385337494884  E_coul = 201.69262620843813
cycle= 2 E= -526.74590754105  delta_E= -0.000706  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.074489
diis-c [-0.00325634  0.08207328  0.91792672]
  HOMO = -0.581250537266818  LUMO = 1.0264933772849
  mo_energy =
[-1.18569905e+02 -1.23037397e+01 -9.55476140e+00 -9.55476140e+00
 -9.55476140e+00 -1.26828319e+00 -5.81250537e-01 -5.81250537e-01
 -5.81250537e-01  1.02649338e+00  1.02649338e+00  1.02649338e+00
  1.04124050e+00  7.45468234e+00  7.45468234e+00  7.45468234e+00
  1.36225325e+01  3.43127616e+01  3.43127616e+01  3.43127616e+01
  1.22454250e+02  1.32200307e+02  1.32200307e+02  1.32200307e+02
  4.87490439e+02  4.87490439e+02  4.87490439e+02  6.61501917e+02
  1.33486572e+03  1.33486572e+03  1.33486572e+03  2.80145731e+03
  3.02235908e+03  3.02235908e+03  3.02235908e+03  6.63800256e+03
  6.63800256e+03  6.63800256e+03  9.22118097e+03  2.55689169e+04
  7.62992936e+04]
E1 = -728.2899078673123  E_coul = 201.54394265818598
cycle= 3 E= -526.745965209126  delta_E= -5.77e-05  |g|= 0.00623  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130592
diis-c [-5.39171615e-07 -1.21961767e-03  1.44813993e-01  8.56405625e-01]
  HOMO = -0.582732401251986  LUMO = 1.02541019490329
  mo_energy =
[-1.18579775e+02 -1.23094924e+01 -9.56085615e+00 -9.56085615e+00
 -9.56085615e+00 -1.26995880e+00 -5.82732401e-01 -5.82732401e-01
 -5.82732401e-01  1.02541019e+00  1.02541019e+00  1.02541019e+00
  1.03995909e+00  7.45089522e+00  7.45089522e+00  7.45089522e+00
  1.36177772e+01  3.43066010e+01  3.43066010e+01  3.43066010e+01
  1.22445827e+02  1.32192007e+02  1.32192007e+02  1.32192007e+02
  4.87480688e+02  4.87480688e+02  4.87480688e+02  6.61491730e+02
  1.33485539e+03  1.33485539e+03  1.33485539e+03  2.80144634e+03
  3.02234836e+03  3.02234836e+03  3.02234836e+03  6.63799146e+03
  6.63799146e+03  6.63799146e+03  9.22116965e+03  2.55689054e+04
  7.62992820e+04]
E1 = -728.3124628165241  E_coul = 201.56649572371344
cycle= 4 E= -526.745967092811  delta_E= -1.88e-06  |g|= 9.39e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109528
diis-c [-3.81937340e-09  6.89586178e-05 -9.96405150e-03 -6.47024580e-02
  1.07459755e+00]
  HOMO = -0.582714462802543  LUMO = 1.02542572201876
  mo_energy =
[-1.18579737e+02 -1.23094299e+01 -9.56080668e+00 -9.56080668e+00
 -9.56080668e+00 -1.26991933e+00 -5.82714463e-01 -5.82714463e-01
 -5.82714463e-01  1.02542572e+00  1.02542572e+00  1.02542572e+00
  1.03999269e+00  7.45093588e+00  7.45093588e+00  7.45093588e+00
  1.36178352e+01  3.43066485e+01  3.43066485e+01  3.43066485e+01
  1.22445876e+02  1.32192052e+02  1.32192052e+02  1.32192052e+02
  4.87480727e+02  4.87480727e+02  4.87480727e+02  6.61491761e+02
  1.33485542e+03  1.33485542e+03  1.33485542e+03  2.80144635e+03
  3.02234838e+03  3.02234838e+03  3.02234838e+03  6.63799146e+03
  6.63799146e+03  6.63799146e+03  9.22116965e+03  2.55689054e+04
  7.62992820e+04]
E1 = -728.3122590731903  E_coul = 201.56629197885897
cycle= 5 E= -526.745967094331  delta_E= -1.52e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.78444e-05
diis-c [-6.72093976e-11  1.39883576e-05 -1.84076478e-03 -1.37550227e-02
  4.30320146e-02  9.72549784e-01]
  HOMO = -0.582721593251559  LUMO = 1.02542093071706
  mo_energy =
[-1.18579767e+02 -1.23094516e+01 -9.56083026e+00 -9.56083026e+00
 -9.56083026e+00 -1.26992503e+00 -5.82721593e-01 -5.82721593e-01
 -5.82721593e-01  1.02542093e+00  1.02542093e+00  1.02542093e+00
  1.03998873e+00  7.45091974e+00  7.45091974e+00  7.45091974e+00
  1.36178171e+01  3.43066255e+01  3.43066255e+01  3.43066255e+01
  1.22445849e+02  1.32192025e+02  1.32192025e+02  1.32192025e+02
  4.87480698e+02  4.87480698e+02  4.87480698e+02  6.61491730e+02
  1.33485539e+03  1.33485539e+03  1.33485539e+03  2.80144632e+03
  3.02234835e+03  3.02234835e+03  3.02234835e+03  6.63799143e+03
  6.63799143e+03  6.63799143e+03  9.22116962e+03  2.55689053e+04
  7.62992819e+04]
E1 = -728.3123377528071  E_coul = 201.56637065842284
cycle= 6 E= -526.745967094384  delta_E= -5.3e-11  |g|= 1.68e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3123377528071  E_coul = 201.56637065842284
  HOMO = -0.582721618283329  LUMO = 1.02542096684308
  mo_energy =
[-1.18579766e+02 -1.23094515e+01 -9.56083024e+00 -9.56083024e+00
 -9.56083024e+00 -1.26992469e+00 -5.82721618e-01 -5.82721618e-01
 -5.82721618e-01  1.02542097e+00  1.02542097e+00  1.02542097e+00
  1.03998906e+00  7.45091977e+00  7.45091977e+00  7.45091977e+00
  1.36178173e+01  3.43066255e+01  3.43066255e+01  3.43066255e+01
  1.22445849e+02  1.32192026e+02  1.32192026e+02  1.32192026e+02
  4.87480698e+02  4.87480698e+02  4.87480698e+02  6.61491731e+02
  1.33485539e+03  1.33485539e+03  1.33485539e+03  2.80144632e+03
  3.02234835e+03  3.02234835e+03  3.02234835e+03  6.63799143e+03
  6.63799143e+03  6.63799143e+03  9.22116962e+03  2.55689053e+04
  7.62992819e+04]
E1 = -728.3123369377324  E_coul = 201.5663698433463
Extra cycle  E= -526.745967094386  delta_E= -1.82e-12  |g|= 3.43e-07  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828237e+04 7.61712643e+03 3.61749888e+03 1.58895349e+03
 4.15179812e+02 1.22033148e+02 3.94217019e+01 8.54447530e+00
 3.36269913e+00 6.74773081e-01 2.49901733e-01 1.36283858e+03
 6.64206985e+02 2.98424200e+02 3.11854861e+02 6.29488743e+01
 7.48697458e+00 2.07084076e+01 7.82293378e-01 2.86824752e+00
 2.24031988e-01]
E = -526.7459670943861
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8237097        1
[INPUT] 0    0    [1    /1   ]  7617.12643425        1
[INPUT] 0    0    [1    /1   ]  3617.49887738        1
[INPUT] 0    0    [1    /1   ]  1588.953487          1
[INPUT] 0    0    [1    /1   ]  415.179812292        1
[INPUT] 0    0    [1    /1   ]  122.033148182        1
[INPUT] 0    0    [1    /1   ]  39.4217018526        1
[INPUT] 0    0    [1    /1   ]  8.54447530477        1
[INPUT] 0    0    [1    /1   ]  3.36269913013        1
[INPUT] 0    0    [1    /1   ]  0.67477308078        1
[INPUT] 0    0    [1    /1   ]  0.249901732564       1
[INPUT] 1    0    [1    /1   ]  1362.83857502        1
[INPUT] 1    0    [1    /1   ]  664.206984919        1
[INPUT] 1    0    [1    /1   ]  298.424199821        1
[INPUT] 1    0    [1    /1   ]  311.854860606        1
[INPUT] 1    0    [1    /1   ]  62.9488742744        1
[INPUT] 1    0    [1    /1   ]  7.48697458096        1
[INPUT] 1    0    [1    /1   ]  20.7084076456        1
[INPUT] 1    0    [1    /1   ]  0.782293378395       1
[INPUT] 1    0    [1    /1   ]  2.86824751908        1
[INPUT] 1    0    [1    /1   ]  0.224031987941       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.82370972112, 1.0]], [0, [7617.126434245631, 1.0]], [0, [3617.4988773827395, 1.0]], [0, [1588.9534869997342, 1.0]], [0, [415.17981229214377, 1.0]], [0, [122.03314818181072, 1.0]], [0, [39.421701852617986, 1.0]], [0, [8.544475304767344, 1.0]], [0, [3.3626991301349287, 1.0]], [0, [0.6747730807797684, 1.0]], [0, [0.24990173256442794, 1.0]], [1, [1362.8385750178845, 1.0]], [1, [664.2069849185577, 1.0]], [1, [298.42419982110994, 1.0]], [1, [311.8548606059114, 1.0]], [1, [62.94887427443187, 1.0]], [1, [7.486974580957521, 1.0]], [1, [20.70840764563161, 1.0]], [1, [0.7822933783952443, 1.0]], [1, [2.8682475190775647, 1.0]], [1, [0.22403198794121912, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.82370972]
bas 1, expnt(s) = [7617.12643425]
bas 2, expnt(s) = [3617.49887738]
bas 3, expnt(s) = [1588.953487]
bas 4, expnt(s) = [415.17981229]
bas 5, expnt(s) = [122.03314818]
bas 6, expnt(s) = [39.42170185]
bas 7, expnt(s) = [8.5444753]
bas 8, expnt(s) = [3.36269913]
bas 9, expnt(s) = [0.67477308]
bas 10, expnt(s) = [0.24990173]
bas 11, expnt(s) = [1362.83857502]
bas 12, expnt(s) = [664.20698492]
bas 13, expnt(s) = [298.42419982]
bas 14, expnt(s) = [311.85486061]
bas 15, expnt(s) = [62.94887427]
bas 16, expnt(s) = [7.48697458]
bas 17, expnt(s) = [20.70840765]
bas 18, expnt(s) = [0.78229338]
bas 19, expnt(s) = [2.86824752]
bas 20, expnt(s) = [0.22403199]
CPU time:       447.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828237e+04 5.20028787e+03 7.61712643e+03 2.05995815e+03
 3.61749888e+03 1.17847759e+03 1.58895349e+03 6.35840830e+02
 4.15179812e+02 2.32376494e+02 1.22033148e+02 9.27627010e+01
 3.94217019e+01 3.97481162e+01 8.54447530e+00 1.26263863e+01
 3.36269913e+00 6.27380524e+00 6.74773081e-01 1.88097635e+00
 2.49901733e-01 8.92980498e-01 1.36283858e+03 2.41568284e+04
 6.64206985e+02 9.83702308e+03 2.98424200e+02 3.61848636e+03
 3.11854861e+02 3.82318259e+03 6.29488743e+01 5.17272455e+02
 7.48697458e+00 3.61299484e+01 2.07084076e+01 1.28874732e+02
 7.82293378e-01 2.14632982e+00 2.86824752e+00 1.08894307e+01
 2.24031988e-01 4.49647241e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993233031482553
cond(S) = 98351.47026120531
E1 = -729.5328692069023  E_coul = 203.1802803029845
init E= -526.352588903918
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555730545462246  LUMO = 1.04409531639855
  mo_energy =
[-1.18331856e+02 -1.22046456e+01 -9.44672550e+00 -9.44672550e+00
 -9.44672550e+00 -1.23994823e+00 -5.55730545e-01 -5.55730545e-01
 -5.55730545e-01  1.04409532e+00  1.04409532e+00  1.04409532e+00
  1.06214476e+00  7.52217255e+00  7.52217255e+00  7.52217255e+00
  1.37050717e+01  3.44269750e+01  3.44269750e+01  3.44269750e+01
  1.22625242e+02  1.32372290e+02  1.32372290e+02  1.32372290e+02
  4.87727592e+02  4.87727592e+02  4.87727592e+02  6.61782570e+02
  1.33515420e+03  1.33515420e+03  1.33515420e+03  2.80187665e+03
  3.02271066e+03  3.02271066e+03  3.02271066e+03  6.63846423e+03
  6.63846423e+03  6.63846423e+03  9.22171527e+03  2.55695442e+04
  7.63000104e+04]
E1 = -727.8705232018115  E_coul = 201.1253213550813
cycle= 1 E= -526.74520184673  delta_E= -0.393  |g|= 0.185  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538507
diis-c [-0.28998951  1.        ]
  HOMO = -0.590268273513481  LUMO = 1.01975754579087
  mo_energy =
[-1.18636935e+02 -1.23414063e+01 -9.59406824e+00 -9.59406824e+00
 -9.59406824e+00 -1.27907621e+00 -5.90268274e-01 -5.90268274e-01
 -5.90268274e-01  1.01975755e+00  1.01975755e+00  1.01975755e+00
  1.03286406e+00  7.43086131e+00  7.43086131e+00  7.43086131e+00
  1.35915405e+01  3.42727493e+01  3.42727493e+01  3.42727493e+01
  1.22397471e+02  1.32144759e+02  1.32144759e+02  1.32144759e+02
  4.87424255e+02  4.87424255e+02  4.87424255e+02  6.61432820e+02
  1.33479553e+03  1.33479553e+03  1.33479553e+03  2.80138375e+03
  3.02228664e+03  3.02228664e+03  3.02228664e+03  6.63792838e+03
  6.63792838e+03  6.63792838e+03  9.22110597e+03  2.55688413e+04
  7.62992177e+04]
E1 = -728.4385337494884  E_coul = 201.69262620843813
cycle= 2 E= -526.74590754105  delta_E= -0.000706  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.074489
diis-c [-0.00325634  0.08207328  0.91792672]
  HOMO = -0.581250537266818  LUMO = 1.0264933772849
  mo_energy =
[-1.18569905e+02 -1.23037397e+01 -9.55476140e+00 -9.55476140e+00
 -9.55476140e+00 -1.26828319e+00 -5.81250537e-01 -5.81250537e-01
 -5.81250537e-01  1.02649338e+00  1.02649338e+00  1.02649338e+00
  1.04124050e+00  7.45468234e+00  7.45468234e+00  7.45468234e+00
  1.36225325e+01  3.43127616e+01  3.43127616e+01  3.43127616e+01
  1.22454250e+02  1.32200307e+02  1.32200307e+02  1.32200307e+02
  4.87490439e+02  4.87490439e+02  4.87490439e+02  6.61501917e+02
  1.33486572e+03  1.33486572e+03  1.33486572e+03  2.80145731e+03
  3.02235908e+03  3.02235908e+03  3.02235908e+03  6.63800256e+03
  6.63800256e+03  6.63800256e+03  9.22118097e+03  2.55689169e+04
  7.62992936e+04]
E1 = -728.2899078673123  E_coul = 201.54394265818598
cycle= 3 E= -526.745965209126  delta_E= -5.77e-05  |g|= 0.00623  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130592
diis-c [-5.39171615e-07 -1.21961767e-03  1.44813993e-01  8.56405625e-01]
  HOMO = -0.582732401251986  LUMO = 1.02541019490329
  mo_energy =
[-1.18579775e+02 -1.23094924e+01 -9.56085615e+00 -9.56085615e+00
 -9.56085615e+00 -1.26995880e+00 -5.82732401e-01 -5.82732401e-01
 -5.82732401e-01  1.02541019e+00  1.02541019e+00  1.02541019e+00
  1.03995909e+00  7.45089522e+00  7.45089522e+00  7.45089522e+00
  1.36177772e+01  3.43066010e+01  3.43066010e+01  3.43066010e+01
  1.22445827e+02  1.32192007e+02  1.32192007e+02  1.32192007e+02
  4.87480688e+02  4.87480688e+02  4.87480688e+02  6.61491730e+02
  1.33485539e+03  1.33485539e+03  1.33485539e+03  2.80144634e+03
  3.02234836e+03  3.02234836e+03  3.02234836e+03  6.63799146e+03
  6.63799146e+03  6.63799146e+03  9.22116965e+03  2.55689054e+04
  7.62992820e+04]
E1 = -728.3124628165241  E_coul = 201.56649572371344
cycle= 4 E= -526.745967092811  delta_E= -1.88e-06  |g|= 9.39e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109528
diis-c [-3.81937340e-09  6.89586178e-05 -9.96405150e-03 -6.47024580e-02
  1.07459755e+00]
  HOMO = -0.582714462802543  LUMO = 1.02542572201876
  mo_energy =
[-1.18579737e+02 -1.23094299e+01 -9.56080668e+00 -9.56080668e+00
 -9.56080668e+00 -1.26991933e+00 -5.82714463e-01 -5.82714463e-01
 -5.82714463e-01  1.02542572e+00  1.02542572e+00  1.02542572e+00
  1.03999269e+00  7.45093588e+00  7.45093588e+00  7.45093588e+00
  1.36178352e+01  3.43066485e+01  3.43066485e+01  3.43066485e+01
  1.22445876e+02  1.32192052e+02  1.32192052e+02  1.32192052e+02
  4.87480727e+02  4.87480727e+02  4.87480727e+02  6.61491761e+02
  1.33485542e+03  1.33485542e+03  1.33485542e+03  2.80144635e+03
  3.02234838e+03  3.02234838e+03  3.02234838e+03  6.63799146e+03
  6.63799146e+03  6.63799146e+03  9.22116965e+03  2.55689054e+04
  7.62992820e+04]
E1 = -728.3122590731903  E_coul = 201.56629197885897
cycle= 5 E= -526.745967094331  delta_E= -1.52e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.78444e-05
diis-c [-6.72093976e-11  1.39883576e-05 -1.84076478e-03 -1.37550227e-02
  4.30320146e-02  9.72549784e-01]
  HOMO = -0.582721593251559  LUMO = 1.02542093071706
  mo_energy =
[-1.18579767e+02 -1.23094516e+01 -9.56083026e+00 -9.56083026e+00
 -9.56083026e+00 -1.26992503e+00 -5.82721593e-01 -5.82721593e-01
 -5.82721593e-01  1.02542093e+00  1.02542093e+00  1.02542093e+00
  1.03998873e+00  7.45091974e+00  7.45091974e+00  7.45091974e+00
  1.36178171e+01  3.43066255e+01  3.43066255e+01  3.43066255e+01
  1.22445849e+02  1.32192025e+02  1.32192025e+02  1.32192025e+02
  4.87480698e+02  4.87480698e+02  4.87480698e+02  6.61491730e+02
  1.33485539e+03  1.33485539e+03  1.33485539e+03  2.80144632e+03
  3.02234835e+03  3.02234835e+03  3.02234835e+03  6.63799143e+03
  6.63799143e+03  6.63799143e+03  9.22116962e+03  2.55689053e+04
  7.62992819e+04]
E1 = -728.3123377528071  E_coul = 201.56637065842284
cycle= 6 E= -526.745967094384  delta_E= -5.3e-11  |g|= 1.68e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3123377528071  E_coul = 201.56637065842284
  HOMO = -0.582721618283329  LUMO = 1.02542096684308
  mo_energy =
[-1.18579766e+02 -1.23094515e+01 -9.56083024e+00 -9.56083024e+00
 -9.56083024e+00 -1.26992469e+00 -5.82721618e-01 -5.82721618e-01
 -5.82721618e-01  1.02542097e+00  1.02542097e+00  1.02542097e+00
  1.03998906e+00  7.45091977e+00  7.45091977e+00  7.45091977e+00
  1.36178173e+01  3.43066255e+01  3.43066255e+01  3.43066255e+01
  1.22445849e+02  1.32192026e+02  1.32192026e+02  1.32192026e+02
  4.87480698e+02  4.87480698e+02  4.87480698e+02  6.61491731e+02
  1.33485539e+03  1.33485539e+03  1.33485539e+03  2.80144632e+03
  3.02234835e+03  3.02234835e+03  3.02234835e+03  6.63799143e+03
  6.63799143e+03  6.63799143e+03  9.22116962e+03  2.55689053e+04
  7.62992819e+04]
E1 = -728.3123369377324  E_coul = 201.5663698433463
Extra cycle  E= -526.745967094386  delta_E= -1.82e-12  |g|= 3.43e-07  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98351.47026120531
E1 = -728.3123369377324  E_coul = 201.5663698433463
init E= -526.745967094386
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582721644756796  LUMO = 1.02542095904396
  mo_energy =
[-1.18579767e+02 -1.23094515e+01 -9.56083031e+00 -9.56083031e+00
 -9.56083031e+00 -1.26992464e+00 -5.82721645e-01 -5.82721645e-01
 -5.82721645e-01  1.02542096e+00  1.02542096e+00  1.02542096e+00
  1.03998911e+00  7.45091972e+00  7.45091972e+00  7.45091972e+00
  1.36178173e+01  3.43066255e+01  3.43066255e+01  3.43066255e+01
  1.22445849e+02  1.32192025e+02  1.32192025e+02  1.32192025e+02
  4.87480698e+02  4.87480698e+02  4.87480698e+02  6.61491730e+02
  1.33485539e+03  1.33485539e+03  1.33485539e+03  2.80144632e+03
  3.02234835e+03  3.02234835e+03  3.02234835e+03  6.63799143e+03
  6.63799143e+03  6.63799143e+03  9.22116962e+03  2.55689053e+04
  7.62992819e+04]
E1 = -728.3123370653162  E_coul = 201.56636997093003
cycle= 1 E= -526.745967094386  delta_E= -1.14e-13  |g|= 7.13e-08  |ddm|= 5.68e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3123370653162  E_coul = 201.56636997093003
  HOMO = -0.582721644634369  LUMO = 1.02542096147689
  mo_energy =
[-1.18579767e+02 -1.23094515e+01 -9.56083031e+00 -9.56083031e+00
 -9.56083031e+00 -1.26992463e+00 -5.82721645e-01 -5.82721645e-01
 -5.82721645e-01  1.02542096e+00  1.02542096e+00  1.02542096e+00
  1.03998912e+00  7.45091973e+00  7.45091973e+00  7.45091973e+00
  1.36178173e+01  3.43066255e+01  3.43066255e+01  3.43066255e+01
  1.22445849e+02  1.32192025e+02  1.32192025e+02  1.32192025e+02
  4.87480698e+02  4.87480698e+02  4.87480698e+02  6.61491731e+02
  1.33485539e+03  1.33485539e+03  1.33485539e+03  2.80144632e+03
  3.02234835e+03  3.02234835e+03  3.02234835e+03  6.63799143e+03
  6.63799143e+03  6.63799143e+03  9.22116962e+03  2.55689053e+04
  7.62992819e+04]
E1 = -728.3123370086827  E_coul = 201.56636991429755
Extra cycle  E= -526.745967094385  delta_E= 1.02e-12  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828237e+04 7.61712643e+03 3.61749888e+03 1.58895349e+03
 4.15179812e+02 1.22033148e+02 3.94217019e+01 8.54447530e+00
 3.36269913e+00 6.74773081e-01 2.49901733e-01 1.36283858e+03
 6.64206985e+02 2.98424200e+02 3.11854861e+02 6.29488743e+01
 7.48697458e+00 2.07084076e+01 7.82293378e-01 2.86824752e+00
 2.24031988e-01]
grad_E = [-1.41412360e-06  2.29907853e-06 -2.14020217e-06  4.13144993e-05
 -3.82611543e-05  8.04805327e-05  5.08114411e-05  2.99454747e-04
 -6.16143009e-04  2.66763842e-04 -3.65386686e-04 -5.82566447e-07
  4.12953866e-06  1.89526959e-05  1.61918109e-05  3.65907291e-05
 -9.73350013e-04  3.08147136e-04  1.29453058e-03  1.27461403e-03
 -3.41902020e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.834739         1
[INPUT] 0    0    [1    /1   ]  7617.10032705        1
[INPUT] 0    0    [1    /1   ]  3617.50849551        1
[INPUT] 0    0    [1    /1   ]  1588.36525321        1
[INPUT] 0    0    [1    /1   ]  417.462640323        1
[INPUT] 0    0    [1    /1   ]  122.415216409        1
[INPUT] 0    0    [1    /1   ]  39.4543789698        1
[INPUT] 0    0    [1    /1   ]  8.51625028296        1
[INPUT] 0    0    [1    /1   ]  3.35830827459        1
[INPUT] 0    0    [1    /1   ]  0.674441092515       1
[INPUT] 0    0    [1    /1   ]  0.249823177918       1
[INPUT] 1    0    [1    /1   ]  1362.84221368        1
[INPUT] 1    0    [1    /1   ]  664.171696611        1
[INPUT] 1    0    [1    /1   ]  298.25801316         1
[INPUT] 1    0    [1    /1   ]  311.711623057        1
[INPUT] 1    0    [1    /1   ]  63.0195239881        1
[INPUT] 1    0    [1    /1   ]  7.51704430572        1
[INPUT] 1    0    [1    /1   ]  20.7708769321        1
[INPUT] 1    0    [1    /1   ]  0.782951910497       1
[INPUT] 1    0    [1    /1   ]  2.87469476592        1
[INPUT] 1    0    [1    /1   ]  0.224227413274       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.834739034646, 1.0]], [0, [7617.100327048049, 1.0]], [0, [3617.508495510532, 1.0]], [0, [1588.3652532124947, 1.0]], [0, [417.4626403228247, 1.0]], [0, [122.4152164089088, 1.0]], [0, [39.4543789697849, 1.0]], [0, [8.516250282961083, 1.0]], [0, [3.3583082745901267, 1.0]], [0, [0.6744410925153654, 1.0]], [0, [0.24982317791813785, 1.0]], [1, [1362.8422136804743, 1.0]], [1, [664.1716966111431, 1.0]], [1, [298.25801316013536, 1.0]], [1, [311.7116230569071, 1.0]], [1, [63.01952398810714, 1.0]], [1, [7.517044305717357, 1.0]], [1, [20.77087693207533, 1.0]], [1, [0.7829519104970786, 1.0]], [1, [2.8746947659201423, 1.0]], [1, [0.22422741327398704, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83473903]
bas 1, expnt(s) = [7617.10032705]
bas 2, expnt(s) = [3617.50849551]
bas 3, expnt(s) = [1588.36525321]
bas 4, expnt(s) = [417.46264032]
bas 5, expnt(s) = [122.41521641]
bas 6, expnt(s) = [39.45437897]
bas 7, expnt(s) = [8.51625028]
bas 8, expnt(s) = [3.35830827]
bas 9, expnt(s) = [0.67444109]
bas 10, expnt(s) = [0.24982318]
bas 11, expnt(s) = [1362.84221368]
bas 12, expnt(s) = [664.17169661]
bas 13, expnt(s) = [298.25801316]
bas 14, expnt(s) = [311.71162306]
bas 15, expnt(s) = [63.01952399]
bas 16, expnt(s) = [7.51704431]
bas 17, expnt(s) = [20.77087693]
bas 18, expnt(s) = [0.78295191]
bas 19, expnt(s) = [2.87469477]
bas 20, expnt(s) = [0.22422741]
CPU time:       452.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828347e+04 5.20028951e+03 7.61710033e+03 2.05995286e+03
 3.61750850e+03 1.17847994e+03 1.58836525e+03 6.35664280e+02
 4.17462640e+02 2.33334113e+02 1.22415216e+02 9.29804359e+01
 3.94543790e+01 3.97728244e+01 8.51625028e+00 1.25950918e+01
 3.35830827e+00 6.26766021e+00 6.74441093e-01 1.88028223e+00
 2.49823178e-01 8.92769964e-01 1.36284221e+03 2.41569090e+04
 6.64171697e+02 9.83636981e+03 2.98258013e+02 3.61596771e+03
 3.11711623e+02 3.82098769e+03 6.30195240e+01 5.17998248e+02
 7.51704431e+00 3.63114239e+01 2.07708769e+01 1.29360872e+02
 7.82951910e-01 2.14858853e+00 2.87469477e+00 1.09200359e+01
 2.24227413e-01 4.50137584e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993205872475233
cond(S) = 98005.26379402001
E1 = -729.5318289517302  E_coul = 203.1799864148369
init E= -526.351842536893
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555717100180283  LUMO = 1.0454348586612
  mo_energy =
[-1.18331894e+02 -1.22046891e+01 -9.44676543e+00 -9.44676543e+00
 -9.44676543e+00 -1.23996005e+00 -5.55717100e-01 -5.55717100e-01
 -5.55717100e-01  1.04543486e+00  1.04543486e+00  1.04543486e+00
  1.06123619e+00  7.54495935e+00  7.54495935e+00  7.54495935e+00
  1.36608602e+01  3.45651184e+01  3.45651184e+01  3.45651184e+01
  1.22724813e+02  1.32733315e+02  1.32733315e+02  1.32733315e+02
  4.88128963e+02  4.88128963e+02  4.88128963e+02  6.64281755e+02
  1.33524184e+03  1.33524184e+03  1.33524184e+03  2.80876865e+03
  3.02234485e+03  3.02234485e+03  3.02234485e+03  6.63777484e+03
  6.63777484e+03  6.63777484e+03  9.22981625e+03  2.55773083e+04
  7.63071601e+04]
E1 = -727.8721122640774  E_coul = 201.12685365134706
cycle= 1 E= -526.74525861273  delta_E= -0.393  |g|= 0.184  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538164
diis-c [-0.28962065  1.        ]
  HOMO = -0.590181206728304  LUMO = 1.02111919735054
  mo_energy =
[-1.18636848e+02 -1.23413414e+01 -9.59398293e+00 -9.59398293e+00
 -9.59398293e+00 -1.27900652e+00 -5.90181207e-01 -5.90181207e-01
 -5.90181207e-01  1.02111920e+00  1.02111920e+00  1.02111920e+00
  1.03205280e+00  7.45357905e+00  7.45357905e+00  7.45357905e+00
  1.35475755e+01  3.44108061e+01  3.44108061e+01  3.44108061e+01
  1.22497053e+02  1.32505840e+02  1.32505840e+02  1.32505840e+02
  4.87825811e+02  4.87825811e+02  4.87825811e+02  6.63931681e+02
  1.33488334e+03  1.33488334e+03  1.33488334e+03  2.80827571e+03
  3.02192095e+03  3.02192095e+03  3.02192095e+03  6.63723910e+03
  6.63723910e+03  6.63723910e+03  9.22920710e+03  2.55766056e+04
  7.63063676e+04]
E1 = -728.4394281470253  E_coul = 201.69346519431608
cycle= 2 E= -526.745962952709  delta_E= -0.000704  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744303
diis-c [-0.00324868  0.08210299  0.91789701]
  HOMO = -0.581176322300514  LUMO = 1.02785455376704
  mo_energy =
[-1.18569891e+02 -1.23037243e+01 -9.55472609e+00 -9.55472609e+00
 -9.55472609e+00 -1.26822940e+00 -5.81176322e-01 -5.81176322e-01
 -5.81176322e-01  1.02785455e+00  1.02785455e+00  1.02785455e+00
  1.04040970e+00  7.47741379e+00  7.47741379e+00  7.47741379e+00
  1.35784856e+01  3.44508188e+01  3.44508188e+01  3.44508188e+01
  1.22553796e+02  1.32561339e+02  1.32561339e+02  1.32561339e+02
  4.87891918e+02  4.87891918e+02  4.87891918e+02  6.64000729e+02
  1.33495345e+03  1.33495345e+03  1.33495345e+03  2.80834920e+03
  3.02199331e+03  3.02199331e+03  3.02199331e+03  6.63731321e+03
  6.63731321e+03  6.63731321e+03  9.22928202e+03  2.55766810e+04
  7.63064433e+04]
E1 = -728.2910552419315  E_coul = 201.5450347794342
cycle= 3 E= -526.746020462497  delta_E= -5.75e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130384
diis-c [-5.36410802e-07 -1.21920630e-03  1.44709272e-01  8.56509934e-01]
  HOMO = -0.582654594008107  LUMO = 1.02677255498338
  mo_energy =
[-1.18579744e+02 -1.23094655e+01 -9.56080881e+00 -9.56080881e+00
 -9.56080881e+00 -1.26990081e+00 -5.82654594e-01 -5.82654594e-01
 -5.82654594e-01  1.02677255e+00  1.02677255e+00  1.02677255e+00
  1.03913269e+00  7.47362787e+00  7.47362787e+00  7.47362787e+00
  1.35737460e+01  3.44446631e+01  3.44446631e+01  3.44446631e+01
  1.22545385e+02  1.32553051e+02  1.32553051e+02  1.32553051e+02
  4.87882186e+02  4.87882186e+02  4.87882186e+02  6.63990556e+02
  1.33494314e+03  1.33494314e+03  1.33494314e+03  2.80833825e+03
  3.02198261e+03  3.02198261e+03  3.02198261e+03  6.63730212e+03
  6.63730212e+03  6.63730212e+03  9.22927073e+03  2.55766696e+04
  7.63064317e+04]
E1 = -728.3135544180288  E_coul = 201.56753208038768
cycle= 4 E= -526.746022337641  delta_E= -1.88e-06  |g|= 9.37e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109322
diis-c [-3.79237880e-09  6.89949888e-05 -9.96905024e-03 -6.47847124e-02
  1.07468477e+00]
  HOMO = -0.58263673279135  LUMO = 1.02678804060164
  mo_energy =
[-1.18579705e+02 -1.23094033e+01 -9.56075959e+00 -9.56075959e+00
 -9.56075959e+00 -1.26986145e+00 -5.82636733e-01 -5.82636733e-01
 -5.82636733e-01  1.02678804e+00  1.02678804e+00  1.02678804e+00
  1.03916618e+00  7.47366838e+00  7.47366838e+00  7.47366838e+00
  1.35738037e+01  3.44447104e+01  3.44447104e+01  3.44447104e+01
  1.22545434e+02  1.32553097e+02  1.32553097e+02  1.32553097e+02
  4.87882224e+02  4.87882224e+02  4.87882224e+02  6.63990586e+02
  1.33494317e+03  1.33494317e+03  1.33494317e+03  2.80833826e+03
  3.02198263e+03  3.02198263e+03  3.02198263e+03  6.63730213e+03
  6.63730213e+03  6.63730213e+03  9.22927072e+03  2.55766696e+04
  7.63064317e+04]
E1 = -728.3133515983266  E_coul = 201.56732925916882
cycle= 5 E= -526.746022339158  delta_E= -1.52e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77225e-05
diis-c [-6.70763961e-11  1.39744521e-05 -1.83729168e-03 -1.37386673e-02
  4.28039920e-02  9.72757993e-01]
  HOMO = -0.582643842073748  LUMO = 1.02678325767475
  mo_energy =
[-1.18579735e+02 -1.23094250e+01 -9.56078310e+00 -9.56078310e+00
 -9.56078310e+00 -1.26986713e+00 -5.82643842e-01 -5.82643842e-01
 -5.82643842e-01  1.02678326e+00  1.02678326e+00  1.02678326e+00
  1.03916224e+00  7.47365226e+00  7.47365226e+00  7.47365226e+00
  1.35737857e+01  3.44446874e+01  3.44446874e+01  3.44446874e+01
  1.22545407e+02  1.32553070e+02  1.32553070e+02  1.32553070e+02
  4.87882195e+02  4.87882195e+02  4.87882195e+02  6.63990556e+02
  1.33494314e+03  1.33494314e+03  1.33494314e+03  2.80833822e+03
  3.02198260e+03  3.02198260e+03  3.02198260e+03  6.63730209e+03
  6.63730209e+03  6.63730209e+03  9.22927069e+03  2.55766695e+04
  7.63064317e+04]
E1 = -728.3134299519206  E_coul = 201.56740761270856
cycle= 6 E= -526.746022339212  delta_E= -5.42e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3134299519206  E_coul = 201.56740761270856
  HOMO = -0.582643866044217  LUMO = 1.02678329441595
  mo_energy =
[-1.18579735e+02 -1.23094249e+01 -9.56078307e+00 -9.56078307e+00
 -9.56078307e+00 -1.26986679e+00 -5.82643866e-01 -5.82643866e-01
 -5.82643866e-01  1.02678329e+00  1.02678329e+00  1.02678329e+00
  1.03916257e+00  7.47365229e+00  7.47365229e+00  7.47365229e+00
  1.35737858e+01  3.44446875e+01  3.44446875e+01  3.44446875e+01
  1.22545407e+02  1.32553070e+02  1.32553070e+02  1.32553070e+02
  4.87882195e+02  4.87882195e+02  4.87882195e+02  6.63990556e+02
  1.33494314e+03  1.33494314e+03  1.33494314e+03  2.80833822e+03
  3.02198260e+03  3.02198260e+03  3.02198260e+03  6.63730209e+03
  6.63730209e+03  6.63730209e+03  9.22927069e+03  2.55766695e+04
  7.63064317e+04]
E1 = -728.3134291167421  E_coul = 201.56740677753018
Extra cycle  E= -526.746022339212  delta_E= 1.14e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828347e+04 7.61710033e+03 3.61750850e+03 1.58836525e+03
 4.17462640e+02 1.22415216e+02 3.94543790e+01 8.51625028e+00
 3.35830827e+00 6.74441093e-01 2.49823178e-01 1.36284221e+03
 6.64171697e+02 2.98258013e+02 3.11711623e+02 6.30195240e+01
 7.51704431e+00 2.07708769e+01 7.82951910e-01 2.87469477e+00
 2.24227413e-01]
E = -526.7460223392119
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.834739         1
[INPUT] 0    0    [1    /1   ]  7617.10032705        1
[INPUT] 0    0    [1    /1   ]  3617.50849551        1
[INPUT] 0    0    [1    /1   ]  1588.36525321        1
[INPUT] 0    0    [1    /1   ]  417.462640323        1
[INPUT] 0    0    [1    /1   ]  122.415216409        1
[INPUT] 0    0    [1    /1   ]  39.4543789698        1
[INPUT] 0    0    [1    /1   ]  8.51625028296        1
[INPUT] 0    0    [1    /1   ]  3.35830827459        1
[INPUT] 0    0    [1    /1   ]  0.674441092515       1
[INPUT] 0    0    [1    /1   ]  0.249823177918       1
[INPUT] 1    0    [1    /1   ]  1362.84221368        1
[INPUT] 1    0    [1    /1   ]  664.171696611        1
[INPUT] 1    0    [1    /1   ]  298.25801316         1
[INPUT] 1    0    [1    /1   ]  311.711623057        1
[INPUT] 1    0    [1    /1   ]  63.0195239881        1
[INPUT] 1    0    [1    /1   ]  7.51704430572        1
[INPUT] 1    0    [1    /1   ]  20.7708769321        1
[INPUT] 1    0    [1    /1   ]  0.782951910497       1
[INPUT] 1    0    [1    /1   ]  2.87469476592        1
[INPUT] 1    0    [1    /1   ]  0.224227413274       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.834739034646, 1.0]], [0, [7617.100327048049, 1.0]], [0, [3617.508495510532, 1.0]], [0, [1588.3652532124947, 1.0]], [0, [417.4626403228247, 1.0]], [0, [122.4152164089088, 1.0]], [0, [39.4543789697849, 1.0]], [0, [8.516250282961083, 1.0]], [0, [3.3583082745901267, 1.0]], [0, [0.6744410925153654, 1.0]], [0, [0.24982317791813785, 1.0]], [1, [1362.8422136804743, 1.0]], [1, [664.1716966111431, 1.0]], [1, [298.25801316013536, 1.0]], [1, [311.7116230569071, 1.0]], [1, [63.01952398810714, 1.0]], [1, [7.517044305717357, 1.0]], [1, [20.77087693207533, 1.0]], [1, [0.7829519104970786, 1.0]], [1, [2.8746947659201423, 1.0]], [1, [0.22422741327398704, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83473903]
bas 1, expnt(s) = [7617.10032705]
bas 2, expnt(s) = [3617.50849551]
bas 3, expnt(s) = [1588.36525321]
bas 4, expnt(s) = [417.46264032]
bas 5, expnt(s) = [122.41521641]
bas 6, expnt(s) = [39.45437897]
bas 7, expnt(s) = [8.51625028]
bas 8, expnt(s) = [3.35830827]
bas 9, expnt(s) = [0.67444109]
bas 10, expnt(s) = [0.24982318]
bas 11, expnt(s) = [1362.84221368]
bas 12, expnt(s) = [664.17169661]
bas 13, expnt(s) = [298.25801316]
bas 14, expnt(s) = [311.71162306]
bas 15, expnt(s) = [63.01952399]
bas 16, expnt(s) = [7.51704431]
bas 17, expnt(s) = [20.77087693]
bas 18, expnt(s) = [0.78295191]
bas 19, expnt(s) = [2.87469477]
bas 20, expnt(s) = [0.22422741]
CPU time:       453.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828347e+04 5.20028951e+03 7.61710033e+03 2.05995286e+03
 3.61750850e+03 1.17847994e+03 1.58836525e+03 6.35664280e+02
 4.17462640e+02 2.33334113e+02 1.22415216e+02 9.29804359e+01
 3.94543790e+01 3.97728244e+01 8.51625028e+00 1.25950918e+01
 3.35830827e+00 6.26766021e+00 6.74441093e-01 1.88028223e+00
 2.49823178e-01 8.92769964e-01 1.36284221e+03 2.41569090e+04
 6.64171697e+02 9.83636981e+03 2.98258013e+02 3.61596771e+03
 3.11711623e+02 3.82098769e+03 6.30195240e+01 5.17998248e+02
 7.51704431e+00 3.63114239e+01 2.07708769e+01 1.29360872e+02
 7.82951910e-01 2.14858853e+00 2.87469477e+00 1.09200359e+01
 2.24227413e-01 4.50137584e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993205872475233
cond(S) = 98005.26379402001
E1 = -729.5318289517302  E_coul = 203.1799864148369
init E= -526.351842536893
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555717100180283  LUMO = 1.0454348586612
  mo_energy =
[-1.18331894e+02 -1.22046891e+01 -9.44676543e+00 -9.44676543e+00
 -9.44676543e+00 -1.23996005e+00 -5.55717100e-01 -5.55717100e-01
 -5.55717100e-01  1.04543486e+00  1.04543486e+00  1.04543486e+00
  1.06123619e+00  7.54495935e+00  7.54495935e+00  7.54495935e+00
  1.36608602e+01  3.45651184e+01  3.45651184e+01  3.45651184e+01
  1.22724813e+02  1.32733315e+02  1.32733315e+02  1.32733315e+02
  4.88128963e+02  4.88128963e+02  4.88128963e+02  6.64281755e+02
  1.33524184e+03  1.33524184e+03  1.33524184e+03  2.80876865e+03
  3.02234485e+03  3.02234485e+03  3.02234485e+03  6.63777484e+03
  6.63777484e+03  6.63777484e+03  9.22981625e+03  2.55773083e+04
  7.63071601e+04]
E1 = -727.8721122640774  E_coul = 201.12685365134706
cycle= 1 E= -526.74525861273  delta_E= -0.393  |g|= 0.184  |ddm|= 0.313
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538164
diis-c [-0.28962065  1.        ]
  HOMO = -0.590181206728304  LUMO = 1.02111919735054
  mo_energy =
[-1.18636848e+02 -1.23413414e+01 -9.59398293e+00 -9.59398293e+00
 -9.59398293e+00 -1.27900652e+00 -5.90181207e-01 -5.90181207e-01
 -5.90181207e-01  1.02111920e+00  1.02111920e+00  1.02111920e+00
  1.03205280e+00  7.45357905e+00  7.45357905e+00  7.45357905e+00
  1.35475755e+01  3.44108061e+01  3.44108061e+01  3.44108061e+01
  1.22497053e+02  1.32505840e+02  1.32505840e+02  1.32505840e+02
  4.87825811e+02  4.87825811e+02  4.87825811e+02  6.63931681e+02
  1.33488334e+03  1.33488334e+03  1.33488334e+03  2.80827571e+03
  3.02192095e+03  3.02192095e+03  3.02192095e+03  6.63723910e+03
  6.63723910e+03  6.63723910e+03  9.22920710e+03  2.55766056e+04
  7.63063676e+04]
E1 = -728.4394281470253  E_coul = 201.69346519431608
cycle= 2 E= -526.745962952709  delta_E= -0.000704  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744303
diis-c [-0.00324868  0.08210299  0.91789701]
  HOMO = -0.581176322300514  LUMO = 1.02785455376704
  mo_energy =
[-1.18569891e+02 -1.23037243e+01 -9.55472609e+00 -9.55472609e+00
 -9.55472609e+00 -1.26822940e+00 -5.81176322e-01 -5.81176322e-01
 -5.81176322e-01  1.02785455e+00  1.02785455e+00  1.02785455e+00
  1.04040970e+00  7.47741379e+00  7.47741379e+00  7.47741379e+00
  1.35784856e+01  3.44508188e+01  3.44508188e+01  3.44508188e+01
  1.22553796e+02  1.32561339e+02  1.32561339e+02  1.32561339e+02
  4.87891918e+02  4.87891918e+02  4.87891918e+02  6.64000729e+02
  1.33495345e+03  1.33495345e+03  1.33495345e+03  2.80834920e+03
  3.02199331e+03  3.02199331e+03  3.02199331e+03  6.63731321e+03
  6.63731321e+03  6.63731321e+03  9.22928202e+03  2.55766810e+04
  7.63064433e+04]
E1 = -728.2910552419315  E_coul = 201.5450347794342
cycle= 3 E= -526.746020462497  delta_E= -5.75e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130384
diis-c [-5.36410802e-07 -1.21920630e-03  1.44709272e-01  8.56509934e-01]
  HOMO = -0.582654594008107  LUMO = 1.02677255498338
  mo_energy =
[-1.18579744e+02 -1.23094655e+01 -9.56080881e+00 -9.56080881e+00
 -9.56080881e+00 -1.26990081e+00 -5.82654594e-01 -5.82654594e-01
 -5.82654594e-01  1.02677255e+00  1.02677255e+00  1.02677255e+00
  1.03913269e+00  7.47362787e+00  7.47362787e+00  7.47362787e+00
  1.35737460e+01  3.44446631e+01  3.44446631e+01  3.44446631e+01
  1.22545385e+02  1.32553051e+02  1.32553051e+02  1.32553051e+02
  4.87882186e+02  4.87882186e+02  4.87882186e+02  6.63990556e+02
  1.33494314e+03  1.33494314e+03  1.33494314e+03  2.80833825e+03
  3.02198261e+03  3.02198261e+03  3.02198261e+03  6.63730212e+03
  6.63730212e+03  6.63730212e+03  9.22927073e+03  2.55766696e+04
  7.63064317e+04]
E1 = -728.3135544180288  E_coul = 201.56753208038768
cycle= 4 E= -526.746022337641  delta_E= -1.88e-06  |g|= 9.37e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109322
diis-c [-3.79237880e-09  6.89949888e-05 -9.96905024e-03 -6.47847124e-02
  1.07468477e+00]
  HOMO = -0.58263673279135  LUMO = 1.02678804060164
  mo_energy =
[-1.18579705e+02 -1.23094033e+01 -9.56075959e+00 -9.56075959e+00
 -9.56075959e+00 -1.26986145e+00 -5.82636733e-01 -5.82636733e-01
 -5.82636733e-01  1.02678804e+00  1.02678804e+00  1.02678804e+00
  1.03916618e+00  7.47366838e+00  7.47366838e+00  7.47366838e+00
  1.35738037e+01  3.44447104e+01  3.44447104e+01  3.44447104e+01
  1.22545434e+02  1.32553097e+02  1.32553097e+02  1.32553097e+02
  4.87882224e+02  4.87882224e+02  4.87882224e+02  6.63990586e+02
  1.33494317e+03  1.33494317e+03  1.33494317e+03  2.80833826e+03
  3.02198263e+03  3.02198263e+03  3.02198263e+03  6.63730213e+03
  6.63730213e+03  6.63730213e+03  9.22927072e+03  2.55766696e+04
  7.63064317e+04]
E1 = -728.3133515983266  E_coul = 201.56732925916882
cycle= 5 E= -526.746022339158  delta_E= -1.52e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77225e-05
diis-c [-6.70763961e-11  1.39744521e-05 -1.83729168e-03 -1.37386673e-02
  4.28039920e-02  9.72757993e-01]
  HOMO = -0.582643842073748  LUMO = 1.02678325767475
  mo_energy =
[-1.18579735e+02 -1.23094250e+01 -9.56078310e+00 -9.56078310e+00
 -9.56078310e+00 -1.26986713e+00 -5.82643842e-01 -5.82643842e-01
 -5.82643842e-01  1.02678326e+00  1.02678326e+00  1.02678326e+00
  1.03916224e+00  7.47365226e+00  7.47365226e+00  7.47365226e+00
  1.35737857e+01  3.44446874e+01  3.44446874e+01  3.44446874e+01
  1.22545407e+02  1.32553070e+02  1.32553070e+02  1.32553070e+02
  4.87882195e+02  4.87882195e+02  4.87882195e+02  6.63990556e+02
  1.33494314e+03  1.33494314e+03  1.33494314e+03  2.80833822e+03
  3.02198260e+03  3.02198260e+03  3.02198260e+03  6.63730209e+03
  6.63730209e+03  6.63730209e+03  9.22927069e+03  2.55766695e+04
  7.63064317e+04]
E1 = -728.3134299519206  E_coul = 201.56740761270856
cycle= 6 E= -526.746022339212  delta_E= -5.42e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3134299519206  E_coul = 201.56740761270856
  HOMO = -0.582643866044217  LUMO = 1.02678329441595
  mo_energy =
[-1.18579735e+02 -1.23094249e+01 -9.56078307e+00 -9.56078307e+00
 -9.56078307e+00 -1.26986679e+00 -5.82643866e-01 -5.82643866e-01
 -5.82643866e-01  1.02678329e+00  1.02678329e+00  1.02678329e+00
  1.03916257e+00  7.47365229e+00  7.47365229e+00  7.47365229e+00
  1.35737858e+01  3.44446875e+01  3.44446875e+01  3.44446875e+01
  1.22545407e+02  1.32553070e+02  1.32553070e+02  1.32553070e+02
  4.87882195e+02  4.87882195e+02  4.87882195e+02  6.63990556e+02
  1.33494314e+03  1.33494314e+03  1.33494314e+03  2.80833822e+03
  3.02198260e+03  3.02198260e+03  3.02198260e+03  6.63730209e+03
  6.63730209e+03  6.63730209e+03  9.22927069e+03  2.55766695e+04
  7.63064317e+04]
E1 = -728.3134291167421  E_coul = 201.56740677753018
Extra cycle  E= -526.746022339212  delta_E= 1.14e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 98005.26379402001
E1 = -728.3134291167421  E_coul = 201.56740677753018
init E= -526.746022339212
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.5826438929372  LUMO = 1.02678328625371
  mo_energy =
[-1.18579735e+02 -1.23094249e+01 -9.56078315e+00 -9.56078315e+00
 -9.56078315e+00 -1.26986674e+00 -5.82643893e-01 -5.82643893e-01
 -5.82643893e-01  1.02678329e+00  1.02678329e+00  1.02678329e+00
  1.03916262e+00  7.47365224e+00  7.47365224e+00  7.47365224e+00
  1.35737858e+01  3.44446874e+01  3.44446874e+01  3.44446874e+01
  1.22545407e+02  1.32553070e+02  1.32553070e+02  1.32553070e+02
  4.87882195e+02  4.87882195e+02  4.87882195e+02  6.63990556e+02
  1.33494314e+03  1.33494314e+03  1.33494314e+03  2.80833822e+03
  3.02198260e+03  3.02198260e+03  3.02198260e+03  6.63730209e+03
  6.63730209e+03  6.63730209e+03  9.22927069e+03  2.55766695e+04
  7.63064317e+04]
E1 = -728.3134292493427  E_coul = 201.5674069101303
cycle= 1 E= -526.746022339212  delta_E= -4.55e-13  |g|= 7.12e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3134292493427  E_coul = 201.5674069101303
  HOMO = -0.582643892725688  LUMO = 1.02678328874784
  mo_energy =
[-1.18579735e+02 -1.23094249e+01 -9.56078314e+00 -9.56078314e+00
 -9.56078314e+00 -1.26986673e+00 -5.82643893e-01 -5.82643893e-01
 -5.82643893e-01  1.02678329e+00  1.02678329e+00  1.02678329e+00
  1.03916263e+00  7.47365225e+00  7.47365225e+00  7.47365225e+00
  1.35737858e+01  3.44446874e+01  3.44446874e+01  3.44446874e+01
  1.22545407e+02  1.32553070e+02  1.32553070e+02  1.32553070e+02
  4.87882195e+02  4.87882195e+02  4.87882195e+02  6.63990556e+02
  1.33494314e+03  1.33494314e+03  1.33494314e+03  2.80833822e+03
  3.02198260e+03  3.02198260e+03  3.02198260e+03  6.63730209e+03
  6.63730209e+03  6.63730209e+03  9.22927069e+03  2.55766695e+04
  7.63064317e+04]
E1 = -728.3134291912249  E_coul = 201.56740685201305
Extra cycle  E= -526.746022339212  delta_E= 4.55e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828347e+04 7.61710033e+03 3.61750850e+03 1.58836525e+03
 4.17462640e+02 1.22415216e+02 3.94543790e+01 8.51625028e+00
 3.35830827e+00 6.74441093e-01 2.49823178e-01 1.36284221e+03
 6.64171697e+02 2.98258013e+02 3.11711623e+02 6.30195240e+01
 7.51704431e+00 2.07708769e+01 7.82951910e-01 2.87469477e+00
 2.24227413e-01]
grad_E = [-1.40220789e-06  2.19902378e-06 -2.14080722e-06  3.81955670e-05
 -5.87102174e-06  3.13366147e-05  9.33174011e-06  1.08733571e-04
 -2.14934151e-04  8.77551347e-05 -1.46854805e-04 -5.84275503e-07
  4.11625312e-06  1.88979771e-05  1.61358230e-05  3.04100501e-05
 -2.24587389e-04  2.09641348e-04  3.07811625e-04  2.78919654e-04
 -8.61609202e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.838189         1
[INPUT] 0    0    [1    /1   ]  7617.09212719        1
[INPUT] 0    0    [1    /1   ]  3617.51147482        1
[INPUT] 0    0    [1    /1   ]  1588.18008287        1
[INPUT] 0    0    [1    /1   ]  418.192490651        1
[INPUT] 0    0    [1    /1   ]  122.505674661        1
[INPUT] 0    0    [1    /1   ]  39.4536575844        1
[INPUT] 0    0    [1    /1   ]  8.50017852212        1
[INPUT] 0    0    [1    /1   ]  3.3551777388         1
[INPUT] 0    0    [1    /1   ]  0.674127083564       1
[INPUT] 0    0    [1    /1   ]  0.249714278065       1
[INPUT] 1    0    [1    /1   ]  1362.84334747        1
[INPUT] 1    0    [1    /1   ]  664.16062631         1
[INPUT] 1    0    [1    /1   ]  298.205835075        1
[INPUT] 1    0    [1    /1   ]  311.666648909        1
[INPUT] 1    0    [1    /1   ]  63.0564789155        1
[INPUT] 1    0    [1    /1   ]  7.50901698231        1
[INPUT] 1    0    [1    /1   ]  20.7563938213        1
[INPUT] 1    0    [1    /1   ]  0.782468074712       1
[INPUT] 1    0    [1    /1   ]  2.87067991186        1
[INPUT] 1    0    [1    /1   ]  0.224146006102       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838188975194, 1.0]], [0, [7617.092127185823, 1.0]], [0, [3617.511474816505, 1.0]], [0, [1588.1800828691119, 1.0]], [0, [418.1924906510434, 1.0]], [0, [122.50567466132651, 1.0]], [0, [39.453657584429884, 1.0]], [0, [8.500178522122969, 1.0]], [0, [3.3551777387976616, 1.0]], [0, [0.6741270835639778, 1.0]], [0, [0.24971427806479132, 1.0]], [1, [1362.8433474706126, 1.0]], [1, [664.1606263097946, 1.0]], [1, [298.20583507522264, 1.0]], [1, [311.6666489090837, 1.0]], [1, [63.05647891548714, 1.0]], [1, [7.509016982312217, 1.0]], [1, [20.756393821310862, 1.0]], [1, [0.7824680747116622, 1.0]], [1, [2.870679911855708, 1.0]], [1, [0.2241460061022048, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83818898]
bas 1, expnt(s) = [7617.09212719]
bas 2, expnt(s) = [3617.51147482]
bas 3, expnt(s) = [1588.18008287]
bas 4, expnt(s) = [418.19249065]
bas 5, expnt(s) = [122.50567466]
bas 6, expnt(s) = [39.45365758]
bas 7, expnt(s) = [8.50017852]
bas 8, expnt(s) = [3.35517774]
bas 9, expnt(s) = [0.67412708]
bas 10, expnt(s) = [0.24971428]
bas 11, expnt(s) = [1362.84334747]
bas 12, expnt(s) = [664.16062631]
bas 13, expnt(s) = [298.20583508]
bas 14, expnt(s) = [311.66664891]
bas 15, expnt(s) = [63.05647892]
bas 16, expnt(s) = [7.50901698]
bas 17, expnt(s) = [20.75639382]
bas 18, expnt(s) = [0.78246807]
bas 19, expnt(s) = [2.87067991]
bas 20, expnt(s) = [0.22414601]
CPU time:       459.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828382e+04 5.20029003e+03 7.61709213e+03 2.05995119e+03
 3.61751147e+03 1.17848067e+03 1.58818008e+03 6.35608700e+02
 4.18192491e+02 2.33640000e+02 1.22505675e+02 9.30319618e+01
 3.94536576e+01 3.97722790e+01 8.50017852e+00 1.25772606e+01
 3.35517774e+00 6.26327777e+00 6.74127084e-01 1.87962562e+00
 2.49714278e-01 8.92478074e-01 1.36284335e+03 2.41569342e+04
 6.64160626e+02 9.83616487e+03 2.98205835e+02 3.61517699e+03
 3.11666649e+02 3.82029858e+03 6.30564789e+01 5.18377971e+02
 7.50901698e+00 3.62629600e+01 2.07563938e+01 1.29248131e+02
 7.82468075e-01 2.14692897e+00 2.87067991e+00 1.09009753e+01
 2.24146006e-01 4.49933312e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9932241266484
cond(S) = 97861.63832519826
E1 = -729.5313816339869  E_coul = 203.17981111183812
init E= -526.351570522149
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555719715206982  LUMO = 1.04467489841558
  mo_energy =
[-1.18331902e+02 -1.22047186e+01 -9.44677955e+00 -9.44677955e+00
 -9.44677955e+00 -1.23996491e+00 -5.55719715e-01 -5.55719715e-01
 -5.55719715e-01  1.04467490e+00  1.04467490e+00  1.04467490e+00
  1.06029796e+00  7.53379877e+00  7.53379877e+00  7.53379877e+00
  1.36321673e+01  3.45201179e+01  3.45201179e+01  3.45201179e+01
  1.22684001e+02  1.32684431e+02  1.32684431e+02  1.32684431e+02
  4.88111613e+02  4.88111613e+02  4.88111613e+02  6.64925457e+02
  1.33514827e+03  1.33514827e+03  1.33514827e+03  2.81078624e+03
  3.02212073e+03  3.02212073e+03  3.02212073e+03  6.63745999e+03
  6.63745999e+03  6.63745999e+03  9.23223001e+03  2.55796258e+04
  7.63092936e+04]
E1 = -727.8718494899713  E_coul = 201.12658343342824
cycle= 1 E= -526.745266056543  delta_E= -0.394  |g|= 0.184  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538051
diis-c [-0.2894989  1.       ]
  HOMO = -0.590183249782868  LUMO = 1.02037997326543
  mo_energy =
[-1.18636902e+02 -1.23413758e+01 -9.59399589e+00 -9.59399589e+00
 -9.59399589e+00 -1.27901188e+00 -5.90183250e-01 -5.90183250e-01
 -5.90183250e-01  1.02037997e+00  1.02037997e+00  1.02037997e+00
  1.03113667e+00  7.44249129e+00  7.44249129e+00  7.44249129e+00
  1.35189733e+01  3.43658482e+01  3.43658482e+01  3.43658482e+01
  1.22456215e+02  1.32456903e+02  1.32456903e+02  1.32456903e+02
  4.87808423e+02  4.87808423e+02  4.87808423e+02  6.64575198e+02
  1.33478973e+03  1.33478973e+03  1.33478973e+03  2.81029319e+03
  3.02169676e+03  3.02169676e+03  3.02169676e+03  6.63692418e+03
  6.63692418e+03  6.63692418e+03  9.23162080e+03  2.55789230e+04
  7.63085010e+04]
E1 = -728.4392396315264  E_coul = 201.69326917882074
cycle= 2 E= -526.745970452706  delta_E= -0.000704  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744239
diis-c [-0.003247    0.08213087  0.91786913]
  HOMO = -0.581176812818125  LUMO = 1.02711057882176
  mo_energy =
[-1.18569940e+02 -1.23037554e+01 -9.55473510e+00 -9.55473510e+00
 -9.55473510e+00 -1.26823324e+00 -5.81176813e-01 -5.81176813e-01
 -5.81176813e-01  1.02711058e+00  1.02711058e+00  1.02711058e+00
  1.03948822e+00  7.46630973e+00  7.46630973e+00  7.46630973e+00
  1.35498601e+01  3.44058531e+01  3.44058531e+01  3.44058531e+01
  1.22512967e+02  1.32512410e+02  1.32512410e+02  1.32512410e+02
  4.87874536e+02  4.87874536e+02  4.87874536e+02  6.64644258e+02
  1.33485985e+03  1.33485985e+03  1.33485985e+03  2.81036668e+03
  3.02176912e+03  3.02176912e+03  3.02176912e+03  6.63699829e+03
  6.63699829e+03  6.63699829e+03  9.23169573e+03  2.55789985e+04
  7.63085768e+04]
E1 = -728.2908455689802  E_coul = 201.54481759340288
cycle= 3 E= -526.746027975577  delta_E= -5.75e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013035
diis-c [-5.35580898e-07 -1.21926179e-03  1.44685415e-01  8.56533847e-01]
  HOMO = -0.582655109347386  LUMO = 1.02602950481379
  mo_energy =
[-1.18579793e+02 -1.23094967e+01 -9.56081779e+00 -9.56081779e+00
 -9.56081779e+00 -1.26990472e+00 -5.82655109e-01 -5.82655109e-01
 -5.82655109e-01  1.02602950e+00  1.02602950e+00  1.02602950e+00
  1.03821216e+00  7.46252676e+00  7.46252676e+00  7.46252676e+00
  1.35451242e+01  3.43996991e+01  3.43996991e+01  3.43996991e+01
  1.22504556e+02  1.32504122e+02  1.32504122e+02  1.32504122e+02
  4.87864804e+02  4.87864804e+02  4.87864804e+02  6.64634085e+02
  1.33484953e+03  1.33484953e+03  1.33484953e+03  2.81035573e+03
  3.02175842e+03  3.02175842e+03  3.02175842e+03  6.63698721e+03
  6.63698721e+03  6.63698721e+03  9.23168443e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.313345650446  E_coul = 201.56731579984188
cycle= 4 E= -526.746029850604  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109096
diis-c [-3.78953702e-09  6.88645468e-05 -9.95338201e-03 -6.46841851e-02
  1.07456870e+00]
  HOMO = -0.582637225149112  LUMO = 1.02604499456204
  mo_energy =
[-1.18579754e+02 -1.23094345e+01 -9.56076851e+00 -9.56076851e+00
 -9.56076851e+00 -1.26986535e+00 -5.82637225e-01 -5.82637225e-01
 -5.82637225e-01  1.02604499e+00  1.02604499e+00  1.02604499e+00
  1.03824563e+00  7.46256730e+00  7.46256730e+00  7.46256730e+00
  1.35451820e+01  3.43997464e+01  3.43997464e+01  3.43997464e+01
  1.22504605e+02  1.32504168e+02  1.32504168e+02  1.32504168e+02
  4.87864842e+02  4.87864842e+02  4.87864842e+02  6.64634116e+02
  1.33484957e+03  1.33484957e+03  1.33484957e+03  2.81035574e+03
  3.02175844e+03  3.02175844e+03  3.02175844e+03  6.63698722e+03
  6.63698722e+03  6.63698722e+03  9.23168443e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.3131425916188  E_coul = 201.56711273949853
cycle= 5 E= -526.74602985212  delta_E= -1.52e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77094e-05
diis-c [-6.70200326e-11  1.39837826e-05 -1.83779122e-03 -1.37425406e-02
  4.27309709e-02  9.72835377e-01]
  HOMO = -0.582644331896366  LUMO = 1.02604021785998
  mo_energy =
[-1.18579784e+02 -1.23094561e+01 -9.56079200e+00 -9.56079200e+00
 -9.56079200e+00 -1.26987103e+00 -5.82644332e-01 -5.82644332e-01
 -5.82644332e-01  1.02604022e+00  1.02604022e+00  1.02604022e+00
  1.03824170e+00  7.46255120e+00  7.46255120e+00  7.46255120e+00
  1.35451640e+01  3.43997235e+01  3.43997235e+01  3.43997235e+01
  1.22504578e+02  1.32504141e+02  1.32504141e+02  1.32504141e+02
  4.87864813e+02  4.87864813e+02  4.87864813e+02  6.64634085e+02
  1.33484953e+03  1.33484953e+03  1.33484953e+03  2.81035571e+03
  3.02175841e+03  3.02175841e+03  3.02175841e+03  6.63698718e+03
  6.63698718e+03  6.63698718e+03  9.23168440e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.3132209140324  E_coul = 201.56719106185892
cycle= 6 E= -526.746029852173  delta_E= -5.32e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3132209140324  E_coul = 201.56719106185892
  HOMO = -0.582644356275587  LUMO = 1.02604025430032
  mo_energy =
[-1.18579784e+02 -1.23094560e+01 -9.56079197e+00 -9.56079197e+00
 -9.56079197e+00 -1.26987068e+00 -5.82644356e-01 -5.82644356e-01
 -5.82644356e-01  1.02604025e+00  1.02604025e+00  1.02604025e+00
  1.03824203e+00  7.46255123e+00  7.46255123e+00  7.46255123e+00
  1.35451642e+01  3.43997236e+01  3.43997236e+01  3.43997236e+01
  1.22504578e+02  1.32504141e+02  1.32504141e+02  1.32504141e+02
  4.87864813e+02  4.87864813e+02  4.87864813e+02  6.64634085e+02
  1.33484954e+03  1.33484954e+03  1.33484954e+03  2.81035571e+03
  3.02175841e+03  3.02175841e+03  3.02175841e+03  6.63698718e+03
  6.63698718e+03  6.63698718e+03  9.23168440e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.3132200836504  E_coul = 201.56719023147565
Extra cycle  E= -526.746029852175  delta_E= -1.36e-12  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828382e+04 7.61709213e+03 3.61751147e+03 1.58818008e+03
 4.18192491e+02 1.22505675e+02 3.94536576e+01 8.50017852e+00
 3.35517774e+00 6.74127084e-01 2.49714278e-01 1.36284335e+03
 6.64160626e+02 2.98205835e+02 3.11666649e+02 6.30564789e+01
 7.50901698e+00 2.07563938e+01 7.82468075e-01 2.87067991e+00
 2.24146006e-01]
E = -526.7460298521748
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.838189         1
[INPUT] 0    0    [1    /1   ]  7617.09212719        1
[INPUT] 0    0    [1    /1   ]  3617.51147482        1
[INPUT] 0    0    [1    /1   ]  1588.18008287        1
[INPUT] 0    0    [1    /1   ]  418.192490651        1
[INPUT] 0    0    [1    /1   ]  122.505674661        1
[INPUT] 0    0    [1    /1   ]  39.4536575844        1
[INPUT] 0    0    [1    /1   ]  8.50017852212        1
[INPUT] 0    0    [1    /1   ]  3.3551777388         1
[INPUT] 0    0    [1    /1   ]  0.674127083564       1
[INPUT] 0    0    [1    /1   ]  0.249714278065       1
[INPUT] 1    0    [1    /1   ]  1362.84334747        1
[INPUT] 1    0    [1    /1   ]  664.16062631         1
[INPUT] 1    0    [1    /1   ]  298.205835075        1
[INPUT] 1    0    [1    /1   ]  311.666648909        1
[INPUT] 1    0    [1    /1   ]  63.0564789155        1
[INPUT] 1    0    [1    /1   ]  7.50901698231        1
[INPUT] 1    0    [1    /1   ]  20.7563938213        1
[INPUT] 1    0    [1    /1   ]  0.782468074712       1
[INPUT] 1    0    [1    /1   ]  2.87067991186        1
[INPUT] 1    0    [1    /1   ]  0.224146006102       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838188975194, 1.0]], [0, [7617.092127185823, 1.0]], [0, [3617.511474816505, 1.0]], [0, [1588.1800828691119, 1.0]], [0, [418.1924906510434, 1.0]], [0, [122.50567466132651, 1.0]], [0, [39.453657584429884, 1.0]], [0, [8.500178522122969, 1.0]], [0, [3.3551777387976616, 1.0]], [0, [0.6741270835639778, 1.0]], [0, [0.24971427806479132, 1.0]], [1, [1362.8433474706126, 1.0]], [1, [664.1606263097946, 1.0]], [1, [298.20583507522264, 1.0]], [1, [311.6666489090837, 1.0]], [1, [63.05647891548714, 1.0]], [1, [7.509016982312217, 1.0]], [1, [20.756393821310862, 1.0]], [1, [0.7824680747116622, 1.0]], [1, [2.870679911855708, 1.0]], [1, [0.2241460061022048, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83818898]
bas 1, expnt(s) = [7617.09212719]
bas 2, expnt(s) = [3617.51147482]
bas 3, expnt(s) = [1588.18008287]
bas 4, expnt(s) = [418.19249065]
bas 5, expnt(s) = [122.50567466]
bas 6, expnt(s) = [39.45365758]
bas 7, expnt(s) = [8.50017852]
bas 8, expnt(s) = [3.35517774]
bas 9, expnt(s) = [0.67412708]
bas 10, expnt(s) = [0.24971428]
bas 11, expnt(s) = [1362.84334747]
bas 12, expnt(s) = [664.16062631]
bas 13, expnt(s) = [298.20583508]
bas 14, expnt(s) = [311.66664891]
bas 15, expnt(s) = [63.05647892]
bas 16, expnt(s) = [7.50901698]
bas 17, expnt(s) = [20.75639382]
bas 18, expnt(s) = [0.78246807]
bas 19, expnt(s) = [2.87067991]
bas 20, expnt(s) = [0.22414601]
CPU time:       459.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828382e+04 5.20029003e+03 7.61709213e+03 2.05995119e+03
 3.61751147e+03 1.17848067e+03 1.58818008e+03 6.35608700e+02
 4.18192491e+02 2.33640000e+02 1.22505675e+02 9.30319618e+01
 3.94536576e+01 3.97722790e+01 8.50017852e+00 1.25772606e+01
 3.35517774e+00 6.26327777e+00 6.74127084e-01 1.87962562e+00
 2.49714278e-01 8.92478074e-01 1.36284335e+03 2.41569342e+04
 6.64160626e+02 9.83616487e+03 2.98205835e+02 3.61517699e+03
 3.11666649e+02 3.82029858e+03 6.30564789e+01 5.18377971e+02
 7.50901698e+00 3.62629600e+01 2.07563938e+01 1.29248131e+02
 7.82468075e-01 2.14692897e+00 2.87067991e+00 1.09009753e+01
 2.24146006e-01 4.49933312e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9932241266484
cond(S) = 97861.63832519826
E1 = -729.5313816339869  E_coul = 203.17981111183812
init E= -526.351570522149
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555719715206982  LUMO = 1.04467489841558
  mo_energy =
[-1.18331902e+02 -1.22047186e+01 -9.44677955e+00 -9.44677955e+00
 -9.44677955e+00 -1.23996491e+00 -5.55719715e-01 -5.55719715e-01
 -5.55719715e-01  1.04467490e+00  1.04467490e+00  1.04467490e+00
  1.06029796e+00  7.53379877e+00  7.53379877e+00  7.53379877e+00
  1.36321673e+01  3.45201179e+01  3.45201179e+01  3.45201179e+01
  1.22684001e+02  1.32684431e+02  1.32684431e+02  1.32684431e+02
  4.88111613e+02  4.88111613e+02  4.88111613e+02  6.64925457e+02
  1.33514827e+03  1.33514827e+03  1.33514827e+03  2.81078624e+03
  3.02212073e+03  3.02212073e+03  3.02212073e+03  6.63745999e+03
  6.63745999e+03  6.63745999e+03  9.23223001e+03  2.55796258e+04
  7.63092936e+04]
E1 = -727.8718494899713  E_coul = 201.12658343342824
cycle= 1 E= -526.745266056543  delta_E= -0.394  |g|= 0.184  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538051
diis-c [-0.2894989  1.       ]
  HOMO = -0.590183249782868  LUMO = 1.02037997326543
  mo_energy =
[-1.18636902e+02 -1.23413758e+01 -9.59399589e+00 -9.59399589e+00
 -9.59399589e+00 -1.27901188e+00 -5.90183250e-01 -5.90183250e-01
 -5.90183250e-01  1.02037997e+00  1.02037997e+00  1.02037997e+00
  1.03113667e+00  7.44249129e+00  7.44249129e+00  7.44249129e+00
  1.35189733e+01  3.43658482e+01  3.43658482e+01  3.43658482e+01
  1.22456215e+02  1.32456903e+02  1.32456903e+02  1.32456903e+02
  4.87808423e+02  4.87808423e+02  4.87808423e+02  6.64575198e+02
  1.33478973e+03  1.33478973e+03  1.33478973e+03  2.81029319e+03
  3.02169676e+03  3.02169676e+03  3.02169676e+03  6.63692418e+03
  6.63692418e+03  6.63692418e+03  9.23162080e+03  2.55789230e+04
  7.63085010e+04]
E1 = -728.4392396315264  E_coul = 201.69326917882074
cycle= 2 E= -526.745970452706  delta_E= -0.000704  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744239
diis-c [-0.003247    0.08213087  0.91786913]
  HOMO = -0.581176812818125  LUMO = 1.02711057882176
  mo_energy =
[-1.18569940e+02 -1.23037554e+01 -9.55473510e+00 -9.55473510e+00
 -9.55473510e+00 -1.26823324e+00 -5.81176813e-01 -5.81176813e-01
 -5.81176813e-01  1.02711058e+00  1.02711058e+00  1.02711058e+00
  1.03948822e+00  7.46630973e+00  7.46630973e+00  7.46630973e+00
  1.35498601e+01  3.44058531e+01  3.44058531e+01  3.44058531e+01
  1.22512967e+02  1.32512410e+02  1.32512410e+02  1.32512410e+02
  4.87874536e+02  4.87874536e+02  4.87874536e+02  6.64644258e+02
  1.33485985e+03  1.33485985e+03  1.33485985e+03  2.81036668e+03
  3.02176912e+03  3.02176912e+03  3.02176912e+03  6.63699829e+03
  6.63699829e+03  6.63699829e+03  9.23169573e+03  2.55789985e+04
  7.63085768e+04]
E1 = -728.2908455689802  E_coul = 201.54481759340288
cycle= 3 E= -526.746027975577  delta_E= -5.75e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013035
diis-c [-5.35580898e-07 -1.21926179e-03  1.44685415e-01  8.56533847e-01]
  HOMO = -0.582655109347386  LUMO = 1.02602950481379
  mo_energy =
[-1.18579793e+02 -1.23094967e+01 -9.56081779e+00 -9.56081779e+00
 -9.56081779e+00 -1.26990472e+00 -5.82655109e-01 -5.82655109e-01
 -5.82655109e-01  1.02602950e+00  1.02602950e+00  1.02602950e+00
  1.03821216e+00  7.46252676e+00  7.46252676e+00  7.46252676e+00
  1.35451242e+01  3.43996991e+01  3.43996991e+01  3.43996991e+01
  1.22504556e+02  1.32504122e+02  1.32504122e+02  1.32504122e+02
  4.87864804e+02  4.87864804e+02  4.87864804e+02  6.64634085e+02
  1.33484953e+03  1.33484953e+03  1.33484953e+03  2.81035573e+03
  3.02175842e+03  3.02175842e+03  3.02175842e+03  6.63698721e+03
  6.63698721e+03  6.63698721e+03  9.23168443e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.313345650446  E_coul = 201.56731579984188
cycle= 4 E= -526.746029850604  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000109096
diis-c [-3.78953702e-09  6.88645468e-05 -9.95338201e-03 -6.46841851e-02
  1.07456870e+00]
  HOMO = -0.582637225149112  LUMO = 1.02604499456204
  mo_energy =
[-1.18579754e+02 -1.23094345e+01 -9.56076851e+00 -9.56076851e+00
 -9.56076851e+00 -1.26986535e+00 -5.82637225e-01 -5.82637225e-01
 -5.82637225e-01  1.02604499e+00  1.02604499e+00  1.02604499e+00
  1.03824563e+00  7.46256730e+00  7.46256730e+00  7.46256730e+00
  1.35451820e+01  3.43997464e+01  3.43997464e+01  3.43997464e+01
  1.22504605e+02  1.32504168e+02  1.32504168e+02  1.32504168e+02
  4.87864842e+02  4.87864842e+02  4.87864842e+02  6.64634116e+02
  1.33484957e+03  1.33484957e+03  1.33484957e+03  2.81035574e+03
  3.02175844e+03  3.02175844e+03  3.02175844e+03  6.63698722e+03
  6.63698722e+03  6.63698722e+03  9.23168443e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.3131425916188  E_coul = 201.56711273949853
cycle= 5 E= -526.74602985212  delta_E= -1.52e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77094e-05
diis-c [-6.70200326e-11  1.39837826e-05 -1.83779122e-03 -1.37425406e-02
  4.27309709e-02  9.72835377e-01]
  HOMO = -0.582644331896366  LUMO = 1.02604021785998
  mo_energy =
[-1.18579784e+02 -1.23094561e+01 -9.56079200e+00 -9.56079200e+00
 -9.56079200e+00 -1.26987103e+00 -5.82644332e-01 -5.82644332e-01
 -5.82644332e-01  1.02604022e+00  1.02604022e+00  1.02604022e+00
  1.03824170e+00  7.46255120e+00  7.46255120e+00  7.46255120e+00
  1.35451640e+01  3.43997235e+01  3.43997235e+01  3.43997235e+01
  1.22504578e+02  1.32504141e+02  1.32504141e+02  1.32504141e+02
  4.87864813e+02  4.87864813e+02  4.87864813e+02  6.64634085e+02
  1.33484953e+03  1.33484953e+03  1.33484953e+03  2.81035571e+03
  3.02175841e+03  3.02175841e+03  3.02175841e+03  6.63698718e+03
  6.63698718e+03  6.63698718e+03  9.23168440e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.3132209140324  E_coul = 201.56719106185892
cycle= 6 E= -526.746029852173  delta_E= -5.32e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3132209140324  E_coul = 201.56719106185892
  HOMO = -0.582644356275587  LUMO = 1.02604025430032
  mo_energy =
[-1.18579784e+02 -1.23094560e+01 -9.56079197e+00 -9.56079197e+00
 -9.56079197e+00 -1.26987068e+00 -5.82644356e-01 -5.82644356e-01
 -5.82644356e-01  1.02604025e+00  1.02604025e+00  1.02604025e+00
  1.03824203e+00  7.46255123e+00  7.46255123e+00  7.46255123e+00
  1.35451642e+01  3.43997236e+01  3.43997236e+01  3.43997236e+01
  1.22504578e+02  1.32504141e+02  1.32504141e+02  1.32504141e+02
  4.87864813e+02  4.87864813e+02  4.87864813e+02  6.64634085e+02
  1.33484954e+03  1.33484954e+03  1.33484954e+03  2.81035571e+03
  3.02175841e+03  3.02175841e+03  3.02175841e+03  6.63698718e+03
  6.63698718e+03  6.63698718e+03  9.23168440e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.3132200836504  E_coul = 201.56719023147565
Extra cycle  E= -526.746029852175  delta_E= -1.36e-12  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97861.63832519826
E1 = -728.3132200836504  E_coul = 201.56719023147565
init E= -526.746029852175
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582644383074121  LUMO = 1.02604024622157
  mo_energy =
[-1.18579784e+02 -1.23094560e+01 -9.56079205e+00 -9.56079205e+00
 -9.56079205e+00 -1.26987064e+00 -5.82644383e-01 -5.82644383e-01
 -5.82644383e-01  1.02604025e+00  1.02604025e+00  1.02604025e+00
  1.03824208e+00  7.46255118e+00  7.46255118e+00  7.46255118e+00
  1.35451641e+01  3.43997235e+01  3.43997235e+01  3.43997235e+01
  1.22504578e+02  1.32504141e+02  1.32504141e+02  1.32504141e+02
  4.87864813e+02  4.87864813e+02  4.87864813e+02  6.64634085e+02
  1.33484953e+03  1.33484953e+03  1.33484953e+03  2.81035571e+03
  3.02175841e+03  3.02175841e+03  3.02175841e+03  6.63698718e+03
  6.63698718e+03  6.63698718e+03  9.23168440e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.3132202149723  E_coul = 201.56719036279833
cycle= 1 E= -526.746029852174  delta_E= 9.09e-13  |g|= 7.12e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3132202149723  E_coul = 201.56719036279833
  HOMO = -0.582644382887924  LUMO = 1.02604024869711
  mo_energy =
[-1.18579784e+02 -1.23094560e+01 -9.56079205e+00 -9.56079205e+00
 -9.56079205e+00 -1.26987062e+00 -5.82644383e-01 -5.82644383e-01
 -5.82644383e-01  1.02604025e+00  1.02604025e+00  1.02604025e+00
  1.03824209e+00  7.46255119e+00  7.46255119e+00  7.46255119e+00
  1.35451641e+01  3.43997235e+01  3.43997235e+01  3.43997235e+01
  1.22504578e+02  1.32504141e+02  1.32504141e+02  1.32504141e+02
  4.87864813e+02  4.87864813e+02  4.87864813e+02  6.64634085e+02
  1.33484953e+03  1.33484953e+03  1.33484953e+03  2.81035571e+03
  3.02175841e+03  3.02175841e+03  3.02175841e+03  6.63698718e+03
  6.63698718e+03  6.63698718e+03  9.23168440e+03  2.55789870e+04
  7.63085652e+04]
E1 = -728.3132201572089  E_coul = 201.56719030503456
Extra cycle  E= -526.746029852174  delta_E= -4.55e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828382e+04 7.61709213e+03 3.61751147e+03 1.58818008e+03
 4.18192491e+02 1.22505675e+02 3.94536576e+01 8.50017852e+00
 3.35517774e+00 6.74127084e-01 2.49714278e-01 1.36284335e+03
 6.64160626e+02 2.98205835e+02 3.11666649e+02 6.30564789e+01
 7.50901698e+00 2.07563938e+01 7.82468075e-01 2.87067991e+00
 2.24146006e-01]
grad_E = [-1.39804815e-06  2.16477045e-06 -2.13829203e-06  3.71114587e-05
  6.63762359e-06  6.27820776e-06  6.39571296e-08  1.63009026e-05
 -3.85615556e-05 -8.05221254e-06 -1.86123029e-05 -5.88872976e-07
  4.04400196e-06  1.84777423e-05  1.57744085e-05  6.02220504e-05
  2.20350745e-05  7.91932730e-05 -3.09505404e-05 -2.60508494e-05
  1.60132967e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8385606        1
[INPUT] 0    0    [1    /1   ]  7617.09123333        1
[INPUT] 0    0    [1    /1   ]  3617.51178652        1
[INPUT] 0    0    [1    /1   ]  1588.15977414        1
[INPUT] 0    0    [1    /1   ]  418.275429508        1
[INPUT] 0    0    [1    /1   ]  122.509037007        1
[INPUT] 0    0    [1    /1   ]  39.4513915493        1
[INPUT] 0    0    [1    /1   ]  8.49730060612        1
[INPUT] 0    0    [1    /1   ]  3.35462409617        1
[INPUT] 0    0    [1    /1   ]  0.674158552986       1
[INPUT] 0    0    [1    /1   ]  0.249724737192       1
[INPUT] 1    0    [1    /1   ]  1362.84346808        1
[INPUT] 1    0    [1    /1   ]  664.159421348        1
[INPUT] 1    0    [1    /1   ]  298.200139576        1
[INPUT] 1    0    [1    /1   ]  311.661739298        1
[INPUT] 1    0    [1    /1   ]  63.0660366853        1
[INPUT] 1    0    [1    /1   ]  7.50154302742        1
[INPUT] 1    0    [1    /1   ]  20.7419003723        1
[INPUT] 1    0    [1    /1   ]  0.782193738659       1
[INPUT] 1    0    [1    /1   ]  2.86812271198        1
[INPUT] 1    0    [1    /1   ]  0.224091330409       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838560607808, 1.0]], [0, [7617.09123332575, 1.0]], [0, [3617.511786516582, 1.0]], [0, [1588.159774140047, 1.0]], [0, [418.2754295075948, 1.0]], [0, [122.50903700733687, 1.0]], [0, [39.45139154926649, 1.0]], [0, [8.497300606124325, 1.0]], [0, [3.354624096173533, 1.0]], [0, [0.6741585529861611, 1.0]], [0, [0.24972473719209637, 1.0]], [1, [1362.8434680817404, 1.0]], [1, [664.1594213477644, 1.0]], [1, [298.2001395761198, 1.0]], [1, [311.66173929817916, 1.0]], [1, [63.066036685281986, 1.0]], [1, [7.501543027421412, 1.0]], [1, [20.74190037227414, 1.0]], [1, [0.7821937386589246, 1.0]], [1, [2.8681227119773283, 1.0]], [1, [0.22409133040892362, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83856061]
bas 1, expnt(s) = [7617.09123333]
bas 2, expnt(s) = [3617.51178652]
bas 3, expnt(s) = [1588.15977414]
bas 4, expnt(s) = [418.27542951]
bas 5, expnt(s) = [122.50903701]
bas 6, expnt(s) = [39.45139155]
bas 7, expnt(s) = [8.49730061]
bas 8, expnt(s) = [3.3546241]
bas 9, expnt(s) = [0.67415855]
bas 10, expnt(s) = [0.24972474]
bas 11, expnt(s) = [1362.84346808]
bas 12, expnt(s) = [664.15942135]
bas 13, expnt(s) = [298.20013958]
bas 14, expnt(s) = [311.6617393]
bas 15, expnt(s) = [63.06603669]
bas 16, expnt(s) = [7.50154303]
bas 17, expnt(s) = [20.74190037]
bas 18, expnt(s) = [0.78219374]
bas 19, expnt(s) = [2.86812271]
bas 20, expnt(s) = [0.22409133]
CPU time:       465.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828386e+04 5.20029008e+03 7.61709123e+03 2.05995101e+03
 3.61751179e+03 1.17848074e+03 1.58815977e+03 6.35602604e+02
 4.18275430e+02 2.33674752e+02 1.22509037e+02 9.30338768e+01
 3.94513915e+01 3.97705658e+01 8.49730061e+00 1.25740667e+01
 3.35462410e+00 6.26250262e+00 6.74158553e-01 1.87969143e+00
 2.49724737e-01 8.92506110e-01 1.36284347e+03 2.41569368e+04
 6.64159421e+02 9.83614256e+03 2.98200140e+02 3.61509068e+03
 3.11661739e+02 3.82022335e+03 6.30660367e+01 5.18476189e+02
 7.50154303e+00 3.62178486e+01 2.07419004e+01 1.29135329e+02
 7.82193739e-01 2.14598811e+00 2.86812271e+00 1.08888384e+01
 2.24091330e-01 4.49796127e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99323408872885
cond(S) = 97833.7729184393
E1 = -729.5313196056711  E_coul = 203.179778764895
init E= -526.351540840776
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555722457181683  LUMO = 1.04421312481116
  mo_energy =
[-1.18331903e+02 -1.22047251e+01 -9.44677996e+00 -9.44677996e+00
 -9.44677996e+00 -1.23996450e+00 -5.55722457e-01 -5.55722457e-01
 -5.55722457e-01  1.04421312e+00  1.04421312e+00  1.04421312e+00
  1.06035117e+00  7.52612640e+00  7.52612640e+00  7.52612640e+00
  1.36275294e+01  3.44825430e+01  3.44825430e+01  3.44825430e+01
  1.22667363e+02  1.32618336e+02  1.32618336e+02  1.32618336e+02
  4.88055838e+02  4.88055838e+02  4.88055838e+02  6.64968798e+02
  1.33509250e+03  1.33509250e+03  1.33509250e+03  2.81097915e+03
  3.02205512e+03  3.02205512e+03  3.02205512e+03  6.63738856e+03
  6.63738856e+03  6.63738856e+03  9.23246956e+03  2.55798567e+04
  7.63095060e+04]
E1 = -727.8716412963389  E_coul = 201.12637480308481
cycle= 1 E= -526.745266493254  delta_E= -0.394  |g|= 0.184  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538037
diis-c [-0.28948342  1.        ]
  HOMO = -0.590193035573214  LUMO = 1.01992524640662
  mo_energy =
[-1.18636930e+02 -1.23413910e+01 -9.59400392e+00 -9.59400392e+00
 -9.59400392e+00 -1.27902009e+00 -5.90193036e-01 -5.90193036e-01
 -5.90193036e-01  1.01992525e+00  1.01992525e+00  1.01992525e+00
  1.03118122e+00  7.43486442e+00  7.43486442e+00  7.43486442e+00
  1.35143436e+01  3.43283114e+01  3.43283114e+01  3.43283114e+01
  1.22439566e+02  1.32390785e+02  1.32390785e+02  1.32390785e+02
  4.87752617e+02  4.87752617e+02  4.87752617e+02  6.64618499e+02
  1.33473393e+03  1.33473393e+03  1.33473393e+03  2.81048606e+03
  3.02163112e+03  3.02163112e+03  3.02163112e+03  6.63685273e+03
  6.63685273e+03  6.63685273e+03  9.23186032e+03  2.55791538e+04
  7.63087134e+04]
E1 = -728.4391255520634  E_coul = 201.69315452649099
cycle= 2 E= -526.745971025572  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744261
diis-c [-0.00324705  0.08213737  0.91786263]
  HOMO = -0.581184836790069  LUMO = 1.02665365316279
  mo_energy =
[-1.18569959e+02 -1.23037646e+01 -9.55473675e+00 -9.55473675e+00
 -9.55473675e+00 -1.26823941e+00 -5.81184837e-01 -5.81184837e-01
 -5.81184837e-01  1.02665365e+00  1.02665365e+00  1.02665365e+00
  1.03953441e+00  7.45867278e+00  7.45867278e+00  7.45867278e+00
  1.35452307e+01  3.43683110e+01  3.43683110e+01  3.43683110e+01
  1.22496326e+02  1.32446300e+02  1.32446300e+02  1.32446300e+02
  4.87818740e+02  4.87818740e+02  4.87818740e+02  6.64687569e+02
  1.33480405e+03  1.33480405e+03  1.33480405e+03  2.81055957e+03
  3.02170350e+03  3.02170350e+03  3.02170350e+03  6.63692685e+03
  6.63692685e+03  6.63692685e+03  9.23193526e+03  2.55792293e+04
  7.63087892e+04]
E1 = -728.2906963042965  E_coul = 201.54466773473865
cycle= 3 E= -526.746028569558  delta_E= -5.75e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130357
diis-c [-5.35500504e-07 -1.21931536e-03  1.44689327e-01  8.56529988e-01]
  HOMO = -0.582663544314499  LUMO = 1.02557283530015
  mo_energy =
[-1.18579813e+02 -1.23095072e+01 -9.56082080e+00 -9.56082080e+00
 -9.56082080e+00 -1.26991140e+00 -5.82663544e-01 -5.82663544e-01
 -5.82663544e-01  1.02557284e+00  1.02557284e+00  1.02557284e+00
  1.03825792e+00  7.45489105e+00  7.45489105e+00  7.45489105e+00
  1.35404943e+01  3.43621573e+01  3.43621573e+01  3.43621573e+01
  1.22487913e+02  1.32438011e+02  1.32438011e+02  1.32438011e+02
  4.87809006e+02  4.87809006e+02  4.87809006e+02  6.64677393e+02
  1.33479374e+03  1.33479374e+03  1.33479374e+03  2.81054861e+03
  3.02169280e+03  3.02169280e+03  3.02169280e+03  6.63691576e+03
  6.63691576e+03  6.63691576e+03  9.23192396e+03  2.55792178e+04
  7.63087776e+04]
E1 = -728.3132033907793  E_coul = 201.56717294524637
cycle= 4 E= -526.746030445533  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010899
diis-c [-3.79141355e-09  6.87751587e-05 -9.94264310e-03 -6.46073049e-02
  1.07448117e+00]
  HOMO = -0.582645633592079  LUMO = 1.02558833665185
  mo_energy =
[-1.18579775e+02 -1.23094449e+01 -9.56077143e+00 -9.56077143e+00
 -9.56077143e+00 -1.26987201e+00 -5.82645634e-01 -5.82645634e-01
 -5.82645634e-01  1.02558834e+00  1.02558834e+00  1.02558834e+00
  1.03829141e+00  7.45493164e+00  7.45493164e+00  7.45493164e+00
  1.35405521e+01  3.43622047e+01  3.43622047e+01  3.43622047e+01
  1.22487962e+02  1.32438056e+02  1.32438056e+02  1.32438056e+02
  4.87809044e+02  4.87809044e+02  4.87809044e+02  6.64677424e+02
  1.33479377e+03  1.33479377e+03  1.33479377e+03  2.81054862e+03
  3.02169282e+03  3.02169282e+03  3.02169282e+03  6.63691577e+03
  6.63691577e+03  6.63691577e+03  9.23192396e+03  2.55792178e+04
  7.63087775e+04]
E1 = -728.3130000624791  E_coul = 201.56696961543278
cycle= 5 E= -526.746030447046  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77196e-05
diis-c [-6.69822471e-11  1.39884946e-05 -1.83836256e-03 -1.37457592e-02
  4.27340481e-02  9.72836085e-01]
  HOMO = -0.582652741206678  LUMO = 1.02558356188784
  mo_energy =
[-1.18579805e+02 -1.23094666e+01 -9.56079493e+00 -9.56079493e+00
 -9.56079493e+00 -1.26987769e+00 -5.82652741e-01 -5.82652741e-01
 -5.82652741e-01  1.02558356e+00  1.02558356e+00  1.02558356e+00
  1.03828748e+00  7.45491555e+00  7.45491555e+00  7.45491555e+00
  1.35405341e+01  3.43621818e+01  3.43621818e+01  3.43621818e+01
  1.22487935e+02  1.32438029e+02  1.32438029e+02  1.32438029e+02
  4.87809015e+02  4.87809015e+02  4.87809015e+02  6.64677394e+02
  1.33479374e+03  1.33479374e+03  1.33479374e+03  2.81054859e+03
  3.02169279e+03  3.02169279e+03  3.02169279e+03  6.63691573e+03
  6.63691573e+03  6.63691573e+03  9.23192392e+03  2.55792178e+04
  7.63087775e+04]
E1 = -728.3130784126373  E_coul = 201.5670479655376
cycle= 6 E= -526.7460304471  delta_E= -5.33e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130784126373  E_coul = 201.5670479655376
  HOMO = -0.582652765987295  LUMO = 1.02558359804672
  mo_energy =
[-1.18579804e+02 -1.23094664e+01 -9.56079490e+00 -9.56079490e+00
 -9.56079490e+00 -1.26987735e+00 -5.82652766e-01 -5.82652766e-01
 -5.82652766e-01  1.02558360e+00  1.02558360e+00  1.02558360e+00
  1.03828780e+00  7.45491558e+00  7.45491558e+00  7.45491558e+00
  1.35405343e+01  3.43621819e+01  3.43621819e+01  3.43621819e+01
  1.22487935e+02  1.32438029e+02  1.32438029e+02  1.32438029e+02
  4.87809015e+02  4.87809015e+02  4.87809015e+02  6.64677394e+02
  1.33479374e+03  1.33479374e+03  1.33479374e+03  2.81054859e+03
  3.02169279e+03  3.02169279e+03  3.02169279e+03  6.63691573e+03
  6.63691573e+03  6.63691573e+03  9.23192392e+03  2.55792178e+04
  7.63087775e+04]
E1 = -728.3130775891088  E_coul = 201.56704714200862
Extra cycle  E= -526.7460304471  delta_E= -5.68e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828386e+04 7.61709123e+03 3.61751179e+03 1.58815977e+03
 4.18275430e+02 1.22509037e+02 3.94513915e+01 8.49730061e+00
 3.35462410e+00 6.74158553e-01 2.49724737e-01 1.36284347e+03
 6.64159421e+02 2.98200140e+02 3.11661739e+02 6.30660367e+01
 7.50154303e+00 2.07419004e+01 7.82193739e-01 2.86812271e+00
 2.24091330e-01]
E = -526.7460304471002
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8385606        1
[INPUT] 0    0    [1    /1   ]  7617.09123333        1
[INPUT] 0    0    [1    /1   ]  3617.51178652        1
[INPUT] 0    0    [1    /1   ]  1588.15977414        1
[INPUT] 0    0    [1    /1   ]  418.275429508        1
[INPUT] 0    0    [1    /1   ]  122.509037007        1
[INPUT] 0    0    [1    /1   ]  39.4513915493        1
[INPUT] 0    0    [1    /1   ]  8.49730060612        1
[INPUT] 0    0    [1    /1   ]  3.35462409617        1
[INPUT] 0    0    [1    /1   ]  0.674158552986       1
[INPUT] 0    0    [1    /1   ]  0.249724737192       1
[INPUT] 1    0    [1    /1   ]  1362.84346808        1
[INPUT] 1    0    [1    /1   ]  664.159421348        1
[INPUT] 1    0    [1    /1   ]  298.200139576        1
[INPUT] 1    0    [1    /1   ]  311.661739298        1
[INPUT] 1    0    [1    /1   ]  63.0660366853        1
[INPUT] 1    0    [1    /1   ]  7.50154302742        1
[INPUT] 1    0    [1    /1   ]  20.7419003723        1
[INPUT] 1    0    [1    /1   ]  0.782193738659       1
[INPUT] 1    0    [1    /1   ]  2.86812271198        1
[INPUT] 1    0    [1    /1   ]  0.224091330409       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838560607808, 1.0]], [0, [7617.09123332575, 1.0]], [0, [3617.511786516582, 1.0]], [0, [1588.159774140047, 1.0]], [0, [418.2754295075948, 1.0]], [0, [122.50903700733687, 1.0]], [0, [39.45139154926649, 1.0]], [0, [8.497300606124325, 1.0]], [0, [3.354624096173533, 1.0]], [0, [0.6741585529861611, 1.0]], [0, [0.24972473719209637, 1.0]], [1, [1362.8434680817404, 1.0]], [1, [664.1594213477644, 1.0]], [1, [298.2001395761198, 1.0]], [1, [311.66173929817916, 1.0]], [1, [63.066036685281986, 1.0]], [1, [7.501543027421412, 1.0]], [1, [20.74190037227414, 1.0]], [1, [0.7821937386589246, 1.0]], [1, [2.8681227119773283, 1.0]], [1, [0.22409133040892362, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83856061]
bas 1, expnt(s) = [7617.09123333]
bas 2, expnt(s) = [3617.51178652]
bas 3, expnt(s) = [1588.15977414]
bas 4, expnt(s) = [418.27542951]
bas 5, expnt(s) = [122.50903701]
bas 6, expnt(s) = [39.45139155]
bas 7, expnt(s) = [8.49730061]
bas 8, expnt(s) = [3.3546241]
bas 9, expnt(s) = [0.67415855]
bas 10, expnt(s) = [0.24972474]
bas 11, expnt(s) = [1362.84346808]
bas 12, expnt(s) = [664.15942135]
bas 13, expnt(s) = [298.20013958]
bas 14, expnt(s) = [311.6617393]
bas 15, expnt(s) = [63.06603669]
bas 16, expnt(s) = [7.50154303]
bas 17, expnt(s) = [20.74190037]
bas 18, expnt(s) = [0.78219374]
bas 19, expnt(s) = [2.86812271]
bas 20, expnt(s) = [0.22409133]
CPU time:       466.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828386e+04 5.20029008e+03 7.61709123e+03 2.05995101e+03
 3.61751179e+03 1.17848074e+03 1.58815977e+03 6.35602604e+02
 4.18275430e+02 2.33674752e+02 1.22509037e+02 9.30338768e+01
 3.94513915e+01 3.97705658e+01 8.49730061e+00 1.25740667e+01
 3.35462410e+00 6.26250262e+00 6.74158553e-01 1.87969143e+00
 2.49724737e-01 8.92506110e-01 1.36284347e+03 2.41569368e+04
 6.64159421e+02 9.83614256e+03 2.98200140e+02 3.61509068e+03
 3.11661739e+02 3.82022335e+03 6.30660367e+01 5.18476189e+02
 7.50154303e+00 3.62178486e+01 2.07419004e+01 1.29135329e+02
 7.82193739e-01 2.14598811e+00 2.86812271e+00 1.08888384e+01
 2.24091330e-01 4.49796127e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99323408872885
cond(S) = 97833.7729184393
E1 = -729.5313196056711  E_coul = 203.179778764895
init E= -526.351540840776
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555722457181683  LUMO = 1.04421312481116
  mo_energy =
[-1.18331903e+02 -1.22047251e+01 -9.44677996e+00 -9.44677996e+00
 -9.44677996e+00 -1.23996450e+00 -5.55722457e-01 -5.55722457e-01
 -5.55722457e-01  1.04421312e+00  1.04421312e+00  1.04421312e+00
  1.06035117e+00  7.52612640e+00  7.52612640e+00  7.52612640e+00
  1.36275294e+01  3.44825430e+01  3.44825430e+01  3.44825430e+01
  1.22667363e+02  1.32618336e+02  1.32618336e+02  1.32618336e+02
  4.88055838e+02  4.88055838e+02  4.88055838e+02  6.64968798e+02
  1.33509250e+03  1.33509250e+03  1.33509250e+03  2.81097915e+03
  3.02205512e+03  3.02205512e+03  3.02205512e+03  6.63738856e+03
  6.63738856e+03  6.63738856e+03  9.23246956e+03  2.55798567e+04
  7.63095060e+04]
E1 = -727.8716412963389  E_coul = 201.12637480308481
cycle= 1 E= -526.745266493254  delta_E= -0.394  |g|= 0.184  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538037
diis-c [-0.28948342  1.        ]
  HOMO = -0.590193035573214  LUMO = 1.01992524640662
  mo_energy =
[-1.18636930e+02 -1.23413910e+01 -9.59400392e+00 -9.59400392e+00
 -9.59400392e+00 -1.27902009e+00 -5.90193036e-01 -5.90193036e-01
 -5.90193036e-01  1.01992525e+00  1.01992525e+00  1.01992525e+00
  1.03118122e+00  7.43486442e+00  7.43486442e+00  7.43486442e+00
  1.35143436e+01  3.43283114e+01  3.43283114e+01  3.43283114e+01
  1.22439566e+02  1.32390785e+02  1.32390785e+02  1.32390785e+02
  4.87752617e+02  4.87752617e+02  4.87752617e+02  6.64618499e+02
  1.33473393e+03  1.33473393e+03  1.33473393e+03  2.81048606e+03
  3.02163112e+03  3.02163112e+03  3.02163112e+03  6.63685273e+03
  6.63685273e+03  6.63685273e+03  9.23186032e+03  2.55791538e+04
  7.63087134e+04]
E1 = -728.4391255520634  E_coul = 201.69315452649099
cycle= 2 E= -526.745971025572  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744261
diis-c [-0.00324705  0.08213737  0.91786263]
  HOMO = -0.581184836790069  LUMO = 1.02665365316279
  mo_energy =
[-1.18569959e+02 -1.23037646e+01 -9.55473675e+00 -9.55473675e+00
 -9.55473675e+00 -1.26823941e+00 -5.81184837e-01 -5.81184837e-01
 -5.81184837e-01  1.02665365e+00  1.02665365e+00  1.02665365e+00
  1.03953441e+00  7.45867278e+00  7.45867278e+00  7.45867278e+00
  1.35452307e+01  3.43683110e+01  3.43683110e+01  3.43683110e+01
  1.22496326e+02  1.32446300e+02  1.32446300e+02  1.32446300e+02
  4.87818740e+02  4.87818740e+02  4.87818740e+02  6.64687569e+02
  1.33480405e+03  1.33480405e+03  1.33480405e+03  2.81055957e+03
  3.02170350e+03  3.02170350e+03  3.02170350e+03  6.63692685e+03
  6.63692685e+03  6.63692685e+03  9.23193526e+03  2.55792293e+04
  7.63087892e+04]
E1 = -728.2906963042965  E_coul = 201.54466773473865
cycle= 3 E= -526.746028569558  delta_E= -5.75e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130357
diis-c [-5.35500504e-07 -1.21931536e-03  1.44689327e-01  8.56529988e-01]
  HOMO = -0.582663544314499  LUMO = 1.02557283530015
  mo_energy =
[-1.18579813e+02 -1.23095072e+01 -9.56082080e+00 -9.56082080e+00
 -9.56082080e+00 -1.26991140e+00 -5.82663544e-01 -5.82663544e-01
 -5.82663544e-01  1.02557284e+00  1.02557284e+00  1.02557284e+00
  1.03825792e+00  7.45489105e+00  7.45489105e+00  7.45489105e+00
  1.35404943e+01  3.43621573e+01  3.43621573e+01  3.43621573e+01
  1.22487913e+02  1.32438011e+02  1.32438011e+02  1.32438011e+02
  4.87809006e+02  4.87809006e+02  4.87809006e+02  6.64677393e+02
  1.33479374e+03  1.33479374e+03  1.33479374e+03  2.81054861e+03
  3.02169280e+03  3.02169280e+03  3.02169280e+03  6.63691576e+03
  6.63691576e+03  6.63691576e+03  9.23192396e+03  2.55792178e+04
  7.63087776e+04]
E1 = -728.3132033907793  E_coul = 201.56717294524637
cycle= 4 E= -526.746030445533  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010899
diis-c [-3.79141355e-09  6.87751587e-05 -9.94264310e-03 -6.46073049e-02
  1.07448117e+00]
  HOMO = -0.582645633592079  LUMO = 1.02558833665185
  mo_energy =
[-1.18579775e+02 -1.23094449e+01 -9.56077143e+00 -9.56077143e+00
 -9.56077143e+00 -1.26987201e+00 -5.82645634e-01 -5.82645634e-01
 -5.82645634e-01  1.02558834e+00  1.02558834e+00  1.02558834e+00
  1.03829141e+00  7.45493164e+00  7.45493164e+00  7.45493164e+00
  1.35405521e+01  3.43622047e+01  3.43622047e+01  3.43622047e+01
  1.22487962e+02  1.32438056e+02  1.32438056e+02  1.32438056e+02
  4.87809044e+02  4.87809044e+02  4.87809044e+02  6.64677424e+02
  1.33479377e+03  1.33479377e+03  1.33479377e+03  2.81054862e+03
  3.02169282e+03  3.02169282e+03  3.02169282e+03  6.63691577e+03
  6.63691577e+03  6.63691577e+03  9.23192396e+03  2.55792178e+04
  7.63087775e+04]
E1 = -728.3130000624791  E_coul = 201.56696961543278
cycle= 5 E= -526.746030447046  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77196e-05
diis-c [-6.69822471e-11  1.39884946e-05 -1.83836256e-03 -1.37457592e-02
  4.27340481e-02  9.72836085e-01]
  HOMO = -0.582652741206678  LUMO = 1.02558356188784
  mo_energy =
[-1.18579805e+02 -1.23094666e+01 -9.56079493e+00 -9.56079493e+00
 -9.56079493e+00 -1.26987769e+00 -5.82652741e-01 -5.82652741e-01
 -5.82652741e-01  1.02558356e+00  1.02558356e+00  1.02558356e+00
  1.03828748e+00  7.45491555e+00  7.45491555e+00  7.45491555e+00
  1.35405341e+01  3.43621818e+01  3.43621818e+01  3.43621818e+01
  1.22487935e+02  1.32438029e+02  1.32438029e+02  1.32438029e+02
  4.87809015e+02  4.87809015e+02  4.87809015e+02  6.64677394e+02
  1.33479374e+03  1.33479374e+03  1.33479374e+03  2.81054859e+03
  3.02169279e+03  3.02169279e+03  3.02169279e+03  6.63691573e+03
  6.63691573e+03  6.63691573e+03  9.23192392e+03  2.55792178e+04
  7.63087775e+04]
E1 = -728.3130784126373  E_coul = 201.5670479655376
cycle= 6 E= -526.7460304471  delta_E= -5.33e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130784126373  E_coul = 201.5670479655376
  HOMO = -0.582652765987295  LUMO = 1.02558359804672
  mo_energy =
[-1.18579804e+02 -1.23094664e+01 -9.56079490e+00 -9.56079490e+00
 -9.56079490e+00 -1.26987735e+00 -5.82652766e-01 -5.82652766e-01
 -5.82652766e-01  1.02558360e+00  1.02558360e+00  1.02558360e+00
  1.03828780e+00  7.45491558e+00  7.45491558e+00  7.45491558e+00
  1.35405343e+01  3.43621819e+01  3.43621819e+01  3.43621819e+01
  1.22487935e+02  1.32438029e+02  1.32438029e+02  1.32438029e+02
  4.87809015e+02  4.87809015e+02  4.87809015e+02  6.64677394e+02
  1.33479374e+03  1.33479374e+03  1.33479374e+03  2.81054859e+03
  3.02169279e+03  3.02169279e+03  3.02169279e+03  6.63691573e+03
  6.63691573e+03  6.63691573e+03  9.23192392e+03  2.55792178e+04
  7.63087775e+04]
E1 = -728.3130775891088  E_coul = 201.56704714200862
Extra cycle  E= -526.7460304471  delta_E= -5.68e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97833.7729184393
E1 = -728.3130775891088  E_coul = 201.56704714200862
init E= -526.7460304471
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582652792640081  LUMO = 1.02558359008575
  mo_energy =
[-1.18579805e+02 -1.23094665e+01 -9.56079498e+00 -9.56079498e+00
 -9.56079498e+00 -1.26987730e+00 -5.82652793e-01 -5.82652793e-01
 -5.82652793e-01  1.02558359e+00  1.02558359e+00  1.02558359e+00
  1.03828785e+00  7.45491553e+00  7.45491553e+00  7.45491553e+00
  1.35405343e+01  3.43621818e+01  3.43621818e+01  3.43621818e+01
  1.22487935e+02  1.32438029e+02  1.32438029e+02  1.32438029e+02
  4.87809015e+02  4.87809015e+02  4.87809015e+02  6.64677394e+02
  1.33479374e+03  1.33479374e+03  1.33479374e+03  2.81054859e+03
  3.02169279e+03  3.02169279e+03  3.02169279e+03  6.63691573e+03
  6.63691573e+03  6.63691573e+03  9.23192392e+03  2.55792178e+04
  7.63087775e+04]
E1 = -728.3130777187171  E_coul = 201.56704727161687
cycle= 1 E= -526.7460304471  delta_E=    0  |g|= 7.12e-08  |ddm|= 5.67e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3130777187171  E_coul = 201.56704727161687
  HOMO = -0.582652792483603  LUMO = 1.02558359253954
  mo_energy =
[-1.18579805e+02 -1.23094665e+01 -9.56079497e+00 -9.56079497e+00
 -9.56079497e+00 -1.26987729e+00 -5.82652792e-01 -5.82652792e-01
 -5.82652792e-01  1.02558359e+00  1.02558359e+00  1.02558359e+00
  1.03828787e+00  7.45491553e+00  7.45491553e+00  7.45491553e+00
  1.35405343e+01  3.43621818e+01  3.43621818e+01  3.43621818e+01
  1.22487935e+02  1.32438029e+02  1.32438029e+02  1.32438029e+02
  4.87809015e+02  4.87809015e+02  4.87809015e+02  6.64677394e+02
  1.33479374e+03  1.33479374e+03  1.33479374e+03  2.81054859e+03
  3.02169279e+03  3.02169279e+03  3.02169279e+03  6.63691573e+03
  6.63691573e+03  6.63691573e+03  9.23192392e+03  2.55792178e+04
  7.63087775e+04]
E1 = -728.3130776614712  E_coul = 201.56704721437006
Extra cycle  E= -526.746030447101  delta_E= -9.09e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828386e+04 7.61709123e+03 3.61751179e+03 1.58815977e+03
 4.18275430e+02 1.22509037e+02 3.94513915e+01 8.49730061e+00
 3.35462410e+00 6.74158553e-01 2.49724737e-01 1.36284347e+03
 6.64159421e+02 2.98200140e+02 3.11661739e+02 6.30660367e+01
 7.50154303e+00 2.07419004e+01 7.82193739e-01 2.86812271e+00
 2.24091330e-01]
grad_E = [-1.39749260e-06  2.16022173e-06 -2.13772893e-06  3.69635112e-05
  8.62106835e-06  9.75327786e-07  5.52565792e-07 -6.44069606e-07
 -4.78228794e-06 -1.57880471e-05  1.34197103e-05 -5.90843989e-07
  4.01101548e-06  1.82834023e-05  1.56083535e-05  7.51466943e-05
  3.13116770e-05  3.13249138e-05 -2.87275953e-05 -2.20291941e-05
  6.17856063e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8384996        1
[INPUT] 0    0    [1    /1   ]  7617.09137688        1
[INPUT] 0    0    [1    /1   ]  3617.51173259        1
[INPUT] 0    0    [1    /1   ]  1588.16300124        1
[INPUT] 0    0    [1    /1   ]  418.262943479        1
[INPUT] 0    0    [1    /1   ]  122.507252606        1
[INPUT] 0    0    [1    /1   ]  39.4513953131        1
[INPUT] 0    0    [1    /1   ]  8.49765620095        1
[INPUT] 0    0    [1    /1   ]  3.35475737683        1
[INPUT] 0    0    [1    /1   ]  0.674229875104       1
[INPUT] 0    0    [1    /1   ]  0.249748660054       1
[INPUT] 1    0    [1    /1   ]  1362.84344777        1
[INPUT] 1    0    [1    /1   ]  664.159613907        1
[INPUT] 1    0    [1    /1   ]  298.20104341         1
[INPUT] 1    0    [1    /1   ]  311.662518348        1
[INPUT] 1    0    [1    /1   ]  63.0667903963        1
[INPUT] 1    0    [1    /1   ]  7.49984417941        1
[INPUT] 1    0    [1    /1   ]  20.7387270572        1
[INPUT] 1    0    [1    /1   ]  0.782141541935       1
[INPUT] 1    0    [1    /1   ]  2.86759498198        1
[INPUT] 1    0    [1    /1   ]  0.224079922971       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838499634036, 1.0]], [0, [7617.091376876148, 1.0]], [0, [3617.5117325862216, 1.0]], [0, [1588.1630012400014, 1.0]], [0, [418.26294347866735, 1.0]], [0, [122.50725260596569, 1.0]], [0, [39.45139531307329, 1.0]], [0, [8.497656200945869, 1.0]], [0, [3.3547573768340464, 1.0]], [0, [0.6742298751038394, 1.0]], [0, [0.24974866005374735, 1.0]], [1, [1362.8434477650637, 1.0]], [1, [664.1596139074566, 1.0]], [1, [298.2010434099669, 1.0]], [1, [311.6625183480261, 1.0]], [1, [63.066790396307326, 1.0]], [1, [7.499844179407355, 1.0]], [1, [20.73872705721909, 1.0]], [1, [0.7821415419349406, 1.0]], [1, [2.867594981979926, 1.0]], [1, [0.22407992297086654, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83849963]
bas 1, expnt(s) = [7617.09137688]
bas 2, expnt(s) = [3617.51173259]
bas 3, expnt(s) = [1588.16300124]
bas 4, expnt(s) = [418.26294348]
bas 5, expnt(s) = [122.50725261]
bas 6, expnt(s) = [39.45139531]
bas 7, expnt(s) = [8.4976562]
bas 8, expnt(s) = [3.35475738]
bas 9, expnt(s) = [0.67422988]
bas 10, expnt(s) = [0.24974866]
bas 11, expnt(s) = [1362.84344777]
bas 12, expnt(s) = [664.15961391]
bas 13, expnt(s) = [298.20104341]
bas 14, expnt(s) = [311.66251835]
bas 15, expnt(s) = [63.0667904]
bas 16, expnt(s) = [7.49984418]
bas 17, expnt(s) = [20.73872706]
bas 18, expnt(s) = [0.78214154]
bas 19, expnt(s) = [2.86759498]
bas 20, expnt(s) = [0.22407992]
CPU time:       472.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828385e+04 5.20029007e+03 7.61709138e+03 2.05995104e+03
 3.61751173e+03 1.17848073e+03 1.58816300e+03 6.35603573e+02
 4.18262943e+02 2.33669520e+02 1.22507253e+02 9.30328605e+01
 3.94513953e+01 3.97705686e+01 8.49765620e+00 1.25744614e+01
 3.35475738e+00 6.26268923e+00 6.74229875e-01 1.87984057e+00
 2.49748660e-01 8.92570233e-01 1.36284345e+03 2.41569364e+04
 6.64159614e+02 9.83614613e+03 2.98201043e+02 3.61510438e+03
 3.11662518e+02 3.82023529e+03 6.30667904e+01 5.18483935e+02
 7.49984418e+00 3.62075962e+01 2.07387271e+01 1.29110634e+02
 7.82141542e-01 2.14580911e+00 2.86759498e+00 1.08863341e+01
 2.24079923e-01 4.49767506e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99323573795097
cond(S) = 97833.17081267337
E1 = -729.5313310808191  E_coul = 203.17978260788593
init E= -526.351548472933
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555723108582108  LUMO = 1.04412151705312
  mo_energy =
[-1.18331903e+02 -1.22047247e+01 -9.44677894e+00 -9.44677894e+00
 -9.44677894e+00 -1.23996378e+00 -5.55723109e-01 -5.55723109e-01
 -5.55723109e-01  1.04412152e+00  1.04412152e+00  1.04412152e+00
  1.06053555e+00  7.52451213e+00  7.52451213e+00  7.52451213e+00
  1.36287576e+01  3.44743176e+01  3.44743176e+01  3.44743176e+01
  1.22668973e+02  1.32602573e+02  1.32602573e+02  1.32602573e+02
  4.88041286e+02  4.88041286e+02  4.88041286e+02  6.64958067e+02
  1.33508147e+03  1.33508147e+03  1.33508147e+03  2.81094459e+03
  3.02204755e+03  3.02204755e+03  3.02204755e+03  6.63738369e+03
  6.63738369e+03  6.63738369e+03  9.23242823e+03  2.55798170e+04
  7.63094695e+04]
E1 = -727.8716076098159  E_coul = 201.1263411232452
cycle= 1 E= -526.745266486571  delta_E= -0.394  |g|= 0.184  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538038
diis-c [-0.28948445  1.        ]
  HOMO = -0.59019579431132  LUMO = 1.01983455839094
  mo_energy =
[-1.18636934e+02 -1.23413924e+01 -9.59400443e+00 -9.59400443e+00
 -9.59400443e+00 -1.27902199e+00 -5.90195794e-01 -5.90195794e-01
 -5.90195794e-01  1.01983456e+00  1.01983456e+00  1.01983456e+00
  1.03135912e+00  7.43325949e+00  7.43325949e+00  7.43325949e+00
  1.35155667e+01  3.43200950e+01  3.43200950e+01  3.43200950e+01
  1.22441174e+02  1.32375019e+02  1.32375019e+02  1.32375019e+02
  4.87738060e+02  4.87738060e+02  4.87738060e+02  6.64607766e+02
  1.33472290e+03  1.33472290e+03  1.33472290e+03  2.81045150e+03
  3.02162355e+03  3.02162355e+03  3.02162355e+03  6.63684784e+03
  6.63684784e+03  6.63684784e+03  9.23181899e+03  2.55791141e+04
  7.63086769e+04]
E1 = -728.4391134190879  E_coul = 201.69314237039248
cycle= 2 E= -526.745971048695  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744268
diis-c [-0.00324716  0.08213722  0.91786278]
  HOMO = -0.581187196180582  LUMO = 1.02656257253192
  mo_energy =
[-1.18569961e+02 -1.23037644e+01 -9.55473570e+00 -9.55473570e+00
 -9.55473570e+00 -1.26824084e+00 -5.81187196e-01 -5.81187196e-01
 -5.81187196e-01  1.02656257e+00  1.02656257e+00  1.02656257e+00
  1.03971376e+00  7.45706578e+00  7.45706578e+00  7.45706578e+00
  1.35464557e+01  3.43600935e+01  3.43600935e+01  3.43600935e+01
  1.22497936e+02  1.32430536e+02  1.32430536e+02  1.32430536e+02
  4.87804185e+02  4.87804185e+02  4.87804185e+02  6.64676838e+02
  1.33479302e+03  1.33479302e+03  1.33479302e+03  2.81052501e+03
  3.02169592e+03  3.02169592e+03  3.02169592e+03  6.63692197e+03
  6.63692197e+03  6.63692197e+03  9.23189392e+03  2.55791897e+04
  7.63087527e+04]
E1 = -728.2906749982028  E_coul = 201.5446464002056
cycle= 3 E= -526.746028597997  delta_E= -5.75e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130362
diis-c [-5.35504586e-07 -1.21931892e-03  1.44692710e-01  8.56526609e-01]
  HOMO = -0.582666027319485  LUMO = 1.02548177292524
  mo_energy =
[-1.18579816e+02 -1.23095075e+01 -9.56082017e+00 -9.56082017e+00
 -9.56082017e+00 -1.26991298e+00 -5.82666027e-01 -5.82666027e-01
 -5.82666027e-01  1.02548177e+00  1.02548177e+00  1.02548177e+00
  1.03843698e+00  7.45328423e+00  7.45328423e+00  7.45328423e+00
  1.35417189e+01  3.43539397e+01  3.43539397e+01  3.43539397e+01
  1.22489523e+02  1.32422246e+02  1.32422246e+02  1.32422246e+02
  4.87794450e+02  4.87794450e+02  4.87794450e+02  6.64666663e+02
  1.33478271e+03  1.33478271e+03  1.33478271e+03  2.81051405e+03
  3.02168522e+03  3.02168522e+03  3.02168522e+03  6.63691088e+03
  6.63691088e+03  6.63691088e+03  9.23188262e+03  2.55791782e+04
  7.63087411e+04]
E1 = -728.3131842793088  E_coul = 201.56715380502465
cycle= 4 E= -526.746030474284  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108964
diis-c [-3.79201980e-09  6.87509465e-05 -9.93975083e-03 -6.45856781e-02
  1.07445668e+00]
  HOMO = -0.582648108774021  LUMO = 1.02549727832275
  mo_energy =
[-1.18579777e+02 -1.23094452e+01 -9.56077078e+00 -9.56077078e+00
 -9.56077078e+00 -1.26987359e+00 -5.82648109e-01 -5.82648109e-01
 -5.82648109e-01  1.02549728e+00  1.02549728e+00  1.02549728e+00
  1.03847047e+00  7.45332484e+00  7.45332484e+00  7.45332484e+00
  1.35417767e+01  3.43539872e+01  3.43539872e+01  3.43539872e+01
  1.22489572e+02  1.32422292e+02  1.32422292e+02  1.32422292e+02
  4.87794489e+02  4.87794489e+02  4.87794489e+02  6.64666693e+02
  1.33478274e+03  1.33478274e+03  1.33478274e+03  2.81051406e+03
  3.02168524e+03  3.02168524e+03  3.02168524e+03  6.63691089e+03
  6.63691089e+03  6.63691089e+03  9.23188262e+03  2.55791782e+04
  7.63087411e+04]
E1 = -728.3129808788991  E_coul = 201.566950403101
cycle= 5 E= -526.746030475798  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77233e-05
diis-c [-6.69679608e-11  1.39889341e-05 -1.83848915e-03 -1.37462962e-02
  4.27376204e-02  9.72833176e-01]
  HOMO = -0.582655216550828  LUMO = 1.02549250392815
  mo_energy =
[-1.18579807e+02 -1.23094668e+01 -9.56079428e+00 -9.56079428e+00
 -9.56079428e+00 -1.26987927e+00 -5.82655217e-01 -5.82655217e-01
 -5.82655217e-01  1.02549250e+00  1.02549250e+00  1.02549250e+00
  1.03846655e+00  7.45330875e+00  7.45330875e+00  7.45330875e+00
  1.35417587e+01  3.43539642e+01  3.43539642e+01  3.43539642e+01
  1.22489545e+02  1.32422265e+02  1.32422265e+02  1.32422265e+02
  4.87794460e+02  4.87794460e+02  4.87794460e+02  6.64666663e+02
  1.33478271e+03  1.33478271e+03  1.33478271e+03  2.81051403e+03
  3.02168521e+03  3.02168521e+03  3.02168521e+03  6.63691085e+03
  6.63691085e+03  6.63691085e+03  9.23188259e+03  2.55791781e+04
  7.63087410e+04]
E1 = -728.3130592390064  E_coul = 201.567028763156
cycle= 6 E= -526.74603047585  delta_E= -5.23e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130592390064  E_coul = 201.567028763156
  HOMO = -0.582655241415616  LUMO = 1.02549254002593
  mo_energy =
[-1.18579807e+02 -1.23094667e+01 -9.56079425e+00 -9.56079425e+00
 -9.56079425e+00 -1.26987892e+00 -5.82655241e-01 -5.82655241e-01
 -5.82655241e-01  1.02549254e+00  1.02549254e+00  1.02549254e+00
  1.03846687e+00  7.45330878e+00  7.45330878e+00  7.45330878e+00
  1.35417589e+01  3.43539643e+01  3.43539643e+01  3.43539643e+01
  1.22489545e+02  1.32422265e+02  1.32422265e+02  1.32422265e+02
  4.87794460e+02  4.87794460e+02  4.87794460e+02  6.64666663e+02
  1.33478271e+03  1.33478271e+03  1.33478271e+03  2.81051403e+03
  3.02168521e+03  3.02168521e+03  3.02168521e+03  6.63691085e+03
  6.63691085e+03  6.63691085e+03  9.23188259e+03  2.55791781e+04
  7.63087410e+04]
E1 = -728.3130584175375  E_coul = 201.56702794168646
Extra cycle  E= -526.746030475851  delta_E= -6.82e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828385e+04 7.61709138e+03 3.61751173e+03 1.58816300e+03
 4.18262943e+02 1.22507253e+02 3.94513953e+01 8.49765620e+00
 3.35475738e+00 6.74229875e-01 2.49748660e-01 1.36284345e+03
 6.64159614e+02 2.98201043e+02 3.11662518e+02 6.30667904e+01
 7.49984418e+00 2.07387271e+01 7.82141542e-01 2.86759498e+00
 2.24079923e-01]
E = -526.7460304758511
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8384996        1
[INPUT] 0    0    [1    /1   ]  7617.09137688        1
[INPUT] 0    0    [1    /1   ]  3617.51173259        1
[INPUT] 0    0    [1    /1   ]  1588.16300124        1
[INPUT] 0    0    [1    /1   ]  418.262943479        1
[INPUT] 0    0    [1    /1   ]  122.507252606        1
[INPUT] 0    0    [1    /1   ]  39.4513953131        1
[INPUT] 0    0    [1    /1   ]  8.49765620095        1
[INPUT] 0    0    [1    /1   ]  3.35475737683        1
[INPUT] 0    0    [1    /1   ]  0.674229875104       1
[INPUT] 0    0    [1    /1   ]  0.249748660054       1
[INPUT] 1    0    [1    /1   ]  1362.84344777        1
[INPUT] 1    0    [1    /1   ]  664.159613907        1
[INPUT] 1    0    [1    /1   ]  298.20104341         1
[INPUT] 1    0    [1    /1   ]  311.662518348        1
[INPUT] 1    0    [1    /1   ]  63.0667903963        1
[INPUT] 1    0    [1    /1   ]  7.49984417941        1
[INPUT] 1    0    [1    /1   ]  20.7387270572        1
[INPUT] 1    0    [1    /1   ]  0.782141541935       1
[INPUT] 1    0    [1    /1   ]  2.86759498198        1
[INPUT] 1    0    [1    /1   ]  0.224079922971       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838499634036, 1.0]], [0, [7617.091376876148, 1.0]], [0, [3617.5117325862216, 1.0]], [0, [1588.1630012400014, 1.0]], [0, [418.26294347866735, 1.0]], [0, [122.50725260596569, 1.0]], [0, [39.45139531307329, 1.0]], [0, [8.497656200945869, 1.0]], [0, [3.3547573768340464, 1.0]], [0, [0.6742298751038394, 1.0]], [0, [0.24974866005374735, 1.0]], [1, [1362.8434477650637, 1.0]], [1, [664.1596139074566, 1.0]], [1, [298.2010434099669, 1.0]], [1, [311.6625183480261, 1.0]], [1, [63.066790396307326, 1.0]], [1, [7.499844179407355, 1.0]], [1, [20.73872705721909, 1.0]], [1, [0.7821415419349406, 1.0]], [1, [2.867594981979926, 1.0]], [1, [0.22407992297086654, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83849963]
bas 1, expnt(s) = [7617.09137688]
bas 2, expnt(s) = [3617.51173259]
bas 3, expnt(s) = [1588.16300124]
bas 4, expnt(s) = [418.26294348]
bas 5, expnt(s) = [122.50725261]
bas 6, expnt(s) = [39.45139531]
bas 7, expnt(s) = [8.4976562]
bas 8, expnt(s) = [3.35475738]
bas 9, expnt(s) = [0.67422988]
bas 10, expnt(s) = [0.24974866]
bas 11, expnt(s) = [1362.84344777]
bas 12, expnt(s) = [664.15961391]
bas 13, expnt(s) = [298.20104341]
bas 14, expnt(s) = [311.66251835]
bas 15, expnt(s) = [63.0667904]
bas 16, expnt(s) = [7.49984418]
bas 17, expnt(s) = [20.73872706]
bas 18, expnt(s) = [0.78214154]
bas 19, expnt(s) = [2.86759498]
bas 20, expnt(s) = [0.22407992]
CPU time:       472.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828385e+04 5.20029007e+03 7.61709138e+03 2.05995104e+03
 3.61751173e+03 1.17848073e+03 1.58816300e+03 6.35603573e+02
 4.18262943e+02 2.33669520e+02 1.22507253e+02 9.30328605e+01
 3.94513953e+01 3.97705686e+01 8.49765620e+00 1.25744614e+01
 3.35475738e+00 6.26268923e+00 6.74229875e-01 1.87984057e+00
 2.49748660e-01 8.92570233e-01 1.36284345e+03 2.41569364e+04
 6.64159614e+02 9.83614613e+03 2.98201043e+02 3.61510438e+03
 3.11662518e+02 3.82023529e+03 6.30667904e+01 5.18483935e+02
 7.49984418e+00 3.62075962e+01 2.07387271e+01 1.29110634e+02
 7.82141542e-01 2.14580911e+00 2.86759498e+00 1.08863341e+01
 2.24079923e-01 4.49767506e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99323573795097
cond(S) = 97833.17081267337
E1 = -729.5313310808191  E_coul = 203.17978260788593
init E= -526.351548472933
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555723108582108  LUMO = 1.04412151705312
  mo_energy =
[-1.18331903e+02 -1.22047247e+01 -9.44677894e+00 -9.44677894e+00
 -9.44677894e+00 -1.23996378e+00 -5.55723109e-01 -5.55723109e-01
 -5.55723109e-01  1.04412152e+00  1.04412152e+00  1.04412152e+00
  1.06053555e+00  7.52451213e+00  7.52451213e+00  7.52451213e+00
  1.36287576e+01  3.44743176e+01  3.44743176e+01  3.44743176e+01
  1.22668973e+02  1.32602573e+02  1.32602573e+02  1.32602573e+02
  4.88041286e+02  4.88041286e+02  4.88041286e+02  6.64958067e+02
  1.33508147e+03  1.33508147e+03  1.33508147e+03  2.81094459e+03
  3.02204755e+03  3.02204755e+03  3.02204755e+03  6.63738369e+03
  6.63738369e+03  6.63738369e+03  9.23242823e+03  2.55798170e+04
  7.63094695e+04]
E1 = -727.8716076098159  E_coul = 201.1263411232452
cycle= 1 E= -526.745266486571  delta_E= -0.394  |g|= 0.184  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538038
diis-c [-0.28948445  1.        ]
  HOMO = -0.59019579431132  LUMO = 1.01983455839094
  mo_energy =
[-1.18636934e+02 -1.23413924e+01 -9.59400443e+00 -9.59400443e+00
 -9.59400443e+00 -1.27902199e+00 -5.90195794e-01 -5.90195794e-01
 -5.90195794e-01  1.01983456e+00  1.01983456e+00  1.01983456e+00
  1.03135912e+00  7.43325949e+00  7.43325949e+00  7.43325949e+00
  1.35155667e+01  3.43200950e+01  3.43200950e+01  3.43200950e+01
  1.22441174e+02  1.32375019e+02  1.32375019e+02  1.32375019e+02
  4.87738060e+02  4.87738060e+02  4.87738060e+02  6.64607766e+02
  1.33472290e+03  1.33472290e+03  1.33472290e+03  2.81045150e+03
  3.02162355e+03  3.02162355e+03  3.02162355e+03  6.63684784e+03
  6.63684784e+03  6.63684784e+03  9.23181899e+03  2.55791141e+04
  7.63086769e+04]
E1 = -728.4391134190879  E_coul = 201.69314237039248
cycle= 2 E= -526.745971048695  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744268
diis-c [-0.00324716  0.08213722  0.91786278]
  HOMO = -0.581187196180582  LUMO = 1.02656257253192
  mo_energy =
[-1.18569961e+02 -1.23037644e+01 -9.55473570e+00 -9.55473570e+00
 -9.55473570e+00 -1.26824084e+00 -5.81187196e-01 -5.81187196e-01
 -5.81187196e-01  1.02656257e+00  1.02656257e+00  1.02656257e+00
  1.03971376e+00  7.45706578e+00  7.45706578e+00  7.45706578e+00
  1.35464557e+01  3.43600935e+01  3.43600935e+01  3.43600935e+01
  1.22497936e+02  1.32430536e+02  1.32430536e+02  1.32430536e+02
  4.87804185e+02  4.87804185e+02  4.87804185e+02  6.64676838e+02
  1.33479302e+03  1.33479302e+03  1.33479302e+03  2.81052501e+03
  3.02169592e+03  3.02169592e+03  3.02169592e+03  6.63692197e+03
  6.63692197e+03  6.63692197e+03  9.23189392e+03  2.55791897e+04
  7.63087527e+04]
E1 = -728.2906749982028  E_coul = 201.5446464002056
cycle= 3 E= -526.746028597997  delta_E= -5.75e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130362
diis-c [-5.35504586e-07 -1.21931892e-03  1.44692710e-01  8.56526609e-01]
  HOMO = -0.582666027319485  LUMO = 1.02548177292524
  mo_energy =
[-1.18579816e+02 -1.23095075e+01 -9.56082017e+00 -9.56082017e+00
 -9.56082017e+00 -1.26991298e+00 -5.82666027e-01 -5.82666027e-01
 -5.82666027e-01  1.02548177e+00  1.02548177e+00  1.02548177e+00
  1.03843698e+00  7.45328423e+00  7.45328423e+00  7.45328423e+00
  1.35417189e+01  3.43539397e+01  3.43539397e+01  3.43539397e+01
  1.22489523e+02  1.32422246e+02  1.32422246e+02  1.32422246e+02
  4.87794450e+02  4.87794450e+02  4.87794450e+02  6.64666663e+02
  1.33478271e+03  1.33478271e+03  1.33478271e+03  2.81051405e+03
  3.02168522e+03  3.02168522e+03  3.02168522e+03  6.63691088e+03
  6.63691088e+03  6.63691088e+03  9.23188262e+03  2.55791782e+04
  7.63087411e+04]
E1 = -728.3131842793088  E_coul = 201.56715380502465
cycle= 4 E= -526.746030474284  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108964
diis-c [-3.79201980e-09  6.87509465e-05 -9.93975083e-03 -6.45856781e-02
  1.07445668e+00]
  HOMO = -0.582648108774021  LUMO = 1.02549727832275
  mo_energy =
[-1.18579777e+02 -1.23094452e+01 -9.56077078e+00 -9.56077078e+00
 -9.56077078e+00 -1.26987359e+00 -5.82648109e-01 -5.82648109e-01
 -5.82648109e-01  1.02549728e+00  1.02549728e+00  1.02549728e+00
  1.03847047e+00  7.45332484e+00  7.45332484e+00  7.45332484e+00
  1.35417767e+01  3.43539872e+01  3.43539872e+01  3.43539872e+01
  1.22489572e+02  1.32422292e+02  1.32422292e+02  1.32422292e+02
  4.87794489e+02  4.87794489e+02  4.87794489e+02  6.64666693e+02
  1.33478274e+03  1.33478274e+03  1.33478274e+03  2.81051406e+03
  3.02168524e+03  3.02168524e+03  3.02168524e+03  6.63691089e+03
  6.63691089e+03  6.63691089e+03  9.23188262e+03  2.55791782e+04
  7.63087411e+04]
E1 = -728.3129808788991  E_coul = 201.566950403101
cycle= 5 E= -526.746030475798  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77233e-05
diis-c [-6.69679608e-11  1.39889341e-05 -1.83848915e-03 -1.37462962e-02
  4.27376204e-02  9.72833176e-01]
  HOMO = -0.582655216550828  LUMO = 1.02549250392815
  mo_energy =
[-1.18579807e+02 -1.23094668e+01 -9.56079428e+00 -9.56079428e+00
 -9.56079428e+00 -1.26987927e+00 -5.82655217e-01 -5.82655217e-01
 -5.82655217e-01  1.02549250e+00  1.02549250e+00  1.02549250e+00
  1.03846655e+00  7.45330875e+00  7.45330875e+00  7.45330875e+00
  1.35417587e+01  3.43539642e+01  3.43539642e+01  3.43539642e+01
  1.22489545e+02  1.32422265e+02  1.32422265e+02  1.32422265e+02
  4.87794460e+02  4.87794460e+02  4.87794460e+02  6.64666663e+02
  1.33478271e+03  1.33478271e+03  1.33478271e+03  2.81051403e+03
  3.02168521e+03  3.02168521e+03  3.02168521e+03  6.63691085e+03
  6.63691085e+03  6.63691085e+03  9.23188259e+03  2.55791781e+04
  7.63087410e+04]
E1 = -728.3130592390064  E_coul = 201.567028763156
cycle= 6 E= -526.74603047585  delta_E= -5.23e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130592390064  E_coul = 201.567028763156
  HOMO = -0.582655241415616  LUMO = 1.02549254002593
  mo_energy =
[-1.18579807e+02 -1.23094667e+01 -9.56079425e+00 -9.56079425e+00
 -9.56079425e+00 -1.26987892e+00 -5.82655241e-01 -5.82655241e-01
 -5.82655241e-01  1.02549254e+00  1.02549254e+00  1.02549254e+00
  1.03846687e+00  7.45330878e+00  7.45330878e+00  7.45330878e+00
  1.35417589e+01  3.43539643e+01  3.43539643e+01  3.43539643e+01
  1.22489545e+02  1.32422265e+02  1.32422265e+02  1.32422265e+02
  4.87794460e+02  4.87794460e+02  4.87794460e+02  6.64666663e+02
  1.33478271e+03  1.33478271e+03  1.33478271e+03  2.81051403e+03
  3.02168521e+03  3.02168521e+03  3.02168521e+03  6.63691085e+03
  6.63691085e+03  6.63691085e+03  9.23188259e+03  2.55791781e+04
  7.63087410e+04]
E1 = -728.3130584175375  E_coul = 201.56702794168646
Extra cycle  E= -526.746030475851  delta_E= -6.82e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97833.17081267337
E1 = -728.3130584175375  E_coul = 201.56702794168646
init E= -526.746030475851
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582655268022357  LUMO = 1.02549253210023
  mo_energy =
[-1.18579807e+02 -1.23094668e+01 -9.56079433e+00 -9.56079433e+00
 -9.56079433e+00 -1.26987888e+00 -5.82655268e-01 -5.82655268e-01
 -5.82655268e-01  1.02549253e+00  1.02549253e+00  1.02549253e+00
  1.03846692e+00  7.45330873e+00  7.45330873e+00  7.45330873e+00
  1.35417589e+01  3.43539642e+01  3.43539642e+01  3.43539642e+01
  1.22489545e+02  1.32422265e+02  1.32422265e+02  1.32422265e+02
  4.87794460e+02  4.87794460e+02  4.87794460e+02  6.64666663e+02
  1.33478271e+03  1.33478271e+03  1.33478271e+03  2.81051403e+03
  3.02168521e+03  3.02168521e+03  3.02168521e+03  6.63691085e+03
  6.63691085e+03  6.63691085e+03  9.23188259e+03  2.55791781e+04
  7.63087410e+04]
E1 = -728.3130585466638  E_coul = 201.56702807081123
cycle= 1 E= -526.746030475853  delta_E= -1.48e-12  |g|= 7.12e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3130585466638  E_coul = 201.56702807081123
  HOMO = -0.582655267873075  LUMO = 1.02549253454825
  mo_energy =
[-1.18579807e+02 -1.23094667e+01 -9.56079432e+00 -9.56079432e+00
 -9.56079432e+00 -1.26987886e+00 -5.82655268e-01 -5.82655268e-01
 -5.82655268e-01  1.02549253e+00  1.02549253e+00  1.02549253e+00
  1.03846693e+00  7.45330873e+00  7.45330873e+00  7.45330873e+00
  1.35417589e+01  3.43539642e+01  3.43539642e+01  3.43539642e+01
  1.22489545e+02  1.32422265e+02  1.32422265e+02  1.32422265e+02
  4.87794460e+02  4.87794460e+02  4.87794460e+02  6.64666663e+02
  1.33478271e+03  1.33478271e+03  1.33478271e+03  2.81051403e+03
  3.02168521e+03  3.02168521e+03  3.02168521e+03  6.63691085e+03
  6.63691085e+03  6.63691085e+03  9.23188259e+03  2.55791781e+04
  7.63087410e+04]
E1 = -728.3130584895797  E_coul = 201.5670280137275
Extra cycle  E= -526.746030475852  delta_E= 3.41e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.38 sec
exp = [2.61828385e+04 7.61709138e+03 3.61751173e+03 1.58816300e+03
 4.18262943e+02 1.22507253e+02 3.94513953e+01 8.49765620e+00
 3.35475738e+00 6.74229875e-01 2.49748660e-01 1.36284345e+03
 6.64159614e+02 2.98201043e+02 3.11662518e+02 6.30667904e+01
 7.49984418e+00 2.07387271e+01 7.82141542e-01 2.86759498e+00
 2.24079923e-01]
grad_E = [-1.39756037e-06  2.16077618e-06 -2.13777394e-06  3.69808722e-05
  8.43282105e-06  1.29433375e-06  5.89988878e-07 -6.15314934e-07
 -7.79574391e-07 -5.30347985e-06  5.55316403e-06 -5.91134867e-07
  4.00597389e-06  1.82535160e-05  1.55829087e-05  7.74773197e-05
  1.65572342e-05  2.67919337e-05 -6.28162083e-06 -2.57451216e-06
  1.80792938e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8384791        1
[INPUT] 0    0    [1    /1   ]  7617.09142707        1
[INPUT] 0    0    [1    /1   ]  3617.51171581        1
[INPUT] 0    0    [1    /1   ]  1588.16414985        1
[INPUT] 0    0    [1    /1   ]  418.258065545        1
[INPUT] 0    0    [1    /1   ]  122.507478564        1
[INPUT] 0    0    [1    /1   ]  39.4517272793        1
[INPUT] 0    0    [1    /1   ]  8.49800095091        1
[INPUT] 0    0    [1    /1   ]  3.35487600546        1
[INPUT] 0    0    [1    /1   ]  0.674280832015       1
[INPUT] 0    0    [1    /1   ]  0.249765908587       1
[INPUT] 1    0    [1    /1   ]  1362.84344109        1
[INPUT] 1    0    [1    /1   ]  664.159679418        1
[INPUT] 1    0    [1    /1   ]  298.20135174         1
[INPUT] 1    0    [1    /1   ]  311.662784301        1
[INPUT] 1    0    [1    /1   ]  63.0669162602        1
[INPUT] 1    0    [1    /1   ]  7.49923003809        1
[INPUT] 1    0    [1    /1   ]  20.7376712631        1
[INPUT] 1    0    [1    /1   ]  0.782123748459       1
[INPUT] 1    0    [1    /1   ]  2.86740752824        1
[INPUT] 1    0    [1    /1   ]  0.224075747206       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838479058315, 1.0]], [0, [7617.091427074018, 1.0]], [0, [3617.511715814657, 1.0]], [0, [1588.1641498521717, 1.0]], [0, [418.2580655451611, 1.0]], [0, [122.50747856354961, 1.0]], [0, [39.451727279329305, 1.0]], [0, [8.498000950905194, 1.0]], [0, [3.3548760054634386, 1.0]], [0, [0.6742808320152899, 1.0]], [0, [0.24976590858665992, 1.0]], [1, [1362.8434410889433, 1.0]], [1, [664.1596794180448, 1.0]], [1, [298.2013517398911, 1.0]], [1, [311.6627843012061, 1.0]], [1, [63.066916260205886, 1.0]], [1, [7.499230038093311, 1.0]], [1, [20.73767126312135, 1.0]], [1, [0.7821237484586002, 1.0]], [1, [2.867407528235541, 1.0]], [1, [0.22407574720596576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83847906]
bas 1, expnt(s) = [7617.09142707]
bas 2, expnt(s) = [3617.51171581]
bas 3, expnt(s) = [1588.16414985]
bas 4, expnt(s) = [418.25806555]
bas 5, expnt(s) = [122.50747856]
bas 6, expnt(s) = [39.45172728]
bas 7, expnt(s) = [8.49800095]
bas 8, expnt(s) = [3.35487601]
bas 9, expnt(s) = [0.67428083]
bas 10, expnt(s) = [0.24976591]
bas 11, expnt(s) = [1362.84344109]
bas 12, expnt(s) = [664.15967942]
bas 13, expnt(s) = [298.20135174]
bas 14, expnt(s) = [311.6627843]
bas 15, expnt(s) = [63.06691626]
bas 16, expnt(s) = [7.49923004]
bas 17, expnt(s) = [20.73767126]
bas 18, expnt(s) = [0.78212375]
bas 19, expnt(s) = [2.86740753]
bas 20, expnt(s) = [0.22407575]
CPU time:       478.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828385e+04 5.20029007e+03 7.61709143e+03 2.05995105e+03
 3.61751172e+03 1.17848073e+03 1.58816415e+03 6.35603918e+02
 4.18258066e+02 2.33667476e+02 1.22507479e+02 9.30329892e+01
 3.94517273e+01 3.97708196e+01 8.49800095e+00 1.25748440e+01
 3.35487601e+00 6.26285532e+00 6.74280832e-01 1.87994713e+00
 2.49765909e-01 8.92616466e-01 1.36284344e+03 2.41569362e+04
 6.64159679e+02 9.83614734e+03 2.98201352e+02 3.61510905e+03
 3.11662784e+02 3.82023936e+03 6.30669163e+01 5.18485228e+02
 7.49923004e+00 3.62038900e+01 2.07376713e+01 1.29102417e+02
 7.82123748e-01 2.14574809e+00 2.86740753e+00 1.08854445e+01
 2.24075747e-01 4.49757029e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993236192754285
cond(S) = 97832.98579941528
E1 = -729.5313389180031  E_coul = 203.1797863538051
init E= -526.351552564198
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555723359841676  LUMO = 1.04408921639732
  mo_energy =
[-1.18331903e+02 -1.22047241e+01 -9.44677832e+00 -9.44677832e+00
 -9.44677832e+00 -1.23996331e+00 -5.55723360e-01 -5.55723360e-01
 -5.55723360e-01  1.04408922e+00  1.04408922e+00  1.04408922e+00
  1.06066890e+00  7.52393686e+00  7.52393686e+00  7.52393686e+00
  1.36298162e+01  3.44714203e+01  3.44714203e+01  3.44714203e+01
  1.22671895e+02  1.32597000e+02  1.32597000e+02  1.32597000e+02
  4.88035920e+02  4.88035920e+02  4.88035920e+02  6.64958538e+02
  1.33507724e+03  1.33507724e+03  1.33507724e+03  2.81093654e+03
  3.02204449e+03  3.02204449e+03  3.02204449e+03  6.63738157e+03
  6.63738157e+03  6.63738157e+03  9.23241725e+03  2.55798064e+04
  7.63094597e+04]
E1 = -727.8716002046687  E_coul = 201.126333715294
cycle= 1 E= -526.745266489375  delta_E= -0.394  |g|= 0.184  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538038
diis-c [-0.28948487  1.        ]
  HOMO = -0.590196906668026  LUMO = 1.01980250961845
  mo_energy =
[-1.18636934e+02 -1.23413923e+01 -9.59400414e+00 -9.59400414e+00
 -9.59400414e+00 -1.27902266e+00 -5.90196907e-01 -5.90196907e-01
 -5.90196907e-01  1.01980251e+00  1.01980251e+00  1.01980251e+00
  1.03148849e+00  7.43268753e+00  7.43268753e+00  7.43268753e+00
  1.35166217e+01  3.43172010e+01  3.43172010e+01  3.43172010e+01
  1.22444094e+02  1.32369446e+02  1.32369446e+02  1.32369446e+02
  4.87732693e+02  4.87732693e+02  4.87732693e+02  6.64608238e+02
  1.33471867e+03  1.33471867e+03  1.33471867e+03  2.81044345e+03
  3.02162049e+03  3.02162049e+03  3.02162049e+03  6.63684573e+03
  6.63684573e+03  6.63684573e+03  9.23180801e+03  2.55791035e+04
  7.63086671e+04]
E1 = -728.4391136949387  E_coul = 201.69314263436027
cycle= 2 E= -526.745971060578  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744271
diis-c [-0.00324722  0.08213693  0.91786307]
  HOMO = -0.581188166990039  LUMO = 1.02653038840925
  mo_energy =
[-1.18569961e+02 -1.23037638e+01 -9.55473482e+00 -9.55473482e+00
 -9.55473482e+00 -1.26824133e+00 -5.81188167e-01 -5.81188167e-01
 -5.81188167e-01  1.02653039e+00  1.02653039e+00  1.02653039e+00
  1.03984404e+00  7.45649310e+00  7.45649310e+00  7.45649310e+00
  1.35475119e+01  3.43571992e+01  3.43571992e+01  3.43571992e+01
  1.22500856e+02  1.32424964e+02  1.32424964e+02  1.32424964e+02
  4.87798819e+02  4.87798819e+02  4.87798819e+02  6.64677310e+02
  1.33478879e+03  1.33478879e+03  1.33478879e+03  2.81051696e+03
  3.02169286e+03  3.02169286e+03  3.02169286e+03  6.63691985e+03
  6.63691985e+03  6.63691985e+03  9.23188295e+03  2.55791790e+04
  7.63087429e+04]
E1 = -728.2906716399023  E_coul = 201.5446430279693
cycle= 3 E= -526.746028611933  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130364
diis-c [-5.35501113e-07 -1.21931672e-03  1.44694464e-01  8.56524853e-01]
  HOMO = -0.582667048865528  LUMO = 1.02544958921253
  mo_energy =
[-1.18579816e+02 -1.23095071e+01 -9.56081948e+00 -9.56081948e+00
 -9.56081948e+00 -1.26991355e+00 -5.82667049e-01 -5.82667049e-01
 -5.82667049e-01  1.02544959e+00  1.02544959e+00  1.02544959e+00
  1.03856709e+00  7.45271159e+00  7.45271159e+00  7.45271159e+00
  1.35427748e+01  3.43510453e+01  3.43510453e+01  3.43510453e+01
  1.22492443e+02  1.32416673e+02  1.32416673e+02  1.32416673e+02
  4.87789084e+02  4.87789084e+02  4.87789084e+02  6.64667134e+02
  1.33477848e+03  1.33477848e+03  1.33477848e+03  2.81050600e+03
  3.02168216e+03  3.02168216e+03  3.02168216e+03  6.63690876e+03
  6.63690876e+03  6.63690876e+03  9.23187165e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.313181873629  E_coul = 201.56715138527326
cycle= 4 E= -526.746030488356  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108951
diis-c [-3.79221074e-09  6.87387981e-05 -9.93829947e-03 -6.45748829e-02
  1.07444444e+00]
  HOMO = -0.582649126595003  LUMO = 1.02546509665286
  mo_energy =
[-1.18579778e+02 -1.23094447e+01 -9.56077007e+00 -9.56077007e+00
 -9.56077007e+00 -1.26987415e+00 -5.82649127e-01 -5.82649127e-01
 -5.82649127e-01  1.02546510e+00  1.02546510e+00  1.02546510e+00
  1.03860059e+00  7.45275221e+00  7.45275221e+00  7.45275221e+00
  1.35428326e+01  3.43510928e+01  3.43510928e+01  3.43510928e+01
  1.22492492e+02  1.32416719e+02  1.32416719e+02  1.32416719e+02
  4.87789122e+02  4.87789122e+02  4.87789122e+02  6.64667165e+02
  1.33477851e+03  1.33477851e+03  1.33477851e+03  2.81050601e+03
  3.02168218e+03  3.02168218e+03  3.02168218e+03  6.63690877e+03
  6.63690877e+03  6.63690877e+03  9.23187165e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.3129784424003  E_coul = 201.56694795253176
cycle= 5 E= -526.746030489869  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77248e-05
diis-c [-6.69589262e-11  1.39889837e-05 -1.83851385e-03 -1.37463182e-02
  4.27393704e-02  9.72831473e-01]
  HOMO = -0.582656234323569  LUMO = 1.02546032245219
  mo_energy =
[-1.18579807e+02 -1.23094663e+01 -9.56079358e+00 -9.56079358e+00
 -9.56079358e+00 -1.26987983e+00 -5.82656234e-01 -5.82656234e-01
 -5.82656234e-01  1.02546032e+00  1.02546032e+00  1.02546032e+00
  1.03859666e+00  7.45273612e+00  7.45273612e+00  7.45273612e+00
  1.35428146e+01  3.43510699e+01  3.43510699e+01  3.43510699e+01
  1.22492465e+02  1.32416692e+02  1.32416692e+02  1.32416692e+02
  4.87789093e+02  4.87789093e+02  4.87789093e+02  6.64667135e+02
  1.33477848e+03  1.33477848e+03  1.33477848e+03  2.81050598e+03
  3.02168215e+03  3.02168215e+03  3.02168215e+03  6.63690874e+03
  6.63690874e+03  6.63690874e+03  9.23187161e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.3130568065811  E_coul = 201.56702631665917
cycle= 6 E= -526.746030489922  delta_E= -5.34e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130568065811  E_coul = 201.56702631665917
  HOMO = -0.582656259219922  LUMO = 1.02546035852564
  mo_energy =
[-1.18579807e+02 -1.23094662e+01 -9.56079355e+00 -9.56079355e+00
 -9.56079355e+00 -1.26987948e+00 -5.82656259e-01 -5.82656259e-01
 -5.82656259e-01  1.02546036e+00  1.02546036e+00  1.02546036e+00
  1.03859698e+00  7.45273614e+00  7.45273614e+00  7.45273614e+00
  1.35428148e+01  3.43510699e+01  3.43510699e+01  3.43510699e+01
  1.22492465e+02  1.32416692e+02  1.32416692e+02  1.32416692e+02
  4.87789093e+02  4.87789093e+02  4.87789093e+02  6.64667135e+02
  1.33477848e+03  1.33477848e+03  1.33477848e+03  2.81050598e+03
  3.02168215e+03  3.02168215e+03  3.02168215e+03  6.63690874e+03
  6.63690874e+03  6.63690874e+03  9.23187161e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.3130559861031  E_coul = 201.56702549617958
Extra cycle  E= -526.746030489924  delta_E= -1.59e-12  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828385e+04 7.61709143e+03 3.61751172e+03 1.58816415e+03
 4.18258066e+02 1.22507479e+02 3.94517273e+01 8.49800095e+00
 3.35487601e+00 6.74280832e-01 2.49765909e-01 1.36284344e+03
 6.64159679e+02 2.98201352e+02 3.11662784e+02 6.30669163e+01
 7.49923004e+00 2.07376713e+01 7.82123748e-01 2.86740753e+00
 2.24075747e-01]
E = -526.7460304899236
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:14:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8384791        1
[INPUT] 0    0    [1    /1   ]  7617.09142707        1
[INPUT] 0    0    [1    /1   ]  3617.51171581        1
[INPUT] 0    0    [1    /1   ]  1588.16414985        1
[INPUT] 0    0    [1    /1   ]  418.258065545        1
[INPUT] 0    0    [1    /1   ]  122.507478564        1
[INPUT] 0    0    [1    /1   ]  39.4517272793        1
[INPUT] 0    0    [1    /1   ]  8.49800095091        1
[INPUT] 0    0    [1    /1   ]  3.35487600546        1
[INPUT] 0    0    [1    /1   ]  0.674280832015       1
[INPUT] 0    0    [1    /1   ]  0.249765908587       1
[INPUT] 1    0    [1    /1   ]  1362.84344109        1
[INPUT] 1    0    [1    /1   ]  664.159679418        1
[INPUT] 1    0    [1    /1   ]  298.20135174         1
[INPUT] 1    0    [1    /1   ]  311.662784301        1
[INPUT] 1    0    [1    /1   ]  63.0669162602        1
[INPUT] 1    0    [1    /1   ]  7.49923003809        1
[INPUT] 1    0    [1    /1   ]  20.7376712631        1
[INPUT] 1    0    [1    /1   ]  0.782123748459       1
[INPUT] 1    0    [1    /1   ]  2.86740752824        1
[INPUT] 1    0    [1    /1   ]  0.224075747206       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838479058315, 1.0]], [0, [7617.091427074018, 1.0]], [0, [3617.511715814657, 1.0]], [0, [1588.1641498521717, 1.0]], [0, [418.2580655451611, 1.0]], [0, [122.50747856354961, 1.0]], [0, [39.451727279329305, 1.0]], [0, [8.498000950905194, 1.0]], [0, [3.3548760054634386, 1.0]], [0, [0.6742808320152899, 1.0]], [0, [0.24976590858665992, 1.0]], [1, [1362.8434410889433, 1.0]], [1, [664.1596794180448, 1.0]], [1, [298.2013517398911, 1.0]], [1, [311.6627843012061, 1.0]], [1, [63.066916260205886, 1.0]], [1, [7.499230038093311, 1.0]], [1, [20.73767126312135, 1.0]], [1, [0.7821237484586002, 1.0]], [1, [2.867407528235541, 1.0]], [1, [0.22407574720596576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83847906]
bas 1, expnt(s) = [7617.09142707]
bas 2, expnt(s) = [3617.51171581]
bas 3, expnt(s) = [1588.16414985]
bas 4, expnt(s) = [418.25806555]
bas 5, expnt(s) = [122.50747856]
bas 6, expnt(s) = [39.45172728]
bas 7, expnt(s) = [8.49800095]
bas 8, expnt(s) = [3.35487601]
bas 9, expnt(s) = [0.67428083]
bas 10, expnt(s) = [0.24976591]
bas 11, expnt(s) = [1362.84344109]
bas 12, expnt(s) = [664.15967942]
bas 13, expnt(s) = [298.20135174]
bas 14, expnt(s) = [311.6627843]
bas 15, expnt(s) = [63.06691626]
bas 16, expnt(s) = [7.49923004]
bas 17, expnt(s) = [20.73767126]
bas 18, expnt(s) = [0.78212375]
bas 19, expnt(s) = [2.86740753]
bas 20, expnt(s) = [0.22407575]
CPU time:       479.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828385e+04 5.20029007e+03 7.61709143e+03 2.05995105e+03
 3.61751172e+03 1.17848073e+03 1.58816415e+03 6.35603918e+02
 4.18258066e+02 2.33667476e+02 1.22507479e+02 9.30329892e+01
 3.94517273e+01 3.97708196e+01 8.49800095e+00 1.25748440e+01
 3.35487601e+00 6.26285532e+00 6.74280832e-01 1.87994713e+00
 2.49765909e-01 8.92616466e-01 1.36284344e+03 2.41569362e+04
 6.64159679e+02 9.83614734e+03 2.98201352e+02 3.61510905e+03
 3.11662784e+02 3.82023936e+03 6.30669163e+01 5.18485228e+02
 7.49923004e+00 3.62038900e+01 2.07376713e+01 1.29102417e+02
 7.82123748e-01 2.14574809e+00 2.86740753e+00 1.08854445e+01
 2.24075747e-01 4.49757029e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993236192754285
cond(S) = 97832.98579941528
E1 = -729.5313389180031  E_coul = 203.1797863538051
init E= -526.351552564198
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.555723359841676  LUMO = 1.04408921639732
  mo_energy =
[-1.18331903e+02 -1.22047241e+01 -9.44677832e+00 -9.44677832e+00
 -9.44677832e+00 -1.23996331e+00 -5.55723360e-01 -5.55723360e-01
 -5.55723360e-01  1.04408922e+00  1.04408922e+00  1.04408922e+00
  1.06066890e+00  7.52393686e+00  7.52393686e+00  7.52393686e+00
  1.36298162e+01  3.44714203e+01  3.44714203e+01  3.44714203e+01
  1.22671895e+02  1.32597000e+02  1.32597000e+02  1.32597000e+02
  4.88035920e+02  4.88035920e+02  4.88035920e+02  6.64958538e+02
  1.33507724e+03  1.33507724e+03  1.33507724e+03  2.81093654e+03
  3.02204449e+03  3.02204449e+03  3.02204449e+03  6.63738157e+03
  6.63738157e+03  6.63738157e+03  9.23241725e+03  2.55798064e+04
  7.63094597e+04]
E1 = -727.8716002046687  E_coul = 201.126333715294
cycle= 1 E= -526.745266489375  delta_E= -0.394  |g|= 0.184  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538038
diis-c [-0.28948487  1.        ]
  HOMO = -0.590196906668026  LUMO = 1.01980250961845
  mo_energy =
[-1.18636934e+02 -1.23413923e+01 -9.59400414e+00 -9.59400414e+00
 -9.59400414e+00 -1.27902266e+00 -5.90196907e-01 -5.90196907e-01
 -5.90196907e-01  1.01980251e+00  1.01980251e+00  1.01980251e+00
  1.03148849e+00  7.43268753e+00  7.43268753e+00  7.43268753e+00
  1.35166217e+01  3.43172010e+01  3.43172010e+01  3.43172010e+01
  1.22444094e+02  1.32369446e+02  1.32369446e+02  1.32369446e+02
  4.87732693e+02  4.87732693e+02  4.87732693e+02  6.64608238e+02
  1.33471867e+03  1.33471867e+03  1.33471867e+03  2.81044345e+03
  3.02162049e+03  3.02162049e+03  3.02162049e+03  6.63684573e+03
  6.63684573e+03  6.63684573e+03  9.23180801e+03  2.55791035e+04
  7.63086671e+04]
E1 = -728.4391136949387  E_coul = 201.69314263436027
cycle= 2 E= -526.745971060578  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744271
diis-c [-0.00324722  0.08213693  0.91786307]
  HOMO = -0.581188166990039  LUMO = 1.02653038840925
  mo_energy =
[-1.18569961e+02 -1.23037638e+01 -9.55473482e+00 -9.55473482e+00
 -9.55473482e+00 -1.26824133e+00 -5.81188167e-01 -5.81188167e-01
 -5.81188167e-01  1.02653039e+00  1.02653039e+00  1.02653039e+00
  1.03984404e+00  7.45649310e+00  7.45649310e+00  7.45649310e+00
  1.35475119e+01  3.43571992e+01  3.43571992e+01  3.43571992e+01
  1.22500856e+02  1.32424964e+02  1.32424964e+02  1.32424964e+02
  4.87798819e+02  4.87798819e+02  4.87798819e+02  6.64677310e+02
  1.33478879e+03  1.33478879e+03  1.33478879e+03  2.81051696e+03
  3.02169286e+03  3.02169286e+03  3.02169286e+03  6.63691985e+03
  6.63691985e+03  6.63691985e+03  9.23188295e+03  2.55791790e+04
  7.63087429e+04]
E1 = -728.2906716399023  E_coul = 201.5446430279693
cycle= 3 E= -526.746028611933  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130364
diis-c [-5.35501113e-07 -1.21931672e-03  1.44694464e-01  8.56524853e-01]
  HOMO = -0.582667048865528  LUMO = 1.02544958921253
  mo_energy =
[-1.18579816e+02 -1.23095071e+01 -9.56081948e+00 -9.56081948e+00
 -9.56081948e+00 -1.26991355e+00 -5.82667049e-01 -5.82667049e-01
 -5.82667049e-01  1.02544959e+00  1.02544959e+00  1.02544959e+00
  1.03856709e+00  7.45271159e+00  7.45271159e+00  7.45271159e+00
  1.35427748e+01  3.43510453e+01  3.43510453e+01  3.43510453e+01
  1.22492443e+02  1.32416673e+02  1.32416673e+02  1.32416673e+02
  4.87789084e+02  4.87789084e+02  4.87789084e+02  6.64667134e+02
  1.33477848e+03  1.33477848e+03  1.33477848e+03  2.81050600e+03
  3.02168216e+03  3.02168216e+03  3.02168216e+03  6.63690876e+03
  6.63690876e+03  6.63690876e+03  9.23187165e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.313181873629  E_coul = 201.56715138527326
cycle= 4 E= -526.746030488356  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108951
diis-c [-3.79221074e-09  6.87387981e-05 -9.93829947e-03 -6.45748829e-02
  1.07444444e+00]
  HOMO = -0.582649126595003  LUMO = 1.02546509665286
  mo_energy =
[-1.18579778e+02 -1.23094447e+01 -9.56077007e+00 -9.56077007e+00
 -9.56077007e+00 -1.26987415e+00 -5.82649127e-01 -5.82649127e-01
 -5.82649127e-01  1.02546510e+00  1.02546510e+00  1.02546510e+00
  1.03860059e+00  7.45275221e+00  7.45275221e+00  7.45275221e+00
  1.35428326e+01  3.43510928e+01  3.43510928e+01  3.43510928e+01
  1.22492492e+02  1.32416719e+02  1.32416719e+02  1.32416719e+02
  4.87789122e+02  4.87789122e+02  4.87789122e+02  6.64667165e+02
  1.33477851e+03  1.33477851e+03  1.33477851e+03  2.81050601e+03
  3.02168218e+03  3.02168218e+03  3.02168218e+03  6.63690877e+03
  6.63690877e+03  6.63690877e+03  9.23187165e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.3129784424003  E_coul = 201.56694795253176
cycle= 5 E= -526.746030489869  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77248e-05
diis-c [-6.69589262e-11  1.39889837e-05 -1.83851385e-03 -1.37463182e-02
  4.27393704e-02  9.72831473e-01]
  HOMO = -0.582656234323569  LUMO = 1.02546032245219
  mo_energy =
[-1.18579807e+02 -1.23094663e+01 -9.56079358e+00 -9.56079358e+00
 -9.56079358e+00 -1.26987983e+00 -5.82656234e-01 -5.82656234e-01
 -5.82656234e-01  1.02546032e+00  1.02546032e+00  1.02546032e+00
  1.03859666e+00  7.45273612e+00  7.45273612e+00  7.45273612e+00
  1.35428146e+01  3.43510699e+01  3.43510699e+01  3.43510699e+01
  1.22492465e+02  1.32416692e+02  1.32416692e+02  1.32416692e+02
  4.87789093e+02  4.87789093e+02  4.87789093e+02  6.64667135e+02
  1.33477848e+03  1.33477848e+03  1.33477848e+03  2.81050598e+03
  3.02168215e+03  3.02168215e+03  3.02168215e+03  6.63690874e+03
  6.63690874e+03  6.63690874e+03  9.23187161e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.3130568065811  E_coul = 201.56702631665917
cycle= 6 E= -526.746030489922  delta_E= -5.34e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130568065811  E_coul = 201.56702631665917
  HOMO = -0.582656259219922  LUMO = 1.02546035852564
  mo_energy =
[-1.18579807e+02 -1.23094662e+01 -9.56079355e+00 -9.56079355e+00
 -9.56079355e+00 -1.26987948e+00 -5.82656259e-01 -5.82656259e-01
 -5.82656259e-01  1.02546036e+00  1.02546036e+00  1.02546036e+00
  1.03859698e+00  7.45273614e+00  7.45273614e+00  7.45273614e+00
  1.35428148e+01  3.43510699e+01  3.43510699e+01  3.43510699e+01
  1.22492465e+02  1.32416692e+02  1.32416692e+02  1.32416692e+02
  4.87789093e+02  4.87789093e+02  4.87789093e+02  6.64667135e+02
  1.33477848e+03  1.33477848e+03  1.33477848e+03  2.81050598e+03
  3.02168215e+03  3.02168215e+03  3.02168215e+03  6.63690874e+03
  6.63690874e+03  6.63690874e+03  9.23187161e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.3130559861031  E_coul = 201.56702549617958
Extra cycle  E= -526.746030489924  delta_E= -1.59e-12  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97832.98579941528
E1 = -728.3130559861031  E_coul = 201.56702549617958
init E= -526.746030489924
    CPU time for initialize scf      0.90 sec, wall time      0.25 sec
  HOMO = -0.582656285803149  LUMO = 1.02546035061754
  mo_energy =
[-1.18579807e+02 -1.23094663e+01 -9.56079363e+00 -9.56079363e+00
 -9.56079363e+00 -1.26987944e+00 -5.82656286e-01 -5.82656286e-01
 -5.82656286e-01  1.02546035e+00  1.02546035e+00  1.02546035e+00
  1.03859703e+00  7.45273610e+00  7.45273610e+00  7.45273610e+00
  1.35428148e+01  3.43510699e+01  3.43510699e+01  3.43510699e+01
  1.22492465e+02  1.32416692e+02  1.32416692e+02  1.32416692e+02
  4.87789093e+02  4.87789093e+02  4.87789093e+02  6.64667135e+02
  1.33477848e+03  1.33477848e+03  1.33477848e+03  2.81050598e+03
  3.02168215e+03  3.02168215e+03  3.02168215e+03  6.63690874e+03
  6.63690874e+03  6.63690874e+03  9.23187161e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.3130561150101  E_coul = 201.5670256250874
cycle= 1 E= -526.746030489923  delta_E= 7.96e-13  |g|= 7.12e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3130561150101  E_coul = 201.5670256250874
  HOMO = -0.582656285656483  LUMO = 1.02546035306316
  mo_energy =
[-1.18579807e+02 -1.23094663e+01 -9.56079362e+00 -9.56079362e+00
 -9.56079362e+00 -1.26987942e+00 -5.82656286e-01 -5.82656286e-01
 -5.82656286e-01  1.02546035e+00  1.02546035e+00  1.02546035e+00
  1.03859704e+00  7.45273610e+00  7.45273610e+00  7.45273610e+00
  1.35428148e+01  3.43510699e+01  3.43510699e+01  3.43510699e+01
  1.22492465e+02  1.32416692e+02  1.32416692e+02  1.32416692e+02
  4.87789093e+02  4.87789093e+02  4.87789093e+02  6.64667135e+02
  1.33477848e+03  1.33477848e+03  1.33477848e+03  2.81050598e+03
  3.02168215e+03  3.02168215e+03  3.02168215e+03  6.63690874e+03
  6.63690874e+03  6.63690874e+03  9.23187161e+03  2.55791675e+04
  7.63087313e+04]
E1 = -728.3130560579941  E_coul = 201.56702556807122
Extra cycle  E= -526.746030489923  delta_E= -1.14e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828385e+04 7.61709143e+03 3.61751172e+03 1.58816415e+03
 4.18258066e+02 1.22507479e+02 3.94517273e+01 8.49800095e+00
 3.35487601e+00 6.74280832e-01 2.49765909e-01 1.36284344e+03
 6.64159679e+02 2.98201352e+02 3.11662784e+02 6.30669163e+01
 7.49923004e+00 2.07376713e+01 7.82123748e-01 2.86740753e+00
 2.24075747e-01]
grad_E = [-1.39759746e-06  2.16107955e-06 -2.13781867e-06  3.69909154e-05
  8.28683318e-06  1.72311668e-06  3.59557571e-07 -2.13457902e-07
  1.39642242e-06  2.39710982e-06 -1.32441517e-06 -5.91211960e-07
  4.00463631e-06  1.82456073e-05  1.55761752e-05  7.80531974e-05
  7.07889772e-06  2.68725491e-05  6.05148583e-06  8.16732584e-06
 -9.73523584e-06]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8384606        1
[INPUT] 0    0    [1    /1   ]  7617.09147897        1
[INPUT] 0    0    [1    /1   ]  3617.51170627        1
[INPUT] 0    0    [1    /1   ]  1588.16541011        1
[INPUT] 0    0    [1    /1   ]  418.251394981        1
[INPUT] 0    0    [1    /1   ]  122.509599797        1
[INPUT] 0    0    [1    /1   ]  39.4528821658        1
[INPUT] 0    0    [1    /1   ]  8.4989423056         1
[INPUT] 0    0    [1    /1   ]  3.35520300527        1
[INPUT] 0    0    [1    /1   ]  0.674415193381       1
[INPUT] 0    0    [1    /1   ]  0.249811672561       1
[INPUT] 1    0    [1    /1   ]  1362.84343579        1
[INPUT] 1    0    [1    /1   ]  664.159739562        1
[INPUT] 1    0    [1    /1   ]  298.201637087        1
[INPUT] 1    0    [1    /1   ]  311.663031292        1
[INPUT] 1    0    [1    /1   ]  63.0670000434        1
[INPUT] 1    0    [1    /1   ]  7.49786250186        1
[INPUT] 1    0    [1    /1   ]  20.7354131135        1
[INPUT] 1    0    [1    /1   ]  0.782084071282       1
[INPUT] 1    0    [1    /1   ]  2.86698683352        1
[INPUT] 1    0    [1    /1   ]  0.224066236976       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838460604966, 1.0]], [0, [7617.091478965374, 1.0]], [0, [3617.5117062654317, 1.0]], [0, [1588.1654101079653, 1.0]], [0, [418.25139498122564, 1.0]], [0, [122.50959979664214, 1.0]], [0, [39.4528821658274, 1.0]], [0, [8.498942305597835, 1.0]], [0, [3.3552030052737276, 1.0]], [0, [0.6744151933814766, 1.0]], [0, [0.2498116725605034, 1.0]], [1, [1362.843435785894, 1.0]], [1, [664.1597395621061, 1.0]], [1, [298.2016370870841, 1.0]], [1, [311.6630312924555, 1.0]], [1, [63.06700004335255, 1.0]], [1, [7.497862501859177, 1.0]], [1, [20.7354131135222, 1.0]], [1, [0.7820840712821433, 1.0]], [1, [2.866986833521506, 1.0]], [1, [0.22406623697644507, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8384606]
bas 1, expnt(s) = [7617.09147897]
bas 2, expnt(s) = [3617.51170627]
bas 3, expnt(s) = [1588.16541011]
bas 4, expnt(s) = [418.25139498]
bas 5, expnt(s) = [122.5095998]
bas 6, expnt(s) = [39.45288217]
bas 7, expnt(s) = [8.49894231]
bas 8, expnt(s) = [3.35520301]
bas 9, expnt(s) = [0.67441519]
bas 10, expnt(s) = [0.24981167]
bas 11, expnt(s) = [1362.84343579]
bas 12, expnt(s) = [664.15973956]
bas 13, expnt(s) = [298.20163709]
bas 14, expnt(s) = [311.66303129]
bas 15, expnt(s) = [63.06700004]
bas 16, expnt(s) = [7.4978625]
bas 17, expnt(s) = [20.73541311]
bas 18, expnt(s) = [0.78208407]
bas 19, expnt(s) = [2.86698683]
bas 20, expnt(s) = [0.22406624]
CPU time:       485.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828385e+04 5.20029007e+03 7.61709148e+03 2.05995106e+03
 3.61751171e+03 1.17848072e+03 1.58816541e+03 6.35604296e+02
 4.18251395e+02 2.33664681e+02 1.22509600e+02 9.30341973e+01
 3.94528822e+01 3.97716928e+01 8.49894231e+00 1.25758887e+01
 3.35520301e+00 6.26331315e+00 6.74415193e-01 1.88022808e+00
 2.49811673e-01 8.92739127e-01 1.36284344e+03 2.41569361e+04
 6.64159740e+02 9.83614845e+03 2.98201637e+02 3.61511337e+03
 3.11663031e+02 3.82024315e+03 6.30670000e+01 5.18486089e+02
 7.49786250e+00 3.61956377e+01 2.07354131e+01 1.29084845e+02
 7.82084071e-01 2.14561202e+00 2.86698683e+00 1.08834482e+01
 2.24066237e-01 4.49733168e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993237111384946
cond(S) = 97831.3563805842
E1 = -729.5313575975363  E_coul = 203.1797963341589
init E= -526.351561263377
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555723939062165  LUMO = 1.04401645480247
  mo_energy =
[-1.18331904e+02 -1.22047226e+01 -9.44677677e+00 -9.44677677e+00
 -9.44677677e+00 -1.23996211e+00 -5.55723939e-01 -5.55723939e-01
 -5.55723939e-01  1.04401645e+00  1.04401645e+00  1.04401645e+00
  1.06102226e+00  7.52264776e+00  7.52264776e+00  7.52264776e+00
  1.36326966e+01  3.44650175e+01  3.44650175e+01  3.44650175e+01
  1.22681010e+02  1.32584641e+02  1.32584641e+02  1.32584641e+02
  4.88023447e+02  4.88023447e+02  4.88023447e+02  6.64968994e+02
  1.33506636e+03  1.33506636e+03  1.33506636e+03  2.81093678e+03
  3.02203512e+03  3.02203512e+03  3.02203512e+03  6.63737363e+03
  6.63737363e+03  6.63737363e+03  9.23241277e+03  2.55798015e+04
  7.63094553e+04]
E1 = -727.8715879315554  E_coul = 201.12632141644156
cycle= 1 E= -526.745266515114  delta_E= -0.394  |g|= 0.185  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538038
diis-c [-0.28948515  1.        ]
  HOMO = -0.590199469897554  LUMO = 1.01973029373691
  mo_energy =
[-1.18636935e+02 -1.23413916e+01 -9.59400306e+00 -9.59400306e+00
 -9.59400306e+00 -1.27902414e+00 -5.90199470e-01 -5.90199470e-01
 -5.90199470e-01  1.01973029e+00  1.01973029e+00  1.01973029e+00
  1.03183158e+00  7.43140585e+00  7.43140585e+00  7.43140585e+00
  1.35194927e+01  3.43108057e+01  3.43108057e+01  3.43108057e+01
  1.22453206e+02  1.32357087e+02  1.32357087e+02  1.32357087e+02
  4.87720219e+02  4.87720219e+02  4.87720219e+02  6.64618694e+02
  1.33470779e+03  1.33470779e+03  1.33470779e+03  2.81044369e+03
  3.02161112e+03  3.02161112e+03  3.02161112e+03  6.63683779e+03
  6.63683779e+03  6.63683779e+03  9.23180353e+03  2.55790987e+04
  7.63086627e+04]
E1 = -728.4391182814084  E_coul = 201.69314717701567
cycle= 2 E= -526.745971104393  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744277
diis-c [-0.00324735  0.0821362   0.9178638 ]
  HOMO = -0.581190418316418  LUMO = 1.02645786470314
  mo_energy =
[-1.18569961e+02 -1.23037619e+01 -9.55473246e+00 -9.55473246e+00
 -9.55473246e+00 -1.26824242e+00 -5.81190418e-01 -5.81190418e-01
 -5.81190418e-01  1.02645786e+00  1.02645786e+00  1.02645786e+00
  1.04018952e+00  7.45520980e+00  7.45520980e+00  7.45520980e+00
  1.35503859e+01  3.43508031e+01  3.43508031e+01  3.43508031e+01
  1.22509970e+02  1.32412606e+02  1.32412606e+02  1.32412606e+02
  4.87786346e+02  4.87786346e+02  4.87786346e+02  6.64687768e+02
  1.33477792e+03  1.33477792e+03  1.33477792e+03  2.81051720e+03
  3.02168350e+03  3.02168350e+03  3.02168350e+03  6.63691191e+03
  6.63691191e+03  6.63691191e+03  9.23187847e+03  2.55791742e+04
  7.63087385e+04]
E1 = -728.2906679216281  E_coul = 201.54463926124043
cycle= 3 E= -526.746028660388  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130369
diis-c [-5.35484061e-07 -1.21930801e-03  1.44698716e-01  8.56520592e-01]
  HOMO = -0.582669416779464  LUMO = 1.02537706407002
  mo_energy =
[-1.18579816e+02 -1.23095055e+01 -9.56081753e+00 -9.56081753e+00
 -9.56081753e+00 -1.26991479e+00 -5.82669417e-01 -5.82669417e-01
 -5.82669417e-01  1.02537706e+00  1.02537706e+00  1.02537706e+00
  1.03891212e+00  7.45142838e+00  7.45142838e+00  7.45142838e+00
  1.35456482e+01  3.43446491e+01  3.43446491e+01  3.43446491e+01
  1.22501557e+02  1.32404315e+02  1.32404315e+02  1.32404315e+02
  4.87776611e+02  4.87776611e+02  4.87776611e+02  6.64677591e+02
  1.33476760e+03  1.33476760e+03  1.33476760e+03  2.81050624e+03
  3.02167280e+03  3.02167280e+03  3.02167280e+03  6.63690082e+03
  6.63690082e+03  6.63690082e+03  9.23186717e+03  2.55791627e+04
  7.63087269e+04]
E1 = -728.3131803896778  E_coul = 201.56714985255184
cycle= 4 E= -526.746030537126  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108918
diis-c [-3.79258131e-09  6.87084820e-05 -9.93466615e-03 -6.45479766e-02
  1.07441393e+00]
  HOMO = -0.582651485439153  LUMO = 1.02539257653262
  mo_energy =
[-1.18579777e+02 -1.23094431e+01 -9.56076810e+00 -9.56076810e+00
 -9.56076810e+00 -1.26987539e+00 -5.82651485e-01 -5.82651485e-01
 -5.82651485e-01  1.02539258e+00  1.02539258e+00  1.02539258e+00
  1.03894563e+00  7.45146901e+00  7.45146901e+00  7.45146901e+00
  1.35457060e+01  3.43446966e+01  3.43446966e+01  3.43446966e+01
  1.22501605e+02  1.32404361e+02  1.32404361e+02  1.32404361e+02
  4.87776649e+02  4.87776649e+02  4.87776649e+02  6.64677622e+02
  1.33476763e+03  1.33476763e+03  1.33476763e+03  2.81050625e+03
  3.02167282e+03  3.02167282e+03  3.02167282e+03  6.63690083e+03
  6.63690083e+03  6.63690083e+03  9.23186717e+03  2.55791627e+04
  7.63087269e+04]
E1 = -728.3129768858869  E_coul = 201.56694634724641
cycle= 5 E= -526.746030538641  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77281e-05
diis-c [-6.69350187e-11  1.39886031e-05 -1.83856067e-03 -1.37462670e-02
  4.27440745e-02  9.72826765e-01]
  HOMO = -0.582658592935587  LUMO = 1.02538780284592
  mo_energy =
[-1.18579807e+02 -1.23094648e+01 -9.56079161e+00 -9.56079161e+00
 -9.56079161e+00 -1.26988107e+00 -5.82658593e-01 -5.82658593e-01
 -5.82658593e-01  1.02538780e+00  1.02538780e+00  1.02538780e+00
  1.03894170e+00  7.45145293e+00  7.45145293e+00  7.45145293e+00
  1.35456880e+01  3.43446737e+01  3.43446737e+01  3.43446737e+01
  1.22501579e+02  1.32404334e+02  1.32404334e+02  1.32404334e+02
  4.87776620e+02  4.87776620e+02  4.87776620e+02  6.64677592e+02
  1.33476760e+03  1.33476760e+03  1.33476760e+03  2.81050622e+03
  3.02167279e+03  3.02167279e+03  3.02167279e+03  6.63690080e+03
  6.63690080e+03  6.63690080e+03  9.23186714e+03  2.55791627e+04
  7.63087268e+04]
E1 = -728.3130552591615  E_coul = 201.5670247204674
cycle= 6 E= -526.746030538694  delta_E= -5.35e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130552591615  E_coul = 201.5670247204674
  HOMO = -0.582658617907244  LUMO = 1.02538783886027
  mo_energy =
[-1.18579807e+02 -1.23094647e+01 -9.56079158e+00 -9.56079158e+00
 -9.56079158e+00 -1.26988072e+00 -5.82658618e-01 -5.82658618e-01
 -5.82658618e-01  1.02538784e+00  1.02538784e+00  1.02538784e+00
  1.03894202e+00  7.45145295e+00  7.45145295e+00  7.45145295e+00
  1.35456882e+01  3.43446737e+01  3.43446737e+01  3.43446737e+01
  1.22501579e+02  1.32404334e+02  1.32404334e+02  1.32404334e+02
  4.87776620e+02  4.87776620e+02  4.87776620e+02  6.64677592e+02
  1.33476760e+03  1.33476760e+03  1.33476760e+03  2.81050622e+03
  3.02167279e+03  3.02167279e+03  3.02167279e+03  6.63690080e+03
  6.63690080e+03  6.63690080e+03  9.23186714e+03  2.55791627e+04
  7.63087268e+04]
E1 = -728.3130544411769  E_coul = 201.56702390248208
Extra cycle  E= -526.746030538695  delta_E= -6.82e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828385e+04 7.61709148e+03 3.61751171e+03 1.58816541e+03
 4.18251395e+02 1.22509600e+02 3.94528822e+01 8.49894231e+00
 3.35520301e+00 6.74415193e-01 2.49811673e-01 1.36284344e+03
 6.64159740e+02 2.98201637e+02 3.11663031e+02 6.30670000e+01
 7.49786250e+00 2.07354131e+01 7.82084071e-01 2.86698683e+00
 2.24066237e-01]
E = -526.7460305386948
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8384606        1
[INPUT] 0    0    [1    /1   ]  7617.09147897        1
[INPUT] 0    0    [1    /1   ]  3617.51170627        1
[INPUT] 0    0    [1    /1   ]  1588.16541011        1
[INPUT] 0    0    [1    /1   ]  418.251394981        1
[INPUT] 0    0    [1    /1   ]  122.509599797        1
[INPUT] 0    0    [1    /1   ]  39.4528821658        1
[INPUT] 0    0    [1    /1   ]  8.4989423056         1
[INPUT] 0    0    [1    /1   ]  3.35520300527        1
[INPUT] 0    0    [1    /1   ]  0.674415193381       1
[INPUT] 0    0    [1    /1   ]  0.249811672561       1
[INPUT] 1    0    [1    /1   ]  1362.84343579        1
[INPUT] 1    0    [1    /1   ]  664.159739562        1
[INPUT] 1    0    [1    /1   ]  298.201637087        1
[INPUT] 1    0    [1    /1   ]  311.663031292        1
[INPUT] 1    0    [1    /1   ]  63.0670000434        1
[INPUT] 1    0    [1    /1   ]  7.49786250186        1
[INPUT] 1    0    [1    /1   ]  20.7354131135        1
[INPUT] 1    0    [1    /1   ]  0.782084071282       1
[INPUT] 1    0    [1    /1   ]  2.86698683352        1
[INPUT] 1    0    [1    /1   ]  0.224066236976       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838460604966, 1.0]], [0, [7617.091478965374, 1.0]], [0, [3617.5117062654317, 1.0]], [0, [1588.1654101079653, 1.0]], [0, [418.25139498122564, 1.0]], [0, [122.50959979664214, 1.0]], [0, [39.4528821658274, 1.0]], [0, [8.498942305597835, 1.0]], [0, [3.3552030052737276, 1.0]], [0, [0.6744151933814766, 1.0]], [0, [0.2498116725605034, 1.0]], [1, [1362.843435785894, 1.0]], [1, [664.1597395621061, 1.0]], [1, [298.2016370870841, 1.0]], [1, [311.6630312924555, 1.0]], [1, [63.06700004335255, 1.0]], [1, [7.497862501859177, 1.0]], [1, [20.7354131135222, 1.0]], [1, [0.7820840712821433, 1.0]], [1, [2.866986833521506, 1.0]], [1, [0.22406623697644507, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8384606]
bas 1, expnt(s) = [7617.09147897]
bas 2, expnt(s) = [3617.51170627]
bas 3, expnt(s) = [1588.16541011]
bas 4, expnt(s) = [418.25139498]
bas 5, expnt(s) = [122.5095998]
bas 6, expnt(s) = [39.45288217]
bas 7, expnt(s) = [8.49894231]
bas 8, expnt(s) = [3.35520301]
bas 9, expnt(s) = [0.67441519]
bas 10, expnt(s) = [0.24981167]
bas 11, expnt(s) = [1362.84343579]
bas 12, expnt(s) = [664.15973956]
bas 13, expnt(s) = [298.20163709]
bas 14, expnt(s) = [311.66303129]
bas 15, expnt(s) = [63.06700004]
bas 16, expnt(s) = [7.4978625]
bas 17, expnt(s) = [20.73541311]
bas 18, expnt(s) = [0.78208407]
bas 19, expnt(s) = [2.86698683]
bas 20, expnt(s) = [0.22406624]
CPU time:       485.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828385e+04 5.20029007e+03 7.61709148e+03 2.05995106e+03
 3.61751171e+03 1.17848072e+03 1.58816541e+03 6.35604296e+02
 4.18251395e+02 2.33664681e+02 1.22509600e+02 9.30341973e+01
 3.94528822e+01 3.97716928e+01 8.49894231e+00 1.25758887e+01
 3.35520301e+00 6.26331315e+00 6.74415193e-01 1.88022808e+00
 2.49811673e-01 8.92739127e-01 1.36284344e+03 2.41569361e+04
 6.64159740e+02 9.83614845e+03 2.98201637e+02 3.61511337e+03
 3.11663031e+02 3.82024315e+03 6.30670000e+01 5.18486089e+02
 7.49786250e+00 3.61956377e+01 2.07354131e+01 1.29084845e+02
 7.82084071e-01 2.14561202e+00 2.86698683e+00 1.08834482e+01
 2.24066237e-01 4.49733168e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993237111384946
cond(S) = 97831.3563805842
E1 = -729.5313575975363  E_coul = 203.1797963341589
init E= -526.351561263377
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555723939062165  LUMO = 1.04401645480247
  mo_energy =
[-1.18331904e+02 -1.22047226e+01 -9.44677677e+00 -9.44677677e+00
 -9.44677677e+00 -1.23996211e+00 -5.55723939e-01 -5.55723939e-01
 -5.55723939e-01  1.04401645e+00  1.04401645e+00  1.04401645e+00
  1.06102226e+00  7.52264776e+00  7.52264776e+00  7.52264776e+00
  1.36326966e+01  3.44650175e+01  3.44650175e+01  3.44650175e+01
  1.22681010e+02  1.32584641e+02  1.32584641e+02  1.32584641e+02
  4.88023447e+02  4.88023447e+02  4.88023447e+02  6.64968994e+02
  1.33506636e+03  1.33506636e+03  1.33506636e+03  2.81093678e+03
  3.02203512e+03  3.02203512e+03  3.02203512e+03  6.63737363e+03
  6.63737363e+03  6.63737363e+03  9.23241277e+03  2.55798015e+04
  7.63094553e+04]
E1 = -727.8715879315554  E_coul = 201.12632141644156
cycle= 1 E= -526.745266515114  delta_E= -0.394  |g|= 0.185  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538038
diis-c [-0.28948515  1.        ]
  HOMO = -0.590199469897554  LUMO = 1.01973029373691
  mo_energy =
[-1.18636935e+02 -1.23413916e+01 -9.59400306e+00 -9.59400306e+00
 -9.59400306e+00 -1.27902414e+00 -5.90199470e-01 -5.90199470e-01
 -5.90199470e-01  1.01973029e+00  1.01973029e+00  1.01973029e+00
  1.03183158e+00  7.43140585e+00  7.43140585e+00  7.43140585e+00
  1.35194927e+01  3.43108057e+01  3.43108057e+01  3.43108057e+01
  1.22453206e+02  1.32357087e+02  1.32357087e+02  1.32357087e+02
  4.87720219e+02  4.87720219e+02  4.87720219e+02  6.64618694e+02
  1.33470779e+03  1.33470779e+03  1.33470779e+03  2.81044369e+03
  3.02161112e+03  3.02161112e+03  3.02161112e+03  6.63683779e+03
  6.63683779e+03  6.63683779e+03  9.23180353e+03  2.55790987e+04
  7.63086627e+04]
E1 = -728.4391182814084  E_coul = 201.69314717701567
cycle= 2 E= -526.745971104393  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744277
diis-c [-0.00324735  0.0821362   0.9178638 ]
  HOMO = -0.581190418316418  LUMO = 1.02645786470314
  mo_energy =
[-1.18569961e+02 -1.23037619e+01 -9.55473246e+00 -9.55473246e+00
 -9.55473246e+00 -1.26824242e+00 -5.81190418e-01 -5.81190418e-01
 -5.81190418e-01  1.02645786e+00  1.02645786e+00  1.02645786e+00
  1.04018952e+00  7.45520980e+00  7.45520980e+00  7.45520980e+00
  1.35503859e+01  3.43508031e+01  3.43508031e+01  3.43508031e+01
  1.22509970e+02  1.32412606e+02  1.32412606e+02  1.32412606e+02
  4.87786346e+02  4.87786346e+02  4.87786346e+02  6.64687768e+02
  1.33477792e+03  1.33477792e+03  1.33477792e+03  2.81051720e+03
  3.02168350e+03  3.02168350e+03  3.02168350e+03  6.63691191e+03
  6.63691191e+03  6.63691191e+03  9.23187847e+03  2.55791742e+04
  7.63087385e+04]
E1 = -728.2906679216281  E_coul = 201.54463926124043
cycle= 3 E= -526.746028660388  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130369
diis-c [-5.35484061e-07 -1.21930801e-03  1.44698716e-01  8.56520592e-01]
  HOMO = -0.582669416779464  LUMO = 1.02537706407002
  mo_energy =
[-1.18579816e+02 -1.23095055e+01 -9.56081753e+00 -9.56081753e+00
 -9.56081753e+00 -1.26991479e+00 -5.82669417e-01 -5.82669417e-01
 -5.82669417e-01  1.02537706e+00  1.02537706e+00  1.02537706e+00
  1.03891212e+00  7.45142838e+00  7.45142838e+00  7.45142838e+00
  1.35456482e+01  3.43446491e+01  3.43446491e+01  3.43446491e+01
  1.22501557e+02  1.32404315e+02  1.32404315e+02  1.32404315e+02
  4.87776611e+02  4.87776611e+02  4.87776611e+02  6.64677591e+02
  1.33476760e+03  1.33476760e+03  1.33476760e+03  2.81050624e+03
  3.02167280e+03  3.02167280e+03  3.02167280e+03  6.63690082e+03
  6.63690082e+03  6.63690082e+03  9.23186717e+03  2.55791627e+04
  7.63087269e+04]
E1 = -728.3131803896778  E_coul = 201.56714985255184
cycle= 4 E= -526.746030537126  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108918
diis-c [-3.79258131e-09  6.87084820e-05 -9.93466615e-03 -6.45479766e-02
  1.07441393e+00]
  HOMO = -0.582651485439153  LUMO = 1.02539257653262
  mo_energy =
[-1.18579777e+02 -1.23094431e+01 -9.56076810e+00 -9.56076810e+00
 -9.56076810e+00 -1.26987539e+00 -5.82651485e-01 -5.82651485e-01
 -5.82651485e-01  1.02539258e+00  1.02539258e+00  1.02539258e+00
  1.03894563e+00  7.45146901e+00  7.45146901e+00  7.45146901e+00
  1.35457060e+01  3.43446966e+01  3.43446966e+01  3.43446966e+01
  1.22501605e+02  1.32404361e+02  1.32404361e+02  1.32404361e+02
  4.87776649e+02  4.87776649e+02  4.87776649e+02  6.64677622e+02
  1.33476763e+03  1.33476763e+03  1.33476763e+03  2.81050625e+03
  3.02167282e+03  3.02167282e+03  3.02167282e+03  6.63690083e+03
  6.63690083e+03  6.63690083e+03  9.23186717e+03  2.55791627e+04
  7.63087269e+04]
E1 = -728.3129768858869  E_coul = 201.56694634724641
cycle= 5 E= -526.746030538641  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77281e-05
diis-c [-6.69350187e-11  1.39886031e-05 -1.83856067e-03 -1.37462670e-02
  4.27440745e-02  9.72826765e-01]
  HOMO = -0.582658592935587  LUMO = 1.02538780284592
  mo_energy =
[-1.18579807e+02 -1.23094648e+01 -9.56079161e+00 -9.56079161e+00
 -9.56079161e+00 -1.26988107e+00 -5.82658593e-01 -5.82658593e-01
 -5.82658593e-01  1.02538780e+00  1.02538780e+00  1.02538780e+00
  1.03894170e+00  7.45145293e+00  7.45145293e+00  7.45145293e+00
  1.35456880e+01  3.43446737e+01  3.43446737e+01  3.43446737e+01
  1.22501579e+02  1.32404334e+02  1.32404334e+02  1.32404334e+02
  4.87776620e+02  4.87776620e+02  4.87776620e+02  6.64677592e+02
  1.33476760e+03  1.33476760e+03  1.33476760e+03  2.81050622e+03
  3.02167279e+03  3.02167279e+03  3.02167279e+03  6.63690080e+03
  6.63690080e+03  6.63690080e+03  9.23186714e+03  2.55791627e+04
  7.63087268e+04]
E1 = -728.3130552591615  E_coul = 201.5670247204674
cycle= 6 E= -526.746030538694  delta_E= -5.35e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130552591615  E_coul = 201.5670247204674
  HOMO = -0.582658617907244  LUMO = 1.02538783886027
  mo_energy =
[-1.18579807e+02 -1.23094647e+01 -9.56079158e+00 -9.56079158e+00
 -9.56079158e+00 -1.26988072e+00 -5.82658618e-01 -5.82658618e-01
 -5.82658618e-01  1.02538784e+00  1.02538784e+00  1.02538784e+00
  1.03894202e+00  7.45145295e+00  7.45145295e+00  7.45145295e+00
  1.35456882e+01  3.43446737e+01  3.43446737e+01  3.43446737e+01
  1.22501579e+02  1.32404334e+02  1.32404334e+02  1.32404334e+02
  4.87776620e+02  4.87776620e+02  4.87776620e+02  6.64677592e+02
  1.33476760e+03  1.33476760e+03  1.33476760e+03  2.81050622e+03
  3.02167279e+03  3.02167279e+03  3.02167279e+03  6.63690080e+03
  6.63690080e+03  6.63690080e+03  9.23186714e+03  2.55791627e+04
  7.63087268e+04]
E1 = -728.3130544411769  E_coul = 201.56702390248208
Extra cycle  E= -526.746030538695  delta_E= -6.82e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97831.3563805842
E1 = -728.3130544411769  E_coul = 201.56702390248208
init E= -526.746030538695
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582658644431162  LUMO = 1.02538783099539
  mo_energy =
[-1.18579807e+02 -1.23094647e+01 -9.56079166e+00 -9.56079166e+00
 -9.56079166e+00 -1.26988068e+00 -5.82658644e-01 -5.82658644e-01
 -5.82658644e-01  1.02538783e+00  1.02538783e+00  1.02538783e+00
  1.03894207e+00  7.45145290e+00  7.45145290e+00  7.45145290e+00
  1.35456881e+01  3.43446737e+01  3.43446737e+01  3.43446737e+01
  1.22501579e+02  1.32404334e+02  1.32404334e+02  1.32404334e+02
  4.87776620e+02  4.87776620e+02  4.87776620e+02  6.64677592e+02
  1.33476760e+03  1.33476760e+03  1.33476760e+03  2.81050622e+03
  3.02167279e+03  3.02167279e+03  3.02167279e+03  6.63690080e+03
  6.63690080e+03  6.63690080e+03  9.23186714e+03  2.55791627e+04
  7.63087268e+04]
E1 = -728.313054569541  E_coul = 201.56702403084782
cycle= 1 E= -526.746030538693  delta_E= 1.59e-12  |g|= 7.12e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.313054569541  E_coul = 201.56702403084782
  HOMO = -0.582658644292973  LUMO = 1.02538783343445
  mo_energy =
[-1.18579807e+02 -1.23094647e+01 -9.56079165e+00 -9.56079165e+00
 -9.56079165e+00 -1.26988066e+00 -5.82658644e-01 -5.82658644e-01
 -5.82658644e-01  1.02538783e+00  1.02538783e+00  1.02538783e+00
  1.03894209e+00  7.45145291e+00  7.45145291e+00  7.45145291e+00
  1.35456882e+01  3.43446737e+01  3.43446737e+01  3.43446737e+01
  1.22501579e+02  1.32404334e+02  1.32404334e+02  1.32404334e+02
  4.87776620e+02  4.87776620e+02  4.87776620e+02  6.64677592e+02
  1.33476760e+03  1.33476760e+03  1.33476760e+03  2.81050622e+03
  3.02167279e+03  3.02167279e+03  3.02167279e+03  6.63690080e+03
  6.63690080e+03  6.63690080e+03  9.23186714e+03  2.55791627e+04
  7.63087268e+04]
E1 = -728.3130545126969  E_coul = 201.5670239740028
Extra cycle  E= -526.746030538694  delta_E= -9.09e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.38 sec
exp = [2.61828385e+04 7.61709148e+03 3.61751171e+03 1.58816541e+03
 4.18251395e+02 1.22509600e+02 3.94528822e+01 8.49894231e+00
 3.35520301e+00 6.74415193e-01 2.49811673e-01 1.36284344e+03
 6.64159740e+02 2.98201637e+02 3.11663031e+02 6.30670000e+01
 7.49786250e+00 2.07354131e+01 7.82084071e-01 2.86698683e+00
 2.24066237e-01]
grad_E = [-1.39766807e-06  2.16165682e-06 -2.13793135e-06  3.70107541e-05
  7.95282946e-06  2.84286258e-06 -3.35523384e-07  7.93385373e-07
  7.39024433e-06  2.25624439e-05 -1.99610838e-05 -5.91355855e-07
  4.00216244e-06  1.82310164e-05  1.55637381e-05  7.90659575e-05
 -1.74701843e-05  2.86892084e-05  3.59616156e-05  3.45703600e-05
 -7.96395665e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8384718        1
[INPUT] 0    0    [1    /1   ]  7617.09147417        1
[INPUT] 0    0    [1    /1   ]  3617.51173338        1
[INPUT] 0    0    [1    /1   ]  1588.16553477        1
[INPUT] 0    0    [1    /1   ]  418.246966367        1
[INPUT] 0    0    [1    /1   ]  122.513861741        1
[INPUT] 0    0    [1    /1   ]  39.4547540001        1
[INPUT] 0    0    [1    /1   ]  8.50032536463        1
[INPUT] 0    0    [1    /1   ]  3.35568222323        1
[INPUT] 0    0    [1    /1   ]  0.674606926913       1
[INPUT] 0    0    [1    /1   ]  0.249877257617       1
[INPUT] 1    0    [1    /1   ]  1362.84344173        1
[INPUT] 1    0    [1    /1   ]  664.159709468        1
[INPUT] 1    0    [1    /1   ]  298.201503858        1
[INPUT] 1    0    [1    /1   ]  311.662919235        1
[INPUT] 1    0    [1    /1   ]  63.0665218675        1
[INPUT] 1    0    [1    /1   ]  7.49600268721        1
[INPUT] 1    0    [1    /1   ]  20.7323519648        1
[INPUT] 1    0    [1    /1   ]  0.782029363355       1
[INPUT] 1    0    [1    /1   ]  2.86640942835        1
[INPUT] 1    0    [1    /1   ]  0.22405306227        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.8384717997, 1.0]], [0, [7617.09147417014, 1.0]], [0, [3617.5117333849594, 1.0]], [0, [1588.1655347722324, 1.0]], [0, [418.2469663668838, 1.0]], [0, [122.51386174134167, 1.0]], [0, [39.45475400012169, 1.0]], [0, [8.5003253646331, 1.0]], [0, [3.3556822232321353, 1.0]], [0, [0.6746069269126451, 1.0]], [0, [0.24987725761660645, 1.0]], [1, [1362.8434417318106, 1.0]], [1, [664.1597094684886, 1.0]], [1, [298.2015038580768, 1.0]], [1, [311.6629192352187, 1.0]], [1, [63.06652186747874, 1.0]], [1, [7.496002687212646, 1.0]], [1, [20.732351964768796, 1.0]], [1, [0.7820293633545843, 1.0]], [1, [2.8664094283485584, 1.0]], [1, [0.2240530622696899, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8384718]
bas 1, expnt(s) = [7617.09147417]
bas 2, expnt(s) = [3617.51173338]
bas 3, expnt(s) = [1588.16553477]
bas 4, expnt(s) = [418.24696637]
bas 5, expnt(s) = [122.51386174]
bas 6, expnt(s) = [39.454754]
bas 7, expnt(s) = [8.50032536]
bas 8, expnt(s) = [3.35568222]
bas 9, expnt(s) = [0.67460693]
bas 10, expnt(s) = [0.24987726]
bas 11, expnt(s) = [1362.84344173]
bas 12, expnt(s) = [664.15970947]
bas 13, expnt(s) = [298.20150386]
bas 14, expnt(s) = [311.66291924]
bas 15, expnt(s) = [63.06652187]
bas 16, expnt(s) = [7.49600269]
bas 17, expnt(s) = [20.73235196]
bas 18, expnt(s) = [0.78202936]
bas 19, expnt(s) = [2.86640943]
bas 20, expnt(s) = [0.22405306]
CPU time:       491.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828385e+04 5.20029007e+03 7.61709147e+03 2.05995106e+03
 3.61751173e+03 1.17848073e+03 1.58816553e+03 6.35604333e+02
 4.18246966e+02 2.33662825e+02 1.22513862e+02 9.30366247e+01
 3.94547540e+01 3.97731080e+01 8.50032536e+00 1.25774236e+01
 3.35568222e+00 6.26398407e+00 6.74606927e-01 1.88062897e+00
 2.49877258e-01 8.92914905e-01 1.36284344e+03 2.41569363e+04
 6.64159709e+02 9.83614790e+03 2.98201504e+02 3.61511135e+03
 3.11662919e+02 3.82024143e+03 6.30665219e+01 5.18481175e+02
 7.49600269e+00 3.61844153e+01 2.07323520e+01 1.29061025e+02
 7.82029363e-01 2.14542441e+00 2.86640943e+00 1.08807084e+01
 2.24053062e-01 4.49700114e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993238337286336
cond(S) = 97826.93131339074
E1 = -729.5313828902587  E_coul = 203.17981064981612
init E= -526.351572240443
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55572474201418  LUMO = 1.04391590723781
  mo_energy =
[-1.18331905e+02 -1.22047203e+01 -9.44677458e+00 -9.44677458e+00
 -9.44677458e+00 -1.23996041e+00 -5.55724742e-01 -5.55724742e-01
 -5.55724742e-01  1.04391591e+00  1.04391591e+00  1.04391591e+00
  1.06152821e+00  7.52088009e+00  7.52088009e+00  7.52088009e+00
  1.36368978e+01  3.44562943e+01  3.44562943e+01  3.44562943e+01
  1.22695217e+02  1.32567275e+02  1.32567275e+02  1.32567275e+02
  4.88004494e+02  4.88004494e+02  4.88004494e+02  6.64991470e+02
  1.33504818e+03  1.33504818e+03  1.33504818e+03  2.81095459e+03
  3.02201757e+03  3.02201757e+03  3.02201757e+03  6.63735722e+03
  6.63735722e+03  6.63735722e+03  9.23242598e+03  2.55798130e+04
  7.63094657e+04]
E1 = -727.8715725006142  E_coul = 201.12630591026004
cycle= 1 E= -526.745266590354  delta_E= -0.394  |g|= 0.185  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538038
diis-c [-0.28948488  1.        ]
  HOMO = -0.590203002281967  LUMO = 1.01963051030131
  mo_energy =
[-1.18636936e+02 -1.23413904e+01 -9.59400148e+00 -9.59400148e+00
 -9.59400148e+00 -1.27902615e+00 -5.90203002e-01 -5.90203002e-01
 -5.90203002e-01  1.01963051e+00  1.01963051e+00  1.01963051e+00
  1.03232294e+00  7.42964834e+00  7.42964834e+00  7.42964834e+00
  1.35236802e+01  3.43020927e+01  3.43020927e+01  3.43020927e+01
  1.22467407e+02  1.32339722e+02  1.32339722e+02  1.32339722e+02
  4.87701263e+02  4.87701263e+02  4.87701263e+02  6.64641169e+02
  1.33468961e+03  1.33468961e+03  1.33468961e+03  2.81046150e+03
  3.02159357e+03  3.02159357e+03  3.02159357e+03  6.63682138e+03
  6.63682138e+03  6.63682138e+03  9.23181674e+03  2.55791102e+04
  7.63086731e+04]
E1 = -728.4391258280538  E_coul = 201.69315462458212
cycle= 2 E= -526.745971203472  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744285
diis-c [-0.00324753  0.08213529  0.91786471]
  HOMO = -0.581193524469868  LUMO = 1.02635765366815
  mo_energy =
[-1.18569960e+02 -1.23037591e+01 -9.55472914e+00 -9.55472914e+00
 -9.55472914e+00 -1.26824390e+00 -5.81193524e-01 -5.81193524e-01
 -5.81193524e-01  1.02635765e+00  1.02635765e+00  1.02635765e+00
  1.04068429e+00  7.45345006e+00  7.45345006e+00  7.45345006e+00
  1.35545776e+01  3.43420891e+01  3.43420891e+01  3.43420891e+01
  1.22524174e+02  1.32395242e+02  1.32395242e+02  1.32395242e+02
  4.87767393e+02  4.87767393e+02  4.87767393e+02  6.64710246e+02
  1.33475974e+03  1.33475974e+03  1.33475974e+03  2.81053501e+03
  3.02166595e+03  3.02166595e+03  3.02166595e+03  6.63689551e+03
  6.63689551e+03  6.63689551e+03  9.23189168e+03  2.55791857e+04
  7.63087489e+04]
E1 = -728.2906640571024  E_coul = 201.54463529126755
cycle= 3 E= -526.746028765835  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130377
diis-c [-5.35456195e-07 -1.21929417e-03  1.44704559e-01  8.56514735e-01]
  HOMO = -0.582672682230087  LUMO = 1.02527685206192
  mo_energy =
[-1.18579816e+02 -1.23095033e+01 -9.56081478e+00 -9.56081478e+00
 -9.56081478e+00 -1.26991649e+00 -5.82672682e-01 -5.82672682e-01
 -5.82672682e-01  1.02527685e+00  1.02527685e+00  1.02527685e+00
  1.03940625e+00  7.44966877e+00  7.44966877e+00  7.44966877e+00
  1.35498390e+01  3.43359350e+01  3.43359350e+01  3.43359350e+01
  1.22515759e+02  1.32386951e+02  1.32386951e+02  1.32386951e+02
  4.87757657e+02  4.87757657e+02  4.87757657e+02  6.64700068e+02
  1.33474942e+03  1.33474942e+03  1.33474942e+03  2.81052406e+03
  3.02165525e+03  3.02165525e+03  3.02165525e+03  6.63688442e+03
  6.63688442e+03  6.63688442e+03  9.23188038e+03  2.55791742e+04
  7.63087373e+04]
E1 = -728.3131795998897  E_coul = 201.5671489568793
cycle= 4 E= -526.74603064301  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108871
diis-c [-3.79305299e-09  6.86658076e-05 -9.92952313e-03 -6.45100498e-02
  1.07437091e+00]
  HOMO = -0.582654738265947  LUMO = 1.02529237150046
  mo_energy =
[-1.18579777e+02 -1.23094409e+01 -9.56076531e+00 -9.56076531e+00
 -9.56076531e+00 -1.26987708e+00 -5.82654738e-01 -5.82654738e-01
 -5.82654738e-01  1.02529237e+00  1.02529237e+00  1.02529237e+00
  1.03943977e+00  7.44970942e+00  7.44970942e+00  7.44970942e+00
  1.35498968e+01  3.43359825e+01  3.43359825e+01  3.43359825e+01
  1.22515808e+02  1.32386996e+02  1.32386996e+02  1.32386996e+02
  4.87757696e+02  4.87757696e+02  4.87757696e+02  6.64700099e+02
  1.33474945e+03  1.33474945e+03  1.33474945e+03  2.81052407e+03
  3.02165527e+03  3.02165527e+03  3.02165527e+03  6.63688442e+03
  6.63688442e+03  6.63688442e+03  9.23188038e+03  2.55791742e+04
  7.63087373e+04]
E1 = -728.3129759967411  E_coul = 201.56694535221826
cycle= 5 E= -526.746030644523  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77324e-05
diis-c [-6.69008703e-11  1.39879875e-05 -1.83860669e-03 -1.37460819e-02
  4.27504223e-02  9.72820278e-01]
  HOMO = -0.582661845378264  LUMO = 1.02528759856499
  mo_energy =
[-1.18579807e+02 -1.23094625e+01 -9.56078881e+00 -9.56078881e+00
 -9.56078881e+00 -1.26988275e+00 -5.82661845e-01 -5.82661845e-01
 -5.82661845e-01  1.02528760e+00  1.02528760e+00  1.02528760e+00
  1.03943584e+00  7.44969334e+00  7.44969334e+00  7.44969334e+00
  1.35498788e+01  3.43359596e+01  3.43359596e+01  3.43359596e+01
  1.22515781e+02  1.32386969e+02  1.32386969e+02  1.32386969e+02
  4.87757666e+02  4.87757666e+02  4.87757666e+02  6.64700069e+02
  1.33474942e+03  1.33474942e+03  1.33474942e+03  2.81052403e+03
  3.02165524e+03  3.02165524e+03  3.02165524e+03  6.63688439e+03
  6.63688439e+03  6.63688439e+03  9.23188035e+03  2.55791741e+04
  7.63087373e+04]
E1 = -728.3130543822839  E_coul = 201.5670237377062
cycle= 6 E= -526.746030644578  delta_E= -5.48e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130543822839  E_coul = 201.5670237377062
  HOMO = -0.582661870450408  LUMO = 1.02528763449957
  mo_energy =
[-1.18579807e+02 -1.23094624e+01 -9.56078879e+00 -9.56078879e+00
 -9.56078879e+00 -1.26988241e+00 -5.82661870e-01 -5.82661870e-01
 -5.82661870e-01  1.02528763e+00  1.02528763e+00  1.02528763e+00
  1.03943617e+00  7.44969336e+00  7.44969336e+00  7.44969336e+00
  1.35498790e+01  3.43359596e+01  3.43359596e+01  3.43359596e+01
  1.22515781e+02  1.32386970e+02  1.32386970e+02  1.32386970e+02
  4.87757666e+02  4.87757666e+02  4.87757666e+02  6.64700069e+02
  1.33474942e+03  1.33474942e+03  1.33474942e+03  2.81052403e+03
  3.02165524e+03  3.02165524e+03  3.02165524e+03  6.63688439e+03
  6.63688439e+03  6.63688439e+03  9.23188035e+03  2.55791741e+04
  7.63087373e+04]
E1 = -728.3130535677768  E_coul = 201.56702292320065
Extra cycle  E= -526.746030644576  delta_E= 1.48e-12  |g|= 3.42e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828385e+04 7.61709147e+03 3.61751173e+03 1.58816553e+03
 4.18246966e+02 1.22513862e+02 3.94547540e+01 8.50032536e+00
 3.35568222e+00 6.74606927e-01 2.49877258e-01 1.36284344e+03
 6.64159709e+02 2.98201504e+02 3.11662919e+02 6.30665219e+01
 7.49600269e+00 2.07323520e+01 7.82029363e-01 2.86640943e+00
 2.24053062e-01]
E = -526.7460306445762
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8384718        1
[INPUT] 0    0    [1    /1   ]  7617.09147417        1
[INPUT] 0    0    [1    /1   ]  3617.51173338        1
[INPUT] 0    0    [1    /1   ]  1588.16553477        1
[INPUT] 0    0    [1    /1   ]  418.246966367        1
[INPUT] 0    0    [1    /1   ]  122.513861741        1
[INPUT] 0    0    [1    /1   ]  39.4547540001        1
[INPUT] 0    0    [1    /1   ]  8.50032536463        1
[INPUT] 0    0    [1    /1   ]  3.35568222323        1
[INPUT] 0    0    [1    /1   ]  0.674606926913       1
[INPUT] 0    0    [1    /1   ]  0.249877257617       1
[INPUT] 1    0    [1    /1   ]  1362.84344173        1
[INPUT] 1    0    [1    /1   ]  664.159709468        1
[INPUT] 1    0    [1    /1   ]  298.201503858        1
[INPUT] 1    0    [1    /1   ]  311.662919235        1
[INPUT] 1    0    [1    /1   ]  63.0665218675        1
[INPUT] 1    0    [1    /1   ]  7.49600268721        1
[INPUT] 1    0    [1    /1   ]  20.7323519648        1
[INPUT] 1    0    [1    /1   ]  0.782029363355       1
[INPUT] 1    0    [1    /1   ]  2.86640942835        1
[INPUT] 1    0    [1    /1   ]  0.22405306227        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.8384717997, 1.0]], [0, [7617.09147417014, 1.0]], [0, [3617.5117333849594, 1.0]], [0, [1588.1655347722324, 1.0]], [0, [418.2469663668838, 1.0]], [0, [122.51386174134167, 1.0]], [0, [39.45475400012169, 1.0]], [0, [8.5003253646331, 1.0]], [0, [3.3556822232321353, 1.0]], [0, [0.6746069269126451, 1.0]], [0, [0.24987725761660645, 1.0]], [1, [1362.8434417318106, 1.0]], [1, [664.1597094684886, 1.0]], [1, [298.2015038580768, 1.0]], [1, [311.6629192352187, 1.0]], [1, [63.06652186747874, 1.0]], [1, [7.496002687212646, 1.0]], [1, [20.732351964768796, 1.0]], [1, [0.7820293633545843, 1.0]], [1, [2.8664094283485584, 1.0]], [1, [0.2240530622696899, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8384718]
bas 1, expnt(s) = [7617.09147417]
bas 2, expnt(s) = [3617.51173338]
bas 3, expnt(s) = [1588.16553477]
bas 4, expnt(s) = [418.24696637]
bas 5, expnt(s) = [122.51386174]
bas 6, expnt(s) = [39.454754]
bas 7, expnt(s) = [8.50032536]
bas 8, expnt(s) = [3.35568222]
bas 9, expnt(s) = [0.67460693]
bas 10, expnt(s) = [0.24987726]
bas 11, expnt(s) = [1362.84344173]
bas 12, expnt(s) = [664.15970947]
bas 13, expnt(s) = [298.20150386]
bas 14, expnt(s) = [311.66291924]
bas 15, expnt(s) = [63.06652187]
bas 16, expnt(s) = [7.49600269]
bas 17, expnt(s) = [20.73235196]
bas 18, expnt(s) = [0.78202936]
bas 19, expnt(s) = [2.86640943]
bas 20, expnt(s) = [0.22405306]
CPU time:       492.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828385e+04 5.20029007e+03 7.61709147e+03 2.05995106e+03
 3.61751173e+03 1.17848073e+03 1.58816553e+03 6.35604333e+02
 4.18246966e+02 2.33662825e+02 1.22513862e+02 9.30366247e+01
 3.94547540e+01 3.97731080e+01 8.50032536e+00 1.25774236e+01
 3.35568222e+00 6.26398407e+00 6.74606927e-01 1.88062897e+00
 2.49877258e-01 8.92914905e-01 1.36284344e+03 2.41569363e+04
 6.64159709e+02 9.83614790e+03 2.98201504e+02 3.61511135e+03
 3.11662919e+02 3.82024143e+03 6.30665219e+01 5.18481175e+02
 7.49600269e+00 3.61844153e+01 2.07323520e+01 1.29061025e+02
 7.82029363e-01 2.14542441e+00 2.86640943e+00 1.08807084e+01
 2.24053062e-01 4.49700114e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993238337286336
cond(S) = 97826.93131339074
E1 = -729.5313828902587  E_coul = 203.17981064981612
init E= -526.351572240443
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55572474201418  LUMO = 1.04391590723781
  mo_energy =
[-1.18331905e+02 -1.22047203e+01 -9.44677458e+00 -9.44677458e+00
 -9.44677458e+00 -1.23996041e+00 -5.55724742e-01 -5.55724742e-01
 -5.55724742e-01  1.04391591e+00  1.04391591e+00  1.04391591e+00
  1.06152821e+00  7.52088009e+00  7.52088009e+00  7.52088009e+00
  1.36368978e+01  3.44562943e+01  3.44562943e+01  3.44562943e+01
  1.22695217e+02  1.32567275e+02  1.32567275e+02  1.32567275e+02
  4.88004494e+02  4.88004494e+02  4.88004494e+02  6.64991470e+02
  1.33504818e+03  1.33504818e+03  1.33504818e+03  2.81095459e+03
  3.02201757e+03  3.02201757e+03  3.02201757e+03  6.63735722e+03
  6.63735722e+03  6.63735722e+03  9.23242598e+03  2.55798130e+04
  7.63094657e+04]
E1 = -727.8715725006142  E_coul = 201.12630591026004
cycle= 1 E= -526.745266590354  delta_E= -0.394  |g|= 0.185  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538038
diis-c [-0.28948488  1.        ]
  HOMO = -0.590203002281967  LUMO = 1.01963051030131
  mo_energy =
[-1.18636936e+02 -1.23413904e+01 -9.59400148e+00 -9.59400148e+00
 -9.59400148e+00 -1.27902615e+00 -5.90203002e-01 -5.90203002e-01
 -5.90203002e-01  1.01963051e+00  1.01963051e+00  1.01963051e+00
  1.03232294e+00  7.42964834e+00  7.42964834e+00  7.42964834e+00
  1.35236802e+01  3.43020927e+01  3.43020927e+01  3.43020927e+01
  1.22467407e+02  1.32339722e+02  1.32339722e+02  1.32339722e+02
  4.87701263e+02  4.87701263e+02  4.87701263e+02  6.64641169e+02
  1.33468961e+03  1.33468961e+03  1.33468961e+03  2.81046150e+03
  3.02159357e+03  3.02159357e+03  3.02159357e+03  6.63682138e+03
  6.63682138e+03  6.63682138e+03  9.23181674e+03  2.55791102e+04
  7.63086731e+04]
E1 = -728.4391258280538  E_coul = 201.69315462458212
cycle= 2 E= -526.745971203472  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744285
diis-c [-0.00324753  0.08213529  0.91786471]
  HOMO = -0.581193524469868  LUMO = 1.02635765366815
  mo_energy =
[-1.18569960e+02 -1.23037591e+01 -9.55472914e+00 -9.55472914e+00
 -9.55472914e+00 -1.26824390e+00 -5.81193524e-01 -5.81193524e-01
 -5.81193524e-01  1.02635765e+00  1.02635765e+00  1.02635765e+00
  1.04068429e+00  7.45345006e+00  7.45345006e+00  7.45345006e+00
  1.35545776e+01  3.43420891e+01  3.43420891e+01  3.43420891e+01
  1.22524174e+02  1.32395242e+02  1.32395242e+02  1.32395242e+02
  4.87767393e+02  4.87767393e+02  4.87767393e+02  6.64710246e+02
  1.33475974e+03  1.33475974e+03  1.33475974e+03  2.81053501e+03
  3.02166595e+03  3.02166595e+03  3.02166595e+03  6.63689551e+03
  6.63689551e+03  6.63689551e+03  9.23189168e+03  2.55791857e+04
  7.63087489e+04]
E1 = -728.2906640571024  E_coul = 201.54463529126755
cycle= 3 E= -526.746028765835  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130377
diis-c [-5.35456195e-07 -1.21929417e-03  1.44704559e-01  8.56514735e-01]
  HOMO = -0.582672682230087  LUMO = 1.02527685206192
  mo_energy =
[-1.18579816e+02 -1.23095033e+01 -9.56081478e+00 -9.56081478e+00
 -9.56081478e+00 -1.26991649e+00 -5.82672682e-01 -5.82672682e-01
 -5.82672682e-01  1.02527685e+00  1.02527685e+00  1.02527685e+00
  1.03940625e+00  7.44966877e+00  7.44966877e+00  7.44966877e+00
  1.35498390e+01  3.43359350e+01  3.43359350e+01  3.43359350e+01
  1.22515759e+02  1.32386951e+02  1.32386951e+02  1.32386951e+02
  4.87757657e+02  4.87757657e+02  4.87757657e+02  6.64700068e+02
  1.33474942e+03  1.33474942e+03  1.33474942e+03  2.81052406e+03
  3.02165525e+03  3.02165525e+03  3.02165525e+03  6.63688442e+03
  6.63688442e+03  6.63688442e+03  9.23188038e+03  2.55791742e+04
  7.63087373e+04]
E1 = -728.3131795998897  E_coul = 201.5671489568793
cycle= 4 E= -526.74603064301  delta_E= -1.88e-06  |g|= 9.36e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108871
diis-c [-3.79305299e-09  6.86658076e-05 -9.92952313e-03 -6.45100498e-02
  1.07437091e+00]
  HOMO = -0.582654738265947  LUMO = 1.02529237150046
  mo_energy =
[-1.18579777e+02 -1.23094409e+01 -9.56076531e+00 -9.56076531e+00
 -9.56076531e+00 -1.26987708e+00 -5.82654738e-01 -5.82654738e-01
 -5.82654738e-01  1.02529237e+00  1.02529237e+00  1.02529237e+00
  1.03943977e+00  7.44970942e+00  7.44970942e+00  7.44970942e+00
  1.35498968e+01  3.43359825e+01  3.43359825e+01  3.43359825e+01
  1.22515808e+02  1.32386996e+02  1.32386996e+02  1.32386996e+02
  4.87757696e+02  4.87757696e+02  4.87757696e+02  6.64700099e+02
  1.33474945e+03  1.33474945e+03  1.33474945e+03  2.81052407e+03
  3.02165527e+03  3.02165527e+03  3.02165527e+03  6.63688442e+03
  6.63688442e+03  6.63688442e+03  9.23188038e+03  2.55791742e+04
  7.63087373e+04]
E1 = -728.3129759967411  E_coul = 201.56694535221826
cycle= 5 E= -526.746030644523  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77324e-05
diis-c [-6.69008703e-11  1.39879875e-05 -1.83860669e-03 -1.37460819e-02
  4.27504223e-02  9.72820278e-01]
  HOMO = -0.582661845378264  LUMO = 1.02528759856499
  mo_energy =
[-1.18579807e+02 -1.23094625e+01 -9.56078881e+00 -9.56078881e+00
 -9.56078881e+00 -1.26988275e+00 -5.82661845e-01 -5.82661845e-01
 -5.82661845e-01  1.02528760e+00  1.02528760e+00  1.02528760e+00
  1.03943584e+00  7.44969334e+00  7.44969334e+00  7.44969334e+00
  1.35498788e+01  3.43359596e+01  3.43359596e+01  3.43359596e+01
  1.22515781e+02  1.32386969e+02  1.32386969e+02  1.32386969e+02
  4.87757666e+02  4.87757666e+02  4.87757666e+02  6.64700069e+02
  1.33474942e+03  1.33474942e+03  1.33474942e+03  2.81052403e+03
  3.02165524e+03  3.02165524e+03  3.02165524e+03  6.63688439e+03
  6.63688439e+03  6.63688439e+03  9.23188035e+03  2.55791741e+04
  7.63087373e+04]
E1 = -728.3130543822839  E_coul = 201.5670237377062
cycle= 6 E= -526.746030644578  delta_E= -5.48e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.04 sec
E1 = -728.3130543822839  E_coul = 201.5670237377062
  HOMO = -0.582661870450408  LUMO = 1.02528763449957
  mo_energy =
[-1.18579807e+02 -1.23094624e+01 -9.56078879e+00 -9.56078879e+00
 -9.56078879e+00 -1.26988241e+00 -5.82661870e-01 -5.82661870e-01
 -5.82661870e-01  1.02528763e+00  1.02528763e+00  1.02528763e+00
  1.03943617e+00  7.44969336e+00  7.44969336e+00  7.44969336e+00
  1.35498790e+01  3.43359596e+01  3.43359596e+01  3.43359596e+01
  1.22515781e+02  1.32386970e+02  1.32386970e+02  1.32386970e+02
  4.87757666e+02  4.87757666e+02  4.87757666e+02  6.64700069e+02
  1.33474942e+03  1.33474942e+03  1.33474942e+03  2.81052403e+03
  3.02165524e+03  3.02165524e+03  3.02165524e+03  6.63688439e+03
  6.63688439e+03  6.63688439e+03  9.23188035e+03  2.55791741e+04
  7.63087373e+04]
E1 = -728.3130535677768  E_coul = 201.56702292320065
Extra cycle  E= -526.746030644576  delta_E= 1.48e-12  |g|= 3.42e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97826.93131339074
E1 = -728.3130535677768  E_coul = 201.56702292320065
init E= -526.746030644576
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582661896892387  LUMO = 1.02528762669502
  mo_energy =
[-1.18579807e+02 -1.23094625e+01 -9.56078887e+00 -9.56078887e+00
 -9.56078887e+00 -1.26988236e+00 -5.82661897e-01 -5.82661897e-01
 -5.82661897e-01  1.02528763e+00  1.02528763e+00  1.02528763e+00
  1.03943621e+00  7.44969331e+00  7.44969331e+00  7.44969331e+00
  1.35498790e+01  3.43359595e+01  3.43359595e+01  3.43359595e+01
  1.22515781e+02  1.32386969e+02  1.32386969e+02  1.32386969e+02
  4.87757666e+02  4.87757666e+02  4.87757666e+02  6.64700069e+02
  1.33474942e+03  1.33474942e+03  1.33474942e+03  2.81052403e+03
  3.02165524e+03  3.02165524e+03  3.02165524e+03  6.63688439e+03
  6.63688439e+03  6.63688439e+03  9.23188035e+03  2.55791741e+04
  7.63087373e+04]
E1 = -728.3130536953688  E_coul = 201.5670230507916
cycle= 1 E= -526.746030644577  delta_E= -1.02e-12  |g|= 7.11e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3130536953688  E_coul = 201.5670230507916
  HOMO = -0.582661896765334  LUMO = 1.02528762912478
  mo_energy =
[-1.18579807e+02 -1.23094624e+01 -9.56078886e+00 -9.56078886e+00
 -9.56078886e+00 -1.26988235e+00 -5.82661897e-01 -5.82661897e-01
 -5.82661897e-01  1.02528763e+00  1.02528763e+00  1.02528763e+00
  1.03943623e+00  7.44969332e+00  7.44969332e+00  7.44969332e+00
  1.35498790e+01  3.43359595e+01  3.43359595e+01  3.43359595e+01
  1.22515781e+02  1.32386969e+02  1.32386969e+02  1.32386969e+02
  4.87757666e+02  4.87757666e+02  4.87757666e+02  6.64700069e+02
  1.33474942e+03  1.33474942e+03  1.33474942e+03  2.81052403e+03
  3.02165524e+03  3.02165524e+03  3.02165524e+03  6.63688439e+03
  6.63688439e+03  6.63688439e+03  9.23188035e+03  2.55791741e+04
  7.63087373e+04]
E1 = -728.3130536387861  E_coul = 201.56702299420917
Extra cycle  E= -526.746030644577  delta_E= 3.41e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828385e+04 7.61709147e+03 3.61751173e+03 1.58816553e+03
 4.18246966e+02 1.22513862e+02 3.94547540e+01 8.50032536e+00
 3.35568222e+00 6.74606927e-01 2.49877258e-01 1.36284344e+03
 6.64159709e+02 2.98201504e+02 3.11662919e+02 6.30665219e+01
 7.49600269e+00 2.07323520e+01 7.82029363e-01 2.86640943e+00
 2.24053062e-01]
grad_E = [-1.39774603e-06  2.16229384e-06 -2.13808863e-06  3.70334995e-05
  7.51996036e-06  4.42528614e-06 -1.39812447e-06  2.31645725e-06
  1.57999232e-05  5.11391806e-05 -4.65736021e-05 -5.91510974e-07
  3.99950565e-06  1.82152947e-05  1.55503308e-05  8.01754796e-05
 -5.26010889e-05  3.23751865e-05  7.70529297e-05  7.11946612e-05
 -1.77238529e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.838551         1
[INPUT] 0    0    [1    /1   ]  7617.09135229        1
[INPUT] 0    0    [1    /1   ]  3617.51185489        1
[INPUT] 0    0    [1    /1   ]  1588.16347799        1
[INPUT] 0    0    [1    /1   ]  418.244300745        1
[INPUT] 0    0    [1    /1   ]  122.522617946        1
[INPUT] 0    0    [1    /1   ]  39.4582825183        1
[INPUT] 0    0    [1    /1   ]  8.50280372145        1
[INPUT] 0    0    [1    /1   ]  3.35653725279        1
[INPUT] 0    0    [1    /1   ]  0.674941364818       1
[INPUT] 0    0    [1    /1   ]  0.249991946884       1
[INPUT] 1    0    [1    /1   ]  1362.84347491        1
[INPUT] 1    0    [1    /1   ]  664.159477426        1
[INPUT] 1    0    [1    /1   ]  298.200440772        1
[INPUT] 1    0    [1    /1   ]  311.662011378        1
[INPUT] 1    0    [1    /1   ]  63.0639155413        1
[INPUT] 1    0    [1    /1   ]  7.49268163909        1
[INPUT] 1    0    [1    /1   ]  20.726706247         1
[INPUT] 1    0    [1    /1   ]  0.781929750209       1
[INPUT] 1    0    [1    /1   ]  2.86537131102        1
[INPUT] 1    0    [1    /1   ]  0.224029206591       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.8385509693, 1.0]], [0, [7617.091352294974, 1.0]], [0, [3617.5118548863684, 1.0]], [0, [1588.1634779935073, 1.0]], [0, [418.2443007453282, 1.0]], [0, [122.52261794622125, 1.0]], [0, [39.458282518326435, 1.0]], [0, [8.502803721445325, 1.0]], [0, [3.356537252793067, 1.0]], [0, [0.6749413648183111, 1.0]], [0, [0.24999194688402843, 1.0]], [1, [1362.8434749134042, 1.0]], [1, [664.1594774261567, 1.0]], [1, [298.200440771885, 1.0]], [1, [311.6620113781273, 1.0]], [1, [63.06391554129654, 1.0]], [1, [7.492681639089238, 1.0]], [1, [20.72670624703898, 1.0]], [1, [0.7819297502091125, 1.0]], [1, [2.8653713110157177, 1.0]], [1, [0.22402920659062975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83855097]
bas 1, expnt(s) = [7617.09135229]
bas 2, expnt(s) = [3617.51185489]
bas 3, expnt(s) = [1588.16347799]
bas 4, expnt(s) = [418.24430075]
bas 5, expnt(s) = [122.52261795]
bas 6, expnt(s) = [39.45828252]
bas 7, expnt(s) = [8.50280372]
bas 8, expnt(s) = [3.35653725]
bas 9, expnt(s) = [0.67494136]
bas 10, expnt(s) = [0.24999195]
bas 11, expnt(s) = [1362.84347491]
bas 12, expnt(s) = [664.15947743]
bas 13, expnt(s) = [298.20044077]
bas 14, expnt(s) = [311.66201138]
bas 15, expnt(s) = [63.06391554]
bas 16, expnt(s) = [7.49268164]
bas 17, expnt(s) = [20.72670625]
bas 18, expnt(s) = [0.78192975]
bas 19, expnt(s) = [2.86537131]
bas 20, expnt(s) = [0.22402921]
CPU time:       498.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828386e+04 5.20029008e+03 7.61709135e+03 2.05995104e+03
 3.61751185e+03 1.17848076e+03 1.58816348e+03 6.35603716e+02
 4.18244301e+02 2.33661709e+02 1.22522618e+02 9.30416118e+01
 3.94582825e+01 3.97757757e+01 8.50280372e+00 1.25801738e+01
 3.35653725e+00 6.26518108e+00 6.74941365e-01 1.88132817e+00
 2.49991947e-01 8.93222261e-01 1.36284347e+03 2.41569370e+04
 6.64159477e+02 9.83614360e+03 2.98200441e+02 3.61509524e+03
 3.11662011e+02 3.82022752e+03 6.30639155e+01 5.18454391e+02
 7.49268164e+00 3.61643774e+01 2.07267062e+01 1.29017095e+02
 7.81929750e-01 2.14508282e+00 2.86537131e+00 1.08757829e+01
 2.24029207e-01 4.49640263e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99324060600232
cond(S) = 97814.22799371059
E1 = -729.5314260616432  E_coul = 203.17983577956278
init E= -526.35159028208
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555726184546791  LUMO = 1.04373334364324
  mo_energy =
[-1.18331907e+02 -1.22047161e+01 -9.44677073e+00 -9.44677073e+00
 -9.44677073e+00 -1.23995741e+00 -5.55726185e-01 -5.55726185e-01
 -5.55726185e-01  1.04373334e+00  1.04373334e+00  1.04373334e+00
  1.06241303e+00  7.51770004e+00  7.51770004e+00  7.51770004e+00
  1.36443662e+01  3.44405670e+01  3.44405670e+01  3.44405670e+01
  1.22721444e+02  1.32534091e+02  1.32534091e+02  1.32534091e+02
  4.87964577e+02  4.87964577e+02  4.87964577e+02  6.65038686e+02
  1.33500700e+03  1.33500700e+03  1.33500700e+03  2.81100325e+03
  3.02197522e+03  3.02197522e+03  3.02197522e+03  6.63731583e+03
  6.63731583e+03  6.63731583e+03  9.23246783e+03  2.55798499e+04
  7.63094989e+04]
E1 = -727.871542152544  E_coul = 201.12627532713995
cycle= 1 E= -526.745266825404  delta_E= -0.394  |g|= 0.185  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538037
diis-c [-0.28948355  1.        ]
  HOMO = -0.590209317845672  LUMO = 1.01944938303907
  mo_energy =
[-1.18636939e+02 -1.23413886e+01 -9.59399898e+00 -9.59399898e+00
 -9.59399898e+00 -1.27902977e+00 -5.90209318e-01 -5.90209318e-01
 -5.90209318e-01  1.01944938e+00  1.01944938e+00  1.01944938e+00
  1.03318209e+00  7.42648648e+00  7.42648648e+00  7.42648648e+00
  1.35311239e+01  3.42863840e+01  3.42863840e+01  3.42863840e+01
  1.22493624e+02  1.32306539e+02  1.32306539e+02  1.32306539e+02
  4.87661344e+02  4.87661344e+02  4.87661344e+02  6.64688384e+02
  1.33464842e+03  1.33464842e+03  1.33464842e+03  2.81051016e+03
  3.02155122e+03  3.02155122e+03  3.02155122e+03  6.63677999e+03
  6.63677999e+03  6.63677999e+03  9.23185859e+03  2.55791471e+04
  7.63087063e+04]
E1 = -728.4391368997549  E_coul = 201.69316541781927
cycle= 2 E= -526.745971481936  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744301
diis-c [-0.00324785  0.08213404  0.91786596]
  HOMO = -0.581199068114084  LUMO = 1.0261757490947
  mo_energy =
[-1.18569958e+02 -1.23037543e+01 -9.55472352e+00 -9.55472352e+00
 -9.55472352e+00 -1.26824656e+00 -5.81199068e-01 -5.81199068e-01
 -5.81199068e-01  1.02617575e+00  1.02617575e+00  1.02617575e+00
  1.04154943e+00  7.45028421e+00  7.45028421e+00  7.45028421e+00
  1.35620290e+01  3.43263784e+01  3.43263784e+01  3.43263784e+01
  1.22550395e+02  1.32362063e+02  1.32362063e+02  1.32362063e+02
  4.87727477e+02  4.87727477e+02  4.87727477e+02  6.64757465e+02
  1.33471856e+03  1.33471856e+03  1.33471856e+03  2.81058368e+03
  3.02162360e+03  3.02162360e+03  3.02162360e+03  6.63685412e+03
  6.63685412e+03  6.63685412e+03  9.23193353e+03  2.55792226e+04
  7.63087821e+04]
E1 = -728.2906547894614  E_coul = 201.54462573375986
cycle= 3 E= -526.746029055702  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130389
diis-c [-5.35406205e-07 -1.21926880e-03  1.44714645e-01  8.56504623e-01]
  HOMO = -0.582678506706264  LUMO = 1.0250949520377
  mo_energy =
[-1.18579816e+02 -1.23094995e+01 -9.56081015e+00 -9.56081015e+00
 -9.56081015e+00 -1.26991953e+00 -5.82678507e-01 -5.82678507e-01
 -5.82678507e-01  1.02509495e+00  1.02509495e+00  1.02509495e+00
  1.04027028e+00  7.44650316e+00  7.44650316e+00  7.44650316e+00
  1.35572887e+01  3.43202240e+01  3.43202240e+01  3.43202240e+01
  1.22541979e+02  1.32353770e+02  1.32353770e+02  1.32353770e+02
  4.87717740e+02  4.87717740e+02  4.87717740e+02  6.64747286e+02
  1.33470824e+03  1.33470824e+03  1.33470824e+03  2.81057272e+03
  3.02161290e+03  3.02161290e+03  3.02161290e+03  6.63684303e+03
  6.63684303e+03  6.63684303e+03  9.23192223e+03  2.55792111e+04
  7.63087705e+04]
E1 = -728.313175744063  E_coul = 201.56714481041988
cycle= 4 E= -526.746030933643  delta_E= -1.88e-06  |g|= 9.35e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010879
diis-c [-3.79387615e-09  6.85907131e-05 -9.92045992e-03 -6.44433868e-02
  1.07429526e+00]
  HOMO = -0.582660540702867  LUMO = 1.02511048354874
  mo_energy =
[-1.18579777e+02 -1.23094370e+01 -9.56076062e+00 -9.56076062e+00
 -9.56076062e+00 -1.26988011e+00 -5.82660541e-01 -5.82660541e-01
 -5.82660541e-01  1.02511048e+00  1.02511048e+00  1.02511048e+00
  1.04030383e+00  7.44654385e+00  7.44654385e+00  7.44654385e+00
  1.35573466e+01  3.43202716e+01  3.43202716e+01  3.43202716e+01
  1.22542028e+02  1.32353816e+02  1.32353816e+02  1.32353816e+02
  4.87717779e+02  4.87717779e+02  4.87717779e+02  6.64747316e+02
  1.33470827e+03  1.33470827e+03  1.33470827e+03  2.81057273e+03
  3.02161292e+03  3.02161292e+03  3.02161292e+03  6.63684304e+03
  6.63684304e+03  6.63684304e+03  9.23192223e+03  2.55792111e+04
  7.63087705e+04]
E1 = -728.3129719680708  E_coul = 201.5669410329172
cycle= 5 E= -526.746030935154  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.774e-05
diis-c [-6.68407370e-11  1.39869486e-05 -1.83868766e-03 -1.37457678e-02
  4.27613785e-02  9.72809090e-01]
  HOMO = -0.582667647115036  LUMO = 1.02510571198217
  mo_energy =
[-1.18579807e+02 -1.23094587e+01 -9.56078412e+00 -9.56078412e+00
 -9.56078412e+00 -1.26988579e+00 -5.82667647e-01 -5.82667647e-01
 -5.82667647e-01  1.02510571e+00  1.02510571e+00  1.02510571e+00
  1.04029989e+00  7.44652777e+00  7.44652777e+00  7.44652777e+00
  1.35573287e+01  3.43202486e+01  3.43202486e+01  3.43202486e+01
  1.22542001e+02  1.32353789e+02  1.32353789e+02  1.32353789e+02
  4.87717749e+02  4.87717749e+02  4.87717749e+02  6.64747286e+02
  1.33470824e+03  1.33470824e+03  1.33470824e+03  2.81057270e+03
  3.02161289e+03  3.02161289e+03  3.02161289e+03  6.63684301e+03
  6.63684301e+03  6.63684301e+03  9.23192220e+03  2.55792110e+04
  7.63087704e+04]
E1 = -728.3130503748833  E_coul = 201.56701943967695
cycle= 6 E= -526.746030935206  delta_E= -5.28e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130503748833  E_coul = 201.56701943967695
  HOMO = -0.582667672365946  LUMO = 1.02510574777589
  mo_energy =
[-1.18579806e+02 -1.23094585e+01 -9.56078410e+00 -9.56078410e+00
 -9.56078410e+00 -1.26988544e+00 -5.82667672e-01 -5.82667672e-01
 -5.82667672e-01  1.02510575e+00  1.02510575e+00  1.02510575e+00
  1.04030022e+00  7.44652779e+00  7.44652779e+00  7.44652779e+00
  1.35573288e+01  3.43202487e+01  3.43202487e+01  3.43202487e+01
  1.22542001e+02  1.32353789e+02  1.32353789e+02  1.32353789e+02
  4.87717749e+02  4.87717749e+02  4.87717749e+02  6.64747286e+02
  1.33470824e+03  1.33470824e+03  1.33470824e+03  2.81057270e+03
  3.02161289e+03  3.02161289e+03  3.02161289e+03  6.63684301e+03
  6.63684301e+03  6.63684301e+03  9.23192220e+03  2.55792110e+04
  7.63087704e+04]
E1 = -728.3130495665072  E_coul = 201.5670186312983
Extra cycle  E= -526.746030935209  delta_E= -2.5e-12  |g|= 3.42e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828386e+04 7.61709135e+03 3.61751185e+03 1.58816348e+03
 4.18244301e+02 1.22522618e+02 3.94582825e+01 8.50280372e+00
 3.35653725e+00 6.74941365e-01 2.49991947e-01 1.36284347e+03
 6.64159477e+02 2.98200441e+02 3.11662011e+02 6.30639155e+01
 7.49268164e+00 2.07267062e+01 7.81929750e-01 2.86537131e+00
 2.24029207e-01]
E = -526.7460309352089
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.838551         1
[INPUT] 0    0    [1    /1   ]  7617.09135229        1
[INPUT] 0    0    [1    /1   ]  3617.51185489        1
[INPUT] 0    0    [1    /1   ]  1588.16347799        1
[INPUT] 0    0    [1    /1   ]  418.244300745        1
[INPUT] 0    0    [1    /1   ]  122.522617946        1
[INPUT] 0    0    [1    /1   ]  39.4582825183        1
[INPUT] 0    0    [1    /1   ]  8.50280372145        1
[INPUT] 0    0    [1    /1   ]  3.35653725279        1
[INPUT] 0    0    [1    /1   ]  0.674941364818       1
[INPUT] 0    0    [1    /1   ]  0.249991946884       1
[INPUT] 1    0    [1    /1   ]  1362.84347491        1
[INPUT] 1    0    [1    /1   ]  664.159477426        1
[INPUT] 1    0    [1    /1   ]  298.200440772        1
[INPUT] 1    0    [1    /1   ]  311.662011378        1
[INPUT] 1    0    [1    /1   ]  63.0639155413        1
[INPUT] 1    0    [1    /1   ]  7.49268163909        1
[INPUT] 1    0    [1    /1   ]  20.726706247         1
[INPUT] 1    0    [1    /1   ]  0.781929750209       1
[INPUT] 1    0    [1    /1   ]  2.86537131102        1
[INPUT] 1    0    [1    /1   ]  0.224029206591       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.8385509693, 1.0]], [0, [7617.091352294974, 1.0]], [0, [3617.5118548863684, 1.0]], [0, [1588.1634779935073, 1.0]], [0, [418.2443007453282, 1.0]], [0, [122.52261794622125, 1.0]], [0, [39.458282518326435, 1.0]], [0, [8.502803721445325, 1.0]], [0, [3.356537252793067, 1.0]], [0, [0.6749413648183111, 1.0]], [0, [0.24999194688402843, 1.0]], [1, [1362.8434749134042, 1.0]], [1, [664.1594774261567, 1.0]], [1, [298.200440771885, 1.0]], [1, [311.6620113781273, 1.0]], [1, [63.06391554129654, 1.0]], [1, [7.492681639089238, 1.0]], [1, [20.72670624703898, 1.0]], [1, [0.7819297502091125, 1.0]], [1, [2.8653713110157177, 1.0]], [1, [0.22402920659062975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83855097]
bas 1, expnt(s) = [7617.09135229]
bas 2, expnt(s) = [3617.51185489]
bas 3, expnt(s) = [1588.16347799]
bas 4, expnt(s) = [418.24430075]
bas 5, expnt(s) = [122.52261795]
bas 6, expnt(s) = [39.45828252]
bas 7, expnt(s) = [8.50280372]
bas 8, expnt(s) = [3.35653725]
bas 9, expnt(s) = [0.67494136]
bas 10, expnt(s) = [0.24999195]
bas 11, expnt(s) = [1362.84347491]
bas 12, expnt(s) = [664.15947743]
bas 13, expnt(s) = [298.20044077]
bas 14, expnt(s) = [311.66201138]
bas 15, expnt(s) = [63.06391554]
bas 16, expnt(s) = [7.49268164]
bas 17, expnt(s) = [20.72670625]
bas 18, expnt(s) = [0.78192975]
bas 19, expnt(s) = [2.86537131]
bas 20, expnt(s) = [0.22402921]
CPU time:       498.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828386e+04 5.20029008e+03 7.61709135e+03 2.05995104e+03
 3.61751185e+03 1.17848076e+03 1.58816348e+03 6.35603716e+02
 4.18244301e+02 2.33661709e+02 1.22522618e+02 9.30416118e+01
 3.94582825e+01 3.97757757e+01 8.50280372e+00 1.25801738e+01
 3.35653725e+00 6.26518108e+00 6.74941365e-01 1.88132817e+00
 2.49991947e-01 8.93222261e-01 1.36284347e+03 2.41569370e+04
 6.64159477e+02 9.83614360e+03 2.98200441e+02 3.61509524e+03
 3.11662011e+02 3.82022752e+03 6.30639155e+01 5.18454391e+02
 7.49268164e+00 3.61643774e+01 2.07267062e+01 1.29017095e+02
 7.81929750e-01 2.14508282e+00 2.86537131e+00 1.08757829e+01
 2.24029207e-01 4.49640263e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99324060600232
cond(S) = 97814.22799371059
E1 = -729.5314260616432  E_coul = 203.17983577956278
init E= -526.35159028208
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555726184546791  LUMO = 1.04373334364324
  mo_energy =
[-1.18331907e+02 -1.22047161e+01 -9.44677073e+00 -9.44677073e+00
 -9.44677073e+00 -1.23995741e+00 -5.55726185e-01 -5.55726185e-01
 -5.55726185e-01  1.04373334e+00  1.04373334e+00  1.04373334e+00
  1.06241303e+00  7.51770004e+00  7.51770004e+00  7.51770004e+00
  1.36443662e+01  3.44405670e+01  3.44405670e+01  3.44405670e+01
  1.22721444e+02  1.32534091e+02  1.32534091e+02  1.32534091e+02
  4.87964577e+02  4.87964577e+02  4.87964577e+02  6.65038686e+02
  1.33500700e+03  1.33500700e+03  1.33500700e+03  2.81100325e+03
  3.02197522e+03  3.02197522e+03  3.02197522e+03  6.63731583e+03
  6.63731583e+03  6.63731583e+03  9.23246783e+03  2.55798499e+04
  7.63094989e+04]
E1 = -727.871542152544  E_coul = 201.12627532713995
cycle= 1 E= -526.745266825404  delta_E= -0.394  |g|= 0.185  |ddm|= 0.312
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538037
diis-c [-0.28948355  1.        ]
  HOMO = -0.590209317845672  LUMO = 1.01944938303907
  mo_energy =
[-1.18636939e+02 -1.23413886e+01 -9.59399898e+00 -9.59399898e+00
 -9.59399898e+00 -1.27902977e+00 -5.90209318e-01 -5.90209318e-01
 -5.90209318e-01  1.01944938e+00  1.01944938e+00  1.01944938e+00
  1.03318209e+00  7.42648648e+00  7.42648648e+00  7.42648648e+00
  1.35311239e+01  3.42863840e+01  3.42863840e+01  3.42863840e+01
  1.22493624e+02  1.32306539e+02  1.32306539e+02  1.32306539e+02
  4.87661344e+02  4.87661344e+02  4.87661344e+02  6.64688384e+02
  1.33464842e+03  1.33464842e+03  1.33464842e+03  2.81051016e+03
  3.02155122e+03  3.02155122e+03  3.02155122e+03  6.63677999e+03
  6.63677999e+03  6.63677999e+03  9.23185859e+03  2.55791471e+04
  7.63087063e+04]
E1 = -728.4391368997549  E_coul = 201.69316541781927
cycle= 2 E= -526.745971481936  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744301
diis-c [-0.00324785  0.08213404  0.91786596]
  HOMO = -0.581199068114084  LUMO = 1.0261757490947
  mo_energy =
[-1.18569958e+02 -1.23037543e+01 -9.55472352e+00 -9.55472352e+00
 -9.55472352e+00 -1.26824656e+00 -5.81199068e-01 -5.81199068e-01
 -5.81199068e-01  1.02617575e+00  1.02617575e+00  1.02617575e+00
  1.04154943e+00  7.45028421e+00  7.45028421e+00  7.45028421e+00
  1.35620290e+01  3.43263784e+01  3.43263784e+01  3.43263784e+01
  1.22550395e+02  1.32362063e+02  1.32362063e+02  1.32362063e+02
  4.87727477e+02  4.87727477e+02  4.87727477e+02  6.64757465e+02
  1.33471856e+03  1.33471856e+03  1.33471856e+03  2.81058368e+03
  3.02162360e+03  3.02162360e+03  3.02162360e+03  6.63685412e+03
  6.63685412e+03  6.63685412e+03  9.23193353e+03  2.55792226e+04
  7.63087821e+04]
E1 = -728.2906547894614  E_coul = 201.54462573375986
cycle= 3 E= -526.746029055702  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130389
diis-c [-5.35406205e-07 -1.21926880e-03  1.44714645e-01  8.56504623e-01]
  HOMO = -0.582678506706264  LUMO = 1.0250949520377
  mo_energy =
[-1.18579816e+02 -1.23094995e+01 -9.56081015e+00 -9.56081015e+00
 -9.56081015e+00 -1.26991953e+00 -5.82678507e-01 -5.82678507e-01
 -5.82678507e-01  1.02509495e+00  1.02509495e+00  1.02509495e+00
  1.04027028e+00  7.44650316e+00  7.44650316e+00  7.44650316e+00
  1.35572887e+01  3.43202240e+01  3.43202240e+01  3.43202240e+01
  1.22541979e+02  1.32353770e+02  1.32353770e+02  1.32353770e+02
  4.87717740e+02  4.87717740e+02  4.87717740e+02  6.64747286e+02
  1.33470824e+03  1.33470824e+03  1.33470824e+03  2.81057272e+03
  3.02161290e+03  3.02161290e+03  3.02161290e+03  6.63684303e+03
  6.63684303e+03  6.63684303e+03  9.23192223e+03  2.55792111e+04
  7.63087705e+04]
E1 = -728.313175744063  E_coul = 201.56714481041988
cycle= 4 E= -526.746030933643  delta_E= -1.88e-06  |g|= 9.35e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010879
diis-c [-3.79387615e-09  6.85907131e-05 -9.92045992e-03 -6.44433868e-02
  1.07429526e+00]
  HOMO = -0.582660540702867  LUMO = 1.02511048354874
  mo_energy =
[-1.18579777e+02 -1.23094370e+01 -9.56076062e+00 -9.56076062e+00
 -9.56076062e+00 -1.26988011e+00 -5.82660541e-01 -5.82660541e-01
 -5.82660541e-01  1.02511048e+00  1.02511048e+00  1.02511048e+00
  1.04030383e+00  7.44654385e+00  7.44654385e+00  7.44654385e+00
  1.35573466e+01  3.43202716e+01  3.43202716e+01  3.43202716e+01
  1.22542028e+02  1.32353816e+02  1.32353816e+02  1.32353816e+02
  4.87717779e+02  4.87717779e+02  4.87717779e+02  6.64747316e+02
  1.33470827e+03  1.33470827e+03  1.33470827e+03  2.81057273e+03
  3.02161292e+03  3.02161292e+03  3.02161292e+03  6.63684304e+03
  6.63684304e+03  6.63684304e+03  9.23192223e+03  2.55792111e+04
  7.63087705e+04]
E1 = -728.3129719680708  E_coul = 201.5669410329172
cycle= 5 E= -526.746030935154  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.00015
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.774e-05
diis-c [-6.68407370e-11  1.39869486e-05 -1.83868766e-03 -1.37457678e-02
  4.27613785e-02  9.72809090e-01]
  HOMO = -0.582667647115036  LUMO = 1.02510571198217
  mo_energy =
[-1.18579807e+02 -1.23094587e+01 -9.56078412e+00 -9.56078412e+00
 -9.56078412e+00 -1.26988579e+00 -5.82667647e-01 -5.82667647e-01
 -5.82667647e-01  1.02510571e+00  1.02510571e+00  1.02510571e+00
  1.04029989e+00  7.44652777e+00  7.44652777e+00  7.44652777e+00
  1.35573287e+01  3.43202486e+01  3.43202486e+01  3.43202486e+01
  1.22542001e+02  1.32353789e+02  1.32353789e+02  1.32353789e+02
  4.87717749e+02  4.87717749e+02  4.87717749e+02  6.64747286e+02
  1.33470824e+03  1.33470824e+03  1.33470824e+03  2.81057270e+03
  3.02161289e+03  3.02161289e+03  3.02161289e+03  6.63684301e+03
  6.63684301e+03  6.63684301e+03  9.23192220e+03  2.55792110e+04
  7.63087704e+04]
E1 = -728.3130503748833  E_coul = 201.56701943967695
cycle= 6 E= -526.746030935206  delta_E= -5.28e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130503748833  E_coul = 201.56701943967695
  HOMO = -0.582667672365946  LUMO = 1.02510574777589
  mo_energy =
[-1.18579806e+02 -1.23094585e+01 -9.56078410e+00 -9.56078410e+00
 -9.56078410e+00 -1.26988544e+00 -5.82667672e-01 -5.82667672e-01
 -5.82667672e-01  1.02510575e+00  1.02510575e+00  1.02510575e+00
  1.04030022e+00  7.44652779e+00  7.44652779e+00  7.44652779e+00
  1.35573288e+01  3.43202487e+01  3.43202487e+01  3.43202487e+01
  1.22542001e+02  1.32353789e+02  1.32353789e+02  1.32353789e+02
  4.87717749e+02  4.87717749e+02  4.87717749e+02  6.64747286e+02
  1.33470824e+03  1.33470824e+03  1.33470824e+03  2.81057270e+03
  3.02161289e+03  3.02161289e+03  3.02161289e+03  6.63684301e+03
  6.63684301e+03  6.63684301e+03  9.23192220e+03  2.55792110e+04
  7.63087704e+04]
E1 = -728.3130495665072  E_coul = 201.5670186312983
Extra cycle  E= -526.746030935209  delta_E= -2.5e-12  |g|= 3.42e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97814.22799371059
E1 = -728.3130495665072  E_coul = 201.5670186312983
init E= -526.746030935209
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582667698661916  LUMO = 1.02510574007773
  mo_energy =
[-1.18579807e+02 -1.23094586e+01 -9.56078417e+00 -9.56078417e+00
 -9.56078417e+00 -1.26988540e+00 -5.82667699e-01 -5.82667699e-01
 -5.82667699e-01  1.02510574e+00  1.02510574e+00  1.02510574e+00
  1.04030026e+00  7.44652775e+00  7.44652775e+00  7.44652775e+00
  1.35573288e+01  3.43202486e+01  3.43202486e+01  3.43202486e+01
  1.22542001e+02  1.32353789e+02  1.32353789e+02  1.32353789e+02
  4.87717749e+02  4.87717749e+02  4.87717749e+02  6.64747286e+02
  1.33470824e+03  1.33470824e+03  1.33470824e+03  2.81057270e+03
  3.02161289e+03  3.02161289e+03  3.02161289e+03  6.63684301e+03
  6.63684301e+03  6.63684301e+03  9.23192220e+03  2.55792110e+04
  7.63087704e+04]
E1 = -728.313049692762  E_coul = 201.56701875755488
cycle= 1 E= -526.746030935207  delta_E= 1.82e-12  |g|= 7.11e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.313049692762  E_coul = 201.56701875755488
  HOMO = -0.582667698554071  LUMO = 1.02510574249306
  mo_energy =
[-1.18579807e+02 -1.23094586e+01 -9.56078417e+00 -9.56078417e+00
 -9.56078417e+00 -1.26988538e+00 -5.82667699e-01 -5.82667699e-01
 -5.82667699e-01  1.02510574e+00  1.02510574e+00  1.02510574e+00
  1.04030028e+00  7.44652775e+00  7.44652775e+00  7.44652775e+00
  1.35573288e+01  3.43202486e+01  3.43202486e+01  3.43202486e+01
  1.22542001e+02  1.32353789e+02  1.32353789e+02  1.32353789e+02
  4.87717749e+02  4.87717749e+02  4.87717749e+02  6.64747286e+02
  1.33470824e+03  1.33470824e+03  1.33470824e+03  2.81057270e+03
  3.02161289e+03  3.02161289e+03  3.02161289e+03  6.63684301e+03
  6.63684301e+03  6.63684301e+03  9.23192220e+03  2.55792110e+04
  7.63087704e+04]
E1 = -728.3130496366357  E_coul = 201.56701870142908
Extra cycle  E= -526.746030935207  delta_E= 4.55e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828386e+04 7.61709135e+03 3.61751185e+03 1.58816348e+03
 4.18244301e+02 1.22522618e+02 3.94582825e+01 8.50280372e+00
 3.35653725e+00 6.74941365e-01 2.49991947e-01 1.36284347e+03
 6.64159477e+02 2.98200441e+02 3.11662011e+02 6.30639155e+01
 7.49268164e+00 2.07267062e+01 7.81929750e-01 2.86537131e+00
 2.24029207e-01]
grad_E = [-1.39785961e-06  2.16322144e-06 -2.13836514e-06  3.70678112e-05
  6.80408956e-06  7.18162482e-06 -3.29445909e-06  5.14777158e-06
  3.01977787e-05  1.00752239e-04 -9.33026237e-05 -5.91699029e-07
  3.99625414e-06  1.81957232e-05  1.55336597e-05  8.17698443e-05
 -1.14519536e-04  3.98315095e-05  1.47666509e-04  1.34540813e-04
 -3.46136102e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8387934        1
[INPUT] 0    0    [1    /1   ]  7617.09095373        1
[INPUT] 0    0    [1    /1   ]  3617.51220671        1
[INPUT] 0    0    [1    /1   ]  1588.15632015        1
[INPUT] 0    0    [1    /1   ]  418.245625769        1
[INPUT] 0    0    [1    /1   ]  122.537962162        1
[INPUT] 0    0    [1    /1   ]  39.4641659841        1
[INPUT] 0    0    [1    /1   ]  8.50680061156        1
[INPUT] 0    0    [1    /1   ]  3.35790960957        1
[INPUT] 0    0    [1    /1   ]  0.675469940471       1
[INPUT] 0    0    [1    /1   ]  0.250173449223       1
[INPUT] 1    0    [1    /1   ]  1362.84357419        1
[INPUT] 1    0    [1    /1   ]  664.15876454         1
[INPUT] 1    0    [1    /1   ]  298.197168874        1
[INPUT] 1    0    [1    /1   ]  311.659213958        1
[INPUT] 1    0    [1    /1   ]  63.0550492016        1
[INPUT] 1    0    [1    /1   ]  7.48703925839        1
[INPUT] 1    0    [1    /1   ]  20.7164832251        1
[INPUT] 1    0    [1    /1   ]  0.781756355968       1
[INPUT] 1    0    [1    /1   ]  2.86360016238        1
[INPUT] 1    0    [1    /1   ]  0.223988197442       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838793405954, 1.0]], [0, [7617.09095372748, 1.0]], [0, [3617.5122067145353, 1.0]], [0, [1588.1563201542708, 1.0]], [0, [418.2456257687695, 1.0]], [0, [122.53796216199976, 1.0]], [0, [39.464165984057104, 1.0]], [0, [8.506800611559026, 1.0]], [0, [3.3579096095732868, 1.0]], [0, [0.6754699404709225, 1.0]], [0, [0.2501734492228882, 1.0]], [1, [1362.8435741873734, 1.0]], [1, [664.1587645395679, 1.0]], [1, [298.1971688742491, 1.0]], [1, [311.65921395783363, 1.0]], [1, [63.05504920164745, 1.0]], [1, [7.487039258388606, 1.0]], [1, [20.71648322508892, 1.0]], [1, [0.7817563559678478, 1.0]], [1, [2.8636001623848704, 1.0]], [1, [0.22398819744198767, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83879341]
bas 1, expnt(s) = [7617.09095373]
bas 2, expnt(s) = [3617.51220671]
bas 3, expnt(s) = [1588.15632015]
bas 4, expnt(s) = [418.24562577]
bas 5, expnt(s) = [122.53796216]
bas 6, expnt(s) = [39.46416598]
bas 7, expnt(s) = [8.50680061]
bas 8, expnt(s) = [3.35790961]
bas 9, expnt(s) = [0.67546994]
bas 10, expnt(s) = [0.25017345]
bas 11, expnt(s) = [1362.84357419]
bas 12, expnt(s) = [664.15876454]
bas 13, expnt(s) = [298.19716887]
bas 14, expnt(s) = [311.65921396]
bas 15, expnt(s) = [63.0550492]
bas 16, expnt(s) = [7.48703926]
bas 17, expnt(s) = [20.71648323]
bas 18, expnt(s) = [0.78175636]
bas 19, expnt(s) = [2.86360016]
bas 20, expnt(s) = [0.2239882]
CPU time:       504.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828388e+04 5.20029012e+03 7.61709095e+03 2.05995095e+03
 3.61751221e+03 1.17848085e+03 1.58815632e+03 6.35601568e+02
 4.18245626e+02 2.33662264e+02 1.22537962e+02 9.30503507e+01
 3.94641660e+01 3.97802237e+01 8.50680061e+00 1.25846086e+01
 3.35790961e+00 6.26710218e+00 6.75469940e-01 1.88243307e+00
 2.50173449e-01 8.93708599e-01 1.36284357e+03 2.41569392e+04
 6.64158765e+02 9.83613040e+03 2.98197169e+02 3.61504566e+03
 3.11659214e+02 3.82018466e+03 6.30550492e+01 5.18363279e+02
 7.48703926e+00 3.61303385e+01 2.07164832e+01 1.28937556e+02
 7.81756356e-01 2.14448824e+00 2.86360016e+00 1.08673803e+01
 2.23988197e-01 4.49537381e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993244740001373
cond(S) = 97782.04664132762
E1 = -729.5314935882909  E_coul = 203.1798755586574
init E= -526.351618029634
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555728625049951  LUMO = 1.04341753494903
  mo_energy =
[-1.18331910e+02 -1.22047095e+01 -9.44676451e+00 -9.44676451e+00
 -9.44676451e+00 -1.23995260e+00 -5.55728625e-01 -5.55728625e-01
 -5.55728625e-01  1.04341753e+00  1.04341753e+00  1.04341753e+00
  1.06381415e+00  7.51226181e+00  7.51226181e+00  7.51226181e+00
  1.36563339e+01  3.44133912e+01  3.44133912e+01  3.44133912e+01
  1.22764569e+02  1.32471774e+02  1.32471774e+02  1.32471774e+02
  4.87881252e+02  4.87881252e+02  4.87881252e+02  6.65122296e+02
  1.33491608e+03  1.33491608e+03  1.33491608e+03  2.81109883e+03
  3.02187818e+03  3.02187818e+03  3.02187818e+03  6.63721885e+03
  6.63721885e+03  6.63721885e+03  9.23255190e+03  2.55799225e+04
  7.63095630e+04]
E1 = -727.8714798794125  E_coul = 201.12621241544161
cycle= 1 E= -526.745267463971  delta_E= -0.394  |g|= 0.185  |ddm|= 0.311
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538033
diis-c [-0.28948003  1.        ]
  HOMO = -0.590219951704786  LUMO = 1.0191361953745
  mo_energy =
[-1.18636943e+02 -1.23413866e+01 -9.59399590e+00 -9.59399590e+00
 -9.59399590e+00 -1.27903603e+00 -5.90219952e-01 -5.90219952e-01
 -5.90219952e-01  1.01913620e+00  1.01913620e+00  1.01913620e+00
  1.03454204e+00  7.42107920e+00  7.42107920e+00  7.42107920e+00
  1.35430510e+01  3.42592405e+01  3.42592405e+01  3.42592405e+01
  1.22536730e+02  1.32244229e+02  1.32244229e+02  1.32244229e+02
  4.87578014e+02  4.87578014e+02  4.87578014e+02  6.64771989e+02
  1.33455750e+03  1.33455750e+03  1.33455750e+03  2.81060575e+03
  3.02145418e+03  3.02145418e+03  3.02145418e+03  6.63668302e+03
  6.63668302e+03  6.63668302e+03  9.23194267e+03  2.55792196e+04
  7.63087704e+04]
E1 = -728.4391460432953  E_coul = 201.69317384505655
cycle= 2 E= -526.745972198239  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.074433
diis-c [-0.00324839  0.08213291  0.91786709]
  HOMO = -0.581208363954632  LUMO = 1.02586121753253
  mo_energy =
[-1.18569956e+02 -1.23037472e+01 -9.55471512e+00 -9.55471512e+00
 -9.55471512e+00 -1.26825116e+00 -5.81208364e-01 -5.81208364e-01
 -5.81208364e-01  1.02586122e+00  1.02586122e+00  1.02586122e+00
  1.04291898e+00  7.44487009e+00  7.44487009e+00  7.44487009e+00
  1.35739688e+01  3.42992312e+01  3.42992312e+01  3.42992312e+01
  1.22593510e+02  1.32299756e+02  1.32299756e+02  1.32299756e+02
  4.87644155e+02  4.87644155e+02  4.87644155e+02  6.64841076e+02
  1.33462764e+03  1.33462764e+03  1.33462764e+03  2.81067927e+03
  3.02152657e+03  3.02152657e+03  3.02152657e+03  6.63675716e+03
  6.63675716e+03  6.63675716e+03  9.23201762e+03  2.55792951e+04
  7.63088462e+04]
E1 = -728.2906297441883  E_coul = 201.54459995285353
cycle= 3 E= -526.746029791335  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013041
diis-c [-5.35329765e-07 -1.21922697e-03  1.44730557e-01  8.56488670e-01]
  HOMO = -0.582688266194484  LUMO = 1.02478044566468
  mo_energy =
[-1.18579816e+02 -1.23094941e+01 -9.56080339e+00 -9.56080339e+00
 -9.56080339e+00 -1.26992476e+00 -5.82688266e-01 -5.82688266e-01
 -5.82688266e-01  1.02478045e+00  1.02478045e+00  1.02478045e+00
  1.04163803e+00  7.44108949e+00  7.44108949e+00  7.44108949e+00
  1.35692258e+01  3.42930764e+01  3.42930764e+01  3.42930764e+01
  1.22585091e+02  1.32291462e+02  1.32291462e+02  1.32291462e+02
  4.87634414e+02  4.87634414e+02  4.87634414e+02  6.64830895e+02
  1.33461732e+03  1.33461732e+03  1.33461732e+03  2.81066831e+03
  3.02151586e+03  3.02151586e+03  3.02151586e+03  6.63674606e+03
  6.63674606e+03  6.63674606e+03  9.23200632e+03  2.55792836e+04
  7.63088346e+04]
E1 = -728.3131595737366  E_coul = 201.56712790320432
cycle= 4 E= -526.746031670532  delta_E= -1.88e-06  |g|= 9.35e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010866
diis-c [-3.79526999e-09  6.84693836e-05 -9.90578252e-03 -6.43357451e-02
  1.07417306e+00]
  HOMO = -0.582670264756911  LUMO = 1.02479599627704
  mo_energy =
[-1.18579778e+02 -1.23094315e+01 -9.56075375e+00 -9.56075375e+00
 -9.56075375e+00 -1.26988531e+00 -5.82670265e-01 -5.82670265e-01
 -5.82670265e-01  1.02479600e+00  1.02479600e+00  1.02479600e+00
  1.04167162e+00  7.44113025e+00  7.44113025e+00  7.44113025e+00
  1.35692838e+01  3.42931241e+01  3.42931241e+01  3.42931241e+01
  1.22585140e+02  1.32291508e+02  1.32291508e+02  1.32291508e+02
  4.87634454e+02  4.87634454e+02  4.87634454e+02  6.64830926e+02
  1.33461735e+03  1.33461735e+03  1.33461735e+03  2.81066832e+03
  3.02151588e+03  3.02151588e+03  3.02151588e+03  6.63674607e+03
  6.63674607e+03  6.63674607e+03  9.23200632e+03  2.55792836e+04
  7.63088346e+04]
E1 = -728.3129555193119  E_coul = 201.56692384727106
cycle= 5 E= -526.746031672041  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77524e-05
diis-c [-6.67449300e-11  1.39854625e-05 -1.83882679e-03 -1.37453432e-02
  4.27785163e-02  9.72791668e-01]
  HOMO = -0.582677370072167  LUMO = 1.02479122701453
  mo_energy =
[-1.18579807e+02 -1.23094531e+01 -9.56077725e+00 -9.56077725e+00
 -9.56077725e+00 -1.26989099e+00 -5.82677370e-01 -5.82677370e-01
 -5.82677370e-01  1.02479123e+00  1.02479123e+00  1.02479123e+00
  1.04166768e+00  7.44111417e+00  7.44111417e+00  7.44111417e+00
  1.35692658e+01  3.42931012e+01  3.42931012e+01  3.42931012e+01
  1.22585113e+02  1.32291481e+02  1.32291481e+02  1.32291481e+02
  4.87634424e+02  4.87634424e+02  4.87634424e+02  6.64830896e+02
  1.33461732e+03  1.33461732e+03  1.33461732e+03  2.81066829e+03
  3.02151585e+03  3.02151585e+03  3.02151585e+03  6.63674604e+03
  6.63674604e+03  6.63674604e+03  9.23200629e+03  2.55792836e+04
  7.63088345e+04]
E1 = -728.3130339606362  E_coul = 201.56700228854288
cycle= 6 E= -526.746031672093  delta_E= -5.24e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130339606362  E_coul = 201.56700228854288
  HOMO = -0.582677395611891  LUMO = 1.02479126258108
  mo_energy =
[-1.18579807e+02 -1.23094530e+01 -9.56077723e+00 -9.56077723e+00
 -9.56077723e+00 -1.26989064e+00 -5.82677396e-01 -5.82677396e-01
 -5.82677396e-01  1.02479126e+00  1.02479126e+00  1.02479126e+00
  1.04166801e+00  7.44111419e+00  7.44111419e+00  7.44111419e+00
  1.35692660e+01  3.42931012e+01  3.42931012e+01  3.42931012e+01
  1.22585113e+02  1.32291481e+02  1.32291481e+02  1.32291481e+02
  4.87634424e+02  4.87634424e+02  4.87634424e+02  6.64830896e+02
  1.33461732e+03  1.33461732e+03  1.33461732e+03  2.81066829e+03
  3.02151585e+03  3.02151585e+03  3.02151585e+03  6.63674604e+03
  6.63674604e+03  6.63674604e+03  9.23200629e+03  2.55792836e+04
  7.63088345e+04]
E1 = -728.3130331621476  E_coul = 201.56700149005334
Extra cycle  E= -526.746031672094  delta_E= -9.09e-13  |g|= 3.42e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828388e+04 7.61709095e+03 3.61751221e+03 1.58815632e+03
 4.18245626e+02 1.22537962e+02 3.94641660e+01 8.50680061e+00
 3.35790961e+00 6.75469940e-01 2.50173449e-01 1.36284357e+03
 6.64158765e+02 2.98197169e+02 3.11659214e+02 6.30550492e+01
 7.48703926e+00 2.07164832e+01 7.81756356e-01 2.86360016e+00
 2.23988197e-01]
E = -526.7460316720942
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8387934        1
[INPUT] 0    0    [1    /1   ]  7617.09095373        1
[INPUT] 0    0    [1    /1   ]  3617.51220671        1
[INPUT] 0    0    [1    /1   ]  1588.15632015        1
[INPUT] 0    0    [1    /1   ]  418.245625769        1
[INPUT] 0    0    [1    /1   ]  122.537962162        1
[INPUT] 0    0    [1    /1   ]  39.4641659841        1
[INPUT] 0    0    [1    /1   ]  8.50680061156        1
[INPUT] 0    0    [1    /1   ]  3.35790960957        1
[INPUT] 0    0    [1    /1   ]  0.675469940471       1
[INPUT] 0    0    [1    /1   ]  0.250173449223       1
[INPUT] 1    0    [1    /1   ]  1362.84357419        1
[INPUT] 1    0    [1    /1   ]  664.15876454         1
[INPUT] 1    0    [1    /1   ]  298.197168874        1
[INPUT] 1    0    [1    /1   ]  311.659213958        1
[INPUT] 1    0    [1    /1   ]  63.0550492016        1
[INPUT] 1    0    [1    /1   ]  7.48703925839        1
[INPUT] 1    0    [1    /1   ]  20.7164832251        1
[INPUT] 1    0    [1    /1   ]  0.781756355968       1
[INPUT] 1    0    [1    /1   ]  2.86360016238        1
[INPUT] 1    0    [1    /1   ]  0.223988197442       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.838793405954, 1.0]], [0, [7617.09095372748, 1.0]], [0, [3617.5122067145353, 1.0]], [0, [1588.1563201542708, 1.0]], [0, [418.2456257687695, 1.0]], [0, [122.53796216199976, 1.0]], [0, [39.464165984057104, 1.0]], [0, [8.506800611559026, 1.0]], [0, [3.3579096095732868, 1.0]], [0, [0.6754699404709225, 1.0]], [0, [0.2501734492228882, 1.0]], [1, [1362.8435741873734, 1.0]], [1, [664.1587645395679, 1.0]], [1, [298.1971688742491, 1.0]], [1, [311.65921395783363, 1.0]], [1, [63.05504920164745, 1.0]], [1, [7.487039258388606, 1.0]], [1, [20.71648322508892, 1.0]], [1, [0.7817563559678478, 1.0]], [1, [2.8636001623848704, 1.0]], [1, [0.22398819744198767, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83879341]
bas 1, expnt(s) = [7617.09095373]
bas 2, expnt(s) = [3617.51220671]
bas 3, expnt(s) = [1588.15632015]
bas 4, expnt(s) = [418.24562577]
bas 5, expnt(s) = [122.53796216]
bas 6, expnt(s) = [39.46416598]
bas 7, expnt(s) = [8.50680061]
bas 8, expnt(s) = [3.35790961]
bas 9, expnt(s) = [0.67546994]
bas 10, expnt(s) = [0.25017345]
bas 11, expnt(s) = [1362.84357419]
bas 12, expnt(s) = [664.15876454]
bas 13, expnt(s) = [298.19716887]
bas 14, expnt(s) = [311.65921396]
bas 15, expnt(s) = [63.0550492]
bas 16, expnt(s) = [7.48703926]
bas 17, expnt(s) = [20.71648323]
bas 18, expnt(s) = [0.78175636]
bas 19, expnt(s) = [2.86360016]
bas 20, expnt(s) = [0.2239882]
CPU time:       505.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828388e+04 5.20029012e+03 7.61709095e+03 2.05995095e+03
 3.61751221e+03 1.17848085e+03 1.58815632e+03 6.35601568e+02
 4.18245626e+02 2.33662264e+02 1.22537962e+02 9.30503507e+01
 3.94641660e+01 3.97802237e+01 8.50680061e+00 1.25846086e+01
 3.35790961e+00 6.26710218e+00 6.75469940e-01 1.88243307e+00
 2.50173449e-01 8.93708599e-01 1.36284357e+03 2.41569392e+04
 6.64158765e+02 9.83613040e+03 2.98197169e+02 3.61504566e+03
 3.11659214e+02 3.82018466e+03 6.30550492e+01 5.18363279e+02
 7.48703926e+00 3.61303385e+01 2.07164832e+01 1.28937556e+02
 7.81756356e-01 2.14448824e+00 2.86360016e+00 1.08673803e+01
 2.23988197e-01 4.49537381e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993244740001373
cond(S) = 97782.04664132762
E1 = -729.5314935882909  E_coul = 203.1798755586574
init E= -526.351618029634
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555728625049951  LUMO = 1.04341753494903
  mo_energy =
[-1.18331910e+02 -1.22047095e+01 -9.44676451e+00 -9.44676451e+00
 -9.44676451e+00 -1.23995260e+00 -5.55728625e-01 -5.55728625e-01
 -5.55728625e-01  1.04341753e+00  1.04341753e+00  1.04341753e+00
  1.06381415e+00  7.51226181e+00  7.51226181e+00  7.51226181e+00
  1.36563339e+01  3.44133912e+01  3.44133912e+01  3.44133912e+01
  1.22764569e+02  1.32471774e+02  1.32471774e+02  1.32471774e+02
  4.87881252e+02  4.87881252e+02  4.87881252e+02  6.65122296e+02
  1.33491608e+03  1.33491608e+03  1.33491608e+03  2.81109883e+03
  3.02187818e+03  3.02187818e+03  3.02187818e+03  6.63721885e+03
  6.63721885e+03  6.63721885e+03  9.23255190e+03  2.55799225e+04
  7.63095630e+04]
E1 = -727.8714798794125  E_coul = 201.12621241544161
cycle= 1 E= -526.745267463971  delta_E= -0.394  |g|= 0.185  |ddm|= 0.311
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538033
diis-c [-0.28948003  1.        ]
  HOMO = -0.590219951704786  LUMO = 1.0191361953745
  mo_energy =
[-1.18636943e+02 -1.23413866e+01 -9.59399590e+00 -9.59399590e+00
 -9.59399590e+00 -1.27903603e+00 -5.90219952e-01 -5.90219952e-01
 -5.90219952e-01  1.01913620e+00  1.01913620e+00  1.01913620e+00
  1.03454204e+00  7.42107920e+00  7.42107920e+00  7.42107920e+00
  1.35430510e+01  3.42592405e+01  3.42592405e+01  3.42592405e+01
  1.22536730e+02  1.32244229e+02  1.32244229e+02  1.32244229e+02
  4.87578014e+02  4.87578014e+02  4.87578014e+02  6.64771989e+02
  1.33455750e+03  1.33455750e+03  1.33455750e+03  2.81060575e+03
  3.02145418e+03  3.02145418e+03  3.02145418e+03  6.63668302e+03
  6.63668302e+03  6.63668302e+03  9.23194267e+03  2.55792196e+04
  7.63087704e+04]
E1 = -728.4391460432953  E_coul = 201.69317384505655
cycle= 2 E= -526.745972198239  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.074433
diis-c [-0.00324839  0.08213291  0.91786709]
  HOMO = -0.581208363954632  LUMO = 1.02586121753253
  mo_energy =
[-1.18569956e+02 -1.23037472e+01 -9.55471512e+00 -9.55471512e+00
 -9.55471512e+00 -1.26825116e+00 -5.81208364e-01 -5.81208364e-01
 -5.81208364e-01  1.02586122e+00  1.02586122e+00  1.02586122e+00
  1.04291898e+00  7.44487009e+00  7.44487009e+00  7.44487009e+00
  1.35739688e+01  3.42992312e+01  3.42992312e+01  3.42992312e+01
  1.22593510e+02  1.32299756e+02  1.32299756e+02  1.32299756e+02
  4.87644155e+02  4.87644155e+02  4.87644155e+02  6.64841076e+02
  1.33462764e+03  1.33462764e+03  1.33462764e+03  2.81067927e+03
  3.02152657e+03  3.02152657e+03  3.02152657e+03  6.63675716e+03
  6.63675716e+03  6.63675716e+03  9.23201762e+03  2.55792951e+04
  7.63088462e+04]
E1 = -728.2906297441883  E_coul = 201.54459995285353
cycle= 3 E= -526.746029791335  delta_E= -5.76e-05  |g|= 0.00622  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013041
diis-c [-5.35329765e-07 -1.21922697e-03  1.44730557e-01  8.56488670e-01]
  HOMO = -0.582688266194484  LUMO = 1.02478044566468
  mo_energy =
[-1.18579816e+02 -1.23094941e+01 -9.56080339e+00 -9.56080339e+00
 -9.56080339e+00 -1.26992476e+00 -5.82688266e-01 -5.82688266e-01
 -5.82688266e-01  1.02478045e+00  1.02478045e+00  1.02478045e+00
  1.04163803e+00  7.44108949e+00  7.44108949e+00  7.44108949e+00
  1.35692258e+01  3.42930764e+01  3.42930764e+01  3.42930764e+01
  1.22585091e+02  1.32291462e+02  1.32291462e+02  1.32291462e+02
  4.87634414e+02  4.87634414e+02  4.87634414e+02  6.64830895e+02
  1.33461732e+03  1.33461732e+03  1.33461732e+03  2.81066831e+03
  3.02151586e+03  3.02151586e+03  3.02151586e+03  6.63674606e+03
  6.63674606e+03  6.63674606e+03  9.23200632e+03  2.55792836e+04
  7.63088346e+04]
E1 = -728.3131595737366  E_coul = 201.56712790320432
cycle= 4 E= -526.746031670532  delta_E= -1.88e-06  |g|= 9.35e-05  |ddm|= 0.00225
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00010866
diis-c [-3.79526999e-09  6.84693836e-05 -9.90578252e-03 -6.43357451e-02
  1.07417306e+00]
  HOMO = -0.582670264756911  LUMO = 1.02479599627704
  mo_energy =
[-1.18579778e+02 -1.23094315e+01 -9.56075375e+00 -9.56075375e+00
 -9.56075375e+00 -1.26988531e+00 -5.82670265e-01 -5.82670265e-01
 -5.82670265e-01  1.02479600e+00  1.02479600e+00  1.02479600e+00
  1.04167162e+00  7.44113025e+00  7.44113025e+00  7.44113025e+00
  1.35692838e+01  3.42931241e+01  3.42931241e+01  3.42931241e+01
  1.22585140e+02  1.32291508e+02  1.32291508e+02  1.32291508e+02
  4.87634454e+02  4.87634454e+02  4.87634454e+02  6.64830926e+02
  1.33461735e+03  1.33461735e+03  1.33461735e+03  2.81066832e+03
  3.02151588e+03  3.02151588e+03  3.02151588e+03  6.63674607e+03
  6.63674607e+03  6.63674607e+03  9.23200632e+03  2.55792836e+04
  7.63088346e+04]
E1 = -728.3129555193119  E_coul = 201.56692384727106
cycle= 5 E= -526.746031672041  delta_E= -1.51e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77524e-05
diis-c [-6.67449300e-11  1.39854625e-05 -1.83882679e-03 -1.37453432e-02
  4.27785163e-02  9.72791668e-01]
  HOMO = -0.582677370072167  LUMO = 1.02479122701453
  mo_energy =
[-1.18579807e+02 -1.23094531e+01 -9.56077725e+00 -9.56077725e+00
 -9.56077725e+00 -1.26989099e+00 -5.82677370e-01 -5.82677370e-01
 -5.82677370e-01  1.02479123e+00  1.02479123e+00  1.02479123e+00
  1.04166768e+00  7.44111417e+00  7.44111417e+00  7.44111417e+00
  1.35692658e+01  3.42931012e+01  3.42931012e+01  3.42931012e+01
  1.22585113e+02  1.32291481e+02  1.32291481e+02  1.32291481e+02
  4.87634424e+02  4.87634424e+02  4.87634424e+02  6.64830896e+02
  1.33461732e+03  1.33461732e+03  1.33461732e+03  2.81066829e+03
  3.02151585e+03  3.02151585e+03  3.02151585e+03  6.63674604e+03
  6.63674604e+03  6.63674604e+03  9.23200629e+03  2.55792836e+04
  7.63088345e+04]
E1 = -728.3130339606362  E_coul = 201.56700228854288
cycle= 6 E= -526.746031672093  delta_E= -5.24e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3130339606362  E_coul = 201.56700228854288
  HOMO = -0.582677395611891  LUMO = 1.02479126258108
  mo_energy =
[-1.18579807e+02 -1.23094530e+01 -9.56077723e+00 -9.56077723e+00
 -9.56077723e+00 -1.26989064e+00 -5.82677396e-01 -5.82677396e-01
 -5.82677396e-01  1.02479126e+00  1.02479126e+00  1.02479126e+00
  1.04166801e+00  7.44111419e+00  7.44111419e+00  7.44111419e+00
  1.35692660e+01  3.42931012e+01  3.42931012e+01  3.42931012e+01
  1.22585113e+02  1.32291481e+02  1.32291481e+02  1.32291481e+02
  4.87634424e+02  4.87634424e+02  4.87634424e+02  6.64830896e+02
  1.33461732e+03  1.33461732e+03  1.33461732e+03  2.81066829e+03
  3.02151585e+03  3.02151585e+03  3.02151585e+03  6.63674604e+03
  6.63674604e+03  6.63674604e+03  9.23200629e+03  2.55792836e+04
  7.63088345e+04]
E1 = -728.3130331621476  E_coul = 201.56700149005334
Extra cycle  E= -526.746031672094  delta_E= -9.09e-13  |g|= 3.42e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97782.04664132762
E1 = -728.3130331621476  E_coul = 201.56700149005334
init E= -526.746031672094
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582677421673301  LUMO = 1.02479125505554
  mo_energy =
[-1.18579807e+02 -1.23094531e+01 -9.56077731e+00 -9.56077731e+00
 -9.56077731e+00 -1.26989060e+00 -5.82677422e-01 -5.82677422e-01
 -5.82677422e-01  1.02479126e+00  1.02479126e+00  1.02479126e+00
  1.04166805e+00  7.44111415e+00  7.44111415e+00  7.44111415e+00
  1.35692660e+01  3.42931012e+01  3.42931012e+01  3.42931012e+01
  1.22585113e+02  1.32291481e+02  1.32291481e+02  1.32291481e+02
  4.87634424e+02  4.87634424e+02  4.87634424e+02  6.64830896e+02
  1.33461732e+03  1.33461732e+03  1.33461732e+03  2.81066829e+03
  3.02151585e+03  3.02151585e+03  3.02151585e+03  6.63674604e+03
  6.63674604e+03  6.63674604e+03  9.23200629e+03  2.55792836e+04
  7.63088345e+04]
E1 = -728.313033286241  E_coul = 201.56700161414693
cycle= 1 E= -526.746031672094  delta_E= 2.27e-13  |g|= 7.1e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.313033286241  E_coul = 201.56700161414693
  HOMO = -0.582677421596796  LUMO = 1.02479125744612
  mo_energy =
[-1.18579807e+02 -1.23094531e+01 -9.56077730e+00 -9.56077730e+00
 -9.56077730e+00 -1.26989058e+00 -5.82677422e-01 -5.82677422e-01
 -5.82677422e-01  1.02479126e+00  1.02479126e+00  1.02479126e+00
  1.04166807e+00  7.44111415e+00  7.44111415e+00  7.44111415e+00
  1.35692660e+01  3.42931012e+01  3.42931012e+01  3.42931012e+01
  1.22585113e+02  1.32291481e+02  1.32291481e+02  1.32291481e+02
  4.87634424e+02  4.87634424e+02  4.87634424e+02  6.64830896e+02
  1.33461732e+03  1.33461732e+03  1.33461732e+03  2.81066829e+03
  3.02151585e+03  3.02151585e+03  3.02151585e+03  6.63674604e+03
  6.63674604e+03  6.63674604e+03  9.23200629e+03  2.55792836e+04
  7.63088345e+04]
E1 = -728.3130332308356  E_coul = 201.56700155874114
Extra cycle  E= -526.746031672094  delta_E= -4.55e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.38 sec
exp = [2.61828388e+04 7.61709095e+03 3.61751221e+03 1.58815632e+03
 4.18245626e+02 1.22537962e+02 3.94641660e+01 8.50680061e+00
 3.35790961e+00 6.75469940e-01 2.50173449e-01 1.36284357e+03
 6.64158765e+02 2.98197169e+02 3.11659214e+02 6.30550492e+01
 7.48703926e+00 2.07164832e+01 7.81756356e-01 2.86360016e+00
 2.23988197e-01]
grad_E = [-1.39801371e-06  2.16447946e-06 -2.13881420e-06  3.71161222e-05
  5.71445876e-06  1.15423117e-05 -6.33419112e-06  9.88991407e-06
  5.23489949e-05  1.78627278e-04 -1.67172754e-04 -5.91819286e-07
  3.99401098e-06  1.81809351e-05  1.55211676e-05  8.38346050e-05
 -2.13049045e-04  5.25024217e-05  2.58328830e-04  2.34125355e-04
 -6.11679419e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8394591        1
[INPUT] 0    0    [1    /1   ]  7617.08984939        1
[INPUT] 0    0    [1    /1   ]  3617.51316499        1
[INPUT] 0    0    [1    /1   ]  1588.13630475        1
[INPUT] 0    0    [1    /1   ]  418.255450791        1
[INPUT] 0    0    [1    /1   ]  122.564868581        1
[INPUT] 0    0    [1    /1   ]  39.4741070206        1
[INPUT] 0    0    [1    /1   ]  8.51335155188        1
[INPUT] 0    0    [1    /1   ]  3.36015065434        1
[INPUT] 0    0    [1    /1   ]  0.676324225599       1
[INPUT] 0    0    [1    /1   ]  0.250466868817       1
[INPUT] 1    0    [1    /1   ]  1362.84384633        1
[INPUT] 1    0    [1    /1   ]  664.156812614        1
[INPUT] 1    0    [1    /1   ]  298.188215242        1
[INPUT] 1    0    [1    /1   ]  311.651557894        1
[INPUT] 1    0    [1    /1   ]  63.0280987247        1
[INPUT] 1    0    [1    /1   ]  7.47676247819        1
[INPUT] 1    0    [1    /1   ]  20.6961647013        1
[INPUT] 1    0    [1    /1   ]  0.781431259163       1
[INPUT] 1    0    [1    /1   ]  2.86036792464        1
[INPUT] 1    0    [1    /1   ]  0.223912676944       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.83945913416, 1.0]], [0, [7617.089849389096, 1.0]], [0, [3617.513164994101, 1.0]], [0, [1588.1363047484847, 1.0]], [0, [418.25545079060475, 1.0]], [0, [122.56486858082745, 1.0]], [0, [39.47410702060878, 1.0]], [0, [8.513351551878623, 1.0]], [0, [3.3601506543449915, 1.0]], [0, [0.676324225598835, 1.0]], [0, [0.25046686881650504, 1.0]], [1, [1362.8438463297357, 1.0]], [1, [664.156812614209, 1.0]], [1, [298.18821524164247, 1.0]], [1, [311.65155789422727, 1.0]], [1, [63.0280987247231, 1.0]], [1, [7.47676247819282, 1.0]], [1, [20.696164701258127, 1.0]], [1, [0.7814312591630543, 1.0]], [1, [2.8603679246424196, 1.0]], [1, [0.22391267694362324, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83945913]
bas 1, expnt(s) = [7617.08984939]
bas 2, expnt(s) = [3617.51316499]
bas 3, expnt(s) = [1588.13630475]
bas 4, expnt(s) = [418.25545079]
bas 5, expnt(s) = [122.56486858]
bas 6, expnt(s) = [39.47410702]
bas 7, expnt(s) = [8.51335155]
bas 8, expnt(s) = [3.36015065]
bas 9, expnt(s) = [0.67632423]
bas 10, expnt(s) = [0.25046687]
bas 11, expnt(s) = [1362.84384633]
bas 12, expnt(s) = [664.15681261]
bas 13, expnt(s) = [298.18821524]
bas 14, expnt(s) = [311.65155789]
bas 15, expnt(s) = [63.02809872]
bas 16, expnt(s) = [7.47676248]
bas 17, expnt(s) = [20.6961647]
bas 18, expnt(s) = [0.78143126]
bas 19, expnt(s) = [2.86036792]
bas 20, expnt(s) = [0.22391268]
CPU time:       511.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828395e+04 5.20029022e+03 7.61708985e+03 2.05995073e+03
 3.61751316e+03 1.17848108e+03 1.58813630e+03 6.35595560e+02
 4.18255451e+02 2.33666380e+02 1.22564869e+02 9.30656740e+01
 3.94741070e+01 3.97877390e+01 8.51335155e+00 1.25918763e+01
 3.36015065e+00 6.27023888e+00 6.76324226e-01 1.88421836e+00
 2.50466869e-01 8.94494633e-01 1.36284385e+03 2.41569452e+04
 6.64156813e+02 9.83609427e+03 2.98188215e+02 3.61490998e+03
 3.11651558e+02 3.82006735e+03 6.30280987e+01 5.18086351e+02
 7.47676248e+00 3.60683581e+01 2.06961647e+01 1.28779499e+02
 7.81431259e-01 2.14337355e+00 2.86036792e+00 1.08520495e+01
 2.23912677e-01 4.49347930e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99325298834497
cond(S) = 97699.13054241557
E1 = -729.5316018478337  E_coul = 203.17993952148535
init E= -526.351662326348
    CPU time for initialize scf      0.10 sec, wall time      0.05 sec
  HOMO = -0.55573301295374  LUMO = 1.04283070002989
  mo_energy =
[-1.18331916e+02 -1.22046987e+01 -9.44675415e+00 -9.44675415e+00
 -9.44675415e+00 -1.23994467e+00 -5.55733013e-01 -5.55733013e-01
 -5.55733013e-01  1.04283070e+00  1.04283070e+00  1.04283070e+00
  1.06608214e+00  7.50229847e+00  7.50229847e+00  7.50229847e+00
  1.36758663e+01  3.43627276e+01  3.43627276e+01  3.43627276e+01
  1.22836503e+02  1.32343432e+02  1.32343432e+02  1.32343432e+02
  4.87691632e+02  4.87691632e+02  4.87691632e+02  6.65269807e+02
  1.33470054e+03  1.33470054e+03  1.33470054e+03  2.81127739e+03
  3.02164303e+03  3.02164303e+03  3.02164303e+03  6.63698098e+03
  6.63698098e+03  6.63698098e+03  9.23270641e+03  2.55800497e+04
  7.63096720e+04]
E1 = -727.8713390634255  E_coul = 201.12606986965855
cycle= 1 E= -526.745269193767  delta_E= -0.394  |g|= 0.185  |ddm|= 0.311
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538025
diis-c [-0.28947113  1.        ]
  HOMO = -0.590238976458522  LUMO = 1.01855457482091
  mo_energy =
[-1.18636955e+02 -1.23413861e+01 -9.59399327e+00 -9.59399327e+00
 -9.59399327e+00 -1.27904763e+00 -5.90238976e-01 -5.90238976e-01
 -5.90238976e-01  1.01855457e+00  1.01855457e+00  1.01855457e+00
  1.03674187e+00  7.41117230e+00  7.41117230e+00  7.41117230e+00
  1.35625146e+01  3.42086378e+01  3.42086378e+01  3.42086378e+01
  1.22608628e+02  1.32115905e+02  1.32115905e+02  1.32115905e+02
  4.87388383e+02  4.87388383e+02  4.87388383e+02  6.64919487e+02
  1.33434195e+03  1.33434195e+03  1.33434195e+03  2.81078431e+03
  3.02121902e+03  3.02121902e+03  3.02121902e+03  6.63644515e+03
  6.63644515e+03  6.63644515e+03  9.23209719e+03  2.55793469e+04
  7.63088794e+04]
E1 = -728.4391375281037  E_coul = 201.69316344840564
cycle= 2 E= -526.745974079698  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744392
diis-c [-0.00324937  0.08213327  0.91786673]
  HOMO = -0.581224893740166  LUMO = 1.02527710028174
  mo_energy =
[-1.18569957e+02 -1.23037375e+01 -9.55470281e+00 -9.55470281e+00
 -9.55470281e+00 -1.26825968e+00 -5.81224894e-01 -5.81224894e-01
 -5.81224894e-01  1.02527710e+00  1.02527710e+00  1.02527710e+00
  1.04513463e+00  7.43495062e+00  7.43495062e+00  7.43495062e+00
  1.35934538e+01  3.42486210e+01  3.42486210e+01  3.42486210e+01
  1.22665422e+02  1.32171438e+02  1.32171438e+02  1.32171438e+02
  4.87454536e+02  4.87454536e+02  4.87454536e+02  6.64988587e+02
  1.33441211e+03  1.33441211e+03  1.33441211e+03  2.81085784e+03
  3.02129142e+03  3.02129142e+03  3.02129142e+03  6.63651930e+03
  6.63651930e+03  6.63651930e+03  9.23217215e+03  2.55794224e+04
  7.63089552e+04]
E1 = -728.2905601277968  E_coul = 201.5445284200319
cycle= 3 E= -526.746031707765  delta_E= -5.76e-05  |g|= 0.00623  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130445
diis-c [-5.35215187e-07 -1.21915622e-03  1.44756346e-01  8.56462810e-01]
  HOMO = -0.582705604157471  LUMO = 1.02419641756252
  mo_energy =
[-1.18579821e+02 -1.23094871e+01 -9.56079390e+00 -9.56079390e+00
 -9.56079390e+00 -1.26993437e+00 -5.82705604e-01 -5.82705604e-01
 -5.82705604e-01  1.02419642e+00  1.02419642e+00  1.02419642e+00
  1.04385074e+00  7.43117098e+00  7.43117098e+00  7.43117098e+00
  1.35887064e+01  3.42424658e+01  3.42424658e+01  3.42424658e+01
  1.22656999e+02  1.32163140e+02  1.32163140e+02  1.32163140e+02
  4.87444792e+02  4.87444792e+02  4.87444792e+02  6.64978401e+02
  1.33440178e+03  1.33440178e+03  1.33440178e+03  2.81084688e+03
  3.02128071e+03  3.02128071e+03  3.02128071e+03  6.63650820e+03
  6.63650820e+03  6.63650820e+03  9.23216084e+03  2.55794109e+04
  7.63089436e+04]
E1 = -728.3131052572729  E_coul = 201.567071668149
cycle= 4 E= -526.746033589124  delta_E= -1.88e-06  |g|= 9.34e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108443
diis-c [-3.79781149e-09  6.82655435e-05 -9.88107832e-03 -6.41552234e-02
  1.07396804e+00]
  HOMO = -0.582687543530231  LUMO = 1.02421199926773
  mo_energy =
[-1.18579782e+02 -1.23094243e+01 -9.56074408e+00 -9.56074408e+00
 -9.56074408e+00 -1.26989488e+00 -5.82687544e-01 -5.82687544e-01
 -5.82687544e-01  1.02421200e+00  1.02421200e+00  1.02421200e+00
  1.04388439e+00  7.43121185e+00  7.43121185e+00  7.43121185e+00
  1.35887645e+01  3.42425136e+01  3.42425136e+01  3.42425136e+01
  1.22657048e+02  1.32163187e+02  1.32163187e+02  1.32163187e+02
  4.87444831e+02  4.87444831e+02  4.87444831e+02  6.64978432e+02
  1.33440181e+03  1.33440181e+03  1.33440181e+03  2.81084689e+03
  3.02128073e+03  3.02128073e+03  3.02128073e+03  6.63650821e+03
  6.63650821e+03  6.63650821e+03  9.23216084e+03  2.55794109e+04
  7.63089436e+04]
E1 = -728.3129007345244  E_coul = 201.56686714389775
cycle= 5 E= -526.746033590627  delta_E= -1.5e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77737e-05
diis-c [-6.65878061e-11  1.39832729e-05 -1.83910869e-03 -1.37449911e-02
  4.28064434e-02  9.72763673e-01]
  HOMO = -0.582694647130646  LUMO = 1.02420723410613
  mo_energy =
[-1.18579811e+02 -1.23094460e+01 -9.56076759e+00 -9.56076759e+00
 -9.56076759e+00 -1.26990056e+00 -5.82694647e-01 -5.82694647e-01
 -5.82694647e-01  1.02420723e+00  1.02420723e+00  1.02420723e+00
  1.04388045e+00  7.43119578e+00  7.43119578e+00  7.43119578e+00
  1.35887465e+01  3.42424907e+01  3.42424907e+01  3.42424907e+01
  1.22657021e+02  1.32163160e+02  1.32163160e+02  1.32163160e+02
  4.87444802e+02  4.87444802e+02  4.87444802e+02  6.64978402e+02
  1.33440178e+03  1.33440178e+03  1.33440178e+03  2.81084686e+03
  3.02128070e+03  3.02128070e+03  3.02128070e+03  6.63650818e+03
  6.63650818e+03  6.63650818e+03  9.23216081e+03  2.55794109e+04
  7.63089435e+04]
E1 = -728.3129792345483  E_coul = 201.56694564386794
cycle= 6 E= -526.74603359068  delta_E= -5.37e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3129792345483  E_coul = 201.56694564386794
  HOMO = -0.582694673165393  LUMO = 1.02420726928635
  mo_energy =
[-1.18579811e+02 -1.23094459e+01 -9.56076757e+00 -9.56076757e+00
 -9.56076757e+00 -1.26990022e+00 -5.82694673e-01 -5.82694673e-01
 -5.82694673e-01  1.02420727e+00  1.02420727e+00  1.02420727e+00
  1.04388077e+00  7.43119580e+00  7.43119580e+00  7.43119580e+00
  1.35887467e+01  3.42424907e+01  3.42424907e+01  3.42424907e+01
  1.22657022e+02  1.32163160e+02  1.32163160e+02  1.32163160e+02
  4.87444802e+02  4.87444802e+02  4.87444802e+02  6.64978402e+02
  1.33440178e+03  1.33440178e+03  1.33440178e+03  2.81084686e+03
  3.02128070e+03  3.02128070e+03  3.02128070e+03  6.63650818e+03
  6.63650818e+03  6.63650818e+03  9.23216081e+03  2.55794109e+04
  7.63089435e+04]
E1 = -728.3129784526823  E_coul = 201.5669448620006
Extra cycle  E= -526.746033590682  delta_E= -1.36e-12  |g|= 3.42e-07  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828395e+04 7.61708985e+03 3.61751316e+03 1.58813630e+03
 4.18255451e+02 1.22564869e+02 3.94741070e+01 8.51335155e+00
 3.36015065e+00 6.76324226e-01 2.50466869e-01 1.36284385e+03
 6.64156813e+02 2.98188215e+02 3.11651558e+02 6.30280987e+01
 7.47676248e+00 2.06961647e+01 7.81431259e-01 2.86036792e+00
 2.23912677e-01]
E = -526.7460335906817
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8394591        1
[INPUT] 0    0    [1    /1   ]  7617.08984939        1
[INPUT] 0    0    [1    /1   ]  3617.51316499        1
[INPUT] 0    0    [1    /1   ]  1588.13630475        1
[INPUT] 0    0    [1    /1   ]  418.255450791        1
[INPUT] 0    0    [1    /1   ]  122.564868581        1
[INPUT] 0    0    [1    /1   ]  39.4741070206        1
[INPUT] 0    0    [1    /1   ]  8.51335155188        1
[INPUT] 0    0    [1    /1   ]  3.36015065434        1
[INPUT] 0    0    [1    /1   ]  0.676324225599       1
[INPUT] 0    0    [1    /1   ]  0.250466868817       1
[INPUT] 1    0    [1    /1   ]  1362.84384633        1
[INPUT] 1    0    [1    /1   ]  664.156812614        1
[INPUT] 1    0    [1    /1   ]  298.188215242        1
[INPUT] 1    0    [1    /1   ]  311.651557894        1
[INPUT] 1    0    [1    /1   ]  63.0280987247        1
[INPUT] 1    0    [1    /1   ]  7.47676247819        1
[INPUT] 1    0    [1    /1   ]  20.6961647013        1
[INPUT] 1    0    [1    /1   ]  0.781431259163       1
[INPUT] 1    0    [1    /1   ]  2.86036792464        1
[INPUT] 1    0    [1    /1   ]  0.223912676944       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.83945913416, 1.0]], [0, [7617.089849389096, 1.0]], [0, [3617.513164994101, 1.0]], [0, [1588.1363047484847, 1.0]], [0, [418.25545079060475, 1.0]], [0, [122.56486858082745, 1.0]], [0, [39.47410702060878, 1.0]], [0, [8.513351551878623, 1.0]], [0, [3.3601506543449915, 1.0]], [0, [0.676324225598835, 1.0]], [0, [0.25046686881650504, 1.0]], [1, [1362.8438463297357, 1.0]], [1, [664.156812614209, 1.0]], [1, [298.18821524164247, 1.0]], [1, [311.65155789422727, 1.0]], [1, [63.0280987247231, 1.0]], [1, [7.47676247819282, 1.0]], [1, [20.696164701258127, 1.0]], [1, [0.7814312591630543, 1.0]], [1, [2.8603679246424196, 1.0]], [1, [0.22391267694362324, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.83945913]
bas 1, expnt(s) = [7617.08984939]
bas 2, expnt(s) = [3617.51316499]
bas 3, expnt(s) = [1588.13630475]
bas 4, expnt(s) = [418.25545079]
bas 5, expnt(s) = [122.56486858]
bas 6, expnt(s) = [39.47410702]
bas 7, expnt(s) = [8.51335155]
bas 8, expnt(s) = [3.36015065]
bas 9, expnt(s) = [0.67632423]
bas 10, expnt(s) = [0.25046687]
bas 11, expnt(s) = [1362.84384633]
bas 12, expnt(s) = [664.15681261]
bas 13, expnt(s) = [298.18821524]
bas 14, expnt(s) = [311.65155789]
bas 15, expnt(s) = [63.02809872]
bas 16, expnt(s) = [7.47676248]
bas 17, expnt(s) = [20.6961647]
bas 18, expnt(s) = [0.78143126]
bas 19, expnt(s) = [2.86036792]
bas 20, expnt(s) = [0.22391268]
CPU time:       511.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828395e+04 5.20029022e+03 7.61708985e+03 2.05995073e+03
 3.61751316e+03 1.17848108e+03 1.58813630e+03 6.35595560e+02
 4.18255451e+02 2.33666380e+02 1.22564869e+02 9.30656740e+01
 3.94741070e+01 3.97877390e+01 8.51335155e+00 1.25918763e+01
 3.36015065e+00 6.27023888e+00 6.76324226e-01 1.88421836e+00
 2.50466869e-01 8.94494633e-01 1.36284385e+03 2.41569452e+04
 6.64156813e+02 9.83609427e+03 2.98188215e+02 3.61490998e+03
 3.11651558e+02 3.82006735e+03 6.30280987e+01 5.18086351e+02
 7.47676248e+00 3.60683581e+01 2.06961647e+01 1.28779499e+02
 7.81431259e-01 2.14337355e+00 2.86036792e+00 1.08520495e+01
 2.23912677e-01 4.49347930e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99325298834497
cond(S) = 97699.13054241557
E1 = -729.5316018478337  E_coul = 203.17993952148535
init E= -526.351662326348
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.55573301295374  LUMO = 1.04283070002989
  mo_energy =
[-1.18331916e+02 -1.22046987e+01 -9.44675415e+00 -9.44675415e+00
 -9.44675415e+00 -1.23994467e+00 -5.55733013e-01 -5.55733013e-01
 -5.55733013e-01  1.04283070e+00  1.04283070e+00  1.04283070e+00
  1.06608214e+00  7.50229847e+00  7.50229847e+00  7.50229847e+00
  1.36758663e+01  3.43627276e+01  3.43627276e+01  3.43627276e+01
  1.22836503e+02  1.32343432e+02  1.32343432e+02  1.32343432e+02
  4.87691632e+02  4.87691632e+02  4.87691632e+02  6.65269807e+02
  1.33470054e+03  1.33470054e+03  1.33470054e+03  2.81127739e+03
  3.02164303e+03  3.02164303e+03  3.02164303e+03  6.63698098e+03
  6.63698098e+03  6.63698098e+03  9.23270641e+03  2.55800497e+04
  7.63096720e+04]
E1 = -727.8713390634255  E_coul = 201.12606986965855
cycle= 1 E= -526.745269193767  delta_E= -0.394  |g|= 0.185  |ddm|= 0.311
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538025
diis-c [-0.28947113  1.        ]
  HOMO = -0.590238976458522  LUMO = 1.01855457482091
  mo_energy =
[-1.18636955e+02 -1.23413861e+01 -9.59399327e+00 -9.59399327e+00
 -9.59399327e+00 -1.27904763e+00 -5.90238976e-01 -5.90238976e-01
 -5.90238976e-01  1.01855457e+00  1.01855457e+00  1.01855457e+00
  1.03674187e+00  7.41117230e+00  7.41117230e+00  7.41117230e+00
  1.35625146e+01  3.42086378e+01  3.42086378e+01  3.42086378e+01
  1.22608628e+02  1.32115905e+02  1.32115905e+02  1.32115905e+02
  4.87388383e+02  4.87388383e+02  4.87388383e+02  6.64919487e+02
  1.33434195e+03  1.33434195e+03  1.33434195e+03  2.81078431e+03
  3.02121902e+03  3.02121902e+03  3.02121902e+03  6.63644515e+03
  6.63644515e+03  6.63644515e+03  9.23209719e+03  2.55793469e+04
  7.63088794e+04]
E1 = -728.4391375281037  E_coul = 201.69316344840564
cycle= 2 E= -526.745974079698  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744392
diis-c [-0.00324937  0.08213327  0.91786673]
  HOMO = -0.581224893740166  LUMO = 1.02527710028174
  mo_energy =
[-1.18569957e+02 -1.23037375e+01 -9.55470281e+00 -9.55470281e+00
 -9.55470281e+00 -1.26825968e+00 -5.81224894e-01 -5.81224894e-01
 -5.81224894e-01  1.02527710e+00  1.02527710e+00  1.02527710e+00
  1.04513463e+00  7.43495062e+00  7.43495062e+00  7.43495062e+00
  1.35934538e+01  3.42486210e+01  3.42486210e+01  3.42486210e+01
  1.22665422e+02  1.32171438e+02  1.32171438e+02  1.32171438e+02
  4.87454536e+02  4.87454536e+02  4.87454536e+02  6.64988587e+02
  1.33441211e+03  1.33441211e+03  1.33441211e+03  2.81085784e+03
  3.02129142e+03  3.02129142e+03  3.02129142e+03  6.63651930e+03
  6.63651930e+03  6.63651930e+03  9.23217215e+03  2.55794224e+04
  7.63089552e+04]
E1 = -728.2905601277968  E_coul = 201.5445284200319
cycle= 3 E= -526.746031707765  delta_E= -5.76e-05  |g|= 0.00623  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130445
diis-c [-5.35215187e-07 -1.21915622e-03  1.44756346e-01  8.56462810e-01]
  HOMO = -0.582705604157471  LUMO = 1.02419641756252
  mo_energy =
[-1.18579821e+02 -1.23094871e+01 -9.56079390e+00 -9.56079390e+00
 -9.56079390e+00 -1.26993437e+00 -5.82705604e-01 -5.82705604e-01
 -5.82705604e-01  1.02419642e+00  1.02419642e+00  1.02419642e+00
  1.04385074e+00  7.43117098e+00  7.43117098e+00  7.43117098e+00
  1.35887064e+01  3.42424658e+01  3.42424658e+01  3.42424658e+01
  1.22656999e+02  1.32163140e+02  1.32163140e+02  1.32163140e+02
  4.87444792e+02  4.87444792e+02  4.87444792e+02  6.64978401e+02
  1.33440178e+03  1.33440178e+03  1.33440178e+03  2.81084688e+03
  3.02128071e+03  3.02128071e+03  3.02128071e+03  6.63650820e+03
  6.63650820e+03  6.63650820e+03  9.23216084e+03  2.55794109e+04
  7.63089436e+04]
E1 = -728.3131052572729  E_coul = 201.567071668149
cycle= 4 E= -526.746033589124  delta_E= -1.88e-06  |g|= 9.34e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108443
diis-c [-3.79781149e-09  6.82655435e-05 -9.88107832e-03 -6.41552234e-02
  1.07396804e+00]
  HOMO = -0.582687543530231  LUMO = 1.02421199926773
  mo_energy =
[-1.18579782e+02 -1.23094243e+01 -9.56074408e+00 -9.56074408e+00
 -9.56074408e+00 -1.26989488e+00 -5.82687544e-01 -5.82687544e-01
 -5.82687544e-01  1.02421200e+00  1.02421200e+00  1.02421200e+00
  1.04388439e+00  7.43121185e+00  7.43121185e+00  7.43121185e+00
  1.35887645e+01  3.42425136e+01  3.42425136e+01  3.42425136e+01
  1.22657048e+02  1.32163187e+02  1.32163187e+02  1.32163187e+02
  4.87444831e+02  4.87444831e+02  4.87444831e+02  6.64978432e+02
  1.33440181e+03  1.33440181e+03  1.33440181e+03  2.81084689e+03
  3.02128073e+03  3.02128073e+03  3.02128073e+03  6.63650821e+03
  6.63650821e+03  6.63650821e+03  9.23216084e+03  2.55794109e+04
  7.63089436e+04]
E1 = -728.3129007345244  E_coul = 201.56686714389775
cycle= 5 E= -526.746033590627  delta_E= -1.5e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77737e-05
diis-c [-6.65878061e-11  1.39832729e-05 -1.83910869e-03 -1.37449911e-02
  4.28064434e-02  9.72763673e-01]
  HOMO = -0.582694647130646  LUMO = 1.02420723410613
  mo_energy =
[-1.18579811e+02 -1.23094460e+01 -9.56076759e+00 -9.56076759e+00
 -9.56076759e+00 -1.26990056e+00 -5.82694647e-01 -5.82694647e-01
 -5.82694647e-01  1.02420723e+00  1.02420723e+00  1.02420723e+00
  1.04388045e+00  7.43119578e+00  7.43119578e+00  7.43119578e+00
  1.35887465e+01  3.42424907e+01  3.42424907e+01  3.42424907e+01
  1.22657021e+02  1.32163160e+02  1.32163160e+02  1.32163160e+02
  4.87444802e+02  4.87444802e+02  4.87444802e+02  6.64978402e+02
  1.33440178e+03  1.33440178e+03  1.33440178e+03  2.81084686e+03
  3.02128070e+03  3.02128070e+03  3.02128070e+03  6.63650818e+03
  6.63650818e+03  6.63650818e+03  9.23216081e+03  2.55794109e+04
  7.63089435e+04]
E1 = -728.3129792345483  E_coul = 201.56694564386794
cycle= 6 E= -526.74603359068  delta_E= -5.37e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3129792345483  E_coul = 201.56694564386794
  HOMO = -0.582694673165393  LUMO = 1.02420726928635
  mo_energy =
[-1.18579811e+02 -1.23094459e+01 -9.56076757e+00 -9.56076757e+00
 -9.56076757e+00 -1.26990022e+00 -5.82694673e-01 -5.82694673e-01
 -5.82694673e-01  1.02420727e+00  1.02420727e+00  1.02420727e+00
  1.04388077e+00  7.43119580e+00  7.43119580e+00  7.43119580e+00
  1.35887467e+01  3.42424907e+01  3.42424907e+01  3.42424907e+01
  1.22657022e+02  1.32163160e+02  1.32163160e+02  1.32163160e+02
  4.87444802e+02  4.87444802e+02  4.87444802e+02  6.64978402e+02
  1.33440178e+03  1.33440178e+03  1.33440178e+03  2.81084686e+03
  3.02128070e+03  3.02128070e+03  3.02128070e+03  6.63650818e+03
  6.63650818e+03  6.63650818e+03  9.23216081e+03  2.55794109e+04
  7.63089435e+04]
E1 = -728.3129784526823  E_coul = 201.5669448620006
Extra cycle  E= -526.746033590682  delta_E= -1.36e-12  |g|= 3.42e-07  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97699.13054241557
E1 = -728.3129784526823  E_coul = 201.5669448620006
init E= -526.746033590682
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582694698833046  LUMO = 1.02420726205154
  mo_energy =
[-1.18579811e+02 -1.23094459e+01 -9.56076765e+00 -9.56076765e+00
 -9.56076765e+00 -1.26990017e+00 -5.82694699e-01 -5.82694699e-01
 -5.82694699e-01  1.02420726e+00  1.02420726e+00  1.02420726e+00
  1.04388082e+00  7.43119576e+00  7.43119576e+00  7.43119576e+00
  1.35887467e+01  3.42424907e+01  3.42424907e+01  3.42424907e+01
  1.22657021e+02  1.32163160e+02  1.32163160e+02  1.32163160e+02
  4.87444802e+02  4.87444802e+02  4.87444802e+02  6.64978402e+02
  1.33440178e+03  1.33440178e+03  1.33440178e+03  2.81084686e+03
  3.02128070e+03  3.02128070e+03  3.02128070e+03  6.63650818e+03
  6.63650818e+03  6.63650818e+03  9.23216081e+03  2.55794109e+04
  7.63089435e+04]
E1 = -728.3129785731148  E_coul = 201.56694498243343
cycle= 1 E= -526.746033590681  delta_E= 2.27e-13  |g|= 7.09e-08  |ddm|= 5.65e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3129785731148  E_coul = 201.56694498243343
  HOMO = -0.582694698810097  LUMO = 1.02420726440036
  mo_energy =
[-1.18579811e+02 -1.23094459e+01 -9.56076764e+00 -9.56076764e+00
 -9.56076764e+00 -1.26990016e+00 -5.82694699e-01 -5.82694699e-01
 -5.82694699e-01  1.02420726e+00  1.02420726e+00  1.02420726e+00
  1.04388083e+00  7.43119576e+00  7.43119576e+00  7.43119576e+00
  1.35887467e+01  3.42424907e+01  3.42424907e+01  3.42424907e+01
  1.22657021e+02  1.32163160e+02  1.32163160e+02  1.32163160e+02
  4.87444802e+02  4.87444802e+02  4.87444802e+02  6.64978402e+02
  1.33440178e+03  1.33440178e+03  1.33440178e+03  2.81084686e+03
  3.02128070e+03  3.02128070e+03  3.02128070e+03  6.63650818e+03
  6.63650818e+03  6.63650818e+03  9.23216081e+03  2.55794109e+04
  7.63089435e+04]
E1 = -728.3129785189354  E_coul = 201.5669449282555
Extra cycle  E= -526.74603359068  delta_E= 1.59e-12  |g|= 1.42e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.38 sec
exp = [2.61828395e+04 7.61708985e+03 3.61751316e+03 1.58813630e+03
 4.18255451e+02 1.22564869e+02 3.94741070e+01 8.51335155e+00
 3.36015065e+00 6.76324226e-01 2.50466869e-01 1.36284385e+03
 6.64156813e+02 2.98188215e+02 3.11651558e+02 6.30280987e+01
 7.47676248e+00 2.06961647e+01 7.81431259e-01 2.86036792e+00
 2.23912677e-01]
grad_E = [-1.39822435e-06  2.16619780e-06 -2.13957447e-06  3.71854759e-05
  4.01848680e-06  1.85703542e-05 -1.12508910e-05  1.78435921e-05
  8.71890206e-05  3.03123043e-04 -2.86014365e-04 -5.91576850e-07
  3.99746158e-06  1.81961708e-05  1.55346202e-05  8.63357555e-05
 -3.72308083e-04  7.35900883e-05  4.35676045e-04  3.93799290e-04
 -1.03773769e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8411654        1
[INPUT] 0    0    [1    /1   ]  7617.08702615        1
[INPUT] 0    0    [1    /1   ]  3617.5156269         1
[INPUT] 0    0    [1    /1   ]  1588.08518539        1
[INPUT] 0    0    [1    /1   ]  418.28417358         1
[INPUT] 0    0    [1    /1   ]  122.610178492        1
[INPUT] 0    0    [1    /1   ]  39.4902341576        1
[INPUT] 0    0    [1    /1   ]  8.52359622604        1
[INPUT] 0    0    [1    /1   ]  3.3636455611         1
[INPUT] 0    0    [1    /1   ]  0.677649136105       1
[INPUT] 0    0    [1    /1   ]  0.250921577564       1
[INPUT] 1    0    [1    /1   ]  1362.84454561        1
[INPUT] 1    0    [1    /1   ]  664.151826883        1
[INPUT] 1    0    [1    /1   ]  298.165365225        1
[INPUT] 1    0    [1    /1   ]  311.632021284        1
[INPUT] 1    0    [1    /1   ]  62.9536248584        1
[INPUT] 1    0    [1    /1   ]  7.45778269222        1
[INPUT] 1    0    [1    /1   ]  20.6546057255        1
[INPUT] 1    0    [1    /1   ]  0.78081027058        1
[INPUT] 1    0    [1    /1   ]  2.85439600017        1
[INPUT] 1    0    [1    /1   ]  0.223771578989       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.84116539068, 1.0]], [0, [7617.087026151472, 1.0]], [0, [3617.515626901725, 1.0]], [0, [1588.0851853931006, 1.0]], [0, [418.28417357968027, 1.0]], [0, [122.61017849189292, 1.0]], [0, [39.49023415759565, 1.0]], [0, [8.523596226043912, 1.0]], [0, [3.3636455611013054, 1.0]], [0, [0.677649136104636, 1.0]], [0, [0.25092157756390787, 1.0]], [1, [1362.8445456071656, 1.0]], [1, [664.151826882975, 1.0]], [1, [298.16536522477713, 1.0]], [1, [311.6320212842847, 1.0]], [1, [62.95362485844877, 1.0]], [1, [7.4577826922184665, 1.0]], [1, [20.654605725471036, 1.0]], [1, [0.7808102705797486, 1.0]], [1, [2.8543960001661812, 1.0]], [1, [0.22377157898922884, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.84116539]
bas 1, expnt(s) = [7617.08702615]
bas 2, expnt(s) = [3617.5156269]
bas 3, expnt(s) = [1588.08518539]
bas 4, expnt(s) = [418.28417358]
bas 5, expnt(s) = [122.61017849]
bas 6, expnt(s) = [39.49023416]
bas 7, expnt(s) = [8.52359623]
bas 8, expnt(s) = [3.36364556]
bas 9, expnt(s) = [0.67764914]
bas 10, expnt(s) = [0.25092158]
bas 11, expnt(s) = [1362.84454561]
bas 12, expnt(s) = [664.15182688]
bas 13, expnt(s) = [298.16536522]
bas 14, expnt(s) = [311.63202128]
bas 15, expnt(s) = [62.95362486]
bas 16, expnt(s) = [7.45778269]
bas 17, expnt(s) = [20.65460573]
bas 18, expnt(s) = [0.78081027]
bas 19, expnt(s) = [2.854396]
bas 20, expnt(s) = [0.22377158]
CPU time:       517.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828412e+04 5.20029047e+03 7.61708703e+03 2.05995016e+03
 3.61751563e+03 1.17848168e+03 1.58808519e+03 6.35580216e+02
 4.18284174e+02 2.33678415e+02 1.22610178e+02 9.30914763e+01
 3.94902342e+01 3.97999298e+01 8.52359623e+00 1.26032391e+01
 3.36364556e+00 6.27512952e+00 6.77649136e-01 1.88698606e+00
 2.50921578e-01 8.95712286e-01 1.36284455e+03 2.41569607e+04
 6.64151827e+02 9.83600197e+03 2.98165365e+02 3.61456372e+03
 3.11632021e+02 3.81976802e+03 6.29536249e+01 5.17321252e+02
 7.45778269e+00 3.59539449e+01 2.06546057e+01 1.28456336e+02
 7.80810271e-01 2.14124464e+00 2.85439600e+00 1.08237355e+01
 2.23771579e-01 4.48994013e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99326987028988
cond(S) = 97492.05256586296
E1 = -729.5317680172974  E_coul = 203.18003737828985
init E= -526.351730639008
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555740951495108  LUMO = 1.04172214101982
  mo_energy =
[-1.18331926e+02 -1.22046820e+01 -9.44673735e+00 -9.44673735e+00
 -9.44673735e+00 -1.23993195e+00 -5.55740951e-01 -5.55740951e-01
 -5.55740951e-01  1.04172214e+00  1.04172214e+00  1.04172214e+00
  1.06960438e+00  7.48379684e+00  7.48379684e+00  7.48379684e+00
  1.37063494e+01  3.42664555e+01  3.42664555e+01  3.42664555e+01
  1.22951436e+02  1.32072099e+02  1.32072099e+02  1.32072099e+02
  4.87254742e+02  4.87254742e+02  4.87254742e+02  6.65519368e+02
  1.33418933e+03  1.33418933e+03  1.33418933e+03  2.81159240e+03
  3.02107764e+03  3.02107764e+03  3.02107764e+03  6.63640510e+03
  6.63640510e+03  6.63640510e+03  9.23296694e+03  2.55802471e+04
  7.63098311e+04]
E1 = -727.8710169336423  E_coul = 201.1257432764345
cycle= 1 E= -526.745273657208  delta_E= -0.394  |g|= 0.185  |ddm|= 0.311
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538005
diis-c [-0.28944927  1.        ]
  HOMO = -0.590273222063298  LUMO = 1.017456669012
  mo_energy =
[-1.18636985e+02 -1.23413922e+01 -9.59399516e+00 -9.59399516e+00
 -9.59399516e+00 -1.27906949e+00 -5.90273222e-01 -5.90273222e-01
 -5.90273222e-01  1.01745667e+00  1.01745667e+00  1.01745667e+00
  1.04015432e+00  7.39277506e+00  7.39277506e+00  7.39277506e+00
  1.35928838e+01  3.41124834e+01  3.41124834e+01  3.41124834e+01
  1.22723496e+02  1.31844622e+02  1.31844622e+02  1.31844622e+02
  4.86951469e+02  4.86951469e+02  4.86951469e+02  6.65169015e+02
  1.33383072e+03  1.33383072e+03  1.33383072e+03  2.81109932e+03
  3.02065361e+03  3.02065361e+03  3.02065361e+03  6.63586926e+03
  6.63586926e+03  6.63586926e+03  9.23235772e+03  2.55795443e+04
  7.63090385e+04]
E1 = -728.4390642854281  E_coul = 201.69308543970794
cycle= 2 E= -526.74597884572  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744523
diis-c [-0.00325114  0.08213933  0.91786067]
  HOMO = -0.581254409629461  LUMO = 1.02417447186988
  mo_energy =
[-1.18569964e+02 -1.23037265e+01 -9.55468688e+00 -9.55468688e+00
 -9.55468688e+00 -1.26827576e+00 -5.81254410e-01 -5.81254410e-01
 -5.81254410e-01  1.02417447e+00  1.02417447e+00  1.02417447e+00
  1.04857246e+00  7.41652989e+00  7.41652989e+00  7.41652989e+00
  1.36238590e+01  3.41524502e+01  3.41524502e+01  3.41524502e+01
  1.22780315e+02  1.31900161e+02  1.31900161e+02  1.31900161e+02
  4.87017644e+02  4.87017644e+02  4.87017644e+02  6.65238137e+02
  1.33390090e+03  1.33390090e+03  1.33390090e+03  2.81117288e+03
  3.02072604e+03  3.02072604e+03  3.02072604e+03  6.63594343e+03
  6.63594343e+03  6.63594343e+03  9.23243270e+03  2.55796199e+04
  7.63091144e+04]
E1 = -728.2903769384242  E_coul = 201.5443404007396
cycle= 3 E= -526.746036537685  delta_E= -5.77e-05  |g|= 0.00623  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130507
diis-c [-5.35061436e-07 -1.21903861e-03  1.44796600e-01  8.56422438e-01]
  HOMO = -0.582736527646845  LUMO = 1.0230940530966
  mo_energy =
[-1.18579835e+02 -1.23094809e+01 -9.56078281e+00 -9.56078281e+00
 -9.56078281e+00 -1.26995231e+00 -5.82736528e-01 -5.82736528e-01
 -5.82736528e-01  1.02309405e+00  1.02309405e+00  1.02309405e+00
  1.04728382e+00  7.41275232e+00  7.41275232e+00  7.41275232e+00
  1.36191043e+01  3.41462950e+01  3.41462950e+01  3.41462950e+01
  1.22771886e+02  1.31891860e+02  1.31891860e+02  1.31891860e+02
  4.87007893e+02  4.87007893e+02  4.87007893e+02  6.65227945e+02
  1.33389056e+03  1.33389056e+03  1.33389056e+03  2.81116191e+03
  3.02071532e+03  3.02071532e+03  3.02071532e+03  6.63593233e+03
  6.63593233e+03  6.63593233e+03  9.23242139e+03  2.55796084e+04
  7.63091028e+04]
E1 = -728.3129483020639  E_coul = 201.56690987932637
cycle= 4 E= -526.746038422737  delta_E= -1.89e-06  |g|= 9.33e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108092
diis-c [-3.80252154e-09  6.79291374e-05 -9.84018756e-03 -6.38579598e-02
  1.07363022e+00]
  HOMO = -0.582718370052678  LUMO = 1.02310968369128
  mo_energy =
[-1.18579795e+02 -1.23094179e+01 -9.56073271e+00 -9.56073271e+00
 -9.56073271e+00 -1.26991277e+00 -5.82718370e-01 -5.82718370e-01
 -5.82718370e-01  1.02310968e+00  1.02310968e+00  1.02310968e+00
  1.04731759e+00  7.41279335e+00  7.41279335e+00  7.41279335e+00
  1.36191626e+01  3.41463431e+01  3.41463431e+01  3.41463431e+01
  1.22771935e+02  1.31891907e+02  1.31891907e+02  1.31891907e+02
  4.87007933e+02  4.87007933e+02  4.87007933e+02  6.65227976e+02
  1.33389059e+03  1.33389059e+03  1.33389059e+03  2.81116192e+03
  3.02071534e+03  3.02071534e+03  3.02071534e+03  6.63593233e+03
  6.63593233e+03  6.63593233e+03  9.23242139e+03  2.55796083e+04
  7.63091028e+04]
E1 = -728.3127430024128  E_coul = 201.56670457817793
cycle= 5 E= -526.746038424235  delta_E= -1.5e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.78097e-05
diis-c [-6.63382441e-11  1.39808875e-05 -1.83967968e-03 -1.37452358e-02
  4.28490703e-02  9.72721864e-01]
  HOMO = -0.582725471172706  LUMO = 1.02310492584617
  mo_energy =
[-1.18579825e+02 -1.23094395e+01 -9.56075623e+00 -9.56075623e+00
 -9.56075623e+00 -1.26991845e+00 -5.82725471e-01 -5.82725471e-01
 -5.82725471e-01  1.02310493e+00  1.02310493e+00  1.02310493e+00
  1.04731363e+00  7.41277730e+00  7.41277730e+00  7.41277730e+00
  1.36191446e+01  3.41463202e+01  3.41463202e+01  3.41463202e+01
  1.22771908e+02  1.31891880e+02  1.31891880e+02  1.31891880e+02
  4.87007903e+02  4.87007903e+02  4.87007903e+02  6.65227946e+02
  1.33389056e+03  1.33389056e+03  1.33389056e+03  2.81116189e+03
  3.02071531e+03  3.02071531e+03  3.02071531e+03  6.63593230e+03
  6.63593230e+03  6.63593230e+03  9.23242135e+03  2.55796083e+04
  7.63091027e+04]
E1 = -728.3128216012075  E_coul = 201.5667831769197
cycle= 6 E= -526.746038424288  delta_E= -5.29e-11  |g|= 1.67e-06  |ddm|= 1.74e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3128216012075  E_coul = 201.5667831769197
  HOMO = -0.582725498044366  LUMO = 1.02310496038519
  mo_energy =
[-1.18579825e+02 -1.23094394e+01 -9.56075621e+00 -9.56075621e+00
 -9.56075621e+00 -1.26991811e+00 -5.82725498e-01 -5.82725498e-01
 -5.82725498e-01  1.02310496e+00  1.02310496e+00  1.02310496e+00
  1.04731395e+00  7.41277732e+00  7.41277732e+00  7.41277732e+00
  1.36191447e+01  3.41463202e+01  3.41463202e+01  3.41463202e+01
  1.22771908e+02  1.31891880e+02  1.31891880e+02  1.31891880e+02
  4.87007904e+02  4.87007904e+02  4.87007904e+02  6.65227946e+02
  1.33389056e+03  1.33389056e+03  1.33389056e+03  2.81116189e+03
  3.02071531e+03  3.02071531e+03  3.02071531e+03  6.63593230e+03
  6.63593230e+03  6.63593230e+03  9.23242135e+03  2.55796083e+04
  7.63091027e+04]
E1 = -728.3128208467417  E_coul = 201.56678242245277
Extra cycle  E= -526.746038424289  delta_E= -1.14e-12  |g|= 3.42e-07  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828412e+04 7.61708703e+03 3.61751563e+03 1.58808519e+03
 4.18284174e+02 1.22610178e+02 3.94902342e+01 8.52359623e+00
 3.36364556e+00 6.77649136e-01 2.50921578e-01 1.36284455e+03
 6.64151827e+02 2.98165365e+02 3.11632021e+02 6.29536249e+01
 7.45778269e+00 2.06546057e+01 7.80810271e-01 2.85439600e+00
 2.23771579e-01]
E = -526.7460384242889
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8411654        1
[INPUT] 0    0    [1    /1   ]  7617.08702615        1
[INPUT] 0    0    [1    /1   ]  3617.5156269         1
[INPUT] 0    0    [1    /1   ]  1588.08518539        1
[INPUT] 0    0    [1    /1   ]  418.28417358         1
[INPUT] 0    0    [1    /1   ]  122.610178492        1
[INPUT] 0    0    [1    /1   ]  39.4902341576        1
[INPUT] 0    0    [1    /1   ]  8.52359622604        1
[INPUT] 0    0    [1    /1   ]  3.3636455611         1
[INPUT] 0    0    [1    /1   ]  0.677649136105       1
[INPUT] 0    0    [1    /1   ]  0.250921577564       1
[INPUT] 1    0    [1    /1   ]  1362.84454561        1
[INPUT] 1    0    [1    /1   ]  664.151826883        1
[INPUT] 1    0    [1    /1   ]  298.165365225        1
[INPUT] 1    0    [1    /1   ]  311.632021284        1
[INPUT] 1    0    [1    /1   ]  62.9536248584        1
[INPUT] 1    0    [1    /1   ]  7.45778269222        1
[INPUT] 1    0    [1    /1   ]  20.6546057255        1
[INPUT] 1    0    [1    /1   ]  0.78081027058        1
[INPUT] 1    0    [1    /1   ]  2.85439600017        1
[INPUT] 1    0    [1    /1   ]  0.223771578989       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.84116539068, 1.0]], [0, [7617.087026151472, 1.0]], [0, [3617.515626901725, 1.0]], [0, [1588.0851853931006, 1.0]], [0, [418.28417357968027, 1.0]], [0, [122.61017849189292, 1.0]], [0, [39.49023415759565, 1.0]], [0, [8.523596226043912, 1.0]], [0, [3.3636455611013054, 1.0]], [0, [0.677649136104636, 1.0]], [0, [0.25092157756390787, 1.0]], [1, [1362.8445456071656, 1.0]], [1, [664.151826882975, 1.0]], [1, [298.16536522477713, 1.0]], [1, [311.6320212842847, 1.0]], [1, [62.95362485844877, 1.0]], [1, [7.4577826922184665, 1.0]], [1, [20.654605725471036, 1.0]], [1, [0.7808102705797486, 1.0]], [1, [2.8543960001661812, 1.0]], [1, [0.22377157898922884, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.84116539]
bas 1, expnt(s) = [7617.08702615]
bas 2, expnt(s) = [3617.5156269]
bas 3, expnt(s) = [1588.08518539]
bas 4, expnt(s) = [418.28417358]
bas 5, expnt(s) = [122.61017849]
bas 6, expnt(s) = [39.49023416]
bas 7, expnt(s) = [8.52359623]
bas 8, expnt(s) = [3.36364556]
bas 9, expnt(s) = [0.67764914]
bas 10, expnt(s) = [0.25092158]
bas 11, expnt(s) = [1362.84454561]
bas 12, expnt(s) = [664.15182688]
bas 13, expnt(s) = [298.16536522]
bas 14, expnt(s) = [311.63202128]
bas 15, expnt(s) = [62.95362486]
bas 16, expnt(s) = [7.45778269]
bas 17, expnt(s) = [20.65460573]
bas 18, expnt(s) = [0.78081027]
bas 19, expnt(s) = [2.854396]
bas 20, expnt(s) = [0.22377158]
CPU time:       518.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828412e+04 5.20029047e+03 7.61708703e+03 2.05995016e+03
 3.61751563e+03 1.17848168e+03 1.58808519e+03 6.35580216e+02
 4.18284174e+02 2.33678415e+02 1.22610178e+02 9.30914763e+01
 3.94902342e+01 3.97999298e+01 8.52359623e+00 1.26032391e+01
 3.36364556e+00 6.27512952e+00 6.77649136e-01 1.88698606e+00
 2.50921578e-01 8.95712286e-01 1.36284455e+03 2.41569607e+04
 6.64151827e+02 9.83600197e+03 2.98165365e+02 3.61456372e+03
 3.11632021e+02 3.81976802e+03 6.29536249e+01 5.17321252e+02
 7.45778269e+00 3.59539449e+01 2.06546057e+01 1.28456336e+02
 7.80810271e-01 2.14124464e+00 2.85439600e+00 1.08237355e+01
 2.23771579e-01 4.48994013e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99326987028988
cond(S) = 97492.05256586296
E1 = -729.5317680172974  E_coul = 203.18003737828985
init E= -526.351730639008
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555740951495108  LUMO = 1.04172214101982
  mo_energy =
[-1.18331926e+02 -1.22046820e+01 -9.44673735e+00 -9.44673735e+00
 -9.44673735e+00 -1.23993195e+00 -5.55740951e-01 -5.55740951e-01
 -5.55740951e-01  1.04172214e+00  1.04172214e+00  1.04172214e+00
  1.06960438e+00  7.48379684e+00  7.48379684e+00  7.48379684e+00
  1.37063494e+01  3.42664555e+01  3.42664555e+01  3.42664555e+01
  1.22951436e+02  1.32072099e+02  1.32072099e+02  1.32072099e+02
  4.87254742e+02  4.87254742e+02  4.87254742e+02  6.65519368e+02
  1.33418933e+03  1.33418933e+03  1.33418933e+03  2.81159240e+03
  3.02107764e+03  3.02107764e+03  3.02107764e+03  6.63640510e+03
  6.63640510e+03  6.63640510e+03  9.23296694e+03  2.55802471e+04
  7.63098311e+04]
E1 = -727.8710169336423  E_coul = 201.1257432764345
cycle= 1 E= -526.745273657208  delta_E= -0.394  |g|= 0.185  |ddm|= 0.311
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538005
diis-c [-0.28944927  1.        ]
  HOMO = -0.590273222063298  LUMO = 1.017456669012
  mo_energy =
[-1.18636985e+02 -1.23413922e+01 -9.59399516e+00 -9.59399516e+00
 -9.59399516e+00 -1.27906949e+00 -5.90273222e-01 -5.90273222e-01
 -5.90273222e-01  1.01745667e+00  1.01745667e+00  1.01745667e+00
  1.04015432e+00  7.39277506e+00  7.39277506e+00  7.39277506e+00
  1.35928838e+01  3.41124834e+01  3.41124834e+01  3.41124834e+01
  1.22723496e+02  1.31844622e+02  1.31844622e+02  1.31844622e+02
  4.86951469e+02  4.86951469e+02  4.86951469e+02  6.65169015e+02
  1.33383072e+03  1.33383072e+03  1.33383072e+03  2.81109932e+03
  3.02065361e+03  3.02065361e+03  3.02065361e+03  6.63586926e+03
  6.63586926e+03  6.63586926e+03  9.23235772e+03  2.55795443e+04
  7.63090385e+04]
E1 = -728.4390642854281  E_coul = 201.69308543970794
cycle= 2 E= -526.74597884572  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744523
diis-c [-0.00325114  0.08213933  0.91786067]
  HOMO = -0.581254409629461  LUMO = 1.02417447186988
  mo_energy =
[-1.18569964e+02 -1.23037265e+01 -9.55468688e+00 -9.55468688e+00
 -9.55468688e+00 -1.26827576e+00 -5.81254410e-01 -5.81254410e-01
 -5.81254410e-01  1.02417447e+00  1.02417447e+00  1.02417447e+00
  1.04857246e+00  7.41652989e+00  7.41652989e+00  7.41652989e+00
  1.36238590e+01  3.41524502e+01  3.41524502e+01  3.41524502e+01
  1.22780315e+02  1.31900161e+02  1.31900161e+02  1.31900161e+02
  4.87017644e+02  4.87017644e+02  4.87017644e+02  6.65238137e+02
  1.33390090e+03  1.33390090e+03  1.33390090e+03  2.81117288e+03
  3.02072604e+03  3.02072604e+03  3.02072604e+03  6.63594343e+03
  6.63594343e+03  6.63594343e+03  9.23243270e+03  2.55796199e+04
  7.63091144e+04]
E1 = -728.2903769384242  E_coul = 201.5443404007396
cycle= 3 E= -526.746036537685  delta_E= -5.77e-05  |g|= 0.00623  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130507
diis-c [-5.35061436e-07 -1.21903861e-03  1.44796600e-01  8.56422438e-01]
  HOMO = -0.582736527646845  LUMO = 1.0230940530966
  mo_energy =
[-1.18579835e+02 -1.23094809e+01 -9.56078281e+00 -9.56078281e+00
 -9.56078281e+00 -1.26995231e+00 -5.82736528e-01 -5.82736528e-01
 -5.82736528e-01  1.02309405e+00  1.02309405e+00  1.02309405e+00
  1.04728382e+00  7.41275232e+00  7.41275232e+00  7.41275232e+00
  1.36191043e+01  3.41462950e+01  3.41462950e+01  3.41462950e+01
  1.22771886e+02  1.31891860e+02  1.31891860e+02  1.31891860e+02
  4.87007893e+02  4.87007893e+02  4.87007893e+02  6.65227945e+02
  1.33389056e+03  1.33389056e+03  1.33389056e+03  2.81116191e+03
  3.02071532e+03  3.02071532e+03  3.02071532e+03  6.63593233e+03
  6.63593233e+03  6.63593233e+03  9.23242139e+03  2.55796084e+04
  7.63091028e+04]
E1 = -728.3129483020639  E_coul = 201.56690987932637
cycle= 4 E= -526.746038422737  delta_E= -1.89e-06  |g|= 9.33e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000108092
diis-c [-3.80252154e-09  6.79291374e-05 -9.84018756e-03 -6.38579598e-02
  1.07363022e+00]
  HOMO = -0.582718370052678  LUMO = 1.02310968369128
  mo_energy =
[-1.18579795e+02 -1.23094179e+01 -9.56073271e+00 -9.56073271e+00
 -9.56073271e+00 -1.26991277e+00 -5.82718370e-01 -5.82718370e-01
 -5.82718370e-01  1.02310968e+00  1.02310968e+00  1.02310968e+00
  1.04731759e+00  7.41279335e+00  7.41279335e+00  7.41279335e+00
  1.36191626e+01  3.41463431e+01  3.41463431e+01  3.41463431e+01
  1.22771935e+02  1.31891907e+02  1.31891907e+02  1.31891907e+02
  4.87007933e+02  4.87007933e+02  4.87007933e+02  6.65227976e+02
  1.33389059e+03  1.33389059e+03  1.33389059e+03  2.81116192e+03
  3.02071534e+03  3.02071534e+03  3.02071534e+03  6.63593233e+03
  6.63593233e+03  6.63593233e+03  9.23242139e+03  2.55796083e+04
  7.63091028e+04]
E1 = -728.3127430024128  E_coul = 201.56670457817793
cycle= 5 E= -526.746038424235  delta_E= -1.5e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.78097e-05
diis-c [-6.63382441e-11  1.39808875e-05 -1.83967968e-03 -1.37452358e-02
  4.28490703e-02  9.72721864e-01]
  HOMO = -0.582725471172706  LUMO = 1.02310492584617
  mo_energy =
[-1.18579825e+02 -1.23094395e+01 -9.56075623e+00 -9.56075623e+00
 -9.56075623e+00 -1.26991845e+00 -5.82725471e-01 -5.82725471e-01
 -5.82725471e-01  1.02310493e+00  1.02310493e+00  1.02310493e+00
  1.04731363e+00  7.41277730e+00  7.41277730e+00  7.41277730e+00
  1.36191446e+01  3.41463202e+01  3.41463202e+01  3.41463202e+01
  1.22771908e+02  1.31891880e+02  1.31891880e+02  1.31891880e+02
  4.87007903e+02  4.87007903e+02  4.87007903e+02  6.65227946e+02
  1.33389056e+03  1.33389056e+03  1.33389056e+03  2.81116189e+03
  3.02071531e+03  3.02071531e+03  3.02071531e+03  6.63593230e+03
  6.63593230e+03  6.63593230e+03  9.23242135e+03  2.55796083e+04
  7.63091027e+04]
E1 = -728.3128216012075  E_coul = 201.5667831769197
cycle= 6 E= -526.746038424288  delta_E= -5.29e-11  |g|= 1.67e-06  |ddm|= 1.74e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3128216012075  E_coul = 201.5667831769197
  HOMO = -0.582725498044366  LUMO = 1.02310496038519
  mo_energy =
[-1.18579825e+02 -1.23094394e+01 -9.56075621e+00 -9.56075621e+00
 -9.56075621e+00 -1.26991811e+00 -5.82725498e-01 -5.82725498e-01
 -5.82725498e-01  1.02310496e+00  1.02310496e+00  1.02310496e+00
  1.04731395e+00  7.41277732e+00  7.41277732e+00  7.41277732e+00
  1.36191447e+01  3.41463202e+01  3.41463202e+01  3.41463202e+01
  1.22771908e+02  1.31891880e+02  1.31891880e+02  1.31891880e+02
  4.87007904e+02  4.87007904e+02  4.87007904e+02  6.65227946e+02
  1.33389056e+03  1.33389056e+03  1.33389056e+03  2.81116189e+03
  3.02071531e+03  3.02071531e+03  3.02071531e+03  6.63593230e+03
  6.63593230e+03  6.63593230e+03  9.23242135e+03  2.55796083e+04
  7.63091027e+04]
E1 = -728.3128208467417  E_coul = 201.56678242245277
Extra cycle  E= -526.746038424289  delta_E= -1.14e-12  |g|= 3.42e-07  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 97492.05256586296
E1 = -728.3128208467417  E_coul = 201.56678242245277
init E= -526.746038424289
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582725523066911  LUMO = 1.02310495362959
  mo_energy =
[-1.18579825e+02 -1.23094395e+01 -9.56075629e+00 -9.56075629e+00
 -9.56075629e+00 -1.26991806e+00 -5.82725523e-01 -5.82725523e-01
 -5.82725523e-01  1.02310495e+00  1.02310495e+00  1.02310495e+00
  1.04731400e+00  7.41277728e+00  7.41277728e+00  7.41277728e+00
  1.36191447e+01  3.41463201e+01  3.41463201e+01  3.41463201e+01
  1.22771908e+02  1.31891880e+02  1.31891880e+02  1.31891880e+02
  4.87007904e+02  4.87007904e+02  4.87007904e+02  6.65227946e+02
  1.33389056e+03  1.33389056e+03  1.33389056e+03  2.81116189e+03
  3.02071531e+03  3.02071531e+03  3.02071531e+03  6.63593230e+03
  6.63593230e+03  6.63593230e+03  9.23242135e+03  2.55796083e+04
  7.63091027e+04]
E1 = -728.3128209611369  E_coul = 201.56678253684902
cycle= 1 E= -526.746038424288  delta_E= 1.02e-12  |g|= 7.07e-08  |ddm|= 5.64e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3128209611369  E_coul = 201.56678253684902
  HOMO = -0.582725523131854  LUMO = 1.0231049559095
  mo_energy =
[-1.18579825e+02 -1.23094395e+01 -9.56075628e+00 -9.56075628e+00
 -9.56075628e+00 -1.26991804e+00 -5.82725523e-01 -5.82725523e-01
 -5.82725523e-01  1.02310496e+00  1.02310496e+00  1.02310496e+00
  1.04731402e+00  7.41277728e+00  7.41277728e+00  7.41277728e+00
  1.36191447e+01  3.41463202e+01  3.41463202e+01  3.41463202e+01
  1.22771908e+02  1.31891880e+02  1.31891880e+02  1.31891880e+02
  4.87007904e+02  4.87007904e+02  4.87007904e+02  6.65227946e+02
  1.33389056e+03  1.33389056e+03  1.33389056e+03  2.81116189e+03
  3.02071531e+03  3.02071531e+03  3.02071531e+03  6.63593230e+03
  6.63593230e+03  6.63593230e+03  9.23242135e+03  2.55796083e+04
  7.63091027e+04]
E1 = -728.3128209089795  E_coul = 201.56678248468907
Extra cycle  E= -526.74603842429  delta_E= -2.5e-12  |g|= 1.42e-08  |ddm|= 1.17e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828412e+04 7.61708703e+03 3.61751563e+03 1.58808519e+03
 4.18284174e+02 1.22610178e+02 3.94902342e+01 8.52359623e+00
 3.36364556e+00 6.77649136e-01 2.50921578e-01 1.36284455e+03
 6.64151827e+02 2.98165365e+02 3.11632021e+02 6.29536249e+01
 7.45778269e+00 2.06546057e+01 7.80810271e-01 2.85439600e+00
 2.23771579e-01]
grad_E = [-1.39847648e-06  2.16825157e-06 -2.14084321e-06  3.72763454e-05
  1.52510270e-06  2.93556575e-05 -1.87915035e-05  3.04142791e-05
  1.39451698e-04  4.92798000e-04 -4.67941042e-04 -5.90082540e-07
  4.02077044e-06  1.83188894e-05  1.56407156e-05  8.83498482e-05
 -6.16745601e-04  1.06132615e-04  7.07267220e-04  6.37574806e-04
 -1.68993608e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8453039        1
[INPUT] 0    0    [1    /1   ]  7617.08020986        1
[INPUT] 0    0    [1    /1   ]  3617.52162358        1
[INPUT] 0    0    [1    /1   ]  1587.96214036        1
[INPUT] 0    0    [1    /1   ]  418.354052737        1
[INPUT] 0    0    [1    /1   ]  122.682539653        1
[INPUT] 0    0    [1    /1   ]  39.5147798653        1
[INPUT] 0    0    [1    /1   ]  8.53833996997        1
[INPUT] 0    0    [1    /1   ]  3.36866628023        1
[INPUT] 0    0    [1    /1   ]  0.679548213439       1
[INPUT] 0    0    [1    /1   ]  0.251572098686       1
[INPUT] 1    0    [1    /1   ]  1362.84624675        1
[INPUT] 1    0    [1    /1   ]  664.139768397        1
[INPUT] 1    0    [1    /1   ]  298.1101427          1
[INPUT] 1    0    [1    /1   ]  311.584812457        1
[INPUT] 1    0    [1    /1   ]  62.763214802         1
[INPUT] 1    0    [1    /1   ]  7.42275287691        1
[INPUT] 1    0    [1    /1   ]  20.5691346364        1
[INPUT] 1    0    [1    /1   ]  0.779618910179       1
[INPUT] 1    0    [1    /1   ]  2.8433753186         1
[INPUT] 1    0    [1    /1   ]  0.223507616311       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.84530390423, 1.0]], [0, [7617.080209862614, 1.0]], [0, [3617.5216235760513, 1.0]], [0, [1587.962140357188, 1.0]], [0, [418.35405273746375, 1.0]], [0, [122.68253965259663, 1.0]], [0, [39.51477986532633, 1.0]], [0, [8.53833996996995, 1.0]], [0, [3.3686662802347853, 1.0]], [0, [0.679548213439432, 1.0]], [0, [0.25157209868624236, 1.0]], [1, [1362.8462467467195, 1.0]], [1, [664.139768397432, 1.0]], [1, [298.1101426999966, 1.0]], [1, [311.5848124565609, 1.0]], [1, [62.7632148019542, 1.0]], [1, [7.422752876912538, 1.0]], [1, [20.56913463644216, 1.0]], [1, [0.7796189101789636, 1.0]], [1, [2.843375318600836, 1.0]], [1, [0.22350761631089813, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8453039]
bas 1, expnt(s) = [7617.08020986]
bas 2, expnt(s) = [3617.52162358]
bas 3, expnt(s) = [1587.96214036]
bas 4, expnt(s) = [418.35405274]
bas 5, expnt(s) = [122.68253965]
bas 6, expnt(s) = [39.51477987]
bas 7, expnt(s) = [8.53833997]
bas 8, expnt(s) = [3.36866628]
bas 9, expnt(s) = [0.67954821]
bas 10, expnt(s) = [0.2515721]
bas 11, expnt(s) = [1362.84624675]
bas 12, expnt(s) = [664.1397684]
bas 13, expnt(s) = [298.1101427]
bas 14, expnt(s) = [311.58481246]
bas 15, expnt(s) = [62.7632148]
bas 16, expnt(s) = [7.42275288]
bas 17, expnt(s) = [20.56913464]
bas 18, expnt(s) = [0.77961891]
bas 19, expnt(s) = [2.84337532]
bas 20, expnt(s) = [0.22350762]
CPU time:       524.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828453e+04 5.20029109e+03 7.61708021e+03 2.05994878e+03
 3.61752162e+03 1.17848315e+03 1.58796214e+03 6.35543282e+02
 4.18354053e+02 2.33707694e+02 1.22682540e+02 9.31326783e+01
 3.95147799e+01 3.98184820e+01 8.53833997e+00 1.26195860e+01
 3.36866628e+00 6.28215310e+00 6.79548213e-01 1.89095081e+00
 2.51572099e-01 8.97453341e-01 1.36284625e+03 2.41569984e+04
 6.64139768e+02 9.83577874e+03 2.98110143e+02 3.61372694e+03
 3.11584812e+02 3.81904472e+03 6.27632148e+01 5.15366124e+02
 7.42275288e+00 3.57429707e+01 2.05691346e+01 1.27792221e+02
 7.79618910e-01 2.13716153e+00 2.84337532e+00 1.07715234e+01
 2.23507616e-01 4.48332065e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99330458740973
cond(S) = 96996.91182209077
E1 = -729.5320032790518  E_coul = 203.18017486458868
init E= -526.351828414463
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555755194698264  LUMO = 1.03962263095934
  mo_energy =
[-1.18331942e+02 -1.22046587e+01 -9.44671121e+00 -9.44671121e+00
 -9.44671121e+00 -1.23991271e+00 -5.55755195e-01 -5.55755195e-01
 -5.55755195e-01  1.03962263e+00  1.03962263e+00  1.03962263e+00
  1.07466025e+00  7.44946822e+00  7.44946822e+00  7.44946822e+00
  1.37502251e+01  3.40829896e+01  3.40829896e+01  3.40829896e+01
  1.23122487e+02  1.31497412e+02  1.31497412e+02  1.31497412e+02
  4.86262296e+02  4.86262296e+02  4.86262296e+02  6.65919802e+02
  1.33300428e+03  1.33300428e+03  1.33300428e+03  2.81211915e+03
  3.01975560e+03  3.01975560e+03  3.01975560e+03  6.63505288e+03
  6.63505288e+03  6.63505288e+03  9.23336877e+03  2.55805062e+04
  7.63100120e+04]
E1 = -727.8702911264506  E_coul = 201.12500662166173
cycle= 1 E= -526.745284504789  delta_E= -0.393  |g|= 0.185  |ddm|= 0.31
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537956
diis-c [-0.28939636  1.        ]
  HOMO = -0.590334479230166  LUMO = 1.01537906419353
  mo_energy =
[-1.18637054e+02 -1.23414188e+01 -9.59401287e+00 -9.59401287e+00
 -9.59401287e+00 -1.27911085e+00 -5.90334479e-01 -5.90334479e-01
 -5.90334479e-01  1.01537906e+00  1.01537906e+00  1.01537906e+00
  1.04504243e+00  7.35863962e+00  7.35863962e+00  7.35863962e+00
  1.36365794e+01  3.39292470e+01  3.39292470e+01  3.39292470e+01
  1.22894424e+02  1.31270062e+02  1.31270062e+02  1.31270062e+02
  4.85958971e+02  4.85958971e+02  4.85958971e+02  6.65569368e+02
  1.33264560e+03  1.33264560e+03  1.33264560e+03  2.81162602e+03
  3.01933151e+03  3.01933151e+03  3.01933151e+03  6.63451699e+03
  6.63451699e+03  6.63451699e+03  9.23275952e+03  2.55798033e+04
  7.63092194e+04]
E1 = -728.4388070312314  E_coul = 201.6928167327386
cycle= 2 E= -526.745990298493  delta_E= -0.000706  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.0744798
diis-c [-0.00325431  0.0821619   0.9178381 ]
  HOMO = -0.581306680236816  LUMO = 1.02208789034023
  mo_energy =
[-1.18569993e+02 -1.23037216e+01 -9.55467186e+00 -9.55467186e+00
 -9.55467186e+00 -1.26830621e+00 -5.81306680e-01 -5.81306680e-01
 -5.81306680e-01  1.02208789e+00  1.02208789e+00  1.02208789e+00
  1.05349902e+00  7.38235043e+00  7.38235043e+00  7.38235043e+00
  1.36676122e+01  3.39691785e+01  3.39691785e+01  3.39691785e+01
  1.22951290e+02  1.31325605e+02  1.31325605e+02  1.31325605e+02
  4.86025185e+02  4.86025185e+02  4.86025185e+02  6.65638533e+02
  1.33271582e+03  1.33271582e+03  1.33271582e+03  2.81169963e+03
  3.01940398e+03  3.01940398e+03  3.01940398e+03  6.63459121e+03
  6.63459121e+03  6.63459121e+03  9.23283455e+03  2.55798789e+04
  7.63092953e+04]
E1 = -728.2899230159444  E_coul = 201.54387490909946
cycle= 3 E= -526.746048106845  delta_E= -5.78e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130611
diis-c [-5.34900355e-07 -1.21884608e-03  1.44855254e-01  8.56363592e-01]
  HOMO = -0.582791217111273  LUMO = 1.02100817277277
  mo_energy =
[-1.18579874e+02 -1.23094840e+01 -9.56077593e+00 -9.56077593e+00
 -9.56077593e+00 -1.26998594e+00 -5.82791217e-01 -5.82791217e-01
 -5.82791217e-01  1.02100817e+00  1.02100817e+00  1.02100817e+00
  1.05220319e+00  7.37857730e+00  7.37857730e+00  7.37857730e+00
  1.36628459e+01  3.39630247e+01  3.39630247e+01  3.39630247e+01
  1.22942849e+02  1.31317299e+02  1.31317299e+02  1.31317299e+02
  4.86015423e+02  4.86015423e+02  4.86015423e+02  6.65628330e+02
  1.33270547e+03  1.33270547e+03  1.33270547e+03  2.81168865e+03
  3.01939325e+03  3.01939325e+03  3.01939325e+03  6.63458009e+03
  6.63458009e+03  6.63458009e+03  9.23282323e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3125384914716  E_coul = 201.56648849338092
cycle= 4 E= -526.746049998091  delta_E= -1.89e-06  |g|= 9.31e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107546
diis-c [-3.81126793e-09  6.73938729e-05 -9.77490938e-03 -6.33868043e-02
  1.07309432e+00]
  HOMO = -0.582772906970526  LUMO = 1.021023875236
  mo_energy =
[-1.18579835e+02 -1.23094206e+01 -9.56072537e+00 -9.56072537e+00
 -9.56072537e+00 -1.26994629e+00 -5.82772907e-01 -5.82772907e-01
 -5.82772907e-01  1.02102388e+00  1.02102388e+00  1.02102388e+00
  1.05223712e+00  7.37861860e+00  7.37861860e+00  7.37861860e+00
  1.36629045e+01  3.39630733e+01  3.39630733e+01  3.39630733e+01
  1.22942899e+02  1.31317346e+02  1.31317346e+02  1.31317346e+02
  4.86015463e+02  4.86015463e+02  4.86015463e+02  6.65628361e+02
  1.33270550e+03  1.33270550e+03  1.33270550e+03  2.81168866e+03
  3.01939327e+03  3.01939327e+03  3.01939327e+03  6.63458010e+03
  6.63458010e+03  6.63458010e+03  9.23282323e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3123319428149  E_coul = 201.5662819432396
cycle= 5 E= -526.746049999575  delta_E= -1.48e-09  |g|= 1.99e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.78697e-05
diis-c [-6.59645233e-11  1.39801180e-05 -1.84088095e-03 -1.37478156e-02
  4.29081181e-02  9.72666598e-01]
  HOMO = -0.582780005016378  LUMO = 1.02101913033578
  mo_energy =
[-1.18579864e+02 -1.23094422e+01 -9.56074890e+00 -9.56074890e+00
 -9.56074890e+00 -1.26995198e+00 -5.82780005e-01 -5.82780005e-01
 -5.82780005e-01  1.02101913e+00  1.02101913e+00  1.02101913e+00
  1.05223315e+00  7.37860258e+00  7.37860258e+00  7.37860258e+00
  1.36628865e+01  3.39630504e+01  3.39630504e+01  3.39630504e+01
  1.22942873e+02  1.31317319e+02  1.31317319e+02  1.31317319e+02
  4.86015434e+02  4.86015434e+02  4.86015434e+02  6.65628331e+02
  1.33270547e+03  1.33270547e+03  1.33270547e+03  2.81168863e+03
  3.01939324e+03  3.01939324e+03  3.01939324e+03  6.63458006e+03
  6.63458006e+03  6.63458006e+03  9.23282320e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3124107034114  E_coul = 201.56636070378326
cycle= 6 E= -526.746049999628  delta_E= -5.28e-11  |g|= 1.67e-06  |ddm|= 1.74e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3124107034114  E_coul = 201.56636070378326
  HOMO = -0.582780033271266  LUMO = 1.02101916383846
  mo_energy =
[-1.18579864e+02 -1.23094421e+01 -9.56074889e+00 -9.56074889e+00
 -9.56074889e+00 -1.26995164e+00 -5.82780033e-01 -5.82780033e-01
 -5.82780033e-01  1.02101916e+00  1.02101916e+00  1.02101916e+00
  1.05223347e+00  7.37860260e+00  7.37860260e+00  7.37860260e+00
  1.36628866e+01  3.39630504e+01  3.39630504e+01  3.39630504e+01
  1.22942873e+02  1.31317319e+02  1.31317319e+02  1.31317319e+02
  4.86015434e+02  4.86015434e+02  4.86015434e+02  6.65628331e+02
  1.33270547e+03  1.33270547e+03  1.33270547e+03  2.81168863e+03
  3.01939324e+03  3.01939324e+03  3.01939324e+03  6.63458006e+03
  6.63458006e+03  6.63458006e+03  9.23282320e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3124099925071  E_coul = 201.56635999287812
Extra cycle  E= -526.746049999629  delta_E= -9.09e-13  |g|= 3.41e-07  |ddm|= 2.87e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828453e+04 7.61708021e+03 3.61752162e+03 1.58796214e+03
 4.18354053e+02 1.22682540e+02 3.95147799e+01 8.53833997e+00
 3.36866628e+00 6.79548213e-01 2.51572099e-01 1.36284625e+03
 6.64139768e+02 2.98110143e+02 3.11584812e+02 6.27632148e+01
 7.42275288e+00 2.05691346e+01 7.79618910e-01 2.84337532e+00
 2.23507616e-01]
E = -526.746049999629
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8453039        1
[INPUT] 0    0    [1    /1   ]  7617.08020986        1
[INPUT] 0    0    [1    /1   ]  3617.52162358        1
[INPUT] 0    0    [1    /1   ]  1587.96214036        1
[INPUT] 0    0    [1    /1   ]  418.354052737        1
[INPUT] 0    0    [1    /1   ]  122.682539653        1
[INPUT] 0    0    [1    /1   ]  39.5147798653        1
[INPUT] 0    0    [1    /1   ]  8.53833996997        1
[INPUT] 0    0    [1    /1   ]  3.36866628023        1
[INPUT] 0    0    [1    /1   ]  0.679548213439       1
[INPUT] 0    0    [1    /1   ]  0.251572098686       1
[INPUT] 1    0    [1    /1   ]  1362.84624675        1
[INPUT] 1    0    [1    /1   ]  664.139768397        1
[INPUT] 1    0    [1    /1   ]  298.1101427          1
[INPUT] 1    0    [1    /1   ]  311.584812457        1
[INPUT] 1    0    [1    /1   ]  62.763214802         1
[INPUT] 1    0    [1    /1   ]  7.42275287691        1
[INPUT] 1    0    [1    /1   ]  20.5691346364        1
[INPUT] 1    0    [1    /1   ]  0.779618910179       1
[INPUT] 1    0    [1    /1   ]  2.8433753186         1
[INPUT] 1    0    [1    /1   ]  0.223507616311       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.84530390423, 1.0]], [0, [7617.080209862614, 1.0]], [0, [3617.5216235760513, 1.0]], [0, [1587.962140357188, 1.0]], [0, [418.35405273746375, 1.0]], [0, [122.68253965259663, 1.0]], [0, [39.51477986532633, 1.0]], [0, [8.53833996996995, 1.0]], [0, [3.3686662802347853, 1.0]], [0, [0.679548213439432, 1.0]], [0, [0.25157209868624236, 1.0]], [1, [1362.8462467467195, 1.0]], [1, [664.139768397432, 1.0]], [1, [298.1101426999966, 1.0]], [1, [311.5848124565609, 1.0]], [1, [62.7632148019542, 1.0]], [1, [7.422752876912538, 1.0]], [1, [20.56913463644216, 1.0]], [1, [0.7796189101789636, 1.0]], [1, [2.843375318600836, 1.0]], [1, [0.22350761631089813, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8453039]
bas 1, expnt(s) = [7617.08020986]
bas 2, expnt(s) = [3617.52162358]
bas 3, expnt(s) = [1587.96214036]
bas 4, expnt(s) = [418.35405274]
bas 5, expnt(s) = [122.68253965]
bas 6, expnt(s) = [39.51477987]
bas 7, expnt(s) = [8.53833997]
bas 8, expnt(s) = [3.36866628]
bas 9, expnt(s) = [0.67954821]
bas 10, expnt(s) = [0.2515721]
bas 11, expnt(s) = [1362.84624675]
bas 12, expnt(s) = [664.1397684]
bas 13, expnt(s) = [298.1101427]
bas 14, expnt(s) = [311.58481246]
bas 15, expnt(s) = [62.7632148]
bas 16, expnt(s) = [7.42275288]
bas 17, expnt(s) = [20.56913464]
bas 18, expnt(s) = [0.77961891]
bas 19, expnt(s) = [2.84337532]
bas 20, expnt(s) = [0.22350762]
CPU time:       524.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828453e+04 5.20029109e+03 7.61708021e+03 2.05994878e+03
 3.61752162e+03 1.17848315e+03 1.58796214e+03 6.35543282e+02
 4.18354053e+02 2.33707694e+02 1.22682540e+02 9.31326783e+01
 3.95147799e+01 3.98184820e+01 8.53833997e+00 1.26195860e+01
 3.36866628e+00 6.28215310e+00 6.79548213e-01 1.89095081e+00
 2.51572099e-01 8.97453341e-01 1.36284625e+03 2.41569984e+04
 6.64139768e+02 9.83577874e+03 2.98110143e+02 3.61372694e+03
 3.11584812e+02 3.81904472e+03 6.27632148e+01 5.15366124e+02
 7.42275288e+00 3.57429707e+01 2.05691346e+01 1.27792221e+02
 7.79618910e-01 2.13716153e+00 2.84337532e+00 1.07715234e+01
 2.23507616e-01 4.48332065e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99330458740973
cond(S) = 96996.91182209077
E1 = -729.5320032790518  E_coul = 203.18017486458868
init E= -526.351828414463
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555755194698264  LUMO = 1.03962263095934
  mo_energy =
[-1.18331942e+02 -1.22046587e+01 -9.44671121e+00 -9.44671121e+00
 -9.44671121e+00 -1.23991271e+00 -5.55755195e-01 -5.55755195e-01
 -5.55755195e-01  1.03962263e+00  1.03962263e+00  1.03962263e+00
  1.07466025e+00  7.44946822e+00  7.44946822e+00  7.44946822e+00
  1.37502251e+01  3.40829896e+01  3.40829896e+01  3.40829896e+01
  1.23122487e+02  1.31497412e+02  1.31497412e+02  1.31497412e+02
  4.86262296e+02  4.86262296e+02  4.86262296e+02  6.65919802e+02
  1.33300428e+03  1.33300428e+03  1.33300428e+03  2.81211915e+03
  3.01975560e+03  3.01975560e+03  3.01975560e+03  6.63505288e+03
  6.63505288e+03  6.63505288e+03  9.23336877e+03  2.55805062e+04
  7.63100120e+04]
E1 = -727.8702911264506  E_coul = 201.12500662166173
cycle= 1 E= -526.745284504789  delta_E= -0.393  |g|= 0.185  |ddm|= 0.31
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537956
diis-c [-0.28939636  1.        ]
  HOMO = -0.590334479230166  LUMO = 1.01537906419353
  mo_energy =
[-1.18637054e+02 -1.23414188e+01 -9.59401287e+00 -9.59401287e+00
 -9.59401287e+00 -1.27911085e+00 -5.90334479e-01 -5.90334479e-01
 -5.90334479e-01  1.01537906e+00  1.01537906e+00  1.01537906e+00
  1.04504243e+00  7.35863962e+00  7.35863962e+00  7.35863962e+00
  1.36365794e+01  3.39292470e+01  3.39292470e+01  3.39292470e+01
  1.22894424e+02  1.31270062e+02  1.31270062e+02  1.31270062e+02
  4.85958971e+02  4.85958971e+02  4.85958971e+02  6.65569368e+02
  1.33264560e+03  1.33264560e+03  1.33264560e+03  2.81162602e+03
  3.01933151e+03  3.01933151e+03  3.01933151e+03  6.63451699e+03
  6.63451699e+03  6.63451699e+03  9.23275952e+03  2.55798033e+04
  7.63092194e+04]
E1 = -728.4388070312314  E_coul = 201.6928167327386
cycle= 2 E= -526.745990298493  delta_E= -0.000706  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0744798
diis-c [-0.00325431  0.0821619   0.9178381 ]
  HOMO = -0.581306680236816  LUMO = 1.02208789034023
  mo_energy =
[-1.18569993e+02 -1.23037216e+01 -9.55467186e+00 -9.55467186e+00
 -9.55467186e+00 -1.26830621e+00 -5.81306680e-01 -5.81306680e-01
 -5.81306680e-01  1.02208789e+00  1.02208789e+00  1.02208789e+00
  1.05349902e+00  7.38235043e+00  7.38235043e+00  7.38235043e+00
  1.36676122e+01  3.39691785e+01  3.39691785e+01  3.39691785e+01
  1.22951290e+02  1.31325605e+02  1.31325605e+02  1.31325605e+02
  4.86025185e+02  4.86025185e+02  4.86025185e+02  6.65638533e+02
  1.33271582e+03  1.33271582e+03  1.33271582e+03  2.81169963e+03
  3.01940398e+03  3.01940398e+03  3.01940398e+03  6.63459121e+03
  6.63459121e+03  6.63459121e+03  9.23283455e+03  2.55798789e+04
  7.63092953e+04]
E1 = -728.2899230159444  E_coul = 201.54387490909946
cycle= 3 E= -526.746048106845  delta_E= -5.78e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130611
diis-c [-5.34900355e-07 -1.21884608e-03  1.44855254e-01  8.56363592e-01]
  HOMO = -0.582791217111273  LUMO = 1.02100817277277
  mo_energy =
[-1.18579874e+02 -1.23094840e+01 -9.56077593e+00 -9.56077593e+00
 -9.56077593e+00 -1.26998594e+00 -5.82791217e-01 -5.82791217e-01
 -5.82791217e-01  1.02100817e+00  1.02100817e+00  1.02100817e+00
  1.05220319e+00  7.37857730e+00  7.37857730e+00  7.37857730e+00
  1.36628459e+01  3.39630247e+01  3.39630247e+01  3.39630247e+01
  1.22942849e+02  1.31317299e+02  1.31317299e+02  1.31317299e+02
  4.86015423e+02  4.86015423e+02  4.86015423e+02  6.65628330e+02
  1.33270547e+03  1.33270547e+03  1.33270547e+03  2.81168865e+03
  3.01939325e+03  3.01939325e+03  3.01939325e+03  6.63458009e+03
  6.63458009e+03  6.63458009e+03  9.23282323e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3125384914716  E_coul = 201.56648849338092
cycle= 4 E= -526.746049998091  delta_E= -1.89e-06  |g|= 9.31e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107546
diis-c [-3.81126793e-09  6.73938729e-05 -9.77490938e-03 -6.33868043e-02
  1.07309432e+00]
  HOMO = -0.582772906970526  LUMO = 1.021023875236
  mo_energy =
[-1.18579835e+02 -1.23094206e+01 -9.56072537e+00 -9.56072537e+00
 -9.56072537e+00 -1.26994629e+00 -5.82772907e-01 -5.82772907e-01
 -5.82772907e-01  1.02102388e+00  1.02102388e+00  1.02102388e+00
  1.05223712e+00  7.37861860e+00  7.37861860e+00  7.37861860e+00
  1.36629045e+01  3.39630733e+01  3.39630733e+01  3.39630733e+01
  1.22942899e+02  1.31317346e+02  1.31317346e+02  1.31317346e+02
  4.86015463e+02  4.86015463e+02  4.86015463e+02  6.65628361e+02
  1.33270550e+03  1.33270550e+03  1.33270550e+03  2.81168866e+03
  3.01939327e+03  3.01939327e+03  3.01939327e+03  6.63458010e+03
  6.63458010e+03  6.63458010e+03  9.23282323e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3123319428149  E_coul = 201.5662819432396
cycle= 5 E= -526.746049999575  delta_E= -1.48e-09  |g|= 1.99e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.78697e-05
diis-c [-6.59645233e-11  1.39801180e-05 -1.84088095e-03 -1.37478156e-02
  4.29081181e-02  9.72666598e-01]
  HOMO = -0.582780005016378  LUMO = 1.02101913033578
  mo_energy =
[-1.18579864e+02 -1.23094422e+01 -9.56074890e+00 -9.56074890e+00
 -9.56074890e+00 -1.26995198e+00 -5.82780005e-01 -5.82780005e-01
 -5.82780005e-01  1.02101913e+00  1.02101913e+00  1.02101913e+00
  1.05223315e+00  7.37860258e+00  7.37860258e+00  7.37860258e+00
  1.36628865e+01  3.39630504e+01  3.39630504e+01  3.39630504e+01
  1.22942873e+02  1.31317319e+02  1.31317319e+02  1.31317319e+02
  4.86015434e+02  4.86015434e+02  4.86015434e+02  6.65628331e+02
  1.33270547e+03  1.33270547e+03  1.33270547e+03  2.81168863e+03
  3.01939324e+03  3.01939324e+03  3.01939324e+03  6.63458006e+03
  6.63458006e+03  6.63458006e+03  9.23282320e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3124107034114  E_coul = 201.56636070378326
cycle= 6 E= -526.746049999628  delta_E= -5.28e-11  |g|= 1.67e-06  |ddm|= 1.74e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3124107034114  E_coul = 201.56636070378326
  HOMO = -0.582780033271266  LUMO = 1.02101916383846
  mo_energy =
[-1.18579864e+02 -1.23094421e+01 -9.56074889e+00 -9.56074889e+00
 -9.56074889e+00 -1.26995164e+00 -5.82780033e-01 -5.82780033e-01
 -5.82780033e-01  1.02101916e+00  1.02101916e+00  1.02101916e+00
  1.05223347e+00  7.37860260e+00  7.37860260e+00  7.37860260e+00
  1.36628866e+01  3.39630504e+01  3.39630504e+01  3.39630504e+01
  1.22942873e+02  1.31317319e+02  1.31317319e+02  1.31317319e+02
  4.86015434e+02  4.86015434e+02  4.86015434e+02  6.65628331e+02
  1.33270547e+03  1.33270547e+03  1.33270547e+03  2.81168863e+03
  3.01939324e+03  3.01939324e+03  3.01939324e+03  6.63458006e+03
  6.63458006e+03  6.63458006e+03  9.23282320e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3124099925071  E_coul = 201.56635999287812
Extra cycle  E= -526.746049999629  delta_E= -9.09e-13  |g|= 3.41e-07  |ddm|= 2.87e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 96996.91182209077
E1 = -728.3124099925071  E_coul = 201.56635999287812
init E= -526.746049999629
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582780057274348  LUMO = 1.02101915784824
  mo_energy =
[-1.18579864e+02 -1.23094422e+01 -9.56074896e+00 -9.56074896e+00
 -9.56074896e+00 -1.26995159e+00 -5.82780057e-01 -5.82780057e-01
 -5.82780057e-01  1.02101916e+00  1.02101916e+00  1.02101916e+00
  1.05223352e+00  7.37860256e+00  7.37860256e+00  7.37860256e+00
  1.36628866e+01  3.39630503e+01  3.39630503e+01  3.39630503e+01
  1.22942873e+02  1.31317319e+02  1.31317319e+02  1.31317319e+02
  4.86015434e+02  4.86015434e+02  4.86015434e+02  6.65628331e+02
  1.33270547e+03  1.33270547e+03  1.33270547e+03  2.81168863e+03
  3.01939324e+03  3.01939324e+03  3.01939324e+03  6.63458006e+03
  6.63458006e+03  6.63458006e+03  9.23282320e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3124100972263  E_coul = 201.5663600975972
cycle= 1 E= -526.746049999629  delta_E= -1.14e-13  |g|= 7.05e-08  |ddm|= 5.63e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3124100972263  E_coul = 201.5663600975972
  HOMO = -0.58278005748276  LUMO = 1.02101916001775
  mo_energy =
[-1.18579864e+02 -1.23094422e+01 -9.56074896e+00 -9.56074896e+00
 -9.56074896e+00 -1.26995157e+00 -5.82780057e-01 -5.82780057e-01
 -5.82780057e-01  1.02101916e+00  1.02101916e+00  1.02101916e+00
  1.05223353e+00  7.37860256e+00  7.37860256e+00  7.37860256e+00
  1.36628866e+01  3.39630504e+01  3.39630504e+01  3.39630504e+01
  1.22942873e+02  1.31317319e+02  1.31317319e+02  1.31317319e+02
  4.86015434e+02  4.86015434e+02  4.86015434e+02  6.65628331e+02
  1.33270547e+03  1.33270547e+03  1.33270547e+03  2.81168863e+03
  3.01939324e+03  3.01939324e+03  3.01939324e+03  6.63458006e+03
  6.63458006e+03  6.63458006e+03  9.23282320e+03  2.55798674e+04
  7.63092836e+04]
E1 = -728.3124100482823  E_coul = 201.5663600486523
Extra cycle  E= -526.74604999963  delta_E= -9.09e-13  |g|= 1.41e-08  |ddm|= 1.17e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828453e+04 7.61708021e+03 3.61752162e+03 1.58796214e+03
 4.18354053e+02 1.22682540e+02 3.95147799e+01 8.53833997e+00
 3.36866628e+00 6.79548213e-01 2.51572099e-01 1.36284625e+03
 6.64139768e+02 2.98110143e+02 3.11584812e+02 6.27632148e+01
 7.42275288e+00 2.05691346e+01 7.79618910e-01 2.84337532e+00
 2.23507616e-01]
grad_E = [-1.39866935e-06  2.16981106e-06 -2.14289580e-06  3.73690487e-05
 -1.72385237e-06  4.44480318e-05 -2.92623256e-05  4.84718244e-05
  2.10894570e-04  7.57636816e-04 -7.23332513e-04 -5.84968118e-07
  4.10081481e-06  1.87524542e-05  1.60145033e-05  8.65874681e-05
 -9.57548349e-04  1.50709203e-04  1.08883143e-03  9.76782416e-04
 -2.60374977e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8541211        1
[INPUT] 0    0    [1    /1   ]  7617.06574919        1
[INPUT] 0    0    [1    /1   ]  3617.53444902        1
[INPUT] 0    0    [1    /1   ]  1587.70187726        1
[INPUT] 0    0    [1    /1   ]  418.499541524        1
[INPUT] 0    0    [1    /1   ]  122.779739363        1
[INPUT] 0    0    [1    /1   ]  39.5451413533        1
[INPUT] 0    0    [1    /1   ]  8.5545704257         1
[INPUT] 0    0    [1    /1   ]  3.37419639588        1
[INPUT] 0    0    [1    /1   ]  0.681631240535       1
[INPUT] 0    0    [1    /1   ]  0.252283806353       1
[INPUT] 1    0    [1    /1   ]  1362.84988021        1
[INPUT] 1    0    [1    /1   ]  664.114134512        1
[INPUT] 1    0    [1    /1   ]  297.992822573        1
[INPUT] 1    0    [1    /1   ]  311.484528657        1
[INPUT] 1    0    [1    /1   ]  62.3420150919        1
[INPUT] 1    0    [1    /1   ]  7.36413052652        1
[INPUT] 1    0    [1    /1   ]  20.4090636615        1
[INPUT] 1    0    [1    /1   ]  0.777528309898       1
[INPUT] 1    0    [1    /1   ]  2.82490721448        1
[INPUT] 1    0    [1    /1   ]  0.223057494634       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.85412105805, 1.0]], [0, [7617.065749187816, 1.0]], [0, [3617.5344490177067, 1.0]], [0, [1587.7018772559277, 1.0]], [0, [418.49954152378183, 1.0]], [0, [122.77973936321646, 1.0]], [0, [39.545141353320744, 1.0]], [0, [8.554570425700687, 1.0]], [0, [3.3741963958778767, 1.0]], [0, [0.6816312405352383, 1.0]], [0, [0.2522838063527248, 1.0]], [1, [1362.8498802142228, 1.0]], [1, [664.1141345123597, 1.0]], [1, [297.9928225726465, 1.0]], [1, [311.4845286569259, 1.0]], [1, [62.34201509185093, 1.0]], [1, [7.36413052651663, 1.0]], [1, [20.409063661539307, 1.0]], [1, [0.7775283098978205, 1.0]], [1, [2.8249072144774456, 1.0]], [1, [0.22305749463405866, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.85412106]
bas 1, expnt(s) = [7617.06574919]
bas 2, expnt(s) = [3617.53444902]
bas 3, expnt(s) = [1587.70187726]
bas 4, expnt(s) = [418.49954152]
bas 5, expnt(s) = [122.77973936]
bas 6, expnt(s) = [39.54514135]
bas 7, expnt(s) = [8.55457043]
bas 8, expnt(s) = [3.3741964]
bas 9, expnt(s) = [0.68163124]
bas 10, expnt(s) = [0.25228381]
bas 11, expnt(s) = [1362.84988021]
bas 12, expnt(s) = [664.11413451]
bas 13, expnt(s) = [297.99282257]
bas 14, expnt(s) = [311.48452866]
bas 15, expnt(s) = [62.34201509]
bas 16, expnt(s) = [7.36413053]
bas 17, expnt(s) = [20.40906366]
bas 18, expnt(s) = [0.77752831]
bas 19, expnt(s) = [2.82490721]
bas 20, expnt(s) = [0.22305749]
CPU time:       530.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828541e+04 5.20029240e+03 7.61706575e+03 2.05994584e+03
 3.61753445e+03 1.17848628e+03 1.58770188e+03 6.35465157e+02
 4.18499542e+02 2.33768647e+02 1.22779739e+02 9.31880136e+01
 3.95451414e+01 3.98414259e+01 8.55457043e+00 1.26375730e+01
 3.37419640e+00 6.28988626e+00 6.81631241e-01 1.89529641e+00
 2.52283806e-01 8.99356868e-01 1.36284988e+03 2.41570789e+04
 6.64114135e+02 9.83530420e+03 2.97992823e+02 3.61194931e+03
 3.11484529e+02 3.81750833e+03 6.23420151e+01 5.11046523e+02
 7.36413053e+00 3.53904626e+01 2.04090637e+01 1.26550319e+02
 7.77528310e-01 2.13000026e+00 2.82490721e+00 1.06841414e+01
 2.23057495e-01 4.47203730e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993370008570007
cond(S) = 95956.57353587539
E1 = -729.5322619268463  E_coul = 203.18032450522037
init E= -526.351937421626
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555778091633823  LUMO = 1.03599365463488
  mo_energy =
[-1.18331965e+02 -1.22046342e+01 -9.44667632e+00 -9.44667632e+00
 -9.44667632e+00 -1.23988925e+00 -5.55778092e-01 -5.55778092e-01
 -5.55778092e-01  1.03599365e+00  1.03599365e+00  1.03599365e+00
  1.08021716e+00  7.39165126e+00  7.39165126e+00  7.39165126e+00
  1.37986646e+01  3.37648505e+01  3.37648505e+01  3.37648505e+01
  1.23324929e+02  1.30392041e+02  1.30392041e+02  1.30392041e+02
  4.84240006e+02  4.84240006e+02  4.84240006e+02  6.66461185e+02
  1.33055446e+03  1.33055446e+03  1.33055446e+03  2.81287347e+03
  3.01700660e+03  3.01700660e+03  3.01700660e+03  6.63223340e+03
  6.63223340e+03  6.63223340e+03  9.23386518e+03  2.55807139e+04
  7.63100758e+04]
E1 = -727.8688164419124  E_coul = 201.12350927480662
cycle= 1 E= -526.745307167106  delta_E= -0.393  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537846
diis-c [-0.28927815  1.        ]
  HOMO = -0.59043347022046  LUMO = 1.01179121730382
  mo_energy =
[-1.18637201e+02 -1.23414936e+01 -9.59406987e+00 -9.59406987e+00
 -9.59406987e+00 -1.27918287e+00 -5.90433470e-01 -5.90433470e-01
 -5.90433470e-01  1.01179122e+00  1.01179122e+00  1.01179122e+00
  1.05038797e+00  7.30114739e+00  7.30114739e+00  7.30114739e+00
  1.36847770e+01  3.36115166e+01  3.36115166e+01  3.36115166e+01
  1.23096666e+02  1.30164973e+02  1.30164973e+02  1.30164973e+02
  4.83936577e+02  4.83936577e+02  4.83936577e+02  6.66110581e+02
  1.33019562e+03  1.33019562e+03  1.33019562e+03  2.81238023e+03
  3.01658237e+03  3.01658237e+03  3.01658237e+03  6.63169736e+03
  6.63169736e+03  6.63169736e+03  9.23325583e+03  2.55800109e+04
  7.63092831e+04]
E1 = -728.4381363378654  E_coul = 201.69212227217562
cycle= 2 E= -526.74601406569  delta_E= -0.000707  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745316
diis-c [-0.00325939  0.08222168  0.91777832]
  HOMO = -0.581390059201853  LUMO = 1.01848444576818
  mo_energy =
[-1.18570069e+02 -1.23037437e+01 -9.55467423e+00 -9.55467423e+00
 -9.55467423e+00 -1.26835948e+00 -5.81390059e-01 -5.81390059e-01
 -5.81390059e-01  1.01848445e+00  1.01848445e+00  1.01848445e+00
  1.05889218e+00  7.32478306e+00  7.32478306e+00  7.32478306e+00
  1.37158891e+01  3.36513788e+01  3.36513788e+01  3.36513788e+01
  1.23153606e+02  1.30220506e+02  1.30220506e+02  1.30220506e+02
  4.84002856e+02  4.84002856e+02  4.84002856e+02  6.66179819e+02
  1.33026591e+03  1.33026591e+03  1.33026591e+03  2.81245390e+03
  3.01665491e+03  3.01665491e+03  3.01665491e+03  6.63177166e+03
  6.63177166e+03  6.63177166e+03  9.23333094e+03  2.55800866e+04
  7.63093590e+04]
E1 = -728.2889344691141  E_coul = 201.542862402837
cycle= 3 E= -526.746072066277  delta_E= -5.8e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130764
diis-c [-5.34855135e-07 -1.21855107e-03  1.44923461e-01  8.56295090e-01]
  HOMO = -0.58287831365094  LUMO = 1.01740632541686
  mo_energy =
[-1.18579967e+02 -1.23095180e+01 -9.56079045e+00 -9.56079045e+00
 -9.56079045e+00 -1.27004397e+00 -5.82878314e-01 -5.82878314e-01
 -5.82878314e-01  1.01740633e+00  1.01740633e+00  1.01740633e+00
  1.05758739e+00  7.32101863e+00  7.32101863e+00  7.32101863e+00
  1.37111072e+01  3.36452303e+01  3.36452303e+01  3.36452303e+01
  1.23145149e+02  1.30212194e+02  1.30212194e+02  1.30212194e+02
  4.83993079e+02  4.83993079e+02  4.83993079e+02  6.66169599e+02
  1.33025555e+03  1.33025555e+03  1.33025555e+03  2.81244290e+03
  3.01664416e+03  3.01664416e+03  3.01664416e+03  6.63176052e+03
  6.63176052e+03  6.63176052e+03  9.23331959e+03  2.55800751e+04
  7.63093474e+04]
E1 = -728.3116155668162  E_coul = 201.5655416001269
cycle= 4 E= -526.746073966689  delta_E= -1.9e-06  |g|= 9.29e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106831
diis-c [-3.82610942e-09  6.66662353e-05 -9.68585136e-03 -6.27506635e-02
  1.07236985e+00]
  HOMO = -0.582859800203005  LUMO = 1.01742211184912
  mo_energy =
[-1.18579927e+02 -1.23094540e+01 -9.56073928e+00 -9.56073928e+00
 -9.56073928e+00 -1.27000419e+00 -5.82859800e-01 -5.82859800e-01
 -5.82859800e-01  1.01742211e+00  1.01742211e+00  1.01742211e+00
  1.05762153e+00  7.32106026e+00  7.32106026e+00  7.32106026e+00
  1.37111663e+01  3.36452795e+01  3.36452795e+01  3.36452795e+01
  1.23145200e+02  1.30212242e+02  1.30212242e+02  1.30212242e+02
  4.83993120e+02  4.83993120e+02  4.83993120e+02  6.66169631e+02
  1.33025558e+03  1.33025558e+03  1.33025558e+03  2.81244292e+03
  3.01664419e+03  3.01664419e+03  3.01664419e+03  6.63176053e+03
  6.63176053e+03  6.63176053e+03  9.23331959e+03  2.55800751e+04
  7.63093474e+04]
E1 = -728.3114072839214  E_coul = 201.56533331575983
cycle= 5 E= -526.746073968162  delta_E= -1.47e-09  |g|= 1.99e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79577e-05
diis-c [-6.55129591e-11  1.39865054e-05 -1.84327872e-03 -1.37568383e-02
  4.29626654e-02  9.72623465e-01]
  HOMO = -0.582866896225633  LUMO = 1.01741738749263
  mo_energy =
[-1.18579956e+02 -1.23094757e+01 -9.56076282e+00 -9.56076282e+00
 -9.56076282e+00 -1.27000987e+00 -5.82866896e-01 -5.82866896e-01
 -5.82866896e-01  1.01741739e+00  1.01741739e+00  1.01741739e+00
  1.05761753e+00  7.32104430e+00  7.32104430e+00  7.32104430e+00
  1.37111483e+01  3.36452566e+01  3.36452566e+01  3.36452566e+01
  1.23145173e+02  1.30212215e+02  1.30212215e+02  1.30212215e+02
  4.83993091e+02  4.83993091e+02  4.83993091e+02  6.66169601e+02
  1.33025555e+03  1.33025555e+03  1.33025555e+03  2.81244288e+03
  3.01664415e+03  3.01664415e+03  3.01664415e+03  6.63176050e+03
  6.63176050e+03  6.63176050e+03  9.23331956e+03  2.55800750e+04
  7.63093473e+04]
E1 = -728.3114862763396  E_coul = 201.56541230812513
cycle= 6 E= -526.746073968214  delta_E= -5.29e-11  |g|= 1.67e-06  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3114862763396  E_coul = 201.56541230812513
  HOMO = -0.582866926460313  LUMO = 1.01741741956826
  mo_energy =
[-1.18579956e+02 -1.23094756e+01 -9.56076283e+00 -9.56076283e+00
 -9.56076283e+00 -1.27000954e+00 -5.82866926e-01 -5.82866926e-01
 -5.82866926e-01  1.01741742e+00  1.01741742e+00  1.01741742e+00
  1.05761785e+00  7.32104431e+00  7.32104431e+00  7.32104431e+00
  1.37111484e+01  3.36452566e+01  3.36452566e+01  3.36452566e+01
  1.23145173e+02  1.30212215e+02  1.30212215e+02  1.30212215e+02
  4.83993091e+02  4.83993091e+02  4.83993091e+02  6.66169601e+02
  1.33025555e+03  1.33025555e+03  1.33025555e+03  2.81244288e+03
  3.01664415e+03  3.01664415e+03  3.01664415e+03  6.63176050e+03
  6.63176050e+03  6.63176050e+03  9.23331956e+03  2.55800750e+04
  7.63093473e+04]
E1 = -728.311485624269  E_coul = 201.56541165605353
Extra cycle  E= -526.746073968216  delta_E= -1.14e-12  |g|= 3.41e-07  |ddm|= 2.86e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828541e+04 7.61706575e+03 3.61753445e+03 1.58770188e+03
 4.18499542e+02 1.22779739e+02 3.95451414e+01 8.55457043e+00
 3.37419640e+00 6.81631241e-01 2.52283806e-01 1.36284988e+03
 6.64114135e+02 2.97992823e+02 3.11484529e+02 6.23420151e+01
 7.36413053e+00 2.04090637e+01 7.77528310e-01 2.82490721e+00
 2.23057495e-01]
E = -526.7460739682156
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8541211        1
[INPUT] 0    0    [1    /1   ]  7617.06574919        1
[INPUT] 0    0    [1    /1   ]  3617.53444902        1
[INPUT] 0    0    [1    /1   ]  1587.70187726        1
[INPUT] 0    0    [1    /1   ]  418.499541524        1
[INPUT] 0    0    [1    /1   ]  122.779739363        1
[INPUT] 0    0    [1    /1   ]  39.5451413533        1
[INPUT] 0    0    [1    /1   ]  8.5545704257         1
[INPUT] 0    0    [1    /1   ]  3.37419639588        1
[INPUT] 0    0    [1    /1   ]  0.681631240535       1
[INPUT] 0    0    [1    /1   ]  0.252283806353       1
[INPUT] 1    0    [1    /1   ]  1362.84988021        1
[INPUT] 1    0    [1    /1   ]  664.114134512        1
[INPUT] 1    0    [1    /1   ]  297.992822573        1
[INPUT] 1    0    [1    /1   ]  311.484528657        1
[INPUT] 1    0    [1    /1   ]  62.3420150919        1
[INPUT] 1    0    [1    /1   ]  7.36413052652        1
[INPUT] 1    0    [1    /1   ]  20.4090636615        1
[INPUT] 1    0    [1    /1   ]  0.777528309898       1
[INPUT] 1    0    [1    /1   ]  2.82490721448        1
[INPUT] 1    0    [1    /1   ]  0.223057494634       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.85412105805, 1.0]], [0, [7617.065749187816, 1.0]], [0, [3617.5344490177067, 1.0]], [0, [1587.7018772559277, 1.0]], [0, [418.49954152378183, 1.0]], [0, [122.77973936321646, 1.0]], [0, [39.545141353320744, 1.0]], [0, [8.554570425700687, 1.0]], [0, [3.3741963958778767, 1.0]], [0, [0.6816312405352383, 1.0]], [0, [0.2522838063527248, 1.0]], [1, [1362.8498802142228, 1.0]], [1, [664.1141345123597, 1.0]], [1, [297.9928225726465, 1.0]], [1, [311.4845286569259, 1.0]], [1, [62.34201509185093, 1.0]], [1, [7.36413052651663, 1.0]], [1, [20.409063661539307, 1.0]], [1, [0.7775283098978205, 1.0]], [1, [2.8249072144774456, 1.0]], [1, [0.22305749463405866, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.85412106]
bas 1, expnt(s) = [7617.06574919]
bas 2, expnt(s) = [3617.53444902]
bas 3, expnt(s) = [1587.70187726]
bas 4, expnt(s) = [418.49954152]
bas 5, expnt(s) = [122.77973936]
bas 6, expnt(s) = [39.54514135]
bas 7, expnt(s) = [8.55457043]
bas 8, expnt(s) = [3.3741964]
bas 9, expnt(s) = [0.68163124]
bas 10, expnt(s) = [0.25228381]
bas 11, expnt(s) = [1362.84988021]
bas 12, expnt(s) = [664.11413451]
bas 13, expnt(s) = [297.99282257]
bas 14, expnt(s) = [311.48452866]
bas 15, expnt(s) = [62.34201509]
bas 16, expnt(s) = [7.36413053]
bas 17, expnt(s) = [20.40906366]
bas 18, expnt(s) = [0.77752831]
bas 19, expnt(s) = [2.82490721]
bas 20, expnt(s) = [0.22305749]
CPU time:       531.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828541e+04 5.20029240e+03 7.61706575e+03 2.05994584e+03
 3.61753445e+03 1.17848628e+03 1.58770188e+03 6.35465157e+02
 4.18499542e+02 2.33768647e+02 1.22779739e+02 9.31880136e+01
 3.95451414e+01 3.98414259e+01 8.55457043e+00 1.26375730e+01
 3.37419640e+00 6.28988626e+00 6.81631241e-01 1.89529641e+00
 2.52283806e-01 8.99356868e-01 1.36284988e+03 2.41570789e+04
 6.64114135e+02 9.83530420e+03 2.97992823e+02 3.61194931e+03
 3.11484529e+02 3.81750833e+03 6.23420151e+01 5.11046523e+02
 7.36413053e+00 3.53904626e+01 2.04090637e+01 1.26550319e+02
 7.77528310e-01 2.13000026e+00 2.82490721e+00 1.06841414e+01
 2.23057495e-01 4.47203730e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993370008570007
cond(S) = 95956.57353587539
E1 = -729.5322619268463  E_coul = 203.18032450522037
init E= -526.351937421626
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555778091633823  LUMO = 1.03599365463488
  mo_energy =
[-1.18331965e+02 -1.22046342e+01 -9.44667632e+00 -9.44667632e+00
 -9.44667632e+00 -1.23988925e+00 -5.55778092e-01 -5.55778092e-01
 -5.55778092e-01  1.03599365e+00  1.03599365e+00  1.03599365e+00
  1.08021716e+00  7.39165126e+00  7.39165126e+00  7.39165126e+00
  1.37986646e+01  3.37648505e+01  3.37648505e+01  3.37648505e+01
  1.23324929e+02  1.30392041e+02  1.30392041e+02  1.30392041e+02
  4.84240006e+02  4.84240006e+02  4.84240006e+02  6.66461185e+02
  1.33055446e+03  1.33055446e+03  1.33055446e+03  2.81287347e+03
  3.01700660e+03  3.01700660e+03  3.01700660e+03  6.63223340e+03
  6.63223340e+03  6.63223340e+03  9.23386518e+03  2.55807139e+04
  7.63100758e+04]
E1 = -727.8688164419124  E_coul = 201.12350927480662
cycle= 1 E= -526.745307167106  delta_E= -0.393  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537846
diis-c [-0.28927815  1.        ]
  HOMO = -0.59043347022046  LUMO = 1.01179121730382
  mo_energy =
[-1.18637201e+02 -1.23414936e+01 -9.59406987e+00 -9.59406987e+00
 -9.59406987e+00 -1.27918287e+00 -5.90433470e-01 -5.90433470e-01
 -5.90433470e-01  1.01179122e+00  1.01179122e+00  1.01179122e+00
  1.05038797e+00  7.30114739e+00  7.30114739e+00  7.30114739e+00
  1.36847770e+01  3.36115166e+01  3.36115166e+01  3.36115166e+01
  1.23096666e+02  1.30164973e+02  1.30164973e+02  1.30164973e+02
  4.83936577e+02  4.83936577e+02  4.83936577e+02  6.66110581e+02
  1.33019562e+03  1.33019562e+03  1.33019562e+03  2.81238023e+03
  3.01658237e+03  3.01658237e+03  3.01658237e+03  6.63169736e+03
  6.63169736e+03  6.63169736e+03  9.23325583e+03  2.55800109e+04
  7.63092831e+04]
E1 = -728.4381363378654  E_coul = 201.69212227217562
cycle= 2 E= -526.74601406569  delta_E= -0.000707  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745316
diis-c [-0.00325939  0.08222168  0.91777832]
  HOMO = -0.581390059201853  LUMO = 1.01848444576818
  mo_energy =
[-1.18570069e+02 -1.23037437e+01 -9.55467423e+00 -9.55467423e+00
 -9.55467423e+00 -1.26835948e+00 -5.81390059e-01 -5.81390059e-01
 -5.81390059e-01  1.01848445e+00  1.01848445e+00  1.01848445e+00
  1.05889218e+00  7.32478306e+00  7.32478306e+00  7.32478306e+00
  1.37158891e+01  3.36513788e+01  3.36513788e+01  3.36513788e+01
  1.23153606e+02  1.30220506e+02  1.30220506e+02  1.30220506e+02
  4.84002856e+02  4.84002856e+02  4.84002856e+02  6.66179819e+02
  1.33026591e+03  1.33026591e+03  1.33026591e+03  2.81245390e+03
  3.01665491e+03  3.01665491e+03  3.01665491e+03  6.63177166e+03
  6.63177166e+03  6.63177166e+03  9.23333094e+03  2.55800866e+04
  7.63093590e+04]
E1 = -728.2889344691141  E_coul = 201.542862402837
cycle= 3 E= -526.746072066277  delta_E= -5.8e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130764
diis-c [-5.34855135e-07 -1.21855107e-03  1.44923461e-01  8.56295090e-01]
  HOMO = -0.58287831365094  LUMO = 1.01740632541686
  mo_energy =
[-1.18579967e+02 -1.23095180e+01 -9.56079045e+00 -9.56079045e+00
 -9.56079045e+00 -1.27004397e+00 -5.82878314e-01 -5.82878314e-01
 -5.82878314e-01  1.01740633e+00  1.01740633e+00  1.01740633e+00
  1.05758739e+00  7.32101863e+00  7.32101863e+00  7.32101863e+00
  1.37111072e+01  3.36452303e+01  3.36452303e+01  3.36452303e+01
  1.23145149e+02  1.30212194e+02  1.30212194e+02  1.30212194e+02
  4.83993079e+02  4.83993079e+02  4.83993079e+02  6.66169599e+02
  1.33025555e+03  1.33025555e+03  1.33025555e+03  2.81244290e+03
  3.01664416e+03  3.01664416e+03  3.01664416e+03  6.63176052e+03
  6.63176052e+03  6.63176052e+03  9.23331959e+03  2.55800751e+04
  7.63093474e+04]
E1 = -728.3116155668162  E_coul = 201.5655416001269
cycle= 4 E= -526.746073966689  delta_E= -1.9e-06  |g|= 9.29e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106831
diis-c [-3.82610942e-09  6.66662353e-05 -9.68585136e-03 -6.27506635e-02
  1.07236985e+00]
  HOMO = -0.582859800203005  LUMO = 1.01742211184912
  mo_energy =
[-1.18579927e+02 -1.23094540e+01 -9.56073928e+00 -9.56073928e+00
 -9.56073928e+00 -1.27000419e+00 -5.82859800e-01 -5.82859800e-01
 -5.82859800e-01  1.01742211e+00  1.01742211e+00  1.01742211e+00
  1.05762153e+00  7.32106026e+00  7.32106026e+00  7.32106026e+00
  1.37111663e+01  3.36452795e+01  3.36452795e+01  3.36452795e+01
  1.23145200e+02  1.30212242e+02  1.30212242e+02  1.30212242e+02
  4.83993120e+02  4.83993120e+02  4.83993120e+02  6.66169631e+02
  1.33025558e+03  1.33025558e+03  1.33025558e+03  2.81244292e+03
  3.01664419e+03  3.01664419e+03  3.01664419e+03  6.63176053e+03
  6.63176053e+03  6.63176053e+03  9.23331959e+03  2.55800751e+04
  7.63093474e+04]
E1 = -728.3114072839214  E_coul = 201.56533331575983
cycle= 5 E= -526.746073968162  delta_E= -1.47e-09  |g|= 1.99e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79577e-05
diis-c [-6.55129591e-11  1.39865054e-05 -1.84327872e-03 -1.37568383e-02
  4.29626654e-02  9.72623465e-01]
  HOMO = -0.582866896225633  LUMO = 1.01741738749263
  mo_energy =
[-1.18579956e+02 -1.23094757e+01 -9.56076282e+00 -9.56076282e+00
 -9.56076282e+00 -1.27000987e+00 -5.82866896e-01 -5.82866896e-01
 -5.82866896e-01  1.01741739e+00  1.01741739e+00  1.01741739e+00
  1.05761753e+00  7.32104430e+00  7.32104430e+00  7.32104430e+00
  1.37111483e+01  3.36452566e+01  3.36452566e+01  3.36452566e+01
  1.23145173e+02  1.30212215e+02  1.30212215e+02  1.30212215e+02
  4.83993091e+02  4.83993091e+02  4.83993091e+02  6.66169601e+02
  1.33025555e+03  1.33025555e+03  1.33025555e+03  2.81244288e+03
  3.01664415e+03  3.01664415e+03  3.01664415e+03  6.63176050e+03
  6.63176050e+03  6.63176050e+03  9.23331956e+03  2.55800750e+04
  7.63093473e+04]
E1 = -728.3114862763396  E_coul = 201.56541230812513
cycle= 6 E= -526.746073968214  delta_E= -5.29e-11  |g|= 1.67e-06  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3114862763396  E_coul = 201.56541230812513
  HOMO = -0.582866926460313  LUMO = 1.01741741956826
  mo_energy =
[-1.18579956e+02 -1.23094756e+01 -9.56076283e+00 -9.56076283e+00
 -9.56076283e+00 -1.27000954e+00 -5.82866926e-01 -5.82866926e-01
 -5.82866926e-01  1.01741742e+00  1.01741742e+00  1.01741742e+00
  1.05761785e+00  7.32104431e+00  7.32104431e+00  7.32104431e+00
  1.37111484e+01  3.36452566e+01  3.36452566e+01  3.36452566e+01
  1.23145173e+02  1.30212215e+02  1.30212215e+02  1.30212215e+02
  4.83993091e+02  4.83993091e+02  4.83993091e+02  6.66169601e+02
  1.33025555e+03  1.33025555e+03  1.33025555e+03  2.81244288e+03
  3.01664415e+03  3.01664415e+03  3.01664415e+03  6.63176050e+03
  6.63176050e+03  6.63176050e+03  9.23331956e+03  2.55800750e+04
  7.63093473e+04]
E1 = -728.311485624269  E_coul = 201.56541165605353
Extra cycle  E= -526.746073968216  delta_E= -1.14e-12  |g|= 3.41e-07  |ddm|= 2.86e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 95956.57353587539
E1 = -728.311485624269  E_coul = 201.56541165605353
init E= -526.746073968216
    CPU time for initialize scf      0.90 sec, wall time      0.25 sec
  HOMO = -0.582866949097565  LUMO = 1.01741741462023
  mo_energy =
[-1.18579956e+02 -1.23094757e+01 -9.56076290e+00 -9.56076290e+00
 -9.56076290e+00 -1.27000949e+00 -5.82866949e-01 -5.82866949e-01
 -5.82866949e-01  1.01741741e+00  1.01741741e+00  1.01741741e+00
  1.05761790e+00  7.32104427e+00  7.32104427e+00  7.32104427e+00
  1.37111484e+01  3.36452565e+01  3.36452565e+01  3.36452565e+01
  1.23145173e+02  1.30212215e+02  1.30212215e+02  1.30212215e+02
  4.83993091e+02  4.83993091e+02  4.83993091e+02  6.66169601e+02
  1.33025555e+03  1.33025555e+03  1.33025555e+03  2.81244288e+03
  3.01664415e+03  3.01664415e+03  3.01664415e+03  6.63176050e+03
  6.63176050e+03  6.63176050e+03  9.23331956e+03  2.55800750e+04
  7.63093473e+04]
E1 = -728.311485715763  E_coul = 201.56541174754742
cycle= 1 E= -526.746073968216  delta_E=    0  |g|= 7.03e-08  |ddm|= 5.63e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.311485715763  E_coul = 201.56541174754742
  HOMO = -0.582866949507997  LUMO = 1.01741741663742
  mo_energy =
[-1.18579956e+02 -1.23094756e+01 -9.56076289e+00 -9.56076289e+00
 -9.56076289e+00 -1.27000947e+00 -5.82866950e-01 -5.82866950e-01
 -5.82866950e-01  1.01741742e+00  1.01741742e+00  1.01741742e+00
  1.05761791e+00  7.32104427e+00  7.32104427e+00  7.32104427e+00
  1.37111484e+01  3.36452566e+01  3.36452566e+01  3.36452566e+01
  1.23145173e+02  1.30212215e+02  1.30212215e+02  1.30212215e+02
  4.83993091e+02  4.83993091e+02  4.83993091e+02  6.66169601e+02
  1.33025555e+03  1.33025555e+03  1.33025555e+03  2.81244288e+03
  3.01664415e+03  3.01664415e+03  3.01664415e+03  6.63176050e+03
  6.63176050e+03  6.63176050e+03  9.23331956e+03  2.55800750e+04
  7.63093473e+04]
E1 = -728.3114856711712  E_coul = 201.5654117029554
Extra cycle  E= -526.746073968216  delta_E= -2.27e-13  |g|= 1.41e-08  |ddm|= 1.16e-07
    CPU time for scf_cycle      1.03 sec, wall time      0.38 sec
exp = [2.61828541e+04 7.61706575e+03 3.61753445e+03 1.58770188e+03
 4.18499542e+02 1.22779739e+02 3.95451414e+01 8.55457043e+00
 3.37419640e+00 6.81631241e-01 2.52283806e-01 1.36284988e+03
 6.64114135e+02 2.97992823e+02 3.11484529e+02 6.23420151e+01
 7.36413053e+00 2.04090637e+01 7.77528310e-01 2.82490721e+00
 2.23057495e-01]
grad_E = [-1.39847224e-06  2.16816096e-06 -2.14575697e-06  3.73800574e-05
 -4.50887469e-06  6.01349618e-05 -3.98119850e-05  6.81170607e-05
  2.82408302e-04  1.03988335e-03 -9.98930429e-04 -5.71050750e-07
  4.31245189e-06  1.99156370e-05  1.70165103e-05  7.21534501e-05
 -1.30542481e-03  1.93713884e-04  1.48981560e-03  1.32606999e-03
 -3.55874791e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8678477        1
[INPUT] 0    0    [1    /1   ]  7617.04330897        1
[INPUT] 0    0    [1    /1   ]  3617.55447381        1
[INPUT] 0    0    [1    /1   ]  1587.29889004        1
[INPUT] 0    0    [1    /1   ]  418.724366045        1
[INPUT] 0    0    [1    /1   ]  122.854170034        1
[INPUT] 0    0    [1    /1   ]  39.5626126573        1
[INPUT] 0    0    [1    /1   ]  8.55896135051        1
[INPUT] 0    0    [1    /1   ]  3.37576408855        1
[INPUT] 0    0    [1    /1   ]  0.682139669666       1
[INPUT] 0    0    [1    /1   ]  0.252461511036       1
[INPUT] 1    0    [1    /1   ]  1362.85554791        1
[INPUT] 1    0    [1    /1   ]  664.074298256        1
[INPUT] 1    0    [1    /1   ]  297.81059022         1
[INPUT] 1    0    [1    /1   ]  311.328772372        1
[INPUT] 1    0    [1    /1   ]  61.6668880028        1
[INPUT] 1    0    [1    /1   ]  7.29332923352        1
[INPUT] 1    0    [1    /1   ]  20.1880677489        1
[INPUT] 1    0    [1    /1   ]  0.774811995664       1
[INPUT] 1    0    [1    /1   ]  2.80240069588        1
[INPUT] 1    0    [1    /1   ]  0.222494679298       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.867847676418, 1.0]], [0, [7617.043308971371, 1.0]], [0, [3617.554473805202, 1.0]], [0, [1587.2988900403966, 1.0]], [0, [418.7243660446086, 1.0]], [0, [122.85417003359053, 1.0]], [0, [39.56261265729459, 1.0]], [0, [8.558961350505236, 1.0]], [0, [3.37576408854995, 1.0]], [0, [0.6821396696657986, 1.0]], [0, [0.25246151103574904, 1.0]], [1, [1362.8555479069819, 1.0]], [1, [664.0742982555162, 1.0]], [1, [297.8105902202874, 1.0]], [1, [311.3287723718131, 1.0]], [1, [61.66688800280863, 1.0]], [1, [7.293329233518533, 1.0]], [1, [20.188067748905198, 1.0]], [1, [0.7748119956643045, 1.0]], [1, [2.8024006958798475, 1.0]], [1, [0.22249467929813233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.86784768]
bas 1, expnt(s) = [7617.04330897]
bas 2, expnt(s) = [3617.55447381]
bas 3, expnt(s) = [1587.29889004]
bas 4, expnt(s) = [418.72436604]
bas 5, expnt(s) = [122.85417003]
bas 6, expnt(s) = [39.56261266]
bas 7, expnt(s) = [8.55896135]
bas 8, expnt(s) = [3.37576409]
bas 9, expnt(s) = [0.68213967]
bas 10, expnt(s) = [0.25246151]
bas 11, expnt(s) = [1362.85554791]
bas 12, expnt(s) = [664.07429826]
bas 13, expnt(s) = [297.81059022]
bas 14, expnt(s) = [311.32877237]
bas 15, expnt(s) = [61.666888]
bas 16, expnt(s) = [7.29332923]
bas 17, expnt(s) = [20.18806775]
bas 18, expnt(s) = [0.774812]
bas 19, expnt(s) = [2.8024007]
bas 20, expnt(s) = [0.22249468]
CPU time:       537.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828678e+04 5.20029445e+03 7.61704331e+03 2.05994129e+03
 3.61755447e+03 1.17849117e+03 1.58729889e+03 6.35344184e+02
 4.18724366e+02 2.33862829e+02 1.22854170e+02 9.32303793e+01
 3.95626127e+01 3.98546268e+01 8.55896135e+00 1.26424377e+01
 3.37576409e+00 6.29207790e+00 6.82139670e-01 1.89635659e+00
 2.52461511e-01 8.99831945e-01 1.36285555e+03 2.41572045e+04
 6.64074298e+02 9.83456675e+03 2.97810590e+02 3.60918849e+03
 3.11328772e+02 3.81512232e+03 6.16668880e+01 5.04137999e+02
 7.29332923e+00 3.49656548e+01 2.01880677e+01 1.24839734e+02
 7.74811996e-01 2.12070281e+00 2.80240070e+00 1.05778446e+01
 2.22494679e-01 4.45793703e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9934633785214
cond(S) = 94367.34629158676
E1 = -729.5323469334962  E_coul = 203.1803702867311
init E= -526.351976646765
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555803924776161  LUMO = 1.03137248245731
  mo_energy =
[-1.18331985e+02 -1.22046297e+01 -9.44664820e+00 -9.44664820e+00
 -9.44664820e+00 -1.23987774e+00 -5.55803925e-01 -5.55803925e-01
 -5.55803925e-01  1.03137248e+00  1.03137248e+00  1.03137248e+00
  1.08161100e+00  7.32081707e+00  7.32081707e+00  7.32081707e+00
  1.38120592e+01  3.33622174e+01  3.33622174e+01  3.33622174e+01
  1.23418815e+02  1.28822727e+02  1.28822727e+02  1.28822727e+02
  4.81207752e+02  4.81207752e+02  4.81207752e+02  6.66882465e+02
  1.32683787e+03  1.32683787e+03  1.32683787e+03  2.81355577e+03
  3.01281655e+03  3.01281655e+03  3.01281655e+03  6.62792631e+03
  6.62792631e+03  6.62792631e+03  9.23415932e+03  2.55805797e+04
  7.63097479e+04]
E1 = -727.8665524732916  E_coul = 201.12121200820238
cycle= 1 E= -526.745340465089  delta_E= -0.393  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537657
diis-c [-0.28907464  1.        ]
  HOMO = -0.590547989494677  LUMO = 1.00722744286296
  mo_energy =
[-1.18637432e+02 -1.23416392e+01 -9.59418683e+00 -9.59418683e+00
 -9.59418683e+00 -1.27927761e+00 -5.90547989e-01 -5.90547989e-01
 -5.90547989e-01  1.00722744e+00  1.00722744e+00  1.00722744e+00
  1.05165148e+00  7.23070804e+00  7.23070804e+00  7.23070804e+00
  1.36979837e+01  3.32094142e+01  3.32094142e+01  3.32094142e+01
  1.23190312e+02  1.28596113e+02  1.28596113e+02  1.28596113e+02
  4.80904161e+02  4.80904161e+02  4.80904161e+02  6.66531589e+02
  1.32647877e+03  1.32647877e+03  1.32647877e+03  2.81306229e+03
  3.01239204e+03  3.01239204e+03  3.01239204e+03  6.62739002e+03
  6.62739002e+03  6.62739002e+03  9.23354975e+03  2.55798765e+04
  7.63089549e+04]
E1 = -728.4368900374402  E_coul = 201.69084116501548
cycle= 2 E= -526.746048872425  delta_E= -0.000708  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746038
diis-c [-0.00326511  0.08233227  0.91766773]
  HOMO = -0.581484403516899  LUMO = 1.01390079346549
  mo_energy =
[-1.18570214e+02 -1.23038250e+01 -9.55472468e+00 -9.55472468e+00
 -9.55472468e+00 -1.26843032e+00 -5.81484404e-01 -5.81484404e-01
 -5.81484404e-01  1.01390079e+00  1.01390079e+00  1.01390079e+00
  1.06018292e+00  7.25425063e+00  7.25425063e+00  7.25425063e+00
  1.37291615e+01  3.32491762e+01  3.32491762e+01  3.32491762e+01
  1.23247339e+02  1.28651606e+02  1.28651606e+02  1.28651606e+02
  4.80970519e+02  4.80970519e+02  4.80970519e+02  6.66600918e+02
  1.32654916e+03  1.32654916e+03  1.32654916e+03  2.81313606e+03
  3.01246468e+03  3.01246468e+03  3.01246468e+03  6.62746441e+03
  6.62746441e+03  6.62746441e+03  9.23362496e+03  2.55799523e+04
  7.63090310e+04]
E1 = -728.2873202663875  E_coul = 201.54121316359647
cycle= 3 E= -526.746107102791  delta_E= -5.82e-05  |g|= 0.00626  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130915
diis-c [-5.35090561e-07 -1.21818633e-03  1.44954724e-01  8.56263463e-01]
  HOMO = -0.582976619201906  LUMO = 1.01282534619031
  mo_energy =
[-1.18580128e+02 -1.23096112e+01 -9.56085313e+00 -9.56085313e+00
 -9.56085313e+00 -1.27011969e+00 -5.82976619e-01 -5.82976619e-01
 -5.82976619e-01  1.01282535e+00  1.01282535e+00  1.01282535e+00
  1.05887288e+00  7.25049885e+00  7.25049885e+00  7.25049885e+00
  1.37243676e+01  3.32430392e+01  3.32430392e+01  3.32430392e+01
  1.23238866e+02  1.28643296e+02  1.28643296e+02  1.28643296e+02
  4.80960726e+02  4.80960726e+02  4.80960726e+02  6.66590681e+02
  1.32653878e+03  1.32653878e+03  1.32653878e+03  2.81312505e+03
  3.01245392e+03  3.01245392e+03  3.01245392e+03  6.62745326e+03
  6.62745326e+03  6.62745326e+03  9.23361360e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.3100669046115  E_coul = 201.5639578923584
cycle= 4 E= -526.746109012253  delta_E= -1.91e-06  |g|= 9.27e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106306
diis-c [-3.84431830e-09  6.60853709e-05 -9.61444717e-03 -6.22518019e-02
  1.07180016e+00]
  HOMO = -0.582957951992263  LUMO = 1.01284117045993
  mo_energy =
[-1.18580087e+02 -1.23095468e+01 -9.56080149e+00 -9.56080149e+00
 -9.56080149e+00 -1.27007978e+00 -5.82957952e-01 -5.82957952e-01
 -5.82957952e-01  1.01284117e+00  1.01284117e+00  1.01284117e+00
  1.05890713e+00  7.25054069e+00  7.25054069e+00  7.25054069e+00
  1.37244271e+01  3.32430887e+01  3.32430887e+01  3.32430887e+01
  1.23238917e+02  1.28643344e+02  1.28643344e+02  1.28643344e+02
  4.80960768e+02  4.80960768e+02  4.80960768e+02  6.66590714e+02
  1.32653881e+03  1.32653881e+03  1.32653881e+03  2.81312506e+03
  3.01245394e+03  3.01245394e+03  3.01245394e+03  6.62745327e+03
  6.62745327e+03  6.62745327e+03  9.23361360e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.3098571548426  E_coul = 201.5637481411227
cycle= 5 E= -526.74610901372  delta_E= -1.47e-09  |g|= 2e-05  |ddm|= 0.000147
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.80427e-05
diis-c [-6.52775310e-11  1.40106333e-05 -1.84730117e-03 -1.37785483e-02
  4.29474431e-02  9.72664396e-01]
  HOMO = -0.582965051348217  LUMO = 1.01283646902811
  mo_energy =
[-1.18580117e+02 -1.23095685e+01 -9.56082505e+00 -9.56082505e+00
 -9.56082505e+00 -1.27008547e+00 -5.82965051e-01 -5.82965051e-01
 -5.82965051e-01  1.01283647e+00  1.01283647e+00  1.01283647e+00
  1.05890312e+00  7.25052480e+00  7.25052480e+00  7.25052480e+00
  1.37244090e+01  3.32430659e+01  3.32430659e+01  3.32430659e+01
  1.23238890e+02  1.28643317e+02  1.28643317e+02  1.28643317e+02
  4.80960739e+02  4.80960739e+02  4.80960739e+02  6.66590684e+02
  1.32653878e+03  1.32653878e+03  1.32653878e+03  2.81312503e+03
  3.01245391e+03  3.01245391e+03  3.01245391e+03  6.62745324e+03
  6.62745324e+03  6.62745324e+03  9.23361357e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.309936360389  E_coul = 201.56382734661614
cycle= 6 E= -526.746109013773  delta_E= -5.3e-11  |g|= 1.67e-06  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.309936360389  E_coul = 201.56382734661614
  HOMO = -0.582965083425558  LUMO = 1.01283649989012
  mo_energy =
[-1.18580117e+02 -1.23095684e+01 -9.56082507e+00 -9.56082507e+00
 -9.56082507e+00 -1.27008514e+00 -5.82965083e-01 -5.82965083e-01
 -5.82965083e-01  1.01283650e+00  1.01283650e+00  1.01283650e+00
  1.05890344e+00  7.25052481e+00  7.25052481e+00  7.25052481e+00
  1.37244091e+01  3.32430659e+01  3.32430659e+01  3.32430659e+01
  1.23238890e+02  1.28643317e+02  1.28643317e+02  1.28643317e+02
  4.80960739e+02  4.80960739e+02  4.80960739e+02  6.66590684e+02
  1.32653878e+03  1.32653878e+03  1.32653878e+03  2.81312503e+03
  3.01245391e+03  3.01245391e+03  3.01245391e+03  6.62745324e+03
  6.62745324e+03  6.62745324e+03  9.23361357e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.3099357547427  E_coul = 201.56382674096832
Extra cycle  E= -526.746109013774  delta_E= -1.48e-12  |g|= 3.41e-07  |ddm|= 2.86e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828678e+04 7.61704331e+03 3.61755447e+03 1.58729889e+03
 4.18724366e+02 1.22854170e+02 3.95626127e+01 8.55896135e+00
 3.37576409e+00 6.82139670e-01 2.52461511e-01 1.36285555e+03
 6.64074298e+02 2.97810590e+02 3.11328772e+02 6.16668880e+01
 7.29332923e+00 2.01880677e+01 7.74811996e-01 2.80240070e+00
 2.22494679e-01]
E = -526.7461090137743
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8678477        1
[INPUT] 0    0    [1    /1   ]  7617.04330897        1
[INPUT] 0    0    [1    /1   ]  3617.55447381        1
[INPUT] 0    0    [1    /1   ]  1587.29889004        1
[INPUT] 0    0    [1    /1   ]  418.724366045        1
[INPUT] 0    0    [1    /1   ]  122.854170034        1
[INPUT] 0    0    [1    /1   ]  39.5626126573        1
[INPUT] 0    0    [1    /1   ]  8.55896135051        1
[INPUT] 0    0    [1    /1   ]  3.37576408855        1
[INPUT] 0    0    [1    /1   ]  0.682139669666       1
[INPUT] 0    0    [1    /1   ]  0.252461511036       1
[INPUT] 1    0    [1    /1   ]  1362.85554791        1
[INPUT] 1    0    [1    /1   ]  664.074298256        1
[INPUT] 1    0    [1    /1   ]  297.81059022         1
[INPUT] 1    0    [1    /1   ]  311.328772372        1
[INPUT] 1    0    [1    /1   ]  61.6668880028        1
[INPUT] 1    0    [1    /1   ]  7.29332923352        1
[INPUT] 1    0    [1    /1   ]  20.1880677489        1
[INPUT] 1    0    [1    /1   ]  0.774811995664       1
[INPUT] 1    0    [1    /1   ]  2.80240069588        1
[INPUT] 1    0    [1    /1   ]  0.222494679298       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.867847676418, 1.0]], [0, [7617.043308971371, 1.0]], [0, [3617.554473805202, 1.0]], [0, [1587.2988900403966, 1.0]], [0, [418.7243660446086, 1.0]], [0, [122.85417003359053, 1.0]], [0, [39.56261265729459, 1.0]], [0, [8.558961350505236, 1.0]], [0, [3.37576408854995, 1.0]], [0, [0.6821396696657986, 1.0]], [0, [0.25246151103574904, 1.0]], [1, [1362.8555479069819, 1.0]], [1, [664.0742982555162, 1.0]], [1, [297.8105902202874, 1.0]], [1, [311.3287723718131, 1.0]], [1, [61.66688800280863, 1.0]], [1, [7.293329233518533, 1.0]], [1, [20.188067748905198, 1.0]], [1, [0.7748119956643045, 1.0]], [1, [2.8024006958798475, 1.0]], [1, [0.22249467929813233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.86784768]
bas 1, expnt(s) = [7617.04330897]
bas 2, expnt(s) = [3617.55447381]
bas 3, expnt(s) = [1587.29889004]
bas 4, expnt(s) = [418.72436604]
bas 5, expnt(s) = [122.85417003]
bas 6, expnt(s) = [39.56261266]
bas 7, expnt(s) = [8.55896135]
bas 8, expnt(s) = [3.37576409]
bas 9, expnt(s) = [0.68213967]
bas 10, expnt(s) = [0.25246151]
bas 11, expnt(s) = [1362.85554791]
bas 12, expnt(s) = [664.07429826]
bas 13, expnt(s) = [297.81059022]
bas 14, expnt(s) = [311.32877237]
bas 15, expnt(s) = [61.666888]
bas 16, expnt(s) = [7.29332923]
bas 17, expnt(s) = [20.18806775]
bas 18, expnt(s) = [0.774812]
bas 19, expnt(s) = [2.8024007]
bas 20, expnt(s) = [0.22249468]
CPU time:       537.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828678e+04 5.20029445e+03 7.61704331e+03 2.05994129e+03
 3.61755447e+03 1.17849117e+03 1.58729889e+03 6.35344184e+02
 4.18724366e+02 2.33862829e+02 1.22854170e+02 9.32303793e+01
 3.95626127e+01 3.98546268e+01 8.55896135e+00 1.26424377e+01
 3.37576409e+00 6.29207790e+00 6.82139670e-01 1.89635659e+00
 2.52461511e-01 8.99831945e-01 1.36285555e+03 2.41572045e+04
 6.64074298e+02 9.83456675e+03 2.97810590e+02 3.60918849e+03
 3.11328772e+02 3.81512232e+03 6.16668880e+01 5.04137999e+02
 7.29332923e+00 3.49656548e+01 2.01880677e+01 1.24839734e+02
 7.74811996e-01 2.12070281e+00 2.80240070e+00 1.05778446e+01
 2.22494679e-01 4.45793703e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9934633785214
cond(S) = 94367.34629158676
E1 = -729.5323469334962  E_coul = 203.1803702867311
init E= -526.351976646765
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555803924776161  LUMO = 1.03137248245731
  mo_energy =
[-1.18331985e+02 -1.22046297e+01 -9.44664820e+00 -9.44664820e+00
 -9.44664820e+00 -1.23987774e+00 -5.55803925e-01 -5.55803925e-01
 -5.55803925e-01  1.03137248e+00  1.03137248e+00  1.03137248e+00
  1.08161100e+00  7.32081707e+00  7.32081707e+00  7.32081707e+00
  1.38120592e+01  3.33622174e+01  3.33622174e+01  3.33622174e+01
  1.23418815e+02  1.28822727e+02  1.28822727e+02  1.28822727e+02
  4.81207752e+02  4.81207752e+02  4.81207752e+02  6.66882465e+02
  1.32683787e+03  1.32683787e+03  1.32683787e+03  2.81355577e+03
  3.01281655e+03  3.01281655e+03  3.01281655e+03  6.62792631e+03
  6.62792631e+03  6.62792631e+03  9.23415932e+03  2.55805797e+04
  7.63097479e+04]
E1 = -727.8665524732916  E_coul = 201.12121200820238
cycle= 1 E= -526.745340465089  delta_E= -0.393  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537657
diis-c [-0.28907464  1.        ]
  HOMO = -0.590547989494677  LUMO = 1.00722744286296
  mo_energy =
[-1.18637432e+02 -1.23416392e+01 -9.59418683e+00 -9.59418683e+00
 -9.59418683e+00 -1.27927761e+00 -5.90547989e-01 -5.90547989e-01
 -5.90547989e-01  1.00722744e+00  1.00722744e+00  1.00722744e+00
  1.05165148e+00  7.23070804e+00  7.23070804e+00  7.23070804e+00
  1.36979837e+01  3.32094142e+01  3.32094142e+01  3.32094142e+01
  1.23190312e+02  1.28596113e+02  1.28596113e+02  1.28596113e+02
  4.80904161e+02  4.80904161e+02  4.80904161e+02  6.66531589e+02
  1.32647877e+03  1.32647877e+03  1.32647877e+03  2.81306229e+03
  3.01239204e+03  3.01239204e+03  3.01239204e+03  6.62739002e+03
  6.62739002e+03  6.62739002e+03  9.23354975e+03  2.55798765e+04
  7.63089549e+04]
E1 = -728.4368900374402  E_coul = 201.69084116501548
cycle= 2 E= -526.746048872425  delta_E= -0.000708  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746038
diis-c [-0.00326511  0.08233227  0.91766773]
  HOMO = -0.581484403516899  LUMO = 1.01390079346549
  mo_energy =
[-1.18570214e+02 -1.23038250e+01 -9.55472468e+00 -9.55472468e+00
 -9.55472468e+00 -1.26843032e+00 -5.81484404e-01 -5.81484404e-01
 -5.81484404e-01  1.01390079e+00  1.01390079e+00  1.01390079e+00
  1.06018292e+00  7.25425063e+00  7.25425063e+00  7.25425063e+00
  1.37291615e+01  3.32491762e+01  3.32491762e+01  3.32491762e+01
  1.23247339e+02  1.28651606e+02  1.28651606e+02  1.28651606e+02
  4.80970519e+02  4.80970519e+02  4.80970519e+02  6.66600918e+02
  1.32654916e+03  1.32654916e+03  1.32654916e+03  2.81313606e+03
  3.01246468e+03  3.01246468e+03  3.01246468e+03  6.62746441e+03
  6.62746441e+03  6.62746441e+03  9.23362496e+03  2.55799523e+04
  7.63090310e+04]
E1 = -728.2873202663875  E_coul = 201.54121316359647
cycle= 3 E= -526.746107102791  delta_E= -5.82e-05  |g|= 0.00626  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130915
diis-c [-5.35090561e-07 -1.21818633e-03  1.44954724e-01  8.56263463e-01]
  HOMO = -0.582976619201906  LUMO = 1.01282534619031
  mo_energy =
[-1.18580128e+02 -1.23096112e+01 -9.56085313e+00 -9.56085313e+00
 -9.56085313e+00 -1.27011969e+00 -5.82976619e-01 -5.82976619e-01
 -5.82976619e-01  1.01282535e+00  1.01282535e+00  1.01282535e+00
  1.05887288e+00  7.25049885e+00  7.25049885e+00  7.25049885e+00
  1.37243676e+01  3.32430392e+01  3.32430392e+01  3.32430392e+01
  1.23238866e+02  1.28643296e+02  1.28643296e+02  1.28643296e+02
  4.80960726e+02  4.80960726e+02  4.80960726e+02  6.66590681e+02
  1.32653878e+03  1.32653878e+03  1.32653878e+03  2.81312505e+03
  3.01245392e+03  3.01245392e+03  3.01245392e+03  6.62745326e+03
  6.62745326e+03  6.62745326e+03  9.23361360e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.3100669046115  E_coul = 201.5639578923584
cycle= 4 E= -526.746109012253  delta_E= -1.91e-06  |g|= 9.27e-05  |ddm|= 0.00228
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106306
diis-c [-3.84431830e-09  6.60853709e-05 -9.61444717e-03 -6.22518019e-02
  1.07180016e+00]
  HOMO = -0.582957951992263  LUMO = 1.01284117045993
  mo_energy =
[-1.18580087e+02 -1.23095468e+01 -9.56080149e+00 -9.56080149e+00
 -9.56080149e+00 -1.27007978e+00 -5.82957952e-01 -5.82957952e-01
 -5.82957952e-01  1.01284117e+00  1.01284117e+00  1.01284117e+00
  1.05890713e+00  7.25054069e+00  7.25054069e+00  7.25054069e+00
  1.37244271e+01  3.32430887e+01  3.32430887e+01  3.32430887e+01
  1.23238917e+02  1.28643344e+02  1.28643344e+02  1.28643344e+02
  4.80960768e+02  4.80960768e+02  4.80960768e+02  6.66590714e+02
  1.32653881e+03  1.32653881e+03  1.32653881e+03  2.81312506e+03
  3.01245394e+03  3.01245394e+03  3.01245394e+03  6.62745327e+03
  6.62745327e+03  6.62745327e+03  9.23361360e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.3098571548426  E_coul = 201.5637481411227
cycle= 5 E= -526.74610901372  delta_E= -1.47e-09  |g|= 2e-05  |ddm|= 0.000147
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.80427e-05
diis-c [-6.52775310e-11  1.40106333e-05 -1.84730117e-03 -1.37785483e-02
  4.29474431e-02  9.72664396e-01]
  HOMO = -0.582965051348217  LUMO = 1.01283646902811
  mo_energy =
[-1.18580117e+02 -1.23095685e+01 -9.56082505e+00 -9.56082505e+00
 -9.56082505e+00 -1.27008547e+00 -5.82965051e-01 -5.82965051e-01
 -5.82965051e-01  1.01283647e+00  1.01283647e+00  1.01283647e+00
  1.05890312e+00  7.25052480e+00  7.25052480e+00  7.25052480e+00
  1.37244090e+01  3.32430659e+01  3.32430659e+01  3.32430659e+01
  1.23238890e+02  1.28643317e+02  1.28643317e+02  1.28643317e+02
  4.80960739e+02  4.80960739e+02  4.80960739e+02  6.66590684e+02
  1.32653878e+03  1.32653878e+03  1.32653878e+03  2.81312503e+03
  3.01245391e+03  3.01245391e+03  3.01245391e+03  6.62745324e+03
  6.62745324e+03  6.62745324e+03  9.23361357e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.309936360389  E_coul = 201.56382734661614
cycle= 6 E= -526.746109013773  delta_E= -5.3e-11  |g|= 1.67e-06  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.309936360389  E_coul = 201.56382734661614
  HOMO = -0.582965083425558  LUMO = 1.01283649989012
  mo_energy =
[-1.18580117e+02 -1.23095684e+01 -9.56082507e+00 -9.56082507e+00
 -9.56082507e+00 -1.27008514e+00 -5.82965083e-01 -5.82965083e-01
 -5.82965083e-01  1.01283650e+00  1.01283650e+00  1.01283650e+00
  1.05890344e+00  7.25052481e+00  7.25052481e+00  7.25052481e+00
  1.37244091e+01  3.32430659e+01  3.32430659e+01  3.32430659e+01
  1.23238890e+02  1.28643317e+02  1.28643317e+02  1.28643317e+02
  4.80960739e+02  4.80960739e+02  4.80960739e+02  6.66590684e+02
  1.32653878e+03  1.32653878e+03  1.32653878e+03  2.81312503e+03
  3.01245391e+03  3.01245391e+03  3.01245391e+03  6.62745324e+03
  6.62745324e+03  6.62745324e+03  9.23361357e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.3099357547427  E_coul = 201.56382674096832
Extra cycle  E= -526.746109013774  delta_E= -1.48e-12  |g|= 3.41e-07  |ddm|= 2.86e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 94367.34629158676
E1 = -728.3099357547427  E_coul = 201.56382674096832
init E= -526.746109013774
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582965105018202  LUMO = 1.01283649578248
  mo_energy =
[-1.18580117e+02 -1.23095684e+01 -9.56082513e+00 -9.56082513e+00
 -9.56082513e+00 -1.27008509e+00 -5.82965105e-01 -5.82965105e-01
 -5.82965105e-01  1.01283650e+00  1.01283650e+00  1.01283650e+00
  1.05890350e+00  7.25052477e+00  7.25052477e+00  7.25052477e+00
  1.37244091e+01  3.32430658e+01  3.32430658e+01  3.32430658e+01
  1.23238890e+02  1.28643317e+02  1.28643317e+02  1.28643317e+02
  4.80960739e+02  4.80960739e+02  4.80960739e+02  6.66590684e+02
  1.32653878e+03  1.32653878e+03  1.32653878e+03  2.81312503e+03
  3.01245391e+03  3.01245391e+03  3.01245391e+03  6.62745323e+03
  6.62745323e+03  6.62745323e+03  9.23361357e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.3099358354829  E_coul = 201.56382682170928
cycle= 1 E= -526.746109013774  delta_E= 7.96e-13  |g|= 7.02e-08  |ddm|= 5.63e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3099358354829  E_coul = 201.56382682170928
  HOMO = -0.582965105601329  LUMO = 1.0128364976754
  mo_energy =
[-1.18580117e+02 -1.23095684e+01 -9.56082513e+00 -9.56082513e+00
 -9.56082513e+00 -1.27008507e+00 -5.82965106e-01 -5.82965106e-01
 -5.82965106e-01  1.01283650e+00  1.01283650e+00  1.01283650e+00
  1.05890351e+00  7.25052477e+00  7.25052477e+00  7.25052477e+00
  1.37244091e+01  3.32430658e+01  3.32430658e+01  3.32430658e+01
  1.23238890e+02  1.28643317e+02  1.28643317e+02  1.28643317e+02
  4.80960739e+02  4.80960739e+02  4.80960739e+02  6.66590684e+02
  1.32653878e+03  1.32653878e+03  1.32653878e+03  2.81312503e+03
  3.01245391e+03  3.01245391e+03  3.01245391e+03  6.62745323e+03
  6.62745323e+03  6.62745323e+03  9.23361357e+03  2.55799407e+04
  7.63090193e+04]
E1 = -728.3099357943197  E_coul = 201.56382678054678
Extra cycle  E= -526.746109013773  delta_E= 6.82e-13  |g|= 1.41e-08  |ddm|= 1.16e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828678e+04 7.61704331e+03 3.61755447e+03 1.58729889e+03
 4.18724366e+02 1.22854170e+02 3.95626127e+01 8.55896135e+00
 3.37576409e+00 6.82139670e-01 2.52461511e-01 1.36285555e+03
 6.64074298e+02 2.97810590e+02 3.11328772e+02 6.16668880e+01
 7.29332923e+00 2.01880677e+01 7.74811996e-01 2.80240070e+00
 2.22494679e-01]
grad_E = [-1.39732797e-06  2.15875830e-06 -2.14809642e-06  3.71413844e-05
 -3.23759497e-06  6.23445370e-05 -4.02509339e-05  7.25550409e-05
  2.88712299e-04  1.11118818e-03 -1.07754166e-03 -5.43117670e-07
  4.71171428e-06  2.21394233e-05  1.89322624e-05  3.26974726e-05
 -1.33388676e-03  1.92450295e-04  1.52998817e-03  1.36640416e-03
 -3.66532128e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8782639        1
[INPUT] 0    0    [1    /1   ]  7617.02630699        1
[INPUT] 0    0    [1    /1   ]  3617.5696903         1
[INPUT] 0    0    [1    /1   ]  1586.99375612        1
[INPUT] 0    0    [1    /1   ]  418.907614081        1
[INPUT] 0    0    [1    /1   ]  122.82539644         1
[INPUT] 0    0    [1    /1   ]  39.5419484572        1
[INPUT] 0    0    [1    /1   ]  8.53784651557        1
[INPUT] 0    0    [1    /1   ]  3.3687992251         1
[INPUT] 0    0    [1    /1   ]  0.679197270115       1
[INPUT] 0    0    [1    /1   ]  0.251484422645       1
[INPUT] 1    0    [1    /1   ]  1362.85985479        1
[INPUT] 1    0    [1    /1   ]  664.044122408        1
[INPUT] 1    0    [1    /1   ]  297.672611876        1
[INPUT] 1    0    [1    /1   ]  311.210847973        1
[INPUT] 1    0    [1    /1   ]  61.138891939         1
[INPUT] 1    0    [1    /1   ]  7.26002169847        1
[INPUT] 1    0    [1    /1   ]  20.0487369205        1
[INPUT] 1    0    [1    /1   ]  0.773240072504       1
[INPUT] 1    0    [1    /1   ]  2.79119272646        1
[INPUT] 1    0    [1    /1   ]  0.222198225181       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.8782638961, 1.0]], [0, [7617.026306989945, 1.0]], [0, [3617.5696902965487, 1.0]], [0, [1586.9937561233749, 1.0]], [0, [418.9076140806144, 1.0]], [0, [122.8253964403436, 1.0]], [0, [39.54194845724787, 1.0]], [0, [8.537846515570399, 1.0]], [0, [3.368799225099905, 1.0]], [0, [0.679197270114534, 1.0]], [0, [0.25148442264483467, 1.0]], [1, [1362.8598547861598, 1.0]], [1, [664.0441224078473, 1.0]], [1, [297.67261187574087, 1.0]], [1, [311.21084797295515, 1.0]], [1, [61.13889193901978, 1.0]], [1, [7.2600216984744055, 1.0]], [1, [20.04873692048315, 1.0]], [1, [0.773240072503617, 1.0]], [1, [2.791192726461528, 1.0]], [1, [0.22219822518070567, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8782639]
bas 1, expnt(s) = [7617.02630699]
bas 2, expnt(s) = [3617.5696903]
bas 3, expnt(s) = [1586.99375612]
bas 4, expnt(s) = [418.90761408]
bas 5, expnt(s) = [122.82539644]
bas 6, expnt(s) = [39.54194846]
bas 7, expnt(s) = [8.53784652]
bas 8, expnt(s) = [3.36879923]
bas 9, expnt(s) = [0.67919727]
bas 10, expnt(s) = [0.25148442]
bas 11, expnt(s) = [1362.85985479]
bas 12, expnt(s) = [664.04412241]
bas 13, expnt(s) = [297.67261188]
bas 14, expnt(s) = [311.21084797]
bas 15, expnt(s) = [61.13889194]
bas 16, expnt(s) = [7.2600217]
bas 17, expnt(s) = [20.04873692]
bas 18, expnt(s) = [0.77324007]
bas 19, expnt(s) = [2.79119273]
bas 20, expnt(s) = [0.22219823]
CPU time:       543.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828783e+04 5.20029600e+03 7.61702631e+03 2.05993784e+03
 3.61756969e+03 1.17849489e+03 1.58699376e+03 6.35252580e+02
 4.18907614e+02 2.33939585e+02 1.22825396e+02 9.32140022e+01
 3.95419485e+01 3.98390133e+01 8.53784652e+00 1.26190390e+01
 3.36879923e+00 6.28233904e+00 6.79197270e-01 1.89021834e+00
 2.51484423e-01 8.97218751e-01 1.36285985e+03 2.41572999e+04
 6.64044122e+02 9.83400815e+03 2.97672612e+02 3.60709840e+03
 3.11210848e+02 3.81331605e+03 6.11388919e+01 4.98748206e+02
 7.26002170e+00 3.47661653e+01 2.00487369e+01 1.23763666e+02
 7.73240073e-01 2.11532613e+00 2.79119273e+00 1.05249896e+01
 2.22198225e-01 4.45051352e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99353077929518
cond(S) = 93187.33973634572
E1 = -729.5320280175125  E_coul = 203.180161986897
init E= -526.351866030615
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555813958963437  LUMO = 1.02881254990536
  mo_energy =
[-1.18331984e+02 -1.22046674e+01 -9.44665855e+00 -9.44665855e+00
 -9.44665855e+00 -1.23989943e+00 -5.55813959e-01 -5.55813959e-01
 -5.55813959e-01  1.02881255e+00  1.02881255e+00  1.02881255e+00
  1.07392583e+00  7.28508272e+00  7.28508272e+00  7.28508272e+00
  1.37491463e+01  3.31472462e+01  3.31472462e+01  3.31472462e+01
  1.23234683e+02  1.27786060e+02  1.27786060e+02  1.27786060e+02
  4.79032341e+02  4.79032341e+02  4.79032341e+02  6.66733849e+02
  1.32412542e+03  1.32412542e+03  1.32412542e+03  2.81355432e+03
  3.00973675e+03  3.00973675e+03  3.00973675e+03  6.62474946e+03
  6.62474946e+03  6.62474946e+03  9.23388930e+03  2.55800090e+04
  7.63090615e+04]
E1 = -727.8647153085432  E_coul = 201.11934924492775
cycle= 1 E= -526.745366063615  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537496
diis-c [-0.28890171  1.        ]
  HOMO = -0.590594872918682  LUMO = 1.00470594391299
  mo_energy =
[-1.18637630e+02 -1.23417944e+01 -9.59431772e+00 -9.59431772e+00
 -9.59431772e+00 -1.27933579e+00 -5.90594873e-01 -5.90594873e-01
 -5.90594873e-01  1.00470594e+00  1.00470594e+00  1.00470594e+00
  1.04410065e+00  7.19516355e+00  7.19516355e+00  7.19516355e+00
  1.36351408e+01  3.29947262e+01  3.29947262e+01  3.29947262e+01
  1.23006068e+02  1.27559787e+02  1.27559787e+02  1.27559787e+02
  4.78728611e+02  4.78728611e+02  4.78728611e+02  6.66382741e+02
  1.32376610e+03  1.32376610e+03  1.32376610e+03  2.81306059e+03
  3.00931197e+03  3.00931197e+03  3.00931197e+03  6.62421290e+03
  6.62421290e+03  6.62421290e+03  9.23327947e+03  2.55793055e+04
  7.63082683e+04]
E1 = -728.4356142008718  E_coul = 201.68953873828158
cycle= 2 E= -526.74607546259  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746521
diis-c [-0.00326712  0.08244054  0.91755946]
  HOMO = -0.581519553385342  LUMO = 1.01136855341108
  mo_energy =
[-1.18570366e+02 -1.23039477e+01 -9.55482260e+00 -9.55482260e+00
 -9.55482260e+00 -1.26847516e+00 -5.81519553e-01 -5.81519553e-01
 -5.81519553e-01  1.01136855e+00  1.01136855e+00  1.01136855e+00
  1.05259735e+00  7.21865985e+00  7.21865985e+00  7.21865985e+00
  1.36663041e+01  3.30344230e+01  3.30344230e+01  3.30344230e+01
  1.23063131e+02  1.27615228e+02  1.27615228e+02  1.27615228e+02
  4.78795007e+02  4.78795007e+02  4.78795007e+02  6.66452119e+02
  1.32383654e+03  1.32383654e+03  1.32383654e+03  2.81313441e+03
  3.00938466e+03  3.00938466e+03  3.00938466e+03  6.62428734e+03
  6.62428734e+03  6.62428734e+03  9.23335473e+03  2.55793813e+04
  7.63083445e+04]
E1 = -728.2858936709717  E_coul = 201.539759872922
cycle= 3 E= -526.74613379805  delta_E= -5.83e-05  |g|= 0.00626  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130934
diis-c [-5.35457109e-07 -1.21801252e-03  1.44892640e-01  8.56325372e-01]
  HOMO = -0.583012849509395  LUMO = 1.01029546058827
  mo_energy =
[-1.18580282e+02 -1.23097360e+01 -9.56095322e+00 -9.56095322e+00
 -9.56095322e+00 -1.27016551e+00 -5.83012850e-01 -5.83012850e-01
 -5.83012850e-01  1.01029546e+00  1.01029546e+00  1.01029546e+00
  1.05129354e+00  7.21491707e+00  7.21491707e+00  7.21491707e+00
  1.36615147e+01  3.30282976e+01  3.30282976e+01  3.30282976e+01
  1.23054656e+02  1.27606928e+02  1.27606928e+02  1.27606928e+02
  4.78785214e+02  4.78785214e+02  4.78785214e+02  6.66441880e+02
  1.32382616e+03  1.32382616e+03  1.32382616e+03  2.81312340e+03
  3.00937390e+03  3.00937390e+03  3.00937390e+03  6.62427618e+03
  6.62427618e+03  6.62427618e+03  9.23334336e+03  2.55793698e+04
  7.63083328e+04]
E1 = -728.3086506971423  E_coul = 201.56251498843213
cycle= 4 E= -526.74613570871  delta_E= -1.91e-06  |g|= 9.29e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106547
diis-c [-3.85235325e-09  6.62558880e-05 -9.63459533e-03 -6.24163366e-02
  1.07198468e+00]
  HOMO = -0.582994247373598  LUMO = 1.01031120908291
  mo_energy =
[-1.18580241e+02 -1.23096718e+01 -9.56090176e+00 -9.56090176e+00
 -9.56090176e+00 -1.27012562e+00 -5.82994247e-01 -5.82994247e-01
 -5.82994247e-01  1.01031121e+00  1.01031121e+00  1.01031121e+00
  1.05132764e+00  7.21495873e+00  7.21495873e+00  7.21495873e+00
  1.36615741e+01  3.30283471e+01  3.30283471e+01  3.30283471e+01
  1.23054707e+02  1.27606976e+02  1.27606976e+02  1.27606976e+02
  4.78785255e+02  4.78785255e+02  4.78785255e+02  6.66441913e+02
  1.32382619e+03  1.32382619e+03  1.32382619e+03  2.81312341e+03
  3.00937392e+03  3.00937392e+03  3.00937392e+03  6.62427619e+03
  6.62427619e+03  6.62427619e+03  9.23334337e+03  2.55793698e+04
  7.63083328e+04]
E1 = -728.3084412164051  E_coul = 201.56230550621916
cycle= 5 E= -526.746135710186  delta_E= -1.48e-09  |g|= 2e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8048e-05
diis-c [-6.56256127e-11  1.40490683e-05 -1.85116665e-03 -1.38065725e-02
  4.28456848e-02  9.72798005e-01]
  HOMO = -0.583001356841084  LUMO = 1.01030651578923
  mo_energy =
[-1.18580271e+02 -1.23096935e+01 -9.56092533e+00 -9.56092533e+00
 -9.56092533e+00 -1.27013131e+00 -5.83001357e-01 -5.83001357e-01
 -5.83001357e-01  1.01030652e+00  1.01030652e+00  1.01030652e+00
  1.05132366e+00  7.21494287e+00  7.21494287e+00  7.21494287e+00
  1.36615560e+01  3.30283242e+01  3.30283242e+01  3.30283242e+01
  1.23054680e+02  1.27606949e+02  1.27606949e+02  1.27606949e+02
  4.78785226e+02  4.78785226e+02  4.78785226e+02  6.66441883e+02
  1.32382616e+03  1.32382616e+03  1.32382616e+03  2.81312338e+03
  3.00937389e+03  3.00937389e+03  3.00937389e+03  6.62427616e+03
  6.62427616e+03  6.62427616e+03  9.23334333e+03  2.55793697e+04
  7.63083328e+04]
E1 = -728.3085204151469  E_coul = 201.56238470490757
cycle= 6 E= -526.746135710239  delta_E= -5.34e-11  |g|= 1.67e-06  |ddm|= 1.74e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3085204151469  E_coul = 201.56238470490757
  HOMO = -0.583001389224541  LUMO = 1.01030654664551
  mo_energy =
[-1.18580271e+02 -1.23096934e+01 -9.56092535e+00 -9.56092535e+00
 -9.56092535e+00 -1.27013098e+00 -5.83001389e-01 -5.83001389e-01
 -5.83001389e-01  1.01030655e+00  1.01030655e+00  1.01030655e+00
  1.05132398e+00  7.21494288e+00  7.21494288e+00  7.21494288e+00
  1.36615562e+01  3.30283242e+01  3.30283242e+01  3.30283242e+01
  1.23054680e+02  1.27606950e+02  1.27606950e+02  1.27606950e+02
  4.78785226e+02  4.78785226e+02  4.78785226e+02  6.66441883e+02
  1.32382616e+03  1.32382616e+03  1.32382616e+03  2.81312338e+03
  3.00937389e+03  3.00937389e+03  3.00937389e+03  6.62427616e+03
  6.62427616e+03  6.62427616e+03  9.23334333e+03  2.55793697e+04
  7.63083328e+04]
E1 = -728.3085197960195  E_coul = 201.56238408578025
Extra cycle  E= -526.746135710239  delta_E=    0  |g|= 3.42e-07  |ddm|= 2.87e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
exp = [2.61828783e+04 7.61702631e+03 3.61756969e+03 1.58699376e+03
 4.18907614e+02 1.22825396e+02 3.95419485e+01 8.53784652e+00
 3.36879923e+00 6.79197270e-01 2.51484423e-01 1.36285985e+03
 6.64044122e+02 2.97672612e+02 3.11210848e+02 6.11388919e+01
 7.26002170e+00 2.00487369e+01 7.73240073e-01 2.79119273e+00
 2.22198225e-01]
E = -526.7461357102393
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8782639        1
[INPUT] 0    0    [1    /1   ]  7617.02630699        1
[INPUT] 0    0    [1    /1   ]  3617.5696903         1
[INPUT] 0    0    [1    /1   ]  1586.99375612        1
[INPUT] 0    0    [1    /1   ]  418.907614081        1
[INPUT] 0    0    [1    /1   ]  122.82539644         1
[INPUT] 0    0    [1    /1   ]  39.5419484572        1
[INPUT] 0    0    [1    /1   ]  8.53784651557        1
[INPUT] 0    0    [1    /1   ]  3.3687992251         1
[INPUT] 0    0    [1    /1   ]  0.679197270115       1
[INPUT] 0    0    [1    /1   ]  0.251484422645       1
[INPUT] 1    0    [1    /1   ]  1362.85985479        1
[INPUT] 1    0    [1    /1   ]  664.044122408        1
[INPUT] 1    0    [1    /1   ]  297.672611876        1
[INPUT] 1    0    [1    /1   ]  311.210847973        1
[INPUT] 1    0    [1    /1   ]  61.138891939         1
[INPUT] 1    0    [1    /1   ]  7.26002169847        1
[INPUT] 1    0    [1    /1   ]  20.0487369205        1
[INPUT] 1    0    [1    /1   ]  0.773240072504       1
[INPUT] 1    0    [1    /1   ]  2.79119272646        1
[INPUT] 1    0    [1    /1   ]  0.222198225181       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.8782638961, 1.0]], [0, [7617.026306989945, 1.0]], [0, [3617.5696902965487, 1.0]], [0, [1586.9937561233749, 1.0]], [0, [418.9076140806144, 1.0]], [0, [122.8253964403436, 1.0]], [0, [39.54194845724787, 1.0]], [0, [8.537846515570399, 1.0]], [0, [3.368799225099905, 1.0]], [0, [0.679197270114534, 1.0]], [0, [0.25148442264483467, 1.0]], [1, [1362.8598547861598, 1.0]], [1, [664.0441224078473, 1.0]], [1, [297.67261187574087, 1.0]], [1, [311.21084797295515, 1.0]], [1, [61.13889193901978, 1.0]], [1, [7.2600216984744055, 1.0]], [1, [20.04873692048315, 1.0]], [1, [0.773240072503617, 1.0]], [1, [2.791192726461528, 1.0]], [1, [0.22219822518070567, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8782639]
bas 1, expnt(s) = [7617.02630699]
bas 2, expnt(s) = [3617.5696903]
bas 3, expnt(s) = [1586.99375612]
bas 4, expnt(s) = [418.90761408]
bas 5, expnt(s) = [122.82539644]
bas 6, expnt(s) = [39.54194846]
bas 7, expnt(s) = [8.53784652]
bas 8, expnt(s) = [3.36879923]
bas 9, expnt(s) = [0.67919727]
bas 10, expnt(s) = [0.25148442]
bas 11, expnt(s) = [1362.85985479]
bas 12, expnt(s) = [664.04412241]
bas 13, expnt(s) = [297.67261188]
bas 14, expnt(s) = [311.21084797]
bas 15, expnt(s) = [61.13889194]
bas 16, expnt(s) = [7.2600217]
bas 17, expnt(s) = [20.04873692]
bas 18, expnt(s) = [0.77324007]
bas 19, expnt(s) = [2.79119273]
bas 20, expnt(s) = [0.22219823]
CPU time:       544.45
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828783e+04 5.20029600e+03 7.61702631e+03 2.05993784e+03
 3.61756969e+03 1.17849489e+03 1.58699376e+03 6.35252580e+02
 4.18907614e+02 2.33939585e+02 1.22825396e+02 9.32140022e+01
 3.95419485e+01 3.98390133e+01 8.53784652e+00 1.26190390e+01
 3.36879923e+00 6.28233904e+00 6.79197270e-01 1.89021834e+00
 2.51484423e-01 8.97218751e-01 1.36285985e+03 2.41572999e+04
 6.64044122e+02 9.83400815e+03 2.97672612e+02 3.60709840e+03
 3.11210848e+02 3.81331605e+03 6.11388919e+01 4.98748206e+02
 7.26002170e+00 3.47661653e+01 2.00487369e+01 1.23763666e+02
 7.73240073e-01 2.11532613e+00 2.79119273e+00 1.05249896e+01
 2.22198225e-01 4.45051352e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99353077929518
cond(S) = 93187.33973634572
E1 = -729.5320280175125  E_coul = 203.180161986897
init E= -526.351866030615
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555813958963437  LUMO = 1.02881254990536
  mo_energy =
[-1.18331984e+02 -1.22046674e+01 -9.44665855e+00 -9.44665855e+00
 -9.44665855e+00 -1.23989943e+00 -5.55813959e-01 -5.55813959e-01
 -5.55813959e-01  1.02881255e+00  1.02881255e+00  1.02881255e+00
  1.07392583e+00  7.28508272e+00  7.28508272e+00  7.28508272e+00
  1.37491463e+01  3.31472462e+01  3.31472462e+01  3.31472462e+01
  1.23234683e+02  1.27786060e+02  1.27786060e+02  1.27786060e+02
  4.79032341e+02  4.79032341e+02  4.79032341e+02  6.66733849e+02
  1.32412542e+03  1.32412542e+03  1.32412542e+03  2.81355432e+03
  3.00973675e+03  3.00973675e+03  3.00973675e+03  6.62474946e+03
  6.62474946e+03  6.62474946e+03  9.23388930e+03  2.55800090e+04
  7.63090615e+04]
E1 = -727.8647153085432  E_coul = 201.11934924492775
cycle= 1 E= -526.745366063615  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537496
diis-c [-0.28890171  1.        ]
  HOMO = -0.590594872918682  LUMO = 1.00470594391299
  mo_energy =
[-1.18637630e+02 -1.23417944e+01 -9.59431772e+00 -9.59431772e+00
 -9.59431772e+00 -1.27933579e+00 -5.90594873e-01 -5.90594873e-01
 -5.90594873e-01  1.00470594e+00  1.00470594e+00  1.00470594e+00
  1.04410065e+00  7.19516355e+00  7.19516355e+00  7.19516355e+00
  1.36351408e+01  3.29947262e+01  3.29947262e+01  3.29947262e+01
  1.23006068e+02  1.27559787e+02  1.27559787e+02  1.27559787e+02
  4.78728611e+02  4.78728611e+02  4.78728611e+02  6.66382741e+02
  1.32376610e+03  1.32376610e+03  1.32376610e+03  2.81306059e+03
  3.00931197e+03  3.00931197e+03  3.00931197e+03  6.62421290e+03
  6.62421290e+03  6.62421290e+03  9.23327947e+03  2.55793055e+04
  7.63082683e+04]
E1 = -728.4356142008718  E_coul = 201.68953873828158
cycle= 2 E= -526.74607546259  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746521
diis-c [-0.00326712  0.08244054  0.91755946]
  HOMO = -0.581519553385342  LUMO = 1.01136855341108
  mo_energy =
[-1.18570366e+02 -1.23039477e+01 -9.55482260e+00 -9.55482260e+00
 -9.55482260e+00 -1.26847516e+00 -5.81519553e-01 -5.81519553e-01
 -5.81519553e-01  1.01136855e+00  1.01136855e+00  1.01136855e+00
  1.05259735e+00  7.21865985e+00  7.21865985e+00  7.21865985e+00
  1.36663041e+01  3.30344230e+01  3.30344230e+01  3.30344230e+01
  1.23063131e+02  1.27615228e+02  1.27615228e+02  1.27615228e+02
  4.78795007e+02  4.78795007e+02  4.78795007e+02  6.66452119e+02
  1.32383654e+03  1.32383654e+03  1.32383654e+03  2.81313441e+03
  3.00938466e+03  3.00938466e+03  3.00938466e+03  6.62428734e+03
  6.62428734e+03  6.62428734e+03  9.23335473e+03  2.55793813e+04
  7.63083445e+04]
E1 = -728.2858936709717  E_coul = 201.539759872922
cycle= 3 E= -526.74613379805  delta_E= -5.83e-05  |g|= 0.00626  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130934
diis-c [-5.35457109e-07 -1.21801252e-03  1.44892640e-01  8.56325372e-01]
  HOMO = -0.583012849509395  LUMO = 1.01029546058827
  mo_energy =
[-1.18580282e+02 -1.23097360e+01 -9.56095322e+00 -9.56095322e+00
 -9.56095322e+00 -1.27016551e+00 -5.83012850e-01 -5.83012850e-01
 -5.83012850e-01  1.01029546e+00  1.01029546e+00  1.01029546e+00
  1.05129354e+00  7.21491707e+00  7.21491707e+00  7.21491707e+00
  1.36615147e+01  3.30282976e+01  3.30282976e+01  3.30282976e+01
  1.23054656e+02  1.27606928e+02  1.27606928e+02  1.27606928e+02
  4.78785214e+02  4.78785214e+02  4.78785214e+02  6.66441880e+02
  1.32382616e+03  1.32382616e+03  1.32382616e+03  2.81312340e+03
  3.00937390e+03  3.00937390e+03  3.00937390e+03  6.62427618e+03
  6.62427618e+03  6.62427618e+03  9.23334336e+03  2.55793698e+04
  7.63083328e+04]
E1 = -728.3086506971423  E_coul = 201.56251498843213
cycle= 4 E= -526.74613570871  delta_E= -1.91e-06  |g|= 9.29e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106547
diis-c [-3.85235325e-09  6.62558880e-05 -9.63459533e-03 -6.24163366e-02
  1.07198468e+00]
  HOMO = -0.582994247373598  LUMO = 1.01031120908291
  mo_energy =
[-1.18580241e+02 -1.23096718e+01 -9.56090176e+00 -9.56090176e+00
 -9.56090176e+00 -1.27012562e+00 -5.82994247e-01 -5.82994247e-01
 -5.82994247e-01  1.01031121e+00  1.01031121e+00  1.01031121e+00
  1.05132764e+00  7.21495873e+00  7.21495873e+00  7.21495873e+00
  1.36615741e+01  3.30283471e+01  3.30283471e+01  3.30283471e+01
  1.23054707e+02  1.27606976e+02  1.27606976e+02  1.27606976e+02
  4.78785255e+02  4.78785255e+02  4.78785255e+02  6.66441913e+02
  1.32382619e+03  1.32382619e+03  1.32382619e+03  2.81312341e+03
  3.00937392e+03  3.00937392e+03  3.00937392e+03  6.62427619e+03
  6.62427619e+03  6.62427619e+03  9.23334337e+03  2.55793698e+04
  7.63083328e+04]
E1 = -728.3084412164051  E_coul = 201.56230550621916
cycle= 5 E= -526.746135710186  delta_E= -1.48e-09  |g|= 2e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.8048e-05
diis-c [-6.56256127e-11  1.40490683e-05 -1.85116665e-03 -1.38065725e-02
  4.28456848e-02  9.72798005e-01]
  HOMO = -0.583001356841084  LUMO = 1.01030651578923
  mo_energy =
[-1.18580271e+02 -1.23096935e+01 -9.56092533e+00 -9.56092533e+00
 -9.56092533e+00 -1.27013131e+00 -5.83001357e-01 -5.83001357e-01
 -5.83001357e-01  1.01030652e+00  1.01030652e+00  1.01030652e+00
  1.05132366e+00  7.21494287e+00  7.21494287e+00  7.21494287e+00
  1.36615560e+01  3.30283242e+01  3.30283242e+01  3.30283242e+01
  1.23054680e+02  1.27606949e+02  1.27606949e+02  1.27606949e+02
  4.78785226e+02  4.78785226e+02  4.78785226e+02  6.66441883e+02
  1.32382616e+03  1.32382616e+03  1.32382616e+03  2.81312338e+03
  3.00937389e+03  3.00937389e+03  3.00937389e+03  6.62427616e+03
  6.62427616e+03  6.62427616e+03  9.23334333e+03  2.55793697e+04
  7.63083328e+04]
E1 = -728.3085204151469  E_coul = 201.56238470490757
cycle= 6 E= -526.746135710239  delta_E= -5.34e-11  |g|= 1.67e-06  |ddm|= 1.74e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3085204151469  E_coul = 201.56238470490757
  HOMO = -0.583001389224541  LUMO = 1.01030654664551
  mo_energy =
[-1.18580271e+02 -1.23096934e+01 -9.56092535e+00 -9.56092535e+00
 -9.56092535e+00 -1.27013098e+00 -5.83001389e-01 -5.83001389e-01
 -5.83001389e-01  1.01030655e+00  1.01030655e+00  1.01030655e+00
  1.05132398e+00  7.21494288e+00  7.21494288e+00  7.21494288e+00
  1.36615562e+01  3.30283242e+01  3.30283242e+01  3.30283242e+01
  1.23054680e+02  1.27606950e+02  1.27606950e+02  1.27606950e+02
  4.78785226e+02  4.78785226e+02  4.78785226e+02  6.66441883e+02
  1.32382616e+03  1.32382616e+03  1.32382616e+03  2.81312338e+03
  3.00937389e+03  3.00937389e+03  3.00937389e+03  6.62427616e+03
  6.62427616e+03  6.62427616e+03  9.23334333e+03  2.55793697e+04
  7.63083328e+04]
E1 = -728.3085197960195  E_coul = 201.56238408578025
Extra cycle  E= -526.746135710239  delta_E=    0  |g|= 3.42e-07  |ddm|= 2.87e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93187.33973634572
E1 = -728.3085197960195  E_coul = 201.56238408578025
init E= -526.746135710239
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.58300141120857  LUMO = 1.01030654234087
  mo_energy =
[-1.18580271e+02 -1.23096934e+01 -9.56092541e+00 -9.56092541e+00
 -9.56092541e+00 -1.27013093e+00 -5.83001411e-01 -5.83001411e-01
 -5.83001411e-01  1.01030654e+00  1.01030654e+00  1.01030654e+00
  1.05132403e+00  7.21494284e+00  7.21494284e+00  7.21494284e+00
  1.36615562e+01  3.30283242e+01  3.30283242e+01  3.30283242e+01
  1.23054680e+02  1.27606949e+02  1.27606949e+02  1.27606949e+02
  4.78785226e+02  4.78785226e+02  4.78785226e+02  6.66441883e+02
  1.32382616e+03  1.32382616e+03  1.32382616e+03  2.81312338e+03
  3.00937389e+03  3.00937389e+03  3.00937389e+03  6.62427616e+03
  6.62427616e+03  6.62427616e+03  9.23334333e+03  2.55793697e+04
  7.63083328e+04]
E1 = -728.3085198789905  E_coul = 201.56238416875004
cycle= 1 E= -526.74613571024  delta_E= -1.14e-12  |g|= 7.05e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3085198789905  E_coul = 201.56238416875004
  HOMO = -0.583001411780076  LUMO = 1.01030654425316
  mo_energy =
[-1.18580271e+02 -1.23096934e+01 -9.56092541e+00 -9.56092541e+00
 -9.56092541e+00 -1.27013091e+00 -5.83001412e-01 -5.83001412e-01
 -5.83001412e-01  1.01030654e+00  1.01030654e+00  1.01030654e+00
  1.05132404e+00  7.21494284e+00  7.21494284e+00  7.21494284e+00
  1.36615562e+01  3.30283242e+01  3.30283242e+01  3.30283242e+01
  1.23054680e+02  1.27606949e+02  1.27606949e+02  1.27606949e+02
  4.78785226e+02  4.78785226e+02  4.78785226e+02  6.66441883e+02
  1.32382616e+03  1.32382616e+03  1.32382616e+03  2.81312338e+03
  3.00937389e+03  3.00937389e+03  3.00937389e+03  6.62427616e+03
  6.62427616e+03  6.62427616e+03  9.23334333e+03  2.55793697e+04
  7.63083328e+04]
E1 = -728.3085198368699  E_coul = 201.56238412662984
Extra cycle  E= -526.74613571024  delta_E= 3.41e-13  |g|= 1.42e-08  |ddm|= 1.17e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828783e+04 7.61702631e+03 3.61756969e+03 1.58699376e+03
 4.18907614e+02 1.22825396e+02 3.95419485e+01 8.53784652e+00
 3.36879923e+00 6.79197270e-01 2.51484423e-01 1.36285985e+03
 6.64044122e+02 2.97672612e+02 3.11210848e+02 6.11388919e+01
 7.26002170e+00 2.00487369e+01 7.73240073e-01 2.79119273e+00
 2.22198225e-01]
grad_E = [-1.39543173e-06  2.14328489e-06 -2.14723724e-06  3.66513902e-05
  4.26112838e-06  3.87045225e-05 -2.30724035e-05  4.20749623e-05
  1.83214185e-04  7.07454440e-04 -6.85884351e-04 -5.15329807e-07
  5.08307311e-06  2.42344884e-05  2.07377678e-05 -1.40288526e-05
 -7.85304027e-04  1.12860763e-04  8.43032403e-04  8.16029036e-04
 -2.08873665e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8792632        1
[INPUT] 0    0    [1    /1   ]  7617.02471154        1
[INPUT] 0    0    [1    /1   ]  3617.57117849        1
[INPUT] 0    0    [1    /1   ]  1586.96545131        1
[INPUT] 0    0    [1    /1   ]  418.935575765        1
[INPUT] 0    0    [1    /1   ]  122.736368717        1
[INPUT] 0    0    [1    /1   ]  39.5055046218        1
[INPUT] 0    0    [1    /1   ]  8.51115599065        1
[INPUT] 0    0    [1    /1   ]  3.35981997489        1
[INPUT] 0    0    [1    /1   ]  0.675450339169       1
[INPUT] 0    0    [1    /1   ]  0.250235512462       1
[INPUT] 1    0    [1    /1   ]  1362.86027494        1
[INPUT] 1    0    [1    /1   ]  664.04128143         1
[INPUT] 1    0    [1    /1   ]  297.659685586        1
[INPUT] 1    0    [1    /1   ]  311.1998093          1
[INPUT] 1    0    [1    /1   ]  61.0731062247        1
[INPUT] 1    0    [1    /1   ]  7.27530125207        1
[INPUT] 1    0    [1    /1   ]  20.0602831445        1
[INPUT] 1    0    [1    /1   ]  0.77355350423        1
[INPUT] 1    0    [1    /1   ]  2.79528685396        1
[INPUT] 1    0    [1    /1   ]  0.22229362903        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.879263239683, 1.0]], [0, [7617.024711543185, 1.0]], [0, [3617.5711784908335, 1.0]], [0, [1586.9654513116566, 1.0]], [0, [418.93557576475996, 1.0]], [0, [122.73636871656973, 1.0]], [0, [39.505504621766704, 1.0]], [0, [8.511155990649833, 1.0]], [0, [3.3598199748921633, 1.0]], [0, [0.6754503391689274, 1.0]], [0, [0.2502355124622672, 1.0]], [1, [1362.8602749438237, 1.0]], [1, [664.041281429853, 1.0]], [1, [297.65968558572325, 1.0]], [1, [311.1998093000735, 1.0]], [1, [61.07310622474329, 1.0]], [1, [7.275301252074924, 1.0]], [1, [20.06028314451397, 1.0]], [1, [0.7735535042297692, 1.0]], [1, [2.7952868539645523, 1.0]], [1, [0.22229362903042899, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87926324]
bas 1, expnt(s) = [7617.02471154]
bas 2, expnt(s) = [3617.57117849]
bas 3, expnt(s) = [1586.96545131]
bas 4, expnt(s) = [418.93557576]
bas 5, expnt(s) = [122.73636872]
bas 6, expnt(s) = [39.50550462]
bas 7, expnt(s) = [8.51115599]
bas 8, expnt(s) = [3.35981997]
bas 9, expnt(s) = [0.67545034]
bas 10, expnt(s) = [0.25023551]
bas 11, expnt(s) = [1362.86027494]
bas 12, expnt(s) = [664.04128143]
bas 13, expnt(s) = [297.65968559]
bas 14, expnt(s) = [311.1998093]
bas 15, expnt(s) = [61.07310622]
bas 16, expnt(s) = [7.27530125]
bas 17, expnt(s) = [20.06028314]
bas 18, expnt(s) = [0.7735535]
bas 19, expnt(s) = [2.79528685]
bas 20, expnt(s) = [0.22229363]
CPU time:       550.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828793e+04 5.20029615e+03 7.61702471e+03 2.05993752e+03
 3.61757118e+03 1.17849525e+03 1.58696545e+03 6.35244083e+02
 4.18935576e+02 2.33951296e+02 1.22736369e+02 9.31633243e+01
 3.95055046e+01 3.98114719e+01 8.51115599e+00 1.25894407e+01
 3.35981997e+00 6.26977607e+00 6.75450339e-01 1.88239210e+00
 2.50235512e-01 8.93874878e-01 1.36286027e+03 2.41573092e+04
 6.64041281e+02 9.83395556e+03 2.97659686e+02 3.60690261e+03
 3.11199809e+02 3.81314698e+03 6.10731062e+01 4.98077478e+02
 7.27530125e+00 3.48576511e+01 2.00602831e+01 1.23852768e+02
 7.73553504e-01 2.11639799e+00 2.79528685e+00 1.05442907e+01
 2.22293629e-01 4.45290226e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993535562395106
cond(S) = 93076.74374390198
E1 = -729.53159657909  E_coul = 203.17986868645528
init E= -526.351727892635
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555806789862548  LUMO = 1.02945418679925
  mo_energy =
[-1.18331968e+02 -1.22047143e+01 -9.44669496e+00 -9.44669496e+00
 -9.44669496e+00 -1.23993208e+00 -5.55806790e-01 -5.55806790e-01
 -5.55806790e-01  1.02945419e+00  1.02945419e+00  1.02945419e+00
  1.06414444e+00  7.29761813e+00  7.29761813e+00  7.29761813e+00
  1.36685427e+01  3.32069440e+01  3.32069440e+01  3.32069440e+01
  1.22957802e+02  1.27823440e+02  1.27823440e+02  1.27823440e+02
  4.78934578e+02  4.78934578e+02  4.78934578e+02  6.66243200e+02
  1.32395591e+03  1.32395591e+03  1.32395591e+03  2.81302218e+03
  3.00952284e+03  3.00952284e+03  3.00952284e+03  6.62451838e+03
  6.62451838e+03  6.62451838e+03  9.23335594e+03  2.55794712e+04
  7.63085450e+04]
E1 = -727.8643439270138  E_coul = 201.1189687612363
cycle= 1 E= -526.745375165778  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537481
diis-c [-0.2888854  1.       ]
  HOMO = -0.590561816828776  LUMO = 1.00534653062901
  mo_energy =
[-1.18637681e+02 -1.23418588e+01 -9.59437969e+00 -9.59437969e+00
 -9.59437969e+00 -1.27932881e+00 -5.90561817e-01 -5.90561817e-01
 -5.90561817e-01  1.00534653e+00  1.00534653e+00  1.00534653e+00
  1.03457162e+00  7.20761841e+00  7.20761841e+00  7.20761841e+00
  1.35547596e+01  3.30543361e+01  3.30543361e+01  3.30543361e+01
  1.22729241e+02  1.27597181e+02  1.27597181e+02  1.27597181e+02
  4.78630810e+02  4.78630810e+02  4.78630810e+02  6.65892035e+02
  1.32359652e+03  1.32359652e+03  1.32359652e+03  2.81252835e+03
  3.00909798e+03  3.00909798e+03  3.00909798e+03  6.62398170e+03
  6.62398170e+03  6.62398170e+03  9.23274600e+03  2.55787677e+04
  7.63077517e+04]
E1 = -728.4351064776731  E_coul = 201.68902192147178
cycle= 2 E= -526.746084556201  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746527
diis-c [-0.00326512  0.08247684  0.91752316]
  HOMO = -0.581488697512265  LUMO = 1.0120122480926
  mo_energy =
[-1.18570429e+02 -1.23040241e+01 -9.55489752e+00 -9.55489752e+00
 -9.55489752e+00 -1.26847142e+00 -5.81488698e-01 -5.81488698e-01
 -5.81488698e-01  1.01201225e+00  1.01201225e+00  1.01201225e+00
  1.04300776e+00  7.23113215e+00  7.23113215e+00  7.23113215e+00
  1.35858576e+01  3.30940369e+01  3.30940369e+01  3.30940369e+01
  1.22786279e+02  1.27652600e+02  1.27652600e+02  1.27652600e+02
  4.78697190e+02  4.78697190e+02  4.78697190e+02  6.65961401e+02
  1.32366694e+03  1.32366694e+03  1.32366694e+03  2.81260216e+03
  3.00917066e+03  3.00917066e+03  3.00917066e+03  6.62405613e+03
  6.62405613e+03  6.62405613e+03  9.23282124e+03  2.55788435e+04
  7.63078278e+04]
E1 = -728.2854940586909  E_coul = 201.5393512223321
cycle= 3 E= -526.746142836359  delta_E= -5.83e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130843
diis-c [-5.35816547e-07 -1.21820494e-03  1.44799641e-01  8.56418564e-01]
  HOMO = -0.582980232526555  LUMO = 1.01093972079077
  mo_energy =
[-1.18580335e+02 -1.23098059e+01 -9.56102145e+00 -9.56102145e+00
 -9.56102145e+00 -1.27015922e+00 -5.82980233e-01 -5.82980233e-01
 -5.82980233e-01  1.01093972e+00  1.01093972e+00  1.01093972e+00
  1.04171501e+00  7.22738999e+00  7.22738999e+00  7.22738999e+00
  1.35810824e+01  3.30879159e+01  3.30879159e+01  3.30879159e+01
  1.22777815e+02  1.27644310e+02  1.27644310e+02  1.27644310e+02
  4.78687407e+02  4.78687407e+02  4.78687407e+02  6.65951172e+02
  1.32365657e+03  1.32365657e+03  1.32365657e+03  2.81259115e+03
  3.00915990e+03  3.00915990e+03  3.00915990e+03  6.62404499e+03
  6.62404499e+03  6.62404499e+03  9.23280989e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.308213545572  E_coul = 201.5620688039974
cycle= 4 E= -526.746144741575  delta_E= -1.91e-06  |g|= 9.31e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107214
diis-c [-3.84805573e-09  6.68752884e-05 -9.70943400e-03 -6.29677648e-02
  1.07261032e+00]
  HOMO = -0.582961817051625  LUMO = 1.01095535771624
  mo_energy =
[-1.18580295e+02 -1.23097421e+01 -9.56097053e+00 -9.56097053e+00
 -9.56097053e+00 -1.27011944e+00 -5.82961817e-01 -5.82961817e-01
 -5.82961817e-01  1.01095536e+00  1.01095536e+00  1.01095536e+00
  1.04174884e+00  7.22743130e+00  7.22743130e+00  7.22743130e+00
  1.35811413e+01  3.30879647e+01  3.30879647e+01  3.30879647e+01
  1.22777866e+02  1.27644358e+02  1.27644358e+02  1.27644358e+02
  4.78687448e+02  4.78687448e+02  4.78687448e+02  6.65951204e+02
  1.32365661e+03  1.32365661e+03  1.32365661e+03  2.81259116e+03
  3.00915992e+03  3.00915992e+03  3.00915992e+03  6.62404500e+03
  6.62404500e+03  6.62404500e+03  9.23280989e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.3080054354655  E_coul = 201.5618606923983
cycle= 5 E= -526.746144743067  delta_E= -1.49e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79913e-05
diis-c [-6.61918523e-11  1.40730826e-05 -1.85225807e-03 -1.38205032e-02
  4.27687830e-02  9.72889905e-01]
  HOMO = -0.582968935926213  LUMO = 1.01095065561031
  mo_energy =
[-1.18580325e+02 -1.23097639e+01 -9.56099410e+00 -9.56099410e+00
 -9.56099410e+00 -1.27012513e+00 -5.82968936e-01 -5.82968936e-01
 -5.82968936e-01  1.01095066e+00  1.01095066e+00  1.01095066e+00
  1.04174489e+00  7.22741543e+00  7.22741543e+00  7.22741543e+00
  1.35811233e+01  3.30879419e+01  3.30879419e+01  3.30879419e+01
  1.22777839e+02  1.27644331e+02  1.27644331e+02  1.27644331e+02
  4.78687418e+02  4.78687418e+02  4.78687418e+02  6.65951173e+02
  1.32365657e+03  1.32365657e+03  1.32365657e+03  2.81259113e+03
  3.00915989e+03  3.00915989e+03  3.00915989e+03  6.62404497e+03
  6.62404497e+03  6.62404497e+03  9.23280986e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.308084469236  E_coul = 201.5619397261158
cycle= 6 E= -526.74614474312  delta_E= -5.3e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.308084469236  E_coul = 201.5619397261158
  HOMO = -0.582968967459388  LUMO = 1.01095068723586
  mo_energy =
[-1.18580325e+02 -1.23097638e+01 -9.56099410e+00 -9.56099410e+00
 -9.56099410e+00 -1.27012480e+00 -5.82968967e-01 -5.82968967e-01
 -5.82968967e-01  1.01095069e+00  1.01095069e+00  1.01095069e+00
  1.04174521e+00  7.22741543e+00  7.22741543e+00  7.22741543e+00
  1.35811234e+01  3.30879419e+01  3.30879419e+01  3.30879419e+01
  1.22777839e+02  1.27644331e+02  1.27644331e+02  1.27644331e+02
  4.78687418e+02  4.78687418e+02  4.78687418e+02  6.65951174e+02
  1.32365657e+03  1.32365657e+03  1.32365657e+03  2.81259113e+03
  3.00915989e+03  3.00915989e+03  3.00915989e+03  6.62404497e+03
  6.62404497e+03  6.62404497e+03  9.23280986e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.3080838014905  E_coul = 201.56193905836943
Extra cycle  E= -526.746144743121  delta_E= -9.09e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828793e+04 7.61702471e+03 3.61757118e+03 1.58696545e+03
 4.18935576e+02 1.22736369e+02 3.95055046e+01 8.51115599e+00
 3.35981997e+00 6.75450339e-01 2.50235512e-01 1.36286027e+03
 6.64041281e+02 2.97659686e+02 3.11199809e+02 6.10731062e+01
 7.27530125e+00 2.00602831e+01 7.73553504e-01 2.79528685e+00
 2.22293629e-01]
E = -526.746144743121
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8792632        1
[INPUT] 0    0    [1    /1   ]  7617.02471154        1
[INPUT] 0    0    [1    /1   ]  3617.57117849        1
[INPUT] 0    0    [1    /1   ]  1586.96545131        1
[INPUT] 0    0    [1    /1   ]  418.935575765        1
[INPUT] 0    0    [1    /1   ]  122.736368717        1
[INPUT] 0    0    [1    /1   ]  39.5055046218        1
[INPUT] 0    0    [1    /1   ]  8.51115599065        1
[INPUT] 0    0    [1    /1   ]  3.35981997489        1
[INPUT] 0    0    [1    /1   ]  0.675450339169       1
[INPUT] 0    0    [1    /1   ]  0.250235512462       1
[INPUT] 1    0    [1    /1   ]  1362.86027494        1
[INPUT] 1    0    [1    /1   ]  664.04128143         1
[INPUT] 1    0    [1    /1   ]  297.659685586        1
[INPUT] 1    0    [1    /1   ]  311.1998093          1
[INPUT] 1    0    [1    /1   ]  61.0731062247        1
[INPUT] 1    0    [1    /1   ]  7.27530125207        1
[INPUT] 1    0    [1    /1   ]  20.0602831445        1
[INPUT] 1    0    [1    /1   ]  0.77355350423        1
[INPUT] 1    0    [1    /1   ]  2.79528685396        1
[INPUT] 1    0    [1    /1   ]  0.22229362903        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.879263239683, 1.0]], [0, [7617.024711543185, 1.0]], [0, [3617.5711784908335, 1.0]], [0, [1586.9654513116566, 1.0]], [0, [418.93557576475996, 1.0]], [0, [122.73636871656973, 1.0]], [0, [39.505504621766704, 1.0]], [0, [8.511155990649833, 1.0]], [0, [3.3598199748921633, 1.0]], [0, [0.6754503391689274, 1.0]], [0, [0.2502355124622672, 1.0]], [1, [1362.8602749438237, 1.0]], [1, [664.041281429853, 1.0]], [1, [297.65968558572325, 1.0]], [1, [311.1998093000735, 1.0]], [1, [61.07310622474329, 1.0]], [1, [7.275301252074924, 1.0]], [1, [20.06028314451397, 1.0]], [1, [0.7735535042297692, 1.0]], [1, [2.7952868539645523, 1.0]], [1, [0.22229362903042899, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87926324]
bas 1, expnt(s) = [7617.02471154]
bas 2, expnt(s) = [3617.57117849]
bas 3, expnt(s) = [1586.96545131]
bas 4, expnt(s) = [418.93557576]
bas 5, expnt(s) = [122.73636872]
bas 6, expnt(s) = [39.50550462]
bas 7, expnt(s) = [8.51115599]
bas 8, expnt(s) = [3.35981997]
bas 9, expnt(s) = [0.67545034]
bas 10, expnt(s) = [0.25023551]
bas 11, expnt(s) = [1362.86027494]
bas 12, expnt(s) = [664.04128143]
bas 13, expnt(s) = [297.65968559]
bas 14, expnt(s) = [311.1998093]
bas 15, expnt(s) = [61.07310622]
bas 16, expnt(s) = [7.27530125]
bas 17, expnt(s) = [20.06028314]
bas 18, expnt(s) = [0.7735535]
bas 19, expnt(s) = [2.79528685]
bas 20, expnt(s) = [0.22229363]
CPU time:       550.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828793e+04 5.20029615e+03 7.61702471e+03 2.05993752e+03
 3.61757118e+03 1.17849525e+03 1.58696545e+03 6.35244083e+02
 4.18935576e+02 2.33951296e+02 1.22736369e+02 9.31633243e+01
 3.95055046e+01 3.98114719e+01 8.51115599e+00 1.25894407e+01
 3.35981997e+00 6.26977607e+00 6.75450339e-01 1.88239210e+00
 2.50235512e-01 8.93874878e-01 1.36286027e+03 2.41573092e+04
 6.64041281e+02 9.83395556e+03 2.97659686e+02 3.60690261e+03
 3.11199809e+02 3.81314698e+03 6.10731062e+01 4.98077478e+02
 7.27530125e+00 3.48576511e+01 2.00602831e+01 1.23852768e+02
 7.73553504e-01 2.11639799e+00 2.79528685e+00 1.05442907e+01
 2.22293629e-01 4.45290226e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993535562395106
cond(S) = 93076.74374390198
E1 = -729.53159657909  E_coul = 203.17986868645528
init E= -526.351727892635
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555806789862548  LUMO = 1.02945418679925
  mo_energy =
[-1.18331968e+02 -1.22047143e+01 -9.44669496e+00 -9.44669496e+00
 -9.44669496e+00 -1.23993208e+00 -5.55806790e-01 -5.55806790e-01
 -5.55806790e-01  1.02945419e+00  1.02945419e+00  1.02945419e+00
  1.06414444e+00  7.29761813e+00  7.29761813e+00  7.29761813e+00
  1.36685427e+01  3.32069440e+01  3.32069440e+01  3.32069440e+01
  1.22957802e+02  1.27823440e+02  1.27823440e+02  1.27823440e+02
  4.78934578e+02  4.78934578e+02  4.78934578e+02  6.66243200e+02
  1.32395591e+03  1.32395591e+03  1.32395591e+03  2.81302218e+03
  3.00952284e+03  3.00952284e+03  3.00952284e+03  6.62451838e+03
  6.62451838e+03  6.62451838e+03  9.23335594e+03  2.55794712e+04
  7.63085450e+04]
E1 = -727.8643439270138  E_coul = 201.1189687612363
cycle= 1 E= -526.745375165778  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537481
diis-c [-0.2888854  1.       ]
  HOMO = -0.590561816828776  LUMO = 1.00534653062901
  mo_energy =
[-1.18637681e+02 -1.23418588e+01 -9.59437969e+00 -9.59437969e+00
 -9.59437969e+00 -1.27932881e+00 -5.90561817e-01 -5.90561817e-01
 -5.90561817e-01  1.00534653e+00  1.00534653e+00  1.00534653e+00
  1.03457162e+00  7.20761841e+00  7.20761841e+00  7.20761841e+00
  1.35547596e+01  3.30543361e+01  3.30543361e+01  3.30543361e+01
  1.22729241e+02  1.27597181e+02  1.27597181e+02  1.27597181e+02
  4.78630810e+02  4.78630810e+02  4.78630810e+02  6.65892035e+02
  1.32359652e+03  1.32359652e+03  1.32359652e+03  2.81252835e+03
  3.00909798e+03  3.00909798e+03  3.00909798e+03  6.62398170e+03
  6.62398170e+03  6.62398170e+03  9.23274600e+03  2.55787677e+04
  7.63077517e+04]
E1 = -728.4351064776731  E_coul = 201.68902192147178
cycle= 2 E= -526.746084556201  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746527
diis-c [-0.00326512  0.08247684  0.91752316]
  HOMO = -0.581488697512265  LUMO = 1.0120122480926
  mo_energy =
[-1.18570429e+02 -1.23040241e+01 -9.55489752e+00 -9.55489752e+00
 -9.55489752e+00 -1.26847142e+00 -5.81488698e-01 -5.81488698e-01
 -5.81488698e-01  1.01201225e+00  1.01201225e+00  1.01201225e+00
  1.04300776e+00  7.23113215e+00  7.23113215e+00  7.23113215e+00
  1.35858576e+01  3.30940369e+01  3.30940369e+01  3.30940369e+01
  1.22786279e+02  1.27652600e+02  1.27652600e+02  1.27652600e+02
  4.78697190e+02  4.78697190e+02  4.78697190e+02  6.65961401e+02
  1.32366694e+03  1.32366694e+03  1.32366694e+03  2.81260216e+03
  3.00917066e+03  3.00917066e+03  3.00917066e+03  6.62405613e+03
  6.62405613e+03  6.62405613e+03  9.23282124e+03  2.55788435e+04
  7.63078278e+04]
E1 = -728.2854940586909  E_coul = 201.5393512223321
cycle= 3 E= -526.746142836359  delta_E= -5.83e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130843
diis-c [-5.35816547e-07 -1.21820494e-03  1.44799641e-01  8.56418564e-01]
  HOMO = -0.582980232526555  LUMO = 1.01093972079077
  mo_energy =
[-1.18580335e+02 -1.23098059e+01 -9.56102145e+00 -9.56102145e+00
 -9.56102145e+00 -1.27015922e+00 -5.82980233e-01 -5.82980233e-01
 -5.82980233e-01  1.01093972e+00  1.01093972e+00  1.01093972e+00
  1.04171501e+00  7.22738999e+00  7.22738999e+00  7.22738999e+00
  1.35810824e+01  3.30879159e+01  3.30879159e+01  3.30879159e+01
  1.22777815e+02  1.27644310e+02  1.27644310e+02  1.27644310e+02
  4.78687407e+02  4.78687407e+02  4.78687407e+02  6.65951172e+02
  1.32365657e+03  1.32365657e+03  1.32365657e+03  2.81259115e+03
  3.00915990e+03  3.00915990e+03  3.00915990e+03  6.62404499e+03
  6.62404499e+03  6.62404499e+03  9.23280989e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.308213545572  E_coul = 201.5620688039974
cycle= 4 E= -526.746144741575  delta_E= -1.91e-06  |g|= 9.31e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107214
diis-c [-3.84805573e-09  6.68752884e-05 -9.70943400e-03 -6.29677648e-02
  1.07261032e+00]
  HOMO = -0.582961817051625  LUMO = 1.01095535771624
  mo_energy =
[-1.18580295e+02 -1.23097421e+01 -9.56097053e+00 -9.56097053e+00
 -9.56097053e+00 -1.27011944e+00 -5.82961817e-01 -5.82961817e-01
 -5.82961817e-01  1.01095536e+00  1.01095536e+00  1.01095536e+00
  1.04174884e+00  7.22743130e+00  7.22743130e+00  7.22743130e+00
  1.35811413e+01  3.30879647e+01  3.30879647e+01  3.30879647e+01
  1.22777866e+02  1.27644358e+02  1.27644358e+02  1.27644358e+02
  4.78687448e+02  4.78687448e+02  4.78687448e+02  6.65951204e+02
  1.32365661e+03  1.32365661e+03  1.32365661e+03  2.81259116e+03
  3.00915992e+03  3.00915992e+03  3.00915992e+03  6.62404500e+03
  6.62404500e+03  6.62404500e+03  9.23280989e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.3080054354655  E_coul = 201.5618606923983
cycle= 5 E= -526.746144743067  delta_E= -1.49e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79913e-05
diis-c [-6.61918523e-11  1.40730826e-05 -1.85225807e-03 -1.38205032e-02
  4.27687830e-02  9.72889905e-01]
  HOMO = -0.582968935926213  LUMO = 1.01095065561031
  mo_energy =
[-1.18580325e+02 -1.23097639e+01 -9.56099410e+00 -9.56099410e+00
 -9.56099410e+00 -1.27012513e+00 -5.82968936e-01 -5.82968936e-01
 -5.82968936e-01  1.01095066e+00  1.01095066e+00  1.01095066e+00
  1.04174489e+00  7.22741543e+00  7.22741543e+00  7.22741543e+00
  1.35811233e+01  3.30879419e+01  3.30879419e+01  3.30879419e+01
  1.22777839e+02  1.27644331e+02  1.27644331e+02  1.27644331e+02
  4.78687418e+02  4.78687418e+02  4.78687418e+02  6.65951173e+02
  1.32365657e+03  1.32365657e+03  1.32365657e+03  2.81259113e+03
  3.00915989e+03  3.00915989e+03  3.00915989e+03  6.62404497e+03
  6.62404497e+03  6.62404497e+03  9.23280986e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.308084469236  E_coul = 201.5619397261158
cycle= 6 E= -526.74614474312  delta_E= -5.3e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.308084469236  E_coul = 201.5619397261158
  HOMO = -0.582968967459388  LUMO = 1.01095068723586
  mo_energy =
[-1.18580325e+02 -1.23097638e+01 -9.56099410e+00 -9.56099410e+00
 -9.56099410e+00 -1.27012480e+00 -5.82968967e-01 -5.82968967e-01
 -5.82968967e-01  1.01095069e+00  1.01095069e+00  1.01095069e+00
  1.04174521e+00  7.22741543e+00  7.22741543e+00  7.22741543e+00
  1.35811234e+01  3.30879419e+01  3.30879419e+01  3.30879419e+01
  1.22777839e+02  1.27644331e+02  1.27644331e+02  1.27644331e+02
  4.78687418e+02  4.78687418e+02  4.78687418e+02  6.65951174e+02
  1.32365657e+03  1.32365657e+03  1.32365657e+03  2.81259113e+03
  3.00915989e+03  3.00915989e+03  3.00915989e+03  6.62404497e+03
  6.62404497e+03  6.62404497e+03  9.23280986e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.3080838014905  E_coul = 201.56193905836943
Extra cycle  E= -526.746144743121  delta_E= -9.09e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93076.74374390198
E1 = -728.3080838014905  E_coul = 201.56193905836943
init E= -526.746144743121
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582968990648641  LUMO = 1.01095068209696
  mo_energy =
[-1.18580325e+02 -1.23097638e+01 -9.56099417e+00 -9.56099417e+00
 -9.56099417e+00 -1.27012475e+00 -5.82968991e-01 -5.82968991e-01
 -5.82968991e-01  1.01095068e+00  1.01095068e+00  1.01095068e+00
  1.04174526e+00  7.22741539e+00  7.22741539e+00  7.22741539e+00
  1.35811234e+01  3.30879419e+01  3.30879419e+01  3.30879419e+01
  1.22777839e+02  1.27644331e+02  1.27644331e+02  1.27644331e+02
  4.78687418e+02  4.78687418e+02  4.78687418e+02  6.65951173e+02
  1.32365657e+03  1.32365657e+03  1.32365657e+03  2.81259113e+03
  3.00915989e+03  3.00915989e+03  3.00915989e+03  6.62404497e+03
  6.62404497e+03  6.62404497e+03  9.23280986e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.3080838945534  E_coul = 201.56193915143243
cycle= 1 E= -526.746144743121  delta_E=    0  |g|= 7.09e-08  |ddm|= 5.69e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3080838945534  E_coul = 201.56193915143243
  HOMO = -0.582968991091919  LUMO = 1.01095068411558
  mo_energy =
[-1.18580325e+02 -1.23097638e+01 -9.56099417e+00 -9.56099417e+00
 -9.56099417e+00 -1.27012473e+00 -5.82968991e-01 -5.82968991e-01
 -5.82968991e-01  1.01095068e+00  1.01095068e+00  1.01095068e+00
  1.04174528e+00  7.22741540e+00  7.22741540e+00  7.22741540e+00
  1.35811234e+01  3.30879419e+01  3.30879419e+01  3.30879419e+01
  1.22777839e+02  1.27644331e+02  1.27644331e+02  1.27644331e+02
  4.78687418e+02  4.78687418e+02  4.78687418e+02  6.65951173e+02
  1.32365657e+03  1.32365657e+03  1.32365657e+03  2.81259113e+03
  3.00915989e+03  3.00915989e+03  3.00915989e+03  6.62404497e+03
  6.62404497e+03  6.62404497e+03  9.23280986e+03  2.55788319e+04
  7.63078161e+04]
E1 = -728.3080838488379  E_coul = 201.56193910571793
Extra cycle  E= -526.74614474312  delta_E= 1.02e-12  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828793e+04 7.61702471e+03 3.61757118e+03 1.58696545e+03
 4.18935576e+02 1.22736369e+02 3.95055046e+01 8.51115599e+00
 3.35981997e+00 6.75450339e-01 2.50235512e-01 1.36286027e+03
 6.64041281e+02 2.97659686e+02 3.11199809e+02 6.10731062e+01
 7.27530125e+00 2.00602831e+01 7.73553504e-01 2.79528685e+00
 2.22293629e-01]
grad_E = [-1.39422744e-06  2.13351859e-06 -2.14449378e-06  3.62972586e-05
  1.15166599e-05  1.12854407e-05 -4.99945153e-06  5.15059317e-06
  5.60082901e-05  1.54246395e-04 -1.33852199e-04 -5.09469624e-07
  5.15914684e-06  2.46718093e-05  2.11144120e-05 -2.85594022e-05
 -1.76136809e-04  1.81719910e-05  1.18185399e-04  1.74003720e-04
 -3.51172702e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8774727        1
[INPUT] 0    0    [1    /1   ]  7617.0277342         1
[INPUT] 0    0    [1    /1   ]  3617.5686428         1
[INPUT] 0    0    [1    /1   ]  1587.02107922        1
[INPUT] 0    0    [1    /1   ]  418.887777672        1
[INPUT] 0    0    [1    /1   ]  122.695388157        1
[INPUT] 0    0    [1    /1   ]  39.4917601835        1
[INPUT] 0    0    [1    /1   ]  8.50327605592        1
[INPUT] 0    0    [1    /1   ]  3.35697748139        1
[INPUT] 0    0    [1    /1   ]  0.674334176026       1
[INPUT] 0    0    [1    /1   ]  0.249846920687       1
[INPUT] 1    0    [1    /1   ]  1362.85954735        1
[INPUT] 1    0    [1    /1   ]  664.046529157        1
[INPUT] 1    0    [1    /1   ]  297.683761591        1
[INPUT] 1    0    [1    /1   ]  311.220402598        1
[INPUT] 1    0    [1    /1   ]  61.1496313861        1
[INPUT] 1    0    [1    /1   ]  7.2902861474         1
[INPUT] 1    0    [1    /1   ]  20.0956365715        1
[INPUT] 1    0    [1    /1   ]  0.774104789103       1
[INPUT] 1    0    [1    /1   ]  2.79999405123        1
[INPUT] 1    0    [1    /1   ]  0.222414892773       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.877472681223, 1.0]], [0, [7617.027734199872, 1.0]], [0, [3617.568642797338, 1.0]], [0, [1587.0210792151047, 1.0]], [0, [418.88777767249877, 1.0]], [0, [122.69538815652045, 1.0]], [0, [39.49176018352847, 1.0]], [0, [8.503276055919377, 1.0]], [0, [3.3569774813926996, 1.0]], [0, [0.6743341760262199, 1.0]], [0, [0.24984692068708572, 1.0]], [1, [1362.8595473478654, 1.0]], [1, [664.0465291574903, 1.0]], [1, [297.68376159134107, 1.0]], [1, [311.2204025979543, 1.0]], [1, [61.149631386131205, 1.0]], [1, [7.2902861473978895, 1.0]], [1, [20.095636571515033, 1.0]], [1, [0.7741047891025701, 1.0]], [1, [2.799994051231169, 1.0]], [1, [0.22241489277315593, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87747268]
bas 1, expnt(s) = [7617.0277342]
bas 2, expnt(s) = [3617.5686428]
bas 3, expnt(s) = [1587.02107922]
bas 4, expnt(s) = [418.88777767]
bas 5, expnt(s) = [122.69538816]
bas 6, expnt(s) = [39.49176018]
bas 7, expnt(s) = [8.50327606]
bas 8, expnt(s) = [3.35697748]
bas 9, expnt(s) = [0.67433418]
bas 10, expnt(s) = [0.24984692]
bas 11, expnt(s) = [1362.85954735]
bas 12, expnt(s) = [664.04652916]
bas 13, expnt(s) = [297.68376159]
bas 14, expnt(s) = [311.2204026]
bas 15, expnt(s) = [61.14963139]
bas 16, expnt(s) = [7.29028615]
bas 17, expnt(s) = [20.09563657]
bas 18, expnt(s) = [0.77410479]
bas 19, expnt(s) = [2.79999405]
bas 20, expnt(s) = [0.22241489]
CPU time:       557.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828775e+04 5.20029588e+03 7.61702773e+03 2.05993813e+03
 3.61756864e+03 1.17849463e+03 1.58702108e+03 6.35260783e+02
 4.18887778e+02 2.33931277e+02 1.22695388e+02 9.31399935e+01
 3.94917602e+01 3.98010833e+01 8.50327606e+00 1.25806979e+01
 3.35697748e+00 6.26579736e+00 6.74334176e-01 1.88005867e+00
 2.49846921e-01 8.92833599e-01 1.36285955e+03 2.41572931e+04
 6.64046529e+02 9.83405270e+03 2.97683762e+02 3.60726729e+03
 3.11220403e+02 3.81346239e+03 6.11496314e+01 4.98857719e+02
 7.29028615e+00 3.49474193e+01 2.00956366e+01 1.24125669e+02
 7.74104789e-01 2.11828351e+00 2.79999405e+00 1.05664908e+01
 2.22414893e-01 4.45593885e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993521307366724
cond(S) = 93271.69324070434
E1 = -729.5314884340304  E_coul = 203.17979172670516
init E= -526.351696707325
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555800785115742  LUMO = 1.03041285961215
  mo_energy =
[-1.18331959e+02 -1.22047272e+01 -9.44670913e+00 -9.44670913e+00
 -9.44670913e+00 -1.23994250e+00 -5.55800785e-01 -5.55800785e-01
 -5.55800785e-01  1.03041286e+00  1.03041286e+00  1.03041286e+00
  1.06116854e+00  7.31230202e+00  7.31230202e+00  7.31230202e+00
  1.36439555e+01  3.32843129e+01  3.32843129e+01  3.32843129e+01
  1.22862816e+02  1.28061884e+02  1.28061884e+02  1.28061884e+02
  4.79343009e+02  4.79343009e+02  4.79343009e+02  6.66012753e+02
  1.32444283e+03  1.32444283e+03  1.32444283e+03  2.81269625e+03
  3.01006834e+03  3.01006834e+03  3.01006834e+03  6.62507830e+03
  6.62507830e+03  6.62507830e+03  9.23307260e+03  2.55792515e+04
  7.63083656e+04]
E1 = -727.8645806951304  E_coul = 201.11920445267592
cycle= 1 E= -526.745376242454  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537514
diis-c [-0.28892119  1.        ]
  HOMO = -0.590535870687573  LUMO = 1.00629370831709
  mo_energy =
[-1.18637659e+02 -1.23418544e+01 -9.59438068e+00 -9.59438068e+00
 -9.59438068e+00 -1.27931224e+00 -5.90535871e-01 -5.90535871e-01
 -5.90535871e-01  1.00629371e+00  1.00629371e+00  1.00629371e+00
  1.03168657e+00  7.22221644e+00  7.22221644e+00  7.22221644e+00
  1.35302627e+01  3.31316009e+01  3.31316009e+01  3.31316009e+01
  1.22634307e+02  1.27835564e+02  1.27835564e+02  1.27835564e+02
  4.79039255e+02  4.79039255e+02  4.79039255e+02  6.65661617e+02
  1.32408346e+03  1.32408346e+03  1.32408346e+03  2.81220242e+03
  3.00964350e+03  3.00964350e+03  3.00964350e+03  6.62454164e+03
  6.62454164e+03  6.62454164e+03  9.23246265e+03  2.55785479e+04
  7.63075723e+04]
E1 = -728.4351509173707  E_coul = 201.68906549806954
cycle= 2 E= -526.746085419301  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746437
diis-c [-0.00326379  0.08247143  0.91752857]
  HOMO = -0.581466564667764  LUMO = 1.01296378016883
  mo_energy =
[-1.18570424e+02 -1.23040328e+01 -9.55491224e+00 -9.55491224e+00
 -9.55491224e+00 -1.26845947e+00 -5.81466565e-01 -5.81466565e-01
 -5.81466565e-01  1.01296378e+00  1.01296378e+00  1.01296378e+00
  1.04010141e+00  7.24574960e+00  7.24574960e+00  7.24574960e+00
  1.35613325e+01  3.31713174e+01  3.31713174e+01  3.31713174e+01
  1.22691326e+02  1.27890982e+02  1.27890982e+02  1.27890982e+02
  4.79105619e+02  4.79105619e+02  4.79105619e+02  6.65730966e+02
  1.32415387e+03  1.32415387e+03  1.32415387e+03  2.81227621e+03
  3.00971615e+03  3.00971615e+03  3.00971615e+03  6.62461605e+03
  6.62461605e+03  6.62461605e+03  9.23253788e+03  2.55786237e+04
  7.63076484e+04]
E1 = -728.2856244498217  E_coul = 201.53948079985813
cycle= 3 E= -526.746143649964  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130797
diis-c [-5.36127791e-07 -1.21838440e-03  1.44768276e-01  8.56450109e-01]
  HOMO = -0.582957000780377  LUMO = 1.01189092254245
  mo_energy =
[-1.18580325e+02 -1.23098109e+01 -9.56103240e+00 -9.56103240e+00
 -9.56103240e+00 -1.27014579e+00 -5.82957001e-01 -5.82957001e-01
 -5.82957001e-01  1.01189092e+00  1.01189092e+00  1.01189092e+00
  1.03881259e+00  7.24200563e+00  7.24200563e+00  7.24200563e+00
  1.35565631e+01  3.31651960e+01  3.31651960e+01  3.31651960e+01
  1.22682867e+02  1.27882695e+02  1.27882695e+02  1.27882695e+02
  4.79095841e+02  4.79095841e+02  4.79095841e+02  6.65720742e+02
  1.32414351e+03  1.32414351e+03  1.32414351e+03  2.81226521e+03
  3.00970540e+03  3.00970540e+03  3.00970540e+03  6.62460491e+03
  6.62460491e+03  6.62460491e+03  9.23252653e+03  2.55786122e+04
  7.63076368e+04]
E1 = -728.3083232588943  E_coul = 201.56217770660942
cycle= 4 E= -526.746145552285  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107529
diis-c [-3.84541020e-09  6.71629563e-05 -9.74435998e-03 -6.32202658e-02
  1.07289746e+00]
  HOMO = -0.582938665103078  LUMO = 1.01190652123609
  mo_energy =
[-1.18580285e+02 -1.23097473e+01 -9.56098172e+00 -9.56098172e+00
 -9.56098172e+00 -1.27010606e+00 -5.82938665e-01 -5.82938665e-01
 -5.82938665e-01  1.01190652e+00  1.01190652e+00  1.01190652e+00
  1.03884634e+00  7.24204681e+00  7.24204681e+00  7.24204681e+00
  1.35566218e+01  3.31652447e+01  3.31652447e+01  3.31652447e+01
  1.22682917e+02  1.27882742e+02  1.27882742e+02  1.27882742e+02
  4.79095882e+02  4.79095882e+02  4.79095882e+02  6.65720773e+02
  1.32414354e+03  1.32414354e+03  1.32414354e+03  2.81226522e+03
  3.00970543e+03  3.00970543e+03  3.00970543e+03  6.62460492e+03
  6.62460492e+03  6.62460492e+03  9.23252653e+03  2.55786121e+04
  7.63076367e+04]
E1 = -728.3081157686042  E_coul = 201.56197021482325
cycle= 5 E= -526.746145553781  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79681e-05
diis-c [-6.64176205e-11  1.40767934e-05 -1.85194933e-03 -1.38215522e-02
  4.27435963e-02  9.72915828e-01]
  HOMO = -0.582945787487348  LUMO = 1.01190181186731
  mo_energy =
[-1.18580315e+02 -1.23097690e+01 -9.56100528e+00 -9.56100528e+00
 -9.56100528e+00 -1.27011175e+00 -5.82945787e-01 -5.82945787e-01
 -5.82945787e-01  1.01190181e+00  1.01190181e+00  1.01190181e+00
  1.03884240e+00  7.24203091e+00  7.24203091e+00  7.24203091e+00
  1.35566038e+01  3.31652219e+01  3.31652219e+01  3.31652219e+01
  1.22682890e+02  1.27882715e+02  1.27882715e+02  1.27882715e+02
  4.79095852e+02  4.79095852e+02  4.79095852e+02  6.65720743e+02
  1.32414351e+03  1.32414351e+03  1.32414351e+03  2.81226519e+03
  3.00970539e+03  3.00970539e+03  3.00970539e+03  6.62460489e+03
  6.62460489e+03  6.62460489e+03  9.23252650e+03  2.55786121e+04
  7.63076367e+04]
E1 = -728.3081947359059  E_coul = 201.56204918206984
cycle= 6 E= -526.746145553836  delta_E= -5.51e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3081947359059  E_coul = 201.56204918206984
  HOMO = -0.582945818357633  LUMO = 1.01190184400075
  mo_energy =
[-1.18580315e+02 -1.23097689e+01 -9.56100529e+00 -9.56100529e+00
 -9.56100529e+00 -1.27011141e+00 -5.82945818e-01 -5.82945818e-01
 -5.82945818e-01  1.01190184e+00  1.01190184e+00  1.01190184e+00
  1.03884272e+00  7.24203092e+00  7.24203092e+00  7.24203092e+00
  1.35566040e+01  3.31652219e+01  3.31652219e+01  3.31652219e+01
  1.22682890e+02  1.27882715e+02  1.27882715e+02  1.27882715e+02
  4.79095852e+02  4.79095852e+02  4.79095852e+02  6.65720743e+02
  1.32414351e+03  1.32414351e+03  1.32414351e+03  2.81226519e+03
  3.00970539e+03  3.00970539e+03  3.00970539e+03  6.62460489e+03
  6.62460489e+03  6.62460489e+03  9.23252650e+03  2.55786121e+04
  7.63076367e+04]
E1 = -728.3081940451547  E_coul = 201.56204849131785
Extra cycle  E= -526.746145553837  delta_E= -7.96e-13  |g|= 3.43e-07  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828775e+04 7.61702773e+03 3.61756864e+03 1.58702108e+03
 4.18887778e+02 1.22695388e+02 3.94917602e+01 8.50327606e+00
 3.35697748e+00 6.74334176e-01 2.49846921e-01 1.36285955e+03
 6.64046529e+02 2.97683762e+02 3.11220403e+02 6.11496314e+01
 7.29028615e+00 2.00956366e+01 7.74104789e-01 2.79999405e+00
 2.22414893e-01]
E = -526.7461455538369
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:15:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8774727        1
[INPUT] 0    0    [1    /1   ]  7617.0277342         1
[INPUT] 0    0    [1    /1   ]  3617.5686428         1
[INPUT] 0    0    [1    /1   ]  1587.02107922        1
[INPUT] 0    0    [1    /1   ]  418.887777672        1
[INPUT] 0    0    [1    /1   ]  122.695388157        1
[INPUT] 0    0    [1    /1   ]  39.4917601835        1
[INPUT] 0    0    [1    /1   ]  8.50327605592        1
[INPUT] 0    0    [1    /1   ]  3.35697748139        1
[INPUT] 0    0    [1    /1   ]  0.674334176026       1
[INPUT] 0    0    [1    /1   ]  0.249846920687       1
[INPUT] 1    0    [1    /1   ]  1362.85954735        1
[INPUT] 1    0    [1    /1   ]  664.046529157        1
[INPUT] 1    0    [1    /1   ]  297.683761591        1
[INPUT] 1    0    [1    /1   ]  311.220402598        1
[INPUT] 1    0    [1    /1   ]  61.1496313861        1
[INPUT] 1    0    [1    /1   ]  7.2902861474         1
[INPUT] 1    0    [1    /1   ]  20.0956365715        1
[INPUT] 1    0    [1    /1   ]  0.774104789103       1
[INPUT] 1    0    [1    /1   ]  2.79999405123        1
[INPUT] 1    0    [1    /1   ]  0.222414892773       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.877472681223, 1.0]], [0, [7617.027734199872, 1.0]], [0, [3617.568642797338, 1.0]], [0, [1587.0210792151047, 1.0]], [0, [418.88777767249877, 1.0]], [0, [122.69538815652045, 1.0]], [0, [39.49176018352847, 1.0]], [0, [8.503276055919377, 1.0]], [0, [3.3569774813926996, 1.0]], [0, [0.6743341760262199, 1.0]], [0, [0.24984692068708572, 1.0]], [1, [1362.8595473478654, 1.0]], [1, [664.0465291574903, 1.0]], [1, [297.68376159134107, 1.0]], [1, [311.2204025979543, 1.0]], [1, [61.149631386131205, 1.0]], [1, [7.2902861473978895, 1.0]], [1, [20.095636571515033, 1.0]], [1, [0.7741047891025701, 1.0]], [1, [2.799994051231169, 1.0]], [1, [0.22241489277315593, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87747268]
bas 1, expnt(s) = [7617.0277342]
bas 2, expnt(s) = [3617.5686428]
bas 3, expnt(s) = [1587.02107922]
bas 4, expnt(s) = [418.88777767]
bas 5, expnt(s) = [122.69538816]
bas 6, expnt(s) = [39.49176018]
bas 7, expnt(s) = [8.50327606]
bas 8, expnt(s) = [3.35697748]
bas 9, expnt(s) = [0.67433418]
bas 10, expnt(s) = [0.24984692]
bas 11, expnt(s) = [1362.85954735]
bas 12, expnt(s) = [664.04652916]
bas 13, expnt(s) = [297.68376159]
bas 14, expnt(s) = [311.2204026]
bas 15, expnt(s) = [61.14963139]
bas 16, expnt(s) = [7.29028615]
bas 17, expnt(s) = [20.09563657]
bas 18, expnt(s) = [0.77410479]
bas 19, expnt(s) = [2.79999405]
bas 20, expnt(s) = [0.22241489]
CPU time:       557.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828775e+04 5.20029588e+03 7.61702773e+03 2.05993813e+03
 3.61756864e+03 1.17849463e+03 1.58702108e+03 6.35260783e+02
 4.18887778e+02 2.33931277e+02 1.22695388e+02 9.31399935e+01
 3.94917602e+01 3.98010833e+01 8.50327606e+00 1.25806979e+01
 3.35697748e+00 6.26579736e+00 6.74334176e-01 1.88005867e+00
 2.49846921e-01 8.92833599e-01 1.36285955e+03 2.41572931e+04
 6.64046529e+02 9.83405270e+03 2.97683762e+02 3.60726729e+03
 3.11220403e+02 3.81346239e+03 6.11496314e+01 4.98857719e+02
 7.29028615e+00 3.49474193e+01 2.00956366e+01 1.24125669e+02
 7.74104789e-01 2.11828351e+00 2.79999405e+00 1.05664908e+01
 2.22414893e-01 4.45593885e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993521307366724
cond(S) = 93271.69324070434
E1 = -729.5314884340304  E_coul = 203.17979172670516
init E= -526.351696707325
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555800785115742  LUMO = 1.03041285961215
  mo_energy =
[-1.18331959e+02 -1.22047272e+01 -9.44670913e+00 -9.44670913e+00
 -9.44670913e+00 -1.23994250e+00 -5.55800785e-01 -5.55800785e-01
 -5.55800785e-01  1.03041286e+00  1.03041286e+00  1.03041286e+00
  1.06116854e+00  7.31230202e+00  7.31230202e+00  7.31230202e+00
  1.36439555e+01  3.32843129e+01  3.32843129e+01  3.32843129e+01
  1.22862816e+02  1.28061884e+02  1.28061884e+02  1.28061884e+02
  4.79343009e+02  4.79343009e+02  4.79343009e+02  6.66012753e+02
  1.32444283e+03  1.32444283e+03  1.32444283e+03  2.81269625e+03
  3.01006834e+03  3.01006834e+03  3.01006834e+03  6.62507830e+03
  6.62507830e+03  6.62507830e+03  9.23307260e+03  2.55792515e+04
  7.63083656e+04]
E1 = -727.8645806951304  E_coul = 201.11920445267592
cycle= 1 E= -526.745376242454  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537514
diis-c [-0.28892119  1.        ]
  HOMO = -0.590535870687573  LUMO = 1.00629370831709
  mo_energy =
[-1.18637659e+02 -1.23418544e+01 -9.59438068e+00 -9.59438068e+00
 -9.59438068e+00 -1.27931224e+00 -5.90535871e-01 -5.90535871e-01
 -5.90535871e-01  1.00629371e+00  1.00629371e+00  1.00629371e+00
  1.03168657e+00  7.22221644e+00  7.22221644e+00  7.22221644e+00
  1.35302627e+01  3.31316009e+01  3.31316009e+01  3.31316009e+01
  1.22634307e+02  1.27835564e+02  1.27835564e+02  1.27835564e+02
  4.79039255e+02  4.79039255e+02  4.79039255e+02  6.65661617e+02
  1.32408346e+03  1.32408346e+03  1.32408346e+03  2.81220242e+03
  3.00964350e+03  3.00964350e+03  3.00964350e+03  6.62454164e+03
  6.62454164e+03  6.62454164e+03  9.23246265e+03  2.55785479e+04
  7.63075723e+04]
E1 = -728.4351509173707  E_coul = 201.68906549806954
cycle= 2 E= -526.746085419301  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746437
diis-c [-0.00326379  0.08247143  0.91752857]
  HOMO = -0.581466564667764  LUMO = 1.01296378016883
  mo_energy =
[-1.18570424e+02 -1.23040328e+01 -9.55491224e+00 -9.55491224e+00
 -9.55491224e+00 -1.26845947e+00 -5.81466565e-01 -5.81466565e-01
 -5.81466565e-01  1.01296378e+00  1.01296378e+00  1.01296378e+00
  1.04010141e+00  7.24574960e+00  7.24574960e+00  7.24574960e+00
  1.35613325e+01  3.31713174e+01  3.31713174e+01  3.31713174e+01
  1.22691326e+02  1.27890982e+02  1.27890982e+02  1.27890982e+02
  4.79105619e+02  4.79105619e+02  4.79105619e+02  6.65730966e+02
  1.32415387e+03  1.32415387e+03  1.32415387e+03  2.81227621e+03
  3.00971615e+03  3.00971615e+03  3.00971615e+03  6.62461605e+03
  6.62461605e+03  6.62461605e+03  9.23253788e+03  2.55786237e+04
  7.63076484e+04]
E1 = -728.2856244498217  E_coul = 201.53948079985813
cycle= 3 E= -526.746143649964  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130797
diis-c [-5.36127791e-07 -1.21838440e-03  1.44768276e-01  8.56450109e-01]
  HOMO = -0.582957000780377  LUMO = 1.01189092254245
  mo_energy =
[-1.18580325e+02 -1.23098109e+01 -9.56103240e+00 -9.56103240e+00
 -9.56103240e+00 -1.27014579e+00 -5.82957001e-01 -5.82957001e-01
 -5.82957001e-01  1.01189092e+00  1.01189092e+00  1.01189092e+00
  1.03881259e+00  7.24200563e+00  7.24200563e+00  7.24200563e+00
  1.35565631e+01  3.31651960e+01  3.31651960e+01  3.31651960e+01
  1.22682867e+02  1.27882695e+02  1.27882695e+02  1.27882695e+02
  4.79095841e+02  4.79095841e+02  4.79095841e+02  6.65720742e+02
  1.32414351e+03  1.32414351e+03  1.32414351e+03  2.81226521e+03
  3.00970540e+03  3.00970540e+03  3.00970540e+03  6.62460491e+03
  6.62460491e+03  6.62460491e+03  9.23252653e+03  2.55786122e+04
  7.63076368e+04]
E1 = -728.3083232588943  E_coul = 201.56217770660942
cycle= 4 E= -526.746145552285  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107529
diis-c [-3.84541020e-09  6.71629563e-05 -9.74435998e-03 -6.32202658e-02
  1.07289746e+00]
  HOMO = -0.582938665103078  LUMO = 1.01190652123609
  mo_energy =
[-1.18580285e+02 -1.23097473e+01 -9.56098172e+00 -9.56098172e+00
 -9.56098172e+00 -1.27010606e+00 -5.82938665e-01 -5.82938665e-01
 -5.82938665e-01  1.01190652e+00  1.01190652e+00  1.01190652e+00
  1.03884634e+00  7.24204681e+00  7.24204681e+00  7.24204681e+00
  1.35566218e+01  3.31652447e+01  3.31652447e+01  3.31652447e+01
  1.22682917e+02  1.27882742e+02  1.27882742e+02  1.27882742e+02
  4.79095882e+02  4.79095882e+02  4.79095882e+02  6.65720773e+02
  1.32414354e+03  1.32414354e+03  1.32414354e+03  2.81226522e+03
  3.00970543e+03  3.00970543e+03  3.00970543e+03  6.62460492e+03
  6.62460492e+03  6.62460492e+03  9.23252653e+03  2.55786121e+04
  7.63076367e+04]
E1 = -728.3081157686042  E_coul = 201.56197021482325
cycle= 5 E= -526.746145553781  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79681e-05
diis-c [-6.64176205e-11  1.40767934e-05 -1.85194933e-03 -1.38215522e-02
  4.27435963e-02  9.72915828e-01]
  HOMO = -0.582945787487348  LUMO = 1.01190181186731
  mo_energy =
[-1.18580315e+02 -1.23097690e+01 -9.56100528e+00 -9.56100528e+00
 -9.56100528e+00 -1.27011175e+00 -5.82945787e-01 -5.82945787e-01
 -5.82945787e-01  1.01190181e+00  1.01190181e+00  1.01190181e+00
  1.03884240e+00  7.24203091e+00  7.24203091e+00  7.24203091e+00
  1.35566038e+01  3.31652219e+01  3.31652219e+01  3.31652219e+01
  1.22682890e+02  1.27882715e+02  1.27882715e+02  1.27882715e+02
  4.79095852e+02  4.79095852e+02  4.79095852e+02  6.65720743e+02
  1.32414351e+03  1.32414351e+03  1.32414351e+03  2.81226519e+03
  3.00970539e+03  3.00970539e+03  3.00970539e+03  6.62460489e+03
  6.62460489e+03  6.62460489e+03  9.23252650e+03  2.55786121e+04
  7.63076367e+04]
E1 = -728.3081947359059  E_coul = 201.56204918206984
cycle= 6 E= -526.746145553836  delta_E= -5.51e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3081947359059  E_coul = 201.56204918206984
  HOMO = -0.582945818357633  LUMO = 1.01190184400075
  mo_energy =
[-1.18580315e+02 -1.23097689e+01 -9.56100529e+00 -9.56100529e+00
 -9.56100529e+00 -1.27011141e+00 -5.82945818e-01 -5.82945818e-01
 -5.82945818e-01  1.01190184e+00  1.01190184e+00  1.01190184e+00
  1.03884272e+00  7.24203092e+00  7.24203092e+00  7.24203092e+00
  1.35566040e+01  3.31652219e+01  3.31652219e+01  3.31652219e+01
  1.22682890e+02  1.27882715e+02  1.27882715e+02  1.27882715e+02
  4.79095852e+02  4.79095852e+02  4.79095852e+02  6.65720743e+02
  1.32414351e+03  1.32414351e+03  1.32414351e+03  2.81226519e+03
  3.00970539e+03  3.00970539e+03  3.00970539e+03  6.62460489e+03
  6.62460489e+03  6.62460489e+03  9.23252650e+03  2.55786121e+04
  7.63076367e+04]
E1 = -728.3081940451547  E_coul = 201.56204849131785
Extra cycle  E= -526.746145553837  delta_E= -7.96e-13  |g|= 3.43e-07  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93271.69324070434
E1 = -728.3081940451547  E_coul = 201.56204849131785
init E= -526.746145553837
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582945842093818  LUMO = 1.01190183846349
  mo_energy =
[-1.18580315e+02 -1.23097690e+01 -9.56100535e+00 -9.56100535e+00
 -9.56100535e+00 -1.27011136e+00 -5.82945842e-01 -5.82945842e-01
 -5.82945842e-01  1.01190184e+00  1.01190184e+00  1.01190184e+00
  1.03884277e+00  7.24203088e+00  7.24203088e+00  7.24203088e+00
  1.35566039e+01  3.31652218e+01  3.31652218e+01  3.31652218e+01
  1.22682890e+02  1.27882715e+02  1.27882715e+02  1.27882715e+02
  4.79095852e+02  4.79095852e+02  4.79095852e+02  6.65720743e+02
  1.32414351e+03  1.32414351e+03  1.32414351e+03  2.81226519e+03
  3.00970539e+03  3.00970539e+03  3.00970539e+03  6.62460489e+03
  6.62460489e+03  6.62460489e+03  9.23252650e+03  2.55786121e+04
  7.63076367e+04]
E1 = -728.308194143275  E_coul = 201.56204858943892
cycle= 1 E= -526.746145553836  delta_E= 6.82e-13  |g|= 7.11e-08  |ddm|= 5.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.308194143275  E_coul = 201.56204858943892
  HOMO = -0.582945842462918  LUMO = 1.0119018405395
  mo_energy =
[-1.18580315e+02 -1.23097690e+01 -9.56100535e+00 -9.56100535e+00
 -9.56100535e+00 -1.27011135e+00 -5.82945842e-01 -5.82945842e-01
 -5.82945842e-01  1.01190184e+00  1.01190184e+00  1.01190184e+00
  1.03884278e+00  7.24203089e+00  7.24203089e+00  7.24203089e+00
  1.35566039e+01  3.31652218e+01  3.31652218e+01  3.31652218e+01
  1.22682890e+02  1.27882715e+02  1.27882715e+02  1.27882715e+02
  4.79095852e+02  4.79095852e+02  4.79095852e+02  6.65720743e+02
  1.32414351e+03  1.32414351e+03  1.32414351e+03  2.81226519e+03
  3.00970539e+03  3.00970539e+03  3.00970539e+03  6.62460489e+03
  6.62460489e+03  6.62460489e+03  9.23252650e+03  2.55786121e+04
  7.63076367e+04]
E1 = -728.3081940958646  E_coul = 201.56204854202795
Extra cycle  E= -526.746145553837  delta_E= -4.55e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828775e+04 7.61702773e+03 3.61756864e+03 1.58702108e+03
 4.18887778e+02 1.22695388e+02 3.94917602e+01 8.50327606e+00
 3.35697748e+00 6.74334176e-01 2.49846921e-01 1.36285955e+03
 6.64046529e+02 2.97683762e+02 3.11220403e+02 6.11496314e+01
 7.29028615e+00 2.00956366e+01 7.74104789e-01 2.79999405e+00
 2.22414893e-01]
grad_E = [-1.39416184e-06  2.13299741e-06 -2.14348468e-06  3.62586971e-05
  1.31411690e-05  3.56054588e-06  1.74485388e-07 -4.29214122e-08
  3.71798201e-07 -4.04014086e-06  8.55131136e-06 -5.12639895e-07
  5.11857409e-06  2.44456068e-05  2.09191940e-05 -2.63175632e-05
 -3.83425675e-06 -8.46244798e-06 -2.23590661e-05 -6.80917529e-06
  4.81432870e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8771341        1
[INPUT] 0    0    [1    /1   ]  7617.0283215         1
[INPUT] 0    0    [1    /1   ]  3617.56817597        1
[INPUT] 0    0    [1    /1   ]  1587.03212362        1
[INPUT] 0    0    [1    /1   ]  418.873629398        1
[INPUT] 0    0    [1    /1   ]  122.691356972        1
[INPUT] 0    0    [1    /1   ]  39.4909873013        1
[INPUT] 0    0    [1    /1   ]  8.50316225609        1
[INPUT] 0    0    [1    /1   ]  3.35691448107        1
[INPUT] 0    0    [1    /1   ]  0.674316624753       1
[INPUT] 0    0    [1    /1   ]  0.249837390625       1
[INPUT] 1    0    [1    /1   ]  1362.85941135        1
[INPUT] 1    0    [1    /1   ]  664.047525175        1
[INPUT] 1    0    [1    /1   ]  297.688337726        1
[INPUT] 1    0    [1    /1   ]  311.224318852        1
[INPUT] 1    0    [1    /1   ]  61.1634536038        1
[INPUT] 1    0    [1    /1   ]  7.29232774338        1
[INPUT] 1    0    [1    /1   ]  20.1010157637        1
[INPUT] 1    0    [1    /1   ]  0.774198044086       1
[INPUT] 1    0    [1    /1   ]  2.80073551591        1
[INPUT] 1    0    [1    /1   ]  0.222433464093       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.877134100076, 1.0]], [0, [7617.028321501652, 1.0]], [0, [3617.5681759659806, 1.0]], [0, [1587.032123616992, 1.0]], [0, [418.87362939814733, 1.0]], [0, [122.69135697240584, 1.0]], [0, [39.49098730133206, 1.0]], [0, [8.503162256094775, 1.0]], [0, [3.3569144810682325, 1.0]], [0, [0.6743166247527114, 1.0]], [0, [0.2498373906248573, 1.0]], [1, [1362.859411346261, 1.0]], [1, [664.0475251752804, 1.0]], [1, [297.68833772612777, 1.0]], [1, [311.224318851886, 1.0]], [1, [61.16345360378945, 1.0]], [1, [7.292327743380674, 1.0]], [1, [20.101015763685513, 1.0]], [1, [0.7741980440863303, 1.0]], [1, [2.8007355159071357, 1.0]], [1, [0.22243346409298442, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8771341]
bas 1, expnt(s) = [7617.0283215]
bas 2, expnt(s) = [3617.56817597]
bas 3, expnt(s) = [1587.03212362]
bas 4, expnt(s) = [418.8736294]
bas 5, expnt(s) = [122.69135697]
bas 6, expnt(s) = [39.4909873]
bas 7, expnt(s) = [8.50316226]
bas 8, expnt(s) = [3.35691448]
bas 9, expnt(s) = [0.67431662]
bas 10, expnt(s) = [0.24983739]
bas 11, expnt(s) = [1362.85941135]
bas 12, expnt(s) = [664.04752518]
bas 13, expnt(s) = [297.68833773]
bas 14, expnt(s) = [311.22431885]
bas 15, expnt(s) = [61.1634536]
bas 16, expnt(s) = [7.29232774]
bas 17, expnt(s) = [20.10101576]
bas 18, expnt(s) = [0.77419804]
bas 19, expnt(s) = [2.80073552]
bas 20, expnt(s) = [0.22243346]
CPU time:       563.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828771e+04 5.20029583e+03 7.61702832e+03 2.05993825e+03
 3.61756818e+03 1.17849452e+03 1.58703212e+03 6.35264099e+02
 4.18873629e+02 2.33925351e+02 1.22691357e+02 9.31376984e+01
 3.94909873e+01 3.98004991e+01 8.50316226e+00 1.25805716e+01
 3.35691448e+00 6.26570916e+00 6.74316625e-01 1.88002197e+00
 2.49837391e-01 8.92808057e-01 1.36285941e+03 2.41572901e+04
 6.64047525e+02 9.83407114e+03 2.97688338e+02 3.60733661e+03
 3.11224319e+02 3.81352238e+03 6.11634536e+01 4.98998675e+02
 7.29232774e+00 3.49596533e+01 2.01010158e+01 1.24167203e+02
 7.74198044e-01 2.11860250e+00 2.80073552e+00 1.05699885e+01
 2.22433464e-01 4.45640394e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9935182556759
cond(S) = 93307.25101324887
E1 = -729.5314922500056  E_coul = 203.17979446937147
init E= -526.351697780634
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555799966878916  LUMO = 1.0305680096498
  mo_energy =
[-1.18331958e+02 -1.22047270e+01 -9.44670975e+00 -9.44670975e+00
 -9.44670975e+00 -1.23994280e+00 -5.55799967e-01 -5.55799967e-01
 -5.55799967e-01  1.03056801e+00  1.03056801e+00  1.03056801e+00
  1.06110823e+00  7.31455492e+00  7.31455492e+00  7.31455492e+00
  1.36434887e+01  3.32956455e+01  3.32956455e+01  3.32956455e+01
  1.22858694e+02  1.28099510e+02  1.28099510e+02  1.28099510e+02
  4.79411269e+02  4.79411269e+02  4.79411269e+02  6.65989623e+02
  1.32452618e+03  1.32452618e+03  1.32452618e+03  2.81264878e+03
  3.01016321e+03  3.01016321e+03  3.01016321e+03  6.62517659e+03
  6.62517659e+03  6.62517659e+03  9.23302854e+03  2.55792181e+04
  7.63083392e+04]
E1 = -727.8646450215008  E_coul = 201.1192687181403
cycle= 1 E= -526.74537630336  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.53752
diis-c [-0.28892759  1.        ]
  HOMO = -0.590532945689955  LUMO = 1.0064462970445
  mo_energy =
[-1.18637652e+02 -1.23418502e+01 -9.59437753e+00 -9.59437753e+00
 -9.59437753e+00 -1.27930984e+00 -5.90532946e-01 -5.90532946e-01
 -5.90532946e-01  1.00644630e+00  1.00644630e+00  1.00644630e+00
  1.03163014e+00  7.22445627e+00  7.22445627e+00  7.22445627e+00
  1.35298011e+01  3.31429202e+01  3.31429202e+01  3.31429202e+01
  1.22630192e+02  1.27873181e+02  1.27873181e+02  1.27873181e+02
  4.79107520e+02  4.79107520e+02  4.79107520e+02  6.65638497e+02
  1.32416682e+03  1.32416682e+03  1.32416682e+03  2.81215496e+03
  3.00973837e+03  3.00973837e+03  3.00973837e+03  6.62463993e+03
  6.62463993e+03  6.62463993e+03  9.23241860e+03  2.55785145e+04
  7.63075459e+04]
E1 = -728.4351859484806  E_coul = 201.68910050936148
cycle= 2 E= -526.746085439119  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746422
diis-c [-0.00326367  0.08246895  0.91753105]
  HOMO = -0.581464235874655  LUMO = 1.01311710173036
  mo_energy =
[-1.18570419e+02 -1.23040305e+01 -9.55491102e+00 -9.55491102e+00
 -9.55491102e+00 -1.26845776e+00 -5.81464236e-01 -5.81464236e-01
 -5.81464236e-01  1.01311710e+00  1.01311710e+00  1.01311710e+00
  1.04004408e+00  7.24799238e+00  7.24799238e+00  7.24799238e+00
  1.35608689e+01  3.31826391e+01  3.31826391e+01  3.31826391e+01
  1.22687208e+02  1.27928599e+02  1.27928599e+02  1.27928599e+02
  4.79173882e+02  4.79173882e+02  4.79173882e+02  6.65707843e+02
  1.32423722e+03  1.32423722e+03  1.32423722e+03  2.81222874e+03
  3.00981103e+03  3.00981103e+03  3.00981103e+03  6.62471433e+03
  6.62471433e+03  6.62471433e+03  9.23249382e+03  2.55785903e+04
  7.63076220e+04]
E1 = -728.285670142018  E_coul = 201.5395264787075
cycle= 3 E= -526.74614366331  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130794
diis-c [-5.36155385e-07 -1.21839691e-03  1.44766946e-01  8.56451451e-01]
  HOMO = -0.582954553512997  LUMO = 1.01204414370946
  mo_energy =
[-1.18580320e+02 -1.23098082e+01 -9.56103081e+00 -9.56103081e+00
 -9.56103081e+00 -1.27014393e+00 -5.82954554e-01 -5.82954554e-01
 -5.82954554e-01  1.01204414e+00  1.01204414e+00  1.01204414e+00
  1.03875544e+00  7.24424802e+00  7.24424802e+00  7.24424802e+00
  1.35560999e+01  3.31765174e+01  3.31765174e+01  3.31765174e+01
  1.22678750e+02  1.27920312e+02  1.27920312e+02  1.27920312e+02
  4.79164105e+02  4.79164105e+02  4.79164105e+02  6.65697619e+02
  1.32422686e+03  1.32422686e+03  1.32422686e+03  2.81221774e+03
  3.00980028e+03  3.00980028e+03  3.00980028e+03  6.62470320e+03
  6.62470320e+03  6.62470320e+03  9.23248248e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3083669297756  E_coul = 201.56222136441787
cycle= 4 E= -526.746145565358  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107553
diis-c [-3.84505124e-09  6.71866916e-05 -9.74730691e-03 -6.32408098e-02
  1.07292093e+00]
  HOMO = -0.582936223856673  LUMO = 1.01205974068036
  mo_energy =
[-1.18580280e+02 -1.23097446e+01 -9.56098014e+00 -9.56098014e+00
 -9.56098014e+00 -1.27010420e+00 -5.82936224e-01 -5.82936224e-01
 -5.82936224e-01  1.01205974e+00  1.01205974e+00  1.01205974e+00
  1.03878918e+00  7.24428919e+00  7.24428919e+00  7.24428919e+00
  1.35561586e+01  3.31765661e+01  3.31765661e+01  3.31765661e+01
  1.22678800e+02  1.27920359e+02  1.27920359e+02  1.27920359e+02
  4.79164145e+02  4.79164145e+02  4.79164145e+02  6.65697651e+02
  1.32422689e+03  1.32422689e+03  1.32422689e+03  2.81221776e+03
  3.00980030e+03  3.00980030e+03  3.00980030e+03  6.62470321e+03
  6.62470321e+03  6.62470321e+03  9.23248248e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3081594888633  E_coul = 201.56201392200768
cycle= 5 E= -526.746145566856  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79664e-05
diis-c [-6.64305438e-11  1.40762992e-05 -1.85185032e-03 -1.38211177e-02
  4.27408730e-02  9.72918019e-01]
  HOMO = -0.582943346372961  LUMO = 1.01205503038202
  mo_energy =
[-1.18580309e+02 -1.23097663e+01 -9.56100371e+00 -9.56100371e+00
 -9.56100371e+00 -1.27010989e+00 -5.82943346e-01 -5.82943346e-01
 -5.82943346e-01  1.01205503e+00  1.01205503e+00  1.01205503e+00
  1.03878524e+00  7.24427329e+00  7.24427329e+00  7.24427329e+00
  1.35561406e+01  3.31765432e+01  3.31765432e+01  3.31765432e+01
  1.22678773e+02  1.27920332e+02  1.27920332e+02  1.27920332e+02
  4.79164116e+02  4.79164116e+02  4.79164116e+02  6.65697621e+02
  1.32422686e+03  1.32422686e+03  1.32422686e+03  2.81221772e+03
  3.00980027e+03  3.00980027e+03  3.00980027e+03  6.62470317e+03
  6.62470317e+03  6.62470317e+03  9.23248244e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3082384514311  E_coul = 201.5620928845224
cycle= 6 E= -526.746145566909  delta_E= -5.31e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3082384514311  E_coul = 201.5620928845224
  HOMO = -0.582943377146247  LUMO = 1.01205506258115
  mo_energy =
[-1.18580309e+02 -1.23097663e+01 -9.56100371e+00 -9.56100371e+00
 -9.56100371e+00 -1.27010955e+00 -5.82943377e-01 -5.82943377e-01
 -5.82943377e-01  1.01205506e+00  1.01205506e+00  1.01205506e+00
  1.03878556e+00  7.24427330e+00  7.24427330e+00  7.24427330e+00
  1.35561408e+01  3.31765433e+01  3.31765433e+01  3.31765433e+01
  1.22678773e+02  1.27920333e+02  1.27920333e+02  1.27920333e+02
  4.79164116e+02  4.79164116e+02  4.79164116e+02  6.65697621e+02
  1.32422686e+03  1.32422686e+03  1.32422686e+03  2.81221772e+03
  3.00980027e+03  3.00980027e+03  3.00980027e+03  6.62470317e+03
  6.62470317e+03  6.62470317e+03  9.23248244e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3082377586767  E_coul = 201.56209219176603
Extra cycle  E= -526.746145566911  delta_E= -1.93e-12  |g|= 3.43e-07  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828771e+04 7.61702832e+03 3.61756818e+03 1.58703212e+03
 4.18873629e+02 1.22691357e+02 3.94909873e+01 8.50316226e+00
 3.35691448e+00 6.74316625e-01 2.49837391e-01 1.36285941e+03
 6.64047525e+02 2.97688338e+02 3.11224319e+02 6.11634536e+01
 7.29232774e+00 2.01010158e+01 7.74198044e-01 2.80073552e+00
 2.22433464e-01]
E = -526.7461455669106
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8771341        1
[INPUT] 0    0    [1    /1   ]  7617.0283215         1
[INPUT] 0    0    [1    /1   ]  3617.56817597        1
[INPUT] 0    0    [1    /1   ]  1587.03212362        1
[INPUT] 0    0    [1    /1   ]  418.873629398        1
[INPUT] 0    0    [1    /1   ]  122.691356972        1
[INPUT] 0    0    [1    /1   ]  39.4909873013        1
[INPUT] 0    0    [1    /1   ]  8.50316225609        1
[INPUT] 0    0    [1    /1   ]  3.35691448107        1
[INPUT] 0    0    [1    /1   ]  0.674316624753       1
[INPUT] 0    0    [1    /1   ]  0.249837390625       1
[INPUT] 1    0    [1    /1   ]  1362.85941135        1
[INPUT] 1    0    [1    /1   ]  664.047525175        1
[INPUT] 1    0    [1    /1   ]  297.688337726        1
[INPUT] 1    0    [1    /1   ]  311.224318852        1
[INPUT] 1    0    [1    /1   ]  61.1634536038        1
[INPUT] 1    0    [1    /1   ]  7.29232774338        1
[INPUT] 1    0    [1    /1   ]  20.1010157637        1
[INPUT] 1    0    [1    /1   ]  0.774198044086       1
[INPUT] 1    0    [1    /1   ]  2.80073551591        1
[INPUT] 1    0    [1    /1   ]  0.222433464093       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.877134100076, 1.0]], [0, [7617.028321501652, 1.0]], [0, [3617.5681759659806, 1.0]], [0, [1587.032123616992, 1.0]], [0, [418.87362939814733, 1.0]], [0, [122.69135697240584, 1.0]], [0, [39.49098730133206, 1.0]], [0, [8.503162256094775, 1.0]], [0, [3.3569144810682325, 1.0]], [0, [0.6743166247527114, 1.0]], [0, [0.2498373906248573, 1.0]], [1, [1362.859411346261, 1.0]], [1, [664.0475251752804, 1.0]], [1, [297.68833772612777, 1.0]], [1, [311.224318851886, 1.0]], [1, [61.16345360378945, 1.0]], [1, [7.292327743380674, 1.0]], [1, [20.101015763685513, 1.0]], [1, [0.7741980440863303, 1.0]], [1, [2.8007355159071357, 1.0]], [1, [0.22243346409298442, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.8771341]
bas 1, expnt(s) = [7617.0283215]
bas 2, expnt(s) = [3617.56817597]
bas 3, expnt(s) = [1587.03212362]
bas 4, expnt(s) = [418.8736294]
bas 5, expnt(s) = [122.69135697]
bas 6, expnt(s) = [39.4909873]
bas 7, expnt(s) = [8.50316226]
bas 8, expnt(s) = [3.35691448]
bas 9, expnt(s) = [0.67431662]
bas 10, expnt(s) = [0.24983739]
bas 11, expnt(s) = [1362.85941135]
bas 12, expnt(s) = [664.04752518]
bas 13, expnt(s) = [297.68833773]
bas 14, expnt(s) = [311.22431885]
bas 15, expnt(s) = [61.1634536]
bas 16, expnt(s) = [7.29232774]
bas 17, expnt(s) = [20.10101576]
bas 18, expnt(s) = [0.77419804]
bas 19, expnt(s) = [2.80073552]
bas 20, expnt(s) = [0.22243346]
CPU time:       564.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828771e+04 5.20029583e+03 7.61702832e+03 2.05993825e+03
 3.61756818e+03 1.17849452e+03 1.58703212e+03 6.35264099e+02
 4.18873629e+02 2.33925351e+02 1.22691357e+02 9.31376984e+01
 3.94909873e+01 3.98004991e+01 8.50316226e+00 1.25805716e+01
 3.35691448e+00 6.26570916e+00 6.74316625e-01 1.88002197e+00
 2.49837391e-01 8.92808057e-01 1.36285941e+03 2.41572901e+04
 6.64047525e+02 9.83407114e+03 2.97688338e+02 3.60733661e+03
 3.11224319e+02 3.81352238e+03 6.11634536e+01 4.98998675e+02
 7.29232774e+00 3.49596533e+01 2.01010158e+01 1.24167203e+02
 7.74198044e-01 2.11860250e+00 2.80073552e+00 1.05699885e+01
 2.22433464e-01 4.45640394e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.9935182556759
cond(S) = 93307.25101324887
E1 = -729.5314922500056  E_coul = 203.17979446937147
init E= -526.351697780634
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555799966878916  LUMO = 1.0305680096498
  mo_energy =
[-1.18331958e+02 -1.22047270e+01 -9.44670975e+00 -9.44670975e+00
 -9.44670975e+00 -1.23994280e+00 -5.55799967e-01 -5.55799967e-01
 -5.55799967e-01  1.03056801e+00  1.03056801e+00  1.03056801e+00
  1.06110823e+00  7.31455492e+00  7.31455492e+00  7.31455492e+00
  1.36434887e+01  3.32956455e+01  3.32956455e+01  3.32956455e+01
  1.22858694e+02  1.28099510e+02  1.28099510e+02  1.28099510e+02
  4.79411269e+02  4.79411269e+02  4.79411269e+02  6.65989623e+02
  1.32452618e+03  1.32452618e+03  1.32452618e+03  2.81264878e+03
  3.01016321e+03  3.01016321e+03  3.01016321e+03  6.62517659e+03
  6.62517659e+03  6.62517659e+03  9.23302854e+03  2.55792181e+04
  7.63083392e+04]
E1 = -727.8646450215008  E_coul = 201.1192687181403
cycle= 1 E= -526.74537630336  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.53752
diis-c [-0.28892759  1.        ]
  HOMO = -0.590532945689955  LUMO = 1.0064462970445
  mo_energy =
[-1.18637652e+02 -1.23418502e+01 -9.59437753e+00 -9.59437753e+00
 -9.59437753e+00 -1.27930984e+00 -5.90532946e-01 -5.90532946e-01
 -5.90532946e-01  1.00644630e+00  1.00644630e+00  1.00644630e+00
  1.03163014e+00  7.22445627e+00  7.22445627e+00  7.22445627e+00
  1.35298011e+01  3.31429202e+01  3.31429202e+01  3.31429202e+01
  1.22630192e+02  1.27873181e+02  1.27873181e+02  1.27873181e+02
  4.79107520e+02  4.79107520e+02  4.79107520e+02  6.65638497e+02
  1.32416682e+03  1.32416682e+03  1.32416682e+03  2.81215496e+03
  3.00973837e+03  3.00973837e+03  3.00973837e+03  6.62463993e+03
  6.62463993e+03  6.62463993e+03  9.23241860e+03  2.55785145e+04
  7.63075459e+04]
E1 = -728.4351859484806  E_coul = 201.68910050936148
cycle= 2 E= -526.746085439119  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746422
diis-c [-0.00326367  0.08246895  0.91753105]
  HOMO = -0.581464235874655  LUMO = 1.01311710173036
  mo_energy =
[-1.18570419e+02 -1.23040305e+01 -9.55491102e+00 -9.55491102e+00
 -9.55491102e+00 -1.26845776e+00 -5.81464236e-01 -5.81464236e-01
 -5.81464236e-01  1.01311710e+00  1.01311710e+00  1.01311710e+00
  1.04004408e+00  7.24799238e+00  7.24799238e+00  7.24799238e+00
  1.35608689e+01  3.31826391e+01  3.31826391e+01  3.31826391e+01
  1.22687208e+02  1.27928599e+02  1.27928599e+02  1.27928599e+02
  4.79173882e+02  4.79173882e+02  4.79173882e+02  6.65707843e+02
  1.32423722e+03  1.32423722e+03  1.32423722e+03  2.81222874e+03
  3.00981103e+03  3.00981103e+03  3.00981103e+03  6.62471433e+03
  6.62471433e+03  6.62471433e+03  9.23249382e+03  2.55785903e+04
  7.63076220e+04]
E1 = -728.285670142018  E_coul = 201.5395264787075
cycle= 3 E= -526.74614366331  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130794
diis-c [-5.36155385e-07 -1.21839691e-03  1.44766946e-01  8.56451451e-01]
  HOMO = -0.582954553512997  LUMO = 1.01204414370946
  mo_energy =
[-1.18580320e+02 -1.23098082e+01 -9.56103081e+00 -9.56103081e+00
 -9.56103081e+00 -1.27014393e+00 -5.82954554e-01 -5.82954554e-01
 -5.82954554e-01  1.01204414e+00  1.01204414e+00  1.01204414e+00
  1.03875544e+00  7.24424802e+00  7.24424802e+00  7.24424802e+00
  1.35560999e+01  3.31765174e+01  3.31765174e+01  3.31765174e+01
  1.22678750e+02  1.27920312e+02  1.27920312e+02  1.27920312e+02
  4.79164105e+02  4.79164105e+02  4.79164105e+02  6.65697619e+02
  1.32422686e+03  1.32422686e+03  1.32422686e+03  2.81221774e+03
  3.00980028e+03  3.00980028e+03  3.00980028e+03  6.62470320e+03
  6.62470320e+03  6.62470320e+03  9.23248248e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3083669297756  E_coul = 201.56222136441787
cycle= 4 E= -526.746145565358  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107553
diis-c [-3.84505124e-09  6.71866916e-05 -9.74730691e-03 -6.32408098e-02
  1.07292093e+00]
  HOMO = -0.582936223856673  LUMO = 1.01205974068036
  mo_energy =
[-1.18580280e+02 -1.23097446e+01 -9.56098014e+00 -9.56098014e+00
 -9.56098014e+00 -1.27010420e+00 -5.82936224e-01 -5.82936224e-01
 -5.82936224e-01  1.01205974e+00  1.01205974e+00  1.01205974e+00
  1.03878918e+00  7.24428919e+00  7.24428919e+00  7.24428919e+00
  1.35561586e+01  3.31765661e+01  3.31765661e+01  3.31765661e+01
  1.22678800e+02  1.27920359e+02  1.27920359e+02  1.27920359e+02
  4.79164145e+02  4.79164145e+02  4.79164145e+02  6.65697651e+02
  1.32422689e+03  1.32422689e+03  1.32422689e+03  2.81221776e+03
  3.00980030e+03  3.00980030e+03  3.00980030e+03  6.62470321e+03
  6.62470321e+03  6.62470321e+03  9.23248248e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3081594888633  E_coul = 201.56201392200768
cycle= 5 E= -526.746145566856  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79664e-05
diis-c [-6.64305438e-11  1.40762992e-05 -1.85185032e-03 -1.38211177e-02
  4.27408730e-02  9.72918019e-01]
  HOMO = -0.582943346372961  LUMO = 1.01205503038202
  mo_energy =
[-1.18580309e+02 -1.23097663e+01 -9.56100371e+00 -9.56100371e+00
 -9.56100371e+00 -1.27010989e+00 -5.82943346e-01 -5.82943346e-01
 -5.82943346e-01  1.01205503e+00  1.01205503e+00  1.01205503e+00
  1.03878524e+00  7.24427329e+00  7.24427329e+00  7.24427329e+00
  1.35561406e+01  3.31765432e+01  3.31765432e+01  3.31765432e+01
  1.22678773e+02  1.27920332e+02  1.27920332e+02  1.27920332e+02
  4.79164116e+02  4.79164116e+02  4.79164116e+02  6.65697621e+02
  1.32422686e+03  1.32422686e+03  1.32422686e+03  2.81221772e+03
  3.00980027e+03  3.00980027e+03  3.00980027e+03  6.62470317e+03
  6.62470317e+03  6.62470317e+03  9.23248244e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3082384514311  E_coul = 201.5620928845224
cycle= 6 E= -526.746145566909  delta_E= -5.31e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3082384514311  E_coul = 201.5620928845224
  HOMO = -0.582943377146247  LUMO = 1.01205506258115
  mo_energy =
[-1.18580309e+02 -1.23097663e+01 -9.56100371e+00 -9.56100371e+00
 -9.56100371e+00 -1.27010955e+00 -5.82943377e-01 -5.82943377e-01
 -5.82943377e-01  1.01205506e+00  1.01205506e+00  1.01205506e+00
  1.03878556e+00  7.24427330e+00  7.24427330e+00  7.24427330e+00
  1.35561408e+01  3.31765433e+01  3.31765433e+01  3.31765433e+01
  1.22678773e+02  1.27920333e+02  1.27920333e+02  1.27920333e+02
  4.79164116e+02  4.79164116e+02  4.79164116e+02  6.65697621e+02
  1.32422686e+03  1.32422686e+03  1.32422686e+03  2.81221772e+03
  3.00980027e+03  3.00980027e+03  3.00980027e+03  6.62470317e+03
  6.62470317e+03  6.62470317e+03  9.23248244e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3082377586767  E_coul = 201.56209219176603
Extra cycle  E= -526.746145566911  delta_E= -1.93e-12  |g|= 3.43e-07  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93307.25101324887
E1 = -728.3082377586767  E_coul = 201.56209219176603
init E= -526.746145566911
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.58294340092585  LUMO = 1.0120550570097
  mo_energy =
[-1.18580309e+02 -1.23097663e+01 -9.56100378e+00 -9.56100378e+00
 -9.56100378e+00 -1.27010950e+00 -5.82943401e-01 -5.82943401e-01
 -5.82943401e-01  1.01205506e+00  1.01205506e+00  1.01205506e+00
  1.03878561e+00  7.24427326e+00  7.24427326e+00  7.24427326e+00
  1.35561407e+01  3.31765432e+01  3.31765432e+01  3.31765432e+01
  1.22678773e+02  1.27920332e+02  1.27920332e+02  1.27920332e+02
  4.79164116e+02  4.79164116e+02  4.79164116e+02  6.65697621e+02
  1.32422686e+03  1.32422686e+03  1.32422686e+03  2.81221772e+03
  3.00980027e+03  3.00980027e+03  3.00980027e+03  6.62470317e+03
  6.62470317e+03  6.62470317e+03  9.23248244e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3082378572831  E_coul = 201.56209229037327
cycle= 1 E= -526.74614556691  delta_E= 7.96e-13  |g|= 7.11e-08  |ddm|= 5.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3082378572831  E_coul = 201.56209229037327
  HOMO = -0.582943401287709  LUMO = 1.01205505909086
  mo_energy =
[-1.18580309e+02 -1.23097663e+01 -9.56100377e+00 -9.56100377e+00
 -9.56100377e+00 -1.27010949e+00 -5.82943401e-01 -5.82943401e-01
 -5.82943401e-01  1.01205506e+00  1.01205506e+00  1.01205506e+00
  1.03878563e+00  7.24427326e+00  7.24427326e+00  7.24427326e+00
  1.35561408e+01  3.31765432e+01  3.31765432e+01  3.31765432e+01
  1.22678773e+02  1.27920333e+02  1.27920333e+02  1.27920333e+02
  4.79164116e+02  4.79164116e+02  4.79164116e+02  6.65697621e+02
  1.32422686e+03  1.32422686e+03  1.32422686e+03  2.81221772e+03
  3.00980027e+03  3.00980027e+03  3.00980027e+03  6.62470317e+03
  6.62470317e+03  6.62470317e+03  9.23248244e+03  2.55785788e+04
  7.63076103e+04]
E1 = -728.3082378097249  E_coul = 201.562092242815
Extra cycle  E= -526.74614556691  delta_E= -1.14e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828771e+04 7.61702832e+03 3.61756818e+03 1.58703212e+03
 4.18873629e+02 1.22691357e+02 3.94909873e+01 8.50316226e+00
 3.35691448e+00 6.74316625e-01 2.49837391e-01 1.36285941e+03
 6.64047525e+02 2.97688338e+02 3.11224319e+02 6.11634536e+01
 7.29232774e+00 2.01010158e+01 7.74198044e-01 2.80073552e+00
 2.22433464e-01]
grad_E = [-1.39422362e-06  2.13349958e-06 -2.14344960e-06  3.62725782e-05
  1.30665760e-05  3.33061480e-06  8.15006995e-07  4.92106413e-07
 -2.04901667e-06 -3.16932977e-06  1.37265847e-06 -5.13260596e-07
  5.11057612e-06  2.44008675e-05  2.08806042e-05 -2.58256822e-05
 -1.32103432e-06 -8.23201509e-06 -5.98195957e-06 -4.59230184e-06
  1.60547292e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8770469        1
[INPUT] 0    0    [1    /1   ]  7617.02847578        1
[INPUT] 0    0    [1    /1   ]  3617.5680582         1
[INPUT] 0    0    [1    /1   ]  1587.03506741        1
[INPUT] 0    0    [1    /1   ]  418.869180758        1
[INPUT] 0    0    [1    /1   ]  122.690248076        1
[INPUT] 0    0    [1    /1   ]  39.4908095072        1
[INPUT] 0    0    [1    /1   ]  8.50316022146        1
[INPUT] 0    0    [1    /1   ]  3.35691960323        1
[INPUT] 0    0    [1    /1   ]  0.674330378602       1
[INPUT] 0    0    [1    /1   ]  0.249841377425       1
[INPUT] 1    0    [1    /1   ]  1362.85937658        1
[INPUT] 1    0    [1    /1   ]  664.047781536        1
[INPUT] 1    0    [1    /1   ]  297.689516033        1
[INPUT] 1    0    [1    /1   ]  311.22532764         1
[INPUT] 1    0    [1    /1   ]  61.1669066502        1
[INPUT] 1    0    [1    /1   ]  7.29286025903        1
[INPUT] 1    0    [1    /1   ]  20.102345262         1
[INPUT] 1    0    [1    /1   ]  0.774225025528       1
[INPUT] 1    0    [1    /1   ]  2.80095220025        1
[INPUT] 1    0    [1    /1   ]  0.222438572396       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.87704691741, 1.0]], [0, [7617.028475780214, 1.0]], [0, [3617.568058198178, 1.0]], [0, [1587.0350674093754, 1.0]], [0, [418.86918075754915, 1.0]], [0, [122.69024807594079, 1.0]], [0, [39.490809507233024, 1.0]], [0, [8.503160221455044, 1.0]], [0, [3.3569196032284103, 1.0]], [0, [0.6743303786023898, 1.0]], [0, [0.2498413774254757, 1.0]], [1, [1362.8593765772919, 1.0]], [1, [664.0477815362075, 1.0]], [1, [297.6895160332477, 1.0]], [1, [311.2253276398846, 1.0]], [1, [61.16690665024745, 1.0]], [1, [7.292860259033036, 1.0]], [1, [20.10234526197942, 1.0]], [1, [0.7742250255283194, 1.0]], [1, [2.800952200250263, 1.0]], [1, [0.22243857239647352, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87704692]
bas 1, expnt(s) = [7617.02847578]
bas 2, expnt(s) = [3617.5680582]
bas 3, expnt(s) = [1587.03506741]
bas 4, expnt(s) = [418.86918076]
bas 5, expnt(s) = [122.69024808]
bas 6, expnt(s) = [39.49080951]
bas 7, expnt(s) = [8.50316022]
bas 8, expnt(s) = [3.3569196]
bas 9, expnt(s) = [0.67433038]
bas 10, expnt(s) = [0.24984138]
bas 11, expnt(s) = [1362.85937658]
bas 12, expnt(s) = [664.04778154]
bas 13, expnt(s) = [297.68951603]
bas 14, expnt(s) = [311.22532764]
bas 15, expnt(s) = [61.16690665]
bas 16, expnt(s) = [7.29286026]
bas 17, expnt(s) = [20.10234526]
bas 18, expnt(s) = [0.77422503]
bas 19, expnt(s) = [2.8009522]
bas 20, expnt(s) = [0.22243857]
CPU time:       570.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828770e+04 5.20029582e+03 7.61702848e+03 2.05993828e+03
 3.61756806e+03 1.17849449e+03 1.58703507e+03 6.35264983e+02
 4.18869181e+02 2.33923487e+02 1.22690248e+02 9.31370671e+01
 3.94908095e+01 3.98003647e+01 8.50316022e+00 1.25805693e+01
 3.35691960e+00 6.26571634e+00 6.74330379e-01 1.88005073e+00
 2.49841377e-01 8.92818742e-01 1.36285938e+03 2.41572893e+04
 6.64047782e+02 9.83407588e+03 2.97689516e+02 3.60735445e+03
 3.11225328e+02 3.81353783e+03 6.11669067e+01 4.99033890e+02
 7.29286026e+00 3.49628444e+01 2.01023453e+01 1.24177469e+02
 7.74225026e-01 2.11869479e+00 2.80095220e+00 1.05710107e+01
 2.22438572e-01 4.45653187e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993517318635803
cond(S) = 93316.31540944411
E1 = -729.5314939841803  E_coul = 203.1797958342292
init E= -526.351698149951
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555799747972335  LUMO = 1.03061195547645
  mo_energy =
[-1.18331958e+02 -1.22047269e+01 -9.44670984e+00 -9.44670984e+00
 -9.44670984e+00 -1.23994276e+00 -5.55799748e-01 -5.55799748e-01
 -5.55799748e-01  1.03061196e+00  1.03061196e+00  1.03061196e+00
  1.06114036e+00  7.31519351e+00  7.31519351e+00  7.31519351e+00
  1.36435789e+01  3.32986470e+01  3.32986470e+01  3.32986470e+01
  1.22857945e+02  1.28109065e+02  1.28109065e+02  1.28109065e+02
  4.79428457e+02  4.79428457e+02  4.79428457e+02  6.65983287e+02
  1.32454719e+03  1.32454719e+03  1.32454719e+03  2.81263461e+03
  3.01018719e+03  3.01018719e+03  3.01018719e+03  6.62520147e+03
  6.62520147e+03  6.62520147e+03  9.23301464e+03  2.55792070e+04
  7.63083300e+04]
E1 = -727.8646664540445  E_coul = 201.11929013099964
cycle= 1 E= -526.745376323045  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537521
diis-c [-0.28892921  1.        ]
  HOMO = -0.590532201348184  LUMO = 1.00648946279296
  mo_energy =
[-1.18637649e+02 -1.23418487e+01 -9.59437624e+00 -9.59437624e+00
 -9.59437624e+00 -1.27930919e+00 -5.90532201e-01 -5.90532201e-01
 -5.90532201e-01  1.00648946e+00  1.00648946e+00  1.00648946e+00
  1.03166217e+00  7.22509125e+00  7.22509125e+00  7.22509125e+00
  1.35298925e+01  3.31459187e+01  3.31459187e+01  3.31459187e+01
  1.22629446e+02  1.27882736e+02  1.27882736e+02  1.27882736e+02
  4.79124711e+02  4.79124711e+02  4.79124711e+02  6.65632164e+02
  1.32418783e+03  1.32418783e+03  1.32418783e+03  2.81214079e+03
  3.00976235e+03  3.00976235e+03  3.00976235e+03  6.62466481e+03
  6.62466481e+03  6.62466481e+03  9.23240470e+03  2.55785034e+04
  7.63075367e+04]
E1 = -728.4351990763281  E_coul = 201.6891136307772
cycle= 2 E= -526.746085445551  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746418
diis-c [-0.00326364  0.08246825  0.91753175]
  HOMO = -0.581463662320098  LUMO = 1.0131604763151
  mo_energy =
[-1.18570417e+02 -1.23040295e+01 -9.55491027e+00 -9.55491027e+00
 -9.55491027e+00 -1.26845731e+00 -5.81463662e-01 -5.81463662e-01
 -5.81463662e-01  1.01316048e+00  1.01316048e+00  1.01316048e+00
  1.04007614e+00  7.24862819e+00  7.24862819e+00  7.24862819e+00
  1.35609598e+01  3.31856381e+01  3.31856381e+01  3.31856381e+01
  1.22686461e+02  1.27938153e+02  1.27938153e+02  1.27938153e+02
  4.79191072e+02  4.79191072e+02  4.79191072e+02  6.65701509e+02
  1.32425824e+03  1.32425824e+03  1.32425824e+03  2.81221457e+03
  3.00983500e+03  3.00983500e+03  3.00983500e+03  6.62473922e+03
  6.62473922e+03  6.62473922e+03  9.23247992e+03  2.55785792e+04
  7.63076128e+04]
E1 = -728.2856860624361  E_coul = 201.53954239443107
cycle= 3 E= -526.746143668005  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130793
diis-c [-5.36150173e-07 -1.21839673e-03  1.44766732e-01  8.56451664e-01]
  HOMO = -0.582953949338304  LUMO = 1.01208748668156
  mo_energy =
[-1.18580318e+02 -1.23098071e+01 -9.56102996e+00 -9.56102996e+00
 -9.56102996e+00 -1.27014345e+00 -5.82953949e-01 -5.82953949e-01
 -5.82953949e-01  1.01208749e+00  1.01208749e+00  1.01208749e+00
  1.03878749e+00  7.24488370e+00  7.24488370e+00  7.24488370e+00
  1.35561909e+01  3.31795164e+01  3.31795164e+01  3.31795164e+01
  1.22678003e+02  1.27929867e+02  1.27929867e+02  1.27929867e+02
  4.79181295e+02  4.79181295e+02  4.79181295e+02  6.65691285e+02
  1.32424787e+03  1.32424787e+03  1.32424787e+03  2.81220357e+03
  3.00982425e+03  3.00982425e+03  3.00982425e+03  6.62472808e+03
  6.62472808e+03  6.62472808e+03  9.23246857e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3083823781517  E_coul = 201.56223680816444
cycle= 4 E= -526.746145569987  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107554
diis-c [-3.84486118e-09  6.71890191e-05 -9.74760442e-03 -6.32428977e-02
  1.07292331e+00]
  HOMO = -0.582935620389044  LUMO = 1.0121030837464
  mo_energy =
[-1.18580278e+02 -1.23097436e+01 -9.56097929e+00 -9.56097929e+00
 -9.56097929e+00 -1.27010372e+00 -5.82935620e-01 -5.82935620e-01
 -5.82935620e-01  1.01210308e+00  1.01210308e+00  1.01210308e+00
  1.03882124e+00  7.24492488e+00  7.24492488e+00  7.24492488e+00
  1.35562497e+01  3.31795651e+01  3.31795651e+01  3.31795651e+01
  1.22678054e+02  1.27929914e+02  1.27929914e+02  1.27929914e+02
  4.79181335e+02  4.79181335e+02  4.79181335e+02  6.65691317e+02
  1.32424790e+03  1.32424790e+03  1.32424790e+03  2.81220358e+03
  3.00982427e+03  3.00982427e+03  3.00982427e+03  6.62472809e+03
  6.62472809e+03  6.62472809e+03  9.23246857e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3081749447126  E_coul = 201.56202937322794
cycle= 5 E= -526.746145571485  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79658e-05
diis-c [-6.64290083e-11  1.40758405e-05 -1.85179609e-03 -1.38208037e-02
  4.27417337e-02  9.72916790e-01]
  HOMO = -0.582942742797798  LUMO = 1.01209837326927
  mo_energy =
[-1.18580308e+02 -1.23097653e+01 -9.56100286e+00 -9.56100286e+00
 -9.56100286e+00 -1.27010941e+00 -5.82942743e-01 -5.82942743e-01
 -5.82942743e-01  1.01209837e+00  1.01209837e+00  1.01209837e+00
  1.03881730e+00  7.24490898e+00  7.24490898e+00  7.24490898e+00
  1.35562316e+01  3.31795422e+01  3.31795422e+01  3.31795422e+01
  1.22678027e+02  1.27929887e+02  1.27929887e+02  1.27929887e+02
  4.79181306e+02  4.79181306e+02  4.79181306e+02  6.65691287e+02
  1.32424787e+03  1.32424787e+03  1.32424787e+03  2.81220355e+03
  3.00982424e+03  3.00982424e+03  3.00982424e+03  6.62472806e+03
  6.62472806e+03  6.62472806e+03  9.23246854e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3082539057091  E_coul = 201.56210833416915
cycle= 6 E= -526.74614557154  delta_E= -5.53e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3082539057091  E_coul = 201.56210833416915
  HOMO = -0.582942773559699  LUMO = 1.01209840547526
  mo_energy =
[-1.18580307e+02 -1.23097652e+01 -9.56100286e+00 -9.56100286e+00
 -9.56100286e+00 -1.27010907e+00 -5.82942774e-01 -5.82942774e-01
 -5.82942774e-01  1.01209841e+00  1.01209841e+00  1.01209841e+00
  1.03881762e+00  7.24490899e+00  7.24490899e+00  7.24490899e+00
  1.35562318e+01  3.31795423e+01  3.31795423e+01  3.31795423e+01
  1.22678027e+02  1.27929887e+02  1.27929887e+02  1.27929887e+02
  4.79181306e+02  4.79181306e+02  4.79181306e+02  6.65691287e+02
  1.32424787e+03  1.32424787e+03  1.32424787e+03  2.81220355e+03
  3.00982424e+03  3.00982424e+03  3.00982424e+03  6.62472806e+03
  6.62472806e+03  6.62472806e+03  9.23246854e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3082532127847  E_coul = 201.56210764124623
Extra cycle  E= -526.746145571538  delta_E= 1.48e-12  |g|= 3.43e-07  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828770e+04 7.61702848e+03 3.61756806e+03 1.58703507e+03
 4.18869181e+02 1.22690248e+02 3.94908095e+01 8.50316022e+00
 3.35691960e+00 6.74330379e-01 2.49841377e-01 1.36285938e+03
 6.64047782e+02 2.97689516e+02 3.11225328e+02 6.11669067e+01
 7.29286026e+00 2.01023453e+01 7.74225026e-01 2.80095220e+00
 2.22438572e-01]
E = -526.7461455715385
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8770469        1
[INPUT] 0    0    [1    /1   ]  7617.02847578        1
[INPUT] 0    0    [1    /1   ]  3617.5680582         1
[INPUT] 0    0    [1    /1   ]  1587.03506741        1
[INPUT] 0    0    [1    /1   ]  418.869180758        1
[INPUT] 0    0    [1    /1   ]  122.690248076        1
[INPUT] 0    0    [1    /1   ]  39.4908095072        1
[INPUT] 0    0    [1    /1   ]  8.50316022146        1
[INPUT] 0    0    [1    /1   ]  3.35691960323        1
[INPUT] 0    0    [1    /1   ]  0.674330378602       1
[INPUT] 0    0    [1    /1   ]  0.249841377425       1
[INPUT] 1    0    [1    /1   ]  1362.85937658        1
[INPUT] 1    0    [1    /1   ]  664.047781536        1
[INPUT] 1    0    [1    /1   ]  297.689516033        1
[INPUT] 1    0    [1    /1   ]  311.22532764         1
[INPUT] 1    0    [1    /1   ]  61.1669066502        1
[INPUT] 1    0    [1    /1   ]  7.29286025903        1
[INPUT] 1    0    [1    /1   ]  20.102345262         1
[INPUT] 1    0    [1    /1   ]  0.774225025528       1
[INPUT] 1    0    [1    /1   ]  2.80095220025        1
[INPUT] 1    0    [1    /1   ]  0.222438572396       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.87704691741, 1.0]], [0, [7617.028475780214, 1.0]], [0, [3617.568058198178, 1.0]], [0, [1587.0350674093754, 1.0]], [0, [418.86918075754915, 1.0]], [0, [122.69024807594079, 1.0]], [0, [39.490809507233024, 1.0]], [0, [8.503160221455044, 1.0]], [0, [3.3569196032284103, 1.0]], [0, [0.6743303786023898, 1.0]], [0, [0.2498413774254757, 1.0]], [1, [1362.8593765772919, 1.0]], [1, [664.0477815362075, 1.0]], [1, [297.6895160332477, 1.0]], [1, [311.2253276398846, 1.0]], [1, [61.16690665024745, 1.0]], [1, [7.292860259033036, 1.0]], [1, [20.10234526197942, 1.0]], [1, [0.7742250255283194, 1.0]], [1, [2.800952200250263, 1.0]], [1, [0.22243857239647352, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87704692]
bas 1, expnt(s) = [7617.02847578]
bas 2, expnt(s) = [3617.5680582]
bas 3, expnt(s) = [1587.03506741]
bas 4, expnt(s) = [418.86918076]
bas 5, expnt(s) = [122.69024808]
bas 6, expnt(s) = [39.49080951]
bas 7, expnt(s) = [8.50316022]
bas 8, expnt(s) = [3.3569196]
bas 9, expnt(s) = [0.67433038]
bas 10, expnt(s) = [0.24984138]
bas 11, expnt(s) = [1362.85937658]
bas 12, expnt(s) = [664.04778154]
bas 13, expnt(s) = [297.68951603]
bas 14, expnt(s) = [311.22532764]
bas 15, expnt(s) = [61.16690665]
bas 16, expnt(s) = [7.29286026]
bas 17, expnt(s) = [20.10234526]
bas 18, expnt(s) = [0.77422503]
bas 19, expnt(s) = [2.8009522]
bas 20, expnt(s) = [0.22243857]
CPU time:       570.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828770e+04 5.20029582e+03 7.61702848e+03 2.05993828e+03
 3.61756806e+03 1.17849449e+03 1.58703507e+03 6.35264983e+02
 4.18869181e+02 2.33923487e+02 1.22690248e+02 9.31370671e+01
 3.94908095e+01 3.98003647e+01 8.50316022e+00 1.25805693e+01
 3.35691960e+00 6.26571634e+00 6.74330379e-01 1.88005073e+00
 2.49841377e-01 8.92818742e-01 1.36285938e+03 2.41572893e+04
 6.64047782e+02 9.83407588e+03 2.97689516e+02 3.60735445e+03
 3.11225328e+02 3.81353783e+03 6.11669067e+01 4.99033890e+02
 7.29286026e+00 3.49628444e+01 2.01023453e+01 1.24177469e+02
 7.74225026e-01 2.11869479e+00 2.80095220e+00 1.05710107e+01
 2.22438572e-01 4.45653187e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993517318635803
cond(S) = 93316.31540944411
E1 = -729.5314939841803  E_coul = 203.1797958342292
init E= -526.351698149951
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555799747972335  LUMO = 1.03061195547645
  mo_energy =
[-1.18331958e+02 -1.22047269e+01 -9.44670984e+00 -9.44670984e+00
 -9.44670984e+00 -1.23994276e+00 -5.55799748e-01 -5.55799748e-01
 -5.55799748e-01  1.03061196e+00  1.03061196e+00  1.03061196e+00
  1.06114036e+00  7.31519351e+00  7.31519351e+00  7.31519351e+00
  1.36435789e+01  3.32986470e+01  3.32986470e+01  3.32986470e+01
  1.22857945e+02  1.28109065e+02  1.28109065e+02  1.28109065e+02
  4.79428457e+02  4.79428457e+02  4.79428457e+02  6.65983287e+02
  1.32454719e+03  1.32454719e+03  1.32454719e+03  2.81263461e+03
  3.01018719e+03  3.01018719e+03  3.01018719e+03  6.62520147e+03
  6.62520147e+03  6.62520147e+03  9.23301464e+03  2.55792070e+04
  7.63083300e+04]
E1 = -727.8646664540445  E_coul = 201.11929013099964
cycle= 1 E= -526.745376323045  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537521
diis-c [-0.28892921  1.        ]
  HOMO = -0.590532201348184  LUMO = 1.00648946279296
  mo_energy =
[-1.18637649e+02 -1.23418487e+01 -9.59437624e+00 -9.59437624e+00
 -9.59437624e+00 -1.27930919e+00 -5.90532201e-01 -5.90532201e-01
 -5.90532201e-01  1.00648946e+00  1.00648946e+00  1.00648946e+00
  1.03166217e+00  7.22509125e+00  7.22509125e+00  7.22509125e+00
  1.35298925e+01  3.31459187e+01  3.31459187e+01  3.31459187e+01
  1.22629446e+02  1.27882736e+02  1.27882736e+02  1.27882736e+02
  4.79124711e+02  4.79124711e+02  4.79124711e+02  6.65632164e+02
  1.32418783e+03  1.32418783e+03  1.32418783e+03  2.81214079e+03
  3.00976235e+03  3.00976235e+03  3.00976235e+03  6.62466481e+03
  6.62466481e+03  6.62466481e+03  9.23240470e+03  2.55785034e+04
  7.63075367e+04]
E1 = -728.4351990763281  E_coul = 201.6891136307772
cycle= 2 E= -526.746085445551  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746418
diis-c [-0.00326364  0.08246825  0.91753175]
  HOMO = -0.581463662320098  LUMO = 1.0131604763151
  mo_energy =
[-1.18570417e+02 -1.23040295e+01 -9.55491027e+00 -9.55491027e+00
 -9.55491027e+00 -1.26845731e+00 -5.81463662e-01 -5.81463662e-01
 -5.81463662e-01  1.01316048e+00  1.01316048e+00  1.01316048e+00
  1.04007614e+00  7.24862819e+00  7.24862819e+00  7.24862819e+00
  1.35609598e+01  3.31856381e+01  3.31856381e+01  3.31856381e+01
  1.22686461e+02  1.27938153e+02  1.27938153e+02  1.27938153e+02
  4.79191072e+02  4.79191072e+02  4.79191072e+02  6.65701509e+02
  1.32425824e+03  1.32425824e+03  1.32425824e+03  2.81221457e+03
  3.00983500e+03  3.00983500e+03  3.00983500e+03  6.62473922e+03
  6.62473922e+03  6.62473922e+03  9.23247992e+03  2.55785792e+04
  7.63076128e+04]
E1 = -728.2856860624361  E_coul = 201.53954239443107
cycle= 3 E= -526.746143668005  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130793
diis-c [-5.36150173e-07 -1.21839673e-03  1.44766732e-01  8.56451664e-01]
  HOMO = -0.582953949338304  LUMO = 1.01208748668156
  mo_energy =
[-1.18580318e+02 -1.23098071e+01 -9.56102996e+00 -9.56102996e+00
 -9.56102996e+00 -1.27014345e+00 -5.82953949e-01 -5.82953949e-01
 -5.82953949e-01  1.01208749e+00  1.01208749e+00  1.01208749e+00
  1.03878749e+00  7.24488370e+00  7.24488370e+00  7.24488370e+00
  1.35561909e+01  3.31795164e+01  3.31795164e+01  3.31795164e+01
  1.22678003e+02  1.27929867e+02  1.27929867e+02  1.27929867e+02
  4.79181295e+02  4.79181295e+02  4.79181295e+02  6.65691285e+02
  1.32424787e+03  1.32424787e+03  1.32424787e+03  2.81220357e+03
  3.00982425e+03  3.00982425e+03  3.00982425e+03  6.62472808e+03
  6.62472808e+03  6.62472808e+03  9.23246857e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3083823781517  E_coul = 201.56223680816444
cycle= 4 E= -526.746145569987  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107554
diis-c [-3.84486118e-09  6.71890191e-05 -9.74760442e-03 -6.32428977e-02
  1.07292331e+00]
  HOMO = -0.582935620389044  LUMO = 1.0121030837464
  mo_energy =
[-1.18580278e+02 -1.23097436e+01 -9.56097929e+00 -9.56097929e+00
 -9.56097929e+00 -1.27010372e+00 -5.82935620e-01 -5.82935620e-01
 -5.82935620e-01  1.01210308e+00  1.01210308e+00  1.01210308e+00
  1.03882124e+00  7.24492488e+00  7.24492488e+00  7.24492488e+00
  1.35562497e+01  3.31795651e+01  3.31795651e+01  3.31795651e+01
  1.22678054e+02  1.27929914e+02  1.27929914e+02  1.27929914e+02
  4.79181335e+02  4.79181335e+02  4.79181335e+02  6.65691317e+02
  1.32424790e+03  1.32424790e+03  1.32424790e+03  2.81220358e+03
  3.00982427e+03  3.00982427e+03  3.00982427e+03  6.62472809e+03
  6.62472809e+03  6.62472809e+03  9.23246857e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3081749447126  E_coul = 201.56202937322794
cycle= 5 E= -526.746145571485  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79658e-05
diis-c [-6.64290083e-11  1.40758405e-05 -1.85179609e-03 -1.38208037e-02
  4.27417337e-02  9.72916790e-01]
  HOMO = -0.582942742797798  LUMO = 1.01209837326927
  mo_energy =
[-1.18580308e+02 -1.23097653e+01 -9.56100286e+00 -9.56100286e+00
 -9.56100286e+00 -1.27010941e+00 -5.82942743e-01 -5.82942743e-01
 -5.82942743e-01  1.01209837e+00  1.01209837e+00  1.01209837e+00
  1.03881730e+00  7.24490898e+00  7.24490898e+00  7.24490898e+00
  1.35562316e+01  3.31795422e+01  3.31795422e+01  3.31795422e+01
  1.22678027e+02  1.27929887e+02  1.27929887e+02  1.27929887e+02
  4.79181306e+02  4.79181306e+02  4.79181306e+02  6.65691287e+02
  1.32424787e+03  1.32424787e+03  1.32424787e+03  2.81220355e+03
  3.00982424e+03  3.00982424e+03  3.00982424e+03  6.62472806e+03
  6.62472806e+03  6.62472806e+03  9.23246854e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3082539057091  E_coul = 201.56210833416915
cycle= 6 E= -526.74614557154  delta_E= -5.53e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3082539057091  E_coul = 201.56210833416915
  HOMO = -0.582942773559699  LUMO = 1.01209840547526
  mo_energy =
[-1.18580307e+02 -1.23097652e+01 -9.56100286e+00 -9.56100286e+00
 -9.56100286e+00 -1.27010907e+00 -5.82942774e-01 -5.82942774e-01
 -5.82942774e-01  1.01209841e+00  1.01209841e+00  1.01209841e+00
  1.03881762e+00  7.24490899e+00  7.24490899e+00  7.24490899e+00
  1.35562318e+01  3.31795423e+01  3.31795423e+01  3.31795423e+01
  1.22678027e+02  1.27929887e+02  1.27929887e+02  1.27929887e+02
  4.79181306e+02  4.79181306e+02  4.79181306e+02  6.65691287e+02
  1.32424787e+03  1.32424787e+03  1.32424787e+03  2.81220355e+03
  3.00982424e+03  3.00982424e+03  3.00982424e+03  6.62472806e+03
  6.62472806e+03  6.62472806e+03  9.23246854e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3082532127847  E_coul = 201.56210764124623
Extra cycle  E= -526.746145571538  delta_E= 1.48e-12  |g|= 3.43e-07  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93316.31540944411
E1 = -728.3082532127847  E_coul = 201.56210764124623
init E= -526.746145571538
    CPU time for initialize scf      0.92 sec, wall time      0.25 sec
  HOMO = -0.582942797343476  LUMO = 1.01209839989979
  mo_energy =
[-1.18580308e+02 -1.23097652e+01 -9.56100293e+00 -9.56100293e+00
 -9.56100293e+00 -1.27010902e+00 -5.82942797e-01 -5.82942797e-01
 -5.82942797e-01  1.01209840e+00  1.01209840e+00  1.01209840e+00
  1.03881767e+00  7.24490895e+00  7.24490895e+00  7.24490895e+00
  1.35562318e+01  3.31795422e+01  3.31795422e+01  3.31795422e+01
  1.22678027e+02  1.27929887e+02  1.27929887e+02  1.27929887e+02
  4.79181306e+02  4.79181306e+02  4.79181306e+02  6.65691287e+02
  1.32424787e+03  1.32424787e+03  1.32424787e+03  2.81220355e+03
  3.00982424e+03  3.00982424e+03  3.00982424e+03  6.62472806e+03
  6.62472806e+03  6.62472806e+03  9.23246854e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3082533114228  E_coul = 201.562107739883
cycle= 1 E= -526.74614557154  delta_E= -1.36e-12  |g|= 7.11e-08  |ddm|= 5.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3082533114228  E_coul = 201.562107739883
  HOMO = -0.582942797703784  LUMO = 1.01209840198193
  mo_energy =
[-1.18580308e+02 -1.23097652e+01 -9.56100293e+00 -9.56100293e+00
 -9.56100293e+00 -1.27010901e+00 -5.82942798e-01 -5.82942798e-01
 -5.82942798e-01  1.01209840e+00  1.01209840e+00  1.01209840e+00
  1.03881768e+00  7.24490895e+00  7.24490895e+00  7.24490895e+00
  1.35562318e+01  3.31795422e+01  3.31795422e+01  3.31795422e+01
  1.22678027e+02  1.27929887e+02  1.27929887e+02  1.27929887e+02
  4.79181306e+02  4.79181306e+02  4.79181306e+02  6.65691287e+02
  1.32424787e+03  1.32424787e+03  1.32424787e+03  2.81220355e+03
  3.00982424e+03  3.00982424e+03  3.00982424e+03  6.62472806e+03
  6.62472806e+03  6.62472806e+03  9.23246854e+03  2.55785676e+04
  7.63076011e+04]
E1 = -728.3082532638575  E_coul = 201.56210769231774
Extra cycle  E= -526.74614557154  delta_E= 1.14e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.05 sec, wall time      0.39 sec
exp = [2.61828770e+04 7.61702848e+03 3.61756806e+03 1.58703507e+03
 4.18869181e+02 1.22690248e+02 3.94908095e+01 8.50316022e+00
 3.35691960e+00 6.74330379e-01 2.49841377e-01 1.36285938e+03
 6.64047782e+02 2.97689516e+02 3.11225328e+02 6.11669067e+01
 7.29286026e+00 2.01023453e+01 7.74225026e-01 2.80095220e+00
 2.22438572e-01]
grad_E = [-1.39424427e-06  2.13366740e-06 -2.14344618e-06  3.62773954e-05
  1.30322345e-05  3.30798901e-06  9.29089098e-07  3.12570277e-07
 -1.17388393e-06 -9.88272618e-07 -4.65506140e-07 -5.13419243e-07
  5.10852439e-06  2.43893603e-05  2.08706837e-05 -2.56701250e-05
 -1.75226586e-06 -8.26401171e-06  2.58119552e-06 -1.10688872e-06
 -4.61351010e-06]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8768029        1
[INPUT] 0    0    [1    /1   ]  7617.02891398        1
[INPUT] 0    0    [1    /1   ]  3617.56773367        1
[INPUT] 0    0    [1    /1   ]  1587.04351515        1
[INPUT] 0    0    [1    /1   ]  418.855114258        1
[INPUT] 0    0    [1    /1   ]  122.686688618        1
[INPUT] 0    0    [1    /1   ]  39.4902396333        1
[INPUT] 0    0    [1    /1   ]  8.50310732327        1
[INPUT] 0    0    [1    /1   ]  3.35694134914        1
[INPUT] 0    0    [1    /1   ]  0.674390588472       1
[INPUT] 0    0    [1    /1   ]  0.24985945392        1
[INPUT] 1    0    [1    /1   ]  1362.85927961        1
[INPUT] 1    0    [1    /1   ]  664.048496251        1
[INPUT] 1    0    [1    /1   ]  297.692799575        1
[INPUT] 1    0    [1    /1   ]  311.228139537        1
[INPUT] 1    0    [1    /1   ]  61.1765719432        1
[INPUT] 1    0    [1    /1   ]  7.29441549326        1
[INPUT] 1    0    [1    /1   ]  20.1060960833        1
[INPUT] 1    0    [1    /1   ]  0.774305657411       1
[INPUT] 1    0    [1    /1   ]  2.80160636506        1
[INPUT] 1    0    [1    /1   ]  0.222453714224       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.876802905383, 1.0]], [0, [7617.028913980906, 1.0]], [0, [3617.5677336734802, 1.0]], [0, [1587.0435151495653, 1.0]], [0, [418.85511425753384, 1.0]], [0, [122.68668861775274, 1.0]], [0, [39.490239633283906, 1.0]], [0, [8.503107323268702, 1.0]], [0, [3.356941349142425, 1.0]], [0, [0.6743905884717432, 1.0]], [0, [0.2498594539199452, 1.0]], [1, [1362.8592796092148, 1.0]], [1, [664.0484962507205, 1.0]], [1, [297.69279957538015, 1.0]], [1, [311.22813953678093, 1.0]], [1, [61.1765719432148, 1.0]], [1, [7.294415493263227, 1.0]], [1, [20.106096083292496, 1.0]], [1, [0.7743056574107927, 1.0]], [1, [2.8016063650568546, 1.0]], [1, [0.2224537142241833, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87680291]
bas 1, expnt(s) = [7617.02891398]
bas 2, expnt(s) = [3617.56773367]
bas 3, expnt(s) = [1587.04351515]
bas 4, expnt(s) = [418.85511426]
bas 5, expnt(s) = [122.68668862]
bas 6, expnt(s) = [39.49023963]
bas 7, expnt(s) = [8.50310732]
bas 8, expnt(s) = [3.35694135]
bas 9, expnt(s) = [0.67439059]
bas 10, expnt(s) = [0.24985945]
bas 11, expnt(s) = [1362.85927961]
bas 12, expnt(s) = [664.04849625]
bas 13, expnt(s) = [297.69279958]
bas 14, expnt(s) = [311.22813954]
bas 15, expnt(s) = [61.17657194]
bas 16, expnt(s) = [7.29441549]
bas 17, expnt(s) = [20.10609608]
bas 18, expnt(s) = [0.77430566]
bas 19, expnt(s) = [2.80160637]
bas 20, expnt(s) = [0.22245371]
CPU time:       576.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828768e+04 5.20029578e+03 7.61702891e+03 2.05993837e+03
 3.61756773e+03 1.17849441e+03 1.58704352e+03 6.35267519e+02
 4.18855114e+02 2.33917596e+02 1.22686689e+02 9.31350405e+01
 3.94902396e+01 3.97999339e+01 8.50310732e+00 1.25805106e+01
 3.35694135e+00 6.26574678e+00 6.74390588e-01 1.88017663e+00
 2.49859454e-01 8.92867190e-01 1.36285928e+03 2.41572872e+04
 6.64048496e+02 9.83408912e+03 2.97692800e+02 3.60740419e+03
 3.11228140e+02 3.81358090e+03 6.11765719e+01 4.99132460e+02
 7.29441549e+00 3.49721646e+01 2.01060961e+01 1.24206432e+02
 7.74305657e-01 2.11897061e+00 2.80160637e+00 1.05740969e+01
 2.22453714e-01 4.45691108e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993514464185917
cond(S) = 93341.76139793028
E1 = -729.5314990195493  E_coul = 203.1798002483862
init E= -526.351698771163
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555799089858128  LUMO = 1.03074288717353
  mo_energy =
[-1.18331958e+02 -1.22047266e+01 -9.44671008e+00 -9.44671008e+00
 -9.44671008e+00 -1.23994250e+00 -5.55799090e-01 -5.55799090e-01
 -5.55799090e-01  1.03074289e+00  1.03074289e+00  1.03074289e+00
  1.06128344e+00  7.31710284e+00  7.31710284e+00  7.31710284e+00
  1.36439348e+01  3.33074107e+01  3.33074107e+01  3.33074107e+01
  1.22855469e+02  1.28136294e+02  1.28136294e+02  1.28136294e+02
  4.79476990e+02  4.79476990e+02  4.79476990e+02  6.65962988e+02
  1.32460635e+03  1.32460635e+03  1.32460635e+03  2.81258896e+03
  3.01025458e+03  3.01025458e+03  3.01025458e+03  6.62527134e+03
  6.62527134e+03  6.62527134e+03  9.23296860e+03  2.55791686e+04
  7.63082974e+04]
E1 = -727.8647344028147  E_coul = 201.11935801124588
cycle= 1 E= -526.745376391569  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537525
diis-c [-0.28893352  1.        ]
  HOMO = -0.59052999823689  LUMO = 1.00661806213461
  mo_energy =
[-1.18637642e+02 -1.23418441e+01 -9.59437195e+00 -9.59437195e+00
 -9.59437195e+00 -1.27930723e+00 -5.90529998e-01 -5.90529998e-01
 -5.90529998e-01  1.00661806e+00  1.00661806e+00  1.00661806e+00
  1.03180388e+00  7.22698996e+00  7.22698996e+00  7.22698996e+00
  1.35302521e+01  3.31546746e+01  3.31546746e+01  3.31546746e+01
  1.22626979e+02  1.27909961e+02  1.27909961e+02  1.27909961e+02
  4.79173251e+02  4.79173251e+02  4.79173251e+02  6.65611876e+02
  1.32424700e+03  1.32424700e+03  1.32424700e+03  2.81209515e+03
  3.00982975e+03  3.00982975e+03  3.00982975e+03  6.62473469e+03
  6.62473469e+03  6.62473469e+03  9.23235867e+03  2.55784650e+04
  7.63075041e+04]
E1 = -728.4352418467611  E_coul = 201.68915637464332
cycle= 2 E= -526.746085472118  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746406
diis-c [-0.00326356  0.08246617  0.91753383]
  HOMO = -0.581461976010463  LUMO = 1.01328969366138
  mo_energy =
[-1.18570412e+02 -1.23040264e+01 -9.55490759e+00 -9.55490759e+00
 -9.55490759e+00 -1.26845596e+00 -5.81461976e-01 -5.81461976e-01
 -5.81461976e-01  1.01328969e+00  1.01328969e+00  1.01328969e+00
  1.04021817e+00  7.25052932e+00  7.25052932e+00  7.25052932e+00
  1.35613181e+01  3.31943954e+01  3.31943954e+01  3.31943954e+01
  1.22683991e+02  1.27965378e+02  1.27965378e+02  1.27965378e+02
  4.79239610e+02  4.79239610e+02  4.79239610e+02  6.65681218e+02
  1.32431740e+03  1.32431740e+03  1.32431740e+03  2.81216894e+03
  3.00990240e+03  3.00990240e+03  3.00990240e+03  6.62480910e+03
  6.62480910e+03  6.62480910e+03  9.23243388e+03  2.55785408e+04
  7.63075802e+04]
E1 = -728.2857370905044  E_coul = 201.53959340111598
cycle= 3 E= -526.746143689388  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013079
diis-c [-5.36120723e-07 -1.21839206e-03  1.44766212e-01  8.56452180e-01]
  HOMO = -0.582952172211876  LUMO = 1.01221660886901
  mo_energy =
[-1.18580312e+02 -1.23098038e+01 -9.56102701e+00 -9.56102701e+00
 -9.56102701e+00 -1.27014199e+00 -5.82952172e-01 -5.82952172e-01
 -5.82952172e-01  1.01221661e+00  1.01221661e+00  1.01221661e+00
  1.03892949e+00  7.24678448e+00  7.24678448e+00  7.24678448e+00
  1.35565494e+01  3.31882736e+01  3.31882736e+01  3.31882736e+01
  1.22675534e+02  1.27957092e+02  1.27957092e+02  1.27957092e+02
  4.79229833e+02  4.79229833e+02  4.79229833e+02  6.65670995e+02
  1.32430704e+03  1.32430704e+03  1.32430704e+03  2.81215793e+03
  3.00989165e+03  3.00989165e+03  3.00989165e+03  6.62479796e+03
  6.62479796e+03  6.62479796e+03  9.23242254e+03  2.55785293e+04
  7.63075686e+04]
E1 = -728.3084320613151  E_coul = 201.5622864701321
cycle= 4 E= -526.746145591183  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107553
diis-c [-3.84419854e-09  6.71925169e-05 -9.74809637e-03 -6.32462977e-02
  1.07292720e+00]
  HOMO = -0.58293384455486  LUMO = 1.01223220670078
  mo_energy =
[-1.18580272e+02 -1.23097402e+01 -9.56097634e+00 -9.56097634e+00
 -9.56097634e+00 -1.27010227e+00 -5.82933845e-01 -5.82933845e-01
 -5.82933845e-01  1.01223221e+00  1.01223221e+00  1.01223221e+00
  1.03896323e+00  7.24682566e+00  7.24682566e+00  7.24682566e+00
  1.35566081e+01  3.31883222e+01  3.31883222e+01  3.31883222e+01
  1.22675584e+02  1.27957139e+02  1.27957139e+02  1.27957139e+02
  4.79229873e+02  4.79229873e+02  4.79229873e+02  6.65671027e+02
  1.32430707e+03  1.32430707e+03  1.32430707e+03  2.81215795e+03
  3.00989167e+03  3.00989167e+03  3.00989167e+03  6.62479797e+03
  6.62479797e+03  6.62479797e+03  9.23242254e+03  2.55785293e+04
  7.63075686e+04]
E1 = -728.3082246451718  E_coul = 201.5620790524922
cycle= 5 E= -526.74614559268  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79638e-05
diis-c [-6.64200834e-11  1.40743229e-05 -1.85161882e-03 -1.38197423e-02
  4.27448731e-02  9.72912414e-01]
  HOMO = -0.582940966506431  LUMO = 1.01222749577806
  mo_energy =
[-1.18580302e+02 -1.23097619e+01 -9.56099991e+00 -9.56099991e+00
 -9.56099991e+00 -1.27010796e+00 -5.82940967e-01 -5.82940967e-01
 -5.82940967e-01  1.01222750e+00  1.01222750e+00  1.01222750e+00
  1.03895929e+00  7.24680975e+00  7.24680975e+00  7.24680975e+00
  1.35565901e+01  3.31882994e+01  3.31882994e+01  3.31882994e+01
  1.22675557e+02  1.27957112e+02  1.27957112e+02  1.27957112e+02
  4.79229844e+02  4.79229844e+02  4.79229844e+02  6.65670996e+02
  1.32430704e+03  1.32430704e+03  1.32430704e+03  2.81215791e+03
  3.00989164e+03  3.00989164e+03  3.00989164e+03  6.62479794e+03
  6.62479794e+03  6.62479794e+03  9.23242251e+03  2.55785292e+04
  7.63075685e+04]
E1 = -728.3083036011889  E_coul = 201.56215800845493
cycle= 6 E= -526.746145592734  delta_E= -5.43e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3083036011889  E_coul = 201.56215800845493
  HOMO = -0.582940997238721  LUMO = 1.01222752799745
  mo_energy =
[-1.18580302e+02 -1.23097618e+01 -9.56099991e+00 -9.56099991e+00
 -9.56099991e+00 -1.27010762e+00 -5.82940997e-01 -5.82940997e-01
 -5.82940997e-01  1.01222753e+00  1.01222753e+00  1.01222753e+00
  1.03895961e+00  7.24680976e+00  7.24680976e+00  7.24680976e+00
  1.35565902e+01  3.31882994e+01  3.31882994e+01  3.31882994e+01
  1.22675557e+02  1.27957112e+02  1.27957112e+02  1.27957112e+02
  4.79229844e+02  4.79229844e+02  4.79229844e+02  6.65670996e+02
  1.32430704e+03  1.32430704e+03  1.32430704e+03  2.81215791e+03
  3.00989164e+03  3.00989164e+03  3.00989164e+03  6.62479794e+03
  6.62479794e+03  6.62479794e+03  9.23242251e+03  2.55785292e+04
  7.63075685e+04]
E1 = -728.3083029079644  E_coul = 201.56215731523008
Extra cycle  E= -526.746145592734  delta_E= -4.55e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828768e+04 7.61702891e+03 3.61756773e+03 1.58704352e+03
 4.18855114e+02 1.22686689e+02 3.94902396e+01 8.50310732e+00
 3.35694135e+00 6.74390588e-01 2.49859454e-01 1.36285928e+03
 6.64048496e+02 2.97692800e+02 3.11228140e+02 6.11765719e+01
 7.29441549e+00 2.01060961e+01 7.74305657e-01 2.80160637e+00
 2.22453714e-01]
E = -526.7461455927344
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8768029        1
[INPUT] 0    0    [1    /1   ]  7617.02891398        1
[INPUT] 0    0    [1    /1   ]  3617.56773367        1
[INPUT] 0    0    [1    /1   ]  1587.04351515        1
[INPUT] 0    0    [1    /1   ]  418.855114258        1
[INPUT] 0    0    [1    /1   ]  122.686688618        1
[INPUT] 0    0    [1    /1   ]  39.4902396333        1
[INPUT] 0    0    [1    /1   ]  8.50310732327        1
[INPUT] 0    0    [1    /1   ]  3.35694134914        1
[INPUT] 0    0    [1    /1   ]  0.674390588472       1
[INPUT] 0    0    [1    /1   ]  0.24985945392        1
[INPUT] 1    0    [1    /1   ]  1362.85927961        1
[INPUT] 1    0    [1    /1   ]  664.048496251        1
[INPUT] 1    0    [1    /1   ]  297.692799575        1
[INPUT] 1    0    [1    /1   ]  311.228139537        1
[INPUT] 1    0    [1    /1   ]  61.1765719432        1
[INPUT] 1    0    [1    /1   ]  7.29441549326        1
[INPUT] 1    0    [1    /1   ]  20.1060960833        1
[INPUT] 1    0    [1    /1   ]  0.774305657411       1
[INPUT] 1    0    [1    /1   ]  2.80160636506        1
[INPUT] 1    0    [1    /1   ]  0.222453714224       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.876802905383, 1.0]], [0, [7617.028913980906, 1.0]], [0, [3617.5677336734802, 1.0]], [0, [1587.0435151495653, 1.0]], [0, [418.85511425753384, 1.0]], [0, [122.68668861775274, 1.0]], [0, [39.490239633283906, 1.0]], [0, [8.503107323268702, 1.0]], [0, [3.356941349142425, 1.0]], [0, [0.6743905884717432, 1.0]], [0, [0.2498594539199452, 1.0]], [1, [1362.8592796092148, 1.0]], [1, [664.0484962507205, 1.0]], [1, [297.69279957538015, 1.0]], [1, [311.22813953678093, 1.0]], [1, [61.1765719432148, 1.0]], [1, [7.294415493263227, 1.0]], [1, [20.106096083292496, 1.0]], [1, [0.7743056574107927, 1.0]], [1, [2.8016063650568546, 1.0]], [1, [0.2224537142241833, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87680291]
bas 1, expnt(s) = [7617.02891398]
bas 2, expnt(s) = [3617.56773367]
bas 3, expnt(s) = [1587.04351515]
bas 4, expnt(s) = [418.85511426]
bas 5, expnt(s) = [122.68668862]
bas 6, expnt(s) = [39.49023963]
bas 7, expnt(s) = [8.50310732]
bas 8, expnt(s) = [3.35694135]
bas 9, expnt(s) = [0.67439059]
bas 10, expnt(s) = [0.24985945]
bas 11, expnt(s) = [1362.85927961]
bas 12, expnt(s) = [664.04849625]
bas 13, expnt(s) = [297.69279958]
bas 14, expnt(s) = [311.22813954]
bas 15, expnt(s) = [61.17657194]
bas 16, expnt(s) = [7.29441549]
bas 17, expnt(s) = [20.10609608]
bas 18, expnt(s) = [0.77430566]
bas 19, expnt(s) = [2.80160637]
bas 20, expnt(s) = [0.22245371]
CPU time:       577.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828768e+04 5.20029578e+03 7.61702891e+03 2.05993837e+03
 3.61756773e+03 1.17849441e+03 1.58704352e+03 6.35267519e+02
 4.18855114e+02 2.33917596e+02 1.22686689e+02 9.31350405e+01
 3.94902396e+01 3.97999339e+01 8.50310732e+00 1.25805106e+01
 3.35694135e+00 6.26574678e+00 6.74390588e-01 1.88017663e+00
 2.49859454e-01 8.92867190e-01 1.36285928e+03 2.41572872e+04
 6.64048496e+02 9.83408912e+03 2.97692800e+02 3.60740419e+03
 3.11228140e+02 3.81358090e+03 6.11765719e+01 4.99132460e+02
 7.29441549e+00 3.49721646e+01 2.01060961e+01 1.24206432e+02
 7.74305657e-01 2.11897061e+00 2.80160637e+00 1.05740969e+01
 2.22453714e-01 4.45691108e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993514464185917
cond(S) = 93341.76139793028
E1 = -729.5314990195493  E_coul = 203.1798002483862
init E= -526.351698771163
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555799089858128  LUMO = 1.03074288717353
  mo_energy =
[-1.18331958e+02 -1.22047266e+01 -9.44671008e+00 -9.44671008e+00
 -9.44671008e+00 -1.23994250e+00 -5.55799090e-01 -5.55799090e-01
 -5.55799090e-01  1.03074289e+00  1.03074289e+00  1.03074289e+00
  1.06128344e+00  7.31710284e+00  7.31710284e+00  7.31710284e+00
  1.36439348e+01  3.33074107e+01  3.33074107e+01  3.33074107e+01
  1.22855469e+02  1.28136294e+02  1.28136294e+02  1.28136294e+02
  4.79476990e+02  4.79476990e+02  4.79476990e+02  6.65962988e+02
  1.32460635e+03  1.32460635e+03  1.32460635e+03  2.81258896e+03
  3.01025458e+03  3.01025458e+03  3.01025458e+03  6.62527134e+03
  6.62527134e+03  6.62527134e+03  9.23296860e+03  2.55791686e+04
  7.63082974e+04]
E1 = -727.8647344028147  E_coul = 201.11935801124588
cycle= 1 E= -526.745376391569  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537525
diis-c [-0.28893352  1.        ]
  HOMO = -0.59052999823689  LUMO = 1.00661806213461
  mo_energy =
[-1.18637642e+02 -1.23418441e+01 -9.59437195e+00 -9.59437195e+00
 -9.59437195e+00 -1.27930723e+00 -5.90529998e-01 -5.90529998e-01
 -5.90529998e-01  1.00661806e+00  1.00661806e+00  1.00661806e+00
  1.03180388e+00  7.22698996e+00  7.22698996e+00  7.22698996e+00
  1.35302521e+01  3.31546746e+01  3.31546746e+01  3.31546746e+01
  1.22626979e+02  1.27909961e+02  1.27909961e+02  1.27909961e+02
  4.79173251e+02  4.79173251e+02  4.79173251e+02  6.65611876e+02
  1.32424700e+03  1.32424700e+03  1.32424700e+03  2.81209515e+03
  3.00982975e+03  3.00982975e+03  3.00982975e+03  6.62473469e+03
  6.62473469e+03  6.62473469e+03  9.23235867e+03  2.55784650e+04
  7.63075041e+04]
E1 = -728.4352418467611  E_coul = 201.68915637464332
cycle= 2 E= -526.746085472118  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746406
diis-c [-0.00326356  0.08246617  0.91753383]
  HOMO = -0.581461976010463  LUMO = 1.01328969366138
  mo_energy =
[-1.18570412e+02 -1.23040264e+01 -9.55490759e+00 -9.55490759e+00
 -9.55490759e+00 -1.26845596e+00 -5.81461976e-01 -5.81461976e-01
 -5.81461976e-01  1.01328969e+00  1.01328969e+00  1.01328969e+00
  1.04021817e+00  7.25052932e+00  7.25052932e+00  7.25052932e+00
  1.35613181e+01  3.31943954e+01  3.31943954e+01  3.31943954e+01
  1.22683991e+02  1.27965378e+02  1.27965378e+02  1.27965378e+02
  4.79239610e+02  4.79239610e+02  4.79239610e+02  6.65681218e+02
  1.32431740e+03  1.32431740e+03  1.32431740e+03  2.81216894e+03
  3.00990240e+03  3.00990240e+03  3.00990240e+03  6.62480910e+03
  6.62480910e+03  6.62480910e+03  9.23243388e+03  2.55785408e+04
  7.63075802e+04]
E1 = -728.2857370905044  E_coul = 201.53959340111598
cycle= 3 E= -526.746143689388  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013079
diis-c [-5.36120723e-07 -1.21839206e-03  1.44766212e-01  8.56452180e-01]
  HOMO = -0.582952172211876  LUMO = 1.01221660886901
  mo_energy =
[-1.18580312e+02 -1.23098038e+01 -9.56102701e+00 -9.56102701e+00
 -9.56102701e+00 -1.27014199e+00 -5.82952172e-01 -5.82952172e-01
 -5.82952172e-01  1.01221661e+00  1.01221661e+00  1.01221661e+00
  1.03892949e+00  7.24678448e+00  7.24678448e+00  7.24678448e+00
  1.35565494e+01  3.31882736e+01  3.31882736e+01  3.31882736e+01
  1.22675534e+02  1.27957092e+02  1.27957092e+02  1.27957092e+02
  4.79229833e+02  4.79229833e+02  4.79229833e+02  6.65670995e+02
  1.32430704e+03  1.32430704e+03  1.32430704e+03  2.81215793e+03
  3.00989165e+03  3.00989165e+03  3.00989165e+03  6.62479796e+03
  6.62479796e+03  6.62479796e+03  9.23242254e+03  2.55785293e+04
  7.63075686e+04]
E1 = -728.3084320613151  E_coul = 201.5622864701321
cycle= 4 E= -526.746145591183  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107553
diis-c [-3.84419854e-09  6.71925169e-05 -9.74809637e-03 -6.32462977e-02
  1.07292720e+00]
  HOMO = -0.58293384455486  LUMO = 1.01223220670078
  mo_energy =
[-1.18580272e+02 -1.23097402e+01 -9.56097634e+00 -9.56097634e+00
 -9.56097634e+00 -1.27010227e+00 -5.82933845e-01 -5.82933845e-01
 -5.82933845e-01  1.01223221e+00  1.01223221e+00  1.01223221e+00
  1.03896323e+00  7.24682566e+00  7.24682566e+00  7.24682566e+00
  1.35566081e+01  3.31883222e+01  3.31883222e+01  3.31883222e+01
  1.22675584e+02  1.27957139e+02  1.27957139e+02  1.27957139e+02
  4.79229873e+02  4.79229873e+02  4.79229873e+02  6.65671027e+02
  1.32430707e+03  1.32430707e+03  1.32430707e+03  2.81215795e+03
  3.00989167e+03  3.00989167e+03  3.00989167e+03  6.62479797e+03
  6.62479797e+03  6.62479797e+03  9.23242254e+03  2.55785293e+04
  7.63075686e+04]
E1 = -728.3082246451718  E_coul = 201.5620790524922
cycle= 5 E= -526.74614559268  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79638e-05
diis-c [-6.64200834e-11  1.40743229e-05 -1.85161882e-03 -1.38197423e-02
  4.27448731e-02  9.72912414e-01]
  HOMO = -0.582940966506431  LUMO = 1.01222749577806
  mo_energy =
[-1.18580302e+02 -1.23097619e+01 -9.56099991e+00 -9.56099991e+00
 -9.56099991e+00 -1.27010796e+00 -5.82940967e-01 -5.82940967e-01
 -5.82940967e-01  1.01222750e+00  1.01222750e+00  1.01222750e+00
  1.03895929e+00  7.24680975e+00  7.24680975e+00  7.24680975e+00
  1.35565901e+01  3.31882994e+01  3.31882994e+01  3.31882994e+01
  1.22675557e+02  1.27957112e+02  1.27957112e+02  1.27957112e+02
  4.79229844e+02  4.79229844e+02  4.79229844e+02  6.65670996e+02
  1.32430704e+03  1.32430704e+03  1.32430704e+03  2.81215791e+03
  3.00989164e+03  3.00989164e+03  3.00989164e+03  6.62479794e+03
  6.62479794e+03  6.62479794e+03  9.23242251e+03  2.55785292e+04
  7.63075685e+04]
E1 = -728.3083036011889  E_coul = 201.56215800845493
cycle= 6 E= -526.746145592734  delta_E= -5.43e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3083036011889  E_coul = 201.56215800845493
  HOMO = -0.582940997238721  LUMO = 1.01222752799745
  mo_energy =
[-1.18580302e+02 -1.23097618e+01 -9.56099991e+00 -9.56099991e+00
 -9.56099991e+00 -1.27010762e+00 -5.82940997e-01 -5.82940997e-01
 -5.82940997e-01  1.01222753e+00  1.01222753e+00  1.01222753e+00
  1.03895961e+00  7.24680976e+00  7.24680976e+00  7.24680976e+00
  1.35565902e+01  3.31882994e+01  3.31882994e+01  3.31882994e+01
  1.22675557e+02  1.27957112e+02  1.27957112e+02  1.27957112e+02
  4.79229844e+02  4.79229844e+02  4.79229844e+02  6.65670996e+02
  1.32430704e+03  1.32430704e+03  1.32430704e+03  2.81215791e+03
  3.00989164e+03  3.00989164e+03  3.00989164e+03  6.62479794e+03
  6.62479794e+03  6.62479794e+03  9.23242251e+03  2.55785292e+04
  7.63075685e+04]
E1 = -728.3083029079644  E_coul = 201.56215731523008
Extra cycle  E= -526.746145592734  delta_E= -4.55e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93341.76139793028
E1 = -728.3083029079644  E_coul = 201.56215731523008
init E= -526.746145592734
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.58294102102721  LUMO = 1.01222752241481
  mo_energy =
[-1.18580302e+02 -1.23097619e+01 -9.56099998e+00 -9.56099998e+00
 -9.56099998e+00 -1.27010757e+00 -5.82941021e-01 -5.82941021e-01
 -5.82941021e-01  1.01222752e+00  1.01222752e+00  1.01222752e+00
  1.03895966e+00  7.24680972e+00  7.24680972e+00  7.24680972e+00
  1.35565902e+01  3.31882994e+01  3.31882994e+01  3.31882994e+01
  1.22675557e+02  1.27957112e+02  1.27957112e+02  1.27957112e+02
  4.79229844e+02  4.79229844e+02  4.79229844e+02  6.65670996e+02
  1.32430704e+03  1.32430704e+03  1.32430704e+03  2.81215791e+03
  3.00989164e+03  3.00989164e+03  3.00989164e+03  6.62479794e+03
  6.62479794e+03  6.62479794e+03  9.23242251e+03  2.55785292e+04
  7.63075685e+04]
E1 = -728.3083030066916  E_coul = 201.56215741395772
cycle= 1 E= -526.746145592734  delta_E= 4.55e-13  |g|= 7.11e-08  |ddm|= 5.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3083030066916  E_coul = 201.56215741395772
  HOMO = -0.582941021385851  LUMO = 1.01222752449796
  mo_energy =
[-1.18580302e+02 -1.23097619e+01 -9.56099998e+00 -9.56099998e+00
 -9.56099998e+00 -1.27010755e+00 -5.82941021e-01 -5.82941021e-01
 -5.82941021e-01  1.01222752e+00  1.01222752e+00  1.01222752e+00
  1.03895968e+00  7.24680973e+00  7.24680973e+00  7.24680973e+00
  1.35565902e+01  3.31882994e+01  3.31882994e+01  3.31882994e+01
  1.22675557e+02  1.27957112e+02  1.27957112e+02  1.27957112e+02
  4.79229844e+02  4.79229844e+02  4.79229844e+02  6.65670996e+02
  1.32430704e+03  1.32430704e+03  1.32430704e+03  2.81215791e+03
  3.00989164e+03  3.00989164e+03  3.00989164e+03  6.62479794e+03
  6.62479794e+03  6.62479794e+03  9.23242251e+03  2.55785292e+04
  7.63075685e+04]
E1 = -728.308302959091  E_coul = 201.56215736635755
Extra cycle  E= -526.746145592733  delta_E= 4.55e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828768e+04 7.61702891e+03 3.61756773e+03 1.58704352e+03
 4.18855114e+02 1.22686689e+02 3.94902396e+01 8.50310732e+00
 3.35694135e+00 6.74390588e-01 2.49859454e-01 1.36285928e+03
 6.64048496e+02 2.97692800e+02 3.11228140e+02 6.11765719e+01
 7.29441549e+00 2.01060961e+01 7.74305657e-01 2.80160637e+00
 2.22453714e-01]
grad_E = [-1.39430782e-06  2.13418407e-06 -2.14343753e-06  3.62922315e-05
  1.29312828e-05  3.20355615e-06  1.29472792e-06 -9.48645845e-07
  3.69849790e-06  7.91123536e-06 -7.15932394e-06 -5.13866676e-07
  5.10272979e-06  2.43568258e-05  2.08426391e-05 -2.51859055e-05
 -2.74361025e-06 -8.79716256e-06  2.96285794e-05  1.06606002e-05
 -7.20096391e-05]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8765249        1
[INPUT] 0    0    [1    /1   ]  7617.02942231        1
[INPUT] 0    0    [1    /1   ]  3617.56737111        1
[INPUT] 0    0    [1    /1   ]  1587.053435          1
[INPUT] 0    0    [1    /1   ]  418.836807012        1
[INPUT] 0    0    [1    /1   ]  122.681967759        1
[INPUT] 0    0    [1    /1   ]  39.4894615225        1
[INPUT] 0    0    [1    /1   ]  8.50299432198        1
[INPUT] 0    0    [1    /1   ]  3.35696897913        1
[INPUT] 0    0    [1    /1   ]  0.674480729758       1
[INPUT] 0    0    [1    /1   ]  0.249886889693       1
[INPUT] 1    0    [1    /1   ]  1362.85916928        1
[INPUT] 1    0    [1    /1   ]  664.049301801        1
[INPUT] 1    0    [1    /1   ]  297.696493701        1
[INPUT] 1    0    [1    /1   ]  311.231303951        1
[INPUT] 1    0    [1    /1   ]  61.1880331221        1
[INPUT] 1    0    [1    /1   ]  7.29631001747        1
[INPUT] 1    0    [1    /1   ]  20.1105685386        1
[INPUT] 1    0    [1    /1   ]  0.774404975888       1
[INPUT] 1    0    [1    /1   ]  2.80241694306        1
[INPUT] 1    0    [1    /1   ]  0.222472349888       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.87652489318, 1.0]], [0, [7617.029422306597, 1.0]], [0, [3617.5673711147747, 1.0]], [0, [1587.0534350018004, 1.0]], [0, [418.8368070123394, 1.0]], [0, [122.68196775906348, 1.0]], [0, [39.48946152248826, 1.0]], [0, [8.50299432197919, 1.0]], [0, [3.3569689791274806, 1.0]], [0, [0.6744807297577795, 1.0]], [0, [0.24988688969296316, 1.0]], [1, [1362.8591692838509, 1.0]], [1, [664.0493018009776, 1.0]], [1, [297.69649370084863, 1.0]], [1, [311.23130395125173, 1.0]], [1, [61.188033122080775, 1.0]], [1, [7.296310017468968, 1.0]], [1, [20.11056853857672, 1.0]], [1, [0.7744049758877818, 1.0]], [1, [2.802416943057732, 1.0]], [1, [0.2224723498878104, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87652489]
bas 1, expnt(s) = [7617.02942231]
bas 2, expnt(s) = [3617.56737111]
bas 3, expnt(s) = [1587.053435]
bas 4, expnt(s) = [418.83680701]
bas 5, expnt(s) = [122.68196776]
bas 6, expnt(s) = [39.48946152]
bas 7, expnt(s) = [8.50299432]
bas 8, expnt(s) = [3.35696898]
bas 9, expnt(s) = [0.67448073]
bas 10, expnt(s) = [0.24988689]
bas 11, expnt(s) = [1362.85916928]
bas 12, expnt(s) = [664.0493018]
bas 13, expnt(s) = [297.6964937]
bas 14, expnt(s) = [311.23130395]
bas 15, expnt(s) = [61.18803312]
bas 16, expnt(s) = [7.29631002]
bas 17, expnt(s) = [20.11056854]
bas 18, expnt(s) = [0.77440498]
bas 19, expnt(s) = [2.80241694]
bas 20, expnt(s) = [0.22247235]
CPU time:       583.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828765e+04 5.20029574e+03 7.61702942e+03 2.05993847e+03
 3.61756737e+03 1.17849432e+03 1.58705344e+03 6.35270497e+02
 4.18836807e+02 2.33909927e+02 1.22681968e+02 9.31323527e+01
 3.94894615e+01 3.97993458e+01 8.50299432e+00 1.25803853e+01
 3.35696898e+00 6.26578546e+00 6.74480730e-01 1.88036511e+00
 2.49886890e-01 8.92940719e-01 1.36285917e+03 2.41572847e+04
 6.64049302e+02 9.83410403e+03 2.97696494e+02 3.60746015e+03
 3.11231304e+02 3.81362936e+03 6.11880331e+01 4.99249351e+02
 7.29631002e+00 3.49835188e+01 2.01105685e+01 1.24240969e+02
 7.74404976e-01 2.11931036e+00 2.80241694e+00 1.05779213e+01
 2.22472350e-01 4.45737779e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993510897110138
cond(S) = 93371.40727884129
E1 = -729.5315051103015  E_coul = 203.17980583524195
init E= -526.35169927506
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555798270598855  LUMO = 1.03090417037486
  mo_energy =
[-1.18331957e+02 -1.22047264e+01 -9.44671036e+00 -9.44671036e+00
 -9.44671036e+00 -1.23994208e+00 -5.55798271e-01 -5.55798271e-01
 -5.55798271e-01  1.03090417e+00  1.03090417e+00  1.03090417e+00
  1.06149886e+00  7.31945728e+00  7.31945728e+00  7.31945728e+00
  1.36444212e+01  3.33180772e+01  3.33180772e+01  3.33180772e+01
  1.22852020e+02  1.28168948e+02  1.28168948e+02  1.28168948e+02
  4.79534740e+02  4.79534740e+02  4.79534740e+02  6.65936074e+02
  1.32467627e+03  1.32467627e+03  1.32467627e+03  2.81252834e+03
  3.01033371e+03  3.01033371e+03  3.01033371e+03  6.62535305e+03
  6.62535305e+03  6.62535305e+03  9.23290590e+03  2.55791147e+04
  7.63082508e+04]
E1 = -727.8648223848006  E_coul = 201.1194458891694
cycle= 1 E= -526.745376495631  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.53753
diis-c [-0.28893847  1.        ]
  HOMO = -0.59052723024479  LUMO = 1.00677651559299
  mo_energy =
[-1.18637632e+02 -1.23418381e+01 -9.59436625e+00 -9.59436625e+00
 -9.59436625e+00 -1.27930472e+00 -5.90527230e-01 -5.90527230e-01
 -5.90527230e-01  1.00677652e+00  1.00677652e+00  1.00677652e+00
  1.03201678e+00  7.22933148e+00  7.22933148e+00  7.22933148e+00
  1.35307435e+01  3.31653321e+01  3.31653321e+01  3.31653321e+01
  1.22623541e+02  1.27942613e+02  1.27942613e+02  1.27942613e+02
  4.79231009e+02  4.79231009e+02  4.79231009e+02  6.65584975e+02
  1.32431693e+03  1.32431693e+03  1.32431693e+03  2.81203454e+03
  3.00990889e+03  3.00990889e+03  3.00990889e+03  6.62481641e+03
  6.62481641e+03  6.62481641e+03  9.23229598e+03  2.55784111e+04
  7.63074575e+04]
E1 = -728.4352981490982  E_coul = 201.68921262707315
cycle= 2 E= -526.746085522025  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746391
diis-c [-0.00326345  0.08246359  0.91753641]
  HOMO = -0.581459858181478  LUMO = 1.01344889808207
  mo_energy =
[-1.18570405e+02 -1.23040224e+01 -9.55490392e+00 -9.55490392e+00
 -9.55490392e+00 -1.26845422e+00 -5.81459858e-01 -5.81459858e-01
 -5.81459858e-01  1.01344890e+00  1.01344890e+00  1.01344890e+00
  1.04043169e+00  7.25287381e+00  7.25287381e+00  7.25287381e+00
  1.35618076e+01  3.32050546e+01  3.32050546e+01  3.32050546e+01
  1.22680550e+02  1.27998029e+02  1.27998029e+02  1.27998029e+02
  4.79297365e+02  4.79297365e+02  4.79297365e+02  6.65654314e+02
  1.32438733e+03  1.32438733e+03  1.32438733e+03  2.81210832e+03
  3.00998154e+03  3.00998154e+03  3.00998154e+03  6.62489081e+03
  6.62489081e+03  6.62489081e+03  9.23237120e+03  2.55784869e+04
  7.63075336e+04]
E1 = -728.285803622058  E_coul = 201.5396598892271
cycle= 3 E= -526.746143732831  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130787
diis-c [-5.36074510e-07 -1.21838380e-03  1.44765642e-01  8.56452742e-01]
  HOMO = -0.582949941459248  LUMO = 1.01237569658356
  mo_energy =
[-1.18580305e+02 -1.23097994e+01 -9.56102299e+00 -9.56102299e+00
 -9.56102299e+00 -1.27014013e+00 -5.82949941e-01 -5.82949941e-01
 -5.82949941e-01  1.01237570e+00  1.01237570e+00  1.01237570e+00
  1.03914292e+00  7.24912854e+00  7.24912854e+00  7.24912854e+00
  1.35570392e+01  3.31989326e+01  3.31989326e+01  3.31989326e+01
  1.22672093e+02  1.27989743e+02  1.27989743e+02  1.27989743e+02
  4.79287589e+02  4.79287589e+02  4.79287589e+02  6.65644092e+02
  1.32437697e+03  1.32437697e+03  1.32437697e+03  2.81209732e+03
  3.00997079e+03  3.00997079e+03  3.00997079e+03  6.62487968e+03
  6.62487968e+03  6.62487968e+03  9.23235985e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3084969670425  E_coul = 201.56235133264423
cycle= 4 E= -526.746145634398  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107547
diis-c [-3.84331252e-09  6.71941895e-05 -9.74837812e-03 -6.32482065e-02
  1.07292939e+00]
  HOMO = -0.582931614701508  LUMO = 1.01239129577078
  mo_energy =
[-1.18580265e+02 -1.23097359e+01 -9.56097234e+00 -9.56097234e+00
 -9.56097234e+00 -1.27010040e+00 -5.82931615e-01 -5.82931615e-01
 -5.82931615e-01  1.01239130e+00  1.01239130e+00  1.01239130e+00
  1.03917666e+00  7.24916971e+00  7.24916971e+00  7.24916971e+00
  1.35570980e+01  3.31989812e+01  3.31989812e+01  3.31989812e+01
  1.22672143e+02  1.27989790e+02  1.27989790e+02  1.27989790e+02
  4.79287629e+02  4.79287629e+02  4.79287629e+02  6.65644124e+02
  1.32437700e+03  1.32437700e+03  1.32437700e+03  2.81209733e+03
  3.00997082e+03  3.00997082e+03  3.00997082e+03  6.62487969e+03
  6.62487969e+03  6.62487969e+03  9.23235985e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3082895683812  E_coul = 201.56214393248416
cycle= 5 E= -526.746145635897  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79611e-05
diis-c [-6.64055908e-11  1.40723509e-05 -1.85138527e-03 -1.38183235e-02
  4.27493390e-02  9.72906297e-01]
  HOMO = -0.582938735977737  LUMO = 1.01238658437034
  mo_energy =
[-1.18580294e+02 -1.23097576e+01 -9.56099590e+00 -9.56099590e+00
 -9.56099590e+00 -1.27010609e+00 -5.82938736e-01 -5.82938736e-01
 -5.82938736e-01  1.01238658e+00  1.01238658e+00  1.01238658e+00
  1.03917272e+00  7.24915381e+00  7.24915381e+00  7.24915381e+00
  1.35570799e+01  3.31989584e+01  3.31989584e+01  3.31989584e+01
  1.22672117e+02  1.27989763e+02  1.27989763e+02  1.27989763e+02
  4.79287600e+02  4.79287600e+02  4.79287600e+02  6.65644093e+02
  1.32437697e+03  1.32437697e+03  1.32437697e+03  2.81209730e+03
  3.00997079e+03  3.00997079e+03  3.00997079e+03  6.62487965e+03
  6.62487965e+03  6.62487965e+03  9.23235982e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3083685179691  E_coul = 201.56222288201934
cycle= 6 E= -526.74614563595  delta_E= -5.29e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3083685179691  E_coul = 201.56222288201934
  HOMO = -0.582938766681413  LUMO = 1.0123866165997
  mo_energy =
[-1.18580294e+02 -1.23097575e+01 -9.56099590e+00 -9.56099590e+00
 -9.56099590e+00 -1.27010575e+00 -5.82938767e-01 -5.82938767e-01
 -5.82938767e-01  1.01238662e+00  1.01238662e+00  1.01238662e+00
  1.03917304e+00  7.24915382e+00  7.24915382e+00  7.24915382e+00
  1.35570801e+01  3.31989584e+01  3.31989584e+01  3.31989584e+01
  1.22672117e+02  1.27989763e+02  1.27989763e+02  1.27989763e+02
  4.79287600e+02  4.79287600e+02  4.79287600e+02  6.65644093e+02
  1.32437697e+03  1.32437697e+03  1.32437697e+03  2.81209730e+03
  3.00997079e+03  3.00997079e+03  3.00997079e+03  6.62487965e+03
  6.62487965e+03  6.62487965e+03  9.23235982e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3083678246181  E_coul = 201.56222218866628
Extra cycle  E= -526.746145635952  delta_E= -2.05e-12  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828765e+04 7.61702942e+03 3.61756737e+03 1.58705344e+03
 4.18836807e+02 1.22681968e+02 3.94894615e+01 8.50299432e+00
 3.35696898e+00 6.74480730e-01 2.49886890e-01 1.36285917e+03
 6.64049302e+02 2.97696494e+02 3.11231304e+02 6.11880331e+01
 7.29631002e+00 2.01105685e+01 7.74404976e-01 2.80241694e+00
 2.22472350e-01]
E = -526.7461456359518
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8765249        1
[INPUT] 0    0    [1    /1   ]  7617.02942231        1
[INPUT] 0    0    [1    /1   ]  3617.56737111        1
[INPUT] 0    0    [1    /1   ]  1587.053435          1
[INPUT] 0    0    [1    /1   ]  418.836807012        1
[INPUT] 0    0    [1    /1   ]  122.681967759        1
[INPUT] 0    0    [1    /1   ]  39.4894615225        1
[INPUT] 0    0    [1    /1   ]  8.50299432198        1
[INPUT] 0    0    [1    /1   ]  3.35696897913        1
[INPUT] 0    0    [1    /1   ]  0.674480729758       1
[INPUT] 0    0    [1    /1   ]  0.249886889693       1
[INPUT] 1    0    [1    /1   ]  1362.85916928        1
[INPUT] 1    0    [1    /1   ]  664.049301801        1
[INPUT] 1    0    [1    /1   ]  297.696493701        1
[INPUT] 1    0    [1    /1   ]  311.231303951        1
[INPUT] 1    0    [1    /1   ]  61.1880331221        1
[INPUT] 1    0    [1    /1   ]  7.29631001747        1
[INPUT] 1    0    [1    /1   ]  20.1105685386        1
[INPUT] 1    0    [1    /1   ]  0.774404975888       1
[INPUT] 1    0    [1    /1   ]  2.80241694306        1
[INPUT] 1    0    [1    /1   ]  0.222472349888       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.87652489318, 1.0]], [0, [7617.029422306597, 1.0]], [0, [3617.5673711147747, 1.0]], [0, [1587.0534350018004, 1.0]], [0, [418.8368070123394, 1.0]], [0, [122.68196775906348, 1.0]], [0, [39.48946152248826, 1.0]], [0, [8.50299432197919, 1.0]], [0, [3.3569689791274806, 1.0]], [0, [0.6744807297577795, 1.0]], [0, [0.24988688969296316, 1.0]], [1, [1362.8591692838509, 1.0]], [1, [664.0493018009776, 1.0]], [1, [297.69649370084863, 1.0]], [1, [311.23130395125173, 1.0]], [1, [61.188033122080775, 1.0]], [1, [7.296310017468968, 1.0]], [1, [20.11056853857672, 1.0]], [1, [0.7744049758877818, 1.0]], [1, [2.802416943057732, 1.0]], [1, [0.2224723498878104, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87652489]
bas 1, expnt(s) = [7617.02942231]
bas 2, expnt(s) = [3617.56737111]
bas 3, expnt(s) = [1587.053435]
bas 4, expnt(s) = [418.83680701]
bas 5, expnt(s) = [122.68196776]
bas 6, expnt(s) = [39.48946152]
bas 7, expnt(s) = [8.50299432]
bas 8, expnt(s) = [3.35696898]
bas 9, expnt(s) = [0.67448073]
bas 10, expnt(s) = [0.24988689]
bas 11, expnt(s) = [1362.85916928]
bas 12, expnt(s) = [664.0493018]
bas 13, expnt(s) = [297.6964937]
bas 14, expnt(s) = [311.23130395]
bas 15, expnt(s) = [61.18803312]
bas 16, expnt(s) = [7.29631002]
bas 17, expnt(s) = [20.11056854]
bas 18, expnt(s) = [0.77440498]
bas 19, expnt(s) = [2.80241694]
bas 20, expnt(s) = [0.22247235]
CPU time:       583.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828765e+04 5.20029574e+03 7.61702942e+03 2.05993847e+03
 3.61756737e+03 1.17849432e+03 1.58705344e+03 6.35270497e+02
 4.18836807e+02 2.33909927e+02 1.22681968e+02 9.31323527e+01
 3.94894615e+01 3.97993458e+01 8.50299432e+00 1.25803853e+01
 3.35696898e+00 6.26578546e+00 6.74480730e-01 1.88036511e+00
 2.49886890e-01 8.92940719e-01 1.36285917e+03 2.41572847e+04
 6.64049302e+02 9.83410403e+03 2.97696494e+02 3.60746015e+03
 3.11231304e+02 3.81362936e+03 6.11880331e+01 4.99249351e+02
 7.29631002e+00 3.49835188e+01 2.01105685e+01 1.24240969e+02
 7.74404976e-01 2.11931036e+00 2.80241694e+00 1.05779213e+01
 2.22472350e-01 4.45737779e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993510897110138
cond(S) = 93371.40727884129
E1 = -729.5315051103015  E_coul = 203.17980583524195
init E= -526.35169927506
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555798270598855  LUMO = 1.03090417037486
  mo_energy =
[-1.18331957e+02 -1.22047264e+01 -9.44671036e+00 -9.44671036e+00
 -9.44671036e+00 -1.23994208e+00 -5.55798271e-01 -5.55798271e-01
 -5.55798271e-01  1.03090417e+00  1.03090417e+00  1.03090417e+00
  1.06149886e+00  7.31945728e+00  7.31945728e+00  7.31945728e+00
  1.36444212e+01  3.33180772e+01  3.33180772e+01  3.33180772e+01
  1.22852020e+02  1.28168948e+02  1.28168948e+02  1.28168948e+02
  4.79534740e+02  4.79534740e+02  4.79534740e+02  6.65936074e+02
  1.32467627e+03  1.32467627e+03  1.32467627e+03  2.81252834e+03
  3.01033371e+03  3.01033371e+03  3.01033371e+03  6.62535305e+03
  6.62535305e+03  6.62535305e+03  9.23290590e+03  2.55791147e+04
  7.63082508e+04]
E1 = -727.8648223848006  E_coul = 201.1194458891694
cycle= 1 E= -526.745376495631  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.53753
diis-c [-0.28893847  1.        ]
  HOMO = -0.59052723024479  LUMO = 1.00677651559299
  mo_energy =
[-1.18637632e+02 -1.23418381e+01 -9.59436625e+00 -9.59436625e+00
 -9.59436625e+00 -1.27930472e+00 -5.90527230e-01 -5.90527230e-01
 -5.90527230e-01  1.00677652e+00  1.00677652e+00  1.00677652e+00
  1.03201678e+00  7.22933148e+00  7.22933148e+00  7.22933148e+00
  1.35307435e+01  3.31653321e+01  3.31653321e+01  3.31653321e+01
  1.22623541e+02  1.27942613e+02  1.27942613e+02  1.27942613e+02
  4.79231009e+02  4.79231009e+02  4.79231009e+02  6.65584975e+02
  1.32431693e+03  1.32431693e+03  1.32431693e+03  2.81203454e+03
  3.00990889e+03  3.00990889e+03  3.00990889e+03  6.62481641e+03
  6.62481641e+03  6.62481641e+03  9.23229598e+03  2.55784111e+04
  7.63074575e+04]
E1 = -728.4352981490982  E_coul = 201.68921262707315
cycle= 2 E= -526.746085522025  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746391
diis-c [-0.00326345  0.08246359  0.91753641]
  HOMO = -0.581459858181478  LUMO = 1.01344889808207
  mo_energy =
[-1.18570405e+02 -1.23040224e+01 -9.55490392e+00 -9.55490392e+00
 -9.55490392e+00 -1.26845422e+00 -5.81459858e-01 -5.81459858e-01
 -5.81459858e-01  1.01344890e+00  1.01344890e+00  1.01344890e+00
  1.04043169e+00  7.25287381e+00  7.25287381e+00  7.25287381e+00
  1.35618076e+01  3.32050546e+01  3.32050546e+01  3.32050546e+01
  1.22680550e+02  1.27998029e+02  1.27998029e+02  1.27998029e+02
  4.79297365e+02  4.79297365e+02  4.79297365e+02  6.65654314e+02
  1.32438733e+03  1.32438733e+03  1.32438733e+03  2.81210832e+03
  3.00998154e+03  3.00998154e+03  3.00998154e+03  6.62489081e+03
  6.62489081e+03  6.62489081e+03  9.23237120e+03  2.55784869e+04
  7.63075336e+04]
E1 = -728.285803622058  E_coul = 201.5396598892271
cycle= 3 E= -526.746143732831  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130787
diis-c [-5.36074510e-07 -1.21838380e-03  1.44765642e-01  8.56452742e-01]
  HOMO = -0.582949941459248  LUMO = 1.01237569658356
  mo_energy =
[-1.18580305e+02 -1.23097994e+01 -9.56102299e+00 -9.56102299e+00
 -9.56102299e+00 -1.27014013e+00 -5.82949941e-01 -5.82949941e-01
 -5.82949941e-01  1.01237570e+00  1.01237570e+00  1.01237570e+00
  1.03914292e+00  7.24912854e+00  7.24912854e+00  7.24912854e+00
  1.35570392e+01  3.31989326e+01  3.31989326e+01  3.31989326e+01
  1.22672093e+02  1.27989743e+02  1.27989743e+02  1.27989743e+02
  4.79287589e+02  4.79287589e+02  4.79287589e+02  6.65644092e+02
  1.32437697e+03  1.32437697e+03  1.32437697e+03  2.81209732e+03
  3.00997079e+03  3.00997079e+03  3.00997079e+03  6.62487968e+03
  6.62487968e+03  6.62487968e+03  9.23235985e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3084969670425  E_coul = 201.56235133264423
cycle= 4 E= -526.746145634398  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107547
diis-c [-3.84331252e-09  6.71941895e-05 -9.74837812e-03 -6.32482065e-02
  1.07292939e+00]
  HOMO = -0.582931614701508  LUMO = 1.01239129577078
  mo_energy =
[-1.18580265e+02 -1.23097359e+01 -9.56097234e+00 -9.56097234e+00
 -9.56097234e+00 -1.27010040e+00 -5.82931615e-01 -5.82931615e-01
 -5.82931615e-01  1.01239130e+00  1.01239130e+00  1.01239130e+00
  1.03917666e+00  7.24916971e+00  7.24916971e+00  7.24916971e+00
  1.35570980e+01  3.31989812e+01  3.31989812e+01  3.31989812e+01
  1.22672143e+02  1.27989790e+02  1.27989790e+02  1.27989790e+02
  4.79287629e+02  4.79287629e+02  4.79287629e+02  6.65644124e+02
  1.32437700e+03  1.32437700e+03  1.32437700e+03  2.81209733e+03
  3.00997082e+03  3.00997082e+03  3.00997082e+03  6.62487969e+03
  6.62487969e+03  6.62487969e+03  9.23235985e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3082895683812  E_coul = 201.56214393248416
cycle= 5 E= -526.746145635897  delta_E= -1.5e-09  |g|= 2e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79611e-05
diis-c [-6.64055908e-11  1.40723509e-05 -1.85138527e-03 -1.38183235e-02
  4.27493390e-02  9.72906297e-01]
  HOMO = -0.582938735977737  LUMO = 1.01238658437034
  mo_energy =
[-1.18580294e+02 -1.23097576e+01 -9.56099590e+00 -9.56099590e+00
 -9.56099590e+00 -1.27010609e+00 -5.82938736e-01 -5.82938736e-01
 -5.82938736e-01  1.01238658e+00  1.01238658e+00  1.01238658e+00
  1.03917272e+00  7.24915381e+00  7.24915381e+00  7.24915381e+00
  1.35570799e+01  3.31989584e+01  3.31989584e+01  3.31989584e+01
  1.22672117e+02  1.27989763e+02  1.27989763e+02  1.27989763e+02
  4.79287600e+02  4.79287600e+02  4.79287600e+02  6.65644093e+02
  1.32437697e+03  1.32437697e+03  1.32437697e+03  2.81209730e+03
  3.00997079e+03  3.00997079e+03  3.00997079e+03  6.62487965e+03
  6.62487965e+03  6.62487965e+03  9.23235982e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3083685179691  E_coul = 201.56222288201934
cycle= 6 E= -526.74614563595  delta_E= -5.29e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3083685179691  E_coul = 201.56222288201934
  HOMO = -0.582938766681413  LUMO = 1.0123866165997
  mo_energy =
[-1.18580294e+02 -1.23097575e+01 -9.56099590e+00 -9.56099590e+00
 -9.56099590e+00 -1.27010575e+00 -5.82938767e-01 -5.82938767e-01
 -5.82938767e-01  1.01238662e+00  1.01238662e+00  1.01238662e+00
  1.03917304e+00  7.24915382e+00  7.24915382e+00  7.24915382e+00
  1.35570801e+01  3.31989584e+01  3.31989584e+01  3.31989584e+01
  1.22672117e+02  1.27989763e+02  1.27989763e+02  1.27989763e+02
  4.79287600e+02  4.79287600e+02  4.79287600e+02  6.65644093e+02
  1.32437697e+03  1.32437697e+03  1.32437697e+03  2.81209730e+03
  3.00997079e+03  3.00997079e+03  3.00997079e+03  6.62487965e+03
  6.62487965e+03  6.62487965e+03  9.23235982e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3083678246181  E_coul = 201.56222218866628
Extra cycle  E= -526.746145635952  delta_E= -2.05e-12  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93371.40727884129
E1 = -728.3083678246181  E_coul = 201.56222218866628
init E= -526.746145635952
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.58293879047059  LUMO = 1.01238661101222
  mo_energy =
[-1.18580294e+02 -1.23097576e+01 -9.56099597e+00 -9.56099597e+00
 -9.56099597e+00 -1.27010571e+00 -5.82938790e-01 -5.82938790e-01
 -5.82938790e-01  1.01238661e+00  1.01238661e+00  1.01238661e+00
  1.03917309e+00  7.24915378e+00  7.24915378e+00  7.24915378e+00
  1.35570801e+01  3.31989584e+01  3.31989584e+01  3.31989584e+01
  1.22672117e+02  1.27989763e+02  1.27989763e+02  1.27989763e+02
  4.79287600e+02  4.79287600e+02  4.79287600e+02  6.65644093e+02
  1.32437697e+03  1.32437697e+03  1.32437697e+03  2.81209730e+03
  3.00997079e+03  3.00997079e+03  3.00997079e+03  6.62487965e+03
  6.62487965e+03  6.62487965e+03  9.23235982e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3083679234074  E_coul = 201.56222228745716
cycle= 1 E= -526.74614563595  delta_E= 1.59e-12  |g|= 7.11e-08  |ddm|= 5.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3083679234074  E_coul = 201.56222228745716
  HOMO = -0.582938790827174  LUMO = 1.01238661309634
  mo_energy =
[-1.18580294e+02 -1.23097575e+01 -9.56099597e+00 -9.56099597e+00
 -9.56099597e+00 -1.27010569e+00 -5.82938791e-01 -5.82938791e-01
 -5.82938791e-01  1.01238661e+00  1.01238661e+00  1.01238661e+00
  1.03917311e+00  7.24915378e+00  7.24915378e+00  7.24915378e+00
  1.35570801e+01  3.31989584e+01  3.31989584e+01  3.31989584e+01
  1.22672117e+02  1.27989763e+02  1.27989763e+02  1.27989763e+02
  4.79287600e+02  4.79287600e+02  4.79287600e+02  6.65644093e+02
  1.32437697e+03  1.32437697e+03  1.32437697e+03  2.81209730e+03
  3.00997079e+03  3.00997079e+03  3.00997079e+03  6.62487965e+03
  6.62487965e+03  6.62487965e+03  9.23235982e+03  2.55784754e+04
  7.63075219e+04]
E1 = -728.3083678757987  E_coul = 201.56222223984787
Extra cycle  E= -526.746145635951  delta_E= -5.68e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828765e+04 7.61702942e+03 3.61756737e+03 1.58705344e+03
 4.18836807e+02 1.22681968e+02 3.94894615e+01 8.50299432e+00
 3.35696898e+00 6.74480730e-01 2.49886890e-01 1.36285917e+03
 6.64049302e+02 2.97696494e+02 3.11231304e+02 6.11880331e+01
 7.29631002e+00 2.01105685e+01 7.74404976e-01 2.80241694e+00
 2.22472350e-01]
grad_E = [-1.39438852e-06  2.13484034e-06 -2.14342954e-06  3.63111027e-05
  1.28074126e-05  3.05067196e-06  1.71631588e-06 -3.05718908e-06
  1.13690299e-05  2.07448264e-05 -1.57634421e-05 -5.14401222e-07
  5.09580811e-06  2.43179490e-05  2.08091207e-05 -2.45699576e-05
 -3.52596257e-06 -9.81500632e-06  6.33272419e-05  2.58267335e-05
 -1.56997487e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8760949        1
[INPUT] 0    0    [1    /1   ]  7617.03022832        1
[INPUT] 0    0    [1    /1   ]  3617.56682586        1
[INPUT] 0    0    [1    /1   ]  1587.06942034        1
[INPUT] 0    0    [1    /1   ]  418.80351572         1
[INPUT] 0    0    [1    /1   ]  122.6733031          1
[INPUT] 0    0    [1    /1   ]  39.4880144081        1
[INPUT] 0    0    [1    /1   ]  8.50274505043        1
[INPUT] 0    0    [1    /1   ]  3.35701752829        1
[INPUT] 0    0    [1    /1   ]  0.674653421617       1
[INPUT] 0    0    [1    /1   ]  0.249939671078       1
[INPUT] 1    0    [1    /1   ]  1362.85899829        1
[INPUT] 1    0    [1    /1   ]  664.050519235        1
[INPUT] 1    0    [1    /1   ]  297.702052518        1
[INPUT] 1    0    [1    /1   ]  311.236067378        1
[INPUT] 1    0    [1    /1   ]  61.2076330771        1
[INPUT] 1    0    [1    /1   ]  7.29959760038        1
[INPUT] 1    0    [1    /1   ]  20.118241598         1
[INPUT] 1    0    [1    /1   ]  0.774578219122       1
[INPUT] 1    0    [1    /1   ]  2.80383549872        1
[INPUT] 1    0    [1    /1   ]  0.222504892988       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.876094854757, 1.0]], [0, [7617.030228321287, 1.0]], [0, [3617.5668258645233, 1.0]], [0, [1587.0694203361504, 1.0]], [0, [418.8035157199019, 1.0]], [0, [122.67330309970936, 1.0]], [0, [39.48801440808153, 1.0]], [0, [8.502745050426919, 1.0]], [0, [3.3570175282918595, 1.0]], [0, [0.6746534216170945, 1.0]], [0, [0.24993967107803405, 1.0]], [1, [1362.8589982896633, 1.0]], [1, [664.0505192350041, 1.0]], [1, [297.7020525181326, 1.0]], [1, [311.2360673776285, 1.0]], [1, [61.20763307707343, 1.0]], [1, [7.299597600378466, 1.0]], [1, [20.11824159797424, 1.0]], [1, [0.7745782191216868, 1.0]], [1, [2.8038354987209804, 1.0]], [1, [0.22250489298760856, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87609485]
bas 1, expnt(s) = [7617.03022832]
bas 2, expnt(s) = [3617.56682586]
bas 3, expnt(s) = [1587.06942034]
bas 4, expnt(s) = [418.80351572]
bas 5, expnt(s) = [122.6733031]
bas 6, expnt(s) = [39.48801441]
bas 7, expnt(s) = [8.50274505]
bas 8, expnt(s) = [3.35701753]
bas 9, expnt(s) = [0.67465342]
bas 10, expnt(s) = [0.24993967]
bas 11, expnt(s) = [1362.85899829]
bas 12, expnt(s) = [664.05051924]
bas 13, expnt(s) = [297.70205252]
bas 14, expnt(s) = [311.23606738]
bas 15, expnt(s) = [61.20763308]
bas 16, expnt(s) = [7.2995976]
bas 17, expnt(s) = [20.1182416]
bas 18, expnt(s) = [0.77457822]
bas 19, expnt(s) = [2.8038355]
bas 20, expnt(s) = [0.22250489]
CPU time:       589.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828761e+04 5.20029567e+03 7.61703023e+03 2.05993864e+03
 3.61756683e+03 1.17849419e+03 1.58706942e+03 6.35275296e+02
 4.18803516e+02 2.33895983e+02 1.22673303e+02 9.31274194e+01
 3.94880144e+01 3.97982519e+01 8.50274505e+00 1.25801087e+01
 3.35701753e+00 6.26585342e+00 6.74653422e-01 1.88072618e+00
 2.49939671e-01 8.93082172e-01 1.36285900e+03 2.41572809e+04
 6.64050519e+02 9.83412656e+03 2.97702053e+02 3.60754435e+03
 3.11236067e+02 3.81370232e+03 6.12076331e+01 4.99449260e+02
 7.29959760e+00 3.50032236e+01 2.01182416e+01 1.24300226e+02
 7.74578219e-01 2.11990302e+00 2.80383550e+00 1.05846147e+01
 2.22504893e-01 4.45819284e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993504618594727
cond(S) = 93419.84934318207
E1 = -729.5315155823752  E_coul = 203.17981570023616
init E= -526.351699882139
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555796831012883  LUMO = 1.03118573040835
  mo_energy =
[-1.18331956e+02 -1.22047262e+01 -9.44671082e+00 -9.44671082e+00
 -9.44671082e+00 -1.23994126e+00 -5.55796831e-01 -5.55796831e-01
 -5.55796831e-01  1.03118573e+00  1.03118573e+00  1.03118573e+00
  1.06191228e+00  7.32356836e+00  7.32356836e+00  7.32356836e+00
  1.36453071e+01  3.33365762e+01  3.33365762e+01  3.33365762e+01
  1.22845512e+02  1.28225128e+02  1.28225128e+02  1.28225128e+02
  4.79633299e+02  4.79633299e+02  4.79633299e+02  6.65886640e+02
  1.32479410e+03  1.32479410e+03  1.32479410e+03  2.81241631e+03
  3.01046527e+03  3.01046527e+03  3.01046527e+03  6.62548769e+03
  6.62548769e+03  6.62548769e+03  9.23278712e+03  2.55790096e+04
  7.63081582e+04]
E1 = -727.8649810521574  E_coul = 201.119604324354
cycle= 1 E= -526.745376727803  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537538
diis-c [-0.28894677  1.        ]
  HOMO = -0.590522320043633  LUMO = 1.00705320077182
  mo_energy =
[-1.18637614e+02 -1.23418273e+01 -9.59435583e+00 -9.59435583e+00
 -9.59435583e+00 -1.27930022e+00 -5.90522320e-01 -5.90522320e-01
 -5.90522320e-01  1.00705320e+00  1.00705320e+00  1.00705320e+00
  1.03242506e+00  7.23342026e+00  7.23342026e+00  7.23342026e+00
  1.35316386e+01  3.31838164e+01  3.31838164e+01  3.31838164e+01
  1.22617054e+02  1.27998789e+02  1.27998789e+02  1.27998789e+02
  4.79329584e+02  4.79329584e+02  4.79329584e+02  6.65535565e+02
  1.32443478e+03  1.32443478e+03  1.32443478e+03  2.81192253e+03
  3.01004048e+03  3.01004048e+03  3.01004048e+03  6.62495107e+03
  6.62495107e+03  6.62495107e+03  9.23217721e+03  2.55783061e+04
  7.63073649e+04]
E1 = -728.435400570835  E_coul = 201.6893149141745
cycle= 2 E= -526.746085656661  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746365
diis-c [-0.00326327  0.08245905  0.91754095]
  HOMO = -0.581456101172857  LUMO = 1.0137268794528
  mo_energy =
[-1.18570392e+02 -1.23040152e+01 -9.55489710e+00 -9.55489710e+00
 -9.55489710e+00 -1.26845108e+00 -5.81456101e-01 -5.81456101e-01
 -5.81456101e-01  1.01372688e+00  1.01372688e+00  1.01372688e+00
  1.04084122e+00  7.25696770e+00  7.25696770e+00  7.25696770e+00
  1.35626994e+01  3.32235416e+01  3.32235416e+01  3.32235416e+01
  1.22674058e+02  1.28054204e+02  1.28054204e+02  1.28054204e+02
  4.79395935e+02  4.79395935e+02  4.79395935e+02  6.65604898e+02
  1.32450517e+03  1.32450517e+03  1.32450517e+03  2.81199630e+03
  3.01011312e+03  3.01011312e+03  3.01011312e+03  6.62502547e+03
  6.62502547e+03  6.62502547e+03  9.23225242e+03  2.55783819e+04
  7.63074410e+04]
E1 = -728.2859240419169  E_coul = 201.53978018586716
cycle= 3 E= -526.74614385605  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130782
diis-c [-5.35984315e-07 -1.21836696e-03  1.44764729e-01  8.56453638e-01]
  HOMO = -0.582945985596105  LUMO = 1.01265347545122
  mo_energy =
[-1.18580291e+02 -1.23097916e+01 -9.56101558e+00 -9.56101558e+00
 -9.56101558e+00 -1.27013677e+00 -5.82945986e-01 -5.82945986e-01
 -5.82945986e-01  1.01265348e+00  1.01265348e+00  1.01265348e+00
  1.03955225e+00  7.25322167e+00  7.25322167e+00  7.25322167e+00
  1.35579315e+01  3.32174193e+01  3.32174193e+01  3.32174193e+01
  1.22665602e+02  1.28045918e+02  1.28045918e+02  1.28045918e+02
  4.79386159e+02  4.79386159e+02  4.79386159e+02  6.65594676e+02
  1.32449481e+03  1.32449481e+03  1.32449481e+03  2.81198530e+03
  3.01010237e+03  3.01010237e+03  3.01010237e+03  6.62501433e+03
  6.62501433e+03  6.62501433e+03  9.23224108e+03  2.55783704e+04
  7.63074294e+04]
E1 = -728.3086145671386  E_coul = 201.56246880991782
cycle= 4 E= -526.746145757221  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107533
diis-c [-3.84169994e-09  6.71944518e-05 -9.74858385e-03 -6.32494874e-02
  1.07293088e+00]
  HOMO = -0.58292765976658  LUMO = 1.01266907739589
  mo_energy =
[-1.18580251e+02 -1.23097281e+01 -9.56096493e+00 -9.56096493e+00
 -9.56096493e+00 -1.27009705e+00 -5.82927660e-01 -5.82927660e-01
 -5.82927660e-01  1.01266908e+00  1.01266908e+00  1.01266908e+00
  1.03958600e+00  7.25326285e+00  7.25326285e+00  7.25326285e+00
  1.35579902e+01  3.32174679e+01  3.32174679e+01  3.32174679e+01
  1.22665652e+02  1.28045965e+02  1.28045965e+02  1.28045965e+02
  4.79386200e+02  4.79386200e+02  4.79386200e+02  6.65594708e+02
  1.32449484e+03  1.32449484e+03  1.32449484e+03  2.81198532e+03
  3.01010239e+03  3.01010239e+03  3.01010239e+03  6.62501434e+03
  6.62501434e+03  6.62501434e+03  9.23224108e+03  2.55783703e+04
  7.63074294e+04]
E1 = -728.3084071952402  E_coul = 201.5622614365233
cycle= 5 E= -526.746145758717  delta_E= -1.5e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79564e-05
diis-c [-6.63772651e-11  1.40686647e-05 -1.85096706e-03 -1.38157608e-02
  4.27577188e-02  9.72894940e-01]
  HOMO = -0.582934779756626  LUMO = 1.01266436522943
  mo_energy =
[-1.18580281e+02 -1.23097498e+01 -9.56098849e+00 -9.56098849e+00
 -9.56098849e+00 -1.27010274e+00 -5.82934780e-01 -5.82934780e-01
 -5.82934780e-01  1.01266437e+00  1.01266437e+00  1.01266437e+00
  1.03958206e+00  7.25324694e+00  7.25324694e+00  7.25324694e+00
  1.35579722e+01  3.32174451e+01  3.32174451e+01  3.32174451e+01
  1.22665625e+02  1.28045938e+02  1.28045938e+02  1.28045938e+02
  4.79386170e+02  4.79386170e+02  4.79386170e+02  6.65594678e+02
  1.32449481e+03  1.32449481e+03  1.32449481e+03  2.81198528e+03
  3.01010236e+03  3.01010236e+03  3.01010236e+03  6.62501431e+03
  6.62501431e+03  6.62501431e+03  9.23224104e+03  2.55783703e+04
  7.63074293e+04]
E1 = -728.30848613336  E_coul = 201.56234037458992
cycle= 6 E= -526.74614575877  delta_E= -5.32e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.30848613336  E_coul = 201.56234037458992
  HOMO = -0.582934810415538  LUMO = 1.01266439747167
  mo_energy =
[-1.18580281e+02 -1.23097497e+01 -9.56098849e+00 -9.56098849e+00
 -9.56098849e+00 -1.27010240e+00 -5.82934810e-01 -5.82934810e-01
 -5.82934810e-01  1.01266440e+00  1.01266440e+00  1.01266440e+00
  1.03958238e+00  7.25324695e+00  7.25324695e+00  7.25324695e+00
  1.35579724e+01  3.32174451e+01  3.32174451e+01  3.32174451e+01
  1.22665625e+02  1.28045938e+02  1.28045938e+02  1.28045938e+02
  4.79386170e+02  4.79386170e+02  4.79386170e+02  6.65594678e+02
  1.32449481e+03  1.32449481e+03  1.32449481e+03  2.81198528e+03
  3.01010236e+03  3.01010236e+03  3.01010236e+03  6.62501431e+03
  6.62501431e+03  6.62501431e+03  9.23224104e+03  2.55783703e+04
  7.63074293e+04]
E1 = -728.308485440032  E_coul = 201.5623396812611
Extra cycle  E= -526.746145758771  delta_E= -6.82e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828761e+04 7.61703023e+03 3.61756683e+03 1.58706942e+03
 4.18803516e+02 1.22673303e+02 3.94880144e+01 8.50274505e+00
 3.35701753e+00 6.74653422e-01 2.49939671e-01 1.36285900e+03
 6.64050519e+02 2.97702053e+02 3.11236067e+02 6.12076331e+01
 7.29959760e+00 2.01182416e+01 7.74578219e-01 2.80383550e+00
 2.22504893e-01]
E = -526.7461457587708
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8760949        1
[INPUT] 0    0    [1    /1   ]  7617.03022832        1
[INPUT] 0    0    [1    /1   ]  3617.56682586        1
[INPUT] 0    0    [1    /1   ]  1587.06942034        1
[INPUT] 0    0    [1    /1   ]  418.80351572         1
[INPUT] 0    0    [1    /1   ]  122.6733031          1
[INPUT] 0    0    [1    /1   ]  39.4880144081        1
[INPUT] 0    0    [1    /1   ]  8.50274505043        1
[INPUT] 0    0    [1    /1   ]  3.35701752829        1
[INPUT] 0    0    [1    /1   ]  0.674653421617       1
[INPUT] 0    0    [1    /1   ]  0.249939671078       1
[INPUT] 1    0    [1    /1   ]  1362.85899829        1
[INPUT] 1    0    [1    /1   ]  664.050519235        1
[INPUT] 1    0    [1    /1   ]  297.702052518        1
[INPUT] 1    0    [1    /1   ]  311.236067378        1
[INPUT] 1    0    [1    /1   ]  61.2076330771        1
[INPUT] 1    0    [1    /1   ]  7.29959760038        1
[INPUT] 1    0    [1    /1   ]  20.118241598         1
[INPUT] 1    0    [1    /1   ]  0.774578219122       1
[INPUT] 1    0    [1    /1   ]  2.80383549872        1
[INPUT] 1    0    [1    /1   ]  0.222504892988       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.876094854757, 1.0]], [0, [7617.030228321287, 1.0]], [0, [3617.5668258645233, 1.0]], [0, [1587.0694203361504, 1.0]], [0, [418.8035157199019, 1.0]], [0, [122.67330309970936, 1.0]], [0, [39.48801440808153, 1.0]], [0, [8.502745050426919, 1.0]], [0, [3.3570175282918595, 1.0]], [0, [0.6746534216170945, 1.0]], [0, [0.24993967107803405, 1.0]], [1, [1362.8589982896633, 1.0]], [1, [664.0505192350041, 1.0]], [1, [297.7020525181326, 1.0]], [1, [311.2360673776285, 1.0]], [1, [61.20763307707343, 1.0]], [1, [7.299597600378466, 1.0]], [1, [20.11824159797424, 1.0]], [1, [0.7745782191216868, 1.0]], [1, [2.8038354987209804, 1.0]], [1, [0.22250489298760856, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87609485]
bas 1, expnt(s) = [7617.03022832]
bas 2, expnt(s) = [3617.56682586]
bas 3, expnt(s) = [1587.06942034]
bas 4, expnt(s) = [418.80351572]
bas 5, expnt(s) = [122.6733031]
bas 6, expnt(s) = [39.48801441]
bas 7, expnt(s) = [8.50274505]
bas 8, expnt(s) = [3.35701753]
bas 9, expnt(s) = [0.67465342]
bas 10, expnt(s) = [0.24993967]
bas 11, expnt(s) = [1362.85899829]
bas 12, expnt(s) = [664.05051924]
bas 13, expnt(s) = [297.70205252]
bas 14, expnt(s) = [311.23606738]
bas 15, expnt(s) = [61.20763308]
bas 16, expnt(s) = [7.2995976]
bas 17, expnt(s) = [20.1182416]
bas 18, expnt(s) = [0.77457822]
bas 19, expnt(s) = [2.8038355]
bas 20, expnt(s) = [0.22250489]
CPU time:       590.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828761e+04 5.20029567e+03 7.61703023e+03 2.05993864e+03
 3.61756683e+03 1.17849419e+03 1.58706942e+03 6.35275296e+02
 4.18803516e+02 2.33895983e+02 1.22673303e+02 9.31274194e+01
 3.94880144e+01 3.97982519e+01 8.50274505e+00 1.25801087e+01
 3.35701753e+00 6.26585342e+00 6.74653422e-01 1.88072618e+00
 2.49939671e-01 8.93082172e-01 1.36285900e+03 2.41572809e+04
 6.64050519e+02 9.83412656e+03 2.97702053e+02 3.60754435e+03
 3.11236067e+02 3.81370232e+03 6.12076331e+01 4.99449260e+02
 7.29959760e+00 3.50032236e+01 2.01182416e+01 1.24300226e+02
 7.74578219e-01 2.11990302e+00 2.80383550e+00 1.05846147e+01
 2.22504893e-01 4.45819284e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993504618594727
cond(S) = 93419.84934318207
E1 = -729.5315155823752  E_coul = 203.17981570023616
init E= -526.351699882139
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555796831012883  LUMO = 1.03118573040835
  mo_energy =
[-1.18331956e+02 -1.22047262e+01 -9.44671082e+00 -9.44671082e+00
 -9.44671082e+00 -1.23994126e+00 -5.55796831e-01 -5.55796831e-01
 -5.55796831e-01  1.03118573e+00  1.03118573e+00  1.03118573e+00
  1.06191228e+00  7.32356836e+00  7.32356836e+00  7.32356836e+00
  1.36453071e+01  3.33365762e+01  3.33365762e+01  3.33365762e+01
  1.22845512e+02  1.28225128e+02  1.28225128e+02  1.28225128e+02
  4.79633299e+02  4.79633299e+02  4.79633299e+02  6.65886640e+02
  1.32479410e+03  1.32479410e+03  1.32479410e+03  2.81241631e+03
  3.01046527e+03  3.01046527e+03  3.01046527e+03  6.62548769e+03
  6.62548769e+03  6.62548769e+03  9.23278712e+03  2.55790096e+04
  7.63081582e+04]
E1 = -727.8649810521574  E_coul = 201.119604324354
cycle= 1 E= -526.745376727803  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537538
diis-c [-0.28894677  1.        ]
  HOMO = -0.590522320043633  LUMO = 1.00705320077182
  mo_energy =
[-1.18637614e+02 -1.23418273e+01 -9.59435583e+00 -9.59435583e+00
 -9.59435583e+00 -1.27930022e+00 -5.90522320e-01 -5.90522320e-01
 -5.90522320e-01  1.00705320e+00  1.00705320e+00  1.00705320e+00
  1.03242506e+00  7.23342026e+00  7.23342026e+00  7.23342026e+00
  1.35316386e+01  3.31838164e+01  3.31838164e+01  3.31838164e+01
  1.22617054e+02  1.27998789e+02  1.27998789e+02  1.27998789e+02
  4.79329584e+02  4.79329584e+02  4.79329584e+02  6.65535565e+02
  1.32443478e+03  1.32443478e+03  1.32443478e+03  2.81192253e+03
  3.01004048e+03  3.01004048e+03  3.01004048e+03  6.62495107e+03
  6.62495107e+03  6.62495107e+03  9.23217721e+03  2.55783061e+04
  7.63073649e+04]
E1 = -728.435400570835  E_coul = 201.6893149141745
cycle= 2 E= -526.746085656661  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746365
diis-c [-0.00326327  0.08245905  0.91754095]
  HOMO = -0.581456101172857  LUMO = 1.0137268794528
  mo_energy =
[-1.18570392e+02 -1.23040152e+01 -9.55489710e+00 -9.55489710e+00
 -9.55489710e+00 -1.26845108e+00 -5.81456101e-01 -5.81456101e-01
 -5.81456101e-01  1.01372688e+00  1.01372688e+00  1.01372688e+00
  1.04084122e+00  7.25696770e+00  7.25696770e+00  7.25696770e+00
  1.35626994e+01  3.32235416e+01  3.32235416e+01  3.32235416e+01
  1.22674058e+02  1.28054204e+02  1.28054204e+02  1.28054204e+02
  4.79395935e+02  4.79395935e+02  4.79395935e+02  6.65604898e+02
  1.32450517e+03  1.32450517e+03  1.32450517e+03  2.81199630e+03
  3.01011312e+03  3.01011312e+03  3.01011312e+03  6.62502547e+03
  6.62502547e+03  6.62502547e+03  9.23225242e+03  2.55783819e+04
  7.63074410e+04]
E1 = -728.2859240419169  E_coul = 201.53978018586716
cycle= 3 E= -526.74614385605  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130782
diis-c [-5.35984315e-07 -1.21836696e-03  1.44764729e-01  8.56453638e-01]
  HOMO = -0.582945985596105  LUMO = 1.01265347545122
  mo_energy =
[-1.18580291e+02 -1.23097916e+01 -9.56101558e+00 -9.56101558e+00
 -9.56101558e+00 -1.27013677e+00 -5.82945986e-01 -5.82945986e-01
 -5.82945986e-01  1.01265348e+00  1.01265348e+00  1.01265348e+00
  1.03955225e+00  7.25322167e+00  7.25322167e+00  7.25322167e+00
  1.35579315e+01  3.32174193e+01  3.32174193e+01  3.32174193e+01
  1.22665602e+02  1.28045918e+02  1.28045918e+02  1.28045918e+02
  4.79386159e+02  4.79386159e+02  4.79386159e+02  6.65594676e+02
  1.32449481e+03  1.32449481e+03  1.32449481e+03  2.81198530e+03
  3.01010237e+03  3.01010237e+03  3.01010237e+03  6.62501433e+03
  6.62501433e+03  6.62501433e+03  9.23224108e+03  2.55783704e+04
  7.63074294e+04]
E1 = -728.3086145671386  E_coul = 201.56246880991782
cycle= 4 E= -526.746145757221  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107533
diis-c [-3.84169994e-09  6.71944518e-05 -9.74858385e-03 -6.32494874e-02
  1.07293088e+00]
  HOMO = -0.58292765976658  LUMO = 1.01266907739589
  mo_energy =
[-1.18580251e+02 -1.23097281e+01 -9.56096493e+00 -9.56096493e+00
 -9.56096493e+00 -1.27009705e+00 -5.82927660e-01 -5.82927660e-01
 -5.82927660e-01  1.01266908e+00  1.01266908e+00  1.01266908e+00
  1.03958600e+00  7.25326285e+00  7.25326285e+00  7.25326285e+00
  1.35579902e+01  3.32174679e+01  3.32174679e+01  3.32174679e+01
  1.22665652e+02  1.28045965e+02  1.28045965e+02  1.28045965e+02
  4.79386200e+02  4.79386200e+02  4.79386200e+02  6.65594708e+02
  1.32449484e+03  1.32449484e+03  1.32449484e+03  2.81198532e+03
  3.01010239e+03  3.01010239e+03  3.01010239e+03  6.62501434e+03
  6.62501434e+03  6.62501434e+03  9.23224108e+03  2.55783703e+04
  7.63074294e+04]
E1 = -728.3084071952402  E_coul = 201.5622614365233
cycle= 5 E= -526.746145758717  delta_E= -1.5e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79564e-05
diis-c [-6.63772651e-11  1.40686647e-05 -1.85096706e-03 -1.38157608e-02
  4.27577188e-02  9.72894940e-01]
  HOMO = -0.582934779756626  LUMO = 1.01266436522943
  mo_energy =
[-1.18580281e+02 -1.23097498e+01 -9.56098849e+00 -9.56098849e+00
 -9.56098849e+00 -1.27010274e+00 -5.82934780e-01 -5.82934780e-01
 -5.82934780e-01  1.01266437e+00  1.01266437e+00  1.01266437e+00
  1.03958206e+00  7.25324694e+00  7.25324694e+00  7.25324694e+00
  1.35579722e+01  3.32174451e+01  3.32174451e+01  3.32174451e+01
  1.22665625e+02  1.28045938e+02  1.28045938e+02  1.28045938e+02
  4.79386170e+02  4.79386170e+02  4.79386170e+02  6.65594678e+02
  1.32449481e+03  1.32449481e+03  1.32449481e+03  2.81198528e+03
  3.01010236e+03  3.01010236e+03  3.01010236e+03  6.62501431e+03
  6.62501431e+03  6.62501431e+03  9.23224104e+03  2.55783703e+04
  7.63074293e+04]
E1 = -728.30848613336  E_coul = 201.56234037458992
cycle= 6 E= -526.74614575877  delta_E= -5.32e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.30848613336  E_coul = 201.56234037458992
  HOMO = -0.582934810415538  LUMO = 1.01266439747167
  mo_energy =
[-1.18580281e+02 -1.23097497e+01 -9.56098849e+00 -9.56098849e+00
 -9.56098849e+00 -1.27010240e+00 -5.82934810e-01 -5.82934810e-01
 -5.82934810e-01  1.01266440e+00  1.01266440e+00  1.01266440e+00
  1.03958238e+00  7.25324695e+00  7.25324695e+00  7.25324695e+00
  1.35579724e+01  3.32174451e+01  3.32174451e+01  3.32174451e+01
  1.22665625e+02  1.28045938e+02  1.28045938e+02  1.28045938e+02
  4.79386170e+02  4.79386170e+02  4.79386170e+02  6.65594678e+02
  1.32449481e+03  1.32449481e+03  1.32449481e+03  2.81198528e+03
  3.01010236e+03  3.01010236e+03  3.01010236e+03  6.62501431e+03
  6.62501431e+03  6.62501431e+03  9.23224104e+03  2.55783703e+04
  7.63074293e+04]
E1 = -728.308485440032  E_coul = 201.5623396812611
Extra cycle  E= -526.746145758771  delta_E= -6.82e-13  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93419.84934318207
E1 = -728.308485440032  E_coul = 201.5623396812611
init E= -526.746145758771
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582934834200137  LUMO = 1.01266439187873
  mo_energy =
[-1.18580281e+02 -1.23097498e+01 -9.56098856e+00 -9.56098856e+00
 -9.56098856e+00 -1.27010235e+00 -5.82934834e-01 -5.82934834e-01
 -5.82934834e-01  1.01266439e+00  1.01266439e+00  1.01266439e+00
  1.03958243e+00  7.25324691e+00  7.25324691e+00  7.25324691e+00
  1.35579724e+01  3.32174451e+01  3.32174451e+01  3.32174451e+01
  1.22665625e+02  1.28045938e+02  1.28045938e+02  1.28045938e+02
  4.79386170e+02  4.79386170e+02  4.79386170e+02  6.65594678e+02
  1.32449481e+03  1.32449481e+03  1.32449481e+03  2.81198528e+03
  3.01010236e+03  3.01010236e+03  3.01010236e+03  6.62501431e+03
  6.62501431e+03  6.62501431e+03  9.23224104e+03  2.55783703e+04
  7.63074293e+04]
E1 = -728.3084855388386  E_coul = 201.56233978006748
cycle= 1 E= -526.746145758771  delta_E= -2.27e-13  |g|= 7.1e-08  |ddm|= 5.7e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3084855388386  E_coul = 201.56233978006748
  HOMO = -0.582934834555308  LUMO = 1.01266439396293
  mo_energy =
[-1.18580281e+02 -1.23097497e+01 -9.56098855e+00 -9.56098855e+00
 -9.56098855e+00 -1.27010234e+00 -5.82934835e-01 -5.82934835e-01
 -5.82934835e-01  1.01266439e+00  1.01266439e+00  1.01266439e+00
  1.03958245e+00  7.25324692e+00  7.25324692e+00  7.25324692e+00
  1.35579724e+01  3.32174451e+01  3.32174451e+01  3.32174451e+01
  1.22665625e+02  1.28045938e+02  1.28045938e+02  1.28045938e+02
  4.79386170e+02  4.79386170e+02  4.79386170e+02  6.65594678e+02
  1.32449481e+03  1.32449481e+03  1.32449481e+03  2.81198528e+03
  3.01010236e+03  3.01010236e+03  3.01010236e+03  6.62501431e+03
  6.62501431e+03  6.62501431e+03  9.23224104e+03  2.55783703e+04
  7.63074293e+04]
E1 = -728.3084854912456  E_coul = 201.56233973247427
Extra cycle  E= -526.746145758771  delta_E= -3.41e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828761e+04 7.61703023e+03 3.61756683e+03 1.58706942e+03
 4.18803516e+02 1.22673303e+02 3.94880144e+01 8.50274505e+00
 3.35701753e+00 6.74653422e-01 2.49939671e-01 1.36285900e+03
 6.64050519e+02 2.97702053e+02 3.11236067e+02 6.12076331e+01
 7.29959760e+00 2.01182416e+01 7.74578219e-01 2.80383550e+00
 2.22504893e-01]
grad_E = [-1.39453226e-06  2.13600963e-06 -2.14342327e-06  3.63448310e-05
  1.25915442e-05  2.74746425e-06  2.45508856e-06 -7.33483401e-06
  2.65459599e-05  4.49727046e-05 -3.14081946e-05 -5.15323095e-07
  5.08389592e-06  2.42510719e-05  2.07514251e-05 -2.34721429e-05
 -4.46321758e-06 -1.19313848e-05  1.22113653e-04  5.28907146e-05
 -3.05868903e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.875571         1
[INPUT] 0    0    [1    /1   ]  7617.03125978        1
[INPUT] 0    0    [1    /1   ]  3617.56620064        1
[INPUT] 0    0    [1    /1   ]  1587.09050343        1
[INPUT] 0    0    [1    /1   ]  418.750452544        1
[INPUT] 0    0    [1    /1   ]  122.659437656        1
[INPUT] 0    0    [1    /1   ]  39.4856742254        1
[INPUT] 0    0    [1    /1   ]  8.50230975429        1
[INPUT] 0    0    [1    /1   ]  3.35709091946        1
[INPUT] 0    0    [1    /1   ]  0.674934490909       1
[INPUT] 0    0    [1    /1   ]  0.250025700456       1
[INPUT] 1    0    [1    /1   ]  1362.8587882         1
[INPUT] 1    0    [1    /1   ]  664.051917423        1
[INPUT] 1    0    [1    /1   ]  297.708361613        1
[INPUT] 1    0    [1    /1   ]  311.241477736        1
[INPUT] 1    0    [1    /1   ]  61.2374262046        1
[INPUT] 1    0    [1    /1   ]  7.30464288043        1
[INPUT] 1    0    [1    /1   ]  20.1299361205        1
[INPUT] 1    0    [1    /1   ]  0.774844845125       1
[INPUT] 1    0    [1    /1   ]  2.80602262112        1
[INPUT] 1    0    [1    /1   ]  0.222555037279       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.87557096138, 1.0]], [0, [7617.0312597759075, 1.0]], [0, [3617.566200635341, 1.0]], [0, [1587.0905034267353, 1.0]], [0, [418.75045254447065, 1.0]], [0, [122.65943765603777, 1.0]], [0, [39.48567422541173, 1.0]], [0, [8.502309754294673, 1.0]], [0, [3.3570909194625105, 1.0]], [0, [0.6749344909093445, 1.0]], [0, [0.2500257004562652, 1.0]], [1, [1362.8587882043112, 1.0]], [1, [664.0519174232857, 1.0]], [1, [297.7083616130306, 1.0]], [1, [311.24147773644404, 1.0]], [1, [61.23742620462306, 1.0]], [1, [7.304642880430012, 1.0]], [1, [20.129936120462354, 1.0]], [1, [0.774844845125019, 1.0]], [1, [2.806022621122321, 1.0]], [1, [0.2225550372787022, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87557096]
bas 1, expnt(s) = [7617.03125978]
bas 2, expnt(s) = [3617.56620064]
bas 3, expnt(s) = [1587.09050343]
bas 4, expnt(s) = [418.75045254]
bas 5, expnt(s) = [122.65943766]
bas 6, expnt(s) = [39.48567423]
bas 7, expnt(s) = [8.50230975]
bas 8, expnt(s) = [3.35709092]
bas 9, expnt(s) = [0.67493449]
bas 10, expnt(s) = [0.2500257]
bas 11, expnt(s) = [1362.8587882]
bas 12, expnt(s) = [664.05191742]
bas 13, expnt(s) = [297.70836161]
bas 14, expnt(s) = [311.24147774]
bas 15, expnt(s) = [61.2374262]
bas 16, expnt(s) = [7.30464288]
bas 17, expnt(s) = [20.12993612]
bas 18, expnt(s) = [0.77484485]
bas 19, expnt(s) = [2.80602262]
bas 20, expnt(s) = [0.22255504]
CPU time:       596.44
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828756e+04 5.20029560e+03 7.61703126e+03 2.05993885e+03
 3.61756620e+03 1.17849404e+03 1.58709050e+03 6.35281625e+02
 4.18750453e+02 2.33873756e+02 1.22659438e+02 9.31195248e+01
 3.94856742e+01 3.97964830e+01 8.50230975e+00 1.25796256e+01
 3.35709092e+00 6.26595616e+00 6.74934491e-01 1.88131380e+00
 2.50025700e-01 8.93312711e-01 1.36285879e+03 2.41572763e+04
 6.64051917e+02 9.83415245e+03 2.97708362e+02 3.60763992e+03
 3.11241478e+02 3.81378519e+03 6.12374262e+01 4.99753166e+02
 7.30464288e+00 3.50334678e+01 2.01299361e+01 1.24390550e+02
 7.74844845e-01 2.12081520e+00 2.80602262e+00 1.05949364e+01
 2.22555037e-01 4.45944876e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993494892362634
cond(S) = 93486.97276168101
E1 = -729.5315316900619  E_coul = 203.1798309986103
init E= -526.351700691452
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555794607303329  LUMO = 1.03161942608829
  mo_energy =
[-1.18331954e+02 -1.22047258e+01 -9.44671151e+00 -9.44671151e+00
 -9.44671151e+00 -1.23993990e+00 -5.55794607e-01 -5.55794607e-01
 -5.55794607e-01  1.03161943e+00  1.03161943e+00  1.03161943e+00
  1.06258553e+00  7.32990032e+00  7.32990032e+00  7.32990032e+00
  1.36467015e+01  3.33649527e+01  3.33649527e+01  3.33649527e+01
  1.22834907e+02  1.28310847e+02  1.28310847e+02  1.28310847e+02
  4.79781986e+02  4.79781986e+02  4.79781986e+02  6.65807367e+02
  1.32496777e+03  1.32496777e+03  1.32496777e+03  2.81223460e+03
  3.01065415e+03  3.01065415e+03  3.01065415e+03  6.62567754e+03
  6.62567754e+03  6.62567754e+03  9.23258824e+03  2.55788277e+04
  7.63079947e+04]
E1 = -727.8652308386961  E_coul = 201.11985362936773
cycle= 1 E= -526.745377209328  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537549
diis-c [-0.28895944  1.        ]
  HOMO = -0.590514668790889  LUMO = 1.00747946626349
  mo_energy =
[-1.18637586e+02 -1.23418104e+01 -9.59433931e+00 -9.59433931e+00
 -9.59433931e+00 -1.27929315e+00 -5.90514669e-01 -5.90514669e-01
 -5.90514669e-01  1.00747947e+00  1.00747947e+00  1.00747947e+00
  1.03308964e+00  7.23971816e+00  7.23971816e+00  7.23971816e+00
  1.35330476e+01  3.32121710e+01  3.32121710e+01  3.32121710e+01
  1.22606481e+02  1.28084503e+02  1.28084503e+02  1.28084503e+02
  4.79478297e+02  4.79478297e+02  4.79478297e+02  6.65456331e+02
  1.32460848e+03  1.32460848e+03  1.32460848e+03  2.81174084e+03
  3.01022938e+03  3.01022938e+03  3.01022938e+03  6.62514095e+03
  6.62514095e+03  6.62514095e+03  9.23197836e+03  2.55781242e+04
  7.63072014e+04]
E1 = -728.4355627008407  E_coul = 201.68947671591584
cycle= 2 E= -526.746085984925  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746324
diis-c [-0.00326297  0.08245204  0.91754796]
  HOMO = -0.581450246812569  LUMO = 1.01415512352771
  mo_energy =
[-1.18570372e+02 -1.23040038e+01 -9.55488619e+00 -9.55488619e+00
 -9.55488619e+00 -1.26844612e+00 -5.81450247e-01 -5.81450247e-01
 -5.81450247e-01  1.01415512e+00  1.01415512e+00  1.01415512e+00
  1.04150792e+00  7.26327342e+00  7.26327342e+00  7.26327342e+00
  1.35641031e+01  3.32519002e+01  3.32519002e+01  3.32519002e+01
  1.22663477e+02  1.28139917e+02  1.28139917e+02  1.28139917e+02
  4.79544640e+02  4.79544640e+02  4.79544640e+02  6.65525655e+02
  1.32467887e+03  1.32467887e+03  1.32467887e+03  2.81181461e+03
  3.01030201e+03  3.01030201e+03  3.01030201e+03  6.62521534e+03
  6.62521534e+03  6.62521534e+03  9.23205355e+03  2.55782000e+04
  7.63072775e+04]
E1 = -728.2861140669911  E_coul = 201.5399699004145
cycle= 3 E= -526.746144166577  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130773
diis-c [-5.35838114e-07 -1.21833933e-03  1.44763376e-01  8.56454964e-01]
  HOMO = -0.58293982262534  LUMO = 1.01308140952313
  mo_energy =
[-1.18580270e+02 -1.23097794e+01 -9.56100375e+00 -9.56100375e+00
 -9.56100375e+00 -1.27013148e+00 -5.82939823e-01 -5.82939823e-01
 -5.82939823e-01  1.01308141e+00  1.01308141e+00  1.01308141e+00
  1.04021863e+00  7.25952624e+00  7.25952624e+00  7.25952624e+00
  1.35593360e+01  3.32457774e+01  3.32457774e+01  3.32457774e+01
  1.22655022e+02  1.28131631e+02  1.28131631e+02  1.28131631e+02
  4.79534866e+02  4.79534866e+02  4.79534866e+02  6.65515435e+02
  1.32466850e+03  1.32466850e+03  1.32466850e+03  2.81180361e+03
  3.01029126e+03  3.01029126e+03  3.01029126e+03  6.62520420e+03
  6.62520420e+03  6.62520420e+03  9.23204221e+03  2.55781885e+04
  7.63072659e+04]
E1 = -728.3088002565443  E_coul = 201.56265418940882
cycle= 4 E= -526.746146067135  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107509
diis-c [-3.83916832e-09  6.71926957e-05 -9.74862553e-03 -6.32495410e-02
  1.07293097e+00]
  HOMO = -0.582921497612158  LUMO = 1.01309701608513
  mo_energy =
[-1.18580230e+02 -1.23097158e+01 -9.56095310e+00 -9.56095310e+00
 -9.56095310e+00 -1.27009177e+00 -5.82921498e-01 -5.82921498e-01
 -5.82921498e-01  1.01309702e+00  1.01309702e+00  1.01309702e+00
  1.04025239e+00  7.25956742e+00  7.25956742e+00  7.25956742e+00
  1.35593947e+01  3.32458261e+01  3.32458261e+01  3.32458261e+01
  1.22655072e+02  1.28131678e+02  1.28131678e+02  1.28131678e+02
  4.79534906e+02  4.79534906e+02  4.79534906e+02  6.65515467e+02
  1.32466853e+03  1.32466853e+03  1.32466853e+03  2.81180362e+03
  3.01029129e+03  3.01029129e+03  3.01029129e+03  6.62520421e+03
  6.62520421e+03  6.62520421e+03  9.23204221e+03  2.55781884e+04
  7.63072659e+04]
E1 = -728.308592922478  E_coul = 201.56244685384752
cycle= 5 E= -526.746146068631  delta_E= -1.5e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.7949e-05
diis-c [-6.63307453e-11  1.40630470e-05 -1.85030886e-03 -1.38117230e-02
  4.27708791e-02  9.72877090e-01]
  HOMO = -0.582928615531219  LUMO = 1.01309230279912
  mo_energy =
[-1.18580260e+02 -1.23097375e+01 -9.56097665e+00 -9.56097665e+00
 -9.56097665e+00 -1.27009745e+00 -5.82928616e-01 -5.82928616e-01
 -5.82928616e-01  1.01309230e+00  1.01309230e+00  1.01309230e+00
  1.04024845e+00  7.25955151e+00  7.25955151e+00  7.25955151e+00
  1.35593767e+01  3.32458033e+01  3.32458033e+01  3.32458033e+01
  1.22655045e+02  1.28131651e+02  1.28131651e+02  1.28131651e+02
  4.79534877e+02  4.79534877e+02  4.79534877e+02  6.65515437e+02
  1.32466850e+03  1.32466850e+03  1.32466850e+03  2.81180359e+03
  3.01029125e+03  3.01029125e+03  3.01029125e+03  6.62520418e+03
  6.62520418e+03  6.62520418e+03  9.23204218e+03  2.55781884e+04
  7.63072658e+04]
E1 = -728.3086718428332  E_coul = 201.5625257741486
cycle= 6 E= -526.746146068685  delta_E= -5.4e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3086718428332  E_coul = 201.5625257741486
  HOMO = -0.582928646126146  LUMO = 1.013092335057
  mo_energy =
[-1.18580260e+02 -1.23097375e+01 -9.56097666e+00 -9.56097666e+00
 -9.56097666e+00 -1.27009712e+00 -5.82928646e-01 -5.82928646e-01
 -5.82928646e-01  1.01309234e+00  1.01309234e+00  1.01309234e+00
  1.04024877e+00  7.25955152e+00  7.25955152e+00  7.25955152e+00
  1.35593768e+01  3.32458033e+01  3.32458033e+01  3.32458033e+01
  1.22655045e+02  1.28131651e+02  1.28131651e+02  1.28131651e+02
  4.79534877e+02  4.79534877e+02  4.79534877e+02  6.65515437e+02
  1.32466850e+03  1.32466850e+03  1.32466850e+03  2.81180359e+03
  3.01029125e+03  3.01029125e+03  3.01029125e+03  6.62520418e+03
  6.62520418e+03  6.62520418e+03  9.23204218e+03  2.55781884e+04
  7.63072658e+04]
E1 = -728.308671149688  E_coul = 201.5625250810035
Extra cycle  E= -526.746146068685  delta_E=    0  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828756e+04 7.61703126e+03 3.61756620e+03 1.58709050e+03
 4.18750453e+02 1.22659438e+02 3.94856742e+01 8.50230975e+00
 3.35709092e+00 6.74934491e-01 2.50025700e-01 1.36285879e+03
 6.64051917e+02 2.97708362e+02 3.11241478e+02 6.12374262e+01
 7.30464288e+00 2.01299361e+01 7.74844845e-01 2.80602262e+00
 2.22555037e-01]
E = -526.7461460686845
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.875571         1
[INPUT] 0    0    [1    /1   ]  7617.03125978        1
[INPUT] 0    0    [1    /1   ]  3617.56620064        1
[INPUT] 0    0    [1    /1   ]  1587.09050343        1
[INPUT] 0    0    [1    /1   ]  418.750452544        1
[INPUT] 0    0    [1    /1   ]  122.659437656        1
[INPUT] 0    0    [1    /1   ]  39.4856742254        1
[INPUT] 0    0    [1    /1   ]  8.50230975429        1
[INPUT] 0    0    [1    /1   ]  3.35709091946        1
[INPUT] 0    0    [1    /1   ]  0.674934490909       1
[INPUT] 0    0    [1    /1   ]  0.250025700456       1
[INPUT] 1    0    [1    /1   ]  1362.8587882         1
[INPUT] 1    0    [1    /1   ]  664.051917423        1
[INPUT] 1    0    [1    /1   ]  297.708361613        1
[INPUT] 1    0    [1    /1   ]  311.241477736        1
[INPUT] 1    0    [1    /1   ]  61.2374262046        1
[INPUT] 1    0    [1    /1   ]  7.30464288043        1
[INPUT] 1    0    [1    /1   ]  20.1299361205        1
[INPUT] 1    0    [1    /1   ]  0.774844845125       1
[INPUT] 1    0    [1    /1   ]  2.80602262112        1
[INPUT] 1    0    [1    /1   ]  0.222555037279       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.87557096138, 1.0]], [0, [7617.0312597759075, 1.0]], [0, [3617.566200635341, 1.0]], [0, [1587.0905034267353, 1.0]], [0, [418.75045254447065, 1.0]], [0, [122.65943765603777, 1.0]], [0, [39.48567422541173, 1.0]], [0, [8.502309754294673, 1.0]], [0, [3.3570909194625105, 1.0]], [0, [0.6749344909093445, 1.0]], [0, [0.2500257004562652, 1.0]], [1, [1362.8587882043112, 1.0]], [1, [664.0519174232857, 1.0]], [1, [297.7083616130306, 1.0]], [1, [311.24147773644404, 1.0]], [1, [61.23742620462306, 1.0]], [1, [7.304642880430012, 1.0]], [1, [20.129936120462354, 1.0]], [1, [0.774844845125019, 1.0]], [1, [2.806022621122321, 1.0]], [1, [0.2225550372787022, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87557096]
bas 1, expnt(s) = [7617.03125978]
bas 2, expnt(s) = [3617.56620064]
bas 3, expnt(s) = [1587.09050343]
bas 4, expnt(s) = [418.75045254]
bas 5, expnt(s) = [122.65943766]
bas 6, expnt(s) = [39.48567423]
bas 7, expnt(s) = [8.50230975]
bas 8, expnt(s) = [3.35709092]
bas 9, expnt(s) = [0.67493449]
bas 10, expnt(s) = [0.2500257]
bas 11, expnt(s) = [1362.8587882]
bas 12, expnt(s) = [664.05191742]
bas 13, expnt(s) = [297.70836161]
bas 14, expnt(s) = [311.24147774]
bas 15, expnt(s) = [61.2374262]
bas 16, expnt(s) = [7.30464288]
bas 17, expnt(s) = [20.12993612]
bas 18, expnt(s) = [0.77484485]
bas 19, expnt(s) = [2.80602262]
bas 20, expnt(s) = [0.22255504]
CPU time:       597.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828756e+04 5.20029560e+03 7.61703126e+03 2.05993885e+03
 3.61756620e+03 1.17849404e+03 1.58709050e+03 6.35281625e+02
 4.18750453e+02 2.33873756e+02 1.22659438e+02 9.31195248e+01
 3.94856742e+01 3.97964830e+01 8.50230975e+00 1.25796256e+01
 3.35709092e+00 6.26595616e+00 6.74934491e-01 1.88131380e+00
 2.50025700e-01 8.93312711e-01 1.36285879e+03 2.41572763e+04
 6.64051917e+02 9.83415245e+03 2.97708362e+02 3.60763992e+03
 3.11241478e+02 3.81378519e+03 6.12374262e+01 4.99753166e+02
 7.30464288e+00 3.50334678e+01 2.01299361e+01 1.24390550e+02
 7.74844845e-01 2.12081520e+00 2.80602262e+00 1.05949364e+01
 2.22555037e-01 4.45944876e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993494892362634
cond(S) = 93486.97276168101
E1 = -729.5315316900619  E_coul = 203.1798309986103
init E= -526.351700691452
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555794607303329  LUMO = 1.03161942608829
  mo_energy =
[-1.18331954e+02 -1.22047258e+01 -9.44671151e+00 -9.44671151e+00
 -9.44671151e+00 -1.23993990e+00 -5.55794607e-01 -5.55794607e-01
 -5.55794607e-01  1.03161943e+00  1.03161943e+00  1.03161943e+00
  1.06258553e+00  7.32990032e+00  7.32990032e+00  7.32990032e+00
  1.36467015e+01  3.33649527e+01  3.33649527e+01  3.33649527e+01
  1.22834907e+02  1.28310847e+02  1.28310847e+02  1.28310847e+02
  4.79781986e+02  4.79781986e+02  4.79781986e+02  6.65807367e+02
  1.32496777e+03  1.32496777e+03  1.32496777e+03  2.81223460e+03
  3.01065415e+03  3.01065415e+03  3.01065415e+03  6.62567754e+03
  6.62567754e+03  6.62567754e+03  9.23258824e+03  2.55788277e+04
  7.63079947e+04]
E1 = -727.8652308386961  E_coul = 201.11985362936773
cycle= 1 E= -526.745377209328  delta_E= -0.394  |g|= 0.185  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537549
diis-c [-0.28895944  1.        ]
  HOMO = -0.590514668790889  LUMO = 1.00747946626349
  mo_energy =
[-1.18637586e+02 -1.23418104e+01 -9.59433931e+00 -9.59433931e+00
 -9.59433931e+00 -1.27929315e+00 -5.90514669e-01 -5.90514669e-01
 -5.90514669e-01  1.00747947e+00  1.00747947e+00  1.00747947e+00
  1.03308964e+00  7.23971816e+00  7.23971816e+00  7.23971816e+00
  1.35330476e+01  3.32121710e+01  3.32121710e+01  3.32121710e+01
  1.22606481e+02  1.28084503e+02  1.28084503e+02  1.28084503e+02
  4.79478297e+02  4.79478297e+02  4.79478297e+02  6.65456331e+02
  1.32460848e+03  1.32460848e+03  1.32460848e+03  2.81174084e+03
  3.01022938e+03  3.01022938e+03  3.01022938e+03  6.62514095e+03
  6.62514095e+03  6.62514095e+03  9.23197836e+03  2.55781242e+04
  7.63072014e+04]
E1 = -728.4355627008407  E_coul = 201.68947671591584
cycle= 2 E= -526.746085984925  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0538
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746324
diis-c [-0.00326297  0.08245204  0.91754796]
  HOMO = -0.581450246812569  LUMO = 1.01415512352771
  mo_energy =
[-1.18570372e+02 -1.23040038e+01 -9.55488619e+00 -9.55488619e+00
 -9.55488619e+00 -1.26844612e+00 -5.81450247e-01 -5.81450247e-01
 -5.81450247e-01  1.01415512e+00  1.01415512e+00  1.01415512e+00
  1.04150792e+00  7.26327342e+00  7.26327342e+00  7.26327342e+00
  1.35641031e+01  3.32519002e+01  3.32519002e+01  3.32519002e+01
  1.22663477e+02  1.28139917e+02  1.28139917e+02  1.28139917e+02
  4.79544640e+02  4.79544640e+02  4.79544640e+02  6.65525655e+02
  1.32467887e+03  1.32467887e+03  1.32467887e+03  2.81181461e+03
  3.01030201e+03  3.01030201e+03  3.01030201e+03  6.62521534e+03
  6.62521534e+03  6.62521534e+03  9.23205355e+03  2.55782000e+04
  7.63072775e+04]
E1 = -728.2861140669911  E_coul = 201.5399699004145
cycle= 3 E= -526.746144166577  delta_E= -5.82e-05  |g|= 0.00625  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130773
diis-c [-5.35838114e-07 -1.21833933e-03  1.44763376e-01  8.56454964e-01]
  HOMO = -0.58293982262534  LUMO = 1.01308140952313
  mo_energy =
[-1.18580270e+02 -1.23097794e+01 -9.56100375e+00 -9.56100375e+00
 -9.56100375e+00 -1.27013148e+00 -5.82939823e-01 -5.82939823e-01
 -5.82939823e-01  1.01308141e+00  1.01308141e+00  1.01308141e+00
  1.04021863e+00  7.25952624e+00  7.25952624e+00  7.25952624e+00
  1.35593360e+01  3.32457774e+01  3.32457774e+01  3.32457774e+01
  1.22655022e+02  1.28131631e+02  1.28131631e+02  1.28131631e+02
  4.79534866e+02  4.79534866e+02  4.79534866e+02  6.65515435e+02
  1.32466850e+03  1.32466850e+03  1.32466850e+03  2.81180361e+03
  3.01029126e+03  3.01029126e+03  3.01029126e+03  6.62520420e+03
  6.62520420e+03  6.62520420e+03  9.23204221e+03  2.55781885e+04
  7.63072659e+04]
E1 = -728.3088002565443  E_coul = 201.56265418940882
cycle= 4 E= -526.746146067135  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107509
diis-c [-3.83916832e-09  6.71926957e-05 -9.74862553e-03 -6.32495410e-02
  1.07293097e+00]
  HOMO = -0.582921497612158  LUMO = 1.01309701608513
  mo_energy =
[-1.18580230e+02 -1.23097158e+01 -9.56095310e+00 -9.56095310e+00
 -9.56095310e+00 -1.27009177e+00 -5.82921498e-01 -5.82921498e-01
 -5.82921498e-01  1.01309702e+00  1.01309702e+00  1.01309702e+00
  1.04025239e+00  7.25956742e+00  7.25956742e+00  7.25956742e+00
  1.35593947e+01  3.32458261e+01  3.32458261e+01  3.32458261e+01
  1.22655072e+02  1.28131678e+02  1.28131678e+02  1.28131678e+02
  4.79534906e+02  4.79534906e+02  4.79534906e+02  6.65515467e+02
  1.32466853e+03  1.32466853e+03  1.32466853e+03  2.81180362e+03
  3.01029129e+03  3.01029129e+03  3.01029129e+03  6.62520421e+03
  6.62520421e+03  6.62520421e+03  9.23204221e+03  2.55781884e+04
  7.63072659e+04]
E1 = -728.308592922478  E_coul = 201.56244685384752
cycle= 5 E= -526.746146068631  delta_E= -1.5e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.7949e-05
diis-c [-6.63307453e-11  1.40630470e-05 -1.85030886e-03 -1.38117230e-02
  4.27708791e-02  9.72877090e-01]
  HOMO = -0.582928615531219  LUMO = 1.01309230279912
  mo_energy =
[-1.18580260e+02 -1.23097375e+01 -9.56097665e+00 -9.56097665e+00
 -9.56097665e+00 -1.27009745e+00 -5.82928616e-01 -5.82928616e-01
 -5.82928616e-01  1.01309230e+00  1.01309230e+00  1.01309230e+00
  1.04024845e+00  7.25955151e+00  7.25955151e+00  7.25955151e+00
  1.35593767e+01  3.32458033e+01  3.32458033e+01  3.32458033e+01
  1.22655045e+02  1.28131651e+02  1.28131651e+02  1.28131651e+02
  4.79534877e+02  4.79534877e+02  4.79534877e+02  6.65515437e+02
  1.32466850e+03  1.32466850e+03  1.32466850e+03  2.81180359e+03
  3.01029125e+03  3.01029125e+03  3.01029125e+03  6.62520418e+03
  6.62520418e+03  6.62520418e+03  9.23204218e+03  2.55781884e+04
  7.63072658e+04]
E1 = -728.3086718428332  E_coul = 201.5625257741486
cycle= 6 E= -526.746146068685  delta_E= -5.4e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3086718428332  E_coul = 201.5625257741486
  HOMO = -0.582928646126146  LUMO = 1.013092335057
  mo_energy =
[-1.18580260e+02 -1.23097375e+01 -9.56097666e+00 -9.56097666e+00
 -9.56097666e+00 -1.27009712e+00 -5.82928646e-01 -5.82928646e-01
 -5.82928646e-01  1.01309234e+00  1.01309234e+00  1.01309234e+00
  1.04024877e+00  7.25955152e+00  7.25955152e+00  7.25955152e+00
  1.35593768e+01  3.32458033e+01  3.32458033e+01  3.32458033e+01
  1.22655045e+02  1.28131651e+02  1.28131651e+02  1.28131651e+02
  4.79534877e+02  4.79534877e+02  4.79534877e+02  6.65515437e+02
  1.32466850e+03  1.32466850e+03  1.32466850e+03  2.81180359e+03
  3.01029125e+03  3.01029125e+03  3.01029125e+03  6.62520418e+03
  6.62520418e+03  6.62520418e+03  9.23204218e+03  2.55781884e+04
  7.63072658e+04]
E1 = -728.308671149688  E_coul = 201.5625250810035
Extra cycle  E= -526.746146068685  delta_E=    0  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93486.97276168101
E1 = -728.308671149688  E_coul = 201.5625250810035
init E= -526.746146068685
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582928669898756  LUMO = 1.0130923294591
  mo_energy =
[-1.18580260e+02 -1.23097375e+01 -9.56097672e+00 -9.56097672e+00
 -9.56097672e+00 -1.27009707e+00 -5.82928670e-01 -5.82928670e-01
 -5.82928670e-01  1.01309233e+00  1.01309233e+00  1.01309233e+00
  1.04024882e+00  7.25955148e+00  7.25955148e+00  7.25955148e+00
  1.35593768e+01  3.32458032e+01  3.32458032e+01  3.32458032e+01
  1.22655045e+02  1.28131651e+02  1.28131651e+02  1.28131651e+02
  4.79534877e+02  4.79534877e+02  4.79534877e+02  6.65515437e+02
  1.32466850e+03  1.32466850e+03  1.32466850e+03  2.81180359e+03
  3.01029125e+03  3.01029125e+03  3.01029125e+03  6.62520418e+03
  6.62520418e+03  6.62520418e+03  9.23204218e+03  2.55781884e+04
  7.63072658e+04]
E1 = -728.3086712485111  E_coul = 201.56252517982645
cycle= 1 E= -526.746146068685  delta_E= -1.14e-13  |g|= 7.1e-08  |ddm|= 5.69e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3086712485111  E_coul = 201.56252517982645
  HOMO = -0.582928670250892  LUMO = 1.01309233154412
  mo_energy =
[-1.18580260e+02 -1.23097375e+01 -9.56097672e+00 -9.56097672e+00
 -9.56097672e+00 -1.27009705e+00 -5.82928670e-01 -5.82928670e-01
 -5.82928670e-01  1.01309233e+00  1.01309233e+00  1.01309233e+00
  1.04024883e+00  7.25955148e+00  7.25955148e+00  7.25955148e+00
  1.35593768e+01  3.32458032e+01  3.32458032e+01  3.32458032e+01
  1.22655045e+02  1.28131651e+02  1.28131651e+02  1.28131651e+02
  4.79534877e+02  4.79534877e+02  4.79534877e+02  6.65515437e+02
  1.32466850e+03  1.32466850e+03  1.32466850e+03  2.81180359e+03
  3.01029125e+03  3.01029125e+03  3.01029125e+03  6.62520418e+03
  6.62520418e+03  6.62520418e+03  9.23204218e+03  2.55781884e+04
  7.63072658e+04]
E1 = -728.3086712009235  E_coul = 201.56252513223882
Extra cycle  E= -526.746146068685  delta_E= -1.14e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828756e+04 7.61703126e+03 3.61756620e+03 1.58709050e+03
 4.18750453e+02 1.22659438e+02 3.94856742e+01 8.50230975e+00
 3.35709092e+00 6.74934491e-01 2.50025700e-01 1.36285879e+03
 6.64051917e+02 2.97708362e+02 3.11241478e+02 6.12374262e+01
 7.30464288e+00 2.01299361e+01 7.74844845e-01 2.80602262e+00
 2.22555037e-01]
grad_E = [-1.39475636e-06  2.13783343e-06 -2.14343480e-06  3.63977707e-05
  1.22578051e-05  2.24957219e-06  3.58159974e-06 -1.44523582e-05
  5.14859571e-05  8.40111798e-05 -5.59229478e-05 -5.16741026e-07
  5.06565754e-06  2.41488161e-05  2.06630997e-05 -2.17548036e-05
 -5.54615176e-06 -1.54971559e-05  2.12642104e-04  9.51858698e-05
 -5.35448142e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.875086         1
[INPUT] 0    0    [1    /1   ]  7617.03237282        1
[INPUT] 0    0    [1    /1   ]  3617.56574632        1
[INPUT] 0    0    [1    /1   ]  1587.11515813        1
[INPUT] 0    0    [1    /1   ]  418.661371764        1
[INPUT] 0    0    [1    /1   ]  122.63618489         1
[INPUT] 0    0    [1    /1   ]  39.4817272265        1
[INPUT] 0    0    [1    /1   ]  8.50154924307        1
[INPUT] 0    0    [1    /1   ]  3.35720856094        1
[INPUT] 0    0    [1    /1   ]  0.67540740114        1
[INPUT] 0    0    [1    /1   ]  0.250170393367       1
[INPUT] 1    0    [1    /1   ]  1362.85858698        1
[INPUT] 1    0    [1    /1   ]  664.052925374        1
[INPUT] 1    0    [1    /1   ]  297.712639707        1
[INPUT] 1    0    [1    /1   ]  311.245159753        1
[INPUT] 1    0    [1    /1   ]  61.2853068627        1
[INPUT] 1    0    [1    /1   ]  7.31281546073        1
[INPUT] 1    0    [1    /1   ]  20.1487905691        1
[INPUT] 1    0    [1    /1   ]  0.775277376788       1
[INPUT] 1    0    [1    /1   ]  2.80957414113        1
[INPUT] 1    0    [1    /1   ]  0.222636460379       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.875085955027, 1.0]], [0, [7617.032372816414, 1.0]], [0, [3617.5657463187686, 1.0]], [0, [1587.1151581339216, 1.0]], [0, [418.6613717636967, 1.0]], [0, [122.63618489009389, 1.0]], [0, [39.48172722645453, 1.0]], [0, [8.501549243069398, 1.0]], [0, [3.357208560942711, 1.0]], [0, [0.6754074011397109, 1.0]], [0, [0.2501703933669384, 1.0]], [1, [1362.8585869837502, 1.0]], [1, [664.052925374101, 1.0]], [1, [297.7126397065309, 1.0]], [1, [311.24515975273874, 1.0]], [1, [61.28530686268037, 1.0]], [1, [7.312815460734653, 1.0]], [1, [20.148790569084973, 1.0]], [1, [0.7752773767883996, 1.0]], [1, [2.8095741411338193, 1.0]], [1, [0.22263646037918006, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87508596]
bas 1, expnt(s) = [7617.03237282]
bas 2, expnt(s) = [3617.56574632]
bas 3, expnt(s) = [1587.11515813]
bas 4, expnt(s) = [418.66137176]
bas 5, expnt(s) = [122.63618489]
bas 6, expnt(s) = [39.48172723]
bas 7, expnt(s) = [8.50154924]
bas 8, expnt(s) = [3.35720856]
bas 9, expnt(s) = [0.6754074]
bas 10, expnt(s) = [0.25017039]
bas 11, expnt(s) = [1362.85858698]
bas 12, expnt(s) = [664.05292537]
bas 13, expnt(s) = [297.71263971]
bas 14, expnt(s) = [311.24515975]
bas 15, expnt(s) = [61.28530686]
bas 16, expnt(s) = [7.31281546]
bas 17, expnt(s) = [20.14879057]
bas 18, expnt(s) = [0.77527738]
bas 19, expnt(s) = [2.80957414]
bas 20, expnt(s) = [0.22263646]
CPU time:       603.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828751e+04 5.20029552e+03 7.61703237e+03 2.05993907e+03
 3.61756575e+03 1.17849393e+03 1.58711516e+03 6.35289027e+02
 4.18661372e+02 2.33836441e+02 1.22636185e+02 9.31062849e+01
 3.94817272e+01 3.97934994e+01 8.50154924e+00 1.25787817e+01
 3.35720856e+00 6.26612084e+00 6.75407401e-01 1.88230236e+00
 2.50170393e-01 8.93700411e-01 1.36285859e+03 2.41572718e+04
 6.64052925e+02 9.83417111e+03 2.97712640e+02 3.60770472e+03
 3.11245160e+02 3.81384159e+03 6.12853069e+01 5.00241651e+02
 7.31281546e+00 3.50824698e+01 2.01487906e+01 1.24536203e+02
 7.75277377e-01 2.12229515e+00 2.80957414e+00 1.06117012e+01
 2.22636460e-01 4.46148825e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993479025757974
cond(S) = 93576.88403162347
E1 = -729.5315580026675  E_coul = 203.17985597496897
init E= -526.351702027698
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555790998631105  LUMO = 1.03232355535931
  mo_energy =
[-1.18331952e+02 -1.22047254e+01 -9.44671260e+00 -9.44671260e+00
 -9.44671260e+00 -1.23993759e+00 -5.55790999e-01 -5.55790999e-01
 -5.55790999e-01  1.03232356e+00  1.03232356e+00  1.03232356e+00
  1.06371821e+00  7.34018010e+00  7.34018010e+00  7.34018010e+00
  1.36489988e+01  3.34108942e+01  3.34108942e+01  3.34108942e+01
  1.22816928e+02  1.28449011e+02  1.28449011e+02  1.28449011e+02
  4.80017428e+02  4.80017428e+02  4.80017428e+02  6.65673949e+02
  1.32523161e+03  1.32523161e+03  1.32523161e+03  2.81192283e+03
  3.01092690e+03  3.01092690e+03  3.01092690e+03  6.62594177e+03
  6.62594177e+03  6.62594177e+03  9.23223198e+03  2.55784879e+04
  7.63076820e+04]
E1 = -727.8656431493104  E_coul = 201.12026483586328
cycle= 1 E= -526.745378313447  delta_E= -0.394  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537569
diis-c [-0.28898021  1.        ]
  HOMO = -0.590502156003751  LUMO = 1.0081716297591
  mo_energy =
[-1.18637540e+02 -1.23417826e+01 -9.59431192e+00 -9.59431192e+00
 -9.59431192e+00 -1.27928151e+00 -5.90502156e-01 -5.90502156e-01
 -5.90502156e-01  1.00817163e+00  1.00817163e+00  1.00817163e+00
  1.03420750e+00  7.24994304e+00  7.24994304e+00  7.24994304e+00
  1.35353692e+01  3.32580778e+01  3.32580778e+01  3.32580778e+01
  1.22588556e+02  1.28222661e+02  1.28222661e+02  1.28222661e+02
  4.79713785e+02  4.79713785e+02  4.79713785e+02  6.65322977e+02
  1.32487237e+03  1.32487237e+03  1.32487237e+03  2.81142912e+03
  3.01050218e+03  3.01050218e+03  3.01050218e+03  6.62540522e+03
  6.62540522e+03  6.62540522e+03  9.23162214e+03  2.55777844e+04
  7.63068888e+04]
E1 = -728.4358313786432  E_coul = 201.68974454211596
cycle= 2 E= -526.746086836527  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746257
diis-c [-0.0032625   0.08244069  0.91755931]
  HOMO = -0.581440678118046  LUMO = 1.01485047399384
  mo_energy =
[-1.18570340e+02 -1.23039850e+01 -9.55486799e+00 -9.55486799e+00
 -9.55486799e+00 -1.26843794e+00 -5.81440678e-01 -5.81440678e-01
 -5.81440678e-01  1.01485047e+00  1.01485047e+00  1.01485047e+00
  1.04262941e+00  7.27351091e+00  7.27351091e+00  7.27351091e+00
  1.35664160e+01  3.32978134e+01  3.32978134e+01  3.32978134e+01
  1.22645537e+02  1.28278071e+02  1.28278071e+02  1.28278071e+02
  4.79780114e+02  4.79780114e+02  4.79780114e+02  6.65392286e+02
  1.32494274e+03  1.32494274e+03  1.32494274e+03  2.81150288e+03
  3.01057480e+03  3.01057480e+03  3.01057480e+03  6.62547959e+03
  6.62547959e+03  6.62547959e+03  9.23169732e+03  2.55778602e+04
  7.63069649e+04]
E1 = -728.2864282803137  E_coul = 201.54028329112376
cycle= 3 E= -526.74614498919  delta_E= -5.82e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013076
diis-c [-5.35595308e-07 -1.21829383e-03  1.44761195e-01  8.56457099e-01]
  HOMO = -0.582929749357037  LUMO = 1.01377625997066
  mo_energy =
[-1.18580236e+02 -1.23097591e+01 -9.56098404e+00 -9.56098404e+00
 -9.56098404e+00 -1.27012275e+00 -5.82929749e-01 -5.82929749e-01
 -5.82929749e-01  1.01377626e+00  1.01377626e+00  1.01377626e+00
  1.04133956e+00  7.26976186e+00  7.26976186e+00  7.26976186e+00
  1.35616502e+01  3.32916899e+01  3.32916899e+01  3.32916899e+01
  1.22637085e+02  1.28269786e+02  1.28269786e+02  1.28269786e+02
  4.79770342e+02  4.79770342e+02  4.79770342e+02  6.65382068e+02
  1.32493238e+03  1.32493238e+03  1.32493238e+03  2.81149188e+03
  3.01056406e+03  3.01056406e+03  3.01056406e+03  6.62546846e+03
  6.62546846e+03  6.62546846e+03  9.23168598e+03  2.55778487e+04
  7.63069532e+04]
E1 = -728.3091074212423  E_coul = 201.56296053249068
cycle= 4 E= -526.746146888752  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107467
diis-c [-3.83501274e-09  6.71875106e-05 -9.74842985e-03 -6.32478153e-02
  1.07292906e+00]
  HOMO = -0.582911425063695  LUMO = 1.01379187438568
  mo_energy =
[-1.18580196e+02 -1.23096956e+01 -9.56093339e+00 -9.56093339e+00
 -9.56093339e+00 -1.27008305e+00 -5.82911425e-01 -5.82911425e-01
 -5.82911425e-01  1.01379187e+00  1.01379187e+00  1.01379187e+00
  1.04137333e+00  7.26980305e+00  7.26980305e+00  7.26980305e+00
  1.35617089e+01  3.32917386e+01  3.32917386e+01  3.32917386e+01
  1.22637135e+02  1.28269834e+02  1.28269834e+02  1.28269834e+02
  4.79770382e+02  4.79770382e+02  4.79770382e+02  6.65382100e+02
  1.32493241e+03  1.32493241e+03  1.32493241e+03  2.81149189e+03
  3.01056408e+03  3.01056408e+03  3.01056408e+03  6.62546847e+03
  6.62546847e+03  6.62546847e+03  9.23168598e+03  2.55778487e+04
  7.63069532e+04]
E1 = -728.3089001455271  E_coul = 201.56275325528208
cycle= 5 E= -526.746146890245  delta_E= -1.49e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79372e-05
diis-c [-6.62527221e-11  1.40536826e-05 -1.84922831e-03 -1.38050883e-02
  4.27931786e-02  9.72847084e-01]
  HOMO = -0.582918539526911  LUMO = 1.0137871593459
  mo_energy =
[-1.18580225e+02 -1.23097173e+01 -9.56095694e+00 -9.56095694e+00
 -9.56095694e+00 -1.27008874e+00 -5.82918540e-01 -5.82918540e-01
 -5.82918540e-01  1.01378716e+00  1.01378716e+00  1.01378716e+00
  1.04136938e+00  7.26978714e+00  7.26978714e+00  7.26978714e+00
  1.35616909e+01  3.32917157e+01  3.32917157e+01  3.32917157e+01
  1.22637108e+02  1.28269807e+02  1.28269807e+02  1.28269807e+02
  4.79770353e+02  4.79770353e+02  4.79770353e+02  6.65382069e+02
  1.32493238e+03  1.32493238e+03  1.32493238e+03  2.81149186e+03
  3.01056405e+03  3.01056405e+03  3.01056405e+03  6.62546844e+03
  6.62546844e+03  6.62546844e+03  9.23168595e+03  2.55778486e+04
  7.63069532e+04]
E1 = -728.3089790369282  E_coul = 201.56283214663145
cycle= 6 E= -526.746146890297  delta_E= -5.18e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3089790369282  E_coul = 201.56283214663145
  HOMO = -0.582918570024096  LUMO = 1.01378719162311
  mo_energy =
[-1.18580225e+02 -1.23097172e+01 -9.56095694e+00 -9.56095694e+00
 -9.56095694e+00 -1.27008840e+00 -5.82918570e-01 -5.82918570e-01
 -5.82918570e-01  1.01378719e+00  1.01378719e+00  1.01378719e+00
  1.04136970e+00  7.26978715e+00  7.26978715e+00  7.26978715e+00
  1.35616911e+01  3.32917157e+01  3.32917157e+01  3.32917157e+01
  1.22637108e+02  1.28269807e+02  1.28269807e+02  1.28269807e+02
  4.79770353e+02  4.79770353e+02  4.79770353e+02  6.65382070e+02
  1.32493238e+03  1.32493238e+03  1.32493238e+03  2.81149186e+03
  3.01056405e+03  3.01056405e+03  3.01056405e+03  6.62546844e+03
  6.62546844e+03  6.62546844e+03  9.23168595e+03  2.55778486e+04
  7.63069532e+04]
E1 = -728.3089783443171  E_coul = 201.56283145401883
Extra cycle  E= -526.746146890298  delta_E= -1.48e-12  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
exp = [2.61828751e+04 7.61703237e+03 3.61756575e+03 1.58711516e+03
 4.18661372e+02 1.22636185e+02 3.94817272e+01 8.50154924e+00
 3.35720856e+00 6.75407401e-01 2.50170393e-01 1.36285859e+03
 6.64052925e+02 2.97712640e+02 3.11245160e+02 6.12853069e+01
 7.31281546e+00 2.01487906e+01 7.75277377e-01 2.80957414e+00
 2.22636460e-01]
E = -526.7461468902983
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.875086         1
[INPUT] 0    0    [1    /1   ]  7617.03237282        1
[INPUT] 0    0    [1    /1   ]  3617.56574632        1
[INPUT] 0    0    [1    /1   ]  1587.11515813        1
[INPUT] 0    0    [1    /1   ]  418.661371764        1
[INPUT] 0    0    [1    /1   ]  122.63618489         1
[INPUT] 0    0    [1    /1   ]  39.4817272265        1
[INPUT] 0    0    [1    /1   ]  8.50154924307        1
[INPUT] 0    0    [1    /1   ]  3.35720856094        1
[INPUT] 0    0    [1    /1   ]  0.67540740114        1
[INPUT] 0    0    [1    /1   ]  0.250170393367       1
[INPUT] 1    0    [1    /1   ]  1362.85858698        1
[INPUT] 1    0    [1    /1   ]  664.052925374        1
[INPUT] 1    0    [1    /1   ]  297.712639707        1
[INPUT] 1    0    [1    /1   ]  311.245159753        1
[INPUT] 1    0    [1    /1   ]  61.2853068627        1
[INPUT] 1    0    [1    /1   ]  7.31281546073        1
[INPUT] 1    0    [1    /1   ]  20.1487905691        1
[INPUT] 1    0    [1    /1   ]  0.775277376788       1
[INPUT] 1    0    [1    /1   ]  2.80957414113        1
[INPUT] 1    0    [1    /1   ]  0.222636460379       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.875085955027, 1.0]], [0, [7617.032372816414, 1.0]], [0, [3617.5657463187686, 1.0]], [0, [1587.1151581339216, 1.0]], [0, [418.6613717636967, 1.0]], [0, [122.63618489009389, 1.0]], [0, [39.48172722645453, 1.0]], [0, [8.501549243069398, 1.0]], [0, [3.357208560942711, 1.0]], [0, [0.6754074011397109, 1.0]], [0, [0.2501703933669384, 1.0]], [1, [1362.8585869837502, 1.0]], [1, [664.052925374101, 1.0]], [1, [297.7126397065309, 1.0]], [1, [311.24515975273874, 1.0]], [1, [61.28530686268037, 1.0]], [1, [7.312815460734653, 1.0]], [1, [20.148790569084973, 1.0]], [1, [0.7752773767883996, 1.0]], [1, [2.8095741411338193, 1.0]], [1, [0.22263646037918006, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87508596]
bas 1, expnt(s) = [7617.03237282]
bas 2, expnt(s) = [3617.56574632]
bas 3, expnt(s) = [1587.11515813]
bas 4, expnt(s) = [418.66137176]
bas 5, expnt(s) = [122.63618489]
bas 6, expnt(s) = [39.48172723]
bas 7, expnt(s) = [8.50154924]
bas 8, expnt(s) = [3.35720856]
bas 9, expnt(s) = [0.6754074]
bas 10, expnt(s) = [0.25017039]
bas 11, expnt(s) = [1362.85858698]
bas 12, expnt(s) = [664.05292537]
bas 13, expnt(s) = [297.71263971]
bas 14, expnt(s) = [311.24515975]
bas 15, expnt(s) = [61.28530686]
bas 16, expnt(s) = [7.31281546]
bas 17, expnt(s) = [20.14879057]
bas 18, expnt(s) = [0.77527738]
bas 19, expnt(s) = [2.80957414]
bas 20, expnt(s) = [0.22263646]
CPU time:       603.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828751e+04 5.20029552e+03 7.61703237e+03 2.05993907e+03
 3.61756575e+03 1.17849393e+03 1.58711516e+03 6.35289027e+02
 4.18661372e+02 2.33836441e+02 1.22636185e+02 9.31062849e+01
 3.94817272e+01 3.97934994e+01 8.50154924e+00 1.25787817e+01
 3.35720856e+00 6.26612084e+00 6.75407401e-01 1.88230236e+00
 2.50170393e-01 8.93700411e-01 1.36285859e+03 2.41572718e+04
 6.64052925e+02 9.83417111e+03 2.97712640e+02 3.60770472e+03
 3.11245160e+02 3.81384159e+03 6.12853069e+01 5.00241651e+02
 7.31281546e+00 3.50824698e+01 2.01487906e+01 1.24536203e+02
 7.75277377e-01 2.12229515e+00 2.80957414e+00 1.06117012e+01
 2.22636460e-01 4.46148825e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993479025757974
cond(S) = 93576.88403162347
E1 = -729.5315580026675  E_coul = 203.17985597496897
init E= -526.351702027698
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555790998631105  LUMO = 1.03232355535931
  mo_energy =
[-1.18331952e+02 -1.22047254e+01 -9.44671260e+00 -9.44671260e+00
 -9.44671260e+00 -1.23993759e+00 -5.55790999e-01 -5.55790999e-01
 -5.55790999e-01  1.03232356e+00  1.03232356e+00  1.03232356e+00
  1.06371821e+00  7.34018010e+00  7.34018010e+00  7.34018010e+00
  1.36489988e+01  3.34108942e+01  3.34108942e+01  3.34108942e+01
  1.22816928e+02  1.28449011e+02  1.28449011e+02  1.28449011e+02
  4.80017428e+02  4.80017428e+02  4.80017428e+02  6.65673949e+02
  1.32523161e+03  1.32523161e+03  1.32523161e+03  2.81192283e+03
  3.01092690e+03  3.01092690e+03  3.01092690e+03  6.62594177e+03
  6.62594177e+03  6.62594177e+03  9.23223198e+03  2.55784879e+04
  7.63076820e+04]
E1 = -727.8656431493104  E_coul = 201.12026483586328
cycle= 1 E= -526.745378313447  delta_E= -0.394  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537569
diis-c [-0.28898021  1.        ]
  HOMO = -0.590502156003751  LUMO = 1.0081716297591
  mo_energy =
[-1.18637540e+02 -1.23417826e+01 -9.59431192e+00 -9.59431192e+00
 -9.59431192e+00 -1.27928151e+00 -5.90502156e-01 -5.90502156e-01
 -5.90502156e-01  1.00817163e+00  1.00817163e+00  1.00817163e+00
  1.03420750e+00  7.24994304e+00  7.24994304e+00  7.24994304e+00
  1.35353692e+01  3.32580778e+01  3.32580778e+01  3.32580778e+01
  1.22588556e+02  1.28222661e+02  1.28222661e+02  1.28222661e+02
  4.79713785e+02  4.79713785e+02  4.79713785e+02  6.65322977e+02
  1.32487237e+03  1.32487237e+03  1.32487237e+03  2.81142912e+03
  3.01050218e+03  3.01050218e+03  3.01050218e+03  6.62540522e+03
  6.62540522e+03  6.62540522e+03  9.23162214e+03  2.55777844e+04
  7.63068888e+04]
E1 = -728.4358313786432  E_coul = 201.68974454211596
cycle= 2 E= -526.746086836527  delta_E= -0.000709  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746257
diis-c [-0.0032625   0.08244069  0.91755931]
  HOMO = -0.581440678118046  LUMO = 1.01485047399384
  mo_energy =
[-1.18570340e+02 -1.23039850e+01 -9.55486799e+00 -9.55486799e+00
 -9.55486799e+00 -1.26843794e+00 -5.81440678e-01 -5.81440678e-01
 -5.81440678e-01  1.01485047e+00  1.01485047e+00  1.01485047e+00
  1.04262941e+00  7.27351091e+00  7.27351091e+00  7.27351091e+00
  1.35664160e+01  3.32978134e+01  3.32978134e+01  3.32978134e+01
  1.22645537e+02  1.28278071e+02  1.28278071e+02  1.28278071e+02
  4.79780114e+02  4.79780114e+02  4.79780114e+02  6.65392286e+02
  1.32494274e+03  1.32494274e+03  1.32494274e+03  2.81150288e+03
  3.01057480e+03  3.01057480e+03  3.01057480e+03  6.62547959e+03
  6.62547959e+03  6.62547959e+03  9.23169732e+03  2.55778602e+04
  7.63069649e+04]
E1 = -728.2864282803137  E_coul = 201.54028329112376
cycle= 3 E= -526.74614498919  delta_E= -5.82e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.013076
diis-c [-5.35595308e-07 -1.21829383e-03  1.44761195e-01  8.56457099e-01]
  HOMO = -0.582929749357037  LUMO = 1.01377625997066
  mo_energy =
[-1.18580236e+02 -1.23097591e+01 -9.56098404e+00 -9.56098404e+00
 -9.56098404e+00 -1.27012275e+00 -5.82929749e-01 -5.82929749e-01
 -5.82929749e-01  1.01377626e+00  1.01377626e+00  1.01377626e+00
  1.04133956e+00  7.26976186e+00  7.26976186e+00  7.26976186e+00
  1.35616502e+01  3.32916899e+01  3.32916899e+01  3.32916899e+01
  1.22637085e+02  1.28269786e+02  1.28269786e+02  1.28269786e+02
  4.79770342e+02  4.79770342e+02  4.79770342e+02  6.65382068e+02
  1.32493238e+03  1.32493238e+03  1.32493238e+03  2.81149188e+03
  3.01056406e+03  3.01056406e+03  3.01056406e+03  6.62546846e+03
  6.62546846e+03  6.62546846e+03  9.23168598e+03  2.55778487e+04
  7.63069532e+04]
E1 = -728.3091074212423  E_coul = 201.56296053249068
cycle= 4 E= -526.746146888752  delta_E= -1.9e-06  |g|= 9.32e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107467
diis-c [-3.83501274e-09  6.71875106e-05 -9.74842985e-03 -6.32478153e-02
  1.07292906e+00]
  HOMO = -0.582911425063695  LUMO = 1.01379187438568
  mo_energy =
[-1.18580196e+02 -1.23096956e+01 -9.56093339e+00 -9.56093339e+00
 -9.56093339e+00 -1.27008305e+00 -5.82911425e-01 -5.82911425e-01
 -5.82911425e-01  1.01379187e+00  1.01379187e+00  1.01379187e+00
  1.04137333e+00  7.26980305e+00  7.26980305e+00  7.26980305e+00
  1.35617089e+01  3.32917386e+01  3.32917386e+01  3.32917386e+01
  1.22637135e+02  1.28269834e+02  1.28269834e+02  1.28269834e+02
  4.79770382e+02  4.79770382e+02  4.79770382e+02  6.65382100e+02
  1.32493241e+03  1.32493241e+03  1.32493241e+03  2.81149189e+03
  3.01056408e+03  3.01056408e+03  3.01056408e+03  6.62546847e+03
  6.62546847e+03  6.62546847e+03  9.23168598e+03  2.55778487e+04
  7.63069532e+04]
E1 = -728.3089001455271  E_coul = 201.56275325528208
cycle= 5 E= -526.746146890245  delta_E= -1.49e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79372e-05
diis-c [-6.62527221e-11  1.40536826e-05 -1.84922831e-03 -1.38050883e-02
  4.27931786e-02  9.72847084e-01]
  HOMO = -0.582918539526911  LUMO = 1.0137871593459
  mo_energy =
[-1.18580225e+02 -1.23097173e+01 -9.56095694e+00 -9.56095694e+00
 -9.56095694e+00 -1.27008874e+00 -5.82918540e-01 -5.82918540e-01
 -5.82918540e-01  1.01378716e+00  1.01378716e+00  1.01378716e+00
  1.04136938e+00  7.26978714e+00  7.26978714e+00  7.26978714e+00
  1.35616909e+01  3.32917157e+01  3.32917157e+01  3.32917157e+01
  1.22637108e+02  1.28269807e+02  1.28269807e+02  1.28269807e+02
  4.79770353e+02  4.79770353e+02  4.79770353e+02  6.65382069e+02
  1.32493238e+03  1.32493238e+03  1.32493238e+03  2.81149186e+03
  3.01056405e+03  3.01056405e+03  3.01056405e+03  6.62546844e+03
  6.62546844e+03  6.62546844e+03  9.23168595e+03  2.55778486e+04
  7.63069532e+04]
E1 = -728.3089790369282  E_coul = 201.56283214663145
cycle= 6 E= -526.746146890297  delta_E= -5.18e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3089790369282  E_coul = 201.56283214663145
  HOMO = -0.582918570024096  LUMO = 1.01378719162311
  mo_energy =
[-1.18580225e+02 -1.23097172e+01 -9.56095694e+00 -9.56095694e+00
 -9.56095694e+00 -1.27008840e+00 -5.82918570e-01 -5.82918570e-01
 -5.82918570e-01  1.01378719e+00  1.01378719e+00  1.01378719e+00
  1.04136970e+00  7.26978715e+00  7.26978715e+00  7.26978715e+00
  1.35616911e+01  3.32917157e+01  3.32917157e+01  3.32917157e+01
  1.22637108e+02  1.28269807e+02  1.28269807e+02  1.28269807e+02
  4.79770353e+02  4.79770353e+02  4.79770353e+02  6.65382070e+02
  1.32493238e+03  1.32493238e+03  1.32493238e+03  2.81149186e+03
  3.01056405e+03  3.01056405e+03  3.01056405e+03  6.62546844e+03
  6.62546844e+03  6.62546844e+03  9.23168595e+03  2.55778486e+04
  7.63069532e+04]
E1 = -728.3089783443171  E_coul = 201.56283145401883
Extra cycle  E= -526.746146890298  delta_E= -1.48e-12  |g|= 3.43e-07  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93576.88403162347
E1 = -728.3089783443171  E_coul = 201.56283145401883
init E= -526.746146890298
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582918593771336  LUMO = 1.01378718602139
  mo_energy =
[-1.18580225e+02 -1.23097173e+01 -9.56095701e+00 -9.56095701e+00
 -9.56095701e+00 -1.27008836e+00 -5.82918594e-01 -5.82918594e-01
 -5.82918594e-01  1.01378719e+00  1.01378719e+00  1.01378719e+00
  1.04136975e+00  7.26978711e+00  7.26978711e+00  7.26978711e+00
  1.35616911e+01  3.32917157e+01  3.32917157e+01  3.32917157e+01
  1.22637108e+02  1.28269807e+02  1.28269807e+02  1.28269807e+02
  4.79770353e+02  4.79770353e+02  4.79770353e+02  6.65382069e+02
  1.32493238e+03  1.32493238e+03  1.32493238e+03  2.81149186e+03
  3.01056405e+03  3.01056405e+03  3.01056405e+03  6.62546844e+03
  6.62546844e+03  6.62546844e+03  9.23168595e+03  2.55778486e+04
  7.63069532e+04]
E1 = -728.308978443123  E_coul = 201.56283155282483
cycle= 1 E= -526.746146890298  delta_E= 1.14e-13  |g|= 7.09e-08  |ddm|= 5.69e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.308978443123  E_coul = 201.56283155282483
  HOMO = -0.582918594120624  LUMO = 1.01378718810643
  mo_energy =
[-1.18580225e+02 -1.23097173e+01 -9.56095701e+00 -9.56095701e+00
 -9.56095701e+00 -1.27008834e+00 -5.82918594e-01 -5.82918594e-01
 -5.82918594e-01  1.01378719e+00  1.01378719e+00  1.01378719e+00
  1.04136977e+00  7.26978711e+00  7.26978711e+00  7.26978711e+00
  1.35616911e+01  3.32917157e+01  3.32917157e+01  3.32917157e+01
  1.22637108e+02  1.28269807e+02  1.28269807e+02  1.28269807e+02
  4.79770353e+02  4.79770353e+02  4.79770353e+02  6.65382069e+02
  1.32493238e+03  1.32493238e+03  1.32493238e+03  2.81149186e+03
  3.01056405e+03  3.01056405e+03  3.01056405e+03  6.62546844e+03
  6.62546844e+03  6.62546844e+03  9.23168595e+03  2.55778486e+04
  7.63069532e+04]
E1 = -728.3089783955558  E_coul = 201.56283150525738
Extra cycle  E= -526.746146890298  delta_E= -2.27e-13  |g|= 1.43e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828751e+04 7.61703237e+03 3.61756575e+03 1.58711516e+03
 4.18661372e+02 1.22636185e+02 3.94817272e+01 8.50154924e+00
 3.35720856e+00 6.75407401e-01 2.50170393e-01 1.36285859e+03
 6.64052925e+02 2.97712640e+02 3.11245160e+02 6.12853069e+01
 7.31281546e+00 2.01487906e+01 7.75277377e-01 2.80957414e+00
 2.22636460e-01]
grad_E = [-1.39512193e-06  2.14081067e-06 -2.14351101e-06  3.64851273e-05
  1.17126909e-05  1.40439782e-06  5.42086002e-06 -2.65573000e-05
  9.36151293e-05  1.49172181e-04 -9.63230526e-05 -5.19060258e-07
  5.03606347e-06  2.39833086e-05  2.05198418e-05 -1.89298002e-05
 -6.99124513e-06 -2.15880410e-05  3.59988340e-04  1.64668285e-04
 -9.09267807e-04]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8752727        1
[INPUT] 0    0    [1    /1   ]  7617.03266403        1
[INPUT] 0    0    [1    /1   ]  3617.56648783        1
[INPUT] 0    0    [1    /1   ]  1587.12904224        1
[INPUT] 0    0    [1    /1   ]  418.513792931        1
[INPUT] 0    0    [1    /1   ]  122.59787575         1
[INPUT] 0    0    [1    /1   ]  39.4751983935        1
[INPUT] 0    0    [1    /1   ]  8.50027718939        1
[INPUT] 0    0    [1    /1   ]  3.35739403913        1
[INPUT] 0    0    [1    /1   ]  0.676183386931       1
[INPUT] 0    0    [1    /1   ]  0.250407396592       1
[INPUT] 1    0    [1    /1   ]  1362.85863275        1
[INPUT] 1    0    [1    /1   ]  664.05121806         1
[INPUT] 1    0    [1    /1   ]  297.703794165        1
[INPUT] 1    0    [1    /1   ]  311.237629444        1
[INPUT] 1    0    [1    /1   ]  61.3606875663        1
[INPUT] 1    0    [1    /1   ]  7.32579887568        1
[INPUT] 1    0    [1    /1   ]  20.1786181297        1
[INPUT] 1    0    [1    /1   ]  0.775965048329       1
[INPUT] 1    0    [1    /1   ]  2.81522328136        1
[INPUT] 1    0    [1    /1   ]  0.222766002745       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.875272707537, 1.0]], [0, [7617.0326640313815, 1.0]], [0, [3617.5664878284647, 1.0]], [0, [1587.1290422418244, 1.0]], [0, [418.51379293124285, 1.0]], [0, [122.59787575013907, 1.0]], [0, [39.475198393456765, 1.0]], [0, [8.500277189391308, 1.0]], [0, [3.357394039126626, 1.0]], [0, [0.676183386930523, 1.0]], [0, [0.25040739659204936, 1.0]], [1, [1362.8586327501143, 1.0]], [1, [664.0512180602434, 1.0]], [1, [297.7037941650611, 1.0]], [1, [311.23762944370884, 1.0]], [1, [61.3606875662795, 1.0]], [1, [7.325798875677426, 1.0]], [1, [20.178618129727028, 1.0]], [1, [0.7759650483293389, 1.0]], [1, [2.815223281362581, 1.0]], [1, [0.2227660027452393, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87527271]
bas 1, expnt(s) = [7617.03266403]
bas 2, expnt(s) = [3617.56648783]
bas 3, expnt(s) = [1587.12904224]
bas 4, expnt(s) = [418.51379293]
bas 5, expnt(s) = [122.59787575]
bas 6, expnt(s) = [39.47519839]
bas 7, expnt(s) = [8.50027719]
bas 8, expnt(s) = [3.35739404]
bas 9, expnt(s) = [0.67618339]
bas 10, expnt(s) = [0.2504074]
bas 11, expnt(s) = [1362.85863275]
bas 12, expnt(s) = [664.05121806]
bas 13, expnt(s) = [297.70379417]
bas 14, expnt(s) = [311.23762944]
bas 15, expnt(s) = [61.36068757]
bas 16, expnt(s) = [7.32579888]
bas 17, expnt(s) = [20.17861813]
bas 18, expnt(s) = [0.77596505]
bas 19, expnt(s) = [2.81522328]
bas 20, expnt(s) = [0.222766]
CPU time:       609.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828753e+04 5.20029555e+03 7.61703266e+03 2.05993913e+03
 3.61756649e+03 1.17849411e+03 1.58712904e+03 6.35293195e+02
 4.18513793e+02 2.33774618e+02 1.22597876e+02 9.30844706e+01
 3.94751984e+01 3.97885640e+01 8.50027719e+00 1.25773701e+01
 3.35739404e+00 6.26638048e+00 6.76183387e-01 1.88392408e+00
 2.50407397e-01 8.94335333e-01 1.36285863e+03 2.41572728e+04
 6.64051218e+02 9.83413950e+03 2.97703794e+02 3.60757073e+03
 3.11237629e+02 3.81372625e+03 6.13606876e+01 5.01010888e+02
 7.32579888e+00 3.51603453e+01 2.01786181e+01 1.24766695e+02
 7.75965048e-01 2.12464851e+00 2.81522328e+00 1.06383788e+01
 2.22766003e-01 4.46473341e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99345364133438
cond(S) = 93670.4895817261
E1 = -729.5316005860662  E_coul = 203.1798959983904
init E= -526.351704587676
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555785278284701  LUMO = 1.03344399809388
  mo_energy =
[-1.18331949e+02 -1.22047249e+01 -9.44671429e+00 -9.44671429e+00
 -9.44671429e+00 -1.23993376e+00 -5.55785278e-01 -5.55785278e-01
 -5.55785278e-01  1.03344400e+00  1.03344400e+00  1.03344400e+00
  1.06557589e+00  7.35653817e+00  7.35653817e+00  7.35653817e+00
  1.36527151e+01  3.34838230e+01  3.34838230e+01  3.34838230e+01
  1.22787093e+02  1.28667230e+02  1.28667230e+02  1.28667230e+02
  4.80378429e+02  4.80378429e+02  4.80378429e+02  6.65452870e+02
  1.32560611e+03  1.32560611e+03  1.32560611e+03  2.81139040e+03
  3.01127421e+03  3.01127421e+03  3.01127421e+03  6.62624880e+03
  6.62624880e+03  6.62624880e+03  9.23158652e+03  2.55778394e+04
  7.63070690e+04]
E1 = -727.866309639039  E_coul = 201.12092872981864
cycle= 1 E= -526.74538090922  delta_E= -0.394  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537601
diis-c [-0.2890144  1.       ]
  HOMO = -0.590482150085715  LUMO = 1.00927317502291
  mo_energy =
[-1.18637466e+02 -1.23417377e+01 -9.59426749e+00 -9.59426749e+00
 -9.59426749e+00 -1.27926276e+00 -5.90482150e-01 -5.90482150e-01
 -5.90482150e-01  1.00927318e+00  1.00927318e+00  1.00927318e+00
  1.03604053e+00  7.26621442e+00  7.26621442e+00  7.26621442e+00
  1.35391250e+01  3.33309530e+01  3.33309530e+01  3.33309530e+01
  1.22558810e+02  1.28440873e+02  1.28440873e+02  1.28440873e+02
  4.80074860e+02  4.80074860e+02  4.80074860e+02  6.65102002e+02
  1.32524695e+03  1.32524695e+03  1.32524695e+03  2.81089678e+03
  3.01084957e+03  3.01084957e+03  3.01084957e+03  6.62571233e+03
  6.62571233e+03  6.62571233e+03  9.23097675e+03  2.55771360e+04
  7.63062759e+04]
E1 = -728.4362673303369  E_coul = 201.69017830515517
cycle= 2 E= -526.746089025182  delta_E= -0.000708  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746153
diis-c [-0.00326175  0.08242287  0.91757713]
  HOMO = -0.58142539879249  LUMO = 1.01595704703806
  mo_energy =
[-1.18570288e+02 -1.23039547e+01 -9.55483831e+00 -9.55483831e+00
 -9.55483831e+00 -1.26842474e+00 -5.81425399e-01 -5.81425399e-01
 -5.81425399e-01  1.01595705e+00  1.01595705e+00  1.01595705e+00
  1.04446848e+00  7.28980217e+00  7.28980217e+00  7.28980217e+00
  1.35701576e+01  3.33706984e+01  3.33706984e+01  3.33706984e+01
  1.22615768e+02  1.28496277e+02  1.28496277e+02  1.28496277e+02
  4.80141168e+02  4.80141168e+02  4.80141168e+02  6.65171287e+02
  1.32531730e+03  1.32531730e+03  1.32531730e+03  2.81097051e+03
  3.01092217e+03  3.01092217e+03  3.01092217e+03  6.62578668e+03
  6.62578668e+03  6.62578668e+03  9.23105191e+03  2.55772117e+04
  7.63063519e+04]
E1 = -728.2869370829702  E_coul = 201.54078995153466
cycle= 3 E= -526.746147131436  delta_E= -5.81e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130738
diis-c [-5.35207368e-07 -1.21822278e-03  1.44757639e-01  8.56460584e-01]
  HOMO = -0.582913660452236  LUMO = 1.01488204401718
  mo_energy =
[-1.18580180e+02 -1.23097265e+01 -9.56095195e+00 -9.56095195e+00
 -9.56095195e+00 -1.27010869e+00 -5.82913660e-01 -5.82913660e-01
 -5.82913660e-01  1.01488204e+00  1.01488204e+00  1.01488204e+00
  1.04317770e+00  7.28605018e+00  7.28605018e+00  7.28605018e+00
  1.35653941e+01  3.33645738e+01  3.33645738e+01  3.33645738e+01
  1.22607319e+02  1.28487993e+02  1.28487993e+02  1.28487993e+02
  4.80131399e+02  4.80131399e+02  4.80131399e+02  6.65161072e+02
  1.32530694e+03  1.32530694e+03  1.32530694e+03  2.81095952e+03
  3.01091143e+03  3.01091143e+03  3.01091143e+03  6.62577555e+03
  6.62577555e+03  6.62577555e+03  9.23104057e+03  2.55772002e+04
  7.63063403e+04]
E1 = -728.3096049632024  E_coul = 201.56345593380064
cycle= 4 E= -526.746149029402  delta_E= -1.9e-06  |g|= 9.31e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107398
diis-c [-3.82836892e-09  6.71764394e-05 -9.74777268e-03 -6.32428553e-02
  1.07292345e+00]
  HOMO = -0.582895336626785  LUMO = 1.01489767131192
  mo_energy =
[-1.18580140e+02 -1.23096630e+01 -9.56090131e+00 -9.56090131e+00
 -9.56090131e+00 -1.27006901e+00 -5.82895337e-01 -5.82895337e-01
 -5.82895337e-01  1.01489767e+00  1.01489767e+00  1.01489767e+00
  1.04321148e+00  7.28609139e+00  7.28609139e+00  7.28609139e+00
  1.35654528e+01  3.33646225e+01  3.33646225e+01  3.33646225e+01
  1.22607369e+02  1.28488040e+02  1.28488040e+02  1.28488040e+02
  4.80131439e+02  4.80131439e+02  4.80131439e+02  6.65161104e+02
  1.32530698e+03  1.32530698e+03  1.32530698e+03  2.81095953e+03
  3.01091145e+03  3.01091145e+03  3.01091145e+03  6.62577556e+03
  6.62577556e+03  6.62577556e+03  9.23104057e+03  2.55772002e+04
  7.63063403e+04]
E1 = -728.3093977776218  E_coul = 201.5632487467291
cycle= 5 E= -526.746149030893  delta_E= -1.49e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79184e-05
diis-c [-6.61253941e-11  1.40385627e-05 -1.84748244e-03 -1.37943914e-02
  4.28298395e-02  9.72797996e-01]
  HOMO = -0.582902445480261  LUMO = 1.01489295356196
  mo_energy =
[-1.18580170e+02 -1.23096847e+01 -9.56092484e+00 -9.56092484e+00
 -9.56092484e+00 -1.27007469e+00 -5.82902445e-01 -5.82902445e-01
 -5.82902445e-01  1.01489295e+00  1.01489295e+00  1.01489295e+00
  1.04320753e+00  7.28607547e+00  7.28607547e+00  7.28607547e+00
  1.35654348e+01  3.33645997e+01  3.33645997e+01  3.33645997e+01
  1.22607342e+02  1.28488013e+02  1.28488013e+02  1.28488013e+02
  4.80131410e+02  4.80131410e+02  4.80131410e+02  6.65161074e+02
  1.32530695e+03  1.32530695e+03  1.32530695e+03  2.81095950e+03
  3.01091142e+03  3.01091142e+03  3.01091142e+03  6.62577553e+03
  6.62577553e+03  6.62577553e+03  9.23104054e+03  2.55772002e+04
  7.63063402e+04]
E1 = -728.3094766230656  E_coul = 201.56332759212103
cycle= 6 E= -526.746149030945  delta_E= -5.18e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3094766230656  E_coul = 201.56332759212103
  HOMO = -0.582902475827122  LUMO = 1.01489298586698
  mo_energy =
[-1.18580170e+02 -1.23096846e+01 -9.56092485e+00 -9.56092485e+00
 -9.56092485e+00 -1.27007435e+00 -5.82902476e-01 -5.82902476e-01
 -5.82902476e-01  1.01489299e+00  1.01489299e+00  1.01489299e+00
  1.04320785e+00  7.28607548e+00  7.28607548e+00  7.28607548e+00
  1.35654349e+01  3.33645997e+01  3.33645997e+01  3.33645997e+01
  1.22607342e+02  1.28488013e+02  1.28488013e+02  1.28488013e+02
  4.80131410e+02  4.80131410e+02  4.80131410e+02  6.65161074e+02
  1.32530695e+03  1.32530695e+03  1.32530695e+03  2.81095950e+03
  3.01091142e+03  3.01091142e+03  3.01091142e+03  6.62577553e+03
  6.62577553e+03  6.62577553e+03  9.23104054e+03  2.55772002e+04
  7.63063402e+04]
E1 = -728.3094759315437  E_coul = 201.56332690059648
Extra cycle  E= -526.746149030947  delta_E= -2.61e-12  |g|= 3.42e-07  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
exp = [2.61828753e+04 7.61703266e+03 3.61756649e+03 1.58712904e+03
 4.18513793e+02 1.22597876e+02 3.94751984e+01 8.50027719e+00
 3.35739404e+00 6.76183387e-01 2.50407397e-01 1.36285863e+03
 6.64051218e+02 2.97703794e+02 3.11237629e+02 6.13606876e+01
 7.32579888e+00 2.01786181e+01 7.75965048e-01 2.81522328e+00
 2.22766003e-01]
E = -526.7461490309472
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:37 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8752727        1
[INPUT] 0    0    [1    /1   ]  7617.03266403        1
[INPUT] 0    0    [1    /1   ]  3617.56648783        1
[INPUT] 0    0    [1    /1   ]  1587.12904224        1
[INPUT] 0    0    [1    /1   ]  418.513792931        1
[INPUT] 0    0    [1    /1   ]  122.59787575         1
[INPUT] 0    0    [1    /1   ]  39.4751983935        1
[INPUT] 0    0    [1    /1   ]  8.50027718939        1
[INPUT] 0    0    [1    /1   ]  3.35739403913        1
[INPUT] 0    0    [1    /1   ]  0.676183386931       1
[INPUT] 0    0    [1    /1   ]  0.250407396592       1
[INPUT] 1    0    [1    /1   ]  1362.85863275        1
[INPUT] 1    0    [1    /1   ]  664.05121806         1
[INPUT] 1    0    [1    /1   ]  297.703794165        1
[INPUT] 1    0    [1    /1   ]  311.237629444        1
[INPUT] 1    0    [1    /1   ]  61.3606875663        1
[INPUT] 1    0    [1    /1   ]  7.32579887568        1
[INPUT] 1    0    [1    /1   ]  20.1786181297        1
[INPUT] 1    0    [1    /1   ]  0.775965048329       1
[INPUT] 1    0    [1    /1   ]  2.81522328136        1
[INPUT] 1    0    [1    /1   ]  0.222766002745       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.875272707537, 1.0]], [0, [7617.0326640313815, 1.0]], [0, [3617.5664878284647, 1.0]], [0, [1587.1290422418244, 1.0]], [0, [418.51379293124285, 1.0]], [0, [122.59787575013907, 1.0]], [0, [39.475198393456765, 1.0]], [0, [8.500277189391308, 1.0]], [0, [3.357394039126626, 1.0]], [0, [0.676183386930523, 1.0]], [0, [0.25040739659204936, 1.0]], [1, [1362.8586327501143, 1.0]], [1, [664.0512180602434, 1.0]], [1, [297.7037941650611, 1.0]], [1, [311.23762944370884, 1.0]], [1, [61.3606875662795, 1.0]], [1, [7.325798875677426, 1.0]], [1, [20.178618129727028, 1.0]], [1, [0.7759650483293389, 1.0]], [1, [2.815223281362581, 1.0]], [1, [0.2227660027452393, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87527271]
bas 1, expnt(s) = [7617.03266403]
bas 2, expnt(s) = [3617.56648783]
bas 3, expnt(s) = [1587.12904224]
bas 4, expnt(s) = [418.51379293]
bas 5, expnt(s) = [122.59787575]
bas 6, expnt(s) = [39.47519839]
bas 7, expnt(s) = [8.50027719]
bas 8, expnt(s) = [3.35739404]
bas 9, expnt(s) = [0.67618339]
bas 10, expnt(s) = [0.2504074]
bas 11, expnt(s) = [1362.85863275]
bas 12, expnt(s) = [664.05121806]
bas 13, expnt(s) = [297.70379417]
bas 14, expnt(s) = [311.23762944]
bas 15, expnt(s) = [61.36068757]
bas 16, expnt(s) = [7.32579888]
bas 17, expnt(s) = [20.17861813]
bas 18, expnt(s) = [0.77596505]
bas 19, expnt(s) = [2.81522328]
bas 20, expnt(s) = [0.222766]
CPU time:       610.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828753e+04 5.20029555e+03 7.61703266e+03 2.05993913e+03
 3.61756649e+03 1.17849411e+03 1.58712904e+03 6.35293195e+02
 4.18513793e+02 2.33774618e+02 1.22597876e+02 9.30844706e+01
 3.94751984e+01 3.97885640e+01 8.50027719e+00 1.25773701e+01
 3.35739404e+00 6.26638048e+00 6.76183387e-01 1.88392408e+00
 2.50407397e-01 8.94335333e-01 1.36285863e+03 2.41572728e+04
 6.64051218e+02 9.83413950e+03 2.97703794e+02 3.60757073e+03
 3.11237629e+02 3.81372625e+03 6.13606876e+01 5.01010888e+02
 7.32579888e+00 3.51603453e+01 2.01786181e+01 1.24766695e+02
 7.75965048e-01 2.12464851e+00 2.81522328e+00 1.06383788e+01
 2.22766003e-01 4.46473341e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99345364133438
cond(S) = 93670.4895817261
E1 = -729.5316005860662  E_coul = 203.1798959983904
init E= -526.351704587676
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555785278284701  LUMO = 1.03344399809388
  mo_energy =
[-1.18331949e+02 -1.22047249e+01 -9.44671429e+00 -9.44671429e+00
 -9.44671429e+00 -1.23993376e+00 -5.55785278e-01 -5.55785278e-01
 -5.55785278e-01  1.03344400e+00  1.03344400e+00  1.03344400e+00
  1.06557589e+00  7.35653817e+00  7.35653817e+00  7.35653817e+00
  1.36527151e+01  3.34838230e+01  3.34838230e+01  3.34838230e+01
  1.22787093e+02  1.28667230e+02  1.28667230e+02  1.28667230e+02
  4.80378429e+02  4.80378429e+02  4.80378429e+02  6.65452870e+02
  1.32560611e+03  1.32560611e+03  1.32560611e+03  2.81139040e+03
  3.01127421e+03  3.01127421e+03  3.01127421e+03  6.62624880e+03
  6.62624880e+03  6.62624880e+03  9.23158652e+03  2.55778394e+04
  7.63070690e+04]
E1 = -727.866309639039  E_coul = 201.12092872981864
cycle= 1 E= -526.74538090922  delta_E= -0.394  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537601
diis-c [-0.2890144  1.       ]
  HOMO = -0.590482150085715  LUMO = 1.00927317502291
  mo_energy =
[-1.18637466e+02 -1.23417377e+01 -9.59426749e+00 -9.59426749e+00
 -9.59426749e+00 -1.27926276e+00 -5.90482150e-01 -5.90482150e-01
 -5.90482150e-01  1.00927318e+00  1.00927318e+00  1.00927318e+00
  1.03604053e+00  7.26621442e+00  7.26621442e+00  7.26621442e+00
  1.35391250e+01  3.33309530e+01  3.33309530e+01  3.33309530e+01
  1.22558810e+02  1.28440873e+02  1.28440873e+02  1.28440873e+02
  4.80074860e+02  4.80074860e+02  4.80074860e+02  6.65102002e+02
  1.32524695e+03  1.32524695e+03  1.32524695e+03  2.81089678e+03
  3.01084957e+03  3.01084957e+03  3.01084957e+03  6.62571233e+03
  6.62571233e+03  6.62571233e+03  9.23097675e+03  2.55771360e+04
  7.63062759e+04]
E1 = -728.4362673303369  E_coul = 201.69017830515517
cycle= 2 E= -526.746089025182  delta_E= -0.000708  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0746153
diis-c [-0.00326175  0.08242287  0.91757713]
  HOMO = -0.58142539879249  LUMO = 1.01595704703806
  mo_energy =
[-1.18570288e+02 -1.23039547e+01 -9.55483831e+00 -9.55483831e+00
 -9.55483831e+00 -1.26842474e+00 -5.81425399e-01 -5.81425399e-01
 -5.81425399e-01  1.01595705e+00  1.01595705e+00  1.01595705e+00
  1.04446848e+00  7.28980217e+00  7.28980217e+00  7.28980217e+00
  1.35701576e+01  3.33706984e+01  3.33706984e+01  3.33706984e+01
  1.22615768e+02  1.28496277e+02  1.28496277e+02  1.28496277e+02
  4.80141168e+02  4.80141168e+02  4.80141168e+02  6.65171287e+02
  1.32531730e+03  1.32531730e+03  1.32531730e+03  2.81097051e+03
  3.01092217e+03  3.01092217e+03  3.01092217e+03  6.62578668e+03
  6.62578668e+03  6.62578668e+03  9.23105191e+03  2.55772117e+04
  7.63063519e+04]
E1 = -728.2869370829702  E_coul = 201.54078995153466
cycle= 3 E= -526.746147131436  delta_E= -5.81e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130738
diis-c [-5.35207368e-07 -1.21822278e-03  1.44757639e-01  8.56460584e-01]
  HOMO = -0.582913660452236  LUMO = 1.01488204401718
  mo_energy =
[-1.18580180e+02 -1.23097265e+01 -9.56095195e+00 -9.56095195e+00
 -9.56095195e+00 -1.27010869e+00 -5.82913660e-01 -5.82913660e-01
 -5.82913660e-01  1.01488204e+00  1.01488204e+00  1.01488204e+00
  1.04317770e+00  7.28605018e+00  7.28605018e+00  7.28605018e+00
  1.35653941e+01  3.33645738e+01  3.33645738e+01  3.33645738e+01
  1.22607319e+02  1.28487993e+02  1.28487993e+02  1.28487993e+02
  4.80131399e+02  4.80131399e+02  4.80131399e+02  6.65161072e+02
  1.32530694e+03  1.32530694e+03  1.32530694e+03  2.81095952e+03
  3.01091143e+03  3.01091143e+03  3.01091143e+03  6.62577555e+03
  6.62577555e+03  6.62577555e+03  9.23104057e+03  2.55772002e+04
  7.63063403e+04]
E1 = -728.3096049632024  E_coul = 201.56345593380064
cycle= 4 E= -526.746149029402  delta_E= -1.9e-06  |g|= 9.31e-05  |ddm|= 0.00227
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107398
diis-c [-3.82836892e-09  6.71764394e-05 -9.74777268e-03 -6.32428553e-02
  1.07292345e+00]
  HOMO = -0.582895336626785  LUMO = 1.01489767131192
  mo_energy =
[-1.18580140e+02 -1.23096630e+01 -9.56090131e+00 -9.56090131e+00
 -9.56090131e+00 -1.27006901e+00 -5.82895337e-01 -5.82895337e-01
 -5.82895337e-01  1.01489767e+00  1.01489767e+00  1.01489767e+00
  1.04321148e+00  7.28609139e+00  7.28609139e+00  7.28609139e+00
  1.35654528e+01  3.33646225e+01  3.33646225e+01  3.33646225e+01
  1.22607369e+02  1.28488040e+02  1.28488040e+02  1.28488040e+02
  4.80131439e+02  4.80131439e+02  4.80131439e+02  6.65161104e+02
  1.32530698e+03  1.32530698e+03  1.32530698e+03  2.81095953e+03
  3.01091145e+03  3.01091145e+03  3.01091145e+03  6.62577556e+03
  6.62577556e+03  6.62577556e+03  9.23104057e+03  2.55772002e+04
  7.63063403e+04]
E1 = -728.3093977776218  E_coul = 201.5632487467291
cycle= 5 E= -526.746149030893  delta_E= -1.49e-09  |g|= 1.99e-05  |ddm|= 0.000149
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.79184e-05
diis-c [-6.61253941e-11  1.40385627e-05 -1.84748244e-03 -1.37943914e-02
  4.28298395e-02  9.72797996e-01]
  HOMO = -0.582902445480261  LUMO = 1.01489295356196
  mo_energy =
[-1.18580170e+02 -1.23096847e+01 -9.56092484e+00 -9.56092484e+00
 -9.56092484e+00 -1.27007469e+00 -5.82902445e-01 -5.82902445e-01
 -5.82902445e-01  1.01489295e+00  1.01489295e+00  1.01489295e+00
  1.04320753e+00  7.28607547e+00  7.28607547e+00  7.28607547e+00
  1.35654348e+01  3.33645997e+01  3.33645997e+01  3.33645997e+01
  1.22607342e+02  1.28488013e+02  1.28488013e+02  1.28488013e+02
  4.80131410e+02  4.80131410e+02  4.80131410e+02  6.65161074e+02
  1.32530695e+03  1.32530695e+03  1.32530695e+03  2.81095950e+03
  3.01091142e+03  3.01091142e+03  3.01091142e+03  6.62577553e+03
  6.62577553e+03  6.62577553e+03  9.23104054e+03  2.55772002e+04
  7.63063402e+04]
E1 = -728.3094766230656  E_coul = 201.56332759212103
cycle= 6 E= -526.746149030945  delta_E= -5.18e-11  |g|= 1.67e-06  |ddm|= 1.75e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3094766230656  E_coul = 201.56332759212103
  HOMO = -0.582902475827122  LUMO = 1.01489298586698
  mo_energy =
[-1.18580170e+02 -1.23096846e+01 -9.56092485e+00 -9.56092485e+00
 -9.56092485e+00 -1.27007435e+00 -5.82902476e-01 -5.82902476e-01
 -5.82902476e-01  1.01489299e+00  1.01489299e+00  1.01489299e+00
  1.04320785e+00  7.28607548e+00  7.28607548e+00  7.28607548e+00
  1.35654349e+01  3.33645997e+01  3.33645997e+01  3.33645997e+01
  1.22607342e+02  1.28488013e+02  1.28488013e+02  1.28488013e+02
  4.80131410e+02  4.80131410e+02  4.80131410e+02  6.65161074e+02
  1.32530695e+03  1.32530695e+03  1.32530695e+03  2.81095950e+03
  3.01091142e+03  3.01091142e+03  3.01091142e+03  6.62577553e+03
  6.62577553e+03  6.62577553e+03  9.23104054e+03  2.55772002e+04
  7.63063402e+04]
E1 = -728.3094759315437  E_coul = 201.56332690059648
Extra cycle  E= -526.746149030947  delta_E= -2.61e-12  |g|= 3.42e-07  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93670.4895817261
E1 = -728.3094759315437  E_coul = 201.56332690059648
init E= -526.746149030947
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582902499529675  LUMO = 1.01489298026194
  mo_energy =
[-1.18580170e+02 -1.23096846e+01 -9.56092491e+00 -9.56092491e+00
 -9.56092491e+00 -1.27007431e+00 -5.82902500e-01 -5.82902500e-01
 -5.82902500e-01  1.01489298e+00  1.01489298e+00  1.01489298e+00
  1.04320790e+00  7.28607544e+00  7.28607544e+00  7.28607544e+00
  1.35654349e+01  3.33645996e+01  3.33645996e+01  3.33645996e+01
  1.22607342e+02  1.28488013e+02  1.28488013e+02  1.28488013e+02
  4.80131410e+02  4.80131410e+02  4.80131410e+02  6.65161074e+02
  1.32530695e+03  1.32530695e+03  1.32530695e+03  2.81095950e+03
  3.01091142e+03  3.01091142e+03  3.01091142e+03  6.62577553e+03
  6.62577553e+03  6.62577553e+03  9.23104054e+03  2.55772002e+04
  7.63063402e+04]
E1 = -728.3094760302498  E_coul = 201.56332699930334
cycle= 1 E= -526.746149030947  delta_E= 6.82e-13  |g|= 7.08e-08  |ddm|= 5.68e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3094760302498  E_coul = 201.56332699930334
  HOMO = -0.58290249987406  LUMO = 1.01489298234658
  mo_energy =
[-1.18580170e+02 -1.23096846e+01 -9.56092491e+00 -9.56092491e+00
 -9.56092491e+00 -1.27007429e+00 -5.82902500e-01 -5.82902500e-01
 -5.82902500e-01  1.01489298e+00  1.01489298e+00  1.01489298e+00
  1.04320792e+00  7.28607544e+00  7.28607544e+00  7.28607544e+00
  1.35654349e+01  3.33645996e+01  3.33645996e+01  3.33645996e+01
  1.22607342e+02  1.28488013e+02  1.28488013e+02  1.28488013e+02
  4.80131410e+02  4.80131410e+02  4.80131410e+02  6.65161074e+02
  1.32530695e+03  1.32530695e+03  1.32530695e+03  2.81095950e+03
  3.01091142e+03  3.01091142e+03  3.01091142e+03  6.62577553e+03
  6.62577553e+03  6.62577553e+03  9.23104054e+03  2.55772002e+04
  7.63063402e+04]
E1 = -728.3094759827976  E_coul = 201.5633269518506
Extra cycle  E= -526.746149030947  delta_E= -4.55e-13  |g|= 1.42e-08  |ddm|= 1.18e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828753e+04 7.61703266e+03 3.61756649e+03 1.58712904e+03
 4.18513793e+02 1.22597876e+02 3.94751984e+01 8.50027719e+00
 3.35739404e+00 6.76183387e-01 2.50407397e-01 1.36285863e+03
 6.64051218e+02 2.97703794e+02 3.11237629e+02 6.13606876e+01
 7.32579888e+00 2.01786181e+01 7.75965048e-01 2.81522328e+00
 2.22766003e-01]
grad_E = [-1.39570262e-06  2.14554459e-06 -2.14378566e-06  3.66265691e-05
  1.08364982e-05  1.88998608e-08  8.36892867e-06 -4.64284654e-05
  1.62509736e-04  2.55090077e-04 -1.61424468e-04 -5.22813594e-07
  4.98879133e-06  2.37200369e-05  2.02911850e-05 -1.43708975e-05
 -9.00432164e-06 -3.16225208e-05  5.96111391e-04  2.76621337e-04
 -1.50838851e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8781054        1
[INPUT] 0    0    [1    /1   ]  7617.02920836        1
[INPUT] 0    0    [1    /1   ]  3617.57153809        1
[INPUT] 0    0    [1    /1   ]  1587.08394278        1
[INPUT] 0    0    [1    /1   ]  418.264607269        1
[INPUT] 0    0    [1    /1   ]  122.533888293        1
[INPUT] 0    0    [1    /1   ]  39.4642634666        1
[INPUT] 0    0    [1    /1   ]  8.49815837894        1
[INPUT] 0    0    [1    /1   ]  3.3576900059         1
[INPUT] 0    0    [1    /1   ]  0.677466238717       1
[INPUT] 0    0    [1    /1   ]  0.250797851081       1
[INPUT] 1    0    [1    /1   ]  1362.85967275        1
[INPUT] 1    0    [1    /1   ]  664.039735034        1
[INPUT] 1    0    [1    /1   ]  297.648271242        1
[INPUT] 1    0    [1    /1   ]  311.190192654        1
[INPUT] 1    0    [1    /1   ]  61.4793337801        1
[INPUT] 1    0    [1    /1   ]  7.34650174902        1
[INPUT] 1    0    [1    /1   ]  20.2259420315        1
[INPUT] 1    0    [1    /1   ]  0.777062016473       1
[INPUT] 1    0    [1    /1   ]  2.82423580865        1
[INPUT] 1    0    [1    /1   ]  0.222972763109       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.878105407806, 1.0]], [0, [7617.02920836003, 1.0]], [0, [3617.571538090642, 1.0]], [0, [1587.0839427785356, 1.0]], [0, [418.2646072694815, 1.0]], [0, [122.53388829299224, 1.0]], [0, [39.464263466617595, 1.0]], [0, [8.498158378936848, 1.0]], [0, [3.3576900058985624, 1.0]], [0, [0.6774662387174757, 1.0]], [0, [0.2507978510813486, 1.0]], [1, [1362.859672753917, 1.0]], [1, [664.0397350344874, 1.0]], [1, [297.64827124247734, 1.0]], [1, [311.19019265363187, 1.0]], [1, [61.479333780123255, 1.0]], [1, [7.346501749023999, 1.0]], [1, [20.22594203150934, 1.0]], [1, [0.7770620164729554, 1.0]], [1, [2.824235808647237, 1.0]], [1, [0.22297276310868244, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87810541]
bas 1, expnt(s) = [7617.02920836]
bas 2, expnt(s) = [3617.57153809]
bas 3, expnt(s) = [1587.08394278]
bas 4, expnt(s) = [418.26460727]
bas 5, expnt(s) = [122.53388829]
bas 6, expnt(s) = [39.46426347]
bas 7, expnt(s) = [8.49815838]
bas 8, expnt(s) = [3.35769001]
bas 9, expnt(s) = [0.67746624]
bas 10, expnt(s) = [0.25079785]
bas 11, expnt(s) = [1362.85967275]
bas 12, expnt(s) = [664.03973503]
bas 13, expnt(s) = [297.64827124]
bas 14, expnt(s) = [311.19019265]
bas 15, expnt(s) = [61.47933378]
bas 16, expnt(s) = [7.34650175]
bas 17, expnt(s) = [20.22594203]
bas 18, expnt(s) = [0.77706202]
bas 19, expnt(s) = [2.82423581]
bas 20, expnt(s) = [0.22297276]
CPU time:       616.27
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828781e+04 5.20029597e+03 7.61702921e+03 2.05993843e+03
 3.61757154e+03 1.17849534e+03 1.58708394e+03 6.35279656e+02
 4.18264607e+02 2.33670217e+02 1.22533888e+02 9.30480306e+01
 3.94642635e+01 3.97802974e+01 8.49815838e+00 1.25750187e+01
 3.35769001e+00 6.26679478e+00 6.77466239e-01 1.88660407e+00
 2.50797851e-01 8.95381017e-01 1.36285967e+03 2.41572959e+04
 6.64039735e+02 9.83392693e+03 2.97648271e+02 3.60672972e+03
 3.11190193e+02 3.81299968e+03 6.14793338e+01 5.02222116e+02
 7.34650175e+00 3.52845941e+01 2.02259420e+01 1.25132563e+02
 7.77062016e-01 2.12840364e+00 2.82423581e+00 1.06809673e+01
 2.22972763e-01 4.46991395e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993412800326016
cond(S) = 93689.50752636779
E1 = -729.5316706234738  E_coul = 203.17996054845744
init E= -526.351710075016
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555776217374832  LUMO = 1.0352332624933
  mo_energy =
[-1.18331945e+02 -1.22047243e+01 -9.44671687e+00 -9.44671687e+00
 -9.44671687e+00 -1.23992735e+00 -5.55776217e-01 -5.55776217e-01
 -5.55776217e-01  1.03523326e+00  1.03523326e+00  1.03523326e+00
  1.06864411e+00  7.38266341e+00  7.38266341e+00  7.38266341e+00
  1.36587961e+01  3.35999677e+01  3.35999677e+01  3.35999677e+01
  1.22737011e+02  1.29012255e+02  1.29012255e+02  1.29012255e+02
  4.80920551e+02  4.80920551e+02  4.80920551e+02  6.65080302e+02
  1.32608619e+03  1.32608619e+03  1.32608619e+03  2.81045193e+03
  3.01160144e+03  3.01160144e+03  3.01160144e+03  6.62644096e+03
  6.62644096e+03  6.62644096e+03  9.23035714e+03  2.55765279e+04
  7.63057934e+04]
E1 = -727.8673944885323  E_coul = 201.12200722259496
cycle= 1 E= -526.745387265937  delta_E= -0.394  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537655
diis-c [-0.2890725  1.       ]
  HOMO = -0.590450090719491  LUMO = 1.0110325268154
  mo_energy =
[-1.18637346e+02 -1.23416648e+01 -9.59419493e+00 -9.59419493e+00
 -9.59419493e+00 -1.27923240e+00 -5.90450091e-01 -5.90450091e-01
 -5.90450091e-01  1.01103253e+00  1.01103253e+00  1.01103253e+00
  1.03906746e+00  7.29220261e+00  7.29220261e+00  7.29220261e+00
  1.35452705e+01  3.34470150e+01  3.34470150e+01  3.34470150e+01
  1.22508873e+02  1.28785890e+02  1.28785890e+02  1.28785890e+02
  4.80617111e+02  4.80617111e+02  4.80617111e+02  6.64729606e+02
  1.32572718e+03  1.32572718e+03  1.32572718e+03  2.80995845e+03
  3.01117694e+03  3.01117694e+03  3.01117694e+03  6.62590462e+03
  6.62590462e+03  6.62590462e+03  9.22974748e+03  2.55758246e+04
  7.63050004e+04]
E1 = -728.4369801762726  E_coul = 201.69088545451848
cycle= 2 E= -526.746094721754  delta_E= -0.000707  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745991
diis-c [-0.00326055  0.08239515  0.91760485]
  HOMO = -0.581400970767486  LUMO = 1.01772433594235
  mo_energy =
[-1.18570204e+02 -1.23039054e+01 -9.55478960e+00 -9.55478960e+00
 -9.55478960e+00 -1.26840336e+00 -5.81400971e-01 -5.81400971e-01
 -5.81400971e-01  1.01772434e+00  1.01772434e+00  1.01772434e+00
  1.04750550e+00  7.31582174e+00  7.31582174e+00  7.31582174e+00
  1.35762802e+01  3.34867754e+01  3.34867754e+01  3.34867754e+01
  1.22565793e+02  1.28841284e+02  1.28841284e+02  1.28841284e+02
  4.80683382e+02  4.80683382e+02  4.80683382e+02  6.64798851e+02
  1.32579749e+03  1.32579749e+03  1.32579749e+03  2.81003214e+03
  3.01124950e+03  3.01124950e+03  3.01124950e+03  6.62597893e+03
  6.62597893e+03  6.62597893e+03  9.22982260e+03  2.55759002e+04
  7.63050764e+04]
E1 = -728.2877670669835  E_coul = 201.5416143135914
cycle= 3 E= -526.746152753392  delta_E= -5.8e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130705
diis-c [-5.34594027e-07 -1.21811550e-03  1.44751599e-01  8.56466516e-01]
  HOMO = -0.582887924234742  LUMO = 1.01664808863978
  mo_energy =
[-1.18580091e+02 -1.23096733e+01 -9.56089932e+00 -9.56089932e+00
 -9.56089932e+00 -1.27008589e+00 -5.82887924e-01 -5.82887924e-01
 -5.82887924e-01  1.01664809e+00  1.01664809e+00  1.01664809e+00
  1.04621317e+00  7.31206511e+00  7.31206511e+00  7.31206511e+00
  1.35715201e+01  3.34806492e+01  3.34806492e+01  3.34806492e+01
  1.22557350e+02  1.28833002e+02  1.28833002e+02  1.28833002e+02
  4.80673619e+02  4.80673619e+02  4.80673619e+02  6.64788642e+02
  1.32578714e+03  1.32578714e+03  1.32578714e+03  2.81002115e+03
  3.01123877e+03  3.01123877e+03  3.01123877e+03  6.62596781e+03
  6.62596781e+03  6.62596781e+03  9.22981127e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3104168271175  E_coul = 201.56426217833064
cycle= 4 E= -526.746154648787  delta_E= -1.9e-06  |g|= 9.3e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107285
diis-c [-3.81772648e-09  6.71537181e-05 -9.74617579e-03 -6.32316749e-02
  1.07291070e+00]
  HOMO = -0.582869600196504  LUMO = 1.01666373700151
  mo_energy =
[-1.18580051e+02 -1.23096099e+01 -9.56084869e+00 -9.56084869e+00
 -9.56084869e+00 -1.27004625e+00 -5.82869600e-01 -5.82869600e-01
 -5.82869600e-01  1.01666374e+00  1.01666374e+00  1.01666374e+00
  1.04624697e+00  7.31210635e+00  7.31210635e+00  7.31210635e+00
  1.35715788e+01  3.34806978e+01  3.34806978e+01  3.34806978e+01
  1.22557400e+02  1.28833049e+02  1.28833049e+02  1.28833049e+02
  4.80673659e+02  4.80673659e+02  4.80673659e+02  6.64788674e+02
  1.32578717e+03  1.32578717e+03  1.32578717e+03  2.81002117e+03
  3.01123879e+03  3.01123879e+03  3.01123879e+03  6.62596781e+03
  6.62596781e+03  6.62596781e+03  9.22981127e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3102097833722  E_coul = 201.56405513310136
cycle= 5 E= -526.746154650271  delta_E= -1.48e-09  |g|= 1.99e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.7889e-05
diis-c [-6.59172389e-11  1.40141734e-05 -1.84464723e-03 -1.37771009e-02
  4.28917241e-02  9.72716010e-01]
  HOMO = -0.58287669990718  LUMO = 1.01665901506492
  mo_energy =
[-1.18580081e+02 -1.23096315e+01 -9.56087220e+00 -9.56087220e+00
 -9.56087220e+00 -1.27005193e+00 -5.82876700e-01 -5.82876700e-01
 -5.82876700e-01  1.01665902e+00  1.01665902e+00  1.01665902e+00
  1.04624302e+00  7.31209042e+00  7.31209042e+00  7.31209042e+00
  1.35715608e+01  3.34806750e+01  3.34806750e+01  3.34806750e+01
  1.22557373e+02  1.28833022e+02  1.28833022e+02  1.28833022e+02
  4.80673630e+02  4.80673630e+02  4.80673630e+02  6.64788644e+02
  1.32578714e+03  1.32578714e+03  1.32578714e+03  2.81002113e+03
  3.01123876e+03  3.01123876e+03  3.01123876e+03  6.62596778e+03
  6.62596778e+03  6.62596778e+03  9.22981124e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3102885557812  E_coul = 201.56413390545708
cycle= 6 E= -526.746154650324  delta_E= -5.32e-11  |g|= 1.67e-06  |ddm|= 1.74e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3102885557812  E_coul = 201.56413390545708
  HOMO = -0.58287673002757  LUMO = 1.01665904740204
  mo_energy =
[-1.18580081e+02 -1.23096314e+01 -9.56087220e+00 -9.56087220e+00
 -9.56087220e+00 -1.27005159e+00 -5.82876730e-01 -5.82876730e-01
 -5.82876730e-01  1.01665905e+00  1.01665905e+00  1.01665905e+00
  1.04624334e+00  7.31209043e+00  7.31209043e+00  7.31209043e+00
  1.35715610e+01  3.34806750e+01  3.34806750e+01  3.34806750e+01
  1.22557373e+02  1.28833022e+02  1.28833022e+02  1.28833022e+02
  4.80673630e+02  4.80673630e+02  4.80673630e+02  6.64788644e+02
  1.32578714e+03  1.32578714e+03  1.32578714e+03  2.81002113e+03
  3.01123876e+03  3.01123876e+03  3.01123876e+03  6.62596778e+03
  6.62596778e+03  6.62596778e+03  9.22981124e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3102878665057  E_coul = 201.56413321618237
Extra cycle  E= -526.746154650323  delta_E= 6.82e-13  |g|= 3.42e-07  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828781e+04 7.61702921e+03 3.61757154e+03 1.58708394e+03
 4.18264607e+02 1.22533888e+02 3.94642635e+01 8.49815838e+00
 3.35769001e+00 6.77466239e-01 2.50797851e-01 1.36285967e+03
 6.64039735e+02 2.97648271e+02 3.11190193e+02 6.14793338e+01
 7.34650175e+00 2.02259420e+01 7.77062016e-01 2.82423581e+00
 2.22972763e-01]
E = -526.7461546503234
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8781054        1
[INPUT] 0    0    [1    /1   ]  7617.02920836        1
[INPUT] 0    0    [1    /1   ]  3617.57153809        1
[INPUT] 0    0    [1    /1   ]  1587.08394278        1
[INPUT] 0    0    [1    /1   ]  418.264607269        1
[INPUT] 0    0    [1    /1   ]  122.533888293        1
[INPUT] 0    0    [1    /1   ]  39.4642634666        1
[INPUT] 0    0    [1    /1   ]  8.49815837894        1
[INPUT] 0    0    [1    /1   ]  3.3576900059         1
[INPUT] 0    0    [1    /1   ]  0.677466238717       1
[INPUT] 0    0    [1    /1   ]  0.250797851081       1
[INPUT] 1    0    [1    /1   ]  1362.85967275        1
[INPUT] 1    0    [1    /1   ]  664.039735034        1
[INPUT] 1    0    [1    /1   ]  297.648271242        1
[INPUT] 1    0    [1    /1   ]  311.190192654        1
[INPUT] 1    0    [1    /1   ]  61.4793337801        1
[INPUT] 1    0    [1    /1   ]  7.34650174902        1
[INPUT] 1    0    [1    /1   ]  20.2259420315        1
[INPUT] 1    0    [1    /1   ]  0.777062016473       1
[INPUT] 1    0    [1    /1   ]  2.82423580865        1
[INPUT] 1    0    [1    /1   ]  0.222972763109       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.878105407806, 1.0]], [0, [7617.02920836003, 1.0]], [0, [3617.571538090642, 1.0]], [0, [1587.0839427785356, 1.0]], [0, [418.2646072694815, 1.0]], [0, [122.53388829299224, 1.0]], [0, [39.464263466617595, 1.0]], [0, [8.498158378936848, 1.0]], [0, [3.3576900058985624, 1.0]], [0, [0.6774662387174757, 1.0]], [0, [0.2507978510813486, 1.0]], [1, [1362.859672753917, 1.0]], [1, [664.0397350344874, 1.0]], [1, [297.64827124247734, 1.0]], [1, [311.19019265363187, 1.0]], [1, [61.479333780123255, 1.0]], [1, [7.346501749023999, 1.0]], [1, [20.22594203150934, 1.0]], [1, [0.7770620164729554, 1.0]], [1, [2.824235808647237, 1.0]], [1, [0.22297276310868244, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.87810541]
bas 1, expnt(s) = [7617.02920836]
bas 2, expnt(s) = [3617.57153809]
bas 3, expnt(s) = [1587.08394278]
bas 4, expnt(s) = [418.26460727]
bas 5, expnt(s) = [122.53388829]
bas 6, expnt(s) = [39.46426347]
bas 7, expnt(s) = [8.49815838]
bas 8, expnt(s) = [3.35769001]
bas 9, expnt(s) = [0.67746624]
bas 10, expnt(s) = [0.25079785]
bas 11, expnt(s) = [1362.85967275]
bas 12, expnt(s) = [664.03973503]
bas 13, expnt(s) = [297.64827124]
bas 14, expnt(s) = [311.19019265]
bas 15, expnt(s) = [61.47933378]
bas 16, expnt(s) = [7.34650175]
bas 17, expnt(s) = [20.22594203]
bas 18, expnt(s) = [0.77706202]
bas 19, expnt(s) = [2.82423581]
bas 20, expnt(s) = [0.22297276]
CPU time:       616.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828781e+04 5.20029597e+03 7.61702921e+03 2.05993843e+03
 3.61757154e+03 1.17849534e+03 1.58708394e+03 6.35279656e+02
 4.18264607e+02 2.33670217e+02 1.22533888e+02 9.30480306e+01
 3.94642635e+01 3.97802974e+01 8.49815838e+00 1.25750187e+01
 3.35769001e+00 6.26679478e+00 6.77466239e-01 1.88660407e+00
 2.50797851e-01 8.95381017e-01 1.36285967e+03 2.41572959e+04
 6.64039735e+02 9.83392693e+03 2.97648271e+02 3.60672972e+03
 3.11190193e+02 3.81299968e+03 6.14793338e+01 5.02222116e+02
 7.34650175e+00 3.52845941e+01 2.02259420e+01 1.25132563e+02
 7.77062016e-01 2.12840364e+00 2.82423581e+00 1.06809673e+01
 2.22972763e-01 4.46991395e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993412800326016
cond(S) = 93689.50752636779
E1 = -729.5316706234738  E_coul = 203.17996054845744
init E= -526.351710075016
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555776217374832  LUMO = 1.0352332624933
  mo_energy =
[-1.18331945e+02 -1.22047243e+01 -9.44671687e+00 -9.44671687e+00
 -9.44671687e+00 -1.23992735e+00 -5.55776217e-01 -5.55776217e-01
 -5.55776217e-01  1.03523326e+00  1.03523326e+00  1.03523326e+00
  1.06864411e+00  7.38266341e+00  7.38266341e+00  7.38266341e+00
  1.36587961e+01  3.35999677e+01  3.35999677e+01  3.35999677e+01
  1.22737011e+02  1.29012255e+02  1.29012255e+02  1.29012255e+02
  4.80920551e+02  4.80920551e+02  4.80920551e+02  6.65080302e+02
  1.32608619e+03  1.32608619e+03  1.32608619e+03  2.81045193e+03
  3.01160144e+03  3.01160144e+03  3.01160144e+03  6.62644096e+03
  6.62644096e+03  6.62644096e+03  9.23035714e+03  2.55765279e+04
  7.63057934e+04]
E1 = -727.8673944885323  E_coul = 201.12200722259496
cycle= 1 E= -526.745387265937  delta_E= -0.394  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537655
diis-c [-0.2890725  1.       ]
  HOMO = -0.590450090719491  LUMO = 1.0110325268154
  mo_energy =
[-1.18637346e+02 -1.23416648e+01 -9.59419493e+00 -9.59419493e+00
 -9.59419493e+00 -1.27923240e+00 -5.90450091e-01 -5.90450091e-01
 -5.90450091e-01  1.01103253e+00  1.01103253e+00  1.01103253e+00
  1.03906746e+00  7.29220261e+00  7.29220261e+00  7.29220261e+00
  1.35452705e+01  3.34470150e+01  3.34470150e+01  3.34470150e+01
  1.22508873e+02  1.28785890e+02  1.28785890e+02  1.28785890e+02
  4.80617111e+02  4.80617111e+02  4.80617111e+02  6.64729606e+02
  1.32572718e+03  1.32572718e+03  1.32572718e+03  2.80995845e+03
  3.01117694e+03  3.01117694e+03  3.01117694e+03  6.62590462e+03
  6.62590462e+03  6.62590462e+03  9.22974748e+03  2.55758246e+04
  7.63050004e+04]
E1 = -728.4369801762726  E_coul = 201.69088545451848
cycle= 2 E= -526.746094721754  delta_E= -0.000707  |g|= 0.0373  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745991
diis-c [-0.00326055  0.08239515  0.91760485]
  HOMO = -0.581400970767486  LUMO = 1.01772433594235
  mo_energy =
[-1.18570204e+02 -1.23039054e+01 -9.55478960e+00 -9.55478960e+00
 -9.55478960e+00 -1.26840336e+00 -5.81400971e-01 -5.81400971e-01
 -5.81400971e-01  1.01772434e+00  1.01772434e+00  1.01772434e+00
  1.04750550e+00  7.31582174e+00  7.31582174e+00  7.31582174e+00
  1.35762802e+01  3.34867754e+01  3.34867754e+01  3.34867754e+01
  1.22565793e+02  1.28841284e+02  1.28841284e+02  1.28841284e+02
  4.80683382e+02  4.80683382e+02  4.80683382e+02  6.64798851e+02
  1.32579749e+03  1.32579749e+03  1.32579749e+03  2.81003214e+03
  3.01124950e+03  3.01124950e+03  3.01124950e+03  6.62597893e+03
  6.62597893e+03  6.62597893e+03  9.22982260e+03  2.55759002e+04
  7.63050764e+04]
E1 = -728.2877670669835  E_coul = 201.5416143135914
cycle= 3 E= -526.746152753392  delta_E= -5.8e-05  |g|= 0.00624  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130705
diis-c [-5.34594027e-07 -1.21811550e-03  1.44751599e-01  8.56466516e-01]
  HOMO = -0.582887924234742  LUMO = 1.01664808863978
  mo_energy =
[-1.18580091e+02 -1.23096733e+01 -9.56089932e+00 -9.56089932e+00
 -9.56089932e+00 -1.27008589e+00 -5.82887924e-01 -5.82887924e-01
 -5.82887924e-01  1.01664809e+00  1.01664809e+00  1.01664809e+00
  1.04621317e+00  7.31206511e+00  7.31206511e+00  7.31206511e+00
  1.35715201e+01  3.34806492e+01  3.34806492e+01  3.34806492e+01
  1.22557350e+02  1.28833002e+02  1.28833002e+02  1.28833002e+02
  4.80673619e+02  4.80673619e+02  4.80673619e+02  6.64788642e+02
  1.32578714e+03  1.32578714e+03  1.32578714e+03  2.81002115e+03
  3.01123877e+03  3.01123877e+03  3.01123877e+03  6.62596781e+03
  6.62596781e+03  6.62596781e+03  9.22981127e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3104168271175  E_coul = 201.56426217833064
cycle= 4 E= -526.746154648787  delta_E= -1.9e-06  |g|= 9.3e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107285
diis-c [-3.81772648e-09  6.71537181e-05 -9.74617579e-03 -6.32316749e-02
  1.07291070e+00]
  HOMO = -0.582869600196504  LUMO = 1.01666373700151
  mo_energy =
[-1.18580051e+02 -1.23096099e+01 -9.56084869e+00 -9.56084869e+00
 -9.56084869e+00 -1.27004625e+00 -5.82869600e-01 -5.82869600e-01
 -5.82869600e-01  1.01666374e+00  1.01666374e+00  1.01666374e+00
  1.04624697e+00  7.31210635e+00  7.31210635e+00  7.31210635e+00
  1.35715788e+01  3.34806978e+01  3.34806978e+01  3.34806978e+01
  1.22557400e+02  1.28833049e+02  1.28833049e+02  1.28833049e+02
  4.80673659e+02  4.80673659e+02  4.80673659e+02  6.64788674e+02
  1.32578717e+03  1.32578717e+03  1.32578717e+03  2.81002117e+03
  3.01123879e+03  3.01123879e+03  3.01123879e+03  6.62596781e+03
  6.62596781e+03  6.62596781e+03  9.22981127e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3102097833722  E_coul = 201.56405513310136
cycle= 5 E= -526.746154650271  delta_E= -1.48e-09  |g|= 1.99e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.7889e-05
diis-c [-6.59172389e-11  1.40141734e-05 -1.84464723e-03 -1.37771009e-02
  4.28917241e-02  9.72716010e-01]
  HOMO = -0.58287669990718  LUMO = 1.01665901506492
  mo_energy =
[-1.18580081e+02 -1.23096315e+01 -9.56087220e+00 -9.56087220e+00
 -9.56087220e+00 -1.27005193e+00 -5.82876700e-01 -5.82876700e-01
 -5.82876700e-01  1.01665902e+00  1.01665902e+00  1.01665902e+00
  1.04624302e+00  7.31209042e+00  7.31209042e+00  7.31209042e+00
  1.35715608e+01  3.34806750e+01  3.34806750e+01  3.34806750e+01
  1.22557373e+02  1.28833022e+02  1.28833022e+02  1.28833022e+02
  4.80673630e+02  4.80673630e+02  4.80673630e+02  6.64788644e+02
  1.32578714e+03  1.32578714e+03  1.32578714e+03  2.81002113e+03
  3.01123876e+03  3.01123876e+03  3.01123876e+03  6.62596778e+03
  6.62596778e+03  6.62596778e+03  9.22981124e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3102885557812  E_coul = 201.56413390545708
cycle= 6 E= -526.746154650324  delta_E= -5.32e-11  |g|= 1.67e-06  |ddm|= 1.74e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3102885557812  E_coul = 201.56413390545708
  HOMO = -0.58287673002757  LUMO = 1.01665904740204
  mo_energy =
[-1.18580081e+02 -1.23096314e+01 -9.56087220e+00 -9.56087220e+00
 -9.56087220e+00 -1.27005159e+00 -5.82876730e-01 -5.82876730e-01
 -5.82876730e-01  1.01665905e+00  1.01665905e+00  1.01665905e+00
  1.04624334e+00  7.31209043e+00  7.31209043e+00  7.31209043e+00
  1.35715610e+01  3.34806750e+01  3.34806750e+01  3.34806750e+01
  1.22557373e+02  1.28833022e+02  1.28833022e+02  1.28833022e+02
  4.80673630e+02  4.80673630e+02  4.80673630e+02  6.64788644e+02
  1.32578714e+03  1.32578714e+03  1.32578714e+03  2.81002113e+03
  3.01123876e+03  3.01123876e+03  3.01123876e+03  6.62596778e+03
  6.62596778e+03  6.62596778e+03  9.22981124e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3102878665057  E_coul = 201.56413321618237
Extra cycle  E= -526.746154650323  delta_E= 6.82e-13  |g|= 3.42e-07  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93689.50752636779
E1 = -728.3102878665057  E_coul = 201.56413321618237
init E= -526.746154650323
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582876753645975  LUMO = 1.01665904180132
  mo_energy =
[-1.18580081e+02 -1.23096315e+01 -9.56087227e+00 -9.56087227e+00
 -9.56087227e+00 -1.27005154e+00 -5.82876754e-01 -5.82876754e-01
 -5.82876754e-01  1.01665904e+00  1.01665904e+00  1.01665904e+00
  1.04624339e+00  7.31209039e+00  7.31209039e+00  7.31209039e+00
  1.35715609e+01  3.34806750e+01  3.34806750e+01  3.34806750e+01
  1.22557373e+02  1.28833022e+02  1.28833022e+02  1.28833022e+02
  4.80673630e+02  4.80673630e+02  4.80673630e+02  6.64788644e+02
  1.32578714e+03  1.32578714e+03  1.32578714e+03  2.81002113e+03
  3.01123876e+03  3.01123876e+03  3.01123876e+03  6.62596778e+03
  6.62596778e+03  6.62596778e+03  9.22981124e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.3102879649664  E_coul = 201.56413331464128
cycle= 1 E= -526.746154650325  delta_E= -1.71e-12  |g|= 7.07e-08  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3102879649664  E_coul = 201.56413331464128
  HOMO = -0.582876753982933  LUMO = 1.01665904388465
  mo_energy =
[-1.18580081e+02 -1.23096315e+01 -9.56087227e+00 -9.56087227e+00
 -9.56087227e+00 -1.27005153e+00 -5.82876754e-01 -5.82876754e-01
 -5.82876754e-01  1.01665904e+00  1.01665904e+00  1.01665904e+00
  1.04624340e+00  7.31209039e+00  7.31209039e+00  7.31209039e+00
  1.35715610e+01  3.34806750e+01  3.34806750e+01  3.34806750e+01
  1.22557373e+02  1.28833022e+02  1.28833022e+02  1.28833022e+02
  4.80673630e+02  4.80673630e+02  4.80673630e+02  6.64788644e+02
  1.32578714e+03  1.32578714e+03  1.32578714e+03  2.81002113e+03
  3.01123876e+03  3.01123876e+03  3.01123876e+03  6.62596778e+03
  6.62596778e+03  6.62596778e+03  9.22981124e+03  2.55758887e+04
  7.63050647e+04]
E1 = -728.310287917679  E_coul = 201.5641332673539
Extra cycle  E= -526.746154650325  delta_E=    0  |g|= 1.42e-08  |ddm|= 1.17e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828781e+04 7.61702921e+03 3.61757154e+03 1.58708394e+03
 4.18264607e+02 1.22533888e+02 3.94642635e+01 8.49815838e+00
 3.35769001e+00 6.77466239e-01 2.50797851e-01 1.36285967e+03
 6.64039735e+02 2.97648271e+02 3.11190193e+02 6.14793338e+01
 7.34650175e+00 2.02259420e+01 7.77062016e-01 2.82423581e+00
 2.22972763e-01]
grad_E = [-1.39662130e-06  2.15304589e-06 -2.14463626e-06  3.68575846e-05
  9.41512415e-06 -2.25419281e-06  1.31488471e-05 -7.90434495e-05
  2.75335277e-04  4.27869787e-04 -2.67057777e-04 -5.28985057e-07
  4.91264027e-06  2.32987101e-05  1.99232584e-05 -6.95601136e-06
 -1.18869047e-05 -4.81482670e-05  9.78161051e-04  4.58291097e-04
 -2.47791423e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8893111        1
[INPUT] 0    0    [1    /1   ]  7617.01332992        1
[INPUT] 0    0    [1    /1   ]  3617.58977765        1
[INPUT] 0    0    [1    /1   ]  1586.83381152        1
[INPUT] 0    0    [1    /1   ]  417.83686806         1
[INPUT] 0    0    [1    /1   ]  122.425946174        1
[INPUT] 0    0    [1    /1   ]  39.4457731122        1
[INPUT] 0    0    [1    /1   ]  8.4946509835         1
[INPUT] 0    0    [1    /1   ]  3.35816185544        1
[INPUT] 0    0    [1    /1   ]  0.679593841099       1
[INPUT] 0    0    [1    /1   ]  0.251441616914       1
[INPUT] 1    0    [1    /1   ]  1362.86388279        1
[INPUT] 1    0    [1    /1   ]  663.998338544        1
[INPUT] 1    0    [1    /1   ]  297.45061115         1
[INPUT] 1    0    [1    /1   ]  311.021203431        1
[INPUT] 1    0    [1    /1   ]  61.6625938637        1
[INPUT] 1    0    [1    /1   ]  7.37916347155        1
[INPUT] 1    0    [1    /1   ]  20.3000505798        1
[INPUT] 1    0    [1    /1   ]  0.778793313511       1
[INPUT] 1    0    [1    /1   ]  2.83845614187        1
[INPUT] 1    0    [1    /1   ]  0.22329926021        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.889311087056, 1.0]], [0, [7617.01332992202, 1.0]], [0, [3617.589777652848, 1.0]], [0, [1586.833811521542, 1.0]], [0, [417.836868059549, 1.0]], [0, [122.42594617433002, 1.0]], [0, [39.44577311217063, 1.0]], [0, [8.494650983499383, 1.0]], [0, [3.3581618554417636, 1.0]], [0, [0.6795938410986387, 1.0]], [0, [0.2514416169140319, 1.0]], [1, [1362.8638827932573, 1.0]], [1, [663.9983385437902, 1.0]], [1, [297.4506111495959, 1.0]], [1, [311.02120343100376, 1.0]], [1, [61.66259386373095, 1.0]], [1, [7.379163471547441, 1.0]], [1, [20.300050579837684, 1.0]], [1, [0.778793313510818, 1.0]], [1, [2.8384561418675256, 1.0]], [1, [0.22329926021047322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.88931109]
bas 1, expnt(s) = [7617.01332992]
bas 2, expnt(s) = [3617.58977765]
bas 3, expnt(s) = [1586.83381152]
bas 4, expnt(s) = [417.83686806]
bas 5, expnt(s) = [122.42594617]
bas 6, expnt(s) = [39.44577311]
bas 7, expnt(s) = [8.49465098]
bas 8, expnt(s) = [3.35816186]
bas 9, expnt(s) = [0.67959384]
bas 10, expnt(s) = [0.25144162]
bas 11, expnt(s) = [1362.86388279]
bas 12, expnt(s) = [663.99833854]
bas 13, expnt(s) = [297.45061115]
bas 14, expnt(s) = [311.02120343]
bas 15, expnt(s) = [61.66259386]
bas 16, expnt(s) = [7.37916347]
bas 17, expnt(s) = [20.30005058]
bas 18, expnt(s) = [0.77879331]
bas 19, expnt(s) = [2.83845614]
bas 20, expnt(s) = [0.22329926]
CPU time:       622.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828893e+04 5.20029764e+03 7.61701333e+03 2.05993521e+03
 3.61758978e+03 1.17849980e+03 1.58683381e+03 6.35204562e+02
 4.17836868e+02 2.33490972e+02 1.22425946e+02 9.29865481e+01
 3.94457731e+01 3.97663178e+01 8.49465098e+00 1.25711260e+01
 3.35816186e+00 6.26745526e+00 6.79593841e-01 1.89104603e+00
 2.51441617e-01 8.97104210e-01 1.36286388e+03 2.41573892e+04
 6.63998339e+02 9.83316062e+03 2.97450611e+02 3.60373605e+03
 3.11021203e+02 3.81041159e+03 6.16625939e+01 5.04094118e+02
 7.37916347e+00 3.54807921e+01 2.03000506e+01 1.25705938e+02
 7.78793314e-01 2.13433291e+00 2.83845614e+00 1.07482344e+01
 2.23299260e-01 4.47809701e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993347497970994
cond(S) = 93374.74213494665
E1 = -729.5317866766047  E_coul = 203.18006398544097
init E= -526.351722691164
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.55576210419993  LUMO = 1.0380615272986
  mo_energy =
[-1.18331940e+02 -1.22047238e+01 -9.44672065e+00 -9.44672065e+00
 -9.44672065e+00 -1.23991656e+00 -5.55762104e-01 -5.55762104e-01
 -5.55762104e-01  1.03806153e+00  1.03806153e+00  1.03806153e+00
  1.07372488e+00  7.42396277e+00  7.42396277e+00  7.42396277e+00
  1.36687949e+01  3.37828167e+01  3.37828167e+01  3.37828167e+01
  1.22652179e+02  1.29549101e+02  1.29549101e+02  1.29549101e+02
  4.81687534e+02  4.81687534e+02  4.81687534e+02  6.64443375e+02
  1.32653333e+03  1.32653333e+03  1.32653333e+03  2.80874242e+03
  3.01151641e+03  3.01151641e+03  3.01151641e+03  6.62595459e+03
  6.62595459e+03  6.62595459e+03  9.22789612e+03  2.55737317e+04
  7.63029982e+04]
E1 = -727.8691564509102  E_coul = 201.12375327219956
cycle= 1 E= -526.745403178711  delta_E= -0.394  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537749
diis-c [-0.28917425  1.        ]
  HOMO = -0.590399234905266  LUMO = 1.01381410765033
  mo_energy =
[-1.18637154e+02 -1.23415469e+01 -9.59407665e+00 -9.59407665e+00
 -9.59407665e+00 -1.27918351e+00 -5.90399235e-01 -5.90399235e-01
 -5.90399235e-01  1.01381411e+00  1.01381411e+00  1.01381411e+00
  1.04407861e+00  7.33328861e+00  7.33328861e+00  7.33328861e+00
  1.35553742e+01  3.36297402e+01  3.36297402e+01  3.36297402e+01
  1.22424281e+02  1.29322739e+02  1.29322739e+02  1.29322739e+02
  4.81384325e+02  4.81384325e+02  4.81384325e+02  6.64092963e+02
  1.32617457e+03  1.32617457e+03  1.32617457e+03  2.80824916e+03
  3.01109215e+03  3.01109215e+03  3.01109215e+03  6.62541845e+03
  6.62541845e+03  6.62541845e+03  9.22728665e+03  2.55730286e+04
  7.63022054e+04]
E1 = -728.4381453621132  E_coul = 201.6920357934054
cycle= 2 E= -526.746109568708  delta_E= -0.000706  |g|= 0.0372  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745752
diis-c [-0.0032587   0.08235349  0.91764651]
  HOMO = -0.581362372201015  LUMO = 1.02051824388884
  mo_energy =
[-1.18570070e+02 -1.23038253e+01 -9.55470965e+00 -9.55470965e+00
 -9.55470965e+00 -1.26836885e+00 -5.81362372e-01 -5.81362372e-01
 -5.81362372e-01  1.02051824e+00  1.02051824e+00  1.02051824e+00
  1.05253359e+00  7.35695640e+00  7.35695640e+00  7.35695640e+00
  1.35863469e+01  3.36695226e+01  3.36695226e+01  3.36695226e+01
  1.22481139e+02  1.29378113e+02  1.29378113e+02  1.29378113e+02
  4.81450536e+02  4.81450536e+02  4.81450536e+02  6.64162144e+02
  1.32624482e+03  1.32624482e+03  1.32624482e+03  2.80832279e+03
  3.01116464e+03  3.01116464e+03  3.01116464e+03  6.62549269e+03
  6.62549269e+03  6.62549269e+03  9.22736171e+03  2.55731042e+04
  7.63022813e+04]
E1 = -728.2891193094644  E_coul = 201.54295182819777
cycle= 3 E= -526.746167481267  delta_E= -5.79e-05  |g|= 0.00623  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130653
diis-c [-5.33649532e-07 -1.21796471e-03  1.44740858e-01  8.56477107e-01]
  HOMO = -0.58284721805063  LUMO = 1.0194400700692
  mo_energy =
[-1.18579948e+02 -1.23095871e+01 -9.56081304e+00 -9.56081304e+00
 -9.56081304e+00 -1.27004913e+00 -5.82847218e-01 -5.82847218e-01
 -5.82847218e-01  1.01944007e+00  1.01944007e+00  1.01944007e+00
  1.05123865e+00  7.35319262e+00  7.35319262e+00  7.35319262e+00
  1.35815925e+01  3.36633942e+01  3.36633942e+01  3.36633942e+01
  1.22472706e+02  1.29369834e+02  1.29369834e+02  1.29369834e+02
  4.81440782e+02  4.81440782e+02  4.81440782e+02  6.64151946e+02
  1.32623448e+03  1.32623448e+03  1.32623448e+03  2.80831181e+03
  3.01115392e+03  3.01115392e+03  3.01115392e+03  6.62548158e+03
  6.62548158e+03  6.62548158e+03  9.22735039e+03  2.55730927e+04
  7.63022697e+04]
E1 = -728.3117400283843  E_coul = 201.5655706558561
cycle= 4 E= -526.746169372528  delta_E= -1.89e-06  |g|= 9.28e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107105
diis-c [-3.80087829e-09  6.71078509e-05 -9.74246735e-03 -6.32074336e-02
  1.07288279e+00]
  HOMO = -0.582828891883336  LUMO = 1.01945575259402
  mo_energy =
[-1.18579908e+02 -1.23095237e+01 -9.56076241e+00 -9.56076241e+00
 -9.56076241e+00 -1.27000954e+00 -5.82828892e-01 -5.82828892e-01
 -5.82828892e-01  1.01945575e+00  1.01945575e+00  1.01945575e+00
  1.05127250e+00  7.35323391e+00  7.35323391e+00  7.35323391e+00
  1.35816512e+01  3.36634428e+01  3.36634428e+01  3.36634428e+01
  1.22472756e+02  1.29369882e+02  1.29369882e+02  1.29369882e+02
  4.81440822e+02  4.81440822e+02  4.81440822e+02  6.64151978e+02
  1.32623451e+03  1.32623451e+03  1.32623451e+03  2.80831182e+03
  3.01115394e+03  3.01115394e+03  3.01115394e+03  6.62548159e+03
  6.62548159e+03  6.62548159e+03  9.22735039e+03  2.55730927e+04
  7.63022697e+04]
E1 = -728.3115332083266  E_coul = 201.56536383432226
cycle= 5 E= -526.746169374004  delta_E= -1.48e-09  |g|= 1.99e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.78441e-05
diis-c [-6.55785448e-11  1.39749455e-05 -1.84003520e-03 -1.37492154e-02
  4.29975987e-02  9.72577677e-01]
  HOMO = -0.582835976750023  LUMO = 1.019451024347
  mo_energy =
[-1.18579938e+02 -1.23095453e+01 -9.56078589e+00 -9.56078589e+00
 -9.56078589e+00 -1.27001521e+00 -5.82835977e-01 -5.82835977e-01
 -5.82835977e-01  1.01945102e+00  1.01945102e+00  1.01945102e+00
  1.05126854e+00  7.35321796e+00  7.35321796e+00  7.35321796e+00
  1.35816332e+01  3.36634200e+01  3.36634200e+01  3.36634200e+01
  1.22472729e+02  1.29369855e+02  1.29369855e+02  1.29369855e+02
  4.81440793e+02  4.81440793e+02  4.81440793e+02  6.64151947e+02
  1.32623448e+03  1.32623448e+03  1.32623448e+03  2.80831179e+03
  3.01115391e+03  3.01115391e+03  3.01115391e+03  6.62548156e+03
  6.62548156e+03  6.62548156e+03  9.22735036e+03  2.55730927e+04
  7.63022696e+04]
E1 = -728.3116118663631  E_coul = 201.56544249230421
cycle= 6 E= -526.746169374059  delta_E= -5.46e-11  |g|= 1.67e-06  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3116118663631  E_coul = 201.56544249230421
  HOMO = -0.582836006535408  LUMO = 1.01945105671722
  mo_energy =
[-1.18579938e+02 -1.23095452e+01 -9.56078589e+00 -9.56078589e+00
 -9.56078589e+00 -1.27001488e+00 -5.82836007e-01 -5.82836007e-01
 -5.82836007e-01  1.01945106e+00  1.01945106e+00  1.01945106e+00
  1.05126886e+00  7.35321797e+00  7.35321797e+00  7.35321797e+00
  1.35816333e+01  3.36634201e+01  3.36634201e+01  3.36634201e+01
  1.22472729e+02  1.29369855e+02  1.29369855e+02  1.29369855e+02
  4.81440793e+02  4.81440793e+02  4.81440793e+02  6.64151947e+02
  1.32623448e+03  1.32623448e+03  1.32623448e+03  2.80831179e+03
  3.01115391e+03  3.01115391e+03  3.01115391e+03  6.62548156e+03
  6.62548156e+03  6.62548156e+03  9.22735036e+03  2.55730927e+04
  7.63022696e+04]
E1 = -728.3116111816956  E_coul = 201.56544180763595
Extra cycle  E= -526.74616937406  delta_E= -7.96e-13  |g|= 3.41e-07  |ddm|= 2.87e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61828893e+04 7.61701333e+03 3.61758978e+03 1.58683381e+03
 4.17836868e+02 1.22425946e+02 3.94457731e+01 8.49465098e+00
 3.35816186e+00 6.79593841e-01 2.51441617e-01 1.36286388e+03
 6.63998339e+02 2.97450611e+02 3.11021203e+02 6.16625939e+01
 7.37916347e+00 2.03000506e+01 7.78793314e-01 2.83845614e+00
 2.23299260e-01]
E = -526.7461693740597
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.8893111        1
[INPUT] 0    0    [1    /1   ]  7617.01332992        1
[INPUT] 0    0    [1    /1   ]  3617.58977765        1
[INPUT] 0    0    [1    /1   ]  1586.83381152        1
[INPUT] 0    0    [1    /1   ]  417.83686806         1
[INPUT] 0    0    [1    /1   ]  122.425946174        1
[INPUT] 0    0    [1    /1   ]  39.4457731122        1
[INPUT] 0    0    [1    /1   ]  8.4946509835         1
[INPUT] 0    0    [1    /1   ]  3.35816185544        1
[INPUT] 0    0    [1    /1   ]  0.679593841099       1
[INPUT] 0    0    [1    /1   ]  0.251441616914       1
[INPUT] 1    0    [1    /1   ]  1362.86388279        1
[INPUT] 1    0    [1    /1   ]  663.998338544        1
[INPUT] 1    0    [1    /1   ]  297.45061115         1
[INPUT] 1    0    [1    /1   ]  311.021203431        1
[INPUT] 1    0    [1    /1   ]  61.6625938637        1
[INPUT] 1    0    [1    /1   ]  7.37916347155        1
[INPUT] 1    0    [1    /1   ]  20.3000505798        1
[INPUT] 1    0    [1    /1   ]  0.778793313511       1
[INPUT] 1    0    [1    /1   ]  2.83845614187        1
[INPUT] 1    0    [1    /1   ]  0.22329926021        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.889311087056, 1.0]], [0, [7617.01332992202, 1.0]], [0, [3617.589777652848, 1.0]], [0, [1586.833811521542, 1.0]], [0, [417.836868059549, 1.0]], [0, [122.42594617433002, 1.0]], [0, [39.44577311217063, 1.0]], [0, [8.494650983499383, 1.0]], [0, [3.3581618554417636, 1.0]], [0, [0.6795938410986387, 1.0]], [0, [0.2514416169140319, 1.0]], [1, [1362.8638827932573, 1.0]], [1, [663.9983385437902, 1.0]], [1, [297.4506111495959, 1.0]], [1, [311.02120343100376, 1.0]], [1, [61.66259386373095, 1.0]], [1, [7.379163471547441, 1.0]], [1, [20.300050579837684, 1.0]], [1, [0.778793313510818, 1.0]], [1, [2.8384561418675256, 1.0]], [1, [0.22329926021047322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.88931109]
bas 1, expnt(s) = [7617.01332992]
bas 2, expnt(s) = [3617.58977765]
bas 3, expnt(s) = [1586.83381152]
bas 4, expnt(s) = [417.83686806]
bas 5, expnt(s) = [122.42594617]
bas 6, expnt(s) = [39.44577311]
bas 7, expnt(s) = [8.49465098]
bas 8, expnt(s) = [3.35816186]
bas 9, expnt(s) = [0.67959384]
bas 10, expnt(s) = [0.25144162]
bas 11, expnt(s) = [1362.86388279]
bas 12, expnt(s) = [663.99833854]
bas 13, expnt(s) = [297.45061115]
bas 14, expnt(s) = [311.02120343]
bas 15, expnt(s) = [61.66259386]
bas 16, expnt(s) = [7.37916347]
bas 17, expnt(s) = [20.30005058]
bas 18, expnt(s) = [0.77879331]
bas 19, expnt(s) = [2.83845614]
bas 20, expnt(s) = [0.22329926]
CPU time:       623.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61828893e+04 5.20029764e+03 7.61701333e+03 2.05993521e+03
 3.61758978e+03 1.17849980e+03 1.58683381e+03 6.35204562e+02
 4.17836868e+02 2.33490972e+02 1.22425946e+02 9.29865481e+01
 3.94457731e+01 3.97663178e+01 8.49465098e+00 1.25711260e+01
 3.35816186e+00 6.26745526e+00 6.79593841e-01 1.89104603e+00
 2.51441617e-01 8.97104210e-01 1.36286388e+03 2.41573892e+04
 6.63998339e+02 9.83316062e+03 2.97450611e+02 3.60373605e+03
 3.11021203e+02 3.81041159e+03 6.16625939e+01 5.04094118e+02
 7.37916347e+00 3.54807921e+01 2.03000506e+01 1.25705938e+02
 7.78793314e-01 2.13433291e+00 2.83845614e+00 1.07482344e+01
 2.23299260e-01 4.47809701e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993347497970994
cond(S) = 93374.74213494665
E1 = -729.5317866766047  E_coul = 203.18006398544097
init E= -526.351722691164
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.55576210419993  LUMO = 1.0380615272986
  mo_energy =
[-1.18331940e+02 -1.22047238e+01 -9.44672065e+00 -9.44672065e+00
 -9.44672065e+00 -1.23991656e+00 -5.55762104e-01 -5.55762104e-01
 -5.55762104e-01  1.03806153e+00  1.03806153e+00  1.03806153e+00
  1.07372488e+00  7.42396277e+00  7.42396277e+00  7.42396277e+00
  1.36687949e+01  3.37828167e+01  3.37828167e+01  3.37828167e+01
  1.22652179e+02  1.29549101e+02  1.29549101e+02  1.29549101e+02
  4.81687534e+02  4.81687534e+02  4.81687534e+02  6.64443375e+02
  1.32653333e+03  1.32653333e+03  1.32653333e+03  2.80874242e+03
  3.01151641e+03  3.01151641e+03  3.01151641e+03  6.62595459e+03
  6.62595459e+03  6.62595459e+03  9.22789612e+03  2.55737317e+04
  7.63029982e+04]
E1 = -727.8691564509102  E_coul = 201.12375327219956
cycle= 1 E= -526.745403178711  delta_E= -0.394  |g|= 0.185  |ddm|= 0.308
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537749
diis-c [-0.28917425  1.        ]
  HOMO = -0.590399234905266  LUMO = 1.01381410765033
  mo_energy =
[-1.18637154e+02 -1.23415469e+01 -9.59407665e+00 -9.59407665e+00
 -9.59407665e+00 -1.27918351e+00 -5.90399235e-01 -5.90399235e-01
 -5.90399235e-01  1.01381411e+00  1.01381411e+00  1.01381411e+00
  1.04407861e+00  7.33328861e+00  7.33328861e+00  7.33328861e+00
  1.35553742e+01  3.36297402e+01  3.36297402e+01  3.36297402e+01
  1.22424281e+02  1.29322739e+02  1.29322739e+02  1.29322739e+02
  4.81384325e+02  4.81384325e+02  4.81384325e+02  6.64092963e+02
  1.32617457e+03  1.32617457e+03  1.32617457e+03  2.80824916e+03
  3.01109215e+03  3.01109215e+03  3.01109215e+03  6.62541845e+03
  6.62541845e+03  6.62541845e+03  9.22728665e+03  2.55730286e+04
  7.63022054e+04]
E1 = -728.4381453621132  E_coul = 201.6920357934054
cycle= 2 E= -526.746109568708  delta_E= -0.000706  |g|= 0.0372  |ddm|= 0.0537
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745752
diis-c [-0.0032587   0.08235349  0.91764651]
  HOMO = -0.581362372201015  LUMO = 1.02051824388884
  mo_energy =
[-1.18570070e+02 -1.23038253e+01 -9.55470965e+00 -9.55470965e+00
 -9.55470965e+00 -1.26836885e+00 -5.81362372e-01 -5.81362372e-01
 -5.81362372e-01  1.02051824e+00  1.02051824e+00  1.02051824e+00
  1.05253359e+00  7.35695640e+00  7.35695640e+00  7.35695640e+00
  1.35863469e+01  3.36695226e+01  3.36695226e+01  3.36695226e+01
  1.22481139e+02  1.29378113e+02  1.29378113e+02  1.29378113e+02
  4.81450536e+02  4.81450536e+02  4.81450536e+02  6.64162144e+02
  1.32624482e+03  1.32624482e+03  1.32624482e+03  2.80832279e+03
  3.01116464e+03  3.01116464e+03  3.01116464e+03  6.62549269e+03
  6.62549269e+03  6.62549269e+03  9.22736171e+03  2.55731042e+04
  7.63022813e+04]
E1 = -728.2891193094644  E_coul = 201.54295182819777
cycle= 3 E= -526.746167481267  delta_E= -5.79e-05  |g|= 0.00623  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130653
diis-c [-5.33649532e-07 -1.21796471e-03  1.44740858e-01  8.56477107e-01]
  HOMO = -0.58284721805063  LUMO = 1.0194400700692
  mo_energy =
[-1.18579948e+02 -1.23095871e+01 -9.56081304e+00 -9.56081304e+00
 -9.56081304e+00 -1.27004913e+00 -5.82847218e-01 -5.82847218e-01
 -5.82847218e-01  1.01944007e+00  1.01944007e+00  1.01944007e+00
  1.05123865e+00  7.35319262e+00  7.35319262e+00  7.35319262e+00
  1.35815925e+01  3.36633942e+01  3.36633942e+01  3.36633942e+01
  1.22472706e+02  1.29369834e+02  1.29369834e+02  1.29369834e+02
  4.81440782e+02  4.81440782e+02  4.81440782e+02  6.64151946e+02
  1.32623448e+03  1.32623448e+03  1.32623448e+03  2.80831181e+03
  3.01115392e+03  3.01115392e+03  3.01115392e+03  6.62548158e+03
  6.62548158e+03  6.62548158e+03  9.22735039e+03  2.55730927e+04
  7.63022697e+04]
E1 = -728.3117400283843  E_coul = 201.5655706558561
cycle= 4 E= -526.746169372528  delta_E= -1.89e-06  |g|= 9.28e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000107105
diis-c [-3.80087829e-09  6.71078509e-05 -9.74246735e-03 -6.32074336e-02
  1.07288279e+00]
  HOMO = -0.582828891883336  LUMO = 1.01945575259402
  mo_energy =
[-1.18579908e+02 -1.23095237e+01 -9.56076241e+00 -9.56076241e+00
 -9.56076241e+00 -1.27000954e+00 -5.82828892e-01 -5.82828892e-01
 -5.82828892e-01  1.01945575e+00  1.01945575e+00  1.01945575e+00
  1.05127250e+00  7.35323391e+00  7.35323391e+00  7.35323391e+00
  1.35816512e+01  3.36634428e+01  3.36634428e+01  3.36634428e+01
  1.22472756e+02  1.29369882e+02  1.29369882e+02  1.29369882e+02
  4.81440822e+02  4.81440822e+02  4.81440822e+02  6.64151978e+02
  1.32623451e+03  1.32623451e+03  1.32623451e+03  2.80831182e+03
  3.01115394e+03  3.01115394e+03  3.01115394e+03  6.62548159e+03
  6.62548159e+03  6.62548159e+03  9.22735039e+03  2.55730927e+04
  7.63022697e+04]
E1 = -728.3115332083266  E_coul = 201.56536383432226
cycle= 5 E= -526.746169374004  delta_E= -1.48e-09  |g|= 1.99e-05  |ddm|= 0.000148
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.78441e-05
diis-c [-6.55785448e-11  1.39749455e-05 -1.84003520e-03 -1.37492154e-02
  4.29975987e-02  9.72577677e-01]
  HOMO = -0.582835976750023  LUMO = 1.019451024347
  mo_energy =
[-1.18579938e+02 -1.23095453e+01 -9.56078589e+00 -9.56078589e+00
 -9.56078589e+00 -1.27001521e+00 -5.82835977e-01 -5.82835977e-01
 -5.82835977e-01  1.01945102e+00  1.01945102e+00  1.01945102e+00
  1.05126854e+00  7.35321796e+00  7.35321796e+00  7.35321796e+00
  1.35816332e+01  3.36634200e+01  3.36634200e+01  3.36634200e+01
  1.22472729e+02  1.29369855e+02  1.29369855e+02  1.29369855e+02
  4.81440793e+02  4.81440793e+02  4.81440793e+02  6.64151947e+02
  1.32623448e+03  1.32623448e+03  1.32623448e+03  2.80831179e+03
  3.01115391e+03  3.01115391e+03  3.01115391e+03  6.62548156e+03
  6.62548156e+03  6.62548156e+03  9.22735036e+03  2.55730927e+04
  7.63022696e+04]
E1 = -728.3116118663631  E_coul = 201.56544249230421
cycle= 6 E= -526.746169374059  delta_E= -5.46e-11  |g|= 1.67e-06  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3116118663631  E_coul = 201.56544249230421
  HOMO = -0.582836006535408  LUMO = 1.01945105671722
  mo_energy =
[-1.18579938e+02 -1.23095452e+01 -9.56078589e+00 -9.56078589e+00
 -9.56078589e+00 -1.27001488e+00 -5.82836007e-01 -5.82836007e-01
 -5.82836007e-01  1.01945106e+00  1.01945106e+00  1.01945106e+00
  1.05126886e+00  7.35321797e+00  7.35321797e+00  7.35321797e+00
  1.35816333e+01  3.36634201e+01  3.36634201e+01  3.36634201e+01
  1.22472729e+02  1.29369855e+02  1.29369855e+02  1.29369855e+02
  4.81440793e+02  4.81440793e+02  4.81440793e+02  6.64151947e+02
  1.32623448e+03  1.32623448e+03  1.32623448e+03  2.80831179e+03
  3.01115391e+03  3.01115391e+03  3.01115391e+03  6.62548156e+03
  6.62548156e+03  6.62548156e+03  9.22735036e+03  2.55730927e+04
  7.63022696e+04]
E1 = -728.3116111816956  E_coul = 201.56544180763595
Extra cycle  E= -526.74616937406  delta_E= -7.96e-13  |g|= 3.41e-07  |ddm|= 2.87e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 93374.74213494665
E1 = -728.3116111816956  E_coul = 201.56544180763595
init E= -526.74616937406
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582836029995804  LUMO = 1.01945105114131
  mo_energy =
[-1.18579938e+02 -1.23095453e+01 -9.56078596e+00 -9.56078596e+00
 -9.56078596e+00 -1.27001483e+00 -5.82836030e-01 -5.82836030e-01
 -5.82836030e-01  1.01945105e+00  1.01945105e+00  1.01945105e+00
  1.05126891e+00  7.35321793e+00  7.35321793e+00  7.35321793e+00
  1.35816333e+01  3.36634200e+01  3.36634200e+01  3.36634200e+01
  1.22472729e+02  1.29369855e+02  1.29369855e+02  1.29369855e+02
  4.81440793e+02  4.81440793e+02  4.81440793e+02  6.64151947e+02
  1.32623448e+03  1.32623448e+03  1.32623448e+03  2.80831179e+03
  3.01115391e+03  3.01115391e+03  3.01115391e+03  6.62548156e+03
  6.62548156e+03  6.62548156e+03  9.22735036e+03  2.55730927e+04
  7.63022696e+04]
E1 = -728.3116112795142  E_coul = 201.56544190545506
cycle= 1 E= -526.746169374059  delta_E= 5.68e-13  |g|= 7.04e-08  |ddm|= 5.63e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3116112795142  E_coul = 201.56544190545506
  HOMO = -0.582836030326507  LUMO = 1.01945105321907
  mo_energy =
[-1.18579938e+02 -1.23095452e+01 -9.56078596e+00 -9.56078596e+00
 -9.56078596e+00 -1.27001481e+00 -5.82836030e-01 -5.82836030e-01
 -5.82836030e-01  1.01945105e+00  1.01945105e+00  1.01945105e+00
  1.05126892e+00  7.35321794e+00  7.35321794e+00  7.35321794e+00
  1.35816333e+01  3.36634200e+01  3.36634200e+01  3.36634200e+01
  1.22472729e+02  1.29369855e+02  1.29369855e+02  1.29369855e+02
  4.81440793e+02  4.81440793e+02  4.81440793e+02  6.64151947e+02
  1.32623448e+03  1.32623448e+03  1.32623448e+03  2.80831179e+03
  3.01115391e+03  3.01115391e+03  3.01115391e+03  6.62548156e+03
  6.62548156e+03  6.62548156e+03  9.22735036e+03  2.55730927e+04
  7.63022696e+04]
E1 = -728.3116112325883  E_coul = 201.56544185852968
Extra cycle  E= -526.746169374059  delta_E= 4.55e-13  |g|= 1.41e-08  |ddm|= 1.16e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61828893e+04 7.61701333e+03 3.61758978e+03 1.58683381e+03
 4.17836868e+02 1.22425946e+02 3.94457731e+01 8.49465098e+00
 3.35816186e+00 6.79593841e-01 2.51441617e-01 1.36286388e+03
 6.63998339e+02 2.97450611e+02 3.11021203e+02 6.16625939e+01
 7.37916347e+00 2.03000506e+01 7.78793314e-01 2.83845614e+00
 2.23299260e-01]
grad_E = [-1.39804428e-06  2.16469252e-06 -2.14709862e-06  3.72351157e-05
  7.11113035e-06 -5.95608178e-06  2.08865095e-05 -1.32231921e-04
  4.59068130e-04  7.08403408e-04 -4.37619793e-04 -5.39204835e-07
  4.79039345e-06  2.26289976e-05  1.93334100e-05  5.08809162e-06
 -1.57810896e-05 -7.52574443e-05  1.59534216e-03  7.52025253e-04
 -4.04478041e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.9248594        1
[INPUT] 0    0    [1    /1   ]  7616.96058218        1
[INPUT] 0    0    [1    /1   ]  3617.64576958        1
[INPUT] 0    0    [1    /1   ]  1585.96314379        1
[INPUT] 0    0    [1    /1   ]  417.080216483        1
[INPUT] 0    0    [1    /1   ]  122.239819212        1
[INPUT] 0    0    [1    /1   ]  39.413813194         1
[INPUT] 0    0    [1    /1   ]  8.48882316304        1
[INPUT] 0    0    [1    /1   ]  3.35891635729        1
[INPUT] 0    0    [1    /1   ]  0.68317170394        1
[INPUT] 0    0    [1    /1   ]  0.252513820489       1
[INPUT] 1    0    [1    /1   ]  1362.87734064        1
[INPUT] 1    0    [1    /1   ]  663.871332721        1
[INPUT] 1    0    [1    /1   ]  296.847123474        1
[INPUT] 1    0    [1    /1   ]  310.505113732        1
[INPUT] 1    0    [1    /1   ]  61.9376165225        1
[INPUT] 1    0    [1    /1   ]  7.43003600215        1
[INPUT] 1    0    [1    /1   ]  20.4140598948        1
[INPUT] 1    0    [1    /1   ]  0.78149275988        1
[INPUT] 1    0    [1    /1   ]  2.86060848972        1
[INPUT] 1    0    [1    /1   ]  0.223808667379       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.924859395756, 1.0]], [0, [7616.9605821796595, 1.0]], [0, [3617.645769582755, 1.0]], [0, [1585.9631437858257, 1.0]], [0, [417.08021648292254, 1.0]], [0, [122.23981921247277, 1.0]], [0, [39.41381319398545, 1.0]], [0, [8.488823163037427, 1.0]], [0, [3.358916357290606, 1.0]], [0, [0.6831717039400258, 1.0]], [0, [0.25251382048882254, 1.0]], [1, [1362.8773406413827, 1.0]], [1, [663.8713327208475, 1.0]], [1, [296.84712347439694, 1.0]], [1, [310.5051137323676, 1.0]], [1, [61.93761652245972, 1.0]], [1, [7.430036002154485, 1.0]], [1, [20.414059894829375, 1.0]], [1, [0.7814927598797422, 1.0]], [1, [2.8606084897222064, 1.0]], [1, [0.2238086673792223, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.9248594]
bas 1, expnt(s) = [7616.96058218]
bas 2, expnt(s) = [3617.64576958]
bas 3, expnt(s) = [1585.96314379]
bas 4, expnt(s) = [417.08021648]
bas 5, expnt(s) = [122.23981921]
bas 6, expnt(s) = [39.41381319]
bas 7, expnt(s) = [8.48882316]
bas 8, expnt(s) = [3.35891636]
bas 9, expnt(s) = [0.6831717]
bas 10, expnt(s) = [0.25251382]
bas 11, expnt(s) = [1362.87734064]
bas 12, expnt(s) = [663.87133272]
bas 13, expnt(s) = [296.84712347]
bas 14, expnt(s) = [310.50511373]
bas 15, expnt(s) = [61.93761652]
bas 16, expnt(s) = [7.430036]
bas 17, expnt(s) = [20.41405989]
bas 18, expnt(s) = [0.78149276]
bas 19, expnt(s) = [2.86060849]
bas 20, expnt(s) = [0.22380867]
CPU time:       629.48
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61829249e+04 5.20030294e+03 7.61696058e+03 2.05992451e+03
 3.61764577e+03 1.17851348e+03 1.58596314e+03 6.34943150e+02
 4.17080216e+02 2.33173782e+02 1.22239819e+02 9.28805008e+01
 3.94138132e+01 3.97421506e+01 8.48882316e+00 1.25646571e+01
 3.35891636e+00 6.26851135e+00 6.83171704e-01 1.89850798e+00
 2.52513820e-01 8.99971774e-01 1.36287734e+03 2.41576873e+04
 6.63871333e+02 9.83080964e+03 2.96847123e+02 3.59459900e+03
 3.10505114e+02 3.80250977e+03 6.19376165e+01 5.06906084e+02
 7.43003600e+00 3.57868143e+01 2.04140599e+01 1.26589045e+02
 7.81492760e-01 2.14358442e+00 2.86060849e+00 1.08531904e+01
 2.23808667e-01 4.49087037e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993243545239697
cond(S) = 91977.34651168536
E1 = -729.5319813440192  E_coul = 203.1802282588034
init E= -526.351753085216
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555740611064976  LUMO = 1.04248148251444
  mo_energy =
[-1.18331941e+02 -1.22047243e+01 -9.44672593e+00 -9.44672593e+00
 -9.44672593e+00 -1.23989799e+00 -5.55740611e-01 -5.55740611e-01
 -5.55740611e-01  1.04248148e+00  1.04248148e+00  1.04248148e+00
  1.08224814e+00  7.48849034e+00  7.48849034e+00  7.48849034e+00
  1.36854721e+01  3.40665648e+01  3.40665648e+01  3.40665648e+01
  1.22505363e+02  1.30365256e+02  1.30365256e+02  1.30365256e+02
  4.82645296e+02  4.82645296e+02  4.82645296e+02  6.63323931e+02
  1.32639645e+03  1.32639645e+03  1.32639645e+03  2.80547467e+03
  3.00976867e+03  3.00976867e+03  3.00976867e+03  6.62307664e+03
  6.62307664e+03  6.62307664e+03  9.22267361e+03  2.55674354e+04
  7.62965534e+04]
E1 = -727.8720264829456  E_coul = 201.126582714657
cycle= 1 E= -526.745443768289  delta_E= -0.394  |g|= 0.184  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537923
diis-c [-0.2893613  1.       ]
  HOMO = -0.590319318748881  LUMO = 1.01816261625511
  mo_energy =
[-1.18636849e+02 -1.23413560e+01 -9.59388308e+00 -9.59388308e+00
 -9.59388308e+00 -1.27910475e+00 -5.90319319e-01 -5.90319319e-01
 -5.90319319e-01  1.01816262e+00  1.01816262e+00  1.01816262e+00
  1.05248217e+00  7.39749100e+00  7.39749100e+00  7.39749100e+00
  1.35722224e+01  3.39133122e+01  3.39133122e+01  3.39133122e+01
  1.22277863e+02  1.30138931e+02  1.30138931e+02  1.30138931e+02
  4.82342516e+02  4.82342516e+02  4.82342516e+02  6.62973999e+02
  1.32603817e+03  1.32603817e+03  1.32603817e+03  2.80498181e+03
  3.00934481e+03  3.00934481e+03  3.00934481e+03  6.62254084e+03
  6.62254084e+03  6.62254084e+03  9.22206446e+03  2.55667326e+04
  7.62957609e+04]
E1 = -728.440061140183  E_coul = 201.69391270193194
cycle= 2 E= -526.746148438251  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745427
diis-c [-0.00325589  0.08229477  0.91770523]
  HOMO = -0.581302105206646  LUMO = 1.02488546475838
  mo_energy =
[-1.18569858e+02 -1.23036951e+01 -9.55457766e+00 -9.55457766e+00
 -9.55457766e+00 -1.26831313e+00 -5.81302105e-01 -5.81302105e-01
 -5.81302105e-01  1.02488546e+00  1.02488546e+00  1.02488546e+00
  1.06096616e+00  7.42123249e+00  7.42123249e+00  7.42123249e+00
  1.36031353e+01  3.39531250e+01  3.39531250e+01  3.39531250e+01
  1.22334621e+02  1.30194268e+02  1.30194268e+02  1.30194268e+02
  4.82408624e+02  4.82408624e+02  4.82408624e+02  6.63043075e+02
  1.32610830e+03  1.32610830e+03  1.32610830e+03  2.80505534e+03
  3.00941720e+03  3.00941720e+03  3.00941720e+03  6.62261498e+03
  6.62261498e+03  6.62261498e+03  9.22213941e+03  2.55668081e+04
  7.62958367e+04]
E1 = -728.2913323619515  E_coul = 201.5451262000161
cycle= 3 E= -526.746206161935  delta_E= -5.77e-05  |g|= 0.00622  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130578
diis-c [-5.32244493e-07 -1.21778112e-03  1.44720184e-01  8.56497598e-01]
  HOMO = -0.582783546470969  LUMO = 1.02380438935074
  mo_energy =
[-1.18579721e+02 -1.23094470e+01 -9.56067075e+00 -9.56067075e+00
 -9.56067075e+00 -1.26998978e+00 -5.82783546e-01 -5.82783546e-01
 -5.82783546e-01  1.02380439e+00  1.02380439e+00  1.02380439e+00
  1.05966676e+00  7.41745798e+00  7.41745798e+00  7.41745798e+00
  1.35983903e+01  3.39469938e+01  3.39469938e+01  3.39469938e+01
  1.22326202e+02  1.30185997e+02  1.30185997e+02  1.30185997e+02
  4.82398886e+02  4.82398886e+02  4.82398886e+02  6.63032893e+02
  1.32609798e+03  1.32609798e+03  1.32609798e+03  2.80504437e+03
  3.00940649e+03  3.00940649e+03  3.00940649e+03  6.62260389e+03
  6.62260389e+03  6.62260389e+03  9.22212811e+03  2.55667967e+04
  7.62958251e+04]
E1 = -728.3139065127921  E_coul = 201.56769846624837
cycle= 4 E= -526.746208046544  delta_E= -1.88e-06  |g|= 9.25e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106824
diis-c [-3.77447693e-09  6.70118055e-05 -9.73377042e-03 -6.31542148e-02
  1.07282097e+00]
  HOMO = -0.582765212939646  LUMO = 1.02382012712015
  mo_energy =
[-1.18579681e+02 -1.23093835e+01 -9.56062011e+00 -9.56062011e+00
 -9.56062011e+00 -1.26995026e+00 -5.82765213e-01 -5.82765213e-01
 -5.82765213e-01  1.02382013e+00  1.02382013e+00  1.02382013e+00
  1.05970069e+00  7.41749936e+00  7.41749936e+00  7.41749936e+00
  1.35984488e+01  3.39470424e+01  3.39470424e+01  3.39470424e+01
  1.22326252e+02  1.30186044e+02  1.30186044e+02  1.30186044e+02
  4.82398926e+02  4.82398926e+02  4.82398926e+02  6.63032925e+02
  1.32609801e+03  1.32609801e+03  1.32609801e+03  2.80504439e+03
  3.00940651e+03  3.00940651e+03  3.00940651e+03  6.62260389e+03
  6.62260389e+03  6.62260389e+03  9.22212811e+03  2.55667966e+04
  7.62958251e+04]
E1 = -728.3137000474412  E_coul = 201.56749199943596
cycle= 5 E= -526.746208048005  delta_E= -1.46e-09  |g|= 1.98e-05  |ddm|= 0.000147
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77777e-05
diis-c [-6.50254796e-11  1.39116878e-05 -1.83247338e-03 -1.37041756e-02
  4.31852960e-02  9.72337441e-01]
  HOMO = -0.582772273610449  LUMO = 1.02381538979011
  mo_energy =
[-1.18579711e+02 -1.23094051e+01 -9.56064354e+00 -9.56064354e+00
 -9.56064354e+00 -1.26995593e+00 -5.82772274e-01 -5.82772274e-01
 -5.82772274e-01  1.02381539e+00  1.02381539e+00  1.02381539e+00
  1.05969670e+00  7.41748338e+00  7.41748338e+00  7.41748338e+00
  1.35984309e+01  3.39470196e+01  3.39470196e+01  3.39470196e+01
  1.22326226e+02  1.30186017e+02  1.30186017e+02  1.30186017e+02
  4.82398897e+02  4.82398897e+02  4.82398897e+02  6.63032895e+02
  1.32609798e+03  1.32609798e+03  1.32609798e+03  2.80504436e+03
  3.00940648e+03  3.00940648e+03  3.00940648e+03  6.62260386e+03
  6.62260386e+03  6.62260386e+03  9.22212807e+03  2.55667966e+04
  7.62958250e+04]
E1 = -728.3137785290555  E_coul = 201.56757048099757
cycle= 6 E= -526.746208048058  delta_E= -5.28e-11  |g|= 1.66e-06  |ddm|= 1.72e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3137785290555  E_coul = 201.56757048099757
  HOMO = -0.582772302937572  LUMO = 1.02381542215978
  mo_energy =
[-1.18579711e+02 -1.23094050e+01 -9.56064354e+00 -9.56064354e+00
 -9.56064354e+00 -1.26995559e+00 -5.82772303e-01 -5.82772303e-01
 -5.82772303e-01  1.02381542e+00  1.02381542e+00  1.02381542e+00
  1.05969702e+00  7.41748339e+00  7.41748339e+00  7.41748339e+00
  1.35984310e+01  3.39470197e+01  3.39470197e+01  3.39470197e+01
  1.22326226e+02  1.30186017e+02  1.30186017e+02  1.30186017e+02
  4.82398897e+02  4.82398897e+02  4.82398897e+02  6.63032895e+02
  1.32609798e+03  1.32609798e+03  1.32609798e+03  2.80504436e+03
  3.00940648e+03  3.00940648e+03  3.00940648e+03  6.62260386e+03
  6.62260386e+03  6.62260386e+03  9.22212807e+03  2.55667966e+04
  7.62958250e+04]
E1 = -728.3137778541471  E_coul = 201.5675698060893
Extra cycle  E= -526.746208048058  delta_E= 1.14e-13  |g|= 3.39e-07  |ddm|= 2.85e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.27 sec
exp = [2.61829249e+04 7.61696058e+03 3.61764577e+03 1.58596314e+03
 4.17080216e+02 1.22239819e+02 3.94138132e+01 8.48882316e+00
 3.35891636e+00 6.83171704e-01 2.52513820e-01 1.36287734e+03
 6.63871333e+02 2.96847123e+02 3.10505114e+02 6.19376165e+01
 7.43003600e+00 2.04140599e+01 7.81492760e-01 2.86060849e+00
 2.23808667e-01]
E = -526.7462080480578
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26182.9248594        1
[INPUT] 0    0    [1    /1   ]  7616.96058218        1
[INPUT] 0    0    [1    /1   ]  3617.64576958        1
[INPUT] 0    0    [1    /1   ]  1585.96314379        1
[INPUT] 0    0    [1    /1   ]  417.080216483        1
[INPUT] 0    0    [1    /1   ]  122.239819212        1
[INPUT] 0    0    [1    /1   ]  39.413813194         1
[INPUT] 0    0    [1    /1   ]  8.48882316304        1
[INPUT] 0    0    [1    /1   ]  3.35891635729        1
[INPUT] 0    0    [1    /1   ]  0.68317170394        1
[INPUT] 0    0    [1    /1   ]  0.252513820489       1
[INPUT] 1    0    [1    /1   ]  1362.87734064        1
[INPUT] 1    0    [1    /1   ]  663.871332721        1
[INPUT] 1    0    [1    /1   ]  296.847123474        1
[INPUT] 1    0    [1    /1   ]  310.505113732        1
[INPUT] 1    0    [1    /1   ]  61.9376165225        1
[INPUT] 1    0    [1    /1   ]  7.43003600215        1
[INPUT] 1    0    [1    /1   ]  20.4140598948        1
[INPUT] 1    0    [1    /1   ]  0.78149275988        1
[INPUT] 1    0    [1    /1   ]  2.86060848972        1
[INPUT] 1    0    [1    /1   ]  0.223808667379       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26182.924859395756, 1.0]], [0, [7616.9605821796595, 1.0]], [0, [3617.645769582755, 1.0]], [0, [1585.9631437858257, 1.0]], [0, [417.08021648292254, 1.0]], [0, [122.23981921247277, 1.0]], [0, [39.41381319398545, 1.0]], [0, [8.488823163037427, 1.0]], [0, [3.358916357290606, 1.0]], [0, [0.6831717039400258, 1.0]], [0, [0.25251382048882254, 1.0]], [1, [1362.8773406413827, 1.0]], [1, [663.8713327208475, 1.0]], [1, [296.84712347439694, 1.0]], [1, [310.5051137323676, 1.0]], [1, [61.93761652245972, 1.0]], [1, [7.430036002154485, 1.0]], [1, [20.414059894829375, 1.0]], [1, [0.7814927598797422, 1.0]], [1, [2.8606084897222064, 1.0]], [1, [0.2238086673792223, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26182.9248594]
bas 1, expnt(s) = [7616.96058218]
bas 2, expnt(s) = [3617.64576958]
bas 3, expnt(s) = [1585.96314379]
bas 4, expnt(s) = [417.08021648]
bas 5, expnt(s) = [122.23981921]
bas 6, expnt(s) = [39.41381319]
bas 7, expnt(s) = [8.48882316]
bas 8, expnt(s) = [3.35891636]
bas 9, expnt(s) = [0.6831717]
bas 10, expnt(s) = [0.25251382]
bas 11, expnt(s) = [1362.87734064]
bas 12, expnt(s) = [663.87133272]
bas 13, expnt(s) = [296.84712347]
bas 14, expnt(s) = [310.50511373]
bas 15, expnt(s) = [61.93761652]
bas 16, expnt(s) = [7.430036]
bas 17, expnt(s) = [20.41405989]
bas 18, expnt(s) = [0.78149276]
bas 19, expnt(s) = [2.86060849]
bas 20, expnt(s) = [0.22380867]
CPU time:       630.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61829249e+04 5.20030294e+03 7.61696058e+03 2.05992451e+03
 3.61764577e+03 1.17851348e+03 1.58596314e+03 6.34943150e+02
 4.17080216e+02 2.33173782e+02 1.22239819e+02 9.28805008e+01
 3.94138132e+01 3.97421506e+01 8.48882316e+00 1.25646571e+01
 3.35891636e+00 6.26851135e+00 6.83171704e-01 1.89850798e+00
 2.52513820e-01 8.99971774e-01 1.36287734e+03 2.41576873e+04
 6.63871333e+02 9.83080964e+03 2.96847123e+02 3.59459900e+03
 3.10505114e+02 3.80250977e+03 6.19376165e+01 5.06906084e+02
 7.43003600e+00 3.57868143e+01 2.04140599e+01 1.26589045e+02
 7.81492760e-01 2.14358442e+00 2.86060849e+00 1.08531904e+01
 2.23808667e-01 4.49087037e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.993243545239697
cond(S) = 91977.34651168536
E1 = -729.5319813440192  E_coul = 203.1802282588034
init E= -526.351753085216
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555740611064976  LUMO = 1.04248148251444
  mo_energy =
[-1.18331941e+02 -1.22047243e+01 -9.44672593e+00 -9.44672593e+00
 -9.44672593e+00 -1.23989799e+00 -5.55740611e-01 -5.55740611e-01
 -5.55740611e-01  1.04248148e+00  1.04248148e+00  1.04248148e+00
  1.08224814e+00  7.48849034e+00  7.48849034e+00  7.48849034e+00
  1.36854721e+01  3.40665648e+01  3.40665648e+01  3.40665648e+01
  1.22505363e+02  1.30365256e+02  1.30365256e+02  1.30365256e+02
  4.82645296e+02  4.82645296e+02  4.82645296e+02  6.63323931e+02
  1.32639645e+03  1.32639645e+03  1.32639645e+03  2.80547467e+03
  3.00976867e+03  3.00976867e+03  3.00976867e+03  6.62307664e+03
  6.62307664e+03  6.62307664e+03  9.22267361e+03  2.55674354e+04
  7.62965534e+04]
E1 = -727.8720264829456  E_coul = 201.126582714657
cycle= 1 E= -526.745443768289  delta_E= -0.394  |g|= 0.184  |ddm|= 0.307
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.537923
diis-c [-0.2893613  1.       ]
  HOMO = -0.590319318748881  LUMO = 1.01816261625511
  mo_energy =
[-1.18636849e+02 -1.23413560e+01 -9.59388308e+00 -9.59388308e+00
 -9.59388308e+00 -1.27910475e+00 -5.90319319e-01 -5.90319319e-01
 -5.90319319e-01  1.01816262e+00  1.01816262e+00  1.01816262e+00
  1.05248217e+00  7.39749100e+00  7.39749100e+00  7.39749100e+00
  1.35722224e+01  3.39133122e+01  3.39133122e+01  3.39133122e+01
  1.22277863e+02  1.30138931e+02  1.30138931e+02  1.30138931e+02
  4.82342516e+02  4.82342516e+02  4.82342516e+02  6.62973999e+02
  1.32603817e+03  1.32603817e+03  1.32603817e+03  2.80498181e+03
  3.00934481e+03  3.00934481e+03  3.00934481e+03  6.62254084e+03
  6.62254084e+03  6.62254084e+03  9.22206446e+03  2.55667326e+04
  7.62957609e+04]
E1 = -728.440061140183  E_coul = 201.69391270193194
cycle= 2 E= -526.746148438251  delta_E= -0.000705  |g|= 0.0372  |ddm|= 0.0536
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745427
diis-c [-0.00325589  0.08229477  0.91770523]
  HOMO = -0.581302105206646  LUMO = 1.02488546475838
  mo_energy =
[-1.18569858e+02 -1.23036951e+01 -9.55457766e+00 -9.55457766e+00
 -9.55457766e+00 -1.26831313e+00 -5.81302105e-01 -5.81302105e-01
 -5.81302105e-01  1.02488546e+00  1.02488546e+00  1.02488546e+00
  1.06096616e+00  7.42123249e+00  7.42123249e+00  7.42123249e+00
  1.36031353e+01  3.39531250e+01  3.39531250e+01  3.39531250e+01
  1.22334621e+02  1.30194268e+02  1.30194268e+02  1.30194268e+02
  4.82408624e+02  4.82408624e+02  4.82408624e+02  6.63043075e+02
  1.32610830e+03  1.32610830e+03  1.32610830e+03  2.80505534e+03
  3.00941720e+03  3.00941720e+03  3.00941720e+03  6.62261498e+03
  6.62261498e+03  6.62261498e+03  9.22213941e+03  2.55668081e+04
  7.62958367e+04]
E1 = -728.2913323619515  E_coul = 201.5451262000161
cycle= 3 E= -526.746206161935  delta_E= -5.77e-05  |g|= 0.00622  |ddm|= 0.0163
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130578
diis-c [-5.32244493e-07 -1.21778112e-03  1.44720184e-01  8.56497598e-01]
  HOMO = -0.582783546470969  LUMO = 1.02380438935074
  mo_energy =
[-1.18579721e+02 -1.23094470e+01 -9.56067075e+00 -9.56067075e+00
 -9.56067075e+00 -1.26998978e+00 -5.82783546e-01 -5.82783546e-01
 -5.82783546e-01  1.02380439e+00  1.02380439e+00  1.02380439e+00
  1.05966676e+00  7.41745798e+00  7.41745798e+00  7.41745798e+00
  1.35983903e+01  3.39469938e+01  3.39469938e+01  3.39469938e+01
  1.22326202e+02  1.30185997e+02  1.30185997e+02  1.30185997e+02
  4.82398886e+02  4.82398886e+02  4.82398886e+02  6.63032893e+02
  1.32609798e+03  1.32609798e+03  1.32609798e+03  2.80504437e+03
  3.00940649e+03  3.00940649e+03  3.00940649e+03  6.62260389e+03
  6.62260389e+03  6.62260389e+03  9.22212811e+03  2.55667967e+04
  7.62958251e+04]
E1 = -728.3139065127921  E_coul = 201.56769846624837
cycle= 4 E= -526.746208046544  delta_E= -1.88e-06  |g|= 9.25e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106824
diis-c [-3.77447693e-09  6.70118055e-05 -9.73377042e-03 -6.31542148e-02
  1.07282097e+00]
  HOMO = -0.582765212939646  LUMO = 1.02382012712015
  mo_energy =
[-1.18579681e+02 -1.23093835e+01 -9.56062011e+00 -9.56062011e+00
 -9.56062011e+00 -1.26995026e+00 -5.82765213e-01 -5.82765213e-01
 -5.82765213e-01  1.02382013e+00  1.02382013e+00  1.02382013e+00
  1.05970069e+00  7.41749936e+00  7.41749936e+00  7.41749936e+00
  1.35984488e+01  3.39470424e+01  3.39470424e+01  3.39470424e+01
  1.22326252e+02  1.30186044e+02  1.30186044e+02  1.30186044e+02
  4.82398926e+02  4.82398926e+02  4.82398926e+02  6.63032925e+02
  1.32609801e+03  1.32609801e+03  1.32609801e+03  2.80504439e+03
  3.00940651e+03  3.00940651e+03  3.00940651e+03  6.62260389e+03
  6.62260389e+03  6.62260389e+03  9.22212811e+03  2.55667966e+04
  7.62958251e+04]
E1 = -728.3137000474412  E_coul = 201.56749199943596
cycle= 5 E= -526.746208048005  delta_E= -1.46e-09  |g|= 1.98e-05  |ddm|= 0.000147
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.77777e-05
diis-c [-6.50254796e-11  1.39116878e-05 -1.83247338e-03 -1.37041756e-02
  4.31852960e-02  9.72337441e-01]
  HOMO = -0.582772273610449  LUMO = 1.02381538979011
  mo_energy =
[-1.18579711e+02 -1.23094051e+01 -9.56064354e+00 -9.56064354e+00
 -9.56064354e+00 -1.26995593e+00 -5.82772274e-01 -5.82772274e-01
 -5.82772274e-01  1.02381539e+00  1.02381539e+00  1.02381539e+00
  1.05969670e+00  7.41748338e+00  7.41748338e+00  7.41748338e+00
  1.35984309e+01  3.39470196e+01  3.39470196e+01  3.39470196e+01
  1.22326226e+02  1.30186017e+02  1.30186017e+02  1.30186017e+02
  4.82398897e+02  4.82398897e+02  4.82398897e+02  6.63032895e+02
  1.32609798e+03  1.32609798e+03  1.32609798e+03  2.80504436e+03
  3.00940648e+03  3.00940648e+03  3.00940648e+03  6.62260386e+03
  6.62260386e+03  6.62260386e+03  9.22212807e+03  2.55667966e+04
  7.62958250e+04]
E1 = -728.3137785290555  E_coul = 201.56757048099757
cycle= 6 E= -526.746208048058  delta_E= -5.28e-11  |g|= 1.66e-06  |ddm|= 1.72e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3137785290555  E_coul = 201.56757048099757
  HOMO = -0.582772302937572  LUMO = 1.02381542215978
  mo_energy =
[-1.18579711e+02 -1.23094050e+01 -9.56064354e+00 -9.56064354e+00
 -9.56064354e+00 -1.26995559e+00 -5.82772303e-01 -5.82772303e-01
 -5.82772303e-01  1.02381542e+00  1.02381542e+00  1.02381542e+00
  1.05969702e+00  7.41748339e+00  7.41748339e+00  7.41748339e+00
  1.35984310e+01  3.39470197e+01  3.39470197e+01  3.39470197e+01
  1.22326226e+02  1.30186017e+02  1.30186017e+02  1.30186017e+02
  4.82398897e+02  4.82398897e+02  4.82398897e+02  6.63032895e+02
  1.32609798e+03  1.32609798e+03  1.32609798e+03  2.80504436e+03
  3.00940648e+03  3.00940648e+03  3.00940648e+03  6.62260386e+03
  6.62260386e+03  6.62260386e+03  9.22212807e+03  2.55667966e+04
  7.62958250e+04]
E1 = -728.3137778541471  E_coul = 201.5675698060893
Extra cycle  E= -526.746208048058  delta_E= 1.14e-13  |g|= 3.39e-07  |ddm|= 2.85e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 91977.34651168536
E1 = -728.3137778541471  E_coul = 201.5675698060893
init E= -526.746208048058
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582772326085842  LUMO = 1.02381541666782
  mo_energy =
[-1.18579711e+02 -1.23094051e+01 -9.56064361e+00 -9.56064361e+00
 -9.56064361e+00 -1.26995554e+00 -5.82772326e-01 -5.82772326e-01
 -5.82772326e-01  1.02381542e+00  1.02381542e+00  1.02381542e+00
  1.05969707e+00  7.41748335e+00  7.41748335e+00  7.41748335e+00
  1.35984310e+01  3.39470196e+01  3.39470196e+01  3.39470196e+01
  1.22326226e+02  1.30186017e+02  1.30186017e+02  1.30186017e+02
  4.82398897e+02  4.82398897e+02  4.82398897e+02  6.63032895e+02
  1.32609798e+03  1.32609798e+03  1.32609798e+03  2.80504436e+03
  3.00940648e+03  3.00940648e+03  3.00940648e+03  6.62260386e+03
  6.62260386e+03  6.62260386e+03  9.22212807e+03  2.55667966e+04
  7.62958250e+04]
E1 = -728.3137779504789  E_coul = 201.56756990242107
cycle= 1 E= -526.746208048058  delta_E=    0  |g|= 6.99e-08  |ddm|= 5.59e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3137779504789  E_coul = 201.56756990242107
  HOMO = -0.582772326411898  LUMO = 1.02381541873238
  mo_energy =
[-1.18579711e+02 -1.23094051e+01 -9.56064361e+00 -9.56064361e+00
 -9.56064361e+00 -1.26995553e+00 -5.82772326e-01 -5.82772326e-01
 -5.82772326e-01  1.02381542e+00  1.02381542e+00  1.02381542e+00
  1.05969708e+00  7.41748335e+00  7.41748335e+00  7.41748335e+00
  1.35984310e+01  3.39470196e+01  3.39470196e+01  3.39470196e+01
  1.22326226e+02  1.30186017e+02  1.30186017e+02  1.30186017e+02
  4.82398897e+02  4.82398897e+02  4.82398897e+02  6.63032895e+02
  1.32609798e+03  1.32609798e+03  1.32609798e+03  2.80504436e+03
  3.00940648e+03  3.00940648e+03  3.00940648e+03  6.62260386e+03
  6.62260386e+03  6.62260386e+03  9.22212807e+03  2.55667966e+04
  7.62958250e+04]
E1 = -728.3137779042752  E_coul = 201.56756985621755
Extra cycle  E= -526.746208048058  delta_E= 2.27e-13  |g|= 1.4e-08  |ddm|= 1.15e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61829249e+04 7.61696058e+03 3.61764577e+03 1.58596314e+03
 4.17080216e+02 1.22239819e+02 3.94138132e+01 8.48882316e+00
 3.35891636e+00 6.83171704e-01 2.52513820e-01 1.36287734e+03
 6.63871333e+02 2.96847123e+02 3.10505114e+02 6.19376165e+01
 7.43003600e+00 2.04140599e+01 7.81492760e-01 2.86060849e+00
 2.23808667e-01]
grad_E = [-1.40018147e-06  2.18224377e-06 -2.15403922e-06  3.78569926e-05
  3.36112417e-06 -1.19762126e-05  3.34489387e-05 -2.19007841e-04
  7.58456195e-04  1.16367783e-03 -7.11763665e-04 -5.56343324e-07
  4.59435954e-06  2.15696985e-05  1.83881632e-05  2.47406564e-05
 -1.97113897e-05 -1.20039430e-04  2.59324319e-03  1.22617335e-03
 -6.58081668e-03]
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.0283299        1
[INPUT] 0    0    [1    /1   ]  7616.80384738        1
[INPUT] 0    0    [1    /1   ]  3617.80622473        1
[INPUT] 0    0    [1    /1   ]  1583.32489465        1
[INPUT] 0    0    [1    /1   ]  415.686823927        1
[INPUT] 0    0    [1    /1   ]  121.908761433        1
[INPUT] 0    0    [1    /1   ]  39.3568114004        1
[INPUT] 0    0    [1    /1   ]  8.4790641265         1
[INPUT] 0    0    [1    /1   ]  3.36012798616        1
[INPUT] 0    0    [1    /1   ]  0.6893240367         1
[INPUT] 0    0    [1    /1   ]  0.254329064014       1
[INPUT] 1    0    [1    /1   ]  1362.91664859        1
[INPUT] 1    0    [1    /1   ]  663.507454992        1
[INPUT] 1    0    [1    /1   ]  295.122182477        1
[INPUT] 1    0    [1    /1   ]  309.029786144        1
[INPUT] 1    0    [1    /1   ]  62.3272051908        1
[INPUT] 1    0    [1    /1   ]  7.50739132715        1
[INPUT] 1    0    [1    /1   ]  20.5835595964        1
[INPUT] 1    0    [1    /1   ]  0.785611773706       1
[INPUT] 1    0    [1    /1   ]  2.89433228489        1
[INPUT] 1    0    [1    /1   ]  0.224586666017       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26183.028329930425, 1.0]], [0, [7616.80384737847, 1.0]], [0, [3617.806224726722, 1.0]], [0, [1583.324894650815, 1.0]], [0, [415.68682392727857, 1.0]], [0, [121.90876143307074, 1.0]], [0, [39.35681140044986, 1.0]], [0, [8.47906412649586, 1.0]], [0, [3.3601279861565536, 1.0]], [0, [0.6893240367000204, 1.0]], [0, [0.2543290640139938, 1.0]], [1, [1362.9166485873818, 1.0]], [1, [663.5074549924263, 1.0]], [1, [295.12218247689117, 1.0]], [1, [309.0297861444855, 1.0]], [1, [62.32720519075591, 1.0]], [1, [7.507391327154229, 1.0]], [1, [20.583559596441603, 1.0]], [1, [0.7856117737064346, 1.0]], [1, [2.8943322848905004, 1.0]], [1, [0.22458666601704322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.02832993]
bas 1, expnt(s) = [7616.80384738]
bas 2, expnt(s) = [3617.80622473]
bas 3, expnt(s) = [1583.32489465]
bas 4, expnt(s) = [415.68682393]
bas 5, expnt(s) = [121.90876143]
bas 6, expnt(s) = [39.3568114]
bas 7, expnt(s) = [8.47906413]
bas 8, expnt(s) = [3.36012799]
bas 9, expnt(s) = [0.68932404]
bas 10, expnt(s) = [0.25432906]
bas 11, expnt(s) = [1362.91664859]
bas 12, expnt(s) = [663.50745499]
bas 13, expnt(s) = [295.12218248]
bas 14, expnt(s) = [309.02978614]
bas 15, expnt(s) = [62.32720519]
bas 16, expnt(s) = [7.50739133]
bas 17, expnt(s) = [20.5835596]
bas 18, expnt(s) = [0.78561177]
bas 19, expnt(s) = [2.89433228]
bas 20, expnt(s) = [0.22458667]
CPU time:       636.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61830283e+04 5.20031835e+03 7.61680385e+03 2.05989272e+03
 3.61780622e+03 1.17855268e+03 1.58332489e+03 6.34150814e+02
 4.15686824e+02 2.32589293e+02 1.21908761e+02 9.26917781e+01
 3.93568114e+01 3.96990353e+01 8.47906413e+00 1.25538219e+01
 3.36012799e+00 6.27020715e+00 6.89324037e-01 1.91131642e+00
 2.54329064e-01 9.04819640e-01 1.36291665e+03 2.41585583e+04
 6.63507455e+02 9.82407459e+03 2.95122182e+02 3.56850829e+03
 3.09029786e+02 3.77993924e+03 6.23272052e+01 5.10894773e+02
 7.50739133e+00 3.62531469e+01 2.05835596e+01 1.27904255e+02
 7.85611774e-01 2.15771645e+00 2.89433228e+00 1.10133611e+01
 2.24586666e-01 4.51039267e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99307947176387
cond(S) = 87546.95890828753
E1 = -729.532310680137  E_coul = 203.18048220714056
init E= -526.351828472996
    CPU time for initialize scf      0.09 sec, wall time      0.04 sec
  HOMO = -0.555709189459689  LUMO = 1.0492489107738
  mo_energy =
[-1.18331961e+02 -1.22047287e+01 -9.44673291e+00 -9.44673291e+00
 -9.44673291e+00 -1.23986494e+00 -5.55709189e-01 -5.55709189e-01
 -5.55709189e-01  1.04924891e+00  1.04924891e+00  1.04924891e+00
  1.09684997e+00  7.58714937e+00  7.58714937e+00  7.58714937e+00
  1.37139225e+01  3.44950869e+01  3.44950869e+01  3.44950869e+01
  1.22243393e+02  1.31550735e+02  1.31550735e+02  1.31550735e+02
  4.83452882e+02  4.83452882e+02  4.83452882e+02  6.61280877e+02
  1.32390692e+03  1.32390692e+03  1.32390692e+03  2.79886771e+03
  3.00269193e+03  3.00269193e+03  3.00269193e+03  6.61290762e+03
  6.61290762e+03  6.61290762e+03  9.21095334e+03  2.55525769e+04
  7.62810601e+04]
E1 = -727.8767152872796  E_coul = 201.1311666082881
cycle= 1 E= -526.745548678991  delta_E= -0.394  |g|= 0.184  |ddm|= 0.305
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538265
diis-c [-0.28972896  1.        ]
  HOMO = -0.590195514305554  LUMO = 1.02482470908638
  mo_energy =
[-1.18636368e+02 -1.23410474e+01 -9.59356528e+00 -9.59356528e+00
 -9.59356528e+00 -1.27897763e+00 -5.90195514e-01 -5.90195514e-01
 -5.90195514e-01  1.02482471e+00  1.02482471e+00  1.02482471e+00
  1.06687226e+00  7.49567348e+00  7.49567348e+00  7.49567348e+00
  1.36009523e+01  3.43416096e+01  3.43416096e+01  3.43416096e+01
  1.22016562e+02  1.31324558e+02  1.31324558e+02  1.31324558e+02
  4.83150941e+02  4.83150941e+02  4.83150941e+02  6.60931769e+02
  1.32354954e+03  1.32354954e+03  1.32354954e+03  2.79837556e+03
  3.00226881e+03  3.00226881e+03  3.00226881e+03  6.61237237e+03
  6.61237237e+03  6.61237237e+03  9.21034472e+03  2.55518745e+04
  7.62802680e+04]
E1 = -728.4432337094361  E_coul = 201.69698313013902
cycle= 2 E= -526.746250579297  delta_E= -0.000702  |g|= 0.0371  |ddm|= 0.0535
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745072
diis-c [-0.00325191  0.08222433  0.91777567]
  HOMO = -0.58120969664586  LUMO = 1.03157477868173
  mo_energy =
[-1.18569528e+02 -1.23034836e+01 -9.55435852e+00 -9.55435852e+00
 -9.55435852e+00 -1.26822271e+00 -5.81209697e-01 -5.81209697e-01
 -5.81209697e-01  1.03157478e+00  1.03157478e+00  1.03157478e+00
  1.07540722e+00  7.51952170e+00  7.51952170e+00  7.51952170e+00
  1.36317688e+01  3.43814579e+01  3.43814579e+01  3.43814579e+01
  1.22073154e+02  1.31379821e+02  1.31379821e+02  1.31379821e+02
  4.83216871e+02  4.83216871e+02  4.83216871e+02  6.61000673e+02
  1.32361950e+03  1.32361950e+03  1.32361950e+03  2.79844891e+03
  3.00234103e+03  3.00234103e+03  3.00234103e+03  6.61244635e+03
  6.61244635e+03  6.61244635e+03  9.21041951e+03  2.55519499e+04
  7.62803436e+04]
E1 = -728.2949737508864  E_coul = 201.54866574427885
cycle= 3 E= -526.746308006607  delta_E= -5.74e-05  |g|= 0.00621  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130476
diis-c [-5.30276248e-07 -1.21764163e-03  1.44675200e-01  8.56542442e-01]
  HOMO = -0.582685597515161  LUMO = 1.0304895697025
  mo_energy =
[-1.18579367e+02 -1.23092191e+01 -9.56043461e+00 -9.56043461e+00
 -9.56043461e+00 -1.26989348e+00 -5.82685598e-01 -5.82685598e-01
 -5.82685598e-01  1.03048957e+00  1.03048957e+00  1.03048957e+00
  1.07410005e+00  7.51573204e+00  7.51573204e+00  7.51573204e+00
  1.36270391e+01  3.43753246e+01  3.43753246e+01  3.43753246e+01
  1.22064762e+02  1.31371564e+02  1.31371564e+02  1.31371564e+02
  4.83207160e+02  4.83207160e+02  4.83207160e+02  6.60990518e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843798e+03
  3.00233035e+03  3.00233035e+03  3.00233035e+03  6.61243528e+03
  6.61243528e+03  6.61243528e+03  9.21040823e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3174729114652  E_coul = 201.5711630310455
cycle= 4 E= -526.74630988042  delta_E= -1.87e-06  |g|= 9.2e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106398
diis-c [-3.73373751e-09  6.68014919e-05 -9.71271510e-03 -6.30335923e-02
  1.07267951e+00]
  HOMO = -0.582667242591159  LUMO = 1.03050539660743
  mo_energy =
[-1.18579327e+02 -1.23091557e+01 -9.56038396e+00 -9.56038396e+00
 -9.56038396e+00 -1.26985409e+00 -5.82667243e-01 -5.82667243e-01
 -5.82667243e-01  1.03050540e+00  1.03050540e+00  1.03050540e+00
  1.07413412e+00  7.51577355e+00  7.51577355e+00  7.51577355e+00
  1.36270975e+01  3.43753734e+01  3.43753734e+01  3.43753734e+01
  1.22064812e+02  1.31371611e+02  1.31371611e+02  1.31371611e+02
  4.83207201e+02  4.83207201e+02  4.83207201e+02  6.60990551e+02
  1.32360924e+03  1.32360924e+03  1.32360924e+03  2.79843799e+03
  3.00233037e+03  3.00233037e+03  3.00233037e+03  6.61243529e+03
  6.61243529e+03  6.61243529e+03  9.21040823e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.317267014632  E_coul = 201.57095713277752
cycle= 5 E= -526.746309881854  delta_E= -1.43e-09  |g|= 1.97e-05  |ddm|= 0.000146
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.76858e-05
diis-c [-6.41137449e-11  1.38097294e-05 -1.81987635e-03 -1.36311264e-02
  4.35359450e-02  9.71901248e-01]
  HOMO = -0.582674263458452  LUMO = 1.03050064747096
  mo_energy =
[-1.18579356e+02 -1.23091772e+01 -9.56040730e+00 -9.56040730e+00
 -9.56040730e+00 -1.26985974e+00 -5.82674263e-01 -5.82674263e-01
 -5.82674263e-01  1.03050065e+00  1.03050065e+00  1.03050065e+00
  1.07413010e+00  7.51575755e+00  7.51575755e+00  7.51575755e+00
  1.36270796e+01  3.43753506e+01  3.43753506e+01  3.43753506e+01
  1.22064785e+02  1.31371584e+02  1.31371584e+02  1.31371584e+02
  4.83207172e+02  4.83207172e+02  4.83207172e+02  6.60990521e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843796e+03
  3.00233034e+03  3.00233034e+03  3.00233034e+03  6.61243525e+03
  6.61243525e+03  6.61243525e+03  9.21040820e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3173452301883  E_coul = 201.5710353482823
cycle= 6 E= -526.746309881906  delta_E= -5.15e-11  |g|= 1.65e-06  |ddm|= 1.7e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3173452301883  E_coul = 201.5710353482823
  HOMO = -0.582674292257226  LUMO = 1.03050067969559
  mo_energy =
[-1.18579356e+02 -1.23091771e+01 -9.56040730e+00 -9.56040730e+00
 -9.56040730e+00 -1.26985941e+00 -5.82674292e-01 -5.82674292e-01
 -5.82674292e-01  1.03050068e+00  1.03050068e+00  1.03050068e+00
  1.07413042e+00  7.51575755e+00  7.51575755e+00  7.51575755e+00
  1.36270798e+01  3.43753506e+01  3.43753506e+01  3.43753506e+01
  1.22064785e+02  1.31371584e+02  1.31371584e+02  1.31371584e+02
  4.83207172e+02  4.83207172e+02  4.83207172e+02  6.60990521e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843796e+03
  3.00233034e+03  3.00233034e+03  3.00233034e+03  6.61243525e+03
  6.61243525e+03  6.61243525e+03  9.21040820e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3173445771158  E_coul = 201.571034695208
Extra cycle  E= -526.746309881908  delta_E= -1.82e-12  |g|= 3.36e-07  |ddm|= 2.81e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
exp = [2.61830283e+04 7.61680385e+03 3.61780622e+03 1.58332489e+03
 4.15686824e+02 1.21908761e+02 3.93568114e+01 8.47906413e+00
 3.36012799e+00 6.89324037e-01 2.54329064e-01 1.36291665e+03
 6.63507455e+02 2.95122182e+02 3.09029786e+02 6.23272052e+01
 7.50739133e+00 2.05835596e+01 7.85611774e-01 2.89433228e+00
 2.24586666e-01]
E = -526.7463098819078
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:16:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.0283299        1
[INPUT] 0    0    [1    /1   ]  7616.80384738        1
[INPUT] 0    0    [1    /1   ]  3617.80622473        1
[INPUT] 0    0    [1    /1   ]  1583.32489465        1
[INPUT] 0    0    [1    /1   ]  415.686823927        1
[INPUT] 0    0    [1    /1   ]  121.908761433        1
[INPUT] 0    0    [1    /1   ]  39.3568114004        1
[INPUT] 0    0    [1    /1   ]  8.4790641265         1
[INPUT] 0    0    [1    /1   ]  3.36012798616        1
[INPUT] 0    0    [1    /1   ]  0.6893240367         1
[INPUT] 0    0    [1    /1   ]  0.254329064014       1
[INPUT] 1    0    [1    /1   ]  1362.91664859        1
[INPUT] 1    0    [1    /1   ]  663.507454992        1
[INPUT] 1    0    [1    /1   ]  295.122182477        1
[INPUT] 1    0    [1    /1   ]  309.029786144        1
[INPUT] 1    0    [1    /1   ]  62.3272051908        1
[INPUT] 1    0    [1    /1   ]  7.50739132715        1
[INPUT] 1    0    [1    /1   ]  20.5835595964        1
[INPUT] 1    0    [1    /1   ]  0.785611773706       1
[INPUT] 1    0    [1    /1   ]  2.89433228489        1
[INPUT] 1    0    [1    /1   ]  0.224586666017       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26183.028329930425, 1.0]], [0, [7616.80384737847, 1.0]], [0, [3617.806224726722, 1.0]], [0, [1583.324894650815, 1.0]], [0, [415.68682392727857, 1.0]], [0, [121.90876143307074, 1.0]], [0, [39.35681140044986, 1.0]], [0, [8.47906412649586, 1.0]], [0, [3.3601279861565536, 1.0]], [0, [0.6893240367000204, 1.0]], [0, [0.2543290640139938, 1.0]], [1, [1362.9166485873818, 1.0]], [1, [663.5074549924263, 1.0]], [1, [295.12218247689117, 1.0]], [1, [309.0297861444855, 1.0]], [1, [62.32720519075591, 1.0]], [1, [7.507391327154229, 1.0]], [1, [20.583559596441603, 1.0]], [1, [0.7856117737064346, 1.0]], [1, [2.8943322848905004, 1.0]], [1, [0.22458666601704322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.02832993]
bas 1, expnt(s) = [7616.80384738]
bas 2, expnt(s) = [3617.80622473]
bas 3, expnt(s) = [1583.32489465]
bas 4, expnt(s) = [415.68682393]
bas 5, expnt(s) = [121.90876143]
bas 6, expnt(s) = [39.3568114]
bas 7, expnt(s) = [8.47906413]
bas 8, expnt(s) = [3.36012799]
bas 9, expnt(s) = [0.68932404]
bas 10, expnt(s) = [0.25432906]
bas 11, expnt(s) = [1362.91664859]
bas 12, expnt(s) = [663.50745499]
bas 13, expnt(s) = [295.12218248]
bas 14, expnt(s) = [309.02978614]
bas 15, expnt(s) = [62.32720519]
bas 16, expnt(s) = [7.50739133]
bas 17, expnt(s) = [20.5835596]
bas 18, expnt(s) = [0.78561177]
bas 19, expnt(s) = [2.89433228]
bas 20, expnt(s) = [0.22458667]
CPU time:       636.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61830283e+04 5.20031835e+03 7.61680385e+03 2.05989272e+03
 3.61780622e+03 1.17855268e+03 1.58332489e+03 6.34150814e+02
 4.15686824e+02 2.32589293e+02 1.21908761e+02 9.26917781e+01
 3.93568114e+01 3.96990353e+01 8.47906413e+00 1.25538219e+01
 3.36012799e+00 6.27020715e+00 6.89324037e-01 1.91131642e+00
 2.54329064e-01 9.04819640e-01 1.36291665e+03 2.41585583e+04
 6.63507455e+02 9.82407459e+03 2.95122182e+02 3.56850829e+03
 3.09029786e+02 3.77993924e+03 6.23272052e+01 5.10894773e+02
 7.50739133e+00 3.62531469e+01 2.05835596e+01 1.27904255e+02
 7.85611774e-01 2.15771645e+00 2.89433228e+00 1.10133611e+01
 2.24586666e-01 4.51039267e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99307947176387
cond(S) = 87546.95890828753
E1 = -729.532310680137  E_coul = 203.18048220714056
init E= -526.351828472996
    CPU time for initialize scf      0.10 sec, wall time      0.04 sec
  HOMO = -0.555709189459689  LUMO = 1.0492489107738
  mo_energy =
[-1.18331961e+02 -1.22047287e+01 -9.44673291e+00 -9.44673291e+00
 -9.44673291e+00 -1.23986494e+00 -5.55709189e-01 -5.55709189e-01
 -5.55709189e-01  1.04924891e+00  1.04924891e+00  1.04924891e+00
  1.09684997e+00  7.58714937e+00  7.58714937e+00  7.58714937e+00
  1.37139225e+01  3.44950869e+01  3.44950869e+01  3.44950869e+01
  1.22243393e+02  1.31550735e+02  1.31550735e+02  1.31550735e+02
  4.83452882e+02  4.83452882e+02  4.83452882e+02  6.61280877e+02
  1.32390692e+03  1.32390692e+03  1.32390692e+03  2.79886771e+03
  3.00269193e+03  3.00269193e+03  3.00269193e+03  6.61290762e+03
  6.61290762e+03  6.61290762e+03  9.21095334e+03  2.55525769e+04
  7.62810601e+04]
E1 = -727.8767152872796  E_coul = 201.1311666082881
cycle= 1 E= -526.745548678991  delta_E= -0.394  |g|= 0.184  |ddm|= 0.305
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538265
diis-c [-0.28972896  1.        ]
  HOMO = -0.590195514305554  LUMO = 1.02482470908638
  mo_energy =
[-1.18636368e+02 -1.23410474e+01 -9.59356528e+00 -9.59356528e+00
 -9.59356528e+00 -1.27897763e+00 -5.90195514e-01 -5.90195514e-01
 -5.90195514e-01  1.02482471e+00  1.02482471e+00  1.02482471e+00
  1.06687226e+00  7.49567348e+00  7.49567348e+00  7.49567348e+00
  1.36009523e+01  3.43416096e+01  3.43416096e+01  3.43416096e+01
  1.22016562e+02  1.31324558e+02  1.31324558e+02  1.31324558e+02
  4.83150941e+02  4.83150941e+02  4.83150941e+02  6.60931769e+02
  1.32354954e+03  1.32354954e+03  1.32354954e+03  2.79837556e+03
  3.00226881e+03  3.00226881e+03  3.00226881e+03  6.61237237e+03
  6.61237237e+03  6.61237237e+03  9.21034472e+03  2.55518745e+04
  7.62802680e+04]
E1 = -728.4432337094361  E_coul = 201.69698313013902
cycle= 2 E= -526.746250579297  delta_E= -0.000702  |g|= 0.0371  |ddm|= 0.0535
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745072
diis-c [-0.00325191  0.08222433  0.91777567]
  HOMO = -0.58120969664586  LUMO = 1.03157477868173
  mo_energy =
[-1.18569528e+02 -1.23034836e+01 -9.55435852e+00 -9.55435852e+00
 -9.55435852e+00 -1.26822271e+00 -5.81209697e-01 -5.81209697e-01
 -5.81209697e-01  1.03157478e+00  1.03157478e+00  1.03157478e+00
  1.07540722e+00  7.51952170e+00  7.51952170e+00  7.51952170e+00
  1.36317688e+01  3.43814579e+01  3.43814579e+01  3.43814579e+01
  1.22073154e+02  1.31379821e+02  1.31379821e+02  1.31379821e+02
  4.83216871e+02  4.83216871e+02  4.83216871e+02  6.61000673e+02
  1.32361950e+03  1.32361950e+03  1.32361950e+03  2.79844891e+03
  3.00234103e+03  3.00234103e+03  3.00234103e+03  6.61244635e+03
  6.61244635e+03  6.61244635e+03  9.21041951e+03  2.55519499e+04
  7.62803436e+04]
E1 = -728.2949737508864  E_coul = 201.54866574427885
cycle= 3 E= -526.746308006607  delta_E= -5.74e-05  |g|= 0.00621  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130476
diis-c [-5.30276248e-07 -1.21764163e-03  1.44675200e-01  8.56542442e-01]
  HOMO = -0.582685597515161  LUMO = 1.0304895697025
  mo_energy =
[-1.18579367e+02 -1.23092191e+01 -9.56043461e+00 -9.56043461e+00
 -9.56043461e+00 -1.26989348e+00 -5.82685598e-01 -5.82685598e-01
 -5.82685598e-01  1.03048957e+00  1.03048957e+00  1.03048957e+00
  1.07410005e+00  7.51573204e+00  7.51573204e+00  7.51573204e+00
  1.36270391e+01  3.43753246e+01  3.43753246e+01  3.43753246e+01
  1.22064762e+02  1.31371564e+02  1.31371564e+02  1.31371564e+02
  4.83207160e+02  4.83207160e+02  4.83207160e+02  6.60990518e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843798e+03
  3.00233035e+03  3.00233035e+03  3.00233035e+03  6.61243528e+03
  6.61243528e+03  6.61243528e+03  9.21040823e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3174729114652  E_coul = 201.5711630310455
cycle= 4 E= -526.74630988042  delta_E= -1.87e-06  |g|= 9.2e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106398
diis-c [-3.73373751e-09  6.68014919e-05 -9.71271510e-03 -6.30335923e-02
  1.07267951e+00]
  HOMO = -0.582667242591159  LUMO = 1.03050539660743
  mo_energy =
[-1.18579327e+02 -1.23091557e+01 -9.56038396e+00 -9.56038396e+00
 -9.56038396e+00 -1.26985409e+00 -5.82667243e-01 -5.82667243e-01
 -5.82667243e-01  1.03050540e+00  1.03050540e+00  1.03050540e+00
  1.07413412e+00  7.51577355e+00  7.51577355e+00  7.51577355e+00
  1.36270975e+01  3.43753734e+01  3.43753734e+01  3.43753734e+01
  1.22064812e+02  1.31371611e+02  1.31371611e+02  1.31371611e+02
  4.83207201e+02  4.83207201e+02  4.83207201e+02  6.60990551e+02
  1.32360924e+03  1.32360924e+03  1.32360924e+03  2.79843799e+03
  3.00233037e+03  3.00233037e+03  3.00233037e+03  6.61243529e+03
  6.61243529e+03  6.61243529e+03  9.21040823e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.317267014632  E_coul = 201.57095713277752
cycle= 5 E= -526.746309881854  delta_E= -1.43e-09  |g|= 1.97e-05  |ddm|= 0.000146
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.76858e-05
diis-c [-6.41137449e-11  1.38097294e-05 -1.81987635e-03 -1.36311264e-02
  4.35359450e-02  9.71901248e-01]
  HOMO = -0.582674263458452  LUMO = 1.03050064747096
  mo_energy =
[-1.18579356e+02 -1.23091772e+01 -9.56040730e+00 -9.56040730e+00
 -9.56040730e+00 -1.26985974e+00 -5.82674263e-01 -5.82674263e-01
 -5.82674263e-01  1.03050065e+00  1.03050065e+00  1.03050065e+00
  1.07413010e+00  7.51575755e+00  7.51575755e+00  7.51575755e+00
  1.36270796e+01  3.43753506e+01  3.43753506e+01  3.43753506e+01
  1.22064785e+02  1.31371584e+02  1.31371584e+02  1.31371584e+02
  4.83207172e+02  4.83207172e+02  4.83207172e+02  6.60990521e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843796e+03
  3.00233034e+03  3.00233034e+03  3.00233034e+03  6.61243525e+03
  6.61243525e+03  6.61243525e+03  9.21040820e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3173452301883  E_coul = 201.5710353482823
cycle= 6 E= -526.746309881906  delta_E= -5.15e-11  |g|= 1.65e-06  |ddm|= 1.7e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3173452301883  E_coul = 201.5710353482823
  HOMO = -0.582674292257226  LUMO = 1.03050067969559
  mo_energy =
[-1.18579356e+02 -1.23091771e+01 -9.56040730e+00 -9.56040730e+00
 -9.56040730e+00 -1.26985941e+00 -5.82674292e-01 -5.82674292e-01
 -5.82674292e-01  1.03050068e+00  1.03050068e+00  1.03050068e+00
  1.07413042e+00  7.51575755e+00  7.51575755e+00  7.51575755e+00
  1.36270798e+01  3.43753506e+01  3.43753506e+01  3.43753506e+01
  1.22064785e+02  1.31371584e+02  1.31371584e+02  1.31371584e+02
  4.83207172e+02  4.83207172e+02  4.83207172e+02  6.60990521e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843796e+03
  3.00233034e+03  3.00233034e+03  3.00233034e+03  6.61243525e+03
  6.61243525e+03  6.61243525e+03  9.21040820e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3173445771158  E_coul = 201.571034695208
Extra cycle  E= -526.746309881908  delta_E= -1.82e-12  |g|= 3.36e-07  |ddm|= 2.81e-06
    CPU time for scf_cycle      0.33 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 87546.95890828753
E1 = -728.3173445771158  E_coul = 201.571034695208
init E= -526.746309881908
    CPU time for initialize scf      0.91 sec, wall time      0.25 sec
  HOMO = -0.582674314760072  LUMO = 1.0305006744535
  mo_energy =
[-1.18579356e+02 -1.23091772e+01 -9.56040737e+00 -9.56040737e+00
 -9.56040737e+00 -1.26985936e+00 -5.82674315e-01 -5.82674315e-01
 -5.82674315e-01  1.03050067e+00  1.03050067e+00  1.03050067e+00
  1.07413046e+00  7.51575751e+00  7.51575751e+00  7.51575751e+00
  1.36270798e+01  3.43753506e+01  3.43753506e+01  3.43753506e+01
  1.22064785e+02  1.31371584e+02  1.31371584e+02  1.31371584e+02
  4.83207172e+02  4.83207172e+02  4.83207172e+02  6.60990521e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843796e+03
  3.00233034e+03  3.00233034e+03  3.00233034e+03  6.61243525e+03
  6.61243525e+03  6.61243525e+03  9.21040820e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3173446696569  E_coul = 201.57103478774883
cycle= 1 E= -526.746309881908  delta_E= -2.27e-13  |g|= 6.91e-08  |ddm|= 5.52e-07
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -728.3173446696569  E_coul = 201.57103478774883
  HOMO = -0.582674315101628  LUMO = 1.03050067647917
  mo_energy =
[-1.18579356e+02 -1.23091772e+01 -9.56040737e+00 -9.56040737e+00
 -9.56040737e+00 -1.26985935e+00 -5.82674315e-01 -5.82674315e-01
 -5.82674315e-01  1.03050068e+00  1.03050068e+00  1.03050068e+00
  1.07413048e+00  7.51575752e+00  7.51575752e+00  7.51575752e+00
  1.36270798e+01  3.43753506e+01  3.43753506e+01  3.43753506e+01
  1.22064785e+02  1.31371584e+02  1.31371584e+02  1.31371584e+02
  4.83207172e+02  4.83207172e+02  4.83207172e+02  6.60990521e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843796e+03
  3.00233034e+03  3.00233034e+03  3.00233034e+03  6.61243525e+03
  6.61243525e+03  6.61243525e+03  9.21040820e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3173446251096  E_coul = 201.571034743203
Extra cycle  E= -526.746309881907  delta_E= 1.36e-12  |g|= 1.38e-08  |ddm|= 1.14e-07
    CPU time for scf_cycle      1.04 sec, wall time      0.38 sec
exp = [2.61830283e+04 7.61680385e+03 3.61780622e+03 1.58332489e+03
 4.15686824e+02 1.21908761e+02 3.93568114e+01 8.47906413e+00
 3.36012799e+00 6.89324037e-01 2.54329064e-01 1.36291665e+03
 6.63507455e+02 2.95122182e+02 3.09029786e+02 6.23272052e+01
 7.50739133e+00 2.05835596e+01 7.85611774e-01 2.89433228e+00
 2.24586666e-01]
grad_E = [-1.40319860e-06  2.20712260e-06 -2.17345446e-06  3.88943768e-05
 -2.77255489e-06 -2.17345806e-05  5.38710319e-05 -3.60712076e-04
  1.24644472e-03  1.89926706e-03 -1.14364306e-03 -5.85369354e-07
  4.28133827e-06  1.99046566e-05  1.68738524e-05  5.70316719e-05
 -1.75510714e-05 -1.95238337e-04  4.20155115e-03  1.98518691e-03
 -1.06772393e-02]
 message: Iteration limit reached
 success: False
  status: 9
     fun: -526.7463098819078
       x: [ 2.618e+04  7.617e+03 ...  2.894e+00  2.246e-01]
     nit: 100
     jac: [-1.403e-06  2.207e-06 ...  1.985e-03 -1.068e-02]
    nfev: 103
    njev: 100
#INFO: **** input file is /project/6004934/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf, re, os, numpy as np
from pyscfad import gto, scf

from scipy import optimize

SOLVER = 'SLSQP'
VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)
    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]
    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])
    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    e = mf.kernel()
    print(f"exp = {exponents}")
    print(f"E = {e}")
    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom
    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    mol.verbose = VERBOSITY
    mol.build()
    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()
    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")
    grad_E = np.array(jac.exp)
    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0])) # Lower and upper bounds
    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method=SOLVER,
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-10,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-10},
    )
    print(res)
    print(f"Final energy = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
number_of_s_exps = 11
number_of_p_exps = 10

exps = np.zeros((number_of_s_exps+number_of_p_exps,2))
#exps[:, 0] = decaying_nums(5)

exps=np.matrix('\
2.6182655855248540e+04 0 ;\
7.6175219156270523e+03 0 ;\
3.6173508674245704e+03 0 ;\
1.5978256930291025e+03 0 ;\
3.8285114947300525e+02 0 ;\
1.0812108340299351e+02 0 ;\
3.4805469069754821e+01 0 ;\
7.5852239053434207e+00 0 ;\
2.5852239053434207e+00 0 ;\
3.9531349055767473e-01 0 ;\
9.9531349055767473e-02 0 ;\
1.3627832062666114e+03 0 ;\
6.6474568098719237e+02 0 ;\
3.0096199157445062e+02 0 ;\
3.1404227399917028e+02 0 ;\
6.1622235863813884e+01 0 ;\
7.3298979484064786e+00 0 ;\
2.0239120129550937e+01 0 ;\
7.7207036457256351e-01 0 ;\
2.8088784348099196e+00 0 ;\
2.2257363203907735e-01 0  \
')
exps=np.array(exps)

basis =  str(number_of_s_exps)+"s"+str(number_of_p_exps)+"p"

minimize_energy(basis, exps)

if np.max(exps[:,1]) ==1:
    name = 'out_'+SOLVER+'-f_'+basis+'.job'
else:    
    name = 'out_'+SOLVER+'_'+basis+'.job'
os.rename("out_and_err."+os.environ["SLURM_JOB_ID"],name+'.'+os.environ["SLURM_JOB_ID"])
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cdr541.int.cedar.computecanada.ca', release='3.10.0-1160.80.1.el7.x86_64', version='#1 SMP Tue Nov 8 15:48:59 UTC 2022', machine='x86_64')  Threads 8
Python 3.10.2 (main, Feb  4 2022, 19:10:35) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Sun Mar 19 09:17:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.62940138.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  26183.0283299        1
[INPUT] 0    0    [1    /1   ]  7616.80384738        1
[INPUT] 0    0    [1    /1   ]  3617.80622473        1
[INPUT] 0    0    [1    /1   ]  1583.32489465        1
[INPUT] 0    0    [1    /1   ]  415.686823927        1
[INPUT] 0    0    [1    /1   ]  121.908761433        1
[INPUT] 0    0    [1    /1   ]  39.3568114004        1
[INPUT] 0    0    [1    /1   ]  8.4790641265         1
[INPUT] 0    0    [1    /1   ]  3.36012798616        1
[INPUT] 0    0    [1    /1   ]  0.6893240367         1
[INPUT] 0    0    [1    /1   ]  0.254329064014       1
[INPUT] 1    0    [1    /1   ]  1362.91664859        1
[INPUT] 1    0    [1    /1   ]  663.507454992        1
[INPUT] 1    0    [1    /1   ]  295.122182477        1
[INPUT] 1    0    [1    /1   ]  309.029786144        1
[INPUT] 1    0    [1    /1   ]  62.3272051908        1
[INPUT] 1    0    [1    /1   ]  7.50739132715        1
[INPUT] 1    0    [1    /1   ]  20.5835595964        1
[INPUT] 1    0    [1    /1   ]  0.785611773706       1
[INPUT] 1    0    [1    /1   ]  2.89433228489        1
[INPUT] 1    0    [1    /1   ]  0.224586666017       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 41
number of NR cGTOs = 41
basis = {'Ar': [[0, [26183.028329930425, 1.0]], [0, [7616.80384737847, 1.0]], [0, [3617.806224726722, 1.0]], [0, [1583.324894650815, 1.0]], [0, [415.68682392727857, 1.0]], [0, [121.90876143307074, 1.0]], [0, [39.35681140044986, 1.0]], [0, [8.47906412649586, 1.0]], [0, [3.3601279861565536, 1.0]], [0, [0.6893240367000204, 1.0]], [0, [0.2543290640139938, 1.0]], [1, [1362.9166485873818, 1.0]], [1, [663.5074549924263, 1.0]], [1, [295.12218247689117, 1.0]], [1, [309.0297861444855, 1.0]], [1, [62.32720519075591, 1.0]], [1, [7.507391327154229, 1.0]], [1, [20.583559596441603, 1.0]], [1, [0.7856117737064346, 1.0]], [1, [2.8943322848905004, 1.0]], [1, [0.22458666601704322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [26183.02832993]
bas 1, expnt(s) = [7616.80384738]
bas 2, expnt(s) = [3617.80622473]
bas 3, expnt(s) = [1583.32489465]
bas 4, expnt(s) = [415.68682393]
bas 5, expnt(s) = [121.90876143]
bas 6, expnt(s) = [39.3568114]
bas 7, expnt(s) = [8.47906413]
bas 8, expnt(s) = [3.36012799]
bas 9, expnt(s) = [0.68932404]
bas 10, expnt(s) = [0.25432906]
bas 11, expnt(s) = [1362.91664859]
bas 12, expnt(s) = [663.50745499]
bas 13, expnt(s) = [295.12218248]
bas 14, expnt(s) = [309.02978614]
bas 15, expnt(s) = [62.32720519]
bas 16, expnt(s) = [7.50739133]
bas 17, expnt(s) = [20.5835596]
bas 18, expnt(s) = [0.78561177]
bas 19, expnt(s) = [2.89433228]
bas 20, expnt(s) = [0.22458667]
CPU time:       642.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]
 [ 0  1  1  1  0 58 59  0]
 [ 0  1  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.61830283e+04 5.20031835e+03 7.61680385e+03 2.05989272e+03
 3.61780622e+03 1.17855268e+03 1.58332489e+03 6.34150814e+02
 4.15686824e+02 2.32589293e+02 1.21908761e+02 9.26917781e+01
 3.93568114e+01 3.96990353e+01 8.47906413e+00 1.25538219e+01
 3.36012799e+00 6.27020715e+00 6.89324037e-01 1.91131642e+00
 2.54329064e-01 9.04819640e-01 1.36291665e+03 2.41585583e+04
 6.63507455e+02 9.82407459e+03 2.95122182e+02 3.56850829e+03
 3.09029786e+02 3.77993924e+03 6.23272052e+01 5.10894773e+02
 7.50739133e+00 3.62531469e+01 2.05835596e+01 1.27904255e+02
 7.85611774e-01 2.15771645e+00 2.89433228e+00 1.10133611e+01
 2.24586666e-01 4.51039267e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.99307947176387
cond(S) = 87546.95890828753
E1 = -729.532310680137  E_coul = 203.18048220714056
init E= -526.351828472996
    CPU time for initialize scf      0.11 sec, wall time      0.05 sec
  HOMO = -0.555709189459689  LUMO = 1.0492489107738
  mo_energy =
[-1.18331961e+02 -1.22047287e+01 -9.44673291e+00 -9.44673291e+00
 -9.44673291e+00 -1.23986494e+00 -5.55709189e-01 -5.55709189e-01
 -5.55709189e-01  1.04924891e+00  1.04924891e+00  1.04924891e+00
  1.09684997e+00  7.58714937e+00  7.58714937e+00  7.58714937e+00
  1.37139225e+01  3.44950869e+01  3.44950869e+01  3.44950869e+01
  1.22243393e+02  1.31550735e+02  1.31550735e+02  1.31550735e+02
  4.83452882e+02  4.83452882e+02  4.83452882e+02  6.61280877e+02
  1.32390692e+03  1.32390692e+03  1.32390692e+03  2.79886771e+03
  3.00269193e+03  3.00269193e+03  3.00269193e+03  6.61290762e+03
  6.61290762e+03  6.61290762e+03  9.21095334e+03  2.55525769e+04
  7.62810601e+04]
E1 = -727.8767152872796  E_coul = 201.1311666082881
cycle= 1 E= -526.745548678991  delta_E= -0.394  |g|= 0.184  |ddm|= 0.305
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.538265
diis-c [-0.28972896  1.        ]
  HOMO = -0.590195514305554  LUMO = 1.02482470908638
  mo_energy =
[-1.18636368e+02 -1.23410474e+01 -9.59356528e+00 -9.59356528e+00
 -9.59356528e+00 -1.27897763e+00 -5.90195514e-01 -5.90195514e-01
 -5.90195514e-01  1.02482471e+00  1.02482471e+00  1.02482471e+00
  1.06687226e+00  7.49567348e+00  7.49567348e+00  7.49567348e+00
  1.36009523e+01  3.43416096e+01  3.43416096e+01  3.43416096e+01
  1.22016562e+02  1.31324558e+02  1.31324558e+02  1.31324558e+02
  4.83150941e+02  4.83150941e+02  4.83150941e+02  6.60931769e+02
  1.32354954e+03  1.32354954e+03  1.32354954e+03  2.79837556e+03
  3.00226881e+03  3.00226881e+03  3.00226881e+03  6.61237237e+03
  6.61237237e+03  6.61237237e+03  9.21034472e+03  2.55518745e+04
  7.62802680e+04]
E1 = -728.4432337094361  E_coul = 201.69698313013902
cycle= 2 E= -526.746250579297  delta_E= -0.000702  |g|= 0.0371  |ddm|= 0.0535
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0745072
diis-c [-0.00325191  0.08222433  0.91777567]
  HOMO = -0.58120969664586  LUMO = 1.03157477868173
  mo_energy =
[-1.18569528e+02 -1.23034836e+01 -9.55435852e+00 -9.55435852e+00
 -9.55435852e+00 -1.26822271e+00 -5.81209697e-01 -5.81209697e-01
 -5.81209697e-01  1.03157478e+00  1.03157478e+00  1.03157478e+00
  1.07540722e+00  7.51952170e+00  7.51952170e+00  7.51952170e+00
  1.36317688e+01  3.43814579e+01  3.43814579e+01  3.43814579e+01
  1.22073154e+02  1.31379821e+02  1.31379821e+02  1.31379821e+02
  4.83216871e+02  4.83216871e+02  4.83216871e+02  6.61000673e+02
  1.32361950e+03  1.32361950e+03  1.32361950e+03  2.79844891e+03
  3.00234103e+03  3.00234103e+03  3.00234103e+03  6.61244635e+03
  6.61244635e+03  6.61244635e+03  9.21041951e+03  2.55519499e+04
  7.62803436e+04]
E1 = -728.2949737508864  E_coul = 201.54866574427885
cycle= 3 E= -526.746308006607  delta_E= -5.74e-05  |g|= 0.00621  |ddm|= 0.0162
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0130476
diis-c [-5.30276248e-07 -1.21764163e-03  1.44675200e-01  8.56542442e-01]
  HOMO = -0.582685597515161  LUMO = 1.0304895697025
  mo_energy =
[-1.18579367e+02 -1.23092191e+01 -9.56043461e+00 -9.56043461e+00
 -9.56043461e+00 -1.26989348e+00 -5.82685598e-01 -5.82685598e-01
 -5.82685598e-01  1.03048957e+00  1.03048957e+00  1.03048957e+00
  1.07410005e+00  7.51573204e+00  7.51573204e+00  7.51573204e+00
  1.36270391e+01  3.43753246e+01  3.43753246e+01  3.43753246e+01
  1.22064762e+02  1.31371564e+02  1.31371564e+02  1.31371564e+02
  4.83207160e+02  4.83207160e+02  4.83207160e+02  6.60990518e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843798e+03
  3.00233035e+03  3.00233035e+03  3.00233035e+03  6.61243528e+03
  6.61243528e+03  6.61243528e+03  9.21040823e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3174729114652  E_coul = 201.5711630310455
cycle= 4 E= -526.74630988042  delta_E= -1.87e-06  |g|= 9.2e-05  |ddm|= 0.00226
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000106398
diis-c [-3.73373751e-09  6.68014919e-05 -9.71271510e-03 -6.30335923e-02
  1.07267951e+00]
  HOMO = -0.582667242591159  LUMO = 1.03050539660743
  mo_energy =
[-1.18579327e+02 -1.23091557e+01 -9.56038396e+00 -9.56038396e+00
 -9.56038396e+00 -1.26985409e+00 -5.82667243e-01 -5.82667243e-01
 -5.82667243e-01  1.03050540e+00  1.03050540e+00  1.03050540e+00
  1.07413412e+00  7.51577355e+00  7.51577355e+00  7.51577355e+00
  1.36270975e+01  3.43753734e+01  3.43753734e+01  3.43753734e+01
  1.22064812e+02  1.31371611e+02  1.31371611e+02  1.31371611e+02
  4.83207201e+02  4.83207201e+02  4.83207201e+02  6.60990551e+02
  1.32360924e+03  1.32360924e+03  1.32360924e+03  2.79843799e+03
  3.00233037e+03  3.00233037e+03  3.00233037e+03  6.61243529e+03
  6.61243529e+03  6.61243529e+03  9.21040823e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.317267014632  E_coul = 201.57095713277752
cycle= 5 E= -526.746309881854  delta_E= -1.43e-09  |g|= 1.97e-05  |ddm|= 0.000146
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.76858e-05
diis-c [-6.41137449e-11  1.38097294e-05 -1.81987635e-03 -1.36311264e-02
  4.35359450e-02  9.71901248e-01]
  HOMO = -0.582674263458452  LUMO = 1.03050064747096
  mo_energy =
[-1.18579356e+02 -1.23091772e+01 -9.56040730e+00 -9.56040730e+00
 -9.56040730e+00 -1.26985974e+00 -5.82674263e-01 -5.82674263e-01
 -5.82674263e-01  1.03050065e+00  1.03050065e+00  1.03050065e+00
  1.07413010e+00  7.51575755e+00  7.51575755e+00  7.51575755e+00
  1.36270796e+01  3.43753506e+01  3.43753506e+01  3.43753506e+01
  1.22064785e+02  1.31371584e+02  1.31371584e+02  1.31371584e+02
  4.83207172e+02  4.83207172e+02  4.83207172e+02  6.60990521e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843796e+03
  3.00233034e+03  3.00233034e+03  3.00233034e+03  6.61243525e+03
  6.61243525e+03  6.61243525e+03  9.21040820e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3173452301883  E_coul = 201.5710353482823
cycle= 6 E= -526.746309881906  delta_E= -5.15e-11  |g|= 1.65e-06  |ddm|= 1.7e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -728.3173452301883  E_coul = 201.5710353482823
  HOMO = -0.582674292257226  LUMO = 1.03050067969559
  mo_energy =
[-1.18579356e+02 -1.23091771e+01 -9.56040730e+00 -9.56040730e+00
 -9.56040730e+00 -1.26985941e+00 -5.82674292e-01 -5.82674292e-01
 -5.82674292e-01  1.03050068e+00  1.03050068e+00  1.03050068e+00
  1.07413042e+00  7.51575755e+00  7.51575755e+00  7.51575755e+00
  1.36270798e+01  3.43753506e+01  3.43753506e+01  3.43753506e+01
  1.22064785e+02  1.31371584e+02  1.31371584e+02  1.31371584e+02
  4.83207172e+02  4.83207172e+02  4.83207172e+02  6.60990521e+02
  1.32360921e+03  1.32360921e+03  1.32360921e+03  2.79843796e+03
  3.00233034e+03  3.00233034e+03  3.00233034e+03  6.61243525e+03
  6.61243525e+03  6.61243525e+03  9.21040820e+03  2.55519384e+04
  7.62803320e+04]
E1 = -728.3173445771158  E_coul = 201.571034695208
Extra cycle  E= -526.746309881908  delta_E= -1.82e-12  |g|= 3.36e-07  |ddm|= 2.81e-06
    CPU time for scf_cycle      0.35 sec, wall time      0.28 sec
exp = [2.61830283e+04 7.61680385e+03 3.61780622e+03 1.58332489e+03
 4.15686824e+02 1.21908761e+02 3.93568114e+01 8.47906413e+00
 3.36012799e+00 6.89324037e-01 2.54329064e-01 1.36291665e+03
 6.63507455e+02 2.95122182e+02 3.09029786e+02 6.23272052e+01
 7.50739133e+00 2.05835596e+01 7.85611774e-01 2.89433228e+00
 2.24586666e-01]
E = -526.7463098819078
E = -526.7463098819078
exp = [2.6183028329930425e+04,7.6168038473784700e+03,3.6178062247267221e+03,1.5833248946508149e+03,4.1568682392727857e+02,1.2190876143307074e+02,3.9356811400449857e+01,8.4790641264958602e+00,3.3601279861565536e+00,6.8932403670002040e-01,2.5432906401399380e-01,1.3629166485873818e+03,6.6350745499242635e+02,2.9512218247689117e+02,3.0902978614448551e+02,6.2327205190755912e+01,7.5073913271542292e+00,2.0583559596441603e+01,7.8561177370643465e-01,2.8943322848905004e+00,2.2458666601704322e-01]

real	8m8.675s
user	9m6.960s
sys	1m38.179s
