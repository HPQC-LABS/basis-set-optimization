created virtual environment CPython3.10.2.final.0-64 in 1244ms
  creator CPython3Posix(dest=/localscratch/nike.35635013.0/ENV, clear=True, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/nike/.local/share/virtualenv)
    added seed packages: pip==22.3.1, setuptools==67.3.3, wheel==0.38.4+computecanada
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Requirement already satisfied: pip in /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages (22.3.1)
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pip-23.0+computecanada-py3-none-any.whl
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 22.3.1
    Uninstalling pip-22.3.1:
      Successfully uninstalled pip-22.3.1
Successfully installed pip-23.0+computecanada
Looking in links: /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx512, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic, /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic
Processing /home/nike/pyscf_ad/dist/pyscf-2.1.1+ad-cp310-cp310-linux_x86_64.whl
Processing /home/nike/properties_ad/dist/pyscf_properties-0.1.0+ad-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/absl_py-1.4.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/contourpy-1.0.7+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/cycler-0.11.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/fonttools-4.39.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/h5py-3.8.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jax-0.4.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/jaxlib-0.4.2+cuda11.cudnn82.computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/jaxopt-0.6+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/kiwisolver-1.4.4+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/matplotlib-3.7.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/numpy-1.24.2+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/opt_einsum-3.3.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/packaging-23.0+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/avx2/Pillow-9.4.0+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyparsing-3.0.9+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/pyscfad-0.1.2+computecanada-py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/python_dateutil-2.8.2+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/gentoo/generic/scipy-1.10.1+computecanada-cp310-cp310-linux_x86_64.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/six-1.16.0+computecanada-py2.py3-none-any.whl
Processing /cvmfs/soft.computecanada.ca/custom/python/wheelhouse/generic/typing_extensions-4.5.0+computecanada-py3-none-any.whl
Installing collected packages: typing_extensions, six, pyparsing, Pillow, packaging, numpy, kiwisolver, fonttools, cycler, absl_py, scipy, python-dateutil, opt-einsum, h5py, contourpy, pyscf, matplotlib, jaxlib, pyscf-properties, jax, jaxopt, pyscfad
Successfully installed Pillow-9.4.0+computecanada absl_py-1.4.0+computecanada contourpy-1.0.7+computecanada cycler-0.11.0+computecanada fonttools-4.39.0+computecanada h5py-3.8.0+computecanada jax-0.4.2+computecanada jaxlib-0.4.2+cuda11.cudnn82.computecanada jaxopt-0.6+computecanada kiwisolver-1.4.4+computecanada matplotlib-3.7.0+computecanada numpy-1.24.2+computecanada opt-einsum-3.3.0+computecanada packaging-23.0+computecanada pyparsing-3.0.9+computecanada pyscf-2.1.1+ad pyscf-properties-0.1.0+ad pyscfad-0.1.2+computecanada python-dateutil-2.8.2+computecanada scipy-1.10.1+computecanada six-1.16.0+computecanada typing_extensions-4.5.0+computecanada
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.024939369593       1
[INPUT] 0    0    [1    /1   ]  0.24939369593        1
[INPUT] 0    0    [1    /1   ]  0.649659304069       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03400796007        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189697        1
[INPUT] 0    0    [1    /1   ]  18375.7713557        1
[INPUT] 0    0    [1    /1   ]  1443.52571784        1
[INPUT] 0    0    [1    /1   ]  417.361955852        1
[INPUT] 0    0    [1    /1   ]  147.783947829        1
[INPUT] 0    0    [1    /1   ]  58.4529757123        1
[INPUT] 0    0    [1    /1   ]  24.5576391034        1
[INPUT] 0    0    [1    /1   ]  7.57714951211        1
[INPUT] 1    0    [1    /1   ]  8.60410450036        1
[INPUT] 1    0    [1    /1   ]  0.492699165905       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.024939369593029802, 1.0]], [0, [0.249393695930298, 1.0]], [0, [0.6496593040692155, 1.0]], [0, [117616.81288988463, 1.0]], [0, [3.0340079600687115, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.069956571, 1.0]], [0, [294042.0309214943, 1.0]], [0, [147020.9913235502, 1.0]], [0, [73510.41754935968, 1.0]], [0, [36754.70154120463, 1.0]], [0, [7302.321896969562, 1.0]], [0, [18375.771355655528, 1.0]], [0, [1443.5257178422494, 1.0]], [0, [417.3619558520113, 1.0]], [0, [147.78394782889714, 1.0]], [0, [58.452975712341704, 1.0]], [0, [24.55763910335318, 1.0]], [0, [7.577149512108849, 1.0]], [1, [8.604104500355444, 1.0]], [1, [0.4926991659049108, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.02493937]
bas 1, expnt(s) = [0.2493937]
bas 2, expnt(s) = [0.6496593]
bas 3, expnt(s) = [117616.81288988]
bas 4, expnt(s) = [3.03400796]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132355]
bas 9, expnt(s) = [73510.41754936]
bas 10, expnt(s) = [36754.7015412]
bas 11, expnt(s) = [7302.32189697]
bas 12, expnt(s) = [18375.77135566]
bas 13, expnt(s) = [1443.52571784]
bas 14, expnt(s) = [417.36195585]
bas 15, expnt(s) = [147.78394783]
bas 16, expnt(s) = [58.45297571]
bas 17, expnt(s) = [24.5576391]
bas 18, expnt(s) = [7.57714951]
bas 19, expnt(s) = [8.6041045]
bas 20, expnt(s) = [0.49269917]
CPU time:         3.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49393696e-02 1.58554703e-01 2.49393696e-01 8.91618617e-01
 6.49659304e-01 1.82822343e+00 1.17616813e+05 1.60460108e+04
 3.03400796e+00 5.80801275e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232190e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352572e+03 5.91675271e+02
 4.17361956e+02 2.33291904e+02 1.47783948e+02 1.07086684e+02
 5.84529757e+01 5.34096821e+01 2.45576391e+01 2.78711561e+01
 7.57714951e+00 1.15383688e+01 8.60410450e+00 4.29899053e+01
 4.92699166e-01 1.20423619e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336115673527935
cond(S) = 912124.5433148387
E1 = -689.5895878091609  E_coul = 184.96845758414477
init E= -504.621130225016
    CPU time for initialize scf      9.89 sec, wall time      0.82 sec
  HOMO = -0.67221175416863  LUMO = -0.069964479047002
  mo_energy =
[-1.21710172e+02 -1.33861760e+01 -7.62381518e+00 -7.62381518e+00
 -7.62381518e+00 -1.65736847e+00 -6.72211754e-01 -6.72211754e-01
 -6.72211754e-01 -6.99644790e-02  8.02132400e-01  1.02438698e+01
  6.34831805e+01  2.57635828e+02  8.86493645e+02  3.14026944e+03
  1.26209249e+04  4.12182459e+04  1.05246528e+05  2.30419710e+05
  4.56227261e+05  8.45173906e+05  1.52834574e+06  2.85060644e+06
  5.80848513e+06]
E1 = -707.7382053973095  E_coul = 199.76658070338726
cycle= 1 E= -507.971624693922  delta_E= -3.35  |g|= 0.451  |ddm|= 0.489
    CPU time for cycle= 1      0.68 sec, wall time      0.69 sec
diis-norm(errvec)=0.720338
diis-c [-0.5188866  1.       ]
  HOMO = -0.217865307186016  LUMO = 0.0665790538257983
  mo_energy =
[-1.20201898e+02 -1.23056265e+01 -6.59531260e+00 -6.59531260e+00
 -6.59531260e+00 -1.16336567e+00 -2.17865307e-01 -2.17865307e-01
 -2.17865307e-01  6.65790538e-02  1.18571848e+00  1.11098872e+01
  6.47525723e+01  2.59091674e+02  8.87985235e+02  3.14170055e+03
  1.26222493e+04  4.12195031e+04  1.05247748e+05  2.30420906e+05
  4.56228440e+05  8.45175071e+05  1.52834689e+06  2.85060758e+06
  5.80848627e+06]
E1 = -706.7930349832404  E_coul = 198.80380855796656
cycle= 2 E= -507.989226425274  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.429
    CPU time for cycle= 2      0.27 sec, wall time      0.27 sec
diis-norm(errvec)=0.0353882
diis-c [-1.25188988e-03 -9.19958453e-04  1.00091996e+00]
  HOMO = -0.239983028023109  LUMO = 0.0665910614823084
  mo_energy =
[-1.20315361e+02 -1.23724512e+01 -6.66929444e+00 -6.66929444e+00
 -6.66929444e+00 -1.17762506e+00 -2.39983028e-01 -2.39983028e-01
 -2.39983028e-01  6.65910615e-02  1.17922793e+00  1.10636284e+01
  6.46708956e+01  2.58988071e+02  8.87866017e+02  3.14156722e+03
  1.26221059e+04  4.12193558e+04  1.05247600e+05  2.30420756e+05
  4.56228290e+05  8.45174920e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6842164996456  E_coul = 198.69472400190176
cycle= 3 E= -507.989492497744  delta_E= -0.000266  |g|= 0.00443  |ddm|= 0.058
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00456655
diis-c [-3.87638672e-06 -3.00501860e-04 -1.31415737e-01  1.13171624e+00]
  HOMO = -0.243283005029024  LUMO = 0.0665781397975219
  mo_energy =
[-1.20327644e+02 -1.23813881e+01 -6.67873625e+00 -6.67873625e+00
 -6.67873625e+00 -1.17962835e+00 -2.43283005e-01 -2.43283005e-01
 -2.43283005e-01  6.65781398e-02  1.17798771e+00  1.10569704e+01
  6.46608997e+01  2.58976468e+02  8.87853468e+02  3.14155393e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.668078386006  E_coul = 198.6785806032706
cycle= 4 E= -507.989497782735  delta_E= -5.28e-06  |g|= 0.000147  |ddm|= 0.00901
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000195733
diis-c [-2.62666610e-09 -1.20665286e-05  9.19008563e-03 -1.01504509e-01
  1.09232649e+00]
  HOMO = -0.243364788164459  LUMO = 0.0665769126418907
  mo_energy =
[-1.20327737e+02 -1.23815507e+01 -6.67888347e+00 -6.67888347e+00
 -6.67888347e+00 -1.17967656e+00 -2.43364788e-01 -2.43364788e-01
 -2.43364788e-01  6.65769126e-02  1.17794434e+00  1.10568241e+01
  6.46607654e+01  2.58976362e+02  8.87853382e+02  3.14155386e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.6676783134918  E_coul = 198.67818052446952
cycle= 5 E= -507.989497789022  delta_E= -6.29e-09  |g|= 7.13e-06  |ddm|= 0.000237
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.22546e-06
diis-c [-2.57060455e-12  1.13193473e-06 -1.11046055e-03  1.24043280e-02
 -1.41273066e-01  1.12997807e+00]
  HOMO = -0.243361818967654  LUMO = 0.0665769254976598
  mo_energy =
[-1.20327727e+02 -1.23815421e+01 -6.67887470e+00 -6.67887470e+00
 -6.67887470e+00 -1.17967503e+00 -2.43361819e-01 -2.43361819e-01
 -2.43361819e-01  6.65769255e-02  1.17794527e+00  1.10568305e+01
  6.46607744e+01  2.58976371e+02  8.87853392e+02  3.14155387e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.667691185298  E_coul = 198.67819339626016
cycle= 6 E= -507.989497789038  delta_E= -1.56e-11  |g|= 1.41e-07  |ddm|= 1.59e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.667691185298  E_coul = 198.67819339626016
  HOMO = -0.243361756102245  LUMO = 0.0665769224295939
  mo_energy =
[-1.20327726e+02 -1.23815419e+01 -6.67887451e+00 -6.67887451e+00
 -6.67887451e+00 -1.17967497e+00 -2.43361756e-01 -2.43361756e-01
 -2.43361756e-01  6.65769224e-02  1.17794526e+00  1.10568306e+01
  6.46607746e+01  2.58976372e+02  8.87853392e+02  3.14155387e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.6676915374744  E_coul = 198.6781937484364
Extra cycle  E= -507.989497789038  delta_E= -1.14e-13  |g|= 1.77e-08  |ddm|= 2.91e-07
    CPU time for scf_cycle     11.01 sec, wall time      1.95 sec
exp = [2.49393696e-02 2.49393696e-01 6.49659304e-01 1.17616813e+05
 3.03400796e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232190e+03
 1.83757714e+04 1.44352572e+03 4.17361956e+02 1.47783948e+02
 5.84529757e+01 2.45576391e+01 7.57714951e+00 8.60410450e+00
 4.92699166e-01]
E = -507.989497789038
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.024939369593       1
[INPUT] 0    0    [1    /1   ]  0.24939369593        1
[INPUT] 0    0    [1    /1   ]  0.649659304069       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03400796007        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189697        1
[INPUT] 0    0    [1    /1   ]  18375.7713557        1
[INPUT] 0    0    [1    /1   ]  1443.52571784        1
[INPUT] 0    0    [1    /1   ]  417.361955852        1
[INPUT] 0    0    [1    /1   ]  147.783947829        1
[INPUT] 0    0    [1    /1   ]  58.4529757123        1
[INPUT] 0    0    [1    /1   ]  24.5576391034        1
[INPUT] 0    0    [1    /1   ]  7.57714951211        1
[INPUT] 1    0    [1    /1   ]  8.60410450036        1
[INPUT] 1    0    [1    /1   ]  0.492699165905       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.024939369593029802, 1.0]], [0, [0.249393695930298, 1.0]], [0, [0.6496593040692155, 1.0]], [0, [117616.81288988463, 1.0]], [0, [3.0340079600687115, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.069956571, 1.0]], [0, [294042.0309214943, 1.0]], [0, [147020.9913235502, 1.0]], [0, [73510.41754935968, 1.0]], [0, [36754.70154120463, 1.0]], [0, [7302.321896969562, 1.0]], [0, [18375.771355655528, 1.0]], [0, [1443.5257178422494, 1.0]], [0, [417.3619558520113, 1.0]], [0, [147.78394782889714, 1.0]], [0, [58.452975712341704, 1.0]], [0, [24.55763910335318, 1.0]], [0, [7.577149512108849, 1.0]], [1, [8.604104500355444, 1.0]], [1, [0.4926991659049108, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.02493937]
bas 1, expnt(s) = [0.2493937]
bas 2, expnt(s) = [0.6496593]
bas 3, expnt(s) = [117616.81288988]
bas 4, expnt(s) = [3.03400796]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132355]
bas 9, expnt(s) = [73510.41754936]
bas 10, expnt(s) = [36754.7015412]
bas 11, expnt(s) = [7302.32189697]
bas 12, expnt(s) = [18375.77135566]
bas 13, expnt(s) = [1443.52571784]
bas 14, expnt(s) = [417.36195585]
bas 15, expnt(s) = [147.78394783]
bas 16, expnt(s) = [58.45297571]
bas 17, expnt(s) = [24.5576391]
bas 18, expnt(s) = [7.57714951]
bas 19, expnt(s) = [8.6041045]
bas 20, expnt(s) = [0.49269917]
CPU time:        14.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49393696e-02 1.58554703e-01 2.49393696e-01 8.91618617e-01
 6.49659304e-01 1.82822343e+00 1.17616813e+05 1.60460108e+04
 3.03400796e+00 5.80801275e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232190e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352572e+03 5.91675271e+02
 4.17361956e+02 2.33291904e+02 1.47783948e+02 1.07086684e+02
 5.84529757e+01 5.34096821e+01 2.45576391e+01 2.78711561e+01
 7.57714951e+00 1.15383688e+01 8.60410450e+00 4.29899053e+01
 4.92699166e-01 1.20423619e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336115673527935
cond(S) = 912124.5433148387
E1 = -689.5895878091609  E_coul = 184.96845758414477
init E= -504.621130225016
    CPU time for initialize scf      1.31 sec, wall time      0.10 sec
  HOMO = -0.67221175416863  LUMO = -0.069964479047002
  mo_energy =
[-1.21710172e+02 -1.33861760e+01 -7.62381518e+00 -7.62381518e+00
 -7.62381518e+00 -1.65736847e+00 -6.72211754e-01 -6.72211754e-01
 -6.72211754e-01 -6.99644790e-02  8.02132400e-01  1.02438698e+01
  6.34831805e+01  2.57635828e+02  8.86493645e+02  3.14026944e+03
  1.26209249e+04  4.12182459e+04  1.05246528e+05  2.30419710e+05
  4.56227261e+05  8.45173906e+05  1.52834574e+06  2.85060644e+06
  5.80848513e+06]
E1 = -707.7382053973095  E_coul = 199.76658070338726
cycle= 1 E= -507.971624693922  delta_E= -3.35  |g|= 0.451  |ddm|= 0.489
    CPU time for cycle= 1      0.55 sec, wall time      0.03 sec
diis-norm(errvec)=0.720338
diis-c [-0.5188866  1.       ]
  HOMO = -0.217865307186016  LUMO = 0.0665790538257983
  mo_energy =
[-1.20201898e+02 -1.23056265e+01 -6.59531260e+00 -6.59531260e+00
 -6.59531260e+00 -1.16336567e+00 -2.17865307e-01 -2.17865307e-01
 -2.17865307e-01  6.65790538e-02  1.18571848e+00  1.11098872e+01
  6.47525723e+01  2.59091674e+02  8.87985235e+02  3.14170055e+03
  1.26222493e+04  4.12195031e+04  1.05247748e+05  2.30420906e+05
  4.56228440e+05  8.45175071e+05  1.52834689e+06  2.85060758e+06
  5.80848627e+06]
E1 = -706.7930349832404  E_coul = 198.80380855796656
cycle= 2 E= -507.989226425274  delta_E= -0.0176  |g|= 0.0348  |ddm|= 0.429
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0353882
diis-c [-1.25188988e-03 -9.19958453e-04  1.00091996e+00]
  HOMO = -0.239983028023109  LUMO = 0.0665910614823084
  mo_energy =
[-1.20315361e+02 -1.23724512e+01 -6.66929444e+00 -6.66929444e+00
 -6.66929444e+00 -1.17762506e+00 -2.39983028e-01 -2.39983028e-01
 -2.39983028e-01  6.65910615e-02  1.17922793e+00  1.10636284e+01
  6.46708956e+01  2.58988071e+02  8.87866017e+02  3.14156722e+03
  1.26221059e+04  4.12193558e+04  1.05247600e+05  2.30420756e+05
  4.56228290e+05  8.45174920e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6842164996456  E_coul = 198.69472400190176
cycle= 3 E= -507.989492497744  delta_E= -0.000266  |g|= 0.00443  |ddm|= 0.058
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00456655
diis-c [-3.87638672e-06 -3.00501860e-04 -1.31415737e-01  1.13171624e+00]
  HOMO = -0.243283005029024  LUMO = 0.0665781397975219
  mo_energy =
[-1.20327644e+02 -1.23813881e+01 -6.67873625e+00 -6.67873625e+00
 -6.67873625e+00 -1.17962835e+00 -2.43283005e-01 -2.43283005e-01
 -2.43283005e-01  6.65781398e-02  1.17798771e+00  1.10569704e+01
  6.46608997e+01  2.58976468e+02  8.87853468e+02  3.14155393e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.668078386006  E_coul = 198.6785806032706
cycle= 4 E= -507.989497782735  delta_E= -5.28e-06  |g|= 0.000147  |ddm|= 0.00901
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.000195733
diis-c [-2.62666610e-09 -1.20665286e-05  9.19008563e-03 -1.01504509e-01
  1.09232649e+00]
  HOMO = -0.243364788164459  LUMO = 0.0665769126418907
  mo_energy =
[-1.20327737e+02 -1.23815507e+01 -6.67888347e+00 -6.67888347e+00
 -6.67888347e+00 -1.17967656e+00 -2.43364788e-01 -2.43364788e-01
 -2.43364788e-01  6.65769126e-02  1.17794434e+00  1.10568241e+01
  6.46607654e+01  2.58976362e+02  8.87853382e+02  3.14155386e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.6676783134918  E_coul = 198.67818052446952
cycle= 5 E= -507.989497789022  delta_E= -6.29e-09  |g|= 7.13e-06  |ddm|= 0.000237
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=6.22546e-06
diis-c [-2.57060455e-12  1.13193473e-06 -1.11046055e-03  1.24043280e-02
 -1.41273066e-01  1.12997807e+00]
  HOMO = -0.243361818967654  LUMO = 0.0665769254976598
  mo_energy =
[-1.20327727e+02 -1.23815421e+01 -6.67887470e+00 -6.67887470e+00
 -6.67887470e+00 -1.17967503e+00 -2.43361819e-01 -2.43361819e-01
 -2.43361819e-01  6.65769255e-02  1.17794527e+00  1.10568305e+01
  6.46607744e+01  2.58976371e+02  8.87853392e+02  3.14155387e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.667691185298  E_coul = 198.67819339626016
cycle= 6 E= -507.989497789038  delta_E= -1.56e-11  |g|= 1.41e-07  |ddm|= 1.59e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.667691185298  E_coul = 198.67819339626016
  HOMO = -0.243361756102245  LUMO = 0.0665769224295939
  mo_energy =
[-1.20327726e+02 -1.23815419e+01 -6.67887451e+00 -6.67887451e+00
 -6.67887451e+00 -1.17967497e+00 -2.43361756e-01 -2.43361756e-01
 -2.43361756e-01  6.65769224e-02  1.17794526e+00  1.10568306e+01
  6.46607746e+01  2.58976372e+02  8.87853392e+02  3.14155387e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.6676915374744  E_coul = 198.6781937484364
Extra cycle  E= -507.989497789038  delta_E= -1.14e-13  |g|= 1.77e-08  |ddm|= 2.91e-07
    CPU time for scf_cycle      2.07 sec, wall time      0.34 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912124.5433148387
E1 = -706.6676915374744  E_coul = 198.6781937484364
init E= -507.989497789038
    CPU time for initialize scf     13.65 sec, wall time      0.89 sec
  HOMO = -0.243361746507043  LUMO = 0.066576922357424
  mo_energy =
[-1.20327726e+02 -1.23815419e+01 -6.67887449e+00 -6.67887449e+00
 -6.67887449e+00 -1.17967496e+00 -2.43361747e-01 -2.43361747e-01
 -2.43361747e-01  6.65769224e-02  1.17794526e+00  1.10568306e+01
  6.46607746e+01  2.58976372e+02  8.87853392e+02  3.14155387e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.6676915835493  E_coul = 198.67819379451166
cycle= 1 E= -507.989497789038  delta_E= 3.98e-13  |g|= 2.94e-09  |ddm|= 3.63e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.6676915835493  E_coul = 198.67819379451166
  HOMO = -0.243361745246258  LUMO = 0.0665769223744269
  mo_energy =
[-1.20327726e+02 -1.23815419e+01 -6.67887448e+00 -6.67887448e+00
 -6.67887448e+00 -1.17967496e+00 -2.43361745e-01 -2.43361745e-01
 -2.43361745e-01  6.65769224e-02  1.17794526e+00  1.10568306e+01
  6.46607746e+01  2.58976372e+02  8.87853392e+02  3.14155387e+03
  1.26220921e+04  4.12193418e+04  1.05247586e+05  2.30420742e+05
  4.56228276e+05  8.45174906e+05  1.52834672e+06  2.85060742e+06
  5.80848610e+06]
E1 = -706.6676915896338  E_coul = 198.67819380059638
Extra cycle  E= -507.989497789037  delta_E= 1.71e-13  |g|= 1.41e-09  |ddm|= 4.88e-09
    CPU time for scf_cycle     16.25 sec, wall time      3.16 sec
exp = [2.49393696e-02 2.49393696e-01 6.49659304e-01 1.17616813e+05
 3.03400796e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232190e+03
 1.83757714e+04 1.44352572e+03 4.17361956e+02 1.47783948e+02
 5.84529757e+01 2.45576391e+01 7.57714951e+00 8.60410450e+00
 4.92699166e-01]
grad_E = [-3.73156818e-03 -1.19384666e-02  2.69278472e-03  6.06870088e-09
 -4.04249181e-05  4.05118062e-11  1.74366199e-10  9.41289497e-10
  3.71913416e-09  1.55306881e-08  8.10024178e-08  5.10558624e-06
  1.98637036e-07 -3.86172654e-05 -4.91575241e-06 -1.22893145e-06
  1.51120853e-06 -4.02086741e-07  2.30486774e-05 -4.57468645e-05
 -1.28366034e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0286709377703      1
[INPUT] 0    0    [1    /1   ]  0.261332162579       1
[INPUT] 0    0    [1    /1   ]  0.646966519345       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03404838499        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175493        1
[INPUT] 0    0    [1    /1   ]  36754.7015411        1
[INPUT] 0    0    [1    /1   ]  7302.32189186        1
[INPUT] 0    0    [1    /1   ]  18375.7713555        1
[INPUT] 0    0    [1    /1   ]  1443.52575646        1
[INPUT] 0    0    [1    /1   ]  417.361960768        1
[INPUT] 0    0    [1    /1   ]  147.783949058        1
[INPUT] 0    0    [1    /1   ]  58.4529742011        1
[INPUT] 0    0    [1    /1   ]  24.5576395054        1
[INPUT] 0    0    [1    /1   ]  7.57712646343        1
[INPUT] 1    0    [1    /1   ]  8.60415024722        1
[INPUT] 1    0    [1    /1   ]  0.493982826247       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.028670937770275316, 1.0]], [0, [0.26133216257914804, 1.0]], [0, [0.646966519344884, 1.0]], [0, [117616.81288987857, 1.0]], [0, [3.0340483849867734, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565709, 1.0]], [0, [294042.03092149337, 1.0]], [0, [147020.99132354648, 1.0]], [0, [73510.41754934416, 1.0]], [0, [36754.70154112363, 1.0]], [0, [7302.321891863976, 1.0]], [0, [18375.77135545689, 1.0]], [0, [1443.5257564595147, 1.0]], [0, [417.3619607677637, 1.0]], [0, [147.78394905782858, 1.0]], [0, [58.45297420113317, 1.0]], [0, [24.55763950543992, 1.0]], [0, [7.577126463431454, 1.0]], [1, [8.604150247219916, 1.0]], [1, [0.49398282624655254, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.02867094]
bas 1, expnt(s) = [0.26133216]
bas 2, expnt(s) = [0.64696652]
bas 3, expnt(s) = [117616.81288988]
bas 4, expnt(s) = [3.03404838]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132355]
bas 9, expnt(s) = [73510.41754934]
bas 10, expnt(s) = [36754.70154112]
bas 11, expnt(s) = [7302.32189186]
bas 12, expnt(s) = [18375.77135546]
bas 13, expnt(s) = [1443.52575646]
bas 14, expnt(s) = [417.36196077]
bas 15, expnt(s) = [147.78394906]
bas 16, expnt(s) = [58.4529742]
bas 17, expnt(s) = [24.55763951]
bas 18, expnt(s) = [7.57712646]
bas 19, expnt(s) = [8.60415025]
bas 20, expnt(s) = [0.49398283]
CPU time:        45.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.86709378e-02 1.76033956e-01 2.61332163e-01 9.23442102e-01
 6.46966519e-01 1.82253711e+00 1.17616813e+05 1.60460108e+04
 3.03404838e+00 5.80807079e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232189e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352576e+03 5.91675283e+02
 4.17361961e+02 2.33291907e+02 1.47783949e+02 1.07086685e+02
 5.84529742e+01 5.34096811e+01 2.45576395e+01 2.78711564e+01
 7.57712646e+00 1.15383425e+01 8.60415025e+00 4.29901910e+01
 4.93982826e-01 1.20815931e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.334283049679033
cond(S) = 912126.4658125608
E1 = -689.6283034507809  E_coul = 185.00449752444615
init E= -504.623805926335
    CPU time for initialize scf      1.36 sec, wall time      0.10 sec
  HOMO = -0.670867429771412  LUMO = -0.066071799059307
  mo_energy =
[-1.21706970e+02 -1.33831461e+01 -7.62175475e+00 -7.62175475e+00
 -7.62175475e+00 -1.65626335e+00 -6.70867430e-01 -6.70867430e-01
 -6.70867430e-01 -6.60717991e-02  8.53987229e-01  1.03103173e+01
  6.35386320e+01  2.57683639e+02  8.86536146e+02  3.14030757e+03
  1.26209589e+04  4.12182776e+04  1.05246559e+05  2.30419740e+05
  4.56227291e+05  8.45173934e+05  1.52834576e+06  2.85060647e+06
  5.80848516e+06]
E1 = -707.7994567059316  E_coul = 199.8277493635186
cycle= 1 E= -507.971707342413  delta_E= -3.35  |g|= 0.451  |ddm|= 0.505
    CPU time for cycle= 1      0.53 sec, wall time      0.03 sec
diis-norm(errvec)=0.721001
diis-c [-0.51984188  1.        ]
  HOMO = -0.214836728906447  LUMO = 0.0783351385879904
  mo_energy =
[-1.20197381e+02 -1.23010687e+01 -6.59191380e+00 -6.59191380e+00
 -6.59191380e+00 -1.16112500e+00 -2.14836729e-01 -2.14836729e-01
 -2.14836729e-01  7.83351386e-02  1.24250497e+00  1.11775573e+01
  6.48092793e+01  2.59140814e+02  8.88029002e+02  3.14173989e+03
  1.26222845e+04  4.12195359e+04  1.05247780e+05  2.30420937e+05
  4.56228470e+05  8.45175101e+05  1.52834692e+06  2.85060761e+06
  5.80848630e+06]
E1 = -706.860408727536  E_coul = 198.87122531782293
cycle= 2 E= -507.989183409713  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.433
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0359271
diis-c [-0.00128996 -0.00123842  1.00123842]
  HOMO = -0.236762098167987  LUMO = 0.0783562109455535
  mo_energy =
[-1.20310389e+02 -1.23674533e+01 -6.66544827e+00 -6.66544827e+00
 -6.66544827e+00 -1.17521553e+00 -2.36762098e-01 -2.36762098e-01
 -2.36762098e-01  7.83562109e-02  1.23579064e+00  1.11316534e+01
  6.47280472e+01  2.59037664e+02  8.87910241e+02  3.14160701e+03
  1.26221415e+04  4.12193891e+04  1.05247632e+05  2.30420787e+05
  4.56228321e+05  8.45174951e+05  1.52834677e+06  2.85060746e+06
  5.80848615e+06]
E1 = -706.7523117628887  E_coul = 198.76286419278568
cycle= 3 E= -507.989447570103  delta_E= -0.000264  |g|= 0.00442  |ddm|= 0.0583
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00470286
diis-c [-4.08921293e-06 -3.24701654e-04 -1.33573731e-01  1.13389843e+00]
  HOMO = -0.240039575524377  LUMO = 0.0783408094276445
  mo_energy =
[-1.20322593e+02 -1.23763259e+01 -6.67482300e+00 -6.67482300e+00
 -6.67482300e+00 -1.17720019e+00 -2.40039576e-01 -2.40039576e-01
 -2.40039576e-01  7.83408094e-02  1.23450935e+00  1.11250465e+01
  6.47181203e+01  2.59026137e+02  8.87897773e+02  3.14159381e+03
  1.26221278e+04  4.12193752e+04  1.05247618e+05  2.30420773e+05
  4.56228307e+05  8.45174937e+05  1.52834675e+06  2.85060745e+06
  5.80848613e+06]
E1 = -706.7362272487038  E_coul = 198.7467743831932
cycle= 4 E= -507.989452865511  delta_E= -5.3e-06  |g|= 0.000147  |ddm|= 0.00897
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000204195
diis-c [-3.03433430e-09 -1.27831248e-05  9.43979279e-03 -1.02838381e-01
  1.09341137e+00]
  HOMO = -0.240116614764312  LUMO = 0.0783392056365666
  mo_energy =
[-1.20322661e+02 -1.23764720e+01 -6.67495243e+00 -6.67495243e+00
 -6.67495243e+00 -1.17724557e+00 -2.40116615e-01 -2.40116615e-01
 -2.40116615e-01  7.83392056e-02  1.23446524e+00  1.11249117e+01
  6.47180052e+01  2.59026054e+02  8.87897712e+02  3.14159377e+03
  1.26221278e+04  4.12193752e+04  1.05247618e+05  2.30420773e+05
  4.56228307e+05  8.45174937e+05  1.52834675e+06  2.85060745e+06
  5.80848613e+06]
E1 = -706.7358476233261  E_coul = 198.74639475116876
cycle= 5 E= -507.989452872157  delta_E= -6.65e-09  |g|= 8.3e-06  |ddm|= 0.000221
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.8475e-06
diis-c [-2.77083317e-12  1.17110029e-06 -1.15632413e-03  1.27413175e-02
 -1.44715428e-01  1.13312926e+00]
  HOMO = -0.240113317124831  LUMO = 0.0783392109162619
  mo_energy =
[-1.20322650e+02 -1.23764623e+01 -6.67494247e+00 -6.67494247e+00
 -6.67494247e+00 -1.17724386e+00 -2.40113317e-01 -2.40113317e-01
 -2.40113317e-01  7.83392109e-02  1.23446621e+00  1.11249189e+01
  6.47180154e+01  2.59026065e+02  8.87897723e+02  3.14159378e+03
  1.26221278e+04  4.12193752e+04  1.05247618e+05  2.30420773e+05
  4.56228307e+05  8.45174937e+05  1.52834675e+06  2.85060745e+06
  5.80848613e+06]
E1 = -706.7358619342668  E_coul = 198.74640906208964
cycle= 6 E= -507.989452872177  delta_E= -1.98e-11  |g|= 1.47e-07  |ddm|= 1.95e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.7358619342668  E_coul = 198.74640906208964
  HOMO = -0.24011325460146  LUMO = 0.0783392064841595
  mo_energy =
[-1.20322649e+02 -1.23764621e+01 -6.67494228e+00 -6.67494228e+00
 -6.67494228e+00 -1.17724380e+00 -2.40113255e-01 -2.40113255e-01
 -2.40113255e-01  7.83392065e-02  1.23446620e+00  1.11249190e+01
  6.47180156e+01  2.59026065e+02  8.87897724e+02  3.14159378e+03
  1.26221278e+04  4.12193752e+04  1.05247618e+05  2.30420773e+05
  4.56228307e+05  8.45174937e+05  1.52834675e+06  2.85060745e+06
  5.80848613e+06]
E1 = -706.7358622933021  E_coul = 198.74640942112538
Extra cycle  E= -507.989452872177  delta_E= 3.98e-13  |g|= 1.8e-08  |ddm|= 3.14e-07
    CPU time for scf_cycle      2.09 sec, wall time      0.32 sec
exp = [2.86709378e-02 2.61332163e-01 6.46966519e-01 1.17616813e+05
 3.03404838e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232189e+03
 1.83757714e+04 1.44352576e+03 4.17361961e+02 1.47783949e+02
 5.84529742e+01 2.45576395e+01 7.57712646e+00 8.60415025e+00
 4.93982826e-01]
E = -507.9894528721768
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0264065998255      1
[INPUT] 0    0    [1    /1   ]  0.254087829432       1
[INPUT] 0    0    [1    /1   ]  0.648600517262       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.0340238549         1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189496        1
[INPUT] 0    0    [1    /1   ]  18375.7713556        1
[INPUT] 0    0    [1    /1   ]  1443.52573303        1
[INPUT] 0    0    [1    /1   ]  417.361957785        1
[INPUT] 0    0    [1    /1   ]  147.783948312        1
[INPUT] 0    0    [1    /1   ]  58.4529751181        1
[INPUT] 0    0    [1    /1   ]  24.5576392615        1
[INPUT] 0    0    [1    /1   ]  7.57714044951        1
[INPUT] 1    0    [1    /1   ]  8.60412248775        1
[INPUT] 1    0    [1    /1   ]  0.493203893454       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.026406599825478765, 1.0]], [0, [0.25408782943242425, 1.0]], [0, [0.6486005172618062, 1.0]], [0, [117616.81288988225, 1.0]], [0, [3.0340238549041016, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565709, 1.0]], [0, [294042.03092149395, 1.0]], [0, [147020.99132354875, 1.0]], [0, [73510.41754935357, 1.0]], [0, [36754.701541172784, 1.0]], [0, [7302.321894962076, 1.0]], [0, [18375.771355577424, 1.0]], [0, [1443.5257330263266, 1.0]], [0, [417.3619577848557, 1.0]], [0, [147.78394831210562, 1.0]], [0, [58.45297511814357, 1.0]], [0, [24.557639261451275, 1.0]], [0, [7.577140449507099, 1.0]], [1, [8.604122487748251, 1.0]], [1, [0.49320389345429266, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.0264066]
bas 1, expnt(s) = [0.25408783]
bas 2, expnt(s) = [0.64860052]
bas 3, expnt(s) = [117616.81288988]
bas 4, expnt(s) = [3.03402385]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132355]
bas 9, expnt(s) = [73510.41754935]
bas 10, expnt(s) = [36754.70154117]
bas 11, expnt(s) = [7302.32189496]
bas 12, expnt(s) = [18375.77135558]
bas 13, expnt(s) = [1443.52573303]
bas 14, expnt(s) = [417.36195778]
bas 15, expnt(s) = [147.78394831]
bas 16, expnt(s) = [58.45297512]
bas 17, expnt(s) = [24.55763926]
bas 18, expnt(s) = [7.57714045]
bas 19, expnt(s) = [8.60412249]
bas 20, expnt(s) = [0.49320389]
CPU time:        47.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64065998e-02 1.65500529e-01 2.54087829e-01 9.04175889e-01
 6.48600517e-01 1.82598831e+00 1.17616813e+05 1.60460108e+04
 3.03402385e+00 5.80803557e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232189e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352573e+03 5.91675276e+02
 4.17361958e+02 2.33291905e+02 1.47783948e+02 1.07086685e+02
 5.84529751e+01 5.34096817e+01 2.45576393e+01 2.78711562e+01
 7.57714045e+00 1.15383585e+01 8.60412249e+00 4.29900176e+01
 4.93203893e-01 1.20577844e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33540883580926
cond(S) = 912125.2945849041
E1 = -689.6050125919413  E_coul = 184.98264541524398
init E= -504.622367176697
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.671682118087658  LUMO = -0.0685475561159637
  mo_energy =
[-1.21708913e+02 -1.33849853e+01 -7.62300507e+00 -7.62300507e+00
 -7.62300507e+00 -1.65695007e+00 -6.71682118e-01 -6.71682118e-01
 -6.71682118e-01 -6.85475561e-02  8.22611211e-01  1.02699709e+01
  6.35049278e+01  2.57654574e+02  8.86510309e+02  3.14028439e+03
  1.26209382e+04  4.12182583e+04  1.05246540e+05  2.30419722e+05
  4.56227273e+05  8.45173917e+05  1.52834575e+06  2.85060645e+06
  5.80848514e+06]
E1 = -707.7621437870486  E_coul = 199.79043321839092
cycle= 1 E= -507.971710568658  delta_E= -3.35  |g|= 0.451  |ddm|= 0.495
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.720587
diis-c [-0.51924572  1.        ]
  HOMO = -0.216678055619721  LUMO = 0.0711635204292544
  mo_energy =
[-1.20200146e+02 -1.23038506e+01 -6.59399339e+00 -6.59399339e+00
 -6.59399339e+00 -1.16250594e+00 -2.16678056e-01 -2.16678056e-01
 -2.16678056e-01  7.11635204e-02  1.20814948e+00  1.11364582e+01
  6.47747945e+01  2.59110921e+02  8.88002373e+02  3.14171595e+03
  1.26222631e+04  4.12195159e+04  1.05247761e+05  2.30420918e+05
  4.56228452e+05  8.45175082e+05  1.52834690e+06  2.85060759e+06
  5.80848628e+06]
E1 = -706.8196011367498  E_coul = 198.83034305139947
cycle= 2 E= -507.98925808535  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0355948
diis-c [-0.00126643 -0.00104275  1.00104275]
  HOMO = -0.238711763701369  LUMO = 0.0711792731628871
  mo_energy =
[-1.20313412e+02 -1.23704863e+01 -6.66778312e+00 -6.66778312e+00
 -6.66778312e+00 -1.17669287e+00 -2.38711764e-01 -2.38711764e-01
 -2.38711764e-01  7.11792732e-02  1.20157406e+00  1.10903528e+01
  6.46933091e+01  2.59007514e+02  8.87883352e+02  3.14158281e+03
  1.26221198e+04  4.12193689e+04  1.05247612e+05  2.30420768e+05
  4.56228302e+05  8.45174932e+05  1.52834675e+06  2.85060744e+06
  5.80848613e+06]
E1 = -706.71110669533  E_coul = 198.72158342527925
cycle= 3 E= -507.989523270051  delta_E= -0.000265  |g|= 0.00442  |ddm|= 0.0581
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00461949
diis-c [-3.96022730e-06 -3.10083936e-04 -1.32264328e-01  1.13257441e+00]
  HOMO = -0.242001272797394  LUMO = 0.071165467815583
  mo_energy =
[-1.20325661e+02 -1.23793948e+01 -6.67719546e+00 -6.67719546e+00
 -6.67719546e+00 -1.17868777e+00 -2.42001273e-01 -2.42001273e-01
 -2.42001273e-01  7.11654678e-02  1.20031847e+00  1.10837176e+01
  6.46833436e+01  2.58995944e+02  8.87870839e+02  3.14156956e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6949969666434  E_coul = 198.70546841130377
cycle= 4 E= -507.98952855534  delta_E= -5.29e-06  |g|= 0.000147  |ddm|= 0.00899
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000199151
diis-c [-2.79355827e-09 -1.23521776e-05  9.29205439e-03 -1.02074100e-01
  1.09279440e+00]
  HOMO = -0.242081100209021  LUMO = 0.0711641020123367
  mo_energy =
[-1.20325744e+02 -1.23795508e+01 -6.67733550e+00 -6.67733550e+00
 -6.67733550e+00 -1.17873482e+00 -2.42081100e-01 -2.42081100e-01
 -2.42081100e-01  7.11641020e-02  1.20027485e+00  1.10835759e+01
  6.46832169e+01  2.58995847e+02  8.87870762e+02  3.14156950e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6946053416227  E_coul = 198.70507677987112
cycle= 5 E= -507.989528561752  delta_E= -6.41e-09  |g|= 7.6e-06  |ddm|= 0.00023
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.48379e-06
diis-c [-2.65555817e-12  1.14935813e-06 -1.12988692e-03  1.25546873e-02
 -1.42785185e-01  1.13135924e+00]
  HOMO = -0.242077989705328  LUMO = 0.0711641121200559
  mo_energy =
[-1.20325733e+02 -1.23795417e+01 -6.67732624e+00 -6.67732624e+00
 -6.67732624e+00 -1.17873320e+00 -2.42077990e-01 -2.42077990e-01
 -2.42077990e-01  7.11641121e-02  1.20027579e+00  1.10835826e+01
  6.46832264e+01  2.58995857e+02  8.87870773e+02  3.14156951e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.694618843638  E_coul = 198.70509028186896
cycle= 6 E= -507.989528561769  delta_E= -1.74e-11  |g|= 1.43e-07  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.694618843638  E_coul = 198.70509028186896
  HOMO = -0.242077926749982  LUMO = 0.0711641088068704
  mo_energy =
[-1.20325733e+02 -1.23795415e+01 -6.67732605e+00 -6.67732605e+00
 -6.67732605e+00 -1.17873314e+00 -2.42077927e-01 -2.42077927e-01
 -2.42077927e-01  7.11641088e-02  1.20027579e+00  1.10835828e+01
  6.46832266e+01  2.58995857e+02  8.87870773e+02  3.14156951e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6946191958529  E_coul = 198.70509063408412
Extra cycle  E= -507.989528561769  delta_E= 2.84e-13  |g|= 1.78e-08  |ddm|= 3e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.64065998e-02 2.54087829e-01 6.48600517e-01 1.17616813e+05
 3.03402385e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232189e+03
 1.83757714e+04 1.44352573e+03 4.17361958e+02 1.47783948e+02
 5.84529751e+01 2.45576393e+01 7.57714045e+00 8.60412249e+00
 4.93203893e-01]
E = -507.98952856176874
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0264065998255      1
[INPUT] 0    0    [1    /1   ]  0.254087829432       1
[INPUT] 0    0    [1    /1   ]  0.648600517262       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.0340238549         1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189496        1
[INPUT] 0    0    [1    /1   ]  18375.7713556        1
[INPUT] 0    0    [1    /1   ]  1443.52573303        1
[INPUT] 0    0    [1    /1   ]  417.361957785        1
[INPUT] 0    0    [1    /1   ]  147.783948312        1
[INPUT] 0    0    [1    /1   ]  58.4529751181        1
[INPUT] 0    0    [1    /1   ]  24.5576392615        1
[INPUT] 0    0    [1    /1   ]  7.57714044951        1
[INPUT] 1    0    [1    /1   ]  8.60412248775        1
[INPUT] 1    0    [1    /1   ]  0.493203893454       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.026406599825478765, 1.0]], [0, [0.25408782943242425, 1.0]], [0, [0.6486005172618062, 1.0]], [0, [117616.81288988225, 1.0]], [0, [3.0340238549041016, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565709, 1.0]], [0, [294042.03092149395, 1.0]], [0, [147020.99132354875, 1.0]], [0, [73510.41754935357, 1.0]], [0, [36754.701541172784, 1.0]], [0, [7302.321894962076, 1.0]], [0, [18375.771355577424, 1.0]], [0, [1443.5257330263266, 1.0]], [0, [417.3619577848557, 1.0]], [0, [147.78394831210562, 1.0]], [0, [58.45297511814357, 1.0]], [0, [24.557639261451275, 1.0]], [0, [7.577140449507099, 1.0]], [1, [8.604122487748251, 1.0]], [1, [0.49320389345429266, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.0264066]
bas 1, expnt(s) = [0.25408783]
bas 2, expnt(s) = [0.64860052]
bas 3, expnt(s) = [117616.81288988]
bas 4, expnt(s) = [3.03402385]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132355]
bas 9, expnt(s) = [73510.41754935]
bas 10, expnt(s) = [36754.70154117]
bas 11, expnt(s) = [7302.32189496]
bas 12, expnt(s) = [18375.77135558]
bas 13, expnt(s) = [1443.52573303]
bas 14, expnt(s) = [417.36195778]
bas 15, expnt(s) = [147.78394831]
bas 16, expnt(s) = [58.45297512]
bas 17, expnt(s) = [24.55763926]
bas 18, expnt(s) = [7.57714045]
bas 19, expnt(s) = [8.60412249]
bas 20, expnt(s) = [0.49320389]
CPU time:        49.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.64065998e-02 1.65500529e-01 2.54087829e-01 9.04175889e-01
 6.48600517e-01 1.82598831e+00 1.17616813e+05 1.60460108e+04
 3.03402385e+00 5.80803557e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232189e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352573e+03 5.91675276e+02
 4.17361958e+02 2.33291905e+02 1.47783948e+02 1.07086685e+02
 5.84529751e+01 5.34096817e+01 2.45576393e+01 2.78711562e+01
 7.57714045e+00 1.15383585e+01 8.60412249e+00 4.29900176e+01
 4.93203893e-01 1.20577844e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33540883580926
cond(S) = 912125.2945849041
E1 = -689.6050125919413  E_coul = 184.98264541524398
init E= -504.622367176697
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.671682118087658  LUMO = -0.0685475561159637
  mo_energy =
[-1.21708913e+02 -1.33849853e+01 -7.62300507e+00 -7.62300507e+00
 -7.62300507e+00 -1.65695007e+00 -6.71682118e-01 -6.71682118e-01
 -6.71682118e-01 -6.85475561e-02  8.22611211e-01  1.02699709e+01
  6.35049278e+01  2.57654574e+02  8.86510309e+02  3.14028439e+03
  1.26209382e+04  4.12182583e+04  1.05246540e+05  2.30419722e+05
  4.56227273e+05  8.45173917e+05  1.52834575e+06  2.85060645e+06
  5.80848514e+06]
E1 = -707.7621437870486  E_coul = 199.79043321839092
cycle= 1 E= -507.971710568658  delta_E= -3.35  |g|= 0.451  |ddm|= 0.495
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.720587
diis-c [-0.51924572  1.        ]
  HOMO = -0.216678055619721  LUMO = 0.0711635204292544
  mo_energy =
[-1.20200146e+02 -1.23038506e+01 -6.59399339e+00 -6.59399339e+00
 -6.59399339e+00 -1.16250594e+00 -2.16678056e-01 -2.16678056e-01
 -2.16678056e-01  7.11635204e-02  1.20814948e+00  1.11364582e+01
  6.47747945e+01  2.59110921e+02  8.88002373e+02  3.14171595e+03
  1.26222631e+04  4.12195159e+04  1.05247761e+05  2.30420918e+05
  4.56228452e+05  8.45175082e+05  1.52834690e+06  2.85060759e+06
  5.80848628e+06]
E1 = -706.8196011367498  E_coul = 198.83034305139947
cycle= 2 E= -507.98925808535  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.431
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0355948
diis-c [-0.00126643 -0.00104275  1.00104275]
  HOMO = -0.238711763701369  LUMO = 0.0711792731628871
  mo_energy =
[-1.20313412e+02 -1.23704863e+01 -6.66778312e+00 -6.66778312e+00
 -6.66778312e+00 -1.17669287e+00 -2.38711764e-01 -2.38711764e-01
 -2.38711764e-01  7.11792732e-02  1.20157406e+00  1.10903528e+01
  6.46933091e+01  2.59007514e+02  8.87883352e+02  3.14158281e+03
  1.26221198e+04  4.12193689e+04  1.05247612e+05  2.30420768e+05
  4.56228302e+05  8.45174932e+05  1.52834675e+06  2.85060744e+06
  5.80848613e+06]
E1 = -706.71110669533  E_coul = 198.72158342527925
cycle= 3 E= -507.989523270051  delta_E= -0.000265  |g|= 0.00442  |ddm|= 0.0581
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00461949
diis-c [-3.96022730e-06 -3.10083936e-04 -1.32264328e-01  1.13257441e+00]
  HOMO = -0.242001272797394  LUMO = 0.071165467815583
  mo_energy =
[-1.20325661e+02 -1.23793948e+01 -6.67719546e+00 -6.67719546e+00
 -6.67719546e+00 -1.17868777e+00 -2.42001273e-01 -2.42001273e-01
 -2.42001273e-01  7.11654678e-02  1.20031847e+00  1.10837176e+01
  6.46833436e+01  2.58995944e+02  8.87870839e+02  3.14156956e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6949969666434  E_coul = 198.70546841130377
cycle= 4 E= -507.98952855534  delta_E= -5.29e-06  |g|= 0.000147  |ddm|= 0.00899
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000199151
diis-c [-2.79355827e-09 -1.23521776e-05  9.29205439e-03 -1.02074100e-01
  1.09279440e+00]
  HOMO = -0.242081100209021  LUMO = 0.0711641020123367
  mo_energy =
[-1.20325744e+02 -1.23795508e+01 -6.67733550e+00 -6.67733550e+00
 -6.67733550e+00 -1.17873482e+00 -2.42081100e-01 -2.42081100e-01
 -2.42081100e-01  7.11641020e-02  1.20027485e+00  1.10835759e+01
  6.46832169e+01  2.58995847e+02  8.87870762e+02  3.14156950e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6946053416227  E_coul = 198.70507677987112
cycle= 5 E= -507.989528561752  delta_E= -6.41e-09  |g|= 7.6e-06  |ddm|= 0.00023
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.48379e-06
diis-c [-2.65555817e-12  1.14935813e-06 -1.12988692e-03  1.25546873e-02
 -1.42785185e-01  1.13135924e+00]
  HOMO = -0.242077989705328  LUMO = 0.0711641121200559
  mo_energy =
[-1.20325733e+02 -1.23795417e+01 -6.67732624e+00 -6.67732624e+00
 -6.67732624e+00 -1.17873320e+00 -2.42077990e-01 -2.42077990e-01
 -2.42077990e-01  7.11641121e-02  1.20027579e+00  1.10835826e+01
  6.46832264e+01  2.58995857e+02  8.87870773e+02  3.14156951e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.694618843638  E_coul = 198.70509028186896
cycle= 6 E= -507.989528561769  delta_E= -1.74e-11  |g|= 1.43e-07  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.694618843638  E_coul = 198.70509028186896
  HOMO = -0.242077926749982  LUMO = 0.0711641088068704
  mo_energy =
[-1.20325733e+02 -1.23795415e+01 -6.67732605e+00 -6.67732605e+00
 -6.67732605e+00 -1.17873314e+00 -2.42077927e-01 -2.42077927e-01
 -2.42077927e-01  7.11641088e-02  1.20027579e+00  1.10835828e+01
  6.46832266e+01  2.58995857e+02  8.87870773e+02  3.14156951e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6946191958529  E_coul = 198.70509063408412
Extra cycle  E= -507.989528561769  delta_E= 2.84e-13  |g|= 1.78e-08  |ddm|= 3e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912125.2945849041
E1 = -706.6946191958529  E_coul = 198.70509063408412
init E= -507.989528561769
    CPU time for initialize scf      5.86 sec, wall time      0.25 sec
  HOMO = -0.242077917207643  LUMO = 0.0711641086469165
  mo_energy =
[-1.20325733e+02 -1.23795415e+01 -6.67732602e+00 -6.67732602e+00
 -6.67732602e+00 -1.17873314e+00 -2.42077917e-01 -2.42077917e-01
 -2.42077917e-01  7.11641086e-02  1.20027579e+00  1.10835828e+01
  6.46832267e+01  2.58995857e+02  8.87870773e+02  3.14156951e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6946192398636  E_coul = 198.70509067809465
cycle= 1 E= -507.989528561769  delta_E= -2.84e-13  |g|= 3.39e-09  |ddm|= 3.59e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6946192398636  E_coul = 198.70509067809465
  HOMO = -0.242077915994988  LUMO = 0.0711641084967041
  mo_energy =
[-1.20325733e+02 -1.23795415e+01 -6.67732602e+00 -6.67732602e+00
 -6.67732602e+00 -1.17873314e+00 -2.42077916e-01 -2.42077916e-01
 -2.42077916e-01  7.11641085e-02  1.20027579e+00  1.10835828e+01
  6.46832267e+01  2.58995857e+02  8.87870773e+02  3.14156951e+03
  1.26221061e+04  4.12193549e+04  1.05247598e+05  2.30420754e+05
  4.56228288e+05  8.45174918e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6946192493999  E_coul = 198.70509068763073
Extra cycle  E= -507.989528561769  delta_E= -1.71e-13  |g|= 1.69e-09  |ddm|= 5.85e-09
    CPU time for scf_cycle      6.37 sec, wall time      0.42 sec
exp = [2.64065998e-02 2.54087829e-01 6.48600517e-01 1.17616813e+05
 3.03402385e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232189e+03
 1.83757714e+04 1.44352573e+03 4.17361958e+02 1.47783948e+02
 5.84529751e+01 2.45576393e+01 7.57714045e+00 8.60412249e+00
 4.93203893e-01]
grad_E = [-5.95331709e-03  1.33825002e-04 -1.79324561e-03  6.06847222e-09
 -5.82130339e-04  4.05094046e-11  1.74358835e-10  9.41254388e-10
  3.71899274e-09  1.55300908e-08  8.09995027e-08  5.10539896e-06
  1.98627849e-07 -3.86099031e-05 -4.98938050e-06 -8.03546893e-07
 -4.49669606e-07  3.00376322e-06  1.18496499e-04 -5.53319243e-04
  1.69260994e-02]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0390849024211      1
[INPUT] 0    0    [1    /1   ]  0.276128583006       1
[INPUT] 0    0    [1    /1   ]  0.645331572756       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03466104751        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175493        1
[INPUT] 0    0    [1    /1   ]  36754.7015409        1
[INPUT] 0    0    [1    /1   ]  7302.32188055        1
[INPUT] 0    0    [1    /1   ]  18375.771355         1
[INPUT] 0    0    [1    /1   ]  1443.52584202        1
[INPUT] 0    0    [1    /1   ]  417.361971731        1
[INPUT] 0    0    [1    /1   ]  147.78395137         1
[INPUT] 0    0    [1    /1   ]  58.452972746         1
[INPUT] 0    0    [1    /1   ]  24.5576371076        1
[INPUT] 0    0    [1    /1   ]  7.57698322383        1
[INPUT] 1    0    [1    /1   ]  8.60474174245        1
[INPUT] 1    0    [1    /1   ]  0.479243322523       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.03908490242109086, 1.0]], [0, [0.27612858300591137, 1.0]], [0, [0.6453315727564007, 1.0]], [0, [117616.81288986512, 1.0]], [0, [3.0346610475136373, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565704, 1.0]], [0, [294042.03092149127, 1.0]], [0, [147020.99132353824, 1.0]], [0, [73510.41754930974, 1.0]], [0, [36754.701540944145, 1.0]], [0, [7302.321880550969, 1.0]], [0, [18375.77135501675, 1.0]], [0, [1443.5258420222788, 1.0]], [0, [417.36197173140647, 1.0]], [0, [147.78395137018595, 1.0]], [0, [58.452972746012726, 1.0]], [0, [24.55763710760983, 1.0]], [0, [7.576983223825401, 1.0]], [1, [8.604741742454287, 1.0]], [1, [0.4792433225227108, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.0390849]
bas 1, expnt(s) = [0.27612858]
bas 2, expnt(s) = [0.64533157]
bas 3, expnt(s) = [117616.81288987]
bas 4, expnt(s) = [3.03466105]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132354]
bas 9, expnt(s) = [73510.41754931]
bas 10, expnt(s) = [36754.70154094]
bas 11, expnt(s) = [7302.32188055]
bas 12, expnt(s) = [18375.77135502]
bas 13, expnt(s) = [1443.52584202]
bas 14, expnt(s) = [417.36197173]
bas 15, expnt(s) = [147.78395137]
bas 16, expnt(s) = [58.45297275]
bas 17, expnt(s) = [24.55763711]
bas 18, expnt(s) = [7.57698322]
bas 19, expnt(s) = [8.60474174]
bas 20, expnt(s) = [0.47924332]
CPU time:        64.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.90849024e-02 2.22086315e-01 2.76128583e-01 9.62384340e-01
 6.45331573e-01 1.81908172e+00 1.17616813e+05 1.60460108e+04
 3.03466105e+00 5.80895038e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232188e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352584e+03 5.91675309e+02
 4.17361972e+02 2.33291911e+02 1.47783951e+02 1.07086686e+02
 5.84529727e+01 5.34096801e+01 2.45576371e+01 2.78711544e+01
 7.57698322e+00 1.15381789e+01 8.60474174e+00 4.29938852e+01
 4.79243323e-01 1.16326719e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.352001108331265
cond(S) = 912130.1050449192
E1 = -689.064953588345  E_coul = 184.4942478918889
init E= -504.570705696456
    CPU time for initialize scf      2.07 sec, wall time      0.13 sec
  HOMO = -0.689331115369336  LUMO = -0.047958390898082
  mo_energy =
[-1.21750290e+02 -1.34255803e+01 -7.65285429e+00 -7.65285429e+00
 -7.65285429e+00 -1.67152786e+00 -6.89331115e-01 -6.89331115e-01
 -6.89331115e-01 -4.79583909e-02  9.39308906e-01  1.03913943e+01
  6.35930192e+01  2.57723089e+02  8.86565609e+02  3.14032895e+03
  1.26209726e+04  4.12182872e+04  1.05246566e+05  2.30419746e+05
  4.56227296e+05  8.45173938e+05  1.52834577e+06  2.85060647e+06
  5.80848516e+06]
E1 = -707.0538759858086  E_coul = 199.08489291749163
cycle= 1 E= -507.968983068317  delta_E= -3.4  |g|= 0.446  |ddm|= 0.532
    CPU time for cycle= 1      0.10 sec, wall time      0.03 sec
diis-norm(errvec)=0.722492
diis-c [-0.52199429  1.        ]
  HOMO = -0.247534483583086  LUMO = 0.109270320094075
  mo_energy =
[-1.20256016e+02 -1.23576722e+01 -6.63584268e+00 -6.63584268e+00
 -6.63584268e+00 -1.18568930e+00 -2.47534484e-01 -2.47534484e-01
 -2.47534484e-01  1.09270320e-01  1.32300454e+00  1.12447817e+01
  6.48489742e+01  2.59165110e+02  8.88043224e+02  3.14174618e+03
  1.26222833e+04  4.12195306e+04  1.05247773e+05  2.30420928e+05
  4.56228460e+05  8.45175090e+05  1.52834691e+06  2.85060760e+06
  5.80848628e+06]
E1 = -706.142669195542  E_coul = 198.1570803053992
cycle= 2 E= -507.985588890143  delta_E= -0.0166  |g|= 0.0339  |ddm|= 0.426
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0367577
diis-c [-0.00134902 -0.00201705  1.00201705]
  HOMO = -0.268269276010732  LUMO = 0.109281482192596
  mo_energy =
[-1.20366523e+02 -1.24221536e+01 -6.70751561e+00 -6.70751561e+00
 -6.70751561e+00 -1.19927031e+00 -2.68269276e-01 -2.68269276e-01
 -2.68269276e-01  1.09281482e-01  1.31605504e+00  1.12003551e+01
  6.47698502e+01  2.59064345e+02  8.87927028e+02  3.14161603e+03
  1.26221431e+04  4.12193867e+04  1.05247627e+05  2.30420781e+05
  4.56228314e+05  8.45174943e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.0382085052119  E_coul = 198.05237052429325
cycle= 3 E= -507.985837980919  delta_E= -0.000249  |g|= 0.00429  |ddm|= 0.0562
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0049014
diis-c [-4.34564774e-06 -3.54915484e-04 -1.36627802e-01  1.13698272e+00]
  HOMO = -0.271374983005173  LUMO = 0.10925626781948
  mo_energy =
[-1.20378317e+02 -1.24307136e+01 -6.71657721e+00 -6.71657721e+00
 -6.71657721e+00 -1.20118815e+00 -2.71374983e-01 -2.71374983e-01
 -2.71374983e-01  1.09256268e-01  1.31474214e+00  1.11939917e+01
  6.47602683e+01  2.59053208e+02  8.87914980e+02  3.14160327e+03
  1.26221299e+04  4.12193733e+04  1.05247614e+05  2.30420768e+05
  4.56228300e+05  8.45174929e+05  1.52834675e+06  2.85060744e+06
  5.80848612e+06]
E1 = -706.0226375240321  E_coul = 198.03679448138368
cycle= 4 E= -507.985843042648  delta_E= -5.06e-06  |g|= 0.00015  |ddm|= 0.00847
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000212615
diis-c [-3.36465645e-09 -1.38042117e-05  9.66248326e-03 -1.03333701e-01
  1.09368502e+00]
  HOMO = -0.271442475297888  LUMO = 0.109253772447265
  mo_energy =
[-1.20378343e+02 -1.24308303e+01 -6.71667530e+00 -6.71667530e+00
 -6.71667530e+00 -1.20122870e+00 -2.71442475e-01 -2.71442475e-01
 -2.71442475e-01  1.09253772e-01  1.31469812e+00  1.11938778e+01
  6.47601865e+01  2.59053165e+02  8.87914962e+02  3.14160327e+03
  1.26221299e+04  4.12193733e+04  1.05247614e+05  2.30420768e+05
  4.56228300e+05  8.45174929e+05  1.52834675e+06  2.85060744e+06
  5.80848612e+06]
E1 = -706.0222962946675  E_coul = 198.03645324480237
cycle= 5 E= -507.985843049865  delta_E= -7.22e-09  |g|= 9.73e-06  |ddm|= 0.000205
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.39431e-06
diis-c [-2.90896906e-12  1.20807361e-06 -1.18998382e-03  1.28228170e-02
 -1.47027761e-01  1.13539372e+00]
  HOMO = -0.271439227583378  LUMO = 0.109253759464982
  mo_energy =
[-1.20378330e+02 -1.24308200e+01 -6.71666472e+00 -6.71666472e+00
 -6.71666472e+00 -1.20122699e+00 -2.71439228e-01 -2.71439228e-01
 -2.71439228e-01  1.09253759e-01  1.31469895e+00  1.11938852e+01
  6.47601974e+01  2.59053177e+02  8.87914974e+02  3.14160329e+03
  1.26221299e+04  4.12193733e+04  1.05247614e+05  2.30420768e+05
  4.56228300e+05  8.45174929e+05  1.52834675e+06  2.85060744e+06
  5.80848612e+06]
E1 = -706.0223103202893  E_coul = 198.036467270398
cycle= 6 E= -507.985843049891  delta_E= -2.61e-11  |g|= 1.51e-07  |ddm|= 2.46e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.0223103202893  E_coul = 198.036467270398
  HOMO = -0.271439171253514  LUMO = 0.109253753041757
  mo_energy =
[-1.20378330e+02 -1.24308198e+01 -6.71666454e+00 -6.71666454e+00
 -6.71666454e+00 -1.20122693e+00 -2.71439171e-01 -2.71439171e-01
 -2.71439171e-01  1.09253753e-01  1.31469894e+00  1.11938854e+01
  6.47601976e+01  2.59053177e+02  8.87914975e+02  3.14160329e+03
  1.26221299e+04  4.12193733e+04  1.05247614e+05  2.30420768e+05
  4.56228300e+05  8.45174929e+05  1.52834675e+06  2.85060744e+06
  5.80848612e+06]
E1 = -706.0223106514662  E_coul = 198.0364676015748
Extra cycle  E= -507.985843049891  delta_E= -1.14e-13  |g|= 1.87e-08  |ddm|= 3.38e-07
    CPU time for scf_cycle      2.37 sec, wall time      0.36 sec
exp = [3.90849024e-02 2.76128583e-01 6.45331573e-01 1.17616813e+05
 3.03466105e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232188e+03
 1.83757714e+04 1.44352584e+03 4.17361972e+02 1.47783951e+02
 5.84529727e+01 2.45576371e+01 7.57698322e+00 8.60474174e+00
 4.79243323e-01]
E = -507.9858430498914
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.027674430085       1
[INPUT] 0    0    [1    /1   ]  0.25629190479        1
[INPUT] 0    0    [1    /1   ]  0.648273622811       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03408757417        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175493        1
[INPUT] 0    0    [1    /1   ]  36754.7015411        1
[INPUT] 0    0    [1    /1   ]  7302.32189352        1
[INPUT] 0    0    [1    /1   ]  18375.7713555        1
[INPUT] 0    0    [1    /1   ]  1443.52574393        1
[INPUT] 0    0    [1    /1   ]  417.36195918         1
[INPUT] 0    0    [1    /1   ]  147.783948618        1
[INPUT] 0    0    [1    /1   ]  58.4529748809        1
[INPUT] 0    0    [1    /1   ]  24.5576390461        1
[INPUT] 0    0    [1    /1   ]  7.57712472694        1
[INPUT] 1    0    [1    /1   ]  8.60418441322        1
[INPUT] 1    0    [1    /1   ]  0.491807836361       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.027674430085039975, 1.0]], [0, [0.256291904789773, 1.0]], [0, [0.6482736228112657, 1.0]], [0, [117616.81288988053, 1.0]], [0, [3.034087574165055, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565709, 1.0]], [0, [294042.03092149366, 1.0]], [0, [147020.9913235477, 1.0]], [0, [73510.4175493492, 1.0]], [0, [36754.70154114992, 1.0]], [0, [7302.321893520965, 1.0]], [0, [18375.771355521356, 1.0]], [0, [1443.525743925922, 1.0]], [0, [417.3619591795108, 1.0]], [0, [147.78394861791367, 1.0]], [0, [58.45297488093048, 1.0]], [0, [24.55763904606713, 1.0]], [0, [7.577124726938929, 1.0]], [1, [8.604184413218855, 1.0]], [1, [0.49180783636113445, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.02767443]
bas 1, expnt(s) = [0.2562919]
bas 2, expnt(s) = [0.64827362]
bas 3, expnt(s) = [117616.81288988]
bas 4, expnt(s) = [3.03408757]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132355]
bas 9, expnt(s) = [73510.41754935]
bas 10, expnt(s) = [36754.70154115]
bas 11, expnt(s) = [7302.32189352]
bas 12, expnt(s) = [18375.77135552]
bas 13, expnt(s) = [1443.52574393]
bas 14, expnt(s) = [417.36195918]
bas 15, expnt(s) = [147.78394862]
bas 16, expnt(s) = [58.45297488]
bas 17, expnt(s) = [24.55763905]
bas 18, expnt(s) = [7.57712473]
bas 19, expnt(s) = [8.60418441]
bas 20, expnt(s) = [0.49180784]
CPU time:        66.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.76744301e-02 1.71424953e-01 2.56291905e-01 9.10051963e-01
 6.48273623e-01 1.82529804e+00 1.17616813e+05 1.60460108e+04
 3.03408757e+00 5.80812705e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232189e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352574e+03 5.91675279e+02
 4.17361959e+02 2.33291906e+02 1.47783949e+02 1.07086685e+02
 5.84529749e+01 5.34096815e+01 2.45576390e+01 2.78711561e+01
 7.57712473e+00 1.15383405e+01 8.60418441e+00 4.29904044e+01
 4.91807836e-01 1.20151362e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33722404515548
cond(S) = 912125.7606382427
E1 = -689.5538438935711  E_coul = 184.93613815557856
init E= -504.617705737993
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.673424627605055  LUMO = -0.0668250759367635
  mo_energy =
[-1.21712884e+02 -1.33888810e+01 -7.62581587e+00 -7.62581587e+00
 -7.62581587e+00 -1.65830703e+00 -6.73424628e-01 -6.73424628e-01
 -6.73424628e-01 -6.68250759e-02  8.34552136e-01  1.02821336e+01
  6.35137410e+01  2.57661448e+02  8.86515879e+02  3.14028890e+03
  1.26209418e+04  4.12182613e+04  1.05246543e+05  2.30419724e+05
  4.56227275e+05  8.45173919e+05  1.52834575e+06  2.85060645e+06
  5.80848514e+06]
E1 = -707.6920463677496  E_coul = 199.72023706520417
cycle= 1 E= -507.971809302545  delta_E= -3.35  |g|= 0.45  |ddm|= 0.498
    CPU time for cycle= 1      0.67 sec, wall time      0.03 sec
diis-norm(errvec)=0.7208
diis-c [-0.51955294  1.        ]
  HOMO = -0.219815601509846  LUMO = 0.074942946509559
  mo_energy =
[-1.20205724e+02 -1.23092069e+01 -6.59814385e+00 -6.59814385e+00
 -6.59814385e+00 -1.16480840e+00 -2.19815602e-01 -2.19815602e-01
 -2.19815602e-01  7.49429465e-02  1.21984691e+00  1.11471901e+01
  6.47820724e+01  2.59116209e+02  8.88006338e+02  3.14171886e+03
  1.26222650e+04  4.12195173e+04  1.05247762e+05  2.30420919e+05
  4.56228453e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848628e+06]
E1 = -706.7530977527424  E_coul = 198.76384796270804
cycle= 2 E= -507.989249790034  delta_E= -0.0174  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0357328
diis-c [-0.00127615 -0.00115336  1.00115336]
  HOMO = -0.24170307272039  LUMO = 0.0749592106764088
  mo_energy =
[-1.20318675e+02 -1.23755945e+01 -6.67168895e+00 -6.67168895e+00
 -6.67168895e+00 -1.17892379e+00 -2.41703073e-01 -2.41703073e-01
 -2.41703073e-01  7.49592107e-02  1.21323708e+00  1.11012796e+01
  6.47008575e+01  2.59013104e+02  8.87887640e+02  3.14158607e+03
  1.26221221e+04  4.12193706e+04  1.05247614e+05  2.30420770e+05
  4.56228303e+05  8.45174933e+05  1.52834675e+06  2.85060744e+06
  5.80848613e+06]
E1 = -706.6450727374025  E_coul = 198.65555962352101
cycle= 3 E= -507.989513113882  delta_E= -0.000263  |g|= 0.00441  |ddm|= 0.0579
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0046547
diis-c [-4.01291600e-06 -3.15906401e-04 -1.32833266e-01  1.13314917e+00]
  HOMO = -0.244971681501105  LUMO = 0.074944456937849
  mo_energy =
[-1.20330872e+02 -1.23844630e+01 -6.68106094e+00 -6.68106094e+00
 -6.68106094e+00 -1.18090949e+00 -2.44971682e-01 -2.44971682e-01
 -2.44971682e-01  7.49444569e-02  1.21197628e+00  1.10946759e+01
  6.46909359e+01  2.59001583e+02  8.87875179e+02  3.14157287e+03
  1.26221084e+04  4.12193567e+04  1.05247600e+05  2.30420756e+05
  4.56228289e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6290255656374  E_coul = 198.63950719312265
cycle= 4 E= -507.989518372515  delta_E= -5.26e-06  |g|= 0.000147  |ddm|= 0.00894
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000201166
diis-c [-2.89284008e-09 -1.25454720e-05  9.35054947e-03 -1.02345854e-01
  1.09300785e+00]
  HOMO = -0.245049793197793  LUMO = 0.0749429882902683
  mo_energy =
[-1.20330947e+02 -1.23846138e+01 -6.68119543e+00 -6.68119543e+00
 -6.68119543e+00 -1.18095561e+00 -2.45049793e-01 -2.45049793e-01
 -2.45049793e-01  7.49429883e-02  1.21193272e+00  1.10945380e+01
  6.46908152e+01  2.59001493e+02  8.87875110e+02  3.14157282e+03
  1.26221084e+04  4.12193567e+04  1.05247600e+05  2.30420756e+05
  4.56228289e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6286410322558  E_coul = 198.63912265326124
cycle= 5 E= -507.989518378995  delta_E= -6.48e-09  |g|= 7.89e-06  |ddm|= 0.000225
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.63755e-06
diis-c [-2.70482756e-12  1.15809195e-06 -1.14056692e-03  1.26260524e-02
 -1.43620744e-01  1.13213410e+00]
  HOMO = -0.245046619997164  LUMO = 0.0749429972646404
  mo_energy =
[-1.20330936e+02 -1.23846044e+01 -6.68118590e+00 -6.68118590e+00
 -6.68118590e+00 -1.18095396e+00 -2.45046620e-01 -2.45046620e-01
 -2.45046620e-01  7.49429973e-02  1.21193368e+00  1.10945449e+01
  6.46908250e+01  2.59001504e+02  8.87875121e+02  3.14157283e+03
  1.26221084e+04  4.12193567e+04  1.05247600e+05  2.30420756e+05
  4.56228289e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6286548084488  E_coul = 198.63913642943655
cycle= 6 E= -507.989518379012  delta_E= -1.76e-11  |g|= 1.45e-07  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6286548084488  E_coul = 198.63913642943655
  HOMO = -0.245046557418065  LUMO = 0.0749429933379435
  mo_energy =
[-1.20330936e+02 -1.23846043e+01 -6.68118571e+00 -6.68118571e+00
 -6.68118571e+00 -1.18095390e+00 -2.45046557e-01 -2.45046557e-01
 -2.45046557e-01  7.49429933e-02  1.21193367e+00  1.10945450e+01
  6.46908252e+01  2.59001504e+02  8.87875122e+02  3.14157283e+03
  1.26221084e+04  4.12193567e+04  1.05247600e+05  2.30420756e+05
  4.56228289e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6286551620371  E_coul = 198.63913678302478
Extra cycle  E= -507.989518379012  delta_E= -1.14e-13  |g|= 1.83e-08  |ddm|= 3.04e-07
    CPU time for scf_cycle      1.59 sec, wall time      0.30 sec
exp = [2.76744301e-02 2.56291905e-01 6.48273623e-01 1.17616813e+05
 3.03408757e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232189e+03
 1.83757714e+04 1.44352574e+03 4.17361959e+02 1.47783949e+02
 5.84529749e+01 2.45576390e+01 7.57712473e+00 8.60418441e+00
 4.91807836e-01]
E = -507.98951837901234
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0268813398591      1
[INPUT] 0    0    [1    /1   ]  0.254913147176       1
[INPUT] 0    0    [1    /1   ]  0.648478111379       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03404771463        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189442        1
[INPUT] 0    0    [1    /1   ]  18375.7713556        1
[INPUT] 0    0    [1    /1   ]  1443.52573711        1
[INPUT] 0    0    [1    /1   ]  417.361958307        1
[INPUT] 0    0    [1    /1   ]  147.783948427        1
[INPUT] 0    0    [1    /1   ]  58.4529750293        1
[INPUT] 0    0    [1    /1   ]  24.5576391808        1
[INPUT] 0    0    [1    /1   ]  7.57713456218        1
[INPUT] 1    0    [1    /1   ]  8.60414567579        1
[INPUT] 1    0    [1    /1   ]  0.492681138782       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.026881339859085956, 1.0]], [0, [0.25491314717612806, 1.0]], [0, [0.6484781113787905, 1.0]], [0, [117616.8128898816, 1.0]], [0, [3.034047714631268, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565709, 1.0]], [0, [294042.03092149383, 1.0]], [0, [147020.99132354834, 1.0]], [0, [73510.41754935193, 1.0]], [0, [36754.70154116422, 1.0]], [0, [7302.321894422451, 1.0]], [0, [18375.77135555643, 1.0]], [0, [1443.5257371076887, 1.0]], [0, [417.3619583070854, 1.0]], [0, [147.78394842661567, 1.0]], [0, [58.45297502931894, 1.0]], [0, [24.557639180800514, 1.0]], [0, [7.577134562179134, 1.0]], [1, [8.604145675789216, 1.0]], [1, [0.4926811387824229, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.02688134]
bas 1, expnt(s) = [0.25491315]
bas 2, expnt(s) = [0.64847811]
bas 3, expnt(s) = [117616.81288988]
bas 4, expnt(s) = [3.03404771]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132355]
bas 9, expnt(s) = [73510.41754935]
bas 10, expnt(s) = [36754.70154116]
bas 11, expnt(s) = [7302.32189442]
bas 12, expnt(s) = [18375.77135556]
bas 13, expnt(s) = [1443.52573711]
bas 14, expnt(s) = [417.36195831]
bas 15, expnt(s) = [147.78394843]
bas 16, expnt(s) = [58.45297503]
bas 17, expnt(s) = [24.55763918]
bas 18, expnt(s) = [7.57713456]
bas 19, expnt(s) = [8.60414568]
bas 20, expnt(s) = [0.49268114]
CPU time:        68.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.68813399e-02 1.67727088e-01 2.54913147e-01 9.06377676e-01
 6.48478111e-01 1.82572985e+00 1.17616813e+05 1.60460108e+04
 3.03404771e+00 5.80806983e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232189e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352574e+03 5.91675277e+02
 4.17361958e+02 2.33291905e+02 1.47783948e+02 1.07086685e+02
 5.84529750e+01 5.34096816e+01 2.45576392e+01 2.78711562e+01
 7.57713456e+00 1.15383517e+01 8.60414568e+00 4.29901624e+01
 4.92681139e-01 1.20418112e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336092555148113
cond(S) = 912125.4686126438
E1 = -689.5859262832935  E_coul = 184.9652903895739
init E= -504.62063589372
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.67233402312538  LUMO = -0.0679141533032017
  mo_energy =
[-1.21710396e+02 -1.33864399e+01 -7.62405313e+00 -7.62405313e+00
 -7.62405313e+00 -1.65745575e+00 -6.72334023e-01 -6.72334023e-01
 -6.72334023e-01 -6.79141533e-02  8.27089158e-01  1.02745248e+01
  6.35082272e+01  2.57657148e+02  8.86512395e+02  3.14028608e+03
  1.26209396e+04  4.12182594e+04  1.05246541e+05  2.30419723e+05
  4.56227274e+05  8.45173918e+05  1.52834575e+06  2.85060645e+06
  5.80848514e+06]
E1 = -707.7359137110136  E_coul = 199.7641563018076
cycle= 1 E= -507.971757409206  delta_E= -3.35  |g|= 0.451  |ddm|= 0.496
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.720667
diis-c [-0.5193613  1.       ]
  HOMO = -0.217854271279657  LUMO = 0.0725775022622061
  mo_energy =
[-1.20202234e+02 -1.23058557e+01 -6.59554674e+00 -6.59554674e+00
 -6.59554674e+00 -1.16336784e+00 -2.17854271e-01 -2.17854271e-01
 -2.17854271e-01  7.25775023e-02  1.21253455e+00  1.11404732e+01
  6.47775152e+01  2.59112897e+02  8.88003854e+02  3.14171704e+03
  1.26222638e+04  4.12195164e+04  1.05247761e+05  2.30420918e+05
  4.56228452e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848628e+06]
E1 = -706.79473018692  E_coul = 198.8054657086076
cycle= 2 E= -507.989264478312  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.035647
diis-c [-0.0012701  -0.00108447  1.00108447]
  HOMO = -0.239832739088573  LUMO = 0.0725934685660503
  mo_energy =
[-1.20315381e+02 -1.23723976e+01 -6.66924391e+00 -6.66924391e+00
 -6.66924391e+00 -1.17752766e+00 -2.39832739e-01 -2.39832739e-01
 -2.39832739e-01  7.25934686e-02  1.20594635e+00  1.10944415e+01
  6.46961322e+01  2.59009604e+02  8.87884955e+02  3.14158403e+03
  1.26221207e+04  4.12193695e+04  1.05247613e+05  2.30420769e+05
  4.56228302e+05  8.45174933e+05  1.52834675e+06  2.85060744e+06
  5.80848613e+06]
E1 = -706.6864135126561  E_coul = 198.6968845540052
cycle= 3 E= -507.989528958651  delta_E= -0.000264  |g|= 0.00442  |ddm|= 0.058
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00463286
diis-c [-3.98034861e-06 -3.12305146e-04 -1.32481035e-01  1.13279334e+00]
  HOMO = -0.243114345935126  LUMO = 0.0725793130716514
  mo_energy =
[-1.20327611e+02 -1.23812909e+01 -6.67864099e+00 -6.67864099e+00
 -6.67864099e+00 -1.17951907e+00 -2.43114346e-01 -2.43114346e-01
 -2.43114346e-01  7.25793131e-02  1.20468882e+00  1.10878182e+01
  6.46861832e+01  2.58998053e+02  8.87872462e+02  3.14157080e+03
  1.26221070e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6703274812891  E_coul = 198.68079324747458
cycle= 4 E= -507.989534233814  delta_E= -5.28e-06  |g|= 0.000147  |ddm|= 0.00897
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000199924
diis-c [-2.83187696e-09 -1.24261465e-05  9.31461087e-03 -1.02180339e-01
  1.09287815e+00]
  HOMO = -0.243193516011199  LUMO = 0.0725779088585536
  mo_energy =
[-1.20327691e+02 -1.23814449e+01 -6.67877891e+00 -6.67877891e+00
 -6.67877891e+00 -1.17956576e+00 -2.43193516e-01 -2.43193516e-01
 -2.43193516e-01  7.25779089e-02  1.20464523e+00  1.10876780e+01
  6.46860588e+01  2.58997958e+02  8.87872388e+02  3.14157074e+03
  1.26221069e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6699385737194  E_coul = 198.6804043334688
cycle= 5 E= -507.989534240251  delta_E= -6.44e-09  |g|= 7.71e-06  |ddm|= 0.000228
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.54328e-06
diis-c [-2.67531605e-12  1.15334016e-06 -1.13403181e-03  1.25828114e-02
 -1.43112020e-01  1.13166209e+00]
  HOMO = -0.243190380525433  LUMO = 0.0725779189077046
  mo_energy =
[-1.20327680e+02 -1.23814357e+01 -6.67876954e+00 -6.67876954e+00
 -6.67876954e+00 -1.17956413e+00 -2.43190381e-01 -2.43190381e-01
 -2.43190381e-01  7.25779189e-02  1.20464618e+00  1.10876848e+01
  6.46860685e+01  2.58997969e+02  8.87872399e+02  3.14157075e+03
  1.26221069e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6699521867292  E_coul = 198.6804179464606
cycle= 6 E= -507.989534240269  delta_E= -1.81e-11  |g|= 1.43e-07  |ddm|= 1.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6699521867292  E_coul = 198.6804179464606
  HOMO = -0.243190317663441  LUMO = 0.0725779149595598
  mo_energy =
[-1.20327680e+02 -1.23814355e+01 -6.67876936e+00 -6.67876936e+00
 -6.67876936e+00 -1.17956407e+00 -2.43190318e-01 -2.43190318e-01
 -2.43190318e-01  7.25779150e-02  1.20464617e+00  1.10876849e+01
  6.46860687e+01  2.58997969e+02  8.87872399e+02  3.14157076e+03
  1.26221069e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6699525429893  E_coul = 198.68041830272085
Extra cycle  E= -507.989534240268  delta_E= 1.71e-13  |g|= 1.73e-08  |ddm|= 3.01e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.68813399e-02 2.54913147e-01 6.48478111e-01 1.17616813e+05
 3.03404771e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232189e+03
 1.83757714e+04 1.44352574e+03 4.17361958e+02 1.47783948e+02
 5.84529750e+01 2.45576392e+01 7.57713456e+00 8.60414568e+00
 4.92681139e-01]
E = -507.9895342402685
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0268813398591      1
[INPUT] 0    0    [1    /1   ]  0.254913147176       1
[INPUT] 0    0    [1    /1   ]  0.648478111379       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03404771463        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175494        1
[INPUT] 0    0    [1    /1   ]  36754.7015412        1
[INPUT] 0    0    [1    /1   ]  7302.32189442        1
[INPUT] 0    0    [1    /1   ]  18375.7713556        1
[INPUT] 0    0    [1    /1   ]  1443.52573711        1
[INPUT] 0    0    [1    /1   ]  417.361958307        1
[INPUT] 0    0    [1    /1   ]  147.783948427        1
[INPUT] 0    0    [1    /1   ]  58.4529750293        1
[INPUT] 0    0    [1    /1   ]  24.5576391808        1
[INPUT] 0    0    [1    /1   ]  7.57713456218        1
[INPUT] 1    0    [1    /1   ]  8.60414567579        1
[INPUT] 1    0    [1    /1   ]  0.492681138782       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.026881339859085956, 1.0]], [0, [0.25491314717612806, 1.0]], [0, [0.6484781113787905, 1.0]], [0, [117616.8128898816, 1.0]], [0, [3.034047714631268, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565709, 1.0]], [0, [294042.03092149383, 1.0]], [0, [147020.99132354834, 1.0]], [0, [73510.41754935193, 1.0]], [0, [36754.70154116422, 1.0]], [0, [7302.321894422451, 1.0]], [0, [18375.77135555643, 1.0]], [0, [1443.5257371076887, 1.0]], [0, [417.3619583070854, 1.0]], [0, [147.78394842661567, 1.0]], [0, [58.45297502931894, 1.0]], [0, [24.557639180800514, 1.0]], [0, [7.577134562179134, 1.0]], [1, [8.604145675789216, 1.0]], [1, [0.4926811387824229, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.02688134]
bas 1, expnt(s) = [0.25491315]
bas 2, expnt(s) = [0.64847811]
bas 3, expnt(s) = [117616.81288988]
bas 4, expnt(s) = [3.03404771]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132355]
bas 9, expnt(s) = [73510.41754935]
bas 10, expnt(s) = [36754.70154116]
bas 11, expnt(s) = [7302.32189442]
bas 12, expnt(s) = [18375.77135556]
bas 13, expnt(s) = [1443.52573711]
bas 14, expnt(s) = [417.36195831]
bas 15, expnt(s) = [147.78394843]
bas 16, expnt(s) = [58.45297503]
bas 17, expnt(s) = [24.55763918]
bas 18, expnt(s) = [7.57713456]
bas 19, expnt(s) = [8.60414568]
bas 20, expnt(s) = [0.49268114]
CPU time:        69.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.68813399e-02 1.67727088e-01 2.54913147e-01 9.06377676e-01
 6.48478111e-01 1.82572985e+00 1.17616813e+05 1.60460108e+04
 3.03404771e+00 5.80806983e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232189e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352574e+03 5.91675277e+02
 4.17361958e+02 2.33291905e+02 1.47783948e+02 1.07086685e+02
 5.84529750e+01 5.34096816e+01 2.45576392e+01 2.78711562e+01
 7.57713456e+00 1.15383517e+01 8.60414568e+00 4.29901624e+01
 4.92681139e-01 1.20418112e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336092555148113
cond(S) = 912125.4686126438
E1 = -689.5859262832935  E_coul = 184.9652903895739
init E= -504.62063589372
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.67233402312538  LUMO = -0.0679141533032017
  mo_energy =
[-1.21710396e+02 -1.33864399e+01 -7.62405313e+00 -7.62405313e+00
 -7.62405313e+00 -1.65745575e+00 -6.72334023e-01 -6.72334023e-01
 -6.72334023e-01 -6.79141533e-02  8.27089158e-01  1.02745248e+01
  6.35082272e+01  2.57657148e+02  8.86512395e+02  3.14028608e+03
  1.26209396e+04  4.12182594e+04  1.05246541e+05  2.30419723e+05
  4.56227274e+05  8.45173918e+05  1.52834575e+06  2.85060645e+06
  5.80848514e+06]
E1 = -707.7359137110136  E_coul = 199.7641563018076
cycle= 1 E= -507.971757409206  delta_E= -3.35  |g|= 0.451  |ddm|= 0.496
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.720667
diis-c [-0.5193613  1.       ]
  HOMO = -0.217854271279657  LUMO = 0.0725775022622061
  mo_energy =
[-1.20202234e+02 -1.23058557e+01 -6.59554674e+00 -6.59554674e+00
 -6.59554674e+00 -1.16336784e+00 -2.17854271e-01 -2.17854271e-01
 -2.17854271e-01  7.25775023e-02  1.21253455e+00  1.11404732e+01
  6.47775152e+01  2.59112897e+02  8.88003854e+02  3.14171704e+03
  1.26222638e+04  4.12195164e+04  1.05247761e+05  2.30420918e+05
  4.56228452e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848628e+06]
E1 = -706.79473018692  E_coul = 198.8054657086076
cycle= 2 E= -507.989264478312  delta_E= -0.0175  |g|= 0.0347  |ddm|= 0.43
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.035647
diis-c [-0.0012701  -0.00108447  1.00108447]
  HOMO = -0.239832739088573  LUMO = 0.0725934685660503
  mo_energy =
[-1.20315381e+02 -1.23723976e+01 -6.66924391e+00 -6.66924391e+00
 -6.66924391e+00 -1.17752766e+00 -2.39832739e-01 -2.39832739e-01
 -2.39832739e-01  7.25934686e-02  1.20594635e+00  1.10944415e+01
  6.46961322e+01  2.59009604e+02  8.87884955e+02  3.14158403e+03
  1.26221207e+04  4.12193695e+04  1.05247613e+05  2.30420769e+05
  4.56228302e+05  8.45174933e+05  1.52834675e+06  2.85060744e+06
  5.80848613e+06]
E1 = -706.6864135126561  E_coul = 198.6968845540052
cycle= 3 E= -507.989528958651  delta_E= -0.000264  |g|= 0.00442  |ddm|= 0.058
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00463286
diis-c [-3.98034861e-06 -3.12305146e-04 -1.32481035e-01  1.13279334e+00]
  HOMO = -0.243114345935126  LUMO = 0.0725793130716514
  mo_energy =
[-1.20327611e+02 -1.23812909e+01 -6.67864099e+00 -6.67864099e+00
 -6.67864099e+00 -1.17951907e+00 -2.43114346e-01 -2.43114346e-01
 -2.43114346e-01  7.25793131e-02  1.20468882e+00  1.10878182e+01
  6.46861832e+01  2.58998053e+02  8.87872462e+02  3.14157080e+03
  1.26221070e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6703274812891  E_coul = 198.68079324747458
cycle= 4 E= -507.989534233814  delta_E= -5.28e-06  |g|= 0.000147  |ddm|= 0.00897
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000199924
diis-c [-2.83187696e-09 -1.24261465e-05  9.31461087e-03 -1.02180339e-01
  1.09287815e+00]
  HOMO = -0.243193516011199  LUMO = 0.0725779088585536
  mo_energy =
[-1.20327691e+02 -1.23814449e+01 -6.67877891e+00 -6.67877891e+00
 -6.67877891e+00 -1.17956576e+00 -2.43193516e-01 -2.43193516e-01
 -2.43193516e-01  7.25779089e-02  1.20464523e+00  1.10876780e+01
  6.46860588e+01  2.58997958e+02  8.87872388e+02  3.14157074e+03
  1.26221069e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848611e+06]
E1 = -706.6699385737194  E_coul = 198.6804043334688
cycle= 5 E= -507.989534240251  delta_E= -6.44e-09  |g|= 7.71e-06  |ddm|= 0.000228
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.54328e-06
diis-c [-2.67531605e-12  1.15334016e-06 -1.13403181e-03  1.25828114e-02
 -1.43112020e-01  1.13166209e+00]
  HOMO = -0.243190380525433  LUMO = 0.0725779189077046
  mo_energy =
[-1.20327680e+02 -1.23814357e+01 -6.67876954e+00 -6.67876954e+00
 -6.67876954e+00 -1.17956413e+00 -2.43190381e-01 -2.43190381e-01
 -2.43190381e-01  7.25779189e-02  1.20464618e+00  1.10876848e+01
  6.46860685e+01  2.58997969e+02  8.87872399e+02  3.14157075e+03
  1.26221069e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6699521867292  E_coul = 198.6804179464606
cycle= 6 E= -507.989534240269  delta_E= -1.81e-11  |g|= 1.43e-07  |ddm|= 1.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6699521867292  E_coul = 198.6804179464606
  HOMO = -0.243190317663441  LUMO = 0.0725779149595598
  mo_energy =
[-1.20327680e+02 -1.23814355e+01 -6.67876936e+00 -6.67876936e+00
 -6.67876936e+00 -1.17956407e+00 -2.43190318e-01 -2.43190318e-01
 -2.43190318e-01  7.25779150e-02  1.20464617e+00  1.10876849e+01
  6.46860687e+01  2.58997969e+02  8.87872399e+02  3.14157076e+03
  1.26221069e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6699525429893  E_coul = 198.68041830272085
Extra cycle  E= -507.989534240268  delta_E= 1.71e-13  |g|= 1.73e-08  |ddm|= 3.01e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912125.4686126438
E1 = -706.6699525429893  E_coul = 198.68041830272085
init E= -507.989534240268
    CPU time for initialize scf     10.15 sec, wall time      0.46 sec
  HOMO = -0.243190308021517  LUMO = 0.0725779150383486
  mo_energy =
[-1.20327679e+02 -1.23814355e+01 -6.67876933e+00 -6.67876933e+00
 -6.67876933e+00 -1.17956406e+00 -2.43190308e-01 -2.43190308e-01
 -2.43190308e-01  7.25779150e-02  1.20464617e+00  1.10876850e+01
  6.46860687e+01  2.58997969e+02  8.87872399e+02  3.14157076e+03
  1.26221069e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6699525828903  E_coul = 198.6804183426219
cycle= 1 E= -507.989534240268  delta_E= 5.68e-14  |g|= 3.14e-09  |ddm|= 3.46e-08
    CPU time for cycle= 1      0.17 sec, wall time      0.03 sec
E1 = -706.6699525828903  E_coul = 198.6804183426219
  HOMO = -0.243190306919898  LUMO = 0.0725779148968853
  mo_energy =
[-1.20327679e+02 -1.23814355e+01 -6.67876933e+00 -6.67876933e+00
 -6.67876933e+00 -1.17956406e+00 -2.43190307e-01 -2.43190307e-01
 -2.43190307e-01  7.25779149e-02  1.20464618e+00  1.10876850e+01
  6.46860687e+01  2.58997969e+02  8.87872399e+02  3.14157076e+03
  1.26221069e+04  4.12193556e+04  1.05247599e+05  2.30420755e+05
  4.56228288e+05  8.45174919e+05  1.52834674e+06  2.85060743e+06
  5.80848612e+06]
E1 = -706.6699525900485  E_coul = 198.68041834978
Extra cycle  E= -507.989534240269  delta_E= -1.14e-13  |g|= 1.61e-09  |ddm|= 4.65e-09
    CPU time for scf_cycle     10.49 sec, wall time      0.66 sec
exp = [2.68813399e-02 2.54913147e-01 6.48478111e-01 1.17616813e+05
 3.03404771e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232189e+03
 1.83757714e+04 1.44352574e+03 4.17361958e+02 1.47783948e+02
 5.84529750e+01 2.45576392e+01 7.57713456e+00 8.60414568e+00
 4.92681139e-01]
grad_E = [-6.30882608e-03  1.95103193e-03 -2.50448036e-03  6.06845057e-09
 -6.83776016e-04  4.05090968e-11  1.74358065e-10  9.41251097e-10
  3.71897923e-09  1.55300331e-08  8.09992394e-08  5.10538171e-06
  1.98626822e-07 -3.86086643e-05 -5.00315405e-06 -7.23662199e-07
 -8.23155597e-07  3.66258867e-06  1.37224823e-04 -1.14517225e-05
 -2.11640047e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0353848955945      1
[INPUT] 0    0    [1    /1   ]  0.257079921473       1
[INPUT] 0    0    [1    /1   ]  0.6503206911         1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03483361797        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175493        1
[INPUT] 0    0    [1    /1   ]  36754.701541         1
[INPUT] 0    0    [1    /1   ]  7302.32188677        1
[INPUT] 0    0    [1    /1   ]  18375.7713553        1
[INPUT] 0    0    [1    /1   ]  1443.52579495        1
[INPUT] 0    0    [1    /1   ]  417.36196577         1
[INPUT] 0    0    [1    /1   ]  147.783949698        1
[INPUT] 0    0    [1    /1   ]  58.4529753967        1
[INPUT] 0    0    [1    /1   ]  24.5576352029        1
[INPUT] 0    0    [1    /1   ]  7.57697141208        1
[INPUT] 1    0    [1    /1   ]  8.60425732859        1
[INPUT] 1    0    [1    /1   ]  0.492659711874       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.03538489559448164, 1.0]], [0, [0.25707992147268643, 1.0]], [0, [0.6503206911003698, 1.0]], [0, [117616.81288987251, 1.0]], [0, [3.0348336179734146, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565706, 1.0]], [0, [294042.03092149243, 1.0]], [0, [147020.99132354278, 1.0]], [0, [73510.41754932866, 1.0]], [0, [36754.70154104288, 1.0]], [0, [7302.321886774437, 1.0]], [0, [18375.77135525888, 1.0]], [0, [1443.5257949472311, 1.0]], [0, [417.3619657695046, 1.0]], [0, [147.78394969791648, 1.0]], [0, [58.45297539667207, 1.0]], [0, [24.557635202949964, 1.0]], [0, [7.576971412083902, 1.0]], [1, [8.60425732859481, 1.0]], [1, [0.49265971187426444, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.0353849]
bas 1, expnt(s) = [0.25707992]
bas 2, expnt(s) = [0.65032069]
bas 3, expnt(s) = [117616.81288987]
bas 4, expnt(s) = [3.03483362]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132354]
bas 9, expnt(s) = [73510.41754933]
bas 10, expnt(s) = [36754.70154104]
bas 11, expnt(s) = [7302.32188677]
bas 12, expnt(s) = [18375.77135526]
bas 13, expnt(s) = [1443.52579495]
bas 14, expnt(s) = [417.36196577]
bas 15, expnt(s) = [147.7839497]
bas 16, expnt(s) = [58.4529754]
bas 17, expnt(s) = [24.5576352]
bas 18, expnt(s) = [7.57697141]
bas 19, expnt(s) = [8.60425733]
bas 20, expnt(s) = [0.49265971]
CPU time:        88.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.53848956e-02 2.06123953e-01 2.57079921e-01 9.12149749e-01
 6.50320691e-01 1.82961918e+00 1.17616813e+05 1.60460108e+04
 3.03483362e+00 5.80919813e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232189e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352579e+03 5.91675295e+02
 4.17361966e+02 2.33291909e+02 1.47783950e+02 1.07086685e+02
 5.84529754e+01 5.34096819e+01 2.45576352e+01 2.78711528e+01
 7.57697141e+00 1.15381654e+01 8.60425733e+00 4.29908598e+01
 4.92659712e-01 1.20411566e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336157023906797
cond(S) = 912127.3807250719
E1 = -689.5864783350314  E_coul = 184.9656346203408
init E= -504.620843714691
    CPU time for initialize scf      7.67 sec, wall time      0.37 sec
  HOMO = -0.67234199141748  LUMO = -0.0571767546559562
  mo_energy =
[-1.21710308e+02 -1.33864197e+01 -7.62401718e+00 -7.62401718e+00
 -7.62401718e+00 -1.65747468e+00 -6.72341991e-01 -6.72341991e-01
 -6.72341991e-01 -5.71767547e-02  8.79449093e-01  1.03339786e+01
  6.35592400e+01  2.57701007e+02  8.86551078e+02  3.14032052e+03
  1.26209700e+04  4.12182876e+04  1.05246568e+05  2.30419749e+05
  4.56227300e+05  8.45173943e+05  1.52834577e+06  2.85060647e+06
  5.80848517e+06]
E1 = -707.7355380049304  E_coul = 199.7637509305645
cycle= 1 E= -507.971787074366  delta_E= -3.35  |g|= 0.451  |ddm|= 0.49
    CPU time for cycle= 1      0.56 sec, wall time      0.03 sec
diis-norm(errvec)=0.725374
diis-c [-0.52616766  1.        ]
  HOMO = -0.217895057002466  LUMO = 0.0971184195832893
  mo_energy =
[-1.20202209e+02 -1.23058920e+01 -6.59556311e+00 -6.59556311e+00
 -6.59556311e+00 -1.16340980e+00 -2.17895057e-01 -2.17895057e-01
 -2.17895057e-01  9.71184196e-02  1.26568672e+00  1.11994256e+01
  6.48283267e+01  2.59156661e+02  8.88042465e+02  3.14175141e+03
  1.26222941e+04  4.12195446e+04  1.05247788e+05  2.30420944e+05
  4.56228478e+05  8.45175108e+05  1.52834693e+06  2.85060762e+06
  5.80848630e+06]
E1 = -706.7932876702052  E_coul = 198.8039743574914
cycle= 2 E= -507.989313312714  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.428
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0374179
diis-c [-0.00139729 -0.00232196  1.00232196]
  HOMO = -0.239938453983856  LUMO = 0.0971273258646921
  mo_energy =
[-1.20315588e+02 -1.23725924e+01 -6.66943073e+00 -6.66943073e+00
 -6.66943073e+00 -1.17761594e+00 -2.39938454e-01 -2.39938454e-01
 -2.39938454e-01  9.71273259e-02  1.25879878e+00  1.11532355e+01
  6.47467663e+01  2.59053153e+02  8.87923327e+02  3.14161814e+03
  1.26221508e+04  4.12193974e+04  1.05247639e+05  2.30420795e+05
  4.56228328e+05  8.45174958e+05  1.52834678e+06  2.85060747e+06
  5.80848615e+06]
E1 = -706.6842698939387  E_coul = 198.69468933323049
cycle= 3 E= -507.989580560708  delta_E= -0.000267  |g|= 0.00441  |ddm|= 0.0569
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00497993
diis-c [-4.44100094e-06 -3.47097448e-04 -1.36491405e-01  1.13683850e+00]
  HOMO = -0.243235791861147  LUMO = 0.0971048701044275
  mo_energy =
[-1.20327789e+02 -1.23814932e+01 -6.67882938e+00 -6.67882938e+00
 -6.67882938e+00 -1.17961760e+00 -2.43235792e-01 -2.43235792e-01
 -2.43235792e-01  9.71048701e-02  1.25748307e+00  1.11465932e+01
  6.47368221e+01  2.59041623e+02  8.87910867e+02  3.14160496e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.6680113042918  E_coul = 198.6784253331999
cycle= 4 E= -507.989585971092  delta_E= -5.41e-06  |g|= 0.000151  |ddm|= 0.00865
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000214529
diis-c [-3.69002674e-09 -1.34532603e-05  9.65732291e-03 -1.02996576e-01
  1.09335271e+00]
  HOMO = -0.2433061014991  LUMO = 0.0971027516345718
  mo_energy =
[-1.20327822e+02 -1.23816167e+01 -6.67893425e+00 -6.67893425e+00
 -6.67893425e+00 -1.17965912e+00 -2.43306101e-01 -2.43306101e-01
 -2.43306101e-01  9.71027516e-02  1.25743966e+00  1.11464740e+01
  6.47367334e+01  2.59041572e+02  8.87910841e+02  3.14160495e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.6676576219592  E_coul = 198.67807164344737
cycle= 5 E= -507.989585978512  delta_E= -7.42e-09  |g|= 9.69e-06  |ddm|= 0.000213
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.78847e-06
diis-c [-3.03358317e-12  1.23608653e-06 -1.19898160e-03  1.29045506e-02
 -1.48678861e-01  1.13697206e+00]
  HOMO = -0.243302610738206  LUMO = 0.0971027575549572
  mo_energy =
[-1.20327809e+02 -1.23816061e+01 -6.67892346e+00 -6.67892346e+00
 -6.67892346e+00 -1.17965732e+00 -2.43302611e-01 -2.43302611e-01
 -2.43302611e-01  9.71027576e-02  1.25744059e+00  1.11464816e+01
  6.47367445e+01  2.59041584e+02  8.87910854e+02  3.14160497e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.667672225391  E_coul = 198.67808624685122
cycle= 6 E= -507.98958597854  delta_E= -2.8e-11  |g|= 1.47e-07  |ddm|= 2.34e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.667672225391  E_coul = 198.67808624685122
  HOMO = -0.243302552478159  LUMO = 0.0971027519966299
  mo_energy =
[-1.20327809e+02 -1.23816060e+01 -6.67892328e+00 -6.67892328e+00
 -6.67892328e+00 -1.17965726e+00 -2.43302552e-01 -2.43302552e-01
 -2.43302552e-01  9.71027520e-02  1.25744058e+00  1.11464818e+01
  6.47367447e+01  2.59041584e+02  8.87910854e+02  3.14160497e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.6676725636765  E_coul = 198.6780865851365
Extra cycle  E= -507.98958597854  delta_E= -2.27e-13  |g|= 1.84e-08  |ddm|= 3.16e-07
    CPU time for scf_cycle      8.46 sec, wall time      0.59 sec
exp = [3.53848956e-02 2.57079921e-01 6.50320691e-01 1.17616813e+05
 3.03483362e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232189e+03
 1.83757714e+04 1.44352579e+03 4.17361966e+02 1.47783950e+02
 5.84529754e+01 2.45576352e+01 7.57697141e+00 8.60425733e+00
 4.92659712e-01]
E = -507.98958597854005
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0353848955945      1
[INPUT] 0    0    [1    /1   ]  0.257079921473       1
[INPUT] 0    0    [1    /1   ]  0.6503206911         1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03483361797        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175493        1
[INPUT] 0    0    [1    /1   ]  36754.701541         1
[INPUT] 0    0    [1    /1   ]  7302.32188677        1
[INPUT] 0    0    [1    /1   ]  18375.7713553        1
[INPUT] 0    0    [1    /1   ]  1443.52579495        1
[INPUT] 0    0    [1    /1   ]  417.36196577         1
[INPUT] 0    0    [1    /1   ]  147.783949698        1
[INPUT] 0    0    [1    /1   ]  58.4529753967        1
[INPUT] 0    0    [1    /1   ]  24.5576352029        1
[INPUT] 0    0    [1    /1   ]  7.57697141208        1
[INPUT] 1    0    [1    /1   ]  8.60425732859        1
[INPUT] 1    0    [1    /1   ]  0.492659711874       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.03538489559448164, 1.0]], [0, [0.25707992147268643, 1.0]], [0, [0.6503206911003698, 1.0]], [0, [117616.81288987251, 1.0]], [0, [3.0348336179734146, 1.0]], [0, [1176168.142613455, 1.0]], [0, [588084.0699565706, 1.0]], [0, [294042.03092149243, 1.0]], [0, [147020.99132354278, 1.0]], [0, [73510.41754932866, 1.0]], [0, [36754.70154104288, 1.0]], [0, [7302.321886774437, 1.0]], [0, [18375.77135525888, 1.0]], [0, [1443.5257949472311, 1.0]], [0, [417.3619657695046, 1.0]], [0, [147.78394969791648, 1.0]], [0, [58.45297539667207, 1.0]], [0, [24.557635202949964, 1.0]], [0, [7.576971412083902, 1.0]], [1, [8.60425732859481, 1.0]], [1, [0.49265971187426444, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.0353849]
bas 1, expnt(s) = [0.25707992]
bas 2, expnt(s) = [0.65032069]
bas 3, expnt(s) = [117616.81288987]
bas 4, expnt(s) = [3.03483362]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092149]
bas 8, expnt(s) = [147020.99132354]
bas 9, expnt(s) = [73510.41754933]
bas 10, expnt(s) = [36754.70154104]
bas 11, expnt(s) = [7302.32188677]
bas 12, expnt(s) = [18375.77135526]
bas 13, expnt(s) = [1443.52579495]
bas 14, expnt(s) = [417.36196577]
bas 15, expnt(s) = [147.7839497]
bas 16, expnt(s) = [58.4529754]
bas 17, expnt(s) = [24.5576352]
bas 18, expnt(s) = [7.57697141]
bas 19, expnt(s) = [8.60425733]
bas 20, expnt(s) = [0.49265971]
CPU time:        97.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.53848956e-02 2.06123953e-01 2.57079921e-01 9.12149749e-01
 6.50320691e-01 1.82961918e+00 1.17616813e+05 1.60460108e+04
 3.03483362e+00 5.80919813e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232189e+03 1.99577121e+03
 1.83757714e+04 3.98748634e+03 1.44352579e+03 5.91675295e+02
 4.17361966e+02 2.33291909e+02 1.47783950e+02 1.07086685e+02
 5.84529754e+01 5.34096819e+01 2.45576352e+01 2.78711528e+01
 7.57697141e+00 1.15381654e+01 8.60425733e+00 4.29908598e+01
 4.92659712e-01 1.20411566e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336157023906797
cond(S) = 912127.3807250719
E1 = -689.5864783350314  E_coul = 184.9656346203408
init E= -504.620843714691
    CPU time for initialize scf      5.13 sec, wall time      0.26 sec
  HOMO = -0.67234199141748  LUMO = -0.0571767546559562
  mo_energy =
[-1.21710308e+02 -1.33864197e+01 -7.62401718e+00 -7.62401718e+00
 -7.62401718e+00 -1.65747468e+00 -6.72341991e-01 -6.72341991e-01
 -6.72341991e-01 -5.71767547e-02  8.79449093e-01  1.03339786e+01
  6.35592400e+01  2.57701007e+02  8.86551078e+02  3.14032052e+03
  1.26209700e+04  4.12182876e+04  1.05246568e+05  2.30419749e+05
  4.56227300e+05  8.45173943e+05  1.52834577e+06  2.85060647e+06
  5.80848517e+06]
E1 = -707.7355380049304  E_coul = 199.7637509305645
cycle= 1 E= -507.971787074366  delta_E= -3.35  |g|= 0.451  |ddm|= 0.49
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.725374
diis-c [-0.52616766  1.        ]
  HOMO = -0.217895057002466  LUMO = 0.0971184195832893
  mo_energy =
[-1.20202209e+02 -1.23058920e+01 -6.59556311e+00 -6.59556311e+00
 -6.59556311e+00 -1.16340980e+00 -2.17895057e-01 -2.17895057e-01
 -2.17895057e-01  9.71184196e-02  1.26568672e+00  1.11994256e+01
  6.48283267e+01  2.59156661e+02  8.88042465e+02  3.14175141e+03
  1.26222941e+04  4.12195446e+04  1.05247788e+05  2.30420944e+05
  4.56228478e+05  8.45175108e+05  1.52834693e+06  2.85060762e+06
  5.80848630e+06]
E1 = -706.7932876702052  E_coul = 198.8039743574914
cycle= 2 E= -507.989313312714  delta_E= -0.0175  |g|= 0.0348  |ddm|= 0.428
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0374179
diis-c [-0.00139729 -0.00232196  1.00232196]
  HOMO = -0.239938453983856  LUMO = 0.0971273258646921
  mo_energy =
[-1.20315588e+02 -1.23725924e+01 -6.66943073e+00 -6.66943073e+00
 -6.66943073e+00 -1.17761594e+00 -2.39938454e-01 -2.39938454e-01
 -2.39938454e-01  9.71273259e-02  1.25879878e+00  1.11532355e+01
  6.47467663e+01  2.59053153e+02  8.87923327e+02  3.14161814e+03
  1.26221508e+04  4.12193974e+04  1.05247639e+05  2.30420795e+05
  4.56228328e+05  8.45174958e+05  1.52834678e+06  2.85060747e+06
  5.80848615e+06]
E1 = -706.6842698939387  E_coul = 198.69468933323049
cycle= 3 E= -507.989580560708  delta_E= -0.000267  |g|= 0.00441  |ddm|= 0.0569
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00497993
diis-c [-4.44100094e-06 -3.47097448e-04 -1.36491405e-01  1.13683850e+00]
  HOMO = -0.243235791861147  LUMO = 0.0971048701044275
  mo_energy =
[-1.20327789e+02 -1.23814932e+01 -6.67882938e+00 -6.67882938e+00
 -6.67882938e+00 -1.17961760e+00 -2.43235792e-01 -2.43235792e-01
 -2.43235792e-01  9.71048701e-02  1.25748307e+00  1.11465932e+01
  6.47368221e+01  2.59041623e+02  8.87910867e+02  3.14160496e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.6680113042918  E_coul = 198.6784253331999
cycle= 4 E= -507.989585971092  delta_E= -5.41e-06  |g|= 0.000151  |ddm|= 0.00865
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.000214529
diis-c [-3.69002674e-09 -1.34532603e-05  9.65732291e-03 -1.02996576e-01
  1.09335271e+00]
  HOMO = -0.2433061014991  LUMO = 0.0971027516345718
  mo_energy =
[-1.20327822e+02 -1.23816167e+01 -6.67893425e+00 -6.67893425e+00
 -6.67893425e+00 -1.17965912e+00 -2.43306101e-01 -2.43306101e-01
 -2.43306101e-01  9.71027516e-02  1.25743966e+00  1.11464740e+01
  6.47367334e+01  2.59041572e+02  8.87910841e+02  3.14160495e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.6676576219592  E_coul = 198.67807164344737
cycle= 5 E= -507.989585978512  delta_E= -7.42e-09  |g|= 9.69e-06  |ddm|= 0.000213
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.78847e-06
diis-c [-3.03358317e-12  1.23608653e-06 -1.19898160e-03  1.29045506e-02
 -1.48678861e-01  1.13697206e+00]
  HOMO = -0.243302610738206  LUMO = 0.0971027575549572
  mo_energy =
[-1.20327809e+02 -1.23816061e+01 -6.67892346e+00 -6.67892346e+00
 -6.67892346e+00 -1.17965732e+00 -2.43302611e-01 -2.43302611e-01
 -2.43302611e-01  9.71027576e-02  1.25744059e+00  1.11464816e+01
  6.47367445e+01  2.59041584e+02  8.87910854e+02  3.14160497e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.667672225391  E_coul = 198.67808624685122
cycle= 6 E= -507.98958597854  delta_E= -2.8e-11  |g|= 1.47e-07  |ddm|= 2.34e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.667672225391  E_coul = 198.67808624685122
  HOMO = -0.243302552478159  LUMO = 0.0971027519966299
  mo_energy =
[-1.20327809e+02 -1.23816060e+01 -6.67892328e+00 -6.67892328e+00
 -6.67892328e+00 -1.17965726e+00 -2.43302552e-01 -2.43302552e-01
 -2.43302552e-01  9.71027520e-02  1.25744058e+00  1.11464818e+01
  6.47367447e+01  2.59041584e+02  8.87910854e+02  3.14160497e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.6676725636765  E_coul = 198.6780865851365
Extra cycle  E= -507.98958597854  delta_E= -2.27e-13  |g|= 1.84e-08  |ddm|= 3.16e-07
    CPU time for scf_cycle      5.94 sec, wall time      0.49 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912127.3807250719
E1 = -706.6676725636765  E_coul = 198.6780865851365
init E= -507.98958597854
    CPU time for initialize scf      6.23 sec, wall time      0.26 sec
  HOMO = -0.243302543482011  LUMO = 0.0971027520532367
  mo_energy =
[-1.20327809e+02 -1.23816059e+01 -6.67892326e+00 -6.67892326e+00
 -6.67892326e+00 -1.17965725e+00 -2.43302543e-01 -2.43302543e-01
 -2.43302543e-01  9.71027521e-02  1.25744059e+00  1.11464818e+01
  6.47367447e+01  2.59041584e+02  8.87910854e+02  3.14160497e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.667672607802  E_coul = 198.6780866292626
cycle= 1 E= -507.989585978539  delta_E= 5.68e-13  |g|= 2.47e-09  |ddm|= 4.14e-08
    CPU time for cycle= 1      0.40 sec, wall time      0.03 sec
E1 = -706.667672607802  E_coul = 198.6780866292626
  HOMO = -0.243302542319685  LUMO = 0.0971027518513587
  mo_energy =
[-1.20327809e+02 -1.23816059e+01 -6.67892325e+00 -6.67892325e+00
 -6.67892325e+00 -1.17965725e+00 -2.43302542e-01 -2.43302542e-01
 -2.43302542e-01  9.71027519e-02  1.25744059e+00  1.11464818e+01
  6.47367448e+01  2.59041584e+02  8.87910854e+02  3.14160497e+03
  1.26221371e+04  4.12193835e+04  1.05247626e+05  2.30420781e+05
  4.56228314e+05  8.45174944e+05  1.52834676e+06  2.85060745e+06
  5.80848614e+06]
E1 = -706.6676726147007  E_coul = 198.6780866361609
Extra cycle  E= -507.98958597854  delta_E= -2.84e-13  |g|= 1.49e-09  |ddm|= 4.86e-09
    CPU time for scf_cycle      6.77 sec, wall time      0.43 sec
exp = [3.53848956e-02 2.57079921e-01 6.50320691e-01 1.17616813e+05
 3.03483362e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232189e+03
 1.83757714e+04 1.44352579e+03 4.17361966e+02 1.47783950e+02
 5.84529754e+01 2.45576352e+01 7.57697141e+00 8.60425733e+00
 4.92659712e-01]
grad_E = [-5.31190707e-03  5.65431767e-04 -2.35860401e-03  6.06848596e-09
 -7.72433340e-04  4.05095288e-11  1.74359254e-10  9.41256515e-10
  3.71900119e-09  1.55301263e-08  8.09996828e-08  5.10541106e-06
  1.98628341e-07 -3.86102856e-05 -4.98694531e-06 -8.09709061e-07
 -5.76364116e-07  3.29666401e-06  1.48506214e-04  9.38232482e-05
 -3.32102411e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0762041463852      1
[INPUT] 0    0    [1    /1   ]  0.270358907478       1
[INPUT] 0    0    [1    /1   ]  0.661204489022       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03965322385        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175492        1
[INPUT] 0    0    [1    /1   ]  36754.7015404        1
[INPUT] 0    0    [1    /1   ]  7302.32184642        1
[INPUT] 0    0    [1    /1   ]  18375.7713537        1
[INPUT] 0    0    [1    /1   ]  1443.52610013        1
[INPUT] 0    0    [1    /1   ]  417.362005093        1
[INPUT] 0    0    [1    /1   ]  147.783956655        1
[INPUT] 0    0    [1    /1   ]  58.4529769329        1
[INPUT] 0    0    [1    /1   ]  24.5576145986        1
[INPUT] 0    0    [1    /1   ]  7.57601364368        1
[INPUT] 1    0    [1    /1   ]  8.60448203009        1
[INPUT] 1    0    [1    /1   ]  0.49272574665        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.07620414638524892, 1.0]], [0, [0.27035890747756525, 1.0]], [0, [0.6612044890216304, 1.0]], [0, [117616.81288982455, 1.0]], [0, [3.0396532238525538, 1.0]], [0, [1176168.1426134547, 1.0]], [0, [588084.0699565692, 1.0]], [0, [294042.030921485, 1.0]], [0, [147020.9913235134, 1.0]], [0, [73510.41754920591, 1.0]], [0, [36754.70154040266, 1.0]], [0, [7302.321846421516, 1.0]], [0, [18375.771353688928, 1.0]], [0, [1443.5261001282556, 1.0]], [0, [417.3620050932847, 1.0]], [0, [147.78395665547714, 1.0]], [0, [58.45297693288094, 1.0]], [0, [24.557614598624465, 1.0]], [0, [7.576013643683725, 1.0]], [1, [8.604482030093918, 1.0]], [1, [0.49272574664970775, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.07620415]
bas 1, expnt(s) = [0.27035891]
bas 2, expnt(s) = [0.66120449]
bas 3, expnt(s) = [117616.81288982]
bas 4, expnt(s) = [3.03965322]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092148]
bas 8, expnt(s) = [147020.99132351]
bas 9, expnt(s) = [73510.41754921]
bas 10, expnt(s) = [36754.7015404]
bas 11, expnt(s) = [7302.32184642]
bas 12, expnt(s) = [18375.77135369]
bas 13, expnt(s) = [1443.52610013]
bas 14, expnt(s) = [417.36200509]
bas 15, expnt(s) = [147.78395666]
bas 16, expnt(s) = [58.45297693]
bas 17, expnt(s) = [24.5576146]
bas 18, expnt(s) = [7.57601364]
bas 19, expnt(s) = [8.60448203]
bas 20, expnt(s) = [0.49272575]
CPU time:       116.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.62041464e-02 3.66436711e-01 2.70358907e-01 9.47262918e-01
 6.61204489e-01 1.85253691e+00 1.17616813e+05 1.60460108e+04
 3.03965322e+00 5.81611593e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232185e+03 1.99577120e+03
 1.83757714e+04 3.98748634e+03 1.44352610e+03 5.91675389e+02
 4.17362005e+02 2.33291925e+02 1.47783957e+02 1.07086689e+02
 5.84529769e+01 5.34096829e+01 2.45576146e+01 2.78711352e+01
 7.57601364e+00 1.15370715e+01 8.60448203e+00 4.29922632e+01
 4.92725747e-01 1.20431740e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3361730240758
cond(S) = 912138.4502126457
E1 = -689.5928641788327  E_coul = 184.97084152526787
init E= -504.622022653565
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672189844127909  LUMO = 0.0133342053714816
  mo_energy =
[-1.21709748e+02 -1.33860183e+01 -7.62365830e+00 -7.62365830e+00
 -7.62365830e+00 -1.65741629e+00 -6.72189844e-01 -6.72189844e-01
 -6.72189844e-01  1.33342054e-02  1.13616326e+00  1.06572869e+01
  6.38413808e+01  2.57944147e+02  8.86765615e+02  3.14051154e+03
  1.26211386e+04  4.12184440e+04  1.05246718e+05  2.30419895e+05
  4.56227442e+05  8.45174083e+05  1.52834591e+06  2.85060661e+06
  5.80848530e+06]
E1 = -707.7409567443358  E_coul = 199.76905451801008
cycle= 1 E= -507.971902226326  delta_E= -3.35  |g|= 0.451  |ddm|= 0.461
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.740002
diis-c [-0.54760337  1.        ]
  HOMO = -0.217707233776575  LUMO = 0.209378541338756
  mo_energy =
[-1.20201687e+02 -1.23055129e+01 -6.59522609e+00 -6.59522609e+00
 -6.59522609e+00 -1.16331666e+00 -2.17707234e-01 -2.17707234e-01
 -2.17707234e-01  2.09378541e-01  1.53170927e+00  1.15208697e+01
  6.51097038e+01  2.59399590e+02  8.88256919e+02  3.14194237e+03
  1.26224627e+04  4.12197009e+04  1.05247938e+05  2.30421090e+05
  4.56228621e+05  8.45175248e+05  1.52834706e+06  2.85060775e+06
  5.80848644e+06]
E1 = -706.7955127384105  E_coul = 198.8060199975469
cycle= 2 E= -507.989492740864  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.414
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0414999
diis-c [-0.00170433 -0.00576028  1.00576028]
  HOMO = -0.239923547694712  LUMO = 0.209281495608814
  mo_energy =
[-1.20315760e+02 -1.23726771e+01 -6.66959573e+00 -6.66959573e+00
 -6.66959573e+00 -1.17764171e+00 -2.39923548e-01 -2.39923548e-01
 -2.39923548e-01  2.09281496e-01  1.52341183e+00  1.14741294e+01
  6.50276297e+01  2.59295446e+02  8.88137065e+02  3.14180832e+03
  1.26223185e+04  4.12195528e+04  1.05247788e+05  2.30420940e+05
  4.56228470e+05  8.45175097e+05  1.52834691e+06  2.85060760e+06
  5.80848628e+06]
E1 = -706.6846846019102  E_coul = 198.69491715648428
cycle= 3 E= -507.989767445426  delta_E= -0.000275  |g|= 0.0044  |ddm|= 0.0513
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00559023
diis-c [-5.02726224e-06 -3.73029055e-04 -1.39680818e-01  1.14005385e+00]
  HOMO = -0.243235683733806  LUMO = 0.20920797159939
  mo_energy =
[-1.20327771e+02 -1.23815178e+01 -6.67891343e+00 -6.67891343e+00
 -6.67891343e+00 -1.17965450e+00 -2.43235684e-01 -2.43235684e-01
 -2.43235684e-01  2.09207972e-01  1.52185941e+00  1.14674881e+01
  6.50177903e+01  2.59284078e+02  8.88124812e+02  3.14179539e+03
  1.26223051e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6680860320413  E_coul = 198.67831276292623
cycle= 4 E= -507.989773269115  delta_E= -5.82e-06  |g|= 0.000191  |ddm|= 0.00738
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000230296
diis-c [-4.38240150e-09 -1.42593472e-05  9.71364338e-03 -1.01724495e-01
  1.09202511e+00]
  HOMO = -0.243304355210143  LUMO = 0.209201950676476
  mo_energy =
[-1.20327761e+02 -1.23816177e+01 -6.67899139e+00 -6.67899139e+00
 -6.67899139e+00 -1.17969593e+00 -2.43304355e-01 -2.43304355e-01
 -2.43304355e-01  2.09201951e-01  1.52180608e+00  1.14673817e+01
  6.50177317e+01  2.59284067e+02  8.88124831e+02  3.14179543e+03
  1.26223052e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6677155221837  E_coul = 198.67794224019926
cycle= 5 E= -507.989773281984  delta_E= -1.29e-08  |g|= 1.39e-05  |ddm|= 0.000416
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.39175e-06
diis-c [-3.40074094e-12  1.32885611e-06 -1.23167157e-03  1.27353778e-02
 -1.55139738e-01  1.14363470e+00]
  HOMO = -0.24330258079863  LUMO = 0.209201844619495
  mo_energy =
[-1.20327752e+02 -1.23816098e+01 -6.67898330e+00 -6.67898330e+00
 -6.67898330e+00 -1.17969529e+00 -2.43302581e-01 -2.43302581e-01
 -2.43302581e-01  2.09201845e-01  1.52180574e+00  1.14673868e+01
  6.50177400e+01  2.59284076e+02  8.88124841e+02  3.14179544e+03
  1.26223052e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6677193152153  E_coul = 198.6779460331725
cycle= 6 E= -507.989773282043  delta_E= -5.84e-11  |g|= 1.39e-07  |ddm|= 4.43e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6677193152153  E_coul = 198.6779460331725
  HOMO = -0.243302554410556  LUMO = 0.209201831388906
  mo_energy =
[-1.20327751e+02 -1.23816097e+01 -6.67898319e+00 -6.67898319e+00
 -6.67898319e+00 -1.17969524e+00 -2.43302554e-01 -2.43302554e-01
 -2.43302554e-01  2.09201831e-01  1.52180572e+00  1.14673868e+01
  6.50177401e+01  2.59284076e+02  8.88124841e+02  3.14179544e+03
  1.26223052e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6677195016852  E_coul = 198.67794621964242
Extra cycle  E= -507.989773282043  delta_E= 1.14e-13  |g|= 1.74e-08  |ddm|= 3.63e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
exp = [7.62041464e-02 2.70358907e-01 6.61204489e-01 1.17616813e+05
 3.03965322e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232185e+03
 1.83757714e+04 1.44352610e+03 4.17362005e+02 1.47783957e+02
 5.84529769e+01 2.45576146e+01 7.57601364e+00 8.60448203e+00
 4.92725747e-01]
E = -507.98977328204273
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.0762041463852      1
[INPUT] 0    0    [1    /1   ]  0.270358907478       1
[INPUT] 0    0    [1    /1   ]  0.661204489022       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.03965322385        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991324        1
[INPUT] 0    0    [1    /1   ]  73510.4175492        1
[INPUT] 0    0    [1    /1   ]  36754.7015404        1
[INPUT] 0    0    [1    /1   ]  7302.32184642        1
[INPUT] 0    0    [1    /1   ]  18375.7713537        1
[INPUT] 0    0    [1    /1   ]  1443.52610013        1
[INPUT] 0    0    [1    /1   ]  417.362005093        1
[INPUT] 0    0    [1    /1   ]  147.783956655        1
[INPUT] 0    0    [1    /1   ]  58.4529769329        1
[INPUT] 0    0    [1    /1   ]  24.5576145986        1
[INPUT] 0    0    [1    /1   ]  7.57601364368        1
[INPUT] 1    0    [1    /1   ]  8.60448203009        1
[INPUT] 1    0    [1    /1   ]  0.49272574665        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.07620414638524892, 1.0]], [0, [0.27035890747756525, 1.0]], [0, [0.6612044890216304, 1.0]], [0, [117616.81288982455, 1.0]], [0, [3.0396532238525538, 1.0]], [0, [1176168.1426134547, 1.0]], [0, [588084.0699565692, 1.0]], [0, [294042.030921485, 1.0]], [0, [147020.9913235134, 1.0]], [0, [73510.41754920591, 1.0]], [0, [36754.70154040266, 1.0]], [0, [7302.321846421516, 1.0]], [0, [18375.771353688928, 1.0]], [0, [1443.5261001282556, 1.0]], [0, [417.3620050932847, 1.0]], [0, [147.78395665547714, 1.0]], [0, [58.45297693288094, 1.0]], [0, [24.557614598624465, 1.0]], [0, [7.576013643683725, 1.0]], [1, [8.604482030093918, 1.0]], [1, [0.49272574664970775, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.07620415]
bas 1, expnt(s) = [0.27035891]
bas 2, expnt(s) = [0.66120449]
bas 3, expnt(s) = [117616.81288982]
bas 4, expnt(s) = [3.03965322]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092148]
bas 8, expnt(s) = [147020.99132351]
bas 9, expnt(s) = [73510.41754921]
bas 10, expnt(s) = [36754.7015404]
bas 11, expnt(s) = [7302.32184642]
bas 12, expnt(s) = [18375.77135369]
bas 13, expnt(s) = [1443.52610013]
bas 14, expnt(s) = [417.36200509]
bas 15, expnt(s) = [147.78395666]
bas 16, expnt(s) = [58.45297693]
bas 17, expnt(s) = [24.5576146]
bas 18, expnt(s) = [7.57601364]
bas 19, expnt(s) = [8.60448203]
bas 20, expnt(s) = [0.49272575]
CPU time:       118.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.62041464e-02 3.66436711e-01 2.70358907e-01 9.47262918e-01
 6.61204489e-01 1.85253691e+00 1.17616813e+05 1.60460108e+04
 3.03965322e+00 5.81611593e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232185e+03 1.99577120e+03
 1.83757714e+04 3.98748634e+03 1.44352610e+03 5.91675389e+02
 4.17362005e+02 2.33291925e+02 1.47783957e+02 1.07086689e+02
 5.84529769e+01 5.34096829e+01 2.45576146e+01 2.78711352e+01
 7.57601364e+00 1.15370715e+01 8.60448203e+00 4.29922632e+01
 4.92725747e-01 1.20431740e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3361730240758
cond(S) = 912138.4502126457
E1 = -689.5928641788327  E_coul = 184.97084152526787
init E= -504.622022653565
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.672189844127909  LUMO = 0.0133342053714816
  mo_energy =
[-1.21709748e+02 -1.33860183e+01 -7.62365830e+00 -7.62365830e+00
 -7.62365830e+00 -1.65741629e+00 -6.72189844e-01 -6.72189844e-01
 -6.72189844e-01  1.33342054e-02  1.13616326e+00  1.06572869e+01
  6.38413808e+01  2.57944147e+02  8.86765615e+02  3.14051154e+03
  1.26211386e+04  4.12184440e+04  1.05246718e+05  2.30419895e+05
  4.56227442e+05  8.45174083e+05  1.52834591e+06  2.85060661e+06
  5.80848530e+06]
E1 = -707.7409567443358  E_coul = 199.76905451801008
cycle= 1 E= -507.971902226326  delta_E= -3.35  |g|= 0.451  |ddm|= 0.461
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.740002
diis-c [-0.54760337  1.        ]
  HOMO = -0.217707233776575  LUMO = 0.209378541338756
  mo_energy =
[-1.20201687e+02 -1.23055129e+01 -6.59522609e+00 -6.59522609e+00
 -6.59522609e+00 -1.16331666e+00 -2.17707234e-01 -2.17707234e-01
 -2.17707234e-01  2.09378541e-01  1.53170927e+00  1.15208697e+01
  6.51097038e+01  2.59399590e+02  8.88256919e+02  3.14194237e+03
  1.26224627e+04  4.12197009e+04  1.05247938e+05  2.30421090e+05
  4.56228621e+05  8.45175248e+05  1.52834706e+06  2.85060775e+06
  5.80848644e+06]
E1 = -706.7955127384105  E_coul = 198.8060199975469
cycle= 2 E= -507.989492740864  delta_E= -0.0176  |g|= 0.0349  |ddm|= 0.414
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0414999
diis-c [-0.00170433 -0.00576028  1.00576028]
  HOMO = -0.239923547694712  LUMO = 0.209281495608814
  mo_energy =
[-1.20315760e+02 -1.23726771e+01 -6.66959573e+00 -6.66959573e+00
 -6.66959573e+00 -1.17764171e+00 -2.39923548e-01 -2.39923548e-01
 -2.39923548e-01  2.09281496e-01  1.52341183e+00  1.14741294e+01
  6.50276297e+01  2.59295446e+02  8.88137065e+02  3.14180832e+03
  1.26223185e+04  4.12195528e+04  1.05247788e+05  2.30420940e+05
  4.56228470e+05  8.45175097e+05  1.52834691e+06  2.85060760e+06
  5.80848628e+06]
E1 = -706.6846846019102  E_coul = 198.69491715648428
cycle= 3 E= -507.989767445426  delta_E= -0.000275  |g|= 0.0044  |ddm|= 0.0513
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00559023
diis-c [-5.02726224e-06 -3.73029055e-04 -1.39680818e-01  1.14005385e+00]
  HOMO = -0.243235683733806  LUMO = 0.20920797159939
  mo_energy =
[-1.20327771e+02 -1.23815178e+01 -6.67891343e+00 -6.67891343e+00
 -6.67891343e+00 -1.17965450e+00 -2.43235684e-01 -2.43235684e-01
 -2.43235684e-01  2.09207972e-01  1.52185941e+00  1.14674881e+01
  6.50177903e+01  2.59284078e+02  8.88124812e+02  3.14179539e+03
  1.26223051e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6680860320413  E_coul = 198.67831276292623
cycle= 4 E= -507.989773269115  delta_E= -5.82e-06  |g|= 0.000191  |ddm|= 0.00738
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000230296
diis-c [-4.38240150e-09 -1.42593472e-05  9.71364338e-03 -1.01724495e-01
  1.09202511e+00]
  HOMO = -0.243304355210143  LUMO = 0.209201950676476
  mo_energy =
[-1.20327761e+02 -1.23816177e+01 -6.67899139e+00 -6.67899139e+00
 -6.67899139e+00 -1.17969593e+00 -2.43304355e-01 -2.43304355e-01
 -2.43304355e-01  2.09201951e-01  1.52180608e+00  1.14673817e+01
  6.50177317e+01  2.59284067e+02  8.88124831e+02  3.14179543e+03
  1.26223052e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6677155221837  E_coul = 198.67794224019926
cycle= 5 E= -507.989773281984  delta_E= -1.29e-08  |g|= 1.39e-05  |ddm|= 0.000416
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=9.39175e-06
diis-c [-3.40074094e-12  1.32885611e-06 -1.23167157e-03  1.27353778e-02
 -1.55139738e-01  1.14363470e+00]
  HOMO = -0.24330258079863  LUMO = 0.209201844619495
  mo_energy =
[-1.20327752e+02 -1.23816098e+01 -6.67898330e+00 -6.67898330e+00
 -6.67898330e+00 -1.17969529e+00 -2.43302581e-01 -2.43302581e-01
 -2.43302581e-01  2.09201845e-01  1.52180574e+00  1.14673868e+01
  6.50177400e+01  2.59284076e+02  8.88124841e+02  3.14179544e+03
  1.26223052e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6677193152153  E_coul = 198.6779460331725
cycle= 6 E= -507.989773282043  delta_E= -5.84e-11  |g|= 1.39e-07  |ddm|= 4.43e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6677193152153  E_coul = 198.6779460331725
  HOMO = -0.243302554410556  LUMO = 0.209201831388906
  mo_energy =
[-1.20327751e+02 -1.23816097e+01 -6.67898319e+00 -6.67898319e+00
 -6.67898319e+00 -1.17969524e+00 -2.43302554e-01 -2.43302554e-01
 -2.43302554e-01  2.09201831e-01  1.52180572e+00  1.14673868e+01
  6.50177401e+01  2.59284076e+02  8.88124841e+02  3.14179544e+03
  1.26223052e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6677195016852  E_coul = 198.67794621964242
Extra cycle  E= -507.989773282043  delta_E= 1.14e-13  |g|= 1.74e-08  |ddm|= 3.63e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912138.4502126457
E1 = -706.6677195016852  E_coul = 198.67794621964242
init E= -507.989773282043
    CPU time for initialize scf      5.75 sec, wall time      0.24 sec
  HOMO = -0.24330255028026  LUMO = 0.209201832039277
  mo_energy =
[-1.20327751e+02 -1.23816097e+01 -6.67898318e+00 -6.67898318e+00
 -6.67898318e+00 -1.17969524e+00 -2.43302550e-01 -2.43302550e-01
 -2.43302550e-01  2.09201832e-01  1.52180572e+00  1.14673869e+01
  6.50177401e+01  2.59284076e+02  8.88124841e+02  3.14179544e+03
  1.26223052e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6677195141943  E_coul = 198.67794623215178
cycle= 1 E= -507.989773282043  delta_E= 1.71e-13  |g|= 2.36e-09  |ddm|= 5e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6677195141943  E_coul = 198.67794623215178
  HOMO = -0.24330255010864  LUMO = 0.209201830937676
  mo_energy =
[-1.20327751e+02 -1.23816097e+01 -6.67898318e+00 -6.67898318e+00
 -6.67898318e+00 -1.17969524e+00 -2.43302550e-01 -2.43302550e-01
 -2.43302550e-01  2.09201831e-01  1.52180572e+00  1.14673869e+01
  6.50177401e+01  2.59284076e+02  8.88124841e+02  3.14179544e+03
  1.26223052e+04  4.12195393e+04  1.05247775e+05  2.30420926e+05
  4.56228456e+05  8.45175083e+05  1.52834690e+06  2.85060759e+06
  5.80848627e+06]
E1 = -706.6677195207541  E_coul = 198.67794623871117
Extra cycle  E= -507.989773282043  delta_E= -3.41e-13  |g|= 2.16e-09  |ddm|= 4e-09
    CPU time for scf_cycle      6.27 sec, wall time      0.41 sec
exp = [7.62041464e-02 2.70358907e-01 6.61204489e-01 1.17616813e+05
 3.03965322e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232185e+03
 1.83757714e+04 1.44352610e+03 4.17362005e+02 1.47783957e+02
 5.84529769e+01 2.45576146e+01 7.57601364e+00 8.60448203e+00
 4.92725747e-01]
grad_E = [-2.06606106e-03 -1.95147714e-03 -2.18254415e-03  6.06876450e-09
 -1.19552215e-03  4.05127839e-11  1.74368498e-10  9.41299193e-10
  3.71917388e-09  1.55308577e-08  8.10031904e-08  5.10564083e-06
  1.98640073e-07 -3.86218467e-05 -4.87129451e-06 -1.42860757e-06
  1.43532830e-06  3.79589434e-07  1.91685141e-04  1.80762573e-04
 -1.92987350e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.137145740011       1
[INPUT] 0    0    [1    /1   ]  0.293133813623       1
[INPUT] 0    0    [1    /1   ]  0.680833309262       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.04891834226        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.417549         1
[INPUT] 0    0    [1    /1   ]  36754.7015393        1
[INPUT] 0    0    [1    /1   ]  7302.32177944        1
[INPUT] 0    0    [1    /1   ]  18375.7713511        1
[INPUT] 0    0    [1    /1   ]  1443.5266067         1
[INPUT] 0    0    [1    /1   ]  417.362070119        1
[INPUT] 0    0    [1    /1   ]  147.7839695          1
[INPUT] 0    0    [1    /1   ]  58.4529755353        1
[INPUT] 0    0    [1    /1   ]  24.5575858595        1
[INPUT] 0    0    [1    /1   ]  7.57427607871        1
[INPUT] 1    0    [1    /1   ]  8.60454982694        1
[INPUT] 1    0    [1    /1   ]  0.492794856696       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.13714574001089036, 1.0]], [0, [0.2931338136228691, 1.0]], [0, [0.6808333092621202, 1.0]], [0, [117616.81288974494, 1.0]], [0, [3.0489183422599253, 1.0]], [0, [1176168.1426134543, 1.0]], [0, [588084.0699565669, 1.0]], [0, [294042.03092147264, 1.0]], [0, [147020.9913234646, 1.0]], [0, [73510.41754900217, 1.0]], [0, [36754.70153934, 1.0]], [0, [7302.321779442041, 1.0]], [0, [18375.77135108305, 1.0]], [0, [1443.5266067014977, 1.0]], [0, [417.3620701191699, 1.0]], [0, [147.78396950002718, 1.0]], [0, [58.45297553525384, 1.0]], [0, [24.557585859491855, 1.0]], [0, [7.574276078706874, 1.0]], [1, [8.604549826939992, 1.0]], [1, [0.49279485669607986, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.13714574]
bas 1, expnt(s) = [0.29313381]
bas 2, expnt(s) = [0.68083331]
bas 3, expnt(s) = [117616.81288974]
bas 4, expnt(s) = [3.04891834]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092147]
bas 8, expnt(s) = [147020.99132346]
bas 9, expnt(s) = [73510.417549]
bas 10, expnt(s) = [36754.70153934]
bas 11, expnt(s) = [7302.32177944]
bas 12, expnt(s) = [18375.77135108]
bas 13, expnt(s) = [1443.5266067]
bas 14, expnt(s) = [417.36207012]
bas 15, expnt(s) = [147.7839695]
bas 16, expnt(s) = [58.45297554]
bas 17, expnt(s) = [24.55758586]
bas 18, expnt(s) = [7.57427608]
bas 19, expnt(s) = [8.60454983]
bas 20, expnt(s) = [0.49279486]
CPU time:       132.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.37145740e-01 5.69379420e-01 2.93133814e-01 1.00650158e+00
 6.80833309e-01 1.89363216e+00 1.17616813e+05 1.60460108e+04
 3.04891834e+00 5.82940688e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232178e+03 1.99577119e+03
 1.83757714e+04 3.98748634e+03 1.44352661e+03 5.91675544e+02
 4.17362070e+02 2.33291952e+02 1.47783970e+02 1.07086696e+02
 5.84529755e+01 5.34096820e+01 2.45575859e+01 2.78711108e+01
 7.57427608e+00 1.15350869e+01 8.60454983e+00 4.29926866e+01
 4.92794857e-01 1.20452856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336121850597067
cond(S) = 912157.9030355732
E1 = -689.5994644436702  E_coul = 184.97646818313348
init E= -504.622996260537
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.671997098999721  LUMO = 0.126135372056698
  mo_energy =
[-1.21709247e+02 -1.33855844e+01 -7.62326329e+00 -7.62326329e+00
 -7.62326329e+00 -1.65735732e+00 -6.71997099e-01 -6.71997099e-01
 -6.71997099e-01  1.26135372e-01  1.50843970e+00  1.11842347e+01
  6.43134892e+01  2.58352577e+02  8.87126248e+02  3.14083267e+03
  1.26214221e+04  4.12187068e+04  1.05246970e+05  2.30420140e+05
  4.56227682e+05  8.45174319e+05  1.52834614e+06  2.85060684e+06
  5.80848552e+06]
E1 = -707.7478372839205  E_coul = 199.77585647415737
cycle= 1 E= -507.971980809763  delta_E= -3.35  |g|= 0.451  |ddm|= 0.433
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.742844
diis-c [-0.55181649  1.        ]
  HOMO = -0.217505938221592  LUMO = 0.359116727869381
  mo_energy =
[-1.20201047e+02 -1.23050039e+01 -6.59473802e+00 -6.59473802e+00
 -6.59473802e+00 -1.16320043e+00 -2.17505938e-01 -2.17505938e-01
 -2.17505938e-01  3.59116728e-01  1.92224808e+00  1.20459025e+01
  6.55807913e+01  2.59807871e+02  8.88617634e+02  3.14226364e+03
  1.26227464e+04  4.12199638e+04  1.05248190e+05  2.30421335e+05
  4.56228861e+05  8.45175484e+05  1.52834730e+06  2.85060798e+06
  5.80848666e+06]
E1 = -706.800255149501  E_coul = 198.8106263641439
cycle= 2 E= -507.989628785357  delta_E= -0.0176  |g|= 0.035  |ddm|= 0.386
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0406827
diis-c [-0.00163583 -0.00595098  1.00595098]
  HOMO = -0.239756885580368  LUMO = 0.358714296517146
  mo_energy =
[-1.20315396e+02 -1.23723536e+01 -6.66931126e+00 -6.66931126e+00
 -6.66931126e+00 -1.17754559e+00 -2.39756886e-01 -2.39756886e-01
 -2.39756886e-01  3.58714297e-01  1.91205739e+00  1.19987060e+01
  6.54985403e+01  2.59703486e+02  8.88497500e+02  3.14212929e+03
  1.26226019e+04  4.12198155e+04  1.05248040e+05  2.30421184e+05
  4.56228709e+05  8.45175333e+05  1.52834714e+06  2.85060783e+06
  5.80848650e+06]
E1 = -706.6893420255312  E_coul = 198.69943787523198
cycle= 3 E= -507.989904150299  delta_E= -0.000275  |g|= 0.00442  |ddm|= 0.0458
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00519615
diis-c [-4.24071114e-06 -3.24164083e-04 -1.31846398e-01  1.13217056e+00]
  HOMO = -0.243048619776995  LUMO = 0.358552833028328
  mo_energy =
[-1.20327293e+02 -1.23811176e+01 -6.67854637e+00 -6.67854637e+00
 -6.67854637e+00 -1.17954805e+00 -2.43048620e-01 -2.43048620e-01
 -2.43048620e-01  3.58552833e-01  1.91023144e+00  1.19920947e+01
  6.54887944e+01  2.59692227e+02  8.88485367e+02  3.14211648e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6728205905359  E_coul = 198.68291049895367
cycle= 4 E= -507.989910091582  delta_E= -5.94e-06  |g|= 0.000224  |ddm|= 0.00815
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000205275
diis-c [-2.70739209e-09 -1.17307572e-05  8.89434571e-03 -9.84619135e-02
  1.08957930e+00]
  HOMO = -0.243143216132322  LUMO = 0.358540726160824
  mo_energy =
[-1.20327367e+02 -1.23812798e+01 -6.67868983e+00 -6.67868983e+00
 -6.67868983e+00 -1.17960593e+00 -2.43143216e-01 -2.43143216e-01
 -2.43143216e-01  3.58540726e-01  1.91015665e+00  1.19919406e+01
  6.54886667e+01  2.59692136e+02  8.88485300e+02  3.14211643e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6723175411798  E_coul = 198.68240743261634
cycle= 5 E= -507.989910108563  delta_E= -1.7e-08  |g|= 1.52e-05  |ddm|= 0.000844
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.86428e-06
diis-c [-2.97536923e-12  1.24436085e-06 -1.13768225e-03  1.22005516e-02
 -1.53595559e-01  1.14253145e+00]
  HOMO = -0.243144952703318  LUMO = 0.358540312636244
  mo_energy =
[-1.20327366e+02 -1.23812799e+01 -6.67868988e+00 -6.67868988e+00
 -6.67868988e+00 -1.17960747e+00 -2.43144953e-01 -2.43144953e-01
 -2.43144953e-01  3.58540313e-01  1.91015422e+00  1.19919393e+01
  6.54886667e+01  2.59692136e+02  8.88485300e+02  3.14211643e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6723037093623  E_coul = 198.6823936007293
cycle= 6 E= -507.989910108633  delta_E= -6.95e-11  |g|= 1.28e-07  |ddm|= 7.36e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6723037093623  E_coul = 198.6823936007293
  HOMO = -0.243144963767538  LUMO = 0.358540292953317
  mo_energy =
[-1.20327366e+02 -1.23812799e+01 -6.67868986e+00 -6.67868986e+00
 -6.67868986e+00 -1.17960745e+00 -2.43144964e-01 -2.43144964e-01
 -2.43144964e-01  3.58540293e-01  1.91015418e+00  1.19919393e+01
  6.54886667e+01  2.59692136e+02  8.88485301e+02  3.14211644e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6723037038109  E_coul = 198.68239359517761
Extra cycle  E= -507.989910108633  delta_E= -3.98e-13  |g|= 1.72e-08  |ddm|= 4.94e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
exp = [1.37145740e-01 2.93133814e-01 6.80833309e-01 1.17616813e+05
 3.04891834e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232178e+03
 1.83757714e+04 1.44352661e+03 4.17362070e+02 1.47783970e+02
 5.84529755e+01 2.45575859e+01 7.57427608e+00 8.60454983e+00
 4.92794857e-01]
E = -507.98991010863335
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.137145740011       1
[INPUT] 0    0    [1    /1   ]  0.293133813623       1
[INPUT] 0    0    [1    /1   ]  0.680833309262       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.04891834226        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.417549         1
[INPUT] 0    0    [1    /1   ]  36754.7015393        1
[INPUT] 0    0    [1    /1   ]  7302.32177944        1
[INPUT] 0    0    [1    /1   ]  18375.7713511        1
[INPUT] 0    0    [1    /1   ]  1443.5266067         1
[INPUT] 0    0    [1    /1   ]  417.362070119        1
[INPUT] 0    0    [1    /1   ]  147.7839695          1
[INPUT] 0    0    [1    /1   ]  58.4529755353        1
[INPUT] 0    0    [1    /1   ]  24.5575858595        1
[INPUT] 0    0    [1    /1   ]  7.57427607871        1
[INPUT] 1    0    [1    /1   ]  8.60454982694        1
[INPUT] 1    0    [1    /1   ]  0.492794856696       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.13714574001089036, 1.0]], [0, [0.2931338136228691, 1.0]], [0, [0.6808333092621202, 1.0]], [0, [117616.81288974494, 1.0]], [0, [3.0489183422599253, 1.0]], [0, [1176168.1426134543, 1.0]], [0, [588084.0699565669, 1.0]], [0, [294042.03092147264, 1.0]], [0, [147020.9913234646, 1.0]], [0, [73510.41754900217, 1.0]], [0, [36754.70153934, 1.0]], [0, [7302.321779442041, 1.0]], [0, [18375.77135108305, 1.0]], [0, [1443.5266067014977, 1.0]], [0, [417.3620701191699, 1.0]], [0, [147.78396950002718, 1.0]], [0, [58.45297553525384, 1.0]], [0, [24.557585859491855, 1.0]], [0, [7.574276078706874, 1.0]], [1, [8.604549826939992, 1.0]], [1, [0.49279485669607986, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.13714574]
bas 1, expnt(s) = [0.29313381]
bas 2, expnt(s) = [0.68083331]
bas 3, expnt(s) = [117616.81288974]
bas 4, expnt(s) = [3.04891834]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092147]
bas 8, expnt(s) = [147020.99132346]
bas 9, expnt(s) = [73510.417549]
bas 10, expnt(s) = [36754.70153934]
bas 11, expnt(s) = [7302.32177944]
bas 12, expnt(s) = [18375.77135108]
bas 13, expnt(s) = [1443.5266067]
bas 14, expnt(s) = [417.36207012]
bas 15, expnt(s) = [147.7839695]
bas 16, expnt(s) = [58.45297554]
bas 17, expnt(s) = [24.55758586]
bas 18, expnt(s) = [7.57427608]
bas 19, expnt(s) = [8.60454983]
bas 20, expnt(s) = [0.49279486]
CPU time:       134.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.37145740e-01 5.69379420e-01 2.93133814e-01 1.00650158e+00
 6.80833309e-01 1.89363216e+00 1.17616813e+05 1.60460108e+04
 3.04891834e+00 5.82940688e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232178e+03 1.99577119e+03
 1.83757714e+04 3.98748634e+03 1.44352661e+03 5.91675544e+02
 4.17362070e+02 2.33291952e+02 1.47783970e+02 1.07086696e+02
 5.84529755e+01 5.34096820e+01 2.45575859e+01 2.78711108e+01
 7.57427608e+00 1.15350869e+01 8.60454983e+00 4.29926866e+01
 4.92794857e-01 1.20452856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336121850597067
cond(S) = 912157.9030355732
E1 = -689.5994644436702  E_coul = 184.97646818313348
init E= -504.622996260537
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.671997098999721  LUMO = 0.126135372056698
  mo_energy =
[-1.21709247e+02 -1.33855844e+01 -7.62326329e+00 -7.62326329e+00
 -7.62326329e+00 -1.65735732e+00 -6.71997099e-01 -6.71997099e-01
 -6.71997099e-01  1.26135372e-01  1.50843970e+00  1.11842347e+01
  6.43134892e+01  2.58352577e+02  8.87126248e+02  3.14083267e+03
  1.26214221e+04  4.12187068e+04  1.05246970e+05  2.30420140e+05
  4.56227682e+05  8.45174319e+05  1.52834614e+06  2.85060684e+06
  5.80848552e+06]
E1 = -707.7478372839205  E_coul = 199.77585647415737
cycle= 1 E= -507.971980809763  delta_E= -3.35  |g|= 0.451  |ddm|= 0.433
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.742844
diis-c [-0.55181649  1.        ]
  HOMO = -0.217505938221592  LUMO = 0.359116727869381
  mo_energy =
[-1.20201047e+02 -1.23050039e+01 -6.59473802e+00 -6.59473802e+00
 -6.59473802e+00 -1.16320043e+00 -2.17505938e-01 -2.17505938e-01
 -2.17505938e-01  3.59116728e-01  1.92224808e+00  1.20459025e+01
  6.55807913e+01  2.59807871e+02  8.88617634e+02  3.14226364e+03
  1.26227464e+04  4.12199638e+04  1.05248190e+05  2.30421335e+05
  4.56228861e+05  8.45175484e+05  1.52834730e+06  2.85060798e+06
  5.80848666e+06]
E1 = -706.800255149501  E_coul = 198.8106263641439
cycle= 2 E= -507.989628785357  delta_E= -0.0176  |g|= 0.035  |ddm|= 0.386
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0406827
diis-c [-0.00163583 -0.00595098  1.00595098]
  HOMO = -0.239756885580368  LUMO = 0.358714296517146
  mo_energy =
[-1.20315396e+02 -1.23723536e+01 -6.66931126e+00 -6.66931126e+00
 -6.66931126e+00 -1.17754559e+00 -2.39756886e-01 -2.39756886e-01
 -2.39756886e-01  3.58714297e-01  1.91205739e+00  1.19987060e+01
  6.54985403e+01  2.59703486e+02  8.88497500e+02  3.14212929e+03
  1.26226019e+04  4.12198155e+04  1.05248040e+05  2.30421184e+05
  4.56228709e+05  8.45175333e+05  1.52834714e+06  2.85060783e+06
  5.80848650e+06]
E1 = -706.6893420255312  E_coul = 198.69943787523198
cycle= 3 E= -507.989904150299  delta_E= -0.000275  |g|= 0.00442  |ddm|= 0.0458
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00519615
diis-c [-4.24071114e-06 -3.24164083e-04 -1.31846398e-01  1.13217056e+00]
  HOMO = -0.243048619776995  LUMO = 0.358552833028328
  mo_energy =
[-1.20327293e+02 -1.23811176e+01 -6.67854637e+00 -6.67854637e+00
 -6.67854637e+00 -1.17954805e+00 -2.43048620e-01 -2.43048620e-01
 -2.43048620e-01  3.58552833e-01  1.91023144e+00  1.19920947e+01
  6.54887944e+01  2.59692227e+02  8.88485367e+02  3.14211648e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6728205905359  E_coul = 198.68291049895367
cycle= 4 E= -507.989910091582  delta_E= -5.94e-06  |g|= 0.000224  |ddm|= 0.00815
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000205275
diis-c [-2.70739209e-09 -1.17307572e-05  8.89434571e-03 -9.84619135e-02
  1.08957930e+00]
  HOMO = -0.243143216132322  LUMO = 0.358540726160824
  mo_energy =
[-1.20327367e+02 -1.23812798e+01 -6.67868983e+00 -6.67868983e+00
 -6.67868983e+00 -1.17960593e+00 -2.43143216e-01 -2.43143216e-01
 -2.43143216e-01  3.58540726e-01  1.91015665e+00  1.19919406e+01
  6.54886667e+01  2.59692136e+02  8.88485300e+02  3.14211643e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6723175411798  E_coul = 198.68240743261634
cycle= 5 E= -507.989910108563  delta_E= -1.7e-08  |g|= 1.52e-05  |ddm|= 0.000844
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.86428e-06
diis-c [-2.97536923e-12  1.24436085e-06 -1.13768225e-03  1.22005516e-02
 -1.53595559e-01  1.14253145e+00]
  HOMO = -0.243144952703318  LUMO = 0.358540312636244
  mo_energy =
[-1.20327366e+02 -1.23812799e+01 -6.67868988e+00 -6.67868988e+00
 -6.67868988e+00 -1.17960747e+00 -2.43144953e-01 -2.43144953e-01
 -2.43144953e-01  3.58540313e-01  1.91015422e+00  1.19919393e+01
  6.54886667e+01  2.59692136e+02  8.88485300e+02  3.14211643e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6723037093623  E_coul = 198.6823936007293
cycle= 6 E= -507.989910108633  delta_E= -6.95e-11  |g|= 1.28e-07  |ddm|= 7.36e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6723037093623  E_coul = 198.6823936007293
  HOMO = -0.243144963767538  LUMO = 0.358540292953317
  mo_energy =
[-1.20327366e+02 -1.23812799e+01 -6.67868986e+00 -6.67868986e+00
 -6.67868986e+00 -1.17960745e+00 -2.43144964e-01 -2.43144964e-01
 -2.43144964e-01  3.58540293e-01  1.91015418e+00  1.19919393e+01
  6.54886667e+01  2.59692136e+02  8.88485301e+02  3.14211644e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6723037038109  E_coul = 198.68239359517761
Extra cycle  E= -507.989910108633  delta_E= -3.98e-13  |g|= 1.72e-08  |ddm|= 4.94e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912157.9030355732
E1 = -706.6723037038109  E_coul = 198.68239359517761
init E= -507.989910108633
    CPU time for initialize scf      5.86 sec, wall time      0.25 sec
  HOMO = -0.243144965477881  LUMO = 0.358540292397972
  mo_energy =
[-1.20327366e+02 -1.23812799e+01 -6.67868986e+00 -6.67868986e+00
 -6.67868986e+00 -1.17960745e+00 -2.43144965e-01 -2.43144965e-01
 -2.43144965e-01  3.58540292e-01  1.91015418e+00  1.19919393e+01
  6.54886667e+01  2.59692136e+02  8.88485301e+02  3.14211644e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6723036895347  E_coul = 198.68239358090153
cycle= 1 E= -507.989910108633  delta_E= 1.71e-13  |g|= 2.85e-09  |ddm|= 7.14e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6723036895347  E_coul = 198.68239358090153
  HOMO = -0.243144966108736  LUMO = 0.358540292552121
  mo_energy =
[-1.20327366e+02 -1.23812799e+01 -6.67868986e+00 -6.67868986e+00
 -6.67868986e+00 -1.17960745e+00 -2.43144966e-01 -2.43144966e-01
 -2.43144966e-01  3.58540293e-01  1.91015418e+00  1.19919393e+01
  6.54886667e+01  2.59692136e+02  8.88485301e+02  3.14211644e+03
  1.26225886e+04  4.12198020e+04  1.05248027e+05  2.30421171e+05
  4.56228696e+05  8.45175319e+05  1.52834713e+06  2.85060782e+06
  5.80848649e+06]
E1 = -706.6723036879691  E_coul = 198.68239357933604
Extra cycle  E= -507.989910108633  delta_E= 5.68e-14  |g|= 1.86e-09  |ddm|= 1.18e-08
    CPU time for scf_cycle      6.37 sec, wall time      0.41 sec
exp = [1.37145740e-01 2.93133814e-01 6.80833309e-01 1.17616813e+05
 3.04891834e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232178e+03
 1.83757714e+04 1.44352661e+03 4.17362070e+02 1.47783970e+02
 5.84529755e+01 2.45575859e+01 7.57427608e+00 8.60454983e+00
 4.92794857e-01]
grad_E = [ 1.39893641e-03 -4.72128856e-03 -4.44397190e-04  6.06958642e-09
 -1.34079999e-03  4.05220185e-11  1.74395482e-10  9.41425201e-10
  3.71968300e-09  1.55330122e-08  8.10135848e-08  5.10631545e-06
  1.98674139e-07 -3.86529187e-05 -4.55909692e-06 -3.13144537e-06
  7.84408533e-06 -9.20184542e-06  1.48075932e-04  1.54385278e-04
  9.60040267e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.153309157708       1
[INPUT] 0    0    [1    /1   ]  0.301569472407       1
[INPUT] 0    0    [1    /1   ]  0.68754814794        1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.05300062767        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175489        1
[INPUT] 0    0    [1    /1   ]  36754.701539         1
[INPUT] 0    0    [1    /1   ]  7302.3217553         1
[INPUT] 0    0    [1    /1   ]  18375.7713501        1
[INPUT] 0    0    [1    /1   ]  1443.52678936        1
[INPUT] 0    0    [1    /1   ]  417.362093119        1
[INPUT] 0    0    [1    /1   ]  147.783976519        1
[INPUT] 0    0    [1    /1   ]  58.4529664459        1
[INPUT] 0    0    [1    /1   ]  24.5575880487        1
[INPUT] 0    0    [1    /1   ]  7.57362794247        1
[INPUT] 1    0    [1    /1   ]  8.60440599809        1
[INPUT] 1    0    [1    /1   ]  0.492749297712       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.15330915770805503, 1.0]], [0, [0.30156947240686655, 1.0]], [0, [0.6875481479396229, 1.0]], [0, [117616.81288971624, 1.0]], [0, [3.0530006276679753, 1.0]], [0, [1176168.142613454, 1.0]], [0, [588084.0699565661, 1.0]], [0, [294042.0309214682, 1.0]], [0, [147020.99132344703, 1.0]], [0, [73510.41754892872, 1.0]], [0, [36754.701538956906, 1.0]], [0, [7302.3217552954475, 1.0]], [0, [18375.7713501436, 1.0]], [0, [1443.526789361842, 1.0]], [0, [417.36209311900643, 1.0]], [0, [147.78397651905547, 1.0]], [0, [58.45296644590417, 1.0]], [0, [24.55758804869392, 1.0]], [0, [7.5736279424714, 1.0]], [1, [8.604405998086436, 1.0]], [1, [0.4927492977116606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.15330916]
bas 1, expnt(s) = [0.30156947]
bas 2, expnt(s) = [0.68754815]
bas 3, expnt(s) = [117616.81288972]
bas 4, expnt(s) = [3.05300063]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092147]
bas 8, expnt(s) = [147020.99132345]
bas 9, expnt(s) = [73510.41754893]
bas 10, expnt(s) = [36754.70153896]
bas 11, expnt(s) = [7302.3217553]
bas 12, expnt(s) = [18375.77135014]
bas 13, expnt(s) = [1443.52678936]
bas 14, expnt(s) = [417.36209312]
bas 15, expnt(s) = [147.78397652]
bas 16, expnt(s) = [58.45296645]
bas 17, expnt(s) = [24.55758805]
bas 18, expnt(s) = [7.57362794]
bas 19, expnt(s) = [8.604406]
bas 20, expnt(s) = [0.4927493]
CPU time:       149.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.53309158e-01 6.19000639e-01 3.01569472e-01 1.02814781e+00
 6.87548148e-01 1.90762217e+00 1.17616813e+05 1.60460108e+04
 3.05300063e+00 5.83525977e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232176e+03 1.99577118e+03
 1.83757714e+04 3.98748634e+03 1.44352679e+03 5.91675601e+02
 4.17362093e+02 2.33291962e+02 1.47783977e+02 1.07086700e+02
 5.84529664e+01 5.34096758e+01 2.45575880e+01 2.78711126e+01
 7.57362794e+00 1.15343466e+01 8.60440600e+00 4.29917883e+01
 4.92749298e-01 1.20438936e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33617402719811
cond(S) = 912164.0341593823
E1 = -689.5978559935822  E_coul = 184.97500402724583
init E= -504.622851966336
    CPU time for initialize scf      7.58 sec, wall time      0.37 sec
  HOMO = -0.672028497378408  LUMO = 0.156401432952006
  mo_energy =
[-1.21709459e+02 -1.33857111e+01 -7.62334597e+00 -7.62334597e+00
 -7.62334597e+00 -1.65741192e+00 -6.72028497e-01 -6.72028497e-01
 -6.72028497e-01  1.56401433e-01  1.61254428e+00  1.13462560e+01
  6.44635540e+01  2.58483088e+02  8.87241570e+02  3.14093538e+03
  1.26215128e+04  4.12187908e+04  1.05247051e+05  2.30420218e+05
  4.56227759e+05  8.45174395e+05  1.52834622e+06  2.85060691e+06
  5.80848559e+06]
E1 = -707.7460939801149  E_coul = 199.77409748717753
cycle= 1 E= -507.971996492937  delta_E= -3.35  |g|= 0.451  |ddm|= 0.436
    CPU time for cycle= 1      0.58 sec, wall time      0.03 sec
diis-norm(errvec)=0.741193
diis-c [-0.54936662  1.        ]
  HOMO = -0.217591193958083  LUMO = 0.397534841397317
  mo_energy =
[-1.20201244e+02 -1.23051377e+01 -6.59481629e+00 -6.59481629e+00
 -6.59481629e+00 -1.16326965e+00 -2.17591194e-01 -2.17591194e-01
 -2.17591194e-01  3.97534841e-01  2.03194348e+00  1.22075826e+01
  6.57305321e+01  2.59938308e+02  8.88732954e+02  3.14236637e+03
  1.26228371e+04  4.12200479e+04  1.05248271e+05  2.30421414e+05
  4.56228937e+05  8.45175560e+05  1.52834737e+06  2.85060805e+06
  5.80848673e+06]
E1 = -706.7984799271087  E_coul = 198.8088319112568
cycle= 2 E= -507.989648015852  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.376
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.039911
diis-c [-0.00157654 -0.00549218  1.00549218]
  HOMO = -0.239816925449981  LUMO = 0.397027427763511
  mo_energy =
[-1.20315565e+02 -1.23724660e+01 -6.66936852e+00 -6.66936852e+00
 -6.66936852e+00 -1.17759735e+00 -2.39816925e-01 -2.39816925e-01
 -2.39816925e-01  3.97027428e-01  2.02124430e+00  1.21603026e+01
  6.56483157e+01  2.59833955e+02  8.88612853e+02  3.14223205e+03
  1.26226926e+04  4.12198996e+04  1.05248121e+05  2.30421263e+05
  4.56228786e+05  8.45175408e+05  1.52834722e+06  2.85060790e+06
  5.80848658e+06]
E1 = -706.6878545100008  E_coul = 198.69793223185337
cycle= 3 E= -507.989922278147  delta_E= -0.000274  |g|= 0.00443  |ddm|= 0.046
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00502135
diis-c [-3.98357267e-06 -3.11195940e-04 -1.29589103e-01  1.12990030e+00]
  HOMO = -0.243100705595694  LUMO = 0.396840919706171
  mo_energy =
[-1.20327459e+02 -1.23812179e+01 -6.67859327e+00 -6.67859327e+00
 -6.67859327e+00 -1.17959546e+00 -2.43100706e-01 -2.43100706e-01
 -2.43100706e-01  3.96840920e-01  2.01934814e+00  1.21536956e+01
  6.56385801e+01  2.59822701e+02  8.88600721e+02  3.14221924e+03
  1.26226794e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228773e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.6714008354838  E_coul = 198.68147263901236
cycle= 4 E= -507.989928196472  delta_E= -5.92e-06  |g|= 0.000229  |ddm|= 0.00899
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00019724
diis-c [-2.32553863e-09 -1.10036749e-05  8.70335035e-03 -9.78478068e-02
  1.08915546e+00]
  HOMO = -0.24320180515339  LUMO = 0.396827149686833
  mo_energy =
[-1.20327558e+02 -1.23813977e+01 -6.67875545e+00 -6.67875545e+00
 -6.67875545e+00 -1.17965738e+00 -2.43201805e-01 -2.43201805e-01
 -2.43201805e-01  3.96827150e-01  2.01926773e+00  1.21535286e+01
  6.56384325e+01  2.59822587e+02  8.88600628e+02  3.14221916e+03
  1.26226793e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228772e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.6708678836685  E_coul = 198.68093966973578
cycle= 5 E= -507.989928213933  delta_E= -1.75e-08  |g|= 1.52e-05  |ddm|= 0.000964
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.33481e-06
diis-c [-2.84006979e-12  1.21045323e-06 -1.11188461e-03  1.20773623e-02
 -1.52411044e-01  1.14144436e+00]
  HOMO = -0.243204232271036  LUMO = 0.396826646638821
  mo_energy =
[-1.20327559e+02 -1.23813996e+01 -6.67875724e+00 -6.67875724e+00
 -6.67875724e+00 -1.17965934e+00 -2.43204232e-01 -2.43204232e-01
 -2.43204232e-01  3.96826647e-01  2.01926488e+00  1.21535259e+01
  6.56384307e+01  2.59822585e+02  8.88600627e+02  3.14221916e+03
  1.26226793e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228772e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.670850923406  E_coul = 198.68092270940411
cycle= 6 E= -507.989928214002  delta_E= -6.91e-11  |g|= 1.26e-07  |ddm|= 8.09e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.670850923406  E_coul = 198.68092270940411
  HOMO = -0.243204250490855  LUMO = 0.396826626870822
  mo_energy =
[-1.20327559e+02 -1.23813996e+01 -6.67875725e+00 -6.67875725e+00
 -6.67875725e+00 -1.17965932e+00 -2.43204250e-01 -2.43204250e-01
 -2.43204250e-01  3.96826627e-01  2.01926484e+00  1.21535259e+01
  6.56384307e+01  2.59822585e+02  8.88600627e+02  3.14221916e+03
  1.26226793e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228772e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.670850875372  E_coul = 198.68092266137057
Extra cycle  E= -507.989928214001  delta_E= 3.98e-13  |g|= 1.76e-08  |ddm|= 5.37e-07
    CPU time for scf_cycle      8.39 sec, wall time      0.59 sec
exp = [1.53309158e-01 3.01569472e-01 6.87548148e-01 1.17616813e+05
 3.05300063e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232176e+03
 1.83757714e+04 1.44352679e+03 4.17362093e+02 1.47783977e+02
 5.84529664e+01 2.45575880e+01 7.57362794e+00 8.60440600e+00
 4.92749298e-01]
E = -507.98992821400145
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:27:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.153309157708       1
[INPUT] 0    0    [1    /1   ]  0.301569472407       1
[INPUT] 0    0    [1    /1   ]  0.68754814794        1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.05300062767        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175489        1
[INPUT] 0    0    [1    /1   ]  36754.701539         1
[INPUT] 0    0    [1    /1   ]  7302.3217553         1
[INPUT] 0    0    [1    /1   ]  18375.7713501        1
[INPUT] 0    0    [1    /1   ]  1443.52678936        1
[INPUT] 0    0    [1    /1   ]  417.362093119        1
[INPUT] 0    0    [1    /1   ]  147.783976519        1
[INPUT] 0    0    [1    /1   ]  58.4529664459        1
[INPUT] 0    0    [1    /1   ]  24.5575880487        1
[INPUT] 0    0    [1    /1   ]  7.57362794247        1
[INPUT] 1    0    [1    /1   ]  8.60440599809        1
[INPUT] 1    0    [1    /1   ]  0.492749297712       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.15330915770805503, 1.0]], [0, [0.30156947240686655, 1.0]], [0, [0.6875481479396229, 1.0]], [0, [117616.81288971624, 1.0]], [0, [3.0530006276679753, 1.0]], [0, [1176168.142613454, 1.0]], [0, [588084.0699565661, 1.0]], [0, [294042.0309214682, 1.0]], [0, [147020.99132344703, 1.0]], [0, [73510.41754892872, 1.0]], [0, [36754.701538956906, 1.0]], [0, [7302.3217552954475, 1.0]], [0, [18375.7713501436, 1.0]], [0, [1443.526789361842, 1.0]], [0, [417.36209311900643, 1.0]], [0, [147.78397651905547, 1.0]], [0, [58.45296644590417, 1.0]], [0, [24.55758804869392, 1.0]], [0, [7.5736279424714, 1.0]], [1, [8.604405998086436, 1.0]], [1, [0.4927492977116606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.15330916]
bas 1, expnt(s) = [0.30156947]
bas 2, expnt(s) = [0.68754815]
bas 3, expnt(s) = [117616.81288972]
bas 4, expnt(s) = [3.05300063]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092147]
bas 8, expnt(s) = [147020.99132345]
bas 9, expnt(s) = [73510.41754893]
bas 10, expnt(s) = [36754.70153896]
bas 11, expnt(s) = [7302.3217553]
bas 12, expnt(s) = [18375.77135014]
bas 13, expnt(s) = [1443.52678936]
bas 14, expnt(s) = [417.36209312]
bas 15, expnt(s) = [147.78397652]
bas 16, expnt(s) = [58.45296645]
bas 17, expnt(s) = [24.55758805]
bas 18, expnt(s) = [7.57362794]
bas 19, expnt(s) = [8.604406]
bas 20, expnt(s) = [0.4927493]
CPU time:       157.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.53309158e-01 6.19000639e-01 3.01569472e-01 1.02814781e+00
 6.87548148e-01 1.90762217e+00 1.17616813e+05 1.60460108e+04
 3.05300063e+00 5.83525977e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232176e+03 1.99577118e+03
 1.83757714e+04 3.98748634e+03 1.44352679e+03 5.91675601e+02
 4.17362093e+02 2.33291962e+02 1.47783977e+02 1.07086700e+02
 5.84529664e+01 5.34096758e+01 2.45575880e+01 2.78711126e+01
 7.57362794e+00 1.15343466e+01 8.60440600e+00 4.29917883e+01
 4.92749298e-01 1.20438936e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33617402719811
cond(S) = 912164.0341593823
E1 = -689.5978559935822  E_coul = 184.97500402724583
init E= -504.622851966336
    CPU time for initialize scf      7.67 sec, wall time      0.37 sec
  HOMO = -0.672028497378408  LUMO = 0.156401432952006
  mo_energy =
[-1.21709459e+02 -1.33857111e+01 -7.62334597e+00 -7.62334597e+00
 -7.62334597e+00 -1.65741192e+00 -6.72028497e-01 -6.72028497e-01
 -6.72028497e-01  1.56401433e-01  1.61254428e+00  1.13462560e+01
  6.44635540e+01  2.58483088e+02  8.87241570e+02  3.14093538e+03
  1.26215128e+04  4.12187908e+04  1.05247051e+05  2.30420218e+05
  4.56227759e+05  8.45174395e+05  1.52834622e+06  2.85060691e+06
  5.80848559e+06]
E1 = -707.7460939801149  E_coul = 199.77409748717753
cycle= 1 E= -507.971996492937  delta_E= -3.35  |g|= 0.451  |ddm|= 0.436
    CPU time for cycle= 1      0.57 sec, wall time      0.03 sec
diis-norm(errvec)=0.741193
diis-c [-0.54936662  1.        ]
  HOMO = -0.217591193958083  LUMO = 0.397534841397317
  mo_energy =
[-1.20201244e+02 -1.23051377e+01 -6.59481629e+00 -6.59481629e+00
 -6.59481629e+00 -1.16326965e+00 -2.17591194e-01 -2.17591194e-01
 -2.17591194e-01  3.97534841e-01  2.03194348e+00  1.22075826e+01
  6.57305321e+01  2.59938308e+02  8.88732954e+02  3.14236637e+03
  1.26228371e+04  4.12200479e+04  1.05248271e+05  2.30421414e+05
  4.56228937e+05  8.45175560e+05  1.52834737e+06  2.85060805e+06
  5.80848673e+06]
E1 = -706.7984799271087  E_coul = 198.8088319112568
cycle= 2 E= -507.989648015852  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.376
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.039911
diis-c [-0.00157654 -0.00549218  1.00549218]
  HOMO = -0.239816925449981  LUMO = 0.397027427763511
  mo_energy =
[-1.20315565e+02 -1.23724660e+01 -6.66936852e+00 -6.66936852e+00
 -6.66936852e+00 -1.17759735e+00 -2.39816925e-01 -2.39816925e-01
 -2.39816925e-01  3.97027428e-01  2.02124430e+00  1.21603026e+01
  6.56483157e+01  2.59833955e+02  8.88612853e+02  3.14223205e+03
  1.26226926e+04  4.12198996e+04  1.05248121e+05  2.30421263e+05
  4.56228786e+05  8.45175408e+05  1.52834722e+06  2.85060790e+06
  5.80848658e+06]
E1 = -706.6878545100008  E_coul = 198.69793223185337
cycle= 3 E= -507.989922278147  delta_E= -0.000274  |g|= 0.00443  |ddm|= 0.046
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00502135
diis-c [-3.98357267e-06 -3.11195940e-04 -1.29589103e-01  1.12990030e+00]
  HOMO = -0.243100705595694  LUMO = 0.396840919706171
  mo_energy =
[-1.20327459e+02 -1.23812179e+01 -6.67859327e+00 -6.67859327e+00
 -6.67859327e+00 -1.17959546e+00 -2.43100706e-01 -2.43100706e-01
 -2.43100706e-01  3.96840920e-01  2.01934814e+00  1.21536956e+01
  6.56385801e+01  2.59822701e+02  8.88600721e+02  3.14221924e+03
  1.26226794e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228773e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.6714008354838  E_coul = 198.68147263901236
cycle= 4 E= -507.989928196472  delta_E= -5.92e-06  |g|= 0.000229  |ddm|= 0.00899
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00019724
diis-c [-2.32553863e-09 -1.10036749e-05  8.70335035e-03 -9.78478068e-02
  1.08915546e+00]
  HOMO = -0.24320180515339  LUMO = 0.396827149686833
  mo_energy =
[-1.20327558e+02 -1.23813977e+01 -6.67875545e+00 -6.67875545e+00
 -6.67875545e+00 -1.17965738e+00 -2.43201805e-01 -2.43201805e-01
 -2.43201805e-01  3.96827150e-01  2.01926773e+00  1.21535286e+01
  6.56384325e+01  2.59822587e+02  8.88600628e+02  3.14221916e+03
  1.26226793e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228772e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.6708678836685  E_coul = 198.68093966973578
cycle= 5 E= -507.989928213933  delta_E= -1.75e-08  |g|= 1.52e-05  |ddm|= 0.000964
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.33481e-06
diis-c [-2.84006979e-12  1.21045323e-06 -1.11188461e-03  1.20773623e-02
 -1.52411044e-01  1.14144436e+00]
  HOMO = -0.243204232271036  LUMO = 0.396826646638821
  mo_energy =
[-1.20327559e+02 -1.23813996e+01 -6.67875724e+00 -6.67875724e+00
 -6.67875724e+00 -1.17965934e+00 -2.43204232e-01 -2.43204232e-01
 -2.43204232e-01  3.96826647e-01  2.01926488e+00  1.21535259e+01
  6.56384307e+01  2.59822585e+02  8.88600627e+02  3.14221916e+03
  1.26226793e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228772e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.670850923406  E_coul = 198.68092270940411
cycle= 6 E= -507.989928214002  delta_E= -6.91e-11  |g|= 1.26e-07  |ddm|= 8.09e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.670850923406  E_coul = 198.68092270940411
  HOMO = -0.243204250490855  LUMO = 0.396826626870822
  mo_energy =
[-1.20327559e+02 -1.23813996e+01 -6.67875725e+00 -6.67875725e+00
 -6.67875725e+00 -1.17965932e+00 -2.43204250e-01 -2.43204250e-01
 -2.43204250e-01  3.96826627e-01  2.01926484e+00  1.21535259e+01
  6.56384307e+01  2.59822585e+02  8.88600627e+02  3.14221916e+03
  1.26226793e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228772e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.670850875372  E_coul = 198.68092266137057
Extra cycle  E= -507.989928214001  delta_E= 3.98e-13  |g|= 1.76e-08  |ddm|= 5.37e-07
    CPU time for scf_cycle      8.46 sec, wall time      0.59 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912164.0341593823
E1 = -706.670850875372  E_coul = 198.68092266137057
init E= -507.989928214001
    CPU time for initialize scf     17.88 sec, wall time      0.80 sec
  HOMO = -0.243204253441347  LUMO = 0.396826625993957
  mo_energy =
[-1.20327559e+02 -1.23813996e+01 -6.67875725e+00 -6.67875725e+00
 -6.67875725e+00 -1.17965933e+00 -2.43204253e-01 -2.43204253e-01
 -2.43204253e-01  3.96826626e-01  2.01926484e+00  1.21535259e+01
  6.56384307e+01  2.59822585e+02  8.88600627e+02  3.14221916e+03
  1.26226793e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228772e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.6708508545786  E_coul = 198.68092264057705
cycle= 1 E= -507.989928214002  delta_E= -1.14e-13  |g|= 3.4e-09  |ddm|= 7.67e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6708508545786  E_coul = 198.68092264057705
  HOMO = -0.24320425424684  LUMO = 0.396826626267057
  mo_energy =
[-1.20327559e+02 -1.23813996e+01 -6.67875725e+00 -6.67875725e+00
 -6.67875725e+00 -1.17965933e+00 -2.43204254e-01 -2.43204254e-01
 -2.43204254e-01  3.96826626e-01  2.01926484e+00  1.21535259e+01
  6.56384307e+01  2.59822585e+02  8.88600627e+02  3.14221916e+03
  1.26226793e+04  4.12198861e+04  1.05248107e+05  2.30421249e+05
  4.56228772e+05  8.45175395e+05  1.52834721e+06  2.85060789e+06
  5.80848656e+06]
E1 = -706.6708508516854  E_coul = 198.68092263768318
Extra cycle  E= -507.989928214002  delta_E= -6.25e-13  |g|= 1.14e-09  |ddm|= 1.54e-08
    CPU time for scf_cycle     18.39 sec, wall time      0.96 sec
exp = [1.53309158e-01 3.01569472e-01 6.87548148e-01 1.17616813e+05
 3.05300063e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232176e+03
 1.83757714e+04 1.44352679e+03 4.17362093e+02 1.47783977e+02
 5.84529664e+01 2.45575880e+01 7.57362794e+00 8.60440600e+00
 4.92749298e-01]
grad_E = [ 2.23841186e-03 -4.84230216e-03 -1.49280308e-05  6.07000053e-09
 -1.24764856e-03  4.05266201e-11  1.74409044e-10  9.41488683e-10
  3.71993947e-09  1.55340973e-08  8.10188254e-08  5.10665406e-06
  1.98691257e-07 -3.86680980e-05 -4.40518004e-06 -3.97656668e-06
  1.12664845e-05 -1.42117233e-05  9.30224508e-05  8.23625565e-05
 -2.08725419e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.162335687205       1
[INPUT] 0    0    [1    /1   ]  0.310529151023       1
[INPUT] 0    0    [1    /1   ]  0.694161824485       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.05822527183        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175488        1
[INPUT] 0    0    [1    /1   ]  36754.7015385        1
[INPUT] 0    0    [1    /1   ]  7302.32172936        1
[INPUT] 0    0    [1    /1   ]  18375.7713491        1
[INPUT] 0    0    [1    /1   ]  1443.5269856         1
[INPUT] 0    0    [1    /1   ]  417.362117075        1
[INPUT] 0    0    [1    /1   ]  147.783988094        1
[INPUT] 0    0    [1    /1   ]  58.4529416788        1
[INPUT] 0    0    [1    /1   ]  24.5576122716        1
[INPUT] 0    0    [1    /1   ]  7.57297157557        1
[INPUT] 1    0    [1    /1   ]  8.60419521976        1
[INPUT] 1    0    [1    /1   ]  0.492698187203       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.1623356872054092, 1.0]], [0, [0.3105291510233205, 1.0]], [0, [0.6941618244853606, 1.0]], [0, [117616.81288968542, 1.0]], [0, [3.058225271827571, 1.0]], [0, [1176168.1426134538, 1.0]], [0, [588084.0699565652, 1.0]], [0, [294042.03092146345, 1.0]], [0, [147020.99132342814, 1.0]], [0, [73510.41754884983, 1.0]], [0, [36754.70153854547, 1.0]], [0, [7302.321729362548, 1.0]], [0, [18375.771349134637, 1.0]], [0, [1443.5269855968477, 1.0]], [0, [417.36211707526513, 1.0]], [0, [147.78398809367786, 1.0]], [0, [58.452941678846294, 1.0]], [0, [24.557612271560423, 1.0]], [0, [7.572971575572389, 1.0]], [1, [8.604195219756264, 1.0]], [1, [0.4926981872028672, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.16233569]
bas 1, expnt(s) = [0.31052915]
bas 2, expnt(s) = [0.69416182]
bas 3, expnt(s) = [117616.81288969]
bas 4, expnt(s) = [3.05822527]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092146]
bas 8, expnt(s) = [147020.99132343]
bas 9, expnt(s) = [73510.41754885]
bas 10, expnt(s) = [36754.70153855]
bas 11, expnt(s) = [7302.32172936]
bas 12, expnt(s) = [18375.77134913]
bas 13, expnt(s) = [1443.5269856]
bas 14, expnt(s) = [417.36211708]
bas 15, expnt(s) = [147.78398809]
bas 16, expnt(s) = [58.45294168]
bas 17, expnt(s) = [24.55761227]
bas 18, expnt(s) = [7.57297158]
bas 19, expnt(s) = [8.60419522]
bas 20, expnt(s) = [0.49269819]
CPU time:       191.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.62335687e-01 6.46138363e-01 3.10529151e-01 1.05097360e+00
 6.94161824e-01 1.92136807e+00 1.17616813e+05 1.60460108e+04
 3.05822527e+00 5.84274764e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232173e+03 1.99577118e+03
 1.83757713e+04 3.98748634e+03 1.44352699e+03 5.91675661e+02
 4.17362117e+02 2.33291972e+02 1.47783988e+02 1.07086706e+02
 5.84529417e+01 5.34096588e+01 2.45576123e+01 2.78711333e+01
 7.57297158e+00 1.15335969e+01 8.60419522e+00 4.29904719e+01
 4.92698187e-01 1.20423320e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33623734838599
cond(S) = 912168.8536905854
E1 = -689.5952050148727  E_coul = 184.97259958306736
init E= -504.622605431805
    CPU time for initialize scf      5.23 sec, wall time      0.28 sec
  HOMO = -0.67208154250498  LUMO = 0.175529712051565
  mo_energy =
[-1.21709786e+02 -1.33859128e+01 -7.62349709e+00 -7.62349709e+00
 -7.62349709e+00 -1.65748071e+00 -6.72081543e-01 -6.72081543e-01
 -6.72081543e-01  1.75529712e-01  1.68715263e+00  1.14770239e+01
  6.45903305e+01  2.58594251e+02  8.87339944e+02  3.14102306e+03
  1.26215903e+04  4.12188627e+04  1.05247120e+05  2.30420285e+05
  4.56227824e+05  8.45174459e+05  1.52834628e+06  2.85060697e+06
  5.80848565e+06]
E1 = -707.7434721403167  E_coul = 199.7714528531046
cycle= 1 E= -507.972019287212  delta_E= -3.35  |g|= 0.451  |ddm|= 0.439
    CPU time for cycle= 1      0.47 sec, wall time      0.03 sec
diis-norm(errvec)=0.73972
diis-c [-0.54718521  1.        ]
  HOMO = -0.217692791740304  LUMO = 0.421781722559024
  mo_energy =
[-1.20201561e+02 -1.23053387e+01 -6.59495827e+00 -6.59495827e+00
 -6.59495827e+00 -1.16335722e+00 -2.17692792e-01 -2.17692792e-01
 -2.17692792e-01  4.21781723e-01  2.11110296e+00  1.23383327e+01
  6.58570668e+01  2.60049412e+02  8.88831326e+02  3.14245406e+03
  1.26229146e+04  4.12201198e+04  1.05248340e+05  2.30421481e+05
  4.56229003e+05  8.45175624e+05  1.52834743e+06  2.85060812e+06
  5.80848679e+06]
E1 = -706.7957076192761  E_coul = 198.80603322465828
cycle= 2 E= -507.989674394618  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.369
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0394242
diis-c [-0.00153996 -0.00514594  1.00514594]
  HOMO = -0.239902186725476  LUMO = 0.421199175395072
  mo_energy =
[-1.20315872e+02 -1.23726615e+01 -6.66950526e+00 -6.66950526e+00
 -6.66950526e+00 -1.17767367e+00 -2.39902187e-01 -2.39902187e-01
 -2.39902187e-01  4.21199175e-01  2.10001545e+00  1.22909641e+01
  6.57748651e+01  2.59945072e+02  8.88711237e+02  3.14231975e+03
  1.26227701e+04  4.12199714e+04  1.05248190e+05  2.30421330e+05
  4.56228852e+05  8.45175473e+05  1.52834728e+06  2.85060796e+06
  5.80848664e+06]
E1 = -706.6852675124495  E_coul = 198.69531962226483
cycle= 3 E= -507.989947890185  delta_E= -0.000273  |g|= 0.00443  |ddm|= 0.0462
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00492279
diis-c [-3.84720499e-06 -3.04800965e-04 -1.28460069e-01  1.12876487e+00]
  HOMO = -0.243182426675036  LUMO = 0.420995295695755
  mo_energy =
[-1.20327775e+02 -1.23814121e+01 -6.67873037e+00 -6.67873037e+00
 -6.67873037e+00 -1.17966991e+00 -2.43182427e-01 -2.43182427e-01
 -2.43182427e-01  4.20995296e-01  2.09806410e+00  1.22843525e+01
  6.57651286e+01  2.59933812e+02  8.88699095e+02  3.14230693e+03
  1.26227569e+04  4.12199580e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6688514422484  E_coul = 198.67889765132279
cycle= 4 E= -507.989953790926  delta_E= -5.9e-06  |g|= 0.000231  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000192816
diis-c [-2.15295289e-09 -1.06564276e-05  8.61164054e-03 -9.75180292e-02
  1.08891705e+00]
  HOMO = -0.243286730454036  LUMO = 0.420980425803568
  mo_energy =
[-1.20327887e+02 -1.23816007e+01 -6.67890195e+00 -6.67890195e+00
 -6.67890195e+00 -1.17973382e+00 -2.43286730e-01 -2.43286730e-01
 -2.43286730e-01  4.20980426e-01  2.09798021e+00  1.22841791e+01
  6.57649709e+01  2.59933686e+02  8.88698990e+02  3.14230684e+03
  1.26227568e+04  4.12199579e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6683045680389  E_coul = 198.678350759541
cycle= 5 E= -507.989953808498  delta_E= -1.76e-08  |g|= 1.51e-05  |ddm|= 0.00101
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.0509e-06
diis-c [-2.75681972e-12  1.18278486e-06 -1.09709967e-03  1.19893459e-02
 -1.51417456e-01  1.14052403e+00]
  HOMO = -0.243289485943579  LUMO = 0.420979873887966
  mo_energy =
[-1.20327889e+02 -1.23816033e+01 -6.67890459e+00 -6.67890459e+00
 -6.67890459e+00 -1.17973596e+00 -2.43289486e-01 -2.43289486e-01
 -2.43289486e-01  4.20979874e-01  2.09797714e+00  1.22841758e+01
  6.57649682e+01  2.59933683e+02  8.88698987e+02  3.14230684e+03
  1.26227568e+04  4.12199579e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6682862036706  E_coul = 198.6783323951057
cycle= 6 E= -507.989953808565  delta_E= -6.7e-11  |g|= 1.21e-07  |ddm|= 8.3e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.6682862036706  E_coul = 198.6783323951057
  HOMO = -0.24328950784722  LUMO = 0.420979850563072
  mo_energy =
[-1.20327889e+02 -1.23816034e+01 -6.67890460e+00 -6.67890460e+00
 -6.67890460e+00 -1.17973596e+00 -2.43289508e-01 -2.43289508e-01
 -2.43289508e-01  4.20979851e-01  2.09797710e+00  1.22841758e+01
  6.57649682e+01  2.59933683e+02  8.88698987e+02  3.14230684e+03
  1.26227568e+04  4.12199579e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6682861461337  E_coul = 198.67833233756897
Extra cycle  E= -507.989953808565  delta_E= 1.71e-13  |g|= 1.75e-08  |ddm|= 5.21e-07
    CPU time for scf_cycle      5.91 sec, wall time      0.52 sec
exp = [1.62335687e-01 3.10529151e-01 6.94161824e-01 1.17616813e+05
 3.05822527e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232173e+03
 1.83757713e+04 1.44352699e+03 4.17362117e+02 1.47783988e+02
 5.84529417e+01 2.45576123e+01 7.57297158e+00 8.60419522e+00
 4.92698187e-01]
E = -507.98995380856474
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.162335687205       1
[INPUT] 0    0    [1    /1   ]  0.310529151023       1
[INPUT] 0    0    [1    /1   ]  0.694161824485       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.05822527183        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175488        1
[INPUT] 0    0    [1    /1   ]  36754.7015385        1
[INPUT] 0    0    [1    /1   ]  7302.32172936        1
[INPUT] 0    0    [1    /1   ]  18375.7713491        1
[INPUT] 0    0    [1    /1   ]  1443.5269856         1
[INPUT] 0    0    [1    /1   ]  417.362117075        1
[INPUT] 0    0    [1    /1   ]  147.783988094        1
[INPUT] 0    0    [1    /1   ]  58.4529416788        1
[INPUT] 0    0    [1    /1   ]  24.5576122716        1
[INPUT] 0    0    [1    /1   ]  7.57297157557        1
[INPUT] 1    0    [1    /1   ]  8.60419521976        1
[INPUT] 1    0    [1    /1   ]  0.492698187203       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.1623356872054092, 1.0]], [0, [0.3105291510233205, 1.0]], [0, [0.6941618244853606, 1.0]], [0, [117616.81288968542, 1.0]], [0, [3.058225271827571, 1.0]], [0, [1176168.1426134538, 1.0]], [0, [588084.0699565652, 1.0]], [0, [294042.03092146345, 1.0]], [0, [147020.99132342814, 1.0]], [0, [73510.41754884983, 1.0]], [0, [36754.70153854547, 1.0]], [0, [7302.321729362548, 1.0]], [0, [18375.771349134637, 1.0]], [0, [1443.5269855968477, 1.0]], [0, [417.36211707526513, 1.0]], [0, [147.78398809367786, 1.0]], [0, [58.452941678846294, 1.0]], [0, [24.557612271560423, 1.0]], [0, [7.572971575572389, 1.0]], [1, [8.604195219756264, 1.0]], [1, [0.4926981872028672, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.16233569]
bas 1, expnt(s) = [0.31052915]
bas 2, expnt(s) = [0.69416182]
bas 3, expnt(s) = [117616.81288969]
bas 4, expnt(s) = [3.05822527]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995657]
bas 7, expnt(s) = [294042.03092146]
bas 8, expnt(s) = [147020.99132343]
bas 9, expnt(s) = [73510.41754885]
bas 10, expnt(s) = [36754.70153855]
bas 11, expnt(s) = [7302.32172936]
bas 12, expnt(s) = [18375.77134913]
bas 13, expnt(s) = [1443.5269856]
bas 14, expnt(s) = [417.36211708]
bas 15, expnt(s) = [147.78398809]
bas 16, expnt(s) = [58.45294168]
bas 17, expnt(s) = [24.55761227]
bas 18, expnt(s) = [7.57297158]
bas 19, expnt(s) = [8.60419522]
bas 20, expnt(s) = [0.49269819]
CPU time:       197.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.62335687e-01 6.46138363e-01 3.10529151e-01 1.05097360e+00
 6.94161824e-01 1.92136807e+00 1.17616813e+05 1.60460108e+04
 3.05822527e+00 5.84274764e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232173e+03 1.99577118e+03
 1.83757713e+04 3.98748634e+03 1.44352699e+03 5.91675661e+02
 4.17362117e+02 2.33291972e+02 1.47783988e+02 1.07086706e+02
 5.84529417e+01 5.34096588e+01 2.45576123e+01 2.78711333e+01
 7.57297158e+00 1.15335969e+01 8.60419522e+00 4.29904719e+01
 4.92698187e-01 1.20423320e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33623734838599
cond(S) = 912168.8536905854
E1 = -689.5952050148727  E_coul = 184.97259958306736
init E= -504.622605431805
    CPU time for initialize scf      0.80 sec, wall time      0.07 sec
  HOMO = -0.67208154250498  LUMO = 0.175529712051565
  mo_energy =
[-1.21709786e+02 -1.33859128e+01 -7.62349709e+00 -7.62349709e+00
 -7.62349709e+00 -1.65748071e+00 -6.72081543e-01 -6.72081543e-01
 -6.72081543e-01  1.75529712e-01  1.68715263e+00  1.14770239e+01
  6.45903305e+01  2.58594251e+02  8.87339944e+02  3.14102306e+03
  1.26215903e+04  4.12188627e+04  1.05247120e+05  2.30420285e+05
  4.56227824e+05  8.45174459e+05  1.52834628e+06  2.85060697e+06
  5.80848565e+06]
E1 = -707.7434721403167  E_coul = 199.7714528531046
cycle= 1 E= -507.972019287212  delta_E= -3.35  |g|= 0.451  |ddm|= 0.439
    CPU time for cycle= 1      0.56 sec, wall time      0.03 sec
diis-norm(errvec)=0.73972
diis-c [-0.54718521  1.        ]
  HOMO = -0.217692791740304  LUMO = 0.421781722559024
  mo_energy =
[-1.20201561e+02 -1.23053387e+01 -6.59495827e+00 -6.59495827e+00
 -6.59495827e+00 -1.16335722e+00 -2.17692792e-01 -2.17692792e-01
 -2.17692792e-01  4.21781723e-01  2.11110296e+00  1.23383327e+01
  6.58570668e+01  2.60049412e+02  8.88831326e+02  3.14245406e+03
  1.26229146e+04  4.12201198e+04  1.05248340e+05  2.30421481e+05
  4.56229003e+05  8.45175624e+05  1.52834743e+06  2.85060812e+06
  5.80848679e+06]
E1 = -706.7957076192761  E_coul = 198.80603322465828
cycle= 2 E= -507.989674394618  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.369
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0394242
diis-c [-0.00153996 -0.00514594  1.00514594]
  HOMO = -0.239902186725476  LUMO = 0.421199175395072
  mo_energy =
[-1.20315872e+02 -1.23726615e+01 -6.66950526e+00 -6.66950526e+00
 -6.66950526e+00 -1.17767367e+00 -2.39902187e-01 -2.39902187e-01
 -2.39902187e-01  4.21199175e-01  2.10001545e+00  1.22909641e+01
  6.57748651e+01  2.59945072e+02  8.88711237e+02  3.14231975e+03
  1.26227701e+04  4.12199714e+04  1.05248190e+05  2.30421330e+05
  4.56228852e+05  8.45175473e+05  1.52834728e+06  2.85060796e+06
  5.80848664e+06]
E1 = -706.6852675124495  E_coul = 198.69531962226483
cycle= 3 E= -507.989947890185  delta_E= -0.000273  |g|= 0.00443  |ddm|= 0.0462
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00492279
diis-c [-3.84720499e-06 -3.04800965e-04 -1.28460069e-01  1.12876487e+00]
  HOMO = -0.243182426675036  LUMO = 0.420995295695755
  mo_energy =
[-1.20327775e+02 -1.23814121e+01 -6.67873037e+00 -6.67873037e+00
 -6.67873037e+00 -1.17966991e+00 -2.43182427e-01 -2.43182427e-01
 -2.43182427e-01  4.20995296e-01  2.09806410e+00  1.22843525e+01
  6.57651286e+01  2.59933812e+02  8.88699095e+02  3.14230693e+03
  1.26227569e+04  4.12199580e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6688514422484  E_coul = 198.67889765132279
cycle= 4 E= -507.989953790926  delta_E= -5.9e-06  |g|= 0.000231  |ddm|= 0.00945
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000192816
diis-c [-2.15295289e-09 -1.06564276e-05  8.61164054e-03 -9.75180292e-02
  1.08891705e+00]
  HOMO = -0.243286730454036  LUMO = 0.420980425803568
  mo_energy =
[-1.20327887e+02 -1.23816007e+01 -6.67890195e+00 -6.67890195e+00
 -6.67890195e+00 -1.17973382e+00 -2.43286730e-01 -2.43286730e-01
 -2.43286730e-01  4.20980426e-01  2.09798021e+00  1.22841791e+01
  6.57649709e+01  2.59933686e+02  8.88698990e+02  3.14230684e+03
  1.26227568e+04  4.12199579e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6683045680389  E_coul = 198.678350759541
cycle= 5 E= -507.989953808498  delta_E= -1.76e-08  |g|= 1.51e-05  |ddm|= 0.00101
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=7.0509e-06
diis-c [-2.75681972e-12  1.18278486e-06 -1.09709967e-03  1.19893459e-02
 -1.51417456e-01  1.14052403e+00]
  HOMO = -0.243289485943579  LUMO = 0.420979873887966
  mo_energy =
[-1.20327889e+02 -1.23816033e+01 -6.67890459e+00 -6.67890459e+00
 -6.67890459e+00 -1.17973596e+00 -2.43289486e-01 -2.43289486e-01
 -2.43289486e-01  4.20979874e-01  2.09797714e+00  1.22841758e+01
  6.57649682e+01  2.59933683e+02  8.88698987e+02  3.14230684e+03
  1.26227568e+04  4.12199579e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6682862036706  E_coul = 198.6783323951057
cycle= 6 E= -507.989953808565  delta_E= -6.7e-11  |g|= 1.21e-07  |ddm|= 8.3e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.6682862036706  E_coul = 198.6783323951057
  HOMO = -0.24328950784722  LUMO = 0.420979850563072
  mo_energy =
[-1.20327889e+02 -1.23816034e+01 -6.67890460e+00 -6.67890460e+00
 -6.67890460e+00 -1.17973596e+00 -2.43289508e-01 -2.43289508e-01
 -2.43289508e-01  4.20979851e-01  2.09797710e+00  1.22841758e+01
  6.57649682e+01  2.59933683e+02  8.88698987e+02  3.14230684e+03
  1.26227568e+04  4.12199579e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6682861461337  E_coul = 198.67833233756897
Extra cycle  E= -507.989953808565  delta_E= 1.71e-13  |g|= 1.75e-08  |ddm|= 5.21e-07
    CPU time for scf_cycle      1.57 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912168.8536905854
E1 = -706.6682861461337  E_coul = 198.67833233756897
init E= -507.989953808565
    CPU time for initialize scf      8.68 sec, wall time      0.39 sec
  HOMO = -0.243289511006122  LUMO = 0.420979851466377
  mo_energy =
[-1.20327889e+02 -1.23816034e+01 -6.67890460e+00 -6.67890460e+00
 -6.67890460e+00 -1.17973596e+00 -2.43289511e-01 -2.43289511e-01
 -2.43289511e-01  4.20979851e-01  2.09797709e+00  1.22841758e+01
  6.57649682e+01  2.59933683e+02  8.88698987e+02  3.14230684e+03
  1.26227568e+04  4.12199579e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6682861219883  E_coul = 198.67833231342345
cycle= 1 E= -507.989953808565  delta_E= -1.71e-13  |g|= 2.86e-09  |ddm|= 8e-08
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -706.6682861219883  E_coul = 198.67833231342345
  HOMO = -0.243289511910245  LUMO = 0.420979851094624
  mo_energy =
[-1.20327889e+02 -1.23816034e+01 -6.67890461e+00 -6.67890461e+00
 -6.67890461e+00 -1.17973596e+00 -2.43289512e-01 -2.43289512e-01
 -2.43289512e-01  4.20979851e-01  2.09797709e+00  1.22841758e+01
  6.57649682e+01  2.59933683e+02  8.88698987e+02  3.14230684e+03
  1.26227568e+04  4.12199579e+04  1.05248176e+05  2.30421316e+05
  4.56228838e+05  8.45175459e+05  1.52834727e+06  2.85060795e+06
  5.80848662e+06]
E1 = -706.6682861184045  E_coul = 198.67833230983916
Extra cycle  E= -507.989953808565  delta_E= -3.98e-13  |g|= 1.96e-09  |ddm|= 1.14e-08
    CPU time for scf_cycle      8.89 sec, wall time      0.60 sec
exp = [1.62335687e-01 3.10529151e-01 6.94161824e-01 1.17616813e+05
 3.05822527e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232173e+03
 1.83757713e+04 1.44352699e+03 4.17362117e+02 1.47783988e+02
 5.84529417e+01 2.45576123e+01 7.57297158e+00 8.60419522e+00
 4.92698187e-01]
grad_E = [ 2.66243622e-03 -4.44773455e-03  1.64207164e-06  6.07051854e-09
 -1.07415687e-03  4.05323858e-11  1.74426029e-10  9.41568068e-10
  3.72026033e-09  1.55354551e-08  8.10253759e-08  5.10707638e-06
  1.98712731e-07 -3.86870671e-05 -4.21085519e-06 -5.04697134e-06
  1.57819187e-05 -2.06755268e-05  4.70402814e-06 -4.04659864e-05
 -1.68431780e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.17488544271        1
[INPUT] 0    0    [1    /1   ]  0.340678005487       1
[INPUT] 0    0    [1    /1   ]  0.716092401819       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.07765128795        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175486        1
[INPUT] 0    0    [1    /1   ]  36754.7015371        1
[INPUT] 0    0    [1    /1   ]  7302.32164012        1
[INPUT] 0    0    [1    /1   ]  18375.7713457        1
[INPUT] 0    0    [1    /1   ]  1443.5276611         1
[INPUT] 0    0    [1    /1   ]  417.362197515        1
[INPUT] 0    0    [1    /1   ]  147.784038823        1
[INPUT] 0    0    [1    /1   ]  58.4528146767        1
[INPUT] 0    0    [1    /1   ]  24.5577561075        1
[INPUT] 0    0    [1    /1   ]  7.57099257748        1
[INPUT] 1    0    [1    /1   ]  8.60367091166        1
[INPUT] 1    0    [1    /1   ]  0.49259805641        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.17488544271006287, 1.0]], [0, [0.3406780054871133, 1.0]], [0, [0.7160924018189876, 1.0]], [0, [117616.81288957933, 1.0]], [0, [3.0776512879540934, 1.0]], [0, [1176168.142613453, 1.0]], [0, [588084.0699565621, 1.0]], [0, [294042.030921447, 1.0]], [0, [147020.99132336312, 1.0]], [0, [73510.41754857835, 1.0]], [0, [36754.701537129535, 1.0]], [0, [7302.321640115486, 1.0]], [0, [18375.77134566227, 1.0]], [0, [1443.5276610975116, 1.0]], [0, [417.3621975149866, 1.0]], [0, [147.78403882278536, 1.0]], [0, [58.45281467669032, 1.0]], [0, [24.557756107526945, 1.0]], [0, [7.570992577480864, 1.0]], [1, [8.603670911656176, 1.0]], [1, [0.49259805641001914, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.17488544]
bas 1, expnt(s) = [0.34067801]
bas 2, expnt(s) = [0.7160924]
bas 3, expnt(s) = [117616.81288958]
bas 4, expnt(s) = [3.07765129]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995656]
bas 7, expnt(s) = [294042.03092145]
bas 8, expnt(s) = [147020.99132336]
bas 9, expnt(s) = [73510.41754858]
bas 10, expnt(s) = [36754.70153713]
bas 11, expnt(s) = [7302.32164012]
bas 12, expnt(s) = [18375.77134566]
bas 13, expnt(s) = [1443.5276611]
bas 14, expnt(s) = [417.36219751]
bas 15, expnt(s) = [147.78403882]
bas 16, expnt(s) = [58.45281468]
bas 17, expnt(s) = [24.55775611]
bas 18, expnt(s) = [7.57099258]
bas 19, expnt(s) = [8.60367091]
bas 20, expnt(s) = [0.49259806]
CPU time:       215.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.74885443e-01 6.83250990e-01 3.40678005e-01 1.12660869e+00
 7.16092402e-01 1.96671678e+00 1.17616813e+05 1.60460108e+04
 3.07765129e+00 5.87056069e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232164e+03 1.99577116e+03
 1.83757713e+04 3.98748634e+03 1.44352766e+03 5.91675869e+02
 4.17362198e+02 2.33292006e+02 1.47784039e+02 1.07086734e+02
 5.84528147e+01 5.34095717e+01 2.45577561e+01 2.78712557e+01
 7.57099258e+00 1.15313363e+01 8.60367091e+00 4.29871973e+01
 4.92598056e-01 1.20392729e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336372754875317
cond(S) = 912181.4957615439
E1 = -689.5886730787338  E_coul = 184.9667584423489
init E= -504.621914636385
    CPU time for initialize scf      0.80 sec, wall time      0.07 sec
  HOMO = -0.672204572676301  LUMO = 0.212495222617554
  mo_energy =
[-1.21710587e+02 -1.33864009e+01 -7.62387952e+00 -7.62387952e+00
 -7.62387952e+00 -1.65764212e+00 -6.72204573e-01 -6.72204573e-01
 -6.72204573e-01  2.12495223e-01  1.86304072e+00  1.18295526e+01
  6.49493393e+01  2.58912003e+02  8.87621718e+02  3.14127449e+03
  1.26218128e+04  4.12190690e+04  1.05247318e+05  2.30420477e+05
  4.56228013e+05  8.45174645e+05  1.52834646e+06  2.85060715e+06
  5.80848583e+06]
E1 = -707.7379861167274  E_coul = 199.7658942289917
cycle= 1 E= -507.972091887736  delta_E= -3.35  |g|= 0.451  |ddm|= 0.442
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.736405
diis-c [-0.54229206  1.        ]
  HOMO = -0.217892496630837  LUMO = 0.468953335515499
  mo_energy =
[-1.20202282e+02 -1.23057581e+01 -6.59525621e+00 -6.59525621e+00
 -6.59525621e+00 -1.16354992e+00 -2.17892497e-01 -2.17892497e-01
 -2.17892497e-01  4.68953336e-01  2.29915685e+00  1.26915910e+01
  6.62155334e+01  2.60367061e+02  8.89113141e+02  3.14270557e+03
  1.26231372e+04  4.12203262e+04  1.05248538e+05  2.30421673e+05
  4.56229191e+05  8.45175810e+05  1.52834762e+06  2.85060830e+06
  5.80848696e+06]
E1 = -706.7890980364875  E_coul = 198.7993295828589
cycle= 2 E= -507.989768453629  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.352
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0386996
diis-c [-0.00148692 -0.00447726  1.00447726]
  HOMO = -0.24009103931784  LUMO = 0.468195014160161
  mo_energy =
[-1.20316657e+02 -1.23731363e+01 -6.66986112e+00 -6.66986112e+00
 -6.66986112e+00 -1.17785787e+00 -2.40091039e-01 -2.40091039e-01
 -2.40091039e-01  4.68195014e-01  2.28706684e+00  1.26438948e+01
  6.61332921e+01  2.60262672e+02  8.88992994e+02  3.14257120e+03
  1.26229926e+04  4.12201778e+04  1.05248388e+05  2.30421522e+05
  4.56229040e+05  8.45175658e+05  1.52834746e+06  2.85060814e+06
  5.80848681e+06]
E1 = -706.678883016958  E_coul = 198.68884219337212
cycle= 3 E= -507.990040823586  delta_E= -0.000272  |g|= 0.00444  |ddm|= 0.0458
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00479755
diis-c [-3.68571726e-06 -2.98150782e-04 -1.27372506e-01  1.12767066e+00]
  HOMO = -0.243371662906346  LUMO = 0.467951364962667
  mo_energy =
[-1.20328603e+02 -1.23819046e+01 -6.67910827e+00 -6.67910827e+00
 -6.67910827e+00 -1.17985463e+00 -2.43371663e-01 -2.43371663e-01
 -2.43371663e-01  4.67951365e-01  2.28496806e+00  1.26372480e+01
  6.61235315e+01  2.60251375e+02  8.88980804e+02  3.14255832e+03
  1.26229793e+04  4.12201643e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175645e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6625039793194  E_coul = 198.6724572842886
cycle= 4 E= -507.990046695031  delta_E= -5.87e-06  |g|= 0.000232  |ddm|= 0.00974
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000186561
diis-c [-1.97619004e-09 -1.04477389e-05  8.50168235e-03 -9.67529383e-02
  1.08826170e+00]
  HOMO = -0.24347901904444  LUMO = 0.467934250189744
  mo_energy =
[-1.20328728e+02 -1.23821017e+01 -6.67928896e+00 -6.67928896e+00
 -6.67928896e+00 -1.17992043e+00 -2.43479019e-01 -2.43479019e-01
 -2.43479019e-01  4.67934250e-01  2.28487788e+00  1.26370686e+01
  6.61233641e+01  2.60251236e+02  8.88980686e+02  3.14255822e+03
  1.26229792e+04  4.12201643e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175644e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6619465822117  E_coul = 198.67189987000236
cycle= 5 E= -507.990046712209  delta_E= -1.72e-08  |g|= 1.45e-05  |ddm|= 0.00102
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.64521e-06
diis-c [-2.59013973e-12  1.13450836e-06 -1.07075066e-03  1.17416465e-02
 -1.48606051e-01  1.13793402e+00]
  HOMO = -0.243482108290352  LUMO = 0.467933614377689
  mo_energy =
[-1.20328731e+02 -1.23821053e+01 -6.67929250e+00 -6.67929250e+00
 -6.67929250e+00 -1.17992277e+00 -2.43482108e-01 -2.43482108e-01
 -2.43482108e-01  4.67933614e-01  2.28487453e+00  1.26370646e+01
  6.61233605e+01  2.60251232e+02  8.88980682e+02  3.14255822e+03
  1.26229792e+04  4.12201642e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175644e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6619270980215  E_coul = 198.67188038575247
cycle= 6 E= -507.990046712269  delta_E= -5.96e-11  |g|= 1.01e-07  |ddm|= 7.87e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6619270980215  E_coul = 198.67188038575247
  HOMO = -0.243482133373924  LUMO = 0.467933591579485
  mo_energy =
[-1.20328731e+02 -1.23821053e+01 -6.67929252e+00 -6.67929252e+00
 -6.67929252e+00 -1.17992276e+00 -2.43482133e-01 -2.43482133e-01
 -2.43482133e-01  4.67933592e-01  2.28487449e+00  1.26370645e+01
  6.61233605e+01  2.60251232e+02  8.88980682e+02  3.14255822e+03
  1.26229792e+04  4.12201642e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175644e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6619270263817  E_coul = 198.67188031411249
Extra cycle  E= -507.990046712269  delta_E= -2.27e-13  |g|= 1.39e-08  |ddm|= 4.16e-07
    CPU time for scf_cycle      1.57 sec, wall time      0.29 sec
exp = [1.74885443e-01 3.40678005e-01 7.16092402e-01 1.17616813e+05
 3.07765129e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232164e+03
 1.83757713e+04 1.44352766e+03 4.17362198e+02 1.47784039e+02
 5.84528147e+01 2.45577561e+01 7.57099258e+00 8.60367091e+00
 4.92598056e-01]
E = -507.9900467122692
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.17488544271        1
[INPUT] 0    0    [1    /1   ]  0.340678005487       1
[INPUT] 0    0    [1    /1   ]  0.716092401819       1
[INPUT] 0    0    [1    /1   ]  117616.81289         1
[INPUT] 0    0    [1    /1   ]  3.07765128795        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175486        1
[INPUT] 0    0    [1    /1   ]  36754.7015371        1
[INPUT] 0    0    [1    /1   ]  7302.32164012        1
[INPUT] 0    0    [1    /1   ]  18375.7713457        1
[INPUT] 0    0    [1    /1   ]  1443.5276611         1
[INPUT] 0    0    [1    /1   ]  417.362197515        1
[INPUT] 0    0    [1    /1   ]  147.784038823        1
[INPUT] 0    0    [1    /1   ]  58.4528146767        1
[INPUT] 0    0    [1    /1   ]  24.5577561075        1
[INPUT] 0    0    [1    /1   ]  7.57099257748        1
[INPUT] 1    0    [1    /1   ]  8.60367091166        1
[INPUT] 1    0    [1    /1   ]  0.49259805641        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.17488544271006287, 1.0]], [0, [0.3406780054871133, 1.0]], [0, [0.7160924018189876, 1.0]], [0, [117616.81288957933, 1.0]], [0, [3.0776512879540934, 1.0]], [0, [1176168.142613453, 1.0]], [0, [588084.0699565621, 1.0]], [0, [294042.030921447, 1.0]], [0, [147020.99132336312, 1.0]], [0, [73510.41754857835, 1.0]], [0, [36754.701537129535, 1.0]], [0, [7302.321640115486, 1.0]], [0, [18375.77134566227, 1.0]], [0, [1443.5276610975116, 1.0]], [0, [417.3621975149866, 1.0]], [0, [147.78403882278536, 1.0]], [0, [58.45281467669032, 1.0]], [0, [24.557756107526945, 1.0]], [0, [7.570992577480864, 1.0]], [1, [8.603670911656176, 1.0]], [1, [0.49259805641001914, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.17488544]
bas 1, expnt(s) = [0.34067801]
bas 2, expnt(s) = [0.7160924]
bas 3, expnt(s) = [117616.81288958]
bas 4, expnt(s) = [3.07765129]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995656]
bas 7, expnt(s) = [294042.03092145]
bas 8, expnt(s) = [147020.99132336]
bas 9, expnt(s) = [73510.41754858]
bas 10, expnt(s) = [36754.70153713]
bas 11, expnt(s) = [7302.32164012]
bas 12, expnt(s) = [18375.77134566]
bas 13, expnt(s) = [1443.5276611]
bas 14, expnt(s) = [417.36219751]
bas 15, expnt(s) = [147.78403882]
bas 16, expnt(s) = [58.45281468]
bas 17, expnt(s) = [24.55775611]
bas 18, expnt(s) = [7.57099258]
bas 19, expnt(s) = [8.60367091]
bas 20, expnt(s) = [0.49259806]
CPU time:       216.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.74885443e-01 6.83250990e-01 3.40678005e-01 1.12660869e+00
 7.16092402e-01 1.96671678e+00 1.17616813e+05 1.60460108e+04
 3.07765129e+00 5.87056069e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232164e+03 1.99577116e+03
 1.83757713e+04 3.98748634e+03 1.44352766e+03 5.91675869e+02
 4.17362198e+02 2.33292006e+02 1.47784039e+02 1.07086734e+02
 5.84528147e+01 5.34095717e+01 2.45577561e+01 2.78712557e+01
 7.57099258e+00 1.15313363e+01 8.60367091e+00 4.29871973e+01
 4.92598056e-01 1.20392729e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336372754875317
cond(S) = 912181.4957615439
E1 = -689.5886730787338  E_coul = 184.9667584423489
init E= -504.621914636385
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672204572676301  LUMO = 0.212495222617554
  mo_energy =
[-1.21710587e+02 -1.33864009e+01 -7.62387952e+00 -7.62387952e+00
 -7.62387952e+00 -1.65764212e+00 -6.72204573e-01 -6.72204573e-01
 -6.72204573e-01  2.12495223e-01  1.86304072e+00  1.18295526e+01
  6.49493393e+01  2.58912003e+02  8.87621718e+02  3.14127449e+03
  1.26218128e+04  4.12190690e+04  1.05247318e+05  2.30420477e+05
  4.56228013e+05  8.45174645e+05  1.52834646e+06  2.85060715e+06
  5.80848583e+06]
E1 = -707.7379861167274  E_coul = 199.7658942289917
cycle= 1 E= -507.972091887736  delta_E= -3.35  |g|= 0.451  |ddm|= 0.442
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.736405
diis-c [-0.54229206  1.        ]
  HOMO = -0.217892496630837  LUMO = 0.468953335515499
  mo_energy =
[-1.20202282e+02 -1.23057581e+01 -6.59525621e+00 -6.59525621e+00
 -6.59525621e+00 -1.16354992e+00 -2.17892497e-01 -2.17892497e-01
 -2.17892497e-01  4.68953336e-01  2.29915685e+00  1.26915910e+01
  6.62155334e+01  2.60367061e+02  8.89113141e+02  3.14270557e+03
  1.26231372e+04  4.12203262e+04  1.05248538e+05  2.30421673e+05
  4.56229191e+05  8.45175810e+05  1.52834762e+06  2.85060830e+06
  5.80848696e+06]
E1 = -706.7890980364875  E_coul = 198.7993295828589
cycle= 2 E= -507.989768453629  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.352
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0386996
diis-c [-0.00148692 -0.00447726  1.00447726]
  HOMO = -0.24009103931784  LUMO = 0.468195014160161
  mo_energy =
[-1.20316657e+02 -1.23731363e+01 -6.66986112e+00 -6.66986112e+00
 -6.66986112e+00 -1.17785787e+00 -2.40091039e-01 -2.40091039e-01
 -2.40091039e-01  4.68195014e-01  2.28706684e+00  1.26438948e+01
  6.61332921e+01  2.60262672e+02  8.88992994e+02  3.14257120e+03
  1.26229926e+04  4.12201778e+04  1.05248388e+05  2.30421522e+05
  4.56229040e+05  8.45175658e+05  1.52834746e+06  2.85060814e+06
  5.80848681e+06]
E1 = -706.678883016958  E_coul = 198.68884219337212
cycle= 3 E= -507.990040823586  delta_E= -0.000272  |g|= 0.00444  |ddm|= 0.0458
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00479755
diis-c [-3.68571726e-06 -2.98150782e-04 -1.27372506e-01  1.12767066e+00]
  HOMO = -0.243371662906346  LUMO = 0.467951364962667
  mo_energy =
[-1.20328603e+02 -1.23819046e+01 -6.67910827e+00 -6.67910827e+00
 -6.67910827e+00 -1.17985463e+00 -2.43371663e-01 -2.43371663e-01
 -2.43371663e-01  4.67951365e-01  2.28496806e+00  1.26372480e+01
  6.61235315e+01  2.60251375e+02  8.88980804e+02  3.14255832e+03
  1.26229793e+04  4.12201643e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175645e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6625039793194  E_coul = 198.6724572842886
cycle= 4 E= -507.990046695031  delta_E= -5.87e-06  |g|= 0.000232  |ddm|= 0.00974
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000186561
diis-c [-1.97619004e-09 -1.04477389e-05  8.50168235e-03 -9.67529383e-02
  1.08826170e+00]
  HOMO = -0.24347901904444  LUMO = 0.467934250189744
  mo_energy =
[-1.20328728e+02 -1.23821017e+01 -6.67928896e+00 -6.67928896e+00
 -6.67928896e+00 -1.17992043e+00 -2.43479019e-01 -2.43479019e-01
 -2.43479019e-01  4.67934250e-01  2.28487788e+00  1.26370686e+01
  6.61233641e+01  2.60251236e+02  8.88980686e+02  3.14255822e+03
  1.26229792e+04  4.12201643e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175644e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6619465822117  E_coul = 198.67189987000236
cycle= 5 E= -507.990046712209  delta_E= -1.72e-08  |g|= 1.45e-05  |ddm|= 0.00102
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.64521e-06
diis-c [-2.59013973e-12  1.13450836e-06 -1.07075066e-03  1.17416465e-02
 -1.48606051e-01  1.13793402e+00]
  HOMO = -0.243482108290352  LUMO = 0.467933614377689
  mo_energy =
[-1.20328731e+02 -1.23821053e+01 -6.67929250e+00 -6.67929250e+00
 -6.67929250e+00 -1.17992277e+00 -2.43482108e-01 -2.43482108e-01
 -2.43482108e-01  4.67933614e-01  2.28487453e+00  1.26370646e+01
  6.61233605e+01  2.60251232e+02  8.88980682e+02  3.14255822e+03
  1.26229792e+04  4.12201642e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175644e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6619270980215  E_coul = 198.67188038575247
cycle= 6 E= -507.990046712269  delta_E= -5.96e-11  |g|= 1.01e-07  |ddm|= 7.87e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6619270980215  E_coul = 198.67188038575247
  HOMO = -0.243482133373924  LUMO = 0.467933591579485
  mo_energy =
[-1.20328731e+02 -1.23821053e+01 -6.67929252e+00 -6.67929252e+00
 -6.67929252e+00 -1.17992276e+00 -2.43482133e-01 -2.43482133e-01
 -2.43482133e-01  4.67933592e-01  2.28487449e+00  1.26370645e+01
  6.61233605e+01  2.60251232e+02  8.88980682e+02  3.14255822e+03
  1.26229792e+04  4.12201642e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175644e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6619270263817  E_coul = 198.67188031411249
Extra cycle  E= -507.990046712269  delta_E= -2.27e-13  |g|= 1.39e-08  |ddm|= 4.16e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912181.4957615439
E1 = -706.6619270263817  E_coul = 198.67188031411249
init E= -507.990046712269
    CPU time for initialize scf      5.67 sec, wall time      0.24 sec
  HOMO = -0.243482136702093  LUMO = 0.467933590702367
  mo_energy =
[-1.20328731e+02 -1.23821053e+01 -6.67929253e+00 -6.67929253e+00
 -6.67929253e+00 -1.17992277e+00 -2.43482137e-01 -2.43482137e-01
 -2.43482137e-01  4.67933591e-01  2.28487449e+00  1.26370645e+01
  6.61233605e+01  2.60251232e+02  8.88980682e+02  3.14255822e+03
  1.26229792e+04  4.12201642e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175644e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6619270103291  E_coul = 198.67188029806007
cycle= 1 E= -507.990046712269  delta_E= 1.14e-13  |g|= 3.96e-09  |ddm|= 5.93e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6619270103291  E_coul = 198.67188029806007
  HOMO = -0.243482137339043  LUMO = 0.467933591134999
  mo_energy =
[-1.20328731e+02 -1.23821053e+01 -6.67929253e+00 -6.67929253e+00
 -6.67929253e+00 -1.17992277e+00 -2.43482137e-01 -2.43482137e-01
 -2.43482137e-01  4.67933591e-01  2.28487449e+00  1.26370645e+01
  6.61233605e+01  2.60251232e+02  8.88980682e+02  3.14255822e+03
  1.26229792e+04  4.12201642e+04  1.05248374e+05  2.30421509e+05
  4.56229026e+05  8.45175644e+05  1.52834745e+06  2.85060813e+06
  5.80848680e+06]
E1 = -706.6619270006381  E_coul = 198.6718802883692
Extra cycle  E= -507.990046712269  delta_E= 1.71e-13  |g|= 2.28e-09  |ddm|= 1.44e-08
    CPU time for scf_cycle      6.13 sec, wall time      0.41 sec
exp = [1.74885443e-01 3.40678005e-01 7.16092402e-01 1.17616813e+05
 3.07765129e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232164e+03
 1.83757713e+04 1.44352766e+03 4.17362198e+02 1.47784039e+02
 5.84528147e+01 2.45577561e+01 7.57099258e+00 8.60367091e+00
 4.92598056e-01]
grad_E = [ 2.80535495e-03 -2.78916762e-03 -5.76216668e-04  6.07233680e-09
 -4.13070482e-04  4.05526724e-11  1.74485716e-10  9.41846655e-10
  3.72138671e-09  1.55402224e-08  8.10483536e-08  5.10855619e-06
  1.98788297e-07 -3.87538453e-05 -3.52223757e-06 -8.84155585e-06
  3.21044512e-05 -4.35807155e-05 -3.29061996e-04 -3.75689859e-04
 -4.75609617e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.1745808929         1
[INPUT] 0    0    [1    /1   ]  0.381174935127       1
[INPUT] 0    0    [1    /1   ]  0.746405110719       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.10499440916        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175482        1
[INPUT] 0    0    [1    /1   ]  36754.7015352        1
[INPUT] 0    0    [1    /1   ]  7302.3215161         1
[INPUT] 0    0    [1    /1   ]  18375.7713408        1
[INPUT] 0    0    [1    /1   ]  1443.52859998        1
[INPUT] 0    0    [1    /1   ]  417.362306306        1
[INPUT] 0    0    [1    /1   ]  147.784125598        1
[INPUT] 0    0    [1    /1   ]  58.4525729044        1
[INPUT] 0    0    [1    /1   ]  24.5580491766        1
[INPUT] 0    0    [1    /1   ]  7.5690317744         1
[INPUT] 1    0    [1    /1   ]  8.60360956983        1
[INPUT] 1    0    [1    /1   ]  0.4926270369         1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.1745808928998835, 1.0]], [0, [0.3811749351272814, 1.0]], [0, [0.7464051107186979, 1.0]], [0, [117616.81288943192, 1.0]], [0, [3.1049944091620487, 1.0]], [0, [1176168.1426134522, 1.0]], [0, [588084.0699565579, 1.0]], [0, [294042.0309214241, 1.0]], [0, [147020.99132327278, 1.0]], [0, [73510.4175482011, 1.0]], [0, [36754.70153516202, 1.0]], [0, [7302.321516102182, 1.0]], [0, [18375.771340837164, 1.0]], [0, [1443.5285999839377, 1.0]], [0, [417.36230630631957, 1.0]], [0, [147.78412559763717, 1.0]], [0, [58.45257290435091, 1.0]], [0, [24.558049176570236, 1.0]], [0, [7.569031774403724, 1.0]], [1, [8.603609569826903, 1.0]], [1, [0.4926270368996085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.17458089]
bas 1, expnt(s) = [0.38117494]
bas 2, expnt(s) = [0.74640511]
bas 3, expnt(s) = [117616.81288943]
bas 4, expnt(s) = [3.10499441]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995656]
bas 7, expnt(s) = [294042.03092142]
bas 8, expnt(s) = [147020.99132327]
bas 9, expnt(s) = [73510.4175482]
bas 10, expnt(s) = [36754.70153516]
bas 11, expnt(s) = [7302.3215161]
bas 12, expnt(s) = [18375.77134084]
bas 13, expnt(s) = [1443.52859998]
bas 14, expnt(s) = [417.36230631]
bas 15, expnt(s) = [147.7841256]
bas 16, expnt(s) = [58.4525729]
bas 17, expnt(s) = [24.55804918]
bas 18, expnt(s) = [7.56903177]
bas 19, expnt(s) = [8.60360957]
bas 20, expnt(s) = [0.49262704]
CPU time:       231.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.74580893e-01 6.82358423e-01 3.81174935e-01 1.22562688e+00
 7.46405111e-01 2.02883149e+00 1.17616813e+05 1.60460108e+04
 3.10499441e+00 5.90963477e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232152e+03 1.99577114e+03
 1.83757713e+04 3.98748634e+03 1.44352860e+03 5.91676157e+02
 4.17362306e+02 2.33292051e+02 1.47784126e+02 1.07086781e+02
 5.84525729e+01 5.34094061e+01 2.45580492e+01 2.78715052e+01
 7.56903177e+00 1.15290964e+01 8.60360957e+00 4.29868142e+01
 4.92627037e-01 1.20401583e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336356681142185
cond(S) = 912195.0587676888
E1 = -689.5875823613368  E_coul = 184.96595306715153
init E= -504.621629294185
    CPU time for initialize scf      0.81 sec, wall time      0.07 sec
  HOMO = -0.672213896861  LUMO = 0.233846599651518
  mo_energy =
[-1.21710689e+02 -1.33864751e+01 -7.62396352e+00 -7.62396352e+00
 -7.62396352e+00 -1.65765462e+00 -6.72213897e-01 -6.72213897e-01
 -6.72213897e-01  2.33846600e-01  2.02862212e+00  1.22221690e+01
  6.53714107e+01  2.59289830e+02  8.87957705e+02  3.14157475e+03
  1.26220789e+04  4.12193160e+04  1.05247554e+05  2.30420708e+05
  4.56228238e+05  8.45174866e+05  1.52834668e+06  2.85060736e+06
  5.80848603e+06]
E1 = -707.7398098586956  E_coul = 199.76769177886982
cycle= 1 E= -507.972118079826  delta_E= -3.35  |g|= 0.451  |ddm|= 0.43
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.734682
diis-c [-0.53975778  1.        ]
  HOMO = -0.21782003172152  LUMO = 0.497440345034986
  mo_energy =
[-1.20202194e+02 -1.23056158e+01 -6.59512656e+00 -6.59512656e+00
 -6.59512656e+00 -1.16352412e+00 -2.17820032e-01 -2.17820032e-01
 -2.17820032e-01  4.97440345e-01  2.47827618e+00  1.30860308e+01
  6.66371868e+01  2.60744887e+02  8.89449266e+02  3.14300599e+03
  1.26234035e+04  4.12205734e+04  1.05248775e+05  2.30421903e+05
  4.56229417e+05  8.45176032e+05  1.52834783e+06  2.85060851e+06
  5.80848717e+06]
E1 = -706.7881529975454  E_coul = 198.79830571447178
cycle= 2 E= -507.989847283074  delta_E= -0.0177  |g|= 0.0351  |ddm|= 0.34
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0388325
diis-c [-0.00149822 -0.00427256  1.00427256]
  HOMO = -0.240082903238913  LUMO = 0.496525842062161
  mo_energy =
[-1.20316822e+02 -1.23731967e+01 -6.66994225e+00 -6.66994225e+00
 -6.66994225e+00 -1.17787205e+00 -2.40082903e-01 -2.40082903e-01
 -2.40082903e-01  4.96525842e-01  2.46507005e+00  1.30378164e+01
  6.65547414e+01  2.60640268e+02  8.89328866e+02  3.14287135e+03
  1.26232587e+04  4.12204247e+04  1.05248625e+05  2.30421752e+05
  4.56229265e+05  8.45175880e+05  1.52834768e+06  2.85060836e+06
  5.80848702e+06]
E1 = -706.6775996495023  E_coul = 198.6874790447461
cycle= 3 E= -507.990120604756  delta_E= -0.000273  |g|= 0.00445  |ddm|= 0.0437
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00485134
diis-c [-3.75939738e-06 -3.03431637e-04 -1.28546517e-01  1.12884995e+00]
  HOMO = -0.243382642339535  LUMO = 0.496245899515912
  mo_energy =
[-1.20328840e+02 -1.23820157e+01 -6.67924329e+00 -6.67924329e+00
 -6.67924329e+00 -1.17988019e+00 -2.43382642e-01 -2.43382642e-01
 -2.43382642e-01  4.96245900e-01  2.46279778e+00  1.30310959e+01
  6.65449253e+01  2.60628905e+02  8.89316603e+02  3.14285840e+03
  1.26232452e+04  4.12204112e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.66114115517  E_coul = 198.67101465709266
cycle= 4 E= -507.990126498077  delta_E= -5.89e-06  |g|= 0.000228  |ddm|= 0.00926
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00018581
diis-c [-2.00657060e-09 -1.12015517e-05  8.48958085e-03 -9.55086925e-02
  1.08703031e+00]
  HOMO = -0.243487235865825  LUMO = 0.496227194146024
  mo_energy =
[-1.20328953e+02 -1.23822044e+01 -6.67941500e+00 -6.67941500e+00
 -6.67941500e+00 -1.17994428e+00 -2.43487236e-01 -2.43487236e-01
 -2.43487236e-01  4.96227194e-01  2.46270432e+00  1.30309227e+01
  6.65447675e+01  2.60628777e+02  8.89316497e+02  3.14285831e+03
  1.26232452e+04  4.12204111e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.6606011782267  E_coul = 198.6704746640477
cycle= 5 E= -507.990126514179  delta_E= -1.61e-08  |g|= 1.38e-05  |ddm|= 0.000937
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.52276e-06
diis-c [-2.47170487e-12  1.09594298e-06 -1.05128004e-03  1.13825483e-02
 -1.45157188e-01  1.13482482e+00]
  HOMO = -0.243490189732264  LUMO = 0.496226531304586
  mo_energy =
[-1.20328956e+02 -1.23822076e+01 -6.67941820e+00 -6.67941820e+00
 -6.67941820e+00 -1.17994653e+00 -2.43490190e-01 -2.43490190e-01
 -2.43490190e-01  4.96226531e-01  2.46270097e+00  1.30309189e+01
  6.65447642e+01  2.60628774e+02  8.89316494e+02  3.14285830e+03
  1.26232452e+04  4.12204111e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.6605827781955  E_coul = 198.67045626396575
cycle= 6 E= -507.99012651423  delta_E= -5.07e-11  |g|= 8.09e-08  |ddm|= 6.92e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6605827781955  E_coul = 198.67045626396575
  HOMO = -0.243490213411881  LUMO = 0.496226509389704
  mo_energy =
[-1.20328956e+02 -1.23822076e+01 -6.67941823e+00 -6.67941823e+00
 -6.67941823e+00 -1.17994652e+00 -2.43490213e-01 -2.43490213e-01
 -2.43490213e-01  4.96226509e-01  2.46270093e+00  1.30309189e+01
  6.65447642e+01  2.60628774e+02  8.89316494e+02  3.14285830e+03
  1.26232452e+04  4.12204111e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.6605827129158  E_coul = 198.67045619868597
Extra cycle  E= -507.99012651423  delta_E= -1.14e-13  |g|= 9.43e-09  |ddm|= 2.81e-07
    CPU time for scf_cycle      1.58 sec, wall time      0.29 sec
exp = [1.74580893e-01 3.81174935e-01 7.46405111e-01 1.17616813e+05
 3.10499441e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232152e+03
 1.83757713e+04 1.44352860e+03 4.17362306e+02 1.47784126e+02
 5.84525729e+01 2.45580492e+01 7.56903177e+00 8.60360957e+00
 4.92627037e-01]
E = -507.9901265142298
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.1745808929         1
[INPUT] 0    0    [1    /1   ]  0.381174935127       1
[INPUT] 0    0    [1    /1   ]  0.746405110719       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.10499440916        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175482        1
[INPUT] 0    0    [1    /1   ]  36754.7015352        1
[INPUT] 0    0    [1    /1   ]  7302.3215161         1
[INPUT] 0    0    [1    /1   ]  18375.7713408        1
[INPUT] 0    0    [1    /1   ]  1443.52859998        1
[INPUT] 0    0    [1    /1   ]  417.362306306        1
[INPUT] 0    0    [1    /1   ]  147.784125598        1
[INPUT] 0    0    [1    /1   ]  58.4525729044        1
[INPUT] 0    0    [1    /1   ]  24.5580491766        1
[INPUT] 0    0    [1    /1   ]  7.5690317744         1
[INPUT] 1    0    [1    /1   ]  8.60360956983        1
[INPUT] 1    0    [1    /1   ]  0.4926270369         1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.1745808928998835, 1.0]], [0, [0.3811749351272814, 1.0]], [0, [0.7464051107186979, 1.0]], [0, [117616.81288943192, 1.0]], [0, [3.1049944091620487, 1.0]], [0, [1176168.1426134522, 1.0]], [0, [588084.0699565579, 1.0]], [0, [294042.0309214241, 1.0]], [0, [147020.99132327278, 1.0]], [0, [73510.4175482011, 1.0]], [0, [36754.70153516202, 1.0]], [0, [7302.321516102182, 1.0]], [0, [18375.771340837164, 1.0]], [0, [1443.5285999839377, 1.0]], [0, [417.36230630631957, 1.0]], [0, [147.78412559763717, 1.0]], [0, [58.45257290435091, 1.0]], [0, [24.558049176570236, 1.0]], [0, [7.569031774403724, 1.0]], [1, [8.603609569826903, 1.0]], [1, [0.4926270368996085, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.17458089]
bas 1, expnt(s) = [0.38117494]
bas 2, expnt(s) = [0.74640511]
bas 3, expnt(s) = [117616.81288943]
bas 4, expnt(s) = [3.10499441]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995656]
bas 7, expnt(s) = [294042.03092142]
bas 8, expnt(s) = [147020.99132327]
bas 9, expnt(s) = [73510.4175482]
bas 10, expnt(s) = [36754.70153516]
bas 11, expnt(s) = [7302.3215161]
bas 12, expnt(s) = [18375.77134084]
bas 13, expnt(s) = [1443.52859998]
bas 14, expnt(s) = [417.36230631]
bas 15, expnt(s) = [147.7841256]
bas 16, expnt(s) = [58.4525729]
bas 17, expnt(s) = [24.55804918]
bas 18, expnt(s) = [7.56903177]
bas 19, expnt(s) = [8.60360957]
bas 20, expnt(s) = [0.49262704]
CPU time:       233.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.74580893e-01 6.82358423e-01 3.81174935e-01 1.22562688e+00
 7.46405111e-01 2.02883149e+00 1.17616813e+05 1.60460108e+04
 3.10499441e+00 5.90963477e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232152e+03 1.99577114e+03
 1.83757713e+04 3.98748634e+03 1.44352860e+03 5.91676157e+02
 4.17362306e+02 2.33292051e+02 1.47784126e+02 1.07086781e+02
 5.84525729e+01 5.34094061e+01 2.45580492e+01 2.78715052e+01
 7.56903177e+00 1.15290964e+01 8.60360957e+00 4.29868142e+01
 4.92627037e-01 1.20401583e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336356681142185
cond(S) = 912195.0587676888
E1 = -689.5875823613368  E_coul = 184.96595306715153
init E= -504.621629294185
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672213896861  LUMO = 0.233846599651518
  mo_energy =
[-1.21710689e+02 -1.33864751e+01 -7.62396352e+00 -7.62396352e+00
 -7.62396352e+00 -1.65765462e+00 -6.72213897e-01 -6.72213897e-01
 -6.72213897e-01  2.33846600e-01  2.02862212e+00  1.22221690e+01
  6.53714107e+01  2.59289830e+02  8.87957705e+02  3.14157475e+03
  1.26220789e+04  4.12193160e+04  1.05247554e+05  2.30420708e+05
  4.56228238e+05  8.45174866e+05  1.52834668e+06  2.85060736e+06
  5.80848603e+06]
E1 = -707.7398098586956  E_coul = 199.76769177886982
cycle= 1 E= -507.972118079826  delta_E= -3.35  |g|= 0.451  |ddm|= 0.43
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.734682
diis-c [-0.53975778  1.        ]
  HOMO = -0.21782003172152  LUMO = 0.497440345034986
  mo_energy =
[-1.20202194e+02 -1.23056158e+01 -6.59512656e+00 -6.59512656e+00
 -6.59512656e+00 -1.16352412e+00 -2.17820032e-01 -2.17820032e-01
 -2.17820032e-01  4.97440345e-01  2.47827618e+00  1.30860308e+01
  6.66371868e+01  2.60744887e+02  8.89449266e+02  3.14300599e+03
  1.26234035e+04  4.12205734e+04  1.05248775e+05  2.30421903e+05
  4.56229417e+05  8.45176032e+05  1.52834783e+06  2.85060851e+06
  5.80848717e+06]
E1 = -706.7881529975454  E_coul = 198.79830571447178
cycle= 2 E= -507.989847283074  delta_E= -0.0177  |g|= 0.0351  |ddm|= 0.34
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0388325
diis-c [-0.00149822 -0.00427256  1.00427256]
  HOMO = -0.240082903238913  LUMO = 0.496525842062161
  mo_energy =
[-1.20316822e+02 -1.23731967e+01 -6.66994225e+00 -6.66994225e+00
 -6.66994225e+00 -1.17787205e+00 -2.40082903e-01 -2.40082903e-01
 -2.40082903e-01  4.96525842e-01  2.46507005e+00  1.30378164e+01
  6.65547414e+01  2.60640268e+02  8.89328866e+02  3.14287135e+03
  1.26232587e+04  4.12204247e+04  1.05248625e+05  2.30421752e+05
  4.56229265e+05  8.45175880e+05  1.52834768e+06  2.85060836e+06
  5.80848702e+06]
E1 = -706.6775996495023  E_coul = 198.6874790447461
cycle= 3 E= -507.990120604756  delta_E= -0.000273  |g|= 0.00445  |ddm|= 0.0437
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00485134
diis-c [-3.75939738e-06 -3.03431637e-04 -1.28546517e-01  1.12884995e+00]
  HOMO = -0.243382642339535  LUMO = 0.496245899515912
  mo_energy =
[-1.20328840e+02 -1.23820157e+01 -6.67924329e+00 -6.67924329e+00
 -6.67924329e+00 -1.17988019e+00 -2.43382642e-01 -2.43382642e-01
 -2.43382642e-01  4.96245900e-01  2.46279778e+00  1.30310959e+01
  6.65449253e+01  2.60628905e+02  8.89316603e+02  3.14285840e+03
  1.26232452e+04  4.12204112e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.66114115517  E_coul = 198.67101465709266
cycle= 4 E= -507.990126498077  delta_E= -5.89e-06  |g|= 0.000228  |ddm|= 0.00926
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00018581
diis-c [-2.00657060e-09 -1.12015517e-05  8.48958085e-03 -9.55086925e-02
  1.08703031e+00]
  HOMO = -0.243487235865825  LUMO = 0.496227194146024
  mo_energy =
[-1.20328953e+02 -1.23822044e+01 -6.67941500e+00 -6.67941500e+00
 -6.67941500e+00 -1.17994428e+00 -2.43487236e-01 -2.43487236e-01
 -2.43487236e-01  4.96227194e-01  2.46270432e+00  1.30309227e+01
  6.65447675e+01  2.60628777e+02  8.89316497e+02  3.14285831e+03
  1.26232452e+04  4.12204111e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.6606011782267  E_coul = 198.6704746640477
cycle= 5 E= -507.990126514179  delta_E= -1.61e-08  |g|= 1.38e-05  |ddm|= 0.000937
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.52276e-06
diis-c [-2.47170487e-12  1.09594298e-06 -1.05128004e-03  1.13825483e-02
 -1.45157188e-01  1.13482482e+00]
  HOMO = -0.243490189732264  LUMO = 0.496226531304586
  mo_energy =
[-1.20328956e+02 -1.23822076e+01 -6.67941820e+00 -6.67941820e+00
 -6.67941820e+00 -1.17994653e+00 -2.43490190e-01 -2.43490190e-01
 -2.43490190e-01  4.96226531e-01  2.46270097e+00  1.30309189e+01
  6.65447642e+01  2.60628774e+02  8.89316494e+02  3.14285830e+03
  1.26232452e+04  4.12204111e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.6605827781955  E_coul = 198.67045626396575
cycle= 6 E= -507.99012651423  delta_E= -5.07e-11  |g|= 8.09e-08  |ddm|= 6.92e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6605827781955  E_coul = 198.67045626396575
  HOMO = -0.243490213411881  LUMO = 0.496226509389704
  mo_energy =
[-1.20328956e+02 -1.23822076e+01 -6.67941823e+00 -6.67941823e+00
 -6.67941823e+00 -1.17994652e+00 -2.43490213e-01 -2.43490213e-01
 -2.43490213e-01  4.96226509e-01  2.46270093e+00  1.30309189e+01
  6.65447642e+01  2.60628774e+02  8.89316494e+02  3.14285830e+03
  1.26232452e+04  4.12204111e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.6605827129158  E_coul = 198.67045619868597
Extra cycle  E= -507.99012651423  delta_E= -1.14e-13  |g|= 9.43e-09  |ddm|= 2.81e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912195.0587676888
E1 = -706.6605827129158  E_coul = 198.67045619868597
init E= -507.99012651423
    CPU time for initialize scf      5.91 sec, wall time      0.25 sec
  HOMO = -0.243490216259769  LUMO = 0.49622650788508
  mo_energy =
[-1.20328956e+02 -1.23822076e+01 -6.67941823e+00 -6.67941823e+00
 -6.67941823e+00 -1.17994653e+00 -2.43490216e-01 -2.43490216e-01
 -2.43490216e-01  4.96226508e-01  2.46270093e+00  1.30309189e+01
  6.65447642e+01  2.60628774e+02  8.89316494e+02  3.14285830e+03
  1.26232452e+04  4.12204111e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.6605827030202  E_coul = 198.67045618879072
cycle= 1 E= -507.990126514229  delta_E= 3.41e-13  |g|= 4.37e-09  |ddm|= 3.47e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6605827030202  E_coul = 198.67045618879072
  HOMO = -0.243490216664234  LUMO = 0.49622650752125
  mo_energy =
[-1.20328956e+02 -1.23822076e+01 -6.67941823e+00 -6.67941823e+00
 -6.67941823e+00 -1.17994653e+00 -2.43490217e-01 -2.43490217e-01
 -2.43490217e-01  4.96226508e-01  2.46270093e+00  1.30309189e+01
  6.65447642e+01  2.60628774e+02  8.89316494e+02  3.14285830e+03
  1.26232452e+04  4.12204111e+04  1.05248611e+05  2.30421739e+05
  4.56229252e+05  8.45175866e+05  1.52834767e+06  2.85060834e+06
  5.80848700e+06]
E1 = -706.6605826980937  E_coul = 198.6704561838643
Extra cycle  E= -507.990126514229  delta_E= 1.14e-13  |g|= 1.49e-09  |ddm|= 6.79e-09
    CPU time for scf_cycle      6.41 sec, wall time      0.42 sec
exp = [1.74580893e-01 3.81174935e-01 7.46405111e-01 1.17616813e+05
 3.10499441e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232152e+03
 1.83757713e+04 1.44352860e+03 4.17362306e+02 1.47784126e+02
 5.84525729e+01 2.45580492e+01 7.56903177e+00 8.60360957e+00
 4.92627037e-01]
grad_E = [-1.63076722e-03  9.95181629e-04 -1.93111889e-03  6.07454720e-09
  2.10352398e-04  4.05774480e-11  1.74558407e-10  9.42185224e-10
  3.72275625e-09  1.55460201e-08  8.10762604e-08  5.11035221e-06
  1.98880492e-07 -3.88357545e-05 -2.67152036e-06 -1.35197827e-05
  5.24481746e-05 -7.12246206e-05 -7.19093657e-04 -4.67331487e-04
 -4.56611617e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.19294866211        1
[INPUT] 0    0    [1    /1   ]  0.411231354325       1
[INPUT] 0    0    [1    /1   ]  0.77075841459        1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.12300948239        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175479        1
[INPUT] 0    0    [1    /1   ]  36754.7015336        1
[INPUT] 0    0    [1    /1   ]  7302.32141947        1
[INPUT] 0    0    [1    /1   ]  18375.7713371        1
[INPUT] 0    0    [1    /1   ]  1443.52933156        1
[INPUT] 0    0    [1    /1   ]  417.362390726        1
[INPUT] 0    0    [1    /1   ]  147.784195231        1
[INPUT] 0    0    [1    /1   ]  58.4523713291        1
[INPUT] 0    0    [1    /1   ]  24.5582942096        1
[INPUT] 0    0    [1    /1   ]  7.56826787964        1
[INPUT] 1    0    [1    /1   ]  8.60439964411        1
[INPUT] 1    0    [1    /1   ]  0.492846773902       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19294866210975892, 1.0]], [0, [0.4112313543247666, 1.0]], [0, [0.7707584145895521, 1.0]], [0, [117616.81288931707, 1.0]], [0, [3.12300948238619, 1.0]], [0, [1176168.1426134515, 1.0]], [0, [588084.0699565547, 1.0]], [0, [294042.0309214063, 1.0]], [0, [147020.99132320238, 1.0]], [0, [73510.41754790717, 1.0]], [0, [36754.70153362899, 1.0]], [0, [7302.321419474799, 1.0]], [0, [18375.77133707758, 1.0]], [0, [1443.5293315599242, 1.0]], [0, [417.3623907258814, 1.0]], [0, [147.78419523076406, 1.0]], [0, [58.45237132908529, 1.0]], [0, [24.55829420962387, 1.0]], [0, [7.568267879638134, 1.0]], [1, [8.604399644107264, 1.0]], [1, [0.4928467739016639, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19294866]
bas 1, expnt(s) = [0.41123135]
bas 2, expnt(s) = [0.77075841]
bas 3, expnt(s) = [117616.81288932]
bas 4, expnt(s) = [3.12300948]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995655]
bas 7, expnt(s) = [294042.03092141]
bas 8, expnt(s) = [147020.9913232]
bas 9, expnt(s) = [73510.41754791]
bas 10, expnt(s) = [36754.70153363]
bas 11, expnt(s) = [7302.32141947]
bas 12, expnt(s) = [18375.77133708]
bas 13, expnt(s) = [1443.52933156]
bas 14, expnt(s) = [417.36239073]
bas 15, expnt(s) = [147.78419523]
bas 16, expnt(s) = [58.45237133]
bas 17, expnt(s) = [24.55829421]
bas 18, expnt(s) = [7.56826788]
bas 19, expnt(s) = [8.60439964]
bas 20, expnt(s) = [0.49284677]
CPU time:       247.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.92948662e-01 7.35523161e-01 4.11231354e-01 1.29741731e+00
 7.70758415e-01 2.07827843e+00 1.17616813e+05 1.60460108e+04
 3.12300948e+00 5.93533179e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232142e+03 1.99577112e+03
 1.83757713e+04 3.98748633e+03 1.44352933e+03 5.91676382e+02
 4.17362391e+02 2.33292087e+02 1.47784195e+02 1.07086819e+02
 5.84523713e+01 5.34092679e+01 2.45582942e+01 2.78717137e+01
 7.56826788e+00 1.15282237e+01 8.60439964e+00 4.29917486e+01
 4.92846774e-01 1.20468718e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336042614016243
cond(S) = 912210.0800131329
E1 = -689.599266179187  E_coul = 184.97743277518956
init E= -504.621833403997
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.671929681540051  LUMO = 0.283705934966095
  mo_energy =
[-1.21709267e+02 -1.33855353e+01 -7.62322056e+00 -7.62322056e+00
 -7.62322056e+00 -1.65745320e+00 -6.71929682e-01 -6.71929682e-01
 -6.71929682e-01  2.83705935e-01  2.23504747e+00  1.26080332e+01
  6.57674069e+01  2.59642526e+02  8.88271259e+02  3.14185491e+03
  1.26223271e+04  4.12195464e+04  1.05247775e+05  2.30420922e+05
  4.56228449e+05  8.45175073e+05  1.52834688e+06  2.85060756e+06
  5.80848623e+06]
E1 = -707.7563583024032  E_coul = 199.78422735535668
cycle= 1 E= -507.972130947047  delta_E= -3.35  |g|= 0.452  |ddm|= 0.443
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.731489
diis-c [-0.53507655  1.        ]
  HOMO = -0.217315419612052  LUMO = 0.55937871628227
  mo_energy =
[-1.20200360e+02 -1.23043416e+01 -6.59404266e+00 -6.59404266e+00
 -6.59404266e+00 -1.16314639e+00 -2.17315420e-01 -2.17315420e-01
 -2.17315420e-01  5.59378716e-01  2.69625512e+00  1.34728478e+01
  6.70328989e+01  2.61097788e+02  8.89763184e+02  3.14328655e+03
  1.26236521e+04  4.12208042e+04  1.05248996e+05  2.30422119e+05
  4.56229628e+05  8.45176239e+05  1.52834804e+06  2.85060871e+06
  5.80848736e+06]
E1 = -706.8045642728188  E_coul = 198.8146886921106
cycle= 2 E= -507.989875580708  delta_E= -0.0177  |g|= 0.0351  |ddm|= 0.326
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0378256
diis-c [-0.00142439 -0.00347328  1.00347328]
  HOMO = -0.239542546045625  LUMO = 0.558212190556065
  mo_energy =
[-1.20314947e+02 -1.23718893e+01 -6.66882460e+00 -6.66882460e+00
 -6.66882460e+00 -1.17746204e+00 -2.39542546e-01 -2.39542546e-01
 -2.39542546e-01  5.58212191e-01  2.68204589e+00  1.34243904e+01
  6.69505064e+01  2.60993221e+02  8.89642831e+02  3.14315196e+03
  1.26235073e+04  4.12206556e+04  1.05248846e+05  2.30421968e+05
  4.56229476e+05  8.45176087e+05  1.52834789e+06  2.85060856e+06
  5.80848721e+06]
E1 = -706.6946227532419  E_coul = 198.70447635505244
cycle= 3 E= -507.990146398189  delta_E= -0.000271  |g|= 0.00445  |ddm|= 0.0455
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00465729
diis-c [-3.52070311e-06 -2.83358773e-04 -1.26351727e-01  1.12663509e+00]
  HOMO = -0.242827828307154  LUMO = 0.557882700848595
  mo_energy =
[-1.20326974e+02 -1.23806939e+01 -6.67811501e+00 -6.67811501e+00
 -6.67811501e+00 -1.17946047e+00 -2.42827828e-01 -2.42827828e-01
 -2.42827828e-01  5.57882701e-01  2.67964089e+00  1.34176627e+01
  6.69406995e+01  2.60981855e+02  8.89630557e+02  3.14313898e+03
  1.26234938e+04  4.12206419e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176074e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.6783192927774  E_coul = 198.68816711182828
cycle= 4 E= -507.990152180949  delta_E= -5.78e-06  |g|= 0.000227  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176589
diis-c [-1.65504766e-09 -1.08793050e-05  8.25401080e-03 -9.42314674e-02
  1.08598834e+00]
  HOMO = -0.242936400681767  LUMO = 0.55786154906745
  mo_energy =
[-1.20327108e+02 -1.23808962e+01 -6.67830160e+00 -6.67830160e+00
 -6.67830160e+00 -1.17952692e+00 -2.42936401e-01 -2.42936401e-01
 -2.42936401e-01  5.57861549e-01  2.67954129e+00  1.34174801e+01
  6.69405256e+01  2.60981708e+02  8.89630429e+02  3.14313887e+03
  1.26234937e+04  4.12206418e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176073e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.6777665356244  E_coul = 198.68761433928242
cycle= 5 E= -507.990152196342  delta_E= -1.54e-08  |g|= 1.3e-05  |ddm|= 0.000984
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.83729e-06
diis-c [-2.25660689e-12  1.03034294e-06 -1.00755703e-03  1.10472959e-02
 -1.41373989e-01  1.13133322e+00]
  HOMO = -0.242939672072163  LUMO = 0.557860806740009
  mo_energy =
[-1.20327112e+02 -1.23809004e+01 -6.67830585e+00 -6.67830585e+00
 -6.67830585e+00 -1.17952934e+00 -2.42939672e-01 -2.42939672e-01
 -2.42939672e-01  5.57860807e-01  2.67953771e+00  1.34174756e+01
  6.69405213e+01  2.60981704e+02  8.89630424e+02  3.14313886e+03
  1.26234937e+04  4.12206418e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176073e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.677747259667  E_coul = 198.687595063281
cycle= 6 E= -507.990152196386  delta_E= -4.39e-11  |g|= 7.81e-08  |ddm|= 6.81e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.677747259667  E_coul = 198.687595063281
  HOMO = -0.24293969857065  LUMO = 0.557860783020792
  mo_energy =
[-1.20327112e+02 -1.23809005e+01 -6.67830589e+00 -6.67830589e+00
 -6.67830589e+00 -1.17952934e+00 -2.42939699e-01 -2.42939699e-01
 -2.42939699e-01  5.57860783e-01  2.67953767e+00  1.34174756e+01
  6.69405212e+01  2.60981704e+02  8.89630424e+02  3.14313886e+03
  1.26234937e+04  4.12206418e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176073e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.6777471783644  E_coul = 198.68759498197895
Extra cycle  E= -507.990152196385  delta_E= 4.55e-13  |g|= 9.49e-09  |ddm|= 2.75e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [1.92948662e-01 4.11231354e-01 7.70758415e-01 1.17616813e+05
 3.12300948e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232142e+03
 1.83757713e+04 1.44352933e+03 4.17362391e+02 1.47784195e+02
 5.84523713e+01 2.45582942e+01 7.56826788e+00 8.60439964e+00
 4.92846774e-01]
E = -507.99015219638545
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.19294866211        1
[INPUT] 0    0    [1    /1   ]  0.411231354325       1
[INPUT] 0    0    [1    /1   ]  0.77075841459        1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.12300948239        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175479        1
[INPUT] 0    0    [1    /1   ]  36754.7015336        1
[INPUT] 0    0    [1    /1   ]  7302.32141947        1
[INPUT] 0    0    [1    /1   ]  18375.7713371        1
[INPUT] 0    0    [1    /1   ]  1443.52933156        1
[INPUT] 0    0    [1    /1   ]  417.362390726        1
[INPUT] 0    0    [1    /1   ]  147.784195231        1
[INPUT] 0    0    [1    /1   ]  58.4523713291        1
[INPUT] 0    0    [1    /1   ]  24.5582942096        1
[INPUT] 0    0    [1    /1   ]  7.56826787964        1
[INPUT] 1    0    [1    /1   ]  8.60439964411        1
[INPUT] 1    0    [1    /1   ]  0.492846773902       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19294866210975892, 1.0]], [0, [0.4112313543247666, 1.0]], [0, [0.7707584145895521, 1.0]], [0, [117616.81288931707, 1.0]], [0, [3.12300948238619, 1.0]], [0, [1176168.1426134515, 1.0]], [0, [588084.0699565547, 1.0]], [0, [294042.0309214063, 1.0]], [0, [147020.99132320238, 1.0]], [0, [73510.41754790717, 1.0]], [0, [36754.70153362899, 1.0]], [0, [7302.321419474799, 1.0]], [0, [18375.77133707758, 1.0]], [0, [1443.5293315599242, 1.0]], [0, [417.3623907258814, 1.0]], [0, [147.78419523076406, 1.0]], [0, [58.45237132908529, 1.0]], [0, [24.55829420962387, 1.0]], [0, [7.568267879638134, 1.0]], [1, [8.604399644107264, 1.0]], [1, [0.4928467739016639, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19294866]
bas 1, expnt(s) = [0.41123135]
bas 2, expnt(s) = [0.77075841]
bas 3, expnt(s) = [117616.81288932]
bas 4, expnt(s) = [3.12300948]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995655]
bas 7, expnt(s) = [294042.03092141]
bas 8, expnt(s) = [147020.9913232]
bas 9, expnt(s) = [73510.41754791]
bas 10, expnt(s) = [36754.70153363]
bas 11, expnt(s) = [7302.32141947]
bas 12, expnt(s) = [18375.77133708]
bas 13, expnt(s) = [1443.52933156]
bas 14, expnt(s) = [417.36239073]
bas 15, expnt(s) = [147.78419523]
bas 16, expnt(s) = [58.45237133]
bas 17, expnt(s) = [24.55829421]
bas 18, expnt(s) = [7.56826788]
bas 19, expnt(s) = [8.60439964]
bas 20, expnt(s) = [0.49284677]
CPU time:       249.62
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.92948662e-01 7.35523161e-01 4.11231354e-01 1.29741731e+00
 7.70758415e-01 2.07827843e+00 1.17616813e+05 1.60460108e+04
 3.12300948e+00 5.93533179e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232142e+03 1.99577112e+03
 1.83757713e+04 3.98748633e+03 1.44352933e+03 5.91676382e+02
 4.17362391e+02 2.33292087e+02 1.47784195e+02 1.07086819e+02
 5.84523713e+01 5.34092679e+01 2.45582942e+01 2.78717137e+01
 7.56826788e+00 1.15282237e+01 8.60439964e+00 4.29917486e+01
 4.92846774e-01 1.20468718e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336042614016243
cond(S) = 912210.0800131329
E1 = -689.599266179187  E_coul = 184.97743277518956
init E= -504.621833403997
    CPU time for initialize scf      0.66 sec, wall time      0.07 sec
  HOMO = -0.671929681540051  LUMO = 0.283705934966095
  mo_energy =
[-1.21709267e+02 -1.33855353e+01 -7.62322056e+00 -7.62322056e+00
 -7.62322056e+00 -1.65745320e+00 -6.71929682e-01 -6.71929682e-01
 -6.71929682e-01  2.83705935e-01  2.23504747e+00  1.26080332e+01
  6.57674069e+01  2.59642526e+02  8.88271259e+02  3.14185491e+03
  1.26223271e+04  4.12195464e+04  1.05247775e+05  2.30420922e+05
  4.56228449e+05  8.45175073e+05  1.52834688e+06  2.85060756e+06
  5.80848623e+06]
E1 = -707.7563583024032  E_coul = 199.78422735535668
cycle= 1 E= -507.972130947047  delta_E= -3.35  |g|= 0.452  |ddm|= 0.443
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.731489
diis-c [-0.53507655  1.        ]
  HOMO = -0.217315419612052  LUMO = 0.55937871628227
  mo_energy =
[-1.20200360e+02 -1.23043416e+01 -6.59404266e+00 -6.59404266e+00
 -6.59404266e+00 -1.16314639e+00 -2.17315420e-01 -2.17315420e-01
 -2.17315420e-01  5.59378716e-01  2.69625512e+00  1.34728478e+01
  6.70328989e+01  2.61097788e+02  8.89763184e+02  3.14328655e+03
  1.26236521e+04  4.12208042e+04  1.05248996e+05  2.30422119e+05
  4.56229628e+05  8.45176239e+05  1.52834804e+06  2.85060871e+06
  5.80848736e+06]
E1 = -706.8045642728188  E_coul = 198.8146886921106
cycle= 2 E= -507.989875580708  delta_E= -0.0177  |g|= 0.0351  |ddm|= 0.326
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0378256
diis-c [-0.00142439 -0.00347328  1.00347328]
  HOMO = -0.239542546045625  LUMO = 0.558212190556065
  mo_energy =
[-1.20314947e+02 -1.23718893e+01 -6.66882460e+00 -6.66882460e+00
 -6.66882460e+00 -1.17746204e+00 -2.39542546e-01 -2.39542546e-01
 -2.39542546e-01  5.58212191e-01  2.68204589e+00  1.34243904e+01
  6.69505064e+01  2.60993221e+02  8.89642831e+02  3.14315196e+03
  1.26235073e+04  4.12206556e+04  1.05248846e+05  2.30421968e+05
  4.56229476e+05  8.45176087e+05  1.52834789e+06  2.85060856e+06
  5.80848721e+06]
E1 = -706.6946227532419  E_coul = 198.70447635505244
cycle= 3 E= -507.990146398189  delta_E= -0.000271  |g|= 0.00445  |ddm|= 0.0455
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00465729
diis-c [-3.52070311e-06 -2.83358773e-04 -1.26351727e-01  1.12663509e+00]
  HOMO = -0.242827828307154  LUMO = 0.557882700848595
  mo_energy =
[-1.20326974e+02 -1.23806939e+01 -6.67811501e+00 -6.67811501e+00
 -6.67811501e+00 -1.17946047e+00 -2.42827828e-01 -2.42827828e-01
 -2.42827828e-01  5.57882701e-01  2.67964089e+00  1.34176627e+01
  6.69406995e+01  2.60981855e+02  8.89630557e+02  3.14313898e+03
  1.26234938e+04  4.12206419e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176074e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.6783192927774  E_coul = 198.68816711182828
cycle= 4 E= -507.990152180949  delta_E= -5.78e-06  |g|= 0.000227  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176589
diis-c [-1.65504766e-09 -1.08793050e-05  8.25401080e-03 -9.42314674e-02
  1.08598834e+00]
  HOMO = -0.242936400681767  LUMO = 0.55786154906745
  mo_energy =
[-1.20327108e+02 -1.23808962e+01 -6.67830160e+00 -6.67830160e+00
 -6.67830160e+00 -1.17952692e+00 -2.42936401e-01 -2.42936401e-01
 -2.42936401e-01  5.57861549e-01  2.67954129e+00  1.34174801e+01
  6.69405256e+01  2.60981708e+02  8.89630429e+02  3.14313887e+03
  1.26234937e+04  4.12206418e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176073e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.6777665356244  E_coul = 198.68761433928242
cycle= 5 E= -507.990152196342  delta_E= -1.54e-08  |g|= 1.3e-05  |ddm|= 0.000984
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.83729e-06
diis-c [-2.25660689e-12  1.03034294e-06 -1.00755703e-03  1.10472959e-02
 -1.41373989e-01  1.13133322e+00]
  HOMO = -0.242939672072163  LUMO = 0.557860806740009
  mo_energy =
[-1.20327112e+02 -1.23809004e+01 -6.67830585e+00 -6.67830585e+00
 -6.67830585e+00 -1.17952934e+00 -2.42939672e-01 -2.42939672e-01
 -2.42939672e-01  5.57860807e-01  2.67953771e+00  1.34174756e+01
  6.69405213e+01  2.60981704e+02  8.89630424e+02  3.14313886e+03
  1.26234937e+04  4.12206418e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176073e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.677747259667  E_coul = 198.687595063281
cycle= 6 E= -507.990152196386  delta_E= -4.39e-11  |g|= 7.81e-08  |ddm|= 6.81e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.677747259667  E_coul = 198.687595063281
  HOMO = -0.24293969857065  LUMO = 0.557860783020792
  mo_energy =
[-1.20327112e+02 -1.23809005e+01 -6.67830589e+00 -6.67830589e+00
 -6.67830589e+00 -1.17952934e+00 -2.42939699e-01 -2.42939699e-01
 -2.42939699e-01  5.57860783e-01  2.67953767e+00  1.34174756e+01
  6.69405212e+01  2.60981704e+02  8.89630424e+02  3.14313886e+03
  1.26234937e+04  4.12206418e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176073e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.6777471783644  E_coul = 198.68759498197895
Extra cycle  E= -507.990152196385  delta_E= 4.55e-13  |g|= 9.49e-09  |ddm|= 2.75e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912210.0800131329
E1 = -706.6777471783644  E_coul = 198.68759498197895
init E= -507.990152196385
    CPU time for initialize scf      7.77 sec, wall time      0.33 sec
  HOMO = -0.242939701802576  LUMO = 0.557860783178066
  mo_energy =
[-1.20327112e+02 -1.23809005e+01 -6.67830590e+00 -6.67830590e+00
 -6.67830590e+00 -1.17952934e+00 -2.42939702e-01 -2.42939702e-01
 -2.42939702e-01  5.57860783e-01  2.67953767e+00  1.34174755e+01
  6.69405212e+01  2.60981704e+02  8.89630424e+02  3.14313886e+03
  1.26234937e+04  4.12206418e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176073e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.6777471609466  E_coul = 198.68759496456104
cycle= 1 E= -507.990152196386  delta_E= -1.14e-13  |g|= 1.49e-09  |ddm|= 4.16e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6777471609466  E_coul = 198.68759496456104
  HOMO = -0.242939702423945  LUMO = 0.557860782763461
  mo_energy =
[-1.20327112e+02 -1.23809005e+01 -6.67830590e+00 -6.67830590e+00
 -6.67830590e+00 -1.17952934e+00 -2.42939702e-01 -2.42939702e-01
 -2.42939702e-01  5.57860783e-01  2.67953767e+00  1.34174755e+01
  6.69405212e+01  2.60981704e+02  8.89630424e+02  3.14313886e+03
  1.26234937e+04  4.12206418e+04  1.05248832e+05  2.30421954e+05
  4.56229462e+05  8.45176073e+05  1.52834787e+06  2.85060854e+06
  5.80848720e+06]
E1 = -706.6777471603964  E_coul = 198.68759496401103
Extra cycle  E= -507.990152196385  delta_E= 2.27e-13  |g|= 2.14e-09  |ddm|= 3.98e-09
    CPU time for scf_cycle      8.31 sec, wall time      0.51 sec
exp = [1.92948662e-01 4.11231354e-01 7.70758415e-01 1.17616813e+05
 3.12300948e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232142e+03
 1.83757713e+04 1.44352933e+03 4.17362391e+02 1.47784195e+02
 5.84523713e+01 2.45582942e+01 7.56826788e+00 8.60439964e+00
 4.92846774e-01]
grad_E = [ 1.33132861e-03 -4.38629604e-04 -1.17571037e-03  6.07598042e-09
  7.56131828e-04  4.05934977e-11  1.74605516e-10  9.42404777e-10
  3.72364420e-09  1.55497789e-08  8.10943611e-08  5.11151843e-06
  1.98940199e-07 -3.88889592e-05 -2.12008385e-06 -1.65551750e-05
  6.54991782e-05 -8.91912919e-05 -9.62056315e-04 -1.66213053e-05
  3.35403536e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:38 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.196632876394       1
[INPUT] 0    0    [1    /1   ]  0.42884365096        1
[INPUT] 0    0    [1    /1   ]  0.785789027052       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.13336379367        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175477        1
[INPUT] 0    0    [1    /1   ]  36754.7015327        1
[INPUT] 0    0    [1    /1   ]  7302.32135897        1
[INPUT] 0    0    [1    /1   ]  18375.7713347        1
[INPUT] 0    0    [1    /1   ]  1443.5297899         1
[INPUT] 0    0    [1    /1   ]  417.362440883        1
[INPUT] 0    0    [1    /1   ]  147.784253652        1
[INPUT] 0    0    [1    /1   ]  58.4521834716        1
[INPUT] 0    0    [1    /1   ]  24.5585337785        1
[INPUT] 0    0    [1    /1   ]  7.56874087106        1
[INPUT] 1    0    [1    /1   ]  8.60453575379        1
[INPUT] 1    0    [1    /1   ]  0.492814211987       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19663287639385676, 1.0]], [0, [0.42884365096029153, 1.0]], [0, [0.7857890270519707, 1.0]], [0, [117616.81288924514, 1.0]], [0, [3.1333637936694565, 1.0]], [0, [1176168.142613451, 1.0]], [0, [588084.0699565526, 1.0]], [0, [294042.0309213951, 1.0]], [0, [147020.9913231583, 1.0]], [0, [73510.4175477231, 1.0]], [0, [36754.701532668994, 1.0]], [0, [7302.321358965793, 1.0]], [0, [18375.77133472322, 1.0]], [0, [1443.529789899383, 1.0]], [0, [417.36244088294546, 1.0]], [0, [147.7842536524171, 1.0]], [0, [58.45218347158458, 1.0]], [0, [24.558533778496162, 1.0]], [0, [7.5687408710586075, 1.0]], [1, [8.604535753788431, 1.0]], [1, [0.49281421198737047, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19663288]
bas 1, expnt(s) = [0.42884365]
bas 2, expnt(s) = [0.78578903]
bas 3, expnt(s) = [117616.81288925]
bas 4, expnt(s) = [3.13336379]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995655]
bas 7, expnt(s) = [294042.0309214]
bas 8, expnt(s) = [147020.99132316]
bas 9, expnt(s) = [73510.41754772]
bas 10, expnt(s) = [36754.70153267]
bas 11, expnt(s) = [7302.32135897]
bas 12, expnt(s) = [18375.77133472]
bas 13, expnt(s) = [1443.5297899]
bas 14, expnt(s) = [417.36244088]
bas 15, expnt(s) = [147.78425365]
bas 16, expnt(s) = [58.45218347]
bas 17, expnt(s) = [24.55853378]
bas 18, expnt(s) = [7.56874087]
bas 19, expnt(s) = [8.60453575]
bas 20, expnt(s) = [0.49281421]
CPU time:       266.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.96632876e-01 7.46031428e-01 4.28843651e-01 1.33887263e+00
 7.85789027e-01 2.10860142e+00 1.17616813e+05 1.60460108e+04
 3.13336379e+00 5.95008459e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232136e+03 1.99577110e+03
 1.83757713e+04 3.98748633e+03 1.44352979e+03 5.91676523e+02
 4.17362441e+02 2.33292108e+02 1.47784254e+02 1.07086851e+02
 5.84521835e+01 5.34091392e+01 2.45585338e+01 2.78719176e+01
 7.56874087e+00 1.15287641e+01 8.60453575e+00 4.29925987e+01
 4.92814212e-01 1.20458769e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336083629652016
cond(S) = 912217.4021351963
E1 = -689.5984372764891  E_coul = 184.9768268747242
init E= -504.621610401765
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.671974977149329  LUMO = 0.300627110980801
  mo_energy =
[-1.21709244e+02 -1.33855913e+01 -7.62325429e+00 -7.62325429e+00
 -7.62325429e+00 -1.65748533e+00 -6.71974977e-01 -6.71974977e-01
 -6.71974977e-01  3.00627111e-01  2.32692210e+00  1.28012473e+01
  6.59743350e+01  2.59828774e+02  8.88437141e+02  3.14200321e+03
  1.26224585e+04  4.12196684e+04  1.05247893e+05  2.30421036e+05
  4.56228560e+05  8.45175183e+05  1.52834699e+06  2.85060767e+06
  5.80848633e+06]
E1 = -707.7555853658589  E_coul = 199.7834534353482
cycle= 1 E= -507.972131930511  delta_E= -3.35  |g|= 0.452  |ddm|= 0.444
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.730765
diis-c [-0.53401697  1.        ]
  HOMO = -0.217393262713299  LUMO = 0.580655887054607
  mo_energy =
[-1.20200337e+02 -1.23043951e+01 -6.59406691e+00 -6.59406691e+00
 -6.59406691e+00 -1.16320243e+00 -2.17393263e-01 -2.17393263e-01
 -2.17393263e-01  5.80655887e-01  2.79390894e+00  1.36667061e+01
  6.72395285e+01  2.61283942e+02  8.89929043e+02  3.14343484e+03
  1.26237835e+04  4.12209262e+04  1.05249113e+05  2.30422232e+05
  4.56229739e+05  8.45176349e+05  1.52834815e+06  2.85060881e+06
  5.80848747e+06]
E1 = -706.8033616414186  E_coul = 198.813475508505
cycle= 2 E= -507.989886132914  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.321
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0376878
diis-c [-0.00141461 -0.00330059  1.00330059]
  HOMO = -0.239620599794079  LUMO = 0.57938180884081
  mo_energy =
[-1.20314955e+02 -1.23719674e+01 -6.66887558e+00 -6.66887558e+00
 -6.66887558e+00 -1.17751748e+00 -2.39620600e-01 -2.39620600e-01
 -2.39620600e-01  5.79381809e-01  2.77919358e+00  1.36180782e+01
  6.71571158e+01  2.61179351e+02  8.89808661e+02  3.14330022e+03
  1.26236387e+04  4.12207775e+04  1.05248963e+05  2.30422081e+05
  4.56229588e+05  8.45176197e+05  1.52834799e+06  2.85060866e+06
  5.80848732e+06]
E1 = -706.6935232427164  E_coul = 198.70336683851502
cycle= 3 E= -507.990156404201  delta_E= -0.00027  |g|= 0.00445  |ddm|= 0.0458
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0046329
diis-c [-3.49527969e-06 -2.77621919e-04 -1.26113624e-01  1.12639125e+00]
  HOMO = -0.242903883075358  LUMO = 0.579031120200338
  mo_energy =
[-1.20326989e+02 -1.23807731e+01 -6.67816831e+00 -6.67816831e+00
 -6.67816831e+00 -1.17951453e+00 -2.42903883e-01 -2.42903883e-01
 -2.42903883e-01  5.79031120e-01  2.77671811e+00  1.36113365e+01
  6.71473064e+01  2.61167979e+02  8.89796379e+02  3.14328723e+03
  1.26236253e+04  4.12207639e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.677255973681  E_coul = 198.68709382259237
cycle= 4 E= -507.990162151089  delta_E= -5.75e-06  |g|= 0.000225  |ddm|= 0.0103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000174336
diis-c [-1.56735401e-09 -1.10475304e-05  8.17812929e-03 -9.34750482e-02
  1.08530797e+00]
  HOMO = -0.24301225116763  LUMO = 0.57900911103101
  mo_energy =
[-1.20327124e+02 -1.23809757e+01 -6.67835537e+00 -6.67835537e+00
 -6.67835537e+00 -1.17958083e+00 -2.43012251e-01 -2.43012251e-01
 -2.43012251e-01  5.79009111e-01  2.77661677e+00  1.36111539e+01
  6.71471319e+01  2.61167831e+02  8.89796249e+02  3.14328712e+03
  1.26236251e+04  4.12207638e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.6767069516804  E_coul = 198.68654478572532
cycle= 5 E= -507.990162165955  delta_E= -1.49e-08  |g|= 1.26e-05  |ddm|= 0.000982
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.62607e-06
diis-c [-2.17704100e-12  9.99266369e-07 -9.89460665e-04  1.08526746e-02
 -1.39409492e-01  1.12954528e+00]
  HOMO = -0.243015518115931  LUMO = 0.5790083507603
  mo_energy =
[-1.20327129e+02 -1.23809801e+01 -6.67835970e+00 -6.67835970e+00
 -6.67835970e+00 -1.17958324e+00 -2.43015518e-01 -2.43015518e-01
 -2.43015518e-01  5.79008351e-01  2.77661317e+00  1.36111493e+01
  6.71471275e+01  2.61167827e+02  8.89796244e+02  3.14328711e+03
  1.26236251e+04  4.12207638e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.676687963454  E_coul = 198.68652579745898
cycle= 6 E= -507.990162165995  delta_E= -3.99e-11  |g|= 7.68e-08  |ddm|= 6.61e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.676687963454  E_coul = 198.68652579745898
  HOMO = -0.243015544679848  LUMO = 0.579008327228388
  mo_energy =
[-1.20327129e+02 -1.23809801e+01 -6.67835974e+00 -6.67835974e+00
 -6.67835974e+00 -1.17958323e+00 -2.43015545e-01 -2.43015545e-01
 -2.43015545e-01  5.79008327e-01  2.77661313e+00  1.36111493e+01
  6.71471274e+01  2.61167827e+02  8.89796244e+02  3.14328711e+03
  1.26236251e+04  4.12207638e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.6766878812949  E_coul = 198.68652571529964
Extra cycle  E= -507.990162165995  delta_E= -2.84e-13  |g|= 9.85e-09  |ddm|= 2.63e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [1.96632876e-01 4.28843651e-01 7.85789027e-01 1.17616813e+05
 3.13336379e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232136e+03
 1.83757713e+04 1.44352979e+03 4.17362441e+02 1.47784254e+02
 5.84521835e+01 2.45585338e+01 7.56874087e+00 8.60453575e+00
 4.92814212e-01]
E = -507.9901621659953
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.196632876394       1
[INPUT] 0    0    [1    /1   ]  0.42884365096        1
[INPUT] 0    0    [1    /1   ]  0.785789027052       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.13336379367        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175477        1
[INPUT] 0    0    [1    /1   ]  36754.7015327        1
[INPUT] 0    0    [1    /1   ]  7302.32135897        1
[INPUT] 0    0    [1    /1   ]  18375.7713347        1
[INPUT] 0    0    [1    /1   ]  1443.5297899         1
[INPUT] 0    0    [1    /1   ]  417.362440883        1
[INPUT] 0    0    [1    /1   ]  147.784253652        1
[INPUT] 0    0    [1    /1   ]  58.4521834716        1
[INPUT] 0    0    [1    /1   ]  24.5585337785        1
[INPUT] 0    0    [1    /1   ]  7.56874087106        1
[INPUT] 1    0    [1    /1   ]  8.60453575379        1
[INPUT] 1    0    [1    /1   ]  0.492814211987       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19663287639385676, 1.0]], [0, [0.42884365096029153, 1.0]], [0, [0.7857890270519707, 1.0]], [0, [117616.81288924514, 1.0]], [0, [3.1333637936694565, 1.0]], [0, [1176168.142613451, 1.0]], [0, [588084.0699565526, 1.0]], [0, [294042.0309213951, 1.0]], [0, [147020.9913231583, 1.0]], [0, [73510.4175477231, 1.0]], [0, [36754.701532668994, 1.0]], [0, [7302.321358965793, 1.0]], [0, [18375.77133472322, 1.0]], [0, [1443.529789899383, 1.0]], [0, [417.36244088294546, 1.0]], [0, [147.7842536524171, 1.0]], [0, [58.45218347158458, 1.0]], [0, [24.558533778496162, 1.0]], [0, [7.5687408710586075, 1.0]], [1, [8.604535753788431, 1.0]], [1, [0.49281421198737047, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19663288]
bas 1, expnt(s) = [0.42884365]
bas 2, expnt(s) = [0.78578903]
bas 3, expnt(s) = [117616.81288925]
bas 4, expnt(s) = [3.13336379]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995655]
bas 7, expnt(s) = [294042.0309214]
bas 8, expnt(s) = [147020.99132316]
bas 9, expnt(s) = [73510.41754772]
bas 10, expnt(s) = [36754.70153267]
bas 11, expnt(s) = [7302.32135897]
bas 12, expnt(s) = [18375.77133472]
bas 13, expnt(s) = [1443.5297899]
bas 14, expnt(s) = [417.36244088]
bas 15, expnt(s) = [147.78425365]
bas 16, expnt(s) = [58.45218347]
bas 17, expnt(s) = [24.55853378]
bas 18, expnt(s) = [7.56874087]
bas 19, expnt(s) = [8.60453575]
bas 20, expnt(s) = [0.49281421]
CPU time:       267.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.96632876e-01 7.46031428e-01 4.28843651e-01 1.33887263e+00
 7.85789027e-01 2.10860142e+00 1.17616813e+05 1.60460108e+04
 3.13336379e+00 5.95008459e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232136e+03 1.99577110e+03
 1.83757713e+04 3.98748633e+03 1.44352979e+03 5.91676523e+02
 4.17362441e+02 2.33292108e+02 1.47784254e+02 1.07086851e+02
 5.84521835e+01 5.34091392e+01 2.45585338e+01 2.78719176e+01
 7.56874087e+00 1.15287641e+01 8.60453575e+00 4.29925987e+01
 4.92814212e-01 1.20458769e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336083629652016
cond(S) = 912217.4021351963
E1 = -689.5984372764891  E_coul = 184.9768268747242
init E= -504.621610401765
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.671974977149329  LUMO = 0.300627110980801
  mo_energy =
[-1.21709244e+02 -1.33855913e+01 -7.62325429e+00 -7.62325429e+00
 -7.62325429e+00 -1.65748533e+00 -6.71974977e-01 -6.71974977e-01
 -6.71974977e-01  3.00627111e-01  2.32692210e+00  1.28012473e+01
  6.59743350e+01  2.59828774e+02  8.88437141e+02  3.14200321e+03
  1.26224585e+04  4.12196684e+04  1.05247893e+05  2.30421036e+05
  4.56228560e+05  8.45175183e+05  1.52834699e+06  2.85060767e+06
  5.80848633e+06]
E1 = -707.7555853658589  E_coul = 199.7834534353482
cycle= 1 E= -507.972131930511  delta_E= -3.35  |g|= 0.452  |ddm|= 0.444
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.730765
diis-c [-0.53401697  1.        ]
  HOMO = -0.217393262713299  LUMO = 0.580655887054607
  mo_energy =
[-1.20200337e+02 -1.23043951e+01 -6.59406691e+00 -6.59406691e+00
 -6.59406691e+00 -1.16320243e+00 -2.17393263e-01 -2.17393263e-01
 -2.17393263e-01  5.80655887e-01  2.79390894e+00  1.36667061e+01
  6.72395285e+01  2.61283942e+02  8.89929043e+02  3.14343484e+03
  1.26237835e+04  4.12209262e+04  1.05249113e+05  2.30422232e+05
  4.56229739e+05  8.45176349e+05  1.52834815e+06  2.85060881e+06
  5.80848747e+06]
E1 = -706.8033616414186  E_coul = 198.813475508505
cycle= 2 E= -507.989886132914  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.321
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0376878
diis-c [-0.00141461 -0.00330059  1.00330059]
  HOMO = -0.239620599794079  LUMO = 0.57938180884081
  mo_energy =
[-1.20314955e+02 -1.23719674e+01 -6.66887558e+00 -6.66887558e+00
 -6.66887558e+00 -1.17751748e+00 -2.39620600e-01 -2.39620600e-01
 -2.39620600e-01  5.79381809e-01  2.77919358e+00  1.36180782e+01
  6.71571158e+01  2.61179351e+02  8.89808661e+02  3.14330022e+03
  1.26236387e+04  4.12207775e+04  1.05248963e+05  2.30422081e+05
  4.56229588e+05  8.45176197e+05  1.52834799e+06  2.85060866e+06
  5.80848732e+06]
E1 = -706.6935232427164  E_coul = 198.70336683851502
cycle= 3 E= -507.990156404201  delta_E= -0.00027  |g|= 0.00445  |ddm|= 0.0458
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0046329
diis-c [-3.49527969e-06 -2.77621919e-04 -1.26113624e-01  1.12639125e+00]
  HOMO = -0.242903883075358  LUMO = 0.579031120200338
  mo_energy =
[-1.20326989e+02 -1.23807731e+01 -6.67816831e+00 -6.67816831e+00
 -6.67816831e+00 -1.17951453e+00 -2.42903883e-01 -2.42903883e-01
 -2.42903883e-01  5.79031120e-01  2.77671811e+00  1.36113365e+01
  6.71473064e+01  2.61167979e+02  8.89796379e+02  3.14328723e+03
  1.26236253e+04  4.12207639e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.677255973681  E_coul = 198.68709382259237
cycle= 4 E= -507.990162151089  delta_E= -5.75e-06  |g|= 0.000225  |ddm|= 0.0103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000174336
diis-c [-1.56735401e-09 -1.10475304e-05  8.17812929e-03 -9.34750482e-02
  1.08530797e+00]
  HOMO = -0.24301225116763  LUMO = 0.57900911103101
  mo_energy =
[-1.20327124e+02 -1.23809757e+01 -6.67835537e+00 -6.67835537e+00
 -6.67835537e+00 -1.17958083e+00 -2.43012251e-01 -2.43012251e-01
 -2.43012251e-01  5.79009111e-01  2.77661677e+00  1.36111539e+01
  6.71471319e+01  2.61167831e+02  8.89796249e+02  3.14328712e+03
  1.26236251e+04  4.12207638e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.6767069516804  E_coul = 198.68654478572532
cycle= 5 E= -507.990162165955  delta_E= -1.49e-08  |g|= 1.26e-05  |ddm|= 0.000982
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.62607e-06
diis-c [-2.17704100e-12  9.99266369e-07 -9.89460665e-04  1.08526746e-02
 -1.39409492e-01  1.12954528e+00]
  HOMO = -0.243015518115931  LUMO = 0.5790083507603
  mo_energy =
[-1.20327129e+02 -1.23809801e+01 -6.67835970e+00 -6.67835970e+00
 -6.67835970e+00 -1.17958324e+00 -2.43015518e-01 -2.43015518e-01
 -2.43015518e-01  5.79008351e-01  2.77661317e+00  1.36111493e+01
  6.71471275e+01  2.61167827e+02  8.89796244e+02  3.14328711e+03
  1.26236251e+04  4.12207638e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.676687963454  E_coul = 198.68652579745898
cycle= 6 E= -507.990162165995  delta_E= -3.99e-11  |g|= 7.68e-08  |ddm|= 6.61e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.676687963454  E_coul = 198.68652579745898
  HOMO = -0.243015544679848  LUMO = 0.579008327228388
  mo_energy =
[-1.20327129e+02 -1.23809801e+01 -6.67835974e+00 -6.67835974e+00
 -6.67835974e+00 -1.17958323e+00 -2.43015545e-01 -2.43015545e-01
 -2.43015545e-01  5.79008327e-01  2.77661313e+00  1.36111493e+01
  6.71471274e+01  2.61167827e+02  8.89796244e+02  3.14328711e+03
  1.26236251e+04  4.12207638e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.6766878812949  E_coul = 198.68652571529964
Extra cycle  E= -507.990162165995  delta_E= -2.84e-13  |g|= 9.85e-09  |ddm|= 2.63e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912217.4021351963
E1 = -706.6766878812949  E_coul = 198.68652571529964
init E= -507.990162165995
    CPU time for initialize scf      5.69 sec, wall time      0.24 sec
  HOMO = -0.243015547892376  LUMO = 0.579008326600637
  mo_energy =
[-1.20327129e+02 -1.23809801e+01 -6.67835975e+00 -6.67835975e+00
 -6.67835975e+00 -1.17958324e+00 -2.43015548e-01 -2.43015548e-01
 -2.43015548e-01  5.79008327e-01  2.77661313e+00  1.36111493e+01
  6.71471274e+01  2.61167827e+02  8.89796244e+02  3.14328711e+03
  1.26236251e+04  4.12207638e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.6766878653235  E_coul = 198.6865256993287
cycle= 1 E= -507.990162165995  delta_E= 5.12e-13  |g|= 2.67e-09  |ddm|= 3.65e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6766878653235  E_coul = 198.6865256993287
  HOMO = -0.243015548458912  LUMO = 0.579008327500275
  mo_energy =
[-1.20327129e+02 -1.23809801e+01 -6.67835975e+00 -6.67835975e+00
 -6.67835975e+00 -1.17958324e+00 -2.43015548e-01 -2.43015548e-01
 -2.43015548e-01  5.79008328e-01  2.77661313e+00  1.36111493e+01
  6.71471274e+01  2.61167827e+02  8.89796244e+02  3.14328711e+03
  1.26236251e+04  4.12207638e+04  1.05248949e+05  2.30422068e+05
  4.56229574e+05  8.45176183e+05  1.52834798e+06  2.85060865e+06
  5.80848730e+06]
E1 = -706.6766878610877  E_coul = 198.6865256950929
Extra cycle  E= -507.990162165995  delta_E=    0  |g|= 2.3e-09  |ddm|= 7.19e-09
    CPU time for scf_cycle      6.19 sec, wall time      0.41 sec
exp = [1.96632876e-01 4.28843651e-01 7.85789027e-01 1.17616813e+05
 3.13336379e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232136e+03
 1.83757713e+04 1.44352979e+03 4.17362441e+02 1.47784254e+02
 5.84521835e+01 2.45585338e+01 7.56874087e+00 8.60453575e+00
 4.92814212e-01]
grad_E = [ 6.96144777e-04  2.72304272e-06 -1.20411464e-03  6.07662495e-09
  8.96526183e-04  4.06007123e-11  1.74626703e-10  9.42503504e-10
  3.72404353e-09  1.55514694e-08  8.11025006e-08  5.11204311e-06
  1.98967060e-07 -3.89130023e-05 -1.86915064e-06 -1.79421880e-05
  7.14977874e-05 -9.73310627e-05 -1.05989002e-03  1.27552674e-04
  1.96133559e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.199340083992       1
[INPUT] 0    0    [1    /1   ]  0.446641423757       1
[INPUT] 0    0    [1    /1   ]  0.802576371006       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.14244243928        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175475        1
[INPUT] 0    0    [1    /1   ]  36754.7015316        1
[INPUT] 0    0    [1    /1   ]  7302.32129052        1
[INPUT] 0    0    [1    /1   ]  18375.7713321        1
[INPUT] 0    0    [1    /1   ]  1443.53030867        1
[INPUT] 0    0    [1    /1   ]  417.362493916        1
[INPUT] 0    0    [1    /1   ]  147.784340084        1
[INPUT] 0    0    [1    /1   ]  58.4518840904        1
[INPUT] 0    0    [1    /1   ]  24.5589251936        1
[INPUT] 0    0    [1    /1   ]  7.57084543156        1
[INPUT] 1    0    [1    /1   ]  8.60441423842        1
[INPUT] 1    0    [1    /1   ]  0.492740928541       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19934008399194447, 1.0]], [0, [0.4466414237567065, 1.0]], [0, [0.8025763710056115, 1.0]], [0, [117616.81288916378, 1.0]], [0, [3.1424424392789674, 1.0]], [0, [1176168.1426134505, 1.0]], [0, [588084.0699565503, 1.0]], [0, [294042.0309213825, 1.0]], [0, [147020.99132310844, 1.0]], [0, [73510.4175475149, 1.0]], [0, [36754.70153158305, 1.0]], [0, [7302.321290518056, 1.0]], [0, [18375.771332059878, 1.0]], [0, [1443.5303086708786, 1.0]], [0, [417.36249391584937, 1.0]], [0, [147.78434008433806, 1.0]], [0, [58.45188409043547, 1.0]], [0, [24.558925193618006, 1.0]], [0, [7.570845431564801, 1.0]], [1, [8.604414238416556, 1.0]], [1, [0.4927409285412047, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19934008]
bas 1, expnt(s) = [0.44664142]
bas 2, expnt(s) = [0.80257637]
bas 3, expnt(s) = [117616.81288916]
bas 4, expnt(s) = [3.14244244]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995655]
bas 7, expnt(s) = [294042.03092138]
bas 8, expnt(s) = [147020.99132311]
bas 9, expnt(s) = [73510.41754751]
bas 10, expnt(s) = [36754.70153158]
bas 11, expnt(s) = [7302.32129052]
bas 12, expnt(s) = [18375.77133206]
bas 13, expnt(s) = [1443.53030867]
bas 14, expnt(s) = [417.36249392]
bas 15, expnt(s) = [147.78434008]
bas 16, expnt(s) = [58.45188409]
bas 17, expnt(s) = [24.55892519]
bas 18, expnt(s) = [7.57084543]
bas 19, expnt(s) = [8.60441424]
bas 20, expnt(s) = [0.49274093]
CPU time:       282.50
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.99340084e-01 7.53721670e-01 4.46641424e-01 1.38033428e+00
 8.02576371e-01 2.14229760e+00 1.17616813e+05 1.60460108e+04
 3.14244244e+00 5.96300980e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232129e+03 1.99577109e+03
 1.83757713e+04 3.98748633e+03 1.44353031e+03 5.91676682e+02
 4.17362494e+02 2.33292130e+02 1.47784340e+02 1.07086898e+02
 5.84518841e+01 5.34089340e+01 2.45589252e+01 2.78722508e+01
 7.57084543e+00 1.15311683e+01 8.60441424e+00 4.29918398e+01
 4.92740929e-01 1.20436379e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336181525892112
cond(S) = 912224.8340548924
E1 = -689.5951221417604  E_coul = 184.9737017993313
init E= -504.621420342429
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672068208072724  LUMO = 0.316114191921501
  mo_energy =
[-1.21709581e+02 -1.33858547e+01 -7.62345288e+00 -7.62345288e+00
 -7.62345288e+00 -1.65755486e+00 -6.72068208e-01 -6.72068208e-01
 -6.72068208e-01  3.16114192e-01  2.41795747e+00  1.29958288e+01
  6.61858864e+01  2.60020718e+02  8.88608376e+02  3.14215637e+03
  1.26225944e+04  4.12197945e+04  1.05248013e+05  2.30421154e+05
  4.56228675e+05  8.45175296e+05  1.52834710e+06  2.85060778e+06
  5.80848644e+06]
E1 = -707.7512861401347  E_coul = 199.77915459683229
cycle= 1 E= -507.972131543302  delta_E= -3.35  |g|= 0.452  |ddm|= 0.443
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.730415
diis-c [-0.53350601  1.        ]
  HOMO = -0.217567040552453  LUMO = 0.600176861521484
  mo_energy =
[-1.20200750e+02 -1.23047201e+01 -6.59432182e+00 -6.59432182e+00
 -6.59432182e+00 -1.16333192e+00 -2.17567041e-01 -2.17567041e-01
 -2.17567041e-01  6.00176862e-01  2.89068293e+00  1.38619282e+01
  6.74507196e+01  2.61475716e+02  8.90100177e+02  3.14358792e+03
  1.26239193e+04  4.12210522e+04  1.05249234e+05  2.30422350e+05
  4.56229854e+05  8.45176462e+05  1.52834826e+06  2.85060892e+06
  5.80848757e+06]
E1 = -706.7985714768374  E_coul = 198.80867601729815
cycle= 2 E= -507.989895459539  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.317
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0376326
diis-c [-0.00141081 -0.00319602  1.00319602]
  HOMO = -0.239798647647842  LUMO = 0.598795825161627
  mo_energy =
[-1.20315411e+02 -1.23723259e+01 -6.66916649e+00 -6.66916649e+00
 -6.66916649e+00 -1.17765015e+00 -2.39798648e-01 -2.39798648e-01
 -2.39798648e-01  5.98795825e-01  2.87545685e+00  1.38131216e+01
  6.73682759e+01  2.61371090e+02  8.89979755e+02  3.14345325e+03
  1.26237744e+04  4.12209035e+04  1.05249084e+05  2.30422199e+05
  4.56229702e+05  8.45176310e+05  1.52834811e+06  2.85060877e+06
  5.80848742e+06]
E1 = -706.688797614443  E_coul = 198.69863230731397
cycle= 3 E= -507.990165307129  delta_E= -0.00027  |g|= 0.00444  |ddm|= 0.0464
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00462118
diis-c [-3.48650277e-06 -2.71233002e-04 -1.25957825e-01  1.12622906e+00]
  HOMO = -0.243080073663583  LUMO = 0.598424340145978
  mo_energy =
[-1.20327450e+02 -1.23811318e+01 -6.67846033e+00 -6.67846033e+00
 -6.67846033e+00 -1.17964599e+00 -2.43080074e-01 -2.43080074e-01
 -2.43080074e-01  5.98424340e-01  2.87291060e+00  1.38063657e+01
  6.73584657e+01  2.61359716e+02  8.89967467e+02  3.14344026e+03
  1.26237609e+04  4.12208899e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6725637296385  E_coul = 198.6823927109834
cycle= 4 E= -507.990171018655  delta_E= -5.71e-06  |g|= 0.000223  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172459
diis-c [-1.48813786e-09 -1.12626668e-05  8.10155613e-03 -9.26691349e-02
  1.08457884e+00]
  HOMO = -0.24318794669436  LUMO = 0.598401549537611
  mo_energy =
[-1.20327585e+02 -1.23813340e+01 -6.67864700e+00 -6.67864700e+00
 -6.67864700e+00 -1.17971196e+00 -2.43187947e-01 -2.43187947e-01
 -2.43187947e-01  5.98401550e-01  2.87280774e+00  1.38061837e+01
  6.73582914e+01  2.61359568e+02  8.89967337e+02  3.14344014e+03
  1.26237608e+04  4.12208898e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6720197542514  E_coul = 198.68184872127216
cycle= 5 E= -507.990171032979  delta_E= -1.43e-08  |g|= 1.22e-05  |ddm|= 0.00098
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.43038e-06
diis-c [-2.09930195e-12  9.71684769e-07 -9.71328304e-04  1.06522616e-02
 -1.37426403e-01  1.12774450e+00]
  HOMO = -0.243191189333905  LUMO = 0.598400778372907
  mo_energy =
[-1.20327590e+02 -1.23813384e+01 -6.67865137e+00 -6.67865137e+00
 -6.67865137e+00 -1.17971434e+00 -2.43191189e-01 -2.43191189e-01
 -2.43191189e-01  5.98400778e-01  2.87280415e+00  1.38061791e+01
  6.73582870e+01  2.61359563e+02  8.89967333e+02  3.14344014e+03
  1.26237608e+04  4.12208898e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6720011231578  E_coul = 198.68183009014123
cycle= 6 E= -507.990171033017  delta_E= -3.72e-11  |g|= 7.46e-08  |ddm|= 6.42e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6720011231578  E_coul = 198.68183009014123
  HOMO = -0.243191216201564  LUMO = 0.598400754728419
  mo_energy =
[-1.20327590e+02 -1.23813384e+01 -6.67865141e+00 -6.67865141e+00
 -6.67865141e+00 -1.17971434e+00 -2.43191216e-01 -2.43191216e-01
 -2.43191216e-01  5.98400755e-01  2.87280411e+00  1.38061791e+01
  6.73582870e+01  2.61359563e+02  8.89967333e+02  3.14344014e+03
  1.26237608e+04  4.12208898e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6720010408105  E_coul = 198.6818300077942
Extra cycle  E= -507.990171033016  delta_E= 1.71e-13  |g|= 9.58e-09  |ddm|= 2.5e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
exp = [1.99340084e-01 4.46641424e-01 8.02576371e-01 1.17616813e+05
 3.14244244e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232129e+03
 1.83757713e+04 1.44353031e+03 4.17362494e+02 1.47784340e+02
 5.84518841e+01 2.45589252e+01 7.57084543e+00 8.60441424e+00
 4.92740929e-01]
E = -507.99017103301634
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.199340083992       1
[INPUT] 0    0    [1    /1   ]  0.446641423757       1
[INPUT] 0    0    [1    /1   ]  0.802576371006       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.14244243928        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175475        1
[INPUT] 0    0    [1    /1   ]  36754.7015316        1
[INPUT] 0    0    [1    /1   ]  7302.32129052        1
[INPUT] 0    0    [1    /1   ]  18375.7713321        1
[INPUT] 0    0    [1    /1   ]  1443.53030867        1
[INPUT] 0    0    [1    /1   ]  417.362493916        1
[INPUT] 0    0    [1    /1   ]  147.784340084        1
[INPUT] 0    0    [1    /1   ]  58.4518840904        1
[INPUT] 0    0    [1    /1   ]  24.5589251936        1
[INPUT] 0    0    [1    /1   ]  7.57084543156        1
[INPUT] 1    0    [1    /1   ]  8.60441423842        1
[INPUT] 1    0    [1    /1   ]  0.492740928541       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19934008399194447, 1.0]], [0, [0.4466414237567065, 1.0]], [0, [0.8025763710056115, 1.0]], [0, [117616.81288916378, 1.0]], [0, [3.1424424392789674, 1.0]], [0, [1176168.1426134505, 1.0]], [0, [588084.0699565503, 1.0]], [0, [294042.0309213825, 1.0]], [0, [147020.99132310844, 1.0]], [0, [73510.4175475149, 1.0]], [0, [36754.70153158305, 1.0]], [0, [7302.321290518056, 1.0]], [0, [18375.771332059878, 1.0]], [0, [1443.5303086708786, 1.0]], [0, [417.36249391584937, 1.0]], [0, [147.78434008433806, 1.0]], [0, [58.45188409043547, 1.0]], [0, [24.558925193618006, 1.0]], [0, [7.570845431564801, 1.0]], [1, [8.604414238416556, 1.0]], [1, [0.4927409285412047, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19934008]
bas 1, expnt(s) = [0.44664142]
bas 2, expnt(s) = [0.80257637]
bas 3, expnt(s) = [117616.81288916]
bas 4, expnt(s) = [3.14244244]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995655]
bas 7, expnt(s) = [294042.03092138]
bas 8, expnt(s) = [147020.99132311]
bas 9, expnt(s) = [73510.41754751]
bas 10, expnt(s) = [36754.70153158]
bas 11, expnt(s) = [7302.32129052]
bas 12, expnt(s) = [18375.77133206]
bas 13, expnt(s) = [1443.53030867]
bas 14, expnt(s) = [417.36249392]
bas 15, expnt(s) = [147.78434008]
bas 16, expnt(s) = [58.45188409]
bas 17, expnt(s) = [24.55892519]
bas 18, expnt(s) = [7.57084543]
bas 19, expnt(s) = [8.60441424]
bas 20, expnt(s) = [0.49274093]
CPU time:       284.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.99340084e-01 7.53721670e-01 4.46641424e-01 1.38033428e+00
 8.02576371e-01 2.14229760e+00 1.17616813e+05 1.60460108e+04
 3.14244244e+00 5.96300980e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232129e+03 1.99577109e+03
 1.83757713e+04 3.98748633e+03 1.44353031e+03 5.91676682e+02
 4.17362494e+02 2.33292130e+02 1.47784340e+02 1.07086898e+02
 5.84518841e+01 5.34089340e+01 2.45589252e+01 2.78722508e+01
 7.57084543e+00 1.15311683e+01 8.60441424e+00 4.29918398e+01
 4.92740929e-01 1.20436379e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336181525892112
cond(S) = 912224.8340548924
E1 = -689.5951221417604  E_coul = 184.9737017993313
init E= -504.621420342429
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672068208072724  LUMO = 0.316114191921501
  mo_energy =
[-1.21709581e+02 -1.33858547e+01 -7.62345288e+00 -7.62345288e+00
 -7.62345288e+00 -1.65755486e+00 -6.72068208e-01 -6.72068208e-01
 -6.72068208e-01  3.16114192e-01  2.41795747e+00  1.29958288e+01
  6.61858864e+01  2.60020718e+02  8.88608376e+02  3.14215637e+03
  1.26225944e+04  4.12197945e+04  1.05248013e+05  2.30421154e+05
  4.56228675e+05  8.45175296e+05  1.52834710e+06  2.85060778e+06
  5.80848644e+06]
E1 = -707.7512861401347  E_coul = 199.77915459683229
cycle= 1 E= -507.972131543302  delta_E= -3.35  |g|= 0.452  |ddm|= 0.443
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.730415
diis-c [-0.53350601  1.        ]
  HOMO = -0.217567040552453  LUMO = 0.600176861521484
  mo_energy =
[-1.20200750e+02 -1.23047201e+01 -6.59432182e+00 -6.59432182e+00
 -6.59432182e+00 -1.16333192e+00 -2.17567041e-01 -2.17567041e-01
 -2.17567041e-01  6.00176862e-01  2.89068293e+00  1.38619282e+01
  6.74507196e+01  2.61475716e+02  8.90100177e+02  3.14358792e+03
  1.26239193e+04  4.12210522e+04  1.05249234e+05  2.30422350e+05
  4.56229854e+05  8.45176462e+05  1.52834826e+06  2.85060892e+06
  5.80848757e+06]
E1 = -706.7985714768374  E_coul = 198.80867601729815
cycle= 2 E= -507.989895459539  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.317
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0376326
diis-c [-0.00141081 -0.00319602  1.00319602]
  HOMO = -0.239798647647842  LUMO = 0.598795825161627
  mo_energy =
[-1.20315411e+02 -1.23723259e+01 -6.66916649e+00 -6.66916649e+00
 -6.66916649e+00 -1.17765015e+00 -2.39798648e-01 -2.39798648e-01
 -2.39798648e-01  5.98795825e-01  2.87545685e+00  1.38131216e+01
  6.73682759e+01  2.61371090e+02  8.89979755e+02  3.14345325e+03
  1.26237744e+04  4.12209035e+04  1.05249084e+05  2.30422199e+05
  4.56229702e+05  8.45176310e+05  1.52834811e+06  2.85060877e+06
  5.80848742e+06]
E1 = -706.688797614443  E_coul = 198.69863230731397
cycle= 3 E= -507.990165307129  delta_E= -0.00027  |g|= 0.00444  |ddm|= 0.0464
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00462118
diis-c [-3.48650277e-06 -2.71233002e-04 -1.25957825e-01  1.12622906e+00]
  HOMO = -0.243080073663583  LUMO = 0.598424340145978
  mo_energy =
[-1.20327450e+02 -1.23811318e+01 -6.67846033e+00 -6.67846033e+00
 -6.67846033e+00 -1.17964599e+00 -2.43080074e-01 -2.43080074e-01
 -2.43080074e-01  5.98424340e-01  2.87291060e+00  1.38063657e+01
  6.73584657e+01  2.61359716e+02  8.89967467e+02  3.14344026e+03
  1.26237609e+04  4.12208899e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6725637296385  E_coul = 198.6823927109834
cycle= 4 E= -507.990171018655  delta_E= -5.71e-06  |g|= 0.000223  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172459
diis-c [-1.48813786e-09 -1.12626668e-05  8.10155613e-03 -9.26691349e-02
  1.08457884e+00]
  HOMO = -0.24318794669436  LUMO = 0.598401549537611
  mo_energy =
[-1.20327585e+02 -1.23813340e+01 -6.67864700e+00 -6.67864700e+00
 -6.67864700e+00 -1.17971196e+00 -2.43187947e-01 -2.43187947e-01
 -2.43187947e-01  5.98401550e-01  2.87280774e+00  1.38061837e+01
  6.73582914e+01  2.61359568e+02  8.89967337e+02  3.14344014e+03
  1.26237608e+04  4.12208898e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6720197542514  E_coul = 198.68184872127216
cycle= 5 E= -507.990171032979  delta_E= -1.43e-08  |g|= 1.22e-05  |ddm|= 0.00098
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.43038e-06
diis-c [-2.09930195e-12  9.71684769e-07 -9.71328304e-04  1.06522616e-02
 -1.37426403e-01  1.12774450e+00]
  HOMO = -0.243191189333905  LUMO = 0.598400778372907
  mo_energy =
[-1.20327590e+02 -1.23813384e+01 -6.67865137e+00 -6.67865137e+00
 -6.67865137e+00 -1.17971434e+00 -2.43191189e-01 -2.43191189e-01
 -2.43191189e-01  5.98400778e-01  2.87280415e+00  1.38061791e+01
  6.73582870e+01  2.61359563e+02  8.89967333e+02  3.14344014e+03
  1.26237608e+04  4.12208898e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6720011231578  E_coul = 198.68183009014123
cycle= 6 E= -507.990171033017  delta_E= -3.72e-11  |g|= 7.46e-08  |ddm|= 6.42e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6720011231578  E_coul = 198.68183009014123
  HOMO = -0.243191216201564  LUMO = 0.598400754728419
  mo_energy =
[-1.20327590e+02 -1.23813384e+01 -6.67865141e+00 -6.67865141e+00
 -6.67865141e+00 -1.17971434e+00 -2.43191216e-01 -2.43191216e-01
 -2.43191216e-01  5.98400755e-01  2.87280411e+00  1.38061791e+01
  6.73582870e+01  2.61359563e+02  8.89967333e+02  3.14344014e+03
  1.26237608e+04  4.12208898e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6720010408105  E_coul = 198.6818300077942
Extra cycle  E= -507.990171033016  delta_E= 1.71e-13  |g|= 9.58e-09  |ddm|= 2.5e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912224.8340548924
E1 = -706.6720010408105  E_coul = 198.6818300077942
init E= -507.990171033016
    CPU time for initialize scf     14.35 sec, wall time      0.63 sec
  HOMO = -0.243191219391692  LUMO = 0.598400753375715
  mo_energy =
[-1.20327590e+02 -1.23813384e+01 -6.67865141e+00 -6.67865141e+00
 -6.67865141e+00 -1.17971434e+00 -2.43191219e-01 -2.43191219e-01
 -2.43191219e-01  5.98400753e-01  2.87280411e+00  1.38061791e+01
  6.73582870e+01  2.61359563e+02  8.89967333e+02  3.14344014e+03
  1.26237608e+04  4.12208898e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6720010227056  E_coul = 198.68182998968896
cycle= 1 E= -507.990171033017  delta_E= -2.84e-13  |g|= 1.86e-09  |ddm|= 3.85e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6720010227056  E_coul = 198.68182998968896
  HOMO = -0.243191220002524  LUMO = 0.598400753878785
  mo_energy =
[-1.20327590e+02 -1.23813384e+01 -6.67865141e+00 -6.67865141e+00
 -6.67865141e+00 -1.17971434e+00 -2.43191220e-01 -2.43191220e-01
 -2.43191220e-01  5.98400754e-01  2.87280411e+00  1.38061791e+01
  6.73582870e+01  2.61359563e+02  8.89967333e+02  3.14344014e+03
  1.26237608e+04  4.12208898e+04  1.05249070e+05  2.30422185e+05
  4.56229689e+05  8.45176296e+05  1.52834809e+06  2.85060876e+06
  5.80848741e+06]
E1 = -706.6720010200197  E_coul = 198.68182998700306
Extra cycle  E= -507.990171033017  delta_E=    0  |g|= 1.43e-09  |ddm|= 7.48e-09
    CPU time for scf_cycle     14.86 sec, wall time      0.79 sec
exp = [1.99340084e-01 4.46641424e-01 8.02576371e-01 1.17616813e+05
 3.14244244e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232129e+03
 1.83757713e+04 1.44353031e+03 4.17362494e+02 1.47784340e+02
 5.84518841e+01 2.45589252e+01 7.57084543e+00 8.60441424e+00
 4.92740929e-01]
grad_E = [-5.08235511e-04  6.23176031e-04 -1.22719833e-03  6.07697814e-09
  8.89446222e-04  4.06046617e-11  1.74638305e-10  9.42557612e-10
  3.72426234e-09  1.55523955e-08  8.11069634e-08  5.11233233e-06
  1.98981754e-07 -3.89265177e-05 -1.72600928e-06 -1.87536418e-05
  7.49884709e-05 -1.02309515e-04 -1.10124310e-03  9.39521209e-05
 -7.44941595e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.205173128942       1
[INPUT] 0    0    [1    /1   ]  0.467209245411       1
[INPUT] 0    0    [1    /1   ]  0.82330770447        1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.15139505769        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175473        1
[INPUT] 0    0    [1    /1   ]  36754.7015302        1
[INPUT] 0    0    [1    /1   ]  7302.32120462        1
[INPUT] 0    0    [1    /1   ]  18375.7713287        1
[INPUT] 0    0    [1    /1   ]  1443.53095995        1
[INPUT] 0    0    [1    /1   ]  417.36255766         1
[INPUT] 0    0    [1    /1   ]  147.78446405         1
[INPUT] 0    0    [1    /1   ]  58.4514414094        1
[INPUT] 0    0    [1    /1   ]  24.5595093373        1
[INPUT] 0    0    [1    /1   ]  7.57476290032        1
[INPUT] 1    0    [1    /1   ]  8.60427280458        1
[INPUT] 1    0    [1    /1   ]  0.492689944951       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20517312894226386, 1.0]], [0, [0.46720924541121467, 1.0]], [0, [0.8233077044695802, 1.0]], [0, [117616.81288906166, 1.0]], [0, [3.151395057685163, 1.0]], [0, [1176168.1426134498, 1.0]], [0, [588084.0699565473, 1.0]], [0, [294042.03092136665, 1.0]], [0, [147020.99132304586, 1.0]], [0, [73510.41754725359, 1.0]], [0, [36754.701530220205, 1.0]], [0, [7302.321204616885, 1.0]], [0, [18375.771328717336, 1.0]], [0, [1443.5309599489683, 1.0]], [0, [417.36255766045605, 1.0]], [0, [147.78446405007253, 1.0]], [0, [58.45144140940187, 1.0]], [0, [24.559509337336515, 1.0]], [0, [7.574762900315579, 1.0]], [1, [8.60427280457817, 1.0]], [1, [0.4926899449505359, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20517313]
bas 1, expnt(s) = [0.46720925]
bas 2, expnt(s) = [0.8233077]
bas 3, expnt(s) = [117616.81288906]
bas 4, expnt(s) = [3.15139506]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995655]
bas 7, expnt(s) = [294042.03092137]
bas 8, expnt(s) = [147020.99132305]
bas 9, expnt(s) = [73510.41754725]
bas 10, expnt(s) = [36754.70153022]
bas 11, expnt(s) = [7302.32120462]
bas 12, expnt(s) = [18375.77132872]
bas 13, expnt(s) = [1443.53095995]
bas 14, expnt(s) = [417.36255766]
bas 15, expnt(s) = [147.78446405]
bas 16, expnt(s) = [58.45144141]
bas 17, expnt(s) = [24.55950934]
bas 18, expnt(s) = [7.5747629]
bas 19, expnt(s) = [8.6042728]
bas 20, expnt(s) = [0.49268994]
CPU time:       307.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.05173129e-01 7.70203318e-01 4.67209245e-01 1.42773825e+00
 8.23307704e-01 2.18366825e+00 1.17616813e+05 1.60460108e+04
 3.15139506e+00 5.97574644e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232120e+03 1.99577107e+03
 1.83757713e+04 3.98748633e+03 1.44353096e+03 5.91676883e+02
 4.17362558e+02 2.33292157e+02 1.47784464e+02 1.07086965e+02
 5.84514414e+01 5.34086307e+01 2.45595093e+01 2.78727480e+01
 7.57476290e+00 1.15356430e+01 8.60427280e+00 4.29909564e+01
 4.92689945e-01 1.20420802e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33623968938373
cond(S) = 912234.4140966804
E1 = -689.5927952608969  E_coul = 184.97147619162968
init E= -504.621319069267
    CPU time for initialize scf      5.55 sec, wall time      0.28 sec
  HOMO = -0.67212674918641  LUMO = 0.339605202860638
  mo_energy =
[-1.21709851e+02 -1.33860441e+01 -7.62359255e+00 -7.62359255e+00
 -7.62359255e+00 -1.65760632e+00 -6.72126749e-01 -6.72126749e-01
 -6.72126749e-01  3.39605203e-01  2.53722466e+00  1.32367486e+01
  6.64469790e+01  2.60258437e+02  8.88820653e+02  3.14234631e+03
  1.26227628e+04  4.12199509e+04  1.05248163e+05  2.30421300e+05
  4.56228818e+05  8.45175436e+05  1.52834724e+06  2.85060791e+06
  5.80848657e+06]
E1 = -707.7482367942488  E_coul = 199.77609627113105
cycle= 1 E= -507.972140523118  delta_E= -3.35  |g|= 0.452  |ddm|= 0.448
    CPU time for cycle= 1      0.58 sec, wall time      0.03 sec
diis-norm(errvec)=0.729827
diis-c [-0.53264713  1.        ]
  HOMO = -0.217688394220732  LUMO = 0.629293725302052
  mo_energy =
[-1.20201067e+02 -1.23049523e+01 -6.59449911e+00 -6.59449911e+00
 -6.59449911e+00 -1.16342281e+00 -2.17688394e-01 -2.17688394e-01
 -2.17688394e-01  6.29293725e-01  3.01672782e+00  1.41035464e+01
  6.77114078e+01  2.61713271e+02  8.90312380e+02  3.14377781e+03
  1.26240877e+04  4.12212086e+04  1.05249384e+05  2.30422496e+05
  4.56229997e+05  8.45176602e+05  1.52834840e+06  2.85060906e+06
  5.80848771e+06]
E1 = -706.7955503883848  E_coul = 198.80564451783806
cycle= 2 E= -507.989905870547  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.313
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0373975
diis-c [-0.00139388 -0.00298232  1.00298232]
  HOMO = -0.239901366371957  LUMO = 0.627764918350443
  mo_energy =
[-1.20315717e+02 -1.23725471e+01 -6.66933428e+00 -6.66933428e+00
 -6.66933428e+00 -1.17772756e+00 -2.39901366e-01 -2.39901366e-01
 -2.39901366e-01  6.27764918e-01  3.00090187e+00  1.40545753e+01
  6.76289811e+01  2.61608664e+02  8.90191971e+02  3.14364315e+03
  1.26239429e+04  4.12210599e+04  1.05249234e+05  2.30422345e+05
  4.56229845e+05  8.45176450e+05  1.52834824e+06  2.85060891e+06
  5.80848755e+06]
E1 = -706.6860544588122  E_coul = 198.695880003553
cycle= 3 E= -507.990174455259  delta_E= -0.000269  |g|= 0.00444  |ddm|= 0.0478
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00457165
diis-c [-3.43750094e-06 -2.58737385e-04 -1.25270885e-01  1.12552962e+00]
  HOMO = -0.243173066526237  LUMO = 0.627366337662804
  mo_energy =
[-1.20327747e+02 -1.23813390e+01 -6.67861506e+00 -6.67861506e+00
 -6.67861506e+00 -1.17971714e+00 -2.43173067e-01 -2.43173067e-01
 -2.43173067e-01  6.27366338e-01  2.99827781e+00  1.40478160e+01
  6.76191843e+01  2.61597300e+02  8.90179692e+02  3.14363017e+03
  1.26239294e+04  4.12210463e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176437e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.669909462928  E_coul = 198.6797293667766
cycle= 4 E= -507.990180096151  delta_E= -5.64e-06  |g|= 0.00022  |ddm|= 0.0108
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169291
diis-c [-1.35835691e-09 -1.13480903e-05  7.98386516e-03 -9.17785139e-02
  1.08380600e+00]
  HOMO = -0.243281112448197  LUMO = 0.627342496257553
  mo_energy =
[-1.20327887e+02 -1.23815434e+01 -6.67880435e+00 -6.67880435e+00
 -6.67880435e+00 -1.17978316e+00 -2.43281112e-01 -2.43281112e-01
 -2.43281112e-01  6.27342496e-01  2.99817278e+00  1.40476328e+01
  6.76190071e+01  2.61597148e+02  8.90179558e+02  3.14363005e+03
  1.26239293e+04  4.12210462e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176436e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.6693682470609  E_coul = 198.67918813719956
cycle= 5 E= -507.990180109861  delta_E= -1.37e-08  |g|= 1.17e-05  |ddm|= 0.000986
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.13183e-06
diis-c [-1.99714720e-12  9.30286883e-07 -9.44835362e-04  1.04032291e-02
 -1.34782954e-01  1.12532363e+00]
  HOMO = -0.24328435739256  LUMO = 0.62734170677337
  mo_energy =
[-1.20327892e+02 -1.23815480e+01 -6.67880888e+00 -6.67880888e+00
 -6.67880888e+00 -1.17978553e+00 -2.43284357e-01 -2.43284357e-01
 -2.43284357e-01  6.27341707e-01  2.99816917e+00  1.40476281e+01
  6.76190025e+01  2.61597143e+02  8.90179553e+02  3.14363004e+03
  1.26239293e+04  4.12210461e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176436e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.6693499358631  E_coul = 198.67916982596873
cycle= 6 E= -507.990180109894  delta_E= -3.3e-11  |g|= 7.5e-08  |ddm|= 6.23e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.6693499358631  E_coul = 198.67916982596873
  HOMO = -0.243284384847495  LUMO = 0.627341682470982
  mo_energy =
[-1.20327892e+02 -1.23815480e+01 -6.67880892e+00 -6.67880892e+00
 -6.67880892e+00 -1.17978553e+00 -2.43284385e-01 -2.43284385e-01
 -2.43284385e-01  6.27341682e-01  2.99816913e+00  1.40476281e+01
  6.76190025e+01  2.61597143e+02  8.90179553e+02  3.14363004e+03
  1.26239293e+04  4.12210461e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176436e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.6693498511535  E_coul = 198.6791697412592
Extra cycle  E= -507.990180109894  delta_E= 1.14e-13  |g|= 9.56e-09  |ddm|= 2.56e-07
    CPU time for scf_cycle      6.34 sec, wall time      0.52 sec
exp = [2.05173129e-01 4.67209245e-01 8.23307704e-01 1.17616813e+05
 3.15139506e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232120e+03
 1.83757713e+04 1.44353096e+03 4.17362558e+02 1.47784464e+02
 5.84514414e+01 2.45595093e+01 7.57476290e+00 8.60427280e+00
 4.92689945e-01]
E = -507.99018010989425
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:28:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.205173128942       1
[INPUT] 0    0    [1    /1   ]  0.467209245411       1
[INPUT] 0    0    [1    /1   ]  0.82330770447        1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.15139505769        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175473        1
[INPUT] 0    0    [1    /1   ]  36754.7015302        1
[INPUT] 0    0    [1    /1   ]  7302.32120462        1
[INPUT] 0    0    [1    /1   ]  18375.7713287        1
[INPUT] 0    0    [1    /1   ]  1443.53095995        1
[INPUT] 0    0    [1    /1   ]  417.36255766         1
[INPUT] 0    0    [1    /1   ]  147.78446405         1
[INPUT] 0    0    [1    /1   ]  58.4514414094        1
[INPUT] 0    0    [1    /1   ]  24.5595093373        1
[INPUT] 0    0    [1    /1   ]  7.57476290032        1
[INPUT] 1    0    [1    /1   ]  8.60427280458        1
[INPUT] 1    0    [1    /1   ]  0.492689944951       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20517312894226386, 1.0]], [0, [0.46720924541121467, 1.0]], [0, [0.8233077044695802, 1.0]], [0, [117616.81288906166, 1.0]], [0, [3.151395057685163, 1.0]], [0, [1176168.1426134498, 1.0]], [0, [588084.0699565473, 1.0]], [0, [294042.03092136665, 1.0]], [0, [147020.99132304586, 1.0]], [0, [73510.41754725359, 1.0]], [0, [36754.701530220205, 1.0]], [0, [7302.321204616885, 1.0]], [0, [18375.771328717336, 1.0]], [0, [1443.5309599489683, 1.0]], [0, [417.36255766045605, 1.0]], [0, [147.78446405007253, 1.0]], [0, [58.45144140940187, 1.0]], [0, [24.559509337336515, 1.0]], [0, [7.574762900315579, 1.0]], [1, [8.60427280457817, 1.0]], [1, [0.4926899449505359, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20517313]
bas 1, expnt(s) = [0.46720925]
bas 2, expnt(s) = [0.8233077]
bas 3, expnt(s) = [117616.81288906]
bas 4, expnt(s) = [3.15139506]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995655]
bas 7, expnt(s) = [294042.03092137]
bas 8, expnt(s) = [147020.99132305]
bas 9, expnt(s) = [73510.41754725]
bas 10, expnt(s) = [36754.70153022]
bas 11, expnt(s) = [7302.32120462]
bas 12, expnt(s) = [18375.77132872]
bas 13, expnt(s) = [1443.53095995]
bas 14, expnt(s) = [417.36255766]
bas 15, expnt(s) = [147.78446405]
bas 16, expnt(s) = [58.45144141]
bas 17, expnt(s) = [24.55950934]
bas 18, expnt(s) = [7.5747629]
bas 19, expnt(s) = [8.6042728]
bas 20, expnt(s) = [0.49268994]
CPU time:       313.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.05173129e-01 7.70203318e-01 4.67209245e-01 1.42773825e+00
 8.23307704e-01 2.18366825e+00 1.17616813e+05 1.60460108e+04
 3.15139506e+00 5.97574644e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232120e+03 1.99577107e+03
 1.83757713e+04 3.98748633e+03 1.44353096e+03 5.91676883e+02
 4.17362558e+02 2.33292157e+02 1.47784464e+02 1.07086965e+02
 5.84514414e+01 5.34086307e+01 2.45595093e+01 2.78727480e+01
 7.57476290e+00 1.15356430e+01 8.60427280e+00 4.29909564e+01
 4.92689945e-01 1.20420802e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33623968938373
cond(S) = 912234.4140966804
E1 = -689.5927952608969  E_coul = 184.97147619162968
init E= -504.621319069267
    CPU time for initialize scf      0.76 sec, wall time      0.07 sec
  HOMO = -0.67212674918641  LUMO = 0.339605202860638
  mo_energy =
[-1.21709851e+02 -1.33860441e+01 -7.62359255e+00 -7.62359255e+00
 -7.62359255e+00 -1.65760632e+00 -6.72126749e-01 -6.72126749e-01
 -6.72126749e-01  3.39605203e-01  2.53722466e+00  1.32367486e+01
  6.64469790e+01  2.60258437e+02  8.88820653e+02  3.14234631e+03
  1.26227628e+04  4.12199509e+04  1.05248163e+05  2.30421300e+05
  4.56228818e+05  8.45175436e+05  1.52834724e+06  2.85060791e+06
  5.80848657e+06]
E1 = -707.7482367942488  E_coul = 199.77609627113105
cycle= 1 E= -507.972140523118  delta_E= -3.35  |g|= 0.452  |ddm|= 0.448
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.729827
diis-c [-0.53264713  1.        ]
  HOMO = -0.217688394220732  LUMO = 0.629293725302052
  mo_energy =
[-1.20201067e+02 -1.23049523e+01 -6.59449911e+00 -6.59449911e+00
 -6.59449911e+00 -1.16342281e+00 -2.17688394e-01 -2.17688394e-01
 -2.17688394e-01  6.29293725e-01  3.01672782e+00  1.41035464e+01
  6.77114078e+01  2.61713271e+02  8.90312380e+02  3.14377781e+03
  1.26240877e+04  4.12212086e+04  1.05249384e+05  2.30422496e+05
  4.56229997e+05  8.45176602e+05  1.52834840e+06  2.85060906e+06
  5.80848771e+06]
E1 = -706.7955503883848  E_coul = 198.80564451783806
cycle= 2 E= -507.989905870547  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.313
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0373975
diis-c [-0.00139388 -0.00298232  1.00298232]
  HOMO = -0.239901366371957  LUMO = 0.627764918350443
  mo_energy =
[-1.20315717e+02 -1.23725471e+01 -6.66933428e+00 -6.66933428e+00
 -6.66933428e+00 -1.17772756e+00 -2.39901366e-01 -2.39901366e-01
 -2.39901366e-01  6.27764918e-01  3.00090187e+00  1.40545753e+01
  6.76289811e+01  2.61608664e+02  8.90191971e+02  3.14364315e+03
  1.26239429e+04  4.12210599e+04  1.05249234e+05  2.30422345e+05
  4.56229845e+05  8.45176450e+05  1.52834824e+06  2.85060891e+06
  5.80848755e+06]
E1 = -706.6860544588122  E_coul = 198.695880003553
cycle= 3 E= -507.990174455259  delta_E= -0.000269  |g|= 0.00444  |ddm|= 0.0478
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00457165
diis-c [-3.43750094e-06 -2.58737385e-04 -1.25270885e-01  1.12552962e+00]
  HOMO = -0.243173066526237  LUMO = 0.627366337662804
  mo_energy =
[-1.20327747e+02 -1.23813390e+01 -6.67861506e+00 -6.67861506e+00
 -6.67861506e+00 -1.17971714e+00 -2.43173067e-01 -2.43173067e-01
 -2.43173067e-01  6.27366338e-01  2.99827781e+00  1.40478160e+01
  6.76191843e+01  2.61597300e+02  8.90179692e+02  3.14363017e+03
  1.26239294e+04  4.12210463e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176437e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.669909462928  E_coul = 198.6797293667766
cycle= 4 E= -507.990180096151  delta_E= -5.64e-06  |g|= 0.00022  |ddm|= 0.0108
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169291
diis-c [-1.35835691e-09 -1.13480903e-05  7.98386516e-03 -9.17785139e-02
  1.08380600e+00]
  HOMO = -0.243281112448197  LUMO = 0.627342496257553
  mo_energy =
[-1.20327887e+02 -1.23815434e+01 -6.67880435e+00 -6.67880435e+00
 -6.67880435e+00 -1.17978316e+00 -2.43281112e-01 -2.43281112e-01
 -2.43281112e-01  6.27342496e-01  2.99817278e+00  1.40476328e+01
  6.76190071e+01  2.61597148e+02  8.90179558e+02  3.14363005e+03
  1.26239293e+04  4.12210462e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176436e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.6693682470609  E_coul = 198.67918813719956
cycle= 5 E= -507.990180109861  delta_E= -1.37e-08  |g|= 1.17e-05  |ddm|= 0.000986
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.13183e-06
diis-c [-1.99714720e-12  9.30286883e-07 -9.44835362e-04  1.04032291e-02
 -1.34782954e-01  1.12532363e+00]
  HOMO = -0.24328435739256  LUMO = 0.62734170677337
  mo_energy =
[-1.20327892e+02 -1.23815480e+01 -6.67880888e+00 -6.67880888e+00
 -6.67880888e+00 -1.17978553e+00 -2.43284357e-01 -2.43284357e-01
 -2.43284357e-01  6.27341707e-01  2.99816917e+00  1.40476281e+01
  6.76190025e+01  2.61597143e+02  8.90179553e+02  3.14363004e+03
  1.26239293e+04  4.12210461e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176436e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.6693499358631  E_coul = 198.67916982596873
cycle= 6 E= -507.990180109894  delta_E= -3.3e-11  |g|= 7.5e-08  |ddm|= 6.23e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6693499358631  E_coul = 198.67916982596873
  HOMO = -0.243284384847495  LUMO = 0.627341682470982
  mo_energy =
[-1.20327892e+02 -1.23815480e+01 -6.67880892e+00 -6.67880892e+00
 -6.67880892e+00 -1.17978553e+00 -2.43284385e-01 -2.43284385e-01
 -2.43284385e-01  6.27341682e-01  2.99816913e+00  1.40476281e+01
  6.76190025e+01  2.61597143e+02  8.90179553e+02  3.14363004e+03
  1.26239293e+04  4.12210461e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176436e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.6693498511535  E_coul = 198.6791697412592
Extra cycle  E= -507.990180109894  delta_E= 1.14e-13  |g|= 9.56e-09  |ddm|= 2.56e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912234.4140966804
E1 = -706.6693498511535  E_coul = 198.6791697412592
init E= -507.990180109894
    CPU time for initialize scf      5.69 sec, wall time      0.24 sec
  HOMO = -0.24328438810952  LUMO = 0.627341683383909
  mo_energy =
[-1.20327892e+02 -1.23815480e+01 -6.67880892e+00 -6.67880892e+00
 -6.67880892e+00 -1.17978553e+00 -2.43284388e-01 -2.43284388e-01
 -2.43284388e-01  6.27341683e-01  2.99816913e+00  1.40476281e+01
  6.76190025e+01  2.61597143e+02  8.90179553e+02  3.14363004e+03
  1.26239293e+04  4.12210461e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176436e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.6693498281064  E_coul = 198.67916971821205
cycle= 1 E= -507.990180109894  delta_E= -1.14e-13  |g|= 2.33e-09  |ddm|= 4.32e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6693498281064  E_coul = 198.67916971821205
  HOMO = -0.243284388867341  LUMO = 0.627341683147381
  mo_energy =
[-1.20327892e+02 -1.23815480e+01 -6.67880893e+00 -6.67880893e+00
 -6.67880893e+00 -1.17978553e+00 -2.43284389e-01 -2.43284389e-01
 -2.43284389e-01  6.27341683e-01  2.99816913e+00  1.40476281e+01
  6.76190025e+01  2.61597143e+02  8.90179553e+02  3.14363004e+03
  1.26239293e+04  4.12210461e+04  1.05249220e+05  2.30422331e+05
  4.56229831e+05  8.45176436e+05  1.52834823e+06  2.85060889e+06
  5.80848754e+06]
E1 = -706.6693498258985  E_coul = 198.6791697160048
Extra cycle  E= -507.990180109894  delta_E= 6.82e-13  |g|= 1.61e-09  |ddm|= 3.71e-09
    CPU time for scf_cycle      6.19 sec, wall time      0.41 sec
exp = [2.05173129e-01 4.67209245e-01 8.23307704e-01 1.17616813e+05
 3.15139506e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232120e+03
 1.83757713e+04 1.44353096e+03 4.17362558e+02 1.47784464e+02
 5.84514414e+01 2.45595093e+01 7.57476290e+00 8.60427280e+00
 4.92689945e-01]
grad_E = [-2.83682440e-04  7.01607695e-04 -1.06388627e-03  6.07714778e-09
  8.36270203e-04  4.06065489e-11  1.74643860e-10  9.42583620e-10
  3.72436739e-09  1.55528400e-08  8.11091123e-08  5.11247416e-06
  1.98988755e-07 -3.89335216e-05 -1.64904815e-06 -1.92231194e-05
  7.69788168e-05 -1.05654991e-04 -1.11077263e-03  2.39991413e-05
 -2.34523088e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.208397161048       1
[INPUT] 0    0    [1    /1   ]  0.487232340062       1
[INPUT] 0    0    [1    /1   ]  0.848604925378       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.15591325201        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175469        1
[INPUT] 0    0    [1    /1   ]  36754.7015285        1
[INPUT] 0    0    [1    /1   ]  7302.32109572        1
[INPUT] 0    0    [1    /1   ]  18375.7713245        1
[INPUT] 0    0    [1    /1   ]  1443.53178642        1
[INPUT] 0    0    [1    /1   ]  417.362628378        1
[INPUT] 0    0    [1    /1   ]  147.784676768        1
[INPUT] 0    0    [1    /1   ]  58.4506431835        1
[INPUT] 0    0    [1    /1   ]  24.56058043          1
[INPUT] 0    0    [1    /1   ]  7.58394123902        1
[INPUT] 1    0    [1    /1   ]  8.60407397842        1
[INPUT] 1    0    [1    /1   ]  0.492661311032       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20839716104807046, 1.0]], [0, [0.487232340061833, 1.0]], [0, [0.8486049253779149, 1.0]], [0, [117616.81288893221, 1.0]], [0, [3.155913252008022, 1.0]], [0, [1176168.142613449, 1.0]], [0, [588084.0699565436, 1.0]], [0, [294042.03092134657, 1.0]], [0, [147020.99132296653, 1.0]], [0, [73510.41754692231, 1.0]], [0, [36754.701528492464, 1.0]], [0, [7302.321095715686, 1.0]], [0, [18375.77132447957, 1.0]], [0, [1443.531786418974, 1.0]], [0, [417.3626283781902, 1.0]], [0, [147.78467676825022, 1.0]], [0, [58.450643183510664, 1.0]], [0, [24.560580429958385, 1.0]], [0, [7.583941239023941, 1.0]], [1, [8.60407397842061, 1.0]], [1, [0.4926613110320345, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20839716]
bas 1, expnt(s) = [0.48723234]
bas 2, expnt(s) = [0.84860493]
bas 3, expnt(s) = [117616.81288893]
bas 4, expnt(s) = [3.15591325]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092135]
bas 8, expnt(s) = [147020.99132297]
bas 9, expnt(s) = [73510.41754692]
bas 10, expnt(s) = [36754.70152849]
bas 11, expnt(s) = [7302.32109572]
bas 12, expnt(s) = [18375.77132448]
bas 13, expnt(s) = [1443.53178642]
bas 14, expnt(s) = [417.36262838]
bas 15, expnt(s) = [147.78467677]
bas 16, expnt(s) = [58.45064318]
bas 17, expnt(s) = [24.56058043]
bas 18, expnt(s) = [7.58394124]
bas 19, expnt(s) = [8.60407398]
bas 20, expnt(s) = [0.49266131]
CPU time:       328.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.08397161e-01 7.79262671e-01 4.87232340e-01 1.47338792e+00
 8.48604925e-01 2.23379948e+00 1.17616813e+05 1.60460108e+04
 3.15591325e+00 5.98217092e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232110e+03 1.99577105e+03
 1.83757713e+04 3.98748633e+03 1.44353179e+03 5.91677137e+02
 4.17362628e+02 2.33292186e+02 1.47784677e+02 1.07087081e+02
 5.84506432e+01 5.34080836e+01 2.45605804e+01 2.78736597e+01
 7.58394124e+00 1.15461247e+01 8.60407398e+00 4.29897146e+01
 4.92661311e-01 1.20412054e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336276818885118
cond(S) = 912243.9538392113
E1 = -689.5913216820004  E_coul = 184.96958106259518
init E= -504.621740619405
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.672161950739767  LUMO = 0.35852428097495
  mo_energy =
[-1.21710119e+02 -1.33862130e+01 -7.62371824e+00 -7.62371824e+00
 -7.62371824e+00 -1.65762468e+00 -6.72161951e-01 -6.72161951e-01
 -6.72161951e-01  3.58524281e-01  2.65088648e+00  1.34751802e+01
  6.67144976e+01  2.60506942e+02  8.89043605e+02  3.14254618e+03
  1.26229405e+04  4.12201160e+04  1.05248322e+05  2.30421453e+05
  4.56228968e+05  8.45175585e+05  1.52834739e+06  2.85060806e+06
  5.80848671e+06]
E1 = -707.7455231804668  E_coul = 199.7733798810701
cycle= 1 E= -507.972143299397  delta_E= -3.35  |g|= 0.452  |ddm|= 0.449
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.730137
diis-c [-0.53310075  1.        ]
  HOMO = -0.217766830846943  LUMO = 0.652993568951529
  mo_energy =
[-1.20201395e+02 -1.23051691e+01 -6.59467573e+00 -6.59467573e+00
 -6.59467573e+00 -1.16347845e+00 -2.17766831e-01 -2.17766831e-01
 -2.17766831e-01  6.52993569e-01  3.13717780e+00  1.43427756e+01
  6.79785451e+01  2.61961604e+02  8.90535244e+02  3.14397762e+03
  1.26242653e+04  4.12213736e+04  1.05249542e+05  2.30422649e+05
  4.56230147e+05  8.45176750e+05  1.52834854e+06  2.85060920e+06
  5.80848784e+06]
E1 = -706.7923129920102  E_coul = 198.80239188998877
cycle= 2 E= -507.989921102021  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.31
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0373704
diis-c [-0.001392   -0.00293434  1.00293434]
  HOMO = -0.239986018794535  LUMO = 0.651326382274953
  mo_energy =
[-1.20316102e+02 -1.23728025e+01 -6.66955353e+00 -6.66955353e+00
 -6.66955353e+00 -1.17778633e+00 -2.39986019e-01 -2.39986019e-01
 -2.39986019e-01  6.51326382e-01  3.12073912e+00  1.42935986e+01
  6.78960765e+01  2.61856950e+02  8.90414780e+02  3.14384290e+03
  1.26241204e+04  4.12212248e+04  1.05249392e+05  2.30422498e+05
  4.56229996e+05  8.45176598e+05  1.52834839e+06  2.85060905e+06
  5.80848769e+06]
E1 = -706.6829201075268  E_coul = 198.6927310494955
cycle= 3 E= -507.990189058031  delta_E= -0.000268  |g|= 0.00443  |ddm|= 0.0492
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00455508
diis-c [-3.43166967e-06 -2.45514051e-04 -1.24826491e-01  1.12507200e+00]
  HOMO = -0.243251863958623  LUMO = 0.650902478953967
  mo_energy =
[-1.20328123e+02 -1.23815850e+01 -6.67882516e+00 -6.67882516e+00
 -6.67882516e+00 -1.17977193e+00 -2.43251864e-01 -2.43251864e-01
 -2.43251864e-01  6.50902479e-01  3.11803442e+00  1.42868303e+01
  6.78862896e+01  2.61845596e+02  8.90402510e+02  3.14382993e+03
  1.26241069e+04  4.12212112e+04  1.05249378e+05  2.30422485e+05
  4.56229982e+05  8.45176585e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6668374616336  E_coul = 198.6766428181582
cycle= 4 E= -507.990194643475  delta_E= -5.59e-06  |g|= 0.000217  |ddm|= 0.0111
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000167278
diis-c [-1.26221546e-09 -1.15071611e-05  7.87580770e-03 -9.08640789e-02
  1.08299978e+00]
  HOMO = -0.24335962809863  LUMO = 0.650877737609825
  mo_energy =
[-1.20328265e+02 -1.23817900e+01 -6.67901529e+00 -6.67901529e+00
 -6.67901529e+00 -1.17983773e+00 -2.43359628e-01 -2.43359628e-01
 -2.43359628e-01  6.50877738e-01  3.11792748e+00  1.42866469e+01
  6.78861113e+01  2.61845442e+02  8.90402373e+02  3.14382980e+03
  1.26241068e+04  4.12212111e+04  1.05249378e+05  2.30422485e+05
  4.56229982e+05  8.45176584e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6663007333791  E_coul = 198.67610607677375
cycle= 5 E= -507.990194656605  delta_E= -1.31e-08  |g|= 1.12e-05  |ddm|= 0.000985
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.89495e-06
diis-c [-1.90639082e-12  9.00665323e-07 -9.19738065e-04  1.01523954e-02
 -1.32205803e-01  1.12297225e+00]
  HOMO = -0.243362846612077  LUMO = 0.650876934299769
  mo_energy =
[-1.20328270e+02 -1.23817946e+01 -6.67901987e+00 -6.67901987e+00
 -6.67901987e+00 -1.17984007e+00 -2.43362847e-01 -2.43362847e-01
 -2.43362847e-01  6.50876934e-01  3.11792387e+00  1.42866423e+01
  6.78861067e+01  2.61845438e+02  8.90402368e+02  3.14382980e+03
  1.26241068e+04  4.12212111e+04  1.05249378e+05  2.30422484e+05
  4.56229982e+05  8.45176584e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6662828323003  E_coul = 198.67608817566514
cycle= 6 E= -507.990194656635  delta_E= -2.98e-11  |g|= 7.62e-08  |ddm|= 6.01e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6662828323003  E_coul = 198.67608817566514
  HOMO = -0.243362874430005  LUMO = 0.650876910755154
  mo_energy =
[-1.20328270e+02 -1.23817946e+01 -6.67901992e+00 -6.67901992e+00
 -6.67901992e+00 -1.17984007e+00 -2.43362874e-01 -2.43362874e-01
 -2.43362874e-01  6.50876911e-01  3.11792383e+00  1.42866422e+01
  6.78861067e+01  2.61845438e+02  8.90402368e+02  3.14382980e+03
  1.26241068e+04  4.12212111e+04  1.05249378e+05  2.30422484e+05
  4.56229982e+05  8.45176584e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6662827390095  E_coul = 198.67608808237486
Extra cycle  E= -507.990194656635  delta_E= 5.68e-13  |g|= 9.53e-09  |ddm|= 2.64e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
exp = [2.08397161e-01 4.87232340e-01 8.48604925e-01 1.17616813e+05
 3.15591325e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232110e+03
 1.83757713e+04 1.44353179e+03 4.17362628e+02 1.47784677e+02
 5.84506432e+01 2.45605804e+01 7.58394124e+00 8.60407398e+00
 4.92661311e-01]
E = -507.9901946566346
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.208397161048       1
[INPUT] 0    0    [1    /1   ]  0.487232340062       1
[INPUT] 0    0    [1    /1   ]  0.848604925378       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.15591325201        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175469        1
[INPUT] 0    0    [1    /1   ]  36754.7015285        1
[INPUT] 0    0    [1    /1   ]  7302.32109572        1
[INPUT] 0    0    [1    /1   ]  18375.7713245        1
[INPUT] 0    0    [1    /1   ]  1443.53178642        1
[INPUT] 0    0    [1    /1   ]  417.362628378        1
[INPUT] 0    0    [1    /1   ]  147.784676768        1
[INPUT] 0    0    [1    /1   ]  58.4506431835        1
[INPUT] 0    0    [1    /1   ]  24.56058043          1
[INPUT] 0    0    [1    /1   ]  7.58394123902        1
[INPUT] 1    0    [1    /1   ]  8.60407397842        1
[INPUT] 1    0    [1    /1   ]  0.492661311032       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20839716104807046, 1.0]], [0, [0.487232340061833, 1.0]], [0, [0.8486049253779149, 1.0]], [0, [117616.81288893221, 1.0]], [0, [3.155913252008022, 1.0]], [0, [1176168.142613449, 1.0]], [0, [588084.0699565436, 1.0]], [0, [294042.03092134657, 1.0]], [0, [147020.99132296653, 1.0]], [0, [73510.41754692231, 1.0]], [0, [36754.701528492464, 1.0]], [0, [7302.321095715686, 1.0]], [0, [18375.77132447957, 1.0]], [0, [1443.531786418974, 1.0]], [0, [417.3626283781902, 1.0]], [0, [147.78467676825022, 1.0]], [0, [58.450643183510664, 1.0]], [0, [24.560580429958385, 1.0]], [0, [7.583941239023941, 1.0]], [1, [8.60407397842061, 1.0]], [1, [0.4926613110320345, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20839716]
bas 1, expnt(s) = [0.48723234]
bas 2, expnt(s) = [0.84860493]
bas 3, expnt(s) = [117616.81288893]
bas 4, expnt(s) = [3.15591325]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092135]
bas 8, expnt(s) = [147020.99132297]
bas 9, expnt(s) = [73510.41754692]
bas 10, expnt(s) = [36754.70152849]
bas 11, expnt(s) = [7302.32109572]
bas 12, expnt(s) = [18375.77132448]
bas 13, expnt(s) = [1443.53178642]
bas 14, expnt(s) = [417.36262838]
bas 15, expnt(s) = [147.78467677]
bas 16, expnt(s) = [58.45064318]
bas 17, expnt(s) = [24.56058043]
bas 18, expnt(s) = [7.58394124]
bas 19, expnt(s) = [8.60407398]
bas 20, expnt(s) = [0.49266131]
CPU time:       330.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.08397161e-01 7.79262671e-01 4.87232340e-01 1.47338792e+00
 8.48604925e-01 2.23379948e+00 1.17616813e+05 1.60460108e+04
 3.15591325e+00 5.98217092e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232110e+03 1.99577105e+03
 1.83757713e+04 3.98748633e+03 1.44353179e+03 5.91677137e+02
 4.17362628e+02 2.33292186e+02 1.47784677e+02 1.07087081e+02
 5.84506432e+01 5.34080836e+01 2.45605804e+01 2.78736597e+01
 7.58394124e+00 1.15461247e+01 8.60407398e+00 4.29897146e+01
 4.92661311e-01 1.20412054e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336276818885118
cond(S) = 912243.9538392113
E1 = -689.5913216820004  E_coul = 184.96958106259518
init E= -504.621740619405
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.672161950739767  LUMO = 0.35852428097495
  mo_energy =
[-1.21710119e+02 -1.33862130e+01 -7.62371824e+00 -7.62371824e+00
 -7.62371824e+00 -1.65762468e+00 -6.72161951e-01 -6.72161951e-01
 -6.72161951e-01  3.58524281e-01  2.65088648e+00  1.34751802e+01
  6.67144976e+01  2.60506942e+02  8.89043605e+02  3.14254618e+03
  1.26229405e+04  4.12201160e+04  1.05248322e+05  2.30421453e+05
  4.56228968e+05  8.45175585e+05  1.52834739e+06  2.85060806e+06
  5.80848671e+06]
E1 = -707.7455231804668  E_coul = 199.7733798810701
cycle= 1 E= -507.972143299397  delta_E= -3.35  |g|= 0.452  |ddm|= 0.449
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.730137
diis-c [-0.53310075  1.        ]
  HOMO = -0.217766830846943  LUMO = 0.652993568951529
  mo_energy =
[-1.20201395e+02 -1.23051691e+01 -6.59467573e+00 -6.59467573e+00
 -6.59467573e+00 -1.16347845e+00 -2.17766831e-01 -2.17766831e-01
 -2.17766831e-01  6.52993569e-01  3.13717780e+00  1.43427756e+01
  6.79785451e+01  2.61961604e+02  8.90535244e+02  3.14397762e+03
  1.26242653e+04  4.12213736e+04  1.05249542e+05  2.30422649e+05
  4.56230147e+05  8.45176750e+05  1.52834854e+06  2.85060920e+06
  5.80848784e+06]
E1 = -706.7923129920102  E_coul = 198.80239188998877
cycle= 2 E= -507.989921102021  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.31
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0373704
diis-c [-0.001392   -0.00293434  1.00293434]
  HOMO = -0.239986018794535  LUMO = 0.651326382274953
  mo_energy =
[-1.20316102e+02 -1.23728025e+01 -6.66955353e+00 -6.66955353e+00
 -6.66955353e+00 -1.17778633e+00 -2.39986019e-01 -2.39986019e-01
 -2.39986019e-01  6.51326382e-01  3.12073912e+00  1.42935986e+01
  6.78960765e+01  2.61856950e+02  8.90414780e+02  3.14384290e+03
  1.26241204e+04  4.12212248e+04  1.05249392e+05  2.30422498e+05
  4.56229996e+05  8.45176598e+05  1.52834839e+06  2.85060905e+06
  5.80848769e+06]
E1 = -706.6829201075268  E_coul = 198.6927310494955
cycle= 3 E= -507.990189058031  delta_E= -0.000268  |g|= 0.00443  |ddm|= 0.0492
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00455508
diis-c [-3.43166967e-06 -2.45514051e-04 -1.24826491e-01  1.12507200e+00]
  HOMO = -0.243251863958623  LUMO = 0.650902478953967
  mo_energy =
[-1.20328123e+02 -1.23815850e+01 -6.67882516e+00 -6.67882516e+00
 -6.67882516e+00 -1.17977193e+00 -2.43251864e-01 -2.43251864e-01
 -2.43251864e-01  6.50902479e-01  3.11803442e+00  1.42868303e+01
  6.78862896e+01  2.61845596e+02  8.90402510e+02  3.14382993e+03
  1.26241069e+04  4.12212112e+04  1.05249378e+05  2.30422485e+05
  4.56229982e+05  8.45176585e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6668374616336  E_coul = 198.6766428181582
cycle= 4 E= -507.990194643475  delta_E= -5.59e-06  |g|= 0.000217  |ddm|= 0.0111
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000167278
diis-c [-1.26221546e-09 -1.15071611e-05  7.87580770e-03 -9.08640789e-02
  1.08299978e+00]
  HOMO = -0.24335962809863  LUMO = 0.650877737609825
  mo_energy =
[-1.20328265e+02 -1.23817900e+01 -6.67901529e+00 -6.67901529e+00
 -6.67901529e+00 -1.17983773e+00 -2.43359628e-01 -2.43359628e-01
 -2.43359628e-01  6.50877738e-01  3.11792748e+00  1.42866469e+01
  6.78861113e+01  2.61845442e+02  8.90402373e+02  3.14382980e+03
  1.26241068e+04  4.12212111e+04  1.05249378e+05  2.30422485e+05
  4.56229982e+05  8.45176584e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6663007333791  E_coul = 198.67610607677375
cycle= 5 E= -507.990194656605  delta_E= -1.31e-08  |g|= 1.12e-05  |ddm|= 0.000985
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.89495e-06
diis-c [-1.90639082e-12  9.00665323e-07 -9.19738065e-04  1.01523954e-02
 -1.32205803e-01  1.12297225e+00]
  HOMO = -0.243362846612077  LUMO = 0.650876934299769
  mo_energy =
[-1.20328270e+02 -1.23817946e+01 -6.67901987e+00 -6.67901987e+00
 -6.67901987e+00 -1.17984007e+00 -2.43362847e-01 -2.43362847e-01
 -2.43362847e-01  6.50876934e-01  3.11792387e+00  1.42866423e+01
  6.78861067e+01  2.61845438e+02  8.90402368e+02  3.14382980e+03
  1.26241068e+04  4.12212111e+04  1.05249378e+05  2.30422484e+05
  4.56229982e+05  8.45176584e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6662828323003  E_coul = 198.67608817566514
cycle= 6 E= -507.990194656635  delta_E= -2.98e-11  |g|= 7.62e-08  |ddm|= 6.01e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6662828323003  E_coul = 198.67608817566514
  HOMO = -0.243362874430005  LUMO = 0.650876910755154
  mo_energy =
[-1.20328270e+02 -1.23817946e+01 -6.67901992e+00 -6.67901992e+00
 -6.67901992e+00 -1.17984007e+00 -2.43362874e-01 -2.43362874e-01
 -2.43362874e-01  6.50876911e-01  3.11792383e+00  1.42866422e+01
  6.78861067e+01  2.61845438e+02  8.90402368e+02  3.14382980e+03
  1.26241068e+04  4.12212111e+04  1.05249378e+05  2.30422484e+05
  4.56229982e+05  8.45176584e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6662827390095  E_coul = 198.67608808237486
Extra cycle  E= -507.990194656635  delta_E= 5.68e-13  |g|= 9.53e-09  |ddm|= 2.64e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912243.9538392113
E1 = -706.6662827390095  E_coul = 198.67608808237486
init E= -507.990194656635
    CPU time for initialize scf      5.56 sec, wall time      0.23 sec
  HOMO = -0.243362877927612  LUMO = 0.650876911487436
  mo_energy =
[-1.20328270e+02 -1.23817946e+01 -6.67901992e+00 -6.67901992e+00
 -6.67901992e+00 -1.17984007e+00 -2.43362878e-01 -2.43362878e-01
 -2.43362878e-01  6.50876911e-01  3.11792383e+00  1.42866422e+01
  6.78861067e+01  2.61845437e+02  8.90402368e+02  3.14382980e+03
  1.26241068e+04  4.12212111e+04  1.05249378e+05  2.30422484e+05
  4.56229982e+05  8.45176584e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6662827173591  E_coul = 198.6760880607243
cycle= 1 E= -507.990194656635  delta_E= -1.71e-13  |g|= 1.51e-09  |ddm|= 4.23e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6662827173591  E_coul = 198.6760880607243
  HOMO = -0.243362878651869  LUMO = 0.650876910240985
  mo_energy =
[-1.20328270e+02 -1.23817946e+01 -6.67901993e+00 -6.67901993e+00
 -6.67901993e+00 -1.17984007e+00 -2.43362879e-01 -2.43362879e-01
 -2.43362879e-01  6.50876910e-01  3.11792383e+00  1.42866422e+01
  6.78861067e+01  2.61845437e+02  8.90402368e+02  3.14382980e+03
  1.26241068e+04  4.12212111e+04  1.05249378e+05  2.30422484e+05
  4.56229982e+05  8.45176584e+05  1.52834838e+06  2.85060904e+06
  5.80848768e+06]
E1 = -706.6662827145678  E_coul = 198.67608805793276
Extra cycle  E= -507.990194656635  delta_E= -2.84e-13  |g|= 1.86e-09  |ddm|= 5.54e-09
    CPU time for scf_cycle      6.07 sec, wall time      0.40 sec
exp = [2.08397161e-01 4.87232340e-01 8.48604925e-01 1.17616813e+05
 3.15591325e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232110e+03
 1.83757713e+04 1.44353179e+03 4.17362628e+02 1.47784677e+02
 5.84506432e+01 2.45605804e+01 7.58394124e+00 8.60407398e+00
 4.92661311e-01]
grad_E = [-1.62452383e-03  1.36754624e-03 -9.41096046e-04  6.07644104e-09
  4.14218136e-04  4.05986774e-11  1.74620643e-10  9.42475385e-10
  3.72392952e-09  1.55509864e-08  8.11001915e-08  5.11190734e-06
  1.98959283e-07 -3.89092974e-05 -1.89027903e-06 -1.80037156e-05
  7.16838073e-05 -1.00096321e-04 -9.71844690e-04 -1.24202629e-04
 -3.33683404e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.214515509345       1
[INPUT] 0    0    [1    /1   ]  0.504794153826       1
[INPUT] 0    0    [1    /1   ]  0.875683460195       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.15565993757        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175466        1
[INPUT] 0    0    [1    /1   ]  36754.7015266        1
[INPUT] 0    0    [1    /1   ]  7302.32097364        1
[INPUT] 0    0    [1    /1   ]  18375.7713197        1
[INPUT] 0    0    [1    /1   ]  1443.53271346        1
[INPUT] 0    0    [1    /1   ]  417.362700496        1
[INPUT] 0    0    [1    /1   ]  147.784954844        1
[INPUT] 0    0    [1    /1   ]  58.4495782265        1
[INPUT] 0    0    [1    /1   ]  24.5620211789        1
[INPUT] 0    0    [1    /1   ]  7.59732195728        1
[INPUT] 1    0    [1    /1   ]  8.60405281948        1
[INPUT] 1    0    [1    /1   ]  0.492669311836       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21451550934529764, 1.0]], [0, [0.5047941538263736, 1.0]], [0, [0.8756834601949601, 1.0]], [0, [117616.8128887871, 1.0]], [0, [3.1556599375713215, 1.0]], [0, [1176168.142613448, 1.0]], [0, [588084.0699565394, 1.0]], [0, [294042.03092132404, 1.0]], [0, [147020.99132287758, 1.0]], [0, [73510.41754655095, 1.0]], [0, [36754.70152655569, 1.0]], [0, [7302.320973638697, 1.0]], [0, [18375.7713197289, 1.0]], [0, [1443.5327134562526, 1.0]], [0, [417.36270049577513, 1.0]], [0, [147.7849548437296, 1.0]], [0, [58.44957822652377, 1.0]], [0, [24.562021178933875, 1.0]], [0, [7.597321957283569, 1.0]], [1, [8.604052819475031, 1.0]], [1, [0.49266931183645685, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21451551]
bas 1, expnt(s) = [0.50479415]
bas 2, expnt(s) = [0.87568346]
bas 3, expnt(s) = [117616.81288879]
bas 4, expnt(s) = [3.15565994]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132288]
bas 9, expnt(s) = [73510.41754655]
bas 10, expnt(s) = [36754.70152656]
bas 11, expnt(s) = [7302.32097364]
bas 12, expnt(s) = [18375.77131973]
bas 13, expnt(s) = [1443.53271346]
bas 14, expnt(s) = [417.3627005]
bas 15, expnt(s) = [147.78495484]
bas 16, expnt(s) = [58.44957823]
bas 17, expnt(s) = [24.56202118]
bas 18, expnt(s) = [7.59732196]
bas 19, expnt(s) = [8.60405282]
bas 20, expnt(s) = [0.49266931]
CPU time:       344.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14515509e-01 7.96359283e-01 5.04794154e-01 1.51304123e+00
 8.75683460e-01 2.28704855e+00 1.17616813e+05 1.60460108e+04
 3.15565994e+00 5.98181079e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232097e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353271e+03 5.91677422e+02
 4.17362700e+02 2.33292217e+02 1.47784955e+02 1.07087232e+02
 5.84495782e+01 5.34073538e+01 2.45620212e+01 2.78748860e+01
 7.59732196e+00 1.15613999e+01 8.60405282e+00 4.29895825e+01
 4.92669312e-01 1.20414499e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336249033740614
cond(S) = 912254.0890883106
E1 = -689.5923535901771  E_coul = 184.97001162490926
init E= -504.622341965268
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672146543572631  LUMO = 0.382632187321297
  mo_energy =
[-1.21710087e+02 -1.33861915e+01 -7.62368689e+00 -7.62368689e+00
 -7.62368689e+00 -1.65761760e+00 -6.72146544e-01 -6.72146544e-01
 -6.72146544e-01  3.82632187e-01  2.77286724e+00  1.37153699e+01
  6.69863673e+01  2.60762727e+02  8.89273826e+02  3.14275283e+03
  1.26231244e+04  4.12202869e+04  1.05248486e+05  2.30421613e+05
  4.56229124e+05  8.45175738e+05  1.52834754e+06  2.85060821e+06
  5.80848685e+06]
E1 = -707.7460254707298  E_coul = 199.77385931967925
cycle= 1 E= -507.972166151051  delta_E= -3.35  |g|= 0.452  |ddm|= 0.457
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.730289
diis-c [-0.53332194  1.        ]
  HOMO = -0.217750649092098  LUMO = 0.682624910211859
  mo_energy =
[-1.20201346e+02 -1.23051469e+01 -6.59464482e+00 -6.59464482e+00
 -6.59464482e+00 -1.16346295e+00 -2.17750649e-01 -2.17750649e-01
 -2.17750649e-01  6.82624910e-01  3.26566504e+00  1.45836654e+01
  6.82501059e+01  2.62217287e+02  8.90765455e+02  3.14418429e+03
  1.26244492e+04  4.12215445e+04  1.05249706e+05  2.30422809e+05
  4.56230303e+05  8.45176904e+05  1.52834869e+06  2.85060935e+06
  5.80848799e+06]
E1 = -706.7932205606241  E_coul = 198.80328101577817
cycle= 2 E= -507.989939544846  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.309
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0371402
diis-c [-0.0013753  -0.00278375  1.00278375]
  HOMO = -0.239939485519808  LUMO = 0.680803031366725
  mo_energy =
[-1.20316022e+02 -1.23727444e+01 -6.66948905e+00 -6.66948905e+00
 -6.66948905e+00 -1.17774769e+00 -2.39939486e-01 -2.39939486e-01
 -2.39939486e-01  6.80803031e-01  3.24865764e+00  1.45343589e+01
  6.81676722e+01  2.62112673e+02  8.90645024e+02  3.14404961e+03
  1.26243043e+04  4.12213958e+04  1.05249556e+05  2.30422658e+05
  4.56230152e+05  8.45176752e+05  1.52834854e+06  2.85060920e+06
  5.80848784e+06]
E1 = -706.6842005491101  E_coul = 198.69399468580593
cycle= 3 E= -507.990205863304  delta_E= -0.000266  |g|= 0.00442  |ddm|= 0.0513
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00449686
diis-c [-3.38384844e-06 -2.26508929e-04 -1.23790553e-01  1.12401706e+00]
  HOMO = -0.243189198926472  LUMO = 0.680352806971561
  mo_energy =
[-1.20328014e+02 -1.23814977e+01 -6.67873179e+00 -6.67873179e+00
 -6.67873179e+00 -1.17972275e+00 -2.43189199e-01 -2.43189199e-01
 -2.43189199e-01  6.80352807e-01  3.24588518e+00  1.45276007e+01
  6.81579149e+01  2.62101349e+02  8.90632784e+02  3.14403666e+03
  1.26242909e+04  4.12213822e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.6682416948632  E_coul = 198.6780303346047
cycle= 4 E= -507.990211360259  delta_E= -5.5e-06  |g|= 0.000215  |ddm|= 0.0115
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000164525
diis-c [-1.14282185e-09 -1.14384099e-05  7.74889124e-03 -9.01740045e-02
  1.08243655e+00]
  HOMO = -0.243297617582384  LUMO = 0.680327046890894
  mo_energy =
[-1.20328163e+02 -1.23817067e+01 -6.67892645e+00 -6.67892645e+00
 -6.67892645e+00 -1.17978890e+00 -2.43297618e-01 -2.43297618e-01
 -2.43297618e-01  6.80327047e-01  3.24577583e+00  1.45274148e+01
  6.81577316e+01  2.62101188e+02  8.90632639e+02  3.14403653e+03
  1.26242908e+04  4.12213821e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.6677051905875  E_coul = 198.67749381769593
cycle= 5 E= -507.990211372892  delta_E= -1.26e-08  |g|= 1.07e-05  |ddm|= 0.000982
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.61008e-06
diis-c [-1.80381159e-12  8.64260271e-07 -8.91188124e-04  9.91290746e-03
 -1.29448669e-01  1.12042609e+00]
  HOMO = -0.243300841426835  LUMO = 0.680326229133565
  mo_energy =
[-1.20328168e+02 -1.23817115e+01 -6.67893122e+00 -6.67893122e+00
 -6.67893122e+00 -1.17979123e+00 -2.43300841e-01 -2.43300841e-01
 -2.43300841e-01  6.80326229e-01  3.24577221e+00  1.45274100e+01
  6.81577268e+01  2.62101183e+02  8.90632634e+02  3.14403652e+03
  1.26242908e+04  4.12213821e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.667687557071  E_coul = 198.6774761841529
cycle= 6 E= -507.990211372918  delta_E= -2.64e-11  |g|= 7.84e-08  |ddm|= 5.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.667687557071  E_coul = 198.6774761841529
  HOMO = -0.243300870580232  LUMO = 0.680326203664945
  mo_energy =
[-1.20328168e+02 -1.23817115e+01 -6.67893127e+00 -6.67893127e+00
 -6.67893127e+00 -1.17979123e+00 -2.43300871e-01 -2.43300871e-01
 -2.43300871e-01  6.80326204e-01  3.24577217e+00  1.45274100e+01
  6.81577267e+01  2.62101183e+02  8.90632634e+02  3.14403652e+03
  1.26242908e+04  4.12213821e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.6676874594698  E_coul = 198.6774760865514
Extra cycle  E= -507.990211372918  delta_E= -3.41e-13  |g|= 1.03e-08  |ddm|= 2.78e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
exp = [2.14515509e-01 5.04794154e-01 8.75683460e-01 1.17616813e+05
 3.15565994e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232097e+03
 1.83757713e+04 1.44353271e+03 4.17362700e+02 1.47784955e+02
 5.84495782e+01 2.45620212e+01 7.59732196e+00 8.60405282e+00
 4.92669312e-01]
E = -507.9902113729184
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.214515509345       1
[INPUT] 0    0    [1    /1   ]  0.504794153826       1
[INPUT] 0    0    [1    /1   ]  0.875683460195       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.15565993757        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175466        1
[INPUT] 0    0    [1    /1   ]  36754.7015266        1
[INPUT] 0    0    [1    /1   ]  7302.32097364        1
[INPUT] 0    0    [1    /1   ]  18375.7713197        1
[INPUT] 0    0    [1    /1   ]  1443.53271346        1
[INPUT] 0    0    [1    /1   ]  417.362700496        1
[INPUT] 0    0    [1    /1   ]  147.784954844        1
[INPUT] 0    0    [1    /1   ]  58.4495782265        1
[INPUT] 0    0    [1    /1   ]  24.5620211789        1
[INPUT] 0    0    [1    /1   ]  7.59732195728        1
[INPUT] 1    0    [1    /1   ]  8.60405281948        1
[INPUT] 1    0    [1    /1   ]  0.492669311836       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21451550934529764, 1.0]], [0, [0.5047941538263736, 1.0]], [0, [0.8756834601949601, 1.0]], [0, [117616.8128887871, 1.0]], [0, [3.1556599375713215, 1.0]], [0, [1176168.142613448, 1.0]], [0, [588084.0699565394, 1.0]], [0, [294042.03092132404, 1.0]], [0, [147020.99132287758, 1.0]], [0, [73510.41754655095, 1.0]], [0, [36754.70152655569, 1.0]], [0, [7302.320973638697, 1.0]], [0, [18375.7713197289, 1.0]], [0, [1443.5327134562526, 1.0]], [0, [417.36270049577513, 1.0]], [0, [147.7849548437296, 1.0]], [0, [58.44957822652377, 1.0]], [0, [24.562021178933875, 1.0]], [0, [7.597321957283569, 1.0]], [1, [8.604052819475031, 1.0]], [1, [0.49266931183645685, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21451551]
bas 1, expnt(s) = [0.50479415]
bas 2, expnt(s) = [0.87568346]
bas 3, expnt(s) = [117616.81288879]
bas 4, expnt(s) = [3.15565994]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132288]
bas 9, expnt(s) = [73510.41754655]
bas 10, expnt(s) = [36754.70152656]
bas 11, expnt(s) = [7302.32097364]
bas 12, expnt(s) = [18375.77131973]
bas 13, expnt(s) = [1443.53271346]
bas 14, expnt(s) = [417.3627005]
bas 15, expnt(s) = [147.78495484]
bas 16, expnt(s) = [58.44957823]
bas 17, expnt(s) = [24.56202118]
bas 18, expnt(s) = [7.59732196]
bas 19, expnt(s) = [8.60405282]
bas 20, expnt(s) = [0.49266931]
CPU time:       345.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14515509e-01 7.96359283e-01 5.04794154e-01 1.51304123e+00
 8.75683460e-01 2.28704855e+00 1.17616813e+05 1.60460108e+04
 3.15565994e+00 5.98181079e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232097e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353271e+03 5.91677422e+02
 4.17362700e+02 2.33292217e+02 1.47784955e+02 1.07087232e+02
 5.84495782e+01 5.34073538e+01 2.45620212e+01 2.78748860e+01
 7.59732196e+00 1.15613999e+01 8.60405282e+00 4.29895825e+01
 4.92669312e-01 1.20414499e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336249033740614
cond(S) = 912254.0890883106
E1 = -689.5923535901771  E_coul = 184.97001162490926
init E= -504.622341965268
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672146543572631  LUMO = 0.382632187321297
  mo_energy =
[-1.21710087e+02 -1.33861915e+01 -7.62368689e+00 -7.62368689e+00
 -7.62368689e+00 -1.65761760e+00 -6.72146544e-01 -6.72146544e-01
 -6.72146544e-01  3.82632187e-01  2.77286724e+00  1.37153699e+01
  6.69863673e+01  2.60762727e+02  8.89273826e+02  3.14275283e+03
  1.26231244e+04  4.12202869e+04  1.05248486e+05  2.30421613e+05
  4.56229124e+05  8.45175738e+05  1.52834754e+06  2.85060821e+06
  5.80848685e+06]
E1 = -707.7460254707298  E_coul = 199.77385931967925
cycle= 1 E= -507.972166151051  delta_E= -3.35  |g|= 0.452  |ddm|= 0.457
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.730289
diis-c [-0.53332194  1.        ]
  HOMO = -0.217750649092098  LUMO = 0.682624910211859
  mo_energy =
[-1.20201346e+02 -1.23051469e+01 -6.59464482e+00 -6.59464482e+00
 -6.59464482e+00 -1.16346295e+00 -2.17750649e-01 -2.17750649e-01
 -2.17750649e-01  6.82624910e-01  3.26566504e+00  1.45836654e+01
  6.82501059e+01  2.62217287e+02  8.90765455e+02  3.14418429e+03
  1.26244492e+04  4.12215445e+04  1.05249706e+05  2.30422809e+05
  4.56230303e+05  8.45176904e+05  1.52834869e+06  2.85060935e+06
  5.80848799e+06]
E1 = -706.7932205606241  E_coul = 198.80328101577817
cycle= 2 E= -507.989939544846  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.309
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0371402
diis-c [-0.0013753  -0.00278375  1.00278375]
  HOMO = -0.239939485519808  LUMO = 0.680803031366725
  mo_energy =
[-1.20316022e+02 -1.23727444e+01 -6.66948905e+00 -6.66948905e+00
 -6.66948905e+00 -1.17774769e+00 -2.39939486e-01 -2.39939486e-01
 -2.39939486e-01  6.80803031e-01  3.24865764e+00  1.45343589e+01
  6.81676722e+01  2.62112673e+02  8.90645024e+02  3.14404961e+03
  1.26243043e+04  4.12213958e+04  1.05249556e+05  2.30422658e+05
  4.56230152e+05  8.45176752e+05  1.52834854e+06  2.85060920e+06
  5.80848784e+06]
E1 = -706.6842005491101  E_coul = 198.69399468580593
cycle= 3 E= -507.990205863304  delta_E= -0.000266  |g|= 0.00442  |ddm|= 0.0513
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00449686
diis-c [-3.38384844e-06 -2.26508929e-04 -1.23790553e-01  1.12401706e+00]
  HOMO = -0.243189198926472  LUMO = 0.680352806971561
  mo_energy =
[-1.20328014e+02 -1.23814977e+01 -6.67873179e+00 -6.67873179e+00
 -6.67873179e+00 -1.17972275e+00 -2.43189199e-01 -2.43189199e-01
 -2.43189199e-01  6.80352807e-01  3.24588518e+00  1.45276007e+01
  6.81579149e+01  2.62101349e+02  8.90632784e+02  3.14403666e+03
  1.26242909e+04  4.12213822e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.6682416948632  E_coul = 198.6780303346047
cycle= 4 E= -507.990211360259  delta_E= -5.5e-06  |g|= 0.000215  |ddm|= 0.0115
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000164525
diis-c [-1.14282185e-09 -1.14384099e-05  7.74889124e-03 -9.01740045e-02
  1.08243655e+00]
  HOMO = -0.243297617582384  LUMO = 0.680327046890894
  mo_energy =
[-1.20328163e+02 -1.23817067e+01 -6.67892645e+00 -6.67892645e+00
 -6.67892645e+00 -1.17978890e+00 -2.43297618e-01 -2.43297618e-01
 -2.43297618e-01  6.80327047e-01  3.24577583e+00  1.45274148e+01
  6.81577316e+01  2.62101188e+02  8.90632639e+02  3.14403653e+03
  1.26242908e+04  4.12213821e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.6677051905875  E_coul = 198.67749381769593
cycle= 5 E= -507.990211372892  delta_E= -1.26e-08  |g|= 1.07e-05  |ddm|= 0.000982
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.61008e-06
diis-c [-1.80381159e-12  8.64260271e-07 -8.91188124e-04  9.91290746e-03
 -1.29448669e-01  1.12042609e+00]
  HOMO = -0.243300841426835  LUMO = 0.680326229133565
  mo_energy =
[-1.20328168e+02 -1.23817115e+01 -6.67893122e+00 -6.67893122e+00
 -6.67893122e+00 -1.17979123e+00 -2.43300841e-01 -2.43300841e-01
 -2.43300841e-01  6.80326229e-01  3.24577221e+00  1.45274100e+01
  6.81577268e+01  2.62101183e+02  8.90632634e+02  3.14403652e+03
  1.26242908e+04  4.12213821e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.667687557071  E_coul = 198.6774761841529
cycle= 6 E= -507.990211372918  delta_E= -2.64e-11  |g|= 7.84e-08  |ddm|= 5.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.667687557071  E_coul = 198.6774761841529
  HOMO = -0.243300870580232  LUMO = 0.680326203664945
  mo_energy =
[-1.20328168e+02 -1.23817115e+01 -6.67893127e+00 -6.67893127e+00
 -6.67893127e+00 -1.17979123e+00 -2.43300871e-01 -2.43300871e-01
 -2.43300871e-01  6.80326204e-01  3.24577217e+00  1.45274100e+01
  6.81577267e+01  2.62101183e+02  8.90632634e+02  3.14403652e+03
  1.26242908e+04  4.12213821e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.6676874594698  E_coul = 198.6774760865514
Extra cycle  E= -507.990211372918  delta_E= -3.41e-13  |g|= 1.03e-08  |ddm|= 2.78e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912254.0890883106
E1 = -706.6676874594698  E_coul = 198.6774760865514
init E= -507.990211372918
    CPU time for initialize scf      5.54 sec, wall time      0.23 sec
  HOMO = -0.243300874228671  LUMO = 0.680326203746376
  mo_energy =
[-1.20328168e+02 -1.23817115e+01 -6.67893128e+00 -6.67893128e+00
 -6.67893128e+00 -1.17979123e+00 -2.43300874e-01 -2.43300874e-01
 -2.43300874e-01  6.80326204e-01  3.24577217e+00  1.45274100e+01
  6.81577267e+01  2.62101183e+02  8.90632634e+02  3.14403652e+03
  1.26242908e+04  4.12213821e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.6676874374042  E_coul = 198.67747606448623
cycle= 1 E= -507.990211372918  delta_E= 3.98e-13  |g|= 2.29e-09  |ddm|= 4.3e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6676874374042  E_coul = 198.67747606448623
  HOMO = -0.243300874956565  LUMO = 0.68032620348804
  mo_energy =
[-1.20328168e+02 -1.23817115e+01 -6.67893128e+00 -6.67893128e+00
 -6.67893128e+00 -1.17979123e+00 -2.43300875e-01 -2.43300875e-01
 -2.43300875e-01  6.80326203e-01  3.24577217e+00  1.45274100e+01
  6.81577267e+01  2.62101183e+02  8.90632634e+02  3.14403652e+03
  1.26242908e+04  4.12213821e+04  1.05249542e+05  2.30422644e+05
  4.56230138e+05  8.45176738e+05  1.52834853e+06  2.85060918e+06
  5.80848782e+06]
E1 = -706.6676874320226  E_coul = 198.67747605910446
Extra cycle  E= -507.990211372918  delta_E= -1.14e-13  |g|= 2.67e-09  |ddm|= 6.42e-09
    CPU time for scf_cycle      6.05 sec, wall time      0.40 sec
exp = [2.14515509e-01 5.04794154e-01 8.75683460e-01 1.17616813e+05
 3.15565994e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232097e+03
 1.83757713e+04 1.44353271e+03 4.17362700e+02 1.47784955e+02
 5.84495782e+01 2.45620212e+01 7.59732196e+00 8.60405282e+00
 4.92669312e-01]
grad_E = [-2.27142048e-04  1.20581084e-03 -6.76999118e-04  6.07509729e-09
 -1.20964651e-04  4.05836770e-11  1.74576482e-10  9.42269580e-10
  3.72309697e-09  1.55474621e-08  8.10832290e-08  5.11082523e-06
  1.98903244e-07 -3.88620983e-05 -2.36546811e-06 -1.55458241e-05
  6.11391393e-05 -8.82490878e-05 -7.45477378e-04 -1.54865360e-04
 -2.73459561e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.211038344884       1
[INPUT] 0    0    [1    /1   ]  0.496636216119       1
[INPUT] 0    0    [1    /1   ]  0.881700906258       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.14138963964        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175464        1
[INPUT] 0    0    [1    /1   ]  36754.7015259        1
[INPUT] 0    0    [1    /1   ]  7302.32093323        1
[INPUT] 0    0    [1    /1   ]  18375.7713182        1
[INPUT] 0    0    [1    /1   ]  1443.53302202        1
[INPUT] 0    0    [1    /1   ]  417.362703186        1
[INPUT] 0    0    [1    /1   ]  147.785163941        1
[INPUT] 0    0    [1    /1   ]  58.4487257793        1
[INPUT] 0    0    [1    /1   ]  24.5632026536        1
[INPUT] 0    0    [1    /1   ]  7.61060725772        1
[INPUT] 1    0    [1    /1   ]  8.60416225527        1
[INPUT] 1    0    [1    /1   ]  0.492715162525       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21103834488405776, 1.0]], [0, [0.49663621611930536, 1.0]], [0, [0.8817009062579331, 1.0]], [0, [117616.81288873906, 1.0]], [0, [3.141389639644591, 1.0]], [0, [1176168.1426134477, 1.0]], [0, [588084.069956538, 1.0]], [0, [294042.0309213166, 1.0]], [0, [147020.99132284816, 1.0]], [0, [73510.41754642801, 1.0]], [0, [36754.70152591461, 1.0]], [0, [7302.320933229188, 1.0]], [0, [18375.77131815581, 1.0]], [0, [1443.5330220229366, 1.0]], [0, [417.36270318615294, 1.0]], [0, [147.7851639413415, 1.0]], [0, [58.44872577925931, 1.0]], [0, [24.56320265361848, 1.0]], [0, [7.610607257718248, 1.0]], [1, [8.604162255270522, 1.0]], [1, [0.49271516252505015, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21103834]
bas 1, expnt(s) = [0.49663622]
bas 2, expnt(s) = [0.88170091]
bas 3, expnt(s) = [117616.81288874]
bas 4, expnt(s) = [3.14138964]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132285]
bas 9, expnt(s) = [73510.41754643]
bas 10, expnt(s) = [36754.70152591]
bas 11, expnt(s) = [7302.32093323]
bas 12, expnt(s) = [18375.77131816]
bas 13, expnt(s) = [1443.53302202]
bas 14, expnt(s) = [417.36270319]
bas 15, expnt(s) = [147.78516394]
bas 16, expnt(s) = [58.44872578]
bas 17, expnt(s) = [24.56320265]
bas 18, expnt(s) = [7.61060726]
bas 19, expnt(s) = [8.60416226]
bas 20, expnt(s) = [0.49271516]
CPU time:       360.31
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.11038345e-01 7.86658163e-01 4.96636216e-01 1.49466482e+00
 8.81700906e-01 2.29882541e+00 1.17616813e+05 1.60460108e+04
 3.14138964e+00 5.96151141e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232093e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353302e+03 5.91677517e+02
 4.17362703e+02 2.33292218e+02 1.47785164e+02 1.07087345e+02
 5.84487258e+01 5.34067696e+01 2.45632027e+01 2.78758916e+01
 7.61060726e+00 1.15765595e+01 8.60416226e+00 4.29902660e+01
 4.92715163e-01 1.20428507e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33620151027755
cond(S) = 912252.0614372997
E1 = -689.5953570223119  E_coul = 184.97200395541842
init E= -504.623353066893
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672094143450906  LUMO = 0.372120844307278
  mo_energy =
[-1.21709844e+02 -1.33860369e+01 -7.62356032e+00 -7.62356032e+00
 -7.62356032e+00 -1.65756591e+00 -6.72094143e-01 -6.72094143e-01
 -6.72094143e-01  3.72120844e-01  2.74207417e+00  1.36637949e+01
  6.69476543e+01  2.60739536e+02  8.89255715e+02  3.14273759e+03
  1.26231118e+04  4.12202755e+04  1.05248475e+05  2.30421602e+05
  4.56229114e+05  8.45175728e+05  1.52834753e+06  2.85060820e+06
  5.80848684e+06]
E1 = -707.7487246299227  E_coul = 199.77656329688793
cycle= 1 E= -507.972161333035  delta_E= -3.35  |g|= 0.452  |ddm|= 0.45
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.731506
diis-c [-0.53510161  1.        ]
  HOMO = -0.21764200290908  LUMO = 0.670147785429297
  mo_energy =
[-1.20201051e+02 -1.23049586e+01 -6.59449335e+00 -6.59449335e+00
 -6.59449335e+00 -1.16337803e+00 -2.17642003e-01 -2.17642003e-01
 -2.17642003e-01  6.70147785e-01  3.23400476e+00  1.45319941e+01
  6.82115626e+01  2.62194172e+02  8.90747403e+02  3.14416912e+03
  1.26244367e+04  4.12215332e+04  1.05249695e+05  2.30422798e+05
  4.56230293e+05  8.45176894e+05  1.52834868e+06  2.85060934e+06
  5.80848798e+06]
E1 = -706.7950410402167  E_coul = 198.80508951617054
cycle= 2 E= -507.989951524046  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.308
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0374062
diis-c [-0.00139442 -0.00300967  1.00300967]
  HOMO = -0.239866079111826  LUMO = 0.66837413186485
  mo_energy =
[-1.20315837e+02 -1.23726326e+01 -6.66941955e+00 -6.66941955e+00
 -6.66941955e+00 -1.17768657e+00 -2.39866079e-01 -2.39866079e-01
 -2.39866079e-01  6.68374132e-01  3.21707641e+00  1.44826570e+01
  6.81290323e+01  2.62089453e+02  8.90626858e+02  3.14403432e+03
  1.26242917e+04  4.12213843e+04  1.05249545e+05  2.30422647e+05
  4.56230141e+05  8.45176742e+05  1.52834853e+06  2.85060919e+06
  5.80848783e+06]
E1 = -706.6857209513139  E_coul = 198.69550197513382
cycle= 3 E= -507.99021897618  delta_E= -0.000267  |g|= 0.00442  |ddm|= 0.0507
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00453659
diis-c [-3.43269154e-06 -2.26836961e-04 -1.24049894e-01  1.12427673e+00]
  HOMO = -0.243123219188542  LUMO = 0.667931556369427
  mo_energy =
[-1.20327835e+02 -1.23813966e+01 -6.67867209e+00 -6.67867209e+00
 -6.67867209e+00 -1.17966623e+00 -2.43123219e-01 -2.43123219e-01
 -2.43123219e-01  6.67931556e-01  3.21431031e+00  1.44758910e+01
  6.81192652e+01  2.62078122e+02  8.90614613e+02  3.14402137e+03
  1.26242783e+04  4.12213707e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6697032473745  E_coul = 198.6794787334057
cycle= 4 E= -507.990224513969  delta_E= -5.54e-06  |g|= 0.000216  |ddm|= 0.0113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016626
diis-c [-1.20355439e-09 -1.14677166e-05  7.77369085e-03 -9.03435626e-02
  1.08258134e+00]
  HOMO = -0.243231888202676  LUMO = 0.667906024411542
  mo_energy =
[-1.20327983e+02 -1.23816052e+01 -6.67886616e+00 -6.67886616e+00
 -6.67886616e+00 -1.17973256e+00 -2.43231888e-01 -2.43231888e-01
 -2.43231888e-01  6.67906024e-01  3.21420084e+00  1.44757051e+01
  6.81190827e+01  2.62077962e+02  8.90614470e+02  3.14402124e+03
  1.26242781e+04  4.12213706e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6691639767208  E_coul = 198.67893944985258
cycle= 5 E= -507.990224526868  delta_E= -1.29e-08  |g|= 1.09e-05  |ddm|= 0.000962
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.75395e-06
diis-c [-1.84230694e-12  8.76701345e-07 -8.99896880e-04  9.99419777e-03
 -1.30532276e-01  1.12143710e+00]
  HOMO = -0.243235163903134  LUMO = 0.667905204430298
  mo_energy =
[-1.20327988e+02 -1.23816100e+01 -6.67887099e+00 -6.67887099e+00
 -6.67887099e+00 -1.17973492e+00 -2.43235164e-01 -2.43235164e-01
 -2.43235164e-01  6.67905204e-01  3.21419717e+00  1.44757003e+01
  6.81190778e+01  2.62077957e+02  8.90614465e+02  3.14402123e+03
  1.26242781e+04  4.12213706e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6691459544517  E_coul = 198.67892142755585
cycle= 6 E= -507.990224526896  delta_E= -2.76e-11  |g|= 7.67e-08  |ddm|= 5.71e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6691459544517  E_coul = 198.67892142755585
  HOMO = -0.243235192808047  LUMO = 0.667905180004502
  mo_energy =
[-1.20327988e+02 -1.23816101e+01 -6.67887104e+00 -6.67887104e+00
 -6.67887104e+00 -1.17973492e+00 -2.43235193e-01 -2.43235193e-01
 -2.43235193e-01  6.67905180e-01  3.21419713e+00  1.44757003e+01
  6.81190777e+01  2.62077957e+02  8.90614465e+02  3.14402123e+03
  1.26242781e+04  4.12213706e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6691458574257  E_coul = 198.67892133052953
Extra cycle  E= -507.990224526896  delta_E= -3.98e-13  |g|= 9.68e-09  |ddm|= 2.61e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.11038345e-01 4.96636216e-01 8.81700906e-01 1.17616813e+05
 3.14138964e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232093e+03
 1.83757713e+04 1.44353302e+03 4.17362703e+02 1.47785164e+02
 5.84487258e+01 2.45632027e+01 7.61060726e+00 8.60416226e+00
 4.92715163e-01]
E = -507.9902245268962
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.211038344884       1
[INPUT] 0    0    [1    /1   ]  0.496636216119       1
[INPUT] 0    0    [1    /1   ]  0.881700906258       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.14138963964        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175464        1
[INPUT] 0    0    [1    /1   ]  36754.7015259        1
[INPUT] 0    0    [1    /1   ]  7302.32093323        1
[INPUT] 0    0    [1    /1   ]  18375.7713182        1
[INPUT] 0    0    [1    /1   ]  1443.53302202        1
[INPUT] 0    0    [1    /1   ]  417.362703186        1
[INPUT] 0    0    [1    /1   ]  147.785163941        1
[INPUT] 0    0    [1    /1   ]  58.4487257793        1
[INPUT] 0    0    [1    /1   ]  24.5632026536        1
[INPUT] 0    0    [1    /1   ]  7.61060725772        1
[INPUT] 1    0    [1    /1   ]  8.60416225527        1
[INPUT] 1    0    [1    /1   ]  0.492715162525       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21103834488405776, 1.0]], [0, [0.49663621611930536, 1.0]], [0, [0.8817009062579331, 1.0]], [0, [117616.81288873906, 1.0]], [0, [3.141389639644591, 1.0]], [0, [1176168.1426134477, 1.0]], [0, [588084.069956538, 1.0]], [0, [294042.0309213166, 1.0]], [0, [147020.99132284816, 1.0]], [0, [73510.41754642801, 1.0]], [0, [36754.70152591461, 1.0]], [0, [7302.320933229188, 1.0]], [0, [18375.77131815581, 1.0]], [0, [1443.5330220229366, 1.0]], [0, [417.36270318615294, 1.0]], [0, [147.7851639413415, 1.0]], [0, [58.44872577925931, 1.0]], [0, [24.56320265361848, 1.0]], [0, [7.610607257718248, 1.0]], [1, [8.604162255270522, 1.0]], [1, [0.49271516252505015, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21103834]
bas 1, expnt(s) = [0.49663622]
bas 2, expnt(s) = [0.88170091]
bas 3, expnt(s) = [117616.81288874]
bas 4, expnt(s) = [3.14138964]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132285]
bas 9, expnt(s) = [73510.41754643]
bas 10, expnt(s) = [36754.70152591]
bas 11, expnt(s) = [7302.32093323]
bas 12, expnt(s) = [18375.77131816]
bas 13, expnt(s) = [1443.53302202]
bas 14, expnt(s) = [417.36270319]
bas 15, expnt(s) = [147.78516394]
bas 16, expnt(s) = [58.44872578]
bas 17, expnt(s) = [24.56320265]
bas 18, expnt(s) = [7.61060726]
bas 19, expnt(s) = [8.60416226]
bas 20, expnt(s) = [0.49271516]
CPU time:       362.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.11038345e-01 7.86658163e-01 4.96636216e-01 1.49466482e+00
 8.81700906e-01 2.29882541e+00 1.17616813e+05 1.60460108e+04
 3.14138964e+00 5.96151141e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232093e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353302e+03 5.91677517e+02
 4.17362703e+02 2.33292218e+02 1.47785164e+02 1.07087345e+02
 5.84487258e+01 5.34067696e+01 2.45632027e+01 2.78758916e+01
 7.61060726e+00 1.15765595e+01 8.60416226e+00 4.29902660e+01
 4.92715163e-01 1.20428507e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33620151027755
cond(S) = 912252.0614372997
E1 = -689.5953570223119  E_coul = 184.97200395541842
init E= -504.623353066893
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.672094143450906  LUMO = 0.372120844307278
  mo_energy =
[-1.21709844e+02 -1.33860369e+01 -7.62356032e+00 -7.62356032e+00
 -7.62356032e+00 -1.65756591e+00 -6.72094143e-01 -6.72094143e-01
 -6.72094143e-01  3.72120844e-01  2.74207417e+00  1.36637949e+01
  6.69476543e+01  2.60739536e+02  8.89255715e+02  3.14273759e+03
  1.26231118e+04  4.12202755e+04  1.05248475e+05  2.30421602e+05
  4.56229114e+05  8.45175728e+05  1.52834753e+06  2.85060820e+06
  5.80848684e+06]
E1 = -707.7487246299227  E_coul = 199.77656329688793
cycle= 1 E= -507.972161333035  delta_E= -3.35  |g|= 0.452  |ddm|= 0.45
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.731506
diis-c [-0.53510161  1.        ]
  HOMO = -0.21764200290908  LUMO = 0.670147785429297
  mo_energy =
[-1.20201051e+02 -1.23049586e+01 -6.59449335e+00 -6.59449335e+00
 -6.59449335e+00 -1.16337803e+00 -2.17642003e-01 -2.17642003e-01
 -2.17642003e-01  6.70147785e-01  3.23400476e+00  1.45319941e+01
  6.82115626e+01  2.62194172e+02  8.90747403e+02  3.14416912e+03
  1.26244367e+04  4.12215332e+04  1.05249695e+05  2.30422798e+05
  4.56230293e+05  8.45176894e+05  1.52834868e+06  2.85060934e+06
  5.80848798e+06]
E1 = -706.7950410402167  E_coul = 198.80508951617054
cycle= 2 E= -507.989951524046  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.308
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0374062
diis-c [-0.00139442 -0.00300967  1.00300967]
  HOMO = -0.239866079111826  LUMO = 0.66837413186485
  mo_energy =
[-1.20315837e+02 -1.23726326e+01 -6.66941955e+00 -6.66941955e+00
 -6.66941955e+00 -1.17768657e+00 -2.39866079e-01 -2.39866079e-01
 -2.39866079e-01  6.68374132e-01  3.21707641e+00  1.44826570e+01
  6.81290323e+01  2.62089453e+02  8.90626858e+02  3.14403432e+03
  1.26242917e+04  4.12213843e+04  1.05249545e+05  2.30422647e+05
  4.56230141e+05  8.45176742e+05  1.52834853e+06  2.85060919e+06
  5.80848783e+06]
E1 = -706.6857209513139  E_coul = 198.69550197513382
cycle= 3 E= -507.99021897618  delta_E= -0.000267  |g|= 0.00442  |ddm|= 0.0507
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00453659
diis-c [-3.43269154e-06 -2.26836961e-04 -1.24049894e-01  1.12427673e+00]
  HOMO = -0.243123219188542  LUMO = 0.667931556369427
  mo_energy =
[-1.20327835e+02 -1.23813966e+01 -6.67867209e+00 -6.67867209e+00
 -6.67867209e+00 -1.17966623e+00 -2.43123219e-01 -2.43123219e-01
 -2.43123219e-01  6.67931556e-01  3.21431031e+00  1.44758910e+01
  6.81192652e+01  2.62078122e+02  8.90614613e+02  3.14402137e+03
  1.26242783e+04  4.12213707e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6697032473745  E_coul = 198.6794787334057
cycle= 4 E= -507.990224513969  delta_E= -5.54e-06  |g|= 0.000216  |ddm|= 0.0113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016626
diis-c [-1.20355439e-09 -1.14677166e-05  7.77369085e-03 -9.03435626e-02
  1.08258134e+00]
  HOMO = -0.243231888202676  LUMO = 0.667906024411542
  mo_energy =
[-1.20327983e+02 -1.23816052e+01 -6.67886616e+00 -6.67886616e+00
 -6.67886616e+00 -1.17973256e+00 -2.43231888e-01 -2.43231888e-01
 -2.43231888e-01  6.67906024e-01  3.21420084e+00  1.44757051e+01
  6.81190827e+01  2.62077962e+02  8.90614470e+02  3.14402124e+03
  1.26242781e+04  4.12213706e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6691639767208  E_coul = 198.67893944985258
cycle= 5 E= -507.990224526868  delta_E= -1.29e-08  |g|= 1.09e-05  |ddm|= 0.000962
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.75395e-06
diis-c [-1.84230694e-12  8.76701345e-07 -8.99896880e-04  9.99419777e-03
 -1.30532276e-01  1.12143710e+00]
  HOMO = -0.243235163903134  LUMO = 0.667905204430298
  mo_energy =
[-1.20327988e+02 -1.23816100e+01 -6.67887099e+00 -6.67887099e+00
 -6.67887099e+00 -1.17973492e+00 -2.43235164e-01 -2.43235164e-01
 -2.43235164e-01  6.67905204e-01  3.21419717e+00  1.44757003e+01
  6.81190778e+01  2.62077957e+02  8.90614465e+02  3.14402123e+03
  1.26242781e+04  4.12213706e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6691459544517  E_coul = 198.67892142755585
cycle= 6 E= -507.990224526896  delta_E= -2.76e-11  |g|= 7.67e-08  |ddm|= 5.71e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6691459544517  E_coul = 198.67892142755585
  HOMO = -0.243235192808047  LUMO = 0.667905180004502
  mo_energy =
[-1.20327988e+02 -1.23816101e+01 -6.67887104e+00 -6.67887104e+00
 -6.67887104e+00 -1.17973492e+00 -2.43235193e-01 -2.43235193e-01
 -2.43235193e-01  6.67905180e-01  3.21419713e+00  1.44757003e+01
  6.81190777e+01  2.62077957e+02  8.90614465e+02  3.14402123e+03
  1.26242781e+04  4.12213706e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6691458574257  E_coul = 198.67892133052953
Extra cycle  E= -507.990224526896  delta_E= -3.98e-13  |g|= 9.68e-09  |ddm|= 2.61e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912252.0614372997
E1 = -706.6691458574257  E_coul = 198.67892133052953
init E= -507.990224526896
    CPU time for initialize scf      5.94 sec, wall time      0.25 sec
  HOMO = -0.243235196422115  LUMO = 0.667905179546754
  mo_energy =
[-1.20327988e+02 -1.23816101e+01 -6.67887105e+00 -6.67887105e+00
 -6.67887105e+00 -1.17973493e+00 -2.43235196e-01 -2.43235196e-01
 -2.43235196e-01  6.67905180e-01  3.21419712e+00  1.44757002e+01
  6.81190777e+01  2.62077957e+02  8.90614465e+02  3.14402123e+03
  1.26242781e+04  4.12213706e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6691458364703  E_coul = 198.67892130957438
cycle= 1 E= -507.990224526896  delta_E= 2.84e-13  |g|= 1.9e-09  |ddm|= 4.05e-08
    CPU time for cycle= 1      0.09 sec, wall time      0.03 sec
E1 = -706.6691458364703  E_coul = 198.67892130957438
  HOMO = -0.24323519711444  LUMO = 0.667905179332471
  mo_energy =
[-1.20327988e+02 -1.23816101e+01 -6.67887105e+00 -6.67887105e+00
 -6.67887105e+00 -1.17973493e+00 -2.43235197e-01 -2.43235197e-01
 -2.43235197e-01  6.67905179e-01  3.21419712e+00  1.44757002e+01
  6.81190777e+01  2.62077957e+02  8.90614465e+02  3.14402123e+03
  1.26242781e+04  4.12213706e+04  1.05249531e+05  2.30422633e+05
  4.56230128e+05  8.45176728e+05  1.52834852e+06  2.85060917e+06
  5.80848781e+06]
E1 = -706.6691458357172  E_coul = 198.6789213088214
Extra cycle  E= -507.990224526896  delta_E= 5.68e-14  |g|= 3.37e-09  |ddm|= 2.5e-09
    CPU time for scf_cycle      6.17 sec, wall time      0.42 sec
exp = [2.11038345e-01 4.96636216e-01 8.81700906e-01 1.17616813e+05
 3.14138964e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232093e+03
 1.83757713e+04 1.44353302e+03 4.17362703e+02 1.47785164e+02
 5.84487258e+01 2.45632027e+01 7.61060726e+00 8.60416226e+00
 4.92715163e-01]
grad_E = [-1.41862430e-03  1.71922837e-03 -6.35584274e-04  6.07283664e-09
 -9.41893310e-04  4.05584641e-11  1.74502248e-10  9.41923268e-10
  3.72169646e-09  1.55415341e-08  8.10546732e-08  5.10899465e-06
  1.98809169e-07 -3.87809652e-05 -3.19113339e-06 -1.11454986e-05
  4.23786043e-05 -6.48217524e-05 -3.80115700e-04 -1.21756318e-04
 -1.42056662e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.209138970551       1
[INPUT] 0    0    [1    /1   ]  0.48281166852        1
[INPUT] 0    0    [1    /1   ]  0.874840210468       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.13147779328        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175465        1
[INPUT] 0    0    [1    /1   ]  36754.7015262        1
[INPUT] 0    0    [1    /1   ]  7302.32095026        1
[INPUT] 0    0    [1    /1   ]  18375.7713188        1
[INPUT] 0    0    [1    /1   ]  1443.53289391        1
[INPUT] 0    0    [1    /1   ]  417.362677904        1
[INPUT] 0    0    [1    /1   ]  147.785209734        1
[INPUT] 0    0    [1    /1   ]  58.448512368         1
[INPUT] 0    0    [1    /1   ]  24.5635191013        1
[INPUT] 0    0    [1    /1   ]  7.61510678417        1
[INPUT] 1    0    [1    /1   ]  8.60433052125        1
[INPUT] 1    0    [1    /1   ]  0.492755079596       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20913897055083303, 1.0]], [0, [0.48281166852012364, 1.0]], [0, [0.8748402104682796, 1.0]], [0, [117616.8128887593, 1.0]], [0, [3.1314777932842737, 1.0]], [0, [1176168.142613448, 1.0]], [0, [588084.0699565386, 1.0]], [0, [294042.03092131973, 1.0]], [0, [147020.99132286056, 1.0]], [0, [73510.41754647982, 1.0]], [0, [36754.70152618483, 1.0]], [0, [7302.320950260767, 1.0]], [0, [18375.771318818217, 1.0]], [0, [1443.5328939074248, 1.0]], [0, [417.36267790416696, 1.0]], [0, [147.7852097338172, 1.0]], [0, [58.448512367959786, 1.0]], [0, [24.56351910133266, 1.0]], [0, [7.615106784165891, 1.0]], [1, [8.60433052124984, 1.0]], [1, [0.4927550795955702, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20913897]
bas 1, expnt(s) = [0.48281167]
bas 2, expnt(s) = [0.87484021]
bas 3, expnt(s) = [117616.81288876]
bas 4, expnt(s) = [3.13147779]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132286]
bas 9, expnt(s) = [73510.41754648]
bas 10, expnt(s) = [36754.70152618]
bas 11, expnt(s) = [7302.32095026]
bas 12, expnt(s) = [18375.77131882]
bas 13, expnt(s) = [1443.53289391]
bas 14, expnt(s) = [417.3626779]
bas 15, expnt(s) = [147.78520973]
bas 16, expnt(s) = [58.44851237]
bas 17, expnt(s) = [24.5635191]
bas 18, expnt(s) = [7.61510678]
bas 19, expnt(s) = [8.60433052]
bas 20, expnt(s) = [0.49275508]
CPU time:       376.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.09138971e-01 7.81342142e-01 4.82811669e-01 1.46335044e+00
 8.74840210e-01 2.28539660e+00 1.17616813e+05 1.60460108e+04
 3.13147779e+00 5.94739833e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232095e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353289e+03 5.91677477e+02
 4.17362678e+02 2.33292207e+02 1.47785210e+02 1.07087370e+02
 5.84485124e+01 5.34066234e+01 2.45635191e+01 2.78761610e+01
 7.61510678e+00 1.15816923e+01 8.60433052e+00 4.29913169e+01
 4.92755080e-01 1.20440702e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336148418847156
cond(S) = 912247.2284401966
E1 = -689.5979389659943  E_coul = 184.9742438103415
init E= -504.623695155653
    CPU time for initialize scf      5.77 sec, wall time      0.29 sec
  HOMO = -0.67204445891542  LUMO = 0.36060456888676
  mo_energy =
[-1.21709554e+02 -1.33858504e+01 -7.62341167e+00 -7.62341167e+00
 -7.62341167e+00 -1.65753892e+00 -6.72044459e-01 -6.72044459e-01
 -6.72044459e-01  3.60604569e-01  2.68117481e+00  1.35405819e+01
  6.68207744e+01  2.60629470e+02  8.89158610e+02  3.14265116e+03
  1.26230355e+04  4.12202048e+04  1.05248407e+05  2.30421536e+05
  4.56229050e+05  8.45175665e+05  1.52834747e+06  2.85060813e+06
  5.80848678e+06]
E1 = -707.752062777621  E_coul = 199.7798922707338
cycle= 1 E= -507.972170506887  delta_E= -3.35  |g|= 0.452  |ddm|= 0.45
    CPU time for cycle= 1      0.55 sec, wall time      0.03 sec
diis-norm(errvec)=0.731842
diis-c [-0.53559342  1.        ]
  HOMO = -0.217533240558961  LUMO = 0.655925070960736
  mo_energy =
[-1.20200672e+02 -1.23047101e+01 -6.59428364e+00 -6.59428364e+00
 -6.59428364e+00 -1.16329908e+00 -2.17533241e-01 -2.17533241e-01
 -2.17533241e-01  6.55925071e-01  3.16991279e+00  1.44083919e+01
  6.80849601e+01  2.62084251e+02  8.90650402e+02  3.14408279e+03
  1.26243605e+04  4.12214626e+04  1.05249628e+05  2.30422733e+05
  4.56230229e+05  8.45176830e+05  1.52834862e+06  2.85060928e+06
  5.80848792e+06]
E1 = -706.7985187323036  E_coul = 198.80856207232705
cycle= 2 E= -507.989956659977  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.308
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.037481
diis-c [-0.00139972 -0.00310101  1.00310101]
  HOMO = -0.239755460042684  LUMO = 0.654231706793307
  mo_energy =
[-1.20315458e+02 -1.23723782e+01 -6.66920497e+00 -6.66920497e+00
 -6.66920497e+00 -1.17760641e+00 -2.39755460e-01 -2.39755460e-01
 -2.39755460e-01  6.54231707e-01  3.15329383e+00  1.43591487e+01
  6.80024269e+01  2.61979528e+02  8.90529856e+02  3.14394799e+03
  1.26242155e+04  4.12213138e+04  1.05249477e+05  2.30422581e+05
  4.56230077e+05  8.45176678e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6891109469017  E_coul = 198.698886407946
cycle= 3 E= -507.990224538956  delta_E= -0.000268  |g|= 0.00442  |ddm|= 0.0501
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00454905
diis-c [-3.44266531e-06 -2.31243512e-04 -1.24169856e-01  1.12440110e+00]
  HOMO = -0.243014703628394  LUMO = 0.653803573165584
  mo_energy =
[-1.20327455e+02 -1.23811443e+01 -6.67845915e+00 -6.67845915e+00
 -6.67845915e+00 -1.17958750e+00 -2.43014704e-01 -2.43014704e-01
 -2.43014704e-01  6.53803573e-01  3.15056799e+00  1.43523890e+01
  6.79926578e+01  2.61968196e+02  8.90517611e+02  3.14393504e+03
  1.26242021e+04  4.12213002e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6730590134239  E_coul = 198.68282890345168
cycle= 4 E= -507.990230109972  delta_E= -5.57e-06  |g|= 0.000219  |ddm|= 0.0111
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000167597
diis-c [-1.26774791e-09 -1.13699906e-05  7.82230893e-03 -9.08455163e-02
  1.08303458e+00]
  HOMO = -0.243123953854476  LUMO = 0.653778483739739
  mo_energy =
[-1.20327603e+02 -1.23813535e+01 -6.67865378e+00 -6.67865378e+00
 -6.67865378e+00 -1.17965423e+00 -2.43123954e-01 -2.43123954e-01
 -2.43123954e-01  6.53778484e-01  3.15045902e+00  1.43522024e+01
  6.79924747e+01  2.61968037e+02  8.90517468e+02  3.14393491e+03
  1.26242020e+04  4.12213001e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6725147659787  E_coul = 198.68228464268813
cycle= 5 E= -507.990230123291  delta_E= -1.33e-08  |g|= 1.12e-05  |ddm|= 0.000956
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.91658e-06
diis-c [-1.89756648e-12  8.92445698e-07 -9.13896622e-04  1.01459162e-02
 -1.32221658e-01  1.12298875e+00]
  HOMO = -0.24312730041617  LUMO = 0.653777661137355
  mo_energy =
[-1.20327609e+02 -1.23813585e+01 -6.67865871e+00 -6.67865871e+00
 -6.67865871e+00 -1.17965664e+00 -2.43127300e-01 -2.43127300e-01
 -2.43127300e-01  6.53777661e-01  3.15045529e+00  1.43521975e+01
  6.79924697e+01  2.61968031e+02  8.90517463e+02  3.14393490e+03
  1.26242020e+04  4.12213001e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6724962219108  E_coul = 198.68226609858982
cycle= 6 E= -507.990230123321  delta_E= -3.05e-11  |g|= 7.58e-08  |ddm|= 5.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6724962219108  E_coul = 198.68226609858982
  HOMO = -0.243127329139112  LUMO = 0.653777636290566
  mo_energy =
[-1.20327609e+02 -1.23813585e+01 -6.67865876e+00 -6.67865876e+00
 -6.67865876e+00 -1.17965664e+00 -2.43127329e-01 -2.43127329e-01
 -2.43127329e-01  6.53777636e-01  3.15045524e+00  1.43521974e+01
  6.79924697e+01  2.61968031e+02  8.90517463e+02  3.14393490e+03
  1.26242020e+04  4.12213001e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6724961290982  E_coul = 198.68226600577756
Extra cycle  E= -507.990230123321  delta_E= 3.41e-13  |g|= 9.97e-09  |ddm|= 2.48e-07
    CPU time for scf_cycle      6.51 sec, wall time      0.51 sec
exp = [2.09138971e-01 4.82811669e-01 8.74840210e-01 1.17616813e+05
 3.13147779e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232095e+03
 1.83757713e+04 1.44353289e+03 4.17362678e+02 1.47785210e+02
 5.84485124e+01 2.45635191e+01 7.61510678e+00 8.60433052e+00
 4.92755080e-01]
E = -507.99023012332066
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.209138970551       1
[INPUT] 0    0    [1    /1   ]  0.48281166852        1
[INPUT] 0    0    [1    /1   ]  0.874840210468       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.13147779328        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175465        1
[INPUT] 0    0    [1    /1   ]  36754.7015262        1
[INPUT] 0    0    [1    /1   ]  7302.32095026        1
[INPUT] 0    0    [1    /1   ]  18375.7713188        1
[INPUT] 0    0    [1    /1   ]  1443.53289391        1
[INPUT] 0    0    [1    /1   ]  417.362677904        1
[INPUT] 0    0    [1    /1   ]  147.785209734        1
[INPUT] 0    0    [1    /1   ]  58.448512368         1
[INPUT] 0    0    [1    /1   ]  24.5635191013        1
[INPUT] 0    0    [1    /1   ]  7.61510678417        1
[INPUT] 1    0    [1    /1   ]  8.60433052125        1
[INPUT] 1    0    [1    /1   ]  0.492755079596       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20913897055083303, 1.0]], [0, [0.48281166852012364, 1.0]], [0, [0.8748402104682796, 1.0]], [0, [117616.8128887593, 1.0]], [0, [3.1314777932842737, 1.0]], [0, [1176168.142613448, 1.0]], [0, [588084.0699565386, 1.0]], [0, [294042.03092131973, 1.0]], [0, [147020.99132286056, 1.0]], [0, [73510.41754647982, 1.0]], [0, [36754.70152618483, 1.0]], [0, [7302.320950260767, 1.0]], [0, [18375.771318818217, 1.0]], [0, [1443.5328939074248, 1.0]], [0, [417.36267790416696, 1.0]], [0, [147.7852097338172, 1.0]], [0, [58.448512367959786, 1.0]], [0, [24.56351910133266, 1.0]], [0, [7.615106784165891, 1.0]], [1, [8.60433052124984, 1.0]], [1, [0.4927550795955702, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20913897]
bas 1, expnt(s) = [0.48281167]
bas 2, expnt(s) = [0.87484021]
bas 3, expnt(s) = [117616.81288876]
bas 4, expnt(s) = [3.13147779]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132286]
bas 9, expnt(s) = [73510.41754648]
bas 10, expnt(s) = [36754.70152618]
bas 11, expnt(s) = [7302.32095026]
bas 12, expnt(s) = [18375.77131882]
bas 13, expnt(s) = [1443.53289391]
bas 14, expnt(s) = [417.3626779]
bas 15, expnt(s) = [147.78520973]
bas 16, expnt(s) = [58.44851237]
bas 17, expnt(s) = [24.5635191]
bas 18, expnt(s) = [7.61510678]
bas 19, expnt(s) = [8.60433052]
bas 20, expnt(s) = [0.49275508]
CPU time:       383.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.09138971e-01 7.81342142e-01 4.82811669e-01 1.46335044e+00
 8.74840210e-01 2.28539660e+00 1.17616813e+05 1.60460108e+04
 3.13147779e+00 5.94739833e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232095e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353289e+03 5.91677477e+02
 4.17362678e+02 2.33292207e+02 1.47785210e+02 1.07087370e+02
 5.84485124e+01 5.34066234e+01 2.45635191e+01 2.78761610e+01
 7.61510678e+00 1.15816923e+01 8.60433052e+00 4.29913169e+01
 4.92755080e-01 1.20440702e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336148418847156
cond(S) = 912247.2284401966
E1 = -689.5979389659943  E_coul = 184.9742438103415
init E= -504.623695155653
    CPU time for initialize scf      0.74 sec, wall time      0.07 sec
  HOMO = -0.67204445891542  LUMO = 0.36060456888676
  mo_energy =
[-1.21709554e+02 -1.33858504e+01 -7.62341167e+00 -7.62341167e+00
 -7.62341167e+00 -1.65753892e+00 -6.72044459e-01 -6.72044459e-01
 -6.72044459e-01  3.60604569e-01  2.68117481e+00  1.35405819e+01
  6.68207744e+01  2.60629470e+02  8.89158610e+02  3.14265116e+03
  1.26230355e+04  4.12202048e+04  1.05248407e+05  2.30421536e+05
  4.56229050e+05  8.45175665e+05  1.52834747e+06  2.85060813e+06
  5.80848678e+06]
E1 = -707.752062777621  E_coul = 199.7798922707338
cycle= 1 E= -507.972170506887  delta_E= -3.35  |g|= 0.452  |ddm|= 0.45
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.731842
diis-c [-0.53559342  1.        ]
  HOMO = -0.217533240558961  LUMO = 0.655925070960736
  mo_energy =
[-1.20200672e+02 -1.23047101e+01 -6.59428364e+00 -6.59428364e+00
 -6.59428364e+00 -1.16329908e+00 -2.17533241e-01 -2.17533241e-01
 -2.17533241e-01  6.55925071e-01  3.16991279e+00  1.44083919e+01
  6.80849601e+01  2.62084251e+02  8.90650402e+02  3.14408279e+03
  1.26243605e+04  4.12214626e+04  1.05249628e+05  2.30422733e+05
  4.56230229e+05  8.45176830e+05  1.52834862e+06  2.85060928e+06
  5.80848792e+06]
E1 = -706.7985187323036  E_coul = 198.80856207232705
cycle= 2 E= -507.989956659977  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.308
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.037481
diis-c [-0.00139972 -0.00310101  1.00310101]
  HOMO = -0.239755460042684  LUMO = 0.654231706793307
  mo_energy =
[-1.20315458e+02 -1.23723782e+01 -6.66920497e+00 -6.66920497e+00
 -6.66920497e+00 -1.17760641e+00 -2.39755460e-01 -2.39755460e-01
 -2.39755460e-01  6.54231707e-01  3.15329383e+00  1.43591487e+01
  6.80024269e+01  2.61979528e+02  8.90529856e+02  3.14394799e+03
  1.26242155e+04  4.12213138e+04  1.05249477e+05  2.30422581e+05
  4.56230077e+05  8.45176678e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6891109469017  E_coul = 198.698886407946
cycle= 3 E= -507.990224538956  delta_E= -0.000268  |g|= 0.00442  |ddm|= 0.0501
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00454905
diis-c [-3.44266531e-06 -2.31243512e-04 -1.24169856e-01  1.12440110e+00]
  HOMO = -0.243014703628394  LUMO = 0.653803573165584
  mo_energy =
[-1.20327455e+02 -1.23811443e+01 -6.67845915e+00 -6.67845915e+00
 -6.67845915e+00 -1.17958750e+00 -2.43014704e-01 -2.43014704e-01
 -2.43014704e-01  6.53803573e-01  3.15056799e+00  1.43523890e+01
  6.79926578e+01  2.61968196e+02  8.90517611e+02  3.14393504e+03
  1.26242021e+04  4.12213002e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6730590134239  E_coul = 198.68282890345168
cycle= 4 E= -507.990230109972  delta_E= -5.57e-06  |g|= 0.000219  |ddm|= 0.0111
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000167597
diis-c [-1.26774791e-09 -1.13699906e-05  7.82230893e-03 -9.08455163e-02
  1.08303458e+00]
  HOMO = -0.243123953854476  LUMO = 0.653778483739739
  mo_energy =
[-1.20327603e+02 -1.23813535e+01 -6.67865378e+00 -6.67865378e+00
 -6.67865378e+00 -1.17965423e+00 -2.43123954e-01 -2.43123954e-01
 -2.43123954e-01  6.53778484e-01  3.15045902e+00  1.43522024e+01
  6.79924747e+01  2.61968037e+02  8.90517468e+02  3.14393491e+03
  1.26242020e+04  4.12213001e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6725147659787  E_coul = 198.68228464268813
cycle= 5 E= -507.990230123291  delta_E= -1.33e-08  |g|= 1.12e-05  |ddm|= 0.000956
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.91658e-06
diis-c [-1.89756648e-12  8.92445698e-07 -9.13896622e-04  1.01459162e-02
 -1.32221658e-01  1.12298875e+00]
  HOMO = -0.24312730041617  LUMO = 0.653777661137355
  mo_energy =
[-1.20327609e+02 -1.23813585e+01 -6.67865871e+00 -6.67865871e+00
 -6.67865871e+00 -1.17965664e+00 -2.43127300e-01 -2.43127300e-01
 -2.43127300e-01  6.53777661e-01  3.15045529e+00  1.43521975e+01
  6.79924697e+01  2.61968031e+02  8.90517463e+02  3.14393490e+03
  1.26242020e+04  4.12213001e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6724962219108  E_coul = 198.68226609858982
cycle= 6 E= -507.990230123321  delta_E= -3.05e-11  |g|= 7.58e-08  |ddm|= 5.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6724962219108  E_coul = 198.68226609858982
  HOMO = -0.243127329139112  LUMO = 0.653777636290566
  mo_energy =
[-1.20327609e+02 -1.23813585e+01 -6.67865876e+00 -6.67865876e+00
 -6.67865876e+00 -1.17965664e+00 -2.43127329e-01 -2.43127329e-01
 -2.43127329e-01  6.53777636e-01  3.15045524e+00  1.43521974e+01
  6.79924697e+01  2.61968031e+02  8.90517463e+02  3.14393490e+03
  1.26242020e+04  4.12213001e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6724961290982  E_coul = 198.68226600577756
Extra cycle  E= -507.990230123321  delta_E= 3.41e-13  |g|= 9.97e-09  |ddm|= 2.48e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912247.2284401966
E1 = -706.6724961290982  E_coul = 198.68226600577756
init E= -507.990230123321
    CPU time for initialize scf      6.50 sec, wall time      0.28 sec
  HOMO = -0.243127332618373  LUMO = 0.653777636003875
  mo_energy =
[-1.20327609e+02 -1.23813585e+01 -6.67865877e+00 -6.67865877e+00
 -6.67865877e+00 -1.17965664e+00 -2.43127333e-01 -2.43127333e-01
 -2.43127333e-01  6.53777636e-01  3.15045524e+00  1.43521974e+01
  6.79924697e+01  2.61968031e+02  8.90517463e+02  3.14393490e+03
  1.26242020e+04  4.12213001e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6724961091908  E_coul = 198.68226598587054
cycle= 1 E= -507.99023012332  delta_E= 4.55e-13  |g|= 2.03e-09  |ddm|= 4.06e-08
    CPU time for cycle= 1      0.11 sec, wall time      0.03 sec
E1 = -706.6724961091908  E_coul = 198.68226598587054
  HOMO = -0.24312733329093  LUMO = 0.653777634853936
  mo_energy =
[-1.20327609e+02 -1.23813585e+01 -6.67865877e+00 -6.67865877e+00
 -6.67865877e+00 -1.17965664e+00 -2.43127333e-01 -2.43127333e-01
 -2.43127333e-01  6.53777635e-01  3.15045524e+00  1.43521974e+01
  6.79924697e+01  2.61968031e+02  8.90517463e+02  3.14393490e+03
  1.26242020e+04  4.12213001e+04  1.05249464e+05  2.30422568e+05
  4.56230063e+05  8.45176665e+05  1.52834845e+06  2.85060911e+06
  5.80848775e+06]
E1 = -706.6724961069299  E_coul = 198.68226598360906
Extra cycle  E= -507.990230123321  delta_E= -6.25e-13  |g|= 1.35e-09  |ddm|= 3.56e-09
    CPU time for scf_cycle      6.76 sec, wall time      0.46 sec
exp = [2.09138971e-01 4.82811669e-01 8.74840210e-01 1.17616813e+05
 3.13147779e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232095e+03
 1.83757713e+04 1.44353289e+03 4.17362678e+02 1.47785210e+02
 5.84485124e+01 2.45635191e+01 7.61510678e+00 8.60433052e+00
 4.92755080e-01]
grad_E = [ 8.73827305e-05  1.21470511e-03 -5.85034360e-04  6.07178620e-09
 -1.22363530e-03  4.05467281e-11  1.74467745e-10  9.41762341e-10
  3.72104570e-09  1.55387796e-08  8.10414038e-08  5.10814190e-06
  1.98765456e-07 -3.87427243e-05 -3.58198877e-06 -9.03968115e-06
  3.34794999e-05 -5.33026917e-05 -2.22448399e-04 -2.13232388e-05
  1.81731951e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.206771406608       1
[INPUT] 0    0    [1    /1   ]  0.47358823752        1
[INPUT] 0    0    [1    /1   ]  0.868374223282       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.12813283188        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175465        1
[INPUT] 0    0    [1    /1   ]  36754.7015265        1
[INPUT] 0    0    [1    /1   ]  7302.32096892        1
[INPUT] 0    0    [1    /1   ]  18375.7713195        1
[INPUT] 0    0    [1    /1   ]  1443.53275275        1
[INPUT] 0    0    [1    /1   ]  417.36266024         1
[INPUT] 0    0    [1    /1   ]  147.7852047          1
[INPUT] 0    0    [1    /1   ]  58.4485148777        1
[INPUT] 0    0    [1    /1   ]  24.5635371643        1
[INPUT] 0    0    [1    /1   ]  7.61572217488        1
[INPUT] 1    0    [1    /1   ]  8.60441071089        1
[INPUT] 1    0    [1    /1   ]  0.492776534222       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20677140660797638, 1.0]], [0, [0.47358823752025675, 1.0]], [0, [0.8683742232815427, 1.0]], [0, [117616.81288878148, 1.0]], [0, [3.128132831880929, 1.0]], [0, [1176168.1426134482, 1.0]], [0, [588084.0699565392, 1.0]], [0, [294042.03092132317, 1.0]], [0, [147020.99132287415, 1.0]], [0, [73510.41754653657, 1.0]], [0, [36754.70152648084, 1.0]], [0, [7302.320968918725, 1.0]], [0, [18375.771319544136, 1.0]], [0, [1443.5327527511004, 1.0]], [0, [417.36266023976117, 1.0]], [0, [147.78520470007962, 1.0]], [0, [58.44851487770777, 1.0]], [0, [24.563537164309324, 1.0]], [0, [7.6157221748849695, 1.0]], [1, [8.604410710893475, 1.0]], [1, [0.49277653422185147, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20677141]
bas 1, expnt(s) = [0.47358824]
bas 2, expnt(s) = [0.86837422]
bas 3, expnt(s) = [117616.81288878]
bas 4, expnt(s) = [3.12813283]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132287]
bas 9, expnt(s) = [73510.41754654]
bas 10, expnt(s) = [36754.70152648]
bas 11, expnt(s) = [7302.32096892]
bas 12, expnt(s) = [18375.77131954]
bas 13, expnt(s) = [1443.53275275]
bas 14, expnt(s) = [417.36266024]
bas 15, expnt(s) = [147.7852047]
bas 16, expnt(s) = [58.44851488]
bas 17, expnt(s) = [24.56353716]
bas 18, expnt(s) = [7.61572217]
bas 19, expnt(s) = [8.60441071]
bas 20, expnt(s) = [0.49277653]
CPU time:       399.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.06771407e-01 7.74698805e-01 4.73588238e-01 1.44233355e+00
 8.68374223e-01 2.27271625e+00 1.17616813e+05 1.60460108e+04
 3.12813283e+00 5.94263305e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232097e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353275e+03 5.91677434e+02
 4.17362660e+02 2.33292200e+02 1.47785205e+02 1.07087367e+02
 5.84485149e+01 5.34066251e+01 2.45635372e+01 2.78761764e+01
 7.61572217e+00 1.15823942e+01 8.60441071e+00 4.29918177e+01
 4.92776534e-01 1.20447258e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33612408774143
cond(S) = 912243.5633700447
E1 = -689.5991080799618  E_coul = 184.97533094892094
init E= -504.623777131041
    CPU time for initialize scf      1.60 sec, wall time      0.11 sec
  HOMO = -0.672019064493236  LUMO = 0.350530070159454
  mo_energy =
[-1.21709415e+02 -1.33857590e+01 -7.62334116e+00 -7.62334116e+00
 -7.62334116e+00 -1.65752299e+00 -6.72019064e-01 -6.72019064e-01
 -6.72019064e-01  3.50530070e-01  2.63306568e+00  1.34502570e+01
  6.67284702e+01  2.60547822e+02  8.89086193e+02  3.14258656e+03
  1.26229784e+04  4.12201519e+04  1.05248356e+05  2.30421487e+05
  4.56229001e+05  8.45175617e+05  1.52834742e+06  2.85060809e+06
  5.80848674e+06]
E1 = -707.7537441659159  E_coul = 199.78157222060838
cycle= 1 E= -507.972171945308  delta_E= -3.35  |g|= 0.452  |ddm|= 0.449
    CPU time for cycle= 1      0.45 sec, wall time      0.03 sec
diis-norm(errvec)=0.732148
diis-c [-0.53604078  1.        ]
  HOMO = -0.217476534416135  LUMO = 0.643558693906899
  mo_energy =
[-1.20200488e+02 -1.23045829e+01 -6.59417804e+00 -6.59417804e+00
 -6.59417804e+00 -1.16325844e+00 -2.17476534e-01 -2.17476534e-01
 -2.17476534e-01  6.43558694e-01  3.11938416e+00  1.43178914e+01
  6.79928460e+01  2.62002691e+02  8.90578041e+02  3.14401825e+03
  1.26243035e+04  4.12214097e+04  1.05249577e+05  2.30422683e+05
  4.56230181e+05  8.45176783e+05  1.52834857e+06  2.85060923e+06
  5.80848788e+06]
E1 = -706.8000866606886  E_coul = 198.8101274618673
cycle= 2 E= -507.989959198821  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.309
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0375933
diis-c [-0.00140782 -0.0032001   1.0032001 ]
  HOMO = -0.239707308516084  LUMO = 0.641928780251222
  mo_energy =
[-1.20315292e+02 -1.23722648e+01 -6.66911349e+00 -6.66911349e+00
 -6.66911349e+00 -1.17757198e+00 -2.39707309e-01 -2.39707309e-01
 -2.39707309e-01  6.41928780e-01  3.10299132e+00  1.42686946e+01
  6.79102932e+01  2.61897947e+02  8.90457475e+02  3.14388342e+03
  1.26241584e+04  4.12212608e+04  1.05249427e+05  2.30422532e+05
  4.56230029e+05  8.45176631e+05  1.52834842e+06  2.85060908e+06
  5.80848772e+06]
E1 = -706.690548173556  E_coul = 198.70032053369195
cycle= 3 E= -507.990227639864  delta_E= -0.000268  |g|= 0.00443  |ddm|= 0.0495
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00457049
diis-c [-3.46309018e-06 -2.36161197e-04 -1.24435779e-01  1.12467194e+00]
  HOMO = -0.242970622546635  LUMO = 0.641511864356855
  mo_energy =
[-1.20327293e+02 -1.23810371e+01 -6.67837350e+00 -6.67837350e+00
 -6.67837350e+00 -1.17955572e+00 -2.42970623e-01 -2.42970623e-01
 -2.42970623e-01  6.41511864e-01  3.10029367e+00  1.42619344e+01
  6.79005180e+01  2.61886611e+02  8.90445226e+02  3.14387047e+03
  1.26241450e+04  4.12212473e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.674456474368  E_coul = 198.68422323143952
cycle= 4 E= -507.990233242928  delta_E= -5.6e-06  |g|= 0.00022  |ddm|= 0.011
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000168869
diis-c [-1.32389892e-09 -1.13514105e-05  7.86623984e-03 -9.11773819e-02
  1.08332249e+00]
  HOMO = -0.243079938601319  LUMO = 0.641487174280599
  mo_energy =
[-1.20327440e+02 -1.23812456e+01 -6.67856730e+00 -6.67856730e+00
 -6.67856730e+00 -1.17962251e+00 -2.43079939e-01 -2.43079939e-01
 -2.43079939e-01  6.41487174e-01  3.10018535e+00  1.42617481e+01
  6.79003359e+01  2.61886453e+02  8.90445085e+02  3.14387034e+03
  1.26241449e+04  4.12212471e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.6739102227274  E_coul = 198.68367696619478
cycle= 5 E= -507.990233256533  delta_E= -1.36e-08  |g|= 1.15e-05  |ddm|= 0.000954
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.05129e-06
diis-c [-1.94144108e-12  9.12390155e-07 -9.25321508e-04  1.02543909e-02
 -1.33461161e-01  1.12413118e+00]
  HOMO = -0.243083314528367  LUMO = 0.641486352922455
  mo_energy =
[-1.20327445e+02 -1.23812506e+01 -6.67857223e+00 -6.67857223e+00
 -6.67857223e+00 -1.17962495e+00 -2.43083315e-01 -2.43083315e-01
 -2.43083315e-01  6.41486353e-01  3.10018159e+00  1.42617432e+01
  6.79003309e+01  2.61886448e+02  8.90445080e+02  3.14387033e+03
  1.26241449e+04  4.12212471e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.6738913930051  E_coul = 198.68365813644067
cycle= 6 E= -507.990233256564  delta_E= -3.18e-11  |g|= 7.47e-08  |ddm|= 5.85e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6738913930051  E_coul = 198.68365813644067
  HOMO = -0.243083342937218  LUMO = 0.64148632781434
  mo_energy =
[-1.20327445e+02 -1.23812506e+01 -6.67857228e+00 -6.67857228e+00
 -6.67857228e+00 -1.17962495e+00 -2.43083343e-01 -2.43083343e-01
 -2.43083343e-01  6.41486328e-01  3.10018155e+00  1.42617432e+01
  6.79003309e+01  2.61886448e+02  8.90445080e+02  3.14387033e+03
  1.26241449e+04  4.12212471e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.6738912998075  E_coul = 198.68365804324296
Extra cycle  E= -507.990233256564  delta_E= -5.68e-14  |g|= 9.65e-09  |ddm|= 2.43e-07
    CPU time for scf_cycle      2.24 sec, wall time      0.33 sec
exp = [2.06771407e-01 4.73588238e-01 8.68374223e-01 1.17616813e+05
 3.12813283e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232097e+03
 1.83757713e+04 1.44353275e+03 4.17362660e+02 1.47785205e+02
 5.84485149e+01 2.45635372e+01 7.61572217e+00 8.60441071e+00
 4.92776534e-01]
E = -507.99023325656447
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.206771406608       1
[INPUT] 0    0    [1    /1   ]  0.47358823752        1
[INPUT] 0    0    [1    /1   ]  0.868374223282       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.12813283188        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175465        1
[INPUT] 0    0    [1    /1   ]  36754.7015265        1
[INPUT] 0    0    [1    /1   ]  7302.32096892        1
[INPUT] 0    0    [1    /1   ]  18375.7713195        1
[INPUT] 0    0    [1    /1   ]  1443.53275275        1
[INPUT] 0    0    [1    /1   ]  417.36266024         1
[INPUT] 0    0    [1    /1   ]  147.7852047          1
[INPUT] 0    0    [1    /1   ]  58.4485148777        1
[INPUT] 0    0    [1    /1   ]  24.5635371643        1
[INPUT] 0    0    [1    /1   ]  7.61572217488        1
[INPUT] 1    0    [1    /1   ]  8.60441071089        1
[INPUT] 1    0    [1    /1   ]  0.492776534222       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20677140660797638, 1.0]], [0, [0.47358823752025675, 1.0]], [0, [0.8683742232815427, 1.0]], [0, [117616.81288878148, 1.0]], [0, [3.128132831880929, 1.0]], [0, [1176168.1426134482, 1.0]], [0, [588084.0699565392, 1.0]], [0, [294042.03092132317, 1.0]], [0, [147020.99132287415, 1.0]], [0, [73510.41754653657, 1.0]], [0, [36754.70152648084, 1.0]], [0, [7302.320968918725, 1.0]], [0, [18375.771319544136, 1.0]], [0, [1443.5327527511004, 1.0]], [0, [417.36266023976117, 1.0]], [0, [147.78520470007962, 1.0]], [0, [58.44851487770777, 1.0]], [0, [24.563537164309324, 1.0]], [0, [7.6157221748849695, 1.0]], [1, [8.604410710893475, 1.0]], [1, [0.49277653422185147, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20677141]
bas 1, expnt(s) = [0.47358824]
bas 2, expnt(s) = [0.86837422]
bas 3, expnt(s) = [117616.81288878]
bas 4, expnt(s) = [3.12813283]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132287]
bas 9, expnt(s) = [73510.41754654]
bas 10, expnt(s) = [36754.70152648]
bas 11, expnt(s) = [7302.32096892]
bas 12, expnt(s) = [18375.77131954]
bas 13, expnt(s) = [1443.53275275]
bas 14, expnt(s) = [417.36266024]
bas 15, expnt(s) = [147.7852047]
bas 16, expnt(s) = [58.44851488]
bas 17, expnt(s) = [24.56353716]
bas 18, expnt(s) = [7.61572217]
bas 19, expnt(s) = [8.60441071]
bas 20, expnt(s) = [0.49277653]
CPU time:       401.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.06771407e-01 7.74698805e-01 4.73588238e-01 1.44233355e+00
 8.68374223e-01 2.27271625e+00 1.17616813e+05 1.60460108e+04
 3.12813283e+00 5.94263305e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232097e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353275e+03 5.91677434e+02
 4.17362660e+02 2.33292200e+02 1.47785205e+02 1.07087367e+02
 5.84485149e+01 5.34066251e+01 2.45635372e+01 2.78761764e+01
 7.61572217e+00 1.15823942e+01 8.60441071e+00 4.29918177e+01
 4.92776534e-01 1.20447258e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33612408774143
cond(S) = 912243.5633700447
E1 = -689.5991080799618  E_coul = 184.97533094892094
init E= -504.623777131041
    CPU time for initialize scf      0.66 sec, wall time      0.07 sec
  HOMO = -0.672019064493236  LUMO = 0.350530070159454
  mo_energy =
[-1.21709415e+02 -1.33857590e+01 -7.62334116e+00 -7.62334116e+00
 -7.62334116e+00 -1.65752299e+00 -6.72019064e-01 -6.72019064e-01
 -6.72019064e-01  3.50530070e-01  2.63306568e+00  1.34502570e+01
  6.67284702e+01  2.60547822e+02  8.89086193e+02  3.14258656e+03
  1.26229784e+04  4.12201519e+04  1.05248356e+05  2.30421487e+05
  4.56229001e+05  8.45175617e+05  1.52834742e+06  2.85060809e+06
  5.80848674e+06]
E1 = -707.7537441659159  E_coul = 199.78157222060838
cycle= 1 E= -507.972171945308  delta_E= -3.35  |g|= 0.452  |ddm|= 0.449
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.732148
diis-c [-0.53604078  1.        ]
  HOMO = -0.217476534416135  LUMO = 0.643558693906899
  mo_energy =
[-1.20200488e+02 -1.23045829e+01 -6.59417804e+00 -6.59417804e+00
 -6.59417804e+00 -1.16325844e+00 -2.17476534e-01 -2.17476534e-01
 -2.17476534e-01  6.43558694e-01  3.11938416e+00  1.43178914e+01
  6.79928460e+01  2.62002691e+02  8.90578041e+02  3.14401825e+03
  1.26243035e+04  4.12214097e+04  1.05249577e+05  2.30422683e+05
  4.56230181e+05  8.45176783e+05  1.52834857e+06  2.85060923e+06
  5.80848788e+06]
E1 = -706.8000866606886  E_coul = 198.8101274618673
cycle= 2 E= -507.989959198821  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.309
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0375933
diis-c [-0.00140782 -0.0032001   1.0032001 ]
  HOMO = -0.239707308516084  LUMO = 0.641928780251222
  mo_energy =
[-1.20315292e+02 -1.23722648e+01 -6.66911349e+00 -6.66911349e+00
 -6.66911349e+00 -1.17757198e+00 -2.39707309e-01 -2.39707309e-01
 -2.39707309e-01  6.41928780e-01  3.10299132e+00  1.42686946e+01
  6.79102932e+01  2.61897947e+02  8.90457475e+02  3.14388342e+03
  1.26241584e+04  4.12212608e+04  1.05249427e+05  2.30422532e+05
  4.56230029e+05  8.45176631e+05  1.52834842e+06  2.85060908e+06
  5.80848772e+06]
E1 = -706.690548173556  E_coul = 198.70032053369195
cycle= 3 E= -507.990227639864  delta_E= -0.000268  |g|= 0.00443  |ddm|= 0.0495
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00457049
diis-c [-3.46309018e-06 -2.36161197e-04 -1.24435779e-01  1.12467194e+00]
  HOMO = -0.242970622546635  LUMO = 0.641511864356855
  mo_energy =
[-1.20327293e+02 -1.23810371e+01 -6.67837350e+00 -6.67837350e+00
 -6.67837350e+00 -1.17955572e+00 -2.42970623e-01 -2.42970623e-01
 -2.42970623e-01  6.41511864e-01  3.10029367e+00  1.42619344e+01
  6.79005180e+01  2.61886611e+02  8.90445226e+02  3.14387047e+03
  1.26241450e+04  4.12212473e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.674456474368  E_coul = 198.68422323143952
cycle= 4 E= -507.990233242928  delta_E= -5.6e-06  |g|= 0.00022  |ddm|= 0.011
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000168869
diis-c [-1.32389892e-09 -1.13514105e-05  7.86623984e-03 -9.11773819e-02
  1.08332249e+00]
  HOMO = -0.243079938601319  LUMO = 0.641487174280599
  mo_energy =
[-1.20327440e+02 -1.23812456e+01 -6.67856730e+00 -6.67856730e+00
 -6.67856730e+00 -1.17962251e+00 -2.43079939e-01 -2.43079939e-01
 -2.43079939e-01  6.41487174e-01  3.10018535e+00  1.42617481e+01
  6.79003359e+01  2.61886453e+02  8.90445085e+02  3.14387034e+03
  1.26241449e+04  4.12212471e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.6739102227274  E_coul = 198.68367696619478
cycle= 5 E= -507.990233256533  delta_E= -1.36e-08  |g|= 1.15e-05  |ddm|= 0.000954
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.05129e-06
diis-c [-1.94144108e-12  9.12390155e-07 -9.25321508e-04  1.02543909e-02
 -1.33461161e-01  1.12413118e+00]
  HOMO = -0.243083314528367  LUMO = 0.641486352922455
  mo_energy =
[-1.20327445e+02 -1.23812506e+01 -6.67857223e+00 -6.67857223e+00
 -6.67857223e+00 -1.17962495e+00 -2.43083315e-01 -2.43083315e-01
 -2.43083315e-01  6.41486353e-01  3.10018159e+00  1.42617432e+01
  6.79003309e+01  2.61886448e+02  8.90445080e+02  3.14387033e+03
  1.26241449e+04  4.12212471e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.6738913930051  E_coul = 198.68365813644067
cycle= 6 E= -507.990233256564  delta_E= -3.18e-11  |g|= 7.47e-08  |ddm|= 5.85e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6738913930051  E_coul = 198.68365813644067
  HOMO = -0.243083342937218  LUMO = 0.64148632781434
  mo_energy =
[-1.20327445e+02 -1.23812506e+01 -6.67857228e+00 -6.67857228e+00
 -6.67857228e+00 -1.17962495e+00 -2.43083343e-01 -2.43083343e-01
 -2.43083343e-01  6.41486328e-01  3.10018155e+00  1.42617432e+01
  6.79003309e+01  2.61886448e+02  8.90445080e+02  3.14387033e+03
  1.26241449e+04  4.12212471e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.6738912998075  E_coul = 198.68365804324296
Extra cycle  E= -507.990233256564  delta_E= -5.68e-14  |g|= 9.65e-09  |ddm|= 2.43e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912243.5633700447
E1 = -706.6738912998075  E_coul = 198.68365804324296
init E= -507.990233256564
    CPU time for initialize scf      6.16 sec, wall time      0.26 sec
  HOMO = -0.243083346409025  LUMO = 0.641486330700135
  mo_energy =
[-1.20327445e+02 -1.23812506e+01 -6.67857228e+00 -6.67857228e+00
 -6.67857228e+00 -1.17962495e+00 -2.43083346e-01 -2.43083346e-01
 -2.43083346e-01  6.41486331e-01  3.10018154e+00  1.42617432e+01
  6.79003309e+01  2.61886448e+02  8.90445080e+02  3.14387033e+03
  1.26241449e+04  4.12212471e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.673891280334  E_coul = 198.6836580237695
cycle= 1 E= -507.990233256565  delta_E= -5.68e-14  |g|= 3.24e-09  |ddm|= 3.98e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.673891280334  E_coul = 198.6836580237695
  HOMO = -0.243083347096113  LUMO = 0.641486328453352
  mo_energy =
[-1.20327445e+02 -1.23812506e+01 -6.67857228e+00 -6.67857228e+00
 -6.67857228e+00 -1.17962495e+00 -2.43083347e-01 -2.43083347e-01
 -2.43083347e-01  6.41486328e-01  3.10018154e+00  1.42617432e+01
  6.79003309e+01  2.61886448e+02  8.90445080e+02  3.14387033e+03
  1.26241449e+04  4.12212471e+04  1.05249413e+05  2.30422518e+05
  4.56230015e+05  8.45176617e+05  1.52834841e+06  2.85060907e+06
  5.80848771e+06]
E1 = -706.6738912808272  E_coul = 198.6836580242626
Extra cycle  E= -507.990233256565  delta_E= -5.68e-14  |g|= 2.51e-09  |ddm|= 2.41e-09
    CPU time for scf_cycle      6.67 sec, wall time      0.43 sec
exp = [2.06771407e-01 4.73588238e-01 8.68374223e-01 1.17616813e+05
 3.12813283e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232097e+03
 1.83757713e+04 1.44353275e+03 4.17362660e+02 1.47785205e+02
 5.84485149e+01 2.45635372e+01 7.61572217e+00 8.60441071e+00
 4.92776534e-01]
grad_E = [ 3.38656872e-04  1.05436707e-03 -5.96589927e-04  6.07152679e-09
 -1.25202469e-03  4.05438309e-11  1.74459231e-10  9.41722590e-10
  3.72088500e-09  1.55380995e-08  8.10381249e-08  5.10793030e-06
  1.98754684e-07 -3.87331305e-05 -3.68003361e-06 -8.50708984e-06
  3.13059904e-05 -5.03720883e-05 -1.93471392e-04  2.46082240e-05
  7.17370395e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.199744636098       1
[INPUT] 0    0    [1    /1   ]  0.449261719191       1
[INPUT] 0    0    [1    /1   ]  0.854643634247       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.12361078492        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175466        1
[INPUT] 0    0    [1    /1   ]  36754.7015268        1
[INPUT] 0    0    [1    /1   ]  7302.32098874        1
[INPUT] 0    0    [1    /1   ]  18375.7713203        1
[INPUT] 0    0    [1    /1   ]  1443.53260349        1
[INPUT] 0    0    [1    /1   ]  417.362632816        1
[INPUT] 0    0    [1    /1   ]  147.785250359        1
[INPUT] 0    0    [1    /1   ]  58.4482992718        1
[INPUT] 0    0    [1    /1   ]  24.5639158484        1
[INPUT] 0    0    [1    /1   ]  7.61944232344        1
[INPUT] 1    0    [1    /1   ]  8.60461768729        1
[INPUT] 1    0    [1    /1   ]  0.492829796201       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19974463609778798, 1.0]], [0, [0.44926171919064417, 1.0]], [0, [0.85464363424672, 1.0]], [0, [117616.81288880504, 1.0]], [0, [3.123610784924189, 1.0]], [0, [1176168.1426134484, 1.0]], [0, [588084.0699565399, 1.0]], [0, [294042.03092132683, 1.0]], [0, [147020.99132288859, 1.0]], [0, [73510.41754659686, 1.0]], [0, [36754.7015267953, 1.0]], [0, [7302.320988738395, 1.0]], [0, [18375.771320315063, 1.0]], [0, [1443.5326034862665, 1.0]], [0, [417.36263281606966, 1.0]], [0, [147.7852503587792, 1.0]], [0, [58.44829927182521, 1.0]], [0, [24.563915848378027, 1.0]], [0, [7.619442323440409, 1.0]], [1, [8.604617687286561, 1.0]], [1, [0.49282979620090084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19974464]
bas 1, expnt(s) = [0.44926172]
bas 2, expnt(s) = [0.85464363]
bas 3, expnt(s) = [117616.81288881]
bas 4, expnt(s) = [3.12361078]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092133]
bas 8, expnt(s) = [147020.99132289]
bas 9, expnt(s) = [73510.4175466]
bas 10, expnt(s) = [36754.7015268]
bas 11, expnt(s) = [7302.32098874]
bas 12, expnt(s) = [18375.77132032]
bas 13, expnt(s) = [1443.53260349]
bas 14, expnt(s) = [417.36263282]
bas 15, expnt(s) = [147.78525036]
bas 16, expnt(s) = [58.44829927]
bas 17, expnt(s) = [24.56391585]
bas 18, expnt(s) = [7.61944232]
bas 19, expnt(s) = [8.60461769]
bas 20, expnt(s) = [0.4928298]
CPU time:       416.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.99744636e-01 7.54868614e-01 4.49261719e-01 1.38640331e+00
 8.54643634e-01 2.24571077e+00 1.17616813e+05 1.60460108e+04
 3.12361078e+00 5.93618886e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232099e+03 1.99577103e+03
 1.83757713e+04 3.98748633e+03 1.44353260e+03 5.91677388e+02
 4.17362633e+02 2.33292188e+02 1.47785250e+02 1.07087392e+02
 5.84482993e+01 5.34064773e+01 2.45639158e+01 2.78764987e+01
 7.61944232e+00 1.15866373e+01 8.60461769e+00 4.29931104e+01
 4.92829796e-01 1.20463531e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33606281965667
cond(S) = 912234.81500243
E1 = -689.6019378446018  E_coul = 184.97807833558716
init E= -504.623859509015
    CPU time for initialize scf      0.75 sec, wall time      0.07 sec
  HOMO = -0.671956102818514  LUMO = 0.322965982181832
  mo_energy =
[-1.21709063e+02 -1.33855281e+01 -7.62316215e+00 -7.62316215e+00
 -7.62316215e+00 -1.65748772e+00 -6.71956103e-01 -6.71956103e-01
 -6.71956103e-01  3.22965982e-01  2.50852211e+00  1.32334629e+01
  6.65223549e+01  2.60370219e+02  8.88929634e+02  3.14244732e+03
  1.26228557e+04  4.12200382e+04  1.05248247e+05  2.30421381e+05
  4.56228898e+05  8.45175515e+05  1.52834732e+06  2.85060799e+06
  5.80848664e+06]
E1 = -707.7582343060825  E_coul = 199.78605652770634
cycle= 1 E= -507.972177778376  delta_E= -3.35  |g|= 0.452  |ddm|= 0.446
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.733357
diis-c [-0.53781277  1.        ]
  HOMO = -0.217333719561372  LUMO = 0.609723622257242
  mo_energy =
[-1.20199991e+02 -1.23042418e+01 -6.59388763e+00 -6.59388763e+00
 -6.59388763e+00 -1.16315717e+00 -2.17333720e-01 -2.17333720e-01
 -2.17333720e-01  6.09723622e-01  2.98876983e+00  1.41010119e+01
  6.77872623e+01  2.61825331e+02  8.90421654e+02  3.14387916e+03
  1.26241809e+04  4.12212962e+04  1.05249468e+05  2.30422578e+05
  4.56230077e+05  8.45176681e+05  1.52834847e+06  2.85060914e+06
  5.80848778e+06]
E1 = -706.8042465942046  E_coul = 198.81427814663027
cycle= 2 E= -507.989968447574  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.311
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0379541
diis-c [-0.0014339 -0.0035231  1.0035231]
  HOMO = -0.23958814700663  LUMO = 0.608259553594055
  mo_energy =
[-1.20314855e+02 -1.23719673e+01 -6.66886826e+00 -6.66886826e+00
 -6.66886826e+00 -1.17748788e+00 -2.39588147e-01 -2.39588147e-01
 -2.39588147e-01  6.08259554e-01  2.97295483e+00  1.40519004e+01
  6.77046465e+01  2.61720525e+02  8.90301023e+02  3.14374427e+03
  1.26240358e+04  4.12211473e+04  1.05249318e+05  2.30422426e+05
  4.56229925e+05  8.45176529e+05  1.52834832e+06  2.85060898e+06
  5.80848763e+06]
E1 = -706.6943609296937  E_coul = 198.70412259493324
cycle= 3 E= -507.990238334761  delta_E= -0.00027  |g|= 0.00443  |ddm|= 0.0483
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0046356
diis-c [-3.53073315e-06 -2.47520019e-04 -1.25147507e-01  1.12539503e+00]
  HOMO = -0.242860552370833  LUMO = 0.607872640637623
  mo_energy =
[-1.20326860e+02 -1.23807523e+01 -6.67813940e+00 -6.67813940e+00
 -6.67813940e+00 -1.17947749e+00 -2.42860552e-01 -2.42860552e-01
 -2.42860552e-01  6.07872641e-01  2.97033028e+00  1.40451384e+01
  6.76948597e+01  2.61709181e+02  8.90288771e+02  3.14373131e+03
  1.26240224e+04  4.12211337e+04  1.05249304e+05  2.30422413e+05
  4.56229912e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6781711284852  E_coul = 198.68792710977056
cycle= 4 E= -507.990244018715  delta_E= -5.68e-06  |g|= 0.000224  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172631
diis-c [-1.48759862e-09 -1.13387370e-05  7.98060273e-03 -9.20541041e-02
  1.08408484e+00]
  HOMO = -0.242969831161703  LUMO = 0.607849071721897
  mo_energy =
[-1.20327002e+02 -1.23809585e+01 -6.67833047e+00 -6.67833047e+00
 -6.67833047e+00 -1.17954433e+00 -2.42969831e-01 -2.42969831e-01
 -2.42969831e-01  6.07849072e-01  2.97022373e+00  1.40449532e+01
  6.76946808e+01  2.61709027e+02  8.90288635e+02  3.14373119e+03
  1.26240223e+04  4.12211336e+04  1.05249304e+05  2.30422412e+05
  4.56229911e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6776202989332  E_coul = 198.68737626583015
cycle= 5 E= -507.990244033103  delta_E= -1.44e-08  |g|= 1.21e-05  |ddm|= 0.000948
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.43381e-06
diis-c [-2.06752357e-12  9.48752726e-07 -9.54218679e-04  1.05293163e-02
 -1.36660371e-01  1.12708432e+00]
  HOMO = -0.242973273163838  LUMO = 0.607848262527514
  mo_energy =
[-1.20327007e+02 -1.23809634e+01 -6.67833537e+00 -6.67833537e+00
 -6.67833537e+00 -1.17954683e+00 -2.42973273e-01 -2.42973273e-01
 -2.42973273e-01  6.07848263e-01  2.97021991e+00  1.40449483e+01
  6.76946758e+01  2.61709022e+02  8.90288630e+02  3.14373118e+03
  1.26240223e+04  4.12211336e+04  1.05249304e+05  2.30422412e+05
  4.56229911e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6776007299222  E_coul = 198.6873566967822
cycle= 6 E= -507.99024403314  delta_E= -3.69e-11  |g|= 7.31e-08  |ddm|= 6.05e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6776007299222  E_coul = 198.6873566967822
  HOMO = -0.242973300865613  LUMO = 0.607848237268625
  mo_energy =
[-1.20327007e+02 -1.23809635e+01 -6.67833542e+00 -6.67833542e+00
 -6.67833542e+00 -1.17954683e+00 -2.42973301e-01 -2.42973301e-01
 -2.42973301e-01  6.07848237e-01  2.97021987e+00  1.40449482e+01
  6.76946758e+01  2.61709022e+02  8.90288630e+02  3.14373118e+03
  1.26240223e+04  4.12211336e+04  1.05249304e+05  2.30422412e+05
  4.56229911e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6776006419362  E_coul = 198.68735660879602
Extra cycle  E= -507.99024403314  delta_E= -2.27e-13  |g|= 8.99e-09  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
exp = [1.99744636e-01 4.49261719e-01 8.54643634e-01 1.17616813e+05
 3.12361078e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232099e+03
 1.83757713e+04 1.44353260e+03 4.17362633e+02 1.47785250e+02
 5.84482993e+01 2.45639158e+01 7.61944232e+00 8.60461769e+00
 4.92829796e-01]
E = -507.99024403314024
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.199744636098       1
[INPUT] 0    0    [1    /1   ]  0.449261719191       1
[INPUT] 0    0    [1    /1   ]  0.854643634247       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.12361078492        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175466        1
[INPUT] 0    0    [1    /1   ]  36754.7015268        1
[INPUT] 0    0    [1    /1   ]  7302.32098874        1
[INPUT] 0    0    [1    /1   ]  18375.7713203        1
[INPUT] 0    0    [1    /1   ]  1443.53260349        1
[INPUT] 0    0    [1    /1   ]  417.362632816        1
[INPUT] 0    0    [1    /1   ]  147.785250359        1
[INPUT] 0    0    [1    /1   ]  58.4482992718        1
[INPUT] 0    0    [1    /1   ]  24.5639158484        1
[INPUT] 0    0    [1    /1   ]  7.61944232344        1
[INPUT] 1    0    [1    /1   ]  8.60461768729        1
[INPUT] 1    0    [1    /1   ]  0.492829796201       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19974463609778798, 1.0]], [0, [0.44926171919064417, 1.0]], [0, [0.85464363424672, 1.0]], [0, [117616.81288880504, 1.0]], [0, [3.123610784924189, 1.0]], [0, [1176168.1426134484, 1.0]], [0, [588084.0699565399, 1.0]], [0, [294042.03092132683, 1.0]], [0, [147020.99132288859, 1.0]], [0, [73510.41754659686, 1.0]], [0, [36754.7015267953, 1.0]], [0, [7302.320988738395, 1.0]], [0, [18375.771320315063, 1.0]], [0, [1443.5326034862665, 1.0]], [0, [417.36263281606966, 1.0]], [0, [147.7852503587792, 1.0]], [0, [58.44829927182521, 1.0]], [0, [24.563915848378027, 1.0]], [0, [7.619442323440409, 1.0]], [1, [8.604617687286561, 1.0]], [1, [0.49282979620090084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.19974464]
bas 1, expnt(s) = [0.44926172]
bas 2, expnt(s) = [0.85464363]
bas 3, expnt(s) = [117616.81288881]
bas 4, expnt(s) = [3.12361078]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092133]
bas 8, expnt(s) = [147020.99132289]
bas 9, expnt(s) = [73510.4175466]
bas 10, expnt(s) = [36754.7015268]
bas 11, expnt(s) = [7302.32098874]
bas 12, expnt(s) = [18375.77132032]
bas 13, expnt(s) = [1443.53260349]
bas 14, expnt(s) = [417.36263282]
bas 15, expnt(s) = [147.78525036]
bas 16, expnt(s) = [58.44829927]
bas 17, expnt(s) = [24.56391585]
bas 18, expnt(s) = [7.61944232]
bas 19, expnt(s) = [8.60461769]
bas 20, expnt(s) = [0.4928298]
CPU time:       418.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.99744636e-01 7.54868614e-01 4.49261719e-01 1.38640331e+00
 8.54643634e-01 2.24571077e+00 1.17616813e+05 1.60460108e+04
 3.12361078e+00 5.93618886e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232099e+03 1.99577103e+03
 1.83757713e+04 3.98748633e+03 1.44353260e+03 5.91677388e+02
 4.17362633e+02 2.33292188e+02 1.47785250e+02 1.07087392e+02
 5.84482993e+01 5.34064773e+01 2.45639158e+01 2.78764987e+01
 7.61944232e+00 1.15866373e+01 8.60461769e+00 4.29931104e+01
 4.92829796e-01 1.20463531e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33606281965667
cond(S) = 912234.81500243
E1 = -689.6019378446018  E_coul = 184.97807833558716
init E= -504.623859509015
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.671956102818514  LUMO = 0.322965982181832
  mo_energy =
[-1.21709063e+02 -1.33855281e+01 -7.62316215e+00 -7.62316215e+00
 -7.62316215e+00 -1.65748772e+00 -6.71956103e-01 -6.71956103e-01
 -6.71956103e-01  3.22965982e-01  2.50852211e+00  1.32334629e+01
  6.65223549e+01  2.60370219e+02  8.88929634e+02  3.14244732e+03
  1.26228557e+04  4.12200382e+04  1.05248247e+05  2.30421381e+05
  4.56228898e+05  8.45175515e+05  1.52834732e+06  2.85060799e+06
  5.80848664e+06]
E1 = -707.7582343060825  E_coul = 199.78605652770634
cycle= 1 E= -507.972177778376  delta_E= -3.35  |g|= 0.452  |ddm|= 0.446
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.733357
diis-c [-0.53781277  1.        ]
  HOMO = -0.217333719561372  LUMO = 0.609723622257242
  mo_energy =
[-1.20199991e+02 -1.23042418e+01 -6.59388763e+00 -6.59388763e+00
 -6.59388763e+00 -1.16315717e+00 -2.17333720e-01 -2.17333720e-01
 -2.17333720e-01  6.09723622e-01  2.98876983e+00  1.41010119e+01
  6.77872623e+01  2.61825331e+02  8.90421654e+02  3.14387916e+03
  1.26241809e+04  4.12212962e+04  1.05249468e+05  2.30422578e+05
  4.56230077e+05  8.45176681e+05  1.52834847e+06  2.85060914e+06
  5.80848778e+06]
E1 = -706.8042465942046  E_coul = 198.81427814663027
cycle= 2 E= -507.989968447574  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.311
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0379541
diis-c [-0.0014339 -0.0035231  1.0035231]
  HOMO = -0.23958814700663  LUMO = 0.608259553594055
  mo_energy =
[-1.20314855e+02 -1.23719673e+01 -6.66886826e+00 -6.66886826e+00
 -6.66886826e+00 -1.17748788e+00 -2.39588147e-01 -2.39588147e-01
 -2.39588147e-01  6.08259554e-01  2.97295483e+00  1.40519004e+01
  6.77046465e+01  2.61720525e+02  8.90301023e+02  3.14374427e+03
  1.26240358e+04  4.12211473e+04  1.05249318e+05  2.30422426e+05
  4.56229925e+05  8.45176529e+05  1.52834832e+06  2.85060898e+06
  5.80848763e+06]
E1 = -706.6943609296937  E_coul = 198.70412259493324
cycle= 3 E= -507.990238334761  delta_E= -0.00027  |g|= 0.00443  |ddm|= 0.0483
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0046356
diis-c [-3.53073315e-06 -2.47520019e-04 -1.25147507e-01  1.12539503e+00]
  HOMO = -0.242860552370833  LUMO = 0.607872640637623
  mo_energy =
[-1.20326860e+02 -1.23807523e+01 -6.67813940e+00 -6.67813940e+00
 -6.67813940e+00 -1.17947749e+00 -2.42860552e-01 -2.42860552e-01
 -2.42860552e-01  6.07872641e-01  2.97033028e+00  1.40451384e+01
  6.76948597e+01  2.61709181e+02  8.90288771e+02  3.14373131e+03
  1.26240224e+04  4.12211337e+04  1.05249304e+05  2.30422413e+05
  4.56229912e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6781711284852  E_coul = 198.68792710977056
cycle= 4 E= -507.990244018715  delta_E= -5.68e-06  |g|= 0.000224  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172631
diis-c [-1.48759862e-09 -1.13387370e-05  7.98060273e-03 -9.20541041e-02
  1.08408484e+00]
  HOMO = -0.242969831161703  LUMO = 0.607849071721897
  mo_energy =
[-1.20327002e+02 -1.23809585e+01 -6.67833047e+00 -6.67833047e+00
 -6.67833047e+00 -1.17954433e+00 -2.42969831e-01 -2.42969831e-01
 -2.42969831e-01  6.07849072e-01  2.97022373e+00  1.40449532e+01
  6.76946808e+01  2.61709027e+02  8.90288635e+02  3.14373119e+03
  1.26240223e+04  4.12211336e+04  1.05249304e+05  2.30422412e+05
  4.56229911e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6776202989332  E_coul = 198.68737626583015
cycle= 5 E= -507.990244033103  delta_E= -1.44e-08  |g|= 1.21e-05  |ddm|= 0.000948
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.43381e-06
diis-c [-2.06752357e-12  9.48752726e-07 -9.54218679e-04  1.05293163e-02
 -1.36660371e-01  1.12708432e+00]
  HOMO = -0.242973273163838  LUMO = 0.607848262527514
  mo_energy =
[-1.20327007e+02 -1.23809634e+01 -6.67833537e+00 -6.67833537e+00
 -6.67833537e+00 -1.17954683e+00 -2.42973273e-01 -2.42973273e-01
 -2.42973273e-01  6.07848263e-01  2.97021991e+00  1.40449483e+01
  6.76946758e+01  2.61709022e+02  8.90288630e+02  3.14373118e+03
  1.26240223e+04  4.12211336e+04  1.05249304e+05  2.30422412e+05
  4.56229911e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6776007299222  E_coul = 198.6873566967822
cycle= 6 E= -507.99024403314  delta_E= -3.69e-11  |g|= 7.31e-08  |ddm|= 6.05e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6776007299222  E_coul = 198.6873566967822
  HOMO = -0.242973300865613  LUMO = 0.607848237268625
  mo_energy =
[-1.20327007e+02 -1.23809635e+01 -6.67833542e+00 -6.67833542e+00
 -6.67833542e+00 -1.17954683e+00 -2.42973301e-01 -2.42973301e-01
 -2.42973301e-01  6.07848237e-01  2.97021987e+00  1.40449482e+01
  6.76946758e+01  2.61709022e+02  8.90288630e+02  3.14373118e+03
  1.26240223e+04  4.12211336e+04  1.05249304e+05  2.30422412e+05
  4.56229911e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6776006419362  E_coul = 198.68735660879602
Extra cycle  E= -507.99024403314  delta_E= -2.27e-13  |g|= 8.99e-09  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912234.81500243
E1 = -706.6776006419362  E_coul = 198.68735660879602
init E= -507.99024403314
    CPU time for initialize scf      5.64 sec, wall time      0.24 sec
  HOMO = -0.242973304157588  LUMO = 0.60784823636755
  mo_energy =
[-1.20327007e+02 -1.23809635e+01 -6.67833542e+00 -6.67833542e+00
 -6.67833542e+00 -1.17954683e+00 -2.42973304e-01 -2.42973304e-01
 -2.42973304e-01  6.07848236e-01  2.97021986e+00  1.40449482e+01
  6.76946758e+01  2.61709022e+02  8.90288630e+02  3.14373118e+03
  1.26240223e+04  4.12211336e+04  1.05249304e+05  2.30422412e+05
  4.56229911e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6776006243613  E_coul = 198.68735659122106
cycle= 1 E= -507.99024403314  delta_E=    0  |g|= 2.3e-09  |ddm|= 3.39e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.6776006243613  E_coul = 198.68735659122106
  HOMO = -0.242973304752586  LUMO = 0.60784823635453
  mo_energy =
[-1.20327007e+02 -1.23809635e+01 -6.67833542e+00 -6.67833542e+00
 -6.67833542e+00 -1.17954683e+00 -2.42973305e-01 -2.42973305e-01
 -2.42973305e-01  6.07848236e-01  2.97021986e+00  1.40449482e+01
  6.76946758e+01  2.61709022e+02  8.90288630e+02  3.14373118e+03
  1.26240223e+04  4.12211336e+04  1.05249304e+05  2.30422412e+05
  4.56229911e+05  8.45176515e+05  1.52834831e+06  2.85060897e+06
  5.80848761e+06]
E1 = -706.6776006223836  E_coul = 198.6873565892439
Extra cycle  E= -507.99024403314  delta_E= 5.68e-13  |g|= 1.24e-09  |ddm|= 4.16e-09
    CPU time for scf_cycle      6.13 sec, wall time      0.40 sec
exp = [1.99744636e-01 4.49261719e-01 8.54643634e-01 1.17616813e+05
 3.12361078e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232099e+03
 1.83757713e+04 1.44353260e+03 4.17362633e+02 1.47785250e+02
 5.84482993e+01 2.45639158e+01 7.61944232e+00 8.60461769e+00
 4.92829796e-01]
grad_E = [ 1.09752543e-03  4.48812866e-04 -5.73703667e-04  6.07099996e-09
 -1.16178132e-03  4.05379360e-11  1.74441939e-10  9.41641844e-10
  3.72055866e-09  1.55367185e-08  8.10314646e-08  5.10750048e-06
  1.98732825e-07 -3.87137719e-05 -3.87304463e-06 -7.49591396e-06
  2.75220757e-05 -4.56808855e-05 -1.74330699e-04  1.48449787e-04
  2.50277401e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.193134596365       1
[INPUT] 0    0    [1    /1   ]  0.431978378891       1
[INPUT] 0    0    [1    /1   ]  0.853947695219       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.12667451983        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175464        1
[INPUT] 0    0    [1    /1   ]  36754.7015259        1
[INPUT] 0    0    [1    /1   ]  7302.3209314         1
[INPUT] 0    0    [1    /1   ]  18375.7713181        1
[INPUT] 0    0    [1    /1   ]  1443.53303973        1
[INPUT] 0    0    [1    /1   ]  417.362656042        1
[INPUT] 0    0    [1    /1   ]  147.785446548        1
[INPUT] 0    0    [1    /1   ]  58.4475179935        1
[INPUT] 0    0    [1    /1   ]  24.5650995953        1
[INPUT] 0    0    [1    /1   ]  7.6290071032         1
[INPUT] 1    0    [1    /1   ]  8.60478970662        1
[INPUT] 1    0    [1    /1   ]  0.492873370238       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19313459636512942, 1.0]], [0, [0.4319783788907231, 1.0]], [0, [0.8539476952191069, 1.0]], [0, [117616.81288873688, 1.0]], [0, [3.126674519826687, 1.0]], [0, [1176168.142613448, 1.0]], [0, [588084.0699565379, 1.0]], [0, [294042.03092131624, 1.0]], [0, [147020.99132284682, 1.0]], [0, [73510.41754642242, 1.0]], [0, [36754.70152588563, 1.0]], [0, [7302.320931399855, 1.0]], [0, [18375.77131808351, 1.0]], [0, [1443.5330397305595, 1.0]], [0, [417.36265604161594, 1.0]], [0, [147.78544654810784, 1.0]], [0, [58.44751799351735, 1.0]], [0, [24.565099595301845, 1.0]], [0, [7.629007103202919, 1.0]], [1, [8.604789706621329, 1.0]], [1, [0.4928733702379187, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.1931346]
bas 1, expnt(s) = [0.43197838]
bas 2, expnt(s) = [0.8539477]
bas 3, expnt(s) = [117616.81288874]
bas 4, expnt(s) = [3.12667452]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132285]
bas 9, expnt(s) = [73510.41754642]
bas 10, expnt(s) = [36754.70152589]
bas 11, expnt(s) = [7302.3209314]
bas 12, expnt(s) = [18375.77131808]
bas 13, expnt(s) = [1443.53303973]
bas 14, expnt(s) = [417.36265604]
bas 15, expnt(s) = [147.78544655]
bas 16, expnt(s) = [58.44751799]
bas 17, expnt(s) = [24.5650996]
bas 18, expnt(s) = [7.6290071]
bas 19, expnt(s) = [8.60478971]
bas 20, expnt(s) = [0.49287337]
CPU time:       432.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.93134596e-01 7.36054685e-01 4.31978379e-01 1.34620603e+00
 8.53947695e-01 2.24433911e+00 1.17616813e+05 1.60460108e+04
 3.12667452e+00 5.94055512e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232093e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353304e+03 5.91677522e+02
 4.17362656e+02 2.33292198e+02 1.47785447e+02 1.07087499e+02
 5.84475180e+01 5.34059419e+01 2.45650996e+01 2.78775062e+01
 7.62900710e+00 1.15975443e+01 8.60478971e+00 4.29941848e+01
 4.92873370e-01 1.20476845e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336010877857163
cond(S) = 912230.6339832406
E1 = -689.6041696987766  E_coul = 184.9803411456508
init E= -504.623828553126
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.671905831330357  LUMO = 0.301158656519157
  mo_energy =
[-1.21708772e+02 -1.33853398e+01 -7.62301373e+00 -7.62301373e+00
 -7.62301373e+00 -1.65746487e+00 -6.71905831e-01 -6.71905831e-01
 -6.71905831e-01  3.01158657e-01  2.42757241e+00  1.31302917e+01
  6.64606628e+01  2.60330585e+02  8.88897591e+02  3.14242002e+03
  1.26228328e+04  4.12200174e+04  1.05248227e+05  2.30421362e+05
  4.56228879e+05  8.45175496e+05  1.52834730e+06  2.85060797e+06
  5.80848662e+06]
E1 = -707.7623911705033  E_coul = 199.7902067601136
cycle= 1 E= -507.97218441039  delta_E= -3.35  |g|= 0.452  |ddm|= 0.445
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.735023
diis-c [-0.54025851  1.        ]
  HOMO = -0.217215696388186  LUMO = 0.583137831510268
  mo_energy =
[-1.20199525e+02 -1.23039244e+01 -6.59360482e+00 -6.59360482e+00
 -6.59360482e+00 -1.16307425e+00 -2.17215696e-01 -2.17215696e-01
 -2.17215696e-01  5.83137832e-01  2.90465658e+00  1.39985466e+01
  6.77260208e+01  2.61785916e+02  8.90389799e+02  3.14385205e+03
  1.26241582e+04  4.12212756e+04  1.05249449e+05  2.30422558e+05
  4.56230058e+05  8.45176663e+05  1.52834846e+06  2.85060912e+06
  5.80848776e+06]
E1 = -706.8078813823495  E_coul = 198.81789842669835
cycle= 2 E= -507.989982955651  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.312
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0383544
diis-c [-0.00146302 -0.00387677  1.00387677]
  HOMO = -0.239494953393714  LUMO = 0.581789420557257
  mo_energy =
[-1.20314475e+02 -1.23717133e+01 -6.66865153e+00 -6.66865153e+00
 -6.66865153e+00 -1.17742251e+00 -2.39494953e-01 -2.39494953e-01
 -2.39494953e-01  5.81789421e-01  2.88917520e+00  1.39493990e+01
  6.76433174e+01  2.61681023e+02  8.90269079e+02  3.14371706e+03
  1.26240130e+04  4.12211265e+04  1.05249298e+05  2.30422407e+05
  4.56229906e+05  8.45176510e+05  1.52834830e+06  2.85060896e+06
  5.80848761e+06]
E1 = -706.6976964643213  E_coul = 198.7074424912135
cycle= 3 E= -507.990253973108  delta_E= -0.000271  |g|= 0.00443  |ddm|= 0.0477
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00470149
diis-c [-3.60941540e-06 -2.52411375e-04 -1.25704051e-01  1.12595646e+00]
  HOMO = -0.242772364230944  LUMO = 0.581423946262541
  mo_energy =
[-1.20326476e+02 -1.23805035e+01 -6.67792621e+00 -6.67792621e+00
 -6.67792621e+00 -1.17941526e+00 -2.42772364e-01 -2.42772364e-01
 -2.42772364e-01  5.81423946e-01  2.88659244e+00  1.39426303e+01
  6.76335269e+01  2.61669682e+02  8.90256833e+02  3.14370411e+03
  1.26239996e+04  4.12211129e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.681439041421  E_coul = 198.69117932726172
cycle= 4 E= -507.990259714159  delta_E= -5.74e-06  |g|= 0.000227  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176121
diis-c [-1.63666665e-09 -1.14355098e-05  8.05668819e-03 -9.26372066e-02
  1.08459195e+00]
  HOMO = -0.242881331017091  LUMO = 0.581401226129568
  mo_energy =
[-1.20326613e+02 -1.23807072e+01 -6.67811441e+00 -6.67811441e+00
 -6.67811441e+00 -1.17948197e+00 -2.42881331e-01 -2.42881331e-01
 -2.42881331e-01  5.81401226e-01  2.88648694e+00  1.39424465e+01
  6.76333511e+01  2.61669532e+02  8.90256701e+02  3.14370400e+03
  1.26239995e+04  4.12211128e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.6808857277388  E_coul = 198.69062599857497
cycle= 5 E= -507.990259729164  delta_E= -1.5e-08  |g|= 1.27e-05  |ddm|= 0.00094
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.7642e-06
diis-c [-2.16411739e-12  9.80577656e-07 -9.74522116e-04  1.07189995e-02
 -1.38970583e-01  1.12922513e+00]
  HOMO = -0.24288481747219  LUMO = 0.581400426789276
  mo_energy =
[-1.20326618e+02 -1.23807121e+01 -6.67811927e+00 -6.67811927e+00
 -6.67811927e+00 -1.17948451e+00 -2.42884817e-01 -2.42884817e-01
 -2.42884817e-01  5.81400427e-01  2.88648306e+00  1.39424415e+01
  6.76333462e+01  2.61669527e+02  8.90256696e+02  3.14370399e+03
  1.26239995e+04  4.12211128e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.6808655690993  E_coul = 198.6906058398939
cycle= 6 E= -507.990259729205  delta_E= -4.16e-11  |g|= 7.1e-08  |ddm|= 6.16e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6808655690993  E_coul = 198.6906058398939
  HOMO = -0.242884844966013  LUMO = 0.581400402794002
  mo_energy =
[-1.20326618e+02 -1.23807121e+01 -6.67811931e+00 -6.67811931e+00
 -6.67811931e+00 -1.17948451e+00 -2.42884845e-01 -2.42884845e-01
 -2.42884845e-01  5.81400403e-01  2.88648302e+00  1.39424415e+01
  6.76333462e+01  2.61669527e+02  8.90256696e+02  3.14370399e+03
  1.26239995e+04  4.12211128e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.6808654833003  E_coul = 198.69060575409532
Extra cycle  E= -507.990259729205  delta_E= 3.98e-13  |g|= 8.29e-09  |ddm|= 2.12e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
exp = [1.93134596e-01 4.31978379e-01 8.53947695e-01 1.17616813e+05
 3.12667452e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232093e+03
 1.83757713e+04 1.44353304e+03 4.17362656e+02 1.47785447e+02
 5.84475180e+01 2.45650996e+01 7.62900710e+00 8.60478971e+00
 4.92873370e-01]
E = -507.990259729205
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.193134596365       1
[INPUT] 0    0    [1    /1   ]  0.431978378891       1
[INPUT] 0    0    [1    /1   ]  0.853947695219       1
[INPUT] 0    0    [1    /1   ]  117616.812889        1
[INPUT] 0    0    [1    /1   ]  3.12667451983        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175464        1
[INPUT] 0    0    [1    /1   ]  36754.7015259        1
[INPUT] 0    0    [1    /1   ]  7302.3209314         1
[INPUT] 0    0    [1    /1   ]  18375.7713181        1
[INPUT] 0    0    [1    /1   ]  1443.53303973        1
[INPUT] 0    0    [1    /1   ]  417.362656042        1
[INPUT] 0    0    [1    /1   ]  147.785446548        1
[INPUT] 0    0    [1    /1   ]  58.4475179935        1
[INPUT] 0    0    [1    /1   ]  24.5650995953        1
[INPUT] 0    0    [1    /1   ]  7.6290071032         1
[INPUT] 1    0    [1    /1   ]  8.60478970662        1
[INPUT] 1    0    [1    /1   ]  0.492873370238       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.19313459636512942, 1.0]], [0, [0.4319783788907231, 1.0]], [0, [0.8539476952191069, 1.0]], [0, [117616.81288873688, 1.0]], [0, [3.126674519826687, 1.0]], [0, [1176168.142613448, 1.0]], [0, [588084.0699565379, 1.0]], [0, [294042.03092131624, 1.0]], [0, [147020.99132284682, 1.0]], [0, [73510.41754642242, 1.0]], [0, [36754.70152588563, 1.0]], [0, [7302.320931399855, 1.0]], [0, [18375.77131808351, 1.0]], [0, [1443.5330397305595, 1.0]], [0, [417.36265604161594, 1.0]], [0, [147.78544654810784, 1.0]], [0, [58.44751799351735, 1.0]], [0, [24.565099595301845, 1.0]], [0, [7.629007103202919, 1.0]], [1, [8.604789706621329, 1.0]], [1, [0.4928733702379187, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.1931346]
bas 1, expnt(s) = [0.43197838]
bas 2, expnt(s) = [0.8539477]
bas 3, expnt(s) = [117616.81288874]
bas 4, expnt(s) = [3.12667452]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995654]
bas 7, expnt(s) = [294042.03092132]
bas 8, expnt(s) = [147020.99132285]
bas 9, expnt(s) = [73510.41754642]
bas 10, expnt(s) = [36754.70152589]
bas 11, expnt(s) = [7302.3209314]
bas 12, expnt(s) = [18375.77131808]
bas 13, expnt(s) = [1443.53303973]
bas 14, expnt(s) = [417.36265604]
bas 15, expnt(s) = [147.78544655]
bas 16, expnt(s) = [58.44751799]
bas 17, expnt(s) = [24.5650996]
bas 18, expnt(s) = [7.6290071]
bas 19, expnt(s) = [8.60478971]
bas 20, expnt(s) = [0.49287337]
CPU time:       434.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.93134596e-01 7.36054685e-01 4.31978379e-01 1.34620603e+00
 8.53947695e-01 2.24433911e+00 1.17616813e+05 1.60460108e+04
 3.12667452e+00 5.94055512e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232093e+03 1.99577102e+03
 1.83757713e+04 3.98748633e+03 1.44353304e+03 5.91677522e+02
 4.17362656e+02 2.33292198e+02 1.47785447e+02 1.07087499e+02
 5.84475180e+01 5.34059419e+01 2.45650996e+01 2.78775062e+01
 7.62900710e+00 1.15975443e+01 8.60478971e+00 4.29941848e+01
 4.92873370e-01 1.20476845e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336010877857163
cond(S) = 912230.6339832406
E1 = -689.6041696987766  E_coul = 184.9803411456508
init E= -504.623828553126
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.671905831330357  LUMO = 0.301158656519157
  mo_energy =
[-1.21708772e+02 -1.33853398e+01 -7.62301373e+00 -7.62301373e+00
 -7.62301373e+00 -1.65746487e+00 -6.71905831e-01 -6.71905831e-01
 -6.71905831e-01  3.01158657e-01  2.42757241e+00  1.31302917e+01
  6.64606628e+01  2.60330585e+02  8.88897591e+02  3.14242002e+03
  1.26228328e+04  4.12200174e+04  1.05248227e+05  2.30421362e+05
  4.56228879e+05  8.45175496e+05  1.52834730e+06  2.85060797e+06
  5.80848662e+06]
E1 = -707.7623911705033  E_coul = 199.7902067601136
cycle= 1 E= -507.97218441039  delta_E= -3.35  |g|= 0.452  |ddm|= 0.445
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.735023
diis-c [-0.54025851  1.        ]
  HOMO = -0.217215696388186  LUMO = 0.583137831510268
  mo_energy =
[-1.20199525e+02 -1.23039244e+01 -6.59360482e+00 -6.59360482e+00
 -6.59360482e+00 -1.16307425e+00 -2.17215696e-01 -2.17215696e-01
 -2.17215696e-01  5.83137832e-01  2.90465658e+00  1.39985466e+01
  6.77260208e+01  2.61785916e+02  8.90389799e+02  3.14385205e+03
  1.26241582e+04  4.12212756e+04  1.05249449e+05  2.30422558e+05
  4.56230058e+05  8.45176663e+05  1.52834846e+06  2.85060912e+06
  5.80848776e+06]
E1 = -706.8078813823495  E_coul = 198.81789842669835
cycle= 2 E= -507.989982955651  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.312
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0383544
diis-c [-0.00146302 -0.00387677  1.00387677]
  HOMO = -0.239494953393714  LUMO = 0.581789420557257
  mo_energy =
[-1.20314475e+02 -1.23717133e+01 -6.66865153e+00 -6.66865153e+00
 -6.66865153e+00 -1.17742251e+00 -2.39494953e-01 -2.39494953e-01
 -2.39494953e-01  5.81789421e-01  2.88917520e+00  1.39493990e+01
  6.76433174e+01  2.61681023e+02  8.90269079e+02  3.14371706e+03
  1.26240130e+04  4.12211265e+04  1.05249298e+05  2.30422407e+05
  4.56229906e+05  8.45176510e+05  1.52834830e+06  2.85060896e+06
  5.80848761e+06]
E1 = -706.6976964643213  E_coul = 198.7074424912135
cycle= 3 E= -507.990253973108  delta_E= -0.000271  |g|= 0.00443  |ddm|= 0.0477
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00470149
diis-c [-3.60941540e-06 -2.52411375e-04 -1.25704051e-01  1.12595646e+00]
  HOMO = -0.242772364230944  LUMO = 0.581423946262541
  mo_energy =
[-1.20326476e+02 -1.23805035e+01 -6.67792621e+00 -6.67792621e+00
 -6.67792621e+00 -1.17941526e+00 -2.42772364e-01 -2.42772364e-01
 -2.42772364e-01  5.81423946e-01  2.88659244e+00  1.39426303e+01
  6.76335269e+01  2.61669682e+02  8.90256833e+02  3.14370411e+03
  1.26239996e+04  4.12211129e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.681439041421  E_coul = 198.69117932726172
cycle= 4 E= -507.990259714159  delta_E= -5.74e-06  |g|= 0.000227  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176121
diis-c [-1.63666665e-09 -1.14355098e-05  8.05668819e-03 -9.26372066e-02
  1.08459195e+00]
  HOMO = -0.242881331017091  LUMO = 0.581401226129568
  mo_energy =
[-1.20326613e+02 -1.23807072e+01 -6.67811441e+00 -6.67811441e+00
 -6.67811441e+00 -1.17948197e+00 -2.42881331e-01 -2.42881331e-01
 -2.42881331e-01  5.81401226e-01  2.88648694e+00  1.39424465e+01
  6.76333511e+01  2.61669532e+02  8.90256701e+02  3.14370400e+03
  1.26239995e+04  4.12211128e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.6808857277388  E_coul = 198.69062599857497
cycle= 5 E= -507.990259729164  delta_E= -1.5e-08  |g|= 1.27e-05  |ddm|= 0.00094
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.7642e-06
diis-c [-2.16411739e-12  9.80577656e-07 -9.74522116e-04  1.07189995e-02
 -1.38970583e-01  1.12922513e+00]
  HOMO = -0.24288481747219  LUMO = 0.581400426789276
  mo_energy =
[-1.20326618e+02 -1.23807121e+01 -6.67811927e+00 -6.67811927e+00
 -6.67811927e+00 -1.17948451e+00 -2.42884817e-01 -2.42884817e-01
 -2.42884817e-01  5.81400427e-01  2.88648306e+00  1.39424415e+01
  6.76333462e+01  2.61669527e+02  8.90256696e+02  3.14370399e+03
  1.26239995e+04  4.12211128e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.6808655690993  E_coul = 198.6906058398939
cycle= 6 E= -507.990259729205  delta_E= -4.16e-11  |g|= 7.1e-08  |ddm|= 6.16e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6808655690993  E_coul = 198.6906058398939
  HOMO = -0.242884844966013  LUMO = 0.581400402794002
  mo_energy =
[-1.20326618e+02 -1.23807121e+01 -6.67811931e+00 -6.67811931e+00
 -6.67811931e+00 -1.17948451e+00 -2.42884845e-01 -2.42884845e-01
 -2.42884845e-01  5.81400403e-01  2.88648302e+00  1.39424415e+01
  6.76333462e+01  2.61669527e+02  8.90256696e+02  3.14370399e+03
  1.26239995e+04  4.12211128e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.6808654833003  E_coul = 198.69060575409532
Extra cycle  E= -507.990259729205  delta_E= 3.98e-13  |g|= 8.29e-09  |ddm|= 2.12e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912230.6339832406
E1 = -706.6808654833003  E_coul = 198.69060575409532
init E= -507.990259729205
    CPU time for initialize scf      5.76 sec, wall time      0.24 sec
  HOMO = -0.242884848174848  LUMO = 0.581400402113489
  mo_energy =
[-1.20326618e+02 -1.23807121e+01 -6.67811932e+00 -6.67811932e+00
 -6.67811932e+00 -1.17948451e+00 -2.42884848e-01 -2.42884848e-01
 -2.42884848e-01  5.81400402e-01  2.88648302e+00  1.39424415e+01
  6.76333462e+01  2.61669527e+02  8.90256696e+02  3.14370399e+03
  1.26239995e+04  4.12211128e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.6808654671138  E_coul = 198.69060573790938
cycle= 1 E= -507.990259729204  delta_E= 5.68e-13  |g|= 2.07e-09  |ddm|= 3.14e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6808654671138  E_coul = 198.69060573790938
  HOMO = -0.242884848735611  LUMO = 0.581400402316035
  mo_energy =
[-1.20326618e+02 -1.23807121e+01 -6.67811932e+00 -6.67811932e+00
 -6.67811932e+00 -1.17948451e+00 -2.42884849e-01 -2.42884849e-01
 -2.42884849e-01  5.81400402e-01  2.88648302e+00  1.39424415e+01
  6.76333462e+01  2.61669527e+02  8.90256696e+02  3.14370399e+03
  1.26239995e+04  4.12211128e+04  1.05249284e+05  2.30422393e+05
  4.56229893e+05  8.45176497e+05  1.52834829e+06  2.85060895e+06
  5.80848760e+06]
E1 = -706.6808654638354  E_coul = 198.69060573463062
Extra cycle  E= -507.990259729205  delta_E= -3.98e-13  |g|= 1.79e-09  |ddm|= 4.8e-09
    CPU time for scf_cycle      6.27 sec, wall time      0.41 sec
exp = [1.93134596e-01 4.31978379e-01 8.53947695e-01 1.17616813e+05
 3.12667452e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232093e+03
 1.83757713e+04 1.44353304e+03 4.17362656e+02 1.47785447e+02
 5.84475180e+01 2.45650996e+01 7.62900710e+00 8.60478971e+00
 4.92873370e-01]
grad_E = [ 1.72318327e-03 -2.88593640e-04 -4.36918715e-04  6.07053357e-09
 -9.22184706e-04  4.05327045e-11  1.74426628e-10  9.41570351e-10
  3.72026975e-09  1.55354959e-08  8.10255697e-08  5.10712236e-06
  1.98713476e-07 -3.86973547e-05 -4.02655969e-06 -6.77990977e-06
  2.53985520e-05 -4.42601302e-05 -2.07835655e-04  2.55110826e-04
  4.02765344e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:56 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.183782901982       1
[INPUT] 0    0    [1    /1   ]  0.421638516546       1
[INPUT] 0    0    [1    /1   ]  0.886028646833       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.14978565713        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175455        1
[INPUT] 0    0    [1    /1   ]  36754.7015213        1
[INPUT] 0    0    [1    /1   ]  7302.32064116        1
[INPUT] 0    0    [1    /1   ]  18375.7713068        1
[INPUT] 0    0    [1    /1   ]  1443.53524416        1
[INPUT] 0    0    [1    /1   ]  417.362822058        1
[INPUT] 0    0    [1    /1   ]  147.786155876        1
[INPUT] 0    0    [1    /1   ]  58.4447768748        1
[INPUT] 0    0    [1    /1   ]  24.5691169735        1
[INPUT] 0    0    [1    /1   ]  7.66004260737        1
[INPUT] 1    0    [1    /1   ]  8.60502329626        1
[INPUT] 1    0    [1    /1   ]  0.492930213269       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.18378290198194133, 1.0]], [0, [0.4216385165456561, 1.0]], [0, [0.8860286468330345, 1.0]], [0, [117616.81288839188, 1.0]], [0, [3.1497856571334704, 1.0]], [0, [1176168.1426134456, 1.0]], [0, [588084.069956528, 1.0]], [0, [294042.03092126275, 1.0]], [0, [147020.99132263538, 1.0]], [0, [73510.41754553949, 1.0]], [0, [36754.701521280884, 1.0]], [0, [7302.320641155503, 1.0]], [0, [18375.77130678859, 1.0]], [0, [1443.5352441587995, 1.0]], [0, [417.3628220579364, 1.0]], [0, [147.78615587611876, 1.0]], [0, [58.44477687484937, 1.0]], [0, [24.569116973464492, 1.0]], [0, [7.660042607369656, 1.0]], [1, [8.605023296260784, 1.0]], [1, [0.49293021326930253, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.1837829]
bas 1, expnt(s) = [0.42163852]
bas 2, expnt(s) = [0.88602865]
bas 3, expnt(s) = [117616.81288839]
bas 4, expnt(s) = [3.14978566]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995653]
bas 7, expnt(s) = [294042.03092126]
bas 8, expnt(s) = [147020.99132264]
bas 9, expnt(s) = [73510.41754554]
bas 10, expnt(s) = [36754.70152128]
bas 11, expnt(s) = [7302.32064116]
bas 12, expnt(s) = [18375.77130679]
bas 13, expnt(s) = [1443.53524416]
bas 14, expnt(s) = [417.36282206]
bas 15, expnt(s) = [147.78615588]
bas 16, expnt(s) = [58.44477687]
bas 17, expnt(s) = [24.56911697]
bas 18, expnt(s) = [7.66004261]
bas 19, expnt(s) = [8.6050233]
bas 20, expnt(s) = [0.49293021]
CPU time:       449.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.83782902e-01 7.09159382e-01 4.21638517e-01 1.32196584e+00
 8.86028647e-01 2.30728290e+00 1.17616813e+05 1.60460108e+04
 3.14978566e+00 5.97345746e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232064e+03 1.99577096e+03
 1.83757713e+04 3.98748633e+03 1.44353524e+03 5.91678200e+02
 4.17362822e+02 2.33292268e+02 1.47786156e+02 1.07087884e+02
 5.84447769e+01 5.34040634e+01 2.45691170e+01 2.78809255e+01
 7.66004261e+00 1.16329112e+01 8.60502330e+00 4.29956437e+01
 4.92930213e-01 1.20494213e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33594188565211
cond(S) = 912235.1710847378
E1 = -689.6067720718246  E_coul = 184.98315599875784
init E= -504.623616073067
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.671849791434487  LUMO = 0.279650524982725
  mo_energy =
[-1.21708397e+02 -1.33851132e+01 -7.62282941e+00 -7.62282941e+00
 -7.62282941e+00 -1.65744329e+00 -6.71849791e-01 -6.71849791e-01
 -6.71849791e-01  2.79650525e-01  2.40684432e+00  1.32521708e+01
  6.67252966e+01  2.60614991e+02  8.89160417e+02  3.14265882e+03
  1.26230481e+04  4.12202183e+04  1.05248420e+05  2.30421549e+05
  4.56229062e+05  8.45175677e+05  1.52834748e+06  2.85060815e+06
  5.80848679e+06]
E1 = -707.768628278071  E_coul = 199.79643248151265
cycle= 1 E= -507.972195796558  delta_E= -3.35  |g|= 0.452  |ddm|= 0.446
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.738412
diis-c [-0.54525157  1.        ]
  HOMO = -0.217067855265697  LUMO = 0.557830955575181
  mo_energy =
[-1.20198806e+02 -1.23034472e+01 -6.59315450e+00 -6.59315450e+00
 -6.59315450e+00 -1.16296890e+00 -2.17067855e-01 -2.17067855e-01
 -2.17067855e-01  5.57830956e-01  2.88674614e+00  1.41234782e+01
  6.79911564e+01  2.62070589e+02  8.90652956e+02  3.14409120e+03
  1.26243738e+04  4.12214769e+04  1.05249642e+05  2.30422746e+05
  4.56230242e+05  8.45176844e+05  1.52834863e+06  2.85060929e+06
  5.80848793e+06]
E1 = -706.8125749594894  E_coul = 198.82255315202616
cycle= 2 E= -507.990021807463  delta_E= -0.0178  |g|= 0.0352  |ddm|= 0.313
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0390334
diis-c [-0.00151294 -0.00444976  1.00444976]
  HOMO = -0.239395675819904  LUMO = 0.556553653954698
  mo_energy =
[-1.20313977e+02 -1.23713976e+01 -6.66837131e+00 -6.66837131e+00
 -6.66837131e+00 -1.17735006e+00 -2.39395676e-01 -2.39395676e-01
 -2.39395676e-01  5.56553654e-01  2.87114190e+00  1.40739521e+01
  6.79082389e+01  2.61965491e+02  8.90532010e+02  3.14395597e+03
  1.26242284e+04  4.12213276e+04  1.05249491e+05  2.30422595e+05
  4.56230090e+05  8.45176691e+05  1.52834848e+06  2.85060914e+06
  5.80848778e+06]
E1 = -706.7019431466757  E_coul = 198.71164887896933
cycle= 3 E= -507.990294267706  delta_E= -0.000272  |g|= 0.00443  |ddm|= 0.0478
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00480334
diis-c [-3.75860913e-06 -2.45682992e-04 -1.26272600e-01  1.12651828e+00]
  HOMO = -0.242676654942206  LUMO = 0.556200882566597
  mo_energy =
[-1.20325963e+02 -1.23801897e+01 -6.67764525e+00 -6.67764525e+00
 -6.67764525e+00 -1.17934474e+00 -2.42676655e-01 -2.42676655e-01
 -2.42676655e-01  5.56200883e-01  2.86853562e+00  1.40671504e+01
  6.78984487e+01  2.61954161e+02  8.90519781e+02  3.14394304e+03
  1.26242150e+04  4.12213140e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176678e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6856178305395  E_coul = 198.69531776449787
cycle= 4 E= -507.990300066042  delta_E= -5.8e-06  |g|= 0.00023  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000181058
diis-c [-1.84442360e-09 -1.18638470e-05  8.09374768e-03 -9.29416041e-02
  1.08485972e+00]
  HOMO = -0.242785172104153  LUMO = 0.556178656576908
  mo_energy =
[-1.20326095e+02 -1.23803903e+01 -6.67782988e+00 -6.67782988e+00
 -6.67782988e+00 -1.17941125e+00 -2.42785172e-01 -2.42785172e-01
 -2.42785172e-01  5.56178657e-01  2.86842908e+00  1.40669683e+01
  6.78982769e+01  2.61954016e+02  8.90519655e+02  3.14394293e+03
  1.26242149e+04  4.12213139e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176677e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6850620880889  E_coul = 198.694762006416
cycle= 5 E= -507.990300081673  delta_E= -1.56e-08  |g|= 1.31e-05  |ddm|= 0.000918
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.16779e-06
diis-c [-2.25610437e-12  9.96516104e-07 -9.85176139e-04  1.08099358e-02
 -1.40463456e-01  1.13063770e+00]
  HOMO = -0.242788723641454  LUMO = 0.556177859810292
  mo_energy =
[-1.20326100e+02 -1.23803952e+01 -6.67783472e+00 -6.67783472e+00
 -6.67783472e+00 -1.17941384e+00 -2.42788724e-01 -2.42788724e-01
 -2.42788724e-01  5.56177860e-01  2.86842506e+00  1.40669633e+01
  6.78982720e+01  2.61954011e+02  8.90519650e+02  3.14394293e+03
  1.26242149e+04  4.12213139e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176677e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6850412035526  E_coul = 198.69474112183565
cycle= 6 E= -507.990300081717  delta_E= -4.41e-11  |g|= 6.67e-08  |ddm|= 6.08e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6850412035526  E_coul = 198.69474112183565
  HOMO = -0.242788750722338  LUMO = 0.556177835736527
  mo_energy =
[-1.20326100e+02 -1.23803952e+01 -6.67783477e+00 -6.67783477e+00
 -6.67783477e+00 -1.17941383e+00 -2.42788751e-01 -2.42788751e-01
 -2.42788751e-01  5.56177836e-01  2.86842502e+00  1.40669632e+01
  6.78982720e+01  2.61954011e+02  8.90519650e+02  3.14394293e+03
  1.26242149e+04  4.12213139e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176677e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6850411286588  E_coul = 198.69474104694163
Extra cycle  E= -507.990300081717  delta_E= -1.71e-13  |g|= 7.96e-09  |ddm|= 1.72e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
exp = [1.83782902e-01 4.21638517e-01 8.86028647e-01 1.17616813e+05
 3.14978566e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232064e+03
 1.83757713e+04 1.44353524e+03 4.17362822e+02 1.47786156e+02
 5.84447769e+01 2.45691170e+01 7.66004261e+00 8.60502330e+00
 4.92930213e-01]
E = -507.9903000817171
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:29:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.183782901982       1
[INPUT] 0    0    [1    /1   ]  0.421638516546       1
[INPUT] 0    0    [1    /1   ]  0.886028646833       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.14978565713        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991323        1
[INPUT] 0    0    [1    /1   ]  73510.4175455        1
[INPUT] 0    0    [1    /1   ]  36754.7015213        1
[INPUT] 0    0    [1    /1   ]  7302.32064116        1
[INPUT] 0    0    [1    /1   ]  18375.7713068        1
[INPUT] 0    0    [1    /1   ]  1443.53524416        1
[INPUT] 0    0    [1    /1   ]  417.362822058        1
[INPUT] 0    0    [1    /1   ]  147.786155876        1
[INPUT] 0    0    [1    /1   ]  58.4447768748        1
[INPUT] 0    0    [1    /1   ]  24.5691169735        1
[INPUT] 0    0    [1    /1   ]  7.66004260737        1
[INPUT] 1    0    [1    /1   ]  8.60502329626        1
[INPUT] 1    0    [1    /1   ]  0.492930213269       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.18378290198194133, 1.0]], [0, [0.4216385165456561, 1.0]], [0, [0.8860286468330345, 1.0]], [0, [117616.81288839188, 1.0]], [0, [3.1497856571334704, 1.0]], [0, [1176168.1426134456, 1.0]], [0, [588084.069956528, 1.0]], [0, [294042.03092126275, 1.0]], [0, [147020.99132263538, 1.0]], [0, [73510.41754553949, 1.0]], [0, [36754.701521280884, 1.0]], [0, [7302.320641155503, 1.0]], [0, [18375.77130678859, 1.0]], [0, [1443.5352441587995, 1.0]], [0, [417.3628220579364, 1.0]], [0, [147.78615587611876, 1.0]], [0, [58.44477687484937, 1.0]], [0, [24.569116973464492, 1.0]], [0, [7.660042607369656, 1.0]], [1, [8.605023296260784, 1.0]], [1, [0.49293021326930253, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.1837829]
bas 1, expnt(s) = [0.42163852]
bas 2, expnt(s) = [0.88602865]
bas 3, expnt(s) = [117616.81288839]
bas 4, expnt(s) = [3.14978566]
bas 5, expnt(s) = [1176168.14261345]
bas 6, expnt(s) = [588084.06995653]
bas 7, expnt(s) = [294042.03092126]
bas 8, expnt(s) = [147020.99132264]
bas 9, expnt(s) = [73510.41754554]
bas 10, expnt(s) = [36754.70152128]
bas 11, expnt(s) = [7302.32064116]
bas 12, expnt(s) = [18375.77130679]
bas 13, expnt(s) = [1443.53524416]
bas 14, expnt(s) = [417.36282206]
bas 15, expnt(s) = [147.78615588]
bas 16, expnt(s) = [58.44477687]
bas 17, expnt(s) = [24.56911697]
bas 18, expnt(s) = [7.66004261]
bas 19, expnt(s) = [8.6050233]
bas 20, expnt(s) = [0.49293021]
CPU time:       450.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.83782902e-01 7.09159382e-01 4.21638517e-01 1.32196584e+00
 8.86028647e-01 2.30728290e+00 1.17616813e+05 1.60460108e+04
 3.14978566e+00 5.97345746e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655823e+03 7.30232064e+03 1.99577096e+03
 1.83757713e+04 3.98748633e+03 1.44353524e+03 5.91678200e+02
 4.17362822e+02 2.33292268e+02 1.47786156e+02 1.07087884e+02
 5.84447769e+01 5.34040634e+01 2.45691170e+01 2.78809255e+01
 7.66004261e+00 1.16329112e+01 8.60502330e+00 4.29956437e+01
 4.92930213e-01 1.20494213e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33594188565211
cond(S) = 912235.1710847378
E1 = -689.6067720718246  E_coul = 184.98315599875784
init E= -504.623616073067
    CPU time for initialize scf      0.66 sec, wall time      0.07 sec
  HOMO = -0.671849791434487  LUMO = 0.279650524982725
  mo_energy =
[-1.21708397e+02 -1.33851132e+01 -7.62282941e+00 -7.62282941e+00
 -7.62282941e+00 -1.65744329e+00 -6.71849791e-01 -6.71849791e-01
 -6.71849791e-01  2.79650525e-01  2.40684432e+00  1.32521708e+01
  6.67252966e+01  2.60614991e+02  8.89160417e+02  3.14265882e+03
  1.26230481e+04  4.12202183e+04  1.05248420e+05  2.30421549e+05
  4.56229062e+05  8.45175677e+05  1.52834748e+06  2.85060815e+06
  5.80848679e+06]
E1 = -707.768628278071  E_coul = 199.79643248151265
cycle= 1 E= -507.972195796558  delta_E= -3.35  |g|= 0.452  |ddm|= 0.446
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.738412
diis-c [-0.54525157  1.        ]
  HOMO = -0.217067855265697  LUMO = 0.557830955575181
  mo_energy =
[-1.20198806e+02 -1.23034472e+01 -6.59315450e+00 -6.59315450e+00
 -6.59315450e+00 -1.16296890e+00 -2.17067855e-01 -2.17067855e-01
 -2.17067855e-01  5.57830956e-01  2.88674614e+00  1.41234782e+01
  6.79911564e+01  2.62070589e+02  8.90652956e+02  3.14409120e+03
  1.26243738e+04  4.12214769e+04  1.05249642e+05  2.30422746e+05
  4.56230242e+05  8.45176844e+05  1.52834863e+06  2.85060929e+06
  5.80848793e+06]
E1 = -706.8125749594894  E_coul = 198.82255315202616
cycle= 2 E= -507.990021807463  delta_E= -0.0178  |g|= 0.0352  |ddm|= 0.313
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0390334
diis-c [-0.00151294 -0.00444976  1.00444976]
  HOMO = -0.239395675819904  LUMO = 0.556553653954698
  mo_energy =
[-1.20313977e+02 -1.23713976e+01 -6.66837131e+00 -6.66837131e+00
 -6.66837131e+00 -1.17735006e+00 -2.39395676e-01 -2.39395676e-01
 -2.39395676e-01  5.56553654e-01  2.87114190e+00  1.40739521e+01
  6.79082389e+01  2.61965491e+02  8.90532010e+02  3.14395597e+03
  1.26242284e+04  4.12213276e+04  1.05249491e+05  2.30422595e+05
  4.56230090e+05  8.45176691e+05  1.52834848e+06  2.85060914e+06
  5.80848778e+06]
E1 = -706.7019431466757  E_coul = 198.71164887896933
cycle= 3 E= -507.990294267706  delta_E= -0.000272  |g|= 0.00443  |ddm|= 0.0478
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00480334
diis-c [-3.75860913e-06 -2.45682992e-04 -1.26272600e-01  1.12651828e+00]
  HOMO = -0.242676654942206  LUMO = 0.556200882566597
  mo_energy =
[-1.20325963e+02 -1.23801897e+01 -6.67764525e+00 -6.67764525e+00
 -6.67764525e+00 -1.17934474e+00 -2.42676655e-01 -2.42676655e-01
 -2.42676655e-01  5.56200883e-01  2.86853562e+00  1.40671504e+01
  6.78984487e+01  2.61954161e+02  8.90519781e+02  3.14394304e+03
  1.26242150e+04  4.12213140e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176678e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6856178305395  E_coul = 198.69531776449787
cycle= 4 E= -507.990300066042  delta_E= -5.8e-06  |g|= 0.00023  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000181058
diis-c [-1.84442360e-09 -1.18638470e-05  8.09374768e-03 -9.29416041e-02
  1.08485972e+00]
  HOMO = -0.242785172104153  LUMO = 0.556178656576908
  mo_energy =
[-1.20326095e+02 -1.23803903e+01 -6.67782988e+00 -6.67782988e+00
 -6.67782988e+00 -1.17941125e+00 -2.42785172e-01 -2.42785172e-01
 -2.42785172e-01  5.56178657e-01  2.86842908e+00  1.40669683e+01
  6.78982769e+01  2.61954016e+02  8.90519655e+02  3.14394293e+03
  1.26242149e+04  4.12213139e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176677e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6850620880889  E_coul = 198.694762006416
cycle= 5 E= -507.990300081673  delta_E= -1.56e-08  |g|= 1.31e-05  |ddm|= 0.000918
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=6.16779e-06
diis-c [-2.25610437e-12  9.96516104e-07 -9.85176139e-04  1.08099358e-02
 -1.40463456e-01  1.13063770e+00]
  HOMO = -0.242788723641454  LUMO = 0.556177859810292
  mo_energy =
[-1.20326100e+02 -1.23803952e+01 -6.67783472e+00 -6.67783472e+00
 -6.67783472e+00 -1.17941384e+00 -2.42788724e-01 -2.42788724e-01
 -2.42788724e-01  5.56177860e-01  2.86842506e+00  1.40669633e+01
  6.78982720e+01  2.61954011e+02  8.90519650e+02  3.14394293e+03
  1.26242149e+04  4.12213139e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176677e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6850412035526  E_coul = 198.69474112183565
cycle= 6 E= -507.990300081717  delta_E= -4.41e-11  |g|= 6.67e-08  |ddm|= 6.08e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6850412035526  E_coul = 198.69474112183565
  HOMO = -0.242788750722338  LUMO = 0.556177835736527
  mo_energy =
[-1.20326100e+02 -1.23803952e+01 -6.67783477e+00 -6.67783477e+00
 -6.67783477e+00 -1.17941383e+00 -2.42788751e-01 -2.42788751e-01
 -2.42788751e-01  5.56177836e-01  2.86842502e+00  1.40669632e+01
  6.78982720e+01  2.61954011e+02  8.90519650e+02  3.14394293e+03
  1.26242149e+04  4.12213139e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176677e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6850411286588  E_coul = 198.69474104694163
Extra cycle  E= -507.990300081717  delta_E= -1.71e-13  |g|= 7.96e-09  |ddm|= 1.72e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912235.1710847378
E1 = -706.6850411286588  E_coul = 198.69474104694163
init E= -507.990300081717
    CPU time for initialize scf      5.56 sec, wall time      0.23 sec
  HOMO = -0.242788753557155  LUMO = 0.556177835613601
  mo_energy =
[-1.20326100e+02 -1.23803952e+01 -6.67783477e+00 -6.67783477e+00
 -6.67783477e+00 -1.17941384e+00 -2.42788754e-01 -2.42788754e-01
 -2.42788754e-01  5.56177836e-01  2.86842502e+00  1.40669632e+01
  6.78982720e+01  2.61954011e+02  8.90519650e+02  3.14394293e+03
  1.26242149e+04  4.12213139e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176677e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.685041113674  E_coul = 198.69474103195677
cycle= 1 E= -507.990300081717  delta_E= -5.68e-14  |g|= 2e-09  |ddm|= 2.76e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.685041113674  E_coul = 198.69474103195677
  HOMO = -0.242788754077922  LUMO = 0.55617783564177
  mo_energy =
[-1.20326100e+02 -1.23803952e+01 -6.67783477e+00 -6.67783477e+00
 -6.67783477e+00 -1.17941384e+00 -2.42788754e-01 -2.42788754e-01
 -2.42788754e-01  5.56177836e-01  2.86842502e+00  1.40669632e+01
  6.78982720e+01  2.61954011e+02  8.90519650e+02  3.14394293e+03
  1.26242149e+04  4.12213139e+04  1.05249477e+05  2.30422581e+05
  4.56230076e+05  8.45176677e+05  1.52834847e+06  2.85060913e+06
  5.80848777e+06]
E1 = -706.6850411077309  E_coul = 198.69474102601436
Extra cycle  E= -507.990300081716  delta_E= 6.82e-13  |g|= 1.56e-09  |ddm|= 4.82e-09
    CPU time for scf_cycle      6.07 sec, wall time      0.40 sec
exp = [1.83782902e-01 4.21638517e-01 8.86028647e-01 1.17616813e+05
 3.14978566e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30232064e+03
 1.83757713e+04 1.44353524e+03 4.17362822e+02 1.47786156e+02
 5.84447769e+01 2.45691170e+01 7.66004261e+00 8.60502330e+00
 4.92930213e-01]
grad_E = [ 1.76857910e-03 -1.35726897e-03 -1.17502749e-04  6.06975515e-09
 -3.12509305e-04  4.05239675e-11  1.74401082e-10  9.41450999e-10
  3.71978758e-09  1.55334558e-08  8.10157318e-08  5.10649780e-06
  1.98681213e-07 -3.86719857e-05 -4.23855693e-06 -6.02136555e-06
  2.46470483e-05 -4.80846459e-05 -3.49374089e-04  4.03797379e-04
  5.96543041e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.181245716215       1
[INPUT] 0    0    [1    /1   ]  0.451515403657       1
[INPUT] 0    0    [1    /1   ]  0.984262576073       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.20455932959        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991322        1
[INPUT] 0    0    [1    /1   ]  73510.4175435        1
[INPUT] 0    0    [1    /1   ]  36754.7015108        1
[INPUT] 0    0    [1    /1   ]  7302.31997997        1
[INPUT] 0    0    [1    /1   ]  18375.7712811        1
[INPUT] 0    0    [1    /1   ]  1443.54026348        1
[INPUT] 0    0    [1    /1   ]  417.363231412        1
[INPUT] 0    0    [1    /1   ]  147.787588217        1
[INPUT] 0    0    [1    /1   ]  58.4393155256        1
[INPUT] 0    0    [1    /1   ]  24.5769766047        1
[INPUT] 0    0    [1    /1   ]  7.71998714954        1
[INPUT] 1    0    [1    /1   ]  8.60511412738        1
[INPUT] 1    0    [1    /1   ]  0.492944308668       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.18124571621480276, 1.0]], [0, [0.451515403657129, 1.0]], [0, [0.9842625760731768, 1.0]], [0, [117616.81288760595, 1.0]], [0, [3.204559329588481, 1.0]], [0, [1176168.1426134403, 1.0]], [0, [588084.0699565054, 1.0]], [0, [294042.03092114086, 1.0]], [0, [147020.99132215374, 1.0]], [0, [73510.41754352815, 1.0]], [0, [36754.70151079106, 1.0]], [0, [7302.319979968259, 1.0]], [0, [18375.771281059027, 1.0]], [0, [1443.5402634766292, 1.0]], [0, [417.3632314119325, 1.0]], [0, [147.7875882174486, 1.0]], [0, [58.439315525615726, 1.0]], [0, [24.576976604693957, 1.0]], [0, [7.7199871495392305, 1.0]], [1, [8.605114127379434, 1.0]], [1, [0.4929443086677371, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.18124572]
bas 1, expnt(s) = [0.4515154]
bas 2, expnt(s) = [0.98426258]
bas 3, expnt(s) = [117616.81288761]
bas 4, expnt(s) = [3.20455933]
bas 5, expnt(s) = [1176168.14261344]
bas 6, expnt(s) = [588084.06995651]
bas 7, expnt(s) = [294042.03092114]
bas 8, expnt(s) = [147020.99132215]
bas 9, expnt(s) = [73510.41754353]
bas 10, expnt(s) = [36754.70151079]
bas 11, expnt(s) = [7302.31997997]
bas 12, expnt(s) = [18375.77128106]
bas 13, expnt(s) = [1443.54026348]
bas 14, expnt(s) = [417.36323141]
bas 15, expnt(s) = [147.78758822]
bas 16, expnt(s) = [58.43931553]
bas 17, expnt(s) = [24.5769766]
bas 18, expnt(s) = [7.71998715]
bas 19, expnt(s) = [8.60511413]
bas 20, expnt(s) = [0.49294431]
CPU time:       465.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.81245716e-01 7.01803997e-01 4.51515404e-01 1.39161613e+00
 9.84262576e-01 2.49659590e+00 1.17616813e+05 1.60460108e+04
 3.20455933e+00 6.05119658e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231998e+03 1.99577082e+03
 1.83757713e+04 3.98748633e+03 1.44354026e+03 5.91679743e+02
 4.17363231e+02 2.33292439e+02 1.47787588e+02 1.07088663e+02
 5.84393155e+01 5.34003206e+01 2.45769766e+01 2.78876145e+01
 7.71998715e+00 1.17011206e+01 8.60511413e+00 4.29962110e+01
 4.92944309e-01 1.20498520e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335937318775148
cond(S) = 912263.8900938097
E1 = -689.6073429563884  E_coul = 184.98324610708522
init E= -504.624096849303
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.671858558694929  LUMO = 0.294914389545211
  mo_energy =
[-1.21708333e+02 -1.33851421e+01 -7.62283677e+00 -7.62283677e+00
 -7.62283677e+00 -1.65742888e+00 -6.71858559e-01 -6.71858559e-01
 -6.71858559e-01  2.94914390e-01  2.64355403e+00  1.39777333e+01
  6.77285455e+01  2.61601907e+02  8.90056970e+02  3.14346710e+03
  1.26237707e+04  4.12208910e+04  1.05249066e+05  2.30422177e+05
  4.56229677e+05  8.45176281e+05  1.52834807e+06  2.85060873e+06
  5.80848736e+06]
E1 = -707.7708992323192  E_coul = 199.79870716650598
cycle= 1 E= -507.972192065813  delta_E= -3.35  |g|= 0.452  |ddm|= 0.44
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.742254
diis-c [-0.55094093  1.        ]
  HOMO = -0.217032793112094  LUMO = 0.579505477909494
  mo_energy =
[-1.20198529e+02 -1.23032930e+01 -6.59297399e+00 -6.59297399e+00
 -6.59297399e+00 -1.16292999e+00 -2.17032793e-01 -2.17032793e-01
 -2.17032793e-01  5.79505478e-01  3.14254033e+00  1.48552726e+01
  6.89941786e+01  2.63057367e+02  8.91549628e+02  3.14489969e+03
  1.26250967e+04  4.12221498e+04  1.05250288e+05  2.30423374e+05
  4.56230857e+05  8.45177448e+05  1.52834923e+06  2.85060987e+06
  5.80848850e+06]
E1 = -706.8120197697893  E_coul = 198.82194955956663
cycle= 2 E= -507.990070210223  delta_E= -0.0179  |g|= 0.0352  |ddm|= 0.311
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0393944
diis-c [-0.00153956 -0.00476516  1.00476516]
  HOMO = -0.239444109177227  LUMO = 0.578017446538594
  mo_energy =
[-1.20314009e+02 -1.23714813e+01 -6.66844087e+00 -6.66844087e+00
 -6.66844087e+00 -1.17736794e+00 -2.39444109e-01 -2.39444109e-01
 -2.39444109e-01  5.78017447e-01  3.12530929e+00  1.48047928e+01
  6.89109583e+01  2.62951997e+02  8.91428376e+02  3.14476412e+03
  1.26249509e+04  4.12220002e+04  1.05250136e+05  2.30423222e+05
  4.56230704e+05  8.45177295e+05  1.52834908e+06  2.85060972e+06
  5.80848835e+06]
E1 = -706.7008489635771  E_coul = 198.71050460089236
cycle= 3 E= -507.990344362685  delta_E= -0.000274  |g|= 0.00443  |ddm|= 0.0497
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00483442
diis-c [-3.88740430e-06 -2.04852707e-04 -1.25709816e-01  1.12591467e+00]
  HOMO = -0.242734483098931  LUMO = 0.577620998173247
  mo_energy =
[-1.20326001e+02 -1.23802872e+01 -6.67772728e+00 -6.67772728e+00
 -6.67772728e+00 -1.17936819e+00 -2.42734483e-01 -2.42734483e-01
 -2.42734483e-01  5.77620998e-01  3.12246705e+00  1.47978978e+01
  6.89011543e+01  2.62940661e+02  8.91416144e+02  3.14475120e+03
  1.26249375e+04  4.12219866e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.6844786842448  E_coul = 198.69412850613327
cycle= 4 E= -507.990350178112  delta_E= -5.82e-06  |g|= 0.00023  |ddm|= 0.0106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000182731
diis-c [-1.81683114e-09 -1.25236467e-05  7.93457920e-03 -9.21001700e-02
  1.08417811e+00]
  HOMO = -0.242845542511772  LUMO = 0.577596694434754
  mo_energy =
[-1.20326142e+02 -1.23804941e+01 -6.67791867e+00 -6.67791867e+00
 -6.67791867e+00 -1.17943625e+00 -2.42845543e-01 -2.42845543e-01
 -2.42845543e-01  5.77596694e-01  3.12235158e+00  1.47977101e+01
  6.89009754e+01  2.62940508e+02  8.91416008e+02  3.14475108e+03
  1.26249374e+04  4.12219865e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.683912746938  E_coul = 198.69356255348697
cycle= 5 E= -507.990350193451  delta_E= -1.53e-08  |g|= 1.25e-05  |ddm|= 0.000874
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.99538e-06
diis-c [-2.12617919e-12  9.47299028e-07 -9.42951630e-04  1.04317713e-02
 -1.36214617e-01  1.12672485e+00]
  HOMO = -0.242849170497855  LUMO = 0.577595857851407
  mo_energy =
[-1.20326147e+02 -1.23804993e+01 -6.67792379e+00 -6.67792379e+00
 -6.67792379e+00 -1.17943888e+00 -2.42849170e-01 -2.42849170e-01
 -2.42849170e-01  5.77595858e-01  3.12234735e+00  1.47977049e+01
  6.89009702e+01  2.62940503e+02  8.91416003e+02  3.14475107e+03
  1.26249374e+04  4.12219865e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.683891778645  E_coul = 198.69354158515517
cycle= 6 E= -507.99035019349  delta_E= -3.89e-11  |g|= 6.3e-08  |ddm|= 5.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.683891778645  E_coul = 198.69354158515517
  HOMO = -0.242849197755212  LUMO = 0.577595835979834
  mo_energy =
[-1.20326147e+02 -1.23804993e+01 -6.67792384e+00 -6.67792384e+00
 -6.67792384e+00 -1.17943887e+00 -2.42849198e-01 -2.42849198e-01
 -2.42849198e-01  5.77595836e-01  3.12234731e+00  1.47977049e+01
  6.89009701e+01  2.62940503e+02  8.91416003e+02  3.14475107e+03
  1.26249374e+04  4.12219865e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.6838916952222  E_coul = 198.69354150173194
Extra cycle  E= -507.99035019349  delta_E= -3.98e-13  |g|= 6.03e-09  |ddm|= 1.4e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [1.81245716e-01 4.51515404e-01 9.84262576e-01 1.17616813e+05
 3.20455933e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231998e+03
 1.83757713e+04 1.44354026e+03 4.17363231e+02 1.47787588e+02
 5.84393155e+01 2.45769766e+01 7.71998715e+00 8.60511413e+00
 4.92944309e-01]
E = -507.99035019349026
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.181245716215       1
[INPUT] 0    0    [1    /1   ]  0.451515403657       1
[INPUT] 0    0    [1    /1   ]  0.984262576073       1
[INPUT] 0    0    [1    /1   ]  117616.812888        1
[INPUT] 0    0    [1    /1   ]  3.20455932959        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069957        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991322        1
[INPUT] 0    0    [1    /1   ]  73510.4175435        1
[INPUT] 0    0    [1    /1   ]  36754.7015108        1
[INPUT] 0    0    [1    /1   ]  7302.31997997        1
[INPUT] 0    0    [1    /1   ]  18375.7712811        1
[INPUT] 0    0    [1    /1   ]  1443.54026348        1
[INPUT] 0    0    [1    /1   ]  417.363231412        1
[INPUT] 0    0    [1    /1   ]  147.787588217        1
[INPUT] 0    0    [1    /1   ]  58.4393155256        1
[INPUT] 0    0    [1    /1   ]  24.5769766047        1
[INPUT] 0    0    [1    /1   ]  7.71998714954        1
[INPUT] 1    0    [1    /1   ]  8.60511412738        1
[INPUT] 1    0    [1    /1   ]  0.492944308668       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.18124571621480276, 1.0]], [0, [0.451515403657129, 1.0]], [0, [0.9842625760731768, 1.0]], [0, [117616.81288760595, 1.0]], [0, [3.204559329588481, 1.0]], [0, [1176168.1426134403, 1.0]], [0, [588084.0699565054, 1.0]], [0, [294042.03092114086, 1.0]], [0, [147020.99132215374, 1.0]], [0, [73510.41754352815, 1.0]], [0, [36754.70151079106, 1.0]], [0, [7302.319979968259, 1.0]], [0, [18375.771281059027, 1.0]], [0, [1443.5402634766292, 1.0]], [0, [417.3632314119325, 1.0]], [0, [147.7875882174486, 1.0]], [0, [58.439315525615726, 1.0]], [0, [24.576976604693957, 1.0]], [0, [7.7199871495392305, 1.0]], [1, [8.605114127379434, 1.0]], [1, [0.4929443086677371, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.18124572]
bas 1, expnt(s) = [0.4515154]
bas 2, expnt(s) = [0.98426258]
bas 3, expnt(s) = [117616.81288761]
bas 4, expnt(s) = [3.20455933]
bas 5, expnt(s) = [1176168.14261344]
bas 6, expnt(s) = [588084.06995651]
bas 7, expnt(s) = [294042.03092114]
bas 8, expnt(s) = [147020.99132215]
bas 9, expnt(s) = [73510.41754353]
bas 10, expnt(s) = [36754.70151079]
bas 11, expnt(s) = [7302.31997997]
bas 12, expnt(s) = [18375.77128106]
bas 13, expnt(s) = [1443.54026348]
bas 14, expnt(s) = [417.36323141]
bas 15, expnt(s) = [147.78758822]
bas 16, expnt(s) = [58.43931553]
bas 17, expnt(s) = [24.5769766]
bas 18, expnt(s) = [7.71998715]
bas 19, expnt(s) = [8.60511413]
bas 20, expnt(s) = [0.49294431]
CPU time:       466.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.81245716e-01 7.01803997e-01 4.51515404e-01 1.39161613e+00
 9.84262576e-01 2.49659590e+00 1.17616813e+05 1.60460108e+04
 3.20455933e+00 6.05119658e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231998e+03 1.99577082e+03
 1.83757713e+04 3.98748633e+03 1.44354026e+03 5.91679743e+02
 4.17363231e+02 2.33292439e+02 1.47787588e+02 1.07088663e+02
 5.84393155e+01 5.34003206e+01 2.45769766e+01 2.78876145e+01
 7.71998715e+00 1.17011206e+01 8.60511413e+00 4.29962110e+01
 4.92944309e-01 1.20498520e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335937318775148
cond(S) = 912263.8900938097
E1 = -689.6073429563884  E_coul = 184.98324610708522
init E= -504.624096849303
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.671858558694929  LUMO = 0.294914389545211
  mo_energy =
[-1.21708333e+02 -1.33851421e+01 -7.62283677e+00 -7.62283677e+00
 -7.62283677e+00 -1.65742888e+00 -6.71858559e-01 -6.71858559e-01
 -6.71858559e-01  2.94914390e-01  2.64355403e+00  1.39777333e+01
  6.77285455e+01  2.61601907e+02  8.90056970e+02  3.14346710e+03
  1.26237707e+04  4.12208910e+04  1.05249066e+05  2.30422177e+05
  4.56229677e+05  8.45176281e+05  1.52834807e+06  2.85060873e+06
  5.80848736e+06]
E1 = -707.7708992323192  E_coul = 199.79870716650598
cycle= 1 E= -507.972192065813  delta_E= -3.35  |g|= 0.452  |ddm|= 0.44
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.742254
diis-c [-0.55094093  1.        ]
  HOMO = -0.217032793112094  LUMO = 0.579505477909494
  mo_energy =
[-1.20198529e+02 -1.23032930e+01 -6.59297399e+00 -6.59297399e+00
 -6.59297399e+00 -1.16292999e+00 -2.17032793e-01 -2.17032793e-01
 -2.17032793e-01  5.79505478e-01  3.14254033e+00  1.48552726e+01
  6.89941786e+01  2.63057367e+02  8.91549628e+02  3.14489969e+03
  1.26250967e+04  4.12221498e+04  1.05250288e+05  2.30423374e+05
  4.56230857e+05  8.45177448e+05  1.52834923e+06  2.85060987e+06
  5.80848850e+06]
E1 = -706.8120197697893  E_coul = 198.82194955956663
cycle= 2 E= -507.990070210223  delta_E= -0.0179  |g|= 0.0352  |ddm|= 0.311
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0393944
diis-c [-0.00153956 -0.00476516  1.00476516]
  HOMO = -0.239444109177227  LUMO = 0.578017446538594
  mo_energy =
[-1.20314009e+02 -1.23714813e+01 -6.66844087e+00 -6.66844087e+00
 -6.66844087e+00 -1.17736794e+00 -2.39444109e-01 -2.39444109e-01
 -2.39444109e-01  5.78017447e-01  3.12530929e+00  1.48047928e+01
  6.89109583e+01  2.62951997e+02  8.91428376e+02  3.14476412e+03
  1.26249509e+04  4.12220002e+04  1.05250136e+05  2.30423222e+05
  4.56230704e+05  8.45177295e+05  1.52834908e+06  2.85060972e+06
  5.80848835e+06]
E1 = -706.7008489635771  E_coul = 198.71050460089236
cycle= 3 E= -507.990344362685  delta_E= -0.000274  |g|= 0.00443  |ddm|= 0.0497
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00483442
diis-c [-3.88740430e-06 -2.04852707e-04 -1.25709816e-01  1.12591467e+00]
  HOMO = -0.242734483098931  LUMO = 0.577620998173247
  mo_energy =
[-1.20326001e+02 -1.23802872e+01 -6.67772728e+00 -6.67772728e+00
 -6.67772728e+00 -1.17936819e+00 -2.42734483e-01 -2.42734483e-01
 -2.42734483e-01  5.77620998e-01  3.12246705e+00  1.47978978e+01
  6.89011543e+01  2.62940661e+02  8.91416144e+02  3.14475120e+03
  1.26249375e+04  4.12219866e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.6844786842448  E_coul = 198.69412850613327
cycle= 4 E= -507.990350178112  delta_E= -5.82e-06  |g|= 0.00023  |ddm|= 0.0106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000182731
diis-c [-1.81683114e-09 -1.25236467e-05  7.93457920e-03 -9.21001700e-02
  1.08417811e+00]
  HOMO = -0.242845542511772  LUMO = 0.577596694434754
  mo_energy =
[-1.20326142e+02 -1.23804941e+01 -6.67791867e+00 -6.67791867e+00
 -6.67791867e+00 -1.17943625e+00 -2.42845543e-01 -2.42845543e-01
 -2.42845543e-01  5.77596694e-01  3.12235158e+00  1.47977101e+01
  6.89009754e+01  2.62940508e+02  8.91416008e+02  3.14475108e+03
  1.26249374e+04  4.12219865e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.683912746938  E_coul = 198.69356255348697
cycle= 5 E= -507.990350193451  delta_E= -1.53e-08  |g|= 1.25e-05  |ddm|= 0.000874
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.99538e-06
diis-c [-2.12617919e-12  9.47299028e-07 -9.42951630e-04  1.04317713e-02
 -1.36214617e-01  1.12672485e+00]
  HOMO = -0.242849170497855  LUMO = 0.577595857851407
  mo_energy =
[-1.20326147e+02 -1.23804993e+01 -6.67792379e+00 -6.67792379e+00
 -6.67792379e+00 -1.17943888e+00 -2.42849170e-01 -2.42849170e-01
 -2.42849170e-01  5.77595858e-01  3.12234735e+00  1.47977049e+01
  6.89009702e+01  2.62940503e+02  8.91416003e+02  3.14475107e+03
  1.26249374e+04  4.12219865e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.683891778645  E_coul = 198.69354158515517
cycle= 6 E= -507.99035019349  delta_E= -3.89e-11  |g|= 6.3e-08  |ddm|= 5.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.683891778645  E_coul = 198.69354158515517
  HOMO = -0.242849197755212  LUMO = 0.577595835979834
  mo_energy =
[-1.20326147e+02 -1.23804993e+01 -6.67792384e+00 -6.67792384e+00
 -6.67792384e+00 -1.17943887e+00 -2.42849198e-01 -2.42849198e-01
 -2.42849198e-01  5.77595836e-01  3.12234731e+00  1.47977049e+01
  6.89009701e+01  2.62940503e+02  8.91416003e+02  3.14475107e+03
  1.26249374e+04  4.12219865e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.6838916952222  E_coul = 198.69354150173194
Extra cycle  E= -507.99035019349  delta_E= -3.98e-13  |g|= 6.03e-09  |ddm|= 1.4e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912263.8900938097
E1 = -706.6838916952222  E_coul = 198.69354150173194
init E= -507.99035019349
    CPU time for initialize scf      6.22 sec, wall time      0.26 sec
  HOMO = -0.242849200728554  LUMO = 0.577595834338009
  mo_energy =
[-1.20326147e+02 -1.23804993e+01 -6.67792385e+00 -6.67792385e+00
 -6.67792385e+00 -1.17943888e+00 -2.42849201e-01 -2.42849201e-01
 -2.42849201e-01  5.77595834e-01  3.12234731e+00  1.47977049e+01
  6.89009701e+01  2.62940503e+02  8.91416003e+02  3.14475107e+03
  1.26249374e+04  4.12219865e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.6838916861421  E_coul = 198.69354149265232
cycle= 1 E= -507.99035019349  delta_E= 4.55e-13  |g|= 3.33e-09  |ddm|= 1.81e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.6838916861421  E_coul = 198.69354149265232
  HOMO = -0.24284920106635  LUMO = 0.577595833701955
  mo_energy =
[-1.20326147e+02 -1.23804993e+01 -6.67792385e+00 -6.67792385e+00
 -6.67792385e+00 -1.17943887e+00 -2.42849201e-01 -2.42849201e-01
 -2.42849201e-01  5.77595834e-01  3.12234731e+00  1.47977049e+01
  6.89009701e+01  2.62940503e+02  8.91416003e+02  3.14475107e+03
  1.26249374e+04  4.12219865e+04  1.05250123e+05  2.30423208e+05
  4.56230691e+05  8.45177282e+05  1.52834906e+06  2.85060971e+06
  5.80848833e+06]
E1 = -706.6838916819567  E_coul = 198.69354148846682
Extra cycle  E= -507.99035019349  delta_E=    0  |g|= 1.38e-09  |ddm|= 4.76e-09
    CPU time for scf_cycle      6.71 sec, wall time      0.43 sec
exp = [1.81245716e-01 4.51515404e-01 9.84262576e-01 1.17616813e+05
 3.20455933e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231998e+03
 1.83757713e+04 1.44354026e+03 4.17363231e+02 1.47787588e+02
 5.84393155e+01 2.45769766e+01 7.71998715e+00 8.60511413e+00
 4.92944309e-01]
grad_E = [-5.49814937e-03  2.27180899e-03 -3.63994968e-04  6.06827713e-09
 -1.49483383e-04  4.05074727e-11  1.74352628e-10  9.41224402e-10
  3.71887212e-09  1.55295825e-08  8.09970498e-08  5.10531816e-06
  1.98619998e-07 -3.86254762e-05 -4.62572399e-06 -4.64133800e-06
  2.25062044e-05 -5.37250235e-05 -4.36409803e-04  4.57555201e-04
  5.55502416e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:11 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.184544071183       1
[INPUT] 0    0    [1    /1   ]  0.457802327486       1
[INPUT] 0    0    [1    /1   ]  1.0229651444         1
[INPUT] 0    0    [1    /1   ]  117616.812887        1
[INPUT] 0    0    [1    /1   ]  3.21744268749        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991322        1
[INPUT] 0    0    [1    /1   ]  73510.4175427        1
[INPUT] 0    0    [1    /1   ]  36754.7015065        1
[INPUT] 0    0    [1    /1   ]  7302.31971123        1
[INPUT] 0    0    [1    /1   ]  18375.7712706        1
[INPUT] 0    0    [1    /1   ]  1443.54230433        1
[INPUT] 0    0    [1    /1   ]  417.363388542        1
[INPUT] 0    0    [1    /1   ]  147.788222467        1
[INPUT] 0    0    [1    /1   ]  58.4368650135        1
[INPUT] 0    0    [1    /1   ]  24.5805044246        1
[INPUT] 0    0    [1    /1   ]  7.74905710649        1
[INPUT] 1    0    [1    /1   ]  8.60450141248        1
[INPUT] 1    0    [1    /1   ]  0.492748462287       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.1845440711832875, 1.0]], [0, [0.45780232748577376, 1.0]], [0, [1.022965144396629, 1.0]], [0, [117616.8128872865, 1.0]], [0, [3.2174426874945445, 1.0]], [0, [1176168.1426134382, 1.0]], [0, [588084.0699564962, 1.0]], [0, [294042.0309210913, 1.0]], [0, [147020.99132195796, 1.0]], [0, [73510.41754271062, 1.0]], [0, [36754.70150652744, 1.0]], [0, [7302.3197112258595, 1.0]], [0, [18375.771270600904, 1.0]], [0, [1443.5423043334756, 1.0]], [0, [417.36338854173914, 1.0]], [0, [147.78822246669176, 1.0]], [0, [58.43686501352264, 1.0]], [0, [24.58050442456282, 1.0]], [0, [7.749057106488356, 1.0]], [1, [8.604501412478502, 1.0]], [1, [0.4927484622869173, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.18454407]
bas 1, expnt(s) = [0.45780233]
bas 2, expnt(s) = [1.02296514]
bas 3, expnt(s) = [117616.81288729]
bas 4, expnt(s) = [3.21744269]
bas 5, expnt(s) = [1176168.14261344]
bas 6, expnt(s) = [588084.0699565]
bas 7, expnt(s) = [294042.03092109]
bas 8, expnt(s) = [147020.99132196]
bas 9, expnt(s) = [73510.41754271]
bas 10, expnt(s) = [36754.70150653]
bas 11, expnt(s) = [7302.31971123]
bas 12, expnt(s) = [18375.7712706]
bas 13, expnt(s) = [1443.54230433]
bas 14, expnt(s) = [417.36338854]
bas 15, expnt(s) = [147.78822247]
bas 16, expnt(s) = [58.43686501]
bas 17, expnt(s) = [24.58050442]
bas 18, expnt(s) = [7.74905711]
bas 19, expnt(s) = [8.60450141]
bas 20, expnt(s) = [0.49274846]
CPU time:       481.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.84544071e-01 7.11361075e-01 4.57802327e-01 1.40612368e+00
 1.02296514e+00 2.56986702e+00 1.17616813e+05 1.60460108e+04
 3.21744269e+00 6.06943324e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231971e+03 1.99577077e+03
 1.83757713e+04 3.98748632e+03 1.44354230e+03 5.91680370e+02
 4.17363389e+02 2.33292505e+02 1.47788222e+02 1.07089007e+02
 5.84368650e+01 5.33986412e+01 2.45805044e+01 2.78906167e+01
 7.74905711e+00 1.17341509e+01 8.60450141e+00 4.29923842e+01
 4.92748462e-01 1.20438681e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33619417055434
cond(S) = 912275.0433529433
E1 = -689.597838799535  E_coul = 184.97418940416597
init E= -504.623649395369
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672094733278643  LUMO = 0.307199915724548
  mo_energy =
[-1.21709449e+02 -1.33858923e+01 -7.62340516e+00 -7.62340516e+00
 -7.62340516e+00 -1.65763891e+00 -6.72094733e-01 -6.72094733e-01
 -6.72094733e-01  3.07199916e-01  2.73840945e+00  1.42400649e+01
  6.80988295e+01  2.61972278e+02  8.90394608e+02  3.14377181e+03
  1.26240433e+04  4.12211449e+04  1.05249309e+05  2.30422413e+05
  4.56229908e+05  8.45176509e+05  1.52834830e+06  2.85060895e+06
  5.80848758e+06]
E1 = -707.7584346824655  E_coul = 199.78620022464358
cycle= 1 E= -507.972234457822  delta_E= -3.35  |g|= 0.452  |ddm|= 0.447
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.743415
diis-c [-0.55266609  1.        ]
  HOMO = -0.217484171701276  LUMO = 0.595095737870548
  mo_energy =
[-1.20199853e+02 -1.23042516e+01 -6.59373527e+00 -6.59373527e+00
 -6.59373527e+00 -1.16327840e+00 -2.17484172e-01 -2.17484172e-01
 -2.17484172e-01  5.95095738e-01  3.24353597e+00  1.51194221e+01
  6.93641414e+01  2.63427404e+02  8.91887029e+02  3.14520420e+03
  1.26253691e+04  4.12224035e+04  1.05250531e+05  2.30423611e+05
  4.56231089e+05  8.45177676e+05  1.52834945e+06  2.85061009e+06
  5.80848871e+06]
E1 = -706.7999944877758  E_coul = 198.8098946706706
cycle= 2 E= -507.990099817105  delta_E= -0.0179  |g|= 0.0352  |ddm|= 0.313
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0392046
diis-c [-0.00152479 -0.004728    1.004728  ]
  HOMO = -0.239863920686689  LUMO = 0.593512065274707
  mo_energy =
[-1.20315304e+02 -1.23724122e+01 -6.66917627e+00 -6.66917627e+00
 -6.66917627e+00 -1.17769863e+00 -2.39863921e-01 -2.39863921e-01
 -2.39863921e-01  5.93512065e-01  3.22578738e+00  1.50687141e+01
  6.92809306e+01  2.63322071e+02  8.91765812e+02  3.14506867e+03
  1.26252234e+04  4.12222539e+04  1.05250380e+05  2.30423459e+05
  4.56230936e+05  8.45177523e+05  1.52834930e+06  2.85060994e+06
  5.80848856e+06]
E1 = -706.6890064584562  E_coul = 198.69863332154358
cycle= 3 E= -507.990373136913  delta_E= -0.000273  |g|= 0.00442  |ddm|= 0.0512
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00477882
diis-c [-3.85716165e-06 -1.82694543e-04 -1.24612419e-01  1.12479511e+00]
  HOMO = -0.243142564505471  LUMO = 0.593098479889426
  mo_energy =
[-1.20327270e+02 -1.23811961e+01 -6.67844029e+00 -6.67844029e+00
 -6.67844029e+00 -1.17969199e+00 -2.43142565e-01 -2.43142565e-01
 -2.43142565e-01  5.93098480e-01  3.22287894e+00  1.50618117e+01
  6.92711487e+01  2.63310761e+02  8.91753605e+02  3.14505577e+03
  1.26252100e+04  4.12222403e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177510e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6727030779625  E_coul = 198.68232416611002
cycle= 4 E= -507.990378911853  delta_E= -5.77e-06  |g|= 0.00023  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000181839
diis-c [-1.73846518e-09 -1.23714754e-05  7.84196547e-03 -9.20689714e-02
  1.08423938e+00]
  HOMO = -0.243256157048047  LUMO = 0.593073214545658
  mo_energy =
[-1.20327423e+02 -1.23814109e+01 -6.67864024e+00 -6.67864024e+00
 -6.67864024e+00 -1.17976159e+00 -2.43256157e-01 -2.43256157e-01
 -2.43256157e-01  5.93073215e-01  3.22275924e+00  1.50616179e+01
  6.92709606e+01  2.63310596e+02  8.91753458e+02  3.14505564e+03
  1.26252099e+04  4.12222402e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177509e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6721258336994  E_coul = 198.68174690648482
cycle= 5 E= -507.990378927215  delta_E= -1.54e-08  |g|= 1.22e-05  |ddm|= 0.000867
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.82959e-06
diis-c [-2.05179744e-12  9.31556871e-07 -9.23954323e-04  1.03299511e-02
 -1.34694965e-01  1.12528804e+00]
  HOMO = -0.243259889962203  LUMO = 0.593072350337965
  mo_energy =
[-1.20327429e+02 -1.23814164e+01 -6.67864575e+00 -6.67864575e+00
 -6.67864575e+00 -1.17976427e+00 -2.43259890e-01 -2.43259890e-01
 -2.43259890e-01  5.93072350e-01  3.22275488e+00  1.50616125e+01
  6.92709550e+01  2.63310590e+02  8.91753452e+02  3.14505563e+03
  1.26252099e+04  4.12222402e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177509e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6721045087064  E_coul = 198.68172558145463
cycle= 6 E= -507.990378927252  delta_E= -3.72e-11  |g|= 6.43e-08  |ddm|= 5.17e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6721045087064  E_coul = 198.68172558145463
  HOMO = -0.24325991815084  LUMO = 0.593072327527799
  mo_energy =
[-1.20327429e+02 -1.23814165e+01 -6.67864580e+00 -6.67864580e+00
 -6.67864580e+00 -1.17976426e+00 -2.43259918e-01 -2.43259918e-01
 -2.43259918e-01  5.93072328e-01  3.22275484e+00  1.50616124e+01
  6.92709549e+01  2.63310590e+02  8.91753452e+02  3.14505563e+03
  1.26252099e+04  4.12222402e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177509e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6721044210888  E_coul = 198.68172549383698
Extra cycle  E= -507.990378927252  delta_E=    0  |g|= 7.01e-09  |ddm|= 1.41e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
exp = [1.84544071e-01 4.57802327e-01 1.02296514e+00 1.17616813e+05
 3.21744269e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231971e+03
 1.83757713e+04 1.44354230e+03 4.17363389e+02 1.47788222e+02
 5.84368650e+01 2.45805044e+01 7.74905711e+00 8.60450141e+00
 4.92748462e-01]
E = -507.99037892725175
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.184544071183       1
[INPUT] 0    0    [1    /1   ]  0.457802327486       1
[INPUT] 0    0    [1    /1   ]  1.0229651444         1
[INPUT] 0    0    [1    /1   ]  117616.812887        1
[INPUT] 0    0    [1    /1   ]  3.21744268749        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991322        1
[INPUT] 0    0    [1    /1   ]  73510.4175427        1
[INPUT] 0    0    [1    /1   ]  36754.7015065        1
[INPUT] 0    0    [1    /1   ]  7302.31971123        1
[INPUT] 0    0    [1    /1   ]  18375.7712706        1
[INPUT] 0    0    [1    /1   ]  1443.54230433        1
[INPUT] 0    0    [1    /1   ]  417.363388542        1
[INPUT] 0    0    [1    /1   ]  147.788222467        1
[INPUT] 0    0    [1    /1   ]  58.4368650135        1
[INPUT] 0    0    [1    /1   ]  24.5805044246        1
[INPUT] 0    0    [1    /1   ]  7.74905710649        1
[INPUT] 1    0    [1    /1   ]  8.60450141248        1
[INPUT] 1    0    [1    /1   ]  0.492748462287       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.1845440711832875, 1.0]], [0, [0.45780232748577376, 1.0]], [0, [1.022965144396629, 1.0]], [0, [117616.8128872865, 1.0]], [0, [3.2174426874945445, 1.0]], [0, [1176168.1426134382, 1.0]], [0, [588084.0699564962, 1.0]], [0, [294042.0309210913, 1.0]], [0, [147020.99132195796, 1.0]], [0, [73510.41754271062, 1.0]], [0, [36754.70150652744, 1.0]], [0, [7302.3197112258595, 1.0]], [0, [18375.771270600904, 1.0]], [0, [1443.5423043334756, 1.0]], [0, [417.36338854173914, 1.0]], [0, [147.78822246669176, 1.0]], [0, [58.43686501352264, 1.0]], [0, [24.58050442456282, 1.0]], [0, [7.749057106488356, 1.0]], [1, [8.604501412478502, 1.0]], [1, [0.4927484622869173, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.18454407]
bas 1, expnt(s) = [0.45780233]
bas 2, expnt(s) = [1.02296514]
bas 3, expnt(s) = [117616.81288729]
bas 4, expnt(s) = [3.21744269]
bas 5, expnt(s) = [1176168.14261344]
bas 6, expnt(s) = [588084.0699565]
bas 7, expnt(s) = [294042.03092109]
bas 8, expnt(s) = [147020.99132196]
bas 9, expnt(s) = [73510.41754271]
bas 10, expnt(s) = [36754.70150653]
bas 11, expnt(s) = [7302.31971123]
bas 12, expnt(s) = [18375.7712706]
bas 13, expnt(s) = [1443.54230433]
bas 14, expnt(s) = [417.36338854]
bas 15, expnt(s) = [147.78822247]
bas 16, expnt(s) = [58.43686501]
bas 17, expnt(s) = [24.58050442]
bas 18, expnt(s) = [7.74905711]
bas 19, expnt(s) = [8.60450141]
bas 20, expnt(s) = [0.49274846]
CPU time:       483.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.84544071e-01 7.11361075e-01 4.57802327e-01 1.40612368e+00
 1.02296514e+00 2.56986702e+00 1.17616813e+05 1.60460108e+04
 3.21744269e+00 6.06943324e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231971e+03 1.99577077e+03
 1.83757713e+04 3.98748632e+03 1.44354230e+03 5.91680370e+02
 4.17363389e+02 2.33292505e+02 1.47788222e+02 1.07089007e+02
 5.84368650e+01 5.33986412e+01 2.45805044e+01 2.78906167e+01
 7.74905711e+00 1.17341509e+01 8.60450141e+00 4.29923842e+01
 4.92748462e-01 1.20438681e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33619417055434
cond(S) = 912275.0433529433
E1 = -689.597838799535  E_coul = 184.97418940416597
init E= -504.623649395369
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.672094733278643  LUMO = 0.307199915724548
  mo_energy =
[-1.21709449e+02 -1.33858923e+01 -7.62340516e+00 -7.62340516e+00
 -7.62340516e+00 -1.65763891e+00 -6.72094733e-01 -6.72094733e-01
 -6.72094733e-01  3.07199916e-01  2.73840945e+00  1.42400649e+01
  6.80988295e+01  2.61972278e+02  8.90394608e+02  3.14377181e+03
  1.26240433e+04  4.12211449e+04  1.05249309e+05  2.30422413e+05
  4.56229908e+05  8.45176509e+05  1.52834830e+06  2.85060895e+06
  5.80848758e+06]
E1 = -707.7584346824655  E_coul = 199.78620022464358
cycle= 1 E= -507.972234457822  delta_E= -3.35  |g|= 0.452  |ddm|= 0.447
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.743415
diis-c [-0.55266609  1.        ]
  HOMO = -0.217484171701276  LUMO = 0.595095737870548
  mo_energy =
[-1.20199853e+02 -1.23042516e+01 -6.59373527e+00 -6.59373527e+00
 -6.59373527e+00 -1.16327840e+00 -2.17484172e-01 -2.17484172e-01
 -2.17484172e-01  5.95095738e-01  3.24353597e+00  1.51194221e+01
  6.93641414e+01  2.63427404e+02  8.91887029e+02  3.14520420e+03
  1.26253691e+04  4.12224035e+04  1.05250531e+05  2.30423611e+05
  4.56231089e+05  8.45177676e+05  1.52834945e+06  2.85061009e+06
  5.80848871e+06]
E1 = -706.7999944877758  E_coul = 198.8098946706706
cycle= 2 E= -507.990099817105  delta_E= -0.0179  |g|= 0.0352  |ddm|= 0.313
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0392046
diis-c [-0.00152479 -0.004728    1.004728  ]
  HOMO = -0.239863920686689  LUMO = 0.593512065274707
  mo_energy =
[-1.20315304e+02 -1.23724122e+01 -6.66917627e+00 -6.66917627e+00
 -6.66917627e+00 -1.17769863e+00 -2.39863921e-01 -2.39863921e-01
 -2.39863921e-01  5.93512065e-01  3.22578738e+00  1.50687141e+01
  6.92809306e+01  2.63322071e+02  8.91765812e+02  3.14506867e+03
  1.26252234e+04  4.12222539e+04  1.05250380e+05  2.30423459e+05
  4.56230936e+05  8.45177523e+05  1.52834930e+06  2.85060994e+06
  5.80848856e+06]
E1 = -706.6890064584562  E_coul = 198.69863332154358
cycle= 3 E= -507.990373136913  delta_E= -0.000273  |g|= 0.00442  |ddm|= 0.0512
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00477882
diis-c [-3.85716165e-06 -1.82694543e-04 -1.24612419e-01  1.12479511e+00]
  HOMO = -0.243142564505471  LUMO = 0.593098479889426
  mo_energy =
[-1.20327270e+02 -1.23811961e+01 -6.67844029e+00 -6.67844029e+00
 -6.67844029e+00 -1.17969199e+00 -2.43142565e-01 -2.43142565e-01
 -2.43142565e-01  5.93098480e-01  3.22287894e+00  1.50618117e+01
  6.92711487e+01  2.63310761e+02  8.91753605e+02  3.14505577e+03
  1.26252100e+04  4.12222403e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177510e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6727030779625  E_coul = 198.68232416611002
cycle= 4 E= -507.990378911853  delta_E= -5.77e-06  |g|= 0.00023  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000181839
diis-c [-1.73846518e-09 -1.23714754e-05  7.84196547e-03 -9.20689714e-02
  1.08423938e+00]
  HOMO = -0.243256157048047  LUMO = 0.593073214545658
  mo_energy =
[-1.20327423e+02 -1.23814109e+01 -6.67864024e+00 -6.67864024e+00
 -6.67864024e+00 -1.17976159e+00 -2.43256157e-01 -2.43256157e-01
 -2.43256157e-01  5.93073215e-01  3.22275924e+00  1.50616179e+01
  6.92709606e+01  2.63310596e+02  8.91753458e+02  3.14505564e+03
  1.26252099e+04  4.12222402e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177509e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6721258336994  E_coul = 198.68174690648482
cycle= 5 E= -507.990378927215  delta_E= -1.54e-08  |g|= 1.22e-05  |ddm|= 0.000867
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.82959e-06
diis-c [-2.05179744e-12  9.31556871e-07 -9.23954323e-04  1.03299511e-02
 -1.34694965e-01  1.12528804e+00]
  HOMO = -0.243259889962203  LUMO = 0.593072350337965
  mo_energy =
[-1.20327429e+02 -1.23814164e+01 -6.67864575e+00 -6.67864575e+00
 -6.67864575e+00 -1.17976427e+00 -2.43259890e-01 -2.43259890e-01
 -2.43259890e-01  5.93072350e-01  3.22275488e+00  1.50616125e+01
  6.92709550e+01  2.63310590e+02  8.91753452e+02  3.14505563e+03
  1.26252099e+04  4.12222402e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177509e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6721045087064  E_coul = 198.68172558145463
cycle= 6 E= -507.990378927252  delta_E= -3.72e-11  |g|= 6.43e-08  |ddm|= 5.17e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6721045087064  E_coul = 198.68172558145463
  HOMO = -0.24325991815084  LUMO = 0.593072327527799
  mo_energy =
[-1.20327429e+02 -1.23814165e+01 -6.67864580e+00 -6.67864580e+00
 -6.67864580e+00 -1.17976426e+00 -2.43259918e-01 -2.43259918e-01
 -2.43259918e-01  5.93072328e-01  3.22275484e+00  1.50616124e+01
  6.92709549e+01  2.63310590e+02  8.91753452e+02  3.14505563e+03
  1.26252099e+04  4.12222402e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177509e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6721044210888  E_coul = 198.68172549383698
Extra cycle  E= -507.990378927252  delta_E=    0  |g|= 7.01e-09  |ddm|= 1.41e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912275.0433529433
E1 = -706.6721044210888  E_coul = 198.68172549383698
init E= -507.990378927252
    CPU time for initialize scf      5.64 sec, wall time      0.24 sec
  HOMO = -0.243259921235966  LUMO = 0.593072327114395
  mo_energy =
[-1.20327429e+02 -1.23814165e+01 -6.67864581e+00 -6.67864581e+00
 -6.67864581e+00 -1.17976427e+00 -2.43259921e-01 -2.43259921e-01
 -2.43259921e-01  5.93072327e-01  3.22275484e+00  1.50616124e+01
  6.92709549e+01  2.63310590e+02  8.91753452e+02  3.14505563e+03
  1.26252099e+04  4.12222402e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177509e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6721044057067  E_coul = 198.6817254784551
cycle= 1 E= -507.990378927252  delta_E= 1.14e-13  |g|= 2.21e-09  |ddm|= 2.16e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6721044057067  E_coul = 198.6817254784551
  HOMO = -0.243259921748923  LUMO = 0.593072326529371
  mo_energy =
[-1.20327429e+02 -1.23814165e+01 -6.67864581e+00 -6.67864581e+00
 -6.67864581e+00 -1.17976427e+00 -2.43259922e-01 -2.43259922e-01
 -2.43259922e-01  5.93072327e-01  3.22275484e+00  1.50616124e+01
  6.92709549e+01  2.63310590e+02  8.91753452e+02  3.14505563e+03
  1.26252099e+04  4.12222402e+04  1.05250366e+05  2.30423445e+05
  4.56230922e+05  8.45177509e+05  1.52834929e+06  2.85060993e+06
  5.80848855e+06]
E1 = -706.6721044052234  E_coul = 198.68172547797192
Extra cycle  E= -507.990378927252  delta_E= 1.14e-13  |g|= 1.34e-09  |ddm|= 3.96e-09
    CPU time for scf_cycle      6.15 sec, wall time      0.40 sec
exp = [1.84544071e-01 4.57802327e-01 1.02296514e+00 1.17616813e+05
 3.21744269e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231971e+03
 1.83757713e+04 1.44354230e+03 4.17363389e+02 1.47788222e+02
 5.84368650e+01 2.45805044e+01 7.74905711e+00 8.60450141e+00
 4.92748462e-01]
grad_E = [-3.82609734e-03  1.23855816e-03 -1.29924665e-04  6.06670323e-09
 -3.25426674e-04  4.04897927e-11  1.74300881e-10  9.40983247e-10
  3.71789699e-09  1.55254550e-08  8.09771782e-08  5.10404927e-06
  1.98554439e-07 -3.85705296e-05 -5.15224880e-06 -2.08170383e-06
  1.31635393e-05 -4.48607648e-05 -3.19396148e-04  1.40084219e-04
 -7.74270910e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.206177419571       1
[INPUT] 0    0    [1    /1   ]  0.510963906924       1
[INPUT] 0    0    [1    /1   ]  1.19538555031        1
[INPUT] 0    0    [1    /1   ]  117616.812886        1
[INPUT] 0    0    [1    /1   ]  3.29321543873        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991321        1
[INPUT] 0    0    [1    /1   ]  73510.4175392        1
[INPUT] 0    0    [1    /1   ]  36754.7014883        1
[INPUT] 0    0    [1    /1   ]  7302.31856043        1
[INPUT] 0    0    [1    /1   ]  18375.7712258        1
[INPUT] 0    0    [1    /1   ]  1443.55104076        1
[INPUT] 0    0    [1    /1   ]  417.364096417        1
[INPUT] 0    0    [1    /1   ]  147.790745226        1
[INPUT] 0    0    [1    /1   ]  58.4271890545        1
[INPUT] 0    0    [1    /1   ]  24.5944565164        1
[INPUT] 0    0    [1    /1   ]  7.85962613183        1
[INPUT] 1    0    [1    /1   ]  8.60328248227        1
[INPUT] 1    0    [1    /1   ]  0.492475043344       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20617741957076935, 1.0]], [0, [0.5109639069243174, 1.0]], [0, [1.1953855503061779, 1.0]], [0, [117616.8128859186, 1.0]], [0, [3.2932154387262256, 1.0]], [0, [1176168.142613429, 1.0]], [0, [588084.0699564569, 1.0]], [0, [294042.03092087916, 1.0]], [0, [147020.99132111965, 1.0]], [0, [73510.4175392099, 1.0]], [0, [36754.70148826994, 1.0]], [0, [7302.318560431692, 1.0]], [0, [18375.771225818586, 1.0]], [0, [1443.5510407587128, 1.0]], [0, [417.3640964172872, 1.0]], [0, [147.79074522634852, 1.0]], [0, [58.427189054544726, 1.0]], [0, [24.594456516414425, 1.0]], [0, [7.859626131832013, 1.0]], [1, [8.603282482274006, 1.0]], [1, [0.4924750433439706, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20617742]
bas 1, expnt(s) = [0.51096391]
bas 2, expnt(s) = [1.19538555]
bas 3, expnt(s) = [117616.81288592]
bas 4, expnt(s) = [3.29321544]
bas 5, expnt(s) = [1176168.14261343]
bas 6, expnt(s) = [588084.06995646]
bas 7, expnt(s) = [294042.03092088]
bas 8, expnt(s) = [147020.99132112]
bas 9, expnt(s) = [73510.41753921]
bas 10, expnt(s) = [36754.70148827]
bas 11, expnt(s) = [7302.31856043]
bas 12, expnt(s) = [18375.77122582]
bas 13, expnt(s) = [1443.55104076]
bas 14, expnt(s) = [417.36409642]
bas 15, expnt(s) = [147.79074523]
bas 16, expnt(s) = [58.42718905]
bas 17, expnt(s) = [24.59445652]
bas 18, expnt(s) = [7.85962613]
bas 19, expnt(s) = [8.60328248]
bas 20, expnt(s) = [0.49247504]
CPU time:       497.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.06177420e-01 7.73029111e-01 5.10963907e-01 1.52688979e+00
 1.19538555e+00 2.88832478e+00 1.17616813e+05 1.60460108e+04
 3.29321544e+00 6.17632487e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231856e+03 1.99577053e+03
 1.83757712e+04 3.98748632e+03 1.44355104e+03 5.91683056e+02
 4.17364096e+02 2.33292802e+02 1.47790745e+02 1.07090378e+02
 5.84271891e+01 5.33920098e+01 2.45944565e+01 2.79024891e+01
 7.85962613e+00 1.18595017e+01 8.60328248e+00 4.29847714e+01
 4.92475043e-01 1.20355149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336526414359607
cond(S) = 912333.6159331577
E1 = -689.5830538533695  E_coul = 184.95959305373262
init E= -504.623460799637
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672430241559894  LUMO = 0.3936611585593
  mo_energy =
[-1.21711371e+02 -1.33871203e+01 -7.62434137e+00 -7.62434137e+00
 -7.62434137e+00 -1.65793666e+00 -6.72430242e-01 -6.72430242e-01
 -6.72430242e-01  3.93661159e-01  3.28145405e+00  1.55755784e+01
  6.99024343e+01  2.63748994e+02  8.92009969e+02  3.14522790e+03
  1.26253443e+04  4.12223556e+04  1.05250471e+05  2.30423543e+05
  4.56231014e+05  8.45177597e+05  1.52834937e+06  2.85061000e+06
  5.80848860e+06]
E1 = -707.7386493005557  E_coul = 199.76631235427246
cycle= 1 E= -507.972336946283  delta_E= -3.35  |g|= 0.452  |ddm|= 0.472
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.746501
diis-c [-0.55726301  1.        ]
  HOMO = -0.218128876648956  LUMO = 0.702558121218397
  mo_energy =
[-1.20202120e+02 -1.23058005e+01 -6.59497870e+00 -6.59497870e+00
 -6.59497870e+00 -1.16378381e+00 -2.18128877e-01 -2.18128877e-01
 -2.18128877e-01  7.02558121e-01  3.81590364e+00  1.64635624e+01
  7.11666255e+01  2.65203158e+02  8.93501885e+02  3.14665996e+03
  1.26266698e+04  4.12236140e+04  1.05251692e+05  2.30424740e+05
  4.56232194e+05  8.45178763e+05  1.52835052e+06  2.85061114e+06
  5.80848973e+06]
E1 = -706.78173750641  E_coul = 198.79156444218856
cycle= 2 E= -507.990173064221  delta_E= -0.0178  |g|= 0.0352  |ddm|= 0.334
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0378342
diis-c [-0.00142211 -0.00411237  1.00411237]
  HOMO = -0.240414978345368  LUMO = 0.700341285513651
  mo_energy =
[-1.20317393e+02 -1.23738203e+01 -6.67027673e+00 -6.67027673e+00
 -6.67027673e+00 -1.17814225e+00 -2.40414978e-01 -2.40414978e-01
 -2.40414978e-01  7.00341286e-01  3.79548341e+00  1.64118409e+01
  7.10835011e+01  2.65098035e+02  8.93380868e+02  3.14652463e+03
  1.26265242e+04  4.12234645e+04  1.05251541e+05  2.30424588e+05
  4.56232041e+05  8.45178611e+05  1.52835037e+06  2.85061099e+06
  5.80848958e+06]
E1 = -706.6717548344069  E_coul = 198.68131282269727
cycle= 3 E= -507.99044201171  delta_E= -0.000269  |g|= 0.0044  |ddm|= 0.0568
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0044628
diis-c [-3.63449458e-06 -8.30194040e-05 -1.19311857e-01  1.11939488e+00]
  HOMO = -0.243645625088045  LUMO = 0.699819397136042
  mo_energy =
[-1.20329271e+02 -1.23825169e+01 -6.67945408e+00 -6.67945408e+00
 -6.67945408e+00 -1.18010524e+00 -2.43645625e-01 -2.43645625e-01
 -2.43645625e-01  6.99819397e-01  3.79224798e+00  1.64049007e+01
  7.10738028e+01  2.65086817e+02  8.93368752e+02  3.14651182e+03
  1.26265110e+04  4.12234511e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.6558252349367  E_coul = 198.6653777215438
cycle= 4 E= -507.990447513393  delta_E= -5.5e-06  |g|= 0.000227  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000174144
diis-c [-1.18177604e-09 -1.13320653e-05  7.39036494e-03 -9.15597615e-02
  1.08418073e+00]
  HOMO = -0.243768710701132  LUMO = 0.69978875516983
  mo_energy =
[-1.20329477e+02 -1.23827660e+01 -6.67969144e+00 -6.67969144e+00
 -6.67969144e+00 -1.18018041e+00 -2.43768711e-01 -2.43768711e-01
 -2.43768711e-01  6.99788755e-01  3.79210974e+00  1.64046808e+01
  7.10735741e+01  2.65086602e+02  8.93368548e+02  3.14651163e+03
  1.26265108e+04  4.12234509e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.655214464634  E_coul = 198.66476693702768
cycle= 5 E= -507.990447527606  delta_E= -1.42e-08  |g|= 1.02e-05  |ddm|= 0.000817
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.57271e-06
diis-c [-1.64227233e-12  8.04625566e-07 -8.07820079e-04  9.51568272e-03
 -1.22977760e-01  1.11426909e+00]
  HOMO = -0.243772424297328  LUMO = 0.699787831264679
  mo_energy =
[-1.20329484e+02 -1.23827722e+01 -6.67969772e+00 -6.67969772e+00
 -6.67969772e+00 -1.18018300e+00 -2.43772424e-01 -2.43772424e-01
 -2.43772424e-01  6.99787831e-01  3.79210531e+00  1.64046749e+01
  7.10735677e+01  2.65086596e+02  8.93368541e+02  3.14651162e+03
  1.26265108e+04  4.12234509e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.6551944575021  E_coul = 198.66474692987174
cycle= 6 E= -507.99044752763  delta_E= -2.41e-11  |g|= 7.51e-08  |ddm|= 4.03e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6551944575021  E_coul = 198.66474692987174
  HOMO = -0.243772457855484  LUMO = 0.699787806878779
  mo_energy =
[-1.20329484e+02 -1.23827723e+01 -6.67969778e+00 -6.67969778e+00
 -6.67969778e+00 -1.18018301e+00 -2.43772458e-01 -2.43772458e-01
 -2.43772458e-01  6.99787807e-01  3.79210526e+00  1.64046748e+01
  7.10735677e+01  2.65086596e+02  8.93368541e+02  3.14651162e+03
  1.26265108e+04  4.12234509e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.6551943287741  E_coul = 198.66474680114374
Extra cycle  E= -507.99044752763  delta_E= 5.68e-14  |g|= 8.37e-09  |ddm|= 1.99e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.06177420e-01 5.10963907e-01 1.19538555e+00 1.17616813e+05
 3.29321544e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231856e+03
 1.83757712e+04 1.44355104e+03 4.17364096e+02 1.47790745e+02
 5.84271891e+01 2.45944565e+01 7.85962613e+00 8.60328248e+00
 4.92475043e-01]
E = -507.99044752763035
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.206177419571       1
[INPUT] 0    0    [1    /1   ]  0.510963906924       1
[INPUT] 0    0    [1    /1   ]  1.19538555031        1
[INPUT] 0    0    [1    /1   ]  117616.812886        1
[INPUT] 0    0    [1    /1   ]  3.29321543873        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.991321        1
[INPUT] 0    0    [1    /1   ]  73510.4175392        1
[INPUT] 0    0    [1    /1   ]  36754.7014883        1
[INPUT] 0    0    [1    /1   ]  7302.31856043        1
[INPUT] 0    0    [1    /1   ]  18375.7712258        1
[INPUT] 0    0    [1    /1   ]  1443.55104076        1
[INPUT] 0    0    [1    /1   ]  417.364096417        1
[INPUT] 0    0    [1    /1   ]  147.790745226        1
[INPUT] 0    0    [1    /1   ]  58.4271890545        1
[INPUT] 0    0    [1    /1   ]  24.5944565164        1
[INPUT] 0    0    [1    /1   ]  7.85962613183        1
[INPUT] 1    0    [1    /1   ]  8.60328248227        1
[INPUT] 1    0    [1    /1   ]  0.492475043344       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.20617741957076935, 1.0]], [0, [0.5109639069243174, 1.0]], [0, [1.1953855503061779, 1.0]], [0, [117616.8128859186, 1.0]], [0, [3.2932154387262256, 1.0]], [0, [1176168.142613429, 1.0]], [0, [588084.0699564569, 1.0]], [0, [294042.03092087916, 1.0]], [0, [147020.99132111965, 1.0]], [0, [73510.4175392099, 1.0]], [0, [36754.70148826994, 1.0]], [0, [7302.318560431692, 1.0]], [0, [18375.771225818586, 1.0]], [0, [1443.5510407587128, 1.0]], [0, [417.3640964172872, 1.0]], [0, [147.79074522634852, 1.0]], [0, [58.427189054544726, 1.0]], [0, [24.594456516414425, 1.0]], [0, [7.859626131832013, 1.0]], [1, [8.603282482274006, 1.0]], [1, [0.4924750433439706, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.20617742]
bas 1, expnt(s) = [0.51096391]
bas 2, expnt(s) = [1.19538555]
bas 3, expnt(s) = [117616.81288592]
bas 4, expnt(s) = [3.29321544]
bas 5, expnt(s) = [1176168.14261343]
bas 6, expnt(s) = [588084.06995646]
bas 7, expnt(s) = [294042.03092088]
bas 8, expnt(s) = [147020.99132112]
bas 9, expnt(s) = [73510.41753921]
bas 10, expnt(s) = [36754.70148827]
bas 11, expnt(s) = [7302.31856043]
bas 12, expnt(s) = [18375.77122582]
bas 13, expnt(s) = [1443.55104076]
bas 14, expnt(s) = [417.36409642]
bas 15, expnt(s) = [147.79074523]
bas 16, expnt(s) = [58.42718905]
bas 17, expnt(s) = [24.59445652]
bas 18, expnt(s) = [7.85962613]
bas 19, expnt(s) = [8.60328248]
bas 20, expnt(s) = [0.49247504]
CPU time:       499.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.06177420e-01 7.73029111e-01 5.10963907e-01 1.52688979e+00
 1.19538555e+00 2.88832478e+00 1.17616813e+05 1.60460108e+04
 3.29321544e+00 6.17632487e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231856e+03 1.99577053e+03
 1.83757712e+04 3.98748632e+03 1.44355104e+03 5.91683056e+02
 4.17364096e+02 2.33292802e+02 1.47790745e+02 1.07090378e+02
 5.84271891e+01 5.33920098e+01 2.45944565e+01 2.79024891e+01
 7.85962613e+00 1.18595017e+01 8.60328248e+00 4.29847714e+01
 4.92475043e-01 1.20355149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336526414359607
cond(S) = 912333.6159331577
E1 = -689.5830538533695  E_coul = 184.95959305373262
init E= -504.623460799637
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672430241559894  LUMO = 0.3936611585593
  mo_energy =
[-1.21711371e+02 -1.33871203e+01 -7.62434137e+00 -7.62434137e+00
 -7.62434137e+00 -1.65793666e+00 -6.72430242e-01 -6.72430242e-01
 -6.72430242e-01  3.93661159e-01  3.28145405e+00  1.55755784e+01
  6.99024343e+01  2.63748994e+02  8.92009969e+02  3.14522790e+03
  1.26253443e+04  4.12223556e+04  1.05250471e+05  2.30423543e+05
  4.56231014e+05  8.45177597e+05  1.52834937e+06  2.85061000e+06
  5.80848860e+06]
E1 = -707.7386493005557  E_coul = 199.76631235427246
cycle= 1 E= -507.972336946283  delta_E= -3.35  |g|= 0.452  |ddm|= 0.472
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.746501
diis-c [-0.55726301  1.        ]
  HOMO = -0.218128876648956  LUMO = 0.702558121218397
  mo_energy =
[-1.20202120e+02 -1.23058005e+01 -6.59497870e+00 -6.59497870e+00
 -6.59497870e+00 -1.16378381e+00 -2.18128877e-01 -2.18128877e-01
 -2.18128877e-01  7.02558121e-01  3.81590364e+00  1.64635624e+01
  7.11666255e+01  2.65203158e+02  8.93501885e+02  3.14665996e+03
  1.26266698e+04  4.12236140e+04  1.05251692e+05  2.30424740e+05
  4.56232194e+05  8.45178763e+05  1.52835052e+06  2.85061114e+06
  5.80848973e+06]
E1 = -706.78173750641  E_coul = 198.79156444218856
cycle= 2 E= -507.990173064221  delta_E= -0.0178  |g|= 0.0352  |ddm|= 0.334
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0378342
diis-c [-0.00142211 -0.00411237  1.00411237]
  HOMO = -0.240414978345368  LUMO = 0.700341285513651
  mo_energy =
[-1.20317393e+02 -1.23738203e+01 -6.67027673e+00 -6.67027673e+00
 -6.67027673e+00 -1.17814225e+00 -2.40414978e-01 -2.40414978e-01
 -2.40414978e-01  7.00341286e-01  3.79548341e+00  1.64118409e+01
  7.10835011e+01  2.65098035e+02  8.93380868e+02  3.14652463e+03
  1.26265242e+04  4.12234645e+04  1.05251541e+05  2.30424588e+05
  4.56232041e+05  8.45178611e+05  1.52835037e+06  2.85061099e+06
  5.80848958e+06]
E1 = -706.6717548344069  E_coul = 198.68131282269727
cycle= 3 E= -507.99044201171  delta_E= -0.000269  |g|= 0.0044  |ddm|= 0.0568
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0044628
diis-c [-3.63449458e-06 -8.30194040e-05 -1.19311857e-01  1.11939488e+00]
  HOMO = -0.243645625088045  LUMO = 0.699819397136042
  mo_energy =
[-1.20329271e+02 -1.23825169e+01 -6.67945408e+00 -6.67945408e+00
 -6.67945408e+00 -1.18010524e+00 -2.43645625e-01 -2.43645625e-01
 -2.43645625e-01  6.99819397e-01  3.79224798e+00  1.64049007e+01
  7.10738028e+01  2.65086817e+02  8.93368752e+02  3.14651182e+03
  1.26265110e+04  4.12234511e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.6558252349367  E_coul = 198.6653777215438
cycle= 4 E= -507.990447513393  delta_E= -5.5e-06  |g|= 0.000227  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000174144
diis-c [-1.18177604e-09 -1.13320653e-05  7.39036494e-03 -9.15597615e-02
  1.08418073e+00]
  HOMO = -0.243768710701132  LUMO = 0.69978875516983
  mo_energy =
[-1.20329477e+02 -1.23827660e+01 -6.67969144e+00 -6.67969144e+00
 -6.67969144e+00 -1.18018041e+00 -2.43768711e-01 -2.43768711e-01
 -2.43768711e-01  6.99788755e-01  3.79210974e+00  1.64046808e+01
  7.10735741e+01  2.65086602e+02  8.93368548e+02  3.14651163e+03
  1.26265108e+04  4.12234509e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.655214464634  E_coul = 198.66476693702768
cycle= 5 E= -507.990447527606  delta_E= -1.42e-08  |g|= 1.02e-05  |ddm|= 0.000817
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=4.57271e-06
diis-c [-1.64227233e-12  8.04625566e-07 -8.07820079e-04  9.51568272e-03
 -1.22977760e-01  1.11426909e+00]
  HOMO = -0.243772424297328  LUMO = 0.699787831264679
  mo_energy =
[-1.20329484e+02 -1.23827722e+01 -6.67969772e+00 -6.67969772e+00
 -6.67969772e+00 -1.18018300e+00 -2.43772424e-01 -2.43772424e-01
 -2.43772424e-01  6.99787831e-01  3.79210531e+00  1.64046749e+01
  7.10735677e+01  2.65086596e+02  8.93368541e+02  3.14651162e+03
  1.26265108e+04  4.12234509e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.6551944575021  E_coul = 198.66474692987174
cycle= 6 E= -507.99044752763  delta_E= -2.41e-11  |g|= 7.51e-08  |ddm|= 4.03e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6551944575021  E_coul = 198.66474692987174
  HOMO = -0.243772457855484  LUMO = 0.699787806878779
  mo_energy =
[-1.20329484e+02 -1.23827723e+01 -6.67969778e+00 -6.67969778e+00
 -6.67969778e+00 -1.18018301e+00 -2.43772458e-01 -2.43772458e-01
 -2.43772458e-01  6.99787807e-01  3.79210526e+00  1.64046748e+01
  7.10735677e+01  2.65086596e+02  8.93368541e+02  3.14651162e+03
  1.26265108e+04  4.12234509e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.6551943287741  E_coul = 198.66474680114374
Extra cycle  E= -507.99044752763  delta_E= 5.68e-14  |g|= 8.37e-09  |ddm|= 1.99e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912333.6159331577
E1 = -706.6551943287741  E_coul = 198.66474680114374
init E= -507.99044752763
    CPU time for initialize scf      5.59 sec, wall time      0.24 sec
  HOMO = -0.243772462245225  LUMO = 0.699787806149945
  mo_energy =
[-1.20329484e+02 -1.23827723e+01 -6.67969779e+00 -6.67969779e+00
 -6.67969779e+00 -1.18018301e+00 -2.43772462e-01 -2.43772462e-01
 -2.43772462e-01  6.99787806e-01  3.79210526e+00  1.64046748e+01
  7.10735677e+01  2.65086596e+02  8.93368541e+02  3.14651162e+03
  1.26265108e+04  4.12234509e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.6551943079825  E_coul = 198.664746780352
cycle= 1 E= -507.99044752763  delta_E= -1.14e-13  |g|= 1.04e-09  |ddm|= 2.83e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6551943079825  E_coul = 198.664746780352
  HOMO = -0.24377246292977  LUMO = 0.699787804935138
  mo_energy =
[-1.20329484e+02 -1.23827723e+01 -6.67969779e+00 -6.67969779e+00
 -6.67969779e+00 -1.18018301e+00 -2.43772463e-01 -2.43772463e-01
 -2.43772463e-01  6.99787805e-01  3.79210526e+00  1.64046748e+01
  7.10735677e+01  2.65086596e+02  8.93368541e+02  3.14651162e+03
  1.26265108e+04  4.12234509e+04  1.05251528e+05  2.30424574e+05
  4.56232028e+05  8.45178597e+05  1.52835036e+06  2.85061098e+06
  5.80848957e+06]
E1 = -706.6551943077885  E_coul = 198.66474678015817
Extra cycle  E= -507.99044752763  delta_E= 1.14e-13  |g|= 1.57e-09  |ddm|= 1.22e-09
    CPU time for scf_cycle      6.10 sec, wall time      0.40 sec
exp = [2.06177420e-01 5.10963907e-01 1.19538555e+00 1.17616813e+05
 3.29321544e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231856e+03
 1.83757712e+04 1.44355104e+03 4.17364096e+02 1.47790745e+02
 5.84271891e+01 2.45944565e+01 7.85962613e+00 8.60328248e+00
 4.92475043e-01]
grad_E = [-7.16326230e-04  5.10553572e-04  1.21554020e-04  6.06217315e-09
 -7.31605190e-04  4.04389724e-11  1.74152066e-10  9.40288987e-10
  3.71509060e-09  1.55135779e-08  8.09199607e-08  5.10040537e-06
  1.98366098e-07 -3.84164957e-05 -6.57769682e-06  4.47541823e-06
 -8.44535277e-06 -2.92153016e-05 -1.11053805e-04 -6.04767544e-04
 -9.07093733e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.216365375827       1
[INPUT] 0    0    [1    /1   ]  0.545496684197       1
[INPUT] 0    0    [1    /1   ]  1.3457172132         1
[INPUT] 0    0    [1    /1   ]  117616.812885        1
[INPUT] 0    0    [1    /1   ]  3.37303944822        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.99132         1
[INPUT] 0    0    [1    /1   ]  73510.417536         1
[INPUT] 0    0    [1    /1   ]  36754.7014713        1
[INPUT] 0    0    [1    /1   ]  7302.31748994        1
[INPUT] 0    0    [1    /1   ]  18375.7711842        1
[INPUT] 0    0    [1    /1   ]  1443.55916727        1
[INPUT] 0    0    [1    /1   ]  417.364757634        1
[INPUT] 0    0    [1    /1   ]  147.793084966        1
[INPUT] 0    0    [1    /1   ]  58.4182051167        1
[INPUT] 0    0    [1    /1   ]  24.6075323203        1
[INPUT] 0    0    [1    /1   ]  7.96112977224        1
[INPUT] 1    0    [1    /1   ]  8.60345940765        1
[INPUT] 1    0    [1    /1   ]  0.49257148014        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21636537582716497, 1.0]], [0, [0.5454966841966191, 1.0]], [0, [1.345717213203145, 1.0]], [0, [117616.81288464615, 1.0]], [0, [3.3730394482248443, 1.0]], [0, [1176168.1426134205, 1.0]], [0, [588084.0699564203, 1.0]], [0, [294042.0309206818, 1.0]], [0, [147020.99132033985, 1.0]], [0, [73510.41753595346, 1.0]], [0, [36754.70147128648, 1.0]], [0, [7302.3174899417545, 1.0]], [0, [18375.771184161393, 1.0]], [0, [1443.5591672734247, 1.0]], [0, [417.36475763403945, 1.0]], [0, [147.79308496563698, 1.0]], [0, [58.418205116668595, 1.0]], [0, [24.607532320294556, 1.0]], [0, [7.961129772244615, 1.0]], [1, [8.603459407654157, 1.0]], [1, [0.49257148014020663, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21636538]
bas 1, expnt(s) = [0.54549668]
bas 2, expnt(s) = [1.34571721]
bas 3, expnt(s) = [117616.81288465]
bas 4, expnt(s) = [3.37303945]
bas 5, expnt(s) = [1176168.14261342]
bas 6, expnt(s) = [588084.06995642]
bas 7, expnt(s) = [294042.03092068]
bas 8, expnt(s) = [147020.99132034]
bas 9, expnt(s) = [73510.41753595]
bas 10, expnt(s) = [36754.70147129]
bas 11, expnt(s) = [7302.31748994]
bas 12, expnt(s) = [18375.77118416]
bas 13, expnt(s) = [1443.55916727]
bas 14, expnt(s) = [417.36475763]
bas 15, expnt(s) = [147.79308497]
bas 16, expnt(s) = [58.41820512]
bas 17, expnt(s) = [24.60753232]
bas 18, expnt(s) = [7.96112977]
bas 19, expnt(s) = [8.60345941]
bas 20, expnt(s) = [0.49257148]
CPU time:       514.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.16365376e-01 8.01504282e-01 5.45496684e-01 1.60364823e+00
 1.34571721e+00 3.15667870e+00 1.17616813e+05 1.60460108e+04
 3.37303945e+00 6.28826868e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231749e+03 1.99577031e+03
 1.83757712e+04 3.98748631e+03 1.44355917e+03 5.91685554e+02
 4.17364758e+02 2.33293079e+02 1.47793085e+02 1.07091650e+02
 5.84182051e+01 5.33858524e+01 2.46075323e+01 2.79136142e+01
 7.96112977e+00 1.19741874e+01 8.60345941e+00 4.29858763e+01
 4.92571480e-01 1.20384610e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33637563410461
cond(S) = 912383.0534393189
E1 = -689.5876737192132  E_coul = 184.9633004209162
init E= -504.624373298297
    CPU time for initialize scf      7.55 sec, wall time      0.37 sec
  HOMO = -0.672322138860537  LUMO = 0.446687346283515
  mo_energy =
[-1.21710948e+02 -1.33868463e+01 -7.62411547e+00 -7.62411547e+00
 -7.62411547e+00 -1.65782917e+00 -6.72322139e-01 -6.72322139e-01
 -6.72322139e-01  4.46687346e-01  3.68426789e+00  1.66624865e+01
  7.14580985e+01  2.65306561e+02  8.93431824e+02  3.14651160e+03
  1.26264927e+04  4.12234249e+04  1.05251497e+05  2.30424540e+05
  4.56231991e+05  8.45178558e+05  1.52835031e+06  2.85061092e+06
  5.80848950e+06]
E1 = -707.7439985380284  E_coul = 199.77163512734293
cycle= 1 E= -507.972363410685  delta_E= -3.35  |g|= 0.452  |ddm|= 0.479
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.750052
diis-c [-0.56257767  1.        ]
  HOMO = -0.217934809209159  LUMO = 0.768527812030605
  mo_energy =
[-1.20201565e+02 -1.23054217e+01 -6.59465418e+00 -6.59465418e+00
 -6.59465418e+00 -1.16362887e+00 -2.17934809e-01 -2.17934809e-01
 -2.17934809e-01  7.68527812e-01  4.24023830e+00  1.75590376e+01
  7.27220827e+01  2.66760361e+02  8.94923732e+02  3.14794377e+03
  1.26278183e+04  4.12246834e+04  1.05252719e+05  2.30425737e+05
  4.56233171e+05  8.45179724e+05  1.52835147e+06  2.85061207e+06
  5.80849063e+06]
E1 = -706.7873425016872  E_coul = 198.7971398099701
cycle= 2 E= -507.990202691717  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.354
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0369586
diis-c [-0.00135785 -0.0038104   1.0038104 ]
  HOMO = -0.240198836221635  LUMO = 0.765860520064396
  mo_energy =
[-1.20316794e+02 -1.23734056e+01 -6.66991526e+00 -6.66991526e+00
 -6.66991526e+00 -1.17796704e+00 -2.40198836e-01 -2.40198836e-01
 -2.40198836e-01  7.65860520e-01  4.21786012e+00  1.75064019e+01
  7.26389199e+01  2.66655312e+02  8.94802775e+02  3.14780849e+03
  1.26276728e+04  4.12245340e+04  1.05252568e+05  2.30425585e+05
  4.56233018e+05  8.45179571e+05  1.52835131e+06  2.85061192e+06
  5.80849048e+06]
E1 = -706.6778970270688  E_coul = 198.68742783768627
cycle= 3 E= -507.990469189382  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0591
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00426437
diis-c [-3.52929628e-06 -1.08420578e-05 -1.15688285e-01  1.11569913e+00]
  HOMO = -0.243400202988023  LUMO = 0.765266612337428
  mo_energy =
[-1.20328611e+02 -1.23820463e+01 -6.67903633e+00 -6.67903633e+00
 -6.67903633e+00 -1.17991041e+00 -2.43400203e-01 -2.43400203e-01
 -2.43400203e-01  7.65266612e-01  4.21439133e+00  1.74994140e+01
  7.26292732e+01  2.66644156e+02  8.94790720e+02  3.14779574e+03
  1.26276596e+04  4.12245206e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6622090151976  E_coul = 198.671734499615
cycle= 4 E= -507.990474515583  delta_E= -5.33e-06  |g|= 0.000225  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172036
diis-c [-9.18810643e-10 -1.06367690e-05  7.15044652e-03 -9.22442187e-02
  1.08510441e+00]
  HOMO = -0.243529774241018  LUMO = 0.765232178522595
  mo_energy =
[-1.20328855e+02 -1.23823189e+01 -6.67929944e+00 -6.67929944e+00
 -6.67929944e+00 -1.17998934e+00 -2.43529774e-01 -2.43529774e-01
 -2.43529774e-01  7.65232179e-01  4.21423860e+00  1.74991750e+01
  7.26290165e+01  2.66643907e+02  8.94790478e+02  3.14779551e+03
  1.26276594e+04  4.12245204e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6615746771549  E_coul = 198.67110014786178
cycle= 5 E= -507.990474529293  delta_E= -1.37e-08  |g|= 8.77e-06  |ddm|= 0.000768
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85374e-06
diis-c [-1.39509245e-12  7.37384361e-07 -7.27395477e-04  8.92356495e-03
 -1.13739023e-01  1.10554212e+00]
  HOMO = -0.24353325740035  LUMO = 0.765231264008041
  mo_energy =
[-1.20328862e+02 -1.23823251e+01 -6.67930567e+00 -6.67930567e+00
 -6.67930567e+00 -1.17999175e+00 -2.43533257e-01 -2.43533257e-01
 -2.43533257e-01  7.65231264e-01  4.21423430e+00  1.74991693e+01
  7.26290102e+01  2.66643900e+02  8.94790471e+02  3.14779550e+03
  1.26276594e+04  4.12245204e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6615564424911  E_coul = 198.6710819131807
cycle= 6 E= -507.99047452931  delta_E= -1.73e-11  |g|= 8.47e-08  |ddm|= 3.24e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6615564424911  E_coul = 198.6710819131807
  HOMO = -0.243533294879455  LUMO = 0.765231238493862
  mo_energy =
[-1.20328862e+02 -1.23823251e+01 -6.67930574e+00 -6.67930574e+00
 -6.67930574e+00 -1.17999176e+00 -2.43533295e-01 -2.43533295e-01
 -2.43533295e-01  7.65231238e-01  4.21423425e+00  1.74991692e+01
  7.26290101e+01  2.66643900e+02  8.94790471e+02  3.14779550e+03
  1.26276594e+04  4.12245204e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6615562883172  E_coul = 198.67108175900685
Extra cycle  E= -507.99047452931  delta_E=    0  |g|= 1.12e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      8.37 sec, wall time      0.59 sec
exp = [2.16365376e-01 5.45496684e-01 1.34571721e+00 1.17616813e+05
 3.37303945e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231749e+03
 1.83757712e+04 1.44355917e+03 4.17364758e+02 1.47793085e+02
 5.84182051e+01 2.46075323e+01 7.96112977e+00 8.60345941e+00
 4.92571480e-01]
E = -507.9904745293104
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:28 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.216365375827       1
[INPUT] 0    0    [1    /1   ]  0.545496684197       1
[INPUT] 0    0    [1    /1   ]  1.3457172132         1
[INPUT] 0    0    [1    /1   ]  117616.812885        1
[INPUT] 0    0    [1    /1   ]  3.37303944822        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.99132         1
[INPUT] 0    0    [1    /1   ]  73510.417536         1
[INPUT] 0    0    [1    /1   ]  36754.7014713        1
[INPUT] 0    0    [1    /1   ]  7302.31748994        1
[INPUT] 0    0    [1    /1   ]  18375.7711842        1
[INPUT] 0    0    [1    /1   ]  1443.55916727        1
[INPUT] 0    0    [1    /1   ]  417.364757634        1
[INPUT] 0    0    [1    /1   ]  147.793084966        1
[INPUT] 0    0    [1    /1   ]  58.4182051167        1
[INPUT] 0    0    [1    /1   ]  24.6075323203        1
[INPUT] 0    0    [1    /1   ]  7.96112977224        1
[INPUT] 1    0    [1    /1   ]  8.60345940765        1
[INPUT] 1    0    [1    /1   ]  0.49257148014        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21636537582716497, 1.0]], [0, [0.5454966841966191, 1.0]], [0, [1.345717213203145, 1.0]], [0, [117616.81288464615, 1.0]], [0, [3.3730394482248443, 1.0]], [0, [1176168.1426134205, 1.0]], [0, [588084.0699564203, 1.0]], [0, [294042.0309206818, 1.0]], [0, [147020.99132033985, 1.0]], [0, [73510.41753595346, 1.0]], [0, [36754.70147128648, 1.0]], [0, [7302.3174899417545, 1.0]], [0, [18375.771184161393, 1.0]], [0, [1443.5591672734247, 1.0]], [0, [417.36475763403945, 1.0]], [0, [147.79308496563698, 1.0]], [0, [58.418205116668595, 1.0]], [0, [24.607532320294556, 1.0]], [0, [7.961129772244615, 1.0]], [1, [8.603459407654157, 1.0]], [1, [0.49257148014020663, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21636538]
bas 1, expnt(s) = [0.54549668]
bas 2, expnt(s) = [1.34571721]
bas 3, expnt(s) = [117616.81288465]
bas 4, expnt(s) = [3.37303945]
bas 5, expnt(s) = [1176168.14261342]
bas 6, expnt(s) = [588084.06995642]
bas 7, expnt(s) = [294042.03092068]
bas 8, expnt(s) = [147020.99132034]
bas 9, expnt(s) = [73510.41753595]
bas 10, expnt(s) = [36754.70147129]
bas 11, expnt(s) = [7302.31748994]
bas 12, expnt(s) = [18375.77118416]
bas 13, expnt(s) = [1443.55916727]
bas 14, expnt(s) = [417.36475763]
bas 15, expnt(s) = [147.79308497]
bas 16, expnt(s) = [58.41820512]
bas 17, expnt(s) = [24.60753232]
bas 18, expnt(s) = [7.96112977]
bas 19, expnt(s) = [8.60345941]
bas 20, expnt(s) = [0.49257148]
CPU time:       522.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.16365376e-01 8.01504282e-01 5.45496684e-01 1.60364823e+00
 1.34571721e+00 3.15667870e+00 1.17616813e+05 1.60460108e+04
 3.37303945e+00 6.28826868e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231749e+03 1.99577031e+03
 1.83757712e+04 3.98748631e+03 1.44355917e+03 5.91685554e+02
 4.17364758e+02 2.33293079e+02 1.47793085e+02 1.07091650e+02
 5.84182051e+01 5.33858524e+01 2.46075323e+01 2.79136142e+01
 7.96112977e+00 1.19741874e+01 8.60345941e+00 4.29858763e+01
 4.92571480e-01 1.20384610e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33637563410461
cond(S) = 912383.0534393189
E1 = -689.5876737192132  E_coul = 184.9633004209162
init E= -504.624373298297
    CPU time for initialize scf      7.59 sec, wall time      0.37 sec
  HOMO = -0.672322138860537  LUMO = 0.446687346283515
  mo_energy =
[-1.21710948e+02 -1.33868463e+01 -7.62411547e+00 -7.62411547e+00
 -7.62411547e+00 -1.65782917e+00 -6.72322139e-01 -6.72322139e-01
 -6.72322139e-01  4.46687346e-01  3.68426789e+00  1.66624865e+01
  7.14580985e+01  2.65306561e+02  8.93431824e+02  3.14651160e+03
  1.26264927e+04  4.12234249e+04  1.05251497e+05  2.30424540e+05
  4.56231991e+05  8.45178558e+05  1.52835031e+06  2.85061092e+06
  5.80848950e+06]
E1 = -707.7439985380284  E_coul = 199.77163512734293
cycle= 1 E= -507.972363410685  delta_E= -3.35  |g|= 0.452  |ddm|= 0.479
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.750052
diis-c [-0.56257767  1.        ]
  HOMO = -0.217934809209159  LUMO = 0.768527812030605
  mo_energy =
[-1.20201565e+02 -1.23054217e+01 -6.59465418e+00 -6.59465418e+00
 -6.59465418e+00 -1.16362887e+00 -2.17934809e-01 -2.17934809e-01
 -2.17934809e-01  7.68527812e-01  4.24023830e+00  1.75590376e+01
  7.27220827e+01  2.66760361e+02  8.94923732e+02  3.14794377e+03
  1.26278183e+04  4.12246834e+04  1.05252719e+05  2.30425737e+05
  4.56233171e+05  8.45179724e+05  1.52835147e+06  2.85061207e+06
  5.80849063e+06]
E1 = -706.7873425016872  E_coul = 198.7971398099701
cycle= 2 E= -507.990202691717  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.354
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0369586
diis-c [-0.00135785 -0.0038104   1.0038104 ]
  HOMO = -0.240198836221635  LUMO = 0.765860520064396
  mo_energy =
[-1.20316794e+02 -1.23734056e+01 -6.66991526e+00 -6.66991526e+00
 -6.66991526e+00 -1.17796704e+00 -2.40198836e-01 -2.40198836e-01
 -2.40198836e-01  7.65860520e-01  4.21786012e+00  1.75064019e+01
  7.26389199e+01  2.66655312e+02  8.94802775e+02  3.14780849e+03
  1.26276728e+04  4.12245340e+04  1.05252568e+05  2.30425585e+05
  4.56233018e+05  8.45179571e+05  1.52835131e+06  2.85061192e+06
  5.80849048e+06]
E1 = -706.6778970270688  E_coul = 198.68742783768627
cycle= 3 E= -507.990469189382  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0591
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00426437
diis-c [-3.52929628e-06 -1.08420578e-05 -1.15688285e-01  1.11569913e+00]
  HOMO = -0.243400202988023  LUMO = 0.765266612337428
  mo_energy =
[-1.20328611e+02 -1.23820463e+01 -6.67903633e+00 -6.67903633e+00
 -6.67903633e+00 -1.17991041e+00 -2.43400203e-01 -2.43400203e-01
 -2.43400203e-01  7.65266612e-01  4.21439133e+00  1.74994140e+01
  7.26292732e+01  2.66644156e+02  8.94790720e+02  3.14779574e+03
  1.26276596e+04  4.12245206e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6622090151976  E_coul = 198.671734499615
cycle= 4 E= -507.990474515583  delta_E= -5.33e-06  |g|= 0.000225  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172036
diis-c [-9.18810643e-10 -1.06367690e-05  7.15044652e-03 -9.22442187e-02
  1.08510441e+00]
  HOMO = -0.243529774241018  LUMO = 0.765232178522595
  mo_energy =
[-1.20328855e+02 -1.23823189e+01 -6.67929944e+00 -6.67929944e+00
 -6.67929944e+00 -1.17998934e+00 -2.43529774e-01 -2.43529774e-01
 -2.43529774e-01  7.65232179e-01  4.21423860e+00  1.74991750e+01
  7.26290165e+01  2.66643907e+02  8.94790478e+02  3.14779551e+03
  1.26276594e+04  4.12245204e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6615746771549  E_coul = 198.67110014786178
cycle= 5 E= -507.990474529293  delta_E= -1.37e-08  |g|= 8.77e-06  |ddm|= 0.000768
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.85374e-06
diis-c [-1.39509245e-12  7.37384361e-07 -7.27395477e-04  8.92356495e-03
 -1.13739023e-01  1.10554212e+00]
  HOMO = -0.24353325740035  LUMO = 0.765231264008041
  mo_energy =
[-1.20328862e+02 -1.23823251e+01 -6.67930567e+00 -6.67930567e+00
 -6.67930567e+00 -1.17999175e+00 -2.43533257e-01 -2.43533257e-01
 -2.43533257e-01  7.65231264e-01  4.21423430e+00  1.74991693e+01
  7.26290102e+01  2.66643900e+02  8.94790471e+02  3.14779550e+03
  1.26276594e+04  4.12245204e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6615564424911  E_coul = 198.6710819131807
cycle= 6 E= -507.99047452931  delta_E= -1.73e-11  |g|= 8.47e-08  |ddm|= 3.24e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6615564424911  E_coul = 198.6710819131807
  HOMO = -0.243533294879455  LUMO = 0.765231238493862
  mo_energy =
[-1.20328862e+02 -1.23823251e+01 -6.67930574e+00 -6.67930574e+00
 -6.67930574e+00 -1.17999176e+00 -2.43533295e-01 -2.43533295e-01
 -2.43533295e-01  7.65231238e-01  4.21423425e+00  1.74991692e+01
  7.26290101e+01  2.66643900e+02  8.94790471e+02  3.14779550e+03
  1.26276594e+04  4.12245204e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6615562883172  E_coul = 198.67108175900685
Extra cycle  E= -507.99047452931  delta_E=    0  |g|= 1.12e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      8.45 sec, wall time      0.58 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912383.0534393189
E1 = -706.6615562883172  E_coul = 198.67108175900685
init E= -507.99047452931
    CPU time for initialize scf     17.14 sec, wall time      0.75 sec
  HOMO = -0.243533300058315  LUMO = 0.765231237444167
  mo_energy =
[-1.20328862e+02 -1.23823252e+01 -6.67930575e+00 -6.67930575e+00
 -6.67930575e+00 -1.17999177e+00 -2.43533300e-01 -2.43533300e-01
 -2.43533300e-01  7.65231237e-01  4.21423425e+00  1.74991692e+01
  7.26290101e+01  2.66643900e+02  8.94790471e+02  3.14779550e+03
  1.26276594e+04  4.12245204e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6615562644357  E_coul = 198.67108173512528
cycle= 1 E= -507.99047452931  delta_E=    0  |g|= 2.57e-09  |ddm|= 3.19e-08
    CPU time for cycle= 1      0.33 sec, wall time      0.03 sec
E1 = -706.6615562644357  E_coul = 198.67108173512528
  HOMO = -0.243533300844521  LUMO = 0.765231238698927
  mo_energy =
[-1.20328862e+02 -1.23823252e+01 -6.67930575e+00 -6.67930575e+00
 -6.67930575e+00 -1.17999177e+00 -2.43533301e-01 -2.43533301e-01
 -2.43533301e-01  7.65231239e-01  4.21423424e+00  1.74991692e+01
  7.26290101e+01  2.66643900e+02  8.94790471e+02  3.14779550e+03
  1.26276594e+04  4.12245204e+04  1.05252554e+05  2.30425572e+05
  4.56233005e+05  8.45179558e+05  1.52835130e+06  2.85061190e+06
  5.80849047e+06]
E1 = -706.6615562580154  E_coul = 198.67108172870468
Extra cycle  E= -507.990474529311  delta_E= -2.84e-13  |g|= 1.57e-09  |ddm|= 6.53e-09
    CPU time for scf_cycle     17.63 sec, wall time      0.92 sec
exp = [2.16365376e-01 5.45496684e-01 1.34571721e+00 1.17616813e+05
 3.37303945e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231749e+03
 1.83757712e+04 1.44355917e+03 4.17364758e+02 1.47793085e+02
 5.84182051e+01 2.46075323e+01 7.96112977e+00 8.60345941e+00
 4.92571480e-01]
grad_E = [-1.34849176e-03  1.28128208e-03  2.02006985e-04  6.05847580e-09
 -8.19497128e-04  4.03975764e-11  1.74030748e-10  9.39722185e-10
  3.71280036e-09  1.55038871e-08  8.08732300e-08  5.09742969e-06
  1.98212794e-07 -3.82924504e-05 -7.69757513e-06  9.45276247e-06
 -2.31385632e-05 -2.08186056e-05 -4.58692839e-05 -5.47301151e-04
 -5.58316055e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.218497455296       1
[INPUT] 0    0    [1    /1   ]  0.552255502155       1
[INPUT] 0    0    [1    /1   ]  1.42698088302        1
[INPUT] 0    0    [1    /1   ]  117616.812884        1
[INPUT] 0    0    [1    /1   ]  3.43086932602        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.99132         1
[INPUT] 0    0    [1    /1   ]  73510.417534         1
[INPUT] 0    0    [1    /1   ]  36754.7014608        1
[INPUT] 0    0    [1    /1   ]  7302.31683192        1
[INPUT] 0    0    [1    /1   ]  18375.7711586        1
[INPUT] 0    0    [1    /1   ]  1443.5641619         1
[INPUT] 0    0    [1    /1   ]  417.365171478        1
[INPUT] 0    0    [1    /1   ]  147.794494188        1
[INPUT] 0    0    [1    /1   ]  58.4127738087        1
[INPUT] 0    0    [1    /1   ]  24.6156043271        1
[INPUT] 0    0    [1    /1   ]  8.02171170139        1
[INPUT] 1    0    [1    /1   ]  8.60421503691        1
[INPUT] 1    0    [1    /1   ]  0.49278109132        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21849745529640374, 1.0]], [0, [0.5522555021549879, 1.0]], [0, [1.4269808830228357, 1.0]], [0, [117616.81288386398, 1.0]], [0, [3.4308693260203946, 1.0]], [0, [1176168.1426134154, 1.0]], [0, [588084.0699563979, 1.0]], [0, [294042.0309205605, 1.0]], [0, [147020.9913198605, 1.0]], [0, [73510.41753395175, 1.0]], [0, [36754.701460846874, 1.0]], [0, [7302.316831919852, 1.0]], [0, [18375.771158555326, 1.0]], [0, [1443.5641619033704, 1.0]], [0, [417.3651714776033, 1.0]], [0, [147.79449418764062, 1.0]], [0, [58.41277380871395, 1.0]], [0, [24.61560432712043, 1.0]], [0, [8.021711701389783, 1.0]], [1, [8.604215036911725, 1.0]], [1, [0.4927810913203199, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21849746]
bas 1, expnt(s) = [0.5522555]
bas 2, expnt(s) = [1.42698088]
bas 3, expnt(s) = [117616.81288386]
bas 4, expnt(s) = [3.43086933]
bas 5, expnt(s) = [1176168.14261342]
bas 6, expnt(s) = [588084.0699564]
bas 7, expnt(s) = [294042.03092056]
bas 8, expnt(s) = [147020.99131986]
bas 9, expnt(s) = [73510.41753395]
bas 10, expnt(s) = [36754.70146085]
bas 11, expnt(s) = [7302.31683192]
bas 12, expnt(s) = [18375.77115856]
bas 13, expnt(s) = [1443.5641619]
bas 14, expnt(s) = [417.36517148]
bas 15, expnt(s) = [147.79449419]
bas 16, expnt(s) = [58.41277381]
bas 17, expnt(s) = [24.61560433]
bas 18, expnt(s) = [8.0217117]
bas 19, expnt(s) = [8.60421504]
bas 20, expnt(s) = [0.49278109]
CPU time:       555.59
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.18497455e-01 8.07420574e-01 5.52255502e-01 1.61852743e+00
 1.42698088e+00 3.29859230e+00 1.17616813e+05 1.60460108e+04
 3.43086933e+00 6.36895466e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231683e+03 1.99577018e+03
 1.83757712e+04 3.98748631e+03 1.44356416e+03 5.91687089e+02
 4.17365171e+02 2.33293253e+02 1.47794494e+02 1.07092416e+02
 5.84127738e+01 5.33821298e+01 2.46156043e+01 2.79204813e+01
 8.02171170e+00 1.20424627e+01 8.60421504e+00 4.29905956e+01
 4.92781091e-01 1.20448650e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608569496394
cond(S) = 912408.3614273609
E1 = -689.5980433550124  E_coul = 184.97318355773646
init E= -504.624859797276
    CPU time for initialize scf      7.63 sec, wall time      0.37 sec
  HOMO = -0.672090928003795  LUMO = 0.460519394728371
  mo_energy =
[-1.21709670e+02 -1.33860501e+01 -7.62348851e+00 -7.62348851e+00
 -7.62348851e+00 -1.65761909e+00 -6.72090928e-01 -6.72090928e-01
 -6.72090928e-01  4.60519395e-01  3.85131769e+00  1.72132653e+01
  7.23113037e+01  2.66177926e+02  8.94230983e+02  3.14723455e+03
  1.26271406e+04  4.12240286e+04  1.05252076e+05  2.30425103e+05
  4.56232542e+05  8.45179100e+05  1.52835085e+06  2.85061145e+06
  5.80849001e+06]
E1 = -707.7581373756253  E_coul = 199.78575305942047
cycle= 1 E= -507.972384316205  delta_E= -3.35  |g|= 0.452  |ddm|= 0.485
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.752092
diis-c [-0.56564196  1.        ]
  HOMO = -0.217470226476417  LUMO = 0.786327254306326
  mo_energy =
[-1.20199986e+02 -1.23043616e+01 -6.59377093e+00 -6.59377093e+00
 -6.59377093e+00 -1.16326496e+00 -2.17470226e-01 -2.17470226e-01
 -2.17470226e-01  7.86327254e-01  4.41744272e+00  1.81153145e+01
  7.35756235e+01  2.67631778e+02  8.95723116e+02  3.14866699e+03
  1.26284666e+04  4.12252874e+04  1.05253298e+05  2.30426301e+05
  4.56233722e+05  8.45180267e+05  1.52835200e+06  2.85061259e+06
  5.80849114e+06]
E1 = -706.8015694435595  E_coul = 198.81134318948344
cycle= 2 E= -507.990226254076  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.363
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0365831
diis-c [-0.00133055 -0.00372554  1.00372554]
  HOMO = -0.239727296433715  LUMO = 0.783509664352801
  mo_energy =
[-1.20315207e+02 -1.23723340e+01 -6.66902065e+00 -6.66902065e+00
 -6.66902065e+00 -1.17759282e+00 -2.39727296e-01 -2.39727296e-01
 -2.39727296e-01  7.83509664e-01  4.39421142e+00  1.80621596e+01
  7.34924142e+01  2.67526753e+02  8.95602175e+02  3.14853172e+03
  1.26283211e+04  4.12251380e+04  1.05253147e+05  2.30426149e+05
  4.56233570e+05  8.45180114e+05  1.52835185e+06  2.85061244e+06
  5.80849099e+06]
E1 = -706.6922280102746  E_coul = 198.7017356657207
cycle= 3 E= -507.990492344554  delta_E= -0.000266  |g|= 0.00437  |ddm|= 0.0598
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00418187
diis-c [-3.49670558e-06  2.01003420e-05 -1.14112203e-01  1.11409210e+00]
  HOMO = -0.242920334127837  LUMO = 0.782891961456399
  mo_energy =
[-1.20327005e+02 -1.23809575e+01 -6.67812424e+00 -6.67812424e+00
 -6.67812424e+00 -1.17953011e+00 -2.42920334e-01 -2.42920334e-01
 -2.42920334e-01  7.82891961e-01  4.39063620e+00  1.80551319e+01
  7.34827808e+01  2.67515617e+02  8.95590140e+02  3.14851899e+03
  1.26283079e+04  4.12251247e+04  1.05253134e+05  2.30426135e+05
  4.56233557e+05  8.45180101e+05  1.52835184e+06  2.85061243e+06
  5.80849098e+06]
E1 = -706.6765972584323  E_coul = 198.68609962069362
cycle= 4 E= -507.990497637739  delta_E= -5.29e-06  |g|= 0.000228  |ddm|= 0.0111
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172845
diis-c [-8.62777471e-10 -1.03885540e-05  7.08714833e-03 -9.32289768e-02
  1.08615222e+00]
  HOMO = -0.243054138610232  LUMO = 0.782855827678674
  mo_energy =
[-1.20327268e+02 -1.23812433e+01 -6.67840144e+00 -6.67840144e+00
 -6.67840144e+00 -1.17961155e+00 -2.43054139e-01 -2.43054139e-01
 -2.43054139e-01  7.82855828e-01  4.39047494e+00  1.80548815e+01
  7.34825090e+01  2.67515349e+02  8.95589878e+02  3.14851873e+03
  1.26283076e+04  4.12251244e+04  1.05253134e+05  2.30426135e+05
  4.56233556e+05  8.45180101e+05  1.52835184e+06  2.85061242e+06
  5.80849098e+06]
E1 = -706.6759436597542  E_coul = 198.68544600803878
cycle= 5 E= -507.990497651715  delta_E= -1.4e-08  |g|= 8.36e-06  |ddm|= 0.000754
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.66522e-06
diis-c [-1.32112463e-12  7.14210160e-07 -7.00067185e-04  8.76065315e-03
 -1.10489232e-01  1.10242793e+00]
  HOMO = -0.243057564184362  LUMO = 0.782854919445676
  mo_energy =
[-1.20327275e+02 -1.23812494e+01 -6.67840769e+00 -6.67840769e+00
 -6.67840769e+00 -1.17961392e+00 -2.43057564e-01 -2.43057564e-01
 -2.43057564e-01  7.82854919e-01  4.39047065e+00  1.80548758e+01
  7.34825026e+01  2.67515343e+02  8.95589871e+02  3.14851873e+03
  1.26283076e+04  4.12251244e+04  1.05253134e+05  2.30426135e+05
  4.56233556e+05  8.45180101e+05  1.52835184e+06  2.85061242e+06
  5.80849098e+06]
E1 = -706.6759258262813  E_coul = 198.68542817455014
cycle= 6 E= -507.990497651731  delta_E= -1.57e-11  |g|= 8.62e-08  |ddm|= 2.97e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759258262813  E_coul = 198.68542817455014
  HOMO = -0.243057603206831  LUMO = 0.782854892752228
  mo_energy =
[-1.20327275e+02 -1.23812495e+01 -6.67840777e+00 -6.67840777e+00
 -6.67840777e+00 -1.17961393e+00 -2.43057603e-01 -2.43057603e-01
 -2.43057603e-01  7.82854893e-01  4.39047059e+00  1.80548757e+01
  7.34825025e+01  2.67515343e+02  8.95589871e+02  3.14851873e+03
  1.26283076e+04  4.12251244e+04  1.05253134e+05  2.30426135e+05
  4.56233556e+05  8.45180101e+05  1.52835184e+06  2.85061242e+06
  5.80849098e+06]
E1 = -706.6759256678911  E_coul = 198.68542801615945
Extra cycle  E= -507.990497651732  delta_E= -4.55e-13  |g|= 1.17e-08  |ddm|= 2.25e-07
    CPU time for scf_cycle      8.47 sec, wall time      0.59 sec
exp = [2.18497455e-01 5.52255502e-01 1.42698088e+00 1.17616813e+05
 3.43086933e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231683e+03
 1.83757712e+04 1.44356416e+03 4.17365171e+02 1.47794494e+02
 5.84127738e+01 2.46156043e+01 8.02171170e+00 8.60421504e+00
 4.92781091e-01]
E = -507.99049765173163
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:36 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.218497455296       1
[INPUT] 0    0    [1    /1   ]  0.552255502155       1
[INPUT] 0    0    [1    /1   ]  1.42698088302        1
[INPUT] 0    0    [1    /1   ]  117616.812884        1
[INPUT] 0    0    [1    /1   ]  3.43086932602        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030921        1
[INPUT] 0    0    [1    /1   ]  147020.99132         1
[INPUT] 0    0    [1    /1   ]  73510.417534         1
[INPUT] 0    0    [1    /1   ]  36754.7014608        1
[INPUT] 0    0    [1    /1   ]  7302.31683192        1
[INPUT] 0    0    [1    /1   ]  18375.7711586        1
[INPUT] 0    0    [1    /1   ]  1443.5641619         1
[INPUT] 0    0    [1    /1   ]  417.365171478        1
[INPUT] 0    0    [1    /1   ]  147.794494188        1
[INPUT] 0    0    [1    /1   ]  58.4127738087        1
[INPUT] 0    0    [1    /1   ]  24.6156043271        1
[INPUT] 0    0    [1    /1   ]  8.02171170139        1
[INPUT] 1    0    [1    /1   ]  8.60421503691        1
[INPUT] 1    0    [1    /1   ]  0.49278109132        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21849745529640374, 1.0]], [0, [0.5522555021549879, 1.0]], [0, [1.4269808830228357, 1.0]], [0, [117616.81288386398, 1.0]], [0, [3.4308693260203946, 1.0]], [0, [1176168.1426134154, 1.0]], [0, [588084.0699563979, 1.0]], [0, [294042.0309205605, 1.0]], [0, [147020.9913198605, 1.0]], [0, [73510.41753395175, 1.0]], [0, [36754.701460846874, 1.0]], [0, [7302.316831919852, 1.0]], [0, [18375.771158555326, 1.0]], [0, [1443.5641619033704, 1.0]], [0, [417.3651714776033, 1.0]], [0, [147.79449418764062, 1.0]], [0, [58.41277380871395, 1.0]], [0, [24.61560432712043, 1.0]], [0, [8.021711701389783, 1.0]], [1, [8.604215036911725, 1.0]], [1, [0.4927810913203199, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21849746]
bas 1, expnt(s) = [0.5522555]
bas 2, expnt(s) = [1.42698088]
bas 3, expnt(s) = [117616.81288386]
bas 4, expnt(s) = [3.43086933]
bas 5, expnt(s) = [1176168.14261342]
bas 6, expnt(s) = [588084.0699564]
bas 7, expnt(s) = [294042.03092056]
bas 8, expnt(s) = [147020.99131986]
bas 9, expnt(s) = [73510.41753395]
bas 10, expnt(s) = [36754.70146085]
bas 11, expnt(s) = [7302.31683192]
bas 12, expnt(s) = [18375.77115856]
bas 13, expnt(s) = [1443.5641619]
bas 14, expnt(s) = [417.36517148]
bas 15, expnt(s) = [147.79449419]
bas 16, expnt(s) = [58.41277381]
bas 17, expnt(s) = [24.61560433]
bas 18, expnt(s) = [8.0217117]
bas 19, expnt(s) = [8.60421504]
bas 20, expnt(s) = [0.49278109]
CPU time:       564.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.18497455e-01 8.07420574e-01 5.52255502e-01 1.61852743e+00
 1.42698088e+00 3.29859230e+00 1.17616813e+05 1.60460108e+04
 3.43086933e+00 6.36895466e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547015e+04 6.70655822e+03 7.30231683e+03 1.99577018e+03
 1.83757712e+04 3.98748631e+03 1.44356416e+03 5.91687089e+02
 4.17365171e+02 2.33293253e+02 1.47794494e+02 1.07092416e+02
 5.84127738e+01 5.33821298e+01 2.46156043e+01 2.79204813e+01
 8.02171170e+00 1.20424627e+01 8.60421504e+00 4.29905956e+01
 4.92781091e-01 1.20448650e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608569496394
cond(S) = 912408.3614273609
E1 = -689.5980433550124  E_coul = 184.97318355773646
init E= -504.624859797276
    CPU time for initialize scf      0.83 sec, wall time      0.07 sec
  HOMO = -0.672090928003795  LUMO = 0.460519394728371
  mo_energy =
[-1.21709670e+02 -1.33860501e+01 -7.62348851e+00 -7.62348851e+00
 -7.62348851e+00 -1.65761909e+00 -6.72090928e-01 -6.72090928e-01
 -6.72090928e-01  4.60519395e-01  3.85131769e+00  1.72132653e+01
  7.23113037e+01  2.66177926e+02  8.94230983e+02  3.14723455e+03
  1.26271406e+04  4.12240286e+04  1.05252076e+05  2.30425103e+05
  4.56232542e+05  8.45179100e+05  1.52835085e+06  2.85061145e+06
  5.80849001e+06]
E1 = -707.7581373756253  E_coul = 199.78575305942047
cycle= 1 E= -507.972384316205  delta_E= -3.35  |g|= 0.452  |ddm|= 0.485
    CPU time for cycle= 1      0.68 sec, wall time      0.04 sec
diis-norm(errvec)=0.752092
diis-c [-0.56564196  1.        ]
  HOMO = -0.217470226476417  LUMO = 0.786327254306326
  mo_energy =
[-1.20199986e+02 -1.23043616e+01 -6.59377093e+00 -6.59377093e+00
 -6.59377093e+00 -1.16326496e+00 -2.17470226e-01 -2.17470226e-01
 -2.17470226e-01  7.86327254e-01  4.41744272e+00  1.81153145e+01
  7.35756235e+01  2.67631778e+02  8.95723116e+02  3.14866699e+03
  1.26284666e+04  4.12252874e+04  1.05253298e+05  2.30426301e+05
  4.56233722e+05  8.45180267e+05  1.52835200e+06  2.85061259e+06
  5.80849114e+06]
E1 = -706.8015694435595  E_coul = 198.81134318948344
cycle= 2 E= -507.990226254076  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.363
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0365831
diis-c [-0.00133055 -0.00372554  1.00372554]
  HOMO = -0.239727296433715  LUMO = 0.783509664352801
  mo_energy =
[-1.20315207e+02 -1.23723340e+01 -6.66902065e+00 -6.66902065e+00
 -6.66902065e+00 -1.17759282e+00 -2.39727296e-01 -2.39727296e-01
 -2.39727296e-01  7.83509664e-01  4.39421142e+00  1.80621596e+01
  7.34924142e+01  2.67526753e+02  8.95602175e+02  3.14853172e+03
  1.26283211e+04  4.12251380e+04  1.05253147e+05  2.30426149e+05
  4.56233570e+05  8.45180114e+05  1.52835185e+06  2.85061244e+06
  5.80849099e+06]
E1 = -706.6922280102746  E_coul = 198.7017356657207
cycle= 3 E= -507.990492344554  delta_E= -0.000266  |g|= 0.00437  |ddm|= 0.0598
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00418187
diis-c [-3.49670558e-06  2.01003420e-05 -1.14112203e-01  1.11409210e+00]
  HOMO = -0.242920334127837  LUMO = 0.782891961456399
  mo_energy =
[-1.20327005e+02 -1.23809575e+01 -6.67812424e+00 -6.67812424e+00
 -6.67812424e+00 -1.17953011e+00 -2.42920334e-01 -2.42920334e-01
 -2.42920334e-01  7.82891961e-01  4.39063620e+00  1.80551319e+01
  7.34827808e+01  2.67515617e+02  8.95590140e+02  3.14851899e+03
  1.26283079e+04  4.12251247e+04  1.05253134e+05  2.30426135e+05
  4.56233557e+05  8.45180101e+05  1.52835184e+06  2.85061243e+06
  5.80849098e+06]
E1 = -706.6765972584323  E_coul = 198.68609962069362
cycle= 4 E= -507.990497637739  delta_E= -5.29e-06  |g|= 0.000228  |ddm|= 0.0111
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172845
diis-c [-8.62777471e-10 -1.03885540e-05  7.08714833e-03 -9.32289768e-02
  1.08615222e+00]
  HOMO = -0.243054138610232  LUMO = 0.782855827678674
  mo_energy =
[-1.20327268e+02 -1.23812433e+01 -6.67840144e+00 -6.67840144e+00
 -6.67840144e+00 -1.17961155e+00 -2.43054139e-01 -2.43054139e-01
 -2.43054139e-01  7.82855828e-01  4.39047494e+00  1.80548815e+01
  7.34825090e+01  2.67515349e+02  8.95589878e+02  3.14851873e+03
  1.26283076e+04  4.12251244e+04  1.05253134e+05  2.30426135e+05
  4.56233556e+05  8.45180101e+05  1.52835184e+06  2.85061242e+06
  5.80849098e+06]
E1 = -706.6759436597542  E_coul = 198.68544600803878
cycle= 5 E= -507.990497651715  delta_E= -1.4e-08  |g|= 8.36e-06  |ddm|= 0.000754
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.66522e-06
diis-c [-1.32112463e-12  7.14210160e-07 -7.00067185e-04  8.76065315e-03
 -1.10489232e-01  1.10242793e+00]
  HOMO = -0.243057564184362  LUMO = 0.782854919445676
  mo_energy =
[-1.20327275e+02 -1.23812494e+01 -6.67840769e+00 -6.67840769e+00
 -6.67840769e+00 -1.17961392e+00 -2.43057564e-01 -2.43057564e-01
 -2.43057564e-01  7.82854919e-01  4.39047065e+00  1.80548758e+01
  7.34825026e+01  2.67515343e+02  8.95589871e+02  3.14851873e+03
  1.26283076e+04  4.12251244e+04  1.05253134e+05  2.30426135e+05
  4.56233556e+05  8.45180101e+05  1.52835184e+06  2.85061242e+06
  5.80849098e+06]
E1 = -706.6759258262813  E_coul = 198.68542817455014
cycle= 6 E= -507.990497651731  delta_E= -1.57e-11  |g|= 8.62e-08  |ddm|= 2.97e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759258262813  E_coul = 198.68542817455014
  HOMO = -0.243057603206831  LUMO = 0.782854892752228
  mo_energy =
[-1.20327275e+02 -1.23812495e+01 -6.67840777e+00 -6.67840777e+00
 -6.67840777e+00 -1.17961393e+00 -2.43057603e-01 -2.43057603e-01
 -2.43057603e-01  7.82854893e-01  4.39047059e+00  1.80548757e+01
  7.34825025e+01  2.67515343e+02  8.95589871e+02  3.14851873e+03
  1.26283076e+04  4.12251244e+04  1.05253134e+05  2.30426135e+05
  4.56233556e+05  8.45180101e+05  1.52835184e+06  2.85061242e+06
  5.80849098e+06]
E1 = -706.6759256678911  E_coul = 198.68542801615945
Extra cycle  E= -507.990497651732  delta_E= -4.55e-13  |g|= 1.17e-08  |ddm|= 2.25e-07
    CPU time for scf_cycle      1.70 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912408.3614273609
E1 = -706.6759256678911  E_coul = 198.68542801615945
init E= -507.990497651732
    CPU time for initialize scf      5.62 sec, wall time      0.24 sec
  HOMO = -0.243057608525917  LUMO = 0.782854891784568
  mo_energy =
[-1.20327275e+02 -1.23812495e+01 -6.67840778e+00 -6.67840778e+00
 -6.67840778e+00 -1.17961393e+00 -2.43057609e-01 -2.43057609e-01
 -2.43057609e-01  7.82854892e-01  4.39047059e+00  1.80548757e+01
  7.34825025e+01  2.67515343e+02  8.95589870e+02  3.14851873e+03
  1.26283076e+04  4.12251244e+04  1.05253134e+05  2.30426135e+05
  4.56233556e+05  8.45180101e+05  1.52835184e+06  2.85061242e+06
  5.80849098e+06]
E1 = -706.6759256417155  E_coul = 198.685427989984
cycle= 1 E= -507.990497651732  delta_E= 1.14e-13  |g|= 2.6e-09  |ddm|= 3.19e-08
    CPU time for cycle= 1      0.39 sec, wall time      0.03 sec
E1 = -706.6759256417155  E_coul = 198.685427989984
  HOMO = -0.243057609365621  LUMO = 0.782854890873354
  mo_energy =
[-1.20327275e+02 -1.23812495e+01 -6.67840778e+00 -6.67840778e+00
 -6.67840778e+00 -1.17961393e+00 -2.43057609e-01 -2.43057609e-01
 -2.43057609e-01  7.82854891e-01  4.39047058e+00  1.80548757e+01
  7.34825025e+01  2.67515343e+02  8.95589870e+02  3.14851873e+03
  1.26283076e+04  4.12251244e+04  1.05253134e+05  2.30426135e+05
  4.56233556e+05  8.45180101e+05  1.52835184e+06  2.85061242e+06
  5.80849098e+06]
E1 = -706.6759256382581  E_coul = 198.6854279865265
Extra cycle  E= -507.990497651732  delta_E= -1.14e-13  |g|= 1.82e-09  |ddm|= 4.46e-09
    CPU time for scf_cycle      6.15 sec, wall time      0.40 sec
exp = [2.18497455e-01 5.52255502e-01 1.42698088e+00 1.17616813e+05
 3.43086933e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547015e+04 7.30231683e+03
 1.83757712e+04 1.44356416e+03 4.17365171e+02 1.47794494e+02
 5.84127738e+01 2.46156043e+01 8.02171170e+00 8.60421504e+00
 4.92781091e-01]
grad_E = [-2.46460851e-05  6.12013165e-04  2.17161202e-04  6.05684860e-09
 -5.46379314e-04  4.03793989e-11  1.73977441e-10  9.39472627e-10
  3.71179260e-09  1.54996240e-08  8.08526470e-08  5.09612299e-06
  1.98145576e-07 -3.82399921e-05 -8.13906942e-06  1.11590091e-05
 -2.61392525e-05 -2.33172460e-05 -1.20725014e-04 -1.21282487e-04
  1.34148985e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:44 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.213636804176       1
[INPUT] 0    0    [1    /1   ]  0.551072092851       1
[INPUT] 0    0    [1    /1   ]  1.56208724922        1
[INPUT] 0    0    [1    /1   ]  117616.812882        1
[INPUT] 0    0    [1    /1   ]  3.53258921515        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991319        1
[INPUT] 0    0    [1    /1   ]  73510.4175305        1
[INPUT] 0    0    [1    /1   ]  36754.7014426        1
[INPUT] 0    0    [1    /1   ]  7302.31568135        1
[INPUT] 0    0    [1    /1   ]  18375.7711138        1
[INPUT] 0    0    [1    /1   ]  1443.57289522        1
[INPUT] 0    0    [1    /1   ]  417.365893441        1
[INPUT] 0    0    [1    /1   ]  147.796976234        1
[INPUT] 0    0    [1    /1   ]  58.4031707614        1
[INPUT] 0    0    [1    /1   ]  24.6299805064        1
[INPUT] 0    0    [1    /1   ]  8.12960023844        1
[INPUT] 1    0    [1    /1   ]  8.60496060345        1
[INPUT] 1    0    [1    /1   ]  0.492895640471       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21363680417611228, 1.0]], [0, [0.5510720928507636, 1.0]], [0, [1.562087249223521, 1.0]], [0, [117616.81288249635, 1.0]], [0, [3.53258921515371, 1.0]], [0, [1176168.1426134063, 1.0]], [0, [588084.0699563585, 1.0]], [0, [294042.03092034836, 1.0]], [0, [147020.99131902237, 1.0]], [0, [73510.41753045173, 1.0]], [0, [36754.70144259295, 1.0]], [0, [7302.315681350453, 1.0]], [0, [18375.771113782448, 1.0]], [0, [1443.5728952186341, 1.0]], [0, [417.36589344108165, 1.0]], [0, [147.79697623368716, 1.0]], [0, [58.403170761389106, 1.0]], [0, [24.62998050637767, 1.0]], [0, [8.12960023843875, 1.0]], [1, [8.604960603446536, 1.0]], [1, [0.4928956404711434, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2136368]
bas 1, expnt(s) = [0.55107209]
bas 2, expnt(s) = [1.56208725]
bas 3, expnt(s) = [117616.8128825]
bas 4, expnt(s) = [3.53258922]
bas 5, expnt(s) = [1176168.14261341]
bas 6, expnt(s) = [588084.06995636]
bas 7, expnt(s) = [294042.03092035]
bas 8, expnt(s) = [147020.99131902]
bas 9, expnt(s) = [73510.41753045]
bas 10, expnt(s) = [36754.70144259]
bas 11, expnt(s) = [7302.31568135]
bas 12, expnt(s) = [18375.77111378]
bas 13, expnt(s) = [1443.57289522]
bas 14, expnt(s) = [417.36589344]
bas 15, expnt(s) = [147.79697623]
bas 16, expnt(s) = [58.40317076]
bas 17, expnt(s) = [24.62998051]
bas 18, expnt(s) = [8.12960024]
bas 19, expnt(s) = [8.6049606]
bas 20, expnt(s) = [0.49289564]
CPU time:       579.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.13636804e-01 7.93911474e-01 5.51072093e-01 1.61592551e+00
 1.56208725e+00 3.53015675e+00 1.17616813e+05 1.60460108e+04
 3.53258922e+00 6.51005831e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231568e+03 1.99576994e+03
 1.83757711e+04 3.98748630e+03 1.44357290e+03 5.91689774e+02
 4.17365893e+02 2.33293555e+02 1.47796976e+02 1.07093765e+02
 5.84031708e+01 5.33755476e+01 2.46299805e+01 2.79327102e+01
 8.12960024e+00 1.21637341e+01 8.60496060e+00 4.29952522e+01
 4.92895640e-01 1.20483649e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335956359638978
cond(S) = 912446.213928787
E1 = -689.6051829605886  E_coul = 184.97979039043776
init E= -504.625392570151
    CPU time for initialize scf      7.60 sec, wall time      0.37 sec
  HOMO = -0.671976068463131  LUMO = 0.454104486055566
  mo_energy =
[-1.21708681e+02 -1.33855389e+01 -7.62306323e+00 -7.62306323e+00
 -7.62306323e+00 -1.65746477e+00 -6.71976068e-01 -6.71976068e-01
 -6.71976068e-01  4.54104486e-01  4.04643761e+00  1.80435002e+01
  7.36809239e+01  2.67600814e+02  8.95541064e+02  3.14842136e+03
  1.26282056e+04  4.12250212e+04  1.05253029e+05  2.30426029e+05
  4.56233449e+05  8.45179992e+05  1.52835172e+06  2.85061231e+06
  5.80849084e+06]
E1 = -707.7668156181338  E_coul = 199.79444615035933
cycle= 1 E= -507.972369467774  delta_E= -3.35  |g|= 0.452  |ddm|= 0.48
    CPU time for cycle= 1      0.39 sec, wall time      0.03 sec
diis-norm(errvec)=0.755943
diis-c [-0.5714497  1.       ]
  HOMO = -0.217244693627073  LUMO = 0.780928869520217
  mo_energy =
[-1.20198837e+02 -1.23037183e+01 -6.59321400e+00 -6.59321400e+00
 -6.59321400e+00 -1.16306064e+00 -2.17244694e-01 -2.17244694e-01
 -2.17244694e-01  7.80928870e-01  4.62740810e+00  1.89547621e+01
  7.49457592e+01  2.69054467e+02  8.97033242e+02  3.14985393e+03
  1.26295317e+04  4.12262801e+04  1.05254251e+05  2.30427227e+05
  4.56234629e+05  8.45181159e+05  1.52835288e+06  2.85061345e+06
  5.80849198e+06]
E1 = -706.8087103688512  E_coul = 198.81847009430194
cycle= 2 E= -507.990240274549  delta_E= -0.0179  |g|= 0.0352  |ddm|= 0.375
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0363055
diis-c [-0.00130995 -0.00379286  1.00379286]
  HOMO = -0.23956317364645  LUMO = 0.778014657327612
  mo_energy =
[-1.20314191e+02 -1.23718048e+01 -6.66858043e+00 -6.66858043e+00
 -6.66858043e+00 -1.17743116e+00 -2.39563174e-01 -2.39563174e-01
 -2.39563174e-01  7.78014657e-01  4.60292276e+00  1.89006364e+01
  7.48623209e+01  2.68949334e+02  8.96912178e+02  3.14971852e+03
  1.26293860e+04  4.12261306e+04  1.05254100e+05  2.30427075e+05
  4.56234477e+05  8.45181006e+05  1.52835273e+06  2.85061330e+06
  5.80849183e+06]
E1 = -706.6987802894486  E_coul = 198.70827147470249
cycle= 3 E= -507.990508814746  delta_E= -0.000269  |g|= 0.00439  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00412108
diis-c [-3.53189913e-06  5.81930060e-05 -1.12697444e-01  1.11263925e+00]
  HOMO = -0.242772828473317  LUMO = 0.777377415119924
  mo_energy =
[-1.20326015e+02 -1.23804558e+01 -6.67771105e+00 -6.67771105e+00
 -6.67771105e+00 -1.17937891e+00 -2.42772828e-01 -2.42772828e-01
 -2.42772828e-01  7.77377415e-01  4.59916546e+00  1.88934921e+01
  7.48526517e+01  2.68938173e+02  8.96900118e+02  3.14970577e+03
  1.26293728e+04  4.12261172e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6830322423149  E_coul = 198.69251804772665
cycle= 4 E= -507.990514194588  delta_E= -5.38e-06  |g|= 0.000236  |ddm|= 0.0109
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000177748
diis-c [-8.84955533e-10 -1.03689366e-05  7.08142636e-03 -9.53615683e-02
  1.08829051e+00]
  HOMO = -0.242914632772662  LUMO = 0.777339066227907
  mo_energy =
[-1.20326307e+02 -1.23807624e+01 -6.67801019e+00 -6.67801019e+00
 -6.67801019e+00 -1.17946521e+00 -2.42914633e-01 -2.42914633e-01
 -2.42914633e-01  7.77339066e-01  4.59898881e+00  1.88932226e+01
  7.48523566e+01  2.68937879e+02  8.96899827e+02  3.14970548e+03
  1.26293725e+04  4.12261169e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6823376624301  E_coul = 198.69182345272858
cycle= 5 E= -507.990514209701  delta_E= -1.51e-08  |g|= 8.09e-06  |ddm|= 0.000742
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.62543e-06
diis-c [-1.27111880e-12  7.23603862e-07 -6.80441828e-04  8.72360351e-03
 -1.07928201e-01  1.09988432e+00]
  HOMO = -0.242918049612983  LUMO = 0.777338166581639
  mo_energy =
[-1.20326314e+02 -1.23807686e+01 -6.67801652e+00 -6.67801652e+00
 -6.67801652e+00 -1.17946756e+00 -2.42918050e-01 -2.42918050e-01
 -2.42918050e-01  7.77338167e-01  4.59898440e+00  1.88932168e+01
  7.48523501e+01  2.68937872e+02  8.96899819e+02  3.14970547e+03
  1.26293725e+04  4.12261169e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6823198176697  E_coul = 198.69180560795309
cycle= 6 E= -507.990514209717  delta_E= -1.52e-11  |g|= 8.18e-08  |ddm|= 2.7e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6823198176697  E_coul = 198.69180560795309
  HOMO = -0.242918088265022  LUMO = 0.777338142006614
  mo_energy =
[-1.20326314e+02 -1.23807687e+01 -6.67801659e+00 -6.67801659e+00
 -6.67801659e+00 -1.17946757e+00 -2.42918088e-01 -2.42918088e-01
 -2.42918088e-01  7.77338142e-01  4.59898435e+00  1.88932167e+01
  7.48523500e+01  2.68937872e+02  8.96899819e+02  3.14970547e+03
  1.26293725e+04  4.12261169e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6823196610891  E_coul = 198.69180545137232
Extra cycle  E= -507.990514209717  delta_E= -1.14e-13  |g|= 1.03e-08  |ddm|= 2.03e-07
    CPU time for scf_cycle      8.19 sec, wall time      0.59 sec
exp = [2.13636804e-01 5.51072093e-01 1.56208725e+00 1.17616813e+05
 3.53258922e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231568e+03
 1.83757711e+04 1.44357290e+03 4.17365893e+02 1.47796976e+02
 5.84031708e+01 2.46299805e+01 8.12960024e+00 8.60496060e+00
 4.92895640e-01]
E = -507.99051420971676
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:45 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.213636804176       1
[INPUT] 0    0    [1    /1   ]  0.551072092851       1
[INPUT] 0    0    [1    /1   ]  1.56208724922        1
[INPUT] 0    0    [1    /1   ]  117616.812882        1
[INPUT] 0    0    [1    /1   ]  3.53258921515        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991319        1
[INPUT] 0    0    [1    /1   ]  73510.4175305        1
[INPUT] 0    0    [1    /1   ]  36754.7014426        1
[INPUT] 0    0    [1    /1   ]  7302.31568135        1
[INPUT] 0    0    [1    /1   ]  18375.7711138        1
[INPUT] 0    0    [1    /1   ]  1443.57289522        1
[INPUT] 0    0    [1    /1   ]  417.365893441        1
[INPUT] 0    0    [1    /1   ]  147.796976234        1
[INPUT] 0    0    [1    /1   ]  58.4031707614        1
[INPUT] 0    0    [1    /1   ]  24.6299805064        1
[INPUT] 0    0    [1    /1   ]  8.12960023844        1
[INPUT] 1    0    [1    /1   ]  8.60496060345        1
[INPUT] 1    0    [1    /1   ]  0.492895640471       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21363680417611228, 1.0]], [0, [0.5510720928507636, 1.0]], [0, [1.562087249223521, 1.0]], [0, [117616.81288249635, 1.0]], [0, [3.53258921515371, 1.0]], [0, [1176168.1426134063, 1.0]], [0, [588084.0699563585, 1.0]], [0, [294042.03092034836, 1.0]], [0, [147020.99131902237, 1.0]], [0, [73510.41753045173, 1.0]], [0, [36754.70144259295, 1.0]], [0, [7302.315681350453, 1.0]], [0, [18375.771113782448, 1.0]], [0, [1443.5728952186341, 1.0]], [0, [417.36589344108165, 1.0]], [0, [147.79697623368716, 1.0]], [0, [58.403170761389106, 1.0]], [0, [24.62998050637767, 1.0]], [0, [8.12960023843875, 1.0]], [1, [8.604960603446536, 1.0]], [1, [0.4928956404711434, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2136368]
bas 1, expnt(s) = [0.55107209]
bas 2, expnt(s) = [1.56208725]
bas 3, expnt(s) = [117616.8128825]
bas 4, expnt(s) = [3.53258922]
bas 5, expnt(s) = [1176168.14261341]
bas 6, expnt(s) = [588084.06995636]
bas 7, expnt(s) = [294042.03092035]
bas 8, expnt(s) = [147020.99131902]
bas 9, expnt(s) = [73510.41753045]
bas 10, expnt(s) = [36754.70144259]
bas 11, expnt(s) = [7302.31568135]
bas 12, expnt(s) = [18375.77111378]
bas 13, expnt(s) = [1443.57289522]
bas 14, expnt(s) = [417.36589344]
bas 15, expnt(s) = [147.79697623]
bas 16, expnt(s) = [58.40317076]
bas 17, expnt(s) = [24.62998051]
bas 18, expnt(s) = [8.12960024]
bas 19, expnt(s) = [8.6049606]
bas 20, expnt(s) = [0.49289564]
CPU time:       587.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.13636804e-01 7.93911474e-01 5.51072093e-01 1.61592551e+00
 1.56208725e+00 3.53015675e+00 1.17616813e+05 1.60460108e+04
 3.53258922e+00 6.51005831e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231568e+03 1.99576994e+03
 1.83757711e+04 3.98748630e+03 1.44357290e+03 5.91689774e+02
 4.17365893e+02 2.33293555e+02 1.47796976e+02 1.07093765e+02
 5.84031708e+01 5.33755476e+01 2.46299805e+01 2.79327102e+01
 8.12960024e+00 1.21637341e+01 8.60496060e+00 4.29952522e+01
 4.92895640e-01 1.20483649e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335956359638978
cond(S) = 912446.213928787
E1 = -689.6051829605886  E_coul = 184.97979039043776
init E= -504.625392570151
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.671976068463131  LUMO = 0.454104486055566
  mo_energy =
[-1.21708681e+02 -1.33855389e+01 -7.62306323e+00 -7.62306323e+00
 -7.62306323e+00 -1.65746477e+00 -6.71976068e-01 -6.71976068e-01
 -6.71976068e-01  4.54104486e-01  4.04643761e+00  1.80435002e+01
  7.36809239e+01  2.67600814e+02  8.95541064e+02  3.14842136e+03
  1.26282056e+04  4.12250212e+04  1.05253029e+05  2.30426029e+05
  4.56233449e+05  8.45179992e+05  1.52835172e+06  2.85061231e+06
  5.80849084e+06]
E1 = -707.7668156181338  E_coul = 199.79444615035933
cycle= 1 E= -507.972369467774  delta_E= -3.35  |g|= 0.452  |ddm|= 0.48
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.755943
diis-c [-0.5714497  1.       ]
  HOMO = -0.217244693627073  LUMO = 0.780928869520217
  mo_energy =
[-1.20198837e+02 -1.23037183e+01 -6.59321400e+00 -6.59321400e+00
 -6.59321400e+00 -1.16306064e+00 -2.17244694e-01 -2.17244694e-01
 -2.17244694e-01  7.80928870e-01  4.62740810e+00  1.89547621e+01
  7.49457592e+01  2.69054467e+02  8.97033242e+02  3.14985393e+03
  1.26295317e+04  4.12262801e+04  1.05254251e+05  2.30427227e+05
  4.56234629e+05  8.45181159e+05  1.52835288e+06  2.85061345e+06
  5.80849198e+06]
E1 = -706.8087103688512  E_coul = 198.81847009430194
cycle= 2 E= -507.990240274549  delta_E= -0.0179  |g|= 0.0352  |ddm|= 0.375
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0363055
diis-c [-0.00130995 -0.00379286  1.00379286]
  HOMO = -0.23956317364645  LUMO = 0.778014657327612
  mo_energy =
[-1.20314191e+02 -1.23718048e+01 -6.66858043e+00 -6.66858043e+00
 -6.66858043e+00 -1.17743116e+00 -2.39563174e-01 -2.39563174e-01
 -2.39563174e-01  7.78014657e-01  4.60292276e+00  1.89006364e+01
  7.48623209e+01  2.68949334e+02  8.96912178e+02  3.14971852e+03
  1.26293860e+04  4.12261306e+04  1.05254100e+05  2.30427075e+05
  4.56234477e+05  8.45181006e+05  1.52835273e+06  2.85061330e+06
  5.80849183e+06]
E1 = -706.6987802894486  E_coul = 198.70827147470249
cycle= 3 E= -507.990508814746  delta_E= -0.000269  |g|= 0.00439  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00412108
diis-c [-3.53189913e-06  5.81930060e-05 -1.12697444e-01  1.11263925e+00]
  HOMO = -0.242772828473317  LUMO = 0.777377415119924
  mo_energy =
[-1.20326015e+02 -1.23804558e+01 -6.67771105e+00 -6.67771105e+00
 -6.67771105e+00 -1.17937891e+00 -2.42772828e-01 -2.42772828e-01
 -2.42772828e-01  7.77377415e-01  4.59916546e+00  1.88934921e+01
  7.48526517e+01  2.68938173e+02  8.96900118e+02  3.14970577e+03
  1.26293728e+04  4.12261172e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6830322423149  E_coul = 198.69251804772665
cycle= 4 E= -507.990514194588  delta_E= -5.38e-06  |g|= 0.000236  |ddm|= 0.0109
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000177748
diis-c [-8.84955533e-10 -1.03689366e-05  7.08142636e-03 -9.53615683e-02
  1.08829051e+00]
  HOMO = -0.242914632772662  LUMO = 0.777339066227907
  mo_energy =
[-1.20326307e+02 -1.23807624e+01 -6.67801019e+00 -6.67801019e+00
 -6.67801019e+00 -1.17946521e+00 -2.42914633e-01 -2.42914633e-01
 -2.42914633e-01  7.77339066e-01  4.59898881e+00  1.88932226e+01
  7.48523566e+01  2.68937879e+02  8.96899827e+02  3.14970548e+03
  1.26293725e+04  4.12261169e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6823376624301  E_coul = 198.69182345272858
cycle= 5 E= -507.990514209701  delta_E= -1.51e-08  |g|= 8.09e-06  |ddm|= 0.000742
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.62543e-06
diis-c [-1.27111880e-12  7.23603862e-07 -6.80441828e-04  8.72360351e-03
 -1.07928201e-01  1.09988432e+00]
  HOMO = -0.242918049612983  LUMO = 0.777338166581639
  mo_energy =
[-1.20326314e+02 -1.23807686e+01 -6.67801652e+00 -6.67801652e+00
 -6.67801652e+00 -1.17946756e+00 -2.42918050e-01 -2.42918050e-01
 -2.42918050e-01  7.77338167e-01  4.59898440e+00  1.88932168e+01
  7.48523501e+01  2.68937872e+02  8.96899819e+02  3.14970547e+03
  1.26293725e+04  4.12261169e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6823198176697  E_coul = 198.69180560795309
cycle= 6 E= -507.990514209717  delta_E= -1.52e-11  |g|= 8.18e-08  |ddm|= 2.7e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6823198176697  E_coul = 198.69180560795309
  HOMO = -0.242918088265022  LUMO = 0.777338142006614
  mo_energy =
[-1.20326314e+02 -1.23807687e+01 -6.67801659e+00 -6.67801659e+00
 -6.67801659e+00 -1.17946757e+00 -2.42918088e-01 -2.42918088e-01
 -2.42918088e-01  7.77338142e-01  4.59898435e+00  1.88932167e+01
  7.48523500e+01  2.68937872e+02  8.96899819e+02  3.14970547e+03
  1.26293725e+04  4.12261169e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6823196610891  E_coul = 198.69180545137232
Extra cycle  E= -507.990514209717  delta_E= -1.14e-13  |g|= 1.03e-08  |ddm|= 2.03e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912446.213928787
E1 = -706.6823196610891  E_coul = 198.69180545137232
init E= -507.990514209717
    CPU time for initialize scf      5.85 sec, wall time      0.25 sec
  HOMO = -0.242918093489705  LUMO = 0.777338140097887
  mo_energy =
[-1.20326314e+02 -1.23807687e+01 -6.67801661e+00 -6.67801661e+00
 -6.67801661e+00 -1.17946758e+00 -2.42918093e-01 -2.42918093e-01
 -2.42918093e-01  7.77338140e-01  4.59898434e+00  1.88932167e+01
  7.48523500e+01  2.68937872e+02  8.96899819e+02  3.14970547e+03
  1.26293725e+04  4.12261169e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6823196341753  E_coul = 198.69180542445864
cycle= 1 E= -507.990514209717  delta_E= 5.68e-14  |g|= 1.65e-09  |ddm|= 2.91e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6823196341753  E_coul = 198.69180542445864
  HOMO = -0.242918094330184  LUMO = 0.777338140980716
  mo_energy =
[-1.20326314e+02 -1.23807687e+01 -6.67801661e+00 -6.67801661e+00
 -6.67801661e+00 -1.17946758e+00 -2.42918094e-01 -2.42918094e-01
 -2.42918094e-01  7.77338141e-01  4.59898434e+00  1.88932167e+01
  7.48523500e+01  2.68937872e+02  8.96899819e+02  3.14970547e+03
  1.26293725e+04  4.12261169e+04  1.05254086e+05  2.30427061e+05
  4.56234463e+05  8.45180993e+05  1.52835271e+06  2.85061328e+06
  5.80849181e+06]
E1 = -706.6823196287638  E_coul = 198.6918054190476
Extra cycle  E= -507.990514209716  delta_E= 4.55e-13  |g|= 2.42e-09  |ddm|= 4.4e-09
    CPU time for scf_cycle      6.37 sec, wall time      0.42 sec
exp = [2.13636804e-01 5.51072093e-01 1.56208725e+00 1.17616813e+05
 3.53258922e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231568e+03
 1.83757711e+04 1.44357290e+03 4.17365893e+02 1.47796976e+02
 5.84031708e+01 2.46299805e+01 8.12960024e+00 8.60496060e+00
 4.92895640e-01]
grad_E = [-4.74954562e-03  1.54667303e-03  2.48373684e-04  6.05359472e-09
 -2.96121876e-04  4.03429905e-11  1.73870784e-10  9.38973629e-10
  3.70977731e-09  1.54910982e-08  8.08114948e-08  5.09350405e-06
  1.98011037e-07 -3.81328525e-05 -9.06604026e-06  1.49978591e-05
 -3.48237757e-05 -2.21657897e-05 -1.75151823e-04  3.84354323e-04
  4.11480117e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.218961724337       1
[INPUT] 0    0    [1    /1   ]  0.555757527281       1
[INPUT] 0    0    [1    /1   ]  1.6331716962         1
[INPUT] 0    0    [1    /1   ]  117616.812882        1
[INPUT] 0    0    [1    /1   ]  3.59419090268        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991319        1
[INPUT] 0    0    [1    /1   ]  73510.4175286        1
[INPUT] 0    0    [1    /1   ]  36754.7014327        1
[INPUT] 0    0    [1    /1   ]  7302.31506027        1
[INPUT] 0    0    [1    /1   ]  18375.7710896        1
[INPUT] 0    0    [1    /1   ]  1443.5776077         1
[INPUT] 0    0    [1    /1   ]  417.366303968        1
[INPUT] 0    0    [1    /1   ]  147.79821245         1
[INPUT] 0    0    [1    /1   ]  58.3983733827        1
[INPUT] 0    0    [1    /1   ]  24.6373231313        1
[INPUT] 0    0    [1    /1   ]  8.18284613896        1
[INPUT] 1    0    [1    /1   ]  8.60485971435        1
[INPUT] 1    0    [1    /1   ]  0.492816298459       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21896172433721756, 1.0]], [0, [0.5557575272805462, 1.0]], [0, [1.6331716961987468, 1.0]], [0, [117616.8128817581, 1.0]], [0, [3.5941909026784145, 1.0]], [0, [1176168.1426134014, 1.0]], [0, [588084.0699563373, 1.0]], [0, [294042.03092023387, 1.0]], [0, [147020.99131856996, 1.0]], [0, [73510.41752856241, 1.0]], [0, [36754.70143273945, 1.0]], [0, [7302.315060271693, 1.0]], [0, [18375.77108961461, 1.0]], [0, [1443.5776077032804, 1.0]], [0, [417.36630396818066, 1.0]], [0, [147.7982124502198, 1.0]], [0, [58.398373382680084, 1.0]], [0, [24.637323131320933, 1.0]], [0, [8.182846138959611, 1.0]], [1, [8.6048597143452, 1.0]], [1, [0.4928162984594004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21896172]
bas 1, expnt(s) = [0.55575753]
bas 2, expnt(s) = [1.6331717]
bas 3, expnt(s) = [117616.81288176]
bas 4, expnt(s) = [3.5941909]
bas 5, expnt(s) = [1176168.1426134]
bas 6, expnt(s) = [588084.06995634]
bas 7, expnt(s) = [294042.03092023]
bas 8, expnt(s) = [147020.99131857]
bas 9, expnt(s) = [73510.41752856]
bas 10, expnt(s) = [36754.70143274]
bas 11, expnt(s) = [7302.31506027]
bas 12, expnt(s) = [18375.77108961]
bas 13, expnt(s) = [1443.5776077]
bas 14, expnt(s) = [417.36630397]
bas 15, expnt(s) = [147.79821245]
bas 16, expnt(s) = [58.39837338]
bas 17, expnt(s) = [24.63732313]
bas 18, expnt(s) = [8.18284614]
bas 19, expnt(s) = [8.60485971]
bas 20, expnt(s) = [0.4928163]
CPU time:       602.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.18961724e-01 8.08706954e-01 5.55757527e-01 1.62621903e+00
 1.63317170e+00 3.64996675e+00 1.17616813e+05 1.60460108e+04
 3.59419090e+00 6.59501640e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231506e+03 1.99576981e+03
 1.83757711e+04 3.98748629e+03 1.44357761e+03 5.91691223e+02
 4.17366304e+02 2.33293727e+02 1.47798212e+02 1.07094437e+02
 5.83983734e+01 5.33722593e+01 2.46373231e+01 2.79389554e+01
 8.18284614e+00 1.22234363e+01 8.60485971e+00 4.29946220e+01
 4.92816298e-01 1.20459407e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336023634761826
cond(S) = 912470.91029219
E1 = -689.6003594848418  E_coul = 184.9760477149644
init E= -504.624311769877
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672108587502575  LUMO = 0.473487970152125
  mo_energy =
[-1.21709048e+02 -1.33858476e+01 -7.62329774e+00 -7.62329774e+00
 -7.62329774e+00 -1.65756745e+00 -6.72108588e-01 -6.72108588e-01
 -6.72108588e-01  4.73487970e-01  4.20775514e+00  1.85555132e+01
  7.44778907e+01  2.68419137e+02  8.96292963e+02  3.14910178e+03
  1.26288154e+04  4.12255893e+04  1.05253574e+05  2.30426559e+05
  4.56233968e+05  8.45180503e+05  1.52835223e+06  2.85061280e+06
  5.80849132e+06]
E1 = -707.7619671739391  E_coul = 199.7895305378617
cycle= 1 E= -507.972436636077  delta_E= -3.35  |g|= 0.452  |ddm|= 0.496
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.756381
diis-c [-0.57211185  1.        ]
  HOMO = -0.217428737751568  LUMO = 0.804618440243893
  mo_energy =
[-1.20199310e+02 -1.23041066e+01 -6.59352145e+00 -6.59352145e+00
 -6.59352145e+00 -1.16319323e+00 -2.17428738e-01 -2.17428738e-01
 -2.17428738e-01  8.04618440e-01  4.79692898e+00  1.94713036e+01
  7.57427434e+01  2.69872470e+02  8.97784971e+02  3.15053423e+03
  1.26301413e+04  4.12268481e+04  1.05254796e+05  2.30427757e+05
  4.56235148e+05  8.45181669e+05  1.52835338e+06  2.85061394e+06
  5.80849246e+06]
E1 = -706.8064533086138  E_coul = 198.81620108307803
cycle= 2 E= -507.990252225536  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.383
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0357199
diis-c [-0.00126883 -0.00353395  1.00353395]
  HOMO = -0.239641425285019  LUMO = 0.801561664060171
  mo_energy =
[-1.20314418e+02 -1.23719908e+01 -6.66868074e+00 -6.66868074e+00
 -6.66868074e+00 -1.17749058e+00 -2.39641425e-01 -2.39641425e-01
 -2.39641425e-01  8.01561664e-01  4.77182868e+00  1.94169051e+01
  7.56594687e+01  2.69767587e+02  8.97664165e+02  3.15039909e+03
  1.26299959e+04  4.12266988e+04  1.05254645e+05  2.30427605e+05
  4.56234996e+05  8.45181517e+05  1.52835323e+06  2.85061379e+06
  5.80849231e+06]
E1 = -706.6971458544022  E_coul = 198.70662739836393
cycle= 3 E= -507.990518456038  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00400989
diis-c [-3.43433133e-06  8.02456647e-05 -1.10929204e-01  1.11084896e+00]
  HOMO = -0.24282561954751  LUMO = 0.800904665554369
  mo_energy =
[-1.20326194e+02 -1.23805953e+01 -6.67776511e+00 -6.67776511e+00
 -6.67776511e+00 -1.17942220e+00 -2.42825620e-01 -2.42825620e-01
 -2.42825620e-01  8.00904666e-01  4.76800556e+00  1.94097570e+01
  7.56498420e+01  2.69756474e+02  8.97652152e+02  3.15038638e+03
  1.26299828e+04  4.12266855e+04  1.05254632e+05  2.30427592e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6815393254591  E_coul = 198.69101556882347
cycle= 4 E= -507.990523756636  delta_E= -5.3e-06  |g|= 0.000238  |ddm|= 0.0109
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176794
diis-c [-8.06694772e-10 -1.00300939e-05  7.02622179e-03 -9.64354291e-02
  1.08941924e+00]
  HOMO = -0.242970767028014  LUMO = 0.800864736320455
  mo_energy =
[-1.20326505e+02 -1.23809137e+01 -6.67807712e+00 -6.67807712e+00
 -6.67807712e+00 -1.17951047e+00 -2.42970767e-01 -2.42970767e-01
 -2.42970767e-01  8.00864736e-01  4.76782156e+00  1.94094772e+01
  7.56495328e+01  2.69756164e+02  8.97651842e+02  3.15038607e+03
  1.26299825e+04  4.12266852e+04  1.05254631e+05  2.30427591e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6808298749387  E_coul = 198.69030610302005
cycle= 5 E= -507.990523771919  delta_E= -1.53e-08  |g|= 7.68e-06  |ddm|= 0.000736
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.40123e-06
diis-c [-1.19557910e-12  7.00197286e-07 -6.54571470e-04  8.55661913e-03
 -1.04663424e-01  1.09676068e+00]
  HOMO = -0.242974095886914  LUMO = 0.800863850541275
  mo_energy =
[-1.20326512e+02 -1.23809199e+01 -6.67808342e+00 -6.67808342e+00
 -6.67808342e+00 -1.17951276e+00 -2.42974096e-01 -2.42974096e-01
 -2.42974096e-01  8.00863851e-01  4.76781722e+00  1.94094714e+01
  7.56495263e+01  2.69756157e+02  8.97651835e+02  3.15038607e+03
  1.26299825e+04  4.12266852e+04  1.05254631e+05  2.30427591e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6808125959952  E_coul = 198.69028882406346
cycle= 6 E= -507.990523771932  delta_E= -1.31e-11  |g|= 8.56e-08  |ddm|= 2.52e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6808125959952  E_coul = 198.69028882406346
  HOMO = -0.242974136130264  LUMO = 0.800863825077568
  mo_energy =
[-1.20326512e+02 -1.23809200e+01 -6.67808350e+00 -6.67808350e+00
 -6.67808350e+00 -1.17951277e+00 -2.42974136e-01 -2.42974136e-01
 -2.42974136e-01  8.00863825e-01  4.76781716e+00  1.94094714e+01
  7.56495262e+01  2.69756157e+02  8.97651835e+02  3.15038607e+03
  1.26299825e+04  4.12266852e+04  1.05254631e+05  2.30427591e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6808124251401  E_coul = 198.6902886532076
Extra cycle  E= -507.990523771932  delta_E= -6.82e-13  |g|= 1.06e-08  |ddm|= 2.14e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.18961724e-01 5.55757527e-01 1.63317170e+00 1.17616813e+05
 3.59419090e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231506e+03
 1.83757711e+04 1.44357761e+03 4.17366304e+02 1.47798212e+02
 5.83983734e+01 2.46373231e+01 8.18284614e+00 8.60485971e+00
 4.92816298e-01]
E = -507.99052377193243
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:30:52 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.218961724337       1
[INPUT] 0    0    [1    /1   ]  0.555757527281       1
[INPUT] 0    0    [1    /1   ]  1.6331716962         1
[INPUT] 0    0    [1    /1   ]  117616.812882        1
[INPUT] 0    0    [1    /1   ]  3.59419090268        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991319        1
[INPUT] 0    0    [1    /1   ]  73510.4175286        1
[INPUT] 0    0    [1    /1   ]  36754.7014327        1
[INPUT] 0    0    [1    /1   ]  7302.31506027        1
[INPUT] 0    0    [1    /1   ]  18375.7710896        1
[INPUT] 0    0    [1    /1   ]  1443.5776077         1
[INPUT] 0    0    [1    /1   ]  417.366303968        1
[INPUT] 0    0    [1    /1   ]  147.79821245         1
[INPUT] 0    0    [1    /1   ]  58.3983733827        1
[INPUT] 0    0    [1    /1   ]  24.6373231313        1
[INPUT] 0    0    [1    /1   ]  8.18284613896        1
[INPUT] 1    0    [1    /1   ]  8.60485971435        1
[INPUT] 1    0    [1    /1   ]  0.492816298459       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21896172433721756, 1.0]], [0, [0.5557575272805462, 1.0]], [0, [1.6331716961987468, 1.0]], [0, [117616.8128817581, 1.0]], [0, [3.5941909026784145, 1.0]], [0, [1176168.1426134014, 1.0]], [0, [588084.0699563373, 1.0]], [0, [294042.03092023387, 1.0]], [0, [147020.99131856996, 1.0]], [0, [73510.41752856241, 1.0]], [0, [36754.70143273945, 1.0]], [0, [7302.315060271693, 1.0]], [0, [18375.77108961461, 1.0]], [0, [1443.5776077032804, 1.0]], [0, [417.36630396818066, 1.0]], [0, [147.7982124502198, 1.0]], [0, [58.398373382680084, 1.0]], [0, [24.637323131320933, 1.0]], [0, [8.182846138959611, 1.0]], [1, [8.6048597143452, 1.0]], [1, [0.4928162984594004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21896172]
bas 1, expnt(s) = [0.55575753]
bas 2, expnt(s) = [1.6331717]
bas 3, expnt(s) = [117616.81288176]
bas 4, expnt(s) = [3.5941909]
bas 5, expnt(s) = [1176168.1426134]
bas 6, expnt(s) = [588084.06995634]
bas 7, expnt(s) = [294042.03092023]
bas 8, expnt(s) = [147020.99131857]
bas 9, expnt(s) = [73510.41752856]
bas 10, expnt(s) = [36754.70143274]
bas 11, expnt(s) = [7302.31506027]
bas 12, expnt(s) = [18375.77108961]
bas 13, expnt(s) = [1443.5776077]
bas 14, expnt(s) = [417.36630397]
bas 15, expnt(s) = [147.79821245]
bas 16, expnt(s) = [58.39837338]
bas 17, expnt(s) = [24.63732313]
bas 18, expnt(s) = [8.18284614]
bas 19, expnt(s) = [8.60485971]
bas 20, expnt(s) = [0.4928163]
CPU time:       604.02
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.18961724e-01 8.08706954e-01 5.55757527e-01 1.62621903e+00
 1.63317170e+00 3.64996675e+00 1.17616813e+05 1.60460108e+04
 3.59419090e+00 6.59501640e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231506e+03 1.99576981e+03
 1.83757711e+04 3.98748629e+03 1.44357761e+03 5.91691223e+02
 4.17366304e+02 2.33293727e+02 1.47798212e+02 1.07094437e+02
 5.83983734e+01 5.33722593e+01 2.46373231e+01 2.79389554e+01
 8.18284614e+00 1.22234363e+01 8.60485971e+00 4.29946220e+01
 4.92816298e-01 1.20459407e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336023634761826
cond(S) = 912470.91029219
E1 = -689.6003594848418  E_coul = 184.9760477149644
init E= -504.624311769877
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672108587502575  LUMO = 0.473487970152125
  mo_energy =
[-1.21709048e+02 -1.33858476e+01 -7.62329774e+00 -7.62329774e+00
 -7.62329774e+00 -1.65756745e+00 -6.72108588e-01 -6.72108588e-01
 -6.72108588e-01  4.73487970e-01  4.20775514e+00  1.85555132e+01
  7.44778907e+01  2.68419137e+02  8.96292963e+02  3.14910178e+03
  1.26288154e+04  4.12255893e+04  1.05253574e+05  2.30426559e+05
  4.56233968e+05  8.45180503e+05  1.52835223e+06  2.85061280e+06
  5.80849132e+06]
E1 = -707.7619671739391  E_coul = 199.7895305378617
cycle= 1 E= -507.972436636077  delta_E= -3.35  |g|= 0.452  |ddm|= 0.496
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.756381
diis-c [-0.57211185  1.        ]
  HOMO = -0.217428737751568  LUMO = 0.804618440243893
  mo_energy =
[-1.20199310e+02 -1.23041066e+01 -6.59352145e+00 -6.59352145e+00
 -6.59352145e+00 -1.16319323e+00 -2.17428738e-01 -2.17428738e-01
 -2.17428738e-01  8.04618440e-01  4.79692898e+00  1.94713036e+01
  7.57427434e+01  2.69872470e+02  8.97784971e+02  3.15053423e+03
  1.26301413e+04  4.12268481e+04  1.05254796e+05  2.30427757e+05
  4.56235148e+05  8.45181669e+05  1.52835338e+06  2.85061394e+06
  5.80849246e+06]
E1 = -706.8064533086138  E_coul = 198.81620108307803
cycle= 2 E= -507.990252225536  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.383
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0357199
diis-c [-0.00126883 -0.00353395  1.00353395]
  HOMO = -0.239641425285019  LUMO = 0.801561664060171
  mo_energy =
[-1.20314418e+02 -1.23719908e+01 -6.66868074e+00 -6.66868074e+00
 -6.66868074e+00 -1.17749058e+00 -2.39641425e-01 -2.39641425e-01
 -2.39641425e-01  8.01561664e-01  4.77182868e+00  1.94169051e+01
  7.56594687e+01  2.69767587e+02  8.97664165e+02  3.15039909e+03
  1.26299959e+04  4.12266988e+04  1.05254645e+05  2.30427605e+05
  4.56234996e+05  8.45181517e+05  1.52835323e+06  2.85061379e+06
  5.80849231e+06]
E1 = -706.6971458544022  E_coul = 198.70662739836393
cycle= 3 E= -507.990518456038  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00400989
diis-c [-3.43433133e-06  8.02456647e-05 -1.10929204e-01  1.11084896e+00]
  HOMO = -0.24282561954751  LUMO = 0.800904665554369
  mo_energy =
[-1.20326194e+02 -1.23805953e+01 -6.67776511e+00 -6.67776511e+00
 -6.67776511e+00 -1.17942220e+00 -2.42825620e-01 -2.42825620e-01
 -2.42825620e-01  8.00904666e-01  4.76800556e+00  1.94097570e+01
  7.56498420e+01  2.69756474e+02  8.97652152e+02  3.15038638e+03
  1.26299828e+04  4.12266855e+04  1.05254632e+05  2.30427592e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6815393254591  E_coul = 198.69101556882347
cycle= 4 E= -507.990523756636  delta_E= -5.3e-06  |g|= 0.000238  |ddm|= 0.0109
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176794
diis-c [-8.06694772e-10 -1.00300939e-05  7.02622179e-03 -9.64354291e-02
  1.08941924e+00]
  HOMO = -0.242970767028014  LUMO = 0.800864736320455
  mo_energy =
[-1.20326505e+02 -1.23809137e+01 -6.67807712e+00 -6.67807712e+00
 -6.67807712e+00 -1.17951047e+00 -2.42970767e-01 -2.42970767e-01
 -2.42970767e-01  8.00864736e-01  4.76782156e+00  1.94094772e+01
  7.56495328e+01  2.69756164e+02  8.97651842e+02  3.15038607e+03
  1.26299825e+04  4.12266852e+04  1.05254631e+05  2.30427591e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6808298749387  E_coul = 198.69030610302005
cycle= 5 E= -507.990523771919  delta_E= -1.53e-08  |g|= 7.68e-06  |ddm|= 0.000736
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.40123e-06
diis-c [-1.19557910e-12  7.00197286e-07 -6.54571470e-04  8.55661913e-03
 -1.04663424e-01  1.09676068e+00]
  HOMO = -0.242974095886914  LUMO = 0.800863850541275
  mo_energy =
[-1.20326512e+02 -1.23809199e+01 -6.67808342e+00 -6.67808342e+00
 -6.67808342e+00 -1.17951276e+00 -2.42974096e-01 -2.42974096e-01
 -2.42974096e-01  8.00863851e-01  4.76781722e+00  1.94094714e+01
  7.56495263e+01  2.69756157e+02  8.97651835e+02  3.15038607e+03
  1.26299825e+04  4.12266852e+04  1.05254631e+05  2.30427591e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6808125959952  E_coul = 198.69028882406346
cycle= 6 E= -507.990523771932  delta_E= -1.31e-11  |g|= 8.56e-08  |ddm|= 2.52e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6808125959952  E_coul = 198.69028882406346
  HOMO = -0.242974136130264  LUMO = 0.800863825077568
  mo_energy =
[-1.20326512e+02 -1.23809200e+01 -6.67808350e+00 -6.67808350e+00
 -6.67808350e+00 -1.17951277e+00 -2.42974136e-01 -2.42974136e-01
 -2.42974136e-01  8.00863825e-01  4.76781716e+00  1.94094714e+01
  7.56495262e+01  2.69756157e+02  8.97651835e+02  3.15038607e+03
  1.26299825e+04  4.12266852e+04  1.05254631e+05  2.30427591e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6808124251401  E_coul = 198.6902886532076
Extra cycle  E= -507.990523771932  delta_E= -6.82e-13  |g|= 1.06e-08  |ddm|= 2.14e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912470.91029219
E1 = -706.6808124251401  E_coul = 198.6902886532076
init E= -507.990523771932
    CPU time for initialize scf      5.67 sec, wall time      0.24 sec
  HOMO = -0.242974141746231  LUMO = 0.800863822659739
  mo_energy =
[-1.20326512e+02 -1.23809200e+01 -6.67808351e+00 -6.67808351e+00
 -6.67808351e+00 -1.17951277e+00 -2.42974142e-01 -2.42974142e-01
 -2.42974142e-01  8.00863823e-01  4.76781715e+00  1.94094714e+01
  7.56495262e+01  2.69756157e+02  8.97651835e+02  3.15038607e+03
  1.26299825e+04  4.12266852e+04  1.05254631e+05  2.30427591e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6808123993568  E_coul = 198.6902886274247
cycle= 1 E= -507.990523771932  delta_E= 3.41e-13  |g|= 2.04e-09  |ddm|= 2.8e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.6808123993568  E_coul = 198.6902886274247
  HOMO = -0.242974142558657  LUMO = 0.800863823736136
  mo_energy =
[-1.20326512e+02 -1.23809200e+01 -6.67808351e+00 -6.67808351e+00
 -6.67808351e+00 -1.17951277e+00 -2.42974143e-01 -2.42974143e-01
 -2.42974143e-01  8.00863824e-01  4.76781715e+00  1.94094714e+01
  7.56495262e+01  2.69756157e+02  8.97651835e+02  3.15038607e+03
  1.26299825e+04  4.12266852e+04  1.05254631e+05  2.30427591e+05
  4.56234982e+05  8.45181503e+05  1.52835322e+06  2.85061378e+06
  5.80849229e+06]
E1 = -706.6808123926883  E_coul = 198.69028862075606
Extra cycle  E= -507.990523771932  delta_E= -1.14e-13  |g|= 1.31e-09  |ddm|= 7.04e-09
    CPU time for scf_cycle      6.16 sec, wall time      0.41 sec
exp = [2.18961724e-01 5.55757527e-01 1.63317170e+00 1.17616813e+05
 3.59419090e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231506e+03
 1.83757711e+04 1.44357761e+03 4.17366304e+02 1.47798212e+02
 5.83983734e+01 2.46373231e+01 8.18284614e+00 8.60485971e+00
 4.92816298e-01]
grad_E = [ 2.67671436e-03 -1.55508718e-03  2.10118813e-04  6.05253294e-09
  1.67113102e-05  4.03310282e-11  1.73835948e-10  9.38810754e-10
  3.70911967e-09  1.54883162e-08  8.07980719e-08  5.09265567e-06
  1.97967120e-07 -3.80997268e-05 -9.32036903e-06  1.57759310e-05
 -3.43942390e-05 -2.75314906e-05 -2.60183934e-04  3.84557297e-04
  1.74400742e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.223838396114       1
[INPUT] 0    0    [1    /1   ]  0.572885566787       1
[INPUT] 0    0    [1    /1   ]  1.71857697976        1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.646297792          1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175266        1
[INPUT] 0    0    [1    /1   ]  36754.7014226        1
[INPUT] 0    0    [1    /1   ]  7302.31441923        1
[INPUT] 0    0    [1    /1   ]  18375.7710647        1
[INPUT] 0    0    [1    /1   ]  1443.58247296        1
[INPUT] 0    0    [1    /1   ]  417.366713075        1
[INPUT] 0    0    [1    /1   ]  147.799554502        1
[INPUT] 0    0    [1    /1   ]  58.3931848615        1
[INPUT] 0    0    [1    /1   ]  24.6450378183        1
[INPUT] 0    0    [1    /1   ]  8.24167642088        1
[INPUT] 1    0    [1    /1   ]  8.60440762816        1
[INPUT] 1    0    [1    /1   ]  0.492721161526       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22383839611360332, 1.0]], [0, [0.5728855667872693, 1.0]], [0, [1.7185769797570898, 1.0]], [0, [117616.81288099612, 1.0]], [0, [3.646297792002446, 1.0]], [0, [1176168.1426133963, 1.0]], [0, [588084.0699563154, 1.0]], [0, [294042.0309201157, 1.0]], [0, [147020.99131810298, 1.0]], [0, [73510.41752661235, 1.0]], [0, [36754.7014225692, 1.0]], [0, [7302.314419227497, 1.0]], [0, [18375.771064669367, 1.0]], [0, [1443.5824729552191, 1.0]], [0, [417.3667130748818, 1.0]], [0, [147.7995545018558, 1.0]], [0, [58.393184861460725, 1.0]], [0, [24.645037818320418, 1.0]], [0, [8.241676420883083, 1.0]], [1, [8.604407628157885, 1.0]], [1, [0.49272116152573825, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2238384]
bas 1, expnt(s) = [0.57288557]
bas 2, expnt(s) = [1.71857698]
bas 3, expnt(s) = [117616.812881]
bas 4, expnt(s) = [3.64629779]
bas 5, expnt(s) = [1176168.1426134]
bas 6, expnt(s) = [588084.06995632]
bas 7, expnt(s) = [294042.03092012]
bas 8, expnt(s) = [147020.9913181]
bas 9, expnt(s) = [73510.41752661]
bas 10, expnt(s) = [36754.70142257]
bas 11, expnt(s) = [7302.31441923]
bas 12, expnt(s) = [18375.77106467]
bas 13, expnt(s) = [1443.58247296]
bas 14, expnt(s) = [417.36671307]
bas 15, expnt(s) = [147.7995545]
bas 16, expnt(s) = [58.39318486]
bas 17, expnt(s) = [24.64503782]
bas 18, expnt(s) = [8.24167642]
bas 19, expnt(s) = [8.60440763]
bas 20, expnt(s) = [0.49272116]
CPU time:       618.61
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.23838396e-01 8.22178211e-01 5.72885567e-01 1.66366521e+00
 1.71857698e+00 3.79220465e+00 1.17616813e+05 1.60460108e+04
 3.64629779e+00 6.66659581e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231442e+03 1.99576968e+03
 1.83757711e+04 3.98748629e+03 1.44358247e+03 5.91692718e+02
 4.17366713e+02 2.33293899e+02 1.47799555e+02 1.07095166e+02
 5.83931849e+01 5.33687028e+01 2.46450378e+01 2.79455165e+01
 8.24167642e+00 1.22892872e+01 8.60440763e+00 4.29917985e+01
 4.92721162e-01 1.20430340e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336140575825706
cond(S) = 912500.5664242383
E1 = -689.5959975738298  E_coul = 184.97116286407478
init E= -504.624834709755
    CPU time for initialize scf      1.39 sec, wall time      0.10 sec
  HOMO = -0.672203366724417  LUMO = 0.501191021060671
  mo_energy =
[-1.21709726e+02 -1.33862629e+01 -7.62361414e+00 -7.62361414e+00
 -7.62361414e+00 -1.65765779e+00 -6.72203367e-01 -6.72203367e-01
 -6.72203367e-01  5.01191021e-01  4.42883047e+00  1.91568061e+01
  7.53689918e+01  2.69327659e+02  8.97126769e+02  3.14985566e+03
  1.26294902e+04  4.12262176e+04  1.05254177e+05  2.30427145e+05
  4.56234542e+05  8.45181067e+05  1.52835278e+06  2.85061334e+06
  5.80849185e+06]
E1 = -707.7551597584308  E_coul = 199.78271898101752
cycle= 1 E= -507.972440777413  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.48 sec, wall time      0.03 sec
diis-norm(errvec)=0.757126
diis-c [-0.57323974  1.        ]
  HOMO = -0.21764454664355  LUMO = 0.838526388524791
  mo_energy =
[-1.20200097e+02 -1.23046333e+01 -6.59394706e+00 -6.59394706e+00
 -6.59394706e+00 -1.16336484e+00 -2.17644547e-01 -2.17644547e-01
 -2.17644547e-01  8.38526389e-01  5.02778731e+00  2.00769896e+01
  7.66337258e+01  2.70780629e+02  8.98618596e+02  3.15128801e+03
  1.26308160e+04  4.12274763e+04  1.05255399e+05  2.30428343e+05
  4.56235722e+05  8.45182234e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.7997889323211  E_coul = 198.80953230920116
cycle= 2 E= -507.99025662312  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.389
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0352097
diis-c [-0.00123356 -0.00329317  1.00329317]
  HOMO = -0.239847945387289  LUMO = 0.835226174882948
  mo_energy =
[-1.20315160e+02 -1.23724915e+01 -6.66907730e+00 -6.66907730e+00
 -6.66907730e+00 -1.17765670e+00 -2.39847945e-01 -2.39847945e-01
 -2.39847945e-01  8.35226175e-01  5.00175009e+00  2.00221516e+01
  7.65504343e+01  2.70675803e+02  8.98497845e+02  3.15115292e+03
  1.26306707e+04  4.12273271e+04  1.05255248e+05  2.30428191e+05
  4.56235570e+05  8.45182081e+05  1.52835378e+06  2.85061433e+06
  5.80849284e+06]
E1 = -706.6908294957694  E_coul = 198.70030829214042
cycle= 3 E= -507.990521203629  delta_E= -0.000265  |g|= 0.00437  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00391102
diis-c [-3.35094611e-06  1.05284084e-04 -1.09263207e-01  1.10915792e+00]
  HOMO = -0.243016748149551  LUMO = 0.834533662856525
  mo_energy =
[-1.20326913e+02 -1.23810703e+01 -6.67813648e+00 -6.67813648e+00
 -6.67813648e+00 -1.17957838e+00 -2.43016748e-01 -2.43016748e-01
 -2.43016748e-01  8.34533663e-01  4.99782415e+00  2.00149808e+01
  7.65408288e+01  2.70664716e+02  8.98485857e+02  3.15114024e+03
  1.26306576e+04  4.12273138e+04  1.05255235e+05  2.30428178e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.6753605112317  E_coul = 198.6848341126052
cycle= 4 E= -507.990526398627  delta_E= -5.19e-06  |g|= 0.000236  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000175012
diis-c [-6.91625248e-10 -9.72657458e-06  6.94029945e-03 -9.69403766e-02
  1.09000980e+00]
  HOMO = -0.243163751036597  LUMO = 0.834491848002139
  mo_energy =
[-1.20327238e+02 -1.23813975e+01 -6.67845823e+00 -6.67845823e+00
 -6.67845823e+00 -1.17966767e+00 -2.43163751e-01 -2.43163751e-01
 -2.43163751e-01  8.34491848e-01  4.99763355e+00  2.00146933e+01
  7.65405089e+01  2.70664392e+02  8.98485532e+02  3.15113991e+03
  1.26306572e+04  4.12273135e+04  1.05255234e+05  2.30428177e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.6746468235971  E_coul = 198.68412041011112
cycle= 5 E= -507.990526413486  delta_E= -1.49e-08  |g|= 6.96e-06  |ddm|= 0.000712
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.0501e-06
diis-c [-1.08120599e-12  6.63040531e-07 -6.14362586e-04  8.17969263e-03
 -9.92071612e-02  1.09164117e+00]
  HOMO = -0.243166831492485  LUMO = 0.834491003680941
  mo_energy =
[-1.20327244e+02 -1.23814033e+01 -6.67846415e+00 -6.67846415e+00
 -6.67846415e+00 -1.17966978e+00 -2.43166831e-01 -2.43166831e-01
 -2.43166831e-01  8.34491004e-01  4.99762946e+00  2.00146879e+01
  7.65405028e+01  2.70664385e+02  8.98485525e+02  3.15113990e+03
  1.26306572e+04  4.12273135e+04  1.05255234e+05  2.30428177e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.6746310232097  E_coul = 198.68410460971361
cycle= 6 E= -507.990526413496  delta_E= -1.02e-11  |g|= 8.99e-08  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6746310232097  E_coul = 198.68410460971361
  HOMO = -0.243166873269435  LUMO = 0.834490978456806
  mo_energy =
[-1.20327244e+02 -1.23814034e+01 -6.67846423e+00 -6.67846423e+00
 -6.67846423e+00 -1.17966980e+00 -2.43166873e-01 -2.43166873e-01
 -2.43166873e-01  8.34490978e-01  4.99762940e+00  2.00146878e+01
  7.65405027e+01  2.70664385e+02  8.98485525e+02  3.15113990e+03
  1.26306572e+04  4.12273135e+04  1.05255234e+05  2.30428177e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.674630844067  E_coul = 198.68410443057059
Extra cycle  E= -507.990526413496  delta_E= -2.84e-13  |g|= 1.21e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      2.07 sec, wall time      0.32 sec
exp = [2.23838396e-01 5.72885567e-01 1.71857698e+00 1.17616813e+05
 3.64629779e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231442e+03
 1.83757711e+04 1.44358247e+03 4.17366713e+02 1.47799555e+02
 5.83931849e+01 2.46450378e+01 8.24167642e+00 8.60440763e+00
 4.92721162e-01]
E = -507.9905264134964
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.223838396114       1
[INPUT] 0    0    [1    /1   ]  0.572885566787       1
[INPUT] 0    0    [1    /1   ]  1.71857697976        1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.646297792          1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175266        1
[INPUT] 0    0    [1    /1   ]  36754.7014226        1
[INPUT] 0    0    [1    /1   ]  7302.31441923        1
[INPUT] 0    0    [1    /1   ]  18375.7710647        1
[INPUT] 0    0    [1    /1   ]  1443.58247296        1
[INPUT] 0    0    [1    /1   ]  417.366713075        1
[INPUT] 0    0    [1    /1   ]  147.799554502        1
[INPUT] 0    0    [1    /1   ]  58.3931848615        1
[INPUT] 0    0    [1    /1   ]  24.6450378183        1
[INPUT] 0    0    [1    /1   ]  8.24167642088        1
[INPUT] 1    0    [1    /1   ]  8.60440762816        1
[INPUT] 1    0    [1    /1   ]  0.492721161526       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22383839611360332, 1.0]], [0, [0.5728855667872693, 1.0]], [0, [1.7185769797570898, 1.0]], [0, [117616.81288099612, 1.0]], [0, [3.646297792002446, 1.0]], [0, [1176168.1426133963, 1.0]], [0, [588084.0699563154, 1.0]], [0, [294042.0309201157, 1.0]], [0, [147020.99131810298, 1.0]], [0, [73510.41752661235, 1.0]], [0, [36754.7014225692, 1.0]], [0, [7302.314419227497, 1.0]], [0, [18375.771064669367, 1.0]], [0, [1443.5824729552191, 1.0]], [0, [417.3667130748818, 1.0]], [0, [147.7995545018558, 1.0]], [0, [58.393184861460725, 1.0]], [0, [24.645037818320418, 1.0]], [0, [8.241676420883083, 1.0]], [1, [8.604407628157885, 1.0]], [1, [0.49272116152573825, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2238384]
bas 1, expnt(s) = [0.57288557]
bas 2, expnt(s) = [1.71857698]
bas 3, expnt(s) = [117616.812881]
bas 4, expnt(s) = [3.64629779]
bas 5, expnt(s) = [1176168.1426134]
bas 6, expnt(s) = [588084.06995632]
bas 7, expnt(s) = [294042.03092012]
bas 8, expnt(s) = [147020.9913181]
bas 9, expnt(s) = [73510.41752661]
bas 10, expnt(s) = [36754.70142257]
bas 11, expnt(s) = [7302.31441923]
bas 12, expnt(s) = [18375.77106467]
bas 13, expnt(s) = [1443.58247296]
bas 14, expnt(s) = [417.36671307]
bas 15, expnt(s) = [147.7995545]
bas 16, expnt(s) = [58.39318486]
bas 17, expnt(s) = [24.64503782]
bas 18, expnt(s) = [8.24167642]
bas 19, expnt(s) = [8.60440763]
bas 20, expnt(s) = [0.49272116]
CPU time:       620.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.23838396e-01 8.22178211e-01 5.72885567e-01 1.66366521e+00
 1.71857698e+00 3.79220465e+00 1.17616813e+05 1.60460108e+04
 3.64629779e+00 6.66659581e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231442e+03 1.99576968e+03
 1.83757711e+04 3.98748629e+03 1.44358247e+03 5.91692718e+02
 4.17366713e+02 2.33293899e+02 1.47799555e+02 1.07095166e+02
 5.83931849e+01 5.33687028e+01 2.46450378e+01 2.79455165e+01
 8.24167642e+00 1.22892872e+01 8.60440763e+00 4.29917985e+01
 4.92721162e-01 1.20430340e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336140575825706
cond(S) = 912500.5664242383
E1 = -689.5959975738298  E_coul = 184.97116286407478
init E= -504.624834709755
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672203366724417  LUMO = 0.501191021060671
  mo_energy =
[-1.21709726e+02 -1.33862629e+01 -7.62361414e+00 -7.62361414e+00
 -7.62361414e+00 -1.65765779e+00 -6.72203367e-01 -6.72203367e-01
 -6.72203367e-01  5.01191021e-01  4.42883047e+00  1.91568061e+01
  7.53689918e+01  2.69327659e+02  8.97126769e+02  3.14985566e+03
  1.26294902e+04  4.12262176e+04  1.05254177e+05  2.30427145e+05
  4.56234542e+05  8.45181067e+05  1.52835278e+06  2.85061334e+06
  5.80849185e+06]
E1 = -707.7551597584308  E_coul = 199.78271898101752
cycle= 1 E= -507.972440777413  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.757126
diis-c [-0.57323974  1.        ]
  HOMO = -0.21764454664355  LUMO = 0.838526388524791
  mo_energy =
[-1.20200097e+02 -1.23046333e+01 -6.59394706e+00 -6.59394706e+00
 -6.59394706e+00 -1.16336484e+00 -2.17644547e-01 -2.17644547e-01
 -2.17644547e-01  8.38526389e-01  5.02778731e+00  2.00769896e+01
  7.66337258e+01  2.70780629e+02  8.98618596e+02  3.15128801e+03
  1.26308160e+04  4.12274763e+04  1.05255399e+05  2.30428343e+05
  4.56235722e+05  8.45182234e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.7997889323211  E_coul = 198.80953230920116
cycle= 2 E= -507.99025662312  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.389
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0352097
diis-c [-0.00123356 -0.00329317  1.00329317]
  HOMO = -0.239847945387289  LUMO = 0.835226174882948
  mo_energy =
[-1.20315160e+02 -1.23724915e+01 -6.66907730e+00 -6.66907730e+00
 -6.66907730e+00 -1.17765670e+00 -2.39847945e-01 -2.39847945e-01
 -2.39847945e-01  8.35226175e-01  5.00175009e+00  2.00221516e+01
  7.65504343e+01  2.70675803e+02  8.98497845e+02  3.15115292e+03
  1.26306707e+04  4.12273271e+04  1.05255248e+05  2.30428191e+05
  4.56235570e+05  8.45182081e+05  1.52835378e+06  2.85061433e+06
  5.80849284e+06]
E1 = -706.6908294957694  E_coul = 198.70030829214042
cycle= 3 E= -507.990521203629  delta_E= -0.000265  |g|= 0.00437  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00391102
diis-c [-3.35094611e-06  1.05284084e-04 -1.09263207e-01  1.10915792e+00]
  HOMO = -0.243016748149551  LUMO = 0.834533662856525
  mo_energy =
[-1.20326913e+02 -1.23810703e+01 -6.67813648e+00 -6.67813648e+00
 -6.67813648e+00 -1.17957838e+00 -2.43016748e-01 -2.43016748e-01
 -2.43016748e-01  8.34533663e-01  4.99782415e+00  2.00149808e+01
  7.65408288e+01  2.70664716e+02  8.98485857e+02  3.15114024e+03
  1.26306576e+04  4.12273138e+04  1.05255235e+05  2.30428178e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.6753605112317  E_coul = 198.6848341126052
cycle= 4 E= -507.990526398627  delta_E= -5.19e-06  |g|= 0.000236  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000175012
diis-c [-6.91625248e-10 -9.72657458e-06  6.94029945e-03 -9.69403766e-02
  1.09000980e+00]
  HOMO = -0.243163751036597  LUMO = 0.834491848002139
  mo_energy =
[-1.20327238e+02 -1.23813975e+01 -6.67845823e+00 -6.67845823e+00
 -6.67845823e+00 -1.17966767e+00 -2.43163751e-01 -2.43163751e-01
 -2.43163751e-01  8.34491848e-01  4.99763355e+00  2.00146933e+01
  7.65405089e+01  2.70664392e+02  8.98485532e+02  3.15113991e+03
  1.26306572e+04  4.12273135e+04  1.05255234e+05  2.30428177e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.6746468235971  E_coul = 198.68412041011112
cycle= 5 E= -507.990526413486  delta_E= -1.49e-08  |g|= 6.96e-06  |ddm|= 0.000712
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.0501e-06
diis-c [-1.08120599e-12  6.63040531e-07 -6.14362586e-04  8.17969263e-03
 -9.92071612e-02  1.09164117e+00]
  HOMO = -0.243166831492485  LUMO = 0.834491003680941
  mo_energy =
[-1.20327244e+02 -1.23814033e+01 -6.67846415e+00 -6.67846415e+00
 -6.67846415e+00 -1.17966978e+00 -2.43166831e-01 -2.43166831e-01
 -2.43166831e-01  8.34491004e-01  4.99762946e+00  2.00146879e+01
  7.65405028e+01  2.70664385e+02  8.98485525e+02  3.15113990e+03
  1.26306572e+04  4.12273135e+04  1.05255234e+05  2.30428177e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.6746310232097  E_coul = 198.68410460971361
cycle= 6 E= -507.990526413496  delta_E= -1.02e-11  |g|= 8.99e-08  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6746310232097  E_coul = 198.68410460971361
  HOMO = -0.243166873269435  LUMO = 0.834490978456806
  mo_energy =
[-1.20327244e+02 -1.23814034e+01 -6.67846423e+00 -6.67846423e+00
 -6.67846423e+00 -1.17966980e+00 -2.43166873e-01 -2.43166873e-01
 -2.43166873e-01  8.34490978e-01  4.99762940e+00  2.00146878e+01
  7.65405027e+01  2.70664385e+02  8.98485525e+02  3.15113990e+03
  1.26306572e+04  4.12273135e+04  1.05255234e+05  2.30428177e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.674630844067  E_coul = 198.68410443057059
Extra cycle  E= -507.990526413496  delta_E= -2.84e-13  |g|= 1.21e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912500.5664242383
E1 = -706.674630844067  E_coul = 198.68410443057059
init E= -507.990526413496
    CPU time for initialize scf      6.29 sec, wall time      0.28 sec
  HOMO = -0.24316687915123  LUMO = 0.834490974385039
  mo_energy =
[-1.20327244e+02 -1.23814034e+01 -6.67846425e+00 -6.67846425e+00
 -6.67846425e+00 -1.17966980e+00 -2.43166879e-01 -2.43166879e-01
 -2.43166879e-01  8.34490974e-01  4.99762939e+00  2.00146878e+01
  7.65405027e+01  2.70664385e+02  8.98485525e+02  3.15113990e+03
  1.26306572e+04  4.12273135e+04  1.05255234e+05  2.30428177e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.6746308171095  E_coul = 198.68410440361325
cycle= 1 E= -507.990526413496  delta_E= 1.71e-13  |g|= 3.1e-09  |ddm|= 2.89e-08
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -706.6746308171095  E_coul = 198.68410440361325
  HOMO = -0.243166879988847  LUMO = 0.834490976082279
  mo_energy =
[-1.20327244e+02 -1.23814034e+01 -6.67846425e+00 -6.67846425e+00
 -6.67846425e+00 -1.17966980e+00 -2.43166880e-01 -2.43166880e-01
 -2.43166880e-01  8.34490976e-01  4.99762939e+00  2.00146878e+01
  7.65405027e+01  2.70664385e+02  8.98485525e+02  3.15113990e+03
  1.26306572e+04  4.12273135e+04  1.05255234e+05  2.30428177e+05
  4.56235556e+05  8.45182068e+05  1.52835377e+06  2.85061432e+06
  5.80849282e+06]
E1 = -706.6746308096596  E_coul = 198.68410439616318
Extra cycle  E= -507.990526413496  delta_E= -1.14e-13  |g|= 1.36e-09  |ddm|= 6.78e-09
    CPU time for scf_cycle      6.46 sec, wall time      0.45 sec
exp = [2.23838396e-01 5.72885567e-01 1.71857698e+00 1.17616813e+05
 3.64629779e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231442e+03
 1.83757711e+04 1.44358247e+03 4.17366713e+02 1.47799555e+02
 5.83931849e+01 2.46450378e+01 8.24167642e+00 8.60440763e+00
 4.92721162e-01]
grad_E = [ 7.25945588e-04 -3.58224567e-05  2.83695715e-04  6.05013438e-09
 -2.19702229e-04  4.03040860e-11  1.73757187e-10  9.38443055e-10
  3.70763386e-09  1.54820288e-08  8.07677625e-08  5.09072127e-06
  1.97867580e-07 -3.80178005e-05 -1.00705792e-05  1.92487553e-05
 -4.53159580e-05 -1.80756689e-05 -1.69542616e-04  1.09694321e-04
 -1.05671698e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22051781122        1
[INPUT] 0    0    [1    /1   ]  0.565253668396       1
[INPUT] 0    0    [1    /1   ]  1.69198005061        1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.63367091811        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175272        1
[INPUT] 0    0    [1    /1   ]  36754.7014254        1
[INPUT] 0    0    [1    /1   ]  7302.31459723        1
[INPUT] 0    0    [1    /1   ]  18375.7710716        1
[INPUT] 0    0    [1    /1   ]  1443.58112126        1
[INPUT] 0    0    [1    /1   ]  417.366607223        1
[INPUT] 0    0    [1    /1   ]  147.799148526        1
[INPUT] 0    0    [1    /1   ]  58.3947236722        1
[INPUT] 0    0    [1    /1   ]  24.6428614005        1
[INPUT] 0    0    [1    /1   ]  8.22463933513        1
[INPUT] 1    0    [1    /1   ]  8.60431928771        1
[INPUT] 1    0    [1    /1   ]  0.492744673412       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22051781122036818, 1.0]], [0, [0.565253668395662, 1.0]], [0, [1.6919800506110545, 1.0]], [0, [117616.8128812077, 1.0]], [0, [3.633670918109563, 1.0]], [0, [1176168.1426133977, 1.0]], [0, [588084.0699563215, 1.0]], [0, [294042.03092014854, 1.0]], [0, [147020.99131823264, 1.0]], [0, [73510.41752715384, 1.0]], [0, [36754.70142539328, 1.0]], [0, [7302.314597233417, 1.0]], [0, [18375.77107159646, 1.0]], [0, [1443.581121262675, 1.0]], [0, [417.36660722312917, 1.0]], [0, [147.79914852557548, 1.0]], [0, [58.394723672166215, 1.0]], [0, [24.64286140050377, 1.0]], [0, [8.224639335125193, 1.0]], [1, [8.604319287709089, 1.0]], [1, [0.49274467341196226, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22051781]
bas 1, expnt(s) = [0.56525367]
bas 2, expnt(s) = [1.69198005]
bas 3, expnt(s) = [117616.81288121]
bas 4, expnt(s) = [3.63367092]
bas 5, expnt(s) = [1176168.1426134]
bas 6, expnt(s) = [588084.06995632]
bas 7, expnt(s) = [294042.03092015]
bas 8, expnt(s) = [147020.99131823]
bas 9, expnt(s) = [73510.41752715]
bas 10, expnt(s) = [36754.70142539]
bas 11, expnt(s) = [7302.31459723]
bas 12, expnt(s) = [18375.7710716]
bas 13, expnt(s) = [1443.58112126]
bas 14, expnt(s) = [417.36660722]
bas 15, expnt(s) = [147.79914853]
bas 16, expnt(s) = [58.39472367]
bas 17, expnt(s) = [24.6428614]
bas 18, expnt(s) = [8.22463934]
bas 19, expnt(s) = [8.60431929]
bas 20, expnt(s) = [0.49274467]
CPU time:       635.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20517811e-01 8.13013541e-01 5.65253668e-01 1.64701505e+00
 1.69198005e+00 3.74810245e+00 1.17616813e+05 1.60460108e+04
 3.63367092e+00 6.64927384e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231460e+03 1.99576972e+03
 1.83757711e+04 3.98748629e+03 1.44358112e+03 5.91692303e+02
 4.17366607e+02 2.33293854e+02 1.47799149e+02 1.07094945e+02
 5.83947237e+01 5.33697576e+01 2.46428614e+01 2.79436656e+01
 8.22463934e+00 1.22702291e+01 8.60431929e+00 4.29912467e+01
 4.92744673e-01 1.20437523e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336125005826617
cond(S) = 912490.5582676904
E1 = -689.5962098986162  E_coul = 184.9715013482733
init E= -504.624708550343
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672175874290253  LUMO = 0.486313876826612
  mo_energy =
[-1.21709746e+02 -1.33862293e+01 -7.62359813e+00 -7.62359813e+00
 -7.62359813e+00 -1.65763140e+00 -6.72175874e-01 -6.72175874e-01
 -6.72175874e-01  4.86313877e-01  4.34410108e+00  1.89604098e+01
  7.50929385e+01  2.69049339e+02  8.96871914e+02  3.14962550e+03
  1.26292844e+04  4.12260262e+04  1.05253993e+05  2.30426967e+05
  4.56234367e+05  8.45180895e+05  1.52835261e+06  2.85061318e+06
  5.80849169e+06]
E1 = -707.7557151747061  E_coul = 199.78328280962214
cycle= 1 E= -507.972432365084  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.757134
diis-c [-0.57325127  1.        ]
  HOMO = -0.217596804892341  LUMO = 0.820648735890252
  mo_energy =
[-1.20200114e+02 -1.23045874e+01 -6.59392193e+00 -6.59392193e+00
 -6.59392193e+00 -1.16332917e+00 -2.17596805e-01 -2.17596805e-01
 -2.17596805e-01  8.20648736e-01  4.93995053e+00  1.98794240e+01
  7.63577272e+01  2.70502396e+02  8.98363768e+02  3.15105785e+03
  1.26306103e+04  4.12272848e+04  1.05255215e+05  2.30428164e+05
  4.56235547e+05  8.45182062e+05  1.52835377e+06  2.85061432e+06
  5.80849283e+06]
E1 = -706.7997869884871  E_coul = 198.80952975428568
cycle= 2 E= -507.990257234201  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.387
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0354475
diis-c [-0.00124988 -0.00342173  1.00342173]
  HOMO = -0.239824942694416  LUMO = 0.817454641687581
  mo_energy =
[-1.20315237e+02 -1.23724940e+01 -6.66910186e+00 -6.66910186e+00
 -6.66910186e+00 -1.17763902e+00 -2.39824943e-01 -2.39824943e-01
 -2.39824943e-01  8.17454642e-01  4.91420581e+00  1.98246717e+01
  7.62743957e+01  2.70397508e+02  8.98242954e+02  3.15092270e+03
  1.26304649e+04  4.12271356e+04  1.05255064e+05  2.30428012e+05
  4.56235395e+05  8.45181909e+05  1.52835361e+06  2.85061417e+06
  5.80849268e+06]
E1 = -706.690521758669  E_coul = 198.69999862314728
cycle= 3 E= -507.990523135522  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0039575
diis-c [-3.39983278e-06  9.62499051e-05 -1.10019711e-01  1.10992346e+00]
  HOMO = -0.243006160603302  LUMO = 0.816776513946365
  mo_energy =
[-1.20327010e+02 -1.23810946e+01 -6.67818256e+00 -6.67818256e+00
 -6.67818256e+00 -1.17956878e+00 -2.43006161e-01 -2.43006161e-01
 -2.43006161e-01  8.16776514e-01  4.91030494e+00  1.98174936e+01
  7.62647694e+01  2.70386399e+02  8.98230944e+02  3.15090999e+03
  1.26304517e+04  4.12271222e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181896e+05  1.52835360e+06  2.85061416e+06
  5.80849266e+06]
E1 = -706.6749592090491  E_coul = 198.6844308125972
cycle= 4 E= -507.990528396452  delta_E= -5.26e-06  |g|= 0.000237  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176416
diis-c [-7.46706829e-10 -9.89089464e-06  6.98307249e-03 -9.68627525e-02
  1.08988957e+00]
  HOMO = -0.24315300023023  LUMO = 0.816735381084358
  mo_energy =
[-1.20327331e+02 -1.23814193e+01 -6.67850148e+00 -6.67850148e+00
 -6.67850148e+00 -1.17965803e+00 -2.43153000e-01 -2.43153000e-01
 -2.43153000e-01  8.16735381e-01  4.91011591e+00  1.98172081e+01
  7.62644527e+01  2.70386079e+02  8.98230624e+02  3.15090967e+03
  1.26304514e+04  4.12271219e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181895e+05  1.52835360e+06  2.85061415e+06
  5.80849266e+06]
E1 = -706.674243932213  E_coul = 198.68371552061433
cycle= 5 E= -507.990528411599  delta_E= -1.51e-08  |g|= 7.25e-06  |ddm|= 0.000721
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.20786e-06
diis-c [-1.12908863e-12  6.78001835e-07 -6.31700177e-04  8.35115519e-03
 -1.01537498e-01  1.09381737e+00]
  HOMO = -0.243156185516117  LUMO = 0.816734518932775
  mo_energy =
[-1.20327337e+02 -1.23814253e+01 -6.67850755e+00 -6.67850755e+00
 -6.67850755e+00 -1.17966021e+00 -2.43156186e-01 -2.43156186e-01
 -2.43156186e-01  8.16734519e-01  4.91011170e+00  1.98172025e+01
  7.62644465e+01  2.70386073e+02  8.98230616e+02  3.15090966e+03
  1.26304514e+04  4.12271219e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181895e+05  1.52835360e+06  2.85061415e+06
  5.80849266e+06]
E1 = -706.6742274934477  E_coul = 198.68369908183712
cycle= 6 E= -507.990528411611  delta_E= -1.19e-11  |g|= 8.74e-08  |ddm|= 2.33e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6742274934477  E_coul = 198.68369908183712
  HOMO = -0.243156226326216  LUMO = 0.816734492770629
  mo_energy =
[-1.20327337e+02 -1.23814254e+01 -6.67850763e+00 -6.67850763e+00
 -6.67850763e+00 -1.17966023e+00 -2.43156226e-01 -2.43156226e-01
 -2.43156226e-01  8.16734493e-01  4.91011164e+00  1.98172024e+01
  7.62644464e+01  2.70386073e+02  8.98230616e+02  3.15090966e+03
  1.26304514e+04  4.12271219e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181895e+05  1.52835360e+06  2.85061415e+06
  5.80849266e+06]
E1 = -706.6742273226196  E_coul = 198.68369891100883
Extra cycle  E= -507.990528411611  delta_E= -1.71e-13  |g|= 1.22e-08  |ddm|= 2.13e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.20517811e-01 5.65253668e-01 1.69198005e+00 1.17616813e+05
 3.63367092e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231460e+03
 1.83757711e+04 1.44358112e+03 4.17366607e+02 1.47799149e+02
 5.83947237e+01 2.46428614e+01 8.22463934e+00 8.60431929e+00
 4.92744673e-01]
E = -507.99052841161074
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22051781122        1
[INPUT] 0    0    [1    /1   ]  0.565253668396       1
[INPUT] 0    0    [1    /1   ]  1.69198005061        1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.63367091811        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175272        1
[INPUT] 0    0    [1    /1   ]  36754.7014254        1
[INPUT] 0    0    [1    /1   ]  7302.31459723        1
[INPUT] 0    0    [1    /1   ]  18375.7710716        1
[INPUT] 0    0    [1    /1   ]  1443.58112126        1
[INPUT] 0    0    [1    /1   ]  417.366607223        1
[INPUT] 0    0    [1    /1   ]  147.799148526        1
[INPUT] 0    0    [1    /1   ]  58.3947236722        1
[INPUT] 0    0    [1    /1   ]  24.6428614005        1
[INPUT] 0    0    [1    /1   ]  8.22463933513        1
[INPUT] 1    0    [1    /1   ]  8.60431928771        1
[INPUT] 1    0    [1    /1   ]  0.492744673412       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22051781122036818, 1.0]], [0, [0.565253668395662, 1.0]], [0, [1.6919800506110545, 1.0]], [0, [117616.8128812077, 1.0]], [0, [3.633670918109563, 1.0]], [0, [1176168.1426133977, 1.0]], [0, [588084.0699563215, 1.0]], [0, [294042.03092014854, 1.0]], [0, [147020.99131823264, 1.0]], [0, [73510.41752715384, 1.0]], [0, [36754.70142539328, 1.0]], [0, [7302.314597233417, 1.0]], [0, [18375.77107159646, 1.0]], [0, [1443.581121262675, 1.0]], [0, [417.36660722312917, 1.0]], [0, [147.79914852557548, 1.0]], [0, [58.394723672166215, 1.0]], [0, [24.64286140050377, 1.0]], [0, [8.224639335125193, 1.0]], [1, [8.604319287709089, 1.0]], [1, [0.49274467341196226, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22051781]
bas 1, expnt(s) = [0.56525367]
bas 2, expnt(s) = [1.69198005]
bas 3, expnt(s) = [117616.81288121]
bas 4, expnt(s) = [3.63367092]
bas 5, expnt(s) = [1176168.1426134]
bas 6, expnt(s) = [588084.06995632]
bas 7, expnt(s) = [294042.03092015]
bas 8, expnt(s) = [147020.99131823]
bas 9, expnt(s) = [73510.41752715]
bas 10, expnt(s) = [36754.70142539]
bas 11, expnt(s) = [7302.31459723]
bas 12, expnt(s) = [18375.7710716]
bas 13, expnt(s) = [1443.58112126]
bas 14, expnt(s) = [417.36660722]
bas 15, expnt(s) = [147.79914853]
bas 16, expnt(s) = [58.39472367]
bas 17, expnt(s) = [24.6428614]
bas 18, expnt(s) = [8.22463934]
bas 19, expnt(s) = [8.60431929]
bas 20, expnt(s) = [0.49274467]
CPU time:       637.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20517811e-01 8.13013541e-01 5.65253668e-01 1.64701505e+00
 1.69198005e+00 3.74810245e+00 1.17616813e+05 1.60460108e+04
 3.63367092e+00 6.64927384e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231460e+03 1.99576972e+03
 1.83757711e+04 3.98748629e+03 1.44358112e+03 5.91692303e+02
 4.17366607e+02 2.33293854e+02 1.47799149e+02 1.07094945e+02
 5.83947237e+01 5.33697576e+01 2.46428614e+01 2.79436656e+01
 8.22463934e+00 1.22702291e+01 8.60431929e+00 4.29912467e+01
 4.92744673e-01 1.20437523e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336125005826617
cond(S) = 912490.5582676904
E1 = -689.5962098986162  E_coul = 184.9715013482733
init E= -504.624708550343
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672175874290253  LUMO = 0.486313876826612
  mo_energy =
[-1.21709746e+02 -1.33862293e+01 -7.62359813e+00 -7.62359813e+00
 -7.62359813e+00 -1.65763140e+00 -6.72175874e-01 -6.72175874e-01
 -6.72175874e-01  4.86313877e-01  4.34410108e+00  1.89604098e+01
  7.50929385e+01  2.69049339e+02  8.96871914e+02  3.14962550e+03
  1.26292844e+04  4.12260262e+04  1.05253993e+05  2.30426967e+05
  4.56234367e+05  8.45180895e+05  1.52835261e+06  2.85061318e+06
  5.80849169e+06]
E1 = -707.7557151747061  E_coul = 199.78328280962214
cycle= 1 E= -507.972432365084  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.757134
diis-c [-0.57325127  1.        ]
  HOMO = -0.217596804892341  LUMO = 0.820648735890252
  mo_energy =
[-1.20200114e+02 -1.23045874e+01 -6.59392193e+00 -6.59392193e+00
 -6.59392193e+00 -1.16332917e+00 -2.17596805e-01 -2.17596805e-01
 -2.17596805e-01  8.20648736e-01  4.93995053e+00  1.98794240e+01
  7.63577272e+01  2.70502396e+02  8.98363768e+02  3.15105785e+03
  1.26306103e+04  4.12272848e+04  1.05255215e+05  2.30428164e+05
  4.56235547e+05  8.45182062e+05  1.52835377e+06  2.85061432e+06
  5.80849283e+06]
E1 = -706.7997869884871  E_coul = 198.80952975428568
cycle= 2 E= -507.990257234201  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.387
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0354475
diis-c [-0.00124988 -0.00342173  1.00342173]
  HOMO = -0.239824942694416  LUMO = 0.817454641687581
  mo_energy =
[-1.20315237e+02 -1.23724940e+01 -6.66910186e+00 -6.66910186e+00
 -6.66910186e+00 -1.17763902e+00 -2.39824943e-01 -2.39824943e-01
 -2.39824943e-01  8.17454642e-01  4.91420581e+00  1.98246717e+01
  7.62743957e+01  2.70397508e+02  8.98242954e+02  3.15092270e+03
  1.26304649e+04  4.12271356e+04  1.05255064e+05  2.30428012e+05
  4.56235395e+05  8.45181909e+05  1.52835361e+06  2.85061417e+06
  5.80849268e+06]
E1 = -706.690521758669  E_coul = 198.69999862314728
cycle= 3 E= -507.990523135522  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0039575
diis-c [-3.39983278e-06  9.62499051e-05 -1.10019711e-01  1.10992346e+00]
  HOMO = -0.243006160603302  LUMO = 0.816776513946365
  mo_energy =
[-1.20327010e+02 -1.23810946e+01 -6.67818256e+00 -6.67818256e+00
 -6.67818256e+00 -1.17956878e+00 -2.43006161e-01 -2.43006161e-01
 -2.43006161e-01  8.16776514e-01  4.91030494e+00  1.98174936e+01
  7.62647694e+01  2.70386399e+02  8.98230944e+02  3.15090999e+03
  1.26304517e+04  4.12271222e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181896e+05  1.52835360e+06  2.85061416e+06
  5.80849266e+06]
E1 = -706.6749592090491  E_coul = 198.6844308125972
cycle= 4 E= -507.990528396452  delta_E= -5.26e-06  |g|= 0.000237  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176416
diis-c [-7.46706829e-10 -9.89089464e-06  6.98307249e-03 -9.68627525e-02
  1.08988957e+00]
  HOMO = -0.24315300023023  LUMO = 0.816735381084358
  mo_energy =
[-1.20327331e+02 -1.23814193e+01 -6.67850148e+00 -6.67850148e+00
 -6.67850148e+00 -1.17965803e+00 -2.43153000e-01 -2.43153000e-01
 -2.43153000e-01  8.16735381e-01  4.91011591e+00  1.98172081e+01
  7.62644527e+01  2.70386079e+02  8.98230624e+02  3.15090967e+03
  1.26304514e+04  4.12271219e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181895e+05  1.52835360e+06  2.85061415e+06
  5.80849266e+06]
E1 = -706.674243932213  E_coul = 198.68371552061433
cycle= 5 E= -507.990528411599  delta_E= -1.51e-08  |g|= 7.25e-06  |ddm|= 0.000721
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.20786e-06
diis-c [-1.12908863e-12  6.78001835e-07 -6.31700177e-04  8.35115519e-03
 -1.01537498e-01  1.09381737e+00]
  HOMO = -0.243156185516117  LUMO = 0.816734518932775
  mo_energy =
[-1.20327337e+02 -1.23814253e+01 -6.67850755e+00 -6.67850755e+00
 -6.67850755e+00 -1.17966021e+00 -2.43156186e-01 -2.43156186e-01
 -2.43156186e-01  8.16734519e-01  4.91011170e+00  1.98172025e+01
  7.62644465e+01  2.70386073e+02  8.98230616e+02  3.15090966e+03
  1.26304514e+04  4.12271219e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181895e+05  1.52835360e+06  2.85061415e+06
  5.80849266e+06]
E1 = -706.6742274934477  E_coul = 198.68369908183712
cycle= 6 E= -507.990528411611  delta_E= -1.19e-11  |g|= 8.74e-08  |ddm|= 2.33e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6742274934477  E_coul = 198.68369908183712
  HOMO = -0.243156226326216  LUMO = 0.816734492770629
  mo_energy =
[-1.20327337e+02 -1.23814254e+01 -6.67850763e+00 -6.67850763e+00
 -6.67850763e+00 -1.17966023e+00 -2.43156226e-01 -2.43156226e-01
 -2.43156226e-01  8.16734493e-01  4.91011164e+00  1.98172024e+01
  7.62644464e+01  2.70386073e+02  8.98230616e+02  3.15090966e+03
  1.26304514e+04  4.12271219e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181895e+05  1.52835360e+06  2.85061415e+06
  5.80849266e+06]
E1 = -706.6742273226196  E_coul = 198.68369891100883
Extra cycle  E= -507.990528411611  delta_E= -1.71e-13  |g|= 1.22e-08  |ddm|= 2.13e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912490.5582676904
E1 = -706.6742273226196  E_coul = 198.68369891100883
init E= -507.990528411611
    CPU time for initialize scf      5.73 sec, wall time      0.24 sec
  HOMO = -0.24315623195166  LUMO = 0.816734493474682
  mo_energy =
[-1.20327337e+02 -1.23814254e+01 -6.67850764e+00 -6.67850764e+00
 -6.67850764e+00 -1.17966023e+00 -2.43156232e-01 -2.43156232e-01
 -2.43156232e-01  8.16734493e-01  4.91011163e+00  1.98172024e+01
  7.62644464e+01  2.70386073e+02  8.98230616e+02  3.15090966e+03
  1.26304514e+04  4.12271219e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181895e+05  1.52835360e+06  2.85061415e+06
  5.80849266e+06]
E1 = -706.674227293857  E_coul = 198.68369888224697
cycle= 1 E= -507.99052841161  delta_E= 6.82e-13  |g|= 3.88e-09  |ddm|= 3.16e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.674227293857  E_coul = 198.68369888224697
  HOMO = -0.243156232879757  LUMO = 0.816734493503351
  mo_energy =
[-1.20327337e+02 -1.23814254e+01 -6.67850764e+00 -6.67850764e+00
 -6.67850764e+00 -1.17966023e+00 -2.43156233e-01 -2.43156233e-01
 -2.43156233e-01  8.16734494e-01  4.91011163e+00  1.98172024e+01
  7.62644464e+01  2.70386073e+02  8.98230616e+02  3.15090966e+03
  1.26304514e+04  4.12271219e+04  1.05255051e+05  2.30427999e+05
  4.56235381e+05  8.45181895e+05  1.52835360e+06  2.85061415e+06
  5.80849266e+06]
E1 = -706.674227285197  E_coul = 198.68369887358654
Extra cycle  E= -507.990528411611  delta_E= -4.55e-13  |g|= 1.21e-09  |ddm|= 7.77e-09
    CPU time for scf_cycle      6.22 sec, wall time      0.41 sec
exp = [2.20517811e-01 5.65253668e-01 1.69198005e+00 1.17616813e+05
 3.63367092e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231460e+03
 1.83757711e+04 1.44358112e+03 4.17366607e+02 1.47799149e+02
 5.83947237e+01 2.46428614e+01 8.22463934e+00 8.60431929e+00
 4.92744673e-01]
grad_E = [-3.04312986e-04 -6.34260309e-05  2.49086485e-04  6.05097066e-09
 -1.18937561e-04  4.03134696e-11  1.73784643e-10  9.38571251e-10
  3.70815190e-09  1.54842210e-08  8.07783313e-08  5.09139709e-06
  1.97902281e-07 -3.80467417e-05 -9.80034154e-06  1.79526320e-05
 -4.09443468e-05 -2.24280681e-05 -2.12067674e-04  7.28552165e-06
 -3.65737717e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.220847389156       1
[INPUT] 0    0    [1    /1   ]  0.565865946048       1
[INPUT] 0    0    [1    /1   ]  1.70110596796        1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.64324969244        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175269        1
[INPUT] 0    0    [1    /1   ]  36754.701424         1
[INPUT] 0    0    [1    /1   ]  7302.31450759        1
[INPUT] 0    0    [1    /1   ]  18375.7710681        1
[INPUT] 0    0    [1    /1   ]  1443.58180071        1
[INPUT] 0    0    [1    /1   ]  417.366674467        1
[INPUT] 0    0    [1    /1   ]  147.799291234        1
[INPUT] 0    0    [1    /1   ]  58.3941403001        1
[INPUT] 0    0    [1    /1   ]  24.6438540554        1
[INPUT] 0    0    [1    /1   ]  8.23162325345        1
[INPUT] 1    0    [1    /1   ]  8.60429107797        1
[INPUT] 1    0    [1    /1   ]  0.492746343744       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2208473891564236, 1.0]], [0, [0.5658659460483287, 1.0]], [0, [1.7011059679572447, 1.0]], [0, [117616.81288110116, 1.0]], [0, [3.6432496924370037, 1.0]], [0, [1176168.142613397, 1.0]], [0, [588084.0699563185, 1.0]], [0, [294042.030920132, 1.0]], [0, [147020.99131816733, 1.0]], [0, [73510.41752688115, 1.0]], [0, [36754.70142397109, 1.0]], [0, [7302.3145075913735, 1.0]], [0, [18375.771068108512, 1.0]], [0, [1443.58180071132, 1.0]], [0, [417.36667446743184, 1.0]], [0, [147.79929123390102, 1.0]], [0, [58.394140300075556, 1.0]], [0, [24.643854055446827, 1.0]], [0, [8.2316232534509, 1.0]], [1, [8.604291077970936, 1.0]], [1, [0.4927463437438886, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22084739]
bas 1, expnt(s) = [0.56586595]
bas 2, expnt(s) = [1.70110597]
bas 3, expnt(s) = [117616.8128811]
bas 4, expnt(s) = [3.64324969]
bas 5, expnt(s) = [1176168.1426134]
bas 6, expnt(s) = [588084.06995632]
bas 7, expnt(s) = [294042.03092013]
bas 8, expnt(s) = [147020.99131817]
bas 9, expnt(s) = [73510.41752688]
bas 10, expnt(s) = [36754.70142397]
bas 11, expnt(s) = [7302.31450759]
bas 12, expnt(s) = [18375.77106811]
bas 13, expnt(s) = [1443.58180071]
bas 14, expnt(s) = [417.36667447]
bas 15, expnt(s) = [147.79929123]
bas 16, expnt(s) = [58.3941403]
bas 17, expnt(s) = [24.64385406]
bas 18, expnt(s) = [8.23162325]
bas 19, expnt(s) = [8.60429108]
bas 20, expnt(s) = [0.49274634]
CPU time:       652.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20847389e-01 8.13924697e-01 5.65865946e-01 1.64835289e+00
 1.70110597e+00 3.76325416e+00 1.17616813e+05 1.60460108e+04
 3.64324969e+00 6.66241570e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231451e+03 1.99576970e+03
 1.83757711e+04 3.98748629e+03 1.44358180e+03 5.91692512e+02
 4.17366674e+02 2.33293883e+02 1.47799291e+02 1.07095023e+02
 5.83941403e+01 5.33693577e+01 2.46438541e+01 2.79445098e+01
 8.23162325e+00 1.22780427e+01 8.60429108e+00 4.29910705e+01
 4.92746344e-01 1.20438033e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33612062391556
cond(S) = 912493.8473927287
E1 = -689.5960278629294  E_coul = 184.97137416194695
init E= -504.624653700982
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672176011122947  LUMO = 0.487946409627901
  mo_energy =
[-1.21709772e+02 -1.33862400e+01 -7.62360785e+00 -7.62360785e+00
 -7.62360785e+00 -1.65763043e+00 -6.72176011e-01 -6.72176011e-01
 -6.72176011e-01  4.87946410e-01  4.36382542e+00  1.90282957e+01
  7.52009595e+01  2.69160973e+02  8.96974713e+02  3.14971862e+03
  1.26293680e+04  4.12261040e+04  1.05254068e+05  2.30427039e+05
  4.56234438e+05  8.45180965e+05  1.52835268e+06  2.85061324e+06
  5.80849176e+06]
E1 = -707.7555993656291  E_coul = 199.78316336700573
cycle= 1 E= -507.972435998623  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.757201
diis-c [-0.5733532  1.       ]
  HOMO = -0.217594236462219  LUMO = 0.82269423865379
  mo_energy =
[-1.20200143e+02 -1.23045980e+01 -6.59393217e+00 -6.59393217e+00
 -6.59393217e+00 -1.16332673e+00 -2.17594236e-01 -2.17594236e-01
 -2.17594236e-01  8.22694239e-01  4.96073933e+00  1.99479472e+01
  7.64657698e+01  2.70614000e+02  8.98466555e+02  3.15115096e+03
  1.26306938e+04  4.12273627e+04  1.05255290e+05  2.30428237e+05
  4.56235618e+05  8.45182132e+05  1.52835384e+06  2.85061439e+06
  5.80849289e+06]
E1 = -706.7998206874304  E_coul = 198.80956291120486
cycle= 2 E= -507.990257776226  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.387
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0353933
diis-c [-0.00124612 -0.00339861  1.00339861]
  HOMO = -0.239816523609994  LUMO = 0.819484296380854
  mo_energy =
[-1.20315250e+02 -1.23724923e+01 -6.66909928e+00 -6.66909928e+00
 -6.66909928e+00 -1.17763242e+00 -2.39816524e-01 -2.39816524e-01
 -2.39816524e-01  8.19484296e-01  4.93490896e+00  1.98931450e+01
  7.63824440e+01  2.70509128e+02  8.98345758e+02  3.15101583e+03
  1.26305485e+04  4.12272134e+04  1.05255139e+05  2.30428085e+05
  4.56235466e+05  8.45181979e+05  1.52835368e+06  2.85061424e+06
  5.80849274e+06]
E1 = -706.6905910354604  E_coul = 198.70006748585945
cycle= 3 E= -507.990523549601  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00394754
diis-c [-3.39198529e-06  9.84202307e-05 -1.09857787e-01  1.10975937e+00]
  HOMO = -0.242996272045461  LUMO = 0.818803826991143
  mo_energy =
[-1.20327021e+02 -1.23810902e+01 -6.67817738e+00 -6.67817738e+00
 -6.67817738e+00 -1.17956123e+00 -2.42996272e-01 -2.42996272e-01
 -2.42996272e-01  8.18803827e-01  4.93099779e+00  1.98859631e+01
  7.63728198e+01  2.70498022e+02  8.98333750e+02  3.15100313e+03
  1.26305353e+04  4.12272001e+04  1.05255126e+05  2.30428072e+05
  4.56235452e+05  8.45181966e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6750372030176  E_coul = 198.68450839747965
cycle= 4 E= -507.990528805538  delta_E= -5.26e-06  |g|= 0.000237  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176398
diis-c [-7.39994460e-10 -9.87456309e-06  6.97920573e-03 -9.69885956e-02
  1.09001926e+00]
  HOMO = -0.243143489662147  LUMO = 0.818762514649329
  mo_energy =
[-1.20327343e+02 -1.23814162e+01 -6.67849766e+00 -6.67849766e+00
 -6.67849766e+00 -1.17965069e+00 -2.43143490e-01 -2.43143490e-01
 -2.43143490e-01  8.18762515e-01  4.93080784e+00  1.98856764e+01
  7.63725016e+01  2.70497700e+02  8.98333428e+02  3.15100281e+03
  1.26305350e+04  4.12271998e+04  1.05255125e+05  2.30428071e+05
  4.56235452e+05  8.45181965e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6743202171448  E_coul = 198.6837913964367
cycle= 5 E= -507.990528820708  delta_E= -1.52e-08  |g|= 7.21e-06  |ddm|= 0.00072
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.18553e-06
diis-c [-1.12057574e-12  6.79205833e-07 -6.29048194e-04  8.33153660e-03
 -1.01156032e-01  1.09345286e+00]
  HOMO = -0.243146661314679  LUMO = 0.818761655156084
  mo_energy =
[-1.20327350e+02 -1.23814222e+01 -6.67850371e+00 -6.67850371e+00
 -6.67850371e+00 -1.17965287e+00 -2.43146661e-01 -2.43146661e-01
 -2.43146661e-01  8.18761655e-01  4.93080364e+00  1.98856709e+01
  7.63724954e+01  2.70497694e+02  8.98333421e+02  3.15100280e+03
  1.26305350e+04  4.12271998e+04  1.05255125e+05  2.30428071e+05
  4.56235452e+05  8.45181965e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6743038573387  E_coul = 198.68377503661947
cycle= 6 E= -507.990528820719  delta_E= -1.12e-11  |g|= 8.74e-08  |ddm|= 2.31e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6743038573387  E_coul = 198.68377503661947
  HOMO = -0.243146702264361  LUMO = 0.818761629825335
  mo_energy =
[-1.20327350e+02 -1.23814223e+01 -6.67850379e+00 -6.67850379e+00
 -6.67850379e+00 -1.17965288e+00 -2.43146702e-01 -2.43146702e-01
 -2.43146702e-01  8.18761630e-01  4.93080358e+00  1.98856708e+01
  7.63724953e+01  2.70497694e+02  8.98333421e+02  3.15100280e+03
  1.26305350e+04  4.12271998e+04  1.05255125e+05  2.30428071e+05
  4.56235452e+05  8.45181965e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6743036825329  E_coul = 198.68377486181333
Extra cycle  E= -507.99052882072  delta_E= -3.41e-13  |g|= 1.14e-08  |ddm|= 2.15e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
exp = [2.20847389e-01 5.65865946e-01 1.70110597e+00 1.17616813e+05
 3.64324969e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231451e+03
 1.83757711e+04 1.44358180e+03 4.17366674e+02 1.47799291e+02
 5.83941403e+01 2.46438541e+01 8.23162325e+00 8.60429108e+00
 4.92746344e-01]
E = -507.9905288207196
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.220847389156       1
[INPUT] 0    0    [1    /1   ]  0.565865946048       1
[INPUT] 0    0    [1    /1   ]  1.70110596796        1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.64324969244        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175269        1
[INPUT] 0    0    [1    /1   ]  36754.701424         1
[INPUT] 0    0    [1    /1   ]  7302.31450759        1
[INPUT] 0    0    [1    /1   ]  18375.7710681        1
[INPUT] 0    0    [1    /1   ]  1443.58180071        1
[INPUT] 0    0    [1    /1   ]  417.366674467        1
[INPUT] 0    0    [1    /1   ]  147.799291234        1
[INPUT] 0    0    [1    /1   ]  58.3941403001        1
[INPUT] 0    0    [1    /1   ]  24.6438540554        1
[INPUT] 0    0    [1    /1   ]  8.23162325345        1
[INPUT] 1    0    [1    /1   ]  8.60429107797        1
[INPUT] 1    0    [1    /1   ]  0.492746343744       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2208473891564236, 1.0]], [0, [0.5658659460483287, 1.0]], [0, [1.7011059679572447, 1.0]], [0, [117616.81288110116, 1.0]], [0, [3.6432496924370037, 1.0]], [0, [1176168.142613397, 1.0]], [0, [588084.0699563185, 1.0]], [0, [294042.030920132, 1.0]], [0, [147020.99131816733, 1.0]], [0, [73510.41752688115, 1.0]], [0, [36754.70142397109, 1.0]], [0, [7302.3145075913735, 1.0]], [0, [18375.771068108512, 1.0]], [0, [1443.58180071132, 1.0]], [0, [417.36667446743184, 1.0]], [0, [147.79929123390102, 1.0]], [0, [58.394140300075556, 1.0]], [0, [24.643854055446827, 1.0]], [0, [8.2316232534509, 1.0]], [1, [8.604291077970936, 1.0]], [1, [0.4927463437438886, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22084739]
bas 1, expnt(s) = [0.56586595]
bas 2, expnt(s) = [1.70110597]
bas 3, expnt(s) = [117616.8128811]
bas 4, expnt(s) = [3.64324969]
bas 5, expnt(s) = [1176168.1426134]
bas 6, expnt(s) = [588084.06995632]
bas 7, expnt(s) = [294042.03092013]
bas 8, expnt(s) = [147020.99131817]
bas 9, expnt(s) = [73510.41752688]
bas 10, expnt(s) = [36754.70142397]
bas 11, expnt(s) = [7302.31450759]
bas 12, expnt(s) = [18375.77106811]
bas 13, expnt(s) = [1443.58180071]
bas 14, expnt(s) = [417.36667447]
bas 15, expnt(s) = [147.79929123]
bas 16, expnt(s) = [58.3941403]
bas 17, expnt(s) = [24.64385406]
bas 18, expnt(s) = [8.23162325]
bas 19, expnt(s) = [8.60429108]
bas 20, expnt(s) = [0.49274634]
CPU time:       653.78
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20847389e-01 8.13924697e-01 5.65865946e-01 1.64835289e+00
 1.70110597e+00 3.76325416e+00 1.17616813e+05 1.60460108e+04
 3.64324969e+00 6.66241570e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231451e+03 1.99576970e+03
 1.83757711e+04 3.98748629e+03 1.44358180e+03 5.91692512e+02
 4.17366674e+02 2.33293883e+02 1.47799291e+02 1.07095023e+02
 5.83941403e+01 5.33693577e+01 2.46438541e+01 2.79445098e+01
 8.23162325e+00 1.22780427e+01 8.60429108e+00 4.29910705e+01
 4.92746344e-01 1.20438033e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33612062391556
cond(S) = 912493.8473927287
E1 = -689.5960278629294  E_coul = 184.97137416194695
init E= -504.624653700982
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672176011122947  LUMO = 0.487946409627901
  mo_energy =
[-1.21709772e+02 -1.33862400e+01 -7.62360785e+00 -7.62360785e+00
 -7.62360785e+00 -1.65763043e+00 -6.72176011e-01 -6.72176011e-01
 -6.72176011e-01  4.87946410e-01  4.36382542e+00  1.90282957e+01
  7.52009595e+01  2.69160973e+02  8.96974713e+02  3.14971862e+03
  1.26293680e+04  4.12261040e+04  1.05254068e+05  2.30427039e+05
  4.56234438e+05  8.45180965e+05  1.52835268e+06  2.85061324e+06
  5.80849176e+06]
E1 = -707.7555993656291  E_coul = 199.78316336700573
cycle= 1 E= -507.972435998623  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.757201
diis-c [-0.5733532  1.       ]
  HOMO = -0.217594236462219  LUMO = 0.82269423865379
  mo_energy =
[-1.20200143e+02 -1.23045980e+01 -6.59393217e+00 -6.59393217e+00
 -6.59393217e+00 -1.16332673e+00 -2.17594236e-01 -2.17594236e-01
 -2.17594236e-01  8.22694239e-01  4.96073933e+00  1.99479472e+01
  7.64657698e+01  2.70614000e+02  8.98466555e+02  3.15115096e+03
  1.26306938e+04  4.12273627e+04  1.05255290e+05  2.30428237e+05
  4.56235618e+05  8.45182132e+05  1.52835384e+06  2.85061439e+06
  5.80849289e+06]
E1 = -706.7998206874304  E_coul = 198.80956291120486
cycle= 2 E= -507.990257776226  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.387
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0353933
diis-c [-0.00124612 -0.00339861  1.00339861]
  HOMO = -0.239816523609994  LUMO = 0.819484296380854
  mo_energy =
[-1.20315250e+02 -1.23724923e+01 -6.66909928e+00 -6.66909928e+00
 -6.66909928e+00 -1.17763242e+00 -2.39816524e-01 -2.39816524e-01
 -2.39816524e-01  8.19484296e-01  4.93490896e+00  1.98931450e+01
  7.63824440e+01  2.70509128e+02  8.98345758e+02  3.15101583e+03
  1.26305485e+04  4.12272134e+04  1.05255139e+05  2.30428085e+05
  4.56235466e+05  8.45181979e+05  1.52835368e+06  2.85061424e+06
  5.80849274e+06]
E1 = -706.6905910354604  E_coul = 198.70006748585945
cycle= 3 E= -507.990523549601  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00394754
diis-c [-3.39198529e-06  9.84202307e-05 -1.09857787e-01  1.10975937e+00]
  HOMO = -0.242996272045461  LUMO = 0.818803826991143
  mo_energy =
[-1.20327021e+02 -1.23810902e+01 -6.67817738e+00 -6.67817738e+00
 -6.67817738e+00 -1.17956123e+00 -2.42996272e-01 -2.42996272e-01
 -2.42996272e-01  8.18803827e-01  4.93099779e+00  1.98859631e+01
  7.63728198e+01  2.70498022e+02  8.98333750e+02  3.15100313e+03
  1.26305353e+04  4.12272001e+04  1.05255126e+05  2.30428072e+05
  4.56235452e+05  8.45181966e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6750372030176  E_coul = 198.68450839747965
cycle= 4 E= -507.990528805538  delta_E= -5.26e-06  |g|= 0.000237  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176398
diis-c [-7.39994460e-10 -9.87456309e-06  6.97920573e-03 -9.69885956e-02
  1.09001926e+00]
  HOMO = -0.243143489662147  LUMO = 0.818762514649329
  mo_energy =
[-1.20327343e+02 -1.23814162e+01 -6.67849766e+00 -6.67849766e+00
 -6.67849766e+00 -1.17965069e+00 -2.43143490e-01 -2.43143490e-01
 -2.43143490e-01  8.18762515e-01  4.93080784e+00  1.98856764e+01
  7.63725016e+01  2.70497700e+02  8.98333428e+02  3.15100281e+03
  1.26305350e+04  4.12271998e+04  1.05255125e+05  2.30428071e+05
  4.56235452e+05  8.45181965e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6743202171448  E_coul = 198.6837913964367
cycle= 5 E= -507.990528820708  delta_E= -1.52e-08  |g|= 7.21e-06  |ddm|= 0.00072
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.18553e-06
diis-c [-1.12057574e-12  6.79205833e-07 -6.29048194e-04  8.33153660e-03
 -1.01156032e-01  1.09345286e+00]
  HOMO = -0.243146661314679  LUMO = 0.818761655156084
  mo_energy =
[-1.20327350e+02 -1.23814222e+01 -6.67850371e+00 -6.67850371e+00
 -6.67850371e+00 -1.17965287e+00 -2.43146661e-01 -2.43146661e-01
 -2.43146661e-01  8.18761655e-01  4.93080364e+00  1.98856709e+01
  7.63724954e+01  2.70497694e+02  8.98333421e+02  3.15100280e+03
  1.26305350e+04  4.12271998e+04  1.05255125e+05  2.30428071e+05
  4.56235452e+05  8.45181965e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6743038573387  E_coul = 198.68377503661947
cycle= 6 E= -507.990528820719  delta_E= -1.12e-11  |g|= 8.74e-08  |ddm|= 2.31e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6743038573387  E_coul = 198.68377503661947
  HOMO = -0.243146702264361  LUMO = 0.818761629825335
  mo_energy =
[-1.20327350e+02 -1.23814223e+01 -6.67850379e+00 -6.67850379e+00
 -6.67850379e+00 -1.17965288e+00 -2.43146702e-01 -2.43146702e-01
 -2.43146702e-01  8.18761630e-01  4.93080358e+00  1.98856708e+01
  7.63724953e+01  2.70497694e+02  8.98333421e+02  3.15100280e+03
  1.26305350e+04  4.12271998e+04  1.05255125e+05  2.30428071e+05
  4.56235452e+05  8.45181965e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6743036825329  E_coul = 198.68377486181333
Extra cycle  E= -507.99052882072  delta_E= -3.41e-13  |g|= 1.14e-08  |ddm|= 2.15e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912493.8473927287
E1 = -706.6743036825329  E_coul = 198.68377486181333
init E= -507.99052882072
    CPU time for initialize scf      5.67 sec, wall time      0.24 sec
  HOMO = -0.243146707997916  LUMO = 0.818761629027133
  mo_energy =
[-1.20327350e+02 -1.23814223e+01 -6.67850381e+00 -6.67850381e+00
 -6.67850381e+00 -1.17965288e+00 -2.43146708e-01 -2.43146708e-01
 -2.43146708e-01  8.18761629e-01  4.93080357e+00  1.98856708e+01
  7.63724953e+01  2.70497694e+02  8.98333421e+02  3.15100280e+03
  1.26305350e+04  4.12271998e+04  1.05255125e+05  2.30428071e+05
  4.56235452e+05  8.45181965e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.6743036522845  E_coul = 198.68377483156493
cycle= 1 E= -507.99052882072  delta_E= 5.68e-14  |g|= 1.76e-09  |ddm|= 3.19e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6743036522845  E_coul = 198.68377483156493
  HOMO = -0.243146708945627  LUMO = 0.81876162961918
  mo_energy =
[-1.20327350e+02 -1.23814223e+01 -6.67850381e+00 -6.67850381e+00
 -6.67850381e+00 -1.17965288e+00 -2.43146709e-01 -2.43146709e-01
 -2.43146709e-01  8.18761630e-01  4.93080357e+00  1.98856708e+01
  7.63724953e+01  2.70497694e+02  8.98333421e+02  3.15100280e+03
  1.26305350e+04  4.12271998e+04  1.05255125e+05  2.30428071e+05
  4.56235452e+05  8.45181965e+05  1.52835367e+06  2.85061422e+06
  5.80849273e+06]
E1 = -706.674303645803  E_coul = 198.68377482508316
Extra cycle  E= -507.99052882072  delta_E= -2.84e-13  |g|= 1.51e-09  |ddm|= 6.45e-09
    CPU time for scf_cycle      6.18 sec, wall time      0.41 sec
exp = [2.20847389e-01 5.65865946e-01 1.70110597e+00 1.17616813e+05
 3.64324969e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231451e+03
 1.83757711e+04 1.44358180e+03 4.17366674e+02 1.47799291e+02
 5.83941403e+01 2.46438541e+01 8.23162325e+00 8.60429108e+00
 4.92746344e-01]
grad_E = [ 6.07328040e-05 -2.24508707e-04  2.39049337e-04  6.05087839e-09
 -8.09425701e-05  4.03124297e-11  1.73781619e-10  9.38557090e-10
  3.70809475e-09  1.54839793e-08  8.07771645e-08  5.09132436e-06
  1.97898474e-07 -3.80441856e-05 -9.81593579e-06  1.79622678e-05
 -4.05443766e-05 -2.35387535e-05 -2.25505958e-04 -1.77442801e-05
 -2.65333602e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.221680319256       1
[INPUT] 0    0    [1    /1   ]  0.568537884681       1
[INPUT] 0    0    [1    /1   ]  1.72738795105        1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.66880668008        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175261        1
[INPUT] 0    0    [1    /1   ]  36754.70142          1
[INPUT] 0    0    [1    /1   ]  7302.31425531        1
[INPUT] 0    0    [1    /1   ]  18375.7710583        1
[INPUT] 0    0    [1    /1   ]  1443.58371267        1
[INPUT] 0    0    [1    /1   ]  417.366865979        1
[INPUT] 0    0    [1    /1   ]  147.799683481        1
[INPUT] 0    0    [1    /1   ]  58.3925189615        1
[INPUT] 0    0    [1    /1   ]  24.6466457558        1
[INPUT] 0    0    [1    /1   ]  8.25158524498        1
[INPUT] 1    0    [1    /1   ]  8.60425255222        1
[INPUT] 1    0    [1    /1   ]  0.492749769445       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22168031925619308, 1.0]], [0, [0.5685378846814705, 1.0]], [0, [1.7273879510456083, 1.0]], [0, [117616.81288080128, 1.0]], [0, [3.668806680081487, 1.0]], [0, [1176168.142613395, 1.0]], [0, [588084.0699563099, 1.0]], [0, [294042.0309200855, 1.0]], [0, [147020.99131798357, 1.0]], [0, [73510.41752611373, 1.0]], [0, [36754.70141996863, 1.0]], [0, [7302.314255311602, 1.0]], [0, [18375.771058292456, 1.0]], [0, [1443.5837126717618, 1.0]], [0, [417.3668659789728, 1.0]], [0, [147.79968348071117, 1.0]], [0, [58.39251896147337, 1.0]], [0, [24.646645755833266, 1.0]], [0, [8.251585244982367, 1.0]], [1, [8.604252552217154, 1.0]], [1, [0.4927497694452997, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22168032]
bas 1, expnt(s) = [0.56853788]
bas 2, expnt(s) = [1.72738795]
bas 3, expnt(s) = [117616.8128808]
bas 4, expnt(s) = [3.66880668]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.06995631]
bas 7, expnt(s) = [294042.03092009]
bas 8, expnt(s) = [147020.99131798]
bas 9, expnt(s) = [73510.41752611]
bas 10, expnt(s) = [36754.70141997]
bas 11, expnt(s) = [7302.31425531]
bas 12, expnt(s) = [18375.77105829]
bas 13, expnt(s) = [1443.58371267]
bas 14, expnt(s) = [417.36686598]
bas 15, expnt(s) = [147.79968348]
bas 16, expnt(s) = [58.39251896]
bas 17, expnt(s) = [24.64664576]
bas 18, expnt(s) = [8.25158524]
bas 19, expnt(s) = [8.60425255]
bas 20, expnt(s) = [0.49274977]
CPU time:       668.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.21680319e-01 8.16225912e-01 5.68537885e-01 1.65418692e+00
 1.72738795e+00 3.80677702e+00 1.17616813e+05 1.60460108e+04
 3.66880668e+00 6.69743713e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231426e+03 1.99576965e+03
 1.83757711e+04 3.98748629e+03 1.44358371e+03 5.91693099e+02
 4.17366866e+02 2.33293963e+02 1.47799683e+02 1.07095236e+02
 5.83925190e+01 5.33682463e+01 2.46466458e+01 2.79468840e+01
 8.25158524e+00 1.23003669e+01 8.60425255e+00 4.29908299e+01
 4.92749769e-01 1.20439080e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336112940273146
cond(S) = 912503.305973327
E1 = -689.5958916555991  E_coul = 184.97124604358063
init E= -504.624645612018
    CPU time for initialize scf      4.65 sec, wall time      0.24 sec
  HOMO = -0.672173507565673  LUMO = 0.492991320723801
  mo_energy =
[-1.21709804e+02 -1.33862535e+01 -7.62361892e+00 -7.62361892e+00
 -7.62361892e+00 -1.65762475e+00 -6.72173508e-01 -6.72173508e-01
 -6.72173508e-01  4.92991321e-01  4.42272978e+00  1.92222996e+01
  7.55064785e+01  2.69476514e+02  8.97265305e+02  3.14998187e+03
  1.26296041e+04  4.12263241e+04  1.05254279e+05  2.30427245e+05
  4.56234639e+05  8.45181163e+05  1.52835288e+06  2.85061343e+06
  5.80849194e+06]
E1 = -707.7554478126107  E_coul = 199.78300797287565
cycle= 1 E= -507.972439839735  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.757421
diis-c [-0.5736865  1.       ]
  HOMO = -0.217590223672544  LUMO = 0.829012777012649
  mo_energy =
[-1.20200181e+02 -1.23046132e+01 -6.59394616e+00 -6.59394616e+00
 -6.59394616e+00 -1.16332197e+00 -2.17590224e-01 -2.17590224e-01
 -2.17590224e-01  8.29012777e-01  5.02269915e+00  2.01436968e+01
  7.67713411e+01  2.70929454e+02  8.98757116e+02  3.15141420e+03
  1.26309300e+04  4.12275828e+04  1.05255501e+05  2.30428442e+05
  4.56235819e+05  8.45182329e+05  1.52835403e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.7998365769749  E_coul = 198.80957792644162
cycle= 2 E= -507.990258650533  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.389
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0352525
diis-c [-0.00123641 -0.00333776  1.00333776]
  HOMO = -0.239805877177845  LUMO = 0.82575123313192
  mo_energy =
[-1.20315266e+02 -1.23724912e+01 -6.66909594e+00 -6.66909594e+00
 -6.66909594e+00 -1.17762284e+00 -2.39805877e-01 -2.39805877e-01
 -2.39805877e-01  8.25751233e-01  4.99660516e+00  2.00887408e+01
  7.66880131e+01  2.70824609e+02  8.98636345e+02  3.15127909e+03
  1.26307846e+04  4.12274335e+04  1.05255350e+05  2.30428290e+05
  4.56235667e+05  8.45182177e+05  1.52835388e+06  2.85061443e+06
  5.80849293e+06]
E1 = -706.6906742633598  E_coul = 198.70015010913284
cycle= 3 E= -507.990524154227  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00392151
diis-c [-3.37206873e-06  1.04622276e-04 -1.09426054e-01  1.10932143e+00]
  HOMO = -0.242982698377836  LUMO = 0.825063032226767
  mo_energy =
[-1.20327032e+02 -1.23810841e+01 -6.67816921e+00 -6.67816921e+00
 -6.67816921e+00 -1.17954971e+00 -2.42982698e-01 -2.42982698e-01
 -2.42982698e-01  8.25063032e-01  4.99266225e+00  2.00815464e+01
  7.66783919e+01  2.70813508e+02  8.98624342e+02  3.15126639e+03
  1.26307715e+04  4.12274202e+04  1.05255337e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6751426559321  E_coul = 198.6846132609735
cycle= 4 E= -507.990529394959  delta_E= -5.24e-06  |g|= 0.000238  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017629
diis-c [-7.18569653e-10 -9.81684423e-06  6.96562790e-03 -9.72809788e-02
  1.09032517e+00]
  HOMO = -0.243130842711309  LUMO = 0.825021194268905
  mo_energy =
[-1.20327359e+02 -1.23814133e+01 -6.67849297e+00 -6.67849297e+00
 -6.67849297e+00 -1.17963971e+00 -2.43130843e-01 -2.43130843e-01
 -2.43130843e-01  8.25021194e-01  4.99246981e+00  2.00812568e+01
  7.66780699e+01  2.70813182e+02  8.98624015e+02  3.15126606e+03
  1.26307711e+04  4.12274199e+04  1.05255337e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6744218052634  E_coul = 198.68389239511856
cycle= 5 E= -507.990529410145  delta_E= -1.52e-08  |g|= 7.05e-06  |ddm|= 0.000716
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.11496e-06
diis-c [-1.09345323e-12  6.75970024e-07 -6.20345662e-04  8.25847472e-03
 -9.99373205e-02  1.09229852e+00]
  HOMO = -0.243133964829223  LUMO = 0.825020344881441
  mo_energy =
[-1.20327366e+02 -1.23814192e+01 -6.67849895e+00 -6.67849895e+00
 -6.67849895e+00 -1.17964186e+00 -2.43133965e-01 -2.43133965e-01
 -2.43133965e-01  8.25020345e-01  4.99246566e+00  2.00812513e+01
  7.66780637e+01  2.70813175e+02  8.98624008e+02  3.15126606e+03
  1.26307711e+04  4.12274199e+04  1.05255336e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6744057307527  E_coul = 198.68387632059677
cycle= 6 E= -507.990529410156  delta_E= -1.11e-11  |g|= 8.81e-08  |ddm|= 2.24e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6744057307527  E_coul = 198.68387632059677
  HOMO = -0.24313400590459  LUMO = 0.825020319865276
  mo_energy =
[-1.20327366e+02 -1.23814193e+01 -6.67849903e+00 -6.67849903e+00
 -6.67849903e+00 -1.17964187e+00 -2.43134006e-01 -2.43134006e-01
 -2.43134006e-01  8.25020320e-01  4.99246560e+00  2.00812512e+01
  7.66780637e+01  2.70813175e+02  8.98624008e+02  3.15126606e+03
  1.26307711e+04  4.12274199e+04  1.05255336e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6744055552542  E_coul = 198.6838761450983
Extra cycle  E= -507.990529410156  delta_E= 5.68e-14  |g|= 1.21e-08  |ddm|= 2.14e-07
    CPU time for scf_cycle      5.44 sec, wall time      0.46 sec
exp = [2.21680319e-01 5.68537885e-01 1.72738795e+00 1.17616813e+05
 3.66880668e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231426e+03
 1.83757711e+04 1.44358371e+03 4.17366866e+02 1.47799683e+02
 5.83925190e+01 2.46466458e+01 8.25158524e+00 8.60425255e+00
 4.92749769e-01]
E = -507.9905294101559
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.221680319256       1
[INPUT] 0    0    [1    /1   ]  0.568537884681       1
[INPUT] 0    0    [1    /1   ]  1.72738795105        1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.66880668008        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175261        1
[INPUT] 0    0    [1    /1   ]  36754.70142          1
[INPUT] 0    0    [1    /1   ]  7302.31425531        1
[INPUT] 0    0    [1    /1   ]  18375.7710583        1
[INPUT] 0    0    [1    /1   ]  1443.58371267        1
[INPUT] 0    0    [1    /1   ]  417.366865979        1
[INPUT] 0    0    [1    /1   ]  147.799683481        1
[INPUT] 0    0    [1    /1   ]  58.3925189615        1
[INPUT] 0    0    [1    /1   ]  24.6466457558        1
[INPUT] 0    0    [1    /1   ]  8.25158524498        1
[INPUT] 1    0    [1    /1   ]  8.60425255222        1
[INPUT] 1    0    [1    /1   ]  0.492749769445       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22168031925619308, 1.0]], [0, [0.5685378846814705, 1.0]], [0, [1.7273879510456083, 1.0]], [0, [117616.81288080128, 1.0]], [0, [3.668806680081487, 1.0]], [0, [1176168.142613395, 1.0]], [0, [588084.0699563099, 1.0]], [0, [294042.0309200855, 1.0]], [0, [147020.99131798357, 1.0]], [0, [73510.41752611373, 1.0]], [0, [36754.70141996863, 1.0]], [0, [7302.314255311602, 1.0]], [0, [18375.771058292456, 1.0]], [0, [1443.5837126717618, 1.0]], [0, [417.3668659789728, 1.0]], [0, [147.79968348071117, 1.0]], [0, [58.39251896147337, 1.0]], [0, [24.646645755833266, 1.0]], [0, [8.251585244982367, 1.0]], [1, [8.604252552217154, 1.0]], [1, [0.4927497694452997, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22168032]
bas 1, expnt(s) = [0.56853788]
bas 2, expnt(s) = [1.72738795]
bas 3, expnt(s) = [117616.8128808]
bas 4, expnt(s) = [3.66880668]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.06995631]
bas 7, expnt(s) = [294042.03092009]
bas 8, expnt(s) = [147020.99131798]
bas 9, expnt(s) = [73510.41752611]
bas 10, expnt(s) = [36754.70141997]
bas 11, expnt(s) = [7302.31425531]
bas 12, expnt(s) = [18375.77105829]
bas 13, expnt(s) = [1443.58371267]
bas 14, expnt(s) = [417.36686598]
bas 15, expnt(s) = [147.79968348]
bas 16, expnt(s) = [58.39251896]
bas 17, expnt(s) = [24.64664576]
bas 18, expnt(s) = [8.25158524]
bas 19, expnt(s) = [8.60425255]
bas 20, expnt(s) = [0.49274977]
CPU time:       674.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.21680319e-01 8.16225912e-01 5.68537885e-01 1.65418692e+00
 1.72738795e+00 3.80677702e+00 1.17616813e+05 1.60460108e+04
 3.66880668e+00 6.69743713e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231426e+03 1.99576965e+03
 1.83757711e+04 3.98748629e+03 1.44358371e+03 5.91693099e+02
 4.17366866e+02 2.33293963e+02 1.47799683e+02 1.07095236e+02
 5.83925190e+01 5.33682463e+01 2.46466458e+01 2.79468840e+01
 8.25158524e+00 1.23003669e+01 8.60425255e+00 4.29908299e+01
 4.92749769e-01 1.20439080e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336112940273146
cond(S) = 912503.305973327
E1 = -689.5958916555991  E_coul = 184.97124604358063
init E= -504.624645612018
    CPU time for initialize scf      0.75 sec, wall time      0.07 sec
  HOMO = -0.672173507565673  LUMO = 0.492991320723801
  mo_energy =
[-1.21709804e+02 -1.33862535e+01 -7.62361892e+00 -7.62361892e+00
 -7.62361892e+00 -1.65762475e+00 -6.72173508e-01 -6.72173508e-01
 -6.72173508e-01  4.92991321e-01  4.42272978e+00  1.92222996e+01
  7.55064785e+01  2.69476514e+02  8.97265305e+02  3.14998187e+03
  1.26296041e+04  4.12263241e+04  1.05254279e+05  2.30427245e+05
  4.56234639e+05  8.45181163e+05  1.52835288e+06  2.85061343e+06
  5.80849194e+06]
E1 = -707.7554478126107  E_coul = 199.78300797287565
cycle= 1 E= -507.972439839735  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.757421
diis-c [-0.5736865  1.       ]
  HOMO = -0.217590223672544  LUMO = 0.829012777012649
  mo_energy =
[-1.20200181e+02 -1.23046132e+01 -6.59394616e+00 -6.59394616e+00
 -6.59394616e+00 -1.16332197e+00 -2.17590224e-01 -2.17590224e-01
 -2.17590224e-01  8.29012777e-01  5.02269915e+00  2.01436968e+01
  7.67713411e+01  2.70929454e+02  8.98757116e+02  3.15141420e+03
  1.26309300e+04  4.12275828e+04  1.05255501e+05  2.30428442e+05
  4.56235819e+05  8.45182329e+05  1.52835403e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.7998365769749  E_coul = 198.80957792644162
cycle= 2 E= -507.990258650533  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.389
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0352525
diis-c [-0.00123641 -0.00333776  1.00333776]
  HOMO = -0.239805877177845  LUMO = 0.82575123313192
  mo_energy =
[-1.20315266e+02 -1.23724912e+01 -6.66909594e+00 -6.66909594e+00
 -6.66909594e+00 -1.17762284e+00 -2.39805877e-01 -2.39805877e-01
 -2.39805877e-01  8.25751233e-01  4.99660516e+00  2.00887408e+01
  7.66880131e+01  2.70824609e+02  8.98636345e+02  3.15127909e+03
  1.26307846e+04  4.12274335e+04  1.05255350e+05  2.30428290e+05
  4.56235667e+05  8.45182177e+05  1.52835388e+06  2.85061443e+06
  5.80849293e+06]
E1 = -706.6906742633598  E_coul = 198.70015010913284
cycle= 3 E= -507.990524154227  delta_E= -0.000266  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00392151
diis-c [-3.37206873e-06  1.04622276e-04 -1.09426054e-01  1.10932143e+00]
  HOMO = -0.242982698377836  LUMO = 0.825063032226767
  mo_energy =
[-1.20327032e+02 -1.23810841e+01 -6.67816921e+00 -6.67816921e+00
 -6.67816921e+00 -1.17954971e+00 -2.42982698e-01 -2.42982698e-01
 -2.42982698e-01  8.25063032e-01  4.99266225e+00  2.00815464e+01
  7.66783919e+01  2.70813508e+02  8.98624342e+02  3.15126639e+03
  1.26307715e+04  4.12274202e+04  1.05255337e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6751426559321  E_coul = 198.6846132609735
cycle= 4 E= -507.990529394959  delta_E= -5.24e-06  |g|= 0.000238  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017629
diis-c [-7.18569653e-10 -9.81684423e-06  6.96562790e-03 -9.72809788e-02
  1.09032517e+00]
  HOMO = -0.243130842711309  LUMO = 0.825021194268905
  mo_energy =
[-1.20327359e+02 -1.23814133e+01 -6.67849297e+00 -6.67849297e+00
 -6.67849297e+00 -1.17963971e+00 -2.43130843e-01 -2.43130843e-01
 -2.43130843e-01  8.25021194e-01  4.99246981e+00  2.00812568e+01
  7.66780699e+01  2.70813182e+02  8.98624015e+02  3.15126606e+03
  1.26307711e+04  4.12274199e+04  1.05255337e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6744218052634  E_coul = 198.68389239511856
cycle= 5 E= -507.990529410145  delta_E= -1.52e-08  |g|= 7.05e-06  |ddm|= 0.000716
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.11496e-06
diis-c [-1.09345323e-12  6.75970024e-07 -6.20345662e-04  8.25847472e-03
 -9.99373205e-02  1.09229852e+00]
  HOMO = -0.243133964829223  LUMO = 0.825020344881441
  mo_energy =
[-1.20327366e+02 -1.23814192e+01 -6.67849895e+00 -6.67849895e+00
 -6.67849895e+00 -1.17964186e+00 -2.43133965e-01 -2.43133965e-01
 -2.43133965e-01  8.25020345e-01  4.99246566e+00  2.00812513e+01
  7.66780637e+01  2.70813175e+02  8.98624008e+02  3.15126606e+03
  1.26307711e+04  4.12274199e+04  1.05255336e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6744057307527  E_coul = 198.68387632059677
cycle= 6 E= -507.990529410156  delta_E= -1.11e-11  |g|= 8.81e-08  |ddm|= 2.24e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6744057307527  E_coul = 198.68387632059677
  HOMO = -0.24313400590459  LUMO = 0.825020319865276
  mo_energy =
[-1.20327366e+02 -1.23814193e+01 -6.67849903e+00 -6.67849903e+00
 -6.67849903e+00 -1.17964187e+00 -2.43134006e-01 -2.43134006e-01
 -2.43134006e-01  8.25020320e-01  4.99246560e+00  2.00812512e+01
  7.66780637e+01  2.70813175e+02  8.98624008e+02  3.15126606e+03
  1.26307711e+04  4.12274199e+04  1.05255336e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6744055552542  E_coul = 198.6838761450983
Extra cycle  E= -507.990529410156  delta_E= 5.68e-14  |g|= 1.21e-08  |ddm|= 2.14e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912503.305973327
E1 = -706.6744055552542  E_coul = 198.6838761450983
init E= -507.990529410156
    CPU time for initialize scf      5.82 sec, wall time      0.25 sec
  HOMO = -0.243134011656995  LUMO = 0.825020318579629
  mo_energy =
[-1.20327366e+02 -1.23814193e+01 -6.67849905e+00 -6.67849905e+00
 -6.67849905e+00 -1.17964187e+00 -2.43134012e-01 -2.43134012e-01
 -2.43134012e-01  8.25020319e-01  4.99246559e+00  2.00812512e+01
  7.66780637e+01  2.70813175e+02  8.98624008e+02  3.15126606e+03
  1.26307711e+04  4.12274199e+04  1.05255336e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6744055250582  E_coul = 198.68387611490274
cycle= 1 E= -507.990529410155  delta_E= 4.55e-13  |g|= 2.65e-09  |ddm|= 3.11e-08
    CPU time for cycle= 1      0.26 sec, wall time      0.03 sec
E1 = -706.6744055250582  E_coul = 198.68387611490274
  HOMO = -0.243134012593851  LUMO = 0.825020317302215
  mo_energy =
[-1.20327366e+02 -1.23814193e+01 -6.67849905e+00 -6.67849905e+00
 -6.67849905e+00 -1.17964187e+00 -2.43134013e-01 -2.43134013e-01
 -2.43134013e-01  8.25020317e-01  4.99246559e+00  2.00812512e+01
  7.66780636e+01  2.70813175e+02  8.98624008e+02  3.15126606e+03
  1.26307711e+04  4.12274199e+04  1.05255336e+05  2.30428277e+05
  4.56235653e+05  8.45182163e+05  1.52835386e+06  2.85061441e+06
  5.80849291e+06]
E1 = -706.6744055218954  E_coul = 198.6838761117396
Extra cycle  E= -507.990529410156  delta_E= -3.98e-13  |g|= 1.27e-09  |ddm|= 4.38e-09
    CPU time for scf_cycle      6.23 sec, wall time      0.42 sec
exp = [2.21680319e-01 5.68537885e-01 1.72738795e+00 1.17616813e+05
 3.66880668e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231426e+03
 1.83757711e+04 1.44358371e+03 4.17366866e+02 1.47799683e+02
 5.83925190e+01 2.46466458e+01 8.25158524e+00 8.60425255e+00
 4.92749769e-01]
grad_E = [ 1.92309364e-04 -2.61866022e-04  2.23596098e-04  6.05049748e-09
 -2.52124390e-05  4.03081497e-11  1.73769127e-10  9.38498662e-10
  3.70785883e-09  1.54829813e-08  8.07723491e-08  5.09102115e-06
  1.97882722e-07 -3.80325653e-05 -9.90554354e-06  1.82444348e-05
 -4.05270769e-05 -2.51816349e-05 -2.46060426e-04 -5.25562496e-05
 -9.21293177e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.222044151947       1
[INPUT] 0    0    [1    /1   ]  0.569854952293       1
[INPUT] 0    0    [1    /1   ]  1.7373017806         1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.67977749589        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175258        1
[INPUT] 0    0    [1    /1   ]  36754.7014182        1
[INPUT] 0    0    [1    /1   ]  7302.31414552        1
[INPUT] 0    0    [1    /1   ]  18375.771054         1
[INPUT] 0    0    [1    /1   ]  1443.58454361        1
[INPUT] 0    0    [1    /1   ]  417.366962143        1
[INPUT] 0    0    [1    /1   ]  147.799797713        1
[INPUT] 0    0    [1    /1   ]  58.3919788362        1
[INPUT] 0    0    [1    /1   ]  24.6477721071        1
[INPUT] 0    0    [1    /1   ]  8.25956759364        1
[INPUT] 1    0    [1    /1   ]  8.60428555263        1
[INPUT] 1    0    [1    /1   ]  0.492755379331       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22204415194678764, 1.0]], [0, [0.5698549522933983, 1.0]], [0, [1.7373017806010096, 1.0]], [0, [117616.81288067078, 1.0]], [0, [3.6797774958890517, 1.0]], [0, [1176168.142613394, 1.0]], [0, [588084.0699563061, 1.0]], [0, [294042.03092006524, 1.0]], [0, [147020.9913179036, 1.0]], [0, [73510.41752577975, 1.0]], [0, [36754.70141822672, 1.0]], [0, [7302.314145517675, 1.0]], [0, [18375.771054020868, 1.0]], [0, [1443.5845436109673, 1.0]], [0, [417.3669621434279, 1.0]], [0, [147.79979771286762, 1.0]], [0, [58.39197883623825, 1.0]], [0, [24.64777210712841, 1.0]], [0, [8.25956759364358, 1.0]], [1, [8.604285552625115, 1.0]], [1, [0.49275537933056224, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22204415]
bas 1, expnt(s) = [0.56985495]
bas 2, expnt(s) = [1.73730178]
bas 3, expnt(s) = [117616.81288067]
bas 4, expnt(s) = [3.6797775]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.06995631]
bas 7, expnt(s) = [294042.03092007]
bas 8, expnt(s) = [147020.9913179]
bas 9, expnt(s) = [73510.41752578]
bas 10, expnt(s) = [36754.70141823]
bas 11, expnt(s) = [7302.31414552]
bas 12, expnt(s) = [18375.77105402]
bas 13, expnt(s) = [1443.58454361]
bas 14, expnt(s) = [417.36696214]
bas 15, expnt(s) = [147.79979771]
bas 16, expnt(s) = [58.39197884]
bas 17, expnt(s) = [24.64777211]
bas 18, expnt(s) = [8.25956759]
bas 19, expnt(s) = [8.60428555]
bas 20, expnt(s) = [0.49275538]
CPU time:       688.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.22044152e-01 8.17230429e-01 5.69854952e-01 1.65706014e+00
 1.73730178e+00 3.82315119e+00 1.17616813e+05 1.60460108e+04
 3.67977750e+00 6.71245201e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231415e+03 1.99576962e+03
 1.83757711e+04 3.98748629e+03 1.44358454e+03 5.91693355e+02
 4.17366962e+02 2.33294003e+02 1.47799798e+02 1.07095298e+02
 5.83919788e+01 5.33678761e+01 2.46477721e+01 2.79478418e+01
 8.25956759e+00 1.23092901e+01 8.60428555e+00 4.29910360e+01
 4.92755379e-01 1.20440794e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33610433878704
cond(S) = 912507.1668238675
E1 = -689.5962212841184  E_coul = 184.97156119539468
init E= -504.624660088724
    CPU time for initialize scf      1.95 sec, wall time      0.12 sec
  HOMO = -0.672167141454216  LUMO = 0.495247033065959
  mo_energy =
[-1.21709759e+02 -1.33862298e+01 -7.62359897e+00 -7.62359897e+00
 -7.62359897e+00 -1.65761681e+00 -6.72167141e-01 -6.72167141e-01
 -6.72167141e-01  4.95247033e-01  4.44683904e+00  1.93007118e+01
  7.56303491e+01  2.69604754e+02  8.97383573e+02  3.15008911e+03
  1.26297005e+04  4.12264139e+04  1.05254366e+05  2.30427329e+05
  4.56234721e+05  8.45181243e+05  1.52835296e+06  2.85061351e+06
  5.80849202e+06]
E1 = -707.7558362168862  E_coul = 199.7833958558256
cycle= 1 E= -507.972440361061  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.75749
diis-c [-0.57379146  1.        ]
  HOMO = -0.217579211720618  LUMO = 0.831821368794198
  mo_energy =
[-1.20200131e+02 -1.23045849e+01 -6.59392191e+00 -6.59392191e+00
 -6.59392191e+00 -1.16331199e+00 -2.17579212e-01 -2.17579212e-01
 -2.17579212e-01  8.31821369e-01  5.04802147e+00  2.02228151e+01
  7.68952403e+01  2.71057667e+02  8.98875378e+02  3.15152144e+03
  1.26310263e+04  4.12276726e+04  1.05255587e+05  2.30428526e+05
  4.56235901e+05  8.45182410e+05  1.52835411e+06  2.85061466e+06
  5.80849316e+06]
E1 = -706.8002535670761  E_coul = 198.80999452874428
cycle= 2 E= -507.990259038332  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0351992
diis-c [-0.00123274 -0.00331318  1.00331318]
  HOMO = -0.239793627976004  LUMO = 0.828537468249972
  mo_energy =
[-1.20315211e+02 -1.23724590e+01 -6.66906759e+00 -6.66906759e+00
 -6.66906759e+00 -1.17761175e+00 -2.39793628e-01 -2.39793628e-01
 -2.39793628e-01  8.28537468e-01  5.02182020e+00  2.01677953e+01
  7.68119082e+01  2.70952829e+02  8.98754614e+02  3.15138634e+03
  1.26308810e+04  4.12275234e+04  1.05255436e+05  2.30428374e+05
  4.56235749e+05  8.45182258e+05  1.52835396e+06  2.85061450e+06
  5.80849300e+06]
E1 = -706.6911175379902  E_coul = 198.70059310838616
cycle= 3 E= -507.990524429604  delta_E= -0.000265  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00391163
diis-c [-3.36414281e-06  1.06903620e-04 -1.09262514e-01  1.10915561e+00]
  HOMO = -0.242969328833132  LUMO = 0.827845940278038
  mo_energy =
[-1.20326976e+02 -1.23810501e+01 -6.67813908e+00 -6.67813908e+00
 -6.67813908e+00 -1.17953786e+00 -2.42969329e-01 -2.42969329e-01
 -2.42969329e-01  8.27845940e-01  5.01786459e+00  2.01605958e+01
  7.68022881e+01  2.70941729e+02  8.98742612e+02  3.15137364e+03
  1.26308678e+04  4.12275101e+04  1.05255423e+05  2.30428361e+05
  4.56235736e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6755956581917  E_coul = 198.68506599500878
cycle= 4 E= -507.990529663183  delta_E= -5.23e-06  |g|= 0.000238  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176202
diis-c [-7.09164133e-10 -9.78786775e-06  6.95949245e-03 -9.73739517e-02
  1.09042425e+00]
  HOMO = -0.243117768134862  LUMO = 0.827803895930351
  mo_energy =
[-1.20327304e+02 -1.23813804e+01 -6.67846405e+00 -6.67846405e+00
 -6.67846405e+00 -1.17962803e+00 -2.43117768e-01 -2.43117768e-01
 -2.43117768e-01  8.27803896e-01  5.01767125e+00  2.01603051e+01
  7.68019648e+01  2.70941401e+02  8.98742284e+02  3.15137331e+03
  1.26308675e+04  4.12275097e+04  1.05255423e+05  2.30428360e+05
  4.56235735e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6748737054165  E_coul = 198.6843440270603
cycle= 5 E= -507.990529678356  delta_E= -1.52e-08  |g|= 6.99e-06  |ddm|= 0.000714
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.08438e-06
diis-c [-1.08755305e-12  6.66956267e-07 -6.15916081e-04  8.21570754e-03
 -9.93268545e-02  1.09172640e+00]
  HOMO = -0.243120867578347  LUMO = 0.827803052272661
  mo_energy =
[-1.20327311e+02 -1.23813863e+01 -6.67847000e+00 -6.67847000e+00
 -6.67847000e+00 -1.17963016e+00 -2.43120868e-01 -2.43120868e-01
 -2.43120868e-01  8.27803052e-01  5.01766712e+00  2.01602997e+01
  7.68019586e+01  2.70941395e+02  8.98742277e+02  3.15137331e+03
  1.26308675e+04  4.12275097e+04  1.05255423e+05  2.30428360e+05
  4.56235735e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6748577586004  E_coul = 198.68432808023314
cycle= 6 E= -507.990529678367  delta_E= -1.1e-11  |g|= 8.81e-08  |ddm|= 2.21e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6748577586004  E_coul = 198.68432808023314
  HOMO = -0.243120908834308  LUMO = 0.827803027614887
  mo_energy =
[-1.20327311e+02 -1.23813864e+01 -6.67847008e+00 -6.67847008e+00
 -6.67847008e+00 -1.17963017e+00 -2.43120909e-01 -2.43120909e-01
 -2.43120909e-01  8.27803028e-01  5.01766706e+00  2.01602996e+01
  7.68019586e+01  2.70941395e+02  8.98742277e+02  3.15137331e+03
  1.26308675e+04  4.12275097e+04  1.05255423e+05  2.30428360e+05
  4.56235735e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6748575790735  E_coul = 198.68432790070634
Extra cycle  E= -507.990529678367  delta_E=    0  |g|= 1.07e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      2.80 sec, wall time      0.35 sec
exp = [2.22044152e-01 5.69854952e-01 1.73730178e+00 1.17616813e+05
 3.67977750e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231415e+03
 1.83757711e+04 1.44358454e+03 4.17366962e+02 1.47799798e+02
 5.83919788e+01 2.46477721e+01 8.25956759e+00 8.60428555e+00
 4.92755379e-01]
E = -507.99052967836724
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.222044151947       1
[INPUT] 0    0    [1    /1   ]  0.569854952293       1
[INPUT] 0    0    [1    /1   ]  1.7373017806         1
[INPUT] 0    0    [1    /1   ]  117616.812881        1
[INPUT] 0    0    [1    /1   ]  3.67977749589        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175258        1
[INPUT] 0    0    [1    /1   ]  36754.7014182        1
[INPUT] 0    0    [1    /1   ]  7302.31414552        1
[INPUT] 0    0    [1    /1   ]  18375.771054         1
[INPUT] 0    0    [1    /1   ]  1443.58454361        1
[INPUT] 0    0    [1    /1   ]  417.366962143        1
[INPUT] 0    0    [1    /1   ]  147.799797713        1
[INPUT] 0    0    [1    /1   ]  58.3919788362        1
[INPUT] 0    0    [1    /1   ]  24.6477721071        1
[INPUT] 0    0    [1    /1   ]  8.25956759364        1
[INPUT] 1    0    [1    /1   ]  8.60428555263        1
[INPUT] 1    0    [1    /1   ]  0.492755379331       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22204415194678764, 1.0]], [0, [0.5698549522933983, 1.0]], [0, [1.7373017806010096, 1.0]], [0, [117616.81288067078, 1.0]], [0, [3.6797774958890517, 1.0]], [0, [1176168.142613394, 1.0]], [0, [588084.0699563061, 1.0]], [0, [294042.03092006524, 1.0]], [0, [147020.9913179036, 1.0]], [0, [73510.41752577975, 1.0]], [0, [36754.70141822672, 1.0]], [0, [7302.314145517675, 1.0]], [0, [18375.771054020868, 1.0]], [0, [1443.5845436109673, 1.0]], [0, [417.3669621434279, 1.0]], [0, [147.79979771286762, 1.0]], [0, [58.39197883623825, 1.0]], [0, [24.64777210712841, 1.0]], [0, [8.25956759364358, 1.0]], [1, [8.604285552625115, 1.0]], [1, [0.49275537933056224, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22204415]
bas 1, expnt(s) = [0.56985495]
bas 2, expnt(s) = [1.73730178]
bas 3, expnt(s) = [117616.81288067]
bas 4, expnt(s) = [3.6797775]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.06995631]
bas 7, expnt(s) = [294042.03092007]
bas 8, expnt(s) = [147020.9913179]
bas 9, expnt(s) = [73510.41752578]
bas 10, expnt(s) = [36754.70141823]
bas 11, expnt(s) = [7302.31414552]
bas 12, expnt(s) = [18375.77105402]
bas 13, expnt(s) = [1443.58454361]
bas 14, expnt(s) = [417.36696214]
bas 15, expnt(s) = [147.79979771]
bas 16, expnt(s) = [58.39197884]
bas 17, expnt(s) = [24.64777211]
bas 18, expnt(s) = [8.25956759]
bas 19, expnt(s) = [8.60428555]
bas 20, expnt(s) = [0.49275538]
CPU time:       691.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.22044152e-01 8.17230429e-01 5.69854952e-01 1.65706014e+00
 1.73730178e+00 3.82315119e+00 1.17616813e+05 1.60460108e+04
 3.67977750e+00 6.71245201e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231415e+03 1.99576962e+03
 1.83757711e+04 3.98748629e+03 1.44358454e+03 5.91693355e+02
 4.17366962e+02 2.33294003e+02 1.47799798e+02 1.07095298e+02
 5.83919788e+01 5.33678761e+01 2.46477721e+01 2.79478418e+01
 8.25956759e+00 1.23092901e+01 8.60428555e+00 4.29910360e+01
 4.92755379e-01 1.20440794e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33610433878704
cond(S) = 912507.1668238675
E1 = -689.5962212841184  E_coul = 184.97156119539468
init E= -504.624660088724
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672167141454216  LUMO = 0.495247033065959
  mo_energy =
[-1.21709759e+02 -1.33862298e+01 -7.62359897e+00 -7.62359897e+00
 -7.62359897e+00 -1.65761681e+00 -6.72167141e-01 -6.72167141e-01
 -6.72167141e-01  4.95247033e-01  4.44683904e+00  1.93007118e+01
  7.56303491e+01  2.69604754e+02  8.97383573e+02  3.15008911e+03
  1.26297005e+04  4.12264139e+04  1.05254366e+05  2.30427329e+05
  4.56234721e+05  8.45181243e+05  1.52835296e+06  2.85061351e+06
  5.80849202e+06]
E1 = -707.7558362168862  E_coul = 199.7833958558256
cycle= 1 E= -507.972440361061  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.75749
diis-c [-0.57379146  1.        ]
  HOMO = -0.217579211720618  LUMO = 0.831821368794198
  mo_energy =
[-1.20200131e+02 -1.23045849e+01 -6.59392191e+00 -6.59392191e+00
 -6.59392191e+00 -1.16331199e+00 -2.17579212e-01 -2.17579212e-01
 -2.17579212e-01  8.31821369e-01  5.04802147e+00  2.02228151e+01
  7.68952403e+01  2.71057667e+02  8.98875378e+02  3.15152144e+03
  1.26310263e+04  4.12276726e+04  1.05255587e+05  2.30428526e+05
  4.56235901e+05  8.45182410e+05  1.52835411e+06  2.85061466e+06
  5.80849316e+06]
E1 = -706.8002535670761  E_coul = 198.80999452874428
cycle= 2 E= -507.990259038332  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0351992
diis-c [-0.00123274 -0.00331318  1.00331318]
  HOMO = -0.239793627976004  LUMO = 0.828537468249972
  mo_energy =
[-1.20315211e+02 -1.23724590e+01 -6.66906759e+00 -6.66906759e+00
 -6.66906759e+00 -1.17761175e+00 -2.39793628e-01 -2.39793628e-01
 -2.39793628e-01  8.28537468e-01  5.02182020e+00  2.01677953e+01
  7.68119082e+01  2.70952829e+02  8.98754614e+02  3.15138634e+03
  1.26308810e+04  4.12275234e+04  1.05255436e+05  2.30428374e+05
  4.56235749e+05  8.45182258e+05  1.52835396e+06  2.85061450e+06
  5.80849300e+06]
E1 = -706.6911175379902  E_coul = 198.70059310838616
cycle= 3 E= -507.990524429604  delta_E= -0.000265  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00391163
diis-c [-3.36414281e-06  1.06903620e-04 -1.09262514e-01  1.10915561e+00]
  HOMO = -0.242969328833132  LUMO = 0.827845940278038
  mo_energy =
[-1.20326976e+02 -1.23810501e+01 -6.67813908e+00 -6.67813908e+00
 -6.67813908e+00 -1.17953786e+00 -2.42969329e-01 -2.42969329e-01
 -2.42969329e-01  8.27845940e-01  5.01786459e+00  2.01605958e+01
  7.68022881e+01  2.70941729e+02  8.98742612e+02  3.15137364e+03
  1.26308678e+04  4.12275101e+04  1.05255423e+05  2.30428361e+05
  4.56235736e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6755956581917  E_coul = 198.68506599500878
cycle= 4 E= -507.990529663183  delta_E= -5.23e-06  |g|= 0.000238  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176202
diis-c [-7.09164133e-10 -9.78786775e-06  6.95949245e-03 -9.73739517e-02
  1.09042425e+00]
  HOMO = -0.243117768134862  LUMO = 0.827803895930351
  mo_energy =
[-1.20327304e+02 -1.23813804e+01 -6.67846405e+00 -6.67846405e+00
 -6.67846405e+00 -1.17962803e+00 -2.43117768e-01 -2.43117768e-01
 -2.43117768e-01  8.27803896e-01  5.01767125e+00  2.01603051e+01
  7.68019648e+01  2.70941401e+02  8.98742284e+02  3.15137331e+03
  1.26308675e+04  4.12275097e+04  1.05255423e+05  2.30428360e+05
  4.56235735e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6748737054165  E_coul = 198.6843440270603
cycle= 5 E= -507.990529678356  delta_E= -1.52e-08  |g|= 6.99e-06  |ddm|= 0.000714
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.08438e-06
diis-c [-1.08755305e-12  6.66956267e-07 -6.15916081e-04  8.21570754e-03
 -9.93268545e-02  1.09172640e+00]
  HOMO = -0.243120867578347  LUMO = 0.827803052272661
  mo_energy =
[-1.20327311e+02 -1.23813863e+01 -6.67847000e+00 -6.67847000e+00
 -6.67847000e+00 -1.17963016e+00 -2.43120868e-01 -2.43120868e-01
 -2.43120868e-01  8.27803052e-01  5.01766712e+00  2.01602997e+01
  7.68019586e+01  2.70941395e+02  8.98742277e+02  3.15137331e+03
  1.26308675e+04  4.12275097e+04  1.05255423e+05  2.30428360e+05
  4.56235735e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6748577586004  E_coul = 198.68432808023314
cycle= 6 E= -507.990529678367  delta_E= -1.1e-11  |g|= 8.81e-08  |ddm|= 2.21e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6748577586004  E_coul = 198.68432808023314
  HOMO = -0.243120908834308  LUMO = 0.827803027614887
  mo_energy =
[-1.20327311e+02 -1.23813864e+01 -6.67847008e+00 -6.67847008e+00
 -6.67847008e+00 -1.17963017e+00 -2.43120909e-01 -2.43120909e-01
 -2.43120909e-01  8.27803028e-01  5.01766706e+00  2.01602996e+01
  7.68019586e+01  2.70941395e+02  8.98742277e+02  3.15137331e+03
  1.26308675e+04  4.12275097e+04  1.05255423e+05  2.30428360e+05
  4.56235735e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6748575790735  E_coul = 198.68432790070634
Extra cycle  E= -507.990529678367  delta_E=    0  |g|= 1.07e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912507.1668238675
E1 = -706.6748575790735  E_coul = 198.68432790070634
init E= -507.990529678367
    CPU time for initialize scf      5.66 sec, wall time      0.24 sec
  HOMO = -0.243120914704526  LUMO = 0.827803024838733
  mo_energy =
[-1.20327311e+02 -1.23813864e+01 -6.67847009e+00 -6.67847009e+00
 -6.67847009e+00 -1.17963018e+00 -2.43120915e-01 -2.43120915e-01
 -2.43120915e-01  8.27803025e-01  5.01766705e+00  2.01602996e+01
  7.68019586e+01  2.70941395e+02  8.98742277e+02  3.15137331e+03
  1.26308675e+04  4.12275097e+04  1.05255423e+05  2.30428360e+05
  4.56235735e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6748575534561  E_coul = 198.6843278750891
cycle= 1 E= -507.990529678367  delta_E= 2.27e-13  |g|= 2.26e-09  |ddm|= 2.77e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6748575534561  E_coul = 198.6843278750891
  HOMO = -0.243120915518954  LUMO = 0.827803025358209
  mo_energy =
[-1.20327311e+02 -1.23813864e+01 -6.67847009e+00 -6.67847009e+00
 -6.67847009e+00 -1.17963018e+00 -2.43120916e-01 -2.43120916e-01
 -2.43120916e-01  8.27803025e-01  5.01766705e+00  2.01602996e+01
  7.68019586e+01  2.70941395e+02  8.98742277e+02  3.15137331e+03
  1.26308675e+04  4.12275097e+04  1.05255423e+05  2.30428360e+05
  4.56235735e+05  8.45182244e+05  1.52835394e+06  2.85061449e+06
  5.80849299e+06]
E1 = -706.6748575500758  E_coul = 198.6843278717084
Extra cycle  E= -507.990529678367  delta_E= -3.41e-13  |g|= 1.8e-09  |ddm|= 3.58e-09
    CPU time for scf_cycle      6.16 sec, wall time      0.40 sec
exp = [2.22044152e-01 5.69854952e-01 1.73730178e+00 1.17616813e+05
 3.67977750e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231415e+03
 1.83757711e+04 1.44358454e+03 4.17366962e+02 1.47799798e+02
 5.83919788e+01 2.46477721e+01 8.25956759e+00 8.60428555e+00
 4.92755379e-01]
grad_E = [ 1.46944410e-04 -2.25917597e-04  2.13170054e-04  6.05040182e-09
  2.46107505e-06  4.03070772e-11  1.73765994e-10  9.38483982e-10
  3.70779959e-09  1.54827307e-08  8.07711396e-08  5.09094637e-06
  1.97878776e-07 -3.80300560e-05 -9.92087374e-06  1.82562289e-05
 -4.01737554e-05 -2.62581782e-05 -2.57555708e-04 -3.02452056e-05
  8.06770385e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.222516373624       1
[INPUT] 0    0    [1    /1   ]  0.571636994199       1
[INPUT] 0    0    [1    /1   ]  1.74784831961        1
[INPUT] 0    0    [1    /1   ]  117616.81288         1
[INPUT] 0    0    [1    /1   ]  3.69340452477        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175253        1
[INPUT] 0    0    [1    /1   ]  36754.7014159        1
[INPUT] 0    0    [1    /1   ]  7302.31399792        1
[INPUT] 0    0    [1    /1   ]  18375.7710483        1
[INPUT] 0    0    [1    /1   ]  1443.58565853        1
[INPUT] 0    0    [1    /1   ]  417.367114715        1
[INPUT] 0    0    [1    /1   ]  147.799849581        1
[INPUT] 0    0    [1    /1   ]  58.3915437541        1
[INPUT] 0    0    [1    /1   ]  24.6491477872        1
[INPUT] 0    0    [1    /1   ]  8.26938121758        1
[INPUT] 1    0    [1    /1   ]  8.60436544163        1
[INPUT] 1    0    [1    /1   ]  0.492766828173       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22251637362385898, 1.0]], [0, [0.5716369941985191, 1.0]], [0, [1.7478483196133816, 1.0]], [0, [117616.81288049534, 1.0]], [0, [3.6934045247693152, 1.0]], [0, [1176168.1426133928, 1.0]], [0, [588084.0699563011, 1.0]], [0, [294042.03092003806, 1.0]], [0, [147020.99131779608, 1.0]], [0, [73510.41752533079, 1.0]], [0, [36754.701415885065, 1.0]], [0, [7302.313997921203, 1.0]], [0, [18375.771048279345, 1.0]], [0, [1443.5856585296542, 1.0]], [0, [417.3671147154597, 1.0]], [0, [147.79984958057875, 1.0]], [0, [58.39154375414441, 1.0]], [0, [24.649147787212613, 1.0]], [0, [8.269381217576367, 1.0]], [1, [8.604365441628671, 1.0]], [1, [0.4927668281734086, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22251637]
bas 1, expnt(s) = [0.57163699]
bas 2, expnt(s) = [1.74784832]
bas 3, expnt(s) = [117616.8128805]
bas 4, expnt(s) = [3.69340452]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.0699563]
bas 7, expnt(s) = [294042.03092004]
bas 8, expnt(s) = [147020.9913178]
bas 9, expnt(s) = [73510.41752533]
bas 10, expnt(s) = [36754.70141589]
bas 11, expnt(s) = [7302.31399792]
bas 12, expnt(s) = [18375.77104828]
bas 13, expnt(s) = [1443.58565853]
bas 14, expnt(s) = [417.36711472]
bas 15, expnt(s) = [147.79984958]
bas 16, expnt(s) = [58.39154375]
bas 17, expnt(s) = [24.64914779]
bas 18, expnt(s) = [8.26938122]
bas 19, expnt(s) = [8.60436544]
bas 20, expnt(s) = [0.49276683]
CPU time:       706.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.22516374e-01 8.18533587e-01 5.71636994e-01 1.66094507e+00
 1.74784832e+00 3.84054475e+00 1.17616813e+05 1.60460108e+04
 3.69340452e+00 6.73108666e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231400e+03 1.99576959e+03
 1.83757710e+04 3.98748629e+03 1.44358566e+03 5.91693698e+02
 4.17367115e+02 2.33294067e+02 1.47799850e+02 1.07095326e+02
 5.83915438e+01 5.33675778e+01 2.46491478e+01 2.79490117e+01
 8.26938122e+00 1.23202575e+01 8.60436544e+00 4.29915350e+01
 4.92766828e-01 1.20444292e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608773633164
cond(S) = 912511.7392044206
E1 = -689.5969759910921  E_coul = 184.97228441690604
init E= -504.624691574186
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672153586193247  LUMO = 0.498146109673198
  mo_energy =
[-1.21709653e+02 -1.33861737e+01 -7.62355228e+00 -7.62355228e+00
 -7.62355228e+00 -1.65760155e+00 -6.72153586e-01 -6.72153586e-01
 -6.72153586e-01  4.98146110e-01  4.47506076e+00  1.93922082e+01
  7.57768027e+01  2.69757400e+02  8.97524752e+02  3.15021737e+03
  1.26298160e+04  4.12265217e+04  1.05254469e+05  2.30427429e+05
  4.56234820e+05  8.45181340e+05  1.52835305e+06  2.85061361e+06
  5.80849211e+06]
E1 = -707.7567397296898  E_coul = 199.78429943307347
cycle= 1 E= -507.972440296616  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.757549
diis-c [-0.5738804  1.       ]
  HOMO = -0.217555396903183  LUMO = 0.835409885600304
  mo_energy =
[-1.20200013e+02 -1.23045175e+01 -6.59386416e+00 -6.59386416e+00
 -6.59386416e+00 -1.16329128e+00 -2.17555397e-01 -2.17555397e-01
 -2.17555397e-01  8.35409886e-01  5.07762542e+00  2.03151483e+01
  7.70417404e+01  2.71210287e+02  8.99016558e+02  3.15164971e+03
  1.26311418e+04  4.12277804e+04  1.05255691e+05  2.30428626e+05
  4.56236000e+05  8.45182507e+05  1.52835421e+06  2.85061475e+06
  5.80849325e+06]
E1 = -706.8011612883341  E_coul = 198.81090159166465
cycle= 2 E= -507.990259696669  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0351409
diis-c [-0.00122875 -0.00328443  1.00328443]
  HOMO = -0.239769388235269  LUMO = 0.832098399824144
  mo_energy =
[-1.20315088e+02 -1.23723892e+01 -6.66900724e+00 -6.66900724e+00
 -6.66900724e+00 -1.17759028e+00 -2.39769388e-01 -2.39769388e-01
 -2.39769388e-01  8.32098400e-01  5.05129972e+00  2.02600524e+01
  7.69584007e+01  2.71105455e+02  8.98895799e+02  3.15151461e+03
  1.26309965e+04  4.12276312e+04  1.05255540e+05  2.30428475e+05
  4.56235848e+05  8.45182355e+05  1.52835405e+06  2.85061460e+06
  5.80849309e+06]
E1 = -706.6920579366678  E_coul = 198.70153299458337
cycle= 3 E= -507.990524942084  delta_E= -0.000265  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00390075
diis-c [-3.35491352e-06  1.09292966e-04 -1.09082172e-01  1.10897288e+00]
  HOMO = -0.242943728802737  LUMO = 0.831402801867342
  mo_energy =
[-1.20326852e+02 -1.23809781e+01 -6.67807662e+00 -6.67807662e+00
 -6.67807662e+00 -1.17951543e+00 -2.42943729e-01 -2.42943729e-01
 -2.42943729e-01  8.31402802e-01  5.04732969e+00  2.02528470e+01
  7.69487818e+01  2.71094358e+02  8.98883799e+02  3.15150192e+03
  1.26309833e+04  4.12276178e+04  1.05255527e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6765487988581  E_coul = 198.68601863290814
cycle= 4 E= -507.99053016595  delta_E= -5.22e-06  |g|= 0.000238  |ddm|= 0.0106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176049
diis-c [-6.97329452e-10 -9.76185510e-06  6.95189515e-03 -9.74560521e-02
  1.09051392e+00]
  HOMO = -0.243092420532094  LUMO = 0.831360531181259
  mo_energy =
[-1.20327182e+02 -1.23813095e+01 -6.67840275e+00 -6.67840275e+00
 -6.67840275e+00 -1.17960574e+00 -2.43092421e-01 -2.43092421e-01
 -2.43092421e-01  8.31360531e-01  5.04713543e+00  2.02525553e+01
  7.69484572e+01  2.71094028e+02  8.98883468e+02  3.15150159e+03
  1.26309830e+04  4.12276175e+04  1.05255526e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6758260780485  E_coul = 198.68529589695842
cycle= 5 E= -507.99053018109  delta_E= -1.51e-08  |g|= 6.91e-06  |ddm|= 0.000711
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.04621e-06
diis-c [-1.07241982e-12  6.62621897e-07 -6.11615166e-04  8.17487370e-03
 -9.87104942e-02  1.09114657e+00]
  HOMO = -0.243095491232112  LUMO = 0.831359691265409
  mo_energy =
[-1.20327189e+02 -1.23813153e+01 -6.67840866e+00 -6.67840866e+00
 -6.67840866e+00 -1.17960785e+00 -2.43095491e-01 -2.43095491e-01
 -2.43095491e-01  8.31359691e-01  5.04713133e+00  2.02525499e+01
  7.69484512e+01  2.71094021e+02  8.98883462e+02  3.15150158e+03
  1.26309830e+04  4.12276175e+04  1.05255526e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6758102988069  E_coul = 198.68528011770624
cycle= 6 E= -507.990530181101  delta_E= -1.06e-11  |g|= 8.91e-08  |ddm|= 2.17e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758102988069  E_coul = 198.68528011770624
  HOMO = -0.243095532570312  LUMO = 0.831359667418765
  mo_energy =
[-1.20327189e+02 -1.23813154e+01 -6.67840874e+00 -6.67840874e+00
 -6.67840874e+00 -1.17960786e+00 -2.43095533e-01 -2.43095533e-01
 -2.43095533e-01  8.31359667e-01  5.04713127e+00  2.02525498e+01
  7.69484511e+01  2.71094021e+02  8.98883461e+02  3.15150158e+03
  1.26309830e+04  4.12276175e+04  1.05255526e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6758101194698  E_coul = 198.68527993836966
Extra cycle  E= -507.9905301811  delta_E= 5.12e-13  |g|= 1.15e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.22516374e-01 5.71636994e-01 1.74784832e+00 1.17616813e+05
 3.69340452e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231400e+03
 1.83757710e+04 1.44358566e+03 4.17367115e+02 1.47799850e+02
 5.83915438e+01 2.46491478e+01 8.26938122e+00 8.60436544e+00
 4.92766828e-01]
E = -507.99053018110016
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.222516373624       1
[INPUT] 0    0    [1    /1   ]  0.571636994199       1
[INPUT] 0    0    [1    /1   ]  1.74784831961        1
[INPUT] 0    0    [1    /1   ]  117616.81288         1
[INPUT] 0    0    [1    /1   ]  3.69340452477        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175253        1
[INPUT] 0    0    [1    /1   ]  36754.7014159        1
[INPUT] 0    0    [1    /1   ]  7302.31399792        1
[INPUT] 0    0    [1    /1   ]  18375.7710483        1
[INPUT] 0    0    [1    /1   ]  1443.58565853        1
[INPUT] 0    0    [1    /1   ]  417.367114715        1
[INPUT] 0    0    [1    /1   ]  147.799849581        1
[INPUT] 0    0    [1    /1   ]  58.3915437541        1
[INPUT] 0    0    [1    /1   ]  24.6491477872        1
[INPUT] 0    0    [1    /1   ]  8.26938121758        1
[INPUT] 1    0    [1    /1   ]  8.60436544163        1
[INPUT] 1    0    [1    /1   ]  0.492766828173       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22251637362385898, 1.0]], [0, [0.5716369941985191, 1.0]], [0, [1.7478483196133816, 1.0]], [0, [117616.81288049534, 1.0]], [0, [3.6934045247693152, 1.0]], [0, [1176168.1426133928, 1.0]], [0, [588084.0699563011, 1.0]], [0, [294042.03092003806, 1.0]], [0, [147020.99131779608, 1.0]], [0, [73510.41752533079, 1.0]], [0, [36754.701415885065, 1.0]], [0, [7302.313997921203, 1.0]], [0, [18375.771048279345, 1.0]], [0, [1443.5856585296542, 1.0]], [0, [417.3671147154597, 1.0]], [0, [147.79984958057875, 1.0]], [0, [58.39154375414441, 1.0]], [0, [24.649147787212613, 1.0]], [0, [8.269381217576367, 1.0]], [1, [8.604365441628671, 1.0]], [1, [0.4927668281734086, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22251637]
bas 1, expnt(s) = [0.57163699]
bas 2, expnt(s) = [1.74784832]
bas 3, expnt(s) = [117616.8128805]
bas 4, expnt(s) = [3.69340452]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.0699563]
bas 7, expnt(s) = [294042.03092004]
bas 8, expnt(s) = [147020.9913178]
bas 9, expnt(s) = [73510.41752533]
bas 10, expnt(s) = [36754.70141589]
bas 11, expnt(s) = [7302.31399792]
bas 12, expnt(s) = [18375.77104828]
bas 13, expnt(s) = [1443.58565853]
bas 14, expnt(s) = [417.36711472]
bas 15, expnt(s) = [147.79984958]
bas 16, expnt(s) = [58.39154375]
bas 17, expnt(s) = [24.64914779]
bas 18, expnt(s) = [8.26938122]
bas 19, expnt(s) = [8.60436544]
bas 20, expnt(s) = [0.49276683]
CPU time:       707.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.22516374e-01 8.18533587e-01 5.71636994e-01 1.66094507e+00
 1.74784832e+00 3.84054475e+00 1.17616813e+05 1.60460108e+04
 3.69340452e+00 6.73108666e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231400e+03 1.99576959e+03
 1.83757710e+04 3.98748629e+03 1.44358566e+03 5.91693698e+02
 4.17367115e+02 2.33294067e+02 1.47799850e+02 1.07095326e+02
 5.83915438e+01 5.33675778e+01 2.46491478e+01 2.79490117e+01
 8.26938122e+00 1.23202575e+01 8.60436544e+00 4.29915350e+01
 4.92766828e-01 1.20444292e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608773633164
cond(S) = 912511.7392044206
E1 = -689.5969759910921  E_coul = 184.97228441690604
init E= -504.624691574186
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672153586193247  LUMO = 0.498146109673198
  mo_energy =
[-1.21709653e+02 -1.33861737e+01 -7.62355228e+00 -7.62355228e+00
 -7.62355228e+00 -1.65760155e+00 -6.72153586e-01 -6.72153586e-01
 -6.72153586e-01  4.98146110e-01  4.47506076e+00  1.93922082e+01
  7.57768027e+01  2.69757400e+02  8.97524752e+02  3.15021737e+03
  1.26298160e+04  4.12265217e+04  1.05254469e+05  2.30427429e+05
  4.56234820e+05  8.45181340e+05  1.52835305e+06  2.85061361e+06
  5.80849211e+06]
E1 = -707.7567397296898  E_coul = 199.78429943307347
cycle= 1 E= -507.972440296616  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.757549
diis-c [-0.5738804  1.       ]
  HOMO = -0.217555396903183  LUMO = 0.835409885600304
  mo_energy =
[-1.20200013e+02 -1.23045175e+01 -6.59386416e+00 -6.59386416e+00
 -6.59386416e+00 -1.16329128e+00 -2.17555397e-01 -2.17555397e-01
 -2.17555397e-01  8.35409886e-01  5.07762542e+00  2.03151483e+01
  7.70417404e+01  2.71210287e+02  8.99016558e+02  3.15164971e+03
  1.26311418e+04  4.12277804e+04  1.05255691e+05  2.30428626e+05
  4.56236000e+05  8.45182507e+05  1.52835421e+06  2.85061475e+06
  5.80849325e+06]
E1 = -706.8011612883341  E_coul = 198.81090159166465
cycle= 2 E= -507.990259696669  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0351409
diis-c [-0.00122875 -0.00328443  1.00328443]
  HOMO = -0.239769388235269  LUMO = 0.832098399824144
  mo_energy =
[-1.20315088e+02 -1.23723892e+01 -6.66900724e+00 -6.66900724e+00
 -6.66900724e+00 -1.17759028e+00 -2.39769388e-01 -2.39769388e-01
 -2.39769388e-01  8.32098400e-01  5.05129972e+00  2.02600524e+01
  7.69584007e+01  2.71105455e+02  8.98895799e+02  3.15151461e+03
  1.26309965e+04  4.12276312e+04  1.05255540e+05  2.30428475e+05
  4.56235848e+05  8.45182355e+05  1.52835405e+06  2.85061460e+06
  5.80849309e+06]
E1 = -706.6920579366678  E_coul = 198.70153299458337
cycle= 3 E= -507.990524942084  delta_E= -0.000265  |g|= 0.00438  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00390075
diis-c [-3.35491352e-06  1.09292966e-04 -1.09082172e-01  1.10897288e+00]
  HOMO = -0.242943728802737  LUMO = 0.831402801867342
  mo_energy =
[-1.20326852e+02 -1.23809781e+01 -6.67807662e+00 -6.67807662e+00
 -6.67807662e+00 -1.17951543e+00 -2.42943729e-01 -2.42943729e-01
 -2.42943729e-01  8.31402802e-01  5.04732969e+00  2.02528470e+01
  7.69487818e+01  2.71094358e+02  8.98883799e+02  3.15150192e+03
  1.26309833e+04  4.12276178e+04  1.05255527e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6765487988581  E_coul = 198.68601863290814
cycle= 4 E= -507.99053016595  delta_E= -5.22e-06  |g|= 0.000238  |ddm|= 0.0106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000176049
diis-c [-6.97329452e-10 -9.76185510e-06  6.95189515e-03 -9.74560521e-02
  1.09051392e+00]
  HOMO = -0.243092420532094  LUMO = 0.831360531181259
  mo_energy =
[-1.20327182e+02 -1.23813095e+01 -6.67840275e+00 -6.67840275e+00
 -6.67840275e+00 -1.17960574e+00 -2.43092421e-01 -2.43092421e-01
 -2.43092421e-01  8.31360531e-01  5.04713543e+00  2.02525553e+01
  7.69484572e+01  2.71094028e+02  8.98883468e+02  3.15150159e+03
  1.26309830e+04  4.12276175e+04  1.05255526e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6758260780485  E_coul = 198.68529589695842
cycle= 5 E= -507.99053018109  delta_E= -1.51e-08  |g|= 6.91e-06  |ddm|= 0.000711
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.04621e-06
diis-c [-1.07241982e-12  6.62621897e-07 -6.11615166e-04  8.17487370e-03
 -9.87104942e-02  1.09114657e+00]
  HOMO = -0.243095491232112  LUMO = 0.831359691265409
  mo_energy =
[-1.20327189e+02 -1.23813153e+01 -6.67840866e+00 -6.67840866e+00
 -6.67840866e+00 -1.17960785e+00 -2.43095491e-01 -2.43095491e-01
 -2.43095491e-01  8.31359691e-01  5.04713133e+00  2.02525499e+01
  7.69484512e+01  2.71094021e+02  8.98883462e+02  3.15150158e+03
  1.26309830e+04  4.12276175e+04  1.05255526e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6758102988069  E_coul = 198.68528011770624
cycle= 6 E= -507.990530181101  delta_E= -1.06e-11  |g|= 8.91e-08  |ddm|= 2.17e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758102988069  E_coul = 198.68528011770624
  HOMO = -0.243095532570312  LUMO = 0.831359667418765
  mo_energy =
[-1.20327189e+02 -1.23813154e+01 -6.67840874e+00 -6.67840874e+00
 -6.67840874e+00 -1.17960786e+00 -2.43095533e-01 -2.43095533e-01
 -2.43095533e-01  8.31359667e-01  5.04713127e+00  2.02525498e+01
  7.69484511e+01  2.71094021e+02  8.98883461e+02  3.15150158e+03
  1.26309830e+04  4.12276175e+04  1.05255526e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6758101194698  E_coul = 198.68527993836966
Extra cycle  E= -507.9905301811  delta_E= 5.12e-13  |g|= 1.15e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912511.7392044206
E1 = -706.6758101194698  E_coul = 198.68527993836966
init E= -507.9905301811
    CPU time for initialize scf      5.57 sec, wall time      0.24 sec
  HOMO = -0.243095538449139  LUMO = 0.831359663712544
  mo_energy =
[-1.20327189e+02 -1.23813154e+01 -6.67840875e+00 -6.67840875e+00
 -6.67840875e+00 -1.17960787e+00 -2.43095538e-01 -2.43095538e-01
 -2.43095538e-01  8.31359664e-01  5.04713126e+00  2.02525498e+01
  7.69484511e+01  2.71094021e+02  8.98883461e+02  3.15150158e+03
  1.26309830e+04  4.12276175e+04  1.05255526e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.6758100926144  E_coul = 198.68527991151385
cycle= 1 E= -507.990530181101  delta_E= -3.98e-13  |g|= 2.98e-09  |ddm|= 2.75e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6758100926144  E_coul = 198.68527991151385
  HOMO = -0.243095539279732  LUMO = 0.831359665077914
  mo_energy =
[-1.20327189e+02 -1.23813154e+01 -6.67840875e+00 -6.67840875e+00
 -6.67840875e+00 -1.17960787e+00 -2.43095539e-01 -2.43095539e-01
 -2.43095539e-01  8.31359665e-01  5.04713126e+00  2.02525498e+01
  7.69484511e+01  2.71094021e+02  8.98883461e+02  3.15150158e+03
  1.26309830e+04  4.12276175e+04  1.05255526e+05  2.30428461e+05
  4.56235834e+05  8.45182341e+05  1.52835404e+06  2.85061458e+06
  5.80849308e+06]
E1 = -706.675810084737  E_coul = 198.685279903637
Extra cycle  E= -507.9905301811  delta_E= 5.68e-13  |g|= 1.14e-09  |ddm|= 8.15e-09
    CPU time for scf_cycle      6.09 sec, wall time      0.40 sec
exp = [2.22516374e-01 5.71636994e-01 1.74784832e+00 1.17616813e+05
 3.69340452e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231400e+03
 1.83757710e+04 1.44358566e+03 4.17367115e+02 1.47799850e+02
 5.83915438e+01 2.46491478e+01 8.26938122e+00 8.60436544e+00
 4.92766828e-01]
grad_E = [ 3.58935286e-05 -1.49500480e-04  1.95884474e-04  6.05035861e-09
  4.17162115e-05  4.03065969e-11  1.73764586e-10  9.38477342e-10
  3.70777284e-09  1.54826177e-08  8.07705934e-08  5.09091555e-06
  1.97877008e-07 -3.80297434e-05 -9.91434226e-06  1.81561914e-05
 -3.94099865e-05 -2.79395290e-05 -2.74324032e-04  2.55119045e-05
  4.19014754e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:46 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.223113957771       1
[INPUT] 0    0    [1    /1   ]  0.573937699516       1
[INPUT] 0    0    [1    /1   ]  1.75874303477        1
[INPUT] 0    0    [1    /1   ]  117616.81288         1
[INPUT] 0    0    [1    /1   ]  3.71014124161        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175247        1
[INPUT] 0    0    [1    /1   ]  36754.7014125        1
[INPUT] 0    0    [1    /1   ]  7302.31378465        1
[INPUT] 0    0    [1    /1   ]  18375.77104          1
[INPUT] 0    0    [1    /1   ]  1443.58726619        1
[INPUT] 0    0    [1    /1   ]  417.367371961        1
[INPUT] 0    0    [1    /1   ]  147.799765241        1
[INPUT] 0    0    [1    /1   ]  58.3913613195        1
[INPUT] 0    0    [1    /1   ]  24.6509471943        1
[INPUT] 0    0    [1    /1   ]  8.28261512602        1
[INPUT] 1    0    [1    /1   ]  8.60448425481        1
[INPUT] 1    0    [1    /1   ]  0.492783657457       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22311395777132945, 1.0]], [0, [0.5739376995164078, 1.0]], [0, [1.758743034774442, 1.0]], [0, [117616.81288024185, 1.0]], [0, [3.7101412416142256, 1.0]], [0, [1176168.1426133912, 1.0]], [0, [588084.0699562938, 1.0]], [0, [294042.03091999877, 1.0]], [0, [147020.99131764073, 1.0]], [0, [73510.4175246821, 1.0]], [0, [36754.70141250143, 1.0]], [0, [7302.313784649588, 1.0]], [0, [18375.7710399843, 1.0]], [0, [1443.5872661928524, 1.0]], [0, [417.3673719613421, 1.0]], [0, [147.7997652414418, 1.0]], [0, [58.39136131951553, 1.0]], [0, [24.65094719426809, 1.0]], [0, [8.282615126021403, 1.0]], [1, [8.604484254811823, 1.0]], [1, [0.49278365745709013, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22311396]
bas 1, expnt(s) = [0.5739377]
bas 2, expnt(s) = [1.75874303]
bas 3, expnt(s) = [117616.81288024]
bas 4, expnt(s) = [3.71014124]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.06995629]
bas 7, expnt(s) = [294042.03092]
bas 8, expnt(s) = [147020.99131764]
bas 9, expnt(s) = [73510.41752468]
bas 10, expnt(s) = [36754.7014125]
bas 11, expnt(s) = [7302.31378465]
bas 12, expnt(s) = [18375.77103998]
bas 13, expnt(s) = [1443.58726619]
bas 14, expnt(s) = [417.36737196]
bas 15, expnt(s) = [147.79976524]
bas 16, expnt(s) = [58.39136132]
bas 17, expnt(s) = [24.65094719]
bas 18, expnt(s) = [8.28261513]
bas 19, expnt(s) = [8.60448425]
bas 20, expnt(s) = [0.49278366]
CPU time:       722.29
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.23113958e-01 8.20181708e-01 5.73937700e-01 1.66595624e+00
 1.75874303e+00 3.85848501e+00 1.17616813e+05 1.60460108e+04
 3.71014124e+00 6.75395024e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231378e+03 1.99576955e+03
 1.83757710e+04 3.98748629e+03 1.44358727e+03 5.91694192e+02
 4.17367372e+02 2.33294175e+02 1.47799765e+02 1.07095280e+02
 5.83913613e+01 5.33674528e+01 2.46509472e+01 2.79505419e+01
 8.28261513e+00 1.23350421e+01 8.60448425e+00 4.29922771e+01
 4.92783657e-01 1.20449434e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33606366785774
cond(S) = 912517.189821635
E1 = -689.5981123411058  E_coul = 184.97336858072242
init E= -504.624743760383
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672133221298932  LUMO = 0.501769635361661
  mo_energy =
[-1.21709494e+02 -1.33860891e+01 -7.62348198e+00 -7.62348198e+00
 -7.62348198e+00 -1.65757955e+00 -6.72133221e-01 -6.72133221e-01
 -6.72133221e-01  5.01769635e-01  4.50751698e+00  1.94986453e+01
  7.59521617e+01  2.69942715e+02  8.97697020e+02  3.15037436e+03
  1.26299579e+04  4.12266543e+04  1.05254596e+05  2.30427553e+05
  4.56234941e+05  8.45181459e+05  1.52835317e+06  2.85061372e+06
  5.80849222e+06]
E1 = -707.7581013637115  E_coul = 199.78566145813426
cycle= 1 E= -507.972439905577  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.757596
diis-c [-0.5739518  1.       ]
  HOMO = -0.217519799532803  LUMO = 0.839871490063738
  mo_energy =
[-1.20199834e+02 -1.23044157e+01 -6.59377672e+00 -6.59377672e+00
 -6.59377672e+00 -1.16326080e+00 -2.17519800e-01 -2.17519800e-01
 -2.17519800e-01  8.39871490e-01  5.11163346e+00  2.04225898e+01
  7.72171755e+01  2.71395579e+02  8.99188831e+02  3.15180671e+03
  1.26312838e+04  4.12279130e+04  1.05255818e+05  2.30428750e+05
  4.56236121e+05  8.45182626e+05  1.52835432e+06  2.85061487e+06
  5.80849336e+06]
E1 = -706.8025038933897  E_coul = 198.81224300728485
cycle= 2 E= -507.990260886105  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350788
diis-c [-0.00122451 -0.00325164  1.00325164]
  HOMO = -0.239734075129304  LUMO = 0.836526759540689
  mo_energy =
[-1.20314908e+02 -1.23722863e+01 -6.66891864e+00 -6.66891864e+00
 -6.66891864e+00 -1.17755930e+00 -2.39734075e-01 -2.39734075e-01
 -2.39734075e-01  8.36526760e-01  5.08516600e+00  2.03674029e+01
  7.71338236e+01  2.71290751e+02  8.99068076e+02  3.15167162e+03
  1.26311384e+04  4.12277638e+04  1.05255667e+05  2.30428599e+05
  4.56235969e+05  8.45182474e+05  1.52835417e+06  2.85061471e+06
  5.80849320e+06]
E1 = -706.6934418674504  E_coul = 198.70291592592807
cycle= 3 E= -507.990525941522  delta_E= -0.000265  |g|= 0.00437  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00388898
diis-c [-3.34432440e-06  1.11739411e-04 -1.08886110e-01  1.10877437e+00]
  HOMO = -0.242906722131527  LUMO = 0.835826306669332
  mo_energy =
[-1.20326669e+02 -1.23808725e+01 -6.67798539e+00 -6.67798539e+00
 -6.67798539e+00 -1.17948325e+00 -2.42906722e-01 -2.42906722e-01
 -2.42906722e-01  8.35826307e-01  5.08117994e+00  2.03601909e+01
  7.71242061e+01  2.71279656e+02  8.99056078e+02  3.15165892e+03
  1.26311253e+04  4.12277505e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.677949208478  E_coul = 198.6874180558934
cycle= 4 E= -507.990531152585  delta_E= -5.21e-06  |g|= 0.000237  |ddm|= 0.0106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000175815
diis-c [-6.83023922e-10 -9.72800458e-06  6.94236860e-03 -9.75189976e-02
  1.09058636e+00]
  HOMO = -0.243055599133081  LUMO = 0.835783788063647
  mo_energy =
[-1.20327001e+02 -1.23812048e+01 -6.67831261e+00 -6.67831261e+00
 -6.67831261e+00 -1.17957365e+00 -2.43055599e-01 -2.43055599e-01
 -2.43055599e-01  8.35783788e-01  5.08098477e+00  2.03598982e+01
  7.71238803e+01  2.71279325e+02  8.99055745e+02  3.15165859e+03
  1.26311250e+04  4.12277502e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.6772261901049  E_coul = 198.686695022441
cycle= 5 E= -507.990531167664  delta_E= -1.51e-08  |g|= 6.81e-06  |ddm|= 0.000708
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.00135e-06
diis-c [-1.05770462e-12  6.60513349e-07 -6.06270259e-04  8.11960626e-03
 -9.79331143e-02  1.09041912e+00]
  HOMO = -0.24305863474  LUMO = 0.835782954897771
  mo_energy =
[-1.20327008e+02 -1.23812106e+01 -6.67831846e+00 -6.67831846e+00
 -6.67831846e+00 -1.17957573e+00 -2.43058635e-01 -2.43058635e-01
 -2.43058635e-01  8.35782955e-01  5.08098070e+00  2.03598929e+01
  7.71238743e+01  2.71279318e+02  8.99055739e+02  3.15165858e+03
  1.26311249e+04  4.12277502e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.6772106110998  E_coul = 198.68667944342604
cycle= 6 E= -507.990531167674  delta_E= -9.83e-12  |g|= 8.88e-08  |ddm|= 2.14e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6772106110998  E_coul = 198.68667944342604
  HOMO = -0.243058676323973  LUMO = 0.835782930183476
  mo_energy =
[-1.20327008e+02 -1.23812107e+01 -6.67831854e+00 -6.67831854e+00
 -6.67831854e+00 -1.17957574e+00 -2.43058676e-01 -2.43058676e-01
 -2.43058676e-01  8.35782930e-01  5.08098064e+00  2.03598928e+01
  7.71238742e+01  2.71279318e+02  8.99055739e+02  3.15165858e+03
  1.26311249e+04  4.12277502e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.6772104307626  E_coul = 198.6866792630886
Extra cycle  E= -507.990531167674  delta_E= -2.27e-13  |g|= 1.12e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.23113958e-01 5.73937700e-01 1.75874303e+00 1.17616813e+05
 3.71014124e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231378e+03
 1.83757710e+04 1.44358727e+03 4.17367372e+02 1.47799765e+02
 5.83913613e+01 2.46509472e+01 8.28261513e+00 8.60448425e+00
 4.92783657e-01]
E = -507.99053116767396
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:47 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.223113957771       1
[INPUT] 0    0    [1    /1   ]  0.573937699516       1
[INPUT] 0    0    [1    /1   ]  1.75874303477        1
[INPUT] 0    0    [1    /1   ]  117616.81288         1
[INPUT] 0    0    [1    /1   ]  3.71014124161        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991318        1
[INPUT] 0    0    [1    /1   ]  73510.4175247        1
[INPUT] 0    0    [1    /1   ]  36754.7014125        1
[INPUT] 0    0    [1    /1   ]  7302.31378465        1
[INPUT] 0    0    [1    /1   ]  18375.77104          1
[INPUT] 0    0    [1    /1   ]  1443.58726619        1
[INPUT] 0    0    [1    /1   ]  417.367371961        1
[INPUT] 0    0    [1    /1   ]  147.799765241        1
[INPUT] 0    0    [1    /1   ]  58.3913613195        1
[INPUT] 0    0    [1    /1   ]  24.6509471943        1
[INPUT] 0    0    [1    /1   ]  8.28261512602        1
[INPUT] 1    0    [1    /1   ]  8.60448425481        1
[INPUT] 1    0    [1    /1   ]  0.492783657457       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22311395777132945, 1.0]], [0, [0.5739376995164078, 1.0]], [0, [1.758743034774442, 1.0]], [0, [117616.81288024185, 1.0]], [0, [3.7101412416142256, 1.0]], [0, [1176168.1426133912, 1.0]], [0, [588084.0699562938, 1.0]], [0, [294042.03091999877, 1.0]], [0, [147020.99131764073, 1.0]], [0, [73510.4175246821, 1.0]], [0, [36754.70141250143, 1.0]], [0, [7302.313784649588, 1.0]], [0, [18375.7710399843, 1.0]], [0, [1443.5872661928524, 1.0]], [0, [417.3673719613421, 1.0]], [0, [147.7997652414418, 1.0]], [0, [58.39136131951553, 1.0]], [0, [24.65094719426809, 1.0]], [0, [8.282615126021403, 1.0]], [1, [8.604484254811823, 1.0]], [1, [0.49278365745709013, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22311396]
bas 1, expnt(s) = [0.5739377]
bas 2, expnt(s) = [1.75874303]
bas 3, expnt(s) = [117616.81288024]
bas 4, expnt(s) = [3.71014124]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.06995629]
bas 7, expnt(s) = [294042.03092]
bas 8, expnt(s) = [147020.99131764]
bas 9, expnt(s) = [73510.41752468]
bas 10, expnt(s) = [36754.7014125]
bas 11, expnt(s) = [7302.31378465]
bas 12, expnt(s) = [18375.77103998]
bas 13, expnt(s) = [1443.58726619]
bas 14, expnt(s) = [417.36737196]
bas 15, expnt(s) = [147.79976524]
bas 16, expnt(s) = [58.39136132]
bas 17, expnt(s) = [24.65094719]
bas 18, expnt(s) = [8.28261513]
bas 19, expnt(s) = [8.60448425]
bas 20, expnt(s) = [0.49278366]
CPU time:       724.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.23113958e-01 8.20181708e-01 5.73937700e-01 1.66595624e+00
 1.75874303e+00 3.85848501e+00 1.17616813e+05 1.60460108e+04
 3.71014124e+00 6.75395024e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231378e+03 1.99576955e+03
 1.83757710e+04 3.98748629e+03 1.44358727e+03 5.91694192e+02
 4.17367372e+02 2.33294175e+02 1.47799765e+02 1.07095280e+02
 5.83913613e+01 5.33674528e+01 2.46509472e+01 2.79505419e+01
 8.28261513e+00 1.23350421e+01 8.60448425e+00 4.29922771e+01
 4.92783657e-01 1.20449434e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33606366785774
cond(S) = 912517.189821635
E1 = -689.5981123411058  E_coul = 184.97336858072242
init E= -504.624743760383
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672133221298932  LUMO = 0.501769635361661
  mo_energy =
[-1.21709494e+02 -1.33860891e+01 -7.62348198e+00 -7.62348198e+00
 -7.62348198e+00 -1.65757955e+00 -6.72133221e-01 -6.72133221e-01
 -6.72133221e-01  5.01769635e-01  4.50751698e+00  1.94986453e+01
  7.59521617e+01  2.69942715e+02  8.97697020e+02  3.15037436e+03
  1.26299579e+04  4.12266543e+04  1.05254596e+05  2.30427553e+05
  4.56234941e+05  8.45181459e+05  1.52835317e+06  2.85061372e+06
  5.80849222e+06]
E1 = -707.7581013637115  E_coul = 199.78566145813426
cycle= 1 E= -507.972439905577  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.757596
diis-c [-0.5739518  1.       ]
  HOMO = -0.217519799532803  LUMO = 0.839871490063738
  mo_energy =
[-1.20199834e+02 -1.23044157e+01 -6.59377672e+00 -6.59377672e+00
 -6.59377672e+00 -1.16326080e+00 -2.17519800e-01 -2.17519800e-01
 -2.17519800e-01  8.39871490e-01  5.11163346e+00  2.04225898e+01
  7.72171755e+01  2.71395579e+02  8.99188831e+02  3.15180671e+03
  1.26312838e+04  4.12279130e+04  1.05255818e+05  2.30428750e+05
  4.56236121e+05  8.45182626e+05  1.52835432e+06  2.85061487e+06
  5.80849336e+06]
E1 = -706.8025038933897  E_coul = 198.81224300728485
cycle= 2 E= -507.990260886105  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350788
diis-c [-0.00122451 -0.00325164  1.00325164]
  HOMO = -0.239734075129304  LUMO = 0.836526759540689
  mo_energy =
[-1.20314908e+02 -1.23722863e+01 -6.66891864e+00 -6.66891864e+00
 -6.66891864e+00 -1.17755930e+00 -2.39734075e-01 -2.39734075e-01
 -2.39734075e-01  8.36526760e-01  5.08516600e+00  2.03674029e+01
  7.71338236e+01  2.71290751e+02  8.99068076e+02  3.15167162e+03
  1.26311384e+04  4.12277638e+04  1.05255667e+05  2.30428599e+05
  4.56235969e+05  8.45182474e+05  1.52835417e+06  2.85061471e+06
  5.80849320e+06]
E1 = -706.6934418674504  E_coul = 198.70291592592807
cycle= 3 E= -507.990525941522  delta_E= -0.000265  |g|= 0.00437  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00388898
diis-c [-3.34432440e-06  1.11739411e-04 -1.08886110e-01  1.10877437e+00]
  HOMO = -0.242906722131527  LUMO = 0.835826306669332
  mo_energy =
[-1.20326669e+02 -1.23808725e+01 -6.67798539e+00 -6.67798539e+00
 -6.67798539e+00 -1.17948325e+00 -2.42906722e-01 -2.42906722e-01
 -2.42906722e-01  8.35826307e-01  5.08117994e+00  2.03601909e+01
  7.71242061e+01  2.71279656e+02  8.99056078e+02  3.15165892e+03
  1.26311253e+04  4.12277505e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.677949208478  E_coul = 198.6874180558934
cycle= 4 E= -507.990531152585  delta_E= -5.21e-06  |g|= 0.000237  |ddm|= 0.0106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000175815
diis-c [-6.83023922e-10 -9.72800458e-06  6.94236860e-03 -9.75189976e-02
  1.09058636e+00]
  HOMO = -0.243055599133081  LUMO = 0.835783788063647
  mo_energy =
[-1.20327001e+02 -1.23812048e+01 -6.67831261e+00 -6.67831261e+00
 -6.67831261e+00 -1.17957365e+00 -2.43055599e-01 -2.43055599e-01
 -2.43055599e-01  8.35783788e-01  5.08098477e+00  2.03598982e+01
  7.71238803e+01  2.71279325e+02  8.99055745e+02  3.15165859e+03
  1.26311250e+04  4.12277502e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.6772261901049  E_coul = 198.686695022441
cycle= 5 E= -507.990531167664  delta_E= -1.51e-08  |g|= 6.81e-06  |ddm|= 0.000708
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.00135e-06
diis-c [-1.05770462e-12  6.60513349e-07 -6.06270259e-04  8.11960626e-03
 -9.79331143e-02  1.09041912e+00]
  HOMO = -0.24305863474  LUMO = 0.835782954897771
  mo_energy =
[-1.20327008e+02 -1.23812106e+01 -6.67831846e+00 -6.67831846e+00
 -6.67831846e+00 -1.17957573e+00 -2.43058635e-01 -2.43058635e-01
 -2.43058635e-01  8.35782955e-01  5.08098070e+00  2.03598929e+01
  7.71238743e+01  2.71279318e+02  8.99055739e+02  3.15165858e+03
  1.26311249e+04  4.12277502e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.6772106110998  E_coul = 198.68667944342604
cycle= 6 E= -507.990531167674  delta_E= -9.83e-12  |g|= 8.88e-08  |ddm|= 2.14e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6772106110998  E_coul = 198.68667944342604
  HOMO = -0.243058676323973  LUMO = 0.835782930183476
  mo_energy =
[-1.20327008e+02 -1.23812107e+01 -6.67831854e+00 -6.67831854e+00
 -6.67831854e+00 -1.17957574e+00 -2.43058676e-01 -2.43058676e-01
 -2.43058676e-01  8.35782930e-01  5.08098064e+00  2.03598928e+01
  7.71238742e+01  2.71279318e+02  8.99055739e+02  3.15165858e+03
  1.26311249e+04  4.12277502e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.6772104307626  E_coul = 198.6866792630886
Extra cycle  E= -507.990531167674  delta_E= -2.27e-13  |g|= 1.12e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912517.189821635
E1 = -706.6772104307626  E_coul = 198.6866792630886
init E= -507.990531167674
    CPU time for initialize scf      5.70 sec, wall time      0.24 sec
  HOMO = -0.243058682223634  LUMO = 0.835782928536947
  mo_energy =
[-1.20327008e+02 -1.23812107e+01 -6.67831856e+00 -6.67831856e+00
 -6.67831856e+00 -1.17957575e+00 -2.43058682e-01 -2.43058682e-01
 -2.43058682e-01  8.35782929e-01  5.08098063e+00  2.03598928e+01
  7.71238742e+01  2.71279318e+02  8.99055739e+02  3.15165858e+03
  1.26311249e+04  4.12277502e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.6772104020502  E_coul = 198.68667923437664
cycle= 1 E= -507.990531167674  delta_E= 4.55e-13  |g|= 2.12e-09  |ddm|= 3.01e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6772104020502  E_coul = 198.68667923437664
  HOMO = -0.243058683124822  LUMO = 0.835782927976198
  mo_energy =
[-1.20327008e+02 -1.23812107e+01 -6.67831856e+00 -6.67831856e+00
 -6.67831856e+00 -1.17957575e+00 -2.43058683e-01 -2.43058683e-01
 -2.43058683e-01  8.35782928e-01  5.08098063e+00  2.03598928e+01
  7.71238742e+01  2.71279318e+02  8.99055739e+02  3.15165858e+03
  1.26311249e+04  4.12277502e+04  1.05255654e+05  2.30428585e+05
  4.56235955e+05  8.45182460e+05  1.52835416e+06  2.85061470e+06
  5.80849319e+06]
E1 = -706.6772103989981  E_coul = 198.6866792313243
Extra cycle  E= -507.990531167674  delta_E= -2.84e-13  |g|= 1.1e-09  |ddm|= 3.13e-09
    CPU time for scf_cycle      6.14 sec, wall time      0.41 sec
exp = [2.23113958e-01 5.73937700e-01 1.75874303e+00 1.17616813e+05
 3.71014124e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231378e+03
 1.83757710e+04 1.44358727e+03 4.17367372e+02 1.47799765e+02
 5.83913613e+01 2.46509472e+01 8.28261513e+00 8.60448425e+00
 4.92783657e-01]
grad_E = [-1.40081231e-04 -3.10272651e-05  1.72014748e-04  6.05036081e-09
  8.96187583e-05  4.03066308e-11  1.73764669e-10  9.38477668e-10
  3.70777422e-09  1.54826237e-08  8.07706230e-08  5.09092390e-06
  1.97877112e-07 -3.80315187e-05 -9.88844878e-06  1.79721629e-05
 -3.84284030e-05 -2.99989199e-05 -2.94057899e-04  1.08607496e-04
  9.15867113e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:54 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.224070746309       1
[INPUT] 0    0    [1    /1   ]  0.577656876768       1
[INPUT] 0    0    [1    /1   ]  1.77319485508        1
[INPUT] 0    0    [1    /1   ]  117616.81288         1
[INPUT] 0    0    [1    /1   ]  3.73751206207        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991317        1
[INPUT] 0    0    [1    /1   ]  73510.4175234        1
[INPUT] 0    0    [1    /1   ]  36754.7014057        1
[INPUT] 0    0    [1    /1   ]  7302.31335591        1
[INPUT] 0    0    [1    /1   ]  18375.7710233        1
[INPUT] 0    0    [1    /1   ]  1443.59049233        1
[INPUT] 0    0    [1    /1   ]  417.367951922        1
[INPUT] 0    0    [1    /1   ]  147.799325068        1
[INPUT] 0    0    [1    /1   ]  58.3917424212        1
[INPUT] 0    0    [1    /1   ]  24.6542764011        1
[INPUT] 0    0    [1    /1   ]  8.30813976113        1
[INPUT] 1    0    [1    /1   ]  8.60467480555        1
[INPUT] 1    0    [1    /1   ]  0.492810688314       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.224070746308963, 1.0]], [0, [0.5776568767679923, 1.0]], [0, [1.773194855075145, 1.0]], [0, [117616.81287973227, 1.0]], [0, [3.7375120620708002, 1.0]], [0, [1176168.1426133877, 1.0]], [0, [588084.0699562791, 1.0]], [0, [294042.0309199197, 1.0]], [0, [147020.99131732844, 1.0]], [0, [73510.41752337806, 1.0]], [0, [36754.70140569931, 1.0]], [0, [7302.313355910597, 1.0]], [0, [18375.771023310965, 1.0]], [0, [1443.5904923291725, 1.0]], [0, [417.36795192230016, 1.0]], [0, [147.7993250682245, 1.0]], [0, [58.391742421205336, 1.0]], [0, [24.65427640114165, 1.0]], [0, [8.308139761126341, 1.0]], [1, [8.604674805545878, 1.0]], [1, [0.49281068831368763, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22407075]
bas 1, expnt(s) = [0.57765688]
bas 2, expnt(s) = [1.77319486]
bas 3, expnt(s) = [117616.81287973]
bas 4, expnt(s) = [3.73751206]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.06995628]
bas 7, expnt(s) = [294042.03091992]
bas 8, expnt(s) = [147020.99131733]
bas 9, expnt(s) = [73510.41752338]
bas 10, expnt(s) = [36754.7014057]
bas 11, expnt(s) = [7302.31335591]
bas 12, expnt(s) = [18375.77102331]
bas 13, expnt(s) = [1443.59049233]
bas 14, expnt(s) = [417.36795192]
bas 15, expnt(s) = [147.79932507]
bas 16, expnt(s) = [58.39174242]
bas 17, expnt(s) = [24.6542764]
bas 18, expnt(s) = [8.30813976]
bas 19, expnt(s) = [8.60467481]
bas 20, expnt(s) = [0.49281069]
CPU time:       738.52
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.24070746e-01 8.22818210e-01 5.77656877e-01 1.67404638e+00
 1.77319486e+00 3.88223992e+00 1.17616813e+05 1.60460108e+04
 3.73751206e+00 6.79128532e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231336e+03 1.99576946e+03
 1.83757710e+04 3.98748628e+03 1.44359049e+03 5.91695183e+02
 4.17367952e+02 2.33294418e+02 1.47799325e+02 1.07095041e+02
 5.83917424e+01 5.33677140e+01 2.46542764e+01 2.79533730e+01
 8.30813976e+00 1.23635409e+01 8.60467481e+00 4.29934672e+01
 4.92810688e-01 1.20457693e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336024935887693
cond(S) = 912525.927595866
E1 = -689.599959965717  E_coul = 184.97512341277113
init E= -504.624836552946
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672100062504141  LUMO = 0.507521534093761
  mo_energy =
[-1.21709239e+02 -1.33859526e+01 -7.62336792e+00 -7.62336792e+00
 -7.62336792e+00 -1.65754417e+00 -6.72100063e-01 -6.72100063e-01
 -6.72100063e-01  5.07521534e-01  4.55599965e+00  1.96635854e+01
  7.62368975e+01  2.70249876e+02  8.97984567e+02  3.15063747e+03
  1.26301970e+04  4.12268782e+04  1.05254811e+05  2.30427762e+05
  4.56235145e+05  8.45181661e+05  1.52835337e+06  2.85061391e+06
  5.80849241e+06]
E1 = -707.7603051022573  E_coul = 199.78786536528216
cycle= 1 E= -507.972439736975  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.757647
diis-c [-0.57402851  1.        ]
  HOMO = -0.217462536875559  LUMO = 0.846923060030844
  mo_energy =
[-1.20199544e+02 -1.23042514e+01 -6.59363495e+00 -6.59363495e+00
 -6.59363495e+00 -1.16321191e+00 -2.17462537e-01 -2.17462537e-01
 -2.17462537e-01  8.46923060e-01  5.16240177e+00  2.05891675e+01
  7.75020757e+01  2.71702709e+02  8.99476391e+02  3.15206985e+03
  1.26315229e+04  4.12281369e+04  1.05256033e+05  2.30428959e+05
  4.56236325e+05  8.45182828e+05  1.52835452e+06  2.85061506e+06
  5.80849355e+06]
E1 = -706.8046638810254  E_coul = 198.8144002320654
cycle= 2 E= -507.99026364896  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0349944
diis-c [-0.00121877 -0.00320381  1.00320381]
  HOMO = -0.239677578463838  LUMO = 0.843527020450182
  mo_energy =
[-1.20314617e+02 -1.23721216e+01 -6.66877651e+00 -6.66877651e+00
 -6.66877651e+00 -1.17750974e+00 -2.39677578e-01 -2.39677578e-01
 -2.39677578e-01  8.43527020e-01  5.13572404e+00  2.05338356e+01
  7.74186995e+01  2.71597885e+02  8.99355638e+02  3.15193476e+03
  1.26313776e+04  4.12279877e+04  1.05255882e+05  2.30428808e+05
  4.56236173e+05  8.45182675e+05  1.52835437e+06  2.85061491e+06
  5.80849339e+06]
E1 = -706.6956709142199  E_coul = 198.70514253120612
cycle= 3 E= -507.990528383014  delta_E= -0.000265  |g|= 0.00437  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00387261
diis-c [-3.32870951e-06  1.14866026e-04 -1.08608518e-01  1.10849365e+00]
  HOMO = -0.242847416393026  LUMO = 0.842819165375392
  mo_energy =
[-1.20326375e+02 -1.23807033e+01 -6.67783885e+00 -6.67783885e+00
 -6.67783885e+00 -1.17943169e+00 -2.42847416e-01 -2.42847416e-01
 -2.42847416e-01  8.42819165e-01  5.13171478e+00  2.05266131e+01
  7.74090844e+01  2.71586795e+02  8.99343644e+02  3.15192207e+03
  1.26313644e+04  4.12279744e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182662e+05  1.52835436e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6802055445768  E_coul = 198.68967197178253
cycle= 4 E= -507.990533572794  delta_E= -5.19e-06  |g|= 0.000237  |ddm|= 0.0106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000175399
diis-c [-6.61149151e-10 -9.67827879e-06  6.92753439e-03 -9.75742114e-02
  1.09065636e+00]
  HOMO = -0.242996427545692  LUMO = 0.842776296185197
  mo_energy =
[-1.20326709e+02 -1.23810367e+01 -6.67816732e+00 -6.67816732e+00
 -6.67816732e+00 -1.17952214e+00 -2.42996428e-01 -2.42996428e-01
 -2.42996428e-01  8.42776296e-01  5.13151844e+00  2.05263193e+01
  7.74087571e+01  2.71586462e+02  8.99343309e+02  3.15192173e+03
  1.26313641e+04  4.12279740e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182661e+05  1.52835435e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6794828600938  E_coul = 198.68894927233814
cycle= 5 E= -507.990533587756  delta_E= -1.5e-08  |g|= 6.66e-06  |ddm|= 0.000703
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.93334e-06
diis-c [-1.03534653e-12  6.52740217e-07 -5.98158495e-04  8.03320539e-03
 -9.67670243e-02  1.08933132e+00]
  HOMO = -0.24299940874444  LUMO = 0.842775474768821
  mo_energy =
[-1.20326715e+02 -1.23810424e+01 -6.67817308e+00 -6.67817308e+00
 -6.67817308e+00 -1.17952419e+00 -2.42999409e-01 -2.42999409e-01
 -2.42999409e-01  8.42775475e-01  5.13151443e+00  2.05263141e+01
  7.74087512e+01  2.71586455e+02  8.99343303e+02  3.15192172e+03
  1.26313641e+04  4.12279740e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182661e+05  1.52835435e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6794675946852  E_coul = 198.6889340069194
cycle= 6 E= -507.990533587766  delta_E= -1.02e-11  |g|= 9e-08  |ddm|= 2.08e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6794675946852  E_coul = 198.6889340069194
  HOMO = -0.242999450554355  LUMO = 0.842775450461899
  mo_energy =
[-1.20326715e+02 -1.23810425e+01 -6.67817316e+00 -6.67817316e+00
 -6.67817316e+00 -1.17952420e+00 -2.42999451e-01 -2.42999451e-01
 -2.42999451e-01  8.42775450e-01  5.13151437e+00  2.05263140e+01
  7.74087511e+01  2.71586455e+02  8.99343303e+02  3.15192172e+03
  1.26313641e+04  4.12279740e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182661e+05  1.52835435e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6794674128402  E_coul = 198.68893382507466
Extra cycle  E= -507.990533587766  delta_E= 2.84e-13  |g|= 1.19e-08  |ddm|= 2.2e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.24070746e-01 5.77656877e-01 1.77319486e+00 1.17616813e+05
 3.73751206e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231336e+03
 1.83757710e+04 1.44359049e+03 4.17367952e+02 1.47799325e+02
 5.83917424e+01 2.46542764e+01 8.30813976e+00 8.60467481e+00
 4.92810688e-01]
E = -507.9905335877655
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:31:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.224070746309       1
[INPUT] 0    0    [1    /1   ]  0.577656876768       1
[INPUT] 0    0    [1    /1   ]  1.77319485508        1
[INPUT] 0    0    [1    /1   ]  117616.81288         1
[INPUT] 0    0    [1    /1   ]  3.73751206207        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991317        1
[INPUT] 0    0    [1    /1   ]  73510.4175234        1
[INPUT] 0    0    [1    /1   ]  36754.7014057        1
[INPUT] 0    0    [1    /1   ]  7302.31335591        1
[INPUT] 0    0    [1    /1   ]  18375.7710233        1
[INPUT] 0    0    [1    /1   ]  1443.59049233        1
[INPUT] 0    0    [1    /1   ]  417.367951922        1
[INPUT] 0    0    [1    /1   ]  147.799325068        1
[INPUT] 0    0    [1    /1   ]  58.3917424212        1
[INPUT] 0    0    [1    /1   ]  24.6542764011        1
[INPUT] 0    0    [1    /1   ]  8.30813976113        1
[INPUT] 1    0    [1    /1   ]  8.60467480555        1
[INPUT] 1    0    [1    /1   ]  0.492810688314       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.224070746308963, 1.0]], [0, [0.5776568767679923, 1.0]], [0, [1.773194855075145, 1.0]], [0, [117616.81287973227, 1.0]], [0, [3.7375120620708002, 1.0]], [0, [1176168.1426133877, 1.0]], [0, [588084.0699562791, 1.0]], [0, [294042.0309199197, 1.0]], [0, [147020.99131732844, 1.0]], [0, [73510.41752337806, 1.0]], [0, [36754.70140569931, 1.0]], [0, [7302.313355910597, 1.0]], [0, [18375.771023310965, 1.0]], [0, [1443.5904923291725, 1.0]], [0, [417.36795192230016, 1.0]], [0, [147.7993250682245, 1.0]], [0, [58.391742421205336, 1.0]], [0, [24.65427640114165, 1.0]], [0, [8.308139761126341, 1.0]], [1, [8.604674805545878, 1.0]], [1, [0.49281068831368763, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22407075]
bas 1, expnt(s) = [0.57765688]
bas 2, expnt(s) = [1.77319486]
bas 3, expnt(s) = [117616.81287973]
bas 4, expnt(s) = [3.73751206]
bas 5, expnt(s) = [1176168.14261339]
bas 6, expnt(s) = [588084.06995628]
bas 7, expnt(s) = [294042.03091992]
bas 8, expnt(s) = [147020.99131733]
bas 9, expnt(s) = [73510.41752338]
bas 10, expnt(s) = [36754.7014057]
bas 11, expnt(s) = [7302.31335591]
bas 12, expnt(s) = [18375.77102331]
bas 13, expnt(s) = [1443.59049233]
bas 14, expnt(s) = [417.36795192]
bas 15, expnt(s) = [147.79932507]
bas 16, expnt(s) = [58.39174242]
bas 17, expnt(s) = [24.6542764]
bas 18, expnt(s) = [8.30813976]
bas 19, expnt(s) = [8.60467481]
bas 20, expnt(s) = [0.49281069]
CPU time:       740.33
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.24070746e-01 8.22818210e-01 5.77656877e-01 1.67404638e+00
 1.77319486e+00 3.88223992e+00 1.17616813e+05 1.60460108e+04
 3.73751206e+00 6.79128532e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231336e+03 1.99576946e+03
 1.83757710e+04 3.98748628e+03 1.44359049e+03 5.91695183e+02
 4.17367952e+02 2.33294418e+02 1.47799325e+02 1.07095041e+02
 5.83917424e+01 5.33677140e+01 2.46542764e+01 2.79533730e+01
 8.30813976e+00 1.23635409e+01 8.60467481e+00 4.29934672e+01
 4.92810688e-01 1.20457693e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336024935887693
cond(S) = 912525.927595866
E1 = -689.599959965717  E_coul = 184.97512341277113
init E= -504.624836552946
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672100062504141  LUMO = 0.507521534093761
  mo_energy =
[-1.21709239e+02 -1.33859526e+01 -7.62336792e+00 -7.62336792e+00
 -7.62336792e+00 -1.65754417e+00 -6.72100063e-01 -6.72100063e-01
 -6.72100063e-01  5.07521534e-01  4.55599965e+00  1.96635854e+01
  7.62368975e+01  2.70249876e+02  8.97984567e+02  3.15063747e+03
  1.26301970e+04  4.12268782e+04  1.05254811e+05  2.30427762e+05
  4.56235145e+05  8.45181661e+05  1.52835337e+06  2.85061391e+06
  5.80849241e+06]
E1 = -707.7603051022573  E_coul = 199.78786536528216
cycle= 1 E= -507.972439736975  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.757647
diis-c [-0.57402851  1.        ]
  HOMO = -0.217462536875559  LUMO = 0.846923060030844
  mo_energy =
[-1.20199544e+02 -1.23042514e+01 -6.59363495e+00 -6.59363495e+00
 -6.59363495e+00 -1.16321191e+00 -2.17462537e-01 -2.17462537e-01
 -2.17462537e-01  8.46923060e-01  5.16240177e+00  2.05891675e+01
  7.75020757e+01  2.71702709e+02  8.99476391e+02  3.15206985e+03
  1.26315229e+04  4.12281369e+04  1.05256033e+05  2.30428959e+05
  4.56236325e+05  8.45182828e+05  1.52835452e+06  2.85061506e+06
  5.80849355e+06]
E1 = -706.8046638810254  E_coul = 198.8144002320654
cycle= 2 E= -507.99026364896  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0349944
diis-c [-0.00121877 -0.00320381  1.00320381]
  HOMO = -0.239677578463838  LUMO = 0.843527020450182
  mo_energy =
[-1.20314617e+02 -1.23721216e+01 -6.66877651e+00 -6.66877651e+00
 -6.66877651e+00 -1.17750974e+00 -2.39677578e-01 -2.39677578e-01
 -2.39677578e-01  8.43527020e-01  5.13572404e+00  2.05338356e+01
  7.74186995e+01  2.71597885e+02  8.99355638e+02  3.15193476e+03
  1.26313776e+04  4.12279877e+04  1.05255882e+05  2.30428808e+05
  4.56236173e+05  8.45182675e+05  1.52835437e+06  2.85061491e+06
  5.80849339e+06]
E1 = -706.6956709142199  E_coul = 198.70514253120612
cycle= 3 E= -507.990528383014  delta_E= -0.000265  |g|= 0.00437  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00387261
diis-c [-3.32870951e-06  1.14866026e-04 -1.08608518e-01  1.10849365e+00]
  HOMO = -0.242847416393026  LUMO = 0.842819165375392
  mo_energy =
[-1.20326375e+02 -1.23807033e+01 -6.67783885e+00 -6.67783885e+00
 -6.67783885e+00 -1.17943169e+00 -2.42847416e-01 -2.42847416e-01
 -2.42847416e-01  8.42819165e-01  5.13171478e+00  2.05266131e+01
  7.74090844e+01  2.71586795e+02  8.99343644e+02  3.15192207e+03
  1.26313644e+04  4.12279744e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182662e+05  1.52835436e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6802055445768  E_coul = 198.68967197178253
cycle= 4 E= -507.990533572794  delta_E= -5.19e-06  |g|= 0.000237  |ddm|= 0.0106
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000175399
diis-c [-6.61149151e-10 -9.67827879e-06  6.92753439e-03 -9.75742114e-02
  1.09065636e+00]
  HOMO = -0.242996427545692  LUMO = 0.842776296185197
  mo_energy =
[-1.20326709e+02 -1.23810367e+01 -6.67816732e+00 -6.67816732e+00
 -6.67816732e+00 -1.17952214e+00 -2.42996428e-01 -2.42996428e-01
 -2.42996428e-01  8.42776296e-01  5.13151844e+00  2.05263193e+01
  7.74087571e+01  2.71586462e+02  8.99343309e+02  3.15192173e+03
  1.26313641e+04  4.12279740e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182661e+05  1.52835435e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6794828600938  E_coul = 198.68894927233814
cycle= 5 E= -507.990533587756  delta_E= -1.5e-08  |g|= 6.66e-06  |ddm|= 0.000703
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.93334e-06
diis-c [-1.03534653e-12  6.52740217e-07 -5.98158495e-04  8.03320539e-03
 -9.67670243e-02  1.08933132e+00]
  HOMO = -0.24299940874444  LUMO = 0.842775474768821
  mo_energy =
[-1.20326715e+02 -1.23810424e+01 -6.67817308e+00 -6.67817308e+00
 -6.67817308e+00 -1.17952419e+00 -2.42999409e-01 -2.42999409e-01
 -2.42999409e-01  8.42775475e-01  5.13151443e+00  2.05263141e+01
  7.74087512e+01  2.71586455e+02  8.99343303e+02  3.15192172e+03
  1.26313641e+04  4.12279740e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182661e+05  1.52835435e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6794675946852  E_coul = 198.6889340069194
cycle= 6 E= -507.990533587766  delta_E= -1.02e-11  |g|= 9e-08  |ddm|= 2.08e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6794675946852  E_coul = 198.6889340069194
  HOMO = -0.242999450554355  LUMO = 0.842775450461899
  mo_energy =
[-1.20326715e+02 -1.23810425e+01 -6.67817316e+00 -6.67817316e+00
 -6.67817316e+00 -1.17952420e+00 -2.42999451e-01 -2.42999451e-01
 -2.42999451e-01  8.42775450e-01  5.13151437e+00  2.05263140e+01
  7.74087511e+01  2.71586455e+02  8.99343303e+02  3.15192172e+03
  1.26313641e+04  4.12279740e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182661e+05  1.52835435e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6794674128402  E_coul = 198.68893382507466
Extra cycle  E= -507.990533587766  delta_E= 2.84e-13  |g|= 1.19e-08  |ddm|= 2.2e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912525.927595866
E1 = -706.6794674128402  E_coul = 198.68893382507466
init E= -507.990533587766
    CPU time for initialize scf      5.75 sec, wall time      0.24 sec
  HOMO = -0.242999456498529  LUMO = 0.842775449117946
  mo_energy =
[-1.20326715e+02 -1.23810425e+01 -6.67817317e+00 -6.67817317e+00
 -6.67817317e+00 -1.17952421e+00 -2.42999456e-01 -2.42999456e-01
 -2.42999456e-01  8.42775449e-01  5.13151436e+00  2.05263140e+01
  7.74087511e+01  2.71586455e+02  8.99343303e+02  3.15192172e+03
  1.26313641e+04  4.12279740e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182661e+05  1.52835435e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.679467381183  E_coul = 198.68893379341742
cycle= 1 E= -507.990533587766  delta_E= -1.14e-13  |g|= 1.79e-09  |ddm|= 3.23e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.679467381183  E_coul = 198.68893379341742
  HOMO = -0.242999457478668  LUMO = 0.842775447300015
  mo_energy =
[-1.20326715e+02 -1.23810425e+01 -6.67817317e+00 -6.67817317e+00
 -6.67817317e+00 -1.17952421e+00 -2.42999457e-01 -2.42999457e-01
 -2.42999457e-01  8.42775447e-01  5.13151436e+00  2.05263140e+01
  7.74087511e+01  2.71586455e+02  8.99343303e+02  3.15192172e+03
  1.26313641e+04  4.12279740e+04  1.05255869e+05  2.30428794e+05
  4.56236160e+05  8.45182661e+05  1.52835435e+06  2.85061489e+06
  5.80849338e+06]
E1 = -706.6794673790034  E_coul = 198.68893379123756
Extra cycle  E= -507.990533587766  delta_E= -2.27e-13  |g|= 1.44e-09  |ddm|= 2.84e-09
    CPU time for scf_cycle      6.19 sec, wall time      0.41 sec
exp = [2.24070746e-01 5.77656877e-01 1.77319486e+00 1.17616813e+05
 3.73751206e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231336e+03
 1.83757710e+04 1.44359049e+03 4.17367952e+02 1.47799325e+02
 5.83917424e+01 2.46542764e+01 8.30813976e+00 8.60467481e+00
 4.92810688e-01]
grad_E = [-4.32511809e-04  1.65926312e-04  1.31902190e-04  6.05040788e-09
  1.60604648e-04  4.03071785e-11  1.73766225e-10  9.38484882e-10
  3.70780338e-09  1.54827473e-08  8.07712245e-08  5.09097579e-06
  1.97879044e-07 -3.80363714e-05 -9.83376361e-06  1.76730316e-05
 -3.72153676e-05 -3.27977645e-05 -3.19911423e-04  2.42045869e-04
  1.71670751e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.225500095721       1
[INPUT] 0    0    [1    /1   ]  0.5832314524         1
[INPUT] 0    0    [1    /1   ]  1.79074312782        1
[INPUT] 0    0    [1    /1   ]  117616.812879        1
[INPUT] 0    0    [1    /1   ]  3.78118235172        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991317        1
[INPUT] 0    0    [1    /1   ]  73510.4175208        1
[INPUT] 0    0    [1    /1   ]  36754.7013921        1
[INPUT] 0    0    [1    /1   ]  7302.3124984         1
[INPUT] 0    0    [1    /1   ]  18375.77099          1
[INPUT] 0    0    [1    /1   ]  1443.59693611        1
[INPUT] 0    0    [1    /1   ]  417.369207665        1
[INPUT] 0    0    [1    /1   ]  147.798033715        1
[INPUT] 0    0    [1    /1   ]  58.3936283052        1
[INPUT] 0    0    [1    /1   ]  24.6605354597        1
[INPUT] 0    0    [1    /1   ]  8.35818978936        1
[INPUT] 1    0    [1    /1   ]  8.60492673678        1
[INPUT] 1    0    [1    /1   ]  0.492846398461       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22550009572050952, 1.0]], [0, [0.5832314524004243, 1.0]], [0, [1.7907431278247536, 1.0]], [0, [117616.81287871308, 1.0]], [0, [3.7811823517199437, 1.0]], [0, [1176168.142613381, 1.0]], [0, [588084.0699562499, 1.0]], [0, [294042.03091976163, 1.0]], [0, [147020.99131670385, 1.0]], [0, [73510.41752076992, 1.0]], [0, [36754.70139209444, 1.0]], [0, [7302.312498395716, 1.0]], [0, [18375.770989966153, 1.0]], [0, [1443.5969361103614, 1.0]], [0, [417.3692076650511, 1.0]], [0, [147.7980337149827, 1.0]], [0, [58.3936283051518, 1.0]], [0, [24.66053545970754, 1.0]], [0, [8.358189789362454, 1.0]], [1, [8.604926736779435, 1.0]], [1, [0.49284639846052847, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2255001]
bas 1, expnt(s) = [0.58323145]
bas 2, expnt(s) = [1.79074313]
bas 3, expnt(s) = [117616.81287871]
bas 4, expnt(s) = [3.78118235]
bas 5, expnt(s) = [1176168.14261338]
bas 6, expnt(s) = [588084.06995625]
bas 7, expnt(s) = [294042.03091976]
bas 8, expnt(s) = [147020.9913167]
bas 9, expnt(s) = [73510.41752077]
bas 10, expnt(s) = [36754.70139209]
bas 11, expnt(s) = [7302.3124984]
bas 12, expnt(s) = [18375.77098997]
bas 13, expnt(s) = [1443.59693611]
bas 14, expnt(s) = [417.36920767]
bas 15, expnt(s) = [147.79803371]
bas 16, expnt(s) = [58.39362831]
bas 17, expnt(s) = [24.66053546]
bas 18, expnt(s) = [8.35818979]
bas 19, expnt(s) = [8.60492674]
bas 20, expnt(s) = [0.4928464]
CPU time:       754.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.25500096e-01 8.26751653e-01 5.83231452e-01 1.68614814e+00
 1.79074313e+00 3.91101962e+00 1.17616813e+05 1.60460108e+04
 3.78118235e+00 6.85071248e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231250e+03 1.99576929e+03
 1.83757710e+04 3.98748628e+03 1.44359694e+03 5.91697164e+02
 4.17369208e+02 2.33294945e+02 1.47798034e+02 1.07094339e+02
 5.83936283e+01 5.33690067e+01 2.46605355e+01 2.79586953e+01
 8.35818979e+00 1.24193594e+01 8.60492674e+00 4.29950406e+01
 4.92846398e-01 1.20468604e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33597290234043
cond(S) = 912539.7472727598
E1 = -689.6024395931189  E_coul = 184.97746281261587
init E= -504.624976780503
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672055645596837  LUMO = 0.51606073066956
  mo_energy =
[-1.21708899e+02 -1.33857724e+01 -7.62321545e+00 -7.62321545e+00
 -7.62321545e+00 -1.65749643e+00 -6.72055646e-01 -6.72055646e-01
 -6.72055646e-01  5.16060731e-01  4.62460278e+00  1.99130717e+01
  7.66961310e+01  2.70758540e+02  8.98464852e+02  3.15107905e+03
  1.26306007e+04  4.12272568e+04  1.05255175e+05  2.30428116e+05
  4.56235492e+05  8.45182001e+05  1.52835370e+06  2.85061424e+06
  5.80849273e+06]
E1 = -707.7632259931045  E_coul = 199.79078445040835
cycle= 1 E= -507.972441542696  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.757706
diis-c [-0.57411884  1.        ]
  HOMO = -0.217387705814228  LUMO = 0.857346943614706
  mo_energy =
[-1.20199156e+02 -1.23040361e+01 -6.59344689e+00 -6.59344689e+00
 -6.59344689e+00 -1.16314750e+00 -2.17387706e-01 -2.17387706e-01
 -2.17387706e-01  8.57346944e-01  5.23422373e+00  2.08413051e+01
  7.79616511e+01  2.72211329e+02  8.99956690e+02  3.15251147e+03
  1.26319267e+04  4.12285156e+04  1.05256397e+05  2.30429313e+05
  4.56236672e+05  8.45183168e+05  1.52835486e+06  2.85061539e+06
  5.80849387e+06]
E1 = -706.8075319896051  E_coul = 198.81726236851998
cycle= 2 E= -507.990269621085  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348902
diis-c [-0.00121171 -0.00313933  1.00313933]
  HOMO = -0.239603051563064  LUMO = 0.853876647209313
  mo_energy =
[-1.20314230e+02 -1.23719054e+01 -6.66858777e+00 -6.66858777e+00
 -6.66858777e+00 -1.17744376e+00 -2.39603052e-01 -2.39603052e-01
 -2.39603052e-01  8.53876647e-01  5.20725027e+00  2.07857461e+01
  7.78782297e+01  2.72106510e+02  8.99835941e+02  3.15237638e+03
  1.26317813e+04  4.12283664e+04  1.05256246e+05  2.30429161e+05
  4.56236520e+05  8.45183016e+05  1.52835470e+06  2.85061524e+06
  5.80849371e+06]
E1 = -706.6986513713762  E_coul = 198.7081175384131
cycle= 3 E= -507.990533832963  delta_E= -0.000264  |g|= 0.00437  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385149
diis-c [-3.30726089e-06  1.18395741e-04 -1.08238243e-01  1.10811985e+00]
  HOMO = -0.242768324048737  LUMO = 0.853158245824673
  mo_energy =
[-1.20325980e+02 -1.23804795e+01 -6.67764274e+00 -6.67764274e+00
 -6.67764274e+00 -1.17936251e+00 -2.42768324e-01 -2.42768324e-01
 -2.42768324e-01  8.53158246e-01  5.20320922e+00  2.07785078e+01
  7.78686182e+01  2.72095426e+02  8.99823954e+02  3.15236369e+03
  1.26317682e+04  4.12283531e+04  1.05256233e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6832289031377  E_coul = 198.6926899135484
cycle= 4 E= -507.990538989589  delta_E= -5.16e-06  |g|= 0.000236  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000174733
diis-c [-6.30471197e-10 -9.61276164e-06  6.90623262e-03 -9.76010496e-02
  1.09070443e+00]
  HOMO = -0.242917316783109  LUMO = 0.853114921694414
  mo_energy =
[-1.20326316e+02 -1.23808140e+01 -6.67797244e+00 -6.67797244e+00
 -6.67797244e+00 -1.17945290e+00 -2.42917317e-01 -2.42917317e-01
 -2.42917317e-01  8.53114922e-01  5.20301152e+00  2.07782127e+01
  7.78682895e+01  2.72095092e+02  8.99823617e+02  3.15236335e+03
  1.26317679e+04  4.12283527e+04  1.05256232e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6825077746455  E_coul = 198.69196877029387
cycle= 5 E= -507.990539004352  delta_E= -1.48e-08  |g|= 6.46e-06  |ddm|= 0.000695
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.83662e-06
diis-c [-1.00289615e-12  6.36149359e-07 -5.86501525e-04  7.90429399e-03
 -9.50826295e-02  1.08776420e+00]
  HOMO = -0.242920219768955  LUMO = 0.853114113871231
  mo_energy =
[-1.20326323e+02 -1.23808196e+01 -6.67797806e+00 -6.67797806e+00
 -6.67797806e+00 -1.17945489e+00 -2.42920220e-01 -2.42920220e-01
 -2.42920220e-01  8.53114114e-01  5.20300760e+00  2.07782076e+01
  7.78682837e+01  2.72095085e+02  8.99823610e+02  3.15236335e+03
  1.26317679e+04  4.12283527e+04  1.05256232e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6824929604902  E_coul = 198.69195395612914
cycle= 6 E= -507.990539004361  delta_E= -9.44e-12  |g|= 9.11e-08  |ddm|= 2e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6824929604902  E_coul = 198.69195395612914
  HOMO = -0.242920261952922  LUMO = 0.853114087719467
  mo_energy =
[-1.20326323e+02 -1.23808196e+01 -6.67797815e+00 -6.67797815e+00
 -6.67797815e+00 -1.17945491e+00 -2.42920262e-01 -2.42920262e-01
 -2.42920262e-01  8.53114088e-01  5.20300753e+00  2.07782075e+01
  7.78682836e+01  2.72095085e+02  8.99823610e+02  3.15236335e+03
  1.26317679e+04  4.12283527e+04  1.05256232e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6824927768611  E_coul = 198.69195377250014
Extra cycle  E= -507.990539004361  delta_E= 1.14e-13  |g|= 1.22e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.25500096e-01 5.83231452e-01 1.79074313e+00 1.17616813e+05
 3.78118235e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231250e+03
 1.83757710e+04 1.44359694e+03 4.17369208e+02 1.47798034e+02
 5.83936283e+01 2.46605355e+01 8.35818979e+00 8.60492674e+00
 4.92846398e-01]
E = -507.9905390043609
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:02 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.225500095721       1
[INPUT] 0    0    [1    /1   ]  0.5832314524         1
[INPUT] 0    0    [1    /1   ]  1.79074312782        1
[INPUT] 0    0    [1    /1   ]  117616.812879        1
[INPUT] 0    0    [1    /1   ]  3.78118235172        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.03092         1
[INPUT] 0    0    [1    /1   ]  147020.991317        1
[INPUT] 0    0    [1    /1   ]  73510.4175208        1
[INPUT] 0    0    [1    /1   ]  36754.7013921        1
[INPUT] 0    0    [1    /1   ]  7302.3124984         1
[INPUT] 0    0    [1    /1   ]  18375.77099          1
[INPUT] 0    0    [1    /1   ]  1443.59693611        1
[INPUT] 0    0    [1    /1   ]  417.369207665        1
[INPUT] 0    0    [1    /1   ]  147.798033715        1
[INPUT] 0    0    [1    /1   ]  58.3936283052        1
[INPUT] 0    0    [1    /1   ]  24.6605354597        1
[INPUT] 0    0    [1    /1   ]  8.35818978936        1
[INPUT] 1    0    [1    /1   ]  8.60492673678        1
[INPUT] 1    0    [1    /1   ]  0.492846398461       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22550009572050952, 1.0]], [0, [0.5832314524004243, 1.0]], [0, [1.7907431278247536, 1.0]], [0, [117616.81287871308, 1.0]], [0, [3.7811823517199437, 1.0]], [0, [1176168.142613381, 1.0]], [0, [588084.0699562499, 1.0]], [0, [294042.03091976163, 1.0]], [0, [147020.99131670385, 1.0]], [0, [73510.41752076992, 1.0]], [0, [36754.70139209444, 1.0]], [0, [7302.312498395716, 1.0]], [0, [18375.770989966153, 1.0]], [0, [1443.5969361103614, 1.0]], [0, [417.3692076650511, 1.0]], [0, [147.7980337149827, 1.0]], [0, [58.3936283051518, 1.0]], [0, [24.66053545970754, 1.0]], [0, [8.358189789362454, 1.0]], [1, [8.604926736779435, 1.0]], [1, [0.49284639846052847, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2255001]
bas 1, expnt(s) = [0.58323145]
bas 2, expnt(s) = [1.79074313]
bas 3, expnt(s) = [117616.81287871]
bas 4, expnt(s) = [3.78118235]
bas 5, expnt(s) = [1176168.14261338]
bas 6, expnt(s) = [588084.06995625]
bas 7, expnt(s) = [294042.03091976]
bas 8, expnt(s) = [147020.9913167]
bas 9, expnt(s) = [73510.41752077]
bas 10, expnt(s) = [36754.70139209]
bas 11, expnt(s) = [7302.3124984]
bas 12, expnt(s) = [18375.77098997]
bas 13, expnt(s) = [1443.59693611]
bas 14, expnt(s) = [417.36920767]
bas 15, expnt(s) = [147.79803371]
bas 16, expnt(s) = [58.39362831]
bas 17, expnt(s) = [24.66053546]
bas 18, expnt(s) = [8.35818979]
bas 19, expnt(s) = [8.60492674]
bas 20, expnt(s) = [0.4928464]
CPU time:       756.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.25500096e-01 8.26751653e-01 5.83231452e-01 1.68614814e+00
 1.79074313e+00 3.91101962e+00 1.17616813e+05 1.60460108e+04
 3.78118235e+00 6.85071248e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655821e+03 7.30231250e+03 1.99576929e+03
 1.83757710e+04 3.98748628e+03 1.44359694e+03 5.91697164e+02
 4.17369208e+02 2.33294945e+02 1.47798034e+02 1.07094339e+02
 5.83936283e+01 5.33690067e+01 2.46605355e+01 2.79586953e+01
 8.35818979e+00 1.24193594e+01 8.60492674e+00 4.29950406e+01
 4.92846398e-01 1.20468604e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33597290234043
cond(S) = 912539.7472727598
E1 = -689.6024395931189  E_coul = 184.97746281261587
init E= -504.624976780503
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672055645596837  LUMO = 0.51606073066956
  mo_energy =
[-1.21708899e+02 -1.33857724e+01 -7.62321545e+00 -7.62321545e+00
 -7.62321545e+00 -1.65749643e+00 -6.72055646e-01 -6.72055646e-01
 -6.72055646e-01  5.16060731e-01  4.62460278e+00  1.99130717e+01
  7.66961310e+01  2.70758540e+02  8.98464852e+02  3.15107905e+03
  1.26306007e+04  4.12272568e+04  1.05255175e+05  2.30428116e+05
  4.56235492e+05  8.45182001e+05  1.52835370e+06  2.85061424e+06
  5.80849273e+06]
E1 = -707.7632259931045  E_coul = 199.79078445040835
cycle= 1 E= -507.972441542696  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.757706
diis-c [-0.57411884  1.        ]
  HOMO = -0.217387705814228  LUMO = 0.857346943614706
  mo_energy =
[-1.20199156e+02 -1.23040361e+01 -6.59344689e+00 -6.59344689e+00
 -6.59344689e+00 -1.16314750e+00 -2.17387706e-01 -2.17387706e-01
 -2.17387706e-01  8.57346944e-01  5.23422373e+00  2.08413051e+01
  7.79616511e+01  2.72211329e+02  8.99956690e+02  3.15251147e+03
  1.26319267e+04  4.12285156e+04  1.05256397e+05  2.30429313e+05
  4.56236672e+05  8.45183168e+05  1.52835486e+06  2.85061539e+06
  5.80849387e+06]
E1 = -706.8075319896051  E_coul = 198.81726236851998
cycle= 2 E= -507.990269621085  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348902
diis-c [-0.00121171 -0.00313933  1.00313933]
  HOMO = -0.239603051563064  LUMO = 0.853876647209313
  mo_energy =
[-1.20314230e+02 -1.23719054e+01 -6.66858777e+00 -6.66858777e+00
 -6.66858777e+00 -1.17744376e+00 -2.39603052e-01 -2.39603052e-01
 -2.39603052e-01  8.53876647e-01  5.20725027e+00  2.07857461e+01
  7.78782297e+01  2.72106510e+02  8.99835941e+02  3.15237638e+03
  1.26317813e+04  4.12283664e+04  1.05256246e+05  2.30429161e+05
  4.56236520e+05  8.45183016e+05  1.52835470e+06  2.85061524e+06
  5.80849371e+06]
E1 = -706.6986513713762  E_coul = 198.7081175384131
cycle= 3 E= -507.990533832963  delta_E= -0.000264  |g|= 0.00437  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385149
diis-c [-3.30726089e-06  1.18395741e-04 -1.08238243e-01  1.10811985e+00]
  HOMO = -0.242768324048737  LUMO = 0.853158245824673
  mo_energy =
[-1.20325980e+02 -1.23804795e+01 -6.67764274e+00 -6.67764274e+00
 -6.67764274e+00 -1.17936251e+00 -2.42768324e-01 -2.42768324e-01
 -2.42768324e-01  8.53158246e-01  5.20320922e+00  2.07785078e+01
  7.78686182e+01  2.72095426e+02  8.99823954e+02  3.15236369e+03
  1.26317682e+04  4.12283531e+04  1.05256233e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6832289031377  E_coul = 198.6926899135484
cycle= 4 E= -507.990538989589  delta_E= -5.16e-06  |g|= 0.000236  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000174733
diis-c [-6.30471197e-10 -9.61276164e-06  6.90623262e-03 -9.76010496e-02
  1.09070443e+00]
  HOMO = -0.242917316783109  LUMO = 0.853114921694414
  mo_energy =
[-1.20326316e+02 -1.23808140e+01 -6.67797244e+00 -6.67797244e+00
 -6.67797244e+00 -1.17945290e+00 -2.42917317e-01 -2.42917317e-01
 -2.42917317e-01  8.53114922e-01  5.20301152e+00  2.07782127e+01
  7.78682895e+01  2.72095092e+02  8.99823617e+02  3.15236335e+03
  1.26317679e+04  4.12283527e+04  1.05256232e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6825077746455  E_coul = 198.69196877029387
cycle= 5 E= -507.990539004352  delta_E= -1.48e-08  |g|= 6.46e-06  |ddm|= 0.000695
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.83662e-06
diis-c [-1.00289615e-12  6.36149359e-07 -5.86501525e-04  7.90429399e-03
 -9.50826295e-02  1.08776420e+00]
  HOMO = -0.242920219768955  LUMO = 0.853114113871231
  mo_energy =
[-1.20326323e+02 -1.23808196e+01 -6.67797806e+00 -6.67797806e+00
 -6.67797806e+00 -1.17945489e+00 -2.42920220e-01 -2.42920220e-01
 -2.42920220e-01  8.53114114e-01  5.20300760e+00  2.07782076e+01
  7.78682837e+01  2.72095085e+02  8.99823610e+02  3.15236335e+03
  1.26317679e+04  4.12283527e+04  1.05256232e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6824929604902  E_coul = 198.69195395612914
cycle= 6 E= -507.990539004361  delta_E= -9.44e-12  |g|= 9.11e-08  |ddm|= 2e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6824929604902  E_coul = 198.69195395612914
  HOMO = -0.242920261952922  LUMO = 0.853114087719467
  mo_energy =
[-1.20326323e+02 -1.23808196e+01 -6.67797815e+00 -6.67797815e+00
 -6.67797815e+00 -1.17945491e+00 -2.42920262e-01 -2.42920262e-01
 -2.42920262e-01  8.53114088e-01  5.20300753e+00  2.07782075e+01
  7.78682836e+01  2.72095085e+02  8.99823610e+02  3.15236335e+03
  1.26317679e+04  4.12283527e+04  1.05256232e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6824927768611  E_coul = 198.69195377250014
Extra cycle  E= -507.990539004361  delta_E= 1.14e-13  |g|= 1.22e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912539.7472727598
E1 = -706.6824927768611  E_coul = 198.69195377250014
init E= -507.990539004361
    CPU time for initialize scf      5.72 sec, wall time      0.24 sec
  HOMO = -0.242920267939578  LUMO = 0.853114086832143
  mo_energy =
[-1.20326323e+02 -1.23808197e+01 -6.67797816e+00 -6.67797816e+00
 -6.67797816e+00 -1.17945491e+00 -2.42920268e-01 -2.42920268e-01
 -2.42920268e-01  8.53114087e-01  5.20300753e+00  2.07782075e+01
  7.78682836e+01  2.72095085e+02  8.99823610e+02  3.15236335e+03
  1.26317679e+04  4.12283527e+04  1.05256232e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6824927454037  E_coul = 198.6919537410424
cycle= 1 E= -507.990539004361  delta_E= -3.41e-13  |g|= 2.39e-09  |ddm|= 3.23e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6824927454037  E_coul = 198.6919537410424
  HOMO = -0.242920268920379  LUMO = 0.853114086921681
  mo_energy =
[-1.20326323e+02 -1.23808197e+01 -6.67797816e+00 -6.67797816e+00
 -6.67797816e+00 -1.17945491e+00 -2.42920269e-01 -2.42920269e-01
 -2.42920269e-01  8.53114087e-01  5.20300752e+00  2.07782075e+01
  7.78682836e+01  2.72095085e+02  8.99823610e+02  3.15236335e+03
  1.26317679e+04  4.12283527e+04  1.05256232e+05  2.30429148e+05
  4.56236506e+05  8.45183002e+05  1.52835469e+06  2.85061522e+06
  5.80849370e+06]
E1 = -706.6824927426219  E_coul = 198.69195373826093
Extra cycle  E= -507.990539004361  delta_E= 3.41e-13  |g|= 2.01e-09  |ddm|= 3.22e-09
    CPU time for scf_cycle      6.18 sec, wall time      0.41 sec
exp = [2.25500096e-01 5.83231452e-01 1.79074313e+00 1.17616813e+05
 3.78118235e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231250e+03
 1.83757710e+04 1.44359694e+03 4.17369208e+02 1.47798034e+02
 5.83936283e+01 2.46605355e+01 8.35818979e+00 8.60492674e+00
 4.92846398e-01]
grad_E = [-8.25562435e-04  4.36406617e-04  6.97393345e-05  6.05049976e-09
  2.54082657e-04  4.03082471e-11  1.73769241e-10  9.38499002e-10
  3.70786024e-09  1.54829879e-08  8.07724048e-08  5.09107824e-06
  1.97882734e-07 -3.80455279e-05 -9.74561485e-06  1.73194657e-05
 -3.64858126e-05 -3.56464167e-05 -3.44632014e-04  4.19221807e-04
  2.78105755e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.227435592861       1
[INPUT] 0    0    [1    /1   ]  0.590795557527       1
[INPUT] 0    0    [1    /1   ]  1.80866513714        1
[INPUT] 0    0    [1    /1   ]  117616.812877        1
[INPUT] 0    0    [1    /1   ]  3.84728045767        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030919        1
[INPUT] 0    0    [1    /1   ]  147020.991316        1
[INPUT] 0    0    [1    /1   ]  73510.4175158        1
[INPUT] 0    0    [1    /1   ]  36754.701366         1
[INPUT] 0    0    [1    /1   ]  7302.31085664        1
[INPUT] 0    0    [1    /1   ]  18375.7709261        1
[INPUT] 0    0    [1    /1   ]  1443.60926087        1
[INPUT] 0    0    [1    /1   ]  417.371744966        1
[INPUT] 0    0    [1    /1   ]  147.794992135        1
[INPUT] 0    0    [1    /1   ]  58.398779788         1
[INPUT] 0    0    [1    /1   ]  24.67201493          1
[INPUT] 0    0    [1    /1   ]  8.45349348798        1
[INPUT] 1    0    [1    /1   ]  8.60517571756        1
[INPUT] 1    0    [1    /1   ]  0.492881457689       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2274355928612136, 1.0]], [0, [0.5907955575269119, 1.0]], [0, [1.808665137142479, 1.0]], [0, [117616.81287676182, 1.0]], [0, [3.847280457671155, 1.0]], [0, [1176168.1426133679, 1.0]], [0, [588084.0699561939, 1.0]], [0, [294042.03091945895, 1.0]], [0, [147020.99131550806, 1.0]], [0, [73510.41751577656, 1.0]], [0, [36754.70136604714, 1.0]], [0, [7302.31085663744, 1.0]], [0, [18375.77092613032, 1.0]], [0, [1443.6092608674514, 1.0]], [0, [417.3717449656516, 1.0]], [0, [147.79499213530383, 1.0]], [0, [58.398779788010806, 1.0]], [0, [24.672014929999104, 1.0]], [0, [8.453493487984419, 1.0]], [1, [8.60517571756483, 1.0]], [1, [0.4928814576888929, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22743559]
bas 1, expnt(s) = [0.59079556]
bas 2, expnt(s) = [1.80866514]
bas 3, expnt(s) = [117616.81287676]
bas 4, expnt(s) = [3.84728046]
bas 5, expnt(s) = [1176168.14261337]
bas 6, expnt(s) = [588084.06995619]
bas 7, expnt(s) = [294042.03091946]
bas 8, expnt(s) = [147020.99131551]
bas 9, expnt(s) = [73510.41751578]
bas 10, expnt(s) = [36754.70136605]
bas 11, expnt(s) = [7302.31085664]
bas 12, expnt(s) = [18375.77092613]
bas 13, expnt(s) = [1443.60926087]
bas 14, expnt(s) = [417.37174497]
bas 15, expnt(s) = [147.79499214]
bas 16, expnt(s) = [58.39877979]
bas 17, expnt(s) = [24.67201493]
bas 18, expnt(s) = [8.45349349]
bas 19, expnt(s) = [8.60517572]
bas 20, expnt(s) = [0.49288146]
CPU time:       771.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.27435593e-01 8.32068053e-01 5.90795558e-01 1.70252281e+00
 1.80866514e+00 3.94033957e+00 1.17616813e+05 1.60460108e+04
 3.84728046e+00 6.94033461e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655820e+03 7.30231086e+03 1.99576895e+03
 1.83757709e+04 3.98748627e+03 1.44360926e+03 5.91700953e+02
 4.17371745e+02 2.33296008e+02 1.47794992e+02 1.07092686e+02
 5.83987798e+01 5.33725378e+01 2.46720149e+01 2.79684558e+01
 8.45349349e+00 1.25254169e+01 8.60517572e+00 4.29965957e+01
 4.92881458e-01 1.20479316e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335919275307266
cond(S) = 912560.8042699221
E1 = -689.6049534233242  E_coul = 184.9798032307269
init E= -504.625150192597
    CPU time for initialize scf      7.65 sec, wall time      0.37 sec
  HOMO = -0.672010947780545  LUMO = 0.527576108980332
  mo_energy =
[-1.21708562e+02 -1.33855972e+01 -7.62306215e+00 -7.62306215e+00
 -7.62306215e+00 -1.65744643e+00 -6.72010948e-01 -6.72010948e-01
 -6.72010948e-01  5.27576109e-01  4.71336977e+00  2.02723578e+01
  7.74132578e+01  2.71578006e+02  8.99246179e+02  3.15180117e+03
  1.26312651e+04  4.12278812e+04  1.05255775e+05  2.30428699e+05
  4.56236063e+05  8.45182563e+05  1.52835425e+06  2.85061478e+06
  5.80849326e+06]
E1 = -707.7660936684898  E_coul = 199.7936446144014
cycle= 1 E= -507.972449054088  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.57 sec, wall time      0.03 sec
diis-norm(errvec)=0.757799
diis-c [-0.57425994  1.        ]
  HOMO = -0.217316985123665  LUMO = 0.871337173674765
  mo_energy =
[-1.20198766e+02 -1.23038312e+01 -6.59326221e+00 -6.59326221e+00
 -6.59326221e+00 -1.16308471e+00 -2.17316985e-01 -2.17316985e-01
 -2.17316985e-01  8.71337174e-01  5.32718899e+00  2.12047351e+01
  7.86794445e+01  2.73030723e+02  9.00738020e+02  3.15323363e+03
  1.26325911e+04  4.12291401e+04  1.05256997e+05  2.30429896e+05
  4.56237243e+05  8.45183730e+05  1.52835541e+06  2.85061593e+06
  5.80849439e+06]
E1 = -706.8103905828516  E_coul = 198.8201092164032
cycle= 2 E= -507.990281366448  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.034783
diis-c [-0.00120452 -0.00306288  1.00306288]
  HOMO = -0.239529767386599  LUMO = 0.867769400718724
  mo_energy =
[-1.20313838e+02 -1.23716957e+01 -6.66839887e+00 -6.66839887e+00
 -6.66839887e+00 -1.17737695e+00 -2.39529767e-01 -2.39529767e-01
 -2.39529767e-01  8.67769401e-01  5.29983419e+00  2.11488371e+01
  7.85959452e+01  2.72925913e+02  9.00617279e+02  3.15309854e+03
  1.26324457e+04  4.12289909e+04  1.05256846e+05  2.30429745e+05
  4.56237091e+05  8.45183578e+05  1.52835526e+06  2.85061578e+06
  5.80849424e+06]
E1 = -706.7016822023342  E_coul = 198.7111374149942
cycle= 3 E= -507.99054478734  delta_E= -0.000263  |g|= 0.00436  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382776
diis-c [-3.28114443e-06  1.21466306e-04 -1.07793846e-01  1.10767238e+00]
  HOMO = -0.2426880214518  LUMO = 0.867037441399181
  mo_energy =
[-1.20325576e+02 -1.23802579e+01 -6.67744209e+00 -6.67744209e+00
 -6.67744209e+00 -1.17929085e+00 -2.42688021e-01 -2.42688021e-01
 -2.42688021e-01  8.67037441e-01  5.29575349e+00  2.11415755e+01
  7.85863389e+01  2.72914842e+02  9.00605304e+02  3.15308587e+03
  1.26324326e+04  4.12289776e+04  1.05256833e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6863219767963  E_coul = 198.6957720799895
cycle= 4 E= -507.990549896807  delta_E= -5.11e-06  |g|= 0.000234  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173783
diis-c [-5.92400457e-10 -9.52313398e-06  6.87855464e-03 -9.75625864e-02
  1.09069355e+00]
  HOMO = -0.24283668236317  LUMO = 0.866993584881321
  mo_energy =
[-1.20325914e+02 -1.23805930e+01 -6.67777254e+00 -6.67777254e+00
 -6.67777254e+00 -1.17938098e+00 -2.42836682e-01 -2.42836682e-01
 -2.42836682e-01  8.66993585e-01  5.29555441e+00  2.11412794e+01
  7.85860092e+01  2.72914506e+02  9.00604966e+02  3.15308553e+03
  1.26324323e+04  4.12289772e+04  1.05256832e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6856044205886  E_coul = 198.69505450931908
cycle= 5 E= -507.990549911269  delta_E= -1.45e-08  |g|= 6.2e-06  |ddm|= 0.000685
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71748e-06
diis-c [-9.66207251e-13  6.21365738e-07 -5.71528111e-04  7.72904635e-03
 -9.28660051e-02  1.08570787e+00]
  HOMO = -0.242839484961161  LUMO = 0.866992798760632
  mo_energy =
[-1.20325921e+02 -1.23805983e+01 -6.67777799e+00 -6.67777799e+00
 -6.67777799e+00 -1.17938290e+00 -2.42839485e-01 -2.42839485e-01
 -2.42839485e-01  8.66992799e-01  5.29555059e+00  2.11412744e+01
  7.85860036e+01  2.72914500e+02  9.00604959e+02  3.15308552e+03
  1.26324323e+04  4.12289772e+04  1.05256832e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6855901791589  E_coul = 198.69504026788127
cycle= 6 E= -507.990549911278  delta_E= -8.19e-12  |g|= 9.24e-08  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6855901791589  E_coul = 198.69504026788127
  HOMO = -0.242839527678624  LUMO = 0.866992774143788
  mo_energy =
[-1.20325921e+02 -1.23805984e+01 -6.67777808e+00 -6.67777808e+00
 -6.67777808e+00 -1.17938292e+00 -2.42839528e-01 -2.42839528e-01
 -2.42839528e-01  8.66992774e-01  5.29555053e+00  2.11412743e+01
  7.85860035e+01  2.72914499e+02  9.00604959e+02  3.15308552e+03
  1.26324323e+04  4.12289772e+04  1.05256832e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6855899943984  E_coul = 198.69504008312072
Extra cycle  E= -507.990549911278  delta_E=    0  |g|= 1.24e-08  |ddm|= 2.25e-07
    CPU time for scf_cycle      8.45 sec, wall time      0.59 sec
exp = [2.27435593e-01 5.90795558e-01 1.80866514e+00 1.17616813e+05
 3.84728046e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231086e+03
 1.83757709e+04 1.44360926e+03 4.17371745e+02 1.47794992e+02
 5.83987798e+01 2.46720149e+01 8.45349349e+00 8.60517572e+00
 4.92881458e-01]
E = -507.99054991127764
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:10 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.227435592861       1
[INPUT] 0    0    [1    /1   ]  0.590795557527       1
[INPUT] 0    0    [1    /1   ]  1.80866513714        1
[INPUT] 0    0    [1    /1   ]  117616.812877        1
[INPUT] 0    0    [1    /1   ]  3.84728045767        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030919        1
[INPUT] 0    0    [1    /1   ]  147020.991316        1
[INPUT] 0    0    [1    /1   ]  73510.4175158        1
[INPUT] 0    0    [1    /1   ]  36754.701366         1
[INPUT] 0    0    [1    /1   ]  7302.31085664        1
[INPUT] 0    0    [1    /1   ]  18375.7709261        1
[INPUT] 0    0    [1    /1   ]  1443.60926087        1
[INPUT] 0    0    [1    /1   ]  417.371744966        1
[INPUT] 0    0    [1    /1   ]  147.794992135        1
[INPUT] 0    0    [1    /1   ]  58.398779788         1
[INPUT] 0    0    [1    /1   ]  24.67201493          1
[INPUT] 0    0    [1    /1   ]  8.45349348798        1
[INPUT] 1    0    [1    /1   ]  8.60517571756        1
[INPUT] 1    0    [1    /1   ]  0.492881457689       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2274355928612136, 1.0]], [0, [0.5907955575269119, 1.0]], [0, [1.808665137142479, 1.0]], [0, [117616.81287676182, 1.0]], [0, [3.847280457671155, 1.0]], [0, [1176168.1426133679, 1.0]], [0, [588084.0699561939, 1.0]], [0, [294042.03091945895, 1.0]], [0, [147020.99131550806, 1.0]], [0, [73510.41751577656, 1.0]], [0, [36754.70136604714, 1.0]], [0, [7302.31085663744, 1.0]], [0, [18375.77092613032, 1.0]], [0, [1443.6092608674514, 1.0]], [0, [417.3717449656516, 1.0]], [0, [147.79499213530383, 1.0]], [0, [58.398779788010806, 1.0]], [0, [24.672014929999104, 1.0]], [0, [8.453493487984419, 1.0]], [1, [8.60517571756483, 1.0]], [1, [0.4928814576888929, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22743559]
bas 1, expnt(s) = [0.59079556]
bas 2, expnt(s) = [1.80866514]
bas 3, expnt(s) = [117616.81287676]
bas 4, expnt(s) = [3.84728046]
bas 5, expnt(s) = [1176168.14261337]
bas 6, expnt(s) = [588084.06995619]
bas 7, expnt(s) = [294042.03091946]
bas 8, expnt(s) = [147020.99131551]
bas 9, expnt(s) = [73510.41751578]
bas 10, expnt(s) = [36754.70136605]
bas 11, expnt(s) = [7302.31085664]
bas 12, expnt(s) = [18375.77092613]
bas 13, expnt(s) = [1443.60926087]
bas 14, expnt(s) = [417.37174497]
bas 15, expnt(s) = [147.79499214]
bas 16, expnt(s) = [58.39877979]
bas 17, expnt(s) = [24.67201493]
bas 18, expnt(s) = [8.45349349]
bas 19, expnt(s) = [8.60517572]
bas 20, expnt(s) = [0.49288146]
CPU time:       780.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.27435593e-01 8.32068053e-01 5.90795558e-01 1.70252281e+00
 1.80866514e+00 3.94033957e+00 1.17616813e+05 1.60460108e+04
 3.84728046e+00 6.94033461e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547014e+04 6.70655820e+03 7.30231086e+03 1.99576895e+03
 1.83757709e+04 3.98748627e+03 1.44360926e+03 5.91700953e+02
 4.17371745e+02 2.33296008e+02 1.47794992e+02 1.07092686e+02
 5.83987798e+01 5.33725378e+01 2.46720149e+01 2.79684558e+01
 8.45349349e+00 1.25254169e+01 8.60517572e+00 4.29965957e+01
 4.92881458e-01 1.20479316e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335919275307266
cond(S) = 912560.8042699221
E1 = -689.6049534233242  E_coul = 184.9798032307269
init E= -504.625150192597
    CPU time for initialize scf      7.89 sec, wall time      0.38 sec
  HOMO = -0.672010947780545  LUMO = 0.527576108980332
  mo_energy =
[-1.21708562e+02 -1.33855972e+01 -7.62306215e+00 -7.62306215e+00
 -7.62306215e+00 -1.65744643e+00 -6.72010948e-01 -6.72010948e-01
 -6.72010948e-01  5.27576109e-01  4.71336977e+00  2.02723578e+01
  7.74132578e+01  2.71578006e+02  8.99246179e+02  3.15180117e+03
  1.26312651e+04  4.12278812e+04  1.05255775e+05  2.30428699e+05
  4.56236063e+05  8.45182563e+05  1.52835425e+06  2.85061478e+06
  5.80849326e+06]
E1 = -707.7660936684898  E_coul = 199.7936446144014
cycle= 1 E= -507.972449054088  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
diis-norm(errvec)=0.757799
diis-c [-0.57425994  1.        ]
  HOMO = -0.217316985123665  LUMO = 0.871337173674765
  mo_energy =
[-1.20198766e+02 -1.23038312e+01 -6.59326221e+00 -6.59326221e+00
 -6.59326221e+00 -1.16308471e+00 -2.17316985e-01 -2.17316985e-01
 -2.17316985e-01  8.71337174e-01  5.32718899e+00  2.12047351e+01
  7.86794445e+01  2.73030723e+02  9.00738020e+02  3.15323363e+03
  1.26325911e+04  4.12291401e+04  1.05256997e+05  2.30429896e+05
  4.56237243e+05  8.45183730e+05  1.52835541e+06  2.85061593e+06
  5.80849439e+06]
E1 = -706.8103905828516  E_coul = 198.8201092164032
cycle= 2 E= -507.990281366448  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.034783
diis-c [-0.00120452 -0.00306288  1.00306288]
  HOMO = -0.239529767386599  LUMO = 0.867769400718724
  mo_energy =
[-1.20313838e+02 -1.23716957e+01 -6.66839887e+00 -6.66839887e+00
 -6.66839887e+00 -1.17737695e+00 -2.39529767e-01 -2.39529767e-01
 -2.39529767e-01  8.67769401e-01  5.29983419e+00  2.11488371e+01
  7.85959452e+01  2.72925913e+02  9.00617279e+02  3.15309854e+03
  1.26324457e+04  4.12289909e+04  1.05256846e+05  2.30429745e+05
  4.56237091e+05  8.45183578e+05  1.52835526e+06  2.85061578e+06
  5.80849424e+06]
E1 = -706.7016822023342  E_coul = 198.7111374149942
cycle= 3 E= -507.99054478734  delta_E= -0.000263  |g|= 0.00436  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382776
diis-c [-3.28114443e-06  1.21466306e-04 -1.07793846e-01  1.10767238e+00]
  HOMO = -0.2426880214518  LUMO = 0.867037441399181
  mo_energy =
[-1.20325576e+02 -1.23802579e+01 -6.67744209e+00 -6.67744209e+00
 -6.67744209e+00 -1.17929085e+00 -2.42688021e-01 -2.42688021e-01
 -2.42688021e-01  8.67037441e-01  5.29575349e+00  2.11415755e+01
  7.85863389e+01  2.72914842e+02  9.00605304e+02  3.15308587e+03
  1.26324326e+04  4.12289776e+04  1.05256833e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6863219767963  E_coul = 198.6957720799895
cycle= 4 E= -507.990549896807  delta_E= -5.11e-06  |g|= 0.000234  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173783
diis-c [-5.92400457e-10 -9.52313398e-06  6.87855464e-03 -9.75625864e-02
  1.09069355e+00]
  HOMO = -0.24283668236317  LUMO = 0.866993584881321
  mo_energy =
[-1.20325914e+02 -1.23805930e+01 -6.67777254e+00 -6.67777254e+00
 -6.67777254e+00 -1.17938098e+00 -2.42836682e-01 -2.42836682e-01
 -2.42836682e-01  8.66993585e-01  5.29555441e+00  2.11412794e+01
  7.85860092e+01  2.72914506e+02  9.00604966e+02  3.15308553e+03
  1.26324323e+04  4.12289772e+04  1.05256832e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6856044205886  E_coul = 198.69505450931908
cycle= 5 E= -507.990549911269  delta_E= -1.45e-08  |g|= 6.2e-06  |ddm|= 0.000685
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71748e-06
diis-c [-9.66207251e-13  6.21365738e-07 -5.71528111e-04  7.72904635e-03
 -9.28660051e-02  1.08570787e+00]
  HOMO = -0.242839484961161  LUMO = 0.866992798760632
  mo_energy =
[-1.20325921e+02 -1.23805983e+01 -6.67777799e+00 -6.67777799e+00
 -6.67777799e+00 -1.17938290e+00 -2.42839485e-01 -2.42839485e-01
 -2.42839485e-01  8.66992799e-01  5.29555059e+00  2.11412744e+01
  7.85860036e+01  2.72914500e+02  9.00604959e+02  3.15308552e+03
  1.26324323e+04  4.12289772e+04  1.05256832e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6855901791589  E_coul = 198.69504026788127
cycle= 6 E= -507.990549911278  delta_E= -8.19e-12  |g|= 9.24e-08  |ddm|= 1.9e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.6855901791589  E_coul = 198.69504026788127
  HOMO = -0.242839527678624  LUMO = 0.866992774143788
  mo_energy =
[-1.20325921e+02 -1.23805984e+01 -6.67777808e+00 -6.67777808e+00
 -6.67777808e+00 -1.17938292e+00 -2.42839528e-01 -2.42839528e-01
 -2.42839528e-01  8.66992774e-01  5.29555053e+00  2.11412743e+01
  7.85860035e+01  2.72914499e+02  9.00604959e+02  3.15308552e+03
  1.26324323e+04  4.12289772e+04  1.05256832e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6855899943984  E_coul = 198.69504008312072
Extra cycle  E= -507.990549911278  delta_E=    0  |g|= 1.24e-08  |ddm|= 2.25e-07
    CPU time for scf_cycle      8.49 sec, wall time      0.62 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912560.8042699221
E1 = -706.6855899943984  E_coul = 198.69504008312072
init E= -507.990549911278
    CPU time for initialize scf      7.17 sec, wall time      0.34 sec
  HOMO = -0.242839533734137  LUMO = 0.866992773936957
  mo_energy =
[-1.20325921e+02 -1.23805984e+01 -6.67777809e+00 -6.67777809e+00
 -6.67777809e+00 -1.17938292e+00 -2.42839534e-01 -2.42839534e-01
 -2.42839534e-01  8.66992774e-01  5.29555052e+00  2.11412743e+01
  7.85860035e+01  2.72914499e+02  9.00604959e+02  3.15308552e+03
  1.26324323e+04  4.12289772e+04  1.05256832e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6855899613984  E_coul = 198.69504005012075
cycle= 1 E= -507.990549911278  delta_E=    0  |g|= 2.95e-09  |ddm|= 3.32e-08
    CPU time for cycle= 1      0.03 sec, wall time      0.03 sec
E1 = -706.6855899613984  E_coul = 198.69504005012075
  HOMO = -0.242839534756332  LUMO = 0.866992771655298
  mo_energy =
[-1.20325921e+02 -1.23805984e+01 -6.67777809e+00 -6.67777809e+00
 -6.67777809e+00 -1.17938292e+00 -2.42839535e-01 -2.42839535e-01
 -2.42839535e-01  8.66992772e-01  5.29555052e+00  2.11412743e+01
  7.85860035e+01  2.72914499e+02  9.00604959e+02  3.15308552e+03
  1.26324323e+04  4.12289772e+04  1.05256832e+05  2.30429731e+05
  4.56237077e+05  8.45183564e+05  1.52835524e+06  2.85061576e+06
  5.80849423e+06]
E1 = -706.6855899598102  E_coul = 198.69504004853292
Extra cycle  E= -507.990549911277  delta_E= 3.98e-13  |g|= 2.31e-09  |ddm|= 2.15e-09
    CPU time for scf_cycle      7.35 sec, wall time      0.52 sec
exp = [2.27435593e-01 5.90795558e-01 1.80866514e+00 1.17616813e+05
 3.84728046e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547014e+04 7.30231086e+03
 1.83757709e+04 1.44360926e+03 4.17371745e+02 1.47794992e+02
 5.83987798e+01 2.46720149e+01 8.45349349e+00 8.60517572e+00
 4.92881458e-01]
grad_E = [-1.21319768e-03  7.23427760e-04 -1.99437516e-05  6.05062871e-09
  3.61191558e-04  4.03097583e-11  1.73773442e-10  9.38518887e-10
  3.70793995e-09  1.54833246e-08  8.07740783e-08  5.09123646e-06
  1.97887740e-07 -3.80606248e-05 -9.62266797e-06  1.70704249e-05
 -3.77464362e-05 -3.68260592e-05 -3.52219615e-04  5.96515572e-04
  3.83868067e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:18 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229365861192       1
[INPUT] 0    0    [1    /1   ]  0.598424967164       1
[INPUT] 0    0    [1    /1   ]  1.81960041224        1
[INPUT] 0    0    [1    /1   ]  117616.812874        1
[INPUT] 0    0    [1    /1   ]  3.92667911457        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030919        1
[INPUT] 0    0    [1    /1   ]  147020.991314        1
[INPUT] 0    0    [1    /1   ]  73510.417508         1
[INPUT] 0    0    [1    /1   ]  36754.7013253        1
[INPUT] 0    0    [1    /1   ]  7302.30828588        1
[INPUT] 0    0    [1    /1   ]  18375.7708262        1
[INPUT] 0    0    [1    /1   ]  1443.6285459         1
[INPUT] 0    0    [1    /1   ]  417.375867339        1
[INPUT] 0    0    [1    /1   ]  147.789594765        1
[INPUT] 0    0    [1    /1   ]  58.4085334826        1
[INPUT] 0    0    [1    /1   ]  24.6895263156        1
[INPUT] 0    0    [1    /1   ]  8.6039249269         1
[INPUT] 1    0    [1    /1   ]  8.60524645034        1
[INPUT] 1    0    [1    /1   ]  0.492891143769       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22936586119202054, 1.0]], [0, [0.5984249671642824, 1.0]], [0, [1.819600412239315, 1.0]], [0, [117616.81287370644, 1.0]], [0, [3.9266791145654936, 1.0]], [0, [1176168.1426133476, 1.0]], [0, [588084.0699561061, 1.0]], [0, [294042.030918985, 1.0]], [0, [147020.99131363563, 1.0]], [0, [73510.41750795778, 1.0]], [0, [36754.70132526082, 1.0]], [0, [7302.3082858836615, 1.0]], [0, [18375.770826177923, 1.0]], [0, [1443.6285459038802, 1.0]], [0, [417.37586733873184, 1.0]], [0, [147.7895947654844, 1.0]], [0, [58.408533482566064, 1.0]], [0, [24.6895263156371, 1.0]], [0, [8.603924926902337, 1.0]], [1, [8.605246450341896, 1.0]], [1, [0.4928911437686589, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22936586]
bas 1, expnt(s) = [0.59842497]
bas 2, expnt(s) = [1.81960041]
bas 3, expnt(s) = [117616.81287371]
bas 4, expnt(s) = [3.92667911]
bas 5, expnt(s) = [1176168.14261335]
bas 6, expnt(s) = [588084.06995611]
bas 7, expnt(s) = [294042.03091899]
bas 8, expnt(s) = [147020.99131364]
bas 9, expnt(s) = [73510.41750796]
bas 10, expnt(s) = [36754.70132526]
bas 11, expnt(s) = [7302.30828588]
bas 12, expnt(s) = [18375.77082618]
bas 13, expnt(s) = [1443.6285459]
bas 14, expnt(s) = [417.37586734]
bas 15, expnt(s) = [147.78959477]
bas 16, expnt(s) = [58.40853348]
bas 17, expnt(s) = [24.68952632]
bas 18, expnt(s) = [8.60392493]
bas 19, expnt(s) = [8.60524645]
bas 20, expnt(s) = [0.49289114]
CPU time:       802.92
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29365861e-01 8.37358837e-01 5.98424967e-01 1.71898585e+00
 1.81960041e+00 3.95819371e+00 1.17616813e+05 1.60460108e+04
 3.92667911e+00 7.04748376e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547013e+04 6.70655820e+03 7.30230829e+03 1.99576842e+03
 1.83757708e+04 3.98748625e+03 1.44362855e+03 5.91706881e+02
 4.17375867e+02 2.33297736e+02 1.47789595e+02 1.07089753e+02
 5.84085335e+01 5.33792234e+01 2.46895263e+01 2.79833428e+01
 8.60392493e+00 1.26922168e+01 8.60524645e+00 4.29970375e+01
 4.92891144e-01 1.20482275e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33589841047268
cond(S) = 912587.1538891001
E1 = -689.6058382889072  E_coul = 184.980541810794
init E= -504.625296478113
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.671996056539032  LUMO = 0.539075923255279
  mo_energy =
[-1.21708462e+02 -1.33855550e+01 -7.62301209e+00 -7.62301209e+00
 -7.62301209e+00 -1.65742459e+00 -6.71996057e-01 -6.71996057e-01
 -6.71996057e-01  5.39075923e-01  4.79964187e+00  2.06907212e+01
  7.83385472e+01  2.72674572e+02  9.00303259e+02  3.15278363e+03
  1.26321748e+04  4.12287381e+04  1.05256599e+05  2.30429500e+05
  4.56236847e+05  8.45183334e+05  1.52835501e+06  2.85061553e+06
  5.80849398e+06]
E1 = -707.7668642510057  E_coul = 199.79439812594126
cycle= 1 E= -507.972466125064  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.757983
diis-c [-0.57453877  1.        ]
  HOMO = -0.217304285181444  LUMO = 0.885238057329218
  mo_energy =
[-1.20198640e+02 -1.23037928e+01 -6.59321282e+00 -6.59321282e+00
 -6.59321282e+00 -1.16306836e+00 -2.17304285e-01 -2.17304285e-01
 -2.17304285e-01  8.85238057e-01  5.41770640e+00  2.16284358e+01
  7.96057850e+01  2.74127189e+02  9.01795068e+02  3.15421611e+03
  1.26335008e+04  4.12299969e+04  1.05257821e+05  2.30430697e+05
  4.56238027e+05  8.45184501e+05  1.52835617e+06  2.85061667e+06
  5.80849512e+06]
E1 = -706.8112650714132  E_coul = 198.82096516537973
cycle= 2 E= -507.990299906033  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347216
diis-c [-0.00120046 -0.00299987  1.00299987]
  HOMO = -0.239509435215538  LUMO = 0.881575500327833
  mo_energy =
[-1.20313703e+02 -1.23716456e+01 -6.66833856e+00 -6.66833856e+00
 -6.66833856e+00 -1.17735349e+00 -2.39509435e-01 -2.39509435e-01
 -2.39509435e-01  8.81575500e-01  5.38997619e+00  2.15721231e+01
  7.95221754e+01  2.74022393e+02  9.01674343e+02  3.15408104e+03
  1.26333555e+04  4.12298478e+04  1.05257670e+05  2.30430545e+05
  4.56237875e+05  8.45184349e+05  1.52835601e+06  2.85061652e+06
  5.80849496e+06]
E1 = -706.702756937683  E_coul = 198.71219451330546
cycle= 3 E= -507.990562424378  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381006
diis-c [-3.25917793e-06  1.22340111e-04 -1.07406923e-01  1.10728458e+00]
  HOMO = -0.242659487640375  LUMO = 0.880830665720892
  mo_energy =
[-1.20325427e+02 -1.23801935e+01 -6.67736749e+00 -6.67736749e+00
 -6.67736749e+00 -1.17926185e+00 -2.42659488e-01 -2.42659488e-01
 -2.42659488e-01  8.80830666e-01  5.38585768e+00  2.15648323e+01
  7.95125739e+01  2.74011336e+02  9.01662383e+02  3.15406838e+03
  1.26333424e+04  4.12298345e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6874643566406  E_coul = 198.69689687269795
cycle= 4 E= -507.990567483943  delta_E= -5.06e-06  |g|= 0.000232  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172813
diis-c [-5.58281401e-10 -9.44749863e-06  6.85275488e-03 -9.74473846e-02
  1.09060408e+00]
  HOMO = -0.242807480525432  LUMO = 0.880786377758655
  mo_energy =
[-1.20325765e+02 -1.23805282e+01 -6.67769769e+00 -6.67769769e+00
 -6.67769769e+00 -1.17935152e+00 -2.42807481e-01 -2.42807481e-01
 -2.42807481e-01  8.80786378e-01  5.38565768e+00  2.15645358e+01
  7.95122441e+01  2.74011000e+02  9.01662044e+02  3.15406804e+03
  1.26333421e+04  4.12298341e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6867519361396  E_coul = 198.69618443806633
cycle= 5 E= -507.990567498073  delta_E= -1.41e-08  |g|= 5.95e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.60886e-06
diis-c [-9.30138194e-13  6.07235757e-07 -5.57944678e-04  7.56244179e-03
 -9.08069870e-02  1.08380188e+00]
  HOMO = -0.242810189748249  LUMO = 0.880785608165581
  mo_energy =
[-1.20325772e+02 -1.23805334e+01 -6.67770299e+00 -6.67770299e+00
 -6.67770299e+00 -1.17935338e+00 -2.42810190e-01 -2.42810190e-01
 -2.42810190e-01  8.80785608e-01  5.38565396e+00  2.15645309e+01
  7.95122387e+01  2.74010994e+02  9.01662038e+02  3.15406803e+03
  1.26333421e+04  4.12298341e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6867382297334  E_coul = 198.69617073165236
cycle= 6 E= -507.990567498081  delta_E= -7.73e-12  |g|= 9.38e-08  |ddm|= 1.81e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6867382297334  E_coul = 198.69617073165236
  HOMO = -0.242810232950774  LUMO = 0.88078558358688
  mo_energy =
[-1.20325772e+02 -1.23805335e+01 -6.67770308e+00 -6.67770308e+00
 -6.67770308e+00 -1.17935340e+00 -2.42810233e-01 -2.42810233e-01
 -2.42810233e-01  8.80785584e-01  5.38565390e+00  2.15645308e+01
  7.95122386e+01  2.74010994e+02  9.01662038e+02  3.15406803e+03
  1.26333421e+04  4.12298341e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6867380406425  E_coul = 198.69617054256162
Extra cycle  E= -507.990567498081  delta_E= 1.14e-13  |g|= 1.21e-08  |ddm|= 2.3e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.29365861e-01 5.98424967e-01 1.81960041e+00 1.17616813e+05
 3.92667911e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547013e+04 7.30230829e+03
 1.83757708e+04 1.44362855e+03 4.17375867e+02 1.47789595e+02
 5.84085335e+01 2.46895263e+01 8.60392493e+00 8.60524645e+00
 4.92891144e-01]
E = -507.99056749808085
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:19 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229365861192       1
[INPUT] 0    0    [1    /1   ]  0.598424967164       1
[INPUT] 0    0    [1    /1   ]  1.81960041224        1
[INPUT] 0    0    [1    /1   ]  117616.812874        1
[INPUT] 0    0    [1    /1   ]  3.92667911457        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030919        1
[INPUT] 0    0    [1    /1   ]  147020.991314        1
[INPUT] 0    0    [1    /1   ]  73510.417508         1
[INPUT] 0    0    [1    /1   ]  36754.7013253        1
[INPUT] 0    0    [1    /1   ]  7302.30828588        1
[INPUT] 0    0    [1    /1   ]  18375.7708262        1
[INPUT] 0    0    [1    /1   ]  1443.6285459         1
[INPUT] 0    0    [1    /1   ]  417.375867339        1
[INPUT] 0    0    [1    /1   ]  147.789594765        1
[INPUT] 0    0    [1    /1   ]  58.4085334826        1
[INPUT] 0    0    [1    /1   ]  24.6895263156        1
[INPUT] 0    0    [1    /1   ]  8.6039249269         1
[INPUT] 1    0    [1    /1   ]  8.60524645034        1
[INPUT] 1    0    [1    /1   ]  0.492891143769       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22936586119202054, 1.0]], [0, [0.5984249671642824, 1.0]], [0, [1.819600412239315, 1.0]], [0, [117616.81287370644, 1.0]], [0, [3.9266791145654936, 1.0]], [0, [1176168.1426133476, 1.0]], [0, [588084.0699561061, 1.0]], [0, [294042.030918985, 1.0]], [0, [147020.99131363563, 1.0]], [0, [73510.41750795778, 1.0]], [0, [36754.70132526082, 1.0]], [0, [7302.3082858836615, 1.0]], [0, [18375.770826177923, 1.0]], [0, [1443.6285459038802, 1.0]], [0, [417.37586733873184, 1.0]], [0, [147.7895947654844, 1.0]], [0, [58.408533482566064, 1.0]], [0, [24.6895263156371, 1.0]], [0, [8.603924926902337, 1.0]], [1, [8.605246450341896, 1.0]], [1, [0.4928911437686589, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22936586]
bas 1, expnt(s) = [0.59842497]
bas 2, expnt(s) = [1.81960041]
bas 3, expnt(s) = [117616.81287371]
bas 4, expnt(s) = [3.92667911]
bas 5, expnt(s) = [1176168.14261335]
bas 6, expnt(s) = [588084.06995611]
bas 7, expnt(s) = [294042.03091899]
bas 8, expnt(s) = [147020.99131364]
bas 9, expnt(s) = [73510.41750796]
bas 10, expnt(s) = [36754.70132526]
bas 11, expnt(s) = [7302.30828588]
bas 12, expnt(s) = [18375.77082618]
bas 13, expnt(s) = [1443.6285459]
bas 14, expnt(s) = [417.37586734]
bas 15, expnt(s) = [147.78959477]
bas 16, expnt(s) = [58.40853348]
bas 17, expnt(s) = [24.68952632]
bas 18, expnt(s) = [8.60392493]
bas 19, expnt(s) = [8.60524645]
bas 20, expnt(s) = [0.49289114]
CPU time:       804.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29365861e-01 8.37358837e-01 5.98424967e-01 1.71898585e+00
 1.81960041e+00 3.95819371e+00 1.17616813e+05 1.60460108e+04
 3.92667911e+00 7.04748376e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547013e+04 6.70655820e+03 7.30230829e+03 1.99576842e+03
 1.83757708e+04 3.98748625e+03 1.44362855e+03 5.91706881e+02
 4.17375867e+02 2.33297736e+02 1.47789595e+02 1.07089753e+02
 5.84085335e+01 5.33792234e+01 2.46895263e+01 2.79833428e+01
 8.60392493e+00 1.26922168e+01 8.60524645e+00 4.29970375e+01
 4.92891144e-01 1.20482275e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33589841047268
cond(S) = 912587.1538891001
E1 = -689.6058382889072  E_coul = 184.980541810794
init E= -504.625296478113
    CPU time for initialize scf      0.89 sec, wall time      0.08 sec
  HOMO = -0.671996056539032  LUMO = 0.539075923255279
  mo_energy =
[-1.21708462e+02 -1.33855550e+01 -7.62301209e+00 -7.62301209e+00
 -7.62301209e+00 -1.65742459e+00 -6.71996057e-01 -6.71996057e-01
 -6.71996057e-01  5.39075923e-01  4.79964187e+00  2.06907212e+01
  7.83385472e+01  2.72674572e+02  9.00303259e+02  3.15278363e+03
  1.26321748e+04  4.12287381e+04  1.05256599e+05  2.30429500e+05
  4.56236847e+05  8.45183334e+05  1.52835501e+06  2.85061553e+06
  5.80849398e+06]
E1 = -707.7668642510057  E_coul = 199.79439812594126
cycle= 1 E= -507.972466125064  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.757983
diis-c [-0.57453877  1.        ]
  HOMO = -0.217304285181444  LUMO = 0.885238057329218
  mo_energy =
[-1.20198640e+02 -1.23037928e+01 -6.59321282e+00 -6.59321282e+00
 -6.59321282e+00 -1.16306836e+00 -2.17304285e-01 -2.17304285e-01
 -2.17304285e-01  8.85238057e-01  5.41770640e+00  2.16284358e+01
  7.96057850e+01  2.74127189e+02  9.01795068e+02  3.15421611e+03
  1.26335008e+04  4.12299969e+04  1.05257821e+05  2.30430697e+05
  4.56238027e+05  8.45184501e+05  1.52835617e+06  2.85061667e+06
  5.80849512e+06]
E1 = -706.8112650714132  E_coul = 198.82096516537973
cycle= 2 E= -507.990299906033  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347216
diis-c [-0.00120046 -0.00299987  1.00299987]
  HOMO = -0.239509435215538  LUMO = 0.881575500327833
  mo_energy =
[-1.20313703e+02 -1.23716456e+01 -6.66833856e+00 -6.66833856e+00
 -6.66833856e+00 -1.17735349e+00 -2.39509435e-01 -2.39509435e-01
 -2.39509435e-01  8.81575500e-01  5.38997619e+00  2.15721231e+01
  7.95221754e+01  2.74022393e+02  9.01674343e+02  3.15408104e+03
  1.26333555e+04  4.12298478e+04  1.05257670e+05  2.30430545e+05
  4.56237875e+05  8.45184349e+05  1.52835601e+06  2.85061652e+06
  5.80849496e+06]
E1 = -706.702756937683  E_coul = 198.71219451330546
cycle= 3 E= -507.990562424378  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381006
diis-c [-3.25917793e-06  1.22340111e-04 -1.07406923e-01  1.10728458e+00]
  HOMO = -0.242659487640375  LUMO = 0.880830665720892
  mo_energy =
[-1.20325427e+02 -1.23801935e+01 -6.67736749e+00 -6.67736749e+00
 -6.67736749e+00 -1.17926185e+00 -2.42659488e-01 -2.42659488e-01
 -2.42659488e-01  8.80830666e-01  5.38585768e+00  2.15648323e+01
  7.95125739e+01  2.74011336e+02  9.01662383e+02  3.15406838e+03
  1.26333424e+04  4.12298345e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6874643566406  E_coul = 198.69689687269795
cycle= 4 E= -507.990567483943  delta_E= -5.06e-06  |g|= 0.000232  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172813
diis-c [-5.58281401e-10 -9.44749863e-06  6.85275488e-03 -9.74473846e-02
  1.09060408e+00]
  HOMO = -0.242807480525432  LUMO = 0.880786377758655
  mo_energy =
[-1.20325765e+02 -1.23805282e+01 -6.67769769e+00 -6.67769769e+00
 -6.67769769e+00 -1.17935152e+00 -2.42807481e-01 -2.42807481e-01
 -2.42807481e-01  8.80786378e-01  5.38565768e+00  2.15645358e+01
  7.95122441e+01  2.74011000e+02  9.01662044e+02  3.15406804e+03
  1.26333421e+04  4.12298341e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6867519361396  E_coul = 198.69618443806633
cycle= 5 E= -507.990567498073  delta_E= -1.41e-08  |g|= 5.95e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.60886e-06
diis-c [-9.30138194e-13  6.07235757e-07 -5.57944678e-04  7.56244179e-03
 -9.08069870e-02  1.08380188e+00]
  HOMO = -0.242810189748249  LUMO = 0.880785608165581
  mo_energy =
[-1.20325772e+02 -1.23805334e+01 -6.67770299e+00 -6.67770299e+00
 -6.67770299e+00 -1.17935338e+00 -2.42810190e-01 -2.42810190e-01
 -2.42810190e-01  8.80785608e-01  5.38565396e+00  2.15645309e+01
  7.95122387e+01  2.74010994e+02  9.01662038e+02  3.15406803e+03
  1.26333421e+04  4.12298341e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6867382297334  E_coul = 198.69617073165236
cycle= 6 E= -507.990567498081  delta_E= -7.73e-12  |g|= 9.38e-08  |ddm|= 1.81e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6867382297334  E_coul = 198.69617073165236
  HOMO = -0.242810232950774  LUMO = 0.88078558358688
  mo_energy =
[-1.20325772e+02 -1.23805335e+01 -6.67770308e+00 -6.67770308e+00
 -6.67770308e+00 -1.17935340e+00 -2.42810233e-01 -2.42810233e-01
 -2.42810233e-01  8.80785584e-01  5.38565390e+00  2.15645308e+01
  7.95122386e+01  2.74010994e+02  9.01662038e+02  3.15406803e+03
  1.26333421e+04  4.12298341e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6867380406425  E_coul = 198.69617054256162
Extra cycle  E= -507.990567498081  delta_E= 1.14e-13  |g|= 1.21e-08  |ddm|= 2.3e-07
    CPU time for scf_cycle      1.73 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912587.1538891001
E1 = -706.6867380406425  E_coul = 198.69617054256162
init E= -507.990567498081
    CPU time for initialize scf      5.86 sec, wall time      0.25 sec
  HOMO = -0.242810239129049  LUMO = 0.880785582304718
  mo_energy =
[-1.20325772e+02 -1.23805335e+01 -6.67770309e+00 -6.67770309e+00
 -6.67770309e+00 -1.17935340e+00 -2.42810239e-01 -2.42810239e-01
 -2.42810239e-01  8.80785582e-01  5.38565389e+00  2.15645308e+01
  7.95122386e+01  2.74010994e+02  9.01662038e+02  3.15406803e+03
  1.26333421e+04  4.12298341e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6867380105999  E_coul = 198.69617051251925
cycle= 1 E= -507.990567498081  delta_E= 1.71e-13  |g|= 2.49e-09  |ddm|= 3.14e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6867380105999  E_coul = 198.69617051251925
  HOMO = -0.242810240074791  LUMO = 0.8807855818755
  mo_energy =
[-1.20325772e+02 -1.23805335e+01 -6.67770309e+00 -6.67770309e+00
 -6.67770309e+00 -1.17935340e+00 -2.42810240e-01 -2.42810240e-01
 -2.42810240e-01  8.80785582e-01  5.38565389e+00  2.15645308e+01
  7.95122386e+01  2.74010994e+02  9.01662038e+02  3.15406803e+03
  1.26333421e+04  4.12298341e+04  1.05257656e+05  2.30430532e+05
  4.56237861e+05  8.45184335e+05  1.52835600e+06  2.85061651e+06
  5.80849495e+06]
E1 = -706.6867380044279  E_coul = 198.6961705063474
Extra cycle  E= -507.99056749808  delta_E= 2.27e-13  |g|= 8.72e-10  |ddm|= 4.85e-09
    CPU time for scf_cycle      6.36 sec, wall time      0.42 sec
exp = [2.29365861e-01 5.98424967e-01 1.81960041e+00 1.17616813e+05
 3.92667911e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547013e+04 7.30230829e+03
 1.83757708e+04 1.44362855e+03 4.17375867e+02 1.47789595e+02
 5.84085335e+01 2.46895263e+01 8.60392493e+00 8.60524645e+00
 4.92891144e-01]
grad_E = [-1.37036351e-03  8.81501694e-04 -1.16692404e-04  6.05068848e-09
  4.36012713e-04  4.03105125e-11  1.73775320e-10  9.38528274e-10
  3.70797663e-09  1.54834785e-08  8.07749088e-08  5.09136776e-06
  1.97889577e-07 -3.80781202e-05 -9.51440932e-06  1.73387178e-05
 -4.32646147e-05 -3.29586818e-05 -3.17679284e-04  6.52293822e-04
  4.15709166e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.230334927814       1
[INPUT] 0    0    [1    /1   ]  0.602517878597       1
[INPUT] 0    0    [1    /1   ]  1.81583506441        1
[INPUT] 0    0    [1    /1   ]  117616.81287         1
[INPUT] 0    0    [1    /1   ]  3.99200103171        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991311        1
[INPUT] 0    0    [1    /1   ]  73510.4174985        1
[INPUT] 0    0    [1    /1   ]  36754.7012757        1
[INPUT] 0    0    [1    /1   ]  7302.30516475        1
[INPUT] 0    0    [1    /1   ]  18375.7707048        1
[INPUT] 0    0    [1    /1   ]  1443.65194542        1
[INPUT] 0    0    [1    /1   ]  417.381027452        1
[INPUT] 0    0    [1    /1   ]  147.78238701         1
[INPUT] 0    0    [1    /1   ]  58.4220772827        1
[INPUT] 0    0    [1    /1   ]  24.710434826         1
[INPUT] 0    0    [1    /1   ]  8.79017244782        1
[INPUT] 1    0    [1    /1   ]  8.6050005213         1
[INPUT] 1    0    [1    /1   ]  0.492856318764       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23033492781443152, 1.0]], [0, [0.6025178785974128, 1.0]], [0, [1.8158350644125996, 1.0]], [0, [117616.81286999695, 1.0]], [0, [3.992001031706398, 1.0]], [0, [1176168.142613323, 1.0]], [0, [588084.0699559996, 1.0]], [0, [294042.03091840964, 1.0]], [0, [147020.99131136236, 1.0]], [0, [73510.41749846516, 1.0]], [0, [36754.70127574237, 1.0]], [0, [7302.305164748563, 1.0]], [0, [18375.770704831826, 1.0]], [0, [1443.6519454201318, 1.0]], [0, [417.38102745171585, 1.0]], [0, [147.78238701031427, 1.0]], [0, [58.422077282668916, 1.0]], [0, [24.710434825996085, 1.0]], [0, [8.790172447822757, 1.0]], [1, [8.605000521296974, 1.0]], [1, [0.4928563187635682, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23033493]
bas 1, expnt(s) = [0.60251788]
bas 2, expnt(s) = [1.81583506]
bas 3, expnt(s) = [117616.81287]
bas 4, expnt(s) = [3.99200103]
bas 5, expnt(s) = [1176168.14261332]
bas 6, expnt(s) = [588084.069956]
bas 7, expnt(s) = [294042.03091841]
bas 8, expnt(s) = [147020.99131136]
bas 9, expnt(s) = [73510.41749847]
bas 10, expnt(s) = [36754.70127574]
bas 11, expnt(s) = [7302.30516475]
bas 12, expnt(s) = [18375.77070483]
bas 13, expnt(s) = [1443.65194542]
bas 14, expnt(s) = [417.38102745]
bas 15, expnt(s) = [147.78238701]
bas 16, expnt(s) = [58.42207728]
bas 17, expnt(s) = [24.71043483]
bas 18, expnt(s) = [8.79017245]
bas 19, expnt(s) = [8.60500052]
bas 20, expnt(s) = [0.49285632]
CPU time:       819.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30334928e-01 8.40010807e-01 6.02517879e-01 1.72779605e+00
 1.81583506e+00 3.95204902e+00 1.17616813e+05 1.60460108e+04
 3.99200103e+00 7.13523051e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547013e+04 6.70655819e+03 7.30230516e+03 1.99576778e+03
 1.83757707e+04 3.98748623e+03 1.44365195e+03 5.91714075e+02
 4.17381027e+02 2.33299900e+02 1.47782387e+02 1.07085836e+02
 5.84220773e+01 5.33885063e+01 2.47104348e+01 2.80011143e+01
 8.79017245e+00 1.28977237e+01 8.60500052e+00 4.29955015e+01
 4.92856319e-01 1.20471635e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335940128776894
cond(S) = 912611.4849812544
E1 = -689.6037880661556  E_coul = 184.97840432547514
init E= -504.62538374068
    CPU time for initialize scf      0.74 sec, wall time      0.07 sec
  HOMO = -0.672035237127862  LUMO = 0.544932168412707
  mo_energy =
[-1.21708784e+02 -1.33857433e+01 -7.62314817e+00 -7.62314817e+00
 -7.62314817e+00 -1.65745812e+00 -6.72035237e-01 -6.72035237e-01
 -6.72035237e-01  5.44932168e-01  4.84348970e+00  2.10340782e+01
  7.92377457e+01  2.73795370e+02  9.01399381e+02  3.15380962e+03
  1.26331325e+04  4.12296424e+04  1.05257468e+05  2.30430345e+05
  4.56237674e+05  8.45184148e+05  1.52835581e+06  2.85061631e+06
  5.80849474e+06]
E1 = -707.7639846702583  E_coul = 199.79149266895095
cycle= 1 E= -507.972492001307  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.758308
diis-c [-0.5750304  1.       ]
  HOMO = -0.217387771245201  LUMO = 0.892263365796095
  mo_energy =
[-1.20198990e+02 -1.23040352e+01 -6.59339907e+00 -6.59339907e+00
 -6.59339907e+00 -1.16313247e+00 -2.17387771e-01 -2.17387771e-01
 -2.17387771e-01  8.92263366e-01  5.46416020e+00  2.19770077e+01
  8.05062730e+01  2.75247885e+02  9.02891114e+02  3.15524208e+03
  1.26344585e+04  4.12309013e+04  1.05258690e+05  2.30431542e+05
  4.56238855e+05  8.45185315e+05  1.52835697e+06  2.85061746e+06
  5.80849588e+06]
E1 = -706.8085600124457  E_coul = 198.81823678853152
cycle= 2 E= -507.990323223914  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347577
diis-c [-0.00120302 -0.00298397  1.00298397]
  HOMO = -0.23958332327049  LUMO = 0.888554207780725
  mo_energy =
[-1.20314042e+02 -1.23718747e+01 -6.66851218e+00 -6.66851218e+00
 -6.66851218e+00 -1.17741081e+00 -2.39583323e-01 -2.39583323e-01
 -2.39583323e-01  8.88554208e-01  5.43621547e+00  2.19203141e+01
  8.04225365e+01  2.75143101e+02  9.02770407e+02  3.15510702e+03
  1.26343132e+04  4.12307521e+04  1.05258539e+05  2.30431391e+05
  4.56238702e+05  8.45185163e+05  1.52835682e+06  2.85061730e+06
  5.80849573e+06]
E1 = -706.7001815598965  E_coul = 198.70959638733646
cycle= 3 E= -507.99058517256  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00380939
diis-c [-3.25437573e-06  1.19570560e-04 -1.07274823e-01  1.10715525e+00]
  HOMO = -0.242728020823582  LUMO = 0.887803207709069
  mo_energy =
[-1.20325755e+02 -1.23804129e+01 -6.67753126e+00 -6.67753126e+00
 -6.67753126e+00 -1.17931572e+00 -2.42728021e-01 -2.42728021e-01
 -2.42728021e-01  8.87803208e-01  5.43207564e+00  2.19129932e+01
  8.04129341e+01  2.75132055e+02  9.02758459e+02  3.15509437e+03
  1.26343001e+04  4.12307389e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6849285655483  E_coul = 198.69433836172917
cycle= 4 E= -507.990590203819  delta_E= -5.03e-06  |g|= 0.000231  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172328
diis-c [-5.44010092e-10 -9.42286053e-06  6.84185731e-03 -9.72959243e-02
  1.09046349e+00]
  HOMO = -0.24287529508191  LUMO = 0.887758791002877
  mo_energy =
[-1.20326092e+02 -1.23807463e+01 -6.67786021e+00 -6.67786021e+00
 -6.67786021e+00 -1.17940493e+00 -2.42875295e-01 -2.42875295e-01
 -2.42875295e-01  8.87758791e-01  5.43187553e+00  2.19126969e+01
  8.04126055e+01  2.75131720e+02  9.02758121e+02  3.15509403e+03
  1.26342998e+04  4.12307385e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6842205492819  E_coul = 198.693630331546
cycle= 5 E= -507.990590217736  delta_E= -1.39e-08  |g|= 5.84e-06  |ddm|= 0.000671
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.56554e-06
diis-c [-9.17420919e-13  6.04004876e-07 -5.52241285e-04  7.48297170e-03
 -8.99120523e-02  1.08298072e+00]
  HOMO = -0.242877964123179  LUMO = 0.887758032964679
  mo_energy =
[-1.20326098e+02 -1.23807515e+01 -6.67786544e+00 -6.67786544e+00
 -6.67786544e+00 -1.17940676e+00 -2.42877964e-01 -2.42877964e-01
 -2.42877964e-01  8.87758033e-01  5.43187186e+00  2.19126921e+01
  8.04126001e+01  2.75131714e+02  9.02758115e+02  3.15509403e+03
  1.26342998e+04  4.12307385e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6842070769437  E_coul = 198.69361685920063
cycle= 6 E= -507.990590217743  delta_E= -7.16e-12  |g|= 9.3e-08  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6842070769437  E_coul = 198.69361685920063
  HOMO = -0.242878007414281  LUMO = 0.887758006102719
  mo_energy =
[-1.20326098e+02 -1.23807516e+01 -6.67786552e+00 -6.67786552e+00
 -6.67786552e+00 -1.17940678e+00 -2.42878007e-01 -2.42878007e-01
 -2.42878007e-01  8.87758006e-01  5.43187179e+00  2.19126920e+01
  8.04126000e+01  2.75131714e+02  9.02758115e+02  3.15509403e+03
  1.26342998e+04  4.12307385e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6842068889766  E_coul = 198.69361667123354
Extra cycle  E= -507.990590217743  delta_E=    0  |g|= 1.18e-08  |ddm|= 2.28e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.30 sec
exp = [2.30334928e-01 6.02517879e-01 1.81583506e+00 1.17616813e+05
 3.99200103e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547013e+04 7.30230516e+03
 1.83757707e+04 1.44365195e+03 4.17381027e+02 1.47782387e+02
 5.84220773e+01 2.47104348e+01 8.79017245e+00 8.60500052e+00
 4.92856319e-01]
E = -507.9905902177431
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:27 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.230334927814       1
[INPUT] 0    0    [1    /1   ]  0.602517878597       1
[INPUT] 0    0    [1    /1   ]  1.81583506441        1
[INPUT] 0    0    [1    /1   ]  117616.81287         1
[INPUT] 0    0    [1    /1   ]  3.99200103171        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991311        1
[INPUT] 0    0    [1    /1   ]  73510.4174985        1
[INPUT] 0    0    [1    /1   ]  36754.7012757        1
[INPUT] 0    0    [1    /1   ]  7302.30516475        1
[INPUT] 0    0    [1    /1   ]  18375.7707048        1
[INPUT] 0    0    [1    /1   ]  1443.65194542        1
[INPUT] 0    0    [1    /1   ]  417.381027452        1
[INPUT] 0    0    [1    /1   ]  147.78238701         1
[INPUT] 0    0    [1    /1   ]  58.4220772827        1
[INPUT] 0    0    [1    /1   ]  24.710434826         1
[INPUT] 0    0    [1    /1   ]  8.79017244782        1
[INPUT] 1    0    [1    /1   ]  8.6050005213         1
[INPUT] 1    0    [1    /1   ]  0.492856318764       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23033492781443152, 1.0]], [0, [0.6025178785974128, 1.0]], [0, [1.8158350644125996, 1.0]], [0, [117616.81286999695, 1.0]], [0, [3.992001031706398, 1.0]], [0, [1176168.142613323, 1.0]], [0, [588084.0699559996, 1.0]], [0, [294042.03091840964, 1.0]], [0, [147020.99131136236, 1.0]], [0, [73510.41749846516, 1.0]], [0, [36754.70127574237, 1.0]], [0, [7302.305164748563, 1.0]], [0, [18375.770704831826, 1.0]], [0, [1443.6519454201318, 1.0]], [0, [417.38102745171585, 1.0]], [0, [147.78238701031427, 1.0]], [0, [58.422077282668916, 1.0]], [0, [24.710434825996085, 1.0]], [0, [8.790172447822757, 1.0]], [1, [8.605000521296974, 1.0]], [1, [0.4928563187635682, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23033493]
bas 1, expnt(s) = [0.60251788]
bas 2, expnt(s) = [1.81583506]
bas 3, expnt(s) = [117616.81287]
bas 4, expnt(s) = [3.99200103]
bas 5, expnt(s) = [1176168.14261332]
bas 6, expnt(s) = [588084.069956]
bas 7, expnt(s) = [294042.03091841]
bas 8, expnt(s) = [147020.99131136]
bas 9, expnt(s) = [73510.41749847]
bas 10, expnt(s) = [36754.70127574]
bas 11, expnt(s) = [7302.30516475]
bas 12, expnt(s) = [18375.77070483]
bas 13, expnt(s) = [1443.65194542]
bas 14, expnt(s) = [417.38102745]
bas 15, expnt(s) = [147.78238701]
bas 16, expnt(s) = [58.42207728]
bas 17, expnt(s) = [24.71043483]
bas 18, expnt(s) = [8.79017245]
bas 19, expnt(s) = [8.60500052]
bas 20, expnt(s) = [0.49285632]
CPU time:       821.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30334928e-01 8.40010807e-01 6.02517879e-01 1.72779605e+00
 1.81583506e+00 3.95204902e+00 1.17616813e+05 1.60460108e+04
 3.99200103e+00 7.13523051e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547013e+04 6.70655819e+03 7.30230516e+03 1.99576778e+03
 1.83757707e+04 3.98748623e+03 1.44365195e+03 5.91714075e+02
 4.17381027e+02 2.33299900e+02 1.47782387e+02 1.07085836e+02
 5.84220773e+01 5.33885063e+01 2.47104348e+01 2.80011143e+01
 8.79017245e+00 1.28977237e+01 8.60500052e+00 4.29955015e+01
 4.92856319e-01 1.20471635e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.335940128776894
cond(S) = 912611.4849812544
E1 = -689.6037880661556  E_coul = 184.97840432547514
init E= -504.62538374068
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672035237127862  LUMO = 0.544932168412707
  mo_energy =
[-1.21708784e+02 -1.33857433e+01 -7.62314817e+00 -7.62314817e+00
 -7.62314817e+00 -1.65745812e+00 -6.72035237e-01 -6.72035237e-01
 -6.72035237e-01  5.44932168e-01  4.84348970e+00  2.10340782e+01
  7.92377457e+01  2.73795370e+02  9.01399381e+02  3.15380962e+03
  1.26331325e+04  4.12296424e+04  1.05257468e+05  2.30430345e+05
  4.56237674e+05  8.45184148e+05  1.52835581e+06  2.85061631e+06
  5.80849474e+06]
E1 = -707.7639846702583  E_coul = 199.79149266895095
cycle= 1 E= -507.972492001307  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.72 sec, wall time      0.04 sec
diis-norm(errvec)=0.758308
diis-c [-0.5750304  1.       ]
  HOMO = -0.217387771245201  LUMO = 0.892263365796095
  mo_energy =
[-1.20198990e+02 -1.23040352e+01 -6.59339907e+00 -6.59339907e+00
 -6.59339907e+00 -1.16313247e+00 -2.17387771e-01 -2.17387771e-01
 -2.17387771e-01  8.92263366e-01  5.46416020e+00  2.19770077e+01
  8.05062730e+01  2.75247885e+02  9.02891114e+02  3.15524208e+03
  1.26344585e+04  4.12309013e+04  1.05258690e+05  2.30431542e+05
  4.56238855e+05  8.45185315e+05  1.52835697e+06  2.85061746e+06
  5.80849588e+06]
E1 = -706.8085600124457  E_coul = 198.81823678853152
cycle= 2 E= -507.990323223914  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347577
diis-c [-0.00120302 -0.00298397  1.00298397]
  HOMO = -0.23958332327049  LUMO = 0.888554207780725
  mo_energy =
[-1.20314042e+02 -1.23718747e+01 -6.66851218e+00 -6.66851218e+00
 -6.66851218e+00 -1.17741081e+00 -2.39583323e-01 -2.39583323e-01
 -2.39583323e-01  8.88554208e-01  5.43621547e+00  2.19203141e+01
  8.04225365e+01  2.75143101e+02  9.02770407e+02  3.15510702e+03
  1.26343132e+04  4.12307521e+04  1.05258539e+05  2.30431391e+05
  4.56238702e+05  8.45185163e+05  1.52835682e+06  2.85061730e+06
  5.80849573e+06]
E1 = -706.7001815598965  E_coul = 198.70959638733646
cycle= 3 E= -507.99058517256  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00380939
diis-c [-3.25437573e-06  1.19570560e-04 -1.07274823e-01  1.10715525e+00]
  HOMO = -0.242728020823582  LUMO = 0.887803207709069
  mo_energy =
[-1.20325755e+02 -1.23804129e+01 -6.67753126e+00 -6.67753126e+00
 -6.67753126e+00 -1.17931572e+00 -2.42728021e-01 -2.42728021e-01
 -2.42728021e-01  8.87803208e-01  5.43207564e+00  2.19129932e+01
  8.04129341e+01  2.75132055e+02  9.02758459e+02  3.15509437e+03
  1.26343001e+04  4.12307389e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6849285655483  E_coul = 198.69433836172917
cycle= 4 E= -507.990590203819  delta_E= -5.03e-06  |g|= 0.000231  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172328
diis-c [-5.44010092e-10 -9.42286053e-06  6.84185731e-03 -9.72959243e-02
  1.09046349e+00]
  HOMO = -0.24287529508191  LUMO = 0.887758791002877
  mo_energy =
[-1.20326092e+02 -1.23807463e+01 -6.67786021e+00 -6.67786021e+00
 -6.67786021e+00 -1.17940493e+00 -2.42875295e-01 -2.42875295e-01
 -2.42875295e-01  8.87758791e-01  5.43187553e+00  2.19126969e+01
  8.04126055e+01  2.75131720e+02  9.02758121e+02  3.15509403e+03
  1.26342998e+04  4.12307385e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6842205492819  E_coul = 198.693630331546
cycle= 5 E= -507.990590217736  delta_E= -1.39e-08  |g|= 5.84e-06  |ddm|= 0.000671
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.56554e-06
diis-c [-9.17420919e-13  6.04004876e-07 -5.52241285e-04  7.48297170e-03
 -8.99120523e-02  1.08298072e+00]
  HOMO = -0.242877964123179  LUMO = 0.887758032964679
  mo_energy =
[-1.20326098e+02 -1.23807515e+01 -6.67786544e+00 -6.67786544e+00
 -6.67786544e+00 -1.17940676e+00 -2.42877964e-01 -2.42877964e-01
 -2.42877964e-01  8.87758033e-01  5.43187186e+00  2.19126921e+01
  8.04126001e+01  2.75131714e+02  9.02758115e+02  3.15509403e+03
  1.26342998e+04  4.12307385e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6842070769437  E_coul = 198.69361685920063
cycle= 6 E= -507.990590217743  delta_E= -7.16e-12  |g|= 9.3e-08  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6842070769437  E_coul = 198.69361685920063
  HOMO = -0.242878007414281  LUMO = 0.887758006102719
  mo_energy =
[-1.20326098e+02 -1.23807516e+01 -6.67786552e+00 -6.67786552e+00
 -6.67786552e+00 -1.17940678e+00 -2.42878007e-01 -2.42878007e-01
 -2.42878007e-01  8.87758006e-01  5.43187179e+00  2.19126920e+01
  8.04126000e+01  2.75131714e+02  9.02758115e+02  3.15509403e+03
  1.26342998e+04  4.12307385e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6842068889766  E_coul = 198.69361667123354
Extra cycle  E= -507.990590217743  delta_E=    0  |g|= 1.18e-08  |ddm|= 2.28e-07
    CPU time for scf_cycle      1.63 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912611.4849812544
E1 = -706.6842068889766  E_coul = 198.69361667123354
init E= -507.990590217743
    CPU time for initialize scf      9.84 sec, wall time      0.45 sec
  HOMO = -0.242878013541048  LUMO = 0.887758003699007
  mo_energy =
[-1.20326098e+02 -1.23807516e+01 -6.67786554e+00 -6.67786554e+00
 -6.67786554e+00 -1.17940679e+00 -2.42878014e-01 -2.42878014e-01
 -2.42878014e-01  8.87758004e-01  5.43187178e+00  2.19126920e+01
  8.04126000e+01  2.75131714e+02  9.02758115e+02  3.15509403e+03
  1.26342998e+04  4.12307385e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6842068591061  E_coul = 198.69361664136272
cycle= 1 E= -507.990590217743  delta_E= -2.84e-13  |g|= 2.47e-09  |ddm|= 3.06e-08
    CPU time for cycle= 1      0.24 sec, wall time      0.03 sec
E1 = -706.6842068591061  E_coul = 198.69361664136272
  HOMO = -0.242878014466042  LUMO = 0.887758005114051
  mo_energy =
[-1.20326098e+02 -1.23807516e+01 -6.67786554e+00 -6.67786554e+00
 -6.67786554e+00 -1.17940679e+00 -2.42878014e-01 -2.42878014e-01
 -2.42878014e-01  8.87758005e-01  5.43187178e+00  2.19126920e+01
  8.04126000e+01  2.75131714e+02  9.02758115e+02  3.15509403e+03
  1.26342998e+04  4.12307385e+04  1.05258526e+05  2.30431377e+05
  4.56238689e+05  8.45185149e+05  1.52835680e+06  2.85061729e+06
  5.80849571e+06]
E1 = -706.6842068533202  E_coul = 198.69361663557754
Extra cycle  E= -507.990590217743  delta_E= 6.82e-13  |g|= 1.18e-09  |ddm|= 5.82e-09
    CPU time for scf_cycle     10.23 sec, wall time      0.63 sec
exp = [2.30334928e-01 6.02517879e-01 1.81583506e+00 1.17616813e+05
 3.99200103e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547013e+04 7.30230516e+03
 1.83757707e+04 1.44365195e+03 4.17381027e+02 1.47782387e+02
 5.84220773e+01 2.47104348e+01 8.79017245e+00 8.60500052e+00
 4.92856319e-01]
grad_E = [-1.19386694e-03  8.01831125e-04 -1.60007630e-04  6.05039797e-09
  3.93648875e-04  4.03073318e-11  1.73765658e-10  9.38484029e-10
  3.70779624e-09  1.54827132e-08  8.07713296e-08  5.09122860e-06
  1.97876697e-07 -3.80848772e-05 -9.54961205e-06  1.87831913e-05
 -5.51235747e-05 -2.01082443e-05 -2.21694662e-04  4.88755421e-04
  3.14958271e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22941483099        1
[INPUT] 0    0    [1    /1   ]  0.59933810031        1
[INPUT] 0    0    [1    /1   ]  1.78687388684        1
[INPUT] 0    0    [1    /1   ]  117616.812867        1
[INPUT] 0    0    [1    /1   ]  4.00342872372        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.99131         1
[INPUT] 0    0    [1    /1   ]  73510.417491         1
[INPUT] 0    0    [1    /1   ]  36754.7012368        1
[INPUT] 0    0    [1    /1   ]  7302.30271067        1
[INPUT] 0    0    [1    /1   ]  18375.7706094        1
[INPUT] 0    0    [1    /1   ]  1443.67032254        1
[INPUT] 0    0    [1    /1   ]  417.385317601        1
[INPUT] 0    0    [1    /1   ]  147.775728779        1
[INPUT] 0    0    [1    /1   ]  58.4353636035        1
[INPUT] 0    0    [1    /1   ]  24.7261698554        1
[INPUT] 0    0    [1    /1   ]  8.93917116842        1
[INPUT] 1    0    [1    /1   ]  8.60454660242        1
[INPUT] 1    0    [1    /1   ]  0.492791196089       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22941483098954102, 1.0]], [0, [0.5993381003099449, 1.0]], [0, [1.786873886838522, 1.0]], [0, [117616.8128670803, 1.0]], [0, [4.003428723719927, 1.0]], [0, [1176168.1426133036, 1.0]], [0, [588084.0699559158, 1.0]], [0, [294042.03091795725, 1.0]], [0, [147020.99130957498, 1.0]], [0, [73510.41749100146, 1.0]], [0, [36754.70123680703, 1.0]], [0, [7302.302710668615, 1.0]], [0, [18375.77060942819, 1.0]], [0, [1443.6703225354831, 1.0]], [0, [417.3853176011155, 1.0]], [0, [147.7757287788179, 1.0]], [0, [58.43536360348987, 1.0]], [0, [24.726169855409683, 1.0]], [0, [8.939171168415292, 1.0]], [1, [8.604546602423197, 1.0]], [1, [0.4927911960888731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22941483]
bas 1, expnt(s) = [0.5993381]
bas 2, expnt(s) = [1.78687389]
bas 3, expnt(s) = [117616.81286708]
bas 4, expnt(s) = [4.00342872]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.06995592]
bas 7, expnt(s) = [294042.03091796]
bas 8, expnt(s) = [147020.99130957]
bas 9, expnt(s) = [73510.417491]
bas 10, expnt(s) = [36754.70123681]
bas 11, expnt(s) = [7302.30271067]
bas 12, expnt(s) = [18375.77060943]
bas 13, expnt(s) = [1443.67032254]
bas 14, expnt(s) = [417.3853176]
bas 15, expnt(s) = [147.77572878]
bas 16, expnt(s) = [58.4353636]
bas 17, expnt(s) = [24.72616986]
bas 18, expnt(s) = [8.93917117]
bas 19, expnt(s) = [8.6045466]
bas 20, expnt(s) = [0.4927912]
CPU time:       840.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29414831e-01 8.37492916e-01 5.99338100e-01 1.72095272e+00
 1.78687389e+00 3.90468003e+00 1.17616813e+05 1.60460108e+04
 4.00342872e+00 7.15054427e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230271e+03 1.99576728e+03
 1.83757706e+04 3.98748622e+03 1.44367032e+03 5.91719724e+02
 4.17385318e+02 2.33301698e+02 1.47775729e+02 1.07082218e+02
 5.84353636e+01 5.33976122e+01 2.47261699e+01 2.80144861e+01
 8.93917117e+00 1.30613469e+01 8.60454660e+00 4.29926665e+01
 4.92791196e-01 1.20451737e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336029512738147
cond(S) = 912619.8028363856
E1 = -689.599698480107  E_coul = 184.97429939705992
init E= -504.625399083047
    CPU time for initialize scf      7.66 sec, wall time      0.37 sec
  HOMO = -0.672114256898347  LUMO = 0.539240648161653
  mo_energy =
[-1.21709387e+02 -1.33860783e+01 -7.62341086e+00 -7.62341086e+00
 -7.62341086e+00 -1.65753759e+00 -6.72114257e-01 -6.72114257e-01
 -6.72114257e-01  5.39240648e-01  4.79387674e+00  2.10747715e+01
  7.96364830e+01  2.74382885e+02  9.01998088e+02  3.15438150e+03
  1.26336787e+04  4.12301621e+04  1.05257969e+05  2.30430831e+05
  4.56238150e+05  8.45184617e+05  1.52835627e+06  2.85061676e+06
  5.80849518e+06]
E1 = -707.7587470592839  E_coul = 199.78623243772597
cycle= 1 E= -507.972514621558  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.758592
diis-c [-0.57546197  1.        ]
  HOMO = -0.217529712528801  LUMO = 0.885262481911596
  mo_energy =
[-1.20199657e+02 -1.23044492e+01 -6.59373720e+00 -6.59373720e+00
 -6.59373720e+00 -1.16324977e+00 -2.17529713e-01 -2.17529713e-01
 -2.17529713e-01  8.85262482e-01  5.41305507e+00  2.20202467e+01
  8.09060776e+01  2.75835382e+02  9.03489748e+02  3.15581392e+03
  1.26350047e+04  4.12314209e+04  1.05259190e+05  2.30432029e+05
  4.56239331e+05  8.45185783e+05  1.52835743e+06  2.85061791e+06
  5.80849632e+06]
E1 = -706.8034187205753  E_coul = 198.81307761101584
cycle= 2 E= -507.990341109559  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0349378
diis-c [-0.00121535 -0.00304834  1.00304834]
  HOMO = -0.239720971239799  LUMO = 0.881606244583234
  mo_energy =
[-1.20314711e+02 -1.23722864e+01 -6.66884873e+00 -6.66884873e+00
 -6.66884873e+00 -1.17752707e+00 -2.39720971e-01 -2.39720971e-01
 -2.39720971e-01  8.81606245e-01  5.38527002e+00  2.19634046e+01
  8.08222414e+01  2.75730590e+02  9.03369041e+02  3.15567886e+03
  1.26348594e+04  4.12312717e+04  1.05259040e+05  2.30431877e+05
  4.56239178e+05  8.45185631e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6949876626311  E_coul = 198.70438434957825
cycle= 3 E= -507.990603313053  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00383771
diis-c [-3.27921303e-06  1.11489043e-04 -1.07649703e-01  1.10753821e+00]
  HOMO = -0.242867913223742  LUMO = 0.880862634950929
  mo_energy =
[-1.20326426e+02 -1.23808280e+01 -6.67787088e+00 -6.67787088e+00
 -6.67787088e+00 -1.17943371e+00 -2.42867913e-01 -2.42867913e-01
 -2.42867913e-01  8.80862635e-01  5.38114705e+00  2.19560655e+01
  8.08126283e+01  2.75719542e+02  9.03357091e+02  3.15566621e+03
  1.26348463e+04  4.12312584e+04  1.05259026e+05  2.30431864e+05
  4.56239165e+05  8.45185618e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.6797101476936  E_coul = 198.6891017847838
cycle= 4 E= -507.99060836291  delta_E= -5.05e-06  |g|= 0.000231  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017273
diis-c [-5.65177543e-10 -9.49777803e-06  6.85894412e-03 -9.70953252e-02
  1.09024588e+00]
  HOMO = -0.243014571307529  LUMO = 0.880818658787778
  mo_energy =
[-1.20326759e+02 -1.23811589e+01 -6.67819709e+00 -6.67819709e+00
 -6.67819709e+00 -1.17952258e+00 -2.43014571e-01 -2.43014571e-01
 -2.43014571e-01  8.80818659e-01  5.38094850e+00  2.19557708e+01
  8.08123026e+01  2.75719210e+02  9.03356758e+02  3.15566587e+03
  1.26348460e+04  4.12312581e+04  1.05259026e+05  2.30431863e+05
  4.56239165e+05  8.45185617e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.67900422322  E_coul = 198.68839584635842
cycle= 5 E= -507.990608376862  delta_E= -1.4e-08  |g|= 5.99e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.64078e-06
diis-c [-9.49289133e-13  6.10255063e-07 -5.62953974e-04  7.59143588e-03
 -9.14165474e-02  1.08438746e+00]
  HOMO = -0.243017300294172  LUMO = 0.88081788679417
  mo_energy =
[-1.20326765e+02 -1.23811642e+01 -6.67820243e+00 -6.67820243e+00
 -6.67820243e+00 -1.17952445e+00 -2.43017300e-01 -2.43017300e-01
 -2.43017300e-01  8.80817887e-01  5.38094476e+00  2.19557659e+01
  8.08122971e+01  2.75719205e+02  9.03356752e+02  3.15566587e+03
  1.26348460e+04  4.12312581e+04  1.05259026e+05  2.30431863e+05
  4.56239165e+05  8.45185617e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.678990422124  E_coul = 198.6883820452545
cycle= 6 E= -507.990608376869  delta_E= -7.9e-12  |g|= 9.26e-08  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.678990422124  E_coul = 198.6883820452545
  HOMO = -0.243017343165051  LUMO = 0.880817862373541
  mo_energy =
[-1.20326765e+02 -1.23811643e+01 -6.67820252e+00 -6.67820252e+00
 -6.67820252e+00 -1.17952447e+00 -2.43017343e-01 -2.43017343e-01
 -2.43017343e-01  8.80817862e-01  5.38094469e+00  2.19557658e+01
  8.08122971e+01  2.75719204e+02  9.03356752e+02  3.15566587e+03
  1.26348460e+04  4.12312581e+04  1.05259026e+05  2.30431863e+05
  4.56239165e+05  8.45185617e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.6789902336204  E_coul = 198.68838185675116
Extra cycle  E= -507.990608376869  delta_E= 2.27e-13  |g|= 1.14e-08  |ddm|= 2.29e-07
    CPU time for scf_cycle      8.49 sec, wall time      0.59 sec
exp = [2.29414831e-01 5.99338100e-01 1.78687389e+00 1.17616813e+05
 4.00342872e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230271e+03
 1.83757706e+04 1.44367032e+03 4.17385318e+02 1.47775729e+02
 5.84353636e+01 2.47261699e+01 8.93917117e+00 8.60454660e+00
 4.92791196e-01]
E = -507.99060837686926
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22941483099        1
[INPUT] 0    0    [1    /1   ]  0.59933810031        1
[INPUT] 0    0    [1    /1   ]  1.78687388684        1
[INPUT] 0    0    [1    /1   ]  117616.812867        1
[INPUT] 0    0    [1    /1   ]  4.00342872372        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.99131         1
[INPUT] 0    0    [1    /1   ]  73510.417491         1
[INPUT] 0    0    [1    /1   ]  36754.7012368        1
[INPUT] 0    0    [1    /1   ]  7302.30271067        1
[INPUT] 0    0    [1    /1   ]  18375.7706094        1
[INPUT] 0    0    [1    /1   ]  1443.67032254        1
[INPUT] 0    0    [1    /1   ]  417.385317601        1
[INPUT] 0    0    [1    /1   ]  147.775728779        1
[INPUT] 0    0    [1    /1   ]  58.4353636035        1
[INPUT] 0    0    [1    /1   ]  24.7261698554        1
[INPUT] 0    0    [1    /1   ]  8.93917116842        1
[INPUT] 1    0    [1    /1   ]  8.60454660242        1
[INPUT] 1    0    [1    /1   ]  0.492791196089       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22941483098954102, 1.0]], [0, [0.5993381003099449, 1.0]], [0, [1.786873886838522, 1.0]], [0, [117616.8128670803, 1.0]], [0, [4.003428723719927, 1.0]], [0, [1176168.1426133036, 1.0]], [0, [588084.0699559158, 1.0]], [0, [294042.03091795725, 1.0]], [0, [147020.99130957498, 1.0]], [0, [73510.41749100146, 1.0]], [0, [36754.70123680703, 1.0]], [0, [7302.302710668615, 1.0]], [0, [18375.77060942819, 1.0]], [0, [1443.6703225354831, 1.0]], [0, [417.3853176011155, 1.0]], [0, [147.7757287788179, 1.0]], [0, [58.43536360348987, 1.0]], [0, [24.726169855409683, 1.0]], [0, [8.939171168415292, 1.0]], [1, [8.604546602423197, 1.0]], [1, [0.4927911960888731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22941483]
bas 1, expnt(s) = [0.5993381]
bas 2, expnt(s) = [1.78687389]
bas 3, expnt(s) = [117616.81286708]
bas 4, expnt(s) = [4.00342872]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.06995592]
bas 7, expnt(s) = [294042.03091796]
bas 8, expnt(s) = [147020.99130957]
bas 9, expnt(s) = [73510.417491]
bas 10, expnt(s) = [36754.70123681]
bas 11, expnt(s) = [7302.30271067]
bas 12, expnt(s) = [18375.77060943]
bas 13, expnt(s) = [1443.67032254]
bas 14, expnt(s) = [417.3853176]
bas 15, expnt(s) = [147.77572878]
bas 16, expnt(s) = [58.4353636]
bas 17, expnt(s) = [24.72616986]
bas 18, expnt(s) = [8.93917117]
bas 19, expnt(s) = [8.6045466]
bas 20, expnt(s) = [0.4927912]
CPU time:       849.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29414831e-01 8.37492916e-01 5.99338100e-01 1.72095272e+00
 1.78687389e+00 3.90468003e+00 1.17616813e+05 1.60460108e+04
 4.00342872e+00 7.15054427e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230271e+03 1.99576728e+03
 1.83757706e+04 3.98748622e+03 1.44367032e+03 5.91719724e+02
 4.17385318e+02 2.33301698e+02 1.47775729e+02 1.07082218e+02
 5.84353636e+01 5.33976122e+01 2.47261699e+01 2.80144861e+01
 8.93917117e+00 1.30613469e+01 8.60454660e+00 4.29926665e+01
 4.92791196e-01 1.20451737e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336029512738147
cond(S) = 912619.8028363856
E1 = -689.599698480107  E_coul = 184.97429939705992
init E= -504.625399083047
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672114256898347  LUMO = 0.539240648161653
  mo_energy =
[-1.21709387e+02 -1.33860783e+01 -7.62341086e+00 -7.62341086e+00
 -7.62341086e+00 -1.65753759e+00 -6.72114257e-01 -6.72114257e-01
 -6.72114257e-01  5.39240648e-01  4.79387674e+00  2.10747715e+01
  7.96364830e+01  2.74382885e+02  9.01998088e+02  3.15438150e+03
  1.26336787e+04  4.12301621e+04  1.05257969e+05  2.30430831e+05
  4.56238150e+05  8.45184617e+05  1.52835627e+06  2.85061676e+06
  5.80849518e+06]
E1 = -707.7587470592839  E_coul = 199.78623243772597
cycle= 1 E= -507.972514621558  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.758592
diis-c [-0.57546197  1.        ]
  HOMO = -0.217529712528801  LUMO = 0.885262481911596
  mo_energy =
[-1.20199657e+02 -1.23044492e+01 -6.59373720e+00 -6.59373720e+00
 -6.59373720e+00 -1.16324977e+00 -2.17529713e-01 -2.17529713e-01
 -2.17529713e-01  8.85262482e-01  5.41305507e+00  2.20202467e+01
  8.09060776e+01  2.75835382e+02  9.03489748e+02  3.15581392e+03
  1.26350047e+04  4.12314209e+04  1.05259190e+05  2.30432029e+05
  4.56239331e+05  8.45185783e+05  1.52835743e+06  2.85061791e+06
  5.80849632e+06]
E1 = -706.8034187205753  E_coul = 198.81307761101584
cycle= 2 E= -507.990341109559  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0349378
diis-c [-0.00121535 -0.00304834  1.00304834]
  HOMO = -0.239720971239799  LUMO = 0.881606244583234
  mo_energy =
[-1.20314711e+02 -1.23722864e+01 -6.66884873e+00 -6.66884873e+00
 -6.66884873e+00 -1.17752707e+00 -2.39720971e-01 -2.39720971e-01
 -2.39720971e-01  8.81606245e-01  5.38527002e+00  2.19634046e+01
  8.08222414e+01  2.75730590e+02  9.03369041e+02  3.15567886e+03
  1.26348594e+04  4.12312717e+04  1.05259040e+05  2.30431877e+05
  4.56239178e+05  8.45185631e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6949876626311  E_coul = 198.70438434957825
cycle= 3 E= -507.990603313053  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00383771
diis-c [-3.27921303e-06  1.11489043e-04 -1.07649703e-01  1.10753821e+00]
  HOMO = -0.242867913223742  LUMO = 0.880862634950929
  mo_energy =
[-1.20326426e+02 -1.23808280e+01 -6.67787088e+00 -6.67787088e+00
 -6.67787088e+00 -1.17943371e+00 -2.42867913e-01 -2.42867913e-01
 -2.42867913e-01  8.80862635e-01  5.38114705e+00  2.19560655e+01
  8.08126283e+01  2.75719542e+02  9.03357091e+02  3.15566621e+03
  1.26348463e+04  4.12312584e+04  1.05259026e+05  2.30431864e+05
  4.56239165e+05  8.45185618e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.6797101476936  E_coul = 198.6891017847838
cycle= 4 E= -507.99060836291  delta_E= -5.05e-06  |g|= 0.000231  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017273
diis-c [-5.65177543e-10 -9.49777803e-06  6.85894412e-03 -9.70953252e-02
  1.09024588e+00]
  HOMO = -0.243014571307529  LUMO = 0.880818658787778
  mo_energy =
[-1.20326759e+02 -1.23811589e+01 -6.67819709e+00 -6.67819709e+00
 -6.67819709e+00 -1.17952258e+00 -2.43014571e-01 -2.43014571e-01
 -2.43014571e-01  8.80818659e-01  5.38094850e+00  2.19557708e+01
  8.08123026e+01  2.75719210e+02  9.03356758e+02  3.15566587e+03
  1.26348460e+04  4.12312581e+04  1.05259026e+05  2.30431863e+05
  4.56239165e+05  8.45185617e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.67900422322  E_coul = 198.68839584635842
cycle= 5 E= -507.990608376862  delta_E= -1.4e-08  |g|= 5.99e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.64078e-06
diis-c [-9.49289133e-13  6.10255063e-07 -5.62953974e-04  7.59143588e-03
 -9.14165474e-02  1.08438746e+00]
  HOMO = -0.243017300294172  LUMO = 0.88081788679417
  mo_energy =
[-1.20326765e+02 -1.23811642e+01 -6.67820243e+00 -6.67820243e+00
 -6.67820243e+00 -1.17952445e+00 -2.43017300e-01 -2.43017300e-01
 -2.43017300e-01  8.80817887e-01  5.38094476e+00  2.19557659e+01
  8.08122971e+01  2.75719205e+02  9.03356752e+02  3.15566587e+03
  1.26348460e+04  4.12312581e+04  1.05259026e+05  2.30431863e+05
  4.56239165e+05  8.45185617e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.678990422124  E_coul = 198.6883820452545
cycle= 6 E= -507.990608376869  delta_E= -7.9e-12  |g|= 9.26e-08  |ddm|= 1.82e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.678990422124  E_coul = 198.6883820452545
  HOMO = -0.243017343165051  LUMO = 0.880817862373541
  mo_energy =
[-1.20326765e+02 -1.23811643e+01 -6.67820252e+00 -6.67820252e+00
 -6.67820252e+00 -1.17952447e+00 -2.43017343e-01 -2.43017343e-01
 -2.43017343e-01  8.80817862e-01  5.38094469e+00  2.19557658e+01
  8.08122971e+01  2.75719204e+02  9.03356752e+02  3.15566587e+03
  1.26348460e+04  4.12312581e+04  1.05259026e+05  2.30431863e+05
  4.56239165e+05  8.45185617e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.6789902336204  E_coul = 198.68838185675116
Extra cycle  E= -507.990608376869  delta_E= 2.27e-13  |g|= 1.14e-08  |ddm|= 2.29e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912619.8028363856
E1 = -706.6789902336204  E_coul = 198.68838185675116
init E= -507.990608376869
    CPU time for initialize scf      5.61 sec, wall time      0.24 sec
  HOMO = -0.243017349315573  LUMO = 0.880817860191046
  mo_energy =
[-1.20326765e+02 -1.23811643e+01 -6.67820253e+00 -6.67820253e+00
 -6.67820253e+00 -1.17952447e+00 -2.43017349e-01 -2.43017349e-01
 -2.43017349e-01  8.80817860e-01  5.38094469e+00  2.19557658e+01
  8.08122970e+01  2.75719204e+02  9.03356752e+02  3.15566587e+03
  1.26348460e+04  4.12312581e+04  1.05259026e+05  2.30431863e+05
  4.56239165e+05  8.45185617e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.6789902026795  E_coul = 198.68838182581038
cycle= 1 E= -507.990608376869  delta_E= 1.14e-13  |g|= 1.59e-09  |ddm|= 3.09e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6789902026795  E_coul = 198.68838182581038
  HOMO = -0.243017350266261  LUMO = 0.880817859012543
  mo_energy =
[-1.20326765e+02 -1.23811643e+01 -6.67820253e+00 -6.67820253e+00
 -6.67820253e+00 -1.17952447e+00 -2.43017350e-01 -2.43017350e-01
 -2.43017350e-01  8.80817859e-01  5.38094468e+00  2.19557658e+01
  8.08122970e+01  2.75719204e+02  9.03356752e+02  3.15566587e+03
  1.26348460e+04  4.12312581e+04  1.05259026e+05  2.30431863e+05
  4.56239165e+05  8.45185617e+05  1.52835726e+06  2.85061774e+06
  5.80849615e+06]
E1 = -706.6789902004642  E_coul = 198.68838182359514
Extra cycle  E= -507.990608376869  delta_E= 5.68e-14  |g|= 1.23e-09  |ddm|= 2.66e-09
    CPU time for scf_cycle      6.13 sec, wall time      0.41 sec
exp = [2.29414831e-01 5.99338100e-01 1.78687389e+00 1.17616813e+05
 4.00342872e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230271e+03
 1.83757706e+04 1.44367032e+03 4.17385318e+02 1.47775729e+02
 5.84353636e+01 2.47261699e+01 8.93917117e+00 8.60454660e+00
 4.92791196e-01]
grad_E = [-6.20516014e-04  4.16808409e-04 -9.23848027e-05  6.04965981e-09
  1.68247115e-04  4.02990967e-11  1.73741313e-10  9.38371110e-10
  3.70733862e-09  1.54807751e-08  8.07620709e-08  5.09069930e-06
  1.97845399e-07 -3.80698261e-05 -9.81395384e-06  2.15382619e-05
 -7.19741629e-05  1.90406205e-06 -7.18744453e-05  1.79285214e-04
  1.19891766e-03]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228320431546       1
[INPUT] 0    0    [1    /1   ]  0.595104138793       1
[INPUT] 0    0    [1    /1   ]  1.76651532262        1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  3.98586262074        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174893        1
[INPUT] 0    0    [1    /1   ]  36754.701228         1
[INPUT] 0    0    [1    /1   ]  7302.30215826        1
[INPUT] 0    0    [1    /1   ]  18375.770588         1
[INPUT] 0    0    [1    /1   ]  1443.67444793        1
[INPUT] 0    0    [1    /1   ]  417.386406226        1
[INPUT] 0    0    [1    /1   ]  147.773702846        1
[INPUT] 0    0    [1    /1   ]  58.43978401          1
[INPUT] 0    0    [1    /1   ]  24.729292157         1
[INPUT] 0    0    [1    /1   ]  8.97351343027        1
[INPUT] 1    0    [1    /1   ]  8.60433003689        1
[INPUT] 1    0    [1    /1   ]  0.492759033622       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2283204315460801, 1.0]], [0, [0.5951041387931433, 1.0]], [0, [1.7665153226241634, 1.0]], [0, [117616.81286642379, 1.0]], [0, [3.9858626207392462, 1.0]], [0, [1176168.1426132992, 1.0]], [0, [588084.0699558969, 1.0]], [0, [294042.03091785545, 1.0]], [0, [147020.99130917265, 1.0]], [0, [73510.41748932147, 1.0]], [0, [36754.701228042715, 1.0]], [0, [7302.302158259524, 1.0]], [0, [18375.770587957304, 1.0]], [0, [1443.6744479264264, 1.0]], [0, [417.3864062261737, 1.0]], [0, [147.77370284632585, 1.0]], [0, [58.439784009991534, 1.0]], [0, [24.72929215701858, 1.0]], [0, [8.973513430267136, 1.0]], [1, [8.604330036892378, 1.0]], [1, [0.4927590336224734, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22832043]
bas 1, expnt(s) = [0.59510414]
bas 2, expnt(s) = [1.76651532]
bas 3, expnt(s) = [117616.81286642]
bas 4, expnt(s) = [3.98586262]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.0699559]
bas 7, expnt(s) = [294042.03091786]
bas 8, expnt(s) = [147020.99130917]
bas 9, expnt(s) = [73510.41748932]
bas 10, expnt(s) = [36754.70122804]
bas 11, expnt(s) = [7302.30215826]
bas 12, expnt(s) = [18375.77058796]
bas 13, expnt(s) = [1443.67444793]
bas 14, expnt(s) = [417.38640623]
bas 15, expnt(s) = [147.77370285]
bas 16, expnt(s) = [58.43978401]
bas 17, expnt(s) = [24.72929216]
bas 18, expnt(s) = [8.97351343]
bas 19, expnt(s) = [8.60433004]
bas 20, expnt(s) = [0.49275903]
CPU time:       863.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28320432e-01 8.34494746e-01 5.95104139e-01 1.71182653e+00
 1.76651532e+00 3.87126660e+00 1.17616813e+05 1.60460108e+04
 3.98586262e+00 7.12700016e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230216e+03 1.99576717e+03
 1.83757706e+04 3.98748621e+03 1.44367445e+03 5.91720992e+02
 4.17386406e+02 2.33302155e+02 1.47773703e+02 1.07081117e+02
 5.84397840e+01 5.34006417e+01 2.47292922e+01 2.80171392e+01
 8.97351343e+00 1.30989629e+01 8.60433004e+00 4.29913139e+01
 4.92759034e-01 1.20441911e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336075650364513
cond(S) = 912615.9641887685
E1 = -689.5976611153877  E_coul = 184.97227468371395
init E= -504.625386431674
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672155271127278  LUMO = 0.532467824872312
  mo_energy =
[-1.21709680e+02 -1.33862369e+01 -7.62354007e+00 -7.62354007e+00
 -7.62354007e+00 -1.65758125e+00 -6.72155271e-01 -6.72155271e-01
 -6.72155271e-01  5.32467825e-01  4.73800486e+00  2.09630100e+01
  7.95656863e+01  2.74361161e+02  9.01994330e+02  3.15438647e+03
  1.26336927e+04  4.12301781e+04  1.05257984e+05  2.30430847e+05
  4.56238165e+05  8.45184631e+05  1.52835629e+06  2.85061678e+06
  5.80849520e+06]
E1 = -707.7562286183797  E_coul = 199.78370896548836
cycle= 1 E= -507.972519652891  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.758651
diis-c [-0.57555081  1.        ]
  HOMO = -0.217596405655592  LUMO = 0.876998679795154
  mo_energy =
[-1.20199982e+02 -1.23046422e+01 -6.59389974e+00 -6.59389974e+00
 -6.59389974e+00 -1.16330684e+00 -2.17596406e-01 -2.17596406e-01
 -2.17596406e-01  8.76998680e-01  5.35496108e+00  2.19082903e+01
  8.08355585e+01  2.75813689e+02  9.03485969e+02  3.15581887e+03
  1.26350186e+04  4.12314369e+04  1.05259206e+05  2.30432044e+05
  4.56239346e+05  8.45185798e+05  1.52835744e+06  2.85061792e+06
  5.80849633e+06]
E1 = -706.8009194836045  E_coul = 198.81057618221442
cycle= 2 E= -507.99034330139  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350593
diis-c [-0.00122365 -0.00310414  1.00310414]
  HOMO = -0.23978757119181  LUMO = 0.873402442317033
  mo_energy =
[-1.20315041e+02 -1.23724818e+01 -6.66901401e+00 -6.66901401e+00
 -6.66901401e+00 -1.17758549e+00 -2.39787571e-01 -2.39787571e-01
 -2.39787571e-01  8.73402442e-01  5.32738880e+00  2.18514927e+01
  8.07517002e+01  2.75708888e+02  9.03365257e+02  3.15568379e+03
  1.26348733e+04  4.12312877e+04  1.05259055e+05  2.30431892e+05
  4.56239193e+05  8.45185646e+05  1.52835729e+06  2.85061777e+06
  5.80849618e+06]
E1 = -706.6923992661583  E_coul = 198.70179334718088
cycle= 3 E= -507.990605918977  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385949
diis-c [-3.29967233e-06  1.06319978e-04 -1.07988379e-01  1.10788206e+00]
  HOMO = -0.242938253991093  LUMO = 0.872667143872499
  mo_energy =
[-1.20326761e+02 -1.23810296e+01 -6.67804220e+00 -6.67804220e+00
 -6.67804220e+00 -1.17949475e+00 -2.42938254e-01 -2.42938254e-01
 -2.42938254e-01  8.72667144e-01  5.32328795e+00  2.18441523e+01
  8.07420797e+01  2.75697833e+02  9.03353302e+02  3.15567114e+03
  1.26348602e+04  4.12312744e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6770874195189  E_coul = 198.68647642496194
cycle= 4 E= -507.990610994557  delta_E= -5.08e-06  |g|= 0.000232  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173233
diis-c [-5.88197322e-10 -9.55961605e-06  6.87678847e-03 -9.70098024e-02
  1.09014257e+00]
  HOMO = -0.243084731414355  LUMO = 0.872623559583785
  mo_energy =
[-1.20327091e+02 -1.23813592e+01 -6.67836683e+00 -6.67836683e+00
 -6.67836683e+00 -1.17958354e+00 -2.43084731e-01 -2.43084731e-01
 -2.43084731e-01  8.72623560e-01  5.32309064e+00  2.18438588e+01
  8.07417558e+01  2.75697504e+02  9.03352971e+02  3.15567081e+03
  1.26348599e+04  4.12312741e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.676381283733  E_coul = 198.68577027510514
cycle= 5 E= -507.990611008628  delta_E= -1.41e-08  |g|= 6.15e-06  |ddm|= 0.000682
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71871e-06
diis-c [-9.78916967e-13  6.19155877e-07 -5.73448905e-04  7.70541275e-03
 -9.29291287e-02  1.08579655e+00]
  HOMO = -0.243087523643596  LUMO = 0.872622776627236
  mo_energy =
[-1.20327097e+02 -1.23813646e+01 -6.67837227e+00 -6.67837227e+00
 -6.67837227e+00 -1.17958546e+00 -2.43087524e-01 -2.43087524e-01
 -2.43087524e-01  8.72622777e-01  5.32308682e+00  2.18438538e+01
  8.07417502e+01  2.75697498e+02  9.03352965e+02  3.15567080e+03
  1.26348599e+04  4.12312741e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6763671218869  E_coul = 198.68575611325096
cycle= 6 E= -507.990611008636  delta_E= -8.07e-12  |g|= 9.06e-08  |ddm|= 1.88e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6763671218869  E_coul = 198.68575611325096
  HOMO = -0.243087566235145  LUMO = 0.872622750052652
  mo_energy =
[-1.20327098e+02 -1.23813646e+01 -6.67837236e+00 -6.67837236e+00
 -6.67837236e+00 -1.17958548e+00 -2.43087566e-01 -2.43087566e-01
 -2.43087566e-01  8.72622750e-01  5.32308676e+00  2.18438538e+01
  8.07417501e+01  2.75697498e+02  9.03352965e+02  3.15567080e+03
  1.26348599e+04  4.12312741e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6763669385433  E_coul = 198.68575592990723
Extra cycle  E= -507.990611008636  delta_E= -1.14e-13  |g|= 1.16e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.28320432e-01 5.95104139e-01 1.76651532e+00 1.17616813e+05
 3.98586262e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230216e+03
 1.83757706e+04 1.44367445e+03 4.17386406e+02 1.47773703e+02
 5.84397840e+01 2.47292922e+01 8.97351343e+00 8.60433004e+00
 4.92759034e-01]
E = -507.99061100863605
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228320431546       1
[INPUT] 0    0    [1    /1   ]  0.595104138793       1
[INPUT] 0    0    [1    /1   ]  1.76651532262        1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  3.98586262074        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174893        1
[INPUT] 0    0    [1    /1   ]  36754.701228         1
[INPUT] 0    0    [1    /1   ]  7302.30215826        1
[INPUT] 0    0    [1    /1   ]  18375.770588         1
[INPUT] 0    0    [1    /1   ]  1443.67444793        1
[INPUT] 0    0    [1    /1   ]  417.386406226        1
[INPUT] 0    0    [1    /1   ]  147.773702846        1
[INPUT] 0    0    [1    /1   ]  58.43978401          1
[INPUT] 0    0    [1    /1   ]  24.729292157         1
[INPUT] 0    0    [1    /1   ]  8.97351343027        1
[INPUT] 1    0    [1    /1   ]  8.60433003689        1
[INPUT] 1    0    [1    /1   ]  0.492759033622       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2283204315460801, 1.0]], [0, [0.5951041387931433, 1.0]], [0, [1.7665153226241634, 1.0]], [0, [117616.81286642379, 1.0]], [0, [3.9858626207392462, 1.0]], [0, [1176168.1426132992, 1.0]], [0, [588084.0699558969, 1.0]], [0, [294042.03091785545, 1.0]], [0, [147020.99130917265, 1.0]], [0, [73510.41748932147, 1.0]], [0, [36754.701228042715, 1.0]], [0, [7302.302158259524, 1.0]], [0, [18375.770587957304, 1.0]], [0, [1443.6744479264264, 1.0]], [0, [417.3864062261737, 1.0]], [0, [147.77370284632585, 1.0]], [0, [58.439784009991534, 1.0]], [0, [24.72929215701858, 1.0]], [0, [8.973513430267136, 1.0]], [1, [8.604330036892378, 1.0]], [1, [0.4927590336224734, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22832043]
bas 1, expnt(s) = [0.59510414]
bas 2, expnt(s) = [1.76651532]
bas 3, expnt(s) = [117616.81286642]
bas 4, expnt(s) = [3.98586262]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.0699559]
bas 7, expnt(s) = [294042.03091786]
bas 8, expnt(s) = [147020.99130917]
bas 9, expnt(s) = [73510.41748932]
bas 10, expnt(s) = [36754.70122804]
bas 11, expnt(s) = [7302.30215826]
bas 12, expnt(s) = [18375.77058796]
bas 13, expnt(s) = [1443.67444793]
bas 14, expnt(s) = [417.38640623]
bas 15, expnt(s) = [147.77370285]
bas 16, expnt(s) = [58.43978401]
bas 17, expnt(s) = [24.72929216]
bas 18, expnt(s) = [8.97351343]
bas 19, expnt(s) = [8.60433004]
bas 20, expnt(s) = [0.49275903]
CPU time:       865.51
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28320432e-01 8.34494746e-01 5.95104139e-01 1.71182653e+00
 1.76651532e+00 3.87126660e+00 1.17616813e+05 1.60460108e+04
 3.98586262e+00 7.12700016e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230216e+03 1.99576717e+03
 1.83757706e+04 3.98748621e+03 1.44367445e+03 5.91720992e+02
 4.17386406e+02 2.33302155e+02 1.47773703e+02 1.07081117e+02
 5.84397840e+01 5.34006417e+01 2.47292922e+01 2.80171392e+01
 8.97351343e+00 1.30989629e+01 8.60433004e+00 4.29913139e+01
 4.92759034e-01 1.20441911e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336075650364513
cond(S) = 912615.9641887685
E1 = -689.5976611153877  E_coul = 184.97227468371395
init E= -504.625386431674
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672155271127278  LUMO = 0.532467824872312
  mo_energy =
[-1.21709680e+02 -1.33862369e+01 -7.62354007e+00 -7.62354007e+00
 -7.62354007e+00 -1.65758125e+00 -6.72155271e-01 -6.72155271e-01
 -6.72155271e-01  5.32467825e-01  4.73800486e+00  2.09630100e+01
  7.95656863e+01  2.74361161e+02  9.01994330e+02  3.15438647e+03
  1.26336927e+04  4.12301781e+04  1.05257984e+05  2.30430847e+05
  4.56238165e+05  8.45184631e+05  1.52835629e+06  2.85061678e+06
  5.80849520e+06]
E1 = -707.7562286183797  E_coul = 199.78370896548836
cycle= 1 E= -507.972519652891  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.758651
diis-c [-0.57555081  1.        ]
  HOMO = -0.217596405655592  LUMO = 0.876998679795154
  mo_energy =
[-1.20199982e+02 -1.23046422e+01 -6.59389974e+00 -6.59389974e+00
 -6.59389974e+00 -1.16330684e+00 -2.17596406e-01 -2.17596406e-01
 -2.17596406e-01  8.76998680e-01  5.35496108e+00  2.19082903e+01
  8.08355585e+01  2.75813689e+02  9.03485969e+02  3.15581887e+03
  1.26350186e+04  4.12314369e+04  1.05259206e+05  2.30432044e+05
  4.56239346e+05  8.45185798e+05  1.52835744e+06  2.85061792e+06
  5.80849633e+06]
E1 = -706.8009194836045  E_coul = 198.81057618221442
cycle= 2 E= -507.99034330139  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350593
diis-c [-0.00122365 -0.00310414  1.00310414]
  HOMO = -0.23978757119181  LUMO = 0.873402442317033
  mo_energy =
[-1.20315041e+02 -1.23724818e+01 -6.66901401e+00 -6.66901401e+00
 -6.66901401e+00 -1.17758549e+00 -2.39787571e-01 -2.39787571e-01
 -2.39787571e-01  8.73402442e-01  5.32738880e+00  2.18514927e+01
  8.07517002e+01  2.75708888e+02  9.03365257e+02  3.15568379e+03
  1.26348733e+04  4.12312877e+04  1.05259055e+05  2.30431892e+05
  4.56239193e+05  8.45185646e+05  1.52835729e+06  2.85061777e+06
  5.80849618e+06]
E1 = -706.6923992661583  E_coul = 198.70179334718088
cycle= 3 E= -507.990605918977  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385949
diis-c [-3.29967233e-06  1.06319978e-04 -1.07988379e-01  1.10788206e+00]
  HOMO = -0.242938253991093  LUMO = 0.872667143872499
  mo_energy =
[-1.20326761e+02 -1.23810296e+01 -6.67804220e+00 -6.67804220e+00
 -6.67804220e+00 -1.17949475e+00 -2.42938254e-01 -2.42938254e-01
 -2.42938254e-01  8.72667144e-01  5.32328795e+00  2.18441523e+01
  8.07420797e+01  2.75697833e+02  9.03353302e+02  3.15567114e+03
  1.26348602e+04  4.12312744e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6770874195189  E_coul = 198.68647642496194
cycle= 4 E= -507.990610994557  delta_E= -5.08e-06  |g|= 0.000232  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173233
diis-c [-5.88197322e-10 -9.55961605e-06  6.87678847e-03 -9.70098024e-02
  1.09014257e+00]
  HOMO = -0.243084731414355  LUMO = 0.872623559583785
  mo_energy =
[-1.20327091e+02 -1.23813592e+01 -6.67836683e+00 -6.67836683e+00
 -6.67836683e+00 -1.17958354e+00 -2.43084731e-01 -2.43084731e-01
 -2.43084731e-01  8.72623560e-01  5.32309064e+00  2.18438588e+01
  8.07417558e+01  2.75697504e+02  9.03352971e+02  3.15567081e+03
  1.26348599e+04  4.12312741e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.676381283733  E_coul = 198.68577027510514
cycle= 5 E= -507.990611008628  delta_E= -1.41e-08  |g|= 6.15e-06  |ddm|= 0.000682
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71871e-06
diis-c [-9.78916967e-13  6.19155877e-07 -5.73448905e-04  7.70541275e-03
 -9.29291287e-02  1.08579655e+00]
  HOMO = -0.243087523643596  LUMO = 0.872622776627236
  mo_energy =
[-1.20327097e+02 -1.23813646e+01 -6.67837227e+00 -6.67837227e+00
 -6.67837227e+00 -1.17958546e+00 -2.43087524e-01 -2.43087524e-01
 -2.43087524e-01  8.72622777e-01  5.32308682e+00  2.18438538e+01
  8.07417502e+01  2.75697498e+02  9.03352965e+02  3.15567080e+03
  1.26348599e+04  4.12312741e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6763671218869  E_coul = 198.68575611325096
cycle= 6 E= -507.990611008636  delta_E= -8.07e-12  |g|= 9.06e-08  |ddm|= 1.88e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6763671218869  E_coul = 198.68575611325096
  HOMO = -0.243087566235145  LUMO = 0.872622750052652
  mo_energy =
[-1.20327098e+02 -1.23813646e+01 -6.67837236e+00 -6.67837236e+00
 -6.67837236e+00 -1.17958548e+00 -2.43087566e-01 -2.43087566e-01
 -2.43087566e-01  8.72622750e-01  5.32308676e+00  2.18438538e+01
  8.07417501e+01  2.75697498e+02  9.03352965e+02  3.15567080e+03
  1.26348599e+04  4.12312741e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6763669385433  E_coul = 198.68575592990723
Extra cycle  E= -507.990611008636  delta_E= -1.14e-13  |g|= 1.16e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912615.9641887685
E1 = -706.6763669385433  E_coul = 198.68575592990723
init E= -507.990611008636
    CPU time for initialize scf      5.54 sec, wall time      0.23 sec
  HOMO = -0.243087572222838  LUMO = 0.872622747254536
  mo_energy =
[-1.20327098e+02 -1.23813647e+01 -6.67837237e+00 -6.67837237e+00
 -6.67837237e+00 -1.17958548e+00 -2.43087572e-01 -2.43087572e-01
 -2.43087572e-01  8.72622747e-01  5.32308675e+00  2.18438537e+01
  8.07417501e+01  2.75697498e+02  9.03352965e+02  3.15567080e+03
  1.26348599e+04  4.12312741e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6763669140927  E_coul = 198.68575590545643
cycle= 1 E= -507.990611008636  delta_E= -2.27e-13  |g|= 3.01e-09  |ddm|= 2.71e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6763669140927  E_coul = 198.68575590545643
  HOMO = -0.243087573010673  LUMO = 0.872622748549581
  mo_energy =
[-1.20327098e+02 -1.23813647e+01 -6.67837237e+00 -6.67837237e+00
 -6.67837237e+00 -1.17958548e+00 -2.43087573e-01 -2.43087573e-01
 -2.43087573e-01  8.72622749e-01  5.32308675e+00  2.18438537e+01
  8.07417501e+01  2.75697498e+02  9.03352965e+02  3.15567080e+03
  1.26348599e+04  4.12312741e+04  1.05259042e+05  2.30431879e+05
  4.56239180e+05  8.45185632e+05  1.52835728e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6763669051501  E_coul = 198.6857558965137
Extra cycle  E= -507.990611008636  delta_E= -1.14e-13  |g|= 1.79e-09  |ddm|= 8.18e-09
    CPU time for scf_cycle      6.05 sec, wall time      0.40 sec
exp = [2.28320432e-01 5.95104139e-01 1.76651532e+00 1.17616813e+05
 3.98586262e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230216e+03
 1.83757706e+04 1.44367445e+03 4.17386406e+02 1.47773703e+02
 5.84397840e+01 2.47292922e+01 8.97351343e+00 8.60433004e+00
 4.92759034e-01]
grad_E = [-1.75533617e-04  1.23732989e-04 -1.61311704e-05  6.04912843e-09
 -8.56945498e-06  4.02931415e-11  1.73723838e-10  9.38289714e-10
  3.70700937e-09  1.54793813e-08  8.07553696e-08  5.09028014e-06
  1.97823188e-07 -3.80521510e-05 -1.00349388e-05  2.32213728e-05
 -8.06416061e-05  1.43820045e-05  1.28722287e-05  3.09638487e-05
  2.21003870e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22824768614        1
[INPUT] 0    0    [1    /1   ]  0.594769293039       1
[INPUT] 0    0    [1    /1   ]  1.7695861437         1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  3.98759374584        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174894        1
[INPUT] 0    0    [1    /1   ]  36754.7012283        1
[INPUT] 0    0    [1    /1   ]  7302.30217667        1
[INPUT] 0    0    [1    /1   ]  18375.7705887        1
[INPUT] 0    0    [1    /1   ]  1443.67431238        1
[INPUT] 0    0    [1    /1   ]  417.386349188        1
[INPUT] 0    0    [1    /1   ]  147.773856651        1
[INPUT] 0    0    [1    /1   ]  58.4394157633        1
[INPUT] 0    0    [1    /1   ]  24.7292762358        1
[INPUT] 0    0    [1    /1   ]  8.97292207378        1
[INPUT] 1    0    [1    /1   ]  8.60430726773        1
[INPUT] 1    0    [1    /1   ]  0.49275539175        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22824768613976404, 1.0]], [0, [0.5947692930391072, 1.0]], [0, [1.7695861436965747, 1.0]], [0, [117616.81286644566, 1.0]], [0, [3.9875937458411284, 1.0]], [0, [1176168.1426132994, 1.0]], [0, [588084.0699558975, 1.0]], [0, [294042.0309178588, 1.0]], [0, [147020.99130918607, 1.0]], [0, [73510.41748937743, 1.0]], [0, [36754.70122833478, 1.0]], [0, [7302.302176667129, 1.0]], [0, [18375.77058867209, 1.0]], [0, [1443.6743123816295, 1.0]], [0, [417.3863491876908, 1.0]], [0, [147.77385665086555, 1.0]], [0, [58.43941576325633, 1.0]], [0, [24.72927623582546, 1.0]], [0, [8.97292207377747, 1.0]], [1, [8.604307267730066, 1.0]], [1, [0.4927553917501934, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22824769]
bas 1, expnt(s) = [0.59476929]
bas 2, expnt(s) = [1.76958614]
bas 3, expnt(s) = [117616.81286645]
bas 4, expnt(s) = [3.98759375]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.0699559]
bas 7, expnt(s) = [294042.03091786]
bas 8, expnt(s) = [147020.99130919]
bas 9, expnt(s) = [73510.41748938]
bas 10, expnt(s) = [36754.70122833]
bas 11, expnt(s) = [7302.30217667]
bas 12, expnt(s) = [18375.77058867]
bas 13, expnt(s) = [1443.67431238]
bas 14, expnt(s) = [417.38634919]
bas 15, expnt(s) = [147.77385665]
bas 16, expnt(s) = [58.43941576]
bas 17, expnt(s) = [24.72927624]
bas 18, expnt(s) = [8.97292207]
bas 19, expnt(s) = [8.60430727]
bas 20, expnt(s) = [0.49275539]
CPU time:       879.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28247686e-01 8.34295329e-01 5.94769293e-01 1.71110409e+00
 1.76958614e+00 3.87631272e+00 1.17616813e+05 1.60460108e+04
 3.98759375e+00 7.12932157e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230218e+03 1.99576717e+03
 1.83757706e+04 3.98748621e+03 1.44367431e+03 5.91720950e+02
 4.17386349e+02 2.33302131e+02 1.47773857e+02 1.07081200e+02
 5.84394158e+01 5.34003893e+01 2.47292762e+01 2.80171257e+01
 8.97292207e+00 1.30983155e+01 8.60430727e+00 4.29911717e+01
 4.92755392e-01 1.20440798e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608061025827
cond(S) = 912616.487301174
E1 = -689.5973890727186  E_coul = 184.97203081443902
init E= -504.62535825828
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672160492995127  LUMO = 0.532163085822028
  mo_energy =
[-1.21709713e+02 -1.33862567e+01 -7.62355612e+00 -7.62355612e+00
 -7.62355612e+00 -1.65758536e+00 -6.72160493e-01 -6.72160493e-01
 -6.72160493e-01  5.32163086e-01  4.74147445e+00  2.09763428e+01
  7.95824821e+01  2.74376303e+02  9.02007534e+02  3.15439801e+03
  1.26337025e+04  4.12301871e+04  1.05257993e+05  2.30430855e+05
  4.56238174e+05  8.45184639e+05  1.52835630e+06  2.85061679e+06
  5.80849520e+06]
E1 = -707.7559161881417  E_coul = 199.7833955269742
cycle= 1 E= -507.972520661167  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.758686
diis-c [-0.5756038  1.       ]
  HOMO = -0.217604709595179  LUMO = 0.876670353680461
  mo_energy =
[-1.20200022e+02 -1.23046664e+01 -6.59392026e+00 -6.59392026e+00
 -6.59392026e+00 -1.16331312e+00 -2.17604710e-01 -2.17604710e-01
 -2.17604710e-01  8.76670354e-01  5.35868038e+00  2.19217166e+01
  8.08523400e+01  2.75828819e+02  9.03499165e+02  3.15583040e+03
  1.26350285e+04  4.12314459e+04  1.05259215e+05  2.30432052e+05
  4.56239354e+05  8.45185806e+05  1.52835745e+06  2.85061793e+06
  5.80849634e+06]
E1 = -706.8006383959261  E_coul = 198.81029508093783
cycle= 2 E= -507.990343314988  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350483
diis-c [-0.00122289 -0.0031022   1.0031022 ]
  HOMO = -0.239794855838409  LUMO = 0.873074195743391
  mo_energy =
[-1.20315077e+02 -1.23725036e+01 -6.66903195e+00 -6.66903195e+00
 -6.66903195e+00 -1.17759125e+00 -2.39794856e-01 -2.39794856e-01
 -2.39794856e-01  8.73074196e-01  5.33109017e+00  2.18649105e+01
  8.07684843e+01  2.75724021e+02  9.03378456e+02  3.15569533e+03
  1.26348832e+04  4.12312967e+04  1.05259064e+05  2.30431901e+05
  4.56239202e+05  8.45185654e+05  1.52835730e+06  2.85061778e+06
  5.80849619e+06]
E1 = -706.6921120502241  E_coul = 198.70150608224202
cycle= 3 E= -507.990605967982  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385769
diis-c [-3.29895795e-06  1.06860423e-04 -1.07959172e-01  1.10785231e+00]
  HOMO = -0.242945735796826  LUMO = 0.872338823447441
  mo_energy =
[-1.20326798e+02 -1.23810517e+01 -6.67806050e+00 -6.67806050e+00
 -6.67806050e+00 -1.17950066e+00 -2.42945736e-01 -2.42945736e-01
 -2.42945736e-01  8.72338823e-01  5.32698648e+00  2.18575687e+01
  8.07588634e+01  2.75712966e+02  9.03366501e+02  3.15568268e+03
  1.26348701e+04  4.12312834e+04  1.05259051e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849618e+06]
E1 = -706.6767975731872  E_coul = 198.6861865273517
cycle= 4 E= -507.990611045835  delta_E= -5.08e-06  |g|= 0.000232  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173318
diis-c [-5.88812593e-10 -9.55829179e-06  6.87767540e-03 -9.70679959e-02
  1.09019988e+00]
  HOMO = -0.243092401058886  LUMO = 0.872295194348999
  mo_energy =
[-1.20327129e+02 -1.23813818e+01 -6.67838564e+00 -6.67838564e+00
 -6.67838564e+00 -1.17958957e+00 -2.43092401e-01 -2.43092401e-01
 -2.43092401e-01  8.72295194e-01  5.32678882e+00  2.18572748e+01
  8.07585390e+01  2.75712637e+02  9.03366170e+02  3.15568235e+03
  1.26348697e+04  4.12312831e+04  1.05259050e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6760904260949  E_coul = 198.68547936615664
cycle= 5 E= -507.990611059938  delta_E= -1.41e-08  |g|= 6.15e-06  |ddm|= 0.000682
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71864e-06
diis-c [-9.76696805e-13  6.18375030e-07 -5.73403267e-04  7.70908701e-03
 -9.29273200e-02  1.08579102e+00]
  HOMO = -0.243095194231353  LUMO = 0.872294410001271
  mo_energy =
[-1.20327135e+02 -1.23813871e+01 -6.67839108e+00 -6.67839108e+00
 -6.67839108e+00 -1.17959149e+00 -2.43095194e-01 -2.43095194e-01
 -2.43095194e-01  8.72294410e-01  5.32678499e+00  2.18572698e+01
  8.07585333e+01  2.75712631e+02  9.03366163e+02  3.15568234e+03
  1.26348697e+04  4.12312831e+04  1.05259050e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6760762602798  E_coul = 198.68546520033235
cycle= 6 E= -507.990611059947  delta_E= -9.21e-12  |g|= 9.14e-08  |ddm|= 1.88e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6760762602798  E_coul = 198.68546520033235
  HOMO = -0.243095236725932  LUMO = 0.872294382707773
  mo_energy =
[-1.20327135e+02 -1.23813872e+01 -6.67839117e+00 -6.67839117e+00
 -6.67839117e+00 -1.17959150e+00 -2.43095237e-01 -2.43095237e-01
 -2.43095237e-01  8.72294383e-01  5.32678493e+00  2.18572697e+01
  8.07585333e+01  2.75712631e+02  9.03366163e+02  3.15568234e+03
  1.26348697e+04  4.12312831e+04  1.05259050e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6760760769604  E_coul = 198.685465017013
Extra cycle  E= -507.990611059947  delta_E= 1.14e-13  |g|= 1.24e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.28247686e-01 5.94769293e-01 1.76958614e+00 1.17616813e+05
 3.98759375e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230218e+03
 1.83757706e+04 1.44367431e+03 4.17386349e+02 1.47773857e+02
 5.84394158e+01 2.47292762e+01 8.97292207e+00 8.60430727e+00
 4.92755392e-01]
E = -507.99061105994735
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22824768614        1
[INPUT] 0    0    [1    /1   ]  0.594769293039       1
[INPUT] 0    0    [1    /1   ]  1.7695861437         1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  3.98759374584        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174894        1
[INPUT] 0    0    [1    /1   ]  36754.7012283        1
[INPUT] 0    0    [1    /1   ]  7302.30217667        1
[INPUT] 0    0    [1    /1   ]  18375.7705887        1
[INPUT] 0    0    [1    /1   ]  1443.67431238        1
[INPUT] 0    0    [1    /1   ]  417.386349188        1
[INPUT] 0    0    [1    /1   ]  147.773856651        1
[INPUT] 0    0    [1    /1   ]  58.4394157633        1
[INPUT] 0    0    [1    /1   ]  24.7292762358        1
[INPUT] 0    0    [1    /1   ]  8.97292207378        1
[INPUT] 1    0    [1    /1   ]  8.60430726773        1
[INPUT] 1    0    [1    /1   ]  0.49275539175        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22824768613976404, 1.0]], [0, [0.5947692930391072, 1.0]], [0, [1.7695861436965747, 1.0]], [0, [117616.81286644566, 1.0]], [0, [3.9875937458411284, 1.0]], [0, [1176168.1426132994, 1.0]], [0, [588084.0699558975, 1.0]], [0, [294042.0309178588, 1.0]], [0, [147020.99130918607, 1.0]], [0, [73510.41748937743, 1.0]], [0, [36754.70122833478, 1.0]], [0, [7302.302176667129, 1.0]], [0, [18375.77058867209, 1.0]], [0, [1443.6743123816295, 1.0]], [0, [417.3863491876908, 1.0]], [0, [147.77385665086555, 1.0]], [0, [58.43941576325633, 1.0]], [0, [24.72927623582546, 1.0]], [0, [8.97292207377747, 1.0]], [1, [8.604307267730066, 1.0]], [1, [0.4927553917501934, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22824769]
bas 1, expnt(s) = [0.59476929]
bas 2, expnt(s) = [1.76958614]
bas 3, expnt(s) = [117616.81286645]
bas 4, expnt(s) = [3.98759375]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.0699559]
bas 7, expnt(s) = [294042.03091786]
bas 8, expnt(s) = [147020.99130919]
bas 9, expnt(s) = [73510.41748938]
bas 10, expnt(s) = [36754.70122833]
bas 11, expnt(s) = [7302.30217667]
bas 12, expnt(s) = [18375.77058867]
bas 13, expnt(s) = [1443.67431238]
bas 14, expnt(s) = [417.38634919]
bas 15, expnt(s) = [147.77385665]
bas 16, expnt(s) = [58.43941576]
bas 17, expnt(s) = [24.72927624]
bas 18, expnt(s) = [8.97292207]
bas 19, expnt(s) = [8.60430727]
bas 20, expnt(s) = [0.49275539]
CPU time:       881.73
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28247686e-01 8.34295329e-01 5.94769293e-01 1.71110409e+00
 1.76958614e+00 3.87631272e+00 1.17616813e+05 1.60460108e+04
 3.98759375e+00 7.12932157e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230218e+03 1.99576717e+03
 1.83757706e+04 3.98748621e+03 1.44367431e+03 5.91720950e+02
 4.17386349e+02 2.33302131e+02 1.47773857e+02 1.07081200e+02
 5.84394158e+01 5.34003893e+01 2.47292762e+01 2.80171257e+01
 8.97292207e+00 1.30983155e+01 8.60430727e+00 4.29911717e+01
 4.92755392e-01 1.20440798e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608061025827
cond(S) = 912616.487301174
E1 = -689.5973890727186  E_coul = 184.97203081443902
init E= -504.62535825828
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672160492995127  LUMO = 0.532163085822028
  mo_energy =
[-1.21709713e+02 -1.33862567e+01 -7.62355612e+00 -7.62355612e+00
 -7.62355612e+00 -1.65758536e+00 -6.72160493e-01 -6.72160493e-01
 -6.72160493e-01  5.32163086e-01  4.74147445e+00  2.09763428e+01
  7.95824821e+01  2.74376303e+02  9.02007534e+02  3.15439801e+03
  1.26337025e+04  4.12301871e+04  1.05257993e+05  2.30430855e+05
  4.56238174e+05  8.45184639e+05  1.52835630e+06  2.85061679e+06
  5.80849520e+06]
E1 = -707.7559161881417  E_coul = 199.7833955269742
cycle= 1 E= -507.972520661167  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.758686
diis-c [-0.5756038  1.       ]
  HOMO = -0.217604709595179  LUMO = 0.876670353680461
  mo_energy =
[-1.20200022e+02 -1.23046664e+01 -6.59392026e+00 -6.59392026e+00
 -6.59392026e+00 -1.16331312e+00 -2.17604710e-01 -2.17604710e-01
 -2.17604710e-01  8.76670354e-01  5.35868038e+00  2.19217166e+01
  8.08523400e+01  2.75828819e+02  9.03499165e+02  3.15583040e+03
  1.26350285e+04  4.12314459e+04  1.05259215e+05  2.30432052e+05
  4.56239354e+05  8.45185806e+05  1.52835745e+06  2.85061793e+06
  5.80849634e+06]
E1 = -706.8006383959261  E_coul = 198.81029508093783
cycle= 2 E= -507.990343314988  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350483
diis-c [-0.00122289 -0.0031022   1.0031022 ]
  HOMO = -0.239794855838409  LUMO = 0.873074195743391
  mo_energy =
[-1.20315077e+02 -1.23725036e+01 -6.66903195e+00 -6.66903195e+00
 -6.66903195e+00 -1.17759125e+00 -2.39794856e-01 -2.39794856e-01
 -2.39794856e-01  8.73074196e-01  5.33109017e+00  2.18649105e+01
  8.07684843e+01  2.75724021e+02  9.03378456e+02  3.15569533e+03
  1.26348832e+04  4.12312967e+04  1.05259064e+05  2.30431901e+05
  4.56239202e+05  8.45185654e+05  1.52835730e+06  2.85061778e+06
  5.80849619e+06]
E1 = -706.6921120502241  E_coul = 198.70150608224202
cycle= 3 E= -507.990605967982  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385769
diis-c [-3.29895795e-06  1.06860423e-04 -1.07959172e-01  1.10785231e+00]
  HOMO = -0.242945735796826  LUMO = 0.872338823447441
  mo_energy =
[-1.20326798e+02 -1.23810517e+01 -6.67806050e+00 -6.67806050e+00
 -6.67806050e+00 -1.17950066e+00 -2.42945736e-01 -2.42945736e-01
 -2.42945736e-01  8.72338823e-01  5.32698648e+00  2.18575687e+01
  8.07588634e+01  2.75712966e+02  9.03366501e+02  3.15568268e+03
  1.26348701e+04  4.12312834e+04  1.05259051e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849618e+06]
E1 = -706.6767975731872  E_coul = 198.6861865273517
cycle= 4 E= -507.990611045835  delta_E= -5.08e-06  |g|= 0.000232  |ddm|= 0.0105
    CPU time for cycle= 4      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.000173318
diis-c [-5.88812593e-10 -9.55829179e-06  6.87767540e-03 -9.70679959e-02
  1.09019988e+00]
  HOMO = -0.243092401058886  LUMO = 0.872295194348999
  mo_energy =
[-1.20327129e+02 -1.23813818e+01 -6.67838564e+00 -6.67838564e+00
 -6.67838564e+00 -1.17958957e+00 -2.43092401e-01 -2.43092401e-01
 -2.43092401e-01  8.72295194e-01  5.32678882e+00  2.18572748e+01
  8.07585390e+01  2.75712637e+02  9.03366170e+02  3.15568235e+03
  1.26348697e+04  4.12312831e+04  1.05259050e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6760904260949  E_coul = 198.68547936615664
cycle= 5 E= -507.990611059938  delta_E= -1.41e-08  |g|= 6.15e-06  |ddm|= 0.000682
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=2.71864e-06
diis-c [-9.76696805e-13  6.18375030e-07 -5.73403267e-04  7.70908701e-03
 -9.29273200e-02  1.08579102e+00]
  HOMO = -0.243095194231353  LUMO = 0.872294410001271
  mo_energy =
[-1.20327135e+02 -1.23813871e+01 -6.67839108e+00 -6.67839108e+00
 -6.67839108e+00 -1.17959149e+00 -2.43095194e-01 -2.43095194e-01
 -2.43095194e-01  8.72294410e-01  5.32678499e+00  2.18572698e+01
  8.07585333e+01  2.75712631e+02  9.03366163e+02  3.15568234e+03
  1.26348697e+04  4.12312831e+04  1.05259050e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6760762602798  E_coul = 198.68546520033235
cycle= 6 E= -507.990611059947  delta_E= -9.21e-12  |g|= 9.14e-08  |ddm|= 1.88e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6760762602798  E_coul = 198.68546520033235
  HOMO = -0.243095236725932  LUMO = 0.872294382707773
  mo_energy =
[-1.20327135e+02 -1.23813872e+01 -6.67839117e+00 -6.67839117e+00
 -6.67839117e+00 -1.17959150e+00 -2.43095237e-01 -2.43095237e-01
 -2.43095237e-01  8.72294383e-01  5.32678493e+00  2.18572697e+01
  8.07585333e+01  2.75712631e+02  9.03366163e+02  3.15568234e+03
  1.26348697e+04  4.12312831e+04  1.05259050e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6760760769604  E_coul = 198.685465017013
Extra cycle  E= -507.990611059947  delta_E= 1.14e-13  |g|= 1.24e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912616.487301174
E1 = -706.6760760769604  E_coul = 198.685465017013
init E= -507.990611059947
    CPU time for initialize scf      5.81 sec, wall time      0.25 sec
  HOMO = -0.243095242703673  LUMO = 0.872294381943991
  mo_energy =
[-1.20327135e+02 -1.23813872e+01 -6.67839118e+00 -6.67839118e+00
 -6.67839118e+00 -1.17959151e+00 -2.43095243e-01 -2.43095243e-01
 -2.43095243e-01  8.72294382e-01  5.32678492e+00  2.18572697e+01
  8.07585332e+01  2.75712631e+02  9.03366163e+02  3.15568234e+03
  1.26348697e+04  4.12312831e+04  1.05259050e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6760760473253  E_coul = 198.68546498737783
cycle= 1 E= -507.990611059947  delta_E= -1.14e-13  |g|= 2.69e-09  |ddm|= 3.06e-08
    CPU time for cycle= 1      0.34 sec, wall time      0.03 sec
E1 = -706.6760760473253  E_coul = 198.68546498737783
  HOMO = -0.243095243634607  LUMO = 0.872294382152051
  mo_energy =
[-1.20327135e+02 -1.23813872e+01 -6.67839118e+00 -6.67839118e+00
 -6.67839118e+00 -1.17959151e+00 -2.43095244e-01 -2.43095244e-01
 -2.43095244e-01  8.72294382e-01  5.32678492e+00  2.18572697e+01
  8.07585332e+01  2.75712631e+02  9.03366163e+02  3.15568234e+03
  1.26348697e+04  4.12312831e+04  1.05259050e+05  2.30431887e+05
  4.56239188e+05  8.45185640e+05  1.52835729e+06  2.85061776e+06
  5.80849617e+06]
E1 = -706.6760760439344  E_coul = 198.68546498398692
Extra cycle  E= -507.990611059947  delta_E=    0  |g|= 2.74e-09  |ddm|= 4.01e-09
    CPU time for scf_cycle      6.30 sec, wall time      0.42 sec
exp = [2.28247686e-01 5.94769293e-01 1.76958614e+00 1.17616813e+05
 3.98759375e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230218e+03
 1.83757706e+04 1.44367431e+03 4.17386349e+02 1.47773857e+02
 5.84394158e+01 2.47292762e+01 8.97292207e+00 8.60430727e+00
 4.92755392e-01]
grad_E = [-9.98883525e-05  7.41085292e-05 -1.58868536e-05  6.04909227e-09
 -2.85843271e-06  4.02927324e-11  1.73722652e-10  9.38284163e-10
  3.70698698e-09  1.54792866e-08  8.07549114e-08  5.09025006e-06
  1.97821702e-07 -3.80508186e-05 -1.00439044e-05  2.32297510e-05
 -8.04717550e-05  1.40540548e-05  1.03382351e-05  1.53467495e-05
  1.04770862e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22819148394        1
[INPUT] 0    0    [1    /1   ]  0.594425992028       1
[INPUT] 0    0    [1    /1   ]  1.77772532627        1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  3.99365349872        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174892        1
[INPUT] 0    0    [1    /1   ]  36754.7012275        1
[INPUT] 0    0    [1    /1   ]  7302.3021254         1
[INPUT] 0    0    [1    /1   ]  18375.7705867        1
[INPUT] 0    0    [1    /1   ]  1443.67470306        1
[INPUT] 0    0    [1    /1   ]  417.38636596         1
[INPUT] 0    0    [1    /1   ]  147.774020782        1
[INPUT] 0    0    [1    /1   ]  58.4389166888        1
[INPUT] 0    0    [1    /1   ]  24.7298785161        1
[INPUT] 0    0    [1    /1   ]  8.97727169697        1
[INPUT] 1    0    [1    /1   ]  8.60426899958        1
[INPUT] 1    0    [1    /1   ]  0.492749847848       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22819148394019778, 1.0]], [0, [0.5944259920278729, 1.0]], [0, [1.7777253262680563, 1.0]], [0, [117616.81286638472, 1.0]], [0, [3.99365349871909, 1.0]], [0, [1176168.142613299, 1.0]], [0, [588084.0699558958, 1.0]], [0, [294042.0309178494, 1.0]], [0, [147020.99130914873, 1.0]], [0, [73510.41748922147, 1.0]], [0, [36754.701227521386, 1.0]], [0, [7302.302125396541, 1.0]], [0, [18375.770586676517, 1.0]], [0, [1443.6747030627062, 1.0]], [0, [417.3863659599566, 1.0]], [0, [147.77402078182678, 1.0]], [0, [58.43891668875963, 1.0]], [0, [24.72987851610929, 1.0]], [0, [8.977271696969497, 1.0]], [1, [8.60426899957737, 1.0]], [1, [0.4927498478483776, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22819148]
bas 1, expnt(s) = [0.59442599]
bas 2, expnt(s) = [1.77772533]
bas 3, expnt(s) = [117616.81286638]
bas 4, expnt(s) = [3.9936535]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.0699559]
bas 7, expnt(s) = [294042.03091785]
bas 8, expnt(s) = [147020.99130915]
bas 9, expnt(s) = [73510.41748922]
bas 10, expnt(s) = [36754.70122752]
bas 11, expnt(s) = [7302.3021254]
bas 12, expnt(s) = [18375.77058668]
bas 13, expnt(s) = [1443.67470306]
bas 14, expnt(s) = [417.38636596]
bas 15, expnt(s) = [147.77402078]
bas 16, expnt(s) = [58.43891669]
bas 17, expnt(s) = [24.72987852]
bas 18, expnt(s) = [8.9772717]
bas 19, expnt(s) = [8.604269]
bas 20, expnt(s) = [0.49274985]
CPU time:       896.53
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28191484e-01 8.34141250e-01 5.94425992e-01 1.71036329e+00
 1.77772533e+00 3.88967682e+00 1.17616813e+05 1.60460108e+04
 3.99365350e+00 7.13744559e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230213e+03 1.99576716e+03
 1.83757706e+04 3.98748621e+03 1.44367470e+03 5.91721070e+02
 4.17386366e+02 2.33302138e+02 1.47774021e+02 1.07081289e+02
 5.84389167e+01 5.34000473e+01 2.47298785e+01 2.80176375e+01
 8.97727170e+00 1.31030772e+01 8.60426900e+00 4.29909327e+01
 4.92749848e-01 1.20439104e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608790580493
cond(S) = 912618.7500119196
E1 = -689.5969593183753  E_coul = 184.97163476597456
init E= -504.625324552401
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672168695028534  LUMO = 0.532118534635696
  mo_energy =
[-1.21709768e+02 -1.33862891e+01 -7.62358238e+00 -7.62358238e+00
 -7.62358238e+00 -1.65759143e+00 -6.72168695e-01 -6.72168695e-01
 -6.72168695e-01  5.32118535e-01  4.75402244e+00  2.10239403e+01
  7.96557204e+01  2.74452059e+02  9.02077436e+02  3.15446129e+03
  1.26337591e+04  4.12302398e+04  1.05258044e+05  2.30430904e+05
  4.56238222e+05  8.45184687e+05  1.52835634e+06  2.85061683e+06
  5.80849525e+06]
E1 = -707.7554056469277  E_coul = 199.78288309318265
cycle= 1 E= -507.972522553745  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.758783
diis-c [-0.57575177  1.        ]
  HOMO = -0.217617706029625  LUMO = 0.876708757053393
  mo_energy =
[-1.20200088e+02 -1.23047063e+01 -6.59395424e+00 -6.59395424e+00
 -6.59395424e+00 -1.16332278e+00 -2.17617706e-01 -2.17617706e-01
 -2.17617706e-01  8.76708757e-01  5.37199883e+00  2.19697074e+01
  8.09255819e+01  2.75904547e+02  9.03569051e+02  3.15589367e+03
  1.26350851e+04  4.12314986e+04  1.05259265e+05  2.30432102e+05
  4.56239402e+05  8.45185854e+05  1.52835750e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.8001932757713  E_coul = 198.80984995052088
cycle= 2 E= -507.99034332525  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350173
diis-c [-0.00122075 -0.0030936   1.0030936 ]
  HOMO = -0.239805661226311  LUMO = 0.873107365000618
  mo_energy =
[-1.20315135e+02 -1.23725380e+01 -6.66906019e+00 -6.66906019e+00
 -6.66906019e+00 -1.17759968e+00 -2.39805661e-01 -2.39805661e-01
 -2.39805661e-01  8.73107365e-01  5.34434867e+00  2.19128671e+01
  8.08417278e+01  2.75799757e+02  9.03448351e+02  3.15575861e+03
  1.26349398e+04  4.12313494e+04  1.05259115e+05  2.30431950e+05
  4.56239250e+05  8.45185701e+05  1.52835735e+06  2.85061782e+06
  5.80849623e+06]
E1 = -706.6916620504874  E_coul = 198.70105603479095
cycle= 3 E= -507.990606015696  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385219
diis-c [-3.29588227e-06  1.08350006e-04 -1.07864785e-01  1.10775644e+00]
  HOMO = -0.242956607616435  LUMO = 0.872371079997659
  mo_energy =
[-1.20326856e+02 -1.23810863e+01 -6.67808889e+00 -6.67808889e+00
 -6.67808889e+00 -1.17950917e+00 -2.42956608e-01 -2.42956608e-01
 -2.42956608e-01  8.72371080e-01  5.34023664e+00  2.19055213e+01
  8.08321064e+01  2.75788703e+02  9.03436395e+02  3.15574596e+03
  1.26349267e+04  4.12313361e+04  1.05259101e+05  2.30431937e+05
  4.56239236e+05  8.45185688e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.676345150283  E_coul = 198.68573405424854
cycle= 4 E= -507.990611096035  delta_E= -5.08e-06  |g|= 0.000232  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173462
diis-c [-5.88208744e-10 -9.55334038e-06  6.87815563e-03 -9.72007533e-02
  1.09033215e+00]
  HOMO = -0.243103689284424  LUMO = 0.872327320445185
  mo_energy =
[-1.20327189e+02 -1.23814175e+01 -6.67841525e+00 -6.67841525e+00
 -6.67841525e+00 -1.17959833e+00 -2.43103689e-01 -2.43103689e-01
 -2.43103689e-01  8.72327320e-01  5.34003809e+00  2.19052263e+01
  8.08317807e+01  2.75788371e+02  9.03436062e+02  3.15574563e+03
  1.26349263e+04  4.12313358e+04  1.05259101e+05  2.30431936e+05
  4.56239236e+05  8.45185687e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.6756358625084  E_coul = 198.68502475231128
cycle= 5 E= -507.990611110197  delta_E= -1.42e-08  |g|= 6.13e-06  |ddm|= 0.000682
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71342e-06
diis-c [-9.75855176e-13  6.18090807e-07 -5.71978506e-04  7.69989065e-03
 -9.27125456e-02  1.08558402e+00]
  HOMO = -0.24310647934095  LUMO = 0.872326537563706
  mo_energy =
[-1.20327195e+02 -1.23814229e+01 -6.67842070e+00 -6.67842070e+00
 -6.67842070e+00 -1.17960025e+00 -2.43106479e-01 -2.43106479e-01
 -2.43106479e-01  8.72326538e-01  5.34003427e+00  2.19052213e+01
  8.08317751e+01  2.75788365e+02  9.03436055e+02  3.15574562e+03
  1.26349263e+04  4.12313358e+04  1.05259101e+05  2.30431936e+05
  4.56239236e+05  8.45185687e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.6756217119533  E_coul = 198.6850106017484
cycle= 6 E= -507.990611110205  delta_E= -7.79e-12  |g|= 9.15e-08  |ddm|= 1.87e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6756217119533  E_coul = 198.6850106017484
  HOMO = -0.243106521772746  LUMO = 0.872326512287187
  mo_energy =
[-1.20327195e+02 -1.23814230e+01 -6.67842078e+00 -6.67842078e+00
 -6.67842078e+00 -1.17960026e+00 -2.43106522e-01 -2.43106522e-01
 -2.43106522e-01  8.72326512e-01  5.34003420e+00  2.19052212e+01
  8.08317750e+01  2.75788365e+02  9.03436055e+02  3.15574562e+03
  1.26349263e+04  4.12313358e+04  1.05259101e+05  2.30431936e+05
  4.56239236e+05  8.45185687e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.6756215244809  E_coul = 198.68501041427558
Extra cycle  E= -507.990611110205  delta_E= -3.98e-13  |g|= 1.13e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.28191484e-01 5.94425992e-01 1.77772533e+00 1.17616813e+05
 3.99365350e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230213e+03
 1.83757706e+04 1.44367470e+03 4.17386366e+02 1.47774021e+02
 5.84389167e+01 2.47298785e+01 8.97727170e+00 8.60426900e+00
 4.92749848e-01]
E = -507.99061111020535
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:32:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22819148394        1
[INPUT] 0    0    [1    /1   ]  0.594425992028       1
[INPUT] 0    0    [1    /1   ]  1.77772532627        1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  3.99365349872        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174892        1
[INPUT] 0    0    [1    /1   ]  36754.7012275        1
[INPUT] 0    0    [1    /1   ]  7302.3021254         1
[INPUT] 0    0    [1    /1   ]  18375.7705867        1
[INPUT] 0    0    [1    /1   ]  1443.67470306        1
[INPUT] 0    0    [1    /1   ]  417.38636596         1
[INPUT] 0    0    [1    /1   ]  147.774020782        1
[INPUT] 0    0    [1    /1   ]  58.4389166888        1
[INPUT] 0    0    [1    /1   ]  24.7298785161        1
[INPUT] 0    0    [1    /1   ]  8.97727169697        1
[INPUT] 1    0    [1    /1   ]  8.60426899958        1
[INPUT] 1    0    [1    /1   ]  0.492749847848       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22819148394019778, 1.0]], [0, [0.5944259920278729, 1.0]], [0, [1.7777253262680563, 1.0]], [0, [117616.81286638472, 1.0]], [0, [3.99365349871909, 1.0]], [0, [1176168.142613299, 1.0]], [0, [588084.0699558958, 1.0]], [0, [294042.0309178494, 1.0]], [0, [147020.99130914873, 1.0]], [0, [73510.41748922147, 1.0]], [0, [36754.701227521386, 1.0]], [0, [7302.302125396541, 1.0]], [0, [18375.770586676517, 1.0]], [0, [1443.6747030627062, 1.0]], [0, [417.3863659599566, 1.0]], [0, [147.77402078182678, 1.0]], [0, [58.43891668875963, 1.0]], [0, [24.72987851610929, 1.0]], [0, [8.977271696969497, 1.0]], [1, [8.60426899957737, 1.0]], [1, [0.4927498478483776, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22819148]
bas 1, expnt(s) = [0.59442599]
bas 2, expnt(s) = [1.77772533]
bas 3, expnt(s) = [117616.81286638]
bas 4, expnt(s) = [3.9936535]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.0699559]
bas 7, expnt(s) = [294042.03091785]
bas 8, expnt(s) = [147020.99130915]
bas 9, expnt(s) = [73510.41748922]
bas 10, expnt(s) = [36754.70122752]
bas 11, expnt(s) = [7302.3021254]
bas 12, expnt(s) = [18375.77058668]
bas 13, expnt(s) = [1443.67470306]
bas 14, expnt(s) = [417.38636596]
bas 15, expnt(s) = [147.77402078]
bas 16, expnt(s) = [58.43891669]
bas 17, expnt(s) = [24.72987852]
bas 18, expnt(s) = [8.9772717]
bas 19, expnt(s) = [8.604269]
bas 20, expnt(s) = [0.49274985]
CPU time:       898.37
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28191484e-01 8.34141250e-01 5.94425992e-01 1.71036329e+00
 1.77772533e+00 3.88967682e+00 1.17616813e+05 1.60460108e+04
 3.99365350e+00 7.13744559e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230213e+03 1.99576716e+03
 1.83757706e+04 3.98748621e+03 1.44367470e+03 5.91721070e+02
 4.17386366e+02 2.33302138e+02 1.47774021e+02 1.07081289e+02
 5.84389167e+01 5.34000473e+01 2.47298785e+01 2.80176375e+01
 8.97727170e+00 1.31030772e+01 8.60426900e+00 4.29909327e+01
 4.92749848e-01 1.20439104e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608790580493
cond(S) = 912618.7500119196
E1 = -689.5969593183753  E_coul = 184.97163476597456
init E= -504.625324552401
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672168695028534  LUMO = 0.532118534635696
  mo_energy =
[-1.21709768e+02 -1.33862891e+01 -7.62358238e+00 -7.62358238e+00
 -7.62358238e+00 -1.65759143e+00 -6.72168695e-01 -6.72168695e-01
 -6.72168695e-01  5.32118535e-01  4.75402244e+00  2.10239403e+01
  7.96557204e+01  2.74452059e+02  9.02077436e+02  3.15446129e+03
  1.26337591e+04  4.12302398e+04  1.05258044e+05  2.30430904e+05
  4.56238222e+05  8.45184687e+05  1.52835634e+06  2.85061683e+06
  5.80849525e+06]
E1 = -707.7554056469277  E_coul = 199.78288309318265
cycle= 1 E= -507.972522553745  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.758783
diis-c [-0.57575177  1.        ]
  HOMO = -0.217617706029625  LUMO = 0.876708757053393
  mo_energy =
[-1.20200088e+02 -1.23047063e+01 -6.59395424e+00 -6.59395424e+00
 -6.59395424e+00 -1.16332278e+00 -2.17617706e-01 -2.17617706e-01
 -2.17617706e-01  8.76708757e-01  5.37199883e+00  2.19697074e+01
  8.09255819e+01  2.75904547e+02  9.03569051e+02  3.15589367e+03
  1.26350851e+04  4.12314986e+04  1.05259265e+05  2.30432102e+05
  4.56239402e+05  8.45185854e+05  1.52835750e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.8001932757713  E_coul = 198.80984995052088
cycle= 2 E= -507.99034332525  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350173
diis-c [-0.00122075 -0.0030936   1.0030936 ]
  HOMO = -0.239805661226311  LUMO = 0.873107365000618
  mo_energy =
[-1.20315135e+02 -1.23725380e+01 -6.66906019e+00 -6.66906019e+00
 -6.66906019e+00 -1.17759968e+00 -2.39805661e-01 -2.39805661e-01
 -2.39805661e-01  8.73107365e-01  5.34434867e+00  2.19128671e+01
  8.08417278e+01  2.75799757e+02  9.03448351e+02  3.15575861e+03
  1.26349398e+04  4.12313494e+04  1.05259115e+05  2.30431950e+05
  4.56239250e+05  8.45185701e+05  1.52835735e+06  2.85061782e+06
  5.80849623e+06]
E1 = -706.6916620504874  E_coul = 198.70105603479095
cycle= 3 E= -507.990606015696  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385219
diis-c [-3.29588227e-06  1.08350006e-04 -1.07864785e-01  1.10775644e+00]
  HOMO = -0.242956607616435  LUMO = 0.872371079997659
  mo_energy =
[-1.20326856e+02 -1.23810863e+01 -6.67808889e+00 -6.67808889e+00
 -6.67808889e+00 -1.17950917e+00 -2.42956608e-01 -2.42956608e-01
 -2.42956608e-01  8.72371080e-01  5.34023664e+00  2.19055213e+01
  8.08321064e+01  2.75788703e+02  9.03436395e+02  3.15574596e+03
  1.26349267e+04  4.12313361e+04  1.05259101e+05  2.30431937e+05
  4.56239236e+05  8.45185688e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.676345150283  E_coul = 198.68573405424854
cycle= 4 E= -507.990611096035  delta_E= -5.08e-06  |g|= 0.000232  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173462
diis-c [-5.88208744e-10 -9.55334038e-06  6.87815563e-03 -9.72007533e-02
  1.09033215e+00]
  HOMO = -0.243103689284424  LUMO = 0.872327320445185
  mo_energy =
[-1.20327189e+02 -1.23814175e+01 -6.67841525e+00 -6.67841525e+00
 -6.67841525e+00 -1.17959833e+00 -2.43103689e-01 -2.43103689e-01
 -2.43103689e-01  8.72327320e-01  5.34003809e+00  2.19052263e+01
  8.08317807e+01  2.75788371e+02  9.03436062e+02  3.15574563e+03
  1.26349263e+04  4.12313358e+04  1.05259101e+05  2.30431936e+05
  4.56239236e+05  8.45185687e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.6756358625084  E_coul = 198.68502475231128
cycle= 5 E= -507.990611110197  delta_E= -1.42e-08  |g|= 6.13e-06  |ddm|= 0.000682
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71342e-06
diis-c [-9.75855176e-13  6.18090807e-07 -5.71978506e-04  7.69989065e-03
 -9.27125456e-02  1.08558402e+00]
  HOMO = -0.24310647934095  LUMO = 0.872326537563706
  mo_energy =
[-1.20327195e+02 -1.23814229e+01 -6.67842070e+00 -6.67842070e+00
 -6.67842070e+00 -1.17960025e+00 -2.43106479e-01 -2.43106479e-01
 -2.43106479e-01  8.72326538e-01  5.34003427e+00  2.19052213e+01
  8.08317751e+01  2.75788365e+02  9.03436055e+02  3.15574562e+03
  1.26349263e+04  4.12313358e+04  1.05259101e+05  2.30431936e+05
  4.56239236e+05  8.45185687e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.6756217119533  E_coul = 198.6850106017484
cycle= 6 E= -507.990611110205  delta_E= -7.79e-12  |g|= 9.15e-08  |ddm|= 1.87e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6756217119533  E_coul = 198.6850106017484
  HOMO = -0.243106521772746  LUMO = 0.872326512287187
  mo_energy =
[-1.20327195e+02 -1.23814230e+01 -6.67842078e+00 -6.67842078e+00
 -6.67842078e+00 -1.17960026e+00 -2.43106522e-01 -2.43106522e-01
 -2.43106522e-01  8.72326512e-01  5.34003420e+00  2.19052212e+01
  8.08317750e+01  2.75788365e+02  9.03436055e+02  3.15574562e+03
  1.26349263e+04  4.12313358e+04  1.05259101e+05  2.30431936e+05
  4.56239236e+05  8.45185687e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.6756215244809  E_coul = 198.68501041427558
Extra cycle  E= -507.990611110205  delta_E= -3.98e-13  |g|= 1.13e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912618.7500119196
E1 = -706.6756215244809  E_coul = 198.68501041427558
init E= -507.990611110205
    CPU time for initialize scf      5.68 sec, wall time      0.24 sec
  HOMO = -0.243106527873264  LUMO = 0.872326509565358
  mo_energy =
[-1.20327195e+02 -1.23814230e+01 -6.67842080e+00 -6.67842080e+00
 -6.67842080e+00 -1.17960027e+00 -2.43106528e-01 -2.43106528e-01
 -2.43106528e-01  8.72326510e-01  5.34003420e+00  2.19052212e+01
  8.08317750e+01  2.75788365e+02  9.03436055e+02  3.15574562e+03
  1.26349263e+04  4.12313358e+04  1.05259101e+05  2.30431936e+05
  4.56239236e+05  8.45185687e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.675621496272  E_coul = 198.685010386067
cycle= 1 E= -507.990611110205  delta_E= 3.41e-13  |g|= 2.17e-09  |ddm|= 2.9e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.675621496272  E_coul = 198.685010386067
  HOMO = -0.243106528752804  LUMO = 0.872326510108749
  mo_energy =
[-1.20327195e+02 -1.23814230e+01 -6.67842080e+00 -6.67842080e+00
 -6.67842080e+00 -1.17960027e+00 -2.43106529e-01 -2.43106529e-01
 -2.43106529e-01  8.72326510e-01  5.34003420e+00  2.19052212e+01
  8.08317750e+01  2.75788365e+02  9.03436055e+02  3.15574562e+03
  1.26349263e+04  4.12313358e+04  1.05259101e+05  2.30431936e+05
  4.56239236e+05  8.45185687e+05  1.52835733e+06  2.85061781e+06
  5.80849622e+06]
E1 = -706.6756214906244  E_coul = 198.68501038041933
Extra cycle  E= -507.990611110205  delta_E= -5.68e-14  |g|= 1.5e-09  |ddm|= 5.43e-09
    CPU time for scf_cycle      6.18 sec, wall time      0.41 sec
exp = [2.28191484e-01 5.94425992e-01 1.77772533e+00 1.17616813e+05
 3.99365350e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230213e+03
 1.83757706e+04 1.44367470e+03 4.17386366e+02 1.47774021e+02
 5.84389167e+01 2.47298785e+01 8.97727170e+00 8.60426900e+00
 4.92749848e-01]
grad_E = [ 2.20391333e-05 -3.89382263e-06 -1.11447238e-05  6.04897455e-09
  1.31540077e-07  4.02914066e-11  1.73718791e-10  9.38266104e-10
  3.70691407e-09  1.54789782e-08  8.07534226e-08  5.09015539e-06
  1.97816838e-07 -3.80470162e-05 -1.00739896e-05  2.33332408e-05
 -8.05473992e-05  1.38871040e-05  8.49224001e-06 -1.13702850e-05
 -6.71483730e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228194807982       1
[INPUT] 0    0    [1    /1   ]  0.594419842556       1
[INPUT] 0    0    [1    /1   ]  1.78039266536        1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  3.997263076          1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.417489         1
[INPUT] 0    0    [1    /1   ]  36754.7012261        1
[INPUT] 0    0    [1    /1   ]  7302.30203879        1
[INPUT] 0    0    [1    /1   ]  18375.7705833        1
[INPUT] 0    0    [1    /1   ]  1443.67535435        1
[INPUT] 0    0    [1    /1   ]  417.386488028        1
[INPUT] 0    0    [1    /1   ]  147.773902801        1
[INPUT] 0    0    [1    /1   ]  58.4391187057        1
[INPUT] 0    0    [1    /1   ]  24.7304848858        1
[INPUT] 0    0    [1    /1   ]  8.98241728458        1
[INPUT] 1    0    [1    /1   ]  8.60426405851        1
[INPUT] 1    0    [1    /1   ]  0.492749031004       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22819480798171737, 1.0]], [0, [0.5944198425563609, 1.0]], [0, [1.7803926653581619, 1.0]], [0, [117616.81286628179, 1.0]], [0, [3.9972630759973815, 1.0]], [0, [1176168.1426132983, 1.0]], [0, [588084.0699558929, 1.0]], [0, [294042.03091783344, 1.0]], [0, [147020.99130908566, 1.0]], [0, [73510.41748895806, 1.0]], [0, [36754.70122614738, 1.0]], [0, [7302.302038791879, 1.0]], [0, [18375.770583308768, 1.0]], [0, [1443.6753543523826, 1.0]], [0, [417.38648802792693, 1.0]], [0, [147.77390280091402, 1.0]], [0, [58.43911870566367, 1.0]], [0, [24.73048488584926, 1.0]], [0, [8.982417284575869, 1.0]], [1, [8.604264058513289, 1.0]], [1, [0.4927490310035522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22819481]
bas 1, expnt(s) = [0.59441984]
bas 2, expnt(s) = [1.78039267]
bas 3, expnt(s) = [117616.81286628]
bas 4, expnt(s) = [3.99726308]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.06995589]
bas 7, expnt(s) = [294042.03091783]
bas 8, expnt(s) = [147020.99130909]
bas 9, expnt(s) = [73510.41748896]
bas 10, expnt(s) = [36754.70122615]
bas 11, expnt(s) = [7302.30203879]
bas 12, expnt(s) = [18375.77058331]
bas 13, expnt(s) = [1443.67535435]
bas 14, expnt(s) = [417.38648803]
bas 15, expnt(s) = [147.7739028]
bas 16, expnt(s) = [58.43911871]
bas 17, expnt(s) = [24.73048489]
bas 18, expnt(s) = [8.98241728]
bas 19, expnt(s) = [8.60426406]
bas 20, expnt(s) = [0.49274903]
CPU time:       913.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28194808e-01 8.34150364e-01 5.94419843e-01 1.71035002e+00
 1.78039267e+00 3.89405312e+00 1.17616813e+05 1.60460108e+04
 3.99726308e+00 7.14228331e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230204e+03 1.99576714e+03
 1.83757706e+04 3.98748621e+03 1.44367535e+03 5.91721271e+02
 4.17386488e+02 2.33302189e+02 1.47773903e+02 1.07081225e+02
 5.84391187e+01 5.34001857e+01 2.47304849e+01 2.80181527e+01
 8.98241728e+00 1.31087097e+01 8.60426406e+00 4.29909018e+01
 4.92749031e-01 1.20438854e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336088853599158
cond(S) = 912620.0375557332
E1 = -689.5968853428402  E_coul = 184.97157213767147
init E= -504.625313205169
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672170261832662  LUMO = 0.532245437163653
  mo_energy =
[-1.21709776e+02 -1.33862945e+01 -7.62358654e+00 -7.62358654e+00
 -7.62358654e+00 -1.65759204e+00 -6.72170262e-01 -6.72170262e-01
 -6.72170262e-01  5.32245437e-01  4.75931272e+00  2.10475310e+01
  7.96993247e+01  2.74501132e+02  9.02124108e+02  3.15450431e+03
  1.26337985e+04  4.12302768e+04  1.05258079e+05  2.30430939e+05
  4.56238256e+05  8.45184720e+05  1.52835638e+06  2.85061686e+06
  5.80849528e+06]
E1 = -707.7553202693789  E_coul = 199.78279715099777
cycle= 1 E= -507.972523118381  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.75882
diis-c [-0.57580762  1.        ]
  HOMO = -0.21761993561054  LUMO = 0.876893262484479
  mo_energy =
[-1.20200098e+02 -1.23047133e+01 -6.59396012e+00 -6.59396012e+00
 -6.59396012e+00 -1.16332409e+00 -2.17619936e-01 -2.17619936e-01
 -2.17619936e-01  8.76893262e-01  5.37760990e+00  2.19935405e+01
  8.09692147e+01  2.75953609e+02  9.03615718e+02  3.15593669e+03
  1.26351245e+04  4.12315356e+04  1.05259301e+05  2.30432136e+05
  4.56239436e+05  8.45185887e+05  1.52835753e+06  2.85061801e+06
  5.80849642e+06]
E1 = -706.8001295093661  E_coul = 198.8097861676948
cycle= 2 E= -507.990343341671  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350075
diis-c [-0.00122007 -0.00309007  1.00309007]
  HOMO = -0.239807120230835  LUMO = 0.873288958438135
  mo_energy =
[-1.20315143e+02 -1.23725432e+01 -6.66906415e+00 -6.66906415e+00
 -6.66906415e+00 -1.17760050e+00 -2.39807120e-01 -2.39807120e-01
 -2.39807120e-01  8.73288958e-01  5.34993439e+00  2.19366805e+01
  8.08853584e+01  2.75848823e+02  9.03495020e+02  3.15580164e+03
  1.26349792e+04  4.12313864e+04  1.05259150e+05  2.30431984e+05
  4.56239284e+05  8.45185734e+05  1.52835738e+06  2.85061786e+06
  5.80849626e+06]
E1 = -706.6915990336735  E_coul = 198.70099299942032
cycle= 3 E= -507.990606034253  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385034
diis-c [-3.29472892e-06  1.08781633e-04 -1.07831156e-01  1.10772237e+00]
  HOMO = -0.242958001488332  LUMO = 0.872552208029032
  mo_energy =
[-1.20326864e+02 -1.23810914e+01 -6.67809275e+00 -6.67809275e+00
 -6.67809275e+00 -1.17950996e+00 -2.42958001e-01 -2.42958001e-01
 -2.42958001e-01  8.72552208e-01  5.34581901e+00  2.19293326e+01
  8.08757368e+01  2.75837768e+02  9.03483065e+02  3.15578898e+03
  1.26349661e+04  4.12313731e+04  1.05259137e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6762821012426  E_coul = 198.68567098641347
cycle= 4 E= -507.990611114829  delta_E= -5.08e-06  |g|= 0.000232  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173498
diis-c [-5.87642205e-10 -9.54479947e-06  6.87800214e-03 -9.72408818e-02
  1.09037242e+00]
  HOMO = -0.243105204935124  LUMO = 0.872508402828067
  mo_energy =
[-1.20327197e+02 -1.23814229e+01 -6.67841949e+00 -6.67841949e+00
 -6.67841949e+00 -1.17959919e+00 -2.43105205e-01 -2.43105205e-01
 -2.43105205e-01  8.72508403e-01  5.34562018e+00  2.19290372e+01
  8.08754106e+01  2.75837436e+02  9.03482731e+02  3.15578865e+03
  1.26349657e+04  4.12313728e+04  1.05259136e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6755722075691  E_coul = 198.6849610785628
cycle= 5 E= -507.990611129006  delta_E= -1.42e-08  |g|= 6.12e-06  |ddm|= 0.000681
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71059e-06
diis-c [-9.70573947e-13  6.24866786e-07 -5.72141516e-04  7.70447814e-03
 -9.27094500e-02  1.08557649e+00]
  HOMO = -0.243107992828022  LUMO = 0.872507619638447
  mo_energy =
[-1.20327203e+02 -1.23814283e+01 -6.67842494e+00 -6.67842494e+00
 -6.67842494e+00 -1.17960111e+00 -2.43107993e-01 -2.43107993e-01
 -2.43107993e-01  8.72507620e-01  5.34561635e+00  2.19290322e+01
  8.08754050e+01  2.75837430e+02  9.03482725e+02  3.15578864e+03
  1.26349657e+04  4.12313728e+04  1.05259136e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6755580665694  E_coul = 198.68494693755514
cycle= 6 E= -507.990611129014  delta_E= -7.9e-12  |g|= 9.13e-08  |ddm|= 1.87e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6755580665694  E_coul = 198.68494693755514
  HOMO = -0.243108035256349  LUMO = 0.872507593765805
  mo_energy =
[-1.20327203e+02 -1.23814284e+01 -6.67842502e+00 -6.67842502e+00
 -6.67842502e+00 -1.17960112e+00 -2.43108035e-01 -2.43108035e-01
 -2.43108035e-01  8.72507594e-01  5.34561629e+00  2.19290321e+01
  8.08754049e+01  2.75837430e+02  9.03482725e+02  3.15578864e+03
  1.26349657e+04  4.12313728e+04  1.05259136e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6755578822347  E_coul = 198.6849467532204
Extra cycle  E= -507.990611129014  delta_E= -5.68e-14  |g|= 1.19e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.28194808e-01 5.94419843e-01 1.78039267e+00 1.17616813e+05
 3.99726308e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230204e+03
 1.83757706e+04 1.44367535e+03 4.17386488e+02 1.47773903e+02
 5.84391187e+01 2.47304849e+01 8.98241728e+00 8.60426406e+00
 4.92749031e-01]
E = -507.99061112901427
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228194807982       1
[INPUT] 0    0    [1    /1   ]  0.594419842556       1
[INPUT] 0    0    [1    /1   ]  1.78039266536        1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  3.997263076          1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.417489         1
[INPUT] 0    0    [1    /1   ]  36754.7012261        1
[INPUT] 0    0    [1    /1   ]  7302.30203879        1
[INPUT] 0    0    [1    /1   ]  18375.7705833        1
[INPUT] 0    0    [1    /1   ]  1443.67535435        1
[INPUT] 0    0    [1    /1   ]  417.386488028        1
[INPUT] 0    0    [1    /1   ]  147.773902801        1
[INPUT] 0    0    [1    /1   ]  58.4391187057        1
[INPUT] 0    0    [1    /1   ]  24.7304848858        1
[INPUT] 0    0    [1    /1   ]  8.98241728458        1
[INPUT] 1    0    [1    /1   ]  8.60426405851        1
[INPUT] 1    0    [1    /1   ]  0.492749031004       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22819480798171737, 1.0]], [0, [0.5944198425563609, 1.0]], [0, [1.7803926653581619, 1.0]], [0, [117616.81286628179, 1.0]], [0, [3.9972630759973815, 1.0]], [0, [1176168.1426132983, 1.0]], [0, [588084.0699558929, 1.0]], [0, [294042.03091783344, 1.0]], [0, [147020.99130908566, 1.0]], [0, [73510.41748895806, 1.0]], [0, [36754.70122614738, 1.0]], [0, [7302.302038791879, 1.0]], [0, [18375.770583308768, 1.0]], [0, [1443.6753543523826, 1.0]], [0, [417.38648802792693, 1.0]], [0, [147.77390280091402, 1.0]], [0, [58.43911870566367, 1.0]], [0, [24.73048488584926, 1.0]], [0, [8.982417284575869, 1.0]], [1, [8.604264058513289, 1.0]], [1, [0.4927490310035522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22819481]
bas 1, expnt(s) = [0.59441984]
bas 2, expnt(s) = [1.78039267]
bas 3, expnt(s) = [117616.81286628]
bas 4, expnt(s) = [3.99726308]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.06995589]
bas 7, expnt(s) = [294042.03091783]
bas 8, expnt(s) = [147020.99130909]
bas 9, expnt(s) = [73510.41748896]
bas 10, expnt(s) = [36754.70122615]
bas 11, expnt(s) = [7302.30203879]
bas 12, expnt(s) = [18375.77058331]
bas 13, expnt(s) = [1443.67535435]
bas 14, expnt(s) = [417.38648803]
bas 15, expnt(s) = [147.7739028]
bas 16, expnt(s) = [58.43911871]
bas 17, expnt(s) = [24.73048489]
bas 18, expnt(s) = [8.98241728]
bas 19, expnt(s) = [8.60426406]
bas 20, expnt(s) = [0.49274903]
CPU time:       914.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28194808e-01 8.34150364e-01 5.94419843e-01 1.71035002e+00
 1.78039267e+00 3.89405312e+00 1.17616813e+05 1.60460108e+04
 3.99726308e+00 7.14228331e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655819e+03 7.30230204e+03 1.99576714e+03
 1.83757706e+04 3.98748621e+03 1.44367535e+03 5.91721271e+02
 4.17386488e+02 2.33302189e+02 1.47773903e+02 1.07081225e+02
 5.84391187e+01 5.34001857e+01 2.47304849e+01 2.80181527e+01
 8.98241728e+00 1.31087097e+01 8.60426406e+00 4.29909018e+01
 4.92749031e-01 1.20438854e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336088853599158
cond(S) = 912620.0375557332
E1 = -689.5968853428402  E_coul = 184.97157213767147
init E= -504.625313205169
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672170261832662  LUMO = 0.532245437163653
  mo_energy =
[-1.21709776e+02 -1.33862945e+01 -7.62358654e+00 -7.62358654e+00
 -7.62358654e+00 -1.65759204e+00 -6.72170262e-01 -6.72170262e-01
 -6.72170262e-01  5.32245437e-01  4.75931272e+00  2.10475310e+01
  7.96993247e+01  2.74501132e+02  9.02124108e+02  3.15450431e+03
  1.26337985e+04  4.12302768e+04  1.05258079e+05  2.30430939e+05
  4.56238256e+05  8.45184720e+05  1.52835638e+06  2.85061686e+06
  5.80849528e+06]
E1 = -707.7553202693789  E_coul = 199.78279715099777
cycle= 1 E= -507.972523118381  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.75882
diis-c [-0.57580762  1.        ]
  HOMO = -0.21761993561054  LUMO = 0.876893262484479
  mo_energy =
[-1.20200098e+02 -1.23047133e+01 -6.59396012e+00 -6.59396012e+00
 -6.59396012e+00 -1.16332409e+00 -2.17619936e-01 -2.17619936e-01
 -2.17619936e-01  8.76893262e-01  5.37760990e+00  2.19935405e+01
  8.09692147e+01  2.75953609e+02  9.03615718e+02  3.15593669e+03
  1.26351245e+04  4.12315356e+04  1.05259301e+05  2.30432136e+05
  4.56239436e+05  8.45185887e+05  1.52835753e+06  2.85061801e+06
  5.80849642e+06]
E1 = -706.8001295093661  E_coul = 198.8097861676948
cycle= 2 E= -507.990343341671  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.39
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350075
diis-c [-0.00122007 -0.00309007  1.00309007]
  HOMO = -0.239807120230835  LUMO = 0.873288958438135
  mo_energy =
[-1.20315143e+02 -1.23725432e+01 -6.66906415e+00 -6.66906415e+00
 -6.66906415e+00 -1.17760050e+00 -2.39807120e-01 -2.39807120e-01
 -2.39807120e-01  8.73288958e-01  5.34993439e+00  2.19366805e+01
  8.08853584e+01  2.75848823e+02  9.03495020e+02  3.15580164e+03
  1.26349792e+04  4.12313864e+04  1.05259150e+05  2.30431984e+05
  4.56239284e+05  8.45185734e+05  1.52835738e+06  2.85061786e+06
  5.80849626e+06]
E1 = -706.6915990336735  E_coul = 198.70099299942032
cycle= 3 E= -507.990606034253  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00385034
diis-c [-3.29472892e-06  1.08781633e-04 -1.07831156e-01  1.10772237e+00]
  HOMO = -0.242958001488332  LUMO = 0.872552208029032
  mo_energy =
[-1.20326864e+02 -1.23810914e+01 -6.67809275e+00 -6.67809275e+00
 -6.67809275e+00 -1.17950996e+00 -2.42958001e-01 -2.42958001e-01
 -2.42958001e-01  8.72552208e-01  5.34581901e+00  2.19293326e+01
  8.08757368e+01  2.75837768e+02  9.03483065e+02  3.15578898e+03
  1.26349661e+04  4.12313731e+04  1.05259137e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6762821012426  E_coul = 198.68567098641347
cycle= 4 E= -507.990611114829  delta_E= -5.08e-06  |g|= 0.000232  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173498
diis-c [-5.87642205e-10 -9.54479947e-06  6.87800214e-03 -9.72408818e-02
  1.09037242e+00]
  HOMO = -0.243105204935124  LUMO = 0.872508402828067
  mo_energy =
[-1.20327197e+02 -1.23814229e+01 -6.67841949e+00 -6.67841949e+00
 -6.67841949e+00 -1.17959919e+00 -2.43105205e-01 -2.43105205e-01
 -2.43105205e-01  8.72508403e-01  5.34562018e+00  2.19290372e+01
  8.08754106e+01  2.75837436e+02  9.03482731e+02  3.15578865e+03
  1.26349657e+04  4.12313728e+04  1.05259136e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6755722075691  E_coul = 198.6849610785628
cycle= 5 E= -507.990611129006  delta_E= -1.42e-08  |g|= 6.12e-06  |ddm|= 0.000681
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.71059e-06
diis-c [-9.70573947e-13  6.24866786e-07 -5.72141516e-04  7.70447814e-03
 -9.27094500e-02  1.08557649e+00]
  HOMO = -0.243107992828022  LUMO = 0.872507619638447
  mo_energy =
[-1.20327203e+02 -1.23814283e+01 -6.67842494e+00 -6.67842494e+00
 -6.67842494e+00 -1.17960111e+00 -2.43107993e-01 -2.43107993e-01
 -2.43107993e-01  8.72507620e-01  5.34561635e+00  2.19290322e+01
  8.08754050e+01  2.75837430e+02  9.03482725e+02  3.15578864e+03
  1.26349657e+04  4.12313728e+04  1.05259136e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6755580665694  E_coul = 198.68494693755514
cycle= 6 E= -507.990611129014  delta_E= -7.9e-12  |g|= 9.13e-08  |ddm|= 1.87e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6755580665694  E_coul = 198.68494693755514
  HOMO = -0.243108035256349  LUMO = 0.872507593765805
  mo_energy =
[-1.20327203e+02 -1.23814284e+01 -6.67842502e+00 -6.67842502e+00
 -6.67842502e+00 -1.17960112e+00 -2.43108035e-01 -2.43108035e-01
 -2.43108035e-01  8.72507594e-01  5.34561629e+00  2.19290321e+01
  8.08754049e+01  2.75837430e+02  9.03482725e+02  3.15578864e+03
  1.26349657e+04  4.12313728e+04  1.05259136e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6755578822347  E_coul = 198.6849467532204
Extra cycle  E= -507.990611129014  delta_E= -5.68e-14  |g|= 1.19e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912620.0375557332
E1 = -706.6755578822347  E_coul = 198.6849467532204
init E= -507.990611129014
    CPU time for initialize scf      5.80 sec, wall time      0.24 sec
  HOMO = -0.24310804127123  LUMO = 0.87250759230286
  mo_energy =
[-1.20327203e+02 -1.23814284e+01 -6.67842503e+00 -6.67842503e+00
 -6.67842503e+00 -1.17960112e+00 -2.43108041e-01 -2.43108041e-01
 -2.43108041e-01  8.72507592e-01  5.34561628e+00  2.19290321e+01
  8.08754049e+01  2.75837430e+02  9.03482724e+02  3.15578864e+03
  1.26349657e+04  4.12313728e+04  1.05259136e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6755578518009  E_coul = 198.68494672278655
cycle= 1 E= -507.990611129014  delta_E= -1.14e-13  |g|= 2.07e-09  |ddm|= 3.09e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6755578518009  E_coul = 198.68494672278655
  HOMO = -0.243108042216478  LUMO = 0.872507592413109
  mo_energy =
[-1.20327203e+02 -1.23814284e+01 -6.67842504e+00 -6.67842504e+00
 -6.67842504e+00 -1.17960113e+00 -2.43108042e-01 -2.43108042e-01
 -2.43108042e-01  8.72507592e-01  5.34561628e+00  2.19290321e+01
  8.08754049e+01  2.75837430e+02  9.03482724e+02  3.15578864e+03
  1.26349657e+04  4.12313728e+04  1.05259136e+05  2.30431971e+05
  4.56239270e+05  8.45185721e+05  1.52835736e+06  2.85061784e+06
  5.80849625e+06]
E1 = -706.6755578467333  E_coul = 198.68494671771896
Extra cycle  E= -507.990611129014  delta_E=    0  |g|= 1.45e-09  |ddm|= 4.39e-09
    CPU time for scf_cycle      6.32 sec, wall time      0.41 sec
exp = [2.28194808e-01 5.94419843e-01 1.78039267e+00 1.17616813e+05
 3.99726308e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230204e+03
 1.83757706e+04 1.44367535e+03 4.17386488e+02 1.47773903e+02
 5.84391187e+01 2.47304849e+01 8.98241728e+00 8.60426406e+00
 4.92749031e-01]
grad_E = [ 6.36177662e-05 -3.18190376e-05 -1.33859104e-05  6.04897517e-09
  5.01129342e-06  4.02914139e-11  1.73718811e-10  9.38266199e-10
  3.70691445e-09  1.54789798e-08  8.07534321e-08  5.09015847e-06
  1.97816853e-07 -3.80475892e-05 -1.00683334e-05  2.33167434e-05
 -8.05367060e-05  1.37870187e-05  7.56603807e-06 -1.46857072e-05
 -9.60901351e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228394114858       1
[INPUT] 0    0    [1    /1   ]  0.595095378568       1
[INPUT] 0    0    [1    /1   ]  1.79299381992        1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  4.01256629351        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174878        1
[INPUT] 0    0    [1    /1   ]  36754.7012203        1
[INPUT] 0    0    [1    /1   ]  7302.30167126        1
[INPUT] 0    0    [1    /1   ]  18375.770569         1
[INPUT] 0    0    [1    /1   ]  1443.67811883        1
[INPUT] 0    0    [1    /1   ]  417.386999903        1
[INPUT] 0    0    [1    /1   ]  147.773427403        1
[INPUT] 0    0    [1    /1   ]  58.4399116352        1
[INPUT] 0    0    [1    /1   ]  24.7330770918        1
[INPUT] 0    0    [1    /1   ]  9.00444540248        1
[INPUT] 1    0    [1    /1   ]  8.60426085337        1
[INPUT] 1    0    [1    /1   ]  0.49274853408        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22839411485820793, 1.0]], [0, [0.5950953785680246, 1.0]], [0, [1.7929938199212208, 1.0]], [0, [117616.81286584497, 1.0]], [0, [4.012566293510162, 1.0]], [0, [1176168.1426132952, 1.0]], [0, [588084.0699558803, 1.0]], [0, [294042.0309177657, 1.0]], [0, [147020.99130881796, 1.0]], [0, [73510.41748784021, 1.0]], [0, [36754.701220316434, 1.0]], [0, [7302.301671263484, 1.0]], [0, [18375.77056901668, 1.0]], [0, [1443.6781188325738, 1.0]], [0, [417.38699990300586, 1.0]], [0, [147.77342740308805, 1.0]], [0, [58.43991163516871, 1.0]], [0, [24.733077091801817, 1.0]], [0, [9.00444540248339, 1.0]], [1, [8.604260853368805, 1.0]], [1, [0.4927485340802909, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22839411]
bas 1, expnt(s) = [0.59509538]
bas 2, expnt(s) = [1.79299382]
bas 3, expnt(s) = [117616.81286584]
bas 4, expnt(s) = [4.01256629]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.06995588]
bas 7, expnt(s) = [294042.03091777]
bas 8, expnt(s) = [147020.99130882]
bas 9, expnt(s) = [73510.41748784]
bas 10, expnt(s) = [36754.70122032]
bas 11, expnt(s) = [7302.30167126]
bas 12, expnt(s) = [18375.77056902]
bas 13, expnt(s) = [1443.67811883]
bas 14, expnt(s) = [417.3869999]
bas 15, expnt(s) = [147.7734274]
bas 16, expnt(s) = [58.43991164]
bas 17, expnt(s) = [24.73307709]
bas 18, expnt(s) = [9.0044454]
bas 19, expnt(s) = [8.60426085]
bas 20, expnt(s) = [0.49274853]
CPU time:       929.86
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28394115e-01 8.34696718e-01 5.95095379e-01 1.71180763e+00
 1.79299382e+00 3.91470570e+00 1.17616813e+05 1.60460108e+04
 4.01256629e+00 7.16278128e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30230167e+03 1.99576707e+03
 1.83757706e+04 3.98748621e+03 1.44367812e+03 5.91722120e+02
 4.17387000e+02 2.33302403e+02 1.47773427e+02 1.07080967e+02
 5.84399116e+01 5.34007292e+01 2.47330771e+01 2.80203553e+01
 9.00444540e+00 1.31328127e+01 8.60426085e+00 4.29908818e+01
 4.92748534e-01 1.20438703e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336088548532462
cond(S) = 912625.988293462
E1 = -689.5968247510704  E_coul = 184.97150628053893
init E= -504.625318470531
    CPU time for initialize scf      7.68 sec, wall time      0.37 sec
  HOMO = -0.672172048528906  LUMO = 0.533834240786886
  mo_energy =
[-1.21709783e+02 -1.33863014e+01 -7.62359130e+00 -7.62359130e+00
 -7.62359130e+00 -1.65759101e+00 -6.72172049e-01 -6.72172049e-01
 -6.72172049e-01  5.33834241e-01  4.78715392e+00  2.11567738e+01
  7.98944118e+01  2.74718817e+02  9.02330676e+02  3.15469449e+03
  1.26339724e+04  4.12304399e+04  1.05258236e+05  2.30431091e+05
  4.56238405e+05  8.45184867e+05  1.52835652e+06  2.85061700e+06
  5.80849542e+06]
E1 = -707.7552057415371  E_coul = 199.78268112444638
cycle= 1 E= -507.972524617091  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.56 sec, wall time      0.03 sec
diis-norm(errvec)=0.758976
diis-c [-0.57604508  1.        ]
  HOMO = -0.217622792236499  LUMO = 0.878932644720696
  mo_energy =
[-1.20200110e+02 -1.23047239e+01 -6.59396881e+00 -6.59396881e+00
 -6.59396881e+00 -1.16332488e+00 -2.17622792e-01 -2.17622792e-01
 -2.17622792e-01  8.78932645e-01  5.40696237e+00  2.21038258e+01
  8.11644171e+01  2.76171254e+02  9.03822267e+02  3.15612686e+03
  1.26352984e+04  4.12316986e+04  1.05259457e+05  2.30432288e+05
  4.56239585e+05  8.45186033e+05  1.52835768e+06  2.85061815e+06
  5.80849655e+06]
E1 = -706.8000815278959  E_coul = 198.8097380606641
cycle= 2 E= -507.990343467232  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0349564
diis-c [-0.00121657 -0.00306907  1.00306907]
  HOMO = -0.239807504104281  LUMO = 0.875307978896097
  mo_energy =
[-1.20315147e+02 -1.23725473e+01 -6.66906608e+00 -6.66906608e+00
 -6.66906608e+00 -1.17759959e+00 -2.39807504e-01 -2.39807504e-01
 -2.39807504e-01  8.75307979e-01  5.37916093e+00  2.20468779e+01
  8.10805501e+01  2.76066477e+02  9.03701580e+02  3.15599182e+03
  1.26351531e+04  4.12315495e+04  1.05259307e+05  2.30432137e+05
  4.56239433e+05  8.45185881e+05  1.52835752e+06  2.85061800e+06
  5.80849640e+06]
E1 = -706.6915682353093  E_coul = 198.70096213877693
cycle= 3 E= -507.990606096532  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00384044
diis-c [-3.28749033e-06  1.11092785e-04 -1.07652758e-01  1.10754167e+00]
  HOMO = -0.242957515617349  LUMO = 0.874568194220063
  mo_energy =
[-1.20326866e+02 -1.23810941e+01 -6.67809326e+00 -6.67809326e+00
 -6.67809326e+00 -1.17950848e+00 -2.42957516e-01 -2.42957516e-01
 -2.42957516e-01  8.74568194e-01  5.37503001e+00  2.20395220e+01
  8.10709284e+01  2.76055424e+02  9.03689626e+02  3.15597917e+03
  1.26351400e+04  4.12315362e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185868e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.6762571820326  E_coul = 198.68564600864315
cycle= 4 E= -507.990611173389  delta_E= -5.08e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173541
diis-c [-5.81720641e-10 -9.52770827e-06  6.87479821e-03 -9.73971957e-02
  1.09053193e+00]
  HOMO = -0.243105176121058  LUMO = 0.87452415721597
  mo_energy =
[-1.20327202e+02 -1.23814271e+01 -6.67842160e+00 -6.67842160e+00
 -6.67842160e+00 -1.17959798e+00 -2.43105176e-01 -2.43105176e-01
 -2.43105176e-01  8.74524157e-01  5.37482993e+00  2.20392252e+01
  8.10706005e+01  2.76055090e+02  9.03689290e+02  3.15597883e+03
  1.26351396e+04  4.12315359e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185867e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.675545212332  E_coul = 198.6849340247361
cycle= 5 E= -507.990611187596  delta_E= -1.42e-08  |g|= 6.07e-06  |ddm|= 0.00068
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.68674e-06
diis-c [-9.64014532e-13  6.15991612e-07 -5.67856126e-04  7.66415568e-03
 -9.21031171e-02  1.08500620e+00]
  HOMO = -0.243107945925098  LUMO = 0.874523375692196
  mo_energy =
[-1.20327208e+02 -1.23814324e+01 -6.67842702e+00 -6.67842702e+00
 -6.67842702e+00 -1.17959988e+00 -2.43107946e-01 -2.43107946e-01
 -2.43107946e-01  8.74523376e-01  5.37482612e+00  2.20392202e+01
  8.10705949e+01  2.76055084e+02  9.03689284e+02  3.15597882e+03
  1.26351396e+04  4.12315358e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185867e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.6755311760958  E_coul = 198.68491998849254
cycle= 6 E= -507.990611187603  delta_E= -7.28e-12  |g|= 9.24e-08  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6755311760958  E_coul = 198.68491998849254
  HOMO = -0.243107988237849  LUMO = 0.874523354459666
  mo_energy =
[-1.20327208e+02 -1.23814325e+01 -6.67842710e+00 -6.67842710e+00
 -6.67842710e+00 -1.17959990e+00 -2.43107988e-01 -2.43107988e-01
 -2.43107988e-01  8.74523354e-01  5.37482606e+00  2.20392201e+01
  8.10705948e+01  2.76055084e+02  9.03689284e+02  3.15597882e+03
  1.26351396e+04  4.12315358e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185867e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.6755309869762  E_coul = 198.68491979937284
Extra cycle  E= -507.990611187603  delta_E= -1.71e-13  |g|= 1.2e-08  |ddm|= 2.27e-07
    CPU time for scf_cycle      8.47 sec, wall time      0.60 sec
exp = [2.28394115e-01 5.95095379e-01 1.79299382e+00 1.17616813e+05
 4.01256629e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230167e+03
 1.83757706e+04 1.44367812e+03 4.17387000e+02 1.47773427e+02
 5.84399116e+01 2.47330771e+01 9.00444540e+00 8.60426085e+00
 4.92748534e-01]
E = -507.9906111876034
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228394114858       1
[INPUT] 0    0    [1    /1   ]  0.595095378568       1
[INPUT] 0    0    [1    /1   ]  1.79299381992        1
[INPUT] 0    0    [1    /1   ]  117616.812866        1
[INPUT] 0    0    [1    /1   ]  4.01256629351        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174878        1
[INPUT] 0    0    [1    /1   ]  36754.7012203        1
[INPUT] 0    0    [1    /1   ]  7302.30167126        1
[INPUT] 0    0    [1    /1   ]  18375.770569         1
[INPUT] 0    0    [1    /1   ]  1443.67811883        1
[INPUT] 0    0    [1    /1   ]  417.386999903        1
[INPUT] 0    0    [1    /1   ]  147.773427403        1
[INPUT] 0    0    [1    /1   ]  58.4399116352        1
[INPUT] 0    0    [1    /1   ]  24.7330770918        1
[INPUT] 0    0    [1    /1   ]  9.00444540248        1
[INPUT] 1    0    [1    /1   ]  8.60426085337        1
[INPUT] 1    0    [1    /1   ]  0.49274853408        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22839411485820793, 1.0]], [0, [0.5950953785680246, 1.0]], [0, [1.7929938199212208, 1.0]], [0, [117616.81286584497, 1.0]], [0, [4.012566293510162, 1.0]], [0, [1176168.1426132952, 1.0]], [0, [588084.0699558803, 1.0]], [0, [294042.0309177657, 1.0]], [0, [147020.99130881796, 1.0]], [0, [73510.41748784021, 1.0]], [0, [36754.701220316434, 1.0]], [0, [7302.301671263484, 1.0]], [0, [18375.77056901668, 1.0]], [0, [1443.6781188325738, 1.0]], [0, [417.38699990300586, 1.0]], [0, [147.77342740308805, 1.0]], [0, [58.43991163516871, 1.0]], [0, [24.733077091801817, 1.0]], [0, [9.00444540248339, 1.0]], [1, [8.604260853368805, 1.0]], [1, [0.4927485340802909, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22839411]
bas 1, expnt(s) = [0.59509538]
bas 2, expnt(s) = [1.79299382]
bas 3, expnt(s) = [117616.81286584]
bas 4, expnt(s) = [4.01256629]
bas 5, expnt(s) = [1176168.1426133]
bas 6, expnt(s) = [588084.06995588]
bas 7, expnt(s) = [294042.03091777]
bas 8, expnt(s) = [147020.99130882]
bas 9, expnt(s) = [73510.41748784]
bas 10, expnt(s) = [36754.70122032]
bas 11, expnt(s) = [7302.30167126]
bas 12, expnt(s) = [18375.77056902]
bas 13, expnt(s) = [1443.67811883]
bas 14, expnt(s) = [417.3869999]
bas 15, expnt(s) = [147.7734274]
bas 16, expnt(s) = [58.43991164]
bas 17, expnt(s) = [24.73307709]
bas 18, expnt(s) = [9.0044454]
bas 19, expnt(s) = [8.60426085]
bas 20, expnt(s) = [0.49274853]
CPU time:       938.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28394115e-01 8.34696718e-01 5.95095379e-01 1.71180763e+00
 1.79299382e+00 3.91470570e+00 1.17616813e+05 1.60460108e+04
 4.01256629e+00 7.16278128e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30230167e+03 1.99576707e+03
 1.83757706e+04 3.98748621e+03 1.44367812e+03 5.91722120e+02
 4.17387000e+02 2.33302403e+02 1.47773427e+02 1.07080967e+02
 5.84399116e+01 5.34007292e+01 2.47330771e+01 2.80203553e+01
 9.00444540e+00 1.31328127e+01 8.60426085e+00 4.29908818e+01
 4.92748534e-01 1.20438703e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336088548532462
cond(S) = 912625.988293462
E1 = -689.5968247510704  E_coul = 184.97150628053893
init E= -504.625318470531
    CPU time for initialize scf      0.73 sec, wall time      0.07 sec
  HOMO = -0.672172048528906  LUMO = 0.533834240786886
  mo_energy =
[-1.21709783e+02 -1.33863014e+01 -7.62359130e+00 -7.62359130e+00
 -7.62359130e+00 -1.65759101e+00 -6.72172049e-01 -6.72172049e-01
 -6.72172049e-01  5.33834241e-01  4.78715392e+00  2.11567738e+01
  7.98944118e+01  2.74718817e+02  9.02330676e+02  3.15469449e+03
  1.26339724e+04  4.12304399e+04  1.05258236e+05  2.30431091e+05
  4.56238405e+05  8.45184867e+05  1.52835652e+06  2.85061700e+06
  5.80849542e+06]
E1 = -707.7552057415371  E_coul = 199.78268112444638
cycle= 1 E= -507.972524617091  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.758976
diis-c [-0.57604508  1.        ]
  HOMO = -0.217622792236499  LUMO = 0.878932644720696
  mo_energy =
[-1.20200110e+02 -1.23047239e+01 -6.59396881e+00 -6.59396881e+00
 -6.59396881e+00 -1.16332488e+00 -2.17622792e-01 -2.17622792e-01
 -2.17622792e-01  8.78932645e-01  5.40696237e+00  2.21038258e+01
  8.11644171e+01  2.76171254e+02  9.03822267e+02  3.15612686e+03
  1.26352984e+04  4.12316986e+04  1.05259457e+05  2.30432288e+05
  4.56239585e+05  8.45186033e+05  1.52835768e+06  2.85061815e+06
  5.80849655e+06]
E1 = -706.8000815278959  E_coul = 198.8097380606641
cycle= 2 E= -507.990343467232  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.391
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0349564
diis-c [-0.00121657 -0.00306907  1.00306907]
  HOMO = -0.239807504104281  LUMO = 0.875307978896097
  mo_energy =
[-1.20315147e+02 -1.23725473e+01 -6.66906608e+00 -6.66906608e+00
 -6.66906608e+00 -1.17759959e+00 -2.39807504e-01 -2.39807504e-01
 -2.39807504e-01  8.75307979e-01  5.37916093e+00  2.20468779e+01
  8.10805501e+01  2.76066477e+02  9.03701580e+02  3.15599182e+03
  1.26351531e+04  4.12315495e+04  1.05259307e+05  2.30432137e+05
  4.56239433e+05  8.45185881e+05  1.52835752e+06  2.85061800e+06
  5.80849640e+06]
E1 = -706.6915682353093  E_coul = 198.70096213877693
cycle= 3 E= -507.990606096532  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00384044
diis-c [-3.28749033e-06  1.11092785e-04 -1.07652758e-01  1.10754167e+00]
  HOMO = -0.242957515617349  LUMO = 0.874568194220063
  mo_energy =
[-1.20326866e+02 -1.23810941e+01 -6.67809326e+00 -6.67809326e+00
 -6.67809326e+00 -1.17950848e+00 -2.42957516e-01 -2.42957516e-01
 -2.42957516e-01  8.74568194e-01  5.37503001e+00  2.20395220e+01
  8.10709284e+01  2.76055424e+02  9.03689626e+02  3.15597917e+03
  1.26351400e+04  4.12315362e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185868e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.6762571820326  E_coul = 198.68564600864315
cycle= 4 E= -507.990611173389  delta_E= -5.08e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173541
diis-c [-5.81720641e-10 -9.52770827e-06  6.87479821e-03 -9.73971957e-02
  1.09053193e+00]
  HOMO = -0.243105176121058  LUMO = 0.87452415721597
  mo_energy =
[-1.20327202e+02 -1.23814271e+01 -6.67842160e+00 -6.67842160e+00
 -6.67842160e+00 -1.17959798e+00 -2.43105176e-01 -2.43105176e-01
 -2.43105176e-01  8.74524157e-01  5.37482993e+00  2.20392252e+01
  8.10706005e+01  2.76055090e+02  9.03689290e+02  3.15597883e+03
  1.26351396e+04  4.12315359e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185867e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.675545212332  E_coul = 198.6849340247361
cycle= 5 E= -507.990611187596  delta_E= -1.42e-08  |g|= 6.07e-06  |ddm|= 0.00068
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.68674e-06
diis-c [-9.64014532e-13  6.15991612e-07 -5.67856126e-04  7.66415568e-03
 -9.21031171e-02  1.08500620e+00]
  HOMO = -0.243107945925098  LUMO = 0.874523375692196
  mo_energy =
[-1.20327208e+02 -1.23814324e+01 -6.67842702e+00 -6.67842702e+00
 -6.67842702e+00 -1.17959988e+00 -2.43107946e-01 -2.43107946e-01
 -2.43107946e-01  8.74523376e-01  5.37482612e+00  2.20392202e+01
  8.10705949e+01  2.76055084e+02  9.03689284e+02  3.15597882e+03
  1.26351396e+04  4.12315358e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185867e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.6755311760958  E_coul = 198.68491998849254
cycle= 6 E= -507.990611187603  delta_E= -7.28e-12  |g|= 9.24e-08  |ddm|= 1.84e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6755311760958  E_coul = 198.68491998849254
  HOMO = -0.243107988237849  LUMO = 0.874523354459666
  mo_energy =
[-1.20327208e+02 -1.23814325e+01 -6.67842710e+00 -6.67842710e+00
 -6.67842710e+00 -1.17959990e+00 -2.43107988e-01 -2.43107988e-01
 -2.43107988e-01  8.74523354e-01  5.37482606e+00  2.20392201e+01
  8.10705948e+01  2.76055084e+02  9.03689284e+02  3.15597882e+03
  1.26351396e+04  4.12315358e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185867e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.6755309869762  E_coul = 198.68491979937284
Extra cycle  E= -507.990611187603  delta_E= -1.71e-13  |g|= 1.2e-08  |ddm|= 2.27e-07
    CPU time for scf_cycle      1.57 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912625.988293462
E1 = -706.6755309869762  E_coul = 198.68491979937284
init E= -507.990611187603
    CPU time for initialize scf      5.87 sec, wall time      0.25 sec
  HOMO = -0.243107994408638  LUMO = 0.874523350841956
  mo_energy =
[-1.20327208e+02 -1.23814325e+01 -6.67842712e+00 -6.67842712e+00
 -6.67842712e+00 -1.17959990e+00 -2.43107994e-01 -2.43107994e-01
 -2.43107994e-01  8.74523351e-01  5.37482605e+00  2.20392201e+01
  8.10705948e+01  2.76055084e+02  9.03689284e+02  3.15597882e+03
  1.26351396e+04  4.12315358e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185867e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.6755309553272  E_coul = 198.6849197677235
cycle= 1 E= -507.990611187604  delta_E= -2.84e-13  |g|= 2.01e-09  |ddm|= 3.15e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6755309553272  E_coul = 198.6849197677235
  HOMO = -0.243107995368159  LUMO = 0.874523350450334
  mo_energy =
[-1.20327208e+02 -1.23814325e+01 -6.67842712e+00 -6.67842712e+00
 -6.67842712e+00 -1.17959991e+00 -2.43107995e-01 -2.43107995e-01
 -2.43107995e-01  8.74523350e-01  5.37482605e+00  2.20392201e+01
  8.10705948e+01  2.76055084e+02  9.03689284e+02  3.15597882e+03
  1.26351396e+04  4.12315358e+04  1.05259293e+05  2.30432123e+05
  4.56239419e+05  8.45185867e+05  1.52835751e+06  2.85061798e+06
  5.80849639e+06]
E1 = -706.675530952232  E_coul = 198.68491976462838
Extra cycle  E= -507.990611187604  delta_E= 1.14e-13  |g|= 1.06e-09  |ddm|= 3.08e-09
    CPU time for scf_cycle      6.40 sec, wall time      0.42 sec
exp = [2.28394115e-01 5.95095379e-01 1.79299382e+00 1.17616813e+05
 4.01256629e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230167e+03
 1.83757706e+04 1.44367812e+03 4.17387000e+02 1.47773427e+02
 5.84399116e+01 2.47330771e+01 9.00444540e+00 8.60426085e+00
 4.92748534e-01]
grad_E = [ 9.96776152e-05 -5.50267893e-05 -1.17690409e-05  6.04892000e-09
  7.25090757e-06  4.02907979e-11  1.73716998e-10  9.38257745e-10
  3.70688026e-09  1.54788352e-08  8.07527415e-08  5.09012436e-06
  1.97814528e-07 -3.80479169e-05 -1.00647433e-05  2.33526875e-05
 -8.08827457e-05  1.38917899e-05  7.89281936e-06 -1.66035599e-05
 -1.13009594e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228543323341       1
[INPUT] 0    0    [1    /1   ]  0.595660741968       1
[INPUT] 0    0    [1    /1   ]  1.79928876081        1
[INPUT] 0    0    [1    /1   ]  117616.812865        1
[INPUT] 0    0    [1    /1   ]  4.02328549809        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174868        1
[INPUT] 0    0    [1    /1   ]  36754.7012149        1
[INPUT] 0    0    [1    /1   ]  7302.30132974        1
[INPUT] 0    0    [1    /1   ]  18375.7705557        1
[INPUT] 0    0    [1    /1   ]  1443.68068319        1
[INPUT] 0    0    [1    /1   ]  417.387525648        1
[INPUT] 0    0    [1    /1   ]  147.77275933         1
[INPUT] 0    0    [1    /1   ]  58.4413388824        1
[INPUT] 0    0    [1    /1   ]  24.7351358841        1
[INPUT] 0    0    [1    /1   ]  9.02286337396        1
[INPUT] 1    0    [1    /1   ]  8.60427445847        1
[INPUT] 1    0    [1    /1   ]  0.492750158248       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22854332334077881, 1.0]], [0, [0.5956607419680576, 1.0]], [0, [1.7992887608103287, 1.0]], [0, [117616.81286543907, 1.0]], [0, [4.023285498090235, 1.0]], [0, [1176168.1426132924, 1.0]], [0, [588084.0699558686, 1.0]], [0, [294042.0309177027, 1.0]], [0, [147020.9913085692, 1.0]], [0, [73510.4174868015, 1.0]], [0, [36754.70121489811, 1.0]], [0, [7302.3013297433545, 1.0]], [0, [18375.770555737734, 1.0]], [0, [1443.6806831945905, 1.0]], [0, [417.38752564787956, 1.0]], [0, [147.77275932956985, 1.0]], [0, [58.441338882446736, 1.0]], [0, [24.73513588408461, 1.0]], [0, [9.022863373955273, 1.0]], [1, [8.604274458471057, 1.0]], [1, [0.4927501582477264, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22854332]
bas 1, expnt(s) = [0.59566074]
bas 2, expnt(s) = [1.79928876]
bas 3, expnt(s) = [117616.81286544]
bas 4, expnt(s) = [4.0232855]
bas 5, expnt(s) = [1176168.14261329]
bas 6, expnt(s) = [588084.06995587]
bas 7, expnt(s) = [294042.0309177]
bas 8, expnt(s) = [147020.99130857]
bas 9, expnt(s) = [73510.4174868]
bas 10, expnt(s) = [36754.7012149]
bas 11, expnt(s) = [7302.30132974]
bas 12, expnt(s) = [18375.77055574]
bas 13, expnt(s) = [1443.68068319]
bas 14, expnt(s) = [417.38752565]
bas 15, expnt(s) = [147.77275933]
bas 16, expnt(s) = [58.44133888]
bas 17, expnt(s) = [24.73513588]
bas 18, expnt(s) = [9.02286337]
bas 19, expnt(s) = [8.60427446]
bas 20, expnt(s) = [0.49275016]
CPU time:       953.58
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28543323e-01 8.35105662e-01 5.95660742e-01 1.71302720e+00
 1.79928876e+00 3.92500916e+00 1.17616813e+05 1.60460108e+04
 4.02328550e+00 7.17712753e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30230133e+03 1.99576700e+03
 1.83757706e+04 3.98748621e+03 1.44368068e+03 5.91722909e+02
 4.17387526e+02 2.33302624e+02 1.47772759e+02 1.07080604e+02
 5.84413389e+01 5.34017073e+01 2.47351359e+01 2.80221046e+01
 9.02286337e+00 1.31529543e+01 8.60427446e+00 4.29909667e+01
 4.92750158e-01 1.20439199e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336085670949153
cond(S) = 912630.0559105778
E1 = -689.5969266194724  E_coul = 184.97160524049005
init E= -504.625321378982
    CPU time for initialize scf      7.47 sec, wall time      0.37 sec
  HOMO = -0.672170761495942  LUMO = 0.534940407516521
  mo_energy =
[-1.21709767e+02 -1.33862945e+01 -7.62358492e+00 -7.62358492e+00
 -7.62358492e+00 -1.65758790e+00 -6.72170761e-01 -6.72170761e-01
 -6.72170761e-01  5.34940408e-01  4.80348236e+00  2.12270069e+01
  8.00303096e+01  2.74875649e+02  9.02481381e+02  3.15483430e+03
  1.26341015e+04  4.12305613e+04  1.05258352e+05  2.30431204e+05
  4.56238516e+05  8.45184976e+05  1.52835663e+06  2.85061711e+06
  5.80849552e+06]
E1 = -707.7553085258215  E_coul = 199.78278328287985
cycle= 1 E= -507.972525242942  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.759064
diis-c [-0.57617816  1.        ]
  HOMO = -0.217620384993532  LUMO = 0.88032924067083
  mo_energy =
[-1.20200094e+02 -1.23047173e+01 -6.59396282e+00 -6.59396282e+00
 -6.59396282e+00 -1.16332181e+00 -2.17620385e-01 -2.17620385e-01
 -2.17620385e-01  8.80329241e-01  5.42417714e+00  2.21747970e+01
  8.13004266e+01  2.76328064e+02  9.03972963e+02  3.15626667e+03
  1.26354274e+04  4.12318201e+04  1.05259574e+05  2.30432402e+05
  4.56239696e+05  8.45186143e+05  1.52835778e+06  2.85061826e+06
  5.80849666e+06]
E1 = -706.800216562341  E_coul = 198.80987297993386
cycle= 2 E= -507.990343582407  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.392
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0349316
diis-c [-0.00121487 -0.00305707  1.00305707]
  HOMO = -0.239803799467997  LUMO = 0.876691830064447
  mo_energy =
[-1.20315127e+02 -1.23725375e+01 -6.66905674e+00 -6.66905674e+00
 -6.66905674e+00 -1.17759552e+00 -2.39803799e-01 -2.39803799e-01
 -2.39803799e-01  8.76691830e-01  5.39630161e+00  2.21177887e+01
  8.12165487e+01  2.76223292e+02  9.03852281e+02  3.15613163e+03
  1.26352821e+04  4.12316709e+04  1.05259423e+05  2.30432250e+05
  4.56239544e+05  8.45185990e+05  1.52835763e+06  2.85061810e+06
  5.80849650e+06]
E1 = -706.6917170052105  E_coul = 198.7011108481216
cycle= 3 E= -507.990606157089  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00383538
diis-c [-3.28352025e-06  1.12135979e-04 -1.07557709e-01  1.10744557e+00]
  HOMO = -0.242953181753887  LUMO = 0.875950174491907
  mo_energy =
[-1.20326845e+02 -1.23810831e+01 -6.67808286e+00 -6.67808286e+00
 -6.67808286e+00 -1.17950399e+00 -2.42953182e-01 -2.42953182e-01
 -2.42953182e-01  8.75950174e-01  5.39216178e+00  2.21104275e+01
  8.12069269e+01  2.76212240e+02  9.03840328e+02  3.15611898e+03
  1.26352690e+04  4.12316576e+04  1.05259410e+05  2.30432237e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6764106384863  E_coul = 198.6857994077285
cycle= 4 E= -507.990611230758  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173534
diis-c [-5.77929023e-10 -9.52058687e-06  6.87256867e-03 -9.74668414e-02
  1.09060379e+00]
  HOMO = -0.243101035615063  LUMO = 0.875906014345383
  mo_energy =
[-1.20327181e+02 -1.23814169e+01 -6.67841195e+00 -6.67841195e+00
 -6.67841195e+00 -1.17959360e+00 -2.43101036e-01 -2.43101036e-01
 -2.43101036e-01  8.75906014e-01  5.39196106e+00  2.21101300e+01
  8.12065981e+01  2.76211905e+02  9.03839991e+02  3.15611864e+03
  1.26352687e+04  4.12316573e+04  1.05259410e+05  2.30432237e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6756978517874  E_coul = 198.68508660682
cycle= 5 E= -507.990611244967  delta_E= -1.42e-08  |g|= 6.03e-06  |ddm|= 0.000679
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.67253e-06
diis-c [-9.56703749e-13  6.17235083e-07 -5.66029564e-04  7.64754532e-03
 -9.18286289e-02  1.08474650e+00]
  HOMO = -0.243103794015108  LUMO = 0.875905237035754
  mo_energy =
[-1.20327188e+02 -1.23814222e+01 -6.67841735e+00 -6.67841735e+00
 -6.67841735e+00 -1.17959549e+00 -2.43103794e-01 -2.43103794e-01
 -2.43103794e-01  8.75905237e-01  5.39195726e+00  2.21101250e+01
  8.12065926e+01  2.76211899e+02  9.03839984e+02  3.15611863e+03
  1.26352687e+04  4.12316573e+04  1.05259410e+05  2.30432236e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6756838723604  E_coul = 198.68507262738441
cycle= 6 E= -507.990611244976  delta_E= -8.58e-12  |g|= 9.1e-08  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6756838723604  E_coul = 198.68507262738441
  HOMO = -0.243103836489831  LUMO = 0.875905212438116
  mo_energy =
[-1.20327188e+02 -1.23814223e+01 -6.67841743e+00 -6.67841743e+00
 -6.67841743e+00 -1.17959551e+00 -2.43103836e-01 -2.43103836e-01
 -2.43103836e-01  8.75905212e-01  5.39195720e+00  2.21101249e+01
  8.12065925e+01  2.76211899e+02  9.03839984e+02  3.15611863e+03
  1.26352687e+04  4.12316573e+04  1.05259410e+05  2.30432236e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6756836859204  E_coul = 198.68507244094477
Extra cycle  E= -507.990611244976  delta_E= 3.41e-13  |g|= 1.14e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      8.29 sec, wall time      0.58 sec
exp = [2.28543323e-01 5.95660742e-01 1.79928876e+00 1.17616813e+05
 4.02328550e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230133e+03
 1.83757706e+04 1.44368068e+03 4.17387526e+02 1.47772759e+02
 5.84413389e+01 2.47351359e+01 9.02286337e+00 8.60427446e+00
 4.92750158e-01]
E = -507.99061124497564
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228543323341       1
[INPUT] 0    0    [1    /1   ]  0.595660741968       1
[INPUT] 0    0    [1    /1   ]  1.79928876081        1
[INPUT] 0    0    [1    /1   ]  117616.812865        1
[INPUT] 0    0    [1    /1   ]  4.02328549809        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991309        1
[INPUT] 0    0    [1    /1   ]  73510.4174868        1
[INPUT] 0    0    [1    /1   ]  36754.7012149        1
[INPUT] 0    0    [1    /1   ]  7302.30132974        1
[INPUT] 0    0    [1    /1   ]  18375.7705557        1
[INPUT] 0    0    [1    /1   ]  1443.68068319        1
[INPUT] 0    0    [1    /1   ]  417.387525648        1
[INPUT] 0    0    [1    /1   ]  147.77275933         1
[INPUT] 0    0    [1    /1   ]  58.4413388824        1
[INPUT] 0    0    [1    /1   ]  24.7351358841        1
[INPUT] 0    0    [1    /1   ]  9.02286337396        1
[INPUT] 1    0    [1    /1   ]  8.60427445847        1
[INPUT] 1    0    [1    /1   ]  0.492750158248       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22854332334077881, 1.0]], [0, [0.5956607419680576, 1.0]], [0, [1.7992887608103287, 1.0]], [0, [117616.81286543907, 1.0]], [0, [4.023285498090235, 1.0]], [0, [1176168.1426132924, 1.0]], [0, [588084.0699558686, 1.0]], [0, [294042.0309177027, 1.0]], [0, [147020.9913085692, 1.0]], [0, [73510.4174868015, 1.0]], [0, [36754.70121489811, 1.0]], [0, [7302.3013297433545, 1.0]], [0, [18375.770555737734, 1.0]], [0, [1443.6806831945905, 1.0]], [0, [417.38752564787956, 1.0]], [0, [147.77275932956985, 1.0]], [0, [58.441338882446736, 1.0]], [0, [24.73513588408461, 1.0]], [0, [9.022863373955273, 1.0]], [1, [8.604274458471057, 1.0]], [1, [0.4927501582477264, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22854332]
bas 1, expnt(s) = [0.59566074]
bas 2, expnt(s) = [1.79928876]
bas 3, expnt(s) = [117616.81286544]
bas 4, expnt(s) = [4.0232855]
bas 5, expnt(s) = [1176168.14261329]
bas 6, expnt(s) = [588084.06995587]
bas 7, expnt(s) = [294042.0309177]
bas 8, expnt(s) = [147020.99130857]
bas 9, expnt(s) = [73510.4174868]
bas 10, expnt(s) = [36754.7012149]
bas 11, expnt(s) = [7302.30132974]
bas 12, expnt(s) = [18375.77055574]
bas 13, expnt(s) = [1443.68068319]
bas 14, expnt(s) = [417.38752565]
bas 15, expnt(s) = [147.77275933]
bas 16, expnt(s) = [58.44133888]
bas 17, expnt(s) = [24.73513588]
bas 18, expnt(s) = [9.02286337]
bas 19, expnt(s) = [8.60427446]
bas 20, expnt(s) = [0.49275016]
CPU time:       962.26
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28543323e-01 8.35105662e-01 5.95660742e-01 1.71302720e+00
 1.79928876e+00 3.92500916e+00 1.17616813e+05 1.60460108e+04
 4.02328550e+00 7.17712753e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30230133e+03 1.99576700e+03
 1.83757706e+04 3.98748621e+03 1.44368068e+03 5.91722909e+02
 4.17387526e+02 2.33302624e+02 1.47772759e+02 1.07080604e+02
 5.84413389e+01 5.34017073e+01 2.47351359e+01 2.80221046e+01
 9.02286337e+00 1.31529543e+01 8.60427446e+00 4.29909667e+01
 4.92750158e-01 1.20439199e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336085670949153
cond(S) = 912630.0559105778
E1 = -689.5969266194724  E_coul = 184.97160524049005
init E= -504.625321378982
    CPU time for initialize scf      7.44 sec, wall time      0.36 sec
  HOMO = -0.672170761495942  LUMO = 0.534940407516521
  mo_energy =
[-1.21709767e+02 -1.33862945e+01 -7.62358492e+00 -7.62358492e+00
 -7.62358492e+00 -1.65758790e+00 -6.72170761e-01 -6.72170761e-01
 -6.72170761e-01  5.34940408e-01  4.80348236e+00  2.12270069e+01
  8.00303096e+01  2.74875649e+02  9.02481381e+02  3.15483430e+03
  1.26341015e+04  4.12305613e+04  1.05258352e+05  2.30431204e+05
  4.56238516e+05  8.45184976e+05  1.52835663e+06  2.85061711e+06
  5.80849552e+06]
E1 = -707.7553085258215  E_coul = 199.78278328287985
cycle= 1 E= -507.972525242942  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.759064
diis-c [-0.57617816  1.        ]
  HOMO = -0.217620384993532  LUMO = 0.88032924067083
  mo_energy =
[-1.20200094e+02 -1.23047173e+01 -6.59396282e+00 -6.59396282e+00
 -6.59396282e+00 -1.16332181e+00 -2.17620385e-01 -2.17620385e-01
 -2.17620385e-01  8.80329241e-01  5.42417714e+00  2.21747970e+01
  8.13004266e+01  2.76328064e+02  9.03972963e+02  3.15626667e+03
  1.26354274e+04  4.12318201e+04  1.05259574e+05  2.30432402e+05
  4.56239696e+05  8.45186143e+05  1.52835778e+06  2.85061826e+06
  5.80849666e+06]
E1 = -706.800216562341  E_coul = 198.80987297993386
cycle= 2 E= -507.990343582407  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.392
    CPU time for cycle= 2      0.12 sec, wall time      0.03 sec
diis-norm(errvec)=0.0349316
diis-c [-0.00121487 -0.00305707  1.00305707]
  HOMO = -0.239803799467997  LUMO = 0.876691830064447
  mo_energy =
[-1.20315127e+02 -1.23725375e+01 -6.66905674e+00 -6.66905674e+00
 -6.66905674e+00 -1.17759552e+00 -2.39803799e-01 -2.39803799e-01
 -2.39803799e-01  8.76691830e-01  5.39630161e+00  2.21177887e+01
  8.12165487e+01  2.76223292e+02  9.03852281e+02  3.15613163e+03
  1.26352821e+04  4.12316709e+04  1.05259423e+05  2.30432250e+05
  4.56239544e+05  8.45185990e+05  1.52835763e+06  2.85061810e+06
  5.80849650e+06]
E1 = -706.6917170052105  E_coul = 198.7011108481216
cycle= 3 E= -507.990606157089  delta_E= -0.000263  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00383538
diis-c [-3.28352025e-06  1.12135979e-04 -1.07557709e-01  1.10744557e+00]
  HOMO = -0.242953181753887  LUMO = 0.875950174491907
  mo_energy =
[-1.20326845e+02 -1.23810831e+01 -6.67808286e+00 -6.67808286e+00
 -6.67808286e+00 -1.17950399e+00 -2.42953182e-01 -2.42953182e-01
 -2.42953182e-01  8.75950174e-01  5.39216178e+00  2.21104275e+01
  8.12069269e+01  2.76212240e+02  9.03840328e+02  3.15611898e+03
  1.26352690e+04  4.12316576e+04  1.05259410e+05  2.30432237e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6764106384863  E_coul = 198.6857994077285
cycle= 4 E= -507.990611230758  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173534
diis-c [-5.77929023e-10 -9.52058687e-06  6.87256867e-03 -9.74668414e-02
  1.09060379e+00]
  HOMO = -0.243101035615063  LUMO = 0.875906014345383
  mo_energy =
[-1.20327181e+02 -1.23814169e+01 -6.67841195e+00 -6.67841195e+00
 -6.67841195e+00 -1.17959360e+00 -2.43101036e-01 -2.43101036e-01
 -2.43101036e-01  8.75906014e-01  5.39196106e+00  2.21101300e+01
  8.12065981e+01  2.76211905e+02  9.03839991e+02  3.15611864e+03
  1.26352687e+04  4.12316573e+04  1.05259410e+05  2.30432237e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6756978517874  E_coul = 198.68508660682
cycle= 5 E= -507.990611244967  delta_E= -1.42e-08  |g|= 6.03e-06  |ddm|= 0.000679
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.67253e-06
diis-c [-9.56703749e-13  6.17235083e-07 -5.66029564e-04  7.64754532e-03
 -9.18286289e-02  1.08474650e+00]
  HOMO = -0.243103794015108  LUMO = 0.875905237035754
  mo_energy =
[-1.20327188e+02 -1.23814222e+01 -6.67841735e+00 -6.67841735e+00
 -6.67841735e+00 -1.17959549e+00 -2.43103794e-01 -2.43103794e-01
 -2.43103794e-01  8.75905237e-01  5.39195726e+00  2.21101250e+01
  8.12065926e+01  2.76211899e+02  9.03839984e+02  3.15611863e+03
  1.26352687e+04  4.12316573e+04  1.05259410e+05  2.30432236e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6756838723604  E_coul = 198.68507262738441
cycle= 6 E= -507.990611244976  delta_E= -8.58e-12  |g|= 9.1e-08  |ddm|= 1.83e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6756838723604  E_coul = 198.68507262738441
  HOMO = -0.243103836489831  LUMO = 0.875905212438116
  mo_energy =
[-1.20327188e+02 -1.23814223e+01 -6.67841743e+00 -6.67841743e+00
 -6.67841743e+00 -1.17959551e+00 -2.43103836e-01 -2.43103836e-01
 -2.43103836e-01  8.75905212e-01  5.39195720e+00  2.21101249e+01
  8.12065925e+01  2.76211899e+02  9.03839984e+02  3.15611863e+03
  1.26352687e+04  4.12316573e+04  1.05259410e+05  2.30432236e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6756836859204  E_coul = 198.68507244094477
Extra cycle  E= -507.990611244976  delta_E= 3.41e-13  |g|= 1.14e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      8.32 sec, wall time      0.58 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912630.0559105778
E1 = -706.6756836859204  E_coul = 198.68507244094477
init E= -507.990611244976
    CPU time for initialize scf     17.27 sec, wall time      0.76 sec
  HOMO = -0.243103842560074  LUMO = 0.875905211158344
  mo_energy =
[-1.20327188e+02 -1.23814223e+01 -6.67841745e+00 -6.67841745e+00
 -6.67841745e+00 -1.17959551e+00 -2.43103843e-01 -2.43103843e-01
 -2.43103843e-01  8.75905211e-01  5.39195719e+00  2.21101249e+01
  8.12065925e+01  2.76211899e+02  9.03839984e+02  3.15611863e+03
  1.26352687e+04  4.12316573e+04  1.05259410e+05  2.30432236e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.6756836542515  E_coul = 198.68507240927565
cycle= 1 E= -507.990611244976  delta_E= -2.27e-13  |g|= 2.42e-09  |ddm|= 3.14e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6756836542515  E_coul = 198.68507240927565
  HOMO = -0.243103843536371  LUMO = 0.875905210511431
  mo_energy =
[-1.20327188e+02 -1.23814223e+01 -6.67841745e+00 -6.67841745e+00
 -6.67841745e+00 -1.17959551e+00 -2.43103844e-01 -2.43103844e-01
 -2.43103844e-01  8.75905211e-01  5.39195719e+00  2.21101249e+01
  8.12065925e+01  2.76211899e+02  9.03839984e+02  3.15611863e+03
  1.26352687e+04  4.12316573e+04  1.05259410e+05  2.30432236e+05
  4.56239530e+05  8.45185977e+05  1.52835762e+06  2.85061809e+06
  5.80849649e+06]
E1 = -706.675683651714  E_coul = 198.68507240673813
Extra cycle  E= -507.990611244976  delta_E= -5.68e-14  |g|= 1.36e-09  |ddm|= 3.2e-09
    CPU time for scf_cycle     17.79 sec, wall time      0.92 sec
exp = [2.28543323e-01 5.95660742e-01 1.79928876e+00 1.17616813e+05
 4.02328550e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230133e+03
 1.83757706e+04 1.44368068e+03 4.17387526e+02 1.47772759e+02
 5.84413389e+01 2.47351359e+01 9.02286337e+00 8.60427446e+00
 4.92750158e-01]
grad_E = [ 1.14596709e-04 -6.58296100e-05 -1.72559813e-05  6.04903202e-09
  1.38837286e-05  4.02920612e-11  1.73720667e-10  9.38274933e-10
  3.70694962e-09  1.54791286e-08  8.07541660e-08  5.09022613e-06
  1.97819109e-07 -3.80540194e-05 -1.00118068e-05  2.31902551e-05
 -8.08433166e-05  1.37892020e-05  7.97248344e-06 -6.55150367e-06
 -6.99832076e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228827831009       1
[INPUT] 0    0    [1    /1   ]  0.596728232354       1
[INPUT] 0    0    [1    /1   ]  1.80936377977        1
[INPUT] 0    0    [1    /1   ]  117616.812865        1
[INPUT] 0    0    [1    /1   ]  4.03844209391        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991308        1
[INPUT] 0    0    [1    /1   ]  73510.4174853        1
[INPUT] 0    0    [1    /1   ]  36754.7012069        1
[INPUT] 0    0    [1    /1   ]  7302.30082254        1
[INPUT] 0    0    [1    /1   ]  18375.770536         1
[INPUT] 0    0    [1    /1   ]  1443.68449127        1
[INPUT] 0    0    [1    /1   ]  417.388313133        1
[INPUT] 0    0    [1    /1   ]  147.771710906        1
[INPUT] 0    0    [1    /1   ]  58.4437769759        1
[INPUT] 0    0    [1    /1   ]  24.7379171795        1
[INPUT] 0    0    [1    /1   ]  9.04847781796        1
[INPUT] 1    0    [1    /1   ]  8.60429724519        1
[INPUT] 1    0    [1    /1   ]  0.492753233394       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2288278310089462, 1.0]], [0, [0.5967282323536176, 1.0]], [0, [1.8093637797699351, 1.0]], [0, [117616.81286483626, 1.0]], [0, [4.038442093908245, 1.0]], [0, [1176168.1426132885, 1.0]], [0, [588084.0699558513, 1.0]], [0, [294042.0309176092, 1.0]], [0, [147020.9913081998, 1.0]], [0, [73510.41748525888, 1.0]], [0, [36754.701206851125, 1.0]], [0, [7302.300822535182, 1.0]], [0, [18375.770536016917, 1.0]], [0, [1443.684491272179, 1.0]], [0, [417.3883131325399, 1.0]], [0, [147.77171090557385, 1.0]], [0, [58.443776975928884, 1.0]], [0, [24.737917179467434, 1.0]], [0, [9.048477817964544, 1.0]], [1, [8.604297245194616, 1.0]], [1, [0.4927532333936817, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22882783]
bas 1, expnt(s) = [0.59672823]
bas 2, expnt(s) = [1.80936378]
bas 3, expnt(s) = [117616.81286484]
bas 4, expnt(s) = [4.03844209]
bas 5, expnt(s) = [1176168.14261329]
bas 6, expnt(s) = [588084.06995585]
bas 7, expnt(s) = [294042.03091761]
bas 8, expnt(s) = [147020.9913082]
bas 9, expnt(s) = [73510.41748526]
bas 10, expnt(s) = [36754.70120685]
bas 11, expnt(s) = [7302.30082254]
bas 12, expnt(s) = [18375.77053602]
bas 13, expnt(s) = [1443.68449127]
bas 14, expnt(s) = [417.38831313]
bas 15, expnt(s) = [147.77171091]
bas 16, expnt(s) = [58.44377698]
bas 17, expnt(s) = [24.73791718]
bas 18, expnt(s) = [9.04847782]
bas 19, expnt(s) = [8.60429725]
bas 20, expnt(s) = [0.49275323]
CPU time:       995.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28827831e-01 8.35885241e-01 5.96728232e-01 1.71532913e+00
 1.80936378e+00 3.94148106e+00 1.17616813e+05 1.60460108e+04
 4.03844209e+00 7.19739635e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30230082e+03 1.99576689e+03
 1.83757705e+04 3.98748620e+03 1.44368449e+03 5.91724079e+02
 4.17388313e+02 2.33302954e+02 1.47771711e+02 1.07080034e+02
 5.84437770e+01 5.34033782e+01 2.47379172e+01 2.80244677e+01
 9.04847782e+00 1.31809487e+01 8.60429725e+00 4.29911091e+01
 4.92753233e-01 1.20440138e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608043363108
cond(S) = 912636.0921317948
E1 = -689.5971402411222  E_coul = 184.971794996248
init E= -504.625345244874
    CPU time for initialize scf      7.40 sec, wall time      0.36 sec
  HOMO = -0.672167443479994  LUMO = 0.536943775443849
  mo_energy =
[-1.21709738e+02 -1.33862808e+01 -7.62357278e+00 -7.62357278e+00
 -7.62357278e+00 -1.65758255e+00 -6.72167443e-01 -6.72167443e-01
 -6.72167443e-01  5.36943775e-01  4.82966262e+00  2.13319425e+01
  8.02276305e+01  2.75102167e+02  9.02699132e+02  3.15503647e+03
  1.26342883e+04  4.12307372e+04  1.05258521e+05  2.30431369e+05
  4.56238677e+05  8.45185134e+05  1.52835678e+06  2.85061726e+06
  5.80849567e+06]
E1 = -707.7555149883968  E_coul = 199.78298913716918
cycle= 1 E= -507.972525851228  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.759193
diis-c [-0.57637421  1.        ]
  HOMO = -0.217615234387975  LUMO = 0.88283478569671
  mo_energy =
[-1.20200064e+02 -1.23047031e+01 -6.59395033e+00 -6.59395033e+00
 -6.59395033e+00 -1.16331633e+00 -2.17615234e-01 -2.17615234e-01
 -2.17615234e-01  8.82834786e-01  5.45171461e+00  2.22807800e+01
  8.14978972e+01  2.76554551e+02  9.04190702e+02  3.15646884e+03
  1.26356143e+04  4.12319959e+04  1.05259743e+05  2.30432566e+05
  4.56239857e+05  8.45186301e+05  1.52835794e+06  2.85061841e+06
  5.80849681e+06]
E1 = -706.8004597578367  E_coul = 198.81011595715816
cycle= 2 E= -507.990343800679  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.392
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.03489
diis-c [-0.00121204 -0.00303697  1.00303697]
  HOMO = -0.239797115586262  LUMO = 0.879175611583285
  mo_energy =
[-1.20315091e+02 -1.23725191e+01 -6.66903988e+00 -6.66903988e+00
 -6.66903988e+00 -1.17758880e+00 -2.39797116e-01 -2.39797116e-01
 -2.39797116e-01  8.79175612e-01  5.42372316e+00  2.22236844e+01
  8.14140040e+01  2.76449786e+02  9.04070027e+02  3.15633381e+03
  1.26354690e+04  4.12318468e+04  1.05259592e+05  2.30432415e+05
  4.56239705e+05  8.45186149e+05  1.52835779e+06  2.85061825e+06
  5.80849665e+06]
E1 = -706.6919848967499  E_coul = 198.70137862610244
cycle= 3 E= -507.990606270647  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382697
diis-c [-3.27665482e-06  1.13935085e-04 -1.07401930e-01  1.10728799e+00]
  HOMO = -0.24294537176235  LUMO = 0.878430813785488
  mo_energy =
[-1.20326808e+02 -1.23810629e+01 -6.67806415e+00 -6.67806415e+00
 -6.67806415e+00 -1.17949651e+00 -2.42945372e-01 -2.42945372e-01
 -2.42945372e-01  8.78430814e-01  5.41956970e+00  2.22163160e+01
  8.14043824e+01  2.76438736e+02  9.04058076e+02  3.15632116e+03
  1.26354559e+04  4.12318335e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.6766875055677  E_coul = 198.68607616759758
cycle= 4 E= -507.99061133797  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173486
diis-c [-5.71180994e-10 -9.49342883e-06  6.86803566e-03 -9.75667728e-02
  1.09070823e+00]
  HOMO = -0.243093501335405  LUMO = 0.878386451201157
  mo_energy =
[-1.20327146e+02 -1.23813976e+01 -6.67839436e+00 -6.67839436e+00
 -6.67839436e+00 -1.17958627e+00 -2.43093501e-01 -2.43093501e-01
 -2.43093501e-01  8.78386451e-01  5.41936803e+00  2.22160173e+01
  8.14040524e+01  2.76438399e+02  9.04057737e+02  3.15632082e+03
  1.26354555e+04  4.12318332e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.675973646267  E_coul = 198.68536229409142
cycle= 5 E= -507.990611352176  delta_E= -1.42e-08  |g|= 5.98e-06  |ddm|= 0.000677
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.6481e-06
diis-c [-9.49868622e-13  6.13644781e-07 -5.62033823e-04  7.60620585e-03
 -9.12391838e-02  1.08419440e+00]
  HOMO = -0.243096239454415  LUMO = 0.878385681905261
  mo_energy =
[-1.20327152e+02 -1.23814029e+01 -6.67839973e+00 -6.67839973e+00
 -6.67839973e+00 -1.17958815e+00 -2.43096239e-01 -2.43096239e-01
 -2.43096239e-01  8.78385682e-01  5.41936425e+00  2.22160124e+01
  8.14040468e+01  2.76438393e+02  9.04057731e+02  3.15632081e+03
  1.26354555e+04  4.12318332e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.6759597754152  E_coul = 198.68534842323226
cycle= 6 E= -507.990611352183  delta_E= -7.33e-12  |g|= 9.1e-08  |ddm|= 1.8e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759597754152  E_coul = 198.68534842323226
  HOMO = -0.243096282070355  LUMO = 0.878385656211822
  mo_energy =
[-1.20327152e+02 -1.23814030e+01 -6.67839982e+00 -6.67839982e+00
 -6.67839982e+00 -1.17958817e+00 -2.43096282e-01 -2.43096282e-01
 -2.43096282e-01  8.78385656e-01  5.41936419e+00  2.22160123e+01
  8.14040468e+01  2.76438393e+02  9.04057731e+02  3.15632081e+03
  1.26354555e+04  4.12318332e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.6759595921756  E_coul = 198.6853482399921
Extra cycle  E= -507.990611352183  delta_E= -5.12e-13  |g|= 1.19e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      8.25 sec, wall time      0.58 sec
exp = [2.28827831e-01 5.96728232e-01 1.80936378e+00 1.17616813e+05
 4.03844209e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230082e+03
 1.83757705e+04 1.44368449e+03 4.17388313e+02 1.47771711e+02
 5.84437770e+01 2.47379172e+01 9.04847782e+00 8.60429725e+00
 4.92753233e-01]
E = -507.99061135218346
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228827831009       1
[INPUT] 0    0    [1    /1   ]  0.596728232354       1
[INPUT] 0    0    [1    /1   ]  1.80936377977        1
[INPUT] 0    0    [1    /1   ]  117616.812865        1
[INPUT] 0    0    [1    /1   ]  4.03844209391        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030918        1
[INPUT] 0    0    [1    /1   ]  147020.991308        1
[INPUT] 0    0    [1    /1   ]  73510.4174853        1
[INPUT] 0    0    [1    /1   ]  36754.7012069        1
[INPUT] 0    0    [1    /1   ]  7302.30082254        1
[INPUT] 0    0    [1    /1   ]  18375.770536         1
[INPUT] 0    0    [1    /1   ]  1443.68449127        1
[INPUT] 0    0    [1    /1   ]  417.388313133        1
[INPUT] 0    0    [1    /1   ]  147.771710906        1
[INPUT] 0    0    [1    /1   ]  58.4437769759        1
[INPUT] 0    0    [1    /1   ]  24.7379171795        1
[INPUT] 0    0    [1    /1   ]  9.04847781796        1
[INPUT] 1    0    [1    /1   ]  8.60429724519        1
[INPUT] 1    0    [1    /1   ]  0.492753233394       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2288278310089462, 1.0]], [0, [0.5967282323536176, 1.0]], [0, [1.8093637797699351, 1.0]], [0, [117616.81286483626, 1.0]], [0, [4.038442093908245, 1.0]], [0, [1176168.1426132885, 1.0]], [0, [588084.0699558513, 1.0]], [0, [294042.0309176092, 1.0]], [0, [147020.9913081998, 1.0]], [0, [73510.41748525888, 1.0]], [0, [36754.701206851125, 1.0]], [0, [7302.300822535182, 1.0]], [0, [18375.770536016917, 1.0]], [0, [1443.684491272179, 1.0]], [0, [417.3883131325399, 1.0]], [0, [147.77171090557385, 1.0]], [0, [58.443776975928884, 1.0]], [0, [24.737917179467434, 1.0]], [0, [9.048477817964544, 1.0]], [1, [8.604297245194616, 1.0]], [1, [0.4927532333936817, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22882783]
bas 1, expnt(s) = [0.59672823]
bas 2, expnt(s) = [1.80936378]
bas 3, expnt(s) = [117616.81286484]
bas 4, expnt(s) = [4.03844209]
bas 5, expnt(s) = [1176168.14261329]
bas 6, expnt(s) = [588084.06995585]
bas 7, expnt(s) = [294042.03091761]
bas 8, expnt(s) = [147020.9913082]
bas 9, expnt(s) = [73510.41748526]
bas 10, expnt(s) = [36754.70120685]
bas 11, expnt(s) = [7302.30082254]
bas 12, expnt(s) = [18375.77053602]
bas 13, expnt(s) = [1443.68449127]
bas 14, expnt(s) = [417.38831313]
bas 15, expnt(s) = [147.77171091]
bas 16, expnt(s) = [58.44377698]
bas 17, expnt(s) = [24.73791718]
bas 18, expnt(s) = [9.04847782]
bas 19, expnt(s) = [8.60429725]
bas 20, expnt(s) = [0.49275323]
CPU time:      1003.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28827831e-01 8.35885241e-01 5.96728232e-01 1.71532913e+00
 1.80936378e+00 3.94148106e+00 1.17616813e+05 1.60460108e+04
 4.03844209e+00 7.19739635e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30230082e+03 1.99576689e+03
 1.83757705e+04 3.98748620e+03 1.44368449e+03 5.91724079e+02
 4.17388313e+02 2.33302954e+02 1.47771711e+02 1.07080034e+02
 5.84437770e+01 5.34033782e+01 2.47379172e+01 2.80244677e+01
 9.04847782e+00 1.31809487e+01 8.60429725e+00 4.29911091e+01
 4.92753233e-01 1.20440138e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608043363108
cond(S) = 912636.0921317948
E1 = -689.5971402411222  E_coul = 184.971794996248
init E= -504.625345244874
    CPU time for initialize scf      7.62 sec, wall time      0.37 sec
  HOMO = -0.672167443479994  LUMO = 0.536943775443849
  mo_energy =
[-1.21709738e+02 -1.33862808e+01 -7.62357278e+00 -7.62357278e+00
 -7.62357278e+00 -1.65758255e+00 -6.72167443e-01 -6.72167443e-01
 -6.72167443e-01  5.36943775e-01  4.82966262e+00  2.13319425e+01
  8.02276305e+01  2.75102167e+02  9.02699132e+02  3.15503647e+03
  1.26342883e+04  4.12307372e+04  1.05258521e+05  2.30431369e+05
  4.56238677e+05  8.45185134e+05  1.52835678e+06  2.85061726e+06
  5.80849567e+06]
E1 = -707.7555149883968  E_coul = 199.78298913716918
cycle= 1 E= -507.972525851228  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.759193
diis-c [-0.57637421  1.        ]
  HOMO = -0.217615234387975  LUMO = 0.88283478569671
  mo_energy =
[-1.20200064e+02 -1.23047031e+01 -6.59395033e+00 -6.59395033e+00
 -6.59395033e+00 -1.16331633e+00 -2.17615234e-01 -2.17615234e-01
 -2.17615234e-01  8.82834786e-01  5.45171461e+00  2.22807800e+01
  8.14978972e+01  2.76554551e+02  9.04190702e+02  3.15646884e+03
  1.26356143e+04  4.12319959e+04  1.05259743e+05  2.30432566e+05
  4.56239857e+05  8.45186301e+05  1.52835794e+06  2.85061841e+06
  5.80849681e+06]
E1 = -706.8004597578367  E_coul = 198.81011595715816
cycle= 2 E= -507.990343800679  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.392
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.03489
diis-c [-0.00121204 -0.00303697  1.00303697]
  HOMO = -0.239797115586262  LUMO = 0.879175611583285
  mo_energy =
[-1.20315091e+02 -1.23725191e+01 -6.66903988e+00 -6.66903988e+00
 -6.66903988e+00 -1.17758880e+00 -2.39797116e-01 -2.39797116e-01
 -2.39797116e-01  8.79175612e-01  5.42372316e+00  2.22236844e+01
  8.14140040e+01  2.76449786e+02  9.04070027e+02  3.15633381e+03
  1.26354690e+04  4.12318468e+04  1.05259592e+05  2.30432415e+05
  4.56239705e+05  8.45186149e+05  1.52835779e+06  2.85061825e+06
  5.80849665e+06]
E1 = -706.6919848967499  E_coul = 198.70137862610244
cycle= 3 E= -507.990606270647  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382697
diis-c [-3.27665482e-06  1.13935085e-04 -1.07401930e-01  1.10728799e+00]
  HOMO = -0.24294537176235  LUMO = 0.878430813785488
  mo_energy =
[-1.20326808e+02 -1.23810629e+01 -6.67806415e+00 -6.67806415e+00
 -6.67806415e+00 -1.17949651e+00 -2.42945372e-01 -2.42945372e-01
 -2.42945372e-01  8.78430814e-01  5.41956970e+00  2.22163160e+01
  8.14043824e+01  2.76438736e+02  9.04058076e+02  3.15632116e+03
  1.26354559e+04  4.12318335e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.6766875055677  E_coul = 198.68607616759758
cycle= 4 E= -507.99061133797  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173486
diis-c [-5.71180994e-10 -9.49342883e-06  6.86803566e-03 -9.75667728e-02
  1.09070823e+00]
  HOMO = -0.243093501335405  LUMO = 0.878386451201157
  mo_energy =
[-1.20327146e+02 -1.23813976e+01 -6.67839436e+00 -6.67839436e+00
 -6.67839436e+00 -1.17958627e+00 -2.43093501e-01 -2.43093501e-01
 -2.43093501e-01  8.78386451e-01  5.41936803e+00  2.22160173e+01
  8.14040524e+01  2.76438399e+02  9.04057737e+02  3.15632082e+03
  1.26354555e+04  4.12318332e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.675973646267  E_coul = 198.68536229409142
cycle= 5 E= -507.990611352176  delta_E= -1.42e-08  |g|= 5.98e-06  |ddm|= 0.000677
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.6481e-06
diis-c [-9.49868622e-13  6.13644781e-07 -5.62033823e-04  7.60620585e-03
 -9.12391838e-02  1.08419440e+00]
  HOMO = -0.243096239454415  LUMO = 0.878385681905261
  mo_energy =
[-1.20327152e+02 -1.23814029e+01 -6.67839973e+00 -6.67839973e+00
 -6.67839973e+00 -1.17958815e+00 -2.43096239e-01 -2.43096239e-01
 -2.43096239e-01  8.78385682e-01  5.41936425e+00  2.22160124e+01
  8.14040468e+01  2.76438393e+02  9.04057731e+02  3.15632081e+03
  1.26354555e+04  4.12318332e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.6759597754152  E_coul = 198.68534842323226
cycle= 6 E= -507.990611352183  delta_E= -7.33e-12  |g|= 9.1e-08  |ddm|= 1.8e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759597754152  E_coul = 198.68534842323226
  HOMO = -0.243096282070355  LUMO = 0.878385656211822
  mo_energy =
[-1.20327152e+02 -1.23814030e+01 -6.67839982e+00 -6.67839982e+00
 -6.67839982e+00 -1.17958817e+00 -2.43096282e-01 -2.43096282e-01
 -2.43096282e-01  8.78385656e-01  5.41936419e+00  2.22160123e+01
  8.14040468e+01  2.76438393e+02  9.04057731e+02  3.15632081e+03
  1.26354555e+04  4.12318332e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.6759595921756  E_coul = 198.6853482399921
Extra cycle  E= -507.990611352183  delta_E= -5.12e-13  |g|= 1.19e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      8.48 sec, wall time      0.58 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912636.0921317948
E1 = -706.6759595921756  E_coul = 198.6853482399921
init E= -507.990611352183
    CPU time for initialize scf     17.09 sec, wall time      0.75 sec
  HOMO = -0.243096288059361  LUMO = 0.878385654466466
  mo_energy =
[-1.20327152e+02 -1.23814030e+01 -6.67839983e+00 -6.67839983e+00
 -6.67839983e+00 -1.17958817e+00 -2.43096288e-01 -2.43096288e-01
 -2.43096288e-01  8.78385654e-01  5.41936418e+00  2.22160123e+01
  8.14040467e+01  2.76438393e+02  9.04057731e+02  3.15632081e+03
  1.26354555e+04  4.12318332e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.6759595606841  E_coul = 198.68534820850093
cycle= 1 E= -507.990611352183  delta_E= 3.41e-13  |g|= 1.87e-09  |ddm|= 3.16e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6759595606841  E_coul = 198.68534820850093
  HOMO = -0.243096289028172  LUMO = 0.878385652886972
  mo_energy =
[-1.20327152e+02 -1.23814030e+01 -6.67839983e+00 -6.67839983e+00
 -6.67839983e+00 -1.17958817e+00 -2.43096289e-01 -2.43096289e-01
 -2.43096289e-01  8.78385653e-01  5.41936418e+00  2.22160123e+01
  8.14040467e+01  2.76438393e+02  9.04057731e+02  3.15632081e+03
  1.26354555e+04  4.12318332e+04  1.05259579e+05  2.30432401e+05
  4.56239691e+05  8.45186135e+05  1.52835777e+06  2.85061824e+06
  5.80849664e+06]
E1 = -706.6759595584707  E_coul = 198.68534820628753
Extra cycle  E= -507.990611352183  delta_E= -5.68e-14  |g|= 1.19e-09  |ddm|= 2.62e-09
    CPU time for scf_cycle     17.62 sec, wall time      0.91 sec
exp = [2.28827831e-01 5.96728232e-01 1.80936378e+00 1.17616813e+05
 4.03844209e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230082e+03
 1.83757705e+04 1.44368449e+03 4.17388313e+02 1.47771711e+02
 5.84437770e+01 2.47379172e+01 9.04847782e+00 8.60429725e+00
 4.92753233e-01]
grad_E = [ 7.27778843e-05 -3.89612005e-05 -1.79294716e-05  6.04927016e-09
  1.33512479e-05  4.02947441e-11  1.73728471e-10  9.38311472e-10
  3.70709707e-09  1.54797524e-08  8.07571902e-08  5.09043605e-06
  1.97828876e-07 -3.80656547e-05 -9.91084052e-06  2.28600315e-05
 -8.06429286e-05  1.36513739e-05  1.00639844e-05  9.92220701e-06
  2.29812422e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229185192842       1
[INPUT] 0    0    [1    /1   ]  0.598100632936       1
[INPUT] 0    0    [1    /1   ]  1.82012420888        1
[INPUT] 0    0    [1    /1   ]  117616.812864        1
[INPUT] 0    0    [1    /1   ]  4.05727466814        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030917        1
[INPUT] 0    0    [1    /1   ]  147020.991308        1
[INPUT] 0    0    [1    /1   ]  73510.4174828        1
[INPUT] 0    0    [1    /1   ]  36754.7011942        1
[INPUT] 0    0    [1    /1   ]  7302.3000221         1
[INPUT] 0    0    [1    /1   ]  18375.7705049        1
[INPUT] 0    0    [1    /1   ]  1443.690495          1
[INPUT] 0    0    [1    /1   ]  417.389626296        1
[INPUT] 0    0    [1    /1   ]  147.769684144        1
[INPUT] 0    0    [1    /1   ]  58.4490662851        1
[INPUT] 0    0    [1    /1   ]  24.7413404211        1
[INPUT] 0    0    [1    /1   ]  9.08288519265        1
[INPUT] 1    0    [1    /1   ]  8.60433576213        1
[INPUT] 1    0    [1    /1   ]  0.492758335852       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2291851928423397, 1.0]], [0, [0.5981006329356158, 1.0]], [0, [1.8201242088826266, 1.0]], [0, [117616.81286388496, 1.0]], [0, [4.057274668138225, 1.0]], [0, [1176168.1426132822, 1.0]], [0, [588084.069955824, 1.0]], [0, [294042.03091746167, 1.0]], [0, [147020.99130761682, 1.0]], [0, [73510.4174828245, 1.0]], [0, [36754.7011941521, 1.0]], [0, [7302.300022101884, 1.0]], [0, [18375.77050489798, 1.0]], [0, [1443.690495000762, 1.0]], [0, [417.38962629646227, 1.0]], [0, [147.7696841439652, 1.0]], [0, [58.449066285083305, 1.0]], [0, [24.741340421085997, 1.0]], [0, [9.082885192652629, 1.0]], [1, [8.604335762131608, 1.0]], [1, [0.4927583358516177, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22918519]
bas 1, expnt(s) = [0.59810063]
bas 2, expnt(s) = [1.82012421]
bas 3, expnt(s) = [117616.81286388]
bas 4, expnt(s) = [4.05727467]
bas 5, expnt(s) = [1176168.14261328]
bas 6, expnt(s) = [588084.06995582]
bas 7, expnt(s) = [294042.03091746]
bas 8, expnt(s) = [147020.99130762]
bas 9, expnt(s) = [73510.41748282]
bas 10, expnt(s) = [36754.70119415]
bas 11, expnt(s) = [7302.3000221]
bas 12, expnt(s) = [18375.7705049]
bas 13, expnt(s) = [1443.690495]
bas 14, expnt(s) = [417.3896263]
bas 15, expnt(s) = [147.76968414]
bas 16, expnt(s) = [58.44906629]
bas 17, expnt(s) = [24.74134042]
bas 18, expnt(s) = [9.08288519]
bas 19, expnt(s) = [8.60433576]
bas 20, expnt(s) = [0.49275834]
CPU time:      1037.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29185193e-01 8.36864106e-01 5.98100633e-01 1.71828706e+00
 1.82012421e+00 3.95904824e+00 1.17616813e+05 1.60460108e+04
 4.05727467e+00 7.22255456e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30230002e+03 1.99576673e+03
 1.83757705e+04 3.98748620e+03 1.44369050e+03 5.91725925e+02
 4.17389626e+02 2.33303505e+02 1.47769684e+02 1.07078933e+02
 5.84490663e+01 5.34070030e+01 2.47413404e+01 2.80273762e+01
 9.08288519e+00 1.32185218e+01 8.60433576e+00 4.29913496e+01
 4.92758336e-01 1.20441697e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3360721827908
cond(S) = 912643.6353222328
E1 = -689.5974879723615  E_coul = 184.97212506938433
init E= -504.625362902977
    CPU time for initialize scf      7.61 sec, wall time      0.37 sec
  HOMO = -0.672161657314278  LUMO = 0.53941310485402
  mo_energy =
[-1.21709689e+02 -1.33862561e+01 -7.62355137e+00 -7.62355137e+00
 -7.62355137e+00 -1.65757438e+00 -6.72161657e-01 -6.72161657e-01
 -6.72161657e-01  5.39413105e-01  4.85997817e+00  2.14583479e+01
  8.04738604e+01  2.75390839e+02  9.02979782e+02  3.15529908e+03
  1.26345334e+04  4.12309686e+04  1.05258744e+05  2.30431585e+05
  4.56238888e+05  8.45185343e+05  1.52835699e+06  2.85061746e+06
  5.80849586e+06]
E1 = -707.7558906093093  E_coul = 199.78336417846296
cycle= 1 E= -507.972526430846  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.75934
diis-c [-0.57659785  1.        ]
  HOMO = -0.217605951685964  LUMO = 0.8859069285705
  mo_energy =
[-1.20200011e+02 -1.23046763e+01 -6.59392697e+00 -6.59392697e+00
 -6.59392697e+00 -1.16330716e+00 -2.17605952e-01 -2.17605952e-01
 -2.17605952e-01  8.85906929e-01  5.48359547e+00  2.24084952e+01
  8.17443387e+01  2.76843192e+02  9.04471339e+02  3.15673145e+03
  1.26358594e+04  4.12322274e+04  1.05259966e+05  2.30432783e+05
  4.56240069e+05  8.45186509e+05  1.52835814e+06  2.85061861e+06
  5.80849700e+06]
E1 = -706.8008720356453  E_coul = 198.81052785330542
cycle= 2 E= -507.99034418234  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348465
diis-c [-0.00120908 -0.00301403  1.00301403]
  HOMO = -0.239786192455201  LUMO = 0.882221867563451
  mo_energy =
[-1.20315032e+02 -1.23724880e+01 -6.66901198e+00 -6.66901198e+00
 -6.66901198e+00 -1.17757819e+00 -2.39786192e-01 -2.39786192e-01
 -2.39786192e-01  8.82221868e-01  5.45547007e+00  2.23512919e+01
  8.16604237e+01  2.76738434e+02  9.04350673e+02  3.15659642e+03
  1.26357141e+04  4.12320783e+04  1.05259815e+05  2.30432631e+05
  4.56239917e+05  8.45186357e+05  1.52835799e+06  2.85061846e+06
  5.80849685e+06]
E1 = -706.6924290824734  E_coul = 198.7018225674959
cycle= 3 E= -507.990606514977  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381787
diis-c [-3.26891799e-06  1.15748068e-04 -1.07229590e-01  1.10711384e+00]
  HOMO = -0.242933032147772  LUMO = 0.881473361179359
  mo_energy =
[-1.20326747e+02 -1.23810293e+01 -6.67803391e+00 -6.67803391e+00
 -6.67803391e+00 -1.17948494e+00 -2.42933032e-01 -2.42933032e-01
 -2.42933032e-01  8.81473361e-01  5.45130109e+00  2.23439147e+01
  8.16508023e+01  2.76727386e+02  9.04338723e+02  3.15658377e+03
  1.26357010e+04  4.12320650e+04  1.05259802e+05  2.30432618e+05
  4.56239903e+05  8.45186344e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.67714321609  E_coul = 198.68653164203798
cycle= 4 E= -507.990611574052  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173402
diis-c [-5.63175090e-10 -9.46777592e-06  6.86247884e-03 -9.76632301e-02
  1.09081022e+00]
  HOMO = -0.243081415170657  LUMO = 0.881428782512119
  mo_energy =
[-1.20327086e+02 -1.23813651e+01 -6.67836524e+00 -6.67836524e+00
 -6.67836524e+00 -1.17957484e+00 -2.43081415e-01 -2.43081415e-01
 -2.43081415e-01  8.81428783e-01  5.45109841e+00  2.23436149e+01
  8.16504711e+01  2.76727048e+02  9.04338383e+02  3.15658343e+03
  1.26357007e+04  4.12320647e+04  1.05259801e+05  2.30432617e+05
  4.56239903e+05  8.45186343e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.6764284554522  E_coul = 198.68581686721208
cycle= 5 E= -507.99061158824  delta_E= -1.42e-08  |g|= 5.91e-06  |ddm|= 0.000675
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.61814e-06
diis-c [-9.37212933e-13  6.09602890e-07 -5.58016451e-04  7.56557948e-03
 -9.06341304e-02  1.08362596e+00]
  HOMO = -0.243084129359892  LUMO = 0.881428014227009
  mo_energy =
[-1.20327092e+02 -1.23813704e+01 -6.67837058e+00 -6.67837058e+00
 -6.67837058e+00 -1.17957671e+00 -2.43084129e-01 -2.43084129e-01
 -2.43084129e-01  8.81428014e-01  5.45109466e+00  2.23436100e+01
  8.16504656e+01  2.76727042e+02  9.04338377e+02  3.15658342e+03
  1.26357007e+04  4.12320646e+04  1.05259801e+05  2.30432617e+05
  4.56239903e+05  8.45186343e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.6764147225301  E_coul = 198.685803134282
cycle= 6 E= -507.990611588248  delta_E= -8.07e-12  |g|= 9.2e-08  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6764147225301  E_coul = 198.685803134282
  HOMO = -0.243084172003534  LUMO = 0.881427989603228
  mo_energy =
[-1.20327093e+02 -1.23813704e+01 -6.67837066e+00 -6.67837066e+00
 -6.67837066e+00 -1.17957672e+00 -2.43084172e-01 -2.43084172e-01
 -2.43084172e-01  8.81427990e-01  5.45109460e+00  2.23436099e+01
  8.16504655e+01  2.76727042e+02  9.04338377e+02  3.15658342e+03
  1.26357007e+04  4.12320646e+04  1.05259801e+05  2.30432617e+05
  4.56239903e+05  8.45186343e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.6764145342776  E_coul = 198.68580294602975
Extra cycle  E= -507.990611588248  delta_E= 3.41e-13  |g|= 1.17e-08  |ddm|= 2.24e-07
    CPU time for scf_cycle      8.45 sec, wall time      0.59 sec
exp = [2.29185193e-01 5.98100633e-01 1.82012421e+00 1.17616813e+05
 4.05727467e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230002e+03
 1.83757705e+04 1.44369050e+03 4.17389626e+02 1.47769684e+02
 5.84490663e+01 2.47413404e+01 9.08288519e+00 8.60433576e+00
 4.92758336e-01]
E = -507.9906115882478
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229185192842       1
[INPUT] 0    0    [1    /1   ]  0.598100632936       1
[INPUT] 0    0    [1    /1   ]  1.82012420888        1
[INPUT] 0    0    [1    /1   ]  117616.812864        1
[INPUT] 0    0    [1    /1   ]  4.05727466814        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030917        1
[INPUT] 0    0    [1    /1   ]  147020.991308        1
[INPUT] 0    0    [1    /1   ]  73510.4174828        1
[INPUT] 0    0    [1    /1   ]  36754.7011942        1
[INPUT] 0    0    [1    /1   ]  7302.3000221         1
[INPUT] 0    0    [1    /1   ]  18375.7705049        1
[INPUT] 0    0    [1    /1   ]  1443.690495          1
[INPUT] 0    0    [1    /1   ]  417.389626296        1
[INPUT] 0    0    [1    /1   ]  147.769684144        1
[INPUT] 0    0    [1    /1   ]  58.4490662851        1
[INPUT] 0    0    [1    /1   ]  24.7413404211        1
[INPUT] 0    0    [1    /1   ]  9.08288519265        1
[INPUT] 1    0    [1    /1   ]  8.60433576213        1
[INPUT] 1    0    [1    /1   ]  0.492758335852       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2291851928423397, 1.0]], [0, [0.5981006329356158, 1.0]], [0, [1.8201242088826266, 1.0]], [0, [117616.81286388496, 1.0]], [0, [4.057274668138225, 1.0]], [0, [1176168.1426132822, 1.0]], [0, [588084.069955824, 1.0]], [0, [294042.03091746167, 1.0]], [0, [147020.99130761682, 1.0]], [0, [73510.4174828245, 1.0]], [0, [36754.7011941521, 1.0]], [0, [7302.300022101884, 1.0]], [0, [18375.77050489798, 1.0]], [0, [1443.690495000762, 1.0]], [0, [417.38962629646227, 1.0]], [0, [147.7696841439652, 1.0]], [0, [58.449066285083305, 1.0]], [0, [24.741340421085997, 1.0]], [0, [9.082885192652629, 1.0]], [1, [8.604335762131608, 1.0]], [1, [0.4927583358516177, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22918519]
bas 1, expnt(s) = [0.59810063]
bas 2, expnt(s) = [1.82012421]
bas 3, expnt(s) = [117616.81286388]
bas 4, expnt(s) = [4.05727467]
bas 5, expnt(s) = [1176168.14261328]
bas 6, expnt(s) = [588084.06995582]
bas 7, expnt(s) = [294042.03091746]
bas 8, expnt(s) = [147020.99130762]
bas 9, expnt(s) = [73510.41748282]
bas 10, expnt(s) = [36754.70119415]
bas 11, expnt(s) = [7302.3000221]
bas 12, expnt(s) = [18375.7705049]
bas 13, expnt(s) = [1443.690495]
bas 14, expnt(s) = [417.3896263]
bas 15, expnt(s) = [147.76968414]
bas 16, expnt(s) = [58.44906629]
bas 17, expnt(s) = [24.74134042]
bas 18, expnt(s) = [9.08288519]
bas 19, expnt(s) = [8.60433576]
bas 20, expnt(s) = [0.49275834]
CPU time:      1045.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29185193e-01 8.36864106e-01 5.98100633e-01 1.71828706e+00
 1.82012421e+00 3.95904824e+00 1.17616813e+05 1.60460108e+04
 4.05727467e+00 7.22255456e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30230002e+03 1.99576673e+03
 1.83757705e+04 3.98748620e+03 1.44369050e+03 5.91725925e+02
 4.17389626e+02 2.33303505e+02 1.47769684e+02 1.07078933e+02
 5.84490663e+01 5.34070030e+01 2.47413404e+01 2.80273762e+01
 9.08288519e+00 1.32185218e+01 8.60433576e+00 4.29913496e+01
 4.92758336e-01 1.20441697e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3360721827908
cond(S) = 912643.6353222328
E1 = -689.5974879723615  E_coul = 184.97212506938433
init E= -504.625362902977
    CPU time for initialize scf      7.60 sec, wall time      0.37 sec
  HOMO = -0.672161657314278  LUMO = 0.53941310485402
  mo_energy =
[-1.21709689e+02 -1.33862561e+01 -7.62355137e+00 -7.62355137e+00
 -7.62355137e+00 -1.65757438e+00 -6.72161657e-01 -6.72161657e-01
 -6.72161657e-01  5.39413105e-01  4.85997817e+00  2.14583479e+01
  8.04738604e+01  2.75390839e+02  9.02979782e+02  3.15529908e+03
  1.26345334e+04  4.12309686e+04  1.05258744e+05  2.30431585e+05
  4.56238888e+05  8.45185343e+05  1.52835699e+06  2.85061746e+06
  5.80849586e+06]
E1 = -707.7558906093093  E_coul = 199.78336417846296
cycle= 1 E= -507.972526430846  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.75934
diis-c [-0.57659785  1.        ]
  HOMO = -0.217605951685964  LUMO = 0.8859069285705
  mo_energy =
[-1.20200011e+02 -1.23046763e+01 -6.59392697e+00 -6.59392697e+00
 -6.59392697e+00 -1.16330716e+00 -2.17605952e-01 -2.17605952e-01
 -2.17605952e-01  8.85906929e-01  5.48359547e+00  2.24084952e+01
  8.17443387e+01  2.76843192e+02  9.04471339e+02  3.15673145e+03
  1.26358594e+04  4.12322274e+04  1.05259966e+05  2.30432783e+05
  4.56240069e+05  8.45186509e+05  1.52835814e+06  2.85061861e+06
  5.80849700e+06]
E1 = -706.8008720356453  E_coul = 198.81052785330542
cycle= 2 E= -507.99034418234  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.09 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348465
diis-c [-0.00120908 -0.00301403  1.00301403]
  HOMO = -0.239786192455201  LUMO = 0.882221867563451
  mo_energy =
[-1.20315032e+02 -1.23724880e+01 -6.66901198e+00 -6.66901198e+00
 -6.66901198e+00 -1.17757819e+00 -2.39786192e-01 -2.39786192e-01
 -2.39786192e-01  8.82221868e-01  5.45547007e+00  2.23512919e+01
  8.16604237e+01  2.76738434e+02  9.04350673e+02  3.15659642e+03
  1.26357141e+04  4.12320783e+04  1.05259815e+05  2.30432631e+05
  4.56239917e+05  8.45186357e+05  1.52835799e+06  2.85061846e+06
  5.80849685e+06]
E1 = -706.6924290824734  E_coul = 198.7018225674959
cycle= 3 E= -507.990606514977  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381787
diis-c [-3.26891799e-06  1.15748068e-04 -1.07229590e-01  1.10711384e+00]
  HOMO = -0.242933032147772  LUMO = 0.881473361179359
  mo_energy =
[-1.20326747e+02 -1.23810293e+01 -6.67803391e+00 -6.67803391e+00
 -6.67803391e+00 -1.17948494e+00 -2.42933032e-01 -2.42933032e-01
 -2.42933032e-01  8.81473361e-01  5.45130109e+00  2.23439147e+01
  8.16508023e+01  2.76727386e+02  9.04338723e+02  3.15658377e+03
  1.26357010e+04  4.12320650e+04  1.05259802e+05  2.30432618e+05
  4.56239903e+05  8.45186344e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.67714321609  E_coul = 198.68653164203798
cycle= 4 E= -507.990611574052  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173402
diis-c [-5.63175090e-10 -9.46777592e-06  6.86247884e-03 -9.76632301e-02
  1.09081022e+00]
  HOMO = -0.243081415170657  LUMO = 0.881428782512119
  mo_energy =
[-1.20327086e+02 -1.23813651e+01 -6.67836524e+00 -6.67836524e+00
 -6.67836524e+00 -1.17957484e+00 -2.43081415e-01 -2.43081415e-01
 -2.43081415e-01  8.81428783e-01  5.45109841e+00  2.23436149e+01
  8.16504711e+01  2.76727048e+02  9.04338383e+02  3.15658343e+03
  1.26357007e+04  4.12320647e+04  1.05259801e+05  2.30432617e+05
  4.56239903e+05  8.45186343e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.6764284554522  E_coul = 198.68581686721208
cycle= 5 E= -507.99061158824  delta_E= -1.42e-08  |g|= 5.91e-06  |ddm|= 0.000675
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.61814e-06
diis-c [-9.37212933e-13  6.09602890e-07 -5.58016451e-04  7.56557948e-03
 -9.06341304e-02  1.08362596e+00]
  HOMO = -0.243084129359892  LUMO = 0.881428014227009
  mo_energy =
[-1.20327092e+02 -1.23813704e+01 -6.67837058e+00 -6.67837058e+00
 -6.67837058e+00 -1.17957671e+00 -2.43084129e-01 -2.43084129e-01
 -2.43084129e-01  8.81428014e-01  5.45109466e+00  2.23436100e+01
  8.16504656e+01  2.76727042e+02  9.04338377e+02  3.15658342e+03
  1.26357007e+04  4.12320646e+04  1.05259801e+05  2.30432617e+05
  4.56239903e+05  8.45186343e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.6764147225301  E_coul = 198.685803134282
cycle= 6 E= -507.990611588248  delta_E= -8.07e-12  |g|= 9.2e-08  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6764147225301  E_coul = 198.685803134282
  HOMO = -0.243084172003534  LUMO = 0.881427989603228
  mo_energy =
[-1.20327093e+02 -1.23813704e+01 -6.67837066e+00 -6.67837066e+00
 -6.67837066e+00 -1.17957672e+00 -2.43084172e-01 -2.43084172e-01
 -2.43084172e-01  8.81427990e-01  5.45109460e+00  2.23436099e+01
  8.16504655e+01  2.76727042e+02  9.04338377e+02  3.15658342e+03
  1.26357007e+04  4.12320646e+04  1.05259801e+05  2.30432617e+05
  4.56239903e+05  8.45186343e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.6764145342776  E_coul = 198.68580294602975
Extra cycle  E= -507.990611588248  delta_E= 3.41e-13  |g|= 1.17e-08  |ddm|= 2.24e-07
    CPU time for scf_cycle      8.44 sec, wall time      0.58 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912643.6353222328
E1 = -706.6764145342776  E_coul = 198.68580294602975
init E= -507.990611588248
    CPU time for initialize scf     17.22 sec, wall time      0.75 sec
  HOMO = -0.243084178126256  LUMO = 0.881427987403161
  mo_energy =
[-1.20327093e+02 -1.23813704e+01 -6.67837068e+00 -6.67837068e+00
 -6.67837068e+00 -1.17957673e+00 -2.43084178e-01 -2.43084178e-01
 -2.43084178e-01  8.81427987e-01  5.45109459e+00  2.23436099e+01
  8.16504655e+01  2.76727042e+02  9.04338377e+02  3.15658342e+03
  1.26357007e+04  4.12320646e+04  1.05259801e+05  2.30432617e+05
  4.56239903e+05  8.45186343e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.6764145038169  E_coul = 198.68580291556881
cycle= 1 E= -507.990611588248  delta_E= -2.27e-13  |g|= 2.08e-09  |ddm|= 3.06e-08
    CPU time for cycle= 1      0.40 sec, wall time      0.04 sec
E1 = -706.6764145038169  E_coul = 198.68580291556881
  HOMO = -0.243084179066492  LUMO = 0.881427986691698
  mo_energy =
[-1.20327093e+02 -1.23813705e+01 -6.67837068e+00 -6.67837068e+00
 -6.67837068e+00 -1.17957673e+00 -2.43084179e-01 -2.43084179e-01
 -2.43084179e-01  8.81427987e-01  5.45109459e+00  2.23436099e+01
  8.16504655e+01  2.76727042e+02  9.04338377e+02  3.15658342e+03
  1.26357007e+04  4.12320646e+04  1.05259801e+05  2.30432617e+05
  4.56239903e+05  8.45186343e+05  1.52835798e+06  2.85061844e+06
  5.80849683e+06]
E1 = -706.6764145002562  E_coul = 198.68580291200834
Extra cycle  E= -507.990611588248  delta_E= 1.71e-13  |g|= 1.38e-09  |ddm|= 3.25e-09
    CPU time for scf_cycle     17.78 sec, wall time      0.95 sec
exp = [2.29185193e-01 5.98100633e-01 1.82012421e+00 1.17616813e+05
 4.05727467e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30230002e+03
 1.83757705e+04 1.44369050e+03 4.17389626e+02 1.47769684e+02
 5.84490663e+01 2.47413404e+01 9.08288519e+00 8.60433576e+00
 4.92758336e-01]
grad_E = [ 1.67187014e-05 -2.78423415e-06 -2.28542599e-05  6.05002633e-09
  1.55406097e-05  4.03032506e-11  1.73753258e-10  9.38427473e-10
  3.70756535e-09  1.54817334e-08  8.07667759e-08  5.09107840e-06
  1.97859999e-07 -3.80976326e-05 -9.63158604e-06  2.18355566e-05
 -7.92291088e-05  1.26693532e-05  1.26400662e-05  3.76649384e-05
  1.74710542e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22974399822        1
[INPUT] 0    0    [1    /1   ]  0.600234492947       1
[INPUT] 0    0    [1    /1   ]  1.83755728116        1
[INPUT] 0    0    [1    /1   ]  117616.812862        1
[INPUT] 0    0    [1    /1   ]  4.08619047215        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030917        1
[INPUT] 0    0    [1    /1   ]  147020.991307        1
[INPUT] 0    0    [1    /1   ]  73510.4174783        1
[INPUT] 0    0    [1    /1   ]  36754.7011708        1
[INPUT] 0    0    [1    /1   ]  7302.29854841        1
[INPUT] 0    0    [1    /1   ]  18375.7704476        1
[INPUT] 0    0    [1    /1   ]  1443.70154278        1
[INPUT] 0    0    [1    /1   ]  417.392119966        1
[INPUT] 0    0    [1    /1   ]  147.765483963        1
[INPUT] 0    0    [1    /1   ]  58.4609445345        1
[INPUT] 0    0    [1    /1   ]  24.7460119481        1
[INPUT] 0    0    [1    /1   ]  9.13585173621        1
[INPUT] 1    0    [1    /1   ]  8.60439037307        1
[INPUT] 1    0    [1    /1   ]  0.492765712922       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22974399822003394, 1.0]], [0, [0.600234492947001, 1.0]], [0, [1.837557281164795, 1.0]], [0, [117616.81286213353, 1.0]], [0, [4.086190472146969, 1.0]], [0, [1176168.1426132706, 1.0]], [0, [588084.0699557737, 1.0]], [0, [294042.03091719, 1.0]], [0, [147020.9913065435, 1.0]], [0, [73510.41747834261, 1.0]], [0, [36754.70117077189, 1.0]], [0, [7302.298548413413, 1.0]], [0, [18375.770447607923, 1.0]], [0, [1443.7015427830913, 1.0]], [0, [417.3921199657372, 1.0]], [0, [147.7654839627055, 1.0]], [0, [58.46094453448932, 1.0]], [0, [24.7460119481104, 1.0]], [0, [9.135851736206883, 1.0]], [1, [8.60439037306718, 1.0]], [1, [0.4927657129224109, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.229744]
bas 1, expnt(s) = [0.60023449]
bas 2, expnt(s) = [1.83755728]
bas 3, expnt(s) = [117616.81286213]
bas 4, expnt(s) = [4.08619047]
bas 5, expnt(s) = [1176168.14261327]
bas 6, expnt(s) = [588084.06995577]
bas 7, expnt(s) = [294042.03091719]
bas 8, expnt(s) = [147020.99130654]
bas 9, expnt(s) = [73510.41747834]
bas 10, expnt(s) = [36754.70117077]
bas 11, expnt(s) = [7302.29854841]
bas 12, expnt(s) = [18375.77044761]
bas 13, expnt(s) = [1443.70154278]
bas 14, expnt(s) = [417.39211997]
bas 15, expnt(s) = [147.76548396]
bas 16, expnt(s) = [58.46094453]
bas 17, expnt(s) = [24.74601195]
bas 18, expnt(s) = [9.13585174]
bas 19, expnt(s) = [8.60439037]
bas 20, expnt(s) = [0.49276571]
CPU time:      1079.32
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29743998e-01 8.38393988e-01 6.00234493e-01 1.72288280e+00
 1.83755728e+00 3.98745403e+00 1.17616813e+05 1.60460108e+04
 4.08619047e+00 7.26112611e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30229855e+03 1.99576643e+03
 1.83757704e+04 3.98748619e+03 1.44370154e+03 5.91729321e+02
 4.17392120e+02 2.33304550e+02 1.47765484e+02 1.07076650e+02
 5.84609445e+01 5.34151430e+01 2.47460119e+01 2.80313451e+01
 9.13585174e+00 1.32762923e+01 8.60439037e+00 4.29916907e+01
 4.92765713e-01 1.20443951e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336060134887358
cond(S) = 912655.575059314
E1 = -689.5979711831944  E_coul = 184.97259899803106
init E= -504.625372185163
    CPU time for initialize scf      7.79 sec, wall time      0.38 sec
  HOMO = -0.672153051877455  LUMO = 0.543296589246112
  mo_energy =
[-1.21709619e+02 -1.33862206e+01 -7.62352076e+00 -7.62352076e+00
 -7.62352076e+00 -1.65756234e+00 -6.72153052e-01 -6.72153052e-01
 -6.72153052e-01  5.43296589e-01  4.90816303e+00  2.16561554e+01
  8.08564317e+01  2.75843191e+02  9.03423433e+02  3.15571702e+03
  1.26349269e+04  4.12313413e+04  1.05259102e+05  2.30431934e+05
  4.56239230e+05  8.45185678e+05  1.52835732e+06  2.85061779e+06
  5.80849618e+06]
E1 = -707.75642322643  E_coul = 199.78389574802148
cycle= 1 E= -507.972527478409  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.759572
diis-c [-0.5769493  1.       ]
  HOMO = -0.217592698697709  LUMO = 0.890738584446911
  mo_energy =
[-1.20199935e+02 -1.23046382e+01 -6.59389398e+00 -6.59389398e+00
 -6.59389398e+00 -1.16329403e+00 -2.17592699e-01 -2.17592699e-01
 -2.17592699e-01  8.90738584e-01  5.53424349e+00  2.26083118e+01
  8.21272336e+01  2.77295496e+02  9.04914971e+02  3.15714939e+03
  1.26362529e+04  4.12326001e+04  1.05260324e+05  2.30433131e+05
  4.56240410e+05  8.45186845e+05  1.52835847e+06  2.85061893e+06
  5.80849732e+06]
E1 = -706.8014592293774  E_coul = 198.81111426182912
cycle= 2 E= -507.990344967548  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.394
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347767
diis-c [-0.00120434 -0.00297757  1.00297757]
  HOMO = -0.239770534063447  LUMO = 0.887012559628356
  mo_energy =
[-1.20314948e+02 -1.23724432e+01 -6.66897202e+00 -6.66897202e+00
 -6.66897202e+00 -1.17756296e+00 -2.39770534e-01 -2.39770534e-01
 -2.39770534e-01  8.87012560e-01  5.50590685e+00  2.25509424e+01
  8.20432853e+01  2.77190748e+02  9.04794316e+02  3.15701437e+03
  1.26361076e+04  4.12324509e+04  1.05260174e+05  2.30432979e+05
  4.56240258e+05  8.45186693e+05  1.52835832e+06  2.85061878e+06
  5.80849716e+06]
E1 = -706.6930658071352  E_coul = 198.70245872154428
cycle= 3 E= -507.990607085591  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00380337
diis-c [-3.25650397e-06  1.18662627e-04 -1.06955830e-01  1.10683717e+00]
  HOMO = -0.242915164937306  LUMO = 0.88625820466777
  mo_energy =
[-1.20326659e+02 -1.23809808e+01 -6.67799031e+00 -6.67799031e+00
 -6.67799031e+00 -1.17946821e+00 -2.42915165e-01 -2.42915165e-01
 -2.42915165e-01  8.86258205e-01  5.50171345e+00  2.25435517e+01
  8.20336642e+01  2.77179704e+02  9.04782370e+02  3.15700173e+03
  1.26360945e+04  4.12324377e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.6777980049758  E_coul = 198.68718587327714
cycle= 4 E= -507.990612131699  delta_E= -5.05e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173271
diis-c [-5.50556558e-10 -9.42950424e-06  6.85411471e-03 -9.78220150e-02
  1.09097733e+00]
  HOMO = -0.243063955230422  LUMO = 0.886213277104534
  mo_energy =
[-1.20327002e+02 -1.23813182e+01 -6.67832345e+00 -6.67832345e+00
 -6.67832345e+00 -1.17955834e+00 -2.43063955e-01 -2.43063955e-01
 -2.43063955e-01  8.86213277e-01  5.50150917e+00  2.25432502e+01
  8.20333309e+01  2.77179363e+02  9.04782027e+02  3.15700138e+03
  1.26360942e+04  4.12324373e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.677081798687  E_coul = 198.6864696528254
cycle= 5 E= -507.990612145862  delta_E= -1.42e-08  |g|= 5.8e-06  |ddm|= 0.000671
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.57277e-06
diis-c [-9.17337267e-13  6.10959175e-07 -5.51754174e-04  7.50145980e-03
 -8.96895908e-02  1.08273927e+00]
  HOMO = -0.243066631062104  LUMO = 0.886212518908806
  mo_energy =
[-1.20327008e+02 -1.23813234e+01 -6.67832873e+00 -6.67832873e+00
 -6.67832873e+00 -1.17956018e+00 -2.43066631e-01 -2.43066631e-01
 -2.43066631e-01  8.86212519e-01  5.50150545e+00  2.25432453e+01
  8.20333255e+01  2.77179358e+02  9.04782021e+02  3.15700138e+03
  1.26360942e+04  4.12324373e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.6770682745295  E_coul = 198.68645612866078
cycle= 6 E= -507.990612145869  delta_E= -7.05e-12  |g|= 9.15e-08  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6770682745295  E_coul = 198.68645612866078
  HOMO = -0.243066673772601  LUMO = 0.886212492295134
  mo_energy =
[-1.20327008e+02 -1.23813235e+01 -6.67832881e+00 -6.67832881e+00
 -6.67832881e+00 -1.17956020e+00 -2.43066674e-01 -2.43066674e-01
 -2.43066674e-01  8.86212492e-01  5.50150538e+00  2.25432453e+01
  8.20333254e+01  2.77179357e+02  9.04782021e+02  3.15700138e+03
  1.26360942e+04  4.12324373e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.6770680888127  E_coul = 198.6864559429438
Extra cycle  E= -507.990612145869  delta_E= -2.27e-13  |g|= 1.23e-08  |ddm|= 2.2e-07
    CPU time for scf_cycle      8.65 sec, wall time      0.60 sec
exp = [2.29743998e-01 6.00234493e-01 1.83755728e+00 1.17616813e+05
 4.08619047e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30229855e+03
 1.83757704e+04 1.44370154e+03 4.17392120e+02 1.47765484e+02
 5.84609445e+01 2.47460119e+01 9.13585174e+00 8.60439037e+00
 4.92765713e-01]
E = -507.9906121458689
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:33:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.22974399822        1
[INPUT] 0    0    [1    /1   ]  0.600234492947       1
[INPUT] 0    0    [1    /1   ]  1.83755728116        1
[INPUT] 0    0    [1    /1   ]  117616.812862        1
[INPUT] 0    0    [1    /1   ]  4.08619047215        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030917        1
[INPUT] 0    0    [1    /1   ]  147020.991307        1
[INPUT] 0    0    [1    /1   ]  73510.4174783        1
[INPUT] 0    0    [1    /1   ]  36754.7011708        1
[INPUT] 0    0    [1    /1   ]  7302.29854841        1
[INPUT] 0    0    [1    /1   ]  18375.7704476        1
[INPUT] 0    0    [1    /1   ]  1443.70154278        1
[INPUT] 0    0    [1    /1   ]  417.392119966        1
[INPUT] 0    0    [1    /1   ]  147.765483963        1
[INPUT] 0    0    [1    /1   ]  58.4609445345        1
[INPUT] 0    0    [1    /1   ]  24.7460119481        1
[INPUT] 0    0    [1    /1   ]  9.13585173621        1
[INPUT] 1    0    [1    /1   ]  8.60439037307        1
[INPUT] 1    0    [1    /1   ]  0.492765712922       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22974399822003394, 1.0]], [0, [0.600234492947001, 1.0]], [0, [1.837557281164795, 1.0]], [0, [117616.81286213353, 1.0]], [0, [4.086190472146969, 1.0]], [0, [1176168.1426132706, 1.0]], [0, [588084.0699557737, 1.0]], [0, [294042.03091719, 1.0]], [0, [147020.9913065435, 1.0]], [0, [73510.41747834261, 1.0]], [0, [36754.70117077189, 1.0]], [0, [7302.298548413413, 1.0]], [0, [18375.770447607923, 1.0]], [0, [1443.7015427830913, 1.0]], [0, [417.3921199657372, 1.0]], [0, [147.7654839627055, 1.0]], [0, [58.46094453448932, 1.0]], [0, [24.7460119481104, 1.0]], [0, [9.135851736206883, 1.0]], [1, [8.60439037306718, 1.0]], [1, [0.4927657129224109, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.229744]
bas 1, expnt(s) = [0.60023449]
bas 2, expnt(s) = [1.83755728]
bas 3, expnt(s) = [117616.81286213]
bas 4, expnt(s) = [4.08619047]
bas 5, expnt(s) = [1176168.14261327]
bas 6, expnt(s) = [588084.06995577]
bas 7, expnt(s) = [294042.03091719]
bas 8, expnt(s) = [147020.99130654]
bas 9, expnt(s) = [73510.41747834]
bas 10, expnt(s) = [36754.70117077]
bas 11, expnt(s) = [7302.29854841]
bas 12, expnt(s) = [18375.77044761]
bas 13, expnt(s) = [1443.70154278]
bas 14, expnt(s) = [417.39211997]
bas 15, expnt(s) = [147.76548396]
bas 16, expnt(s) = [58.46094453]
bas 17, expnt(s) = [24.74601195]
bas 18, expnt(s) = [9.13585174]
bas 19, expnt(s) = [8.60439037]
bas 20, expnt(s) = [0.49276571]
CPU time:      1088.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29743998e-01 8.38393988e-01 6.00234493e-01 1.72288280e+00
 1.83755728e+00 3.98745403e+00 1.17616813e+05 1.60460108e+04
 4.08619047e+00 7.26112611e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547012e+04 6.70655818e+03 7.30229855e+03 1.99576643e+03
 1.83757704e+04 3.98748619e+03 1.44370154e+03 5.91729321e+02
 4.17392120e+02 2.33304550e+02 1.47765484e+02 1.07076650e+02
 5.84609445e+01 5.34151430e+01 2.47460119e+01 2.80313451e+01
 9.13585174e+00 1.32762923e+01 8.60439037e+00 4.29916907e+01
 4.92765713e-01 1.20443951e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336060134887358
cond(S) = 912655.575059314
E1 = -689.5979711831944  E_coul = 184.97259899803106
init E= -504.625372185163
    CPU time for initialize scf      7.62 sec, wall time      0.37 sec
  HOMO = -0.672153051877455  LUMO = 0.543296589246112
  mo_energy =
[-1.21709619e+02 -1.33862206e+01 -7.62352076e+00 -7.62352076e+00
 -7.62352076e+00 -1.65756234e+00 -6.72153052e-01 -6.72153052e-01
 -6.72153052e-01  5.43296589e-01  4.90816303e+00  2.16561554e+01
  8.08564317e+01  2.75843191e+02  9.03423433e+02  3.15571702e+03
  1.26349269e+04  4.12313413e+04  1.05259102e+05  2.30431934e+05
  4.56239230e+05  8.45185678e+05  1.52835732e+06  2.85061779e+06
  5.80849618e+06]
E1 = -707.75642322643  E_coul = 199.78389574802148
cycle= 1 E= -507.972527478409  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.759572
diis-c [-0.5769493  1.       ]
  HOMO = -0.217592698697709  LUMO = 0.890738584446911
  mo_energy =
[-1.20199935e+02 -1.23046382e+01 -6.59389398e+00 -6.59389398e+00
 -6.59389398e+00 -1.16329403e+00 -2.17592699e-01 -2.17592699e-01
 -2.17592699e-01  8.90738584e-01  5.53424349e+00  2.26083118e+01
  8.21272336e+01  2.77295496e+02  9.04914971e+02  3.15714939e+03
  1.26362529e+04  4.12326001e+04  1.05260324e+05  2.30433131e+05
  4.56240410e+05  8.45186845e+05  1.52835847e+06  2.85061893e+06
  5.80849732e+06]
E1 = -706.8014592293774  E_coul = 198.81111426182912
cycle= 2 E= -507.990344967548  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.394
    CPU time for cycle= 2      0.11 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347767
diis-c [-0.00120434 -0.00297757  1.00297757]
  HOMO = -0.239770534063447  LUMO = 0.887012559628356
  mo_energy =
[-1.20314948e+02 -1.23724432e+01 -6.66897202e+00 -6.66897202e+00
 -6.66897202e+00 -1.17756296e+00 -2.39770534e-01 -2.39770534e-01
 -2.39770534e-01  8.87012560e-01  5.50590685e+00  2.25509424e+01
  8.20432853e+01  2.77190748e+02  9.04794316e+02  3.15701437e+03
  1.26361076e+04  4.12324509e+04  1.05260174e+05  2.30432979e+05
  4.56240258e+05  8.45186693e+05  1.52835832e+06  2.85061878e+06
  5.80849716e+06]
E1 = -706.6930658071352  E_coul = 198.70245872154428
cycle= 3 E= -507.990607085591  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00380337
diis-c [-3.25650397e-06  1.18662627e-04 -1.06955830e-01  1.10683717e+00]
  HOMO = -0.242915164937306  LUMO = 0.88625820466777
  mo_energy =
[-1.20326659e+02 -1.23809808e+01 -6.67799031e+00 -6.67799031e+00
 -6.67799031e+00 -1.17946821e+00 -2.42915165e-01 -2.42915165e-01
 -2.42915165e-01  8.86258205e-01  5.50171345e+00  2.25435517e+01
  8.20336642e+01  2.77179704e+02  9.04782370e+02  3.15700173e+03
  1.26360945e+04  4.12324377e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.6777980049758  E_coul = 198.68718587327714
cycle= 4 E= -507.990612131699  delta_E= -5.05e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173271
diis-c [-5.50556558e-10 -9.42950424e-06  6.85411471e-03 -9.78220150e-02
  1.09097733e+00]
  HOMO = -0.243063955230422  LUMO = 0.886213277104534
  mo_energy =
[-1.20327002e+02 -1.23813182e+01 -6.67832345e+00 -6.67832345e+00
 -6.67832345e+00 -1.17955834e+00 -2.43063955e-01 -2.43063955e-01
 -2.43063955e-01  8.86213277e-01  5.50150917e+00  2.25432502e+01
  8.20333309e+01  2.77179363e+02  9.04782027e+02  3.15700138e+03
  1.26360942e+04  4.12324373e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.677081798687  E_coul = 198.6864696528254
cycle= 5 E= -507.990612145862  delta_E= -1.42e-08  |g|= 5.8e-06  |ddm|= 0.000671
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.57277e-06
diis-c [-9.17337267e-13  6.10959175e-07 -5.51754174e-04  7.50145980e-03
 -8.96895908e-02  1.08273927e+00]
  HOMO = -0.243066631062104  LUMO = 0.886212518908806
  mo_energy =
[-1.20327008e+02 -1.23813234e+01 -6.67832873e+00 -6.67832873e+00
 -6.67832873e+00 -1.17956018e+00 -2.43066631e-01 -2.43066631e-01
 -2.43066631e-01  8.86212519e-01  5.50150545e+00  2.25432453e+01
  8.20333255e+01  2.77179358e+02  9.04782021e+02  3.15700138e+03
  1.26360942e+04  4.12324373e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.6770682745295  E_coul = 198.68645612866078
cycle= 6 E= -507.990612145869  delta_E= -7.05e-12  |g|= 9.15e-08  |ddm|= 1.73e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6770682745295  E_coul = 198.68645612866078
  HOMO = -0.243066673772601  LUMO = 0.886212492295134
  mo_energy =
[-1.20327008e+02 -1.23813235e+01 -6.67832881e+00 -6.67832881e+00
 -6.67832881e+00 -1.17956020e+00 -2.43066674e-01 -2.43066674e-01
 -2.43066674e-01  8.86212492e-01  5.50150538e+00  2.25432453e+01
  8.20333254e+01  2.77179357e+02  9.04782021e+02  3.15700138e+03
  1.26360942e+04  4.12324373e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.6770680888127  E_coul = 198.6864559429438
Extra cycle  E= -507.990612145869  delta_E= -2.27e-13  |g|= 1.23e-08  |ddm|= 2.2e-07
    CPU time for scf_cycle      8.49 sec, wall time      0.59 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912655.575059314
E1 = -706.6770680888127  E_coul = 198.6864559429438
init E= -507.990612145869
    CPU time for initialize scf     17.12 sec, wall time      0.75 sec
  HOMO = -0.243066679805979  LUMO = 0.88621249156503
  mo_energy =
[-1.20327008e+02 -1.23813235e+01 -6.67832883e+00 -6.67832883e+00
 -6.67832883e+00 -1.17956020e+00 -2.43066680e-01 -2.43066680e-01
 -2.43066680e-01  8.86212492e-01  5.50150537e+00  2.25432452e+01
  8.20333254e+01  2.77179357e+02  9.04782021e+02  3.15700138e+03
  1.26360942e+04  4.12324373e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.6770680589706  E_coul = 198.68645591310187
cycle= 1 E= -507.990612145869  delta_E= 2.27e-13  |g|= 2.3e-09  |ddm|= 3.02e-08
    CPU time for cycle= 1      0.34 sec, wall time      0.03 sec
E1 = -706.6770680589706  E_coul = 198.68645591310187
  HOMO = -0.243066680742163  LUMO = 0.886212492764246
  mo_energy =
[-1.20327008e+02 -1.23813235e+01 -6.67832883e+00 -6.67832883e+00
 -6.67832883e+00 -1.17956020e+00 -2.43066681e-01 -2.43066681e-01
 -2.43066681e-01  8.86212493e-01  5.50150537e+00  2.25432452e+01
  8.20333254e+01  2.77179357e+02  9.04782021e+02  3.15700138e+03
  1.26360942e+04  4.12324373e+04  1.05260160e+05  2.30432966e+05
  4.56240244e+05  8.45186679e+05  1.52835831e+06  2.85061877e+06
  5.80849715e+06]
E1 = -706.6770680508217  E_coul = 198.68645590495262
Extra cycle  E= -507.990612145869  delta_E= -4.55e-13  |g|= 1.72e-09  |ddm|= 7.21e-09
    CPU time for scf_cycle     17.62 sec, wall time      0.92 sec
exp = [2.29743998e-01 6.00234493e-01 1.83755728e+00 1.17616813e+05
 4.08619047e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547012e+04 7.30229855e+03
 1.83757704e+04 1.44370154e+03 4.17392120e+02 1.47765484e+02
 5.84609445e+01 2.47460119e+01 9.13585174e+00 8.60439037e+00
 4.92765713e-01]
grad_E = [-9.90099078e-05  7.05892612e-05 -2.46134742e-05  6.05199669e-09
  1.23683022e-05  4.03254042e-11  1.73817852e-10  9.38729722e-10
  3.70878557e-09  1.54868956e-08  8.07917407e-08  5.09273395e-06
  1.97941183e-07 -3.81772536e-05 -8.93295465e-06  1.91633800e-05
 -7.48614027e-05  9.65046237e-06  1.74848840e-05  7.68131263e-05
  3.99202614e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.230391401734       1
[INPUT] 0    0    [1    /1   ]  0.602705828903       1
[INPUT] 0    0    [1    /1   ]  1.85738378935        1
[INPUT] 0    0    [1    /1   ]  117616.812859        1
[INPUT] 0    0    [1    /1   ]  4.12180080392        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030917        1
[INPUT] 0    0    [1    /1   ]  147020.991305        1
[INPUT] 0    0    [1    /1   ]  73510.4174706        1
[INPUT] 0    0    [1    /1   ]  36754.7011304        1
[INPUT] 0    0    [1    /1   ]  7302.29600205        1
[INPUT] 0    0    [1    /1   ]  18375.7703486        1
[INPUT] 0    0    [1    /1   ]  1443.72061642        1
[INPUT] 0    0    [1    /1   ]  417.396625982        1
[INPUT] 0    0    [1    /1   ]  147.757089544        1
[INPUT] 0    0    [1    /1   ]  58.4863322373        1
[INPUT] 0    0    [1    /1   ]  24.7505505471        1
[INPUT] 0    0    [1    /1   ]  9.20494136089        1
[INPUT] 1    0    [1    /1   ]  8.60445653804        1
[INPUT] 1    0    [1    /1   ]  0.492774504595       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23039140173406913, 1.0]], [0, [0.6027058289032851, 1.0]], [0, [1.8573837893508076, 1.0]], [0, [117616.81285910735, 1.0]], [0, [4.121800803919184, 1.0]], [0, [1176168.1426132503, 1.0]], [0, [588084.0699556867, 1.0]], [0, [294042.0309167206, 1.0]], [0, [147020.99130468897, 1.0]], [0, [73510.41747059864, 1.0]], [0, [36754.70113037392, 1.0]], [0, [7302.296002054008, 1.0]], [0, [18375.77034862591, 1.0]], [0, [1443.7206164216677, 1.0]], [0, [417.39662598241836, 1.0]], [0, [147.75708954379328, 1.0]], [0, [58.486332237268996, 1.0]], [0, [24.75055054705728, 1.0]], [0, [9.204941360888393, 1.0]], [1, [8.604456538038091, 1.0]], [1, [0.49277450459548733, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2303914]
bas 1, expnt(s) = [0.60270583]
bas 2, expnt(s) = [1.85738379]
bas 3, expnt(s) = [117616.81285911]
bas 4, expnt(s) = [4.1218008]
bas 5, expnt(s) = [1176168.14261325]
bas 6, expnt(s) = [588084.06995569]
bas 7, expnt(s) = [294042.03091672]
bas 8, expnt(s) = [147020.99130469]
bas 9, expnt(s) = [73510.4174706]
bas 10, expnt(s) = [36754.70113037]
bas 11, expnt(s) = [7302.29600205]
bas 12, expnt(s) = [18375.77034863]
bas 13, expnt(s) = [1443.72061642]
bas 14, expnt(s) = [417.39662598]
bas 15, expnt(s) = [147.75708954]
bas 16, expnt(s) = [58.48633224]
bas 17, expnt(s) = [24.75055055]
bas 18, expnt(s) = [9.20494136]
bas 19, expnt(s) = [8.60445654]
bas 20, expnt(s) = [0.4927745]
CPU time:      1121.34
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30391402e-01 8.40165269e-01 6.02705829e-01 1.72820027e+00
 1.85738379e+00 4.01967798e+00 1.17616813e+05 1.60460108e+04
 4.12180080e+00 7.30853404e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655817e+03 7.30229600e+03 1.99576591e+03
 1.83757703e+04 3.98748617e+03 1.44372062e+03 5.91735184e+02
 4.17396626e+02 2.33306439e+02 1.47757090e+02 1.07072088e+02
 5.84863322e+01 5.34325394e+01 2.47505505e+01 2.80352009e+01
 9.20494136e+00 1.33515226e+01 8.60445654e+00 4.29921039e+01
 4.92774505e-01 1.20446637e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33604571545687
cond(S) = 912670.7570469804
E1 = -689.5984689959738  E_coul = 184.97316899974848
init E= -504.625299996225
    CPU time for initialize scf      7.52 sec, wall time      0.38 sec
  HOMO = -0.672142888814489  LUMO = 0.547807072699526
  mo_energy =
[-1.21709535e+02 -1.33861775e+01 -7.62348383e+00 -7.62348383e+00
 -7.62348383e+00 -1.65754788e+00 -6.72142889e-01 -6.72142889e-01
 -6.72142889e-01  5.47807073e-01  4.96471121e+00  2.18962235e+01
  8.13324343e+01  2.76423202e+02  9.04004462e+02  3.15627276e+03
  1.26354601e+04  4.12318492e+04  1.05259592e+05  2.30432409e+05
  4.56239695e+05  8.45186136e+05  1.52835777e+06  2.85061823e+06
  5.80849661e+06]
E1 = -707.7570604135148  E_coul = 199.7845310586789
cycle= 1 E= -507.972529354836  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.75985
diis-c [-0.57737127  1.        ]
  HOMO = -0.217576954374065  LUMO = 0.896346759726874
  mo_energy =
[-1.20199846e+02 -1.23045924e+01 -6.59385462e+00 -6.59385462e+00
 -6.59385462e+00 -1.16327824e+00 -2.17576954e-01 -2.17576954e-01
 -2.17576954e-01  8.96346760e-01  5.59369279e+00  2.28508648e+01
  8.26036720e+01  2.77875459e+02  9.05495976e+02  3.15770513e+03
  1.26367861e+04  4.12331080e+04  1.05260813e+05  2.30433607e+05
  4.56240875e+05  8.45187303e+05  1.52835892e+06  2.85061937e+06
  5.80849775e+06]
E1 = -706.8021664996256  E_coul = 198.81182007532777
cycle= 2 E= -507.990346424298  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347002
diis-c [-0.00119917 -0.0029358   1.0029358 ]
  HOMO = -0.239751733986606  LUMO = 0.892573163624739
  mo_energy =
[-1.20314848e+02 -1.23723891e+01 -6.66892413e+00 -6.66892413e+00
 -6.66892413e+00 -1.17754452e+00 -2.39751734e-01 -2.39751734e-01
 -2.39751734e-01  8.92573164e-01  5.56510877e+00  2.27932926e+01
  8.25196797e+01  2.77770722e+02  9.05375335e+02  3.15757013e+03
  1.26366408e+04  4.12329589e+04  1.05260663e+05  2.30433455e+05
  4.56240723e+05  8.45187150e+05  1.52835877e+06  2.85061922e+06
  5.80849759e+06]
E1 = -706.6938324374435  E_coul = 198.70322415093452
cycle= 3 E= -507.990608286509  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0037872
diis-c [-3.24236347e-06  1.21736416e-04 -1.06645502e-01  1.10652377e+00]
  HOMO = -0.242893746857945  LUMO = 0.891812045349566
  mo_energy =
[-1.20326555e+02 -1.23809224e+01 -6.67793810e+00 -6.67793810e+00
 -6.67793810e+00 -1.17944800e+00 -2.42893747e-01 -2.42893747e-01
 -2.42893747e-01  8.91812045e-01  5.56088683e+00  2.27858853e+01
  8.25100587e+01  2.77759681e+02  9.05363394e+02  3.15755749e+03
  1.26366277e+04  4.12329456e+04  1.05260649e+05  2.30433442e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.6785858585534  E_coul = 198.68797254112798
cycle= 4 E= -507.990613317425  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173109
diis-c [-5.36455621e-10 -9.38358776e-06  6.84455097e-03 -9.79968978e-02
  1.09116173e+00]
  HOMO = -0.243042972310376  LUMO = 0.891766721521931
  mo_energy =
[-1.20326900e+02 -1.23812616e+01 -6.67827323e+00 -6.67827323e+00
 -6.67827323e+00 -1.17953836e+00 -2.43042972e-01 -2.43042972e-01
 -2.43042972e-01  8.91766722e-01  5.56068071e+00  2.27855818e+01
  8.25097232e+01  2.77759339e+02  9.05363048e+02  3.15755714e+03
  1.26366274e+04  4.12329453e+04  1.05260649e+05  2.30433441e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.6778681427681  E_coul = 198.68725481121348
cycle= 5 E= -507.990613331555  delta_E= -1.41e-08  |g|= 5.68e-06  |ddm|= 0.000667
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.51984e-06
diis-c [-9.01019803e-13  5.94254784e-07 -5.43240542e-04  7.41067502e-03
 -8.84414691e-02  1.08157344e+00]
  HOMO = -0.243045604093509  LUMO = 0.891765974791084
  mo_energy =
[-1.20326906e+02 -1.23812667e+01 -6.67827844e+00 -6.67827844e+00
 -6.67827844e+00 -1.17954017e+00 -2.43045604e-01 -2.43045604e-01
 -2.43045604e-01  8.91765975e-01  5.56067704e+00  2.27855770e+01
  8.25097178e+01  2.77759333e+02  9.05363041e+02  3.15755713e+03
  1.26366274e+04  4.12329453e+04  1.05260649e+05  2.30433441e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.677854858505  E_coul = 198.68724152694367
cycle= 6 E= -507.990613331561  delta_E= -6.71e-12  |g|= 9.18e-08  |ddm|= 1.68e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.677854858505  E_coul = 198.68724152694367
  HOMO = -0.24304564706994  LUMO = 0.891765948888772
  mo_energy =
[-1.20326906e+02 -1.23812668e+01 -6.67827852e+00 -6.67827852e+00
 -6.67827852e+00 -1.17954019e+00 -2.43045647e-01 -2.43045647e-01
 -2.43045647e-01  8.91765949e-01  5.56067697e+00  2.27855770e+01
  8.25097177e+01  2.77759333e+02  9.05363041e+02  3.15755713e+03
  1.26366274e+04  4.12329453e+04  1.05260649e+05  2.30433441e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.6778546712713  E_coul = 198.68724133970989
Extra cycle  E= -507.990613331561  delta_E= -1.14e-13  |g|= 1.18e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      8.32 sec, wall time      0.60 sec
exp = [2.30391402e-01 6.02705829e-01 1.85738379e+00 1.17616813e+05
 4.12180080e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229600e+03
 1.83757703e+04 1.44372062e+03 4.17396626e+02 1.47757090e+02
 5.84863322e+01 2.47505505e+01 9.20494136e+00 8.60445654e+00
 4.92774505e-01]
E = -507.99061333156146
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:01 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.230391401734       1
[INPUT] 0    0    [1    /1   ]  0.602705828903       1
[INPUT] 0    0    [1    /1   ]  1.85738378935        1
[INPUT] 0    0    [1    /1   ]  117616.812859        1
[INPUT] 0    0    [1    /1   ]  4.12180080392        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030917        1
[INPUT] 0    0    [1    /1   ]  147020.991305        1
[INPUT] 0    0    [1    /1   ]  73510.4174706        1
[INPUT] 0    0    [1    /1   ]  36754.7011304        1
[INPUT] 0    0    [1    /1   ]  7302.29600205        1
[INPUT] 0    0    [1    /1   ]  18375.7703486        1
[INPUT] 0    0    [1    /1   ]  1443.72061642        1
[INPUT] 0    0    [1    /1   ]  417.396625982        1
[INPUT] 0    0    [1    /1   ]  147.757089544        1
[INPUT] 0    0    [1    /1   ]  58.4863322373        1
[INPUT] 0    0    [1    /1   ]  24.7505505471        1
[INPUT] 0    0    [1    /1   ]  9.20494136089        1
[INPUT] 1    0    [1    /1   ]  8.60445653804        1
[INPUT] 1    0    [1    /1   ]  0.492774504595       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23039140173406913, 1.0]], [0, [0.6027058289032851, 1.0]], [0, [1.8573837893508076, 1.0]], [0, [117616.81285910735, 1.0]], [0, [4.121800803919184, 1.0]], [0, [1176168.1426132503, 1.0]], [0, [588084.0699556867, 1.0]], [0, [294042.0309167206, 1.0]], [0, [147020.99130468897, 1.0]], [0, [73510.41747059864, 1.0]], [0, [36754.70113037392, 1.0]], [0, [7302.296002054008, 1.0]], [0, [18375.77034862591, 1.0]], [0, [1443.7206164216677, 1.0]], [0, [417.39662598241836, 1.0]], [0, [147.75708954379328, 1.0]], [0, [58.486332237268996, 1.0]], [0, [24.75055054705728, 1.0]], [0, [9.204941360888393, 1.0]], [1, [8.604456538038091, 1.0]], [1, [0.49277450459548733, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2303914]
bas 1, expnt(s) = [0.60270583]
bas 2, expnt(s) = [1.85738379]
bas 3, expnt(s) = [117616.81285911]
bas 4, expnt(s) = [4.1218008]
bas 5, expnt(s) = [1176168.14261325]
bas 6, expnt(s) = [588084.06995569]
bas 7, expnt(s) = [294042.03091672]
bas 8, expnt(s) = [147020.99130469]
bas 9, expnt(s) = [73510.4174706]
bas 10, expnt(s) = [36754.70113037]
bas 11, expnt(s) = [7302.29600205]
bas 12, expnt(s) = [18375.77034863]
bas 13, expnt(s) = [1443.72061642]
bas 14, expnt(s) = [417.39662598]
bas 15, expnt(s) = [147.75708954]
bas 16, expnt(s) = [58.48633224]
bas 17, expnt(s) = [24.75055055]
bas 18, expnt(s) = [9.20494136]
bas 19, expnt(s) = [8.60445654]
bas 20, expnt(s) = [0.4927745]
CPU time:      1130.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30391402e-01 8.40165269e-01 6.02705829e-01 1.72820027e+00
 1.85738379e+00 4.01967798e+00 1.17616813e+05 1.60460108e+04
 4.12180080e+00 7.30853404e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655817e+03 7.30229600e+03 1.99576591e+03
 1.83757703e+04 3.98748617e+03 1.44372062e+03 5.91735184e+02
 4.17396626e+02 2.33306439e+02 1.47757090e+02 1.07072088e+02
 5.84863322e+01 5.34325394e+01 2.47505505e+01 2.80352009e+01
 9.20494136e+00 1.33515226e+01 8.60445654e+00 4.29921039e+01
 4.92774505e-01 1.20446637e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33604571545687
cond(S) = 912670.7570469804
E1 = -689.5984689959738  E_coul = 184.97316899974848
init E= -504.625299996225
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672142888814489  LUMO = 0.547807072699526
  mo_energy =
[-1.21709535e+02 -1.33861775e+01 -7.62348383e+00 -7.62348383e+00
 -7.62348383e+00 -1.65754788e+00 -6.72142889e-01 -6.72142889e-01
 -6.72142889e-01  5.47807073e-01  4.96471121e+00  2.18962235e+01
  8.13324343e+01  2.76423202e+02  9.04004462e+02  3.15627276e+03
  1.26354601e+04  4.12318492e+04  1.05259592e+05  2.30432409e+05
  4.56239695e+05  8.45186136e+05  1.52835777e+06  2.85061823e+06
  5.80849661e+06]
E1 = -707.7570604135148  E_coul = 199.7845310586789
cycle= 1 E= -507.972529354836  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.75985
diis-c [-0.57737127  1.        ]
  HOMO = -0.217576954374065  LUMO = 0.896346759726874
  mo_energy =
[-1.20199846e+02 -1.23045924e+01 -6.59385462e+00 -6.59385462e+00
 -6.59385462e+00 -1.16327824e+00 -2.17576954e-01 -2.17576954e-01
 -2.17576954e-01  8.96346760e-01  5.59369279e+00  2.28508648e+01
  8.26036720e+01  2.77875459e+02  9.05495976e+02  3.15770513e+03
  1.26367861e+04  4.12331080e+04  1.05260813e+05  2.30433607e+05
  4.56240875e+05  8.45187303e+05  1.52835892e+06  2.85061937e+06
  5.80849775e+06]
E1 = -706.8021664996256  E_coul = 198.81182007532777
cycle= 2 E= -507.990346424298  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347002
diis-c [-0.00119917 -0.0029358   1.0029358 ]
  HOMO = -0.239751733986606  LUMO = 0.892573163624739
  mo_energy =
[-1.20314848e+02 -1.23723891e+01 -6.66892413e+00 -6.66892413e+00
 -6.66892413e+00 -1.17754452e+00 -2.39751734e-01 -2.39751734e-01
 -2.39751734e-01  8.92573164e-01  5.56510877e+00  2.27932926e+01
  8.25196797e+01  2.77770722e+02  9.05375335e+02  3.15757013e+03
  1.26366408e+04  4.12329589e+04  1.05260663e+05  2.30433455e+05
  4.56240723e+05  8.45187150e+05  1.52835877e+06  2.85061922e+06
  5.80849759e+06]
E1 = -706.6938324374435  E_coul = 198.70322415093452
cycle= 3 E= -507.990608286509  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0037872
diis-c [-3.24236347e-06  1.21736416e-04 -1.06645502e-01  1.10652377e+00]
  HOMO = -0.242893746857945  LUMO = 0.891812045349566
  mo_energy =
[-1.20326555e+02 -1.23809224e+01 -6.67793810e+00 -6.67793810e+00
 -6.67793810e+00 -1.17944800e+00 -2.42893747e-01 -2.42893747e-01
 -2.42893747e-01  8.91812045e-01  5.56088683e+00  2.27858853e+01
  8.25100587e+01  2.77759681e+02  9.05363394e+02  3.15755749e+03
  1.26366277e+04  4.12329456e+04  1.05260649e+05  2.30433442e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.6785858585534  E_coul = 198.68797254112798
cycle= 4 E= -507.990613317425  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173109
diis-c [-5.36455621e-10 -9.38358776e-06  6.84455097e-03 -9.79968978e-02
  1.09116173e+00]
  HOMO = -0.243042972310376  LUMO = 0.891766721521931
  mo_energy =
[-1.20326900e+02 -1.23812616e+01 -6.67827323e+00 -6.67827323e+00
 -6.67827323e+00 -1.17953836e+00 -2.43042972e-01 -2.43042972e-01
 -2.43042972e-01  8.91766722e-01  5.56068071e+00  2.27855818e+01
  8.25097232e+01  2.77759339e+02  9.05363048e+02  3.15755714e+03
  1.26366274e+04  4.12329453e+04  1.05260649e+05  2.30433441e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.6778681427681  E_coul = 198.68725481121348
cycle= 5 E= -507.990613331555  delta_E= -1.41e-08  |g|= 5.68e-06  |ddm|= 0.000667
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.51984e-06
diis-c [-9.01019803e-13  5.94254784e-07 -5.43240542e-04  7.41067502e-03
 -8.84414691e-02  1.08157344e+00]
  HOMO = -0.243045604093509  LUMO = 0.891765974791084
  mo_energy =
[-1.20326906e+02 -1.23812667e+01 -6.67827844e+00 -6.67827844e+00
 -6.67827844e+00 -1.17954017e+00 -2.43045604e-01 -2.43045604e-01
 -2.43045604e-01  8.91765975e-01  5.56067704e+00  2.27855770e+01
  8.25097178e+01  2.77759333e+02  9.05363041e+02  3.15755713e+03
  1.26366274e+04  4.12329453e+04  1.05260649e+05  2.30433441e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.677854858505  E_coul = 198.68724152694367
cycle= 6 E= -507.990613331561  delta_E= -6.71e-12  |g|= 9.18e-08  |ddm|= 1.68e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.677854858505  E_coul = 198.68724152694367
  HOMO = -0.24304564706994  LUMO = 0.891765948888772
  mo_energy =
[-1.20326906e+02 -1.23812668e+01 -6.67827852e+00 -6.67827852e+00
 -6.67827852e+00 -1.17954019e+00 -2.43045647e-01 -2.43045647e-01
 -2.43045647e-01  8.91765949e-01  5.56067697e+00  2.27855770e+01
  8.25097177e+01  2.77759333e+02  9.05363041e+02  3.15755713e+03
  1.26366274e+04  4.12329453e+04  1.05260649e+05  2.30433441e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.6778546712713  E_coul = 198.68724133970989
Extra cycle  E= -507.990613331561  delta_E= -1.14e-13  |g|= 1.18e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912670.7570469804
E1 = -706.6778546712713  E_coul = 198.68724133970989
init E= -507.990613331561
    CPU time for initialize scf      5.80 sec, wall time      0.25 sec
  HOMO = -0.243045653159285  LUMO = 0.891765949006956
  mo_energy =
[-1.20326906e+02 -1.23812668e+01 -6.67827854e+00 -6.67827854e+00
 -6.67827854e+00 -1.17954019e+00 -2.43045653e-01 -2.43045653e-01
 -2.43045653e-01  8.91765949e-01  5.56067696e+00  2.27855769e+01
  8.25097177e+01  2.77759333e+02  9.05363041e+02  3.15755713e+03
  1.26366274e+04  4.12329453e+04  1.05260649e+05  2.30433441e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.6778546375767  E_coul = 198.68724130601484
cycle= 1 E= -507.990613331562  delta_E= -4.55e-13  |g|= 1.91e-09  |ddm|= 3.26e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6778546375767  E_coul = 198.68724130601484
  HOMO = -0.243045654196505  LUMO = 0.891765945350281
  mo_energy =
[-1.20326906e+02 -1.23812668e+01 -6.67827854e+00 -6.67827854e+00
 -6.67827854e+00 -1.17954020e+00 -2.43045654e-01 -2.43045654e-01
 -2.43045654e-01  8.91765945e-01  5.56067696e+00  2.27855769e+01
  8.25097177e+01  2.77759333e+02  9.05363041e+02  3.15755713e+03
  1.26366274e+04  4.12329453e+04  1.05260649e+05  2.30433441e+05
  4.56240710e+05  8.45187137e+05  1.52835876e+06  2.85061921e+06
  5.80849758e+06]
E1 = -706.6778546391155  E_coul = 198.6872413075542
Extra cycle  E= -507.990613331561  delta_E= 6.25e-13  |g|= 1.96e-09  |ddm|= 8.75e-10
    CPU time for scf_cycle      6.30 sec, wall time      0.41 sec
exp = [2.30391402e-01 6.02705829e-01 1.85738379e+00 1.17616813e+05
 4.12180080e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229600e+03
 1.83757703e+04 1.44372062e+03 4.17396626e+02 1.47757090e+02
 5.84863322e+01 2.47505505e+01 9.20494136e+00 8.60445654e+00
 4.92774505e-01]
grad_E = [-2.10072564e-04  1.43016944e-04 -3.05339243e-05  6.05671576e-09
  1.26253759e-05  4.03784419e-11  1.73972568e-10  9.39453584e-10
  3.71170812e-09  1.54992596e-08  8.08515106e-08  5.09666922e-06
  1.98135771e-07 -3.83619056e-05 -7.30743245e-06  1.27696792e-05
 -6.32919083e-05  1.48757448e-06  2.24360824e-05  1.24093537e-04
  6.64501277e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.23089108105        1
[INPUT] 0    0    [1    /1   ]  0.604574358697       1
[INPUT] 0    0    [1    /1   ]  1.87647059568        1
[INPUT] 0    0    [1    /1   ]  117616.812855        1
[INPUT] 0    0    [1    /1   ]  4.15267621817        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991302        1
[INPUT] 0    0    [1    /1   ]  73510.4174598        1
[INPUT] 0    0    [1    /1   ]  36754.7010739        1
[INPUT] 0    0    [1    /1   ]  7302.29244521        1
[INPUT] 0    0    [1    /1   ]  18375.7702104        1
[INPUT] 0    0    [1    /1   ]  1443.74723995        1
[INPUT] 0    0    [1    /1   ]  417.403173561        1
[INPUT] 0    0    [1    /1   ]  147.743800262        1
[INPUT] 0    0    [1    /1   ]  58.5289431753        1
[INPUT] 0    0    [1    /1   ]  24.7514508071        1
[INPUT] 0    0    [1    /1   ]  9.26659205768        1
[INPUT] 1    0    [1    /1   ]  8.60448948802        1
[INPUT] 1    0    [1    /1   ]  0.49277905376        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23089108104996656, 1.0]], [0, [0.6045743586966734, 1.0]], [0, [1.876470595675584, 1.0]], [0, [117616.81285488035, 1.0]], [0, [4.152676218173087, 1.0]], [0, [1176168.1426132221, 1.0]], [0, [588084.0699555653, 1.0]], [0, [294042.030916065, 1.0]], [0, [147020.99130209858, 1.0]], [0, [73510.41745978186, 1.0]], [0, [36754.701073945056, 1.0]], [0, [7302.2924452082625, 1.0]], [0, [18375.77021037577, 1.0]], [0, [1443.7472399499843, 1.0]], [0, [417.40317356141276, 1.0]], [0, [147.74380026174876, 1.0]], [0, [58.52894317529755, 1.0]], [0, [24.751450807052393, 1.0]], [0, [9.26659205768286, 1.0]], [1, [8.604489488015878, 1.0]], [1, [0.4927790537600695, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23089108]
bas 1, expnt(s) = [0.60457436]
bas 2, expnt(s) = [1.8764706]
bas 3, expnt(s) = [117616.81285488]
bas 4, expnt(s) = [4.15267622]
bas 5, expnt(s) = [1176168.14261322]
bas 6, expnt(s) = [588084.06995557]
bas 7, expnt(s) = [294042.03091606]
bas 8, expnt(s) = [147020.9913021]
bas 9, expnt(s) = [73510.41745978]
bas 10, expnt(s) = [36754.70107395]
bas 11, expnt(s) = [7302.29244521]
bas 12, expnt(s) = [18375.77021038]
bas 13, expnt(s) = [1443.74723995]
bas 14, expnt(s) = [417.40317356]
bas 15, expnt(s) = [147.74380026]
bas 16, expnt(s) = [58.52894318]
bas 17, expnt(s) = [24.75145081]
bas 18, expnt(s) = [9.26659206]
bas 19, expnt(s) = [8.60448949]
bas 20, expnt(s) = [0.49277905]
CPU time:      1144.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30891081e-01 8.41531529e-01 6.04574359e-01 1.73221708e+00
 1.87647060e+00 4.05061855e+00 1.17616813e+05 1.60460108e+04
 4.15267622e+00 7.34955556e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229245e+03 1.99576518e+03
 1.83757702e+04 3.98748615e+03 1.44374724e+03 5.91743368e+02
 4.17403174e+02 2.33309184e+02 1.47743800e+02 1.07064865e+02
 5.85289432e+01 5.34617334e+01 2.47514508e+01 2.80359657e+01
 9.26659206e+00 1.34185336e+01 8.60448949e+00 4.29923097e+01
 4.92779054e-01 1.20448027e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336037558253718
cond(S) = 912685.1696780274
E1 = -689.5985323986448  E_coul = 184.97344506632564
init E= -504.625087332319
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672137843776423  LUMO = 0.551436126928964
  mo_energy =
[-1.21709496e+02 -1.33861571e+01 -7.62346629e+00 -7.62346629e+00
 -7.62346629e+00 -1.65753901e+00 -6.72137844e-01 -6.72137844e-01
 -6.72137844e-01  5.51436127e-01  5.01548312e+00  2.21114001e+01
  8.17588045e+01  2.76966031e+02  9.04568713e+02  3.15682700e+03
  1.26360090e+04  4.12323774e+04  1.05260101e+05  2.30432904e+05
  4.56240180e+05  8.45186613e+05  1.52835824e+06  2.85061869e+06
  5.80849705e+06]
E1 = -707.7573335756286  E_coul = 199.7848012280818
cycle= 1 E= -507.972532347547  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.760116
diis-c [-0.57777621  1.        ]
  HOMO = -0.21757006955761  LUMO = 0.900889565166813
  mo_energy =
[-1.20199806e+02 -1.23045734e+01 -6.59383900e+00 -6.59383900e+00
 -6.59383900e+00 -1.16327015e+00 -2.17570070e-01 -2.17570070e-01
 -2.17570070e-01  9.00889565e-01  5.64709114e+00  2.30682270e+01
  8.30304344e+01  2.78418252e+02  9.06060200e+02  3.15825936e+03
  1.26373350e+04  4.12336362e+04  1.05261323e+05  2.30434102e+05
  4.56241360e+05  8.45187779e+05  1.52835939e+06  2.85061983e+06
  5.80849819e+06]
E1 = -706.8025120946214  E_coul = 198.8121635233334
cycle= 2 E= -507.990348571288  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0346296
diis-c [-0.00119439 -0.00289927  1.00289927]
  HOMO = -0.239742006978107  LUMO = 0.897075460988168
  mo_energy =
[-1.20314798e+02 -1.23723621e+01 -6.66890007e+00 -6.66890007e+00
 -6.66890007e+00 -1.17753416e+00 -2.39742007e-01 -2.39742007e-01
 -2.39742007e-01  8.97075461e-01  5.61828488e+00  2.30104761e+01
  8.29464033e+01  2.78313524e+02  9.05939573e+02  3.15812437e+03
  1.26371897e+04  4.12334871e+04  1.05261172e+05  2.30433950e+05
  4.56241208e+05  8.45187627e+05  1.52835924e+06  2.85061968e+06
  5.80849804e+06]
E1 = -706.6942232827741  E_coul = 198.7036130409565
cycle= 3 E= -507.990610241818  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0037725
diis-c [-3.22982282e-06  1.24591832e-04 -1.06364420e-01  1.10623983e+00]
  HOMO = -0.242881971015636  LUMO = 0.896308544346458
  mo_energy =
[-1.20326502e+02 -1.23808919e+01 -6.67791070e+00 -6.67791070e+00
 -6.67791070e+00 -1.17943626e+00 -2.42881971e-01 -2.42881971e-01
 -2.42881971e-01  8.96308544e-01  5.61403689e+00  2.30030537e+01
  8.29367818e+01  2.78302487e+02  9.05927635e+02  3.15811173e+03
  1.26371766e+04  4.12334738e+04  1.05261159e+05  2.30433937e+05
  4.56241195e+05  8.45187614e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6789929400942  E_coul = 198.68837767885609
cycle= 4 E= -507.990615261238  delta_E= -5.02e-06  |g|= 0.000233  |ddm|= 0.0103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017302
diis-c [-5.24950200e-10 -9.34514555e-06  6.83727201e-03 -9.81827191e-02
  1.09135479e+00]
  HOMO = -0.243031676029768  LUMO = 0.896262854403366
  mo_energy =
[-1.20326850e+02 -1.23812330e+01 -6.67824783e+00 -6.67824783e+00
 -6.67824783e+00 -1.17952690e+00 -2.43031676e-01 -2.43031676e-01
 -2.43031676e-01  8.96262854e-01  5.61382898e+00  2.30027483e+01
  8.29364440e+01  2.78302141e+02  9.05927286e+02  3.15811138e+03
  1.26371763e+04  4.12334735e+04  1.05261158e+05  2.30433936e+05
  4.56241194e+05  8.45187613e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6782733536631  E_coul = 198.6876580783051
cycle= 5 E= -507.990615275358  delta_E= -1.41e-08  |g|= 5.57e-06  |ddm|= 0.000663
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.47672e-06
diis-c [-8.83695444e-13  5.95326947e-07 -5.36728668e-04  7.34230148e-03
 -8.74364027e-02  1.08063023e+00]
  HOMO = -0.243034270591977  LUMO = 0.896262115716905
  mo_energy =
[-1.20326856e+02 -1.23812381e+01 -6.67825298e+00 -6.67825298e+00
 -6.67825298e+00 -1.17952868e+00 -2.43034271e-01 -2.43034271e-01
 -2.43034271e-01  8.96262116e-01  5.61382535e+00  2.30027435e+01
  8.29364387e+01  2.78302136e+02  9.05927280e+02  3.15811137e+03
  1.26371763e+04  4.12334735e+04  1.05261158e+05  2.30433936e+05
  4.56241194e+05  8.45187613e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6782602748592  E_coul = 198.68764499949472
cycle= 6 E= -507.990615275364  delta_E= -6.42e-12  |g|= 9.24e-08  |ddm|= 1.64e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6782602748592  E_coul = 198.68764499949472
  HOMO = -0.243034313509213  LUMO = 0.896262090715638
  mo_energy =
[-1.20326856e+02 -1.23812382e+01 -6.67825306e+00 -6.67825306e+00
 -6.67825306e+00 -1.17952870e+00 -2.43034314e-01 -2.43034314e-01
 -2.43034314e-01  8.96262091e-01  5.61382528e+00  2.30027435e+01
  8.29364386e+01  2.78302136e+02  9.05927280e+02  3.15811137e+03
  1.26371763e+04  4.12334735e+04  1.05261158e+05  2.30433936e+05
  4.56241194e+05  8.45187613e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6782600833204  E_coul = 198.68764480795573
Extra cycle  E= -507.990615275365  delta_E= -2.27e-13  |g|= 1.18e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.30891081e-01 6.04574359e-01 1.87647060e+00 1.17616813e+05
 4.15267622e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229245e+03
 1.83757702e+04 1.44374724e+03 4.17403174e+02 1.47743800e+02
 5.85289432e+01 2.47514508e+01 9.26659206e+00 8.60448949e+00
 4.92779054e-01]
E = -507.9906152753647
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.23089108105        1
[INPUT] 0    0    [1    /1   ]  0.604574358697       1
[INPUT] 0    0    [1    /1   ]  1.87647059568        1
[INPUT] 0    0    [1    /1   ]  117616.812855        1
[INPUT] 0    0    [1    /1   ]  4.15267621817        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991302        1
[INPUT] 0    0    [1    /1   ]  73510.4174598        1
[INPUT] 0    0    [1    /1   ]  36754.7010739        1
[INPUT] 0    0    [1    /1   ]  7302.29244521        1
[INPUT] 0    0    [1    /1   ]  18375.7702104        1
[INPUT] 0    0    [1    /1   ]  1443.74723995        1
[INPUT] 0    0    [1    /1   ]  417.403173561        1
[INPUT] 0    0    [1    /1   ]  147.743800262        1
[INPUT] 0    0    [1    /1   ]  58.5289431753        1
[INPUT] 0    0    [1    /1   ]  24.7514508071        1
[INPUT] 0    0    [1    /1   ]  9.26659205768        1
[INPUT] 1    0    [1    /1   ]  8.60448948802        1
[INPUT] 1    0    [1    /1   ]  0.49277905376        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23089108104996656, 1.0]], [0, [0.6045743586966734, 1.0]], [0, [1.876470595675584, 1.0]], [0, [117616.81285488035, 1.0]], [0, [4.152676218173087, 1.0]], [0, [1176168.1426132221, 1.0]], [0, [588084.0699555653, 1.0]], [0, [294042.030916065, 1.0]], [0, [147020.99130209858, 1.0]], [0, [73510.41745978186, 1.0]], [0, [36754.701073945056, 1.0]], [0, [7302.2924452082625, 1.0]], [0, [18375.77021037577, 1.0]], [0, [1443.7472399499843, 1.0]], [0, [417.40317356141276, 1.0]], [0, [147.74380026174876, 1.0]], [0, [58.52894317529755, 1.0]], [0, [24.751450807052393, 1.0]], [0, [9.26659205768286, 1.0]], [1, [8.604489488015878, 1.0]], [1, [0.4927790537600695, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23089108]
bas 1, expnt(s) = [0.60457436]
bas 2, expnt(s) = [1.8764706]
bas 3, expnt(s) = [117616.81285488]
bas 4, expnt(s) = [4.15267622]
bas 5, expnt(s) = [1176168.14261322]
bas 6, expnt(s) = [588084.06995557]
bas 7, expnt(s) = [294042.03091606]
bas 8, expnt(s) = [147020.9913021]
bas 9, expnt(s) = [73510.41745978]
bas 10, expnt(s) = [36754.70107395]
bas 11, expnt(s) = [7302.29244521]
bas 12, expnt(s) = [18375.77021038]
bas 13, expnt(s) = [1443.74723995]
bas 14, expnt(s) = [417.40317356]
bas 15, expnt(s) = [147.74380026]
bas 16, expnt(s) = [58.52894318]
bas 17, expnt(s) = [24.75145081]
bas 18, expnt(s) = [9.26659206]
bas 19, expnt(s) = [8.60448949]
bas 20, expnt(s) = [0.49277905]
CPU time:      1146.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30891081e-01 8.41531529e-01 6.04574359e-01 1.73221708e+00
 1.87647060e+00 4.05061855e+00 1.17616813e+05 1.60460108e+04
 4.15267622e+00 7.34955556e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229245e+03 1.99576518e+03
 1.83757702e+04 3.98748615e+03 1.44374724e+03 5.91743368e+02
 4.17403174e+02 2.33309184e+02 1.47743800e+02 1.07064865e+02
 5.85289432e+01 5.34617334e+01 2.47514508e+01 2.80359657e+01
 9.26659206e+00 1.34185336e+01 8.60448949e+00 4.29923097e+01
 4.92779054e-01 1.20448027e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336037558253718
cond(S) = 912685.1696780274
E1 = -689.5985323986448  E_coul = 184.97344506632564
init E= -504.625087332319
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672137843776423  LUMO = 0.551436126928964
  mo_energy =
[-1.21709496e+02 -1.33861571e+01 -7.62346629e+00 -7.62346629e+00
 -7.62346629e+00 -1.65753901e+00 -6.72137844e-01 -6.72137844e-01
 -6.72137844e-01  5.51436127e-01  5.01548312e+00  2.21114001e+01
  8.17588045e+01  2.76966031e+02  9.04568713e+02  3.15682700e+03
  1.26360090e+04  4.12323774e+04  1.05260101e+05  2.30432904e+05
  4.56240180e+05  8.45186613e+05  1.52835824e+06  2.85061869e+06
  5.80849705e+06]
E1 = -707.7573335756286  E_coul = 199.7848012280818
cycle= 1 E= -507.972532347547  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.760116
diis-c [-0.57777621  1.        ]
  HOMO = -0.21757006955761  LUMO = 0.900889565166813
  mo_energy =
[-1.20199806e+02 -1.23045734e+01 -6.59383900e+00 -6.59383900e+00
 -6.59383900e+00 -1.16327015e+00 -2.17570070e-01 -2.17570070e-01
 -2.17570070e-01  9.00889565e-01  5.64709114e+00  2.30682270e+01
  8.30304344e+01  2.78418252e+02  9.06060200e+02  3.15825936e+03
  1.26373350e+04  4.12336362e+04  1.05261323e+05  2.30434102e+05
  4.56241360e+05  8.45187779e+05  1.52835939e+06  2.85061983e+06
  5.80849819e+06]
E1 = -706.8025120946214  E_coul = 198.8121635233334
cycle= 2 E= -507.990348571288  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0346296
diis-c [-0.00119439 -0.00289927  1.00289927]
  HOMO = -0.239742006978107  LUMO = 0.897075460988168
  mo_energy =
[-1.20314798e+02 -1.23723621e+01 -6.66890007e+00 -6.66890007e+00
 -6.66890007e+00 -1.17753416e+00 -2.39742007e-01 -2.39742007e-01
 -2.39742007e-01  8.97075461e-01  5.61828488e+00  2.30104761e+01
  8.29464033e+01  2.78313524e+02  9.05939573e+02  3.15812437e+03
  1.26371897e+04  4.12334871e+04  1.05261172e+05  2.30433950e+05
  4.56241208e+05  8.45187627e+05  1.52835924e+06  2.85061968e+06
  5.80849804e+06]
E1 = -706.6942232827741  E_coul = 198.7036130409565
cycle= 3 E= -507.990610241818  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0037725
diis-c [-3.22982282e-06  1.24591832e-04 -1.06364420e-01  1.10623983e+00]
  HOMO = -0.242881971015636  LUMO = 0.896308544346458
  mo_energy =
[-1.20326502e+02 -1.23808919e+01 -6.67791070e+00 -6.67791070e+00
 -6.67791070e+00 -1.17943626e+00 -2.42881971e-01 -2.42881971e-01
 -2.42881971e-01  8.96308544e-01  5.61403689e+00  2.30030537e+01
  8.29367818e+01  2.78302487e+02  9.05927635e+02  3.15811173e+03
  1.26371766e+04  4.12334738e+04  1.05261159e+05  2.30433937e+05
  4.56241195e+05  8.45187614e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6789929400942  E_coul = 198.68837767885609
cycle= 4 E= -507.990615261238  delta_E= -5.02e-06  |g|= 0.000233  |ddm|= 0.0103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017302
diis-c [-5.24950200e-10 -9.34514555e-06  6.83727201e-03 -9.81827191e-02
  1.09135479e+00]
  HOMO = -0.243031676029768  LUMO = 0.896262854403366
  mo_energy =
[-1.20326850e+02 -1.23812330e+01 -6.67824783e+00 -6.67824783e+00
 -6.67824783e+00 -1.17952690e+00 -2.43031676e-01 -2.43031676e-01
 -2.43031676e-01  8.96262854e-01  5.61382898e+00  2.30027483e+01
  8.29364440e+01  2.78302141e+02  9.05927286e+02  3.15811138e+03
  1.26371763e+04  4.12334735e+04  1.05261158e+05  2.30433936e+05
  4.56241194e+05  8.45187613e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6782733536631  E_coul = 198.6876580783051
cycle= 5 E= -507.990615275358  delta_E= -1.41e-08  |g|= 5.57e-06  |ddm|= 0.000663
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.47672e-06
diis-c [-8.83695444e-13  5.95326947e-07 -5.36728668e-04  7.34230148e-03
 -8.74364027e-02  1.08063023e+00]
  HOMO = -0.243034270591977  LUMO = 0.896262115716905
  mo_energy =
[-1.20326856e+02 -1.23812381e+01 -6.67825298e+00 -6.67825298e+00
 -6.67825298e+00 -1.17952868e+00 -2.43034271e-01 -2.43034271e-01
 -2.43034271e-01  8.96262116e-01  5.61382535e+00  2.30027435e+01
  8.29364387e+01  2.78302136e+02  9.05927280e+02  3.15811137e+03
  1.26371763e+04  4.12334735e+04  1.05261158e+05  2.30433936e+05
  4.56241194e+05  8.45187613e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6782602748592  E_coul = 198.68764499949472
cycle= 6 E= -507.990615275364  delta_E= -6.42e-12  |g|= 9.24e-08  |ddm|= 1.64e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6782602748592  E_coul = 198.68764499949472
  HOMO = -0.243034313509213  LUMO = 0.896262090715638
  mo_energy =
[-1.20326856e+02 -1.23812382e+01 -6.67825306e+00 -6.67825306e+00
 -6.67825306e+00 -1.17952870e+00 -2.43034314e-01 -2.43034314e-01
 -2.43034314e-01  8.96262091e-01  5.61382528e+00  2.30027435e+01
  8.29364386e+01  2.78302136e+02  9.05927280e+02  3.15811137e+03
  1.26371763e+04  4.12334735e+04  1.05261158e+05  2.30433936e+05
  4.56241194e+05  8.45187613e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6782600833204  E_coul = 198.68764480795573
Extra cycle  E= -507.990615275365  delta_E= -2.27e-13  |g|= 1.18e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912685.1696780274
E1 = -706.6782600833204  E_coul = 198.68764480795573
init E= -507.990615275365
    CPU time for initialize scf      5.80 sec, wall time      0.25 sec
  HOMO = -0.243034319699425  LUMO = 0.896262090653465
  mo_energy =
[-1.20326856e+02 -1.23812382e+01 -6.67825308e+00 -6.67825308e+00
 -6.67825308e+00 -1.17952870e+00 -2.43034320e-01 -2.43034320e-01
 -2.43034320e-01  8.96262091e-01  5.61382527e+00  2.30027434e+01
  8.29364386e+01  2.78302136e+02  9.05927280e+02  3.15811137e+03
  1.26371763e+04  4.12334735e+04  1.05261158e+05  2.30433936e+05
  4.56241194e+05  8.45187613e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.6782600526287  E_coul = 198.68764477726404
cycle= 1 E= -507.990615275365  delta_E=    0  |g|= 1.92e-09  |ddm|= 3.05e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6782600526287  E_coul = 198.68764477726404
  HOMO = -0.243034320664902  LUMO = 0.896262088220114
  mo_energy =
[-1.20326856e+02 -1.23812382e+01 -6.67825308e+00 -6.67825308e+00
 -6.67825308e+00 -1.17952871e+00 -2.43034321e-01 -2.43034321e-01
 -2.43034321e-01  8.96262088e-01  5.61382527e+00  2.30027434e+01
  8.29364386e+01  2.78302136e+02  9.05927280e+02  3.15811137e+03
  1.26371763e+04  4.12334735e+04  1.05261158e+05  2.30433936e+05
  4.56241194e+05  8.45187613e+05  1.52835923e+06  2.85061967e+06
  5.80849803e+06]
E1 = -706.678260050068  E_coul = 198.6876447747035
Extra cycle  E= -507.990615275365  delta_E= 1.14e-13  |g|= 1.52e-09  |ddm|= 2.46e-09
    CPU time for scf_cycle      6.30 sec, wall time      0.41 sec
exp = [2.30891081e-01 6.04574359e-01 1.87647060e+00 1.17616813e+05
 4.15267622e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229245e+03
 1.83757702e+04 1.44374724e+03 4.17403174e+02 1.47743800e+02
 5.85289432e+01 2.47514508e+01 9.26659206e+00 8.60448949e+00
 4.92779054e-01]
grad_E = [-3.03278745e-04  1.98919485e-04 -2.56207351e-05  6.06522245e-09
  4.45454931e-06  4.04740159e-11  1.74251479e-10  9.40758375e-10
  3.71697646e-09  1.55215477e-08  8.09592279e-08  5.10373060e-06
  1.98486722e-07 -3.86882770e-05 -4.42682775e-06  1.26231383e-06
 -4.13479944e-05 -1.41005469e-05  2.74220684e-05  1.47029513e-04
  8.07125338e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.230595745241       1
[INPUT] 0    0    [1    /1   ]  0.603402818186       1
[INPUT] 0    0    [1    /1   ]  1.86937098334        1
[INPUT] 0    0    [1    /1   ]  117616.812851        1
[INPUT] 0    0    [1    /1   ]  4.14214551379        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.9913          1
[INPUT] 0    0    [1    /1   ]  73510.417451         1
[INPUT] 0    0    [1    /1   ]  36754.7010281        1
[INPUT] 0    0    [1    /1   ]  7302.28955831        1
[INPUT] 0    0    [1    /1   ]  18375.7700982        1
[INPUT] 0    0    [1    /1   ]  1443.76881078        1
[INPUT] 0    0    [1    /1   ]  417.408976001        1
[INPUT] 0    0    [1    /1   ]  147.730123849        1
[INPUT] 0    0    [1    /1   ]  58.5762409338        1
[INPUT] 0    0    [1    /1   ]  24.7427714782        1
[INPUT] 0    0    [1    /1   ]  9.25635949008        1
[INPUT] 1    0    [1    /1   ]  8.60445078724        1
[INPUT] 1    0    [1    /1   ]  0.492773791947       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23059574524117613, 1.0]], [0, [0.6034028181859978, 1.0]], [0, [1.8693709833449466, 1.0]], [0, [117616.81285144968, 1.0]], [0, [4.1421455137862635, 1.0]], [0, [1176168.1426131993, 1.0]], [0, [588084.0699554668, 1.0]], [0, [294042.03091553284, 1.0]], [0, [147020.9912999962, 1.0]], [0, [73510.417451003, 1.0]], [0, [36754.70102814561, 1.0]], [0, [7302.289558313283, 1.0]], [0, [18375.770098187128, 1.0]], [0, [1443.768810776303, 1.0]], [0, [417.4089760012308, 1.0]], [0, [147.73012384933384, 1.0]], [0, [58.57624093383623, 1.0]], [0, [24.74277147822419, 1.0]], [0, [9.256359490078106, 1.0]], [1, [8.604450787236026, 1.0]], [1, [0.49277379194696563, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23059575]
bas 1, expnt(s) = [0.60340282]
bas 2, expnt(s) = [1.86937098]
bas 3, expnt(s) = [117616.81285145]
bas 4, expnt(s) = [4.14214551]
bas 5, expnt(s) = [1176168.1426132]
bas 6, expnt(s) = [588084.06995547]
bas 7, expnt(s) = [294042.03091553]
bas 8, expnt(s) = [147020.9913]
bas 9, expnt(s) = [73510.417451]
bas 10, expnt(s) = [36754.70102815]
bas 11, expnt(s) = [7302.28955831]
bas 12, expnt(s) = [18375.77009819]
bas 13, expnt(s) = [1443.76881078]
bas 14, expnt(s) = [417.408976]
bas 15, expnt(s) = [147.73012385]
bas 16, expnt(s) = [58.57624093]
bas 17, expnt(s) = [24.74277148]
bas 18, expnt(s) = [9.25635949]
bas 19, expnt(s) = [8.60445079]
bas 20, expnt(s) = [0.49277379]
CPU time:      1161.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30595745e-01 8.40724090e-01 6.03402818e-01 1.72969896e+00
 1.86937098e+00 4.03911899e+00 1.17616813e+05 1.60460108e+04
 4.14214551e+00 7.33557291e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547010e+04 6.70655816e+03 7.30228956e+03 1.99576459e+03
 1.83757701e+04 3.98748613e+03 1.44376881e+03 5.91749999e+02
 4.17408976e+02 2.33311616e+02 1.47730124e+02 1.07057432e+02
 5.85762409e+01 5.34941323e+01 2.47427715e+01 2.80285920e+01
 9.25635949e+00 1.34074191e+01 8.60445079e+00 4.29920680e+01
 4.92773792e-01 1.20446420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336045549045817
cond(S) = 912683.3724747427
E1 = -689.5977795548814  E_coul = 184.97308782691073
init E= -504.624691727971
    CPU time for initialize scf      0.79 sec, wall time      0.08 sec
  HOMO = -0.672144965089863  LUMO = 0.549454020252202
  mo_energy =
[-1.21709550e+02 -1.33861833e+01 -7.62348943e+00 -7.62348943e+00
 -7.62348943e+00 -1.65754661e+00 -6.72144965e-01 -6.72144965e-01
 -6.72144965e-01  5.49454020e-01  4.99507329e+00  2.20422372e+01
  8.16486912e+01  2.76901420e+02  9.04559523e+02  3.15685739e+03
  1.26360846e+04  4.12324634e+04  1.05260186e+05  2.30432987e+05
  4.56240260e+05  8.45186692e+05  1.52835832e+06  2.85061876e+06
  5.80849713e+06]
E1 = -707.756905235685  E_coul = 199.78437014916375
cycle= 1 E= -507.972535086521  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.760081
diis-c [-0.57772299  1.        ]
  HOMO = -0.217580567011849  LUMO = 0.898454762948247
  mo_energy =
[-1.20199867e+02 -1.23046045e+01 -6.59386709e+00 -6.59386709e+00
 -6.59386709e+00 -1.16327918e+00 -2.17580567e-01 -2.17580567e-01
 -2.17580567e-01  8.98454763e-01  5.62575304e+00  2.29984923e+01
  8.29202951e+01  2.78353688e+02  9.06051014e+02  3.15828975e+03
  1.26374106e+04  4.12337222e+04  1.05261407e+05  2.30434184e+05
  4.56241441e+05  8.45187859e+05  1.52835947e+06  2.85061991e+06
  5.80849827e+06]
E1 = -706.8020889102737  E_coul = 198.81173832702078
cycle= 2 E= -507.990350583253  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0346615
diis-c [-0.00119654 -0.00291761  1.00291761]
  HOMO = -0.239752595135154  LUMO = 0.894659934667046
  mo_energy =
[-1.20314860e+02 -1.23723941e+01 -6.66892921e+00 -6.66892921e+00
 -6.66892921e+00 -1.17754354e+00 -2.39752595e-01 -2.39752595e-01
 -2.39752595e-01  8.94659935e-01  5.59703038e+00  2.29407926e+01
  8.28362687e+01  2.78248954e+02  9.05930385e+02  3.15815475e+03
  1.26372653e+04  4.12335731e+04  1.05261257e+05  2.30434033e+05
  4.56241289e+05  8.45187706e+05  1.52835932e+06  2.85061976e+06
  5.80849811e+06]
E1 = -706.6937748891446  E_coul = 198.70316251824823
cycle= 3 E= -507.990612370896  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00377871
diis-c [-3.23591794e-06  1.23361875e-04 -1.06472333e-01  1.10634897e+00]
  HOMO = -0.242893602655624  LUMO = 0.893895705222399
  mo_energy =
[-1.20326566e+02 -1.23809256e+01 -6.67794143e+00 -6.67794143e+00
 -6.67794143e+00 -1.17944636e+00 -2.42893603e-01 -2.42893603e-01
 -2.42893603e-01  8.93895705e-01  5.59279158e+00  2.29333737e+01
  8.28266462e+01  2.78237915e+02  9.05918445e+02  3.15814212e+03
  1.26372522e+04  4.12335598e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.6785349752125  E_coul = 198.6879175776736
cycle= 4 E= -507.990617397539  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173148
diis-c [-5.31123317e-10 -9.36196152e-06  6.84166162e-03 -9.81417728e-02
  1.09130947e+00]
  HOMO = -0.243043226346383  LUMO = 0.893850152248036
  mo_energy =
[-1.20326913e+02 -1.23812661e+01 -6.67827800e+00 -6.67827800e+00
 -6.67827800e+00 -1.17953696e+00 -2.43043226e-01 -2.43043226e-01
 -2.43043226e-01  8.93850152e-01  5.59258420e+00  2.29330688e+01
  8.28263091e+01  2.78237570e+02  9.05918097e+02  3.15814177e+03
  1.26372519e+04  4.12335595e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.6778154770099  E_coul = 198.68719806532098
cycle= 5 E= -507.990617411689  delta_E= -1.41e-08  |g|= 5.62e-06  |ddm|= 0.000665
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.49837e-06
diis-c [-8.88661099e-13  6.00013927e-07 -5.40422262e-04  7.38524227e-03
 -8.79865239e-02  1.08114110e+00]
  HOMO = -0.243045840073965  LUMO = 0.893849408317642
  mo_energy =
[-1.20326919e+02 -1.23812712e+01 -6.67828318e+00 -6.67828318e+00
 -6.67828318e+00 -1.17953876e+00 -2.43045840e-01 -2.43045840e-01
 -2.43045840e-01  8.93849408e-01  5.59258054e+00  2.29330641e+01
  8.28263037e+01  2.78237564e+02  9.05918091e+02  3.15814176e+03
  1.26372519e+04  4.12335595e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.6778022904695  E_coul = 198.68718487877413
cycle= 6 E= -507.990617411695  delta_E= -6.48e-12  |g|= 9.15e-08  |ddm|= 1.66e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6778022904695  E_coul = 198.68718487877413
  HOMO = -0.243045882974969  LUMO = 0.893849384918755
  mo_energy =
[-1.20326919e+02 -1.23812713e+01 -6.67828326e+00 -6.67828326e+00
 -6.67828326e+00 -1.17953878e+00 -2.43045883e-01 -2.43045883e-01
 -2.43045883e-01  8.93849385e-01  5.59258048e+00  2.29330640e+01
  8.28263036e+01  2.78237564e+02  9.05918091e+02  3.15814176e+03
  1.26372519e+04  4.12335595e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.677802102057  E_coul = 198.6871846903613
Extra cycle  E= -507.990617411696  delta_E= -3.41e-13  |g|= 1.15e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      1.57 sec, wall time      0.30 sec
exp = [2.30595745e-01 6.03402818e-01 1.86937098e+00 1.17616813e+05
 4.14214551e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547010e+04 7.30228956e+03
 1.83757701e+04 1.44376881e+03 4.17408976e+02 1.47730124e+02
 5.85762409e+01 2.47427715e+01 9.25635949e+00 8.60445079e+00
 4.92773792e-01]
E = -507.99061741169567
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.230595745241       1
[INPUT] 0    0    [1    /1   ]  0.603402818186       1
[INPUT] 0    0    [1    /1   ]  1.86937098334        1
[INPUT] 0    0    [1    /1   ]  117616.812851        1
[INPUT] 0    0    [1    /1   ]  4.14214551379        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.9913          1
[INPUT] 0    0    [1    /1   ]  73510.417451         1
[INPUT] 0    0    [1    /1   ]  36754.7010281        1
[INPUT] 0    0    [1    /1   ]  7302.28955831        1
[INPUT] 0    0    [1    /1   ]  18375.7700982        1
[INPUT] 0    0    [1    /1   ]  1443.76881078        1
[INPUT] 0    0    [1    /1   ]  417.408976001        1
[INPUT] 0    0    [1    /1   ]  147.730123849        1
[INPUT] 0    0    [1    /1   ]  58.5762409338        1
[INPUT] 0    0    [1    /1   ]  24.7427714782        1
[INPUT] 0    0    [1    /1   ]  9.25635949008        1
[INPUT] 1    0    [1    /1   ]  8.60445078724        1
[INPUT] 1    0    [1    /1   ]  0.492773791947       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23059574524117613, 1.0]], [0, [0.6034028181859978, 1.0]], [0, [1.8693709833449466, 1.0]], [0, [117616.81285144968, 1.0]], [0, [4.1421455137862635, 1.0]], [0, [1176168.1426131993, 1.0]], [0, [588084.0699554668, 1.0]], [0, [294042.03091553284, 1.0]], [0, [147020.9912999962, 1.0]], [0, [73510.417451003, 1.0]], [0, [36754.70102814561, 1.0]], [0, [7302.289558313283, 1.0]], [0, [18375.770098187128, 1.0]], [0, [1443.768810776303, 1.0]], [0, [417.4089760012308, 1.0]], [0, [147.73012384933384, 1.0]], [0, [58.57624093383623, 1.0]], [0, [24.74277147822419, 1.0]], [0, [9.256359490078106, 1.0]], [1, [8.604450787236026, 1.0]], [1, [0.49277379194696563, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23059575]
bas 1, expnt(s) = [0.60340282]
bas 2, expnt(s) = [1.86937098]
bas 3, expnt(s) = [117616.81285145]
bas 4, expnt(s) = [4.14214551]
bas 5, expnt(s) = [1176168.1426132]
bas 6, expnt(s) = [588084.06995547]
bas 7, expnt(s) = [294042.03091553]
bas 8, expnt(s) = [147020.9913]
bas 9, expnt(s) = [73510.417451]
bas 10, expnt(s) = [36754.70102815]
bas 11, expnt(s) = [7302.28955831]
bas 12, expnt(s) = [18375.77009819]
bas 13, expnt(s) = [1443.76881078]
bas 14, expnt(s) = [417.408976]
bas 15, expnt(s) = [147.73012385]
bas 16, expnt(s) = [58.57624093]
bas 17, expnt(s) = [24.74277148]
bas 18, expnt(s) = [9.25635949]
bas 19, expnt(s) = [8.60445079]
bas 20, expnt(s) = [0.49277379]
CPU time:      1163.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30595745e-01 8.40724090e-01 6.03402818e-01 1.72969896e+00
 1.86937098e+00 4.03911899e+00 1.17616813e+05 1.60460108e+04
 4.14214551e+00 7.33557291e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547010e+04 6.70655816e+03 7.30228956e+03 1.99576459e+03
 1.83757701e+04 3.98748613e+03 1.44376881e+03 5.91749999e+02
 4.17408976e+02 2.33311616e+02 1.47730124e+02 1.07057432e+02
 5.85762409e+01 5.34941323e+01 2.47427715e+01 2.80285920e+01
 9.25635949e+00 1.34074191e+01 8.60445079e+00 4.29920680e+01
 4.92773792e-01 1.20446420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336045549045817
cond(S) = 912683.3724747427
E1 = -689.5977795548814  E_coul = 184.97308782691073
init E= -504.624691727971
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672144965089863  LUMO = 0.549454020252202
  mo_energy =
[-1.21709550e+02 -1.33861833e+01 -7.62348943e+00 -7.62348943e+00
 -7.62348943e+00 -1.65754661e+00 -6.72144965e-01 -6.72144965e-01
 -6.72144965e-01  5.49454020e-01  4.99507329e+00  2.20422372e+01
  8.16486912e+01  2.76901420e+02  9.04559523e+02  3.15685739e+03
  1.26360846e+04  4.12324634e+04  1.05260186e+05  2.30432987e+05
  4.56240260e+05  8.45186692e+05  1.52835832e+06  2.85061876e+06
  5.80849713e+06]
E1 = -707.756905235685  E_coul = 199.78437014916375
cycle= 1 E= -507.972535086521  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.760081
diis-c [-0.57772299  1.        ]
  HOMO = -0.217580567011849  LUMO = 0.898454762948247
  mo_energy =
[-1.20199867e+02 -1.23046045e+01 -6.59386709e+00 -6.59386709e+00
 -6.59386709e+00 -1.16327918e+00 -2.17580567e-01 -2.17580567e-01
 -2.17580567e-01  8.98454763e-01  5.62575304e+00  2.29984923e+01
  8.29202951e+01  2.78353688e+02  9.06051014e+02  3.15828975e+03
  1.26374106e+04  4.12337222e+04  1.05261407e+05  2.30434184e+05
  4.56241441e+05  8.45187859e+05  1.52835947e+06  2.85061991e+06
  5.80849827e+06]
E1 = -706.8020889102737  E_coul = 198.81173832702078
cycle= 2 E= -507.990350583253  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0346615
diis-c [-0.00119654 -0.00291761  1.00291761]
  HOMO = -0.239752595135154  LUMO = 0.894659934667046
  mo_energy =
[-1.20314860e+02 -1.23723941e+01 -6.66892921e+00 -6.66892921e+00
 -6.66892921e+00 -1.17754354e+00 -2.39752595e-01 -2.39752595e-01
 -2.39752595e-01  8.94659935e-01  5.59703038e+00  2.29407926e+01
  8.28362687e+01  2.78248954e+02  9.05930385e+02  3.15815475e+03
  1.26372653e+04  4.12335731e+04  1.05261257e+05  2.30434033e+05
  4.56241289e+05  8.45187706e+05  1.52835932e+06  2.85061976e+06
  5.80849811e+06]
E1 = -706.6937748891446  E_coul = 198.70316251824823
cycle= 3 E= -507.990612370896  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0605
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00377871
diis-c [-3.23591794e-06  1.23361875e-04 -1.06472333e-01  1.10634897e+00]
  HOMO = -0.242893602655624  LUMO = 0.893895705222399
  mo_energy =
[-1.20326566e+02 -1.23809256e+01 -6.67794143e+00 -6.67794143e+00
 -6.67794143e+00 -1.17944636e+00 -2.42893603e-01 -2.42893603e-01
 -2.42893603e-01  8.93895705e-01  5.59279158e+00  2.29333737e+01
  8.28266462e+01  2.78237915e+02  9.05918445e+02  3.15814212e+03
  1.26372522e+04  4.12335598e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.6785349752125  E_coul = 198.6879175776736
cycle= 4 E= -507.990617397539  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173148
diis-c [-5.31123317e-10 -9.36196152e-06  6.84166162e-03 -9.81417728e-02
  1.09130947e+00]
  HOMO = -0.243043226346383  LUMO = 0.893850152248036
  mo_energy =
[-1.20326913e+02 -1.23812661e+01 -6.67827800e+00 -6.67827800e+00
 -6.67827800e+00 -1.17953696e+00 -2.43043226e-01 -2.43043226e-01
 -2.43043226e-01  8.93850152e-01  5.59258420e+00  2.29330688e+01
  8.28263091e+01  2.78237570e+02  9.05918097e+02  3.15814177e+03
  1.26372519e+04  4.12335595e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.6778154770099  E_coul = 198.68719806532098
cycle= 5 E= -507.990617411689  delta_E= -1.41e-08  |g|= 5.62e-06  |ddm|= 0.000665
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.49837e-06
diis-c [-8.88661099e-13  6.00013927e-07 -5.40422262e-04  7.38524227e-03
 -8.79865239e-02  1.08114110e+00]
  HOMO = -0.243045840073965  LUMO = 0.893849408317642
  mo_energy =
[-1.20326919e+02 -1.23812712e+01 -6.67828318e+00 -6.67828318e+00
 -6.67828318e+00 -1.17953876e+00 -2.43045840e-01 -2.43045840e-01
 -2.43045840e-01  8.93849408e-01  5.59258054e+00  2.29330641e+01
  8.28263037e+01  2.78237564e+02  9.05918091e+02  3.15814176e+03
  1.26372519e+04  4.12335595e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.6778022904695  E_coul = 198.68718487877413
cycle= 6 E= -507.990617411695  delta_E= -6.48e-12  |g|= 9.15e-08  |ddm|= 1.66e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6778022904695  E_coul = 198.68718487877413
  HOMO = -0.243045882974969  LUMO = 0.893849384918755
  mo_energy =
[-1.20326919e+02 -1.23812713e+01 -6.67828326e+00 -6.67828326e+00
 -6.67828326e+00 -1.17953878e+00 -2.43045883e-01 -2.43045883e-01
 -2.43045883e-01  8.93849385e-01  5.59258048e+00  2.29330640e+01
  8.28263036e+01  2.78237564e+02  9.05918091e+02  3.15814176e+03
  1.26372519e+04  4.12335595e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.677802102057  E_coul = 198.6871846903613
Extra cycle  E= -507.990617411696  delta_E= -3.41e-13  |g|= 1.15e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912683.3724747427
E1 = -706.677802102057  E_coul = 198.6871846903613
init E= -507.990617411696
    CPU time for initialize scf      5.78 sec, wall time      0.24 sec
  HOMO = -0.243045889106547  LUMO = 0.893849380125773
  mo_energy =
[-1.20326919e+02 -1.23812713e+01 -6.67828328e+00 -6.67828328e+00
 -6.67828328e+00 -1.17953878e+00 -2.43045889e-01 -2.43045889e-01
 -2.43045889e-01  8.93849380e-01  5.59258047e+00  2.29330640e+01
  8.28263036e+01  2.78237564e+02  9.05918091e+02  3.15814176e+03
  1.26372519e+04  4.12335595e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.6778020738935  E_coul = 198.68718466219727
cycle= 1 E= -507.990617411696  delta_E= -5.68e-13  |g|= 2.39e-09  |ddm|= 2.77e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6778020738935  E_coul = 198.68718466219727
  HOMO = -0.243045889962552  LUMO = 0.893849381507522
  mo_energy =
[-1.20326919e+02 -1.23812713e+01 -6.67828328e+00 -6.67828328e+00
 -6.67828328e+00 -1.17953878e+00 -2.43045890e-01 -2.43045890e-01
 -2.43045890e-01  8.93849382e-01  5.59258047e+00  2.29330640e+01
  8.28263036e+01  2.78237564e+02  9.05918091e+02  3.15814176e+03
  1.26372519e+04  4.12335595e+04  1.05261243e+05  2.30434019e+05
  4.56241275e+05  8.45187693e+05  1.52835930e+06  2.85061974e+06
  5.80849810e+06]
E1 = -706.6778020682016  E_coul = 198.68718465650574
Extra cycle  E= -507.990617411696  delta_E= 3.98e-13  |g|= 1.24e-09  |ddm|= 5.46e-09
    CPU time for scf_cycle      6.30 sec, wall time      0.42 sec
exp = [2.30595745e-01 6.03402818e-01 1.86937098e+00 1.17616813e+05
 4.14214551e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547010e+04 7.30228956e+03
 1.83757701e+04 1.44376881e+03 4.17408976e+02 1.47730124e+02
 5.85762409e+01 2.47427715e+01 9.25635949e+00 8.60445079e+00
 4.92773792e-01]
grad_E = [-1.50952495e-04  1.06808874e-04 -2.77876082e-05  6.07561670e-09
  1.00654911e-05  4.05907526e-11  1.74592304e-10  9.42352606e-10
  3.72341392e-09  1.55487823e-08  8.10908109e-08  5.11231289e-06
  1.98915818e-07 -3.90779344e-05 -9.76086915e-07 -1.27914369e-05
 -1.28648630e-05 -3.50769611e-05  2.51368212e-05  1.17958318e-04
  6.41316796e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229833848386       1
[INPUT] 0    0    [1    /1   ]  0.600475033144       1
[INPUT] 0    0    [1    /1   ]  1.85019790286        1
[INPUT] 0    0    [1    /1   ]  117616.812851        1
[INPUT] 0    0    [1    /1   ]  4.09731049024        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030915        1
[INPUT] 0    0    [1    /1   ]  147020.9913          1
[INPUT] 0    0    [1    /1   ]  73510.4174496        1
[INPUT] 0    0    [1    /1   ]  36754.7010206        1
[INPUT] 0    0    [1    /1   ]  7302.28908367        1
[INPUT] 0    0    [1    /1   ]  18375.7700798        1
[INPUT] 0    0    [1    /1   ]  1443.77231344        1
[INPUT] 0    0    [1    /1   ]  417.410515851        1
[INPUT] 0    0    [1    /1   ]  147.724198309        1
[INPUT] 0    0    [1    /1   ]  58.6011009389        1
[INPUT] 0    0    [1    /1   ]  24.7282252221        1
[INPUT] 0    0    [1    /1   ]  9.16981322774        1
[INPUT] 1    0    [1    /1   ]  8.6043498347         1
[INPUT] 1    0    [1    /1   ]  0.492760838425       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22983384838600182, 1.0]], [0, [0.6004750331435738, 1.0]], [0, [1.850197902863626, 1.0]], [0, [117616.81285088584, 1.0]], [0, [4.097310490243407, 1.0]], [0, [1176168.1426131956, 1.0]], [0, [588084.0699554506, 1.0]], [0, [294042.03091544536, 1.0]], [0, [147020.9912996507, 1.0]], [0, [73510.41744956031, 1.0]], [0, [36754.70102061667, 1.0]], [0, [7302.289083665918, 1.0]], [0, [18375.770079768612, 1.0]], [0, [1443.772313443441, 1.0]], [0, [417.4105158511121, 1.0]], [0, [147.72419830910837, 1.0]], [0, [58.60110093889545, 1.0]], [0, [24.7282252221028, 1.0]], [0, [9.169813227744033, 1.0]], [1, [8.60434983470278, 1.0]], [1, [0.49276083842516566, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22983385]
bas 1, expnt(s) = [0.60047503]
bas 2, expnt(s) = [1.8501979]
bas 3, expnt(s) = [117616.81285089]
bas 4, expnt(s) = [4.09731049]
bas 5, expnt(s) = [1176168.1426132]
bas 6, expnt(s) = [588084.06995545]
bas 7, expnt(s) = [294042.03091545]
bas 8, expnt(s) = [147020.99129965]
bas 9, expnt(s) = [73510.41744956]
bas 10, expnt(s) = [36754.70102062]
bas 11, expnt(s) = [7302.28908367]
bas 12, expnt(s) = [18375.77007977]
bas 13, expnt(s) = [1443.77231344]
bas 14, expnt(s) = [417.41051585]
bas 15, expnt(s) = [147.72419831]
bas 16, expnt(s) = [58.60110094]
bas 17, expnt(s) = [24.72822522]
bas 18, expnt(s) = [9.16981323]
bas 19, expnt(s) = [8.60434983]
bas 20, expnt(s) = [0.49276084]
CPU time:      1178.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29833848e-01 8.38639890e-01 6.00475033e-01 1.72340060e+00
 1.85019790e+00 4.00800876e+00 1.17616813e+05 1.60460108e+04
 4.09731049e+00 7.27594120e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104174e+04 1.12791583e+04
 3.67547010e+04 6.70655816e+03 7.30228908e+03 1.99576449e+03
 1.83757701e+04 3.98748613e+03 1.44377231e+03 5.91751076e+02
 4.17410516e+02 2.33312262e+02 1.47724198e+02 1.07054211e+02
 5.86011009e+01 5.35111588e+01 2.47282252e+01 2.80162326e+01
 9.16981323e+00 1.33132900e+01 8.60434983e+00 4.29914375e+01
 4.92760838e-01 1.20442462e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336066360935117
cond(S) = 912667.6137969813
E1 = -689.5966274979788  E_coul = 184.97222682864313
init E= -504.624400669336
    CPU time for initialize scf      0.84 sec, wall time      0.08 sec
  HOMO = -0.672159458897799  LUMO = 0.544283733543026
  mo_energy =
[-1.21709681e+02 -1.33862477e+01 -7.62354581e+00 -7.62354581e+00
 -7.62354581e+00 -1.65756667e+00 -6.72159459e-01 -6.72159459e-01
 -6.72159459e-01  5.44283734e-01  4.93318245e+00  2.17626365e+01
  8.10826192e+01  2.76269715e+02  9.03981734e+02  3.15634469e+03
  1.26356403e+04  4.12320545e+04  1.05259794e+05  2.30432606e+05
  4.56239887e+05  8.45186325e+05  1.52835795e+06  2.85061841e+06
  5.80849678e+06]
E1 = -707.7559084418057  E_coul = 199.7833728563249
cycle= 1 E= -507.972535585481  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.759807
diis-c [-0.57730643  1.        ]
  HOMO = -0.217604894334758  LUMO = 0.892053334470458
  mo_energy =
[-1.20200010e+02 -1.23046751e+01 -6.59392992e+00 -6.59392992e+00
 -6.59392992e+00 -1.16330294e+00 -2.17604894e-01 -2.17604894e-01
 -2.17604894e-01  8.92053334e-01  5.56066050e+00  2.27158724e+01
  8.23536879e+01  2.77722067e+02  9.05473252e+02  3.15777704e+03
  1.26369663e+04  4.12333133e+04  1.05261016e+05  2.30433803e+05
  4.56241068e+05  8.45187492e+05  1.52835911e+06  2.85061956e+06
  5.80849792e+06]
E1 = -706.8009997210546  E_coul = 198.81064808007136
cycle= 2 E= -507.990351640983  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347339
diis-c [-0.00120141 -0.00296451  1.00296451]
  HOMO = -0.239781179757267  LUMO = 0.888311122203857
  mo_energy =
[-1.20315015e+02 -1.23724750e+01 -6.66900246e+00 -6.66900246e+00
 -6.66900246e+00 -1.17757103e+00 -2.39781180e-01 -2.39781180e-01
 -2.39781180e-01  8.88311122e-01  5.53220838e+00  2.26584137e+01
  8.22697137e+01  2.77617315e+02  9.05352605e+02  3.15764203e+03
  1.26368210e+04  4.12331642e+04  1.05260865e+05  2.30433652e+05
  4.56240916e+05  8.45187339e+05  1.52835896e+06  2.85061940e+06
  5.80849777e+06]
E1 = -706.6926107975786  E_coul = 198.70199705048637
cycle= 3 E= -507.990613747092  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0037946
diis-c [-3.25080497e-06  1.20859191e-04 -1.06783392e-01  1.10666253e+00]
  HOMO = -0.242925307176355  LUMO = 0.887554321737115
  mo_energy =
[-1.20326725e+02 -1.23810117e+01 -6.67801979e+00 -6.67801979e+00
 -6.67801979e+00 -1.17947598e+00 -2.42925307e-01 -2.42925307e-01
 -2.42925307e-01  8.87554322e-01  5.52800049e+00  2.26510145e+01
  8.22600912e+01  2.77606271e+02  9.05340661e+02  3.15762939e+03
  1.26368079e+04  4.12331509e+04  1.05260852e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6773457834346  E_coul = 198.68672699170207
cycle= 4 E= -507.990618791733  delta_E= -5.04e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173382
diis-c [-5.46760314e-10 -9.40680046e-06  6.85155734e-03 -9.79895172e-02
  1.09114737e+00]
  HOMO = -0.24307460949722  LUMO = 0.887509172092745
  mo_energy =
[-1.20327070e+02 -1.23813507e+01 -6.67835462e+00 -6.67835462e+00
 -6.67835462e+00 -1.17956641e+00 -2.43074609e-01 -2.43074609e-01
 -2.43074609e-01  8.87509172e-01  5.52779492e+00  2.26507115e+01
  8.22597561e+01  2.77605929e+02  9.05340315e+02  3.15762904e+03
  1.26368076e+04  4.12331506e+04  1.05260851e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6766271469032  E_coul = 198.68600834095918
cycle= 5 E= -507.990618805944  delta_E= -1.42e-08  |g|= 5.76e-06  |ddm|= 0.00067
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.55556e-06
diis-c [-9.11989939e-13  6.01733073e-07 -5.48675287e-04  7.47653561e-03
 -8.92543632e-02  1.08232590e+00]
  HOMO = -0.24307727200672  LUMO = 0.887508417779189
  mo_energy =
[-1.20327076e+02 -1.23813559e+01 -6.67835987e+00 -6.67835987e+00
 -6.67835987e+00 -1.17956824e+00 -2.43077272e-01 -2.43077272e-01
 -2.43077272e-01  8.87508418e-01  5.52779121e+00  2.26507066e+01
  8.22597506e+01  2.77605923e+02  9.05340309e+02  3.15762903e+03
  1.26368076e+04  4.12331506e+04  1.05260851e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6766136897706  E_coul = 198.68599488381932
cycle= 6 E= -507.990618805951  delta_E= -7.28e-12  |g|= 9.2e-08  |ddm|= 1.71e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6766136897706  E_coul = 198.68599488381932
  HOMO = -0.243077314770415  LUMO = 0.887508393661075
  mo_energy =
[-1.20327076e+02 -1.23813560e+01 -6.67835996e+00 -6.67835996e+00
 -6.67835996e+00 -1.17956826e+00 -2.43077315e-01 -2.43077315e-01
 -2.43077315e-01  8.87508394e-01  5.52779114e+00  2.26507066e+01
  8.22597505e+01  2.77605923e+02  9.05340309e+02  3.15762903e+03
  1.26368076e+04  4.12331506e+04  1.05260851e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6766135023051  E_coul = 198.68599469635413
Extra cycle  E= -507.990618805951  delta_E= 2.84e-13  |g|= 1.23e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      1.64 sec, wall time      0.30 sec
exp = [2.29833848e-01 6.00475033e-01 1.85019790e+00 1.17616813e+05
 4.09731049e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104174e+04 3.67547010e+04 7.30228908e+03
 1.83757701e+04 1.44377231e+03 4.17410516e+02 1.47724198e+02
 5.86011009e+01 2.47282252e+01 9.16981323e+00 8.60434983e+00
 4.92760838e-01]
E = -507.99061880595104
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229833848386       1
[INPUT] 0    0    [1    /1   ]  0.600475033144       1
[INPUT] 0    0    [1    /1   ]  1.85019790286        1
[INPUT] 0    0    [1    /1   ]  117616.812851        1
[INPUT] 0    0    [1    /1   ]  4.09731049024        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030915        1
[INPUT] 0    0    [1    /1   ]  147020.9913          1
[INPUT] 0    0    [1    /1   ]  73510.4174496        1
[INPUT] 0    0    [1    /1   ]  36754.7010206        1
[INPUT] 0    0    [1    /1   ]  7302.28908367        1
[INPUT] 0    0    [1    /1   ]  18375.7700798        1
[INPUT] 0    0    [1    /1   ]  1443.77231344        1
[INPUT] 0    0    [1    /1   ]  417.410515851        1
[INPUT] 0    0    [1    /1   ]  147.724198309        1
[INPUT] 0    0    [1    /1   ]  58.6011009389        1
[INPUT] 0    0    [1    /1   ]  24.7282252221        1
[INPUT] 0    0    [1    /1   ]  9.16981322774        1
[INPUT] 1    0    [1    /1   ]  8.6043498347         1
[INPUT] 1    0    [1    /1   ]  0.492760838425       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22983384838600182, 1.0]], [0, [0.6004750331435738, 1.0]], [0, [1.850197902863626, 1.0]], [0, [117616.81285088584, 1.0]], [0, [4.097310490243407, 1.0]], [0, [1176168.1426131956, 1.0]], [0, [588084.0699554506, 1.0]], [0, [294042.03091544536, 1.0]], [0, [147020.9912996507, 1.0]], [0, [73510.41744956031, 1.0]], [0, [36754.70102061667, 1.0]], [0, [7302.289083665918, 1.0]], [0, [18375.770079768612, 1.0]], [0, [1443.772313443441, 1.0]], [0, [417.4105158511121, 1.0]], [0, [147.72419830910837, 1.0]], [0, [58.60110093889545, 1.0]], [0, [24.7282252221028, 1.0]], [0, [9.169813227744033, 1.0]], [1, [8.60434983470278, 1.0]], [1, [0.49276083842516566, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22983385]
bas 1, expnt(s) = [0.60047503]
bas 2, expnt(s) = [1.8501979]
bas 3, expnt(s) = [117616.81285089]
bas 4, expnt(s) = [4.09731049]
bas 5, expnt(s) = [1176168.1426132]
bas 6, expnt(s) = [588084.06995545]
bas 7, expnt(s) = [294042.03091545]
bas 8, expnt(s) = [147020.99129965]
bas 9, expnt(s) = [73510.41744956]
bas 10, expnt(s) = [36754.70102062]
bas 11, expnt(s) = [7302.28908367]
bas 12, expnt(s) = [18375.77007977]
bas 13, expnt(s) = [1443.77231344]
bas 14, expnt(s) = [417.41051585]
bas 15, expnt(s) = [147.72419831]
bas 16, expnt(s) = [58.60110094]
bas 17, expnt(s) = [24.72822522]
bas 18, expnt(s) = [9.16981323]
bas 19, expnt(s) = [8.60434983]
bas 20, expnt(s) = [0.49276084]
CPU time:      1180.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29833848e-01 8.38639890e-01 6.00475033e-01 1.72340060e+00
 1.85019790e+00 4.00800876e+00 1.17616813e+05 1.60460108e+04
 4.09731049e+00 7.27594120e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104174e+04 1.12791583e+04
 3.67547010e+04 6.70655816e+03 7.30228908e+03 1.99576449e+03
 1.83757701e+04 3.98748613e+03 1.44377231e+03 5.91751076e+02
 4.17410516e+02 2.33312262e+02 1.47724198e+02 1.07054211e+02
 5.86011009e+01 5.35111588e+01 2.47282252e+01 2.80162326e+01
 9.16981323e+00 1.33132900e+01 8.60434983e+00 4.29914375e+01
 4.92760838e-01 1.20442462e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336066360935117
cond(S) = 912667.6137969813
E1 = -689.5966274979788  E_coul = 184.97222682864313
init E= -504.624400669336
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672159458897799  LUMO = 0.544283733543026
  mo_energy =
[-1.21709681e+02 -1.33862477e+01 -7.62354581e+00 -7.62354581e+00
 -7.62354581e+00 -1.65756667e+00 -6.72159459e-01 -6.72159459e-01
 -6.72159459e-01  5.44283734e-01  4.93318245e+00  2.17626365e+01
  8.10826192e+01  2.76269715e+02  9.03981734e+02  3.15634469e+03
  1.26356403e+04  4.12320545e+04  1.05259794e+05  2.30432606e+05
  4.56239887e+05  8.45186325e+05  1.52835795e+06  2.85061841e+06
  5.80849678e+06]
E1 = -707.7559084418057  E_coul = 199.7833728563249
cycle= 1 E= -507.972535585481  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.759807
diis-c [-0.57730643  1.        ]
  HOMO = -0.217604894334758  LUMO = 0.892053334470458
  mo_energy =
[-1.20200010e+02 -1.23046751e+01 -6.59392992e+00 -6.59392992e+00
 -6.59392992e+00 -1.16330294e+00 -2.17604894e-01 -2.17604894e-01
 -2.17604894e-01  8.92053334e-01  5.56066050e+00  2.27158724e+01
  8.23536879e+01  2.77722067e+02  9.05473252e+02  3.15777704e+03
  1.26369663e+04  4.12333133e+04  1.05261016e+05  2.30433803e+05
  4.56241068e+05  8.45187492e+05  1.52835911e+06  2.85061956e+06
  5.80849792e+06]
E1 = -706.8009997210546  E_coul = 198.81064808007136
cycle= 2 E= -507.990351640983  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.394
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347339
diis-c [-0.00120141 -0.00296451  1.00296451]
  HOMO = -0.239781179757267  LUMO = 0.888311122203857
  mo_energy =
[-1.20315015e+02 -1.23724750e+01 -6.66900246e+00 -6.66900246e+00
 -6.66900246e+00 -1.17757103e+00 -2.39781180e-01 -2.39781180e-01
 -2.39781180e-01  8.88311122e-01  5.53220838e+00  2.26584137e+01
  8.22697137e+01  2.77617315e+02  9.05352605e+02  3.15764203e+03
  1.26368210e+04  4.12331642e+04  1.05260865e+05  2.30433652e+05
  4.56240916e+05  8.45187339e+05  1.52835896e+06  2.85061940e+06
  5.80849777e+06]
E1 = -706.6926107975786  E_coul = 198.70199705048637
cycle= 3 E= -507.990613747092  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0037946
diis-c [-3.25080497e-06  1.20859191e-04 -1.06783392e-01  1.10666253e+00]
  HOMO = -0.242925307176355  LUMO = 0.887554321737115
  mo_energy =
[-1.20326725e+02 -1.23810117e+01 -6.67801979e+00 -6.67801979e+00
 -6.67801979e+00 -1.17947598e+00 -2.42925307e-01 -2.42925307e-01
 -2.42925307e-01  8.87554322e-01  5.52800049e+00  2.26510145e+01
  8.22600912e+01  2.77606271e+02  9.05340661e+02  3.15762939e+03
  1.26368079e+04  4.12331509e+04  1.05260852e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6773457834346  E_coul = 198.68672699170207
cycle= 4 E= -507.990618791733  delta_E= -5.04e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173382
diis-c [-5.46760314e-10 -9.40680046e-06  6.85155734e-03 -9.79895172e-02
  1.09114737e+00]
  HOMO = -0.24307460949722  LUMO = 0.887509172092745
  mo_energy =
[-1.20327070e+02 -1.23813507e+01 -6.67835462e+00 -6.67835462e+00
 -6.67835462e+00 -1.17956641e+00 -2.43074609e-01 -2.43074609e-01
 -2.43074609e-01  8.87509172e-01  5.52779492e+00  2.26507115e+01
  8.22597561e+01  2.77605929e+02  9.05340315e+02  3.15762904e+03
  1.26368076e+04  4.12331506e+04  1.05260851e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6766271469032  E_coul = 198.68600834095918
cycle= 5 E= -507.990618805944  delta_E= -1.42e-08  |g|= 5.76e-06  |ddm|= 0.00067
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.55556e-06
diis-c [-9.11989939e-13  6.01733073e-07 -5.48675287e-04  7.47653561e-03
 -8.92543632e-02  1.08232590e+00]
  HOMO = -0.24307727200672  LUMO = 0.887508417779189
  mo_energy =
[-1.20327076e+02 -1.23813559e+01 -6.67835987e+00 -6.67835987e+00
 -6.67835987e+00 -1.17956824e+00 -2.43077272e-01 -2.43077272e-01
 -2.43077272e-01  8.87508418e-01  5.52779121e+00  2.26507066e+01
  8.22597506e+01  2.77605923e+02  9.05340309e+02  3.15762903e+03
  1.26368076e+04  4.12331506e+04  1.05260851e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6766136897706  E_coul = 198.68599488381932
cycle= 6 E= -507.990618805951  delta_E= -7.28e-12  |g|= 9.2e-08  |ddm|= 1.71e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6766136897706  E_coul = 198.68599488381932
  HOMO = -0.243077314770415  LUMO = 0.887508393661075
  mo_energy =
[-1.20327076e+02 -1.23813560e+01 -6.67835996e+00 -6.67835996e+00
 -6.67835996e+00 -1.17956826e+00 -2.43077315e-01 -2.43077315e-01
 -2.43077315e-01  8.87508394e-01  5.52779114e+00  2.26507066e+01
  8.22597505e+01  2.77605923e+02  9.05340309e+02  3.15762903e+03
  1.26368076e+04  4.12331506e+04  1.05260851e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6766135023051  E_coul = 198.68599469635413
Extra cycle  E= -507.990618805951  delta_E= 2.84e-13  |g|= 1.23e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912667.6137969813
E1 = -706.6766135023051  E_coul = 198.68599469635413
init E= -507.990618805951
    CPU time for initialize scf      6.35 sec, wall time      0.27 sec
  HOMO = -0.243077320868123  LUMO = 0.887508391228352
  mo_energy =
[-1.20327076e+02 -1.23813560e+01 -6.67835997e+00 -6.67835997e+00
 -6.67835997e+00 -1.17956826e+00 -2.43077321e-01 -2.43077321e-01
 -2.43077321e-01  8.87508391e-01  5.52779113e+00  2.26507065e+01
  8.22597505e+01  2.77605923e+02  9.05340309e+02  3.15762903e+03
  1.26368076e+04  4.12331506e+04  1.05260851e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6766134704603  E_coul = 198.685994664509
cycle= 1 E= -507.990618805951  delta_E= -2.84e-13  |g|= 2.43e-09  |ddm|= 3.18e-08
    CPU time for cycle= 1      0.34 sec, wall time      0.03 sec
E1 = -706.6766134704603  E_coul = 198.685994664509
  HOMO = -0.243077321843623  LUMO = 0.887508391962442
  mo_energy =
[-1.20327076e+02 -1.23813560e+01 -6.67835998e+00 -6.67835998e+00
 -6.67835998e+00 -1.17956826e+00 -2.43077322e-01 -2.43077322e-01
 -2.43077322e-01  8.87508392e-01  5.52779113e+00  2.26507065e+01
  8.22597505e+01  2.77605923e+02  9.05340309e+02  3.15762903e+03
  1.26368076e+04  4.12331506e+04  1.05260851e+05  2.30433638e+05
  4.56240902e+05  8.45187326e+05  1.52835894e+06  2.85061939e+06
  5.80849776e+06]
E1 = -706.6766134660783  E_coul = 198.68599466012697
Extra cycle  E= -507.990618805951  delta_E= 5.68e-14  |g|= 1.36e-09  |ddm|= 4.74e-09
    CPU time for scf_cycle      6.84 sec, wall time      0.44 sec
exp = [2.29833848e-01 6.00475033e-01 1.85019790e+00 1.17616813e+05
 4.09731049e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104174e+04 3.67547010e+04 7.30228908e+03
 1.83757701e+04 1.44377231e+03 4.17410516e+02 1.47724198e+02
 5.86011009e+01 2.47282252e+01 9.16981323e+00 8.60434983e+00
 4.92760838e-01]
grad_E = [-1.28741207e-04  7.76458359e-05  3.11214745e-06  6.08215420e-09
 -9.69498268e-06  4.06641410e-11  1.74806686e-10  9.43355244e-10
  3.72746289e-09  1.55659123e-08  8.11735401e-08  5.11767044e-06
  1.99185922e-07 -3.93151093e-05  1.14062519e-06 -2.17424034e-05
  7.10685079e-06 -5.06025271e-05  1.98408319e-05  4.35992861e-05
  2.64469299e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228952897423       1
[INPUT] 0    0    [1    /1   ]  0.597173812624       1
[INPUT] 0    0    [1    /1   ]  1.81519002467        1
[INPUT] 0    0    [1    /1   ]  117616.812853        1
[INPUT] 0    0    [1    /1   ]  4.04479888333        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174542        1
[INPUT] 0    0    [1    /1   ]  36754.701045         1
[INPUT] 0    0    [1    /1   ]  7302.29062291        1
[INPUT] 0    0    [1    /1   ]  18375.7701396        1
[INPUT] 0    0    [1    /1   ]  1443.76075009        1
[INPUT] 0    0    [1    /1   ]  417.408218331        1
[INPUT] 0    0    [1    /1   ]  147.726790066        1
[INPUT] 0    0    [1    /1   ]  58.5965125257        1
[INPUT] 0    0    [1    /1   ]  24.717649638         1
[INPUT] 0    0    [1    /1   ]  9.07740152654        1
[INPUT] 1    0    [1    /1   ]  8.60429782395        1
[INPUT] 1    0    [1    /1   ]  0.492753240972       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.228952897422864, 1.0]], [0, [0.5971738126239808, 1.0]], [0, [1.8151900246739396, 1.0]], [0, [117616.81285271527, 1.0]], [0, [4.044798883327485, 1.0]], [0, [1176168.1426132077, 1.0]], [0, [588084.0699555031, 1.0]], [0, [294042.0309157291, 1.0]], [0, [147020.99130077183, 1.0]], [0, [73510.41745424189, 1.0]], [0, [36754.70104503741, 1.0]], [0, [7302.290622912696, 1.0]], [0, [18375.770139620607, 1.0]], [0, [1443.7607500880831, 1.0]], [0, [417.4082183308837, 1.0]], [0, [147.72679006591167, 1.0]], [0, [58.596512525672225, 1.0]], [0, [24.717649638013302, 1.0]], [0, [9.077401526541317, 1.0]], [1, [8.604297823952653, 1.0]], [1, [0.49275324097233886, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2289529]
bas 1, expnt(s) = [0.59717381]
bas 2, expnt(s) = [1.81519002]
bas 3, expnt(s) = [117616.81285272]
bas 4, expnt(s) = [4.04479888]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.0699555]
bas 7, expnt(s) = [294042.03091573]
bas 8, expnt(s) = [147020.99130077]
bas 9, expnt(s) = [73510.41745424]
bas 10, expnt(s) = [36754.70104504]
bas 11, expnt(s) = [7302.29062291]
bas 12, expnt(s) = [18375.77013962]
bas 13, expnt(s) = [1443.76075009]
bas 14, expnt(s) = [417.40821833]
bas 15, expnt(s) = [147.72679007]
bas 16, expnt(s) = [58.59651253]
bas 17, expnt(s) = [24.71764964]
bas 18, expnt(s) = [9.07740153]
bas 19, expnt(s) = [8.60429782]
bas 20, expnt(s) = [0.49275324]
CPU time:      1196.35
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28952897e-01 8.36227859e-01 5.97173813e-01 1.71628968e+00
 1.81519002e+00 3.95099606e+00 1.17616813e+05 1.60460108e+04
 4.04479888e+00 7.20589158e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547010e+04 6.70655816e+03 7.30229062e+03 1.99576480e+03
 1.83757701e+04 3.98748614e+03 1.44376075e+03 5.91747521e+02
 4.17408218e+02 2.33311299e+02 1.47726790e+02 1.07055620e+02
 5.85965125e+01 5.35080163e+01 2.47176496e+01 2.80072458e+01
 9.07740153e+00 1.32125360e+01 8.60429782e+00 4.29911127e+01
 4.92753241e-01 1.20440141e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336080053403606
cond(S) = 912646.5831658918
E1 = -689.5960697508319  E_coul = 184.97179057917035
init E= -504.624279171662
    CPU time for initialize scf      0.74 sec, wall time      0.07 sec
  HOMO = -0.672167417001655  LUMO = 0.537887164866028
  mo_energy =
[-1.21709747e+02 -1.33862773e+01 -7.62357337e+00 -7.62357337e+00
 -7.62357337e+00 -1.65758128e+00 -6.72167417e-01 -6.72167417e-01
 -6.72167417e-01  5.37887165e-01  4.84372098e+00  2.13975044e+01
  8.03903967e+01  2.75475805e+02  9.03221680e+02  3.15564186e+03
  1.26349945e+04  4.12314478e+04  1.05259211e+05  2.30432039e+05
  4.56239333e+05  8.45185779e+05  1.52835742e+06  2.85061788e+06
  5.80849627e+06]
E1 = -707.7554710499504  E_coul = 199.78293708601845
cycle= 1 E= -507.972533963932  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.759362
diis-c [-0.57663001  1.        ]
  HOMO = -0.21761623223495  LUMO = 0.884025736236627
  mo_energy =
[-1.20200077e+02 -1.23047029e+01 -6.59395509e+00 -6.59395509e+00
 -6.59395509e+00 -1.16331622e+00 -2.17616232e-01 -2.17616232e-01
 -2.17616232e-01  8.84025736e-01  5.46654393e+00  2.23471021e+01
  8.16609267e+01  2.76928267e+02  9.04713243e+02  3.15707422e+03
  1.26363205e+04  4.12327066e+04  1.05260433e+05  2.30433236e+05
  4.56240513e+05  8.45186946e+05  1.52835857e+06  2.85061903e+06
  5.80849741e+06]
E1 = -706.8004334262858  E_coul = 198.81008179259726
cycle= 2 E= -507.990351633689  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348718
diis-c [-0.00121078 -0.00303242  1.00303242]
  HOMO = -0.239797656980215  LUMO = 0.880355398904252
  mo_energy =
[-1.20315101e+02 -1.23725173e+01 -6.66904288e+00 -6.66904288e+00
 -6.66904288e+00 -1.17758835e+00 -2.39797657e-01 -2.39797657e-01
 -2.39797657e-01  8.80355399e-01  5.43848710e+00  2.22899453e+01
  8.15770071e+01  2.76823492e+02  9.04592571e+02  3.15693919e+03
  1.26361752e+04  4.12325574e+04  1.05260282e+05  2.30433085e+05
  4.56240361e+05  8.45186794e+05  1.52835842e+06  2.85061888e+06
  5.80849726e+06]
E1 = -706.6919677991739  E_coul = 198.70135373738268
cycle= 3 E= -507.990614061791  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382247
diis-c [-3.27380756e-06  1.15073048e-04 -1.07301320e-01  1.10718625e+00]
  HOMO = -0.242945277583101  LUMO = 0.879608992623297
  mo_energy =
[-1.20326817e+02 -1.23810598e+01 -6.67806586e+00 -6.67806586e+00
 -6.67806586e+00 -1.17949564e+00 -2.42945278e-01 -2.42945278e-01
 -2.42945278e-01  8.79608993e-01  5.43432602e+00  2.22825719e+01
  8.15673847e+01  2.76812442e+02  9.04580622e+02  3.15692654e+03
  1.26361621e+04  4.12325442e+04  1.05260269e+05  2.30433072e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6766750697375  E_coul = 198.68605594374293
cycle= 4 E= -507.990619125995  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017351
diis-c [-5.68183366e-10 -9.47036791e-06  6.86495608e-03 -9.76338332e-02
  1.09077835e+00]
  HOMO = -0.243093613501625  LUMO = 0.879564516066231
  mo_energy =
[-1.20327156e+02 -1.23813953e+01 -6.67839682e+00 -6.67839682e+00
 -6.67839682e+00 -1.17958553e+00 -2.43093614e-01 -2.43093614e-01
 -2.43093614e-01  8.79564516e-01  5.43412375e+00  2.22822725e+01
  8.15670539e+01  2.76812105e+02  9.04580282e+02  3.15692620e+03
  1.26361617e+04  4.12325438e+04  1.05260268e+05  2.30433071e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6759603233548  E_coul = 198.68534118314687
cycle= 5 E= -507.990619140208  delta_E= -1.42e-08  |g|= 5.95e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63622e-06
diis-c [-9.43156262e-13  6.13326022e-07 -5.60510010e-04  7.59452497e-03
 -9.10263752e-02  1.08399175e+00]
  HOMO = -0.243096342625412  LUMO = 0.879563747987558
  mo_energy =
[-1.20327162e+02 -1.23814006e+01 -6.67840218e+00 -6.67840218e+00
 -6.67840218e+00 -1.17958740e+00 -2.43096343e-01 -2.43096343e-01
 -2.43096343e-01  8.79563748e-01  5.43411998e+00  2.22822676e+01
  8.15670484e+01  2.76812099e+02  9.04580276e+02  3.15692619e+03
  1.26361617e+04  4.12325438e+04  1.05260268e+05  2.30433071e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6759465041185  E_coul = 198.68532736390242
cycle= 6 E= -507.990619140216  delta_E= -8.19e-12  |g|= 9.04e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759465041185  E_coul = 198.68532736390242
  HOMO = -0.243096385231529  LUMO = 0.879563721434401
  mo_energy =
[-1.20327162e+02 -1.23814006e+01 -6.67840227e+00 -6.67840227e+00
 -6.67840227e+00 -1.17958742e+00 -2.43096385e-01 -2.43096385e-01
 -2.43096385e-01  8.79563721e-01  5.43411991e+00  2.22822675e+01
  8.15670483e+01  2.76812099e+02  9.04580276e+02  3.15692619e+03
  1.26361617e+04  4.12325438e+04  1.05260268e+05  2.30433071e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6759463193147  E_coul = 198.6853271790991
Extra cycle  E= -507.990619140216  delta_E= 5.68e-13  |g|= 1.13e-08  |ddm|= 2.2e-07
    CPU time for scf_cycle      1.58 sec, wall time      0.29 sec
exp = [2.28952897e-01 5.97173813e-01 1.81519002e+00 1.17616813e+05
 4.04479888e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547010e+04 7.30229062e+03
 1.83757701e+04 1.44376075e+03 4.17408218e+02 1.47726790e+02
 5.85965125e+01 2.47176496e+01 9.07740153e+00 8.60429782e+00
 4.92753241e-01]
E = -507.9906191402156
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228952897423       1
[INPUT] 0    0    [1    /1   ]  0.597173812624       1
[INPUT] 0    0    [1    /1   ]  1.81519002467        1
[INPUT] 0    0    [1    /1   ]  117616.812853        1
[INPUT] 0    0    [1    /1   ]  4.04479888333        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174542        1
[INPUT] 0    0    [1    /1   ]  36754.701045         1
[INPUT] 0    0    [1    /1   ]  7302.29062291        1
[INPUT] 0    0    [1    /1   ]  18375.7701396        1
[INPUT] 0    0    [1    /1   ]  1443.76075009        1
[INPUT] 0    0    [1    /1   ]  417.408218331        1
[INPUT] 0    0    [1    /1   ]  147.726790066        1
[INPUT] 0    0    [1    /1   ]  58.5965125257        1
[INPUT] 0    0    [1    /1   ]  24.717649638         1
[INPUT] 0    0    [1    /1   ]  9.07740152654        1
[INPUT] 1    0    [1    /1   ]  8.60429782395        1
[INPUT] 1    0    [1    /1   ]  0.492753240972       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.228952897422864, 1.0]], [0, [0.5971738126239808, 1.0]], [0, [1.8151900246739396, 1.0]], [0, [117616.81285271527, 1.0]], [0, [4.044798883327485, 1.0]], [0, [1176168.1426132077, 1.0]], [0, [588084.0699555031, 1.0]], [0, [294042.0309157291, 1.0]], [0, [147020.99130077183, 1.0]], [0, [73510.41745424189, 1.0]], [0, [36754.70104503741, 1.0]], [0, [7302.290622912696, 1.0]], [0, [18375.770139620607, 1.0]], [0, [1443.7607500880831, 1.0]], [0, [417.4082183308837, 1.0]], [0, [147.72679006591167, 1.0]], [0, [58.596512525672225, 1.0]], [0, [24.717649638013302, 1.0]], [0, [9.077401526541317, 1.0]], [1, [8.604297823952653, 1.0]], [1, [0.49275324097233886, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2289529]
bas 1, expnt(s) = [0.59717381]
bas 2, expnt(s) = [1.81519002]
bas 3, expnt(s) = [117616.81285272]
bas 4, expnt(s) = [4.04479888]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.0699555]
bas 7, expnt(s) = [294042.03091573]
bas 8, expnt(s) = [147020.99130077]
bas 9, expnt(s) = [73510.41745424]
bas 10, expnt(s) = [36754.70104504]
bas 11, expnt(s) = [7302.29062291]
bas 12, expnt(s) = [18375.77013962]
bas 13, expnt(s) = [1443.76075009]
bas 14, expnt(s) = [417.40821833]
bas 15, expnt(s) = [147.72679007]
bas 16, expnt(s) = [58.59651253]
bas 17, expnt(s) = [24.71764964]
bas 18, expnt(s) = [9.07740153]
bas 19, expnt(s) = [8.60429782]
bas 20, expnt(s) = [0.49275324]
CPU time:      1198.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28952897e-01 8.36227859e-01 5.97173813e-01 1.71628968e+00
 1.81519002e+00 3.95099606e+00 1.17616813e+05 1.60460108e+04
 4.04479888e+00 7.20589158e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547010e+04 6.70655816e+03 7.30229062e+03 1.99576480e+03
 1.83757701e+04 3.98748614e+03 1.44376075e+03 5.91747521e+02
 4.17408218e+02 2.33311299e+02 1.47726790e+02 1.07055620e+02
 5.85965125e+01 5.35080163e+01 2.47176496e+01 2.80072458e+01
 9.07740153e+00 1.32125360e+01 8.60429782e+00 4.29911127e+01
 4.92753241e-01 1.20440141e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336080053403606
cond(S) = 912646.5831658918
E1 = -689.5960697508319  E_coul = 184.97179057917035
init E= -504.624279171662
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672167417001655  LUMO = 0.537887164866028
  mo_energy =
[-1.21709747e+02 -1.33862773e+01 -7.62357337e+00 -7.62357337e+00
 -7.62357337e+00 -1.65758128e+00 -6.72167417e-01 -6.72167417e-01
 -6.72167417e-01  5.37887165e-01  4.84372098e+00  2.13975044e+01
  8.03903967e+01  2.75475805e+02  9.03221680e+02  3.15564186e+03
  1.26349945e+04  4.12314478e+04  1.05259211e+05  2.30432039e+05
  4.56239333e+05  8.45185779e+05  1.52835742e+06  2.85061788e+06
  5.80849627e+06]
E1 = -707.7554710499504  E_coul = 199.78293708601845
cycle= 1 E= -507.972533963932  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.66 sec, wall time      0.03 sec
diis-norm(errvec)=0.759362
diis-c [-0.57663001  1.        ]
  HOMO = -0.21761623223495  LUMO = 0.884025736236627
  mo_energy =
[-1.20200077e+02 -1.23047029e+01 -6.59395509e+00 -6.59395509e+00
 -6.59395509e+00 -1.16331622e+00 -2.17616232e-01 -2.17616232e-01
 -2.17616232e-01  8.84025736e-01  5.46654393e+00  2.23471021e+01
  8.16609267e+01  2.76928267e+02  9.04713243e+02  3.15707422e+03
  1.26363205e+04  4.12327066e+04  1.05260433e+05  2.30433236e+05
  4.56240513e+05  8.45186946e+05  1.52835857e+06  2.85061903e+06
  5.80849741e+06]
E1 = -706.8004334262858  E_coul = 198.81008179259726
cycle= 2 E= -507.990351633689  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348718
diis-c [-0.00121078 -0.00303242  1.00303242]
  HOMO = -0.239797656980215  LUMO = 0.880355398904252
  mo_energy =
[-1.20315101e+02 -1.23725173e+01 -6.66904288e+00 -6.66904288e+00
 -6.66904288e+00 -1.17758835e+00 -2.39797657e-01 -2.39797657e-01
 -2.39797657e-01  8.80355399e-01  5.43848710e+00  2.22899453e+01
  8.15770071e+01  2.76823492e+02  9.04592571e+02  3.15693919e+03
  1.26361752e+04  4.12325574e+04  1.05260282e+05  2.30433085e+05
  4.56240361e+05  8.45186794e+05  1.52835842e+06  2.85061888e+06
  5.80849726e+06]
E1 = -706.6919677991739  E_coul = 198.70135373738268
cycle= 3 E= -507.990614061791  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382247
diis-c [-3.27380756e-06  1.15073048e-04 -1.07301320e-01  1.10718625e+00]
  HOMO = -0.242945277583101  LUMO = 0.879608992623297
  mo_energy =
[-1.20326817e+02 -1.23810598e+01 -6.67806586e+00 -6.67806586e+00
 -6.67806586e+00 -1.17949564e+00 -2.42945278e-01 -2.42945278e-01
 -2.42945278e-01  8.79608993e-01  5.43432602e+00  2.22825719e+01
  8.15673847e+01  2.76812442e+02  9.04580622e+02  3.15692654e+03
  1.26361621e+04  4.12325442e+04  1.05260269e+05  2.30433072e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6766750697375  E_coul = 198.68605594374293
cycle= 4 E= -507.990619125995  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017351
diis-c [-5.68183366e-10 -9.47036791e-06  6.86495608e-03 -9.76338332e-02
  1.09077835e+00]
  HOMO = -0.243093613501625  LUMO = 0.879564516066231
  mo_energy =
[-1.20327156e+02 -1.23813953e+01 -6.67839682e+00 -6.67839682e+00
 -6.67839682e+00 -1.17958553e+00 -2.43093614e-01 -2.43093614e-01
 -2.43093614e-01  8.79564516e-01  5.43412375e+00  2.22822725e+01
  8.15670539e+01  2.76812105e+02  9.04580282e+02  3.15692620e+03
  1.26361617e+04  4.12325438e+04  1.05260268e+05  2.30433071e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6759603233548  E_coul = 198.68534118314687
cycle= 5 E= -507.990619140208  delta_E= -1.42e-08  |g|= 5.95e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63622e-06
diis-c [-9.43156262e-13  6.13326022e-07 -5.60510010e-04  7.59452497e-03
 -9.10263752e-02  1.08399175e+00]
  HOMO = -0.243096342625412  LUMO = 0.879563747987558
  mo_energy =
[-1.20327162e+02 -1.23814006e+01 -6.67840218e+00 -6.67840218e+00
 -6.67840218e+00 -1.17958740e+00 -2.43096343e-01 -2.43096343e-01
 -2.43096343e-01  8.79563748e-01  5.43411998e+00  2.22822676e+01
  8.15670484e+01  2.76812099e+02  9.04580276e+02  3.15692619e+03
  1.26361617e+04  4.12325438e+04  1.05260268e+05  2.30433071e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6759465041185  E_coul = 198.68532736390242
cycle= 6 E= -507.990619140216  delta_E= -8.19e-12  |g|= 9.04e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759465041185  E_coul = 198.68532736390242
  HOMO = -0.243096385231529  LUMO = 0.879563721434401
  mo_energy =
[-1.20327162e+02 -1.23814006e+01 -6.67840227e+00 -6.67840227e+00
 -6.67840227e+00 -1.17958742e+00 -2.43096385e-01 -2.43096385e-01
 -2.43096385e-01  8.79563721e-01  5.43411991e+00  2.22822675e+01
  8.15670483e+01  2.76812099e+02  9.04580276e+02  3.15692619e+03
  1.26361617e+04  4.12325438e+04  1.05260268e+05  2.30433071e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6759463193147  E_coul = 198.6853271790991
Extra cycle  E= -507.990619140216  delta_E= 5.68e-13  |g|= 1.13e-08  |ddm|= 2.2e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912646.5831658918
E1 = -706.6759463193147  E_coul = 198.6853271790991
init E= -507.990619140216
    CPU time for initialize scf      6.05 sec, wall time      0.26 sec
  HOMO = -0.2430963912421  LUMO = 0.879563719832182
  mo_energy =
[-1.20327162e+02 -1.23814007e+01 -6.67840228e+00 -6.67840228e+00
 -6.67840228e+00 -1.17958742e+00 -2.43096391e-01 -2.43096391e-01
 -2.43096391e-01  8.79563720e-01  5.43411991e+00  2.22822675e+01
  8.15670483e+01  2.76812099e+02  9.04580275e+02  3.15692619e+03
  1.26361617e+04  4.12325438e+04  1.05260268e+05  2.30433071e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6759462882133  E_coul = 198.6853271479974
cycle= 1 E= -507.990619140216  delta_E= -2.27e-13  |g|= 2.17e-09  |ddm|= 3.13e-08
    CPU time for cycle= 1      0.33 sec, wall time      0.03 sec
E1 = -706.6759462882133  E_coul = 198.6853271479974
  HOMO = -0.243096392202637  LUMO = 0.879563719354654
  mo_energy =
[-1.20327162e+02 -1.23814007e+01 -6.67840228e+00 -6.67840228e+00
 -6.67840228e+00 -1.17958742e+00 -2.43096392e-01 -2.43096392e-01
 -2.43096392e-01  8.79563719e-01  5.43411991e+00  2.22822675e+01
  8.15670483e+01  2.76812099e+02  9.04580275e+02  3.15692619e+03
  1.26361617e+04  4.12325438e+04  1.05260268e+05  2.30433071e+05
  4.56240347e+05  8.45186780e+05  1.52835841e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6759462858728  E_coul = 198.685327145657
Extra cycle  E= -507.990619140216  delta_E=    0  |g|= 1.18e-09  |ddm|= 2.51e-09
    CPU time for scf_cycle      6.52 sec, wall time      0.43 sec
exp = [2.28952897e-01 5.97173813e-01 1.81519002e+00 1.17616813e+05
 4.04479888e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547010e+04 7.30229062e+03
 1.83757701e+04 1.44376075e+03 4.17408218e+02 1.47726790e+02
 5.85965125e+01 2.47176496e+01 9.07740153e+00 8.60429782e+00
 4.92753241e-01]
grad_E = [ 2.40722247e-05 -9.99253120e-06 -5.98707671e-06  6.08244929e-09
  8.69976278e-06  4.06674320e-11  1.74816382e-10  9.43400463e-10
  3.72764576e-09  1.55666861e-08  8.11772422e-08  5.11786682e-06
  1.99198332e-07 -3.93167457e-05  1.17066861e-06 -2.22743821e-05
  1.04695045e-05 -5.42193538e-05  7.29495679e-06  5.67174358e-06
  2.63246514e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228965140584       1
[INPUT] 0    0    [1    /1   ]  0.597218167139       1
[INPUT] 0    0    [1    /1   ]  1.81793548285        1
[INPUT] 0    0    [1    /1   ]  117616.812853        1
[INPUT] 0    0    [1    /1   ]  4.04561056896        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174556        1
[INPUT] 0    0    [1    /1   ]  36754.7010522        1
[INPUT] 0    0    [1    /1   ]  7302.29107406        1
[INPUT] 0    0    [1    /1   ]  18375.7701572        1
[INPUT] 0    0    [1    /1   ]  1443.75737997        1
[INPUT] 0    0    [1    /1   ]  417.407307956        1
[INPUT] 0    0    [1    /1   ]  147.728885611        1
[INPUT] 0    0    [1    /1   ]  58.5895948392        1
[INPUT] 0    0    [1    /1   ]  24.7185593406        1
[INPUT] 0    0    [1    /1   ]  9.07566735478        1
[INPUT] 1    0    [1    /1   ]  8.60428818948        1
[INPUT] 1    0    [1    /1   ]  0.492752141911       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22896514058403022, 1.0]], [0, [0.5972181671385307, 1.0]], [0, [1.8179354828498973, 1.0]], [0, [117616.8128532514, 1.0]], [0, [4.0456105689643955, 1.0]], [0, [1176168.1426132112, 1.0]], [0, [588084.0699555185, 1.0]], [0, [294042.0309158123, 1.0]], [0, [147020.99130110038, 1.0]], [0, [73510.4174556138, 1.0]], [0, [36754.701052194694, 1.0]], [0, [7302.291074055808, 1.0]], [0, [18375.77015715293, 1.0]], [0, [1443.757379968382, 1.0]], [0, [417.4073079557776, 1.0]], [0, [147.72888561107277, 1.0]], [0, [58.58959483915914, 1.0]], [0, [24.71855934055185, 1.0]], [0, [9.075667354776652, 1.0]], [1, [8.604288189475275, 1.0]], [1, [0.49275214191068184, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22896514]
bas 1, expnt(s) = [0.59721817]
bas 2, expnt(s) = [1.81793548]
bas 3, expnt(s) = [117616.81285325]
bas 4, expnt(s) = [4.04561057]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995552]
bas 7, expnt(s) = [294042.03091581]
bas 8, expnt(s) = [147020.9913011]
bas 9, expnt(s) = [73510.41745561]
bas 10, expnt(s) = [36754.70105219]
bas 11, expnt(s) = [7302.29107406]
bas 12, expnt(s) = [18375.77015715]
bas 13, expnt(s) = [1443.75737997]
bas 14, expnt(s) = [417.40730796]
bas 15, expnt(s) = [147.72888561]
bas 16, expnt(s) = [58.58959484]
bas 17, expnt(s) = [24.71855934]
bas 18, expnt(s) = [9.07566735]
bas 19, expnt(s) = [8.60428819]
bas 20, expnt(s) = [0.49275214]
CPU time:      1213.38
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28965141e-01 8.36261397e-01 5.97218167e-01 1.71638528e+00
 1.81793548e+00 3.95547710e+00 1.17616813e+05 1.60460108e+04
 4.04561057e+00 7.20697608e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229107e+03 1.99576490e+03
 1.83757702e+04 3.98748614e+03 1.44375738e+03 5.91746485e+02
 4.17407308e+02 2.33310917e+02 1.47728886e+02 1.07056759e+02
 5.85895948e+01 5.35032785e+01 2.47185593e+01 2.80080189e+01
 9.07566735e+00 1.32106428e+01 8.60428819e+00 4.29910525e+01
 4.92752142e-01 1.20439805e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608158528602
cond(S) = 912646.7288188668
E1 = -689.5960457591217  E_coul = 184.97170750420125
init E= -504.62433825492
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672168641403627  LUMO = 0.538061927762859
  mo_energy =
[-1.21709759e+02 -1.33862844e+01 -7.62357901e+00 -7.62357901e+00
 -7.62357901e+00 -1.65758243e+00 -6.72168641e-01 -6.72168641e-01
 -6.72168641e-01  5.38061928e-01  4.84816813e+00  2.14085235e+01
  8.03997719e+01  2.75474471e+02  9.03212121e+02  3.15562718e+03
  1.26349739e+04  4.12314262e+04  1.05259190e+05  2.30432019e+05
  4.56239313e+05  8.45185759e+05  1.52835740e+06  2.85061786e+06
  5.80849625e+06]
E1 = -707.7553625784765  E_coul = 199.7828284787923
cycle= 1 E= -507.972534099684  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.759381
diis-c [-0.57665999  1.        ]
  HOMO = -0.217618823145949  LUMO = 0.884260798953413
  mo_energy =
[-1.20200091e+02 -1.23047114e+01 -6.59396223e+00 -6.59396223e+00
 -6.59396223e+00 -1.16331840e+00 -2.17618823e-01 -2.17618823e-01
 -2.17618823e-01  8.84260799e-01  5.47121239e+00  2.23581590e+01
  8.16702764e+01  2.76926922e+02  9.04703681e+02  3.15705954e+03
  1.26362999e+04  4.12326850e+04  1.05260412e+05  2.30433216e+05
  4.56240493e+05  8.45186926e+05  1.52835855e+06  2.85061901e+06
  5.80849739e+06]
E1 = -706.800327342252  E_coul = 198.8099756787476
cycle= 2 E= -507.990351663504  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348602
diis-c [-0.00120999 -0.00302859  1.00302859]
  HOMO = -0.239800247499273  LUMO = 0.880587420816301
  mo_energy =
[-1.20315115e+02 -1.23725253e+01 -6.66904945e+00 -6.66904945e+00
 -6.66904945e+00 -1.17759060e+00 -2.39800247e-01 -2.39800247e-01
 -2.39800247e-01  8.80587421e-01  5.44313620e+00  2.23009965e+01
  8.15863588e+01  2.76822148e+02  9.04583011e+02  3.15692451e+03
  1.26361546e+04  4.12325359e+04  1.05260261e+05  2.30433064e+05
  4.56240341e+05  8.45186774e+05  1.52835840e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6918610431828  E_coul = 198.70124694856858
cycle= 3 E= -507.990614094614  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382046
diis-c [-3.27240716e-06  1.15636967e-04 -1.07268771e-01  1.10715313e+00]
  HOMO = -0.242947855781537  LUMO = 0.879840547142891
  mo_energy =
[-1.20326830e+02 -1.23810678e+01 -6.67807246e+00 -6.67807246e+00
 -6.67807246e+00 -1.17949788e+00 -2.42947856e-01 -2.42947856e-01
 -2.42947856e-01  8.79840547e-01  5.43897261e+00  2.22936225e+01
  8.15767364e+01  2.76811099e+02  9.04571061e+02  3.15691186e+03
  1.26361415e+04  4.12325226e+04  1.05260248e+05  2.30433051e+05
  4.56240327e+05  8.45186761e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.6765684649107  E_coul = 198.68594930619062
cycle= 4 E= -507.99061915872  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173526
diis-c [-5.67327540e-10 -9.46931742e-06  6.86453710e-03 -9.76680619e-02
  1.09081299e+00]
  HOMO = -0.243096299581478  LUMO = 0.879796025602706
  mo_energy =
[-1.20327170e+02 -1.23814036e+01 -6.67840377e+00 -6.67840377e+00
 -6.67840377e+00 -1.17958783e+00 -2.43096300e-01 -2.43096300e-01
 -2.43096300e-01  8.79796026e-01  5.43877010e+00  2.22933228e+01
  8.15764052e+01  2.76810761e+02  9.04570720e+02  3.15691152e+03
  1.26361411e+04  4.12325222e+04  1.05260247e+05  2.30433051e+05
  4.56240327e+05  8.45186760e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.6758532102521  E_coul = 198.68523403730748
cycle= 5 E= -507.990619172945  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63232e-06
diis-c [-9.42540324e-13  6.09186463e-07 -5.59799862e-04  7.58873565e-03
 -9.09313101e-02  1.08390177e+00]
  HOMO = -0.24309902577975  LUMO = 0.87979525630737
  mo_energy =
[-1.20327176e+02 -1.23814089e+01 -6.67840913e+00 -6.67840913e+00
 -6.67840913e+00 -1.17958971e+00 -2.43099026e-01 -2.43099026e-01
 -2.43099026e-01  8.79795256e-01  5.43876633e+00  2.22933179e+01
  8.15763997e+01  2.76810755e+02  9.04570714e+02  3.15691151e+03
  1.26361411e+04  4.12325222e+04  1.05260247e+05  2.30433051e+05
  4.56240327e+05  8.45186760e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.6758394096092  E_coul = 198.6852202366572
cycle= 6 E= -507.990619172952  delta_E= -7.5e-12  |g|= 9.2e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758394096092  E_coul = 198.6852202366572
  HOMO = -0.243099068289098  LUMO = 0.879795232303441
  mo_energy =
[-1.20327176e+02 -1.23814090e+01 -6.67840921e+00 -6.67840921e+00
 -6.67840921e+00 -1.17958972e+00 -2.43099068e-01 -2.43099068e-01
 -2.43099068e-01  8.79795232e-01  5.43876627e+00  2.22933178e+01
  8.15763996e+01  2.76810755e+02  9.04570714e+02  3.15691151e+03
  1.26361411e+04  4.12325222e+04  1.05260247e+05  2.30433051e+05
  4.56240327e+05  8.45186760e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.675839217533  E_coul = 198.68522004458129
Extra cycle  E= -507.990619172952  delta_E= 2.84e-13  |g|= 1.13e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.28965141e-01 5.97218167e-01 1.81793548e+00 1.17616813e+05
 4.04561057e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229107e+03
 1.83757702e+04 1.44375738e+03 4.17407308e+02 1.47728886e+02
 5.85895948e+01 2.47185593e+01 9.07566735e+00 8.60428819e+00
 4.92752142e-01]
E = -507.99061917295177
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228965140584       1
[INPUT] 0    0    [1    /1   ]  0.597218167139       1
[INPUT] 0    0    [1    /1   ]  1.81793548285        1
[INPUT] 0    0    [1    /1   ]  117616.812853        1
[INPUT] 0    0    [1    /1   ]  4.04561056896        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174556        1
[INPUT] 0    0    [1    /1   ]  36754.7010522        1
[INPUT] 0    0    [1    /1   ]  7302.29107406        1
[INPUT] 0    0    [1    /1   ]  18375.7701572        1
[INPUT] 0    0    [1    /1   ]  1443.75737997        1
[INPUT] 0    0    [1    /1   ]  417.407307956        1
[INPUT] 0    0    [1    /1   ]  147.728885611        1
[INPUT] 0    0    [1    /1   ]  58.5895948392        1
[INPUT] 0    0    [1    /1   ]  24.7185593406        1
[INPUT] 0    0    [1    /1   ]  9.07566735478        1
[INPUT] 1    0    [1    /1   ]  8.60428818948        1
[INPUT] 1    0    [1    /1   ]  0.492752141911       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22896514058403022, 1.0]], [0, [0.5972181671385307, 1.0]], [0, [1.8179354828498973, 1.0]], [0, [117616.8128532514, 1.0]], [0, [4.0456105689643955, 1.0]], [0, [1176168.1426132112, 1.0]], [0, [588084.0699555185, 1.0]], [0, [294042.0309158123, 1.0]], [0, [147020.99130110038, 1.0]], [0, [73510.4174556138, 1.0]], [0, [36754.701052194694, 1.0]], [0, [7302.291074055808, 1.0]], [0, [18375.77015715293, 1.0]], [0, [1443.757379968382, 1.0]], [0, [417.4073079557776, 1.0]], [0, [147.72888561107277, 1.0]], [0, [58.58959483915914, 1.0]], [0, [24.71855934055185, 1.0]], [0, [9.075667354776652, 1.0]], [1, [8.604288189475275, 1.0]], [1, [0.49275214191068184, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22896514]
bas 1, expnt(s) = [0.59721817]
bas 2, expnt(s) = [1.81793548]
bas 3, expnt(s) = [117616.81285325]
bas 4, expnt(s) = [4.04561057]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995552]
bas 7, expnt(s) = [294042.03091581]
bas 8, expnt(s) = [147020.9913011]
bas 9, expnt(s) = [73510.41745561]
bas 10, expnt(s) = [36754.70105219]
bas 11, expnt(s) = [7302.29107406]
bas 12, expnt(s) = [18375.77015715]
bas 13, expnt(s) = [1443.75737997]
bas 14, expnt(s) = [417.40730796]
bas 15, expnt(s) = [147.72888561]
bas 16, expnt(s) = [58.58959484]
bas 17, expnt(s) = [24.71855934]
bas 18, expnt(s) = [9.07566735]
bas 19, expnt(s) = [8.60428819]
bas 20, expnt(s) = [0.49275214]
CPU time:      1215.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28965141e-01 8.36261397e-01 5.97218167e-01 1.71638528e+00
 1.81793548e+00 3.95547710e+00 1.17616813e+05 1.60460108e+04
 4.04561057e+00 7.20697608e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229107e+03 1.99576490e+03
 1.83757702e+04 3.98748614e+03 1.44375738e+03 5.91746485e+02
 4.17407308e+02 2.33310917e+02 1.47728886e+02 1.07056759e+02
 5.85895948e+01 5.35032785e+01 2.47185593e+01 2.80080189e+01
 9.07566735e+00 1.32106428e+01 8.60428819e+00 4.29910525e+01
 4.92752142e-01 1.20439805e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608158528602
cond(S) = 912646.7288188668
E1 = -689.5960457591217  E_coul = 184.97170750420125
init E= -504.62433825492
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672168641403627  LUMO = 0.538061927762859
  mo_energy =
[-1.21709759e+02 -1.33862844e+01 -7.62357901e+00 -7.62357901e+00
 -7.62357901e+00 -1.65758243e+00 -6.72168641e-01 -6.72168641e-01
 -6.72168641e-01  5.38061928e-01  4.84816813e+00  2.14085235e+01
  8.03997719e+01  2.75474471e+02  9.03212121e+02  3.15562718e+03
  1.26349739e+04  4.12314262e+04  1.05259190e+05  2.30432019e+05
  4.56239313e+05  8.45185759e+05  1.52835740e+06  2.85061786e+06
  5.80849625e+06]
E1 = -707.7553625784765  E_coul = 199.7828284787923
cycle= 1 E= -507.972534099684  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.759381
diis-c [-0.57665999  1.        ]
  HOMO = -0.217618823145949  LUMO = 0.884260798953413
  mo_energy =
[-1.20200091e+02 -1.23047114e+01 -6.59396223e+00 -6.59396223e+00
 -6.59396223e+00 -1.16331840e+00 -2.17618823e-01 -2.17618823e-01
 -2.17618823e-01  8.84260799e-01  5.47121239e+00  2.23581590e+01
  8.16702764e+01  2.76926922e+02  9.04703681e+02  3.15705954e+03
  1.26362999e+04  4.12326850e+04  1.05260412e+05  2.30433216e+05
  4.56240493e+05  8.45186926e+05  1.52835855e+06  2.85061901e+06
  5.80849739e+06]
E1 = -706.800327342252  E_coul = 198.8099756787476
cycle= 2 E= -507.990351663504  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348602
diis-c [-0.00120999 -0.00302859  1.00302859]
  HOMO = -0.239800247499273  LUMO = 0.880587420816301
  mo_energy =
[-1.20315115e+02 -1.23725253e+01 -6.66904945e+00 -6.66904945e+00
 -6.66904945e+00 -1.17759060e+00 -2.39800247e-01 -2.39800247e-01
 -2.39800247e-01  8.80587421e-01  5.44313620e+00  2.23009965e+01
  8.15863588e+01  2.76822148e+02  9.04583011e+02  3.15692451e+03
  1.26361546e+04  4.12325359e+04  1.05260261e+05  2.30433064e+05
  4.56240341e+05  8.45186774e+05  1.52835840e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6918610431828  E_coul = 198.70124694856858
cycle= 3 E= -507.990614094614  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382046
diis-c [-3.27240716e-06  1.15636967e-04 -1.07268771e-01  1.10715313e+00]
  HOMO = -0.242947855781537  LUMO = 0.879840547142891
  mo_energy =
[-1.20326830e+02 -1.23810678e+01 -6.67807246e+00 -6.67807246e+00
 -6.67807246e+00 -1.17949788e+00 -2.42947856e-01 -2.42947856e-01
 -2.42947856e-01  8.79840547e-01  5.43897261e+00  2.22936225e+01
  8.15767364e+01  2.76811099e+02  9.04571061e+02  3.15691186e+03
  1.26361415e+04  4.12325226e+04  1.05260248e+05  2.30433051e+05
  4.56240327e+05  8.45186761e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.6765684649107  E_coul = 198.68594930619062
cycle= 4 E= -507.99061915872  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173526
diis-c [-5.67327540e-10 -9.46931742e-06  6.86453710e-03 -9.76680619e-02
  1.09081299e+00]
  HOMO = -0.243096299581478  LUMO = 0.879796025602706
  mo_energy =
[-1.20327170e+02 -1.23814036e+01 -6.67840377e+00 -6.67840377e+00
 -6.67840377e+00 -1.17958783e+00 -2.43096300e-01 -2.43096300e-01
 -2.43096300e-01  8.79796026e-01  5.43877010e+00  2.22933228e+01
  8.15764052e+01  2.76810761e+02  9.04570720e+02  3.15691152e+03
  1.26361411e+04  4.12325222e+04  1.05260247e+05  2.30433051e+05
  4.56240327e+05  8.45186760e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.6758532102521  E_coul = 198.68523403730748
cycle= 5 E= -507.990619172945  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63232e-06
diis-c [-9.42540324e-13  6.09186463e-07 -5.59799862e-04  7.58873565e-03
 -9.09313101e-02  1.08390177e+00]
  HOMO = -0.24309902577975  LUMO = 0.87979525630737
  mo_energy =
[-1.20327176e+02 -1.23814089e+01 -6.67840913e+00 -6.67840913e+00
 -6.67840913e+00 -1.17958971e+00 -2.43099026e-01 -2.43099026e-01
 -2.43099026e-01  8.79795256e-01  5.43876633e+00  2.22933179e+01
  8.15763997e+01  2.76810755e+02  9.04570714e+02  3.15691151e+03
  1.26361411e+04  4.12325222e+04  1.05260247e+05  2.30433051e+05
  4.56240327e+05  8.45186760e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.6758394096092  E_coul = 198.6852202366572
cycle= 6 E= -507.990619172952  delta_E= -7.5e-12  |g|= 9.2e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758394096092  E_coul = 198.6852202366572
  HOMO = -0.243099068289098  LUMO = 0.879795232303441
  mo_energy =
[-1.20327176e+02 -1.23814090e+01 -6.67840921e+00 -6.67840921e+00
 -6.67840921e+00 -1.17958972e+00 -2.43099068e-01 -2.43099068e-01
 -2.43099068e-01  8.79795232e-01  5.43876627e+00  2.22933178e+01
  8.15763996e+01  2.76810755e+02  9.04570714e+02  3.15691151e+03
  1.26361411e+04  4.12325222e+04  1.05260247e+05  2.30433051e+05
  4.56240327e+05  8.45186760e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.675839217533  E_coul = 198.68522004458129
Extra cycle  E= -507.990619172952  delta_E= 2.84e-13  |g|= 1.13e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912646.7288188668
E1 = -706.675839217533  E_coul = 198.68522004458129
init E= -507.990619172952
    CPU time for initialize scf      5.63 sec, wall time      0.24 sec
  HOMO = -0.243099074501262  LUMO = 0.879795229659273
  mo_energy =
[-1.20327176e+02 -1.23814090e+01 -6.67840923e+00 -6.67840923e+00
 -6.67840923e+00 -1.17958973e+00 -2.43099075e-01 -2.43099075e-01
 -2.43099075e-01  8.79795230e-01  5.43876626e+00  2.22933178e+01
  8.15763996e+01  2.76810755e+02  9.04570714e+02  3.15691151e+03
  1.26361411e+04  4.12325222e+04  1.05260247e+05  2.30433051e+05
  4.56240327e+05  8.45186760e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.6758391909624  E_coul = 198.68522001801034
cycle= 1 E= -507.990619172952  delta_E= -2.84e-13  |g|= 2.13e-09  |ddm|= 2.81e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6758391909624  E_coul = 198.68522001801034
  HOMO = -0.243099075346763  LUMO = 0.879795229547386
  mo_energy =
[-1.20327176e+02 -1.23814090e+01 -6.67840923e+00 -6.67840923e+00
 -6.67840923e+00 -1.17958973e+00 -2.43099075e-01 -2.43099075e-01
 -2.43099075e-01  8.79795230e-01  5.43876626e+00  2.22933178e+01
  8.15763996e+01  2.76810755e+02  9.04570714e+02  3.15691151e+03
  1.26361411e+04  4.12325222e+04  1.05260247e+05  2.30433051e+05
  4.56240327e+05  8.45186760e+05  1.52835839e+06  2.85061884e+06
  5.80849723e+06]
E1 = -706.6758391874203  E_coul = 198.68522001446803
Extra cycle  E= -507.990619172952  delta_E= -1.71e-13  |g|= 1.41e-09  |ddm|= 3.47e-09
    CPU time for scf_cycle      6.14 sec, wall time      0.40 sec
exp = [2.28965141e-01 5.97218167e-01 1.81793548e+00 1.17616813e+05
 4.04561057e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229107e+03
 1.83757702e+04 1.44375738e+03 4.17407308e+02 1.47728886e+02
 5.85895948e+01 2.47185593e+01 9.07566735e+00 8.60428819e+00
 4.92752142e-01]
grad_E = [-1.33507041e-05  7.28554976e-06  1.62054525e-06  6.08093340e-09
  7.37954499e-07  4.06504101e-11  1.74766673e-10  9.43167970e-10
  3.72670692e-09  1.55627141e-08  8.11580530e-08  5.11661496e-06
  1.99135740e-07 -3.92598329e-05  6.66588398e-07 -2.02326745e-05
  6.33765051e-06 -5.10523036e-05  8.70227156e-06 -1.11496750e-06
 -2.41366700e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228964363631       1
[INPUT] 0    0    [1    /1   ]  0.597206658148       1
[INPUT] 0    0    [1    /1   ]  1.81796529625        1
[INPUT] 0    0    [1    /1   ]  117616.812853        1
[INPUT] 0    0    [1    /1   ]  4.04605593371        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174559        1
[INPUT] 0    0    [1    /1   ]  36754.7010539        1
[INPUT] 0    0    [1    /1   ]  7302.29118246        1
[INPUT] 0    0    [1    /1   ]  18375.7701614        1
[INPUT] 0    0    [1    /1   ]  1443.75657128        1
[INPUT] 0    0    [1    /1   ]  417.407075337        1
[INPUT] 0    0    [1    /1   ]  147.729465916        1
[INPUT] 0    0    [1    /1   ]  58.5876359096        1
[INPUT] 0    0    [1    /1   ]  24.719034423         1
[INPUT] 0    0    [1    /1   ]  9.07649936366        1
[INPUT] 1    0    [1    /1   ]  8.60428836311        1
[INPUT] 1    0    [1    /1   ]  0.492752089608       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22896436363134154, 1.0]], [0, [0.5972066581484746, 1.0]], [0, [1.8179652962509651, 1.0]], [0, [117616.81285338022, 1.0]], [0, [4.046055933713831, 1.0]], [0, [1176168.142613212, 1.0]], [0, [588084.0699555222, 1.0]], [0, [294042.03091583226, 1.0]], [0, [147020.99130117934, 1.0]], [0, [73510.41745594345, 1.0]], [0, [36754.70105391453, 1.0]], [0, [7302.291182461981, 1.0]], [0, [18375.770161365293, 1.0]], [0, [1443.7565712849225, 1.0]], [0, [417.4070753371436, 1.0]], [0, [147.7294659163999, 1.0]], [0, [58.587635909638436, 1.0]], [0, [24.71903442301822, 1.0]], [0, [9.076499363663629, 1.0]], [1, [8.604288363110047, 1.0]], [1, [0.49275208960765726, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22896436]
bas 1, expnt(s) = [0.59720666]
bas 2, expnt(s) = [1.8179653]
bas 3, expnt(s) = [117616.81285338]
bas 4, expnt(s) = [4.04605593]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995552]
bas 7, expnt(s) = [294042.03091583]
bas 8, expnt(s) = [147020.99130118]
bas 9, expnt(s) = [73510.41745594]
bas 10, expnt(s) = [36754.70105391]
bas 11, expnt(s) = [7302.29118246]
bas 12, expnt(s) = [18375.77016137]
bas 13, expnt(s) = [1443.75657128]
bas 14, expnt(s) = [417.40707534]
bas 15, expnt(s) = [147.72946592]
bas 16, expnt(s) = [58.58763591]
bas 17, expnt(s) = [24.71903442]
bas 18, expnt(s) = [9.07649936]
bas 19, expnt(s) = [8.60428836]
bas 20, expnt(s) = [0.49275209]
CPU time:      1230.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28964364e-01 8.36259269e-01 5.97206658e-01 1.71636048e+00
 1.81796530e+00 3.95552575e+00 1.17616813e+05 1.60460108e+04
 4.04605593e+00 7.20757111e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229118e+03 1.99576492e+03
 1.83757702e+04 3.98748614e+03 1.44375657e+03 5.91746237e+02
 4.17407075e+02 2.33310819e+02 1.47729466e+02 1.07057074e+02
 5.85876359e+01 5.35019369e+01 2.47190344e+01 2.80084226e+01
 9.07649936e+00 1.32115511e+01 8.60428836e+00 4.29910536e+01
 4.92752090e-01 1.20439789e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608161184483
cond(S) = 912646.7771386048
E1 = -689.5960557881668  E_coul = 184.97170490745566
init E= -504.624350880711
    CPU time for initialize scf      3.39 sec, wall time      0.19 sec
  HOMO = -0.672168817935558  LUMO = 0.538054504927312
  mo_energy =
[-1.21709759e+02 -1.33862847e+01 -7.62357915e+00 -7.62357915e+00
 -7.62357915e+00 -1.65758249e+00 -6.72168818e-01 -6.72168818e-01
 -6.72168818e-01  5.38054505e-01  4.84834784e+00  2.14104635e+01
  8.04043505e+01  2.75477846e+02  9.03213377e+02  3.15562687e+03
  1.26349718e+04  4.12314237e+04  1.05259187e+05  2.30432016e+05
  4.56239310e+05  8.45185757e+05  1.52835740e+06  2.85061786e+06
  5.80849625e+06]
E1 = -707.7553594327915  E_coul = 199.78282523063405
cycle= 1 E= -507.972534202157  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.759382
diis-c [-0.57666161  1.        ]
  HOMO = -0.217618957680276  LUMO = 0.88425307637957
  mo_energy =
[-1.20200091e+02 -1.23047118e+01 -6.59396246e+00 -6.59396246e+00
 -6.59396246e+00 -1.16331845e+00 -2.17618958e-01 -2.17618958e-01
 -2.17618958e-01  8.84253076e-01  5.47140901e+00  2.23601275e+01
  8.16748603e+01  2.76930295e+02  9.04704936e+02  3.15705922e+03
  1.26362978e+04  4.12326824e+04  1.05260409e+05  2.30433214e+05
  4.56240490e+05  8.45186924e+05  1.52835855e+06  2.85061901e+06
  5.80849739e+06]
E1 = -706.8003282532825  E_coul = 198.8099765826643
cycle= 2 E= -507.990351670618  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348602
diis-c [-0.00120999 -0.0030284   1.0030284 ]
  HOMO = -0.23980022150981  LUMO = 0.880579712241453
  mo_energy =
[-1.20315115e+02 -1.23725254e+01 -6.66904936e+00 -6.66904936e+00
 -6.66904936e+00 -1.17759053e+00 -2.39800222e-01 -2.39800222e-01
 -2.39800222e-01  8.80579712e-01  5.44333181e+00  2.23029631e+01
  8.15909424e+01  2.76825522e+02  9.04584266e+02  3.15692419e+03
  1.26361525e+04  4.12325333e+04  1.05260258e+05  2.30433062e+05
  4.56240338e+05  8.45186772e+05  1.52835840e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6918622939638  E_coul = 198.70124819264473
cycle= 3 E= -507.990614101319  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382045
diis-c [-3.27239564e-06  1.15616283e-04 -1.07268465e-01  1.10715285e+00]
  HOMO = -0.242947821935174  LUMO = 0.879832836851545
  mo_energy =
[-1.20326830e+02 -1.23810679e+01 -6.67807236e+00 -6.67807236e+00
 -6.67807236e+00 -1.17949781e+00 -2.42947822e-01 -2.42947822e-01
 -2.42947822e-01  8.79832837e-01  5.43916809e+00  2.22955889e+01
  8.15813200e+01  2.76814472e+02  9.04572316e+02  3.15691154e+03
  1.26361394e+04  4.12325200e+04  1.05260245e+05  2.30433049e+05
  4.56240325e+05  8.45186758e+05  1.52835839e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6765696724298  E_coul = 198.68595050693943
cycle= 4 E= -507.99061916549  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017353
diis-c [-5.67335258e-10 -9.46937387e-06  6.86472380e-03 -9.76706850e-02
  1.09081543e+00]
  HOMO = -0.243096269206341  LUMO = 0.879788316780963
  mo_energy =
[-1.20327169e+02 -1.23814037e+01 -6.67840368e+00 -6.67840368e+00
 -6.67840368e+00 -1.17958776e+00 -2.43096269e-01 -2.43096269e-01
 -2.43096269e-01  8.79788317e-01  5.43896556e+00  2.22952892e+01
  8.15809888e+01  2.76814135e+02  9.04571976e+02  3.15691120e+03
  1.26361390e+04  4.12325197e+04  1.05260245e+05  2.30433048e+05
  4.56240325e+05  8.45186758e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6758543947915  E_coul = 198.68523521507606
cycle= 5 E= -507.990619179715  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63258e-06
diis-c [-9.40390223e-13  6.14809758e-07 -5.60225531e-04  7.59367333e-03
 -9.09741749e-02  1.08394011e+00]
  HOMO = -0.243098995419039  LUMO = 0.879787547368435
  mo_energy =
[-1.20327176e+02 -1.23814090e+01 -6.67840904e+00 -6.67840904e+00
 -6.67840904e+00 -1.17958964e+00 -2.43098995e-01 -2.43098995e-01
 -2.43098995e-01  8.79787547e-01  5.43896179e+00  2.22952843e+01
  8.15809832e+01  2.76814129e+02  9.04571970e+02  3.15691119e+03
  1.26361390e+04  4.12325197e+04  1.05260245e+05  2.30433048e+05
  4.56240325e+05  8.45186758e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6758405923217  E_coul = 198.6852214125988
cycle= 6 E= -507.990619179723  delta_E= -7.5e-12  |g|= 9.12e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758405923217  E_coul = 198.6852214125988
  HOMO = -0.243099037943037  LUMO = 0.879787523054595
  mo_energy =
[-1.20327176e+02 -1.23814091e+01 -6.67840912e+00 -6.67840912e+00
 -6.67840912e+00 -1.17958965e+00 -2.43099038e-01 -2.43099038e-01
 -2.43099038e-01  8.79787523e-01  5.43896173e+00  2.22952842e+01
  8.15809832e+01  2.76814128e+02  9.04571969e+02  3.15691119e+03
  1.26361390e+04  4.12325197e+04  1.05260245e+05  2.30433048e+05
  4.56240325e+05  8.45186758e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6758404061073  E_coul = 198.68522122638439
Extra cycle  E= -507.990619179723  delta_E= -5.68e-14  |g|= 1.15e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      4.24 sec, wall time      0.41 sec
exp = [2.28964364e-01 5.97206658e-01 1.81796530e+00 1.17616813e+05
 4.04605593e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229118e+03
 1.83757702e+04 1.44375657e+03 4.17407075e+02 1.47729466e+02
 5.85876359e+01 2.47190344e+01 9.07649936e+00 8.60428836e+00
 4.92752090e-01]
E = -507.99061917972296
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228964363631       1
[INPUT] 0    0    [1    /1   ]  0.597206658148       1
[INPUT] 0    0    [1    /1   ]  1.81796529625        1
[INPUT] 0    0    [1    /1   ]  117616.812853        1
[INPUT] 0    0    [1    /1   ]  4.04605593371        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174559        1
[INPUT] 0    0    [1    /1   ]  36754.7010539        1
[INPUT] 0    0    [1    /1   ]  7302.29118246        1
[INPUT] 0    0    [1    /1   ]  18375.7701614        1
[INPUT] 0    0    [1    /1   ]  1443.75657128        1
[INPUT] 0    0    [1    /1   ]  417.407075337        1
[INPUT] 0    0    [1    /1   ]  147.729465916        1
[INPUT] 0    0    [1    /1   ]  58.5876359096        1
[INPUT] 0    0    [1    /1   ]  24.719034423         1
[INPUT] 0    0    [1    /1   ]  9.07649936366        1
[INPUT] 1    0    [1    /1   ]  8.60428836311        1
[INPUT] 1    0    [1    /1   ]  0.492752089608       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22896436363134154, 1.0]], [0, [0.5972066581484746, 1.0]], [0, [1.8179652962509651, 1.0]], [0, [117616.81285338022, 1.0]], [0, [4.046055933713831, 1.0]], [0, [1176168.142613212, 1.0]], [0, [588084.0699555222, 1.0]], [0, [294042.03091583226, 1.0]], [0, [147020.99130117934, 1.0]], [0, [73510.41745594345, 1.0]], [0, [36754.70105391453, 1.0]], [0, [7302.291182461981, 1.0]], [0, [18375.770161365293, 1.0]], [0, [1443.7565712849225, 1.0]], [0, [417.4070753371436, 1.0]], [0, [147.7294659163999, 1.0]], [0, [58.587635909638436, 1.0]], [0, [24.71903442301822, 1.0]], [0, [9.076499363663629, 1.0]], [1, [8.604288363110047, 1.0]], [1, [0.49275208960765726, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22896436]
bas 1, expnt(s) = [0.59720666]
bas 2, expnt(s) = [1.8179653]
bas 3, expnt(s) = [117616.81285338]
bas 4, expnt(s) = [4.04605593]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995552]
bas 7, expnt(s) = [294042.03091583]
bas 8, expnt(s) = [147020.99130118]
bas 9, expnt(s) = [73510.41745594]
bas 10, expnt(s) = [36754.70105391]
bas 11, expnt(s) = [7302.29118246]
bas 12, expnt(s) = [18375.77016137]
bas 13, expnt(s) = [1443.75657128]
bas 14, expnt(s) = [417.40707534]
bas 15, expnt(s) = [147.72946592]
bas 16, expnt(s) = [58.58763591]
bas 17, expnt(s) = [24.71903442]
bas 18, expnt(s) = [9.07649936]
bas 19, expnt(s) = [8.60428836]
bas 20, expnt(s) = [0.49275209]
CPU time:      1234.69
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28964364e-01 8.36259269e-01 5.97206658e-01 1.71636048e+00
 1.81796530e+00 3.95552575e+00 1.17616813e+05 1.60460108e+04
 4.04605593e+00 7.20757111e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229118e+03 1.99576492e+03
 1.83757702e+04 3.98748614e+03 1.44375657e+03 5.91746237e+02
 4.17407075e+02 2.33310819e+02 1.47729466e+02 1.07057074e+02
 5.85876359e+01 5.35019369e+01 2.47190344e+01 2.80084226e+01
 9.07649936e+00 1.32115511e+01 8.60428836e+00 4.29910536e+01
 4.92752090e-01 1.20439789e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608161184483
cond(S) = 912646.7771386048
E1 = -689.5960557881668  E_coul = 184.97170490745566
init E= -504.624350880711
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672168817935558  LUMO = 0.538054504927312
  mo_energy =
[-1.21709759e+02 -1.33862847e+01 -7.62357915e+00 -7.62357915e+00
 -7.62357915e+00 -1.65758249e+00 -6.72168818e-01 -6.72168818e-01
 -6.72168818e-01  5.38054505e-01  4.84834784e+00  2.14104635e+01
  8.04043505e+01  2.75477846e+02  9.03213377e+02  3.15562687e+03
  1.26349718e+04  4.12314237e+04  1.05259187e+05  2.30432016e+05
  4.56239310e+05  8.45185757e+05  1.52835740e+06  2.85061786e+06
  5.80849625e+06]
E1 = -707.7553594327915  E_coul = 199.78282523063405
cycle= 1 E= -507.972534202157  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.759382
diis-c [-0.57666161  1.        ]
  HOMO = -0.217618957680276  LUMO = 0.88425307637957
  mo_energy =
[-1.20200091e+02 -1.23047118e+01 -6.59396246e+00 -6.59396246e+00
 -6.59396246e+00 -1.16331845e+00 -2.17618958e-01 -2.17618958e-01
 -2.17618958e-01  8.84253076e-01  5.47140901e+00  2.23601275e+01
  8.16748603e+01  2.76930295e+02  9.04704936e+02  3.15705922e+03
  1.26362978e+04  4.12326824e+04  1.05260409e+05  2.30433214e+05
  4.56240490e+05  8.45186924e+05  1.52835855e+06  2.85061901e+06
  5.80849739e+06]
E1 = -706.8003282532825  E_coul = 198.8099765826643
cycle= 2 E= -507.990351670618  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348602
diis-c [-0.00120999 -0.0030284   1.0030284 ]
  HOMO = -0.23980022150981  LUMO = 0.880579712241453
  mo_energy =
[-1.20315115e+02 -1.23725254e+01 -6.66904936e+00 -6.66904936e+00
 -6.66904936e+00 -1.17759053e+00 -2.39800222e-01 -2.39800222e-01
 -2.39800222e-01  8.80579712e-01  5.44333181e+00  2.23029631e+01
  8.15909424e+01  2.76825522e+02  9.04584266e+02  3.15692419e+03
  1.26361525e+04  4.12325333e+04  1.05260258e+05  2.30433062e+05
  4.56240338e+05  8.45186772e+05  1.52835840e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6918622939638  E_coul = 198.70124819264473
cycle= 3 E= -507.990614101319  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382045
diis-c [-3.27239564e-06  1.15616283e-04 -1.07268465e-01  1.10715285e+00]
  HOMO = -0.242947821935174  LUMO = 0.879832836851545
  mo_energy =
[-1.20326830e+02 -1.23810679e+01 -6.67807236e+00 -6.67807236e+00
 -6.67807236e+00 -1.17949781e+00 -2.42947822e-01 -2.42947822e-01
 -2.42947822e-01  8.79832837e-01  5.43916809e+00  2.22955889e+01
  8.15813200e+01  2.76814472e+02  9.04572316e+02  3.15691154e+03
  1.26361394e+04  4.12325200e+04  1.05260245e+05  2.30433049e+05
  4.56240325e+05  8.45186758e+05  1.52835839e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6765696724298  E_coul = 198.68595050693943
cycle= 4 E= -507.99061916549  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017353
diis-c [-5.67335258e-10 -9.46937387e-06  6.86472380e-03 -9.76706850e-02
  1.09081543e+00]
  HOMO = -0.243096269206341  LUMO = 0.879788316780963
  mo_energy =
[-1.20327169e+02 -1.23814037e+01 -6.67840368e+00 -6.67840368e+00
 -6.67840368e+00 -1.17958776e+00 -2.43096269e-01 -2.43096269e-01
 -2.43096269e-01  8.79788317e-01  5.43896556e+00  2.22952892e+01
  8.15809888e+01  2.76814135e+02  9.04571976e+02  3.15691120e+03
  1.26361390e+04  4.12325197e+04  1.05260245e+05  2.30433048e+05
  4.56240325e+05  8.45186758e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6758543947915  E_coul = 198.68523521507606
cycle= 5 E= -507.990619179715  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63258e-06
diis-c [-9.40390223e-13  6.14809758e-07 -5.60225531e-04  7.59367333e-03
 -9.09741749e-02  1.08394011e+00]
  HOMO = -0.243098995419039  LUMO = 0.879787547368435
  mo_energy =
[-1.20327176e+02 -1.23814090e+01 -6.67840904e+00 -6.67840904e+00
 -6.67840904e+00 -1.17958964e+00 -2.43098995e-01 -2.43098995e-01
 -2.43098995e-01  8.79787547e-01  5.43896179e+00  2.22952843e+01
  8.15809832e+01  2.76814129e+02  9.04571970e+02  3.15691119e+03
  1.26361390e+04  4.12325197e+04  1.05260245e+05  2.30433048e+05
  4.56240325e+05  8.45186758e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6758405923217  E_coul = 198.6852214125988
cycle= 6 E= -507.990619179723  delta_E= -7.5e-12  |g|= 9.12e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758405923217  E_coul = 198.6852214125988
  HOMO = -0.243099037943037  LUMO = 0.879787523054595
  mo_energy =
[-1.20327176e+02 -1.23814091e+01 -6.67840912e+00 -6.67840912e+00
 -6.67840912e+00 -1.17958965e+00 -2.43099038e-01 -2.43099038e-01
 -2.43099038e-01  8.79787523e-01  5.43896173e+00  2.22952842e+01
  8.15809832e+01  2.76814128e+02  9.04571969e+02  3.15691119e+03
  1.26361390e+04  4.12325197e+04  1.05260245e+05  2.30433048e+05
  4.56240325e+05  8.45186758e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6758404061073  E_coul = 198.68522122638439
Extra cycle  E= -507.990619179723  delta_E= -5.68e-14  |g|= 1.15e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912646.7771386048
E1 = -706.6758404061073  E_coul = 198.68522122638439
init E= -507.990619179723
    CPU time for initialize scf      6.08 sec, wall time      0.26 sec
  HOMO = -0.243099044010709  LUMO = 0.879787521410229
  mo_energy =
[-1.20327176e+02 -1.23814091e+01 -6.67840914e+00 -6.67840914e+00
 -6.67840914e+00 -1.17958966e+00 -2.43099044e-01 -2.43099044e-01
 -2.43099044e-01  8.79787521e-01  5.43896172e+00  2.22952842e+01
  8.15809831e+01  2.76814128e+02  9.04571969e+02  3.15691119e+03
  1.26361390e+04  4.12325197e+04  1.05260245e+05  2.30433048e+05
  4.56240325e+05  8.45186758e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6758403742393  E_coul = 198.68522119451623
cycle= 1 E= -507.990619179723  delta_E= -1.71e-13  |g|= 1.75e-09  |ddm|= 3.17e-08
    CPU time for cycle= 1      0.33 sec, wall time      0.03 sec
E1 = -706.6758403742393  E_coul = 198.68522119451623
  HOMO = -0.243099044988569  LUMO = 0.879787519928907
  mo_energy =
[-1.20327176e+02 -1.23814091e+01 -6.67840914e+00 -6.67840914e+00
 -6.67840914e+00 -1.17958966e+00 -2.43099045e-01 -2.43099045e-01
 -2.43099045e-01  8.79787520e-01  5.43896172e+00  2.22952842e+01
  8.15809831e+01  2.76814128e+02  9.04571969e+02  3.15691119e+03
  1.26361390e+04  4.12325197e+04  1.05260245e+05  2.30433048e+05
  4.56240325e+05  8.45186758e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6758403717406  E_coul = 198.68522119201722
Extra cycle  E= -507.990619179723  delta_E= -2.27e-13  |g|= 1.67e-09  |ddm|= 3.1e-09
    CPU time for scf_cycle      6.56 sec, wall time      0.43 sec
exp = [2.28964364e-01 5.97206658e-01 1.81796530e+00 1.17616813e+05
 4.04605593e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229118e+03
 1.83757702e+04 1.44375657e+03 4.17407075e+02 1.47729466e+02
 5.85876359e+01 2.47190344e+01 9.07649936e+00 8.60428836e+00
 4.92752090e-01]
grad_E = [ 1.19654467e-06 -3.89268699e-07  5.13328308e-07  6.08047920e-09
  1.75764165e-06  4.06453103e-11  1.74751780e-10  9.43098310e-10
  3.72642562e-09  1.55615240e-08  8.11523039e-08  5.11624063e-06
  1.99116984e-07 -3.92429343e-05  5.16709517e-07 -1.96190631e-05
  5.06549638e-06 -5.00817680e-05  8.77857597e-06 -8.35015648e-07
 -5.07763053e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228954195969       1
[INPUT] 0    0    [1    /1   ]  0.597162562622       1
[INPUT] 0    0    [1    /1   ]  1.81787053238        1
[INPUT] 0    0    [1    /1   ]  117616.812854        1
[INPUT] 0    0    [1    /1   ]  4.04621142971        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174564        1
[INPUT] 0    0    [1    /1   ]  36754.7010561        1
[INPUT] 0    0    [1    /1   ]  7302.29132075        1
[INPUT] 0    0    [1    /1   ]  18375.7701667        1
[INPUT] 0    0    [1    /1   ]  1443.75554187        1
[INPUT] 0    0    [1    /1   ]  417.406756495        1
[INPUT] 0    0    [1    /1   ]  147.730280597        1
[INPUT] 0    0    [1    /1   ]  58.5850992529        1
[INPUT] 0    0    [1    /1   ]  24.7196598973        1
[INPUT] 0    0    [1    /1   ]  9.07658194385        1
[INPUT] 1    0    [1    /1   ]  8.60428749108        1
[INPUT] 1    0    [1    /1   ]  0.492751916326       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22895419596919245, 1.0]], [0, [0.5971625626224399, 1.0]], [0, [1.8178705323789779, 1.0]], [0, [117616.81285354456, 1.0]], [0, [4.046211429712983, 1.0]], [0, [1176168.1426132133, 1.0]], [0, [588084.069955527, 1.0]], [0, [294042.03091585776, 1.0]], [0, [147020.99130128004, 1.0]], [0, [73510.41745636397, 1.0]], [0, [36754.70105610854, 1.0]], [0, [7302.291320754029, 1.0]], [0, [18375.77016673847, 1.0]], [0, [1443.7555418669253, 1.0]], [0, [417.40675649482534, 1.0]], [0, [147.73028059720193, 1.0]], [0, [58.58509925288376, 1.0]], [0, [24.719659897336417, 1.0]], [0, [9.076581943853409, 1.0]], [1, [8.604287491084891, 1.0]], [1, [0.4927519163259265, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2289542]
bas 1, expnt(s) = [0.59716256]
bas 2, expnt(s) = [1.81787053]
bas 3, expnt(s) = [117616.81285354]
bas 4, expnt(s) = [4.04621143]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995553]
bas 7, expnt(s) = [294042.03091586]
bas 8, expnt(s) = [147020.99130128]
bas 9, expnt(s) = [73510.41745636]
bas 10, expnt(s) = [36754.70105611]
bas 11, expnt(s) = [7302.29132075]
bas 12, expnt(s) = [18375.77016674]
bas 13, expnt(s) = [1443.75554187]
bas 14, expnt(s) = [417.40675649]
bas 15, expnt(s) = [147.7302806]
bas 16, expnt(s) = [58.58509925]
bas 17, expnt(s) = [24.7196599]
bas 18, expnt(s) = [9.07658194]
bas 19, expnt(s) = [8.60428749]
bas 20, expnt(s) = [0.49275192]
CPU time:      1249.94
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28954196e-01 8.36231416e-01 5.97162563e-01 1.71626543e+00
 1.81787053e+00 3.95537111e+00 1.17616813e+05 1.60460108e+04
 4.04621143e+00 7.20777886e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229132e+03 1.99576495e+03
 1.83757702e+04 3.98748614e+03 1.44375554e+03 5.91745920e+02
 4.17406756e+02 2.33310686e+02 1.47730281e+02 1.07057517e+02
 5.85850993e+01 5.35001995e+01 2.47196599e+01 2.80089542e+01
 9.07658194e+00 1.32116413e+01 8.60428749e+00 4.29910481e+01
 4.92751916e-01 1.20439736e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336081840962237
cond(S) = 912646.6866003555
E1 = -689.5960603189938  E_coul = 184.97169338021703
init E= -504.624366938777
    CPU time for initialize scf      0.76 sec, wall time      0.07 sec
  HOMO = -0.672169147705638  LUMO = 0.537991685042777
  mo_energy =
[-1.21709761e+02 -1.33862857e+01 -7.62357988e+00 -7.62357988e+00
 -7.62357988e+00 -1.65758272e+00 -6.72169148e-01 -6.72169148e-01
 -6.72169148e-01  5.37991685e-01  4.84805204e+00  2.14103536e+01
  8.04046926e+01  2.75475818e+02  9.03209043e+02  3.15562114e+03
  1.26349644e+04  4.12314160e+04  1.05259180e+05  2.30432009e+05
  4.56239303e+05  8.45185750e+05  1.52835739e+06  2.85061786e+06
  5.80849625e+06]
E1 = -707.7553456628924  E_coul = 199.78281135139187
cycle= 1 E= -507.972534311501  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.759381
diis-c [-0.5766596  1.       ]
  HOMO = -0.217619338768728  LUMO = 0.884177940816443
  mo_energy =
[-1.20200093e+02 -1.23047130e+01 -6.59396337e+00 -6.59396337e+00
 -6.59396337e+00 -1.16331871e+00 -2.17619339e-01 -2.17619339e-01
 -2.17619339e-01  8.84177941e-01  5.47110730e+00  2.23600234e+01
  8.16752033e+01  2.76928265e+02  9.04700602e+02  3.15705349e+03
  1.26362904e+04  4.12326748e+04  1.05260402e+05  2.30433206e+05
  4.56240483e+05  8.45186917e+05  1.52835854e+06  2.85061900e+06
  5.80849738e+06]
E1 = -706.8003178623629  E_coul = 198.80996618047647
cycle= 2 E= -507.990351681886  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348608
diis-c [-0.00121003 -0.00302854  1.00302854]
  HOMO = -0.239800477617054  LUMO = 0.880505074901362
  mo_energy =
[-1.20315116e+02 -1.23725264e+01 -6.66905003e+00 -6.66905003e+00
 -6.66905003e+00 -1.17759071e+00 -2.39800478e-01 -2.39800478e-01
 -2.39800478e-01  8.80505075e-01  5.44303111e+00  2.23028590e+01
  8.15912856e+01  2.76823493e+02  9.04579932e+02  3.15691846e+03
  1.26361451e+04  4.12325257e+04  1.05260251e+05  2.30433055e+05
  4.56240331e+05  8.45186765e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6918513412238  E_coul = 198.70123722500412
cycle= 3 E= -507.99061411622  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382058
diis-c [-3.27251513e-06  1.15569179e-04 -1.07270992e-01  1.10715542e+00]
  HOMO = -0.2429481099703  LUMO = 0.879758265070806
  mo_energy =
[-1.20326831e+02 -1.23810689e+01 -6.67807309e+00 -6.67807309e+00
 -6.67807309e+00 -1.17949802e+00 -2.42948110e-01 -2.42948110e-01
 -2.42948110e-01  8.79758265e-01  5.43886744e+00  2.22954846e+01
  8.15816631e+01  2.76812443e+02  9.04567982e+02  3.15690582e+03
  1.26361320e+04  4.12325124e+04  1.05260238e+05  2.30433041e+05
  4.56240318e+05  8.45186751e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6765583602707  E_coul = 198.6859391795856
cycle= 4 E= -507.990619180685  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173535
diis-c [-5.67566152e-10 -9.47176930e-06  6.86490918e-03 -9.76710584e-02
  1.09081562e+00]
  HOMO = -0.243096559867047  LUMO = 0.879713746361537
  mo_energy =
[-1.20327171e+02 -1.23814047e+01 -6.67840441e+00 -6.67840441e+00
 -6.67840441e+00 -1.17958797e+00 -2.43096560e-01 -2.43096560e-01
 -2.43096560e-01  8.79713746e-01  5.43866491e+00  2.22951850e+01
  8.15813319e+01  2.76812105e+02  9.04567642e+02  3.15690547e+03
  1.26361316e+04  4.12325121e+04  1.05260237e+05  2.30433041e+05
  4.56240317e+05  8.45186751e+05  1.52835838e+06  2.85061883e+06
  5.80849722e+06]
E1 = -706.6758430544684  E_coul = 198.68522385955603
cycle= 5 E= -507.990619194912  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63332e-06
diis-c [-9.43625790e-13  6.11187425e-07 -5.59928067e-04  7.58939946e-03
 -9.09300149e-02  1.08389993e+00]
  HOMO = -0.243099286690565  LUMO = 0.879712977680958
  mo_energy =
[-1.20327177e+02 -1.23814100e+01 -6.67840976e+00 -6.67840976e+00
 -6.67840976e+00 -1.17958984e+00 -2.43099287e-01 -2.43099287e-01
 -2.43099287e-01  8.79712978e-01  5.43866114e+00  2.22951800e+01
  8.15813264e+01  2.76812099e+02  9.04567636e+02  3.15690547e+03
  1.26361316e+04  4.12325121e+04  1.05260237e+05  2.30433041e+05
  4.56240317e+05  8.45186751e+05  1.52835838e+06  2.85061883e+06
  5.80849722e+06]
E1 = -706.6758292471208  E_coul = 198.6852100522011
cycle= 6 E= -507.99061919492  delta_E= -7.28e-12  |g|= 9.13e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758292471208  E_coul = 198.6852100522011
  HOMO = -0.243099329282028  LUMO = 0.87971295269356
  mo_energy =
[-1.20327177e+02 -1.23814101e+01 -6.67840985e+00 -6.67840985e+00
 -6.67840985e+00 -1.17958986e+00 -2.43099329e-01 -2.43099329e-01
 -2.43099329e-01  8.79712953e-01  5.43866108e+00  2.22951799e+01
  8.15813263e+01  2.76812099e+02  9.04567636e+02  3.15690547e+03
  1.26361316e+04  4.12325121e+04  1.05260237e+05  2.30433041e+05
  4.56240317e+05  8.45186751e+05  1.52835838e+06  2.85061883e+06
  5.80849722e+06]
E1 = -706.6758290598219  E_coul = 198.6852098649024
Extra cycle  E= -507.99061919492  delta_E= 1.14e-13  |g|= 1.14e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.61 sec, wall time      0.29 sec
exp = [2.28954196e-01 5.97162563e-01 1.81787053e+00 1.17616813e+05
 4.04621143e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229132e+03
 1.83757702e+04 1.44375554e+03 4.17406756e+02 1.47730281e+02
 5.85850993e+01 2.47196599e+01 9.07658194e+00 8.60428749e+00
 4.92751916e-01]
E = -507.99061919491953
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:34:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228954195969       1
[INPUT] 0    0    [1    /1   ]  0.597162562622       1
[INPUT] 0    0    [1    /1   ]  1.81787053238        1
[INPUT] 0    0    [1    /1   ]  117616.812854        1
[INPUT] 0    0    [1    /1   ]  4.04621142971        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174564        1
[INPUT] 0    0    [1    /1   ]  36754.7010561        1
[INPUT] 0    0    [1    /1   ]  7302.29132075        1
[INPUT] 0    0    [1    /1   ]  18375.7701667        1
[INPUT] 0    0    [1    /1   ]  1443.75554187        1
[INPUT] 0    0    [1    /1   ]  417.406756495        1
[INPUT] 0    0    [1    /1   ]  147.730280597        1
[INPUT] 0    0    [1    /1   ]  58.5850992529        1
[INPUT] 0    0    [1    /1   ]  24.7196598973        1
[INPUT] 0    0    [1    /1   ]  9.07658194385        1
[INPUT] 1    0    [1    /1   ]  8.60428749108        1
[INPUT] 1    0    [1    /1   ]  0.492751916326       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22895419596919245, 1.0]], [0, [0.5971625626224399, 1.0]], [0, [1.8178705323789779, 1.0]], [0, [117616.81285354456, 1.0]], [0, [4.046211429712983, 1.0]], [0, [1176168.1426132133, 1.0]], [0, [588084.069955527, 1.0]], [0, [294042.03091585776, 1.0]], [0, [147020.99130128004, 1.0]], [0, [73510.41745636397, 1.0]], [0, [36754.70105610854, 1.0]], [0, [7302.291320754029, 1.0]], [0, [18375.77016673847, 1.0]], [0, [1443.7555418669253, 1.0]], [0, [417.40675649482534, 1.0]], [0, [147.73028059720193, 1.0]], [0, [58.58509925288376, 1.0]], [0, [24.719659897336417, 1.0]], [0, [9.076581943853409, 1.0]], [1, [8.604287491084891, 1.0]], [1, [0.4927519163259265, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2289542]
bas 1, expnt(s) = [0.59716256]
bas 2, expnt(s) = [1.81787053]
bas 3, expnt(s) = [117616.81285354]
bas 4, expnt(s) = [4.04621143]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995553]
bas 7, expnt(s) = [294042.03091586]
bas 8, expnt(s) = [147020.99130128]
bas 9, expnt(s) = [73510.41745636]
bas 10, expnt(s) = [36754.70105611]
bas 11, expnt(s) = [7302.29132075]
bas 12, expnt(s) = [18375.77016674]
bas 13, expnt(s) = [1443.75554187]
bas 14, expnt(s) = [417.40675649]
bas 15, expnt(s) = [147.7302806]
bas 16, expnt(s) = [58.58509925]
bas 17, expnt(s) = [24.7196599]
bas 18, expnt(s) = [9.07658194]
bas 19, expnt(s) = [8.60428749]
bas 20, expnt(s) = [0.49275192]
CPU time:      1251.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28954196e-01 8.36231416e-01 5.97162563e-01 1.71626543e+00
 1.81787053e+00 3.95537111e+00 1.17616813e+05 1.60460108e+04
 4.04621143e+00 7.20777886e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229132e+03 1.99576495e+03
 1.83757702e+04 3.98748614e+03 1.44375554e+03 5.91745920e+02
 4.17406756e+02 2.33310686e+02 1.47730281e+02 1.07057517e+02
 5.85850993e+01 5.35001995e+01 2.47196599e+01 2.80089542e+01
 9.07658194e+00 1.32116413e+01 8.60428749e+00 4.29910481e+01
 4.92751916e-01 1.20439736e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336081840962237
cond(S) = 912646.6866003555
E1 = -689.5960603189938  E_coul = 184.97169338021703
init E= -504.624366938777
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672169147705638  LUMO = 0.537991685042777
  mo_energy =
[-1.21709761e+02 -1.33862857e+01 -7.62357988e+00 -7.62357988e+00
 -7.62357988e+00 -1.65758272e+00 -6.72169148e-01 -6.72169148e-01
 -6.72169148e-01  5.37991685e-01  4.84805204e+00  2.14103536e+01
  8.04046926e+01  2.75475818e+02  9.03209043e+02  3.15562114e+03
  1.26349644e+04  4.12314160e+04  1.05259180e+05  2.30432009e+05
  4.56239303e+05  8.45185750e+05  1.52835739e+06  2.85061786e+06
  5.80849625e+06]
E1 = -707.7553456628924  E_coul = 199.78281135139187
cycle= 1 E= -507.972534311501  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.66 sec, wall time      0.03 sec
diis-norm(errvec)=0.759381
diis-c [-0.5766596  1.       ]
  HOMO = -0.217619338768728  LUMO = 0.884177940816443
  mo_energy =
[-1.20200093e+02 -1.23047130e+01 -6.59396337e+00 -6.59396337e+00
 -6.59396337e+00 -1.16331871e+00 -2.17619339e-01 -2.17619339e-01
 -2.17619339e-01  8.84177941e-01  5.47110730e+00  2.23600234e+01
  8.16752033e+01  2.76928265e+02  9.04700602e+02  3.15705349e+03
  1.26362904e+04  4.12326748e+04  1.05260402e+05  2.30433206e+05
  4.56240483e+05  8.45186917e+05  1.52835854e+06  2.85061900e+06
  5.80849738e+06]
E1 = -706.8003178623629  E_coul = 198.80996618047647
cycle= 2 E= -507.990351681886  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348608
diis-c [-0.00121003 -0.00302854  1.00302854]
  HOMO = -0.239800477617054  LUMO = 0.880505074901362
  mo_energy =
[-1.20315116e+02 -1.23725264e+01 -6.66905003e+00 -6.66905003e+00
 -6.66905003e+00 -1.17759071e+00 -2.39800478e-01 -2.39800478e-01
 -2.39800478e-01  8.80505075e-01  5.44303111e+00  2.23028590e+01
  8.15912856e+01  2.76823493e+02  9.04579932e+02  3.15691846e+03
  1.26361451e+04  4.12325257e+04  1.05260251e+05  2.30433055e+05
  4.56240331e+05  8.45186765e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6918513412238  E_coul = 198.70123722500412
cycle= 3 E= -507.99061411622  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382058
diis-c [-3.27251513e-06  1.15569179e-04 -1.07270992e-01  1.10715542e+00]
  HOMO = -0.2429481099703  LUMO = 0.879758265070806
  mo_energy =
[-1.20326831e+02 -1.23810689e+01 -6.67807309e+00 -6.67807309e+00
 -6.67807309e+00 -1.17949802e+00 -2.42948110e-01 -2.42948110e-01
 -2.42948110e-01  8.79758265e-01  5.43886744e+00  2.22954846e+01
  8.15816631e+01  2.76812443e+02  9.04567982e+02  3.15690582e+03
  1.26361320e+04  4.12325124e+04  1.05260238e+05  2.30433041e+05
  4.56240318e+05  8.45186751e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6765583602707  E_coul = 198.6859391795856
cycle= 4 E= -507.990619180685  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173535
diis-c [-5.67566152e-10 -9.47176930e-06  6.86490918e-03 -9.76710584e-02
  1.09081562e+00]
  HOMO = -0.243096559867047  LUMO = 0.879713746361537
  mo_energy =
[-1.20327171e+02 -1.23814047e+01 -6.67840441e+00 -6.67840441e+00
 -6.67840441e+00 -1.17958797e+00 -2.43096560e-01 -2.43096560e-01
 -2.43096560e-01  8.79713746e-01  5.43866491e+00  2.22951850e+01
  8.15813319e+01  2.76812105e+02  9.04567642e+02  3.15690547e+03
  1.26361316e+04  4.12325121e+04  1.05260237e+05  2.30433041e+05
  4.56240317e+05  8.45186751e+05  1.52835838e+06  2.85061883e+06
  5.80849722e+06]
E1 = -706.6758430544684  E_coul = 198.68522385955603
cycle= 5 E= -507.990619194912  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63332e-06
diis-c [-9.43625790e-13  6.11187425e-07 -5.59928067e-04  7.58939946e-03
 -9.09300149e-02  1.08389993e+00]
  HOMO = -0.243099286690565  LUMO = 0.879712977680958
  mo_energy =
[-1.20327177e+02 -1.23814100e+01 -6.67840976e+00 -6.67840976e+00
 -6.67840976e+00 -1.17958984e+00 -2.43099287e-01 -2.43099287e-01
 -2.43099287e-01  8.79712978e-01  5.43866114e+00  2.22951800e+01
  8.15813264e+01  2.76812099e+02  9.04567636e+02  3.15690547e+03
  1.26361316e+04  4.12325121e+04  1.05260237e+05  2.30433041e+05
  4.56240317e+05  8.45186751e+05  1.52835838e+06  2.85061883e+06
  5.80849722e+06]
E1 = -706.6758292471208  E_coul = 198.6852100522011
cycle= 6 E= -507.99061919492  delta_E= -7.28e-12  |g|= 9.13e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758292471208  E_coul = 198.6852100522011
  HOMO = -0.243099329282028  LUMO = 0.87971295269356
  mo_energy =
[-1.20327177e+02 -1.23814101e+01 -6.67840985e+00 -6.67840985e+00
 -6.67840985e+00 -1.17958986e+00 -2.43099329e-01 -2.43099329e-01
 -2.43099329e-01  8.79712953e-01  5.43866108e+00  2.22951799e+01
  8.15813263e+01  2.76812099e+02  9.04567636e+02  3.15690547e+03
  1.26361316e+04  4.12325121e+04  1.05260237e+05  2.30433041e+05
  4.56240317e+05  8.45186751e+05  1.52835838e+06  2.85061883e+06
  5.80849722e+06]
E1 = -706.6758290598219  E_coul = 198.6852098649024
Extra cycle  E= -507.99061919492  delta_E= 1.14e-13  |g|= 1.14e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912646.6866003555
E1 = -706.6758290598219  E_coul = 198.6852098649024
init E= -507.99061919492
    CPU time for initialize scf      5.83 sec, wall time      0.25 sec
  HOMO = -0.243099335378246  LUMO = 0.87971295226851
  mo_energy =
[-1.20327177e+02 -1.23814101e+01 -6.67840986e+00 -6.67840986e+00
 -6.67840986e+00 -1.17958987e+00 -2.43099335e-01 -2.43099335e-01
 -2.43099335e-01  8.79712952e-01  5.43866107e+00  2.22951799e+01
  8.15813263e+01  2.76812099e+02  9.04567636e+02  3.15690547e+03
  1.26361316e+04  4.12325121e+04  1.05260237e+05  2.30433041e+05
  4.56240317e+05  8.45186751e+05  1.52835838e+06  2.85061883e+06
  5.80849722e+06]
E1 = -706.6758290302478  E_coul = 198.68520983532812
cycle= 1 E= -507.99061919492  delta_E= -1.14e-13  |g|= 2.86e-09  |ddm|= 2.99e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.6758290302478  E_coul = 198.68520983532812
  HOMO = -0.243099336309241  LUMO = 0.879712949961892
  mo_energy =
[-1.20327177e+02 -1.23814101e+01 -6.67840987e+00 -6.67840987e+00
 -6.67840987e+00 -1.17958987e+00 -2.43099336e-01 -2.43099336e-01
 -2.43099336e-01  8.79712950e-01  5.43866107e+00  2.22951799e+01
  8.15813263e+01  2.76812099e+02  9.04567636e+02  3.15690547e+03
  1.26361316e+04  4.12325121e+04  1.05260237e+05  2.30433041e+05
  4.56240317e+05  8.45186751e+05  1.52835838e+06  2.85061883e+06
  5.80849722e+06]
E1 = -706.6758290280768  E_coul = 198.6852098331571
Extra cycle  E= -507.99061919492  delta_E= -5.68e-14  |g|= 1.88e-09  |ddm|= 2.53e-09
    CPU time for scf_cycle      6.32 sec, wall time      0.42 sec
exp = [2.28954196e-01 5.97162563e-01 1.81787053e+00 1.17616813e+05
 4.04621143e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229132e+03
 1.83757702e+04 1.44375554e+03 4.17406756e+02 1.47730281e+02
 5.85850993e+01 2.47196599e+01 9.07658194e+00 8.60428749e+00
 4.92751916e-01]
grad_E = [ 1.62693570e-05 -9.22993457e-06 -6.22416677e-07  6.07988118e-09
  3.03404962e-06  4.06385951e-11  1.74732170e-10  9.43006590e-10
  3.72605524e-09  1.55599570e-08  8.11447344e-08  5.11574794e-06
  1.99092289e-07 -3.92207468e-05  3.20756589e-07 -1.88218800e-05
  3.43775280e-06 -4.88495896e-05  8.70068615e-06 -1.31061133e-06
 -1.15530011e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228938105192       1
[INPUT] 0    0    [1    /1   ]  0.597084279769       1
[INPUT] 0    0    [1    /1   ]  1.81783734336        1
[INPUT] 0    0    [1    /1   ]  117616.812854        1
[INPUT] 0    0    [1    /1   ]  4.04675142965        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.417457         1
[INPUT] 0    0    [1    /1   ]  36754.7010593        1
[INPUT] 0    0    [1    /1   ]  7302.29152303        1
[INPUT] 0    0    [1    /1   ]  18375.7701746        1
[INPUT] 0    0    [1    /1   ]  1443.75404654        1
[INPUT] 0    0    [1    /1   ]  417.406179068        1
[INPUT] 0    0    [1    /1   ]  147.731927944        1
[INPUT] 0    0    [1    /1   ]  58.5804308062        1
[INPUT] 0    0    [1    /1   ]  24.7212845957        1
[INPUT] 0    0    [1    /1   ]  9.07709999223        1
[INPUT] 1    0    [1    /1   ]  8.60428572229        1
[INPUT] 1    0    [1    /1   ]  0.492751552607       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2289381051922853, 1.0]], [0, [0.5970842797689824, 1.0]], [0, [1.817837343357001, 1.0]], [0, [117616.81285378493, 1.0]], [0, [4.046751429652528, 1.0]], [0, [1176168.142613215, 1.0]], [0, [588084.0699555338, 1.0]], [0, [294042.03091589507, 1.0]], [0, [147020.99130142733, 1.0]], [0, [73510.41745697903, 1.0]], [0, [36754.70105931786, 1.0]], [0, [7302.291523032795, 1.0]], [0, [18375.770174594727, 1.0]], [0, [1443.7540465362893, 1.0]], [0, [417.4061790678258, 1.0]], [0, [147.7319279444116, 1.0]], [0, [58.580430806184395, 1.0]], [0, [24.72128459565904, 1.0]], [0, [9.077099992229188, 1.0]], [1, [8.60428572229215, 1.0]], [1, [0.4927515526074739, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22893811]
bas 1, expnt(s) = [0.59708428]
bas 2, expnt(s) = [1.81783734]
bas 3, expnt(s) = [117616.81285378]
bas 4, expnt(s) = [4.04675143]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995553]
bas 7, expnt(s) = [294042.0309159]
bas 8, expnt(s) = [147020.99130143]
bas 9, expnt(s) = [73510.41745698]
bas 10, expnt(s) = [36754.70105932]
bas 11, expnt(s) = [7302.29152303]
bas 12, expnt(s) = [18375.77017459]
bas 13, expnt(s) = [1443.75404654]
bas 14, expnt(s) = [417.40617907]
bas 15, expnt(s) = [147.73192794]
bas 16, expnt(s) = [58.58043081]
bas 17, expnt(s) = [24.7212846]
bas 18, expnt(s) = [9.07709999]
bas 19, expnt(s) = [8.60428572]
bas 20, expnt(s) = [0.49275155]
CPU time:      1266.95
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28938105e-01 8.36187339e-01 5.97084280e-01 1.71609668e+00
 1.81783734e+00 3.95531694e+00 1.17616813e+05 1.60460108e+04
 4.04675143e+00 7.20850030e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229152e+03 1.99576499e+03
 1.83757702e+04 3.98748615e+03 1.44375405e+03 5.91745461e+02
 4.17406179e+02 2.33310444e+02 1.47731928e+02 1.07058412e+02
 5.85804308e+01 5.34970021e+01 2.47212846e+01 2.80103348e+01
 9.07709999e+00 1.32122068e+01 8.60428572e+00 4.29910371e+01
 4.92751553e-01 1.20439625e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336082292005717
cond(S) = 912646.6427807711
E1 = -689.5960670910742  E_coul = 184.9716690285862
init E= -504.624398062488
    CPU time for initialize scf      0.89 sec, wall time      0.08 sec
  HOMO = -0.672169855230895  LUMO = 0.537891756718299
  mo_energy =
[-1.21709763e+02 -1.33862878e+01 -7.62358143e+00 -7.62358143e+00
 -7.62358143e+00 -1.65758318e+00 -6.72169855e-01 -6.72169855e-01
 -6.72169855e-01  5.37891757e-01  4.84784003e+00  2.14117071e+01
  8.04088047e+01  2.75476853e+02  9.03206208e+02  3.15561592e+03
  1.26349564e+04  4.12314075e+04  1.05259172e+05  2.30432001e+05
  4.56239295e+05  8.45185742e+05  1.52835738e+06  2.85061785e+06
  5.80849624e+06]
E1 = -707.7553162476776  E_coul = 199.78278165856725
cycle= 1 E= -507.97253458911  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.67 sec, wall time      0.03 sec
diis-norm(errvec)=0.75938
diis-c [-0.57665817  1.        ]
  HOMO = -0.217620155161104  LUMO = 0.88406000082716
  mo_energy =
[-1.20200097e+02 -1.23047156e+01 -6.59396533e+00 -6.59396533e+00
 -6.59396533e+00 -1.16331925e+00 -2.17620155e-01 -2.17620155e-01
 -2.17620155e-01  8.84060001e-01  5.47090376e+00  2.23614049e+01
  8.16793215e+01  2.76929297e+02  9.04697766e+02  3.15704827e+03
  1.26362823e+04  4.12326663e+04  1.05260393e+05  2.30433198e+05
  4.56240475e+05  8.45186909e+05  1.52835854e+06  2.85061899e+06
  5.80849738e+06]
E1 = -706.8002971094714  E_coul = 198.8099453852989
cycle= 2 E= -507.990351724173  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348612
diis-c [-0.00121006 -0.00302839  1.00302839]
  HOMO = -0.239800967718248  LUMO = 0.880387850496719
  mo_energy =
[-1.20315119e+02 -1.23725283e+01 -6.66905134e+00 -6.66905134e+00
 -6.66905134e+00 -1.17759105e+00 -2.39800968e-01 -2.39800968e-01
 -2.39800968e-01  8.80387850e-01  5.44282794e+00  2.23042390e+01
  8.15954039e+01  2.76824526e+02  9.04577097e+02  3.15691325e+03
  1.26361371e+04  4.12325171e+04  1.05260243e+05  2.30433047e+05
  4.56240323e+05  8.45186757e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6918299672645  E_coul = 198.70121580330755
cycle= 3 E= -507.990614163957  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382071
diis-c [-3.27263108e-06  1.15496194e-04 -1.07273828e-01  1.10715833e+00]
  HOMO = -0.242948646215577  LUMO = 0.879641133677823
  mo_energy =
[-1.20326834e+02 -1.23810710e+01 -6.67807448e+00 -6.67807448e+00
 -6.67807448e+00 -1.17949839e+00 -2.42948646e-01 -2.42948646e-01
 -2.42948646e-01  8.79641134e-01  5.43866419e+00  2.22968643e+01
  8.15857813e+01  2.76813476e+02  9.04565147e+02  3.15690060e+03
  1.26361240e+04  4.12325038e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6765363691514  E_coul = 198.68591714020934
cycle= 4 E= -507.990619228942  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173545
diis-c [-5.67879897e-10 -9.47042448e-06  6.86520989e-03 -9.76737566e-02
  1.09081802e+00]
  HOMO = -0.243097106537202  LUMO = 0.879596614144896
  mo_energy =
[-1.20327174e+02 -1.23814068e+01 -6.67840582e+00 -6.67840582e+00
 -6.67840582e+00 -1.17958835e+00 -2.43097107e-01 -2.43097107e-01
 -2.43097107e-01  8.79596614e-01  5.43846165e+00  2.22965647e+01
  8.15854500e+01  2.76813138e+02  9.04564806e+02  3.15690026e+03
  1.26361236e+04  4.12325035e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.675820992803  E_coul = 198.68520174963047
cycle= 5 E= -507.990619243173  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63402e-06
diis-c [-9.42054930e-13  6.11573713e-07 -5.60403521e-04  7.59592138e-03
 -9.09964546e-02  1.08396033e+00]
  HOMO = -0.243099834150562  LUMO = 0.879595845025586
  mo_energy =
[-1.20327180e+02 -1.23814120e+01 -6.67841118e+00 -6.67841118e+00
 -6.67841118e+00 -1.17959022e+00 -2.43099834e-01 -2.43099834e-01
 -2.43099834e-01  8.79595845e-01  5.43845788e+00  2.22965597e+01
  8.15854445e+01  2.76813132e+02  9.04564800e+02  3.15690025e+03
  1.26361236e+04  4.12325035e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6758071786574  E_coul = 198.68518793547761
cycle= 6 E= -507.99061924318  delta_E= -7.16e-12  |g|= 9.13e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758071786574  E_coul = 198.68518793547761
  HOMO = -0.243099876800271  LUMO = 0.879595819254569
  mo_energy =
[-1.20327180e+02 -1.23814121e+01 -6.67841126e+00 -6.67841126e+00
 -6.67841126e+00 -1.17959024e+00 -2.43099877e-01 -2.43099877e-01
 -2.43099877e-01  8.79595819e-01  5.43845781e+00  2.22965596e+01
  8.15854444e+01  2.76813132e+02  9.04564800e+02  3.15690025e+03
  1.26361236e+04  4.12325035e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6758069912304  E_coul = 198.68518774805042
Extra cycle  E= -507.99061924318  delta_E= -2.27e-13  |g|= 1.15e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.76 sec, wall time      0.31 sec
exp = [2.28938105e-01 5.97084280e-01 1.81783734e+00 1.17616813e+05
 4.04675143e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229152e+03
 1.83757702e+04 1.44375405e+03 4.17406179e+02 1.47731928e+02
 5.85804308e+01 2.47212846e+01 9.07709999e+00 8.60428572e+00
 4.92751553e-01]
E = -507.99061924317994
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228938105192       1
[INPUT] 0    0    [1    /1   ]  0.597084279769       1
[INPUT] 0    0    [1    /1   ]  1.81783734336        1
[INPUT] 0    0    [1    /1   ]  117616.812854        1
[INPUT] 0    0    [1    /1   ]  4.04675142965        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.417457         1
[INPUT] 0    0    [1    /1   ]  36754.7010593        1
[INPUT] 0    0    [1    /1   ]  7302.29152303        1
[INPUT] 0    0    [1    /1   ]  18375.7701746        1
[INPUT] 0    0    [1    /1   ]  1443.75404654        1
[INPUT] 0    0    [1    /1   ]  417.406179068        1
[INPUT] 0    0    [1    /1   ]  147.731927944        1
[INPUT] 0    0    [1    /1   ]  58.5804308062        1
[INPUT] 0    0    [1    /1   ]  24.7212845957        1
[INPUT] 0    0    [1    /1   ]  9.07709999223        1
[INPUT] 1    0    [1    /1   ]  8.60428572229        1
[INPUT] 1    0    [1    /1   ]  0.492751552607       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2289381051922853, 1.0]], [0, [0.5970842797689824, 1.0]], [0, [1.817837343357001, 1.0]], [0, [117616.81285378493, 1.0]], [0, [4.046751429652528, 1.0]], [0, [1176168.142613215, 1.0]], [0, [588084.0699555338, 1.0]], [0, [294042.03091589507, 1.0]], [0, [147020.99130142733, 1.0]], [0, [73510.41745697903, 1.0]], [0, [36754.70105931786, 1.0]], [0, [7302.291523032795, 1.0]], [0, [18375.770174594727, 1.0]], [0, [1443.7540465362893, 1.0]], [0, [417.4061790678258, 1.0]], [0, [147.7319279444116, 1.0]], [0, [58.580430806184395, 1.0]], [0, [24.72128459565904, 1.0]], [0, [9.077099992229188, 1.0]], [1, [8.60428572229215, 1.0]], [1, [0.4927515526074739, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22893811]
bas 1, expnt(s) = [0.59708428]
bas 2, expnt(s) = [1.81783734]
bas 3, expnt(s) = [117616.81285378]
bas 4, expnt(s) = [4.04675143]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995553]
bas 7, expnt(s) = [294042.0309159]
bas 8, expnt(s) = [147020.99130143]
bas 9, expnt(s) = [73510.41745698]
bas 10, expnt(s) = [36754.70105932]
bas 11, expnt(s) = [7302.29152303]
bas 12, expnt(s) = [18375.77017459]
bas 13, expnt(s) = [1443.75404654]
bas 14, expnt(s) = [417.40617907]
bas 15, expnt(s) = [147.73192794]
bas 16, expnt(s) = [58.58043081]
bas 17, expnt(s) = [24.7212846]
bas 18, expnt(s) = [9.07709999]
bas 19, expnt(s) = [8.60428572]
bas 20, expnt(s) = [0.49275155]
CPU time:      1269.23
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28938105e-01 8.36187339e-01 5.97084280e-01 1.71609668e+00
 1.81783734e+00 3.95531694e+00 1.17616813e+05 1.60460108e+04
 4.04675143e+00 7.20850030e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229152e+03 1.99576499e+03
 1.83757702e+04 3.98748615e+03 1.44375405e+03 5.91745461e+02
 4.17406179e+02 2.33310444e+02 1.47731928e+02 1.07058412e+02
 5.85804308e+01 5.34970021e+01 2.47212846e+01 2.80103348e+01
 9.07709999e+00 1.32122068e+01 8.60428572e+00 4.29910371e+01
 4.92751553e-01 1.20439625e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336082292005717
cond(S) = 912646.6427807711
E1 = -689.5960670910742  E_coul = 184.9716690285862
init E= -504.624398062488
    CPU time for initialize scf      0.88 sec, wall time      0.08 sec
  HOMO = -0.672169855230895  LUMO = 0.537891756718299
  mo_energy =
[-1.21709763e+02 -1.33862878e+01 -7.62358143e+00 -7.62358143e+00
 -7.62358143e+00 -1.65758318e+00 -6.72169855e-01 -6.72169855e-01
 -6.72169855e-01  5.37891757e-01  4.84784003e+00  2.14117071e+01
  8.04088047e+01  2.75476853e+02  9.03206208e+02  3.15561592e+03
  1.26349564e+04  4.12314075e+04  1.05259172e+05  2.30432001e+05
  4.56239295e+05  8.45185742e+05  1.52835738e+06  2.85061785e+06
  5.80849624e+06]
E1 = -707.7553162476776  E_coul = 199.78278165856725
cycle= 1 E= -507.97253458911  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.56 sec, wall time      0.03 sec
diis-norm(errvec)=0.75938
diis-c [-0.57665817  1.        ]
  HOMO = -0.217620155161104  LUMO = 0.88406000082716
  mo_energy =
[-1.20200097e+02 -1.23047156e+01 -6.59396533e+00 -6.59396533e+00
 -6.59396533e+00 -1.16331925e+00 -2.17620155e-01 -2.17620155e-01
 -2.17620155e-01  8.84060001e-01  5.47090376e+00  2.23614049e+01
  8.16793215e+01  2.76929297e+02  9.04697766e+02  3.15704827e+03
  1.26362823e+04  4.12326663e+04  1.05260393e+05  2.30433198e+05
  4.56240475e+05  8.45186909e+05  1.52835854e+06  2.85061899e+06
  5.80849738e+06]
E1 = -706.8002971094714  E_coul = 198.8099453852989
cycle= 2 E= -507.990351724173  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348612
diis-c [-0.00121006 -0.00302839  1.00302839]
  HOMO = -0.239800967718248  LUMO = 0.880387850496719
  mo_energy =
[-1.20315119e+02 -1.23725283e+01 -6.66905134e+00 -6.66905134e+00
 -6.66905134e+00 -1.17759105e+00 -2.39800968e-01 -2.39800968e-01
 -2.39800968e-01  8.80387850e-01  5.44282794e+00  2.23042390e+01
  8.15954039e+01  2.76824526e+02  9.04577097e+02  3.15691325e+03
  1.26361371e+04  4.12325171e+04  1.05260243e+05  2.30433047e+05
  4.56240323e+05  8.45186757e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6918299672645  E_coul = 198.70121580330755
cycle= 3 E= -507.990614163957  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382071
diis-c [-3.27263108e-06  1.15496194e-04 -1.07273828e-01  1.10715833e+00]
  HOMO = -0.242948646215577  LUMO = 0.879641133677823
  mo_energy =
[-1.20326834e+02 -1.23810710e+01 -6.67807448e+00 -6.67807448e+00
 -6.67807448e+00 -1.17949839e+00 -2.42948646e-01 -2.42948646e-01
 -2.42948646e-01  8.79641134e-01  5.43866419e+00  2.22968643e+01
  8.15857813e+01  2.76813476e+02  9.04565147e+02  3.15690060e+03
  1.26361240e+04  4.12325038e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6765363691514  E_coul = 198.68591714020934
cycle= 4 E= -507.990619228942  delta_E= -5.06e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173545
diis-c [-5.67879897e-10 -9.47042448e-06  6.86520989e-03 -9.76737566e-02
  1.09081802e+00]
  HOMO = -0.243097106537202  LUMO = 0.879596614144896
  mo_energy =
[-1.20327174e+02 -1.23814068e+01 -6.67840582e+00 -6.67840582e+00
 -6.67840582e+00 -1.17958835e+00 -2.43097107e-01 -2.43097107e-01
 -2.43097107e-01  8.79596614e-01  5.43846165e+00  2.22965647e+01
  8.15854500e+01  2.76813138e+02  9.04564806e+02  3.15690026e+03
  1.26361236e+04  4.12325035e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.675820992803  E_coul = 198.68520174963047
cycle= 5 E= -507.990619243173  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63402e-06
diis-c [-9.42054930e-13  6.11573713e-07 -5.60403521e-04  7.59592138e-03
 -9.09964546e-02  1.08396033e+00]
  HOMO = -0.243099834150562  LUMO = 0.879595845025586
  mo_energy =
[-1.20327180e+02 -1.23814120e+01 -6.67841118e+00 -6.67841118e+00
 -6.67841118e+00 -1.17959022e+00 -2.43099834e-01 -2.43099834e-01
 -2.43099834e-01  8.79595845e-01  5.43845788e+00  2.22965597e+01
  8.15854445e+01  2.76813132e+02  9.04564800e+02  3.15690025e+03
  1.26361236e+04  4.12325035e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6758071786574  E_coul = 198.68518793547761
cycle= 6 E= -507.99061924318  delta_E= -7.16e-12  |g|= 9.13e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758071786574  E_coul = 198.68518793547761
  HOMO = -0.243099876800271  LUMO = 0.879595819254569
  mo_energy =
[-1.20327180e+02 -1.23814121e+01 -6.67841126e+00 -6.67841126e+00
 -6.67841126e+00 -1.17959024e+00 -2.43099877e-01 -2.43099877e-01
 -2.43099877e-01  8.79595819e-01  5.43845781e+00  2.22965596e+01
  8.15854444e+01  2.76813132e+02  9.04564800e+02  3.15690025e+03
  1.26361236e+04  4.12325035e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6758069912304  E_coul = 198.68518774805042
Extra cycle  E= -507.99061924318  delta_E= -2.27e-13  |g|= 1.15e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      1.63 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912646.6427807711
E1 = -706.6758069912304  E_coul = 198.68518774805042
init E= -507.99061924318
    CPU time for initialize scf      5.92 sec, wall time      0.25 sec
  HOMO = -0.243099882891718  LUMO = 0.879595818339518
  mo_energy =
[-1.20327180e+02 -1.23814121e+01 -6.67841128e+00 -6.67841128e+00
 -6.67841128e+00 -1.17959024e+00 -2.43099883e-01 -2.43099883e-01
 -2.43099883e-01  8.79595818e-01  5.43845780e+00  2.22965596e+01
  8.15854444e+01  2.76813132e+02  9.04564800e+02  3.15690025e+03
  1.26361236e+04  4.12325035e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6758069616691  E_coul = 198.6851877184892
cycle= 1 E= -507.99061924318  delta_E= 5.68e-14  |g|= 1.78e-09  |ddm|= 2.98e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6758069616691  E_coul = 198.6851877184892
  HOMO = -0.243099883817661  LUMO = 0.879595815817862
  mo_energy =
[-1.20327180e+02 -1.23814121e+01 -6.67841128e+00 -6.67841128e+00
 -6.67841128e+00 -1.17959024e+00 -2.43099884e-01 -2.43099884e-01
 -2.43099884e-01  8.79595816e-01  5.43845780e+00  2.22965596e+01
  8.15854444e+01  2.76813132e+02  9.04564800e+02  3.15690025e+03
  1.26361236e+04  4.12325035e+04  1.05260229e+05  2.30433033e+05
  4.56240310e+05  8.45186743e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.675806962228  E_coul = 198.68518771904775
Extra cycle  E= -507.99061924318  delta_E= -3.41e-13  |g|= 2.39e-09  |ddm|= 4.68e-10
    CPU time for scf_cycle      6.43 sec, wall time      0.43 sec
exp = [2.28938105e-01 5.97084280e-01 1.81783734e+00 1.17616813e+05
 4.04675143e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229152e+03
 1.83757702e+04 1.44375405e+03 4.17406179e+02 1.47731928e+02
 5.85804308e+01 2.47212846e+01 9.07709999e+00 8.60428572e+00
 4.92751553e-01]
grad_E = [ 5.01267804e-05 -2.83638234e-05 -2.98648057e-06  6.07869564e-09
  5.73795810e-06  4.06252823e-11  1.74693294e-10  9.42824760e-10
  3.72532099e-09  1.55568507e-08  8.11297295e-08  5.11477346e-06
  1.99043327e-07 -3.91772768e-05 -6.15003895e-08 -1.72644418e-05
  2.34741759e-07 -4.64053428e-05  8.52871746e-06 -2.25977252e-06
 -2.49686282e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228912655612       1
[INPUT] 0    0    [1    /1   ]  0.596964307945       1
[INPUT] 0    0    [1    /1   ]  1.81788887333        1
[INPUT] 0    0    [1    /1   ]  117616.812854        1
[INPUT] 0    0    [1    /1   ]  4.04766342393        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991302        1
[INPUT] 0    0    [1    /1   ]  73510.4174574        1
[INPUT] 0    0    [1    /1   ]  36754.7010616        1
[INPUT] 0    0    [1    /1   ]  7302.29166885        1
[INPUT] 0    0    [1    /1   ]  18375.7701802        1
[INPUT] 0    0    [1    /1   ]  1443.7530016         1
[INPUT] 0    0    [1    /1   ]  417.405410996        1
[INPUT] 0    0    [1    /1   ]  147.734546618        1
[INPUT] 0    0    [1    /1   ]  58.5741496876        1
[INPUT] 0    0    [1    /1   ]  24.724614562         1
[INPUT] 0    0    [1    /1   ]  9.07791185738        1
[INPUT] 1    0    [1    /1   ]  8.60428266854        1
[INPUT] 1    0    [1    /1   ]  0.492750966955       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2289126556123256, 1.0]], [0, [0.5969643079446536, 1.0]], [0, [1.8178888733339977, 1.0]], [0, [117616.81285395818, 1.0]], [0, [4.0476634239266955, 1.0]], [0, [1176168.142613216, 1.0]], [0, [588084.0699555388, 1.0]], [0, [294042.03091592196, 1.0]], [0, [147020.9913015335, 1.0]], [0, [73510.41745742231, 1.0]], [0, [36754.70106163188, 1.0]], [0, [7302.291668852135, 1.0]], [0, [18375.77018024862, 1.0]], [0, [1443.7530016037501, 1.0]], [0, [417.4054109964251, 1.0]], [0, [147.7345466176871, 1.0]], [0, [58.574149687628896, 1.0]], [0, [24.724614561958884, 1.0]], [0, [9.07791185737769, 1.0]], [1, [8.604282668543325, 1.0]], [1, [0.49275096695486725, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22891266]
bas 1, expnt(s) = [0.59696431]
bas 2, expnt(s) = [1.81788887]
bas 3, expnt(s) = [117616.81285396]
bas 4, expnt(s) = [4.04766342]
bas 5, expnt(s) = [1176168.14261322]
bas 6, expnt(s) = [588084.06995554]
bas 7, expnt(s) = [294042.03091592]
bas 8, expnt(s) = [147020.99130153]
bas 9, expnt(s) = [73510.41745742]
bas 10, expnt(s) = [36754.70106163]
bas 11, expnt(s) = [7302.29166885]
bas 12, expnt(s) = [18375.77018025]
bas 13, expnt(s) = [1443.7530016]
bas 14, expnt(s) = [417.405411]
bas 15, expnt(s) = [147.73454662]
bas 16, expnt(s) = [58.57414969]
bas 17, expnt(s) = [24.72461456]
bas 18, expnt(s) = [9.07791186]
bas 19, expnt(s) = [8.60428267]
bas 20, expnt(s) = [0.49275097]
CPU time:      1284.49
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28912656e-01 8.36117622e-01 5.96964308e-01 1.71583807e+00
 1.81788887e+00 3.95540104e+00 1.17616813e+05 1.60460108e+04
 4.04766342e+00 7.20971867e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229167e+03 1.99576502e+03
 1.83757702e+04 3.98748615e+03 1.44375300e+03 5.91745139e+02
 4.17405411e+02 2.33310122e+02 1.47734547e+02 1.07059836e+02
 5.85741497e+01 5.34927000e+01 2.47246146e+01 2.80131645e+01
 9.07791186e+00 1.32130931e+01 8.60428267e+00 4.29910180e+01
 4.92750967e-01 1.20439446e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608302960289
cond(S) = 912646.7254231701
E1 = -689.596073601567  E_coul = 184.97162895302495
init E= -504.624444648542
    CPU time for initialize scf      8.23 sec, wall time      0.40 sec
  HOMO = -0.672170977389148  LUMO = 0.537740891732972
  mo_energy =
[-1.21709768e+02 -1.33862913e+01 -7.62358398e+00 -7.62358398e+00
 -7.62358398e+00 -1.65758391e+00 -6.72170977e-01 -6.72170977e-01
 -6.72170977e-01  5.37740892e-01  4.84769512e+00  2.14144683e+01
  8.04173706e+01  2.75483773e+02  9.03209238e+02  3.15561677e+03
  1.26349546e+04  4.12314050e+04  1.05259169e+05  2.30431998e+05
  4.56239293e+05  8.45185740e+05  1.52835738e+06  2.85061785e+06
  5.80849624e+06]
E1 = -707.7552673122173  E_coul = 199.78273225220758
cycle= 1 E= -507.97253506001  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.75938
diis-c [-0.5766576  1.       ]
  HOMO = -0.217621489725924  LUMO = 0.883883217571834
  mo_energy =
[-1.20200102e+02 -1.23047198e+01 -6.59396860e+00 -6.59396860e+00
 -6.59396860e+00 -1.16332014e+00 -2.17621490e-01 -2.17621490e-01
 -2.17621490e-01  8.83883218e-01  5.47078223e+00  2.23642161e+01
  8.16879020e+01  2.76936213e+02  9.04700795e+02  3.15704912e+03
  1.26362805e+04  4.12326638e+04  1.05260391e+05  2.30433196e+05
  4.56240473e+05  8.45186907e+05  1.52835853e+06  2.85061899e+06
  5.80849737e+06]
E1 = -706.8002614077182  E_coul = 198.8099095753659
cycle= 2 E= -507.990351832352  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348614
diis-c [-0.00121007 -0.00302772  1.00302772]
  HOMO = -0.23980180195865  LUMO = 0.880212062497778
  mo_energy =
[-1.20315123e+02 -1.23725316e+01 -6.66905358e+00 -6.66905358e+00
 -6.66905358e+00 -1.17759162e+00 -2.39801802e-01 -2.39801802e-01
 -2.39801802e-01  8.80212062e-01  5.44270611e+00  2.23070473e+01
  8.16039840e+01  2.76831443e+02  9.04580127e+02  3.15691409e+03
  1.26361353e+04  4.12325147e+04  1.05260240e+05  2.30433044e+05
  4.56240321e+05  8.45186755e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6917931967621  E_coul = 198.7011789156236
cycle= 3 E= -507.990614281139  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382084
diis-c [-3.27274124e-06  1.15391413e-04 -1.07277698e-01  1.10716231e+00]
  HOMO = -0.242949563575845  LUMO = 0.879465463995067
  mo_energy =
[-1.20326839e+02 -1.23810744e+01 -6.67807689e+00 -6.67807689e+00
 -6.67807689e+00 -1.17949902e+00 -2.42949564e-01 -2.42949564e-01
 -2.42949564e-01  8.79465464e-01  5.43854210e+00  2.22996721e+01
  8.15943611e+01  2.76820393e+02  9.04568177e+02  3.15690145e+03
  1.26361222e+04  4.12325014e+04  1.05260227e+05  2.30433031e+05
  4.56240308e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6764985915535  E_coul = 198.68587924459507
cycle= 4 E= -507.990619346958  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173563
diis-c [-5.68299953e-10 -9.47283816e-06  6.86596596e-03 -9.76816252e-02
  1.09082513e+00]
  HOMO = -0.243098043410282  LUMO = 0.87942094663383
  mo_energy =
[-1.20327179e+02 -1.23814102e+01 -6.67840826e+00 -6.67840826e+00
 -6.67840826e+00 -1.17958899e+00 -2.43098043e-01 -2.43098043e-01
 -2.43098043e-01  8.79420947e-01  5.43833953e+00  2.22993724e+01
  8.15940299e+01  2.76820056e+02  9.04567836e+02  3.15690110e+03
  1.26361218e+04  4.12325010e+04  1.05260226e+05  2.30433031e+05
  4.56240307e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6757830777367  E_coul = 198.6851637165411
cycle= 5 E= -507.990619361196  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63524e-06
diis-c [-9.42533519e-13  6.14354444e-07 -5.60395887e-04  7.59523165e-03
 -9.09876510e-02  1.08395220e+00]
  HOMO = -0.243100772113644  LUMO = 0.879420176310213
  mo_energy =
[-1.20327185e+02 -1.23814155e+01 -6.67841362e+00 -6.67841362e+00
 -6.67841362e+00 -1.17959087e+00 -2.43100772e-01 -2.43100772e-01
 -2.43100772e-01  8.79420176e-01  5.43833576e+00  2.22993675e+01
  8.15940243e+01  2.76820050e+02  9.04567830e+02  3.15690110e+03
  1.26361218e+04  4.12325010e+04  1.05260226e+05  2.30433031e+05
  4.56240307e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6757692621925  E_coul = 198.68514990098916
cycle= 6 E= -507.990619361203  delta_E= -7.73e-12  |g|= 9.18e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757692621925  E_coul = 198.68514990098916
  HOMO = -0.243100814647162  LUMO = 0.879420149589833
  mo_energy =
[-1.20327185e+02 -1.23814156e+01 -6.67841371e+00 -6.67841371e+00
 -6.67841371e+00 -1.17959088e+00 -2.43100815e-01 -2.43100815e-01
 -2.43100815e-01  8.79420150e-01  5.43833569e+00  2.22993674e+01
  8.15940242e+01  2.76820050e+02  9.04567830e+02  3.15690110e+03
  1.26361218e+04  4.12325010e+04  1.05260226e+05  2.30433031e+05
  4.56240307e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6757690765031  E_coul = 198.6851497152999
Extra cycle  E= -507.990619361203  delta_E= 1.14e-13  |g|= 1.25e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      8.48 sec, wall time      0.64 sec
exp = [2.28912656e-01 5.96964308e-01 1.81788887e+00 1.17616813e+05
 4.04766342e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229167e+03
 1.83757702e+04 1.44375300e+03 4.17405411e+02 1.47734547e+02
 5.85741497e+01 2.47246146e+01 9.07791186e+00 8.60428267e+00
 4.92750967e-01]
E = -507.99061936120324
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228912655612       1
[INPUT] 0    0    [1    /1   ]  0.596964307945       1
[INPUT] 0    0    [1    /1   ]  1.81788887333        1
[INPUT] 0    0    [1    /1   ]  117616.812854        1
[INPUT] 0    0    [1    /1   ]  4.04766342393        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991302        1
[INPUT] 0    0    [1    /1   ]  73510.4174574        1
[INPUT] 0    0    [1    /1   ]  36754.7010616        1
[INPUT] 0    0    [1    /1   ]  7302.29166885        1
[INPUT] 0    0    [1    /1   ]  18375.7701802        1
[INPUT] 0    0    [1    /1   ]  1443.7530016         1
[INPUT] 0    0    [1    /1   ]  417.405410996        1
[INPUT] 0    0    [1    /1   ]  147.734546618        1
[INPUT] 0    0    [1    /1   ]  58.5741496876        1
[INPUT] 0    0    [1    /1   ]  24.724614562         1
[INPUT] 0    0    [1    /1   ]  9.07791185738        1
[INPUT] 1    0    [1    /1   ]  8.60428266854        1
[INPUT] 1    0    [1    /1   ]  0.492750966955       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2289126556123256, 1.0]], [0, [0.5969643079446536, 1.0]], [0, [1.8178888733339977, 1.0]], [0, [117616.81285395818, 1.0]], [0, [4.0476634239266955, 1.0]], [0, [1176168.142613216, 1.0]], [0, [588084.0699555388, 1.0]], [0, [294042.03091592196, 1.0]], [0, [147020.9913015335, 1.0]], [0, [73510.41745742231, 1.0]], [0, [36754.70106163188, 1.0]], [0, [7302.291668852135, 1.0]], [0, [18375.77018024862, 1.0]], [0, [1443.7530016037501, 1.0]], [0, [417.4054109964251, 1.0]], [0, [147.7345466176871, 1.0]], [0, [58.574149687628896, 1.0]], [0, [24.724614561958884, 1.0]], [0, [9.07791185737769, 1.0]], [1, [8.604282668543325, 1.0]], [1, [0.49275096695486725, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22891266]
bas 1, expnt(s) = [0.59696431]
bas 2, expnt(s) = [1.81788887]
bas 3, expnt(s) = [117616.81285396]
bas 4, expnt(s) = [4.04766342]
bas 5, expnt(s) = [1176168.14261322]
bas 6, expnt(s) = [588084.06995554]
bas 7, expnt(s) = [294042.03091592]
bas 8, expnt(s) = [147020.99130153]
bas 9, expnt(s) = [73510.41745742]
bas 10, expnt(s) = [36754.70106163]
bas 11, expnt(s) = [7302.29166885]
bas 12, expnt(s) = [18375.77018025]
bas 13, expnt(s) = [1443.7530016]
bas 14, expnt(s) = [417.405411]
bas 15, expnt(s) = [147.73454662]
bas 16, expnt(s) = [58.57414969]
bas 17, expnt(s) = [24.72461456]
bas 18, expnt(s) = [9.07791186]
bas 19, expnt(s) = [8.60428267]
bas 20, expnt(s) = [0.49275097]
CPU time:      1293.56
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28912656e-01 8.36117622e-01 5.96964308e-01 1.71583807e+00
 1.81788887e+00 3.95540104e+00 1.17616813e+05 1.60460108e+04
 4.04766342e+00 7.20971867e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229167e+03 1.99576502e+03
 1.83757702e+04 3.98748615e+03 1.44375300e+03 5.91745139e+02
 4.17405411e+02 2.33310122e+02 1.47734547e+02 1.07059836e+02
 5.85741497e+01 5.34927000e+01 2.47246146e+01 2.80131645e+01
 9.07791186e+00 1.32130931e+01 8.60428267e+00 4.29910180e+01
 4.92750967e-01 1.20439446e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608302960289
cond(S) = 912646.7254231701
E1 = -689.596073601567  E_coul = 184.97162895302495
init E= -504.624444648542
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672170977389148  LUMO = 0.537740891732972
  mo_energy =
[-1.21709768e+02 -1.33862913e+01 -7.62358398e+00 -7.62358398e+00
 -7.62358398e+00 -1.65758391e+00 -6.72170977e-01 -6.72170977e-01
 -6.72170977e-01  5.37740892e-01  4.84769512e+00  2.14144683e+01
  8.04173706e+01  2.75483773e+02  9.03209238e+02  3.15561677e+03
  1.26349546e+04  4.12314050e+04  1.05259169e+05  2.30431998e+05
  4.56239293e+05  8.45185740e+05  1.52835738e+06  2.85061785e+06
  5.80849624e+06]
E1 = -707.7552673122173  E_coul = 199.78273225220758
cycle= 1 E= -507.97253506001  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.66 sec, wall time      0.03 sec
diis-norm(errvec)=0.75938
diis-c [-0.5766576  1.       ]
  HOMO = -0.217621489725924  LUMO = 0.883883217571834
  mo_energy =
[-1.20200102e+02 -1.23047198e+01 -6.59396860e+00 -6.59396860e+00
 -6.59396860e+00 -1.16332014e+00 -2.17621490e-01 -2.17621490e-01
 -2.17621490e-01  8.83883218e-01  5.47078223e+00  2.23642161e+01
  8.16879020e+01  2.76936213e+02  9.04700795e+02  3.15704912e+03
  1.26362805e+04  4.12326638e+04  1.05260391e+05  2.30433196e+05
  4.56240473e+05  8.45186907e+05  1.52835853e+06  2.85061899e+06
  5.80849737e+06]
E1 = -706.8002614077182  E_coul = 198.8099095753659
cycle= 2 E= -507.990351832352  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348614
diis-c [-0.00121007 -0.00302772  1.00302772]
  HOMO = -0.23980180195865  LUMO = 0.880212062497778
  mo_energy =
[-1.20315123e+02 -1.23725316e+01 -6.66905358e+00 -6.66905358e+00
 -6.66905358e+00 -1.17759162e+00 -2.39801802e-01 -2.39801802e-01
 -2.39801802e-01  8.80212062e-01  5.44270611e+00  2.23070473e+01
  8.16039840e+01  2.76831443e+02  9.04580127e+02  3.15691409e+03
  1.26361353e+04  4.12325147e+04  1.05260240e+05  2.30433044e+05
  4.56240321e+05  8.45186755e+05  1.52835838e+06  2.85061884e+06
  5.80849722e+06]
E1 = -706.6917931967621  E_coul = 198.7011789156236
cycle= 3 E= -507.990614281139  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382084
diis-c [-3.27274124e-06  1.15391413e-04 -1.07277698e-01  1.10716231e+00]
  HOMO = -0.242949563575845  LUMO = 0.879465463995067
  mo_energy =
[-1.20326839e+02 -1.23810744e+01 -6.67807689e+00 -6.67807689e+00
 -6.67807689e+00 -1.17949902e+00 -2.42949564e-01 -2.42949564e-01
 -2.42949564e-01  8.79465464e-01  5.43854210e+00  2.22996721e+01
  8.15943611e+01  2.76820393e+02  9.04568177e+02  3.15690145e+03
  1.26361222e+04  4.12325014e+04  1.05260227e+05  2.30433031e+05
  4.56240308e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6764985915535  E_coul = 198.68587924459507
cycle= 4 E= -507.990619346958  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173563
diis-c [-5.68299953e-10 -9.47283816e-06  6.86596596e-03 -9.76816252e-02
  1.09082513e+00]
  HOMO = -0.243098043410282  LUMO = 0.87942094663383
  mo_energy =
[-1.20327179e+02 -1.23814102e+01 -6.67840826e+00 -6.67840826e+00
 -6.67840826e+00 -1.17958899e+00 -2.43098043e-01 -2.43098043e-01
 -2.43098043e-01  8.79420947e-01  5.43833953e+00  2.22993724e+01
  8.15940299e+01  2.76820056e+02  9.04567836e+02  3.15690110e+03
  1.26361218e+04  4.12325010e+04  1.05260226e+05  2.30433031e+05
  4.56240307e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6757830777367  E_coul = 198.6851637165411
cycle= 5 E= -507.990619361196  delta_E= -1.42e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63524e-06
diis-c [-9.42533519e-13  6.14354444e-07 -5.60395887e-04  7.59523165e-03
 -9.09876510e-02  1.08395220e+00]
  HOMO = -0.243100772113644  LUMO = 0.879420176310213
  mo_energy =
[-1.20327185e+02 -1.23814155e+01 -6.67841362e+00 -6.67841362e+00
 -6.67841362e+00 -1.17959087e+00 -2.43100772e-01 -2.43100772e-01
 -2.43100772e-01  8.79420176e-01  5.43833576e+00  2.22993675e+01
  8.15940243e+01  2.76820050e+02  9.04567830e+02  3.15690110e+03
  1.26361218e+04  4.12325010e+04  1.05260226e+05  2.30433031e+05
  4.56240307e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6757692621925  E_coul = 198.68514990098916
cycle= 6 E= -507.990619361203  delta_E= -7.73e-12  |g|= 9.18e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757692621925  E_coul = 198.68514990098916
  HOMO = -0.243100814647162  LUMO = 0.879420149589833
  mo_energy =
[-1.20327185e+02 -1.23814156e+01 -6.67841371e+00 -6.67841371e+00
 -6.67841371e+00 -1.17959088e+00 -2.43100815e-01 -2.43100815e-01
 -2.43100815e-01  8.79420150e-01  5.43833569e+00  2.22993674e+01
  8.15940242e+01  2.76820050e+02  9.04567830e+02  3.15690110e+03
  1.26361218e+04  4.12325010e+04  1.05260226e+05  2.30433031e+05
  4.56240307e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6757690765031  E_coul = 198.6851497152999
Extra cycle  E= -507.990619361203  delta_E= 1.14e-13  |g|= 1.25e-08  |ddm|= 2.21e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912646.7254231701
E1 = -706.6757690765031  E_coul = 198.6851497152999
init E= -507.990619361203
    CPU time for initialize scf      5.92 sec, wall time      0.25 sec
  HOMO = -0.243100820678104  LUMO = 0.879420149381675
  mo_energy =
[-1.20327185e+02 -1.23814156e+01 -6.67841372e+00 -6.67841372e+00
 -6.67841372e+00 -1.17959089e+00 -2.43100821e-01 -2.43100821e-01
 -2.43100821e-01  8.79420149e-01  5.43833568e+00  2.22993674e+01
  8.15940242e+01  2.76820050e+02  9.04567830e+02  3.15690110e+03
  1.26361218e+04  4.12325010e+04  1.05260226e+05  2.30433031e+05
  4.56240307e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6757690451946  E_coul = 198.68514968399114
cycle= 1 E= -507.990619361203  delta_E= -1.71e-13  |g|= 2.27e-09  |ddm|= 3.22e-08
    CPU time for cycle= 1      0.33 sec, wall time      0.03 sec
E1 = -706.6757690451946  E_coul = 198.68514968399114
  HOMO = -0.243100821660718  LUMO = 0.879420151310713
  mo_energy =
[-1.20327185e+02 -1.23814156e+01 -6.67841372e+00 -6.67841372e+00
 -6.67841372e+00 -1.17959089e+00 -2.43100822e-01 -2.43100822e-01
 -2.43100822e-01  8.79420151e-01  5.43833568e+00  2.22993674e+01
  8.15940242e+01  2.76820050e+02  9.04567830e+02  3.15690110e+03
  1.26361218e+04  4.12325010e+04  1.05260226e+05  2.30433031e+05
  4.56240307e+05  8.45186741e+05  1.52835837e+06  2.85061883e+06
  5.80849721e+06]
E1 = -706.6757690343707  E_coul = 198.68514967316761
Extra cycle  E= -507.990619361203  delta_E= 3.98e-13  |g|= 2.35e-09  |ddm|= 8.49e-09
    CPU time for scf_cycle      6.40 sec, wall time      0.42 sec
exp = [2.28912656e-01 5.96964308e-01 1.81788887e+00 1.17616813e+05
 4.04766342e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229167e+03
 1.83757702e+04 1.44375300e+03 4.17405411e+02 1.47734547e+02
 5.85741497e+01 2.47246146e+01 9.07791186e+00 8.60428267e+00
 4.92750967e-01]
grad_E = [ 1.00375126e-04 -5.74233782e-05 -6.55361426e-06  6.07688752e-09
  9.91450590e-06  4.06049774e-11  1.74634002e-10  9.42547441e-10
  3.72420115e-09  1.55521130e-08  8.11068480e-08  5.11329235e-06
  1.98968642e-07 -3.91121657e-05 -6.29829286e-07 -1.49463973e-05
 -4.57292113e-06 -4.26900915e-05  8.21607464e-06 -3.97959239e-06
 -4.64248736e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228875717577       1
[INPUT] 0    0    [1    /1   ]  0.59678004668        1
[INPUT] 0    0    [1    /1   ]  1.8182098117         1
[INPUT] 0    0    [1    /1   ]  117616.812854        1
[INPUT] 0    0    [1    /1   ]  4.04945285904        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174569        1
[INPUT] 0    0    [1    /1   ]  36754.7010587        1
[INPUT] 0    0    [1    /1   ]  7302.29148653        1
[INPUT] 0    0    [1    /1   ]  18375.7701731        1
[INPUT] 0    0    [1    /1   ]  1443.75449222        1
[INPUT] 0    0    [1    /1   ]  417.404410172        1
[INPUT] 0    0    [1    /1   ]  147.739252292        1
[INPUT] 0    0    [1    /1   ]  58.5657305444        1
[INPUT] 0    0    [1    /1   ]  24.7325021606        1
[INPUT] 0    0    [1    /1   ]  9.07947450048        1
[INPUT] 1    0    [1    /1   ]  8.6042774006         1
[INPUT] 1    0    [1    /1   ]  0.492749959285       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22887571757707292, 1.0]], [0, [0.5967800466800021, 1.0]], [0, [1.8182098117044265, 1.0]], [0, [117616.81285374144, 1.0]], [0, [4.049452859039517, 1.0]], [0, [1176168.1426132147, 1.0]], [0, [588084.0699555326, 1.0]], [0, [294042.0309158884, 1.0]], [0, [147020.99130140065, 1.0]], [0, [73510.41745686745, 1.0]], [0, [36754.701058741215, 1.0]], [0, [7302.291486526681, 1.0]], [0, [18375.770173126006, 1.0]], [0, [1443.754492221432, 1.0]], [0, [417.40441017188346, 1.0]], [0, [147.73925229159957, 1.0]], [0, [58.56573054440036, 1.0]], [0, [24.732502160566813, 1.0]], [0, [9.079474500482393, 1.0]], [1, [8.604277400596365, 1.0]], [1, [0.4927499592849908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22887572]
bas 1, expnt(s) = [0.59678005]
bas 2, expnt(s) = [1.81820981]
bas 3, expnt(s) = [117616.81285374]
bas 4, expnt(s) = [4.04945286]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995553]
bas 7, expnt(s) = [294042.03091589]
bas 8, expnt(s) = [147020.9913014]
bas 9, expnt(s) = [73510.41745687]
bas 10, expnt(s) = [36754.70105874]
bas 11, expnt(s) = [7302.29148653]
bas 12, expnt(s) = [18375.77017313]
bas 13, expnt(s) = [1443.75449222]
bas 14, expnt(s) = [417.40441017]
bas 15, expnt(s) = [147.73925229]
bas 16, expnt(s) = [58.56573054]
bas 17, expnt(s) = [24.73250216]
bas 18, expnt(s) = [9.0794745]
bas 19, expnt(s) = [8.6042774]
bas 20, expnt(s) = [0.49274996]
CPU time:      1308.46
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28875718e-01 8.36016432e-01 5.96780047e-01 1.71544084e+00
 1.81820981e+00 3.95592475e+00 1.17616813e+05 1.60460108e+04
 4.04945286e+00 7.21210905e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229149e+03 1.99576498e+03
 1.83757702e+04 3.98748615e+03 1.44375449e+03 5.91745598e+02
 4.17404410e+02 2.33309702e+02 1.47739252e+02 1.07062393e+02
 5.85657305e+01 5.34869333e+01 2.47325022e+01 2.80198668e+01
 9.07947450e+00 1.32147989e+01 8.60427740e+00 4.29909851e+01
 4.92749959e-01 1.20439138e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336084270664628
cond(S) = 912647.2733051302
E1 = -689.5960813007166  E_coul = 184.97155963193762
init E= -504.624521668779
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672172906942865  LUMO = 0.537525922869263
  mo_energy =
[-1.21709777e+02 -1.33862973e+01 -7.62358842e+00 -7.62358842e+00
 -7.62358842e+00 -1.65758512e+00 -6.72172907e-01 -6.72172907e-01
 -6.72172907e-01  5.37525923e-01  4.84799469e+00  2.14211336e+01
  8.04383580e+01  2.75510126e+02  9.03234296e+02  3.15564191e+03
  1.26349797e+04  4.12314292e+04  1.05259192e+05  2.30432021e+05
  4.56239315e+05  8.45185762e+05  1.52835740e+06  2.85061787e+06
  5.80849626e+06]
E1 = -707.7551820445535  E_coul = 199.7826460406769
cycle= 1 E= -507.972536003877  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.759381
diis-c [-0.57665955  1.        ]
  HOMO = -0.217623815513234  LUMO = 0.883634541276475
  mo_energy =
[-1.20200112e+02 -1.23047272e+01 -6.59397433e+00 -6.59397433e+00
 -6.59397433e+00 -1.16332167e+00 -2.17623816e-01 -2.17623816e-01
 -2.17623816e-01  8.83634541e-01  5.47114879e+00  2.23709870e+01
  8.17089295e+01  2.76962563e+02  9.04725849e+02  3.15707426e+03
  1.26363056e+04  4.12326880e+04  1.05260414e+05  2.30433219e+05
  4.56240495e+05  8.45186929e+05  1.52835856e+06  2.85061901e+06
  5.80849739e+06]
E1 = -706.8002000816595  E_coul = 198.80984794721954
cycle= 2 E= -507.99035213444  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348604
diis-c [-0.00121001 -0.00302528  1.00302528]
  HOMO = -0.239803203694471  LUMO = 0.879964637040739
  mo_energy =
[-1.20315131e+02 -1.23725370e+01 -6.66905734e+00 -6.66905734e+00
 -6.66905734e+00 -1.17759257e+00 -2.39803204e-01 -2.39803204e-01
 -2.39803204e-01  8.79964637e-01  5.44306985e+00  2.23138116e+01
  8.16250097e+01  2.76857796e+02  9.04605184e+02  3.15693924e+03
  1.26361604e+04  4.12325389e+04  1.05260263e+05  2.30433067e+05
  4.56240343e+05  8.45186776e+05  1.52835840e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6917307282971  E_coul = 198.70111613222082
cycle= 3 E= -507.990614596076  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382087
diis-c [-3.27268552e-06  1.15218330e-04 -1.07282156e-01  1.10716694e+00]
  HOMO = -0.242951101226073  LUMO = 0.879218171301507
  mo_energy =
[-1.20326847e+02 -1.23810801e+01 -6.67808097e+00 -6.67808097e+00
 -6.67808097e+00 -1.17950006e+00 -2.42951101e-01 -2.42951101e-01
 -2.42951101e-01  8.79218171e-01  5.43890512e+00  2.23064354e+01
  8.16153861e+01  2.76846745e+02  9.04593233e+02  3.15692659e+03
  1.26361473e+04  4.12325256e+04  1.05260250e+05  2.30433054e+05
  4.56240330e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6764345016003  E_coul = 198.68581483836385
cycle= 4 E= -507.990619663236  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173589
diis-c [-5.68890160e-10 -9.47544685e-06  6.86735516e-03 -9.76976669e-02
  1.09083979e+00]
  HOMO = -0.243099618680667  LUMO = 0.87917365227791
  mo_energy =
[-1.20327187e+02 -1.23814160e+01 -6.67841242e+00 -6.67841242e+00
 -6.67841242e+00 -1.17959006e+00 -2.43099619e-01 -2.43099619e-01
 -2.43099619e-01  8.79173652e-01  5.43870247e+00  2.23061356e+01
  8.16150548e+01  2.76846407e+02  9.04592893e+02  3.15692625e+03
  1.26361469e+04  4.12325253e+04  1.05260250e+05  2.30433053e+05
  4.56240329e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.675718746485  E_coul = 198.6850990690008
cycle= 5 E= -507.990619677484  delta_E= -1.42e-08  |g|= 5.95e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63667e-06
diis-c [-9.44325120e-13  6.10415188e-07 -5.60428079e-04  7.59575668e-03
 -9.09871007e-02  1.08395116e+00]
  HOMO = -0.243102348620963  LUMO = 0.879172882386989
  mo_energy =
[-1.20327193e+02 -1.23814213e+01 -6.67841778e+00 -6.67841778e+00
 -6.67841778e+00 -1.17959193e+00 -2.43102349e-01 -2.43102349e-01
 -2.43102349e-01  8.79172882e-01  5.43869870e+00  2.23061306e+01
  8.16150493e+01  2.76846401e+02  9.04592886e+02  3.15692624e+03
  1.26361469e+04  4.12325252e+04  1.05260250e+05  2.30433053e+05
  4.56240329e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6757049173883  E_coul = 198.68508523989675
cycle= 6 E= -507.990619677492  delta_E= -7.33e-12  |g|= 9.12e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757049173883  E_coul = 198.68508523989675
  HOMO = -0.243102391283685  LUMO = 0.879172855766324
  mo_energy =
[-1.20327193e+02 -1.23814214e+01 -6.67841787e+00 -6.67841787e+00
 -6.67841787e+00 -1.17959195e+00 -2.43102391e-01 -2.43102391e-01
 -2.43102391e-01  8.79172856e-01  5.43869864e+00  2.23061306e+01
  8.16150492e+01  2.76846401e+02  9.04592886e+02  3.15692624e+03
  1.26361469e+04  4.12325252e+04  1.05260250e+05  2.30433053e+05
  4.56240329e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6757047354463  E_coul = 198.68508505795435
Extra cycle  E= -507.990619677492  delta_E= -3.98e-13  |g|= 1.27e-08  |ddm|= 2.18e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.28875718e-01 5.96780047e-01 1.81820981e+00 1.17616813e+05
 4.04945286e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229149e+03
 1.83757702e+04 1.44375449e+03 4.17404410e+02 1.47739252e+02
 5.85657305e+01 2.47325022e+01 9.07947450e+00 8.60427740e+00
 4.92749959e-01]
E = -507.99061967749196
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228875717577       1
[INPUT] 0    0    [1    /1   ]  0.59678004668        1
[INPUT] 0    0    [1    /1   ]  1.8182098117         1
[INPUT] 0    0    [1    /1   ]  117616.812854        1
[INPUT] 0    0    [1    /1   ]  4.04945285904        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069956        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.991301        1
[INPUT] 0    0    [1    /1   ]  73510.4174569        1
[INPUT] 0    0    [1    /1   ]  36754.7010587        1
[INPUT] 0    0    [1    /1   ]  7302.29148653        1
[INPUT] 0    0    [1    /1   ]  18375.7701731        1
[INPUT] 0    0    [1    /1   ]  1443.75449222        1
[INPUT] 0    0    [1    /1   ]  417.404410172        1
[INPUT] 0    0    [1    /1   ]  147.739252292        1
[INPUT] 0    0    [1    /1   ]  58.5657305444        1
[INPUT] 0    0    [1    /1   ]  24.7325021606        1
[INPUT] 0    0    [1    /1   ]  9.07947450048        1
[INPUT] 1    0    [1    /1   ]  8.6042774006         1
[INPUT] 1    0    [1    /1   ]  0.492749959285       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22887571757707292, 1.0]], [0, [0.5967800466800021, 1.0]], [0, [1.8182098117044265, 1.0]], [0, [117616.81285374144, 1.0]], [0, [4.049452859039517, 1.0]], [0, [1176168.1426132147, 1.0]], [0, [588084.0699555326, 1.0]], [0, [294042.0309158884, 1.0]], [0, [147020.99130140065, 1.0]], [0, [73510.41745686745, 1.0]], [0, [36754.701058741215, 1.0]], [0, [7302.291486526681, 1.0]], [0, [18375.770173126006, 1.0]], [0, [1443.754492221432, 1.0]], [0, [417.40441017188346, 1.0]], [0, [147.73925229159957, 1.0]], [0, [58.56573054440036, 1.0]], [0, [24.732502160566813, 1.0]], [0, [9.079474500482393, 1.0]], [1, [8.604277400596365, 1.0]], [1, [0.4927499592849908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22887572]
bas 1, expnt(s) = [0.59678005]
bas 2, expnt(s) = [1.81820981]
bas 3, expnt(s) = [117616.81285374]
bas 4, expnt(s) = [4.04945286]
bas 5, expnt(s) = [1176168.14261321]
bas 6, expnt(s) = [588084.06995553]
bas 7, expnt(s) = [294042.03091589]
bas 8, expnt(s) = [147020.9913014]
bas 9, expnt(s) = [73510.41745687]
bas 10, expnt(s) = [36754.70105874]
bas 11, expnt(s) = [7302.29148653]
bas 12, expnt(s) = [18375.77017313]
bas 13, expnt(s) = [1443.75449222]
bas 14, expnt(s) = [417.40441017]
bas 15, expnt(s) = [147.73925229]
bas 16, expnt(s) = [58.56573054]
bas 17, expnt(s) = [24.73250216]
bas 18, expnt(s) = [9.0794745]
bas 19, expnt(s) = [8.6042774]
bas 20, expnt(s) = [0.49274996]
CPU time:      1310.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28875718e-01 8.36016432e-01 5.96780047e-01 1.71544084e+00
 1.81820981e+00 3.95592475e+00 1.17616813e+05 1.60460108e+04
 4.04945286e+00 7.21210905e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547011e+04 6.70655816e+03 7.30229149e+03 1.99576498e+03
 1.83757702e+04 3.98748615e+03 1.44375449e+03 5.91745598e+02
 4.17404410e+02 2.33309702e+02 1.47739252e+02 1.07062393e+02
 5.85657305e+01 5.34869333e+01 2.47325022e+01 2.80198668e+01
 9.07947450e+00 1.32147989e+01 8.60427740e+00 4.29909851e+01
 4.92749959e-01 1.20439138e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336084270664628
cond(S) = 912647.2733051302
E1 = -689.5960813007166  E_coul = 184.97155963193762
init E= -504.624521668779
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672172906942865  LUMO = 0.537525922869263
  mo_energy =
[-1.21709777e+02 -1.33862973e+01 -7.62358842e+00 -7.62358842e+00
 -7.62358842e+00 -1.65758512e+00 -6.72172907e-01 -6.72172907e-01
 -6.72172907e-01  5.37525923e-01  4.84799469e+00  2.14211336e+01
  8.04383580e+01  2.75510126e+02  9.03234296e+02  3.15564191e+03
  1.26349797e+04  4.12314292e+04  1.05259192e+05  2.30432021e+05
  4.56239315e+05  8.45185762e+05  1.52835740e+06  2.85061787e+06
  5.80849626e+06]
E1 = -707.7551820445535  E_coul = 199.7826460406769
cycle= 1 E= -507.972536003877  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.72 sec, wall time      0.04 sec
diis-norm(errvec)=0.759381
diis-c [-0.57665955  1.        ]
  HOMO = -0.217623815513234  LUMO = 0.883634541276475
  mo_energy =
[-1.20200112e+02 -1.23047272e+01 -6.59397433e+00 -6.59397433e+00
 -6.59397433e+00 -1.16332167e+00 -2.17623816e-01 -2.17623816e-01
 -2.17623816e-01  8.83634541e-01  5.47114879e+00  2.23709870e+01
  8.17089295e+01  2.76962563e+02  9.04725849e+02  3.15707426e+03
  1.26363056e+04  4.12326880e+04  1.05260414e+05  2.30433219e+05
  4.56240495e+05  8.45186929e+05  1.52835856e+06  2.85061901e+06
  5.80849739e+06]
E1 = -706.8002000816595  E_coul = 198.80984794721954
cycle= 2 E= -507.99035213444  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.0348604
diis-c [-0.00121001 -0.00302528  1.00302528]
  HOMO = -0.239803203694471  LUMO = 0.879964637040739
  mo_energy =
[-1.20315131e+02 -1.23725370e+01 -6.66905734e+00 -6.66905734e+00
 -6.66905734e+00 -1.17759257e+00 -2.39803204e-01 -2.39803204e-01
 -2.39803204e-01  8.79964637e-01  5.44306985e+00  2.23138116e+01
  8.16250097e+01  2.76857796e+02  9.04605184e+02  3.15693924e+03
  1.26361604e+04  4.12325389e+04  1.05260263e+05  2.30433067e+05
  4.56240343e+05  8.45186776e+05  1.52835840e+06  2.85061886e+06
  5.80849724e+06]
E1 = -706.6917307282971  E_coul = 198.70111613222082
cycle= 3 E= -507.990614596076  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00382087
diis-c [-3.27268552e-06  1.15218330e-04 -1.07282156e-01  1.10716694e+00]
  HOMO = -0.242951101226073  LUMO = 0.879218171301507
  mo_energy =
[-1.20326847e+02 -1.23810801e+01 -6.67808097e+00 -6.67808097e+00
 -6.67808097e+00 -1.17950006e+00 -2.42951101e-01 -2.42951101e-01
 -2.42951101e-01  8.79218171e-01  5.43890512e+00  2.23064354e+01
  8.16153861e+01  2.76846745e+02  9.04593233e+02  3.15692659e+03
  1.26361473e+04  4.12325256e+04  1.05260250e+05  2.30433054e+05
  4.56240330e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6764345016003  E_coul = 198.68581483836385
cycle= 4 E= -507.990619663236  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173589
diis-c [-5.68890160e-10 -9.47544685e-06  6.86735516e-03 -9.76976669e-02
  1.09083979e+00]
  HOMO = -0.243099618680667  LUMO = 0.87917365227791
  mo_energy =
[-1.20327187e+02 -1.23814160e+01 -6.67841242e+00 -6.67841242e+00
 -6.67841242e+00 -1.17959006e+00 -2.43099619e-01 -2.43099619e-01
 -2.43099619e-01  8.79173652e-01  5.43870247e+00  2.23061356e+01
  8.16150548e+01  2.76846407e+02  9.04592893e+02  3.15692625e+03
  1.26361469e+04  4.12325253e+04  1.05260250e+05  2.30433053e+05
  4.56240329e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.675718746485  E_coul = 198.6850990690008
cycle= 5 E= -507.990619677484  delta_E= -1.42e-08  |g|= 5.95e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63667e-06
diis-c [-9.44325120e-13  6.10415188e-07 -5.60428079e-04  7.59575668e-03
 -9.09871007e-02  1.08395116e+00]
  HOMO = -0.243102348620963  LUMO = 0.879172882386989
  mo_energy =
[-1.20327193e+02 -1.23814213e+01 -6.67841778e+00 -6.67841778e+00
 -6.67841778e+00 -1.17959193e+00 -2.43102349e-01 -2.43102349e-01
 -2.43102349e-01  8.79172882e-01  5.43869870e+00  2.23061306e+01
  8.16150493e+01  2.76846401e+02  9.04592886e+02  3.15692624e+03
  1.26361469e+04  4.12325252e+04  1.05260250e+05  2.30433053e+05
  4.56240329e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6757049173883  E_coul = 198.68508523989675
cycle= 6 E= -507.990619677492  delta_E= -7.33e-12  |g|= 9.12e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757049173883  E_coul = 198.68508523989675
  HOMO = -0.243102391283685  LUMO = 0.879172855766324
  mo_energy =
[-1.20327193e+02 -1.23814214e+01 -6.67841787e+00 -6.67841787e+00
 -6.67841787e+00 -1.17959195e+00 -2.43102391e-01 -2.43102391e-01
 -2.43102391e-01  8.79172856e-01  5.43869864e+00  2.23061306e+01
  8.16150492e+01  2.76846401e+02  9.04592886e+02  3.15692624e+03
  1.26361469e+04  4.12325252e+04  1.05260250e+05  2.30433053e+05
  4.56240329e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6757047354463  E_coul = 198.68508505795435
Extra cycle  E= -507.990619677492  delta_E= -3.98e-13  |g|= 1.27e-08  |ddm|= 2.18e-07
    CPU time for scf_cycle      1.64 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912647.2733051302
E1 = -706.6757047354463  E_coul = 198.68508505795435
init E= -507.990619677492
    CPU time for initialize scf      6.14 sec, wall time      0.26 sec
  HOMO = -0.243102397227146  LUMO = 0.879172856115885
  mo_energy =
[-1.20327193e+02 -1.23814214e+01 -6.67841788e+00 -6.67841788e+00
 -6.67841788e+00 -1.17959195e+00 -2.43102397e-01 -2.43102397e-01
 -2.43102397e-01  8.79172856e-01  5.43869863e+00  2.23061306e+01
  8.16150492e+01  2.76846401e+02  9.04592886e+02  3.15692624e+03
  1.26361469e+04  4.12325252e+04  1.05260250e+05  2.30433053e+05
  4.56240329e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6757047014341  E_coul = 198.68508502394243
cycle= 1 E= -507.990619677492  delta_E= 2.27e-13  |g|= 1.94e-09  |ddm|= 3.4e-08
    CPU time for cycle= 1      0.27 sec, wall time      0.03 sec
E1 = -706.6757047014341  E_coul = 198.68508502394243
  HOMO = -0.243102398278442  LUMO = 0.879172855900355
  mo_energy =
[-1.20327193e+02 -1.23814214e+01 -6.67841788e+00 -6.67841788e+00
 -6.67841788e+00 -1.17959195e+00 -2.43102398e-01 -2.43102398e-01
 -2.43102398e-01  8.79172856e-01  5.43869863e+00  2.23061306e+01
  8.16150492e+01  2.76846401e+02  9.04592886e+02  3.15692624e+03
  1.26361469e+04  4.12325252e+04  1.05260250e+05  2.30433053e+05
  4.56240329e+05  8.45186763e+05  1.52835839e+06  2.85061885e+06
  5.80849723e+06]
E1 = -706.6757046942482  E_coul = 198.68508501675652
Extra cycle  E= -507.990619677492  delta_E=    0  |g|= 2.74e-09  |ddm|= 6.19e-09
    CPU time for scf_cycle      6.57 sec, wall time      0.44 sec
exp = [2.28875718e-01 5.96780047e-01 1.81820981e+00 1.17616813e+05
 4.04945286e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547011e+04 7.30229149e+03
 1.83757702e+04 1.44375449e+03 4.17404410e+02 1.47739252e+02
 5.85657305e+01 2.47325022e+01 9.07947450e+00 8.60427740e+00
 4.92749959e-01]
grad_E = [ 1.86030979e-04 -1.06544060e-04 -1.24894137e-05  6.07382704e-09
  1.69231154e-05  4.05706057e-11  1.74533642e-10  9.42078032e-10
  3.72230565e-09  1.55440941e-08  8.10681254e-08  5.11079879e-06
  1.98842198e-07 -3.90050825e-05 -1.55329767e-06 -1.11724258e-05
 -1.25155373e-05 -3.64193787e-05  7.64760124e-06 -6.95423298e-06
 -8.30091783e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228828062084       1
[INPUT] 0    0    [1    /1   ]  0.596527378044       1
[INPUT] 0    0    [1    /1   ]  1.81930133602        1
[INPUT] 0    0    [1    /1   ]  117616.812852        1
[INPUT] 0    0    [1    /1   ]  4.05300290174        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.9913          1
[INPUT] 0    0    [1    /1   ]  73510.4174526        1
[INPUT] 0    0    [1    /1   ]  36754.7010367        1
[INPUT] 0    0    [1    /1   ]  7302.2900972         1
[INPUT] 0    0    [1    /1   ]  18375.770119         1
[INPUT] 0    0    [1    /1   ]  1443.76521763        1
[INPUT] 0    0    [1    /1   ]  417.403528879        1
[INPUT] 0    0    [1    /1   ]  147.747665249        1
[INPUT] 0    0    [1    /1   ]  58.5575370151        1
[INPUT] 0    0    [1    /1   ]  24.7511641154        1
[INPUT] 0    0    [1    /1   ]  9.08255974871        1
[INPUT] 1    0    [1    /1   ]  8.6042687719         1
[INPUT] 1    0    [1    /1   ]  0.492748336296       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22882806208410164, 1.0]], [0, [0.5965273780438821, 1.0]], [0, [1.8193013360171253, 1.0]], [0, [117616.81285209024, 1.0]], [0, [4.053002901735719, 1.0]], [0, [1176168.1426132037, 1.0]], [0, [588084.069955485, 1.0]], [0, [294042.03091563226, 1.0]], [0, [147020.99130038868, 1.0]], [0, [73510.41745264144, 1.0]], [0, [36754.7010367051, 1.0]], [0, [7302.2900972043335, 1.0]], [0, [18375.770119034787, 1.0]], [0, [1443.7652176275471, 1.0]], [0, [417.40352887854726, 1.0]], [0, [147.74766524919, 1.0]], [0, [58.55753701513077, 1.0]], [0, [24.75116411538086, 1.0]], [0, [9.082559748713022, 1.0]], [1, [8.60426877190149, 1.0]], [1, [0.4927483362959166, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22882806]
bas 1, expnt(s) = [0.59652738]
bas 2, expnt(s) = [1.81930134]
bas 3, expnt(s) = [117616.81285209]
bas 4, expnt(s) = [4.0530029]
bas 5, expnt(s) = [1176168.1426132]
bas 6, expnt(s) = [588084.06995549]
bas 7, expnt(s) = [294042.03091563]
bas 8, expnt(s) = [147020.99130039]
bas 9, expnt(s) = [73510.41745264]
bas 10, expnt(s) = [36754.70103671]
bas 11, expnt(s) = [7302.2900972]
bas 12, expnt(s) = [18375.77011903]
bas 13, expnt(s) = [1443.76521763]
bas 14, expnt(s) = [417.40352888]
bas 15, expnt(s) = [147.74766525]
bas 16, expnt(s) = [58.55753702]
bas 17, expnt(s) = [24.75116412]
bas 18, expnt(s) = [9.08255975]
bas 19, expnt(s) = [8.60426877]
bas 20, expnt(s) = [0.49274834]
CPU time:      1325.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28828062e-01 8.35885874e-01 5.96527378e-01 1.71489609e+00
 1.81930134e+00 3.95770576e+00 1.17616813e+05 1.60460108e+04
 4.05300290e+00 7.21685052e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547010e+04 6.70655816e+03 7.30229010e+03 1.99576470e+03
 1.83757701e+04 3.98748614e+03 1.44376522e+03 5.91748895e+02
 4.17403529e+02 2.33309333e+02 1.47747665e+02 1.07066966e+02
 5.85575370e+01 5.34813209e+01 2.47511641e+01 2.80357221e+01
 9.08255975e+00 1.32181666e+01 8.60426877e+00 4.29909312e+01
 4.92748336e-01 1.20438642e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608622502765
cond(S) = 912649.2061337286
E1 = -689.5960904921877  E_coul = 184.97144620474072
init E= -504.624644287447
    CPU time for initialize scf      8.23 sec, wall time      0.40 sec
  HOMO = -0.672176034200875  LUMO = 0.537269005092694
  mo_energy =
[-1.21709791e+02 -1.33863072e+01 -7.62359569e+00 -7.62359569e+00
 -7.62359569e+00 -1.65758696e+00 -6.72176034e-01 -6.72176034e-01
 -6.72176034e-01  5.37269005e-01  4.84982069e+00  2.14370331e+01
  8.04892379e+01  2.75590563e+02  9.03326052e+02  3.15574340e+03
  1.26350922e+04  4.12315411e+04  1.05259301e+05  2.30432127e+05
  4.56239418e+05  8.45185863e+05  1.52835750e+06  2.85061796e+06
  5.80849635e+06]
E1 = -707.7550406257279  E_coul = 199.78250275365997
cycle= 1 E= -507.972537872068  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.759388
diis-c [-0.57667068  1.        ]
  HOMO = -0.217627660318223  LUMO = 0.88334688660985
  mo_energy =
[-1.20200130e+02 -1.23047396e+01 -6.59398389e+00 -6.59398389e+00
 -6.59398389e+00 -1.16332415e+00 -2.17627660e-01 -2.17627660e-01
 -2.17627660e-01  8.83346887e-01  5.47315229e+00  2.23871131e+01
  8.17599139e+01  2.77043004e+02  9.04817601e+02  3.15717574e+03
  1.26364181e+04  4.12327999e+04  1.05260523e+05  2.30433324e+05
  4.56240598e+05  8.45187030e+05  1.52835866e+06  2.85061911e+06
  5.80849749e+06]
E1 = -706.8000995755458  E_coul = 198.80974664563627
cycle= 2 E= -507.99035292991  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.034856
diis-c [-0.00120973 -0.00301809  1.00301809]
  HOMO = -0.239805426513641  LUMO = 0.879677953869322
  mo_energy =
[-1.20315144e+02 -1.23725459e+01 -6.66906330e+00 -6.66906330e+00
 -6.66906330e+00 -1.17759400e+00 -2.39805427e-01 -2.39805427e-01
 -2.39805427e-01  8.79677954e-01  5.44506297e+00  2.23299227e+01
  8.16759879e+01  2.76938240e+02  9.04696940e+02  3.15704072e+03
  1.26362729e+04  4.12326507e+04  1.05260372e+05  2.30433172e+05
  4.56240446e+05  8.45186878e+05  1.52835850e+06  2.85061896e+06
  5.80849734e+06]
E1 = -706.69162960102  E_coul = 198.70101419295722
cycle= 3 E= -507.990615408063  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0038205
diis-c [-3.27203277e-06  1.14935502e-04 -1.07284902e-01  1.10716997e+00]
  HOMO = -0.242953551749294  LUMO = 0.878931543471562
  mo_energy =
[-1.20326861e+02 -1.23810895e+01 -6.67808757e+00 -6.67808757e+00
 -6.67808757e+00 -1.17950166e+00 -2.42953552e-01 -2.42953552e-01
 -2.42953552e-01  8.78931543e-01  5.44089629e+00  2.23225442e+01
  8.16663629e+01  2.76927188e+02  9.04684988e+02  3.15702807e+03
  1.26362598e+04  4.12326375e+04  1.05260358e+05  2.30433159e+05
  4.56240433e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.6763308496015  E_coul = 198.68571037233195
cycle= 4 E= -507.99062047727  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173621
diis-c [-5.69549230e-10 -9.47583107e-06  6.86946087e-03 -9.77259809e-02
  1.09086600e+00]
  HOMO = -0.243102140897117  LUMO = 0.878887009365662
  mo_energy =
[-1.20327201e+02 -1.23814256e+01 -6.67841918e+00 -6.67841918e+00
 -6.67841918e+00 -1.17959170e+00 -2.43102141e-01 -2.43102141e-01
 -2.43102141e-01  8.78887009e-01  5.44069347e+00  2.23222442e+01
  8.16660314e+01  2.76926850e+02  9.04684648e+02  3.15702773e+03
  1.26362594e+04  4.12326371e+04  1.05260358e+05  2.30433159e+05
  4.56240432e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.6756146568499  E_coul = 198.68499416531634
cycle= 5 E= -507.990620491534  delta_E= -1.43e-08  |g|= 5.95e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63776e-06
diis-c [-9.43631199e-13  6.11418622e-07 -5.60459416e-04  7.59634629e-03
 -9.09816648e-02  1.08394517e+00]
  HOMO = -0.243104872293488  LUMO = 0.878886240137897
  mo_energy =
[-1.20327207e+02 -1.23814309e+01 -6.67842455e+00 -6.67842455e+00
 -6.67842455e+00 -1.17959357e+00 -2.43104872e-01 -2.43104872e-01
 -2.43104872e-01  8.78886240e-01  5.44068969e+00  2.23222393e+01
  8.16660258e+01  2.76926844e+02  9.04684641e+02  3.15702772e+03
  1.26362594e+04  4.12326371e+04  1.05260358e+05  2.30433159e+05
  4.56240432e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.675600820306  E_coul = 198.68498032876536
cycle= 6 E= -507.990620491541  delta_E= -7.05e-12  |g|= 9.05e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.675600820306  E_coul = 198.68498032876536
  HOMO = -0.243104914910549  LUMO = 0.878886213261426
  mo_energy =
[-1.20327207e+02 -1.23814310e+01 -6.67842463e+00 -6.67842463e+00
 -6.67842463e+00 -1.17959359e+00 -2.43104915e-01 -2.43104915e-01
 -2.43104915e-01  8.78886213e-01  5.44068963e+00  2.23222392e+01
  8.16660257e+01  2.76926844e+02  9.04684641e+02  3.15702772e+03
  1.26362594e+04  4.12326371e+04  1.05260358e+05  2.30433159e+05
  4.56240432e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.6756006371071  E_coul = 198.684980145566
Extra cycle  E= -507.990620491541  delta_E= -4.55e-13  |g|= 1.18e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      8.47 sec, wall time      0.63 sec
exp = [2.28828062e-01 5.96527378e-01 1.81930134e+00 1.17616813e+05
 4.05300290e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547010e+04 7.30229010e+03
 1.83757701e+04 1.44376522e+03 4.17403529e+02 1.47747665e+02
 5.85575370e+01 2.47511641e+01 9.08255975e+00 8.60426877e+00
 4.92748336e-01]
E = -507.9906204915411
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228828062084       1
[INPUT] 0    0    [1    /1   ]  0.596527378044       1
[INPUT] 0    0    [1    /1   ]  1.81930133602        1
[INPUT] 0    0    [1    /1   ]  117616.812852        1
[INPUT] 0    0    [1    /1   ]  4.05300290174        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030916        1
[INPUT] 0    0    [1    /1   ]  147020.9913          1
[INPUT] 0    0    [1    /1   ]  73510.4174526        1
[INPUT] 0    0    [1    /1   ]  36754.7010367        1
[INPUT] 0    0    [1    /1   ]  7302.2900972         1
[INPUT] 0    0    [1    /1   ]  18375.770119         1
[INPUT] 0    0    [1    /1   ]  1443.76521763        1
[INPUT] 0    0    [1    /1   ]  417.403528879        1
[INPUT] 0    0    [1    /1   ]  147.747665249        1
[INPUT] 0    0    [1    /1   ]  58.5575370151        1
[INPUT] 0    0    [1    /1   ]  24.7511641154        1
[INPUT] 0    0    [1    /1   ]  9.08255974871        1
[INPUT] 1    0    [1    /1   ]  8.6042687719         1
[INPUT] 1    0    [1    /1   ]  0.492748336296       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22882806208410164, 1.0]], [0, [0.5965273780438821, 1.0]], [0, [1.8193013360171253, 1.0]], [0, [117616.81285209024, 1.0]], [0, [4.053002901735719, 1.0]], [0, [1176168.1426132037, 1.0]], [0, [588084.069955485, 1.0]], [0, [294042.03091563226, 1.0]], [0, [147020.99130038868, 1.0]], [0, [73510.41745264144, 1.0]], [0, [36754.7010367051, 1.0]], [0, [7302.2900972043335, 1.0]], [0, [18375.770119034787, 1.0]], [0, [1443.7652176275471, 1.0]], [0, [417.40352887854726, 1.0]], [0, [147.74766524919, 1.0]], [0, [58.55753701513077, 1.0]], [0, [24.75116411538086, 1.0]], [0, [9.082559748713022, 1.0]], [1, [8.60426877190149, 1.0]], [1, [0.4927483362959166, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22882806]
bas 1, expnt(s) = [0.59652738]
bas 2, expnt(s) = [1.81930134]
bas 3, expnt(s) = [117616.81285209]
bas 4, expnt(s) = [4.0530029]
bas 5, expnt(s) = [1176168.1426132]
bas 6, expnt(s) = [588084.06995549]
bas 7, expnt(s) = [294042.03091563]
bas 8, expnt(s) = [147020.99130039]
bas 9, expnt(s) = [73510.41745264]
bas 10, expnt(s) = [36754.70103671]
bas 11, expnt(s) = [7302.2900972]
bas 12, expnt(s) = [18375.77011903]
bas 13, expnt(s) = [1443.76521763]
bas 14, expnt(s) = [417.40352888]
bas 15, expnt(s) = [147.74766525]
bas 16, expnt(s) = [58.55753702]
bas 17, expnt(s) = [24.75116412]
bas 18, expnt(s) = [9.08255975]
bas 19, expnt(s) = [8.60426877]
bas 20, expnt(s) = [0.49274834]
CPU time:      1334.80
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28828062e-01 8.35885874e-01 5.96527378e-01 1.71489609e+00
 1.81930134e+00 3.95770576e+00 1.17616813e+05 1.60460108e+04
 4.05300290e+00 7.21685052e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104175e+04 1.12791583e+04
 3.67547010e+04 6.70655816e+03 7.30229010e+03 1.99576470e+03
 1.83757701e+04 3.98748614e+03 1.44376522e+03 5.91748895e+02
 4.17403529e+02 2.33309333e+02 1.47747665e+02 1.07066966e+02
 5.85575370e+01 5.34813209e+01 2.47511641e+01 2.80357221e+01
 9.08255975e+00 1.32181666e+01 8.60426877e+00 4.29909312e+01
 4.92748336e-01 1.20438642e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608622502765
cond(S) = 912649.2061337286
E1 = -689.5960904921877  E_coul = 184.97144620474072
init E= -504.624644287447
    CPU time for initialize scf      7.72 sec, wall time      0.38 sec
  HOMO = -0.672176034200875  LUMO = 0.537269005092694
  mo_energy =
[-1.21709791e+02 -1.33863072e+01 -7.62359569e+00 -7.62359569e+00
 -7.62359569e+00 -1.65758696e+00 -6.72176034e-01 -6.72176034e-01
 -6.72176034e-01  5.37269005e-01  4.84982069e+00  2.14370331e+01
  8.04892379e+01  2.75590563e+02  9.03326052e+02  3.15574340e+03
  1.26350922e+04  4.12315411e+04  1.05259301e+05  2.30432127e+05
  4.56239418e+05  8.45185863e+05  1.52835750e+06  2.85061796e+06
  5.80849635e+06]
E1 = -707.7550406257279  E_coul = 199.78250275365997
cycle= 1 E= -507.972537872068  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.57 sec, wall time      0.03 sec
diis-norm(errvec)=0.759388
diis-c [-0.57667068  1.        ]
  HOMO = -0.217627660318223  LUMO = 0.88334688660985
  mo_energy =
[-1.20200130e+02 -1.23047396e+01 -6.59398389e+00 -6.59398389e+00
 -6.59398389e+00 -1.16332415e+00 -2.17627660e-01 -2.17627660e-01
 -2.17627660e-01  8.83346887e-01  5.47315229e+00  2.23871131e+01
  8.17599139e+01  2.77043004e+02  9.04817601e+02  3.15717574e+03
  1.26364181e+04  4.12327999e+04  1.05260523e+05  2.30433324e+05
  4.56240598e+05  8.45187030e+05  1.52835866e+06  2.85061911e+06
  5.80849749e+06]
E1 = -706.8000995755458  E_coul = 198.80974664563627
cycle= 2 E= -507.99035292991  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.034856
diis-c [-0.00120973 -0.00301809  1.00301809]
  HOMO = -0.239805426513641  LUMO = 0.879677953869322
  mo_energy =
[-1.20315144e+02 -1.23725459e+01 -6.66906330e+00 -6.66906330e+00
 -6.66906330e+00 -1.17759400e+00 -2.39805427e-01 -2.39805427e-01
 -2.39805427e-01  8.79677954e-01  5.44506297e+00  2.23299227e+01
  8.16759879e+01  2.76938240e+02  9.04696940e+02  3.15704072e+03
  1.26362729e+04  4.12326507e+04  1.05260372e+05  2.30433172e+05
  4.56240446e+05  8.45186878e+05  1.52835850e+06  2.85061896e+06
  5.80849734e+06]
E1 = -706.69162960102  E_coul = 198.70101419295722
cycle= 3 E= -507.990615408063  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0038205
diis-c [-3.27203277e-06  1.14935502e-04 -1.07284902e-01  1.10716997e+00]
  HOMO = -0.242953551749294  LUMO = 0.878931543471562
  mo_energy =
[-1.20326861e+02 -1.23810895e+01 -6.67808757e+00 -6.67808757e+00
 -6.67808757e+00 -1.17950166e+00 -2.42953552e-01 -2.42953552e-01
 -2.42953552e-01  8.78931543e-01  5.44089629e+00  2.23225442e+01
  8.16663629e+01  2.76927188e+02  9.04684988e+02  3.15702807e+03
  1.26362598e+04  4.12326375e+04  1.05260358e+05  2.30433159e+05
  4.56240433e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.6763308496015  E_coul = 198.68571037233195
cycle= 4 E= -507.99062047727  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173621
diis-c [-5.69549230e-10 -9.47583107e-06  6.86946087e-03 -9.77259809e-02
  1.09086600e+00]
  HOMO = -0.243102140897117  LUMO = 0.878887009365662
  mo_energy =
[-1.20327201e+02 -1.23814256e+01 -6.67841918e+00 -6.67841918e+00
 -6.67841918e+00 -1.17959170e+00 -2.43102141e-01 -2.43102141e-01
 -2.43102141e-01  8.78887009e-01  5.44069347e+00  2.23222442e+01
  8.16660314e+01  2.76926850e+02  9.04684648e+02  3.15702773e+03
  1.26362594e+04  4.12326371e+04  1.05260358e+05  2.30433159e+05
  4.56240432e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.6756146568499  E_coul = 198.68499416531634
cycle= 5 E= -507.990620491534  delta_E= -1.43e-08  |g|= 5.95e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63776e-06
diis-c [-9.43631199e-13  6.11418622e-07 -5.60459416e-04  7.59634629e-03
 -9.09816648e-02  1.08394517e+00]
  HOMO = -0.243104872293488  LUMO = 0.878886240137897
  mo_energy =
[-1.20327207e+02 -1.23814309e+01 -6.67842455e+00 -6.67842455e+00
 -6.67842455e+00 -1.17959357e+00 -2.43104872e-01 -2.43104872e-01
 -2.43104872e-01  8.78886240e-01  5.44068969e+00  2.23222393e+01
  8.16660258e+01  2.76926844e+02  9.04684641e+02  3.15702772e+03
  1.26362594e+04  4.12326371e+04  1.05260358e+05  2.30433159e+05
  4.56240432e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.675600820306  E_coul = 198.68498032876536
cycle= 6 E= -507.990620491541  delta_E= -7.05e-12  |g|= 9.05e-08  |ddm|= 1.79e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.675600820306  E_coul = 198.68498032876536
  HOMO = -0.243104914910549  LUMO = 0.878886213261426
  mo_energy =
[-1.20327207e+02 -1.23814310e+01 -6.67842463e+00 -6.67842463e+00
 -6.67842463e+00 -1.17959359e+00 -2.43104915e-01 -2.43104915e-01
 -2.43104915e-01  8.78886213e-01  5.44068963e+00  2.23222392e+01
  8.16660257e+01  2.76926844e+02  9.04684641e+02  3.15702772e+03
  1.26362594e+04  4.12326371e+04  1.05260358e+05  2.30433159e+05
  4.56240432e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.6756006371071  E_coul = 198.684980145566
Extra cycle  E= -507.990620491541  delta_E= -4.55e-13  |g|= 1.18e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      8.53 sec, wall time      0.60 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912649.2061337286
E1 = -706.6756006371071  E_coul = 198.684980145566
init E= -507.990620491541
    CPU time for initialize scf     16.93 sec, wall time      0.74 sec
  HOMO = -0.243104920881005  LUMO = 0.878886211099018
  mo_energy =
[-1.20327207e+02 -1.23814310e+01 -6.67842465e+00 -6.67842465e+00
 -6.67842465e+00 -1.17959359e+00 -2.43104921e-01 -2.43104921e-01
 -2.43104921e-01  8.78886211e-01  5.44068962e+00  2.23222392e+01
  8.16660257e+01  2.76926844e+02  9.04684641e+02  3.15702772e+03
  1.26362594e+04  4.12326371e+04  1.05260358e+05  2.30433159e+05
  4.56240432e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.6756006082886  E_coul = 198.68498011674774
cycle= 1 E= -507.990620491541  delta_E= 2.27e-13  |g|= 2.59e-09  |ddm|= 2.88e-08
    CPU time for cycle= 1      0.34 sec, wall time      0.03 sec
E1 = -706.6756006082886  E_coul = 198.68498011674774
  HOMO = -0.243104921773786  LUMO = 0.878886212336415
  mo_energy =
[-1.20327207e+02 -1.23814310e+01 -6.67842465e+00 -6.67842465e+00
 -6.67842465e+00 -1.17959359e+00 -2.43104922e-01 -2.43104922e-01
 -2.43104922e-01  8.78886212e-01  5.44068962e+00  2.23222392e+01
  8.16660257e+01  2.76926844e+02  9.04684641e+02  3.15702772e+03
  1.26362594e+04  4.12326371e+04  1.05260358e+05  2.30433159e+05
  4.56240432e+05  8.45186864e+05  1.52835849e+06  2.85061894e+06
  5.80849732e+06]
E1 = -706.6756006006816  E_coul = 198.6849801091408
Extra cycle  E= -507.990620491541  delta_E= 1.14e-13  |g|= 8.89e-10  |ddm|= 7e-09
    CPU time for scf_cycle     17.43 sec, wall time      0.91 sec
exp = [2.28828062e-01 5.96527378e-01 1.81930134e+00 1.17616813e+05
 4.05300290e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104175e+04 3.67547010e+04 7.30229010e+03
 1.83757701e+04 1.44376522e+03 4.17403529e+02 1.47747665e+02
 5.85575370e+01 2.47511641e+01 9.08255975e+00 8.60426877e+00
 4.92748336e-01]
grad_E = [ 3.21122963e-04 -1.84460964e-04 -2.18894851e-05  6.06880694e-09
  2.80473785e-05  4.05142185e-11  1.74369019e-10  9.41308041e-10
  3.71919645e-09  1.55309408e-08  8.10046284e-08  5.10674277e-06
  1.98634718e-07 -3.88373828e-05 -2.97020645e-06 -5.36405883e-06
 -2.50418691e-05 -2.61723672e-05  6.67627783e-06 -1.18485566e-05
 -1.41720658e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228793226647       1
[INPUT] 0    0    [1    /1   ]  0.596267553581       1
[INPUT] 0    0    [1    /1   ]  1.82281580289        1
[INPUT] 0    0    [1    /1   ]  117616.812846        1
[INPUT] 0    0    [1    /1   ]  4.06085125748        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030915        1
[INPUT] 0    0    [1    /1   ]  147020.991297        1
[INPUT] 0    0    [1    /1   ]  73510.4174372        1
[INPUT] 0    0    [1    /1   ]  36754.7009561        1
[INPUT] 0    0    [1    /1   ]  7302.28501412        1
[INPUT] 0    0    [1    /1   ]  18375.7699212        1
[INPUT] 0    0    [1    /1   ]  1443.80411186        1
[INPUT] 0    0    [1    /1   ]  417.403996097        1
[INPUT] 0    0    [1    /1   ]  147.76343448         1
[INPUT] 0    0    [1    /1   ]  58.5580971557        1
[INPUT] 0    0    [1    /1   ]  24.7968256011        1
[INPUT] 0    0    [1    /1   ]  9.08964316439        1
[INPUT] 1    0    [1    /1   ]  8.60425505051        1
[INPUT] 1    0    [1    /1   ]  0.492745763922       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22879322664654686, 1.0]], [0, [0.5962675535812053, 1.0]], [0, [1.8228158028884096, 1.0]], [0, [117616.81284604917, 1.0]], [0, [4.060851257479989, 1.0]], [0, [1176168.1426131635, 1.0]], [0, [588084.0699553115, 1.0]], [0, [294042.0309146953, 1.0]], [0, [147020.99129668644, 1.0]], [0, [73510.41743718096, 1.0]], [0, [36754.700956076944, 1.0]], [0, [7302.285014118778, 1.0]], [0, [18375.769921232524, 1.0]], [0, [1443.8041118570452, 1.0]], [0, [417.40399609680736, 1.0]], [0, [147.76343448025779, 1.0]], [0, [58.55809715569396, 1.0]], [0, [24.796825601093733, 1.0]], [0, [9.089643164389658, 1.0]], [1, [8.604255050510316, 1.0]], [1, [0.49274576392230923, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22879323]
bas 1, expnt(s) = [0.59626755]
bas 2, expnt(s) = [1.8228158]
bas 3, expnt(s) = [117616.81284605]
bas 4, expnt(s) = [4.06085126]
bas 5, expnt(s) = [1176168.14261316]
bas 6, expnt(s) = [588084.06995531]
bas 7, expnt(s) = [294042.0309147]
bas 8, expnt(s) = [147020.99129669]
bas 9, expnt(s) = [73510.41743718]
bas 10, expnt(s) = [36754.70095608]
bas 11, expnt(s) = [7302.28501412]
bas 12, expnt(s) = [18375.76992123]
bas 13, expnt(s) = [1443.80411186]
bas 14, expnt(s) = [417.4039961]
bas 15, expnt(s) = [147.76343448]
bas 16, expnt(s) = [58.55809716]
bas 17, expnt(s) = [24.7968256]
bas 18, expnt(s) = [9.08964316]
bas 19, expnt(s) = [8.60425505]
bas 20, expnt(s) = [0.49274576]
CPU time:      1367.82
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28793227e-01 8.35790435e-01 5.96267554e-01 1.71433585e+00
 1.82281580e+00 3.96343840e+00 1.17616813e+05 1.60460108e+04
 4.06085126e+00 7.22732918e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104174e+04 1.12791583e+04
 3.67547010e+04 6.70655815e+03 7.30228501e+03 1.99576365e+03
 1.83757699e+04 3.98748610e+03 1.44380411e+03 5.91760851e+02
 4.17403996e+02 2.33309529e+02 1.47763434e+02 1.07075536e+02
 5.85580972e+01 5.34817046e+01 2.47968256e+01 2.80745039e+01
 9.08964316e+00 1.32258974e+01 8.60425505e+00 4.29908455e+01
 4.92745764e-01 1.20437856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336089144881743
cond(S) = 912655.1982660529
E1 = -689.5961024276675  E_coul = 184.97126223830392
init E= -504.624840189364
    CPU time for initialize scf      7.62 sec, wall time      0.37 sec
  HOMO = -0.672181087519378  LUMO = 0.537152330506639
  mo_energy =
[-1.21709814e+02 -1.33863234e+01 -7.62360756e+00 -7.62360756e+00
 -7.62360756e+00 -1.65758957e+00 -6.72181088e-01 -6.72181088e-01
 -6.72181088e-01  5.37152331e-01  4.85697627e+00  2.14788190e+01
  8.06206196e+01  2.75824348e+02  9.03612465e+02  3.15606988e+03
  1.26354648e+04  4.12319142e+04  1.05259663e+05  2.30432478e+05
  4.56239762e+05  8.45186202e+05  1.52835783e+06  2.85061829e+06
  5.80849667e+06]
E1 = -707.7548058008848  E_coul = 199.7822639732409
cycle= 1 E= -507.972541827644  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.759416
diis-c [-0.57671283  1.        ]
  HOMO = -0.217634038462787  LUMO = 0.883257073048675
  mo_energy =
[-1.20200158e+02 -1.23047602e+01 -6.59399997e+00 -6.59399997e+00
 -6.59399997e+00 -1.16332808e+00 -2.17634038e-01 -2.17634038e-01
 -2.17634038e-01  8.83257073e-01  5.48080999e+00  2.24294367e+01
  8.18915711e+01  2.77276813e+02  9.05104005e+02  3.15750222e+03
  1.26367907e+04  4.12331730e+04  1.05260884e+05  2.30433676e+05
  4.56240942e+05  8.45187369e+05  1.52835899e+06  2.85061944e+06
  5.80849781e+06]
E1 = -706.799939280449  E_coul = 198.80958426556938
cycle= 2 E= -507.99035501488  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348399
diis-c [-0.00120868 -0.00299737  1.00299737]
  HOMO = -0.239808745221776  LUMO = 0.879586360015987
  mo_energy =
[-1.20315163e+02 -1.23725596e+01 -6.66907223e+00 -6.66907223e+00
 -6.66907223e+00 -1.17759594e+00 -2.39808745e-01 -2.39808745e-01
 -2.39808745e-01  8.79586360e-01  5.45268571e+00  2.23722085e+01
  8.18076265e+01  2.77172053e+02  9.04983353e+02  3.15736721e+03
  1.26366454e+04  4.12330239e+04  1.05260734e+05  2.30433524e+05
  4.56240790e+05  8.45187216e+05  1.52835884e+06  2.85061928e+06
  5.80849765e+06]
E1 = -706.6914725868133  E_coul = 198.70085508259112
cycle= 3 E= -507.990617504222  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381854
diis-c [-3.26930569e-06  1.14519440e-04 -1.07273488e-01  1.10715897e+00]
  HOMO = -0.242957213948579  LUMO = 0.878839529187508
  mo_energy =
[-1.20326882e+02 -1.23811044e+01 -6.67809773e+00 -6.67809773e+00
 -6.67809773e+00 -1.17950383e+00 -2.42957214e-01 -2.42957214e-01
 -2.42957214e-01  8.78839529e-01  5.44851350e+00  2.23648247e+01
  8.17979981e+01  2.77160999e+02  9.04971400e+02  3.15735456e+03
  1.26366323e+04  4.12330106e+04  1.05260720e+05  2.30433511e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.6761703384826  E_coul = 198.68554776228152
cycle= 4 E= -507.990622576201  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173648
diis-c [-5.69451704e-10 -9.47583933e-06  6.87335312e-03 -9.77905030e-02
  1.09092663e+00]
  HOMO = -0.243105954234857  LUMO = 0.878794942030596
  mo_energy =
[-1.20327223e+02 -1.23814408e+01 -6.67842977e+00 -6.67842977e+00
 -6.67842977e+00 -1.17959396e+00 -2.43105954e-01 -2.43105954e-01
 -2.43105954e-01  8.78794942e-01  5.44831027e+00  2.23645243e+01
  8.17976661e+01  2.77160661e+02  9.04971059e+02  3.15735422e+03
  1.26366320e+04  4.12330102e+04  1.05260720e+05  2.30433510e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.675453311391  E_coul = 198.68483072090035
cycle= 5 E= -507.990622590491  delta_E= -1.43e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63602e-06
diis-c [-9.41643353e-13  6.10401000e-07 -5.60327030e-04  7.59501794e-03
 -9.09109776e-02  1.08387568e+00]
  HOMO = -0.243108684243185  LUMO = 0.878794172423484
  mo_energy =
[-1.20327229e+02 -1.23814461e+01 -6.67843513e+00 -6.67843513e+00
 -6.67843513e+00 -1.17959584e+00 -2.43108684e-01 -2.43108684e-01
 -2.43108684e-01  8.78794172e-01  5.44830649e+00  2.23645193e+01
  8.17976606e+01  2.77160655e+02  9.04971052e+02  3.15735421e+03
  1.26366320e+04  4.12330102e+04  1.05260720e+05  2.30433510e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.6754394788971  E_coul = 198.68481688839933
cycle= 6 E= -507.990622590498  delta_E= -7.11e-12  |g|= 9.16e-08  |ddm|= 1.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6754394788971  E_coul = 198.68481688839933
  HOMO = -0.243108726752863  LUMO = 0.878794147471206
  mo_energy =
[-1.20327229e+02 -1.23814462e+01 -6.67843522e+00 -6.67843522e+00
 -6.67843522e+00 -1.17959586e+00 -2.43108727e-01 -2.43108727e-01
 -2.43108727e-01  8.78794147e-01  5.44830643e+00  2.23645192e+01
  8.17976605e+01  2.77160655e+02  9.04971052e+02  3.15735421e+03
  1.26366320e+04  4.12330102e+04  1.05260720e+05  2.30433510e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.6754392909218  E_coul = 198.6848167004241
Extra cycle  E= -507.990622590498  delta_E= 1.71e-13  |g|= 1.18e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      8.47 sec, wall time      0.59 sec
exp = [2.28793227e-01 5.96267554e-01 1.82281580e+00 1.17616813e+05
 4.06085126e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104174e+04 3.67547010e+04 7.30228501e+03
 1.83757699e+04 1.44380411e+03 4.17403996e+02 1.47763434e+02
 5.85580972e+01 2.47968256e+01 9.08964316e+00 8.60425505e+00
 4.92745764e-01]
E = -507.99062259049765
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228793226647       1
[INPUT] 0    0    [1    /1   ]  0.596267553581       1
[INPUT] 0    0    [1    /1   ]  1.82281580289        1
[INPUT] 0    0    [1    /1   ]  117616.812846        1
[INPUT] 0    0    [1    /1   ]  4.06085125748        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030915        1
[INPUT] 0    0    [1    /1   ]  147020.991297        1
[INPUT] 0    0    [1    /1   ]  73510.4174372        1
[INPUT] 0    0    [1    /1   ]  36754.7009561        1
[INPUT] 0    0    [1    /1   ]  7302.28501412        1
[INPUT] 0    0    [1    /1   ]  18375.7699212        1
[INPUT] 0    0    [1    /1   ]  1443.80411186        1
[INPUT] 0    0    [1    /1   ]  417.403996097        1
[INPUT] 0    0    [1    /1   ]  147.76343448         1
[INPUT] 0    0    [1    /1   ]  58.5580971557        1
[INPUT] 0    0    [1    /1   ]  24.7968256011        1
[INPUT] 0    0    [1    /1   ]  9.08964316439        1
[INPUT] 1    0    [1    /1   ]  8.60425505051        1
[INPUT] 1    0    [1    /1   ]  0.492745763922       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22879322664654686, 1.0]], [0, [0.5962675535812053, 1.0]], [0, [1.8228158028884096, 1.0]], [0, [117616.81284604917, 1.0]], [0, [4.060851257479989, 1.0]], [0, [1176168.1426131635, 1.0]], [0, [588084.0699553115, 1.0]], [0, [294042.0309146953, 1.0]], [0, [147020.99129668644, 1.0]], [0, [73510.41743718096, 1.0]], [0, [36754.700956076944, 1.0]], [0, [7302.285014118778, 1.0]], [0, [18375.769921232524, 1.0]], [0, [1443.8041118570452, 1.0]], [0, [417.40399609680736, 1.0]], [0, [147.76343448025779, 1.0]], [0, [58.55809715569396, 1.0]], [0, [24.796825601093733, 1.0]], [0, [9.089643164389658, 1.0]], [1, [8.604255050510316, 1.0]], [1, [0.49274576392230923, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22879323]
bas 1, expnt(s) = [0.59626755]
bas 2, expnt(s) = [1.8228158]
bas 3, expnt(s) = [117616.81284605]
bas 4, expnt(s) = [4.06085126]
bas 5, expnt(s) = [1176168.14261316]
bas 6, expnt(s) = [588084.06995531]
bas 7, expnt(s) = [294042.0309147]
bas 8, expnt(s) = [147020.99129669]
bas 9, expnt(s) = [73510.41743718]
bas 10, expnt(s) = [36754.70095608]
bas 11, expnt(s) = [7302.28501412]
bas 12, expnt(s) = [18375.76992123]
bas 13, expnt(s) = [1443.80411186]
bas 14, expnt(s) = [417.4039961]
bas 15, expnt(s) = [147.76343448]
bas 16, expnt(s) = [58.55809716]
bas 17, expnt(s) = [24.7968256]
bas 18, expnt(s) = [9.08964316]
bas 19, expnt(s) = [8.60425505]
bas 20, expnt(s) = [0.49274576]
CPU time:      1376.85
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28793227e-01 8.35790435e-01 5.96267554e-01 1.71433585e+00
 1.82281580e+00 3.96343840e+00 1.17616813e+05 1.60460108e+04
 4.06085126e+00 7.22732918e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104174e+04 1.12791583e+04
 3.67547010e+04 6.70655815e+03 7.30228501e+03 1.99576365e+03
 1.83757699e+04 3.98748610e+03 1.44380411e+03 5.91760851e+02
 4.17403996e+02 2.33309529e+02 1.47763434e+02 1.07075536e+02
 5.85580972e+01 5.34817046e+01 2.47968256e+01 2.80745039e+01
 9.08964316e+00 1.32258974e+01 8.60425505e+00 4.29908455e+01
 4.92745764e-01 1.20437856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336089144881743
cond(S) = 912655.1982660529
E1 = -689.5961024276675  E_coul = 184.97126223830392
init E= -504.624840189364
    CPU time for initialize scf      7.35 sec, wall time      0.36 sec
  HOMO = -0.672181087519378  LUMO = 0.537152330506639
  mo_energy =
[-1.21709814e+02 -1.33863234e+01 -7.62360756e+00 -7.62360756e+00
 -7.62360756e+00 -1.65758957e+00 -6.72181088e-01 -6.72181088e-01
 -6.72181088e-01  5.37152331e-01  4.85697627e+00  2.14788190e+01
  8.06206196e+01  2.75824348e+02  9.03612465e+02  3.15606988e+03
  1.26354648e+04  4.12319142e+04  1.05259663e+05  2.30432478e+05
  4.56239762e+05  8.45186202e+05  1.52835783e+06  2.85061829e+06
  5.80849667e+06]
E1 = -707.7548058008848  E_coul = 199.7822639732409
cycle= 1 E= -507.972541827644  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.759416
diis-c [-0.57671283  1.        ]
  HOMO = -0.217634038462787  LUMO = 0.883257073048675
  mo_energy =
[-1.20200158e+02 -1.23047602e+01 -6.59399997e+00 -6.59399997e+00
 -6.59399997e+00 -1.16332808e+00 -2.17634038e-01 -2.17634038e-01
 -2.17634038e-01  8.83257073e-01  5.48080999e+00  2.24294367e+01
  8.18915711e+01  2.77276813e+02  9.05104005e+02  3.15750222e+03
  1.26367907e+04  4.12331730e+04  1.05260884e+05  2.30433676e+05
  4.56240942e+05  8.45187369e+05  1.52835899e+06  2.85061944e+06
  5.80849781e+06]
E1 = -706.799939280449  E_coul = 198.80958426556938
cycle= 2 E= -507.99035501488  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.393
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0348399
diis-c [-0.00120868 -0.00299737  1.00299737]
  HOMO = -0.239808745221776  LUMO = 0.879586360015987
  mo_energy =
[-1.20315163e+02 -1.23725596e+01 -6.66907223e+00 -6.66907223e+00
 -6.66907223e+00 -1.17759594e+00 -2.39808745e-01 -2.39808745e-01
 -2.39808745e-01  8.79586360e-01  5.45268571e+00  2.23722085e+01
  8.18076265e+01  2.77172053e+02  9.04983353e+02  3.15736721e+03
  1.26366454e+04  4.12330239e+04  1.05260734e+05  2.30433524e+05
  4.56240790e+05  8.45187216e+05  1.52835884e+06  2.85061928e+06
  5.80849765e+06]
E1 = -706.6914725868133  E_coul = 198.70085508259112
cycle= 3 E= -507.990617504222  delta_E= -0.000262  |g|= 0.00435  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381854
diis-c [-3.26930569e-06  1.14519440e-04 -1.07273488e-01  1.10715897e+00]
  HOMO = -0.242957213948579  LUMO = 0.878839529187508
  mo_energy =
[-1.20326882e+02 -1.23811044e+01 -6.67809773e+00 -6.67809773e+00
 -6.67809773e+00 -1.17950383e+00 -2.42957214e-01 -2.42957214e-01
 -2.42957214e-01  8.78839529e-01  5.44851350e+00  2.23648247e+01
  8.17979981e+01  2.77160999e+02  9.04971400e+02  3.15735456e+03
  1.26366323e+04  4.12330106e+04  1.05260720e+05  2.30433511e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.6761703384826  E_coul = 198.68554776228152
cycle= 4 E= -507.990622576201  delta_E= -5.07e-06  |g|= 0.000233  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173648
diis-c [-5.69451704e-10 -9.47583933e-06  6.87335312e-03 -9.77905030e-02
  1.09092663e+00]
  HOMO = -0.243105954234857  LUMO = 0.878794942030596
  mo_energy =
[-1.20327223e+02 -1.23814408e+01 -6.67842977e+00 -6.67842977e+00
 -6.67842977e+00 -1.17959396e+00 -2.43105954e-01 -2.43105954e-01
 -2.43105954e-01  8.78794942e-01  5.44831027e+00  2.23645243e+01
  8.17976661e+01  2.77160661e+02  9.04971059e+02  3.15735422e+03
  1.26366320e+04  4.12330102e+04  1.05260720e+05  2.30433510e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.675453311391  E_coul = 198.68483072090035
cycle= 5 E= -507.990622590491  delta_E= -1.43e-08  |g|= 5.94e-06  |ddm|= 0.000676
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.63602e-06
diis-c [-9.41643353e-13  6.10401000e-07 -5.60327030e-04  7.59501794e-03
 -9.09109776e-02  1.08387568e+00]
  HOMO = -0.243108684243185  LUMO = 0.878794172423484
  mo_energy =
[-1.20327229e+02 -1.23814461e+01 -6.67843513e+00 -6.67843513e+00
 -6.67843513e+00 -1.17959584e+00 -2.43108684e-01 -2.43108684e-01
 -2.43108684e-01  8.78794172e-01  5.44830649e+00  2.23645193e+01
  8.17976606e+01  2.77160655e+02  9.04971052e+02  3.15735421e+03
  1.26366320e+04  4.12330102e+04  1.05260720e+05  2.30433510e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.6754394788971  E_coul = 198.68481688839933
cycle= 6 E= -507.990622590498  delta_E= -7.11e-12  |g|= 9.16e-08  |ddm|= 1.78e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6754394788971  E_coul = 198.68481688839933
  HOMO = -0.243108726752863  LUMO = 0.878794147471206
  mo_energy =
[-1.20327229e+02 -1.23814462e+01 -6.67843522e+00 -6.67843522e+00
 -6.67843522e+00 -1.17959586e+00 -2.43108727e-01 -2.43108727e-01
 -2.43108727e-01  8.78794147e-01  5.44830643e+00  2.23645192e+01
  8.17976605e+01  2.77160655e+02  9.04971052e+02  3.15735421e+03
  1.26366320e+04  4.12330102e+04  1.05260720e+05  2.30433510e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.6754392909218  E_coul = 198.6848167004241
Extra cycle  E= -507.990622590498  delta_E= 1.71e-13  |g|= 1.18e-08  |ddm|= 2.23e-07
    CPU time for scf_cycle      8.19 sec, wall time      0.58 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912655.1982660529
E1 = -706.6754392909218  E_coul = 198.6848167004241
init E= -507.990622590498
    CPU time for initialize scf      5.62 sec, wall time      0.24 sec
  HOMO = -0.243108732856278  LUMO = 0.878794146675993
  mo_energy =
[-1.20327229e+02 -1.23814462e+01 -6.67843523e+00 -6.67843523e+00
 -6.67843523e+00 -1.17959586e+00 -2.43108733e-01 -2.43108733e-01
 -2.43108733e-01  8.78794147e-01  5.44830642e+00  2.23645192e+01
  8.17976605e+01  2.77160654e+02  9.04971052e+02  3.15735421e+03
  1.26366320e+04  4.12330102e+04  1.05260720e+05  2.30433510e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.6754392600374  E_coul = 198.68481666953883
cycle= 1 E= -507.990622590499  delta_E= -9.09e-13  |g|= 2.23e-09  |ddm|= 3.12e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6754392600374  E_coul = 198.68481666953883
  HOMO = -0.243108733820478  LUMO = 0.878794146290329
  mo_energy =
[-1.20327229e+02 -1.23814462e+01 -6.67843523e+00 -6.67843523e+00
 -6.67843523e+00 -1.17959586e+00 -2.43108734e-01 -2.43108734e-01
 -2.43108734e-01  8.78794146e-01  5.44830642e+00  2.23645192e+01
  8.17976605e+01  2.77160654e+02  9.04971052e+02  3.15735421e+03
  1.26366320e+04  4.12330102e+04  1.05260720e+05  2.30433510e+05
  4.56240777e+05  8.45187203e+05  1.52835882e+06  2.85061927e+06
  5.80849764e+06]
E1 = -706.6754392542946  E_coul = 198.6848166637966
Extra cycle  E= -507.990622590498  delta_E= 5.68e-13  |g|= 1.87e-09  |ddm|= 4.85e-09
    CPU time for scf_cycle      6.13 sec, wall time      0.40 sec
exp = [2.28793227e-01 5.96267554e-01 1.82281580e+00 1.17616813e+05
 4.06085126e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104174e+04 3.67547010e+04 7.30228501e+03
 1.83757699e+04 1.44380411e+03 4.17403996e+02 1.47763434e+02
 5.85580972e+01 2.47968256e+01 9.08964316e+00 8.60425505e+00
 4.92745764e-01]
grad_E = [ 5.34160518e-04 -3.06975919e-04 -3.65982437e-05  6.06043915e-09
  4.52858977e-05  4.04202089e-11  1.74094609e-10  9.40024512e-10
  3.71401377e-09  1.55090166e-08  8.08988366e-08  5.10006846e-06
  1.98288694e-07 -3.85780398e-05 -5.08374351e-06  3.34079573e-06
 -4.46135680e-05 -9.18834492e-06  5.04600079e-06 -1.95567828e-05
 -2.34233892e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228874825356       1
[INPUT] 0    0    [1    /1   ]  0.596351815151       1
[INPUT] 0    0    [1    /1   ]  1.83414350952        1
[INPUT] 0    0    [1    /1   ]  117616.812828        1
[INPUT] 0    0    [1    /1   ]  4.08034365612        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030912        1
[INPUT] 0    0    [1    /1   ]  147020.991286        1
[INPUT] 0    0    [1    /1   ]  73510.4173911        1
[INPUT] 0    0    [1    /1   ]  36754.7007157        1
[INPUT] 0    0    [1    /1   ]  7302.26986103        1
[INPUT] 0    0    [1    /1   ]  18375.7693317        1
[INPUT] 0    0    [1    /1   ]  1443.91966259        1
[INPUT] 0    0    [1    /1   ]  417.409603874        1
[INPUT] 0    0    [1    /1   ]  147.793349896        1
[INPUT] 0    0    [1    /1   ]  58.5941973712        1
[INPUT] 0    0    [1    /1   ]  24.9074336607        1
[INPUT] 0    0    [1    /1   ]  9.10897174216        1
[INPUT] 1    0    [1    /1   ]  8.60423492677        1
[INPUT] 1    0    [1    /1   ]  0.492742017603       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22887482535560694, 1.0]], [0, [0.5963518151512216, 1.0]], [0, [1.8341435095150178, 1.0]], [0, [117616.81282804048, 1.0]], [0, [4.080343656120111, 1.0]], [0, [1176168.142613043, 1.0]], [0, [588084.069954794, 1.0]], [0, [294042.0309119021, 1.0]], [0, [147020.99128564994, 1.0]], [0, [73510.41739109333, 1.0]], [0, [36754.70071571202, 1.0]], [0, [7302.269861026543, 1.0]], [0, [18375.769331681855, 1.0]], [0, [1443.9196625859674, 1.0]], [0, [417.4096038735704, 1.0]], [0, [147.7933498959275, 1.0]], [0, [58.59419737117801, 1.0]], [0, [24.907433660660864, 1.0]], [0, [9.108971742161593, 1.0]], [1, [8.604234926765733, 1.0]], [1, [0.49274201760307845, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22887483]
bas 1, expnt(s) = [0.59635182]
bas 2, expnt(s) = [1.83414351]
bas 3, expnt(s) = [117616.81282804]
bas 4, expnt(s) = [4.08034366]
bas 5, expnt(s) = [1176168.14261304]
bas 6, expnt(s) = [588084.06995479]
bas 7, expnt(s) = [294042.0309119]
bas 8, expnt(s) = [147020.99128565]
bas 9, expnt(s) = [73510.41739109]
bas 10, expnt(s) = [36754.70071571]
bas 11, expnt(s) = [7302.26986103]
bas 12, expnt(s) = [18375.76933168]
bas 13, expnt(s) = [1443.91966259]
bas 14, expnt(s) = [417.40960387]
bas 15, expnt(s) = [147.7933499]
bas 16, expnt(s) = [58.59419737]
bas 17, expnt(s) = [24.90743366]
bas 18, expnt(s) = [9.10897174]
bas 19, expnt(s) = [8.60423493]
bas 20, expnt(s) = [0.49274202]
CPU time:      1398.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28874825e-01 8.36013987e-01 5.96351815e-01 1.71451754e+00
 1.83414351e+00 3.98189688e+00 1.17616813e+05 1.60460108e+04
 4.08034366e+00 7.25333240e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104174e+04 1.12791583e+04
 3.67547007e+04 6.70655812e+03 7.30226986e+03 1.99576055e+03
 1.83757693e+04 3.98748601e+03 1.44391966e+03 5.91796370e+02
 4.17409604e+02 2.33311879e+02 1.47793350e+02 1.07091794e+02
 5.85941974e+01 5.35064307e+01 2.49074337e+01 2.81683729e+01
 9.10897174e+00 1.32469849e+01 8.60423493e+00 4.29907199e+01
 4.92742018e-01 1.20436712e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336092828031898
cond(S) = 912672.5555910624
E1 = -689.5961217633704  E_coul = 184.97097939141455
init E= -504.625142371956
    CPU time for initialize scf      0.78 sec, wall time      0.07 sec
  HOMO = -0.672188810687202  LUMO = 0.537948346198578
  mo_energy =
[-1.21709850e+02 -1.33863492e+01 -7.62362603e+00 -7.62362603e+00
 -7.62362603e+00 -1.65759232e+00 -6.72188811e-01 -6.72188811e-01
 -6.72188811e-01  5.37948346e-01  4.88221280e+00  2.15981507e+01
  8.09741467e+01  2.76478754e+02  9.04434707e+02  3.15701424e+03
  1.26365505e+04  4.12330035e+04  1.05260719e+05  2.30433506e+05
  4.56240768e+05  8.45187190e+05  1.52835881e+06  2.85061924e+06
  5.80849760e+06]
E1 = -707.7544251889942  E_coul = 199.7818747888354
cycle= 1 E= -507.972550400159  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.759514
diis-c [-0.57686127  1.        ]
  HOMO = -0.217644290839038  LUMO = 0.884347290970155
  mo_energy =
[-1.20200205e+02 -1.23047944e+01 -6.59402673e+00 -6.59402673e+00
 -6.59402673e+00 -1.16333380e+00 -2.17644291e-01 -2.17644291e-01
 -2.17644291e-01  8.84347291e-01  5.50755045e+00  2.25501651e+01
  8.22458109e+01  2.77931303e+02  9.05926227e+02  3.15844657e+03
  1.26378764e+04  4.12342623e+04  1.05261941e+05  2.30434703e+05
  4.56241948e+05  8.45188357e+05  1.52835996e+06  2.85062039e+06
  5.80849873e+06]
E1 = -706.7997005299677  E_coul = 198.8093402690013
cycle= 2 E= -507.990360260966  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.394
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347869
diis-c [-0.00120518 -0.00293959  1.00293959]
  HOMO = -0.239812988609024  LUMO = 0.880662710638146
  mo_energy =
[-1.20315190e+02 -1.23725793e+01 -6.66908392e+00 -6.66908392e+00
 -6.66908392e+00 -1.17759768e+00 -2.39812989e-01 -2.39812989e-01
 -2.39812989e-01  8.80662711e-01  5.47931070e+00  2.24928330e+01
  8.21618139e+01  2.77826546e+02  9.05805597e+02  3.15831159e+03
  1.26377312e+04  4.12341132e+04  1.05261790e+05  2.30434551e+05
  4.56241796e+05  8.45188205e+05  1.52835981e+06  2.85062024e+06
  5.80849858e+06]
E1 = -706.6912519300712  E_coul = 198.70062921054017
cycle= 3 E= -507.990622719531  delta_E= -0.000262  |g|= 0.00436  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381097
diis-c [-3.25990359e-06  1.14235174e-04 -1.07196402e-01  1.10708217e+00]
  HOMO = -0.242961828164607  LUMO = 0.879913536575632
  mo_energy =
[-1.20326914e+02 -1.23811260e+01 -6.67811169e+00 -6.67811169e+00
 -6.67811169e+00 -1.17950583e+00 -2.42961828e-01 -2.42961828e-01
 -2.42961828e-01  8.79913537e-01  5.47512207e+00  2.24854363e+01
  8.21521775e+01  2.77815488e+02  9.05793638e+02  3.15829893e+03
  1.26377181e+04  4.12340999e+04  1.05261777e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6759465790234  E_coul = 198.6853187851857
cycle= 4 E= -507.990627793838  delta_E= -5.07e-06  |g|= 0.000234  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173623
diis-c [-5.65714470e-10 -9.45798708e-06  6.87939268e-03 -9.79457134e-02
  1.09107578e+00]
  HOMO = -0.24311093246575  LUMO = 0.879868767430267
  mo_energy =
[-1.20327255e+02 -1.23814636e+01 -6.67844492e+00 -6.67844492e+00
 -6.67844492e+00 -1.17959618e+00 -2.43110932e-01 -2.43110932e-01
 -2.43110932e-01  8.79868767e-01  5.47491771e+00  2.24851346e+01
  8.21518442e+01  2.77815148e+02  9.05793296e+02  3.15829858e+03
  1.26377177e+04  4.12340995e+04  1.05261776e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6752277395677  E_coul = 198.68459993140573
cycle= 5 E= -507.990627808162  delta_E= -1.43e-08  |g|= 5.9e-06  |ddm|= 0.000675
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.61978e-06
diis-c [-9.32277077e-13  6.11097043e-07 -5.58158507e-04  7.57081308e-03
 -9.04925740e-02  1.08347931e+00]
  HOMO = -0.243113649505468  LUMO = 0.879868002505427
  mo_energy =
[-1.20327262e+02 -1.23814689e+01 -6.67845027e+00 -6.67845027e+00
 -6.67845027e+00 -1.17959804e+00 -2.43113650e-01 -2.43113650e-01
 -2.43113650e-01  8.79868003e-01  5.47491394e+00  2.24851297e+01
  8.21518387e+01  2.77815142e+02  9.05793289e+02  3.15829858e+03
  1.26377177e+04  4.12340995e+04  1.05261776e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6752139728324  E_coul = 198.68458616466248
cycle= 6 E= -507.99062780817  delta_E= -7.84e-12  |g|= 9.13e-08  |ddm|= 1.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6752139728324  E_coul = 198.68458616466248
  HOMO = -0.243113691922873  LUMO = 0.879867976768582
  mo_energy =
[-1.20327262e+02 -1.23814690e+01 -6.67845035e+00 -6.67845035e+00
 -6.67845035e+00 -1.17959806e+00 -2.43113692e-01 -2.43113692e-01
 -2.43113692e-01  8.79867977e-01  5.47491388e+00  2.24851296e+01
  8.21518386e+01  2.77815142e+02  9.05793289e+02  3.15829858e+03
  1.26377177e+04  4.12340995e+04  1.05261776e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6752137880881  E_coul = 198.68458597991835
Extra cycle  E= -507.99062780817  delta_E= 1.14e-13  |g|= 1.24e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      1.61 sec, wall time      0.29 sec
exp = [2.28874825e-01 5.96351815e-01 1.83414351e+00 1.17616813e+05
 4.08034366e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104174e+04 3.67547007e+04 7.30226986e+03
 1.83757693e+04 1.44391966e+03 4.17409604e+02 1.47793350e+02
 5.85941974e+01 2.49074337e+01 9.10897174e+00 8.60423493e+00
 4.92742018e-01]
E = -507.99062780816973
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.228874825356       1
[INPUT] 0    0    [1    /1   ]  0.596351815151       1
[INPUT] 0    0    [1    /1   ]  1.83414350952        1
[INPUT] 0    0    [1    /1   ]  117616.812828        1
[INPUT] 0    0    [1    /1   ]  4.08034365612        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069955        1
[INPUT] 0    0    [1    /1   ]  294042.030912        1
[INPUT] 0    0    [1    /1   ]  147020.991286        1
[INPUT] 0    0    [1    /1   ]  73510.4173911        1
[INPUT] 0    0    [1    /1   ]  36754.7007157        1
[INPUT] 0    0    [1    /1   ]  7302.26986103        1
[INPUT] 0    0    [1    /1   ]  18375.7693317        1
[INPUT] 0    0    [1    /1   ]  1443.91966259        1
[INPUT] 0    0    [1    /1   ]  417.409603874        1
[INPUT] 0    0    [1    /1   ]  147.793349896        1
[INPUT] 0    0    [1    /1   ]  58.5941973712        1
[INPUT] 0    0    [1    /1   ]  24.9074336607        1
[INPUT] 0    0    [1    /1   ]  9.10897174216        1
[INPUT] 1    0    [1    /1   ]  8.60423492677        1
[INPUT] 1    0    [1    /1   ]  0.492742017603       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22887482535560694, 1.0]], [0, [0.5963518151512216, 1.0]], [0, [1.8341435095150178, 1.0]], [0, [117616.81282804048, 1.0]], [0, [4.080343656120111, 1.0]], [0, [1176168.142613043, 1.0]], [0, [588084.069954794, 1.0]], [0, [294042.0309119021, 1.0]], [0, [147020.99128564994, 1.0]], [0, [73510.41739109333, 1.0]], [0, [36754.70071571202, 1.0]], [0, [7302.269861026543, 1.0]], [0, [18375.769331681855, 1.0]], [0, [1443.9196625859674, 1.0]], [0, [417.4096038735704, 1.0]], [0, [147.7933498959275, 1.0]], [0, [58.59419737117801, 1.0]], [0, [24.907433660660864, 1.0]], [0, [9.108971742161593, 1.0]], [1, [8.604234926765733, 1.0]], [1, [0.49274201760307845, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22887483]
bas 1, expnt(s) = [0.59635182]
bas 2, expnt(s) = [1.83414351]
bas 3, expnt(s) = [117616.81282804]
bas 4, expnt(s) = [4.08034366]
bas 5, expnt(s) = [1176168.14261304]
bas 6, expnt(s) = [588084.06995479]
bas 7, expnt(s) = [294042.0309119]
bas 8, expnt(s) = [147020.99128565]
bas 9, expnt(s) = [73510.41739109]
bas 10, expnt(s) = [36754.70071571]
bas 11, expnt(s) = [7302.26986103]
bas 12, expnt(s) = [18375.76933168]
bas 13, expnt(s) = [1443.91966259]
bas 14, expnt(s) = [417.40960387]
bas 15, expnt(s) = [147.7933499]
bas 16, expnt(s) = [58.59419737]
bas 17, expnt(s) = [24.90743366]
bas 18, expnt(s) = [9.10897174]
bas 19, expnt(s) = [8.60423493]
bas 20, expnt(s) = [0.49274202]
CPU time:      1400.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.28874825e-01 8.36013987e-01 5.96351815e-01 1.71451754e+00
 1.83414351e+00 3.98189688e+00 1.17616813e+05 1.60460108e+04
 4.08034366e+00 7.25333240e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104174e+04 1.12791583e+04
 3.67547007e+04 6.70655812e+03 7.30226986e+03 1.99576055e+03
 1.83757693e+04 3.98748601e+03 1.44391966e+03 5.91796370e+02
 4.17409604e+02 2.33311879e+02 1.47793350e+02 1.07091794e+02
 5.85941974e+01 5.35064307e+01 2.49074337e+01 2.81683729e+01
 9.10897174e+00 1.32469849e+01 8.60423493e+00 4.29907199e+01
 4.92742018e-01 1.20436712e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336092828031898
cond(S) = 912672.5555910624
E1 = -689.5961217633704  E_coul = 184.97097939141455
init E= -504.625142371956
    CPU time for initialize scf      0.67 sec, wall time      0.07 sec
  HOMO = -0.672188810687202  LUMO = 0.537948346198578
  mo_energy =
[-1.21709850e+02 -1.33863492e+01 -7.62362603e+00 -7.62362603e+00
 -7.62362603e+00 -1.65759232e+00 -6.72188811e-01 -6.72188811e-01
 -6.72188811e-01  5.37948346e-01  4.88221280e+00  2.15981507e+01
  8.09741467e+01  2.76478754e+02  9.04434707e+02  3.15701424e+03
  1.26365505e+04  4.12330035e+04  1.05260719e+05  2.30433506e+05
  4.56240768e+05  8.45187190e+05  1.52835881e+06  2.85061924e+06
  5.80849760e+06]
E1 = -707.7544251889942  E_coul = 199.7818747888354
cycle= 1 E= -507.972550400159  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.759514
diis-c [-0.57686127  1.        ]
  HOMO = -0.217644290839038  LUMO = 0.884347290970155
  mo_energy =
[-1.20200205e+02 -1.23047944e+01 -6.59402673e+00 -6.59402673e+00
 -6.59402673e+00 -1.16333380e+00 -2.17644291e-01 -2.17644291e-01
 -2.17644291e-01  8.84347291e-01  5.50755045e+00  2.25501651e+01
  8.22458109e+01  2.77931303e+02  9.05926227e+02  3.15844657e+03
  1.26378764e+04  4.12342623e+04  1.05261941e+05  2.30434703e+05
  4.56241948e+05  8.45188357e+05  1.52835996e+06  2.85062039e+06
  5.80849873e+06]
E1 = -706.7997005299677  E_coul = 198.8093402690013
cycle= 2 E= -507.990360260966  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.394
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347869
diis-c [-0.00120518 -0.00293959  1.00293959]
  HOMO = -0.239812988609024  LUMO = 0.880662710638146
  mo_energy =
[-1.20315190e+02 -1.23725793e+01 -6.66908392e+00 -6.66908392e+00
 -6.66908392e+00 -1.17759768e+00 -2.39812989e-01 -2.39812989e-01
 -2.39812989e-01  8.80662711e-01  5.47931070e+00  2.24928330e+01
  8.21618139e+01  2.77826546e+02  9.05805597e+02  3.15831159e+03
  1.26377312e+04  4.12341132e+04  1.05261790e+05  2.30434551e+05
  4.56241796e+05  8.45188205e+05  1.52835981e+06  2.85062024e+06
  5.80849858e+06]
E1 = -706.6912519300712  E_coul = 198.70062921054017
cycle= 3 E= -507.990622719531  delta_E= -0.000262  |g|= 0.00436  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00381097
diis-c [-3.25990359e-06  1.14235174e-04 -1.07196402e-01  1.10708217e+00]
  HOMO = -0.242961828164607  LUMO = 0.879913536575632
  mo_energy =
[-1.20326914e+02 -1.23811260e+01 -6.67811169e+00 -6.67811169e+00
 -6.67811169e+00 -1.17950583e+00 -2.42961828e-01 -2.42961828e-01
 -2.42961828e-01  8.79913537e-01  5.47512207e+00  2.24854363e+01
  8.21521775e+01  2.77815488e+02  9.05793638e+02  3.15829893e+03
  1.26377181e+04  4.12340999e+04  1.05261777e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6759465790234  E_coul = 198.6853187851857
cycle= 4 E= -507.990627793838  delta_E= -5.07e-06  |g|= 0.000234  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173623
diis-c [-5.65714470e-10 -9.45798708e-06  6.87939268e-03 -9.79457134e-02
  1.09107578e+00]
  HOMO = -0.24311093246575  LUMO = 0.879868767430267
  mo_energy =
[-1.20327255e+02 -1.23814636e+01 -6.67844492e+00 -6.67844492e+00
 -6.67844492e+00 -1.17959618e+00 -2.43110932e-01 -2.43110932e-01
 -2.43110932e-01  8.79868767e-01  5.47491771e+00  2.24851346e+01
  8.21518442e+01  2.77815148e+02  9.05793296e+02  3.15829858e+03
  1.26377177e+04  4.12340995e+04  1.05261776e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6752277395677  E_coul = 198.68459993140573
cycle= 5 E= -507.990627808162  delta_E= -1.43e-08  |g|= 5.9e-06  |ddm|= 0.000675
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.61978e-06
diis-c [-9.32277077e-13  6.11097043e-07 -5.58158507e-04  7.57081308e-03
 -9.04925740e-02  1.08347931e+00]
  HOMO = -0.243113649505468  LUMO = 0.879868002505427
  mo_energy =
[-1.20327262e+02 -1.23814689e+01 -6.67845027e+00 -6.67845027e+00
 -6.67845027e+00 -1.17959804e+00 -2.43113650e-01 -2.43113650e-01
 -2.43113650e-01  8.79868003e-01  5.47491394e+00  2.24851297e+01
  8.21518387e+01  2.77815142e+02  9.05793289e+02  3.15829858e+03
  1.26377177e+04  4.12340995e+04  1.05261776e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6752139728324  E_coul = 198.68458616466248
cycle= 6 E= -507.99062780817  delta_E= -7.84e-12  |g|= 9.13e-08  |ddm|= 1.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6752139728324  E_coul = 198.68458616466248
  HOMO = -0.243113691922873  LUMO = 0.879867976768582
  mo_energy =
[-1.20327262e+02 -1.23814690e+01 -6.67845035e+00 -6.67845035e+00
 -6.67845035e+00 -1.17959806e+00 -2.43113692e-01 -2.43113692e-01
 -2.43113692e-01  8.79867977e-01  5.47491388e+00  2.24851296e+01
  8.21518386e+01  2.77815142e+02  9.05793289e+02  3.15829858e+03
  1.26377177e+04  4.12340995e+04  1.05261776e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6752137880881  E_coul = 198.68458597991835
Extra cycle  E= -507.99062780817  delta_E= 1.14e-13  |g|= 1.24e-08  |ddm|= 2.19e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912672.5555910624
E1 = -706.6752137880881  E_coul = 198.68458597991835
init E= -507.99062780817
    CPU time for initialize scf      5.72 sec, wall time      0.24 sec
  HOMO = -0.243113697929496  LUMO = 0.879867977513108
  mo_energy =
[-1.20327262e+02 -1.23814690e+01 -6.67845037e+00 -6.67845037e+00
 -6.67845037e+00 -1.17959806e+00 -2.43113698e-01 -2.43113698e-01
 -2.43113698e-01  8.79867978e-01  5.47491387e+00  2.24851296e+01
  8.21518386e+01  2.77815142e+02  9.05793289e+02  3.15829858e+03
  1.26377177e+04  4.12340995e+04  1.05261776e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6752137526254  E_coul = 198.68458594445522
cycle= 1 E= -507.99062780817  delta_E= -4.55e-13  |g|= 1.97e-09  |ddm|= 3.45e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6752137526254  E_coul = 198.68458594445522
  HOMO = -0.243113699017894  LUMO = 0.879867976769739
  mo_energy =
[-1.20327262e+02 -1.23814690e+01 -6.67845037e+00 -6.67845037e+00
 -6.67845037e+00 -1.17959806e+00 -2.43113699e-01 -2.43113699e-01
 -2.43113699e-01  8.79867977e-01  5.47491387e+00  2.24851296e+01
  8.21518386e+01  2.77815142e+02  9.05793289e+02  3.15829858e+03
  1.26377177e+04  4.12340995e+04  1.05261776e+05  2.30434538e+05
  4.56241782e+05  8.45188191e+05  1.52835979e+06  2.85062022e+06
  5.80849857e+06]
E1 = -706.6752137486627  E_coul = 198.68458594049335
Extra cycle  E= -507.990627808169  delta_E= 7.96e-13  |g|= 1.68e-09  |ddm|= 3.56e-09
    CPU time for scf_cycle      6.22 sec, wall time      0.41 sec
exp = [2.28874825e-01 5.96351815e-01 1.83414351e+00 1.17616813e+05
 4.08034366e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104174e+04 3.67547007e+04 7.30226986e+03
 1.83757693e+04 1.44391966e+03 4.17409604e+02 1.47793350e+02
 5.85941974e+01 2.49074337e+01 9.10897174e+00 8.60423493e+00
 4.92742018e-01]
grad_E = [ 8.40777949e-04 -4.82960870e-04 -5.75004722e-05  6.04680868e-09
  6.86750257e-05  4.02670221e-11  1.73647600e-10  9.37933591e-10
  3.70557140e-09  1.54733051e-08  8.07266307e-08  5.08941127e-06
  1.97724593e-07 -3.82057764e-05 -7.91104204e-06  1.50709476e-05
 -7.31028467e-05  1.81880108e-05  2.69176081e-06 -3.05849956e-05
 -3.68003807e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229457065998       1
[INPUT] 0    0    [1    /1   ]  0.5981490416         1
[INPUT] 0    0    [1    /1   ]  1.87082694562        1
[INPUT] 0    0    [1    /1   ]  117616.812781        1
[INPUT] 0    0    [1    /1   ]  4.13442557053        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069953        1
[INPUT] 0    0    [1    /1   ]  294042.030905        1
[INPUT] 0    0    [1    /1   ]  147020.991257        1
[INPUT] 0    0    [1    /1   ]  73510.4172707        1
[INPUT] 0    0    [1    /1   ]  36754.700088         1
[INPUT] 0    0    [1    /1   ]  7302.23029064        1
[INPUT] 0    0    [1    /1   ]  18375.7677923        1
[INPUT] 0    0    [1    /1   ]  1444.22086773        1
[INPUT] 0    0    [1    /1   ]  417.429986086        1
[INPUT] 0    0    [1    /1   ]  147.848392219        1
[INPUT] 0    0    [1    /1   ]  58.7334751687        1
[INPUT] 0    0    [1    /1   ]  25.1628701185        1
[INPUT] 0    0    [1    /1   ]  9.1698290019         1
[INPUT] 1    0    [1    /1   ]  8.60421186789        1
[INPUT] 1    0    [1    /1   ]  0.492737719145       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2294570659982554, 1.0]], [0, [0.5981490415999787, 1.0]], [0, [1.8708269456168967, 1.0]], [0, [117616.81278101332, 1.0]], [0, [4.134425570525538, 1.0]], [0, [1176168.142612729, 1.0]], [0, [588084.0699534428, 1.0]], [0, [294042.0309046079, 1.0]], [0, [147020.9912568298, 1.0]], [0, [73510.41727074298, 1.0]], [0, [36754.700088021105, 1.0]], [0, [7302.23029063908, 1.0]], [0, [18375.76779229818, 1.0]], [0, [1444.2208677280073, 1.0]], [0, [417.42998608601437, 1.0]], [0, [147.84839221946808, 1.0]], [0, [58.73347516873566, 1.0]], [0, [25.16287011852542, 1.0]], [0, [9.169829001898776, 1.0]], [1, [8.604211867886573, 1.0]], [1, [0.4927377191454778, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22945707]
bas 1, expnt(s) = [0.59814904]
bas 2, expnt(s) = [1.87082695]
bas 3, expnt(s) = [117616.81278101]
bas 4, expnt(s) = [4.13442557]
bas 5, expnt(s) = [1176168.14261273]
bas 6, expnt(s) = [588084.06995344]
bas 7, expnt(s) = [294042.03090461]
bas 8, expnt(s) = [147020.99125683]
bas 9, expnt(s) = [73510.41727074]
bas 10, expnt(s) = [36754.70008802]
bas 11, expnt(s) = [7302.23029064]
bas 12, expnt(s) = [18375.7677923]
bas 13, expnt(s) = [1444.22086773]
bas 14, expnt(s) = [417.42998609]
bas 15, expnt(s) = [147.84839222]
bas 16, expnt(s) = [58.73347517]
bas 17, expnt(s) = [25.16287012]
bas 18, expnt(s) = [9.169829]
bas 19, expnt(s) = [8.60421187]
bas 20, expnt(s) = [0.49273772]
CPU time:      1415.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29457066e-01 8.37608549e-01 5.98149042e-01 1.71839137e+00
 1.87082695e+00 4.04147816e+00 1.17616813e+05 1.60460108e+04
 4.13442557e+00 7.32531674e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104173e+04 1.12791583e+04
 3.67547001e+04 6.70655803e+03 7.30223029e+03 1.99575244e+03
 1.83757678e+04 3.98748576e+03 1.44422087e+03 5.91888955e+02
 4.17429986e+02 2.33320424e+02 1.47848392e+02 1.07121706e+02
 5.87334752e+01 5.36017906e+01 2.51628701e+01 2.83847554e+01
 9.16982900e+00 1.33133072e+01 8.60421187e+00 4.29905758e+01
 4.92737719e-01 1.20435398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33609499718546
cond(S) = 912720.3469063402
E1 = -689.5961883683598  E_coul = 184.97060462487997
init E= -504.62558374348
    CPU time for initialize scf      0.73 sec, wall time      0.07 sec
  HOMO = -0.672198849083954  LUMO = 0.542455556391919
  mo_energy =
[-1.21709900e+02 -1.33863861e+01 -7.62365138e+00 -7.62365138e+00
 -7.62365138e+00 -1.65759173e+00 -6.72198849e-01 -6.72198849e-01
 -6.72198849e-01  5.42455556e-01  4.96793862e+00  2.19604293e+01
  8.19497339e+01  2.78242945e+02  9.06644424e+02  3.15953633e+03
  1.26394361e+04  4.12358949e+04  1.05263523e+05  2.30436232e+05
  4.56243435e+05  8.45189813e+05  1.52836139e+06  2.85062177e+06
  5.80850006e+06]
E1 = -707.7538460079746  E_coul = 199.78127727534977
cycle= 1 E= -507.972568732625  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.759831
diis-c [-0.57734376  1.        ]
  HOMO = -0.217659430483553  LUMO = 0.890144350733012
  mo_energy =
[-1.20200274e+02 -1.23048484e+01 -6.59406980e+00 -6.59406980e+00
 -6.59406980e+00 -1.16334046e+00 -2.17659430e-01 -2.17659430e-01
 -2.17659430e-01  8.90144351e-01  5.59794354e+00  2.29163353e+01
  8.32231642e+01  2.79695702e+02  9.08135895e+02  3.16096863e+03
  1.26407620e+04  4.12371536e+04  1.05264745e+05  2.30437429e+05
  4.56244615e+05  8.45190980e+05  1.52836254e+06  2.85062292e+06
  5.80850120e+06]
E1 = -706.7994088815784  E_coul = 198.80903637462683
cycle= 2 E= -507.990372506952  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0346202
diis-c [-0.00119412 -0.00278362  1.00278362]
  HOMO = -0.239815900068974  LUMO = 0.886401374319486
  mo_energy =
[-1.20315215e+02 -1.23726014e+01 -6.66909310e+00 -6.66909310e+00
 -6.66909310e+00 -1.17759605e+00 -2.39815900e-01 -2.39815900e-01
 -2.39815900e-01  8.86401374e-01  5.56932563e+00  2.28587002e+01
  8.31390294e+01  2.79590949e+02  9.08015314e+02  3.16083370e+03
  1.26406169e+04  4.12370046e+04  1.05264594e+05  2.30437277e+05
  4.56244463e+05  8.45190828e+05  1.52836239e+06  2.85062276e+06
  5.80850104e+06]
E1 = -706.6910283559831  E_coul = 198.7003935963871
cycle= 3 E= -507.990634759596  delta_E= -0.000262  |g|= 0.00436  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00378469
diis-c [-3.22997588e-06  1.15532191e-04 -1.06861937e-01  1.10674640e+00]
  HOMO = -0.242964402490833  LUMO = 0.885643079957164
  mo_energy =
[-1.20326947e+02 -1.23811506e+01 -6.67812432e+00 -6.67812432e+00
 -6.67812432e+00 -1.17950398e+00 -2.42964402e-01 -2.42964402e-01
 -2.42964402e-01  8.85643080e-01  5.56508679e+00  2.28512693e+01
  8.31293753e+01  2.79579881e+02  9.08003347e+02  3.16082103e+03
  1.26406037e+04  4.12369913e+04  1.05264581e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836238e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6757281975067  E_coul = 198.68508836804867
cycle= 4 E= -507.990639829458  delta_E= -5.07e-06  |g|= 0.000234  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173392
diis-c [-5.48029178e-10 -9.39625112e-06  6.88686747e-03 -9.83642963e-02
  1.09148683e+00]
  HOMO = -0.243114491022295  LUMO = 0.885597697751012
  mo_energy =
[-1.20327293e+02 -1.23814915e+01 -6.67846115e+00 -6.67846115e+00
 -6.67846115e+00 -1.17959488e+00 -2.43114491e-01 -2.43114491e-01
 -2.43114491e-01  8.85597698e-01  5.56487907e+00  2.28509640e+01
  8.31290379e+01  2.79579536e+02  9.08002999e+02  3.16082068e+03
  1.26406034e+04  4.12369909e+04  1.05264580e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836237e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6750049337145  E_coul = 198.68436508989197
cycle= 5 E= -507.990639843823  delta_E= -1.44e-08  |g|= 5.73e-06  |ddm|= 0.00067
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.54979e-06
diis-c [-9.03104423e-13  6.03505343e-07 -5.48109749e-04  7.45825563e-03
 -8.87837301e-02  1.08187298e+00]
  HOMO = -0.243117150483926  LUMO = 0.885596947908424
  mo_energy =
[-1.20327299e+02 -1.23814967e+01 -6.67846641e+00 -6.67846641e+00
 -6.67846641e+00 -1.17959671e+00 -2.43117150e-01 -2.43117150e-01
 -2.43117150e-01  8.85596948e-01  5.56487535e+00  2.28509592e+01
  8.31290325e+01  2.79579530e+02  9.08002993e+02  3.16082067e+03
  1.26406034e+04  4.12369909e+04  1.05264580e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836237e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6749914685706  E_coul = 198.6843516247412
cycle= 6 E= -507.990639843829  delta_E= -6.88e-12  |g|= 9.08e-08  |ddm|= 1.69e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6749914685706  E_coul = 198.6843516247412
  HOMO = -0.243117193039717  LUMO = 0.885596924662405
  mo_energy =
[-1.20327300e+02 -1.23814968e+01 -6.67846650e+00 -6.67846650e+00
 -6.67846650e+00 -1.17959672e+00 -2.43117193e-01 -2.43117193e-01
 -2.43117193e-01  8.85596925e-01  5.56487529e+00  2.28509591e+01
  8.31290324e+01  2.79579530e+02  9.08002993e+02  3.16082067e+03
  1.26406034e+04  4.12369909e+04  1.05264580e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836237e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6749912806404  E_coul = 198.68435143681066
Extra cycle  E= -507.99063984383  delta_E= -3.41e-13  |g|= 1.1e-08  |ddm|= 2.2e-07
    CPU time for scf_cycle      1.57 sec, wall time      0.29 sec
exp = [2.29457066e-01 5.98149042e-01 1.87082695e+00 1.17616813e+05
 4.13442557e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104173e+04 3.67547001e+04 7.30223029e+03
 1.83757678e+04 1.44422087e+03 4.17429986e+02 1.47848392e+02
 5.87334752e+01 2.51628701e+01 9.16982900e+00 8.60421187e+00
 4.92737719e-01]
E = -507.99063984382974
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:35:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229457065998       1
[INPUT] 0    0    [1    /1   ]  0.5981490416         1
[INPUT] 0    0    [1    /1   ]  1.87082694562        1
[INPUT] 0    0    [1    /1   ]  117616.812781        1
[INPUT] 0    0    [1    /1   ]  4.13442557053        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069953        1
[INPUT] 0    0    [1    /1   ]  294042.030905        1
[INPUT] 0    0    [1    /1   ]  147020.991257        1
[INPUT] 0    0    [1    /1   ]  73510.4172707        1
[INPUT] 0    0    [1    /1   ]  36754.700088         1
[INPUT] 0    0    [1    /1   ]  7302.23029064        1
[INPUT] 0    0    [1    /1   ]  18375.7677923        1
[INPUT] 0    0    [1    /1   ]  1444.22086773        1
[INPUT] 0    0    [1    /1   ]  417.429986086        1
[INPUT] 0    0    [1    /1   ]  147.848392219        1
[INPUT] 0    0    [1    /1   ]  58.7334751687        1
[INPUT] 0    0    [1    /1   ]  25.1628701185        1
[INPUT] 0    0    [1    /1   ]  9.1698290019         1
[INPUT] 1    0    [1    /1   ]  8.60421186789        1
[INPUT] 1    0    [1    /1   ]  0.492737719145       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2294570659982554, 1.0]], [0, [0.5981490415999787, 1.0]], [0, [1.8708269456168967, 1.0]], [0, [117616.81278101332, 1.0]], [0, [4.134425570525538, 1.0]], [0, [1176168.142612729, 1.0]], [0, [588084.0699534428, 1.0]], [0, [294042.0309046079, 1.0]], [0, [147020.9912568298, 1.0]], [0, [73510.41727074298, 1.0]], [0, [36754.700088021105, 1.0]], [0, [7302.23029063908, 1.0]], [0, [18375.76779229818, 1.0]], [0, [1444.2208677280073, 1.0]], [0, [417.42998608601437, 1.0]], [0, [147.84839221946808, 1.0]], [0, [58.73347516873566, 1.0]], [0, [25.16287011852542, 1.0]], [0, [9.169829001898776, 1.0]], [1, [8.604211867886573, 1.0]], [1, [0.4927377191454778, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22945707]
bas 1, expnt(s) = [0.59814904]
bas 2, expnt(s) = [1.87082695]
bas 3, expnt(s) = [117616.81278101]
bas 4, expnt(s) = [4.13442557]
bas 5, expnt(s) = [1176168.14261273]
bas 6, expnt(s) = [588084.06995344]
bas 7, expnt(s) = [294042.03090461]
bas 8, expnt(s) = [147020.99125683]
bas 9, expnt(s) = [73510.41727074]
bas 10, expnt(s) = [36754.70008802]
bas 11, expnt(s) = [7302.23029064]
bas 12, expnt(s) = [18375.7677923]
bas 13, expnt(s) = [1444.22086773]
bas 14, expnt(s) = [417.42998609]
bas 15, expnt(s) = [147.84839222]
bas 16, expnt(s) = [58.73347517]
bas 17, expnt(s) = [25.16287012]
bas 18, expnt(s) = [9.169829]
bas 19, expnt(s) = [8.60421187]
bas 20, expnt(s) = [0.49273772]
CPU time:      1417.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29457066e-01 8.37608549e-01 5.98149042e-01 1.71839137e+00
 1.87082695e+00 4.04147816e+00 1.17616813e+05 1.60460108e+04
 4.13442557e+00 7.32531674e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692227e+04 7.35104173e+04 1.12791583e+04
 3.67547001e+04 6.70655803e+03 7.30223029e+03 1.99575244e+03
 1.83757678e+04 3.98748576e+03 1.44422087e+03 5.91888955e+02
 4.17429986e+02 2.33320424e+02 1.47848392e+02 1.07121706e+02
 5.87334752e+01 5.36017906e+01 2.51628701e+01 2.83847554e+01
 9.16982900e+00 1.33133072e+01 8.60421187e+00 4.29905758e+01
 4.92737719e-01 1.20435398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33609499718546
cond(S) = 912720.3469063402
E1 = -689.5961883683598  E_coul = 184.97060462487997
init E= -504.62558374348
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672198849083954  LUMO = 0.542455556391919
  mo_energy =
[-1.21709900e+02 -1.33863861e+01 -7.62365138e+00 -7.62365138e+00
 -7.62365138e+00 -1.65759173e+00 -6.72198849e-01 -6.72198849e-01
 -6.72198849e-01  5.42455556e-01  4.96793862e+00  2.19604293e+01
  8.19497339e+01  2.78242945e+02  9.06644424e+02  3.15953633e+03
  1.26394361e+04  4.12358949e+04  1.05263523e+05  2.30436232e+05
  4.56243435e+05  8.45189813e+05  1.52836139e+06  2.85062177e+06
  5.80850006e+06]
E1 = -707.7538460079746  E_coul = 199.78127727534977
cycle= 1 E= -507.972568732625  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.759831
diis-c [-0.57734376  1.        ]
  HOMO = -0.217659430483553  LUMO = 0.890144350733012
  mo_energy =
[-1.20200274e+02 -1.23048484e+01 -6.59406980e+00 -6.59406980e+00
 -6.59406980e+00 -1.16334046e+00 -2.17659430e-01 -2.17659430e-01
 -2.17659430e-01  8.90144351e-01  5.59794354e+00  2.29163353e+01
  8.32231642e+01  2.79695702e+02  9.08135895e+02  3.16096863e+03
  1.26407620e+04  4.12371536e+04  1.05264745e+05  2.30437429e+05
  4.56244615e+05  8.45190980e+05  1.52836254e+06  2.85062292e+06
  5.80850120e+06]
E1 = -706.7994088815784  E_coul = 198.80903637462683
cycle= 2 E= -507.990372506952  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0346202
diis-c [-0.00119412 -0.00278362  1.00278362]
  HOMO = -0.239815900068974  LUMO = 0.886401374319486
  mo_energy =
[-1.20315215e+02 -1.23726014e+01 -6.66909310e+00 -6.66909310e+00
 -6.66909310e+00 -1.17759605e+00 -2.39815900e-01 -2.39815900e-01
 -2.39815900e-01  8.86401374e-01  5.56932563e+00  2.28587002e+01
  8.31390294e+01  2.79590949e+02  9.08015314e+02  3.16083370e+03
  1.26406169e+04  4.12370046e+04  1.05264594e+05  2.30437277e+05
  4.56244463e+05  8.45190828e+05  1.52836239e+06  2.85062276e+06
  5.80850104e+06]
E1 = -706.6910283559831  E_coul = 198.7003935963871
cycle= 3 E= -507.990634759596  delta_E= -0.000262  |g|= 0.00436  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00378469
diis-c [-3.22997588e-06  1.15532191e-04 -1.06861937e-01  1.10674640e+00]
  HOMO = -0.242964402490833  LUMO = 0.885643079957164
  mo_energy =
[-1.20326947e+02 -1.23811506e+01 -6.67812432e+00 -6.67812432e+00
 -6.67812432e+00 -1.17950398e+00 -2.42964402e-01 -2.42964402e-01
 -2.42964402e-01  8.85643080e-01  5.56508679e+00  2.28512693e+01
  8.31293753e+01  2.79579881e+02  9.08003347e+02  3.16082103e+03
  1.26406037e+04  4.12369913e+04  1.05264581e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836238e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6757281975067  E_coul = 198.68508836804867
cycle= 4 E= -507.990639829458  delta_E= -5.07e-06  |g|= 0.000234  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000173392
diis-c [-5.48029178e-10 -9.39625112e-06  6.88686747e-03 -9.83642963e-02
  1.09148683e+00]
  HOMO = -0.243114491022295  LUMO = 0.885597697751012
  mo_energy =
[-1.20327293e+02 -1.23814915e+01 -6.67846115e+00 -6.67846115e+00
 -6.67846115e+00 -1.17959488e+00 -2.43114491e-01 -2.43114491e-01
 -2.43114491e-01  8.85597698e-01  5.56487907e+00  2.28509640e+01
  8.31290379e+01  2.79579536e+02  9.08002999e+02  3.16082068e+03
  1.26406034e+04  4.12369909e+04  1.05264580e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836237e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6750049337145  E_coul = 198.68436508989197
cycle= 5 E= -507.990639843823  delta_E= -1.44e-08  |g|= 5.73e-06  |ddm|= 0.00067
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.54979e-06
diis-c [-9.03104423e-13  6.03505343e-07 -5.48109749e-04  7.45825563e-03
 -8.87837301e-02  1.08187298e+00]
  HOMO = -0.243117150483926  LUMO = 0.885596947908424
  mo_energy =
[-1.20327299e+02 -1.23814967e+01 -6.67846641e+00 -6.67846641e+00
 -6.67846641e+00 -1.17959671e+00 -2.43117150e-01 -2.43117150e-01
 -2.43117150e-01  8.85596948e-01  5.56487535e+00  2.28509592e+01
  8.31290325e+01  2.79579530e+02  9.08002993e+02  3.16082067e+03
  1.26406034e+04  4.12369909e+04  1.05264580e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836237e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6749914685706  E_coul = 198.6843516247412
cycle= 6 E= -507.990639843829  delta_E= -6.88e-12  |g|= 9.08e-08  |ddm|= 1.69e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6749914685706  E_coul = 198.6843516247412
  HOMO = -0.243117193039717  LUMO = 0.885596924662405
  mo_energy =
[-1.20327300e+02 -1.23814968e+01 -6.67846650e+00 -6.67846650e+00
 -6.67846650e+00 -1.17959672e+00 -2.43117193e-01 -2.43117193e-01
 -2.43117193e-01  8.85596925e-01  5.56487529e+00  2.28509591e+01
  8.31290324e+01  2.79579530e+02  9.08002993e+02  3.16082067e+03
  1.26406034e+04  4.12369909e+04  1.05264580e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836237e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6749912806404  E_coul = 198.68435143681066
Extra cycle  E= -507.99063984383  delta_E= -3.41e-13  |g|= 1.1e-08  |ddm|= 2.2e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912720.3469063402
E1 = -706.6749912806404  E_coul = 198.68435143681066
init E= -507.99063984383
    CPU time for initialize scf      5.91 sec, wall time      0.25 sec
  HOMO = -0.243117199152465  LUMO = 0.885596920450639
  mo_energy =
[-1.20327300e+02 -1.23814968e+01 -6.67846651e+00 -6.67846651e+00
 -6.67846651e+00 -1.17959673e+00 -2.43117199e-01 -2.43117199e-01
 -2.43117199e-01  8.85596920e-01  5.56487529e+00  2.28509591e+01
  8.31290324e+01  2.79579530e+02  9.08002993e+02  3.16082067e+03
  1.26406034e+04  4.12369909e+04  1.05264580e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836237e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6749912549278  E_coul = 198.68435141109828
cycle= 1 E= -507.99063984383  delta_E= 2.27e-13  |g|= 2.57e-09  |ddm|= 2.65e-08
    CPU time for cycle= 1      0.28 sec, wall time      0.03 sec
E1 = -706.6749912549278  E_coul = 198.68435141109828
  HOMO = -0.243117199958474  LUMO = 0.885596921937377
  mo_energy =
[-1.20327300e+02 -1.23814968e+01 -6.67846651e+00 -6.67846651e+00
 -6.67846651e+00 -1.17959673e+00 -2.43117200e-01 -2.43117200e-01
 -2.43117200e-01  8.85596922e-01  5.56487528e+00  2.28509591e+01
  8.31290324e+01  2.79579530e+02  9.08002993e+02  3.16082067e+03
  1.26406034e+04  4.12369909e+04  1.05264580e+05  2.30437264e+05
  4.56244450e+05  8.45190814e+05  1.52836237e+06  2.85062275e+06
  5.80850103e+06]
E1 = -706.6749912475907  E_coul = 198.68435140376104
Extra cycle  E= -507.99063984383  delta_E= -1.14e-13  |g|= 1.38e-09  |ddm|= 6.28e-09
    CPU time for scf_cycle      6.34 sec, wall time      0.43 sec
exp = [2.29457066e-01 5.98149042e-01 1.87082695e+00 1.17616813e+05
 4.13442557e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104173e+04 3.67547001e+04 7.30223029e+03
 1.83757678e+04 1.44422087e+03 4.17429986e+02 1.47848392e+02
 5.87334752e+01 2.51628701e+01 9.16982900e+00 8.60421187e+00
 4.92737719e-01]
grad_E = [ 1.16242646e-03 -6.63405876e-04 -7.53847974e-05  6.02608834e-09
  8.31539838e-05  4.00340333e-11  1.72968037e-10  9.34754721e-10
  3.69273730e-09  1.54190215e-08  8.04651438e-08  5.07372749e-06
  1.96865971e-07 -3.77606432e-05 -1.07358726e-05  2.69700336e-05
 -1.07784866e-04  5.86549590e-05  2.20253805e-06 -4.19891508e-05
 -5.16367556e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.231505315902       1
[INPUT] 0    0    [1    /1   ]  0.605217147239       1
[INPUT] 0    0    [1    /1   ]  1.97577251834        1
[INPUT] 0    0    [1    /1   ]  117616.812678        1
[INPUT] 0    0    [1    /1   ]  4.28156557426        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.06995         1
[INPUT] 0    0    [1    /1   ]  294042.030889        1
[INPUT] 0    0    [1    /1   ]  147020.991194        1
[INPUT] 0    0    [1    /1   ]  73510.4170064        1
[INPUT] 0    0    [1    /1   ]  36754.6987095        1
[INPUT] 0    0    [1    /1   ]  7302.14338675        1
[INPUT] 0    0    [1    /1   ]  18375.7644117        1
[INPUT] 0    0    [1    /1   ]  1444.88158606        1
[INPUT] 0    0    [1    /1   ]  417.483011218        1
[INPUT] 0    0    [1    /1   ]  147.93660607         1
[INPUT] 0    0    [1    /1   ]  59.0987976658        1
[INPUT] 0    0    [1    /1   ]  25.6796683743        1
[INPUT] 0    0    [1    /1   ]  9.35496314961        1
[INPUT] 1    0    [1    /1   ]  8.60420748915        1
[INPUT] 1    0    [1    /1   ]  0.492736689579       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23150531590203596, 1.0]], [0, [0.6052171472385464, 1.0]], [0, [1.9757725183426553, 1.0]], [0, [117616.81267773325, 1.0]], [0, [4.281565574259411, 1.0]], [0, [1176168.1426120393, 1.0]], [0, [588084.0699504752, 1.0]], [0, [294042.0308885886, 1.0]], [0, [147020.9911935357, 1.0]], [0, [73510.41700643358, 1.0]], [0, [36754.69870948311, 1.0]], [0, [7302.143386754672, 1.0]], [0, [18375.76441174317, 1.0]], [0, [1444.8815860644547, 1.0]], [0, [417.4830112183815, 1.0]], [0, [147.93660607045874, 1.0]], [0, [59.09879766575045, 1.0]], [0, [25.679668374266374, 1.0]], [0, [9.354963149612963, 1.0]], [1, [8.60420748915256, 1.0]], [1, [0.4927366895792941, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23150532]
bas 1, expnt(s) = [0.60521715]
bas 2, expnt(s) = [1.97577252]
bas 3, expnt(s) = [117616.81267773]
bas 4, expnt(s) = [4.28156557]
bas 5, expnt(s) = [1176168.14261204]
bas 6, expnt(s) = [588084.06995048]
bas 7, expnt(s) = [294042.03088859]
bas 8, expnt(s) = [147020.99119354]
bas 9, expnt(s) = [73510.41700643]
bas 10, expnt(s) = [36754.69870948]
bas 11, expnt(s) = [7302.14338675]
bas 12, expnt(s) = [18375.76441174]
bas 13, expnt(s) = [1444.88158606]
bas 14, expnt(s) = [417.48301122]
bas 15, expnt(s) = [147.93660607]
bas 16, expnt(s) = [59.09879767]
bas 17, expnt(s) = [25.67966837]
bas 18, expnt(s) = [9.35496315]
bas 19, expnt(s) = [8.60420749]
bas 20, expnt(s) = [0.49273669]
CPU time:      1433.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.31505316e-01 8.43210003e-01 6.05217147e-01 1.73359818e+00
 1.97577252e+00 4.21034544e+00 1.17616813e+05 1.60460108e+04
 4.28156557e+00 7.51998500e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104170e+04 1.12791582e+04
 3.67546987e+04 6.70655784e+03 7.30214339e+03 1.99573462e+03
 1.83757644e+04 3.98748521e+03 1.44488159e+03 5.92092032e+02
 4.17483011e+02 2.33342652e+02 1.47936606e+02 1.07169638e+02
 5.90987977e+01 5.38516492e+01 2.56796684e+01 2.88208697e+01
 9.35496315e+00 1.35143943e+01 8.60420749e+00 4.29905485e+01
 4.92736690e-01 1.20435084e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608760841537
cond(S) = 912837.6528879808
E1 = -689.59656500396  E_coul = 184.97036430526265
init E= -504.626200698697
    CPU time for initialize scf      1.63 sec, wall time      0.11 sec
  HOMO = -0.672203648562313  LUMO = 0.557782438471311
  mo_energy =
[-1.21709938e+02 -1.33864204e+01 -7.62367067e+00 -7.62367067e+00
 -7.62367067e+00 -1.65757738e+00 -6.72203649e-01 -6.72203649e-01
 -6.72203649e-01  5.57782438e-01  5.22208920e+00  2.29818209e+01
  8.44484253e+01  2.82503006e+02  9.11875444e+02  3.16541793e+03
  1.26460781e+04  4.12425275e+04  1.05269951e+05  2.30442482e+05
  4.56249552e+05  8.45195828e+05  1.52836730e+06  2.85062757e+06
  5.80850570e+06]
E1 = -707.7531979311193  E_coul = 199.7805957010618
cycle= 1 E= -507.972602230058  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.760601
diis-c [-0.57851389  1.        ]
  HOMO = -0.217675246351092  LUMO = 0.909545147664124
  mo_energy =
[-1.20200348e+02 -1.23049147e+01 -6.59412437e+00 -6.59412437e+00
 -6.59412437e+00 -1.16334308e+00 -2.17675246e-01 -2.17675246e-01
 -2.17675246e-01  9.09545148e-01  5.86509275e+00  2.39478992e+01
  8.57257407e+01  2.83956153e+02  9.13366792e+02  3.16685017e+03
  1.26474039e+04  4.12437862e+04  1.05271173e+05  2.30443680e+05
  4.56250732e+05  8.45196995e+05  1.52836846e+06  2.85062871e+06
  5.80850684e+06]
E1 = -706.7992942931044  E_coul = 198.80889799459214
cycle= 2 E= -507.990396298512  delta_E= -0.0178  |g|= 0.0351  |ddm|=  0.4
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0341781
diis-c [-0.00116481 -0.00240892  1.00240892]
  HOMO = -0.239810192819163  LUMO = 0.905617514299225
  mo_energy =
[-1.20315191e+02 -1.23726015e+01 -6.66907666e+00 -6.66907666e+00
 -6.66907666e+00 -1.17758377e+00 -2.39810193e-01 -2.39810193e-01
 -2.39810193e-01  9.05617514e-01  5.83539276e+00  2.38894500e+01
  8.56412866e+01  2.83851411e+02  9.13246320e+02  3.16671535e+03
  1.26472589e+04  4.12436373e+04  1.05271023e+05  2.30443528e+05
  4.56250580e+05  8.45196843e+05  1.52836831e+06  2.85062856e+06
  5.80850669e+06]
E1 = -706.6911116662309  E_coul = 198.70045383314397
cycle= 3 E= -507.990657833087  delta_E= -0.000262  |g|= 0.00436  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00371114
diis-c [-3.14797171e-06  1.21652387e-04 -1.05824286e-01  1.10570263e+00]
  HOMO = -0.242955453374191  LUMO = 0.904831430544884
  mo_energy =
[-1.20326936e+02 -1.23811522e+01 -6.67811136e+00 -6.67811136e+00
 -6.67811136e+00 -1.17948949e+00 -2.42955453e-01 -2.42955453e-01
 -2.42955453e-01  9.04831431e-01  5.83101627e+00  2.38819337e+01
  8.56315962e+01  2.83840327e+02  9.13234338e+02  3.16670267e+03
  1.26472457e+04  4.12436240e+04  1.05271009e+05  2.30443515e+05
  4.56250567e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6758489461864  E_coul = 198.68518607419793
cycle= 4 E= -507.990662871988  delta_E= -5.04e-06  |g|= 0.000235  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172468
diis-c [-4.93124355e-10 -9.19935892e-06  6.88887922e-03 -9.93729803e-02
  1.09249330e+00]
  HOMO = -0.2431078540873  LUMO = 0.904784310531155
  mo_energy =
[-1.20327296e+02 -1.23815018e+01 -6.67845750e+00 -6.67845750e+00
 -6.67845750e+00 -1.17958169e+00 -2.43107854e-01 -2.43107854e-01
 -2.43107854e-01  9.04784311e-01  5.83079965e+00  2.38816191e+01
  8.56312483e+01  2.83839970e+02  9.13233977e+02  3.16670230e+03
  1.26472454e+04  4.12436236e+04  1.05271009e+05  2.30443514e+05
  4.56250566e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6751161662971  E_coul = 198.68445327995596
cycle= 5 E= -507.990662886341  delta_E= -1.44e-08  |g|= 5.23e-06  |ddm|= 0.000653
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.33552e-06
diis-c [-8.13077832e-13  5.73522551e-07 -5.16790147e-04  7.10296595e-03
 -8.36726389e-02  1.07708589e+00]
  HOMO = -0.24311032797452  LUMO = 0.904783609457083
  mo_energy =
[-1.20327302e+02 -1.23815067e+01 -6.67846246e+00 -6.67846246e+00
 -6.67846246e+00 -1.17958340e+00 -2.43110328e-01 -2.43110328e-01
 -2.43110328e-01  9.04783609e-01  5.83079612e+00  2.38816145e+01
  8.56312432e+01  2.83839964e+02  9.13233971e+02  3.16670230e+03
  1.26472454e+04  4.12436236e+04  1.05271009e+05  2.30443514e+05
  4.56250566e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6751036815203  E_coul = 198.68444079517312
cycle= 6 E= -507.990662886347  delta_E= -6.03e-12  |g|= 9.07e-08  |ddm|= 1.49e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6751036815203  E_coul = 198.68444079517312
  HOMO = -0.243110370789892  LUMO = 0.904783583617061
  mo_energy =
[-1.20327302e+02 -1.23815068e+01 -6.67846255e+00 -6.67846255e+00
 -6.67846255e+00 -1.17958342e+00 -2.43110371e-01 -2.43110371e-01
 -2.43110371e-01  9.04783584e-01  5.83079605e+00  2.38816145e+01
  8.56312431e+01  2.83839964e+02  9.13233971e+02  3.16670230e+03
  1.26472454e+04  4.12436236e+04  1.05271009e+05  2.30443514e+05
  4.56250566e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6751034935528  E_coul = 198.68444060720606
Extra cycle  E= -507.990662886347  delta_E= 4.55e-13  |g|= 1.14e-08  |ddm|= 2.13e-07
    CPU time for scf_cycle      2.42 sec, wall time      0.33 sec
exp = [2.31505316e-01 6.05217147e-01 1.97577252e+00 1.17616813e+05
 4.28156557e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104170e+04 3.67546987e+04 7.30214339e+03
 1.83757644e+04 1.44488159e+03 4.17483011e+02 1.47936606e+02
 5.90987977e+01 2.56796684e+01 9.35496315e+00 8.60420749e+00
 4.92736690e-01]
E = -507.99066288634674
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.231505315902       1
[INPUT] 0    0    [1    /1   ]  0.605217147239       1
[INPUT] 0    0    [1    /1   ]  1.97577251834        1
[INPUT] 0    0    [1    /1   ]  117616.812678        1
[INPUT] 0    0    [1    /1   ]  4.28156557426        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.06995         1
[INPUT] 0    0    [1    /1   ]  294042.030889        1
[INPUT] 0    0    [1    /1   ]  147020.991194        1
[INPUT] 0    0    [1    /1   ]  73510.4170064        1
[INPUT] 0    0    [1    /1   ]  36754.6987095        1
[INPUT] 0    0    [1    /1   ]  7302.14338675        1
[INPUT] 0    0    [1    /1   ]  18375.7644117        1
[INPUT] 0    0    [1    /1   ]  1444.88158606        1
[INPUT] 0    0    [1    /1   ]  417.483011218        1
[INPUT] 0    0    [1    /1   ]  147.93660607         1
[INPUT] 0    0    [1    /1   ]  59.0987976658        1
[INPUT] 0    0    [1    /1   ]  25.6796683743        1
[INPUT] 0    0    [1    /1   ]  9.35496314961        1
[INPUT] 1    0    [1    /1   ]  8.60420748915        1
[INPUT] 1    0    [1    /1   ]  0.492736689579       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23150531590203596, 1.0]], [0, [0.6052171472385464, 1.0]], [0, [1.9757725183426553, 1.0]], [0, [117616.81267773325, 1.0]], [0, [4.281565574259411, 1.0]], [0, [1176168.1426120393, 1.0]], [0, [588084.0699504752, 1.0]], [0, [294042.0308885886, 1.0]], [0, [147020.9911935357, 1.0]], [0, [73510.41700643358, 1.0]], [0, [36754.69870948311, 1.0]], [0, [7302.143386754672, 1.0]], [0, [18375.76441174317, 1.0]], [0, [1444.8815860644547, 1.0]], [0, [417.4830112183815, 1.0]], [0, [147.93660607045874, 1.0]], [0, [59.09879766575045, 1.0]], [0, [25.679668374266374, 1.0]], [0, [9.354963149612963, 1.0]], [1, [8.60420748915256, 1.0]], [1, [0.4927366895792941, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23150532]
bas 1, expnt(s) = [0.60521715]
bas 2, expnt(s) = [1.97577252]
bas 3, expnt(s) = [117616.81267773]
bas 4, expnt(s) = [4.28156557]
bas 5, expnt(s) = [1176168.14261204]
bas 6, expnt(s) = [588084.06995048]
bas 7, expnt(s) = [294042.03088859]
bas 8, expnt(s) = [147020.99119354]
bas 9, expnt(s) = [73510.41700643]
bas 10, expnt(s) = [36754.69870948]
bas 11, expnt(s) = [7302.14338675]
bas 12, expnt(s) = [18375.76441174]
bas 13, expnt(s) = [1444.88158606]
bas 14, expnt(s) = [417.48301122]
bas 15, expnt(s) = [147.93660607]
bas 16, expnt(s) = [59.09879767]
bas 17, expnt(s) = [25.67966837]
bas 18, expnt(s) = [9.35496315]
bas 19, expnt(s) = [8.60420749]
bas 20, expnt(s) = [0.49273669]
CPU time:      1436.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.31505316e-01 8.43210003e-01 6.05217147e-01 1.73359818e+00
 1.97577252e+00 4.21034544e+00 1.17616813e+05 1.60460108e+04
 4.28156557e+00 7.51998500e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104170e+04 1.12791582e+04
 3.67546987e+04 6.70655784e+03 7.30214339e+03 1.99573462e+03
 1.83757644e+04 3.98748521e+03 1.44488159e+03 5.92092032e+02
 4.17483011e+02 2.33342652e+02 1.47936606e+02 1.07169638e+02
 5.90987977e+01 5.38516492e+01 2.56796684e+01 2.88208697e+01
 9.35496315e+00 1.35143943e+01 8.60420749e+00 4.29905485e+01
 4.92736690e-01 1.20435084e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608760841537
cond(S) = 912837.6528879808
E1 = -689.59656500396  E_coul = 184.97036430526265
init E= -504.626200698697
    CPU time for initialize scf      0.76 sec, wall time      0.07 sec
  HOMO = -0.672203648562313  LUMO = 0.557782438471311
  mo_energy =
[-1.21709938e+02 -1.33864204e+01 -7.62367067e+00 -7.62367067e+00
 -7.62367067e+00 -1.65757738e+00 -6.72203649e-01 -6.72203649e-01
 -6.72203649e-01  5.57782438e-01  5.22208920e+00  2.29818209e+01
  8.44484253e+01  2.82503006e+02  9.11875444e+02  3.16541793e+03
  1.26460781e+04  4.12425275e+04  1.05269951e+05  2.30442482e+05
  4.56249552e+05  8.45195828e+05  1.52836730e+06  2.85062757e+06
  5.80850570e+06]
E1 = -707.7531979311193  E_coul = 199.7805957010618
cycle= 1 E= -507.972602230058  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.760601
diis-c [-0.57851389  1.        ]
  HOMO = -0.217675246351092  LUMO = 0.909545147664124
  mo_energy =
[-1.20200348e+02 -1.23049147e+01 -6.59412437e+00 -6.59412437e+00
 -6.59412437e+00 -1.16334308e+00 -2.17675246e-01 -2.17675246e-01
 -2.17675246e-01  9.09545148e-01  5.86509275e+00  2.39478992e+01
  8.57257407e+01  2.83956153e+02  9.13366792e+02  3.16685017e+03
  1.26474039e+04  4.12437862e+04  1.05271173e+05  2.30443680e+05
  4.56250732e+05  8.45196995e+05  1.52836846e+06  2.85062871e+06
  5.80850684e+06]
E1 = -706.7992942931044  E_coul = 198.80889799459214
cycle= 2 E= -507.990396298512  delta_E= -0.0178  |g|= 0.0351  |ddm|=  0.4
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0341781
diis-c [-0.00116481 -0.00240892  1.00240892]
  HOMO = -0.239810192819163  LUMO = 0.905617514299225
  mo_energy =
[-1.20315191e+02 -1.23726015e+01 -6.66907666e+00 -6.66907666e+00
 -6.66907666e+00 -1.17758377e+00 -2.39810193e-01 -2.39810193e-01
 -2.39810193e-01  9.05617514e-01  5.83539276e+00  2.38894500e+01
  8.56412866e+01  2.83851411e+02  9.13246320e+02  3.16671535e+03
  1.26472589e+04  4.12436373e+04  1.05271023e+05  2.30443528e+05
  4.56250580e+05  8.45196843e+05  1.52836831e+06  2.85062856e+06
  5.80850669e+06]
E1 = -706.6911116662309  E_coul = 198.70045383314397
cycle= 3 E= -507.990657833087  delta_E= -0.000262  |g|= 0.00436  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00371114
diis-c [-3.14797171e-06  1.21652387e-04 -1.05824286e-01  1.10570263e+00]
  HOMO = -0.242955453374191  LUMO = 0.904831430544884
  mo_energy =
[-1.20326936e+02 -1.23811522e+01 -6.67811136e+00 -6.67811136e+00
 -6.67811136e+00 -1.17948949e+00 -2.42955453e-01 -2.42955453e-01
 -2.42955453e-01  9.04831431e-01  5.83101627e+00  2.38819337e+01
  8.56315962e+01  2.83840327e+02  9.13234338e+02  3.16670267e+03
  1.26472457e+04  4.12436240e+04  1.05271009e+05  2.30443515e+05
  4.56250567e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6758489461864  E_coul = 198.68518607419793
cycle= 4 E= -507.990662871988  delta_E= -5.04e-06  |g|= 0.000235  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000172468
diis-c [-4.93124355e-10 -9.19935892e-06  6.88887922e-03 -9.93729803e-02
  1.09249330e+00]
  HOMO = -0.2431078540873  LUMO = 0.904784310531155
  mo_energy =
[-1.20327296e+02 -1.23815018e+01 -6.67845750e+00 -6.67845750e+00
 -6.67845750e+00 -1.17958169e+00 -2.43107854e-01 -2.43107854e-01
 -2.43107854e-01  9.04784311e-01  5.83079965e+00  2.38816191e+01
  8.56312483e+01  2.83839970e+02  9.13233977e+02  3.16670230e+03
  1.26472454e+04  4.12436236e+04  1.05271009e+05  2.30443514e+05
  4.56250566e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6751161662971  E_coul = 198.68445327995596
cycle= 5 E= -507.990662886341  delta_E= -1.44e-08  |g|= 5.23e-06  |ddm|= 0.000653
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.33552e-06
diis-c [-8.13077832e-13  5.73522551e-07 -5.16790147e-04  7.10296595e-03
 -8.36726389e-02  1.07708589e+00]
  HOMO = -0.24311032797452  LUMO = 0.904783609457083
  mo_energy =
[-1.20327302e+02 -1.23815067e+01 -6.67846246e+00 -6.67846246e+00
 -6.67846246e+00 -1.17958340e+00 -2.43110328e-01 -2.43110328e-01
 -2.43110328e-01  9.04783609e-01  5.83079612e+00  2.38816145e+01
  8.56312432e+01  2.83839964e+02  9.13233971e+02  3.16670230e+03
  1.26472454e+04  4.12436236e+04  1.05271009e+05  2.30443514e+05
  4.56250566e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6751036815203  E_coul = 198.68444079517312
cycle= 6 E= -507.990662886347  delta_E= -6.03e-12  |g|= 9.07e-08  |ddm|= 1.49e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6751036815203  E_coul = 198.68444079517312
  HOMO = -0.243110370789892  LUMO = 0.904783583617061
  mo_energy =
[-1.20327302e+02 -1.23815068e+01 -6.67846255e+00 -6.67846255e+00
 -6.67846255e+00 -1.17958342e+00 -2.43110371e-01 -2.43110371e-01
 -2.43110371e-01  9.04783584e-01  5.83079605e+00  2.38816145e+01
  8.56312431e+01  2.83839964e+02  9.13233971e+02  3.16670230e+03
  1.26472454e+04  4.12436236e+04  1.05271009e+05  2.30443514e+05
  4.56250566e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6751034935528  E_coul = 198.68444060720606
Extra cycle  E= -507.990662886347  delta_E= 4.55e-13  |g|= 1.14e-08  |ddm|= 2.13e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912837.6528879808
E1 = -706.6751034935528  E_coul = 198.68444060720606
init E= -507.990662886347
    CPU time for initialize scf      6.01 sec, wall time      0.25 sec
  HOMO = -0.24311037686017  LUMO = 0.904783581043367
  mo_energy =
[-1.20327302e+02 -1.23815068e+01 -6.67846256e+00 -6.67846256e+00
 -6.67846256e+00 -1.17958342e+00 -2.43110377e-01 -2.43110377e-01
 -2.43110377e-01  9.04783581e-01  5.83079604e+00  2.38816144e+01
  8.56312431e+01  2.83839964e+02  9.13233971e+02  3.16670230e+03
  1.26472454e+04  4.12436236e+04  1.05271009e+05  2.30443514e+05
  4.56250566e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6751034641281  E_coul = 198.6844405777812
cycle= 1 E= -507.990662886347  delta_E= -2.27e-13  |g|= 2.27e-09  |ddm|= 2.84e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6751034641281  E_coul = 198.6844405777812
  HOMO = -0.243110377765861  LUMO = 0.904783581326882
  mo_energy =
[-1.20327302e+02 -1.23815068e+01 -6.67846256e+00 -6.67846256e+00
 -6.67846256e+00 -1.17958342e+00 -2.43110378e-01 -2.43110378e-01
 -2.43110378e-01  9.04783581e-01  5.83079604e+00  2.38816144e+01
  8.56312431e+01  2.83839964e+02  9.13233971e+02  3.16670230e+03
  1.26472454e+04  4.12436236e+04  1.05271009e+05  2.30443514e+05
  4.56250566e+05  8.45196829e+05  1.52836829e+06  2.85062855e+06
  5.80850667e+06]
E1 = -706.6751034612892  E_coul = 198.68444057494202
Extra cycle  E= -507.990662886347  delta_E= -1.71e-13  |g|= 1.28e-09  |ddm|= 3.17e-09
    CPU time for scf_cycle      6.46 sec, wall time      0.42 sec
exp = [2.31505316e-01 6.05217147e-01 1.97577252e+00 1.17616813e+05
 4.28156557e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104170e+04 3.67546987e+04 7.30214339e+03
 1.83757644e+04 1.44488159e+03 4.17483011e+02 1.47936606e+02
 5.90987977e+01 2.56796684e+01 9.35496315e+00 8.60420749e+00
 4.92736690e-01]
grad_E = [ 8.97392848e-04 -4.97552439e-04 -1.55941440e-05  6.00010661e-09
  5.78747896e-06  3.97416639e-11  1.72115787e-10  9.30767982e-10
  3.67664313e-09  1.53509593e-08  8.01379314e-08  5.05523025e-06
  1.95786600e-07 -3.74741083e-05 -1.09903826e-05  2.86279242e-05
 -1.31004654e-04  1.04509277e-04  1.98747667e-05 -3.76970185e-05
 -5.03779324e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233628507426       1
[INPUT] 0    0    [1    /1   ]  0.61291860787        1
[INPUT] 0    0    [1    /1   ]  2.07633220723        1
[INPUT] 0    0    [1    /1   ]  117616.812525        1
[INPUT] 0    0    [1    /1   ]  4.45992459619        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069946        1
[INPUT] 0    0    [1    /1   ]  294042.030865        1
[INPUT] 0    0    [1    /1   ]  147020.9911          1
[INPUT] 0    0    [1    /1   ]  73510.4166168        1
[INPUT] 0    0    [1    /1   ]  36754.6966771        1
[INPUT] 0    0    [1    /1   ]  7302.0152669         1
[INPUT] 0    0    [1    /1   ]  18375.7594281        1
[INPUT] 0    0    [1    /1   ]  1445.8548643         1
[INPUT] 0    0    [1    /1   ]  417.569721239        1
[INPUT] 0    0    [1    /1   ]  148.031698881        1
[INPUT] 0    0    [1    /1   ]  59.7109380973        1
[INPUT] 0    0    [1    /1   ]  26.3884547491        1
[INPUT] 0    0    [1    /1   ]  9.59585742836        1
[INPUT] 1    0    [1    /1   ]  8.60424974697        1
[INPUT] 1    0    [1    /1   ]  0.492743559519       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23362850742603233, 1.0]], [0, [0.612918607870488, 1.0]], [0, [2.0763322072254398, 1.0]], [0, [117616.81252547097, 1.0]], [0, [4.45992459619309, 1.0]], [0, [1176168.1426110228, 1.0]], [0, [588084.0699461005, 1.0]], [0, [294042.0308649718, 1.0]], [0, [147020.9911002236, 1.0]], [0, [73510.41661677283, 1.0]], [0, [36754.696677133885, 1.0]], [0, [7302.01526690121, 1.0]], [0, [18375.75942812622, 1.0]], [0, [1445.8548643046488, 1.0]], [0, [417.5697212388022, 1.0]], [0, [148.03169888142284, 1.0]], [0, [59.710938097259735, 1.0]], [0, [26.388454749122246, 1.0]], [0, [9.59585742835594, 1.0]], [1, [8.604249746968879, 1.0]], [1, [0.49274355951858534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23362851]
bas 1, expnt(s) = [0.61291861]
bas 2, expnt(s) = [2.07633221]
bas 3, expnt(s) = [117616.81252547]
bas 4, expnt(s) = [4.4599246]
bas 5, expnt(s) = [1176168.14261102]
bas 6, expnt(s) = [588084.0699461]
bas 7, expnt(s) = [294042.03086497]
bas 8, expnt(s) = [147020.99110022]
bas 9, expnt(s) = [73510.41661677]
bas 10, expnt(s) = [36754.69667713]
bas 11, expnt(s) = [7302.0152669]
bas 12, expnt(s) = [18375.75942813]
bas 13, expnt(s) = [1445.8548643]
bas 14, expnt(s) = [417.56972124]
bas 15, expnt(s) = [148.03169888]
bas 16, expnt(s) = [59.7109381]
bas 17, expnt(s) = [26.38845475]
bas 18, expnt(s) = [9.59585743]
bas 19, expnt(s) = [8.60424975]
bas 20, expnt(s) = [0.49274356]
CPU time:      1451.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33628507e-01 8.49003343e-01 6.12918608e-01 1.75011718e+00
 2.07633221e+00 4.37006257e+00 1.17616813e+05 1.60460107e+04
 4.45992460e+00 7.75372978e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104166e+04 1.12791582e+04
 3.67546967e+04 6.70655756e+03 7.30201527e+03 1.99570836e+03
 1.83757594e+04 3.98748440e+03 1.44585486e+03 5.92391133e+02
 4.17569721e+02 2.33379000e+02 1.48031699e+02 1.07221300e+02
 5.97109381e+01 5.42694531e+01 2.63884547e+01 2.94154498e+01
 9.59585743e+00 1.37745641e+01 8.60424975e+00 4.29908124e+01
 4.92743560e-01 1.20437183e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336069249356797
cond(S) = 912994.1576149368
E1 = -689.5970476063359  E_coul = 184.97066072386122
init E= -504.626386882475
    CPU time for initialize scf      1.67 sec, wall time      0.11 sec
  HOMO = -0.672195950893611  LUMO = 0.573846208102301
  mo_energy =
[-1.21709911e+02 -1.33864096e+01 -7.62365473e+00 -7.62365473e+00
 -7.62365473e+00 -1.65754978e+00 -6.72195951e-01 -6.72195951e-01
 -6.72195951e-01  5.73846208e-01  5.49323520e+00  2.41469202e+01
  8.75672360e+01  2.88187913e+02  9.19069408e+02  3.17363427e+03
  1.26554734e+04  4.12519396e+04  1.05279078e+05  2.30451357e+05
  4.56258236e+05  8.45204367e+05  1.52837570e+06  2.85063580e+06
  5.80851371e+06]
E1 = -707.7531401377227  E_coul = 199.78050138420136
cycle= 1 E= -507.972638753521  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.761195
diis-c [-0.5794171  1.       ]
  HOMO = -0.21767505968442  LUMO = 0.929776760996315
  mo_energy =
[-1.20200351e+02 -1.23049338e+01 -6.59414198e+00 -6.59414198e+00
 -6.59414198e+00 -1.16333108e+00 -2.17675060e-01 -2.17675060e-01
 -2.17675060e-01  9.29776761e-01  6.14981838e+00  2.51249567e+01
  8.88498877e+01  2.89641784e+02  9.20560644e+02  3.17506645e+03
  1.26567992e+04  4.12531983e+04  1.05280300e+05  2.30452554e+05
  4.56259416e+05  8.45205534e+05  1.52837686e+06  2.85063694e+06
  5.80851485e+06]
E1 = -706.7997330641517  E_coul = 198.80930825436363
cycle= 2 E= -507.990424809788  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.403
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0337867
diis-c [-0.00113929 -0.00197674  1.00197674]
  HOMO = -0.239789564920091  LUMO = 0.925657856527283
  mo_energy =
[-1.20315092e+02 -1.23725531e+01 -6.66902124e+00 -6.66902124e+00
 -6.66902124e+00 -1.17755731e+00 -2.39789565e-01 -2.39789565e-01
 -2.39789565e-01  9.25657857e-01  6.11899811e+00  2.50655752e+01
  8.87649888e+01  2.89537011e+02  9.20440284e+02  3.17493176e+03
  1.26566543e+04  4.12530495e+04  1.05280149e+05  2.30452403e+05
  4.56259264e+05  8.45205382e+05  1.52837671e+06  2.85063679e+06
  5.80851470e+06]
E1 = -706.6917703116236  E_coul = 198.70108477144328
cycle= 3 E= -507.99068554018  delta_E= -0.000261  |g|= 0.00436  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00364925
diis-c [-3.06374639e-06  1.20041943e-04 -1.05065216e-01  1.10494517e+00]
  HOMO = -0.242933001488627  LUMO = 0.924843050010888
  mo_energy =
[-1.20326859e+02 -1.23811103e+01 -6.67806492e+00 -6.67806492e+00
 -6.67806492e+00 -1.17946166e+00 -2.42933001e-01 -2.42933001e-01
 -2.42933001e-01  9.24843050e-01  6.11447818e+00  2.50579583e+01
  8.87552461e+01  2.89525900e+02  9.20428279e+02  3.17491905e+03
  1.26566411e+04  4.12530361e+04  1.05280136e+05  2.30452389e+05
  4.56259251e+05  8.45205369e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6765415701573  E_coul = 198.68585102337613
cycle= 4 E= -507.990690546781  delta_E= -5.01e-06  |g|= 0.000235  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170994
diis-c [-4.40030992e-10 -9.00597393e-06  6.90469497e-03 -1.00147219e-01
  1.09325153e+00]
  HOMO = -0.24308667442897  LUMO = 0.924794381073919
  mo_energy =
[-1.20327229e+02 -1.23814657e+01 -6.67841747e+00 -6.67841747e+00
 -6.67841747e+00 -1.17955451e+00 -2.43086674e-01 -2.43086674e-01
 -2.43086674e-01  9.24794381e-01  6.11425376e+00  2.50576365e+01
  8.87548906e+01  2.89525534e+02  9.20427908e+02  3.17491867e+03
  1.26566407e+04  4.12530357e+04  1.05280136e+05  2.30452389e+05
  4.56259250e+05  8.45205368e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6758044794399  E_coul = 198.68511391847682
cycle= 5 E= -507.990690560963  delta_E= -1.42e-08  |g|= 4.73e-06  |ddm|= 0.000635
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.12556e-06
diis-c [-7.25307202e-13  5.42270220e-07 -4.84196714e-04  6.68822333e-03
 -7.81446772e-02  1.07194011e+00]
  HOMO = -0.243088953683047  LUMO = 0.924793732298753
  mo_energy =
[-1.20327234e+02 -1.23814703e+01 -6.67842211e+00 -6.67842211e+00
 -6.67842211e+00 -1.17955609e+00 -2.43088954e-01 -2.43088954e-01
 -2.43088954e-01  9.24793732e-01  6.11425043e+00  2.50576322e+01
  8.87548858e+01  2.89525529e+02  9.20427902e+02  3.17491866e+03
  1.26566407e+04  4.12530357e+04  1.05280136e+05  2.30452389e+05
  4.56259250e+05  8.45205368e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6757930189566  E_coul = 198.68510245798828
cycle= 6 E= -507.990690560968  delta_E= -5.29e-12  |g|= 9.1e-08  |ddm|= 1.31e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757930189566  E_coul = 198.68510245798828
  HOMO = -0.243088996265471  LUMO = 0.924793707985297
  mo_energy =
[-1.20327234e+02 -1.23814703e+01 -6.67842219e+00 -6.67842219e+00
 -6.67842219e+00 -1.17955610e+00 -2.43088996e-01 -2.43088996e-01
 -2.43088996e-01  9.24793708e-01  6.11425037e+00  2.50576321e+01
  8.87548857e+01  2.89525529e+02  9.20427902e+02  3.17491866e+03
  1.26566407e+04  4.12530357e+04  1.05280136e+05  2.30452389e+05
  4.56259250e+05  8.45205368e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6757928290272  E_coul = 198.68510226805924
Extra cycle  E= -507.990690560968  delta_E= 4.55e-13  |g|= 1.14e-08  |ddm|= 2.1e-07
    CPU time for scf_cycle      2.49 sec, wall time      0.34 sec
exp = [2.33628507e-01 6.12918608e-01 2.07633221e+00 1.17616813e+05
 4.45992460e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104166e+04 3.67546967e+04 7.30201527e+03
 1.83757594e+04 1.44585486e+03 4.17569721e+02 1.48031699e+02
 5.97109381e+01 2.63884547e+01 9.59585743e+00 8.60424975e+00
 4.92743560e-01]
E = -507.9906905609679
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233628507426       1
[INPUT] 0    0    [1    /1   ]  0.61291860787        1
[INPUT] 0    0    [1    /1   ]  2.07633220723        1
[INPUT] 0    0    [1    /1   ]  117616.812525        1
[INPUT] 0    0    [1    /1   ]  4.45992459619        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069946        1
[INPUT] 0    0    [1    /1   ]  294042.030865        1
[INPUT] 0    0    [1    /1   ]  147020.9911          1
[INPUT] 0    0    [1    /1   ]  73510.4166168        1
[INPUT] 0    0    [1    /1   ]  36754.6966771        1
[INPUT] 0    0    [1    /1   ]  7302.0152669         1
[INPUT] 0    0    [1    /1   ]  18375.7594281        1
[INPUT] 0    0    [1    /1   ]  1445.8548643         1
[INPUT] 0    0    [1    /1   ]  417.569721239        1
[INPUT] 0    0    [1    /1   ]  148.031698881        1
[INPUT] 0    0    [1    /1   ]  59.7109380973        1
[INPUT] 0    0    [1    /1   ]  26.3884547491        1
[INPUT] 0    0    [1    /1   ]  9.59585742836        1
[INPUT] 1    0    [1    /1   ]  8.60424974697        1
[INPUT] 1    0    [1    /1   ]  0.492743559519       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23362850742603233, 1.0]], [0, [0.612918607870488, 1.0]], [0, [2.0763322072254398, 1.0]], [0, [117616.81252547097, 1.0]], [0, [4.45992459619309, 1.0]], [0, [1176168.1426110228, 1.0]], [0, [588084.0699461005, 1.0]], [0, [294042.0308649718, 1.0]], [0, [147020.9911002236, 1.0]], [0, [73510.41661677283, 1.0]], [0, [36754.696677133885, 1.0]], [0, [7302.01526690121, 1.0]], [0, [18375.75942812622, 1.0]], [0, [1445.8548643046488, 1.0]], [0, [417.5697212388022, 1.0]], [0, [148.03169888142284, 1.0]], [0, [59.710938097259735, 1.0]], [0, [26.388454749122246, 1.0]], [0, [9.59585742835594, 1.0]], [1, [8.604249746968879, 1.0]], [1, [0.49274355951858534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23362851]
bas 1, expnt(s) = [0.61291861]
bas 2, expnt(s) = [2.07633221]
bas 3, expnt(s) = [117616.81252547]
bas 4, expnt(s) = [4.4599246]
bas 5, expnt(s) = [1176168.14261102]
bas 6, expnt(s) = [588084.0699461]
bas 7, expnt(s) = [294042.03086497]
bas 8, expnt(s) = [147020.99110022]
bas 9, expnt(s) = [73510.41661677]
bas 10, expnt(s) = [36754.69667713]
bas 11, expnt(s) = [7302.0152669]
bas 12, expnt(s) = [18375.75942813]
bas 13, expnt(s) = [1445.8548643]
bas 14, expnt(s) = [417.56972124]
bas 15, expnt(s) = [148.03169888]
bas 16, expnt(s) = [59.7109381]
bas 17, expnt(s) = [26.38845475]
bas 18, expnt(s) = [9.59585743]
bas 19, expnt(s) = [8.60424975]
bas 20, expnt(s) = [0.49274356]
CPU time:      1454.30
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33628507e-01 8.49003343e-01 6.12918608e-01 1.75011718e+00
 2.07633221e+00 4.37006257e+00 1.17616813e+05 1.60460107e+04
 4.45992460e+00 7.75372978e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104166e+04 1.12791582e+04
 3.67546967e+04 6.70655756e+03 7.30201527e+03 1.99570836e+03
 1.83757594e+04 3.98748440e+03 1.44585486e+03 5.92391133e+02
 4.17569721e+02 2.33379000e+02 1.48031699e+02 1.07221300e+02
 5.97109381e+01 5.42694531e+01 2.63884547e+01 2.94154498e+01
 9.59585743e+00 1.37745641e+01 8.60424975e+00 4.29908124e+01
 4.92743560e-01 1.20437183e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336069249356797
cond(S) = 912994.1576149368
E1 = -689.5970476063359  E_coul = 184.97066072386122
init E= -504.626386882475
    CPU time for initialize scf      0.86 sec, wall time      0.07 sec
  HOMO = -0.672195950893611  LUMO = 0.573846208102301
  mo_energy =
[-1.21709911e+02 -1.33864096e+01 -7.62365473e+00 -7.62365473e+00
 -7.62365473e+00 -1.65754978e+00 -6.72195951e-01 -6.72195951e-01
 -6.72195951e-01  5.73846208e-01  5.49323520e+00  2.41469202e+01
  8.75672360e+01  2.88187913e+02  9.19069408e+02  3.17363427e+03
  1.26554734e+04  4.12519396e+04  1.05279078e+05  2.30451357e+05
  4.56258236e+05  8.45204367e+05  1.52837570e+06  2.85063580e+06
  5.80851371e+06]
E1 = -707.7531401377227  E_coul = 199.78050138420136
cycle= 1 E= -507.972638753521  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.761195
diis-c [-0.5794171  1.       ]
  HOMO = -0.21767505968442  LUMO = 0.929776760996315
  mo_energy =
[-1.20200351e+02 -1.23049338e+01 -6.59414198e+00 -6.59414198e+00
 -6.59414198e+00 -1.16333108e+00 -2.17675060e-01 -2.17675060e-01
 -2.17675060e-01  9.29776761e-01  6.14981838e+00  2.51249567e+01
  8.88498877e+01  2.89641784e+02  9.20560644e+02  3.17506645e+03
  1.26567992e+04  4.12531983e+04  1.05280300e+05  2.30452554e+05
  4.56259416e+05  8.45205534e+05  1.52837686e+06  2.85063694e+06
  5.80851485e+06]
E1 = -706.7997330641517  E_coul = 198.80930825436363
cycle= 2 E= -507.990424809788  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.403
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0337867
diis-c [-0.00113929 -0.00197674  1.00197674]
  HOMO = -0.239789564920091  LUMO = 0.925657856527283
  mo_energy =
[-1.20315092e+02 -1.23725531e+01 -6.66902124e+00 -6.66902124e+00
 -6.66902124e+00 -1.17755731e+00 -2.39789565e-01 -2.39789565e-01
 -2.39789565e-01  9.25657857e-01  6.11899811e+00  2.50655752e+01
  8.87649888e+01  2.89537011e+02  9.20440284e+02  3.17493176e+03
  1.26566543e+04  4.12530495e+04  1.05280149e+05  2.30452403e+05
  4.56259264e+05  8.45205382e+05  1.52837671e+06  2.85063679e+06
  5.80851470e+06]
E1 = -706.6917703116236  E_coul = 198.70108477144328
cycle= 3 E= -507.99068554018  delta_E= -0.000261  |g|= 0.00436  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00364925
diis-c [-3.06374639e-06  1.20041943e-04 -1.05065216e-01  1.10494517e+00]
  HOMO = -0.242933001488627  LUMO = 0.924843050010888
  mo_energy =
[-1.20326859e+02 -1.23811103e+01 -6.67806492e+00 -6.67806492e+00
 -6.67806492e+00 -1.17946166e+00 -2.42933001e-01 -2.42933001e-01
 -2.42933001e-01  9.24843050e-01  6.11447818e+00  2.50579583e+01
  8.87552461e+01  2.89525900e+02  9.20428279e+02  3.17491905e+03
  1.26566411e+04  4.12530361e+04  1.05280136e+05  2.30452389e+05
  4.56259251e+05  8.45205369e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6765415701573  E_coul = 198.68585102337613
cycle= 4 E= -507.990690546781  delta_E= -5.01e-06  |g|= 0.000235  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170994
diis-c [-4.40030992e-10 -9.00597393e-06  6.90469497e-03 -1.00147219e-01
  1.09325153e+00]
  HOMO = -0.24308667442897  LUMO = 0.924794381073919
  mo_energy =
[-1.20327229e+02 -1.23814657e+01 -6.67841747e+00 -6.67841747e+00
 -6.67841747e+00 -1.17955451e+00 -2.43086674e-01 -2.43086674e-01
 -2.43086674e-01  9.24794381e-01  6.11425376e+00  2.50576365e+01
  8.87548906e+01  2.89525534e+02  9.20427908e+02  3.17491867e+03
  1.26566407e+04  4.12530357e+04  1.05280136e+05  2.30452389e+05
  4.56259250e+05  8.45205368e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6758044794399  E_coul = 198.68511391847682
cycle= 5 E= -507.990690560963  delta_E= -1.42e-08  |g|= 4.73e-06  |ddm|= 0.000635
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.12556e-06
diis-c [-7.25307202e-13  5.42270220e-07 -4.84196714e-04  6.68822333e-03
 -7.81446772e-02  1.07194011e+00]
  HOMO = -0.243088953683047  LUMO = 0.924793732298753
  mo_energy =
[-1.20327234e+02 -1.23814703e+01 -6.67842211e+00 -6.67842211e+00
 -6.67842211e+00 -1.17955609e+00 -2.43088954e-01 -2.43088954e-01
 -2.43088954e-01  9.24793732e-01  6.11425043e+00  2.50576322e+01
  8.87548858e+01  2.89525529e+02  9.20427902e+02  3.17491866e+03
  1.26566407e+04  4.12530357e+04  1.05280136e+05  2.30452389e+05
  4.56259250e+05  8.45205368e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6757930189566  E_coul = 198.68510245798828
cycle= 6 E= -507.990690560968  delta_E= -5.29e-12  |g|= 9.1e-08  |ddm|= 1.31e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757930189566  E_coul = 198.68510245798828
  HOMO = -0.243088996265471  LUMO = 0.924793707985297
  mo_energy =
[-1.20327234e+02 -1.23814703e+01 -6.67842219e+00 -6.67842219e+00
 -6.67842219e+00 -1.17955610e+00 -2.43088996e-01 -2.43088996e-01
 -2.43088996e-01  9.24793708e-01  6.11425037e+00  2.50576321e+01
  8.87548857e+01  2.89525529e+02  9.20427902e+02  3.17491866e+03
  1.26566407e+04  4.12530357e+04  1.05280136e+05  2.30452389e+05
  4.56259250e+05  8.45205368e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6757928290272  E_coul = 198.68510226805924
Extra cycle  E= -507.990690560968  delta_E= 4.55e-13  |g|= 1.14e-08  |ddm|= 2.1e-07
    CPU time for scf_cycle      1.72 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912994.1576149368
E1 = -706.6757928290272  E_coul = 198.68510226805924
init E= -507.990690560968
    CPU time for initialize scf      5.91 sec, wall time      0.25 sec
  HOMO = -0.2430890023749  LUMO = 0.924793705553502
  mo_energy =
[-1.20327234e+02 -1.23814704e+01 -6.67842221e+00 -6.67842221e+00
 -6.67842221e+00 -1.17955611e+00 -2.43089002e-01 -2.43089002e-01
 -2.43089002e-01  9.24793706e-01  6.11425036e+00  2.50576321e+01
  8.87548857e+01  2.89525529e+02  9.20427902e+02  3.17491866e+03
  1.26566407e+04  4.12530357e+04  1.05280136e+05  2.30452389e+05
  4.56259250e+05  8.45205368e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6757928017419  E_coul = 198.68510224077366
cycle= 1 E= -507.990690560968  delta_E= -3.41e-13  |g|= 2.7e-09  |ddm|= 2.62e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6757928017419  E_coul = 198.68510224077366
  HOMO = -0.243089003226954  LUMO = 0.924793707177969
  mo_energy =
[-1.20327234e+02 -1.23814704e+01 -6.67842221e+00 -6.67842221e+00
 -6.67842221e+00 -1.17955611e+00 -2.43089003e-01 -2.43089003e-01
 -2.43089003e-01  9.24793707e-01  6.11425035e+00  2.50576321e+01
  8.87548857e+01  2.89525529e+02  9.20427902e+02  3.17491866e+03
  1.26566407e+04  4.12530357e+04  1.05280136e+05  2.30452389e+05
  4.56259250e+05  8.45205368e+05  1.52837669e+06  2.85063678e+06
  5.80851468e+06]
E1 = -706.6757927928338  E_coul = 198.68510223186573
Extra cycle  E= -507.990690560968  delta_E= 1.14e-13  |g|= 1.49e-09  |ddm|= 6.65e-09
    CPU time for scf_cycle      6.42 sec, wall time      0.42 sec
exp = [2.33628507e-01 6.12918608e-01 2.07633221e+00 1.17616813e+05
 4.45992460e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104166e+04 3.67546967e+04 7.30201527e+03
 1.83757594e+04 1.44585486e+03 4.17569721e+02 1.48031699e+02
 5.97109381e+01 2.63884547e+01 9.59585743e+00 8.60424975e+00
 4.92743560e-01]
grad_E = [ 3.79720997e-04 -2.22616396e-04  3.76059378e-06  5.98196612e-09
 -2.03069183e-05  3.95372971e-11  1.71520447e-10  9.27983538e-10
  3.66540377e-09  1.53034444e-08  7.99107228e-08  5.04444106e-06
  1.95027523e-07 -3.77632026e-05 -5.25863007e-06  6.46212600e-06
 -1.10638540e-04  1.23576393e-04  1.91250109e-05 -2.78988032e-06
 -2.45408514e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234631946845       1
[INPUT] 0    0    [1    /1   ]  0.616314435406       1
[INPUT] 0    0    [1    /1   ]  2.11778487052        1
[INPUT] 0    0    [1    /1   ]  117616.812416        1
[INPUT] 0    0    [1    /1   ]  4.56067384886        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030848        1
[INPUT] 0    0    [1    /1   ]  147020.991033        1
[INPUT] 0    0    [1    /1   ]  73510.4163362        1
[INPUT] 0    0    [1    /1   ]  36754.6952138        1
[INPUT] 0    0    [1    /1   ]  7301.92302013        1
[INPUT] 0    0    [1    /1   ]  18375.7558401        1
[INPUT] 0    0    [1    /1   ]  1446.5549497         1
[INPUT] 0    0    [1    /1   ]  417.639396803        1
[INPUT] 0    0    [1    /1   ]  148.070476448        1
[INPUT] 0    0    [1    /1   ]  60.2141721118        1
[INPUT] 0    0    [1    /1   ]  26.8531279717        1
[INPUT] 0    0    [1    /1   ]  9.74280964043        1
[INPUT] 1    0    [1    /1   ]  8.60427425763        1
[INPUT] 1    0    [1    /1   ]  0.492748475406       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23463194684494487, 1.0]], [0, [0.6163144354064835, 1.0]], [0, [2.117784870522389, 1.0]], [0, [117616.81241584201, 1.0]], [0, [4.560673848857176, 1.0]], [0, [1176168.142610291, 1.0]], [0, [588084.0699429507, 1.0]], [0, [294042.03084796766, 1.0]], [0, [147020.9910330389, 1.0]], [0, [73510.41633621807, 1.0]], [0, [36754.69521382563, 1.0]], [0, [7301.9230201337505, 1.0]], [0, [18375.75584010457, 1.0]], [0, [1446.5549496969036, 1.0]], [0, [417.6393968033214, 1.0]], [0, [148.07047644767832, 1.0]], [0, [60.21417211179082, 1.0]], [0, [26.85312797167297, 1.0]], [0, [9.742809640431725, 1.0]], [1, [8.604274257625342, 1.0]], [1, [0.4927484754056, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23463195]
bas 1, expnt(s) = [0.61631444]
bas 2, expnt(s) = [2.11778487]
bas 3, expnt(s) = [117616.81241584]
bas 4, expnt(s) = [4.56067385]
bas 5, expnt(s) = [1176168.14261029]
bas 6, expnt(s) = [588084.06994295]
bas 7, expnt(s) = [294042.03084797]
bas 8, expnt(s) = [147020.99103304]
bas 9, expnt(s) = [73510.41633622]
bas 10, expnt(s) = [36754.69521383]
bas 11, expnt(s) = [7301.92302013]
bas 12, expnt(s) = [18375.7558401]
bas 13, expnt(s) = [1446.5549497]
bas 14, expnt(s) = [417.6393968]
bas 15, expnt(s) = [148.07047645]
bas 16, expnt(s) = [60.21417211]
bas 17, expnt(s) = [26.85312797]
bas 18, expnt(s) = [9.74280964]
bas 19, expnt(s) = [8.60427426]
bas 20, expnt(s) = [0.49274848]
CPU time:      1469.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34631947e-01 8.51736742e-01 6.16314435e-01 1.75738445e+00
 2.11778487e+00 4.43533477e+00 1.17616812e+05 1.60460107e+04
 4.56067385e+00 7.88472926e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546952e+04 6.70655736e+03 7.30192302e+03 1.99568945e+03
 1.83757558e+04 3.98748381e+03 1.44655495e+03 5.92606248e+02
 4.17639397e+02 2.33408205e+02 1.48070476e+02 1.07242364e+02
 6.02141721e+01 5.46121235e+01 2.68531280e+01 2.98030825e+01
 9.74280964e+00 1.39324723e+01 8.60427426e+00 4.29909655e+01
 4.92748475e-01 1.20438685e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336056978271102
cond(S) = 913095.4062006939
E1 = -689.5967104039194  E_coul = 184.9708338198682
init E= -504.625876584051
    CPU time for initialize scf      0.74 sec, wall time      0.07 sec
  HOMO = -0.672192612605647  LUMO = 0.581141982756731
  mo_energy =
[-1.21709897e+02 -1.33864001e+01 -7.62364522e+00 -7.62364522e+00
 -7.62364522e+00 -1.65753258e+00 -6.72192613e-01 -6.72192613e-01
 -6.72192613e-01  5.81141983e-01  5.62270860e+00  2.47654381e+01
  8.94272749e+01  2.91865668e+02  9.23885014e+02  3.17922959e+03
  1.26619584e+04  4.12584581e+04  1.05285402e+05  2.30457506e+05
  4.56264253e+05  8.45210284e+05  1.52838152e+06  2.85064150e+06
  5.80851926e+06]
E1 = -707.7530933912543  E_coul = 199.78043074777733
cycle= 1 E= -507.972662643477  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.761469
diis-c [-0.57983558  1.        ]
  HOMO = -0.21767235003533  LUMO = 0.938944227837859
  mo_energy =
[-1.20200363e+02 -1.23049448e+01 -6.59415532e+00 -6.59415532e+00
 -6.59415532e+00 -1.16332020e+00 -2.17672350e-01 -2.17672350e-01
 -2.17672350e-01  9.38944228e-01  6.28584515e+00  2.57501839e+01
  9.07134338e+01  2.93320127e+02  9.25376193e+02  3.18066172e+03
  1.26632842e+04  4.12597168e+04  1.05286624e+05  2.30458703e+05
  4.56265433e+05  8.45211451e+05  1.52838268e+06  2.85064264e+06
  5.80852040e+06]
E1 = -706.8000586426022  E_coul = 198.80961665154493
cycle= 2 E= -507.990441991057  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.404
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0336323
diis-c [-0.00112939 -0.00174071  1.00174071]
  HOMO = -0.239771441357863  LUMO = 0.934740013822155
  mo_energy =
[-1.20315041e+02 -1.23725199e+01 -6.66898764e+00 -6.66898764e+00
 -6.66898764e+00 -1.17753545e+00 -2.39771441e-01 -2.39771441e-01
 -2.39771441e-01  9.34740014e-01  6.25450292e+00  2.56903033e+01
  9.06282499e+01  2.93215319e+02  9.25255899e+02  3.18052710e+03
  1.26631394e+04  4.12595681e+04  1.05286473e+05  2.30458552e+05
  4.56265282e+05  8.45211299e+05  1.52838253e+06  2.85064249e+06
  5.80852025e+06]
E1 = -706.6922225400618  E_coul = 198.70152025230234
cycle= 3 E= -507.99070228776  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00362682
diis-c [-3.02432606e-06  1.14942273e-04 -1.04869992e-01  1.10475505e+00]
  HOMO = -0.242914514714429  LUMO = 0.933912261230649
  mo_energy =
[-1.20326823e+02 -1.23810820e+01 -6.67803779e+00 -6.67803779e+00
 -6.67803779e+00 -1.17943946e+00 -2.42914515e-01 -2.42914515e-01
 -2.42914515e-01  9.33912261e-01  6.24991469e+00  2.56826309e+01
  9.06184732e+01  2.93204189e+02  9.25243878e+02  3.18051437e+03
  1.26631262e+04  4.12595547e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6770057667627  E_coul = 198.68629848512637
cycle= 4 E= -507.990707281636  delta_E= -4.99e-06  |g|= 0.000234  |ddm|= 0.01
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170115
diis-c [-4.17892349e-10 -8.89488506e-06  6.92155084e-03 -1.00410874e-01
  1.09349822e+00]
  HOMO = -0.243068330327826  LUMO = 0.933862993707579
  mo_energy =
[-1.20327195e+02 -1.23814389e+01 -6.67839197e+00 -6.67839197e+00
 -6.67839197e+00 -1.17953234e+00 -2.43068330e-01 -2.43068330e-01
 -2.43068330e-01  9.33862994e-01  6.24968721e+00  2.56823066e+01
  9.06181156e+01  2.93203821e+02  9.25243505e+02  3.18051399e+03
  1.26631258e+04  4.12595543e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6762687282273  E_coul = 198.6855614325382
cycle= 5 E= -507.990707295689  delta_E= -1.41e-08  |g|= 4.52e-06  |ddm|= 0.000627
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.03635e-06
diis-c [-6.86349346e-13  5.23838722e-07 -4.69749228e-04  6.48675444e-03
 -7.55794220e-02  1.06956189e+00]
  HOMO = -0.243070524409753  LUMO = 0.933862368735035
  mo_energy =
[-1.20327200e+02 -1.23814433e+01 -6.67839647e+00 -6.67839647e+00
 -6.67839647e+00 -1.17953386e+00 -2.43070524e-01 -2.43070524e-01
 -2.43070524e-01  9.33862369e-01  6.24968397e+00  2.56823025e+01
  9.06181109e+01  2.93203816e+02  9.25243500e+02  3.18051398e+03
  1.26631258e+04  4.12595543e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6762577125446  E_coul = 198.6855504168515
cycle= 6 E= -507.990707295693  delta_E= -3.98e-12  |g|= 9.19e-08  |ddm|= 1.23e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6762577125446  E_coul = 198.6855504168515
  HOMO = -0.243070566726491  LUMO = 0.933862346990588
  mo_energy =
[-1.20327200e+02 -1.23814434e+01 -6.67839655e+00 -6.67839655e+00
 -6.67839655e+00 -1.17953388e+00 -2.43070567e-01 -2.43070567e-01
 -2.43070567e-01  9.33862347e-01  6.24968390e+00  2.56823024e+01
  9.06181108e+01  2.93203816e+02  9.25243499e+02  3.18051398e+03
  1.26631258e+04  4.12595543e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6762575189499  E_coul = 198.68555022325637
Extra cycle  E= -507.990707295694  delta_E= -3.98e-13  |g|= 1.15e-08  |ddm|= 2.1e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.34631947e-01 6.16314435e-01 2.11778487e+00 1.17616812e+05
 4.56067385e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546952e+04 7.30192302e+03
 1.83757558e+04 1.44655495e+03 4.17639397e+02 1.48070476e+02
 6.02141721e+01 2.68531280e+01 9.74280964e+00 8.60427426e+00
 4.92748475e-01]
E = -507.99070729569354
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234631946845       1
[INPUT] 0    0    [1    /1   ]  0.616314435406       1
[INPUT] 0    0    [1    /1   ]  2.11778487052        1
[INPUT] 0    0    [1    /1   ]  117616.812416        1
[INPUT] 0    0    [1    /1   ]  4.56067384886        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030848        1
[INPUT] 0    0    [1    /1   ]  147020.991033        1
[INPUT] 0    0    [1    /1   ]  73510.4163362        1
[INPUT] 0    0    [1    /1   ]  36754.6952138        1
[INPUT] 0    0    [1    /1   ]  7301.92302013        1
[INPUT] 0    0    [1    /1   ]  18375.7558401        1
[INPUT] 0    0    [1    /1   ]  1446.5549497         1
[INPUT] 0    0    [1    /1   ]  417.639396803        1
[INPUT] 0    0    [1    /1   ]  148.070476448        1
[INPUT] 0    0    [1    /1   ]  60.2141721118        1
[INPUT] 0    0    [1    /1   ]  26.8531279717        1
[INPUT] 0    0    [1    /1   ]  9.74280964043        1
[INPUT] 1    0    [1    /1   ]  8.60427425763        1
[INPUT] 1    0    [1    /1   ]  0.492748475406       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23463194684494487, 1.0]], [0, [0.6163144354064835, 1.0]], [0, [2.117784870522389, 1.0]], [0, [117616.81241584201, 1.0]], [0, [4.560673848857176, 1.0]], [0, [1176168.142610291, 1.0]], [0, [588084.0699429507, 1.0]], [0, [294042.03084796766, 1.0]], [0, [147020.9910330389, 1.0]], [0, [73510.41633621807, 1.0]], [0, [36754.69521382563, 1.0]], [0, [7301.9230201337505, 1.0]], [0, [18375.75584010457, 1.0]], [0, [1446.5549496969036, 1.0]], [0, [417.6393968033214, 1.0]], [0, [148.07047644767832, 1.0]], [0, [60.21417211179082, 1.0]], [0, [26.85312797167297, 1.0]], [0, [9.742809640431725, 1.0]], [1, [8.604274257625342, 1.0]], [1, [0.4927484754056, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23463195]
bas 1, expnt(s) = [0.61631444]
bas 2, expnt(s) = [2.11778487]
bas 3, expnt(s) = [117616.81241584]
bas 4, expnt(s) = [4.56067385]
bas 5, expnt(s) = [1176168.14261029]
bas 6, expnt(s) = [588084.06994295]
bas 7, expnt(s) = [294042.03084797]
bas 8, expnt(s) = [147020.99103304]
bas 9, expnt(s) = [73510.41633622]
bas 10, expnt(s) = [36754.69521383]
bas 11, expnt(s) = [7301.92302013]
bas 12, expnt(s) = [18375.7558401]
bas 13, expnt(s) = [1446.5549497]
bas 14, expnt(s) = [417.6393968]
bas 15, expnt(s) = [148.07047645]
bas 16, expnt(s) = [60.21417211]
bas 17, expnt(s) = [26.85312797]
bas 18, expnt(s) = [9.74280964]
bas 19, expnt(s) = [8.60427426]
bas 20, expnt(s) = [0.49274848]
CPU time:      1471.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34631947e-01 8.51736742e-01 6.16314435e-01 1.75738445e+00
 2.11778487e+00 4.43533477e+00 1.17616812e+05 1.60460107e+04
 4.56067385e+00 7.88472926e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546952e+04 6.70655736e+03 7.30192302e+03 1.99568945e+03
 1.83757558e+04 3.98748381e+03 1.44655495e+03 5.92606248e+02
 4.17639397e+02 2.33408205e+02 1.48070476e+02 1.07242364e+02
 6.02141721e+01 5.46121235e+01 2.68531280e+01 2.98030825e+01
 9.74280964e+00 1.39324723e+01 8.60427426e+00 4.29909655e+01
 4.92748475e-01 1.20438685e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336056978271102
cond(S) = 913095.4062006939
E1 = -689.5967104039194  E_coul = 184.9708338198682
init E= -504.625876584051
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672192612605647  LUMO = 0.581141982756731
  mo_energy =
[-1.21709897e+02 -1.33864001e+01 -7.62364522e+00 -7.62364522e+00
 -7.62364522e+00 -1.65753258e+00 -6.72192613e-01 -6.72192613e-01
 -6.72192613e-01  5.81141983e-01  5.62270860e+00  2.47654381e+01
  8.94272749e+01  2.91865668e+02  9.23885014e+02  3.17922959e+03
  1.26619584e+04  4.12584581e+04  1.05285402e+05  2.30457506e+05
  4.56264253e+05  8.45210284e+05  1.52838152e+06  2.85064150e+06
  5.80851926e+06]
E1 = -707.7530933912543  E_coul = 199.78043074777733
cycle= 1 E= -507.972662643477  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.761469
diis-c [-0.57983558  1.        ]
  HOMO = -0.21767235003533  LUMO = 0.938944227837859
  mo_energy =
[-1.20200363e+02 -1.23049448e+01 -6.59415532e+00 -6.59415532e+00
 -6.59415532e+00 -1.16332020e+00 -2.17672350e-01 -2.17672350e-01
 -2.17672350e-01  9.38944228e-01  6.28584515e+00  2.57501839e+01
  9.07134338e+01  2.93320127e+02  9.25376193e+02  3.18066172e+03
  1.26632842e+04  4.12597168e+04  1.05286624e+05  2.30458703e+05
  4.56265433e+05  8.45211451e+05  1.52838268e+06  2.85064264e+06
  5.80852040e+06]
E1 = -706.8000586426022  E_coul = 198.80961665154493
cycle= 2 E= -507.990441991057  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.404
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0336323
diis-c [-0.00112939 -0.00174071  1.00174071]
  HOMO = -0.239771441357863  LUMO = 0.934740013822155
  mo_energy =
[-1.20315041e+02 -1.23725199e+01 -6.66898764e+00 -6.66898764e+00
 -6.66898764e+00 -1.17753545e+00 -2.39771441e-01 -2.39771441e-01
 -2.39771441e-01  9.34740014e-01  6.25450292e+00  2.56903033e+01
  9.06282499e+01  2.93215319e+02  9.25255899e+02  3.18052710e+03
  1.26631394e+04  4.12595681e+04  1.05286473e+05  2.30458552e+05
  4.56265282e+05  8.45211299e+05  1.52838253e+06  2.85064249e+06
  5.80852025e+06]
E1 = -706.6922225400618  E_coul = 198.70152025230234
cycle= 3 E= -507.99070228776  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00362682
diis-c [-3.02432606e-06  1.14942273e-04 -1.04869992e-01  1.10475505e+00]
  HOMO = -0.242914514714429  LUMO = 0.933912261230649
  mo_energy =
[-1.20326823e+02 -1.23810820e+01 -6.67803779e+00 -6.67803779e+00
 -6.67803779e+00 -1.17943946e+00 -2.42914515e-01 -2.42914515e-01
 -2.42914515e-01  9.33912261e-01  6.24991469e+00  2.56826309e+01
  9.06184732e+01  2.93204189e+02  9.25243878e+02  3.18051437e+03
  1.26631262e+04  4.12595547e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6770057667627  E_coul = 198.68629848512637
cycle= 4 E= -507.990707281636  delta_E= -4.99e-06  |g|= 0.000234  |ddm|= 0.01
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170115
diis-c [-4.17892349e-10 -8.89488506e-06  6.92155084e-03 -1.00410874e-01
  1.09349822e+00]
  HOMO = -0.243068330327826  LUMO = 0.933862993707579
  mo_energy =
[-1.20327195e+02 -1.23814389e+01 -6.67839197e+00 -6.67839197e+00
 -6.67839197e+00 -1.17953234e+00 -2.43068330e-01 -2.43068330e-01
 -2.43068330e-01  9.33862994e-01  6.24968721e+00  2.56823066e+01
  9.06181156e+01  2.93203821e+02  9.25243505e+02  3.18051399e+03
  1.26631258e+04  4.12595543e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6762687282273  E_coul = 198.6855614325382
cycle= 5 E= -507.990707295689  delta_E= -1.41e-08  |g|= 4.52e-06  |ddm|= 0.000627
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.03635e-06
diis-c [-6.86349346e-13  5.23838722e-07 -4.69749228e-04  6.48675444e-03
 -7.55794220e-02  1.06956189e+00]
  HOMO = -0.243070524409753  LUMO = 0.933862368735035
  mo_energy =
[-1.20327200e+02 -1.23814433e+01 -6.67839647e+00 -6.67839647e+00
 -6.67839647e+00 -1.17953386e+00 -2.43070524e-01 -2.43070524e-01
 -2.43070524e-01  9.33862369e-01  6.24968397e+00  2.56823025e+01
  9.06181109e+01  2.93203816e+02  9.25243500e+02  3.18051398e+03
  1.26631258e+04  4.12595543e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6762577125446  E_coul = 198.6855504168515
cycle= 6 E= -507.990707295693  delta_E= -3.98e-12  |g|= 9.19e-08  |ddm|= 1.23e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6762577125446  E_coul = 198.6855504168515
  HOMO = -0.243070566726491  LUMO = 0.933862346990588
  mo_energy =
[-1.20327200e+02 -1.23814434e+01 -6.67839655e+00 -6.67839655e+00
 -6.67839655e+00 -1.17953388e+00 -2.43070567e-01 -2.43070567e-01
 -2.43070567e-01  9.33862347e-01  6.24968390e+00  2.56823024e+01
  9.06181108e+01  2.93203816e+02  9.25243499e+02  3.18051398e+03
  1.26631258e+04  4.12595543e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6762575189499  E_coul = 198.68555022325637
Extra cycle  E= -507.990707295694  delta_E= -3.98e-13  |g|= 1.15e-08  |ddm|= 2.1e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913095.4062006939
E1 = -706.6762575189499  E_coul = 198.68555022325637
init E= -507.990707295694
    CPU time for initialize scf      5.78 sec, wall time      0.24 sec
  HOMO = -0.243070572931282  LUMO = 0.933862343782352
  mo_energy =
[-1.20327200e+02 -1.23814434e+01 -6.67839656e+00 -6.67839656e+00
 -6.67839656e+00 -1.17953388e+00 -2.43070573e-01 -2.43070573e-01
 -2.43070573e-01  9.33862344e-01  6.24968389e+00  2.56823024e+01
  9.06181108e+01  2.93203816e+02  9.25243499e+02  3.18051398e+03
  1.26631258e+04  4.12595543e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.6762574910568  E_coul = 198.6855501953633
cycle= 1 E= -507.990707295694  delta_E=    0  |g|= 2.58e-09  |ddm|= 2.63e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6762574910568  E_coul = 198.6855501953633
  HOMO = -0.243070573792916  LUMO = 0.933862343649733
  mo_energy =
[-1.20327200e+02 -1.23814434e+01 -6.67839657e+00 -6.67839657e+00
 -6.67839657e+00 -1.17953388e+00 -2.43070574e-01 -2.43070574e-01
 -2.43070574e-01  9.33862344e-01  6.24968389e+00  2.56823024e+01
  9.06181108e+01  2.93203816e+02  9.25243499e+02  3.18051398e+03
  1.26631258e+04  4.12595543e+04  1.05286460e+05  2.30458538e+05
  4.56265268e+05  8.45211285e+05  1.52838251e+06  2.85064248e+06
  5.80852023e+06]
E1 = -706.676257482111  E_coul = 198.68555018641774
Extra cycle  E= -507.990707295693  delta_E= 2.27e-13  |g|= 2.38e-09  |ddm|= 6.34e-09
    CPU time for scf_cycle      6.28 sec, wall time      0.41 sec
exp = [2.34631947e-01 6.16314435e-01 2.11778487e+00 1.17616812e+05
 4.56067385e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546952e+04 7.30192302e+03
 1.83757558e+04 1.44655495e+03 4.17639397e+02 1.48070476e+02
 6.02141721e+01 2.68531280e+01 9.74280964e+00 8.60427426e+00
 4.92748475e-01]
grad_E = [ 6.10512998e-04 -3.15955048e-04 -8.25194148e-05  5.98464080e-09
  5.43313100e-05  3.95672314e-11  1.71607657e-10  9.28392995e-10
  3.66705665e-09  1.53104563e-08  7.99463265e-08  5.04954423e-06
  1.95129830e-07 -3.85227273e-05  3.56102837e-06 -2.71954725e-05
 -6.02329066e-05  1.02967252e-04 -1.52559930e-06  1.26579285e-05
 -9.63877325e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.237117977469       1
[INPUT] 0    0    [1    /1   ]  0.624999853484       1
[INPUT] 0    0    [1    /1   ]  2.25696889949        1
[INPUT] 0    0    [1    /1   ]  117616.812335        1
[INPUT] 0    0    [1    /1   ]  4.73887780153        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069941        1
[INPUT] 0    0    [1    /1   ]  294042.030835        1
[INPUT] 0    0    [1    /1   ]  147020.990984        1
[INPUT] 0    0    [1    /1   ]  73510.4161303        1
[INPUT] 0    0    [1    /1   ]  36754.6941399        1
[INPUT] 0    0    [1    /1   ]  7301.85531866        1
[INPUT] 0    0    [1    /1   ]  18375.7532069        1
[INPUT] 0    0    [1    /1   ]  1447.06821633        1
[INPUT] 0    0    [1    /1   ]  417.69607083         1
[INPUT] 0    0    [1    /1   ]  148.078395244        1
[INPUT] 0    0    [1    /1   ]  60.6096703142        1
[INPUT] 0    0    [1    /1   ]  27.1725767121        1
[INPUT] 0    0    [1    /1   ]  9.98065899567        1
[INPUT] 1    0    [1    /1   ]  8.60427676045        1
[INPUT] 1    0    [1    /1   ]  0.49275233989        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23711797746874427, 1.0]], [0, [0.6249998534843639, 1.0]], [0, [2.256968899486222, 1.0]], [0, [117616.81233538344, 1.0]], [0, [4.738877801527661, 1.0]], [0, [1176168.142609754, 1.0]], [0, [588084.0699406391, 1.0]], [0, [294042.030835488, 1.0]], [0, [147020.99098373103, 1.0]], [0, [73510.41613031508, 1.0]], [0, [36754.69413986804, 1.0]], [0, [7301.855318664269, 1.0]], [0, [18375.753206926427, 1.0]], [0, [1447.0682163323431, 1.0]], [0, [417.6960708302512, 1.0]], [0, [148.07839524447664, 1.0]], [0, [60.60967031417868, 1.0]], [0, [27.17257671214387, 1.0]], [0, [9.98065899566664, 1.0]], [1, [8.604276760448371, 1.0]], [1, [0.49275233989046147, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23711798]
bas 1, expnt(s) = [0.62499985]
bas 2, expnt(s) = [2.2569689]
bas 3, expnt(s) = [117616.81233538]
bas 4, expnt(s) = [4.7388778]
bas 5, expnt(s) = [1176168.14260975]
bas 6, expnt(s) = [588084.06994064]
bas 7, expnt(s) = [294042.03083549]
bas 8, expnt(s) = [147020.99098373]
bas 9, expnt(s) = [73510.41613032]
bas 10, expnt(s) = [36754.69413987]
bas 11, expnt(s) = [7301.85531866]
bas 12, expnt(s) = [18375.75320693]
bas 13, expnt(s) = [1447.06821633]
bas 14, expnt(s) = [417.69607083]
bas 15, expnt(s) = [148.07839524]
bas 16, expnt(s) = [60.60967031]
bas 17, expnt(s) = [27.17257671]
bas 18, expnt(s) = [9.980659]
bas 19, expnt(s) = [8.60427676]
bas 20, expnt(s) = [0.49275234]
CPU time:      1486.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.37117977e-01 8.58496217e-01 6.24999853e-01 1.77592639e+00
 2.25696890e+00 4.65220887e+00 1.17616812e+05 1.60460107e+04
 4.73887780e+00 8.11468483e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104161e+04 1.12791581e+04
 3.67546941e+04 6.70655722e+03 7.30185532e+03 1.99567557e+03
 1.83757532e+04 3.98748338e+03 1.44706822e+03 5.92763942e+02
 4.17696071e+02 2.33431960e+02 1.48078395e+02 1.07246666e+02
 6.06096703e+01 5.48809304e+01 2.71725767e+01 3.00685954e+01
 9.98065900e+00 1.41867997e+01 8.60427676e+00 4.29909811e+01
 4.92752340e-01 1.20439865e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3360424143468
cond(S) = 913214.6707451183
E1 = -689.5971168466615  E_coul = 184.9711752323483
init E= -504.625941614313
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672171138184537  LUMO = 0.600497440715368
  mo_energy =
[-1.21709882e+02 -1.33863776e+01 -7.62362656e+00 -7.62362656e+00
 -7.62362656e+00 -1.65751788e+00 -6.72171138e-01 -6.72171138e-01
 -6.72171138e-01  6.00497441e-01  5.96412504e+00  2.60448033e+01
  9.21056813e+01  2.95960352e+02  9.28727418e+02  3.18451683e+03
  1.26677622e+04  4.12642102e+04  1.05290971e+05  2.30462921e+05
  4.56269553e+05  8.45215496e+05  1.52838665e+06  2.85064652e+06
  5.80852415e+06]
E1 = -707.7533895747212  E_coul = 199.78073433112436
cycle= 1 E= -507.972655243597  delta_E= -3.35  |g|= 0.452  |ddm|= 0.484
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.761794
diis-c [-0.58033037  1.        ]
  HOMO = -0.217670696854372  LUMO = 0.963236978750221
  mo_energy =
[-1.20200320e+02 -1.23049127e+01 -6.59413008e+00 -6.59413008e+00
 -6.59413008e+00 -1.16332151e+00 -2.17670697e-01 -2.17670697e-01
 -2.17670697e-01  9.63236979e-01  6.64264741e+00  2.70400329e+01
  9.33947728e+01  2.97415018e+02  9.30218510e+02  3.18594896e+03
  1.26690881e+04  4.12654689e+04  1.05292193e+05  2.30464118e+05
  4.56270733e+05  8.45216663e+05  1.52838780e+06  2.85064767e+06
  5.80852529e+06]
E1 = -706.8004454032304  E_coul = 198.81000924262952
cycle= 2 E= -507.990436160601  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.407
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0331898
diis-c [-0.00110045 -0.00138801  1.00138801]
  HOMO = -0.239771495579914  LUMO = 0.958795100213181
  mo_energy =
[-1.20314928e+02 -1.23724555e+01 -6.66892199e+00 -6.66892199e+00
 -6.66892199e+00 -1.17753851e+00 -2.39771496e-01 -2.39771496e-01
 -2.39771496e-01  9.58795100e-01  6.60999288e+00  2.69792744e+01
  9.33093197e+01  2.97310221e+02  9.30098303e+02  3.18581443e+03
  1.26689434e+04  4.12653203e+04  1.05292043e+05  2.30463967e+05
  4.56270581e+05  8.45216511e+05  1.52838765e+06  2.85064752e+06
  5.80852514e+06]
E1 = -706.6927967713892  E_coul = 198.7021011626069
cycle= 3 E= -507.990695608782  delta_E= -0.000259  |g|= 0.00436  |ddm|= 0.0595
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00355092
diis-c [-2.93198432e-06  1.20998427e-04 -1.03750663e-01  1.10362966e+00]
  HOMO = -0.24291036246977  LUMO = 0.957933216995198
  mo_energy =
[-1.20326722e+02 -1.23810182e+01 -6.67797444e+00 -6.67797444e+00
 -6.67797444e+00 -1.17943962e+00 -2.42910362e-01 -2.42910362e-01
 -2.42910362e-01  9.57933217e-01  6.60524494e+00  2.69715147e+01
  9.32995134e+01  2.97299079e+02  9.30086269e+02  3.18580168e+03
  1.26689301e+04  4.12653069e+04  1.05292030e+05  2.30463954e+05
  4.56270568e+05  8.45216497e+05  1.52838764e+06  2.85064750e+06
  5.80852512e+06]
E1 = -706.67763833374  E_coul = 198.68693778378636
cycle= 4 E= -507.990700549954  delta_E= -4.94e-06  |g|= 0.000233  |ddm|= 0.00981
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000168448
diis-c [-3.61246290e-10 -8.68224495e-06  6.91000710e-03 -1.01248613e-01
  1.09434729e+00]
  HOMO = -0.243065730072509  LUMO = 0.957882078152582
  mo_energy =
[-1.20327105e+02 -1.23813824e+01 -6.67833674e+00 -6.67833674e+00
 -6.67833674e+00 -1.17953331e+00 -2.43065730e-01 -2.43065730e-01
 -2.43065730e-01  9.57882078e-01  6.60500821e+00  2.69711819e+01
  9.32991463e+01  2.97298700e+02  9.30085883e+02  3.18580129e+03
  1.26689297e+04  4.12653065e+04  1.05292029e+05  2.30463953e+05
  4.56270568e+05  8.45216497e+05  1.52838764e+06  2.85064750e+06
  5.80852512e+06]
E1 = -706.6768962925  E_coul = 198.6861957286953
cycle= 5 E= -507.990700563805  delta_E= -1.39e-08  |g|= 3.95e-06  |ddm|= 0.000606
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.79549e-06
diis-c [-5.86248315e-13  4.82717525e-07 -4.25824961e-04  5.93447561e-03
 -6.85425302e-02  1.06303340e+00]
  HOMO = -0.243067687856267  LUMO = 0.957881520765845
  mo_energy =
[-1.20327110e+02 -1.23813864e+01 -6.67834082e+00 -6.67834082e+00
 -6.67834082e+00 -1.17953468e+00 -2.43067688e-01 -2.43067688e-01
 -2.43067688e-01  9.57881521e-01  6.60500525e+00  2.69711781e+01
  9.32991420e+01  2.97298695e+02  9.30085878e+02  3.18580129e+03
  1.26689297e+04  4.12653065e+04  1.05292029e+05  2.30463953e+05
  4.56270568e+05  8.45216497e+05  1.52838764e+06  2.85064750e+06
  5.80852512e+06]
E1 = -706.6768865009351  E_coul = 198.6861859371271
cycle= 6 E= -507.990700563808  delta_E= -3.3e-12  |g|= 8.96e-08  |ddm|= 1.04e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6768865009351  E_coul = 198.6861859371271
  HOMO = -0.243067729697051  LUMO = 0.957881498049011
  mo_energy =
[-1.20327110e+02 -1.23813865e+01 -6.67834091e+00 -6.67834091e+00
 -6.67834091e+00 -1.17953469e+00 -2.43067730e-01 -2.43067730e-01
 -2.43067730e-01  9.57881498e-01  6.60500518e+00  2.69711780e+01
  9.32991419e+01  2.97298695e+02  9.30085878e+02  3.18580129e+03
  1.26689297e+04  4.12653065e+04  1.05292029e+05  2.30463953e+05
  4.56270568e+05  8.45216497e+05  1.52838764e+06  2.85064750e+06
  5.80852512e+06]
E1 = -706.6768863101319  E_coul = 198.6861857463243
Extra cycle  E= -507.990700563808  delta_E= 4.55e-13  |g|= 1.06e-08  |ddm|= 2.01e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.37117977e-01 6.24999853e-01 2.25696890e+00 1.17616812e+05
 4.73887780e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104161e+04 3.67546941e+04 7.30185532e+03
 1.83757532e+04 1.44706822e+03 4.17696071e+02 1.48078395e+02
 6.06096703e+01 2.71725767e+01 9.98065900e+00 8.60427676e+00
 4.92752340e-01]
E = -507.99070056380754
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.235479927658       1
[INPUT] 0    0    [1    /1   ]  0.619277016725       1
[INPUT] 0    0    [1    /1   ]  2.16526030582        1
[INPUT] 0    0    [1    /1   ]  117616.812388        1
[INPUT] 0    0    [1    /1   ]  4.62145891369        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069942        1
[INPUT] 0    0    [1    /1   ]  294042.030844        1
[INPUT] 0    0    [1    /1   ]  147020.991016        1
[INPUT] 0    0    [1    /1   ]  73510.416266         1
[INPUT] 0    0    [1    /1   ]  36754.6948475        1
[INPUT] 0    0    [1    /1   ]  7301.89992728        1
[INPUT] 0    0    [1    /1   ]  18375.7549419        1
[INPUT] 0    0    [1    /1   ]  1446.73002407        1
[INPUT] 0    0    [1    /1   ]  417.658728217        1
[INPUT] 0    0    [1    /1   ]  148.073177536        1
[INPUT] 0    0    [1    /1   ]  60.3490758752        1
[INPUT] 0    0    [1    /1   ]  26.9620913931        1
[INPUT] 0    0    [1    /1   ]  9.82393965053        1
[INPUT] 1    0    [1    /1   ]  8.60427511133        1
[INPUT] 1    0    [1    /1   ]  0.492749793575       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23547992765789122, 1.0]], [0, [0.6192770167246507, 1.0]], [0, [2.1652603058207363, 1.0]], [0, [117616.81238839772, 1.0]], [0, [4.621458913694721, 1.0]], [0, [1176168.1426101078, 1.0]], [0, [588084.0699421623, 1.0]], [0, [294042.0308437109, 1.0]], [0, [147020.99101622007, 1.0]], [0, [73510.41626598491, 1.0]], [0, [36754.69484750053, 1.0]], [0, [7301.899927277782, 1.0]], [0, [18375.75494193199, 1.0]], [0, [1446.7300240723403, 1.0]], [0, [417.6587282174113, 1.0]], [0, [148.07317753578332, 1.0]], [0, [60.34907587523165, 1.0]], [0, [26.962091393139275, 1.0]], [0, [9.823939650528954, 1.0]], [1, [8.604275111334015, 1.0]], [1, [0.4927497935748064, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23547993]
bas 1, expnt(s) = [0.61927702]
bas 2, expnt(s) = [2.16526031]
bas 3, expnt(s) = [117616.8123884]
bas 4, expnt(s) = [4.62145891]
bas 5, expnt(s) = [1176168.14261011]
bas 6, expnt(s) = [588084.06994216]
bas 7, expnt(s) = [294042.03084371]
bas 8, expnt(s) = [147020.99101622]
bas 9, expnt(s) = [73510.41626598]
bas 10, expnt(s) = [36754.6948475]
bas 11, expnt(s) = [7301.89992728]
bas 12, expnt(s) = [18375.75494193]
bas 13, expnt(s) = [1446.73002407]
bas 14, expnt(s) = [417.65872822]
bas 15, expnt(s) = [148.07317754]
bas 16, expnt(s) = [60.34907588]
bas 17, expnt(s) = [26.96209139]
bas 18, expnt(s) = [9.82393965]
bas 19, expnt(s) = [8.60427511]
bas 20, expnt(s) = [0.49274979]
CPU time:      1488.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.35479928e-01 8.54044391e-01 6.19277017e-01 1.76371637e+00
 2.16526031e+00 4.50969956e+00 1.17616812e+05 1.60460107e+04
 4.62145891e+00 7.96341496e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546948e+04 6.70655731e+03 7.30189993e+03 1.99568472e+03
 1.83757549e+04 3.98748367e+03 1.44673002e+03 5.92660039e+02
 4.17658728e+02 2.33416308e+02 1.48073178e+02 1.07243831e+02
 6.03490759e+01 5.47038626e+01 2.69620914e+01 2.98937368e+01
 9.82393965e+00 1.40193955e+01 8.60427511e+00 4.29909708e+01
 4.92749794e-01 1.20439087e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33605230477565
cond(S) = 913135.9065636664
E1 = -689.5968193239701  E_coul = 184.97092596222114
init E= -504.625893361749
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672186113813803  LUMO = 0.58772866875009
  mo_energy =
[-1.21709895e+02 -1.33863959e+01 -7.62364082e+00 -7.62364082e+00
 -7.62364082e+00 -1.65752723e+00 -6.72186114e-01 -6.72186114e-01
 -6.72186114e-01  5.87728669e-01  5.73846457e+00  2.52016457e+01
  9.03416691e+01  2.93263154e+02  9.25536628e+02  3.18103236e+03
  1.26639373e+04  4.12604194e+04  1.05287301e+05  2.30459352e+05
  4.56266060e+05  8.45212061e+05  1.52838327e+06  2.85064321e+06
  5.80852093e+06]
E1 = -707.7531277375128  E_coul = 199.78046175719882
cycle= 1 E= -507.972665980314  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.76162
diis-c [-0.58006523  1.        ]
  HOMO = -0.217672163408663  LUMO = 0.947225464575965
  mo_energy =
[-1.20200359e+02 -1.23049413e+01 -6.59415323e+00 -6.59415323e+00
 -6.59415323e+00 -1.16332067e+00 -2.17672163e-01 -2.17672163e-01
 -2.17672163e-01  9.47225465e-01  6.40691456e+00  2.61900244e+01
  9.16288287e+01  2.94717676e+02  9.27027769e+02  3.18246448e+03
  1.26652631e+04  4.12616780e+04  1.05288523e+05  2.30460549e+05
  4.56267240e+05  8.45213228e+05  1.52838443e+06  2.85064436e+06
  5.80852207e+06]
E1 = -706.8001561480045  E_coul = 198.8097110739659
cycle= 2 E= -507.990445074039  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.405
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0334752
diis-c [-0.00111908 -0.00162025  1.00162025]
  HOMO = -0.23977060979626  LUMO = 0.942940308597717
  mo_energy =
[-1.20315011e+02 -1.23725028e+01 -6.66896937e+00 -6.66896937e+00
 -6.66896937e+00 -1.17753564e+00 -2.39770610e-01 -2.39770610e-01
 -2.39770610e-01  9.42940309e-01  6.37512061e+00  2.61298408e+01
  9.15435542e+01  2.94612874e+02  9.26907507e+02  3.18232989e+03
  1.26651183e+04  4.12615294e+04  1.05288372e+05  2.30460398e+05
  4.56267089e+05  8.45213076e+05  1.52838427e+06  2.85064420e+06
  5.80852191e+06]
E1 = -706.6923849743121  E_coul = 198.7016798881085
cycle= 3 E= -507.990705086204  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.0598
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00359969
diis-c [-2.99260169e-06  1.17482678e-04 -1.04462548e-01  1.10434507e+00]
  HOMO = -0.242912159271679  LUMO = 0.942100861159275
  mo_energy =
[-1.20326796e+02 -1.23810649e+01 -6.67801997e+00 -6.67801997e+00
 -6.67801997e+00 -1.17943861e+00 -2.42912159e-01 -2.42912159e-01
 -2.42912159e-01  9.42100861e-01  6.37047717e+00  2.61221382e+01
  9.15337677e+01  2.94601740e+02  9.26895482e+02  3.18231716e+03
  1.26651051e+04  4.12615160e+04  1.05288359e+05  2.30460385e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6771879570601  E_coul = 198.68647789445774
cycle= 4 E= -507.990710062602  delta_E= -4.98e-06  |g|= 0.000234  |ddm|= 0.00995
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169599
diis-c [-3.97781827e-10 -8.82581712e-06  6.91753587e-03 -1.00730416e-01
  1.09382171e+00]
  HOMO = -0.2430666174082  LUMO = 0.942050925992092
  mo_energy =
[-1.20327172e+02 -1.23814245e+01 -6.67837724e+00 -6.67837724e+00
 -6.67837724e+00 -1.17953184e+00 -2.43066617e-01 -2.43066617e-01
 -2.43066617e-01  9.42050926e-01  6.37024635e+00  2.61218108e+01
  9.15334065e+01  2.94601368e+02  9.26895104e+02  3.18231677e+03
  1.26651047e+04  4.12615156e+04  1.05288359e+05  2.30460384e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6764486451596  E_coul = 198.68573856855838
cycle= 5 E= -507.990710076601  delta_E= -1.4e-08  |g|= 4.32e-06  |ddm|= 0.00062
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.95235e-06
diis-c [-6.51890547e-13  5.10585806e-07 -4.54843341e-04  6.30324903e-03
 -7.31990497e-02  1.06735013e+00]
  HOMO = -0.243068730238356  LUMO = 0.942050325540206
  mo_energy =
[-1.20327177e+02 -1.23814288e+01 -6.67838159e+00 -6.67838159e+00
 -6.67838159e+00 -1.17953330e+00 -2.43068730e-01 -2.43068730e-01
 -2.43068730e-01  9.42050326e-01  6.37024321e+00  2.61218068e+01
  9.15334020e+01  2.94601363e+02  9.26895099e+02  3.18231677e+03
  1.26651047e+04  4.12615156e+04  1.05288359e+05  2.30460384e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6764380495885  E_coul = 198.68572797298287
cycle= 6 E= -507.990710076606  delta_E= -4.38e-12  |g|= 9.1e-08  |ddm|= 1.16e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6764380495885  E_coul = 198.68572797298287
  HOMO = -0.243068772482862  LUMO = 0.942050300858758
  mo_energy =
[-1.20327178e+02 -1.23814289e+01 -6.67838168e+00 -6.67838168e+00
 -6.67838168e+00 -1.17953332e+00 -2.43068772e-01 -2.43068772e-01
 -2.43068772e-01  9.42050301e-01  6.37024314e+00  2.61218067e+01
  9.15334019e+01  2.94601363e+02  9.26895099e+02  3.18231677e+03
  1.26651047e+04  4.12615156e+04  1.05288359e+05  2.30460384e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6764378570668  E_coul = 198.6857277804614
Extra cycle  E= -507.990710076605  delta_E= 1.71e-13  |g|= 1.13e-08  |ddm|= 2.07e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.35479928e-01 6.19277017e-01 2.16526031e+00 1.17616812e+05
 4.62145891e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546948e+04 7.30189993e+03
 1.83757549e+04 1.44673002e+03 4.17658728e+02 1.48073178e+02
 6.03490759e+01 2.69620914e+01 9.82393965e+00 8.60427511e+00
 4.92749794e-01]
E = -507.9907100766054
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.235479927658       1
[INPUT] 0    0    [1    /1   ]  0.619277016725       1
[INPUT] 0    0    [1    /1   ]  2.16526030582        1
[INPUT] 0    0    [1    /1   ]  117616.812388        1
[INPUT] 0    0    [1    /1   ]  4.62145891369        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069942        1
[INPUT] 0    0    [1    /1   ]  294042.030844        1
[INPUT] 0    0    [1    /1   ]  147020.991016        1
[INPUT] 0    0    [1    /1   ]  73510.416266         1
[INPUT] 0    0    [1    /1   ]  36754.6948475        1
[INPUT] 0    0    [1    /1   ]  7301.89992728        1
[INPUT] 0    0    [1    /1   ]  18375.7549419        1
[INPUT] 0    0    [1    /1   ]  1446.73002407        1
[INPUT] 0    0    [1    /1   ]  417.658728217        1
[INPUT] 0    0    [1    /1   ]  148.073177536        1
[INPUT] 0    0    [1    /1   ]  60.3490758752        1
[INPUT] 0    0    [1    /1   ]  26.9620913931        1
[INPUT] 0    0    [1    /1   ]  9.82393965053        1
[INPUT] 1    0    [1    /1   ]  8.60427511133        1
[INPUT] 1    0    [1    /1   ]  0.492749793575       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23547992765789122, 1.0]], [0, [0.6192770167246507, 1.0]], [0, [2.1652603058207363, 1.0]], [0, [117616.81238839772, 1.0]], [0, [4.621458913694721, 1.0]], [0, [1176168.1426101078, 1.0]], [0, [588084.0699421623, 1.0]], [0, [294042.0308437109, 1.0]], [0, [147020.99101622007, 1.0]], [0, [73510.41626598491, 1.0]], [0, [36754.69484750053, 1.0]], [0, [7301.899927277782, 1.0]], [0, [18375.75494193199, 1.0]], [0, [1446.7300240723403, 1.0]], [0, [417.6587282174113, 1.0]], [0, [148.07317753578332, 1.0]], [0, [60.34907587523165, 1.0]], [0, [26.962091393139275, 1.0]], [0, [9.823939650528954, 1.0]], [1, [8.604275111334015, 1.0]], [1, [0.4927497935748064, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23547993]
bas 1, expnt(s) = [0.61927702]
bas 2, expnt(s) = [2.16526031]
bas 3, expnt(s) = [117616.8123884]
bas 4, expnt(s) = [4.62145891]
bas 5, expnt(s) = [1176168.14261011]
bas 6, expnt(s) = [588084.06994216]
bas 7, expnt(s) = [294042.03084371]
bas 8, expnt(s) = [147020.99101622]
bas 9, expnt(s) = [73510.41626598]
bas 10, expnt(s) = [36754.6948475]
bas 11, expnt(s) = [7301.89992728]
bas 12, expnt(s) = [18375.75494193]
bas 13, expnt(s) = [1446.73002407]
bas 14, expnt(s) = [417.65872822]
bas 15, expnt(s) = [148.07317754]
bas 16, expnt(s) = [60.34907588]
bas 17, expnt(s) = [26.96209139]
bas 18, expnt(s) = [9.82393965]
bas 19, expnt(s) = [8.60427511]
bas 20, expnt(s) = [0.49274979]
CPU time:      1491.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.35479928e-01 8.54044391e-01 6.19277017e-01 1.76371637e+00
 2.16526031e+00 4.50969956e+00 1.17616812e+05 1.60460107e+04
 4.62145891e+00 7.96341496e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546948e+04 6.70655731e+03 7.30189993e+03 1.99568472e+03
 1.83757549e+04 3.98748367e+03 1.44673002e+03 5.92660039e+02
 4.17658728e+02 2.33416308e+02 1.48073178e+02 1.07243831e+02
 6.03490759e+01 5.47038626e+01 2.69620914e+01 2.98937368e+01
 9.82393965e+00 1.40193955e+01 8.60427511e+00 4.29909708e+01
 4.92749794e-01 1.20439087e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33605230477565
cond(S) = 913135.9065636664
E1 = -689.5968193239701  E_coul = 184.97092596222114
init E= -504.625893361749
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672186113813803  LUMO = 0.58772866875009
  mo_energy =
[-1.21709895e+02 -1.33863959e+01 -7.62364082e+00 -7.62364082e+00
 -7.62364082e+00 -1.65752723e+00 -6.72186114e-01 -6.72186114e-01
 -6.72186114e-01  5.87728669e-01  5.73846457e+00  2.52016457e+01
  9.03416691e+01  2.93263154e+02  9.25536628e+02  3.18103236e+03
  1.26639373e+04  4.12604194e+04  1.05287301e+05  2.30459352e+05
  4.56266060e+05  8.45212061e+05  1.52838327e+06  2.85064321e+06
  5.80852093e+06]
E1 = -707.7531277375128  E_coul = 199.78046175719882
cycle= 1 E= -507.972665980314  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.76162
diis-c [-0.58006523  1.        ]
  HOMO = -0.217672163408663  LUMO = 0.947225464575965
  mo_energy =
[-1.20200359e+02 -1.23049413e+01 -6.59415323e+00 -6.59415323e+00
 -6.59415323e+00 -1.16332067e+00 -2.17672163e-01 -2.17672163e-01
 -2.17672163e-01  9.47225465e-01  6.40691456e+00  2.61900244e+01
  9.16288287e+01  2.94717676e+02  9.27027769e+02  3.18246448e+03
  1.26652631e+04  4.12616780e+04  1.05288523e+05  2.30460549e+05
  4.56267240e+05  8.45213228e+05  1.52838443e+06  2.85064436e+06
  5.80852207e+06]
E1 = -706.8001561480045  E_coul = 198.8097110739659
cycle= 2 E= -507.990445074039  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.405
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0334752
diis-c [-0.00111908 -0.00162025  1.00162025]
  HOMO = -0.23977060979626  LUMO = 0.942940308597717
  mo_energy =
[-1.20315011e+02 -1.23725028e+01 -6.66896937e+00 -6.66896937e+00
 -6.66896937e+00 -1.17753564e+00 -2.39770610e-01 -2.39770610e-01
 -2.39770610e-01  9.42940309e-01  6.37512061e+00  2.61298408e+01
  9.15435542e+01  2.94612874e+02  9.26907507e+02  3.18232989e+03
  1.26651183e+04  4.12615294e+04  1.05288372e+05  2.30460398e+05
  4.56267089e+05  8.45213076e+05  1.52838427e+06  2.85064420e+06
  5.80852191e+06]
E1 = -706.6923849743121  E_coul = 198.7016798881085
cycle= 3 E= -507.990705086204  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.0598
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00359969
diis-c [-2.99260169e-06  1.17482678e-04 -1.04462548e-01  1.10434507e+00]
  HOMO = -0.242912159271679  LUMO = 0.942100861159275
  mo_energy =
[-1.20326796e+02 -1.23810649e+01 -6.67801997e+00 -6.67801997e+00
 -6.67801997e+00 -1.17943861e+00 -2.42912159e-01 -2.42912159e-01
 -2.42912159e-01  9.42100861e-01  6.37047717e+00  2.61221382e+01
  9.15337677e+01  2.94601740e+02  9.26895482e+02  3.18231716e+03
  1.26651051e+04  4.12615160e+04  1.05288359e+05  2.30460385e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6771879570601  E_coul = 198.68647789445774
cycle= 4 E= -507.990710062602  delta_E= -4.98e-06  |g|= 0.000234  |ddm|= 0.00995
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169599
diis-c [-3.97781827e-10 -8.82581712e-06  6.91753587e-03 -1.00730416e-01
  1.09382171e+00]
  HOMO = -0.2430666174082  LUMO = 0.942050925992092
  mo_energy =
[-1.20327172e+02 -1.23814245e+01 -6.67837724e+00 -6.67837724e+00
 -6.67837724e+00 -1.17953184e+00 -2.43066617e-01 -2.43066617e-01
 -2.43066617e-01  9.42050926e-01  6.37024635e+00  2.61218108e+01
  9.15334065e+01  2.94601368e+02  9.26895104e+02  3.18231677e+03
  1.26651047e+04  4.12615156e+04  1.05288359e+05  2.30460384e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6764486451596  E_coul = 198.68573856855838
cycle= 5 E= -507.990710076601  delta_E= -1.4e-08  |g|= 4.32e-06  |ddm|= 0.00062
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.95235e-06
diis-c [-6.51890547e-13  5.10585806e-07 -4.54843341e-04  6.30324903e-03
 -7.31990497e-02  1.06735013e+00]
  HOMO = -0.243068730238356  LUMO = 0.942050325540206
  mo_energy =
[-1.20327177e+02 -1.23814288e+01 -6.67838159e+00 -6.67838159e+00
 -6.67838159e+00 -1.17953330e+00 -2.43068730e-01 -2.43068730e-01
 -2.43068730e-01  9.42050326e-01  6.37024321e+00  2.61218068e+01
  9.15334020e+01  2.94601363e+02  9.26895099e+02  3.18231677e+03
  1.26651047e+04  4.12615156e+04  1.05288359e+05  2.30460384e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6764380495885  E_coul = 198.68572797298287
cycle= 6 E= -507.990710076606  delta_E= -4.38e-12  |g|= 9.1e-08  |ddm|= 1.16e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6764380495885  E_coul = 198.68572797298287
  HOMO = -0.243068772482862  LUMO = 0.942050300858758
  mo_energy =
[-1.20327178e+02 -1.23814289e+01 -6.67838168e+00 -6.67838168e+00
 -6.67838168e+00 -1.17953332e+00 -2.43068772e-01 -2.43068772e-01
 -2.43068772e-01  9.42050301e-01  6.37024314e+00  2.61218067e+01
  9.15334019e+01  2.94601363e+02  9.26895099e+02  3.18231677e+03
  1.26651047e+04  4.12615156e+04  1.05288359e+05  2.30460384e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6764378570668  E_coul = 198.6857277804614
Extra cycle  E= -507.990710076605  delta_E= 1.71e-13  |g|= 1.13e-08  |ddm|= 2.07e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913135.9065636664
E1 = -706.6764378570668  E_coul = 198.6857277804614
init E= -507.990710076605
    CPU time for initialize scf      5.67 sec, wall time      0.24 sec
  HOMO = -0.243068778622327  LUMO = 0.942050298811692
  mo_energy =
[-1.20327178e+02 -1.23814289e+01 -6.67838169e+00 -6.67838169e+00
 -6.67838169e+00 -1.17953332e+00 -2.43068779e-01 -2.43068779e-01
 -2.43068779e-01  9.42050299e-01  6.37024313e+00  2.61218067e+01
  9.15334019e+01  2.94601363e+02  9.26895099e+02  3.18231677e+03
  1.26651047e+04  4.12615156e+04  1.05288359e+05  2.30460384e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6764378288689  E_coul = 198.68572775226355
cycle= 1 E= -507.990710076605  delta_E= 1.14e-13  |g|= 2.04e-09  |ddm|= 2.6e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6764378288689  E_coul = 198.68572775226355
  HOMO = -0.243068779496277  LUMO = 0.942050298873767
  mo_energy =
[-1.20327178e+02 -1.23814289e+01 -6.67838169e+00 -6.67838169e+00
 -6.67838169e+00 -1.17953333e+00 -2.43068779e-01 -2.43068779e-01
 -2.43068779e-01  9.42050299e-01  6.37024313e+00  2.61218067e+01
  9.15334019e+01  2.94601363e+02  9.26895099e+02  3.18231677e+03
  1.26651047e+04  4.12615156e+04  1.05288359e+05  2.30460384e+05
  4.56267075e+05  8.45213062e+05  1.52838426e+06  2.85064419e+06
  5.80852190e+06]
E1 = -706.6764378261448  E_coul = 198.68572774953952
Extra cycle  E= -507.990710076605  delta_E=    0  |g|= 1.42e-09  |ddm|= 2.99e-09
    CPU time for scf_cycle      6.17 sec, wall time      0.41 sec
exp = [2.35479928e-01 6.19277017e-01 2.16526031e+00 1.17616812e+05
 4.62145891e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546948e+04 7.30189993e+03
 1.83757549e+04 1.44673002e+03 4.17658728e+02 1.48073178e+02
 6.03490759e+01 2.69620914e+01 9.82393965e+00 8.60427511e+00
 4.92749794e-01]
grad_E = [-2.34908463e-04  1.40881462e-04  7.91963987e-05  5.98838889e-09
 -5.91936118e-05  3.96093759e-11  1.71730387e-10  9.28967869e-10
  3.66937691e-09  1.53202757e-08  7.99942158e-08  5.05333992e-06
  1.95282279e-07 -3.88198327e-05  6.66720235e-06 -3.88353025e-05
 -4.21664057e-05  9.25798562e-05  2.01363116e-05  1.59114782e-05
  5.66307274e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234279123723       1
[INPUT] 0    0    [1    /1   ]  0.615015295565       1
[INPUT] 0    0    [1    /1   ]  2.12996016277        1
[INPUT] 0    0    [1    /1   ]  117616.812338        1
[INPUT] 0    0    [1    /1   ]  4.58023790327        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069941        1
[INPUT] 0    0    [1    /1   ]  294042.030836        1
[INPUT] 0    0    [1    /1   ]  147020.990985        1
[INPUT] 0    0    [1    /1   ]  73510.4161364        1
[INPUT] 0    0    [1    /1   ]  36754.6941714        1
[INPUT] 0    0    [1    /1   ]  7301.85730827        1
[INPUT] 0    0    [1    /1   ]  18375.7532844        1
[INPUT] 0    0    [1    /1   ]  1447.0528347         1
[INPUT] 0    0    [1    /1   ]  417.697875601        1
[INPUT] 0    0    [1    /1   ]  148.060699973        1
[INPUT] 0    0    [1    /1   ]  60.659432109         1
[INPUT] 0    0    [1    /1   ]  27.1188373328        1
[INPUT] 0    0    [1    /1   ]  9.74490115592        1
[INPUT] 1    0    [1    /1   ]  8.60422765412        1
[INPUT] 1    0    [1    /1   ]  0.492746468828       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23427912372293874, 1.0]], [0, [0.6150152955648832, 1.0]], [0, [2.1299601627745006, 1.0]], [0, [117616.81233774865, 1.0]], [0, [4.580237903272363, 1.0]], [0, [1176168.1426097697, 1.0]], [0, [588084.0699407072, 1.0]], [0, [294042.0308358548, 1.0]], [0, [147020.9909851806, 1.0]], [0, [73510.4161363687, 1.0]], [0, [36754.69417143036, 1.0]], [0, [7301.857308269701, 1.0]], [0, [18375.753284438568, 1.0]], [0, [1447.0528346968442, 1.0]], [0, [417.697875600753, 1.0]], [0, [148.06069997280918, 1.0]], [0, [60.65943210895404, 1.0]], [0, [27.11883733276076, 1.0]], [0, [9.744901155920852, 1.0]], [1, [8.604227654119379, 1.0]], [1, [0.4927464688283363, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23427912]
bas 1, expnt(s) = [0.6150153]
bas 2, expnt(s) = [2.12996016]
bas 3, expnt(s) = [117616.81233775]
bas 4, expnt(s) = [4.5802379]
bas 5, expnt(s) = [1176168.14260977]
bas 6, expnt(s) = [588084.06994071]
bas 7, expnt(s) = [294042.03083585]
bas 8, expnt(s) = [147020.99098518]
bas 9, expnt(s) = [73510.41613637]
bas 10, expnt(s) = [36754.69417143]
bas 11, expnt(s) = [7301.85730827]
bas 12, expnt(s) = [18375.75328444]
bas 13, expnt(s) = [1447.0528347]
bas 14, expnt(s) = [417.6978756]
bas 15, expnt(s) = [148.06069997]
bas 16, expnt(s) = [60.65943211]
bas 17, expnt(s) = [27.11883733]
bas 18, expnt(s) = [9.74490116]
bas 19, expnt(s) = [8.60422765]
bas 20, expnt(s) = [0.49274647]
CPU time:      1505.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34279124e-01 8.50775975e-01 6.15015296e-01 1.75460540e+00
 2.12996016e+00 4.45444535e+00 1.17616812e+05 1.60460107e+04
 4.58023790e+00 7.91008320e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104161e+04 1.12791581e+04
 3.67546942e+04 6.70655722e+03 7.30185731e+03 1.99567598e+03
 1.83757533e+04 3.98748340e+03 1.44705283e+03 5.92759217e+02
 4.17697876e+02 2.33432717e+02 1.48060700e+02 1.07237054e+02
 6.06594321e+01 5.49147207e+01 2.71188373e+01 3.00239843e+01
 9.74490116e+00 1.39347154e+01 8.60422765e+00 4.29906744e+01
 4.92746469e-01 1.20438072e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336061067140644
cond(S) = 913147.7930864175
E1 = -689.5951924399299  E_coul = 184.97043876897638
init E= -504.624753670954
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672199297404712  LUMO = 0.57959578857278
  mo_energy =
[-1.21709965e+02 -1.33864291e+01 -7.62367287e+00 -7.62367287e+00
 -7.62367287e+00 -1.65753146e+00 -6.72199297e-01 -6.72199297e-01
 -6.72199297e-01  5.79595789e-01  5.64401387e+00  2.48841862e+01
  9.00620419e+01  2.93698129e+02  9.26593589e+02  3.18256731e+03
  1.26660079e+04  4.12625739e+04  1.05289401e+05  2.30461394e+05
  4.56268058e+05  8.45214025e+05  1.52838520e+06  2.85064510e+06
  5.80852277e+06]
E1 = -707.7524794841785  E_coul = 199.7798059635702
cycle= 1 E= -507.972673520608  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.761462
diis-c [-0.57982459  1.        ]
  HOMO = -0.217680066813513  LUMO = 0.937269934724722
  mo_energy =
[-1.20200464e+02 -1.23049912e+01 -6.59420274e+00 -6.59420274e+00
 -6.59420274e+00 -1.16332306e+00 -2.17680067e-01 -2.17680067e-01
 -2.17680067e-01  9.37269935e-01  6.30857173e+00  2.58704667e+01
  9.13499528e+01  2.95153080e+02  9.28084750e+02  3.18399938e+03
  1.26673337e+04  4.12638325e+04  1.05290623e+05  2.30462591e+05
  4.56269238e+05  8.45215192e+05  1.52838636e+06  2.85064625e+06
  5.80852391e+06]
E1 = -706.7996021844133  E_coul = 198.8091537186554
cycle= 2 E= -507.990448465758  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.404
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0335795
diis-c [-0.00112604 -0.00163939  1.00163939]
  HOMO = -0.239774092976584  LUMO = 0.933067259913265
  mo_energy =
[-1.20315112e+02 -1.23725471e+01 -6.66901430e+00 -6.66901430e+00
 -6.66901430e+00 -1.17753542e+00 -2.39774093e-01 -2.39774093e-01
 -2.39774093e-01  9.33067260e-01  6.27713279e+00  2.58104810e+01
  9.12646323e+01  2.95048228e+02  9.27964483e+02  3.18386480e+03
  1.26671889e+04  4.12636838e+04  1.05290472e+05  2.30462440e+05
  4.56269086e+05  8.45215040e+05  1.52838621e+06  2.85064610e+06
  5.80852376e+06]
E1 = -706.691737895196  E_coul = 198.7010289198349
cycle= 3 E= -507.990708975361  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00362414
diis-c [-3.01418731e-06  1.10693456e-04 -1.04986715e-01  1.10487602e+00]
  HOMO = -0.24292125837801  LUMO = 0.932238639677088
  mo_energy =
[-1.20326909e+02 -1.23811195e+01 -6.67807546e+00 -6.67807546e+00
 -6.67807546e+00 -1.17944213e+00 -2.42921258e-01 -2.42921258e-01
 -2.42921258e-01  9.32238640e-01  6.27252516e+00  2.58027879e+01
  9.12548314e+01  2.95037079e+02  9.27952446e+02  3.18385205e+03
  1.26671757e+04  4.12636704e+04  1.05290459e+05  2.30462427e+05
  4.56269073e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6764935741191  E_coul = 198.6857795872775
cycle= 4 E= -507.990713986842  delta_E= -5.01e-06  |g|= 0.000234  |ddm|= 0.01
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017006
diis-c [-4.17934942e-10 -8.86590170e-06  6.94352645e-03 -1.00571736e-01
  1.09363708e+00]
  HOMO = -0.243075396946958  LUMO = 0.932189277515607
  mo_energy =
[-1.20327281e+02 -1.23814770e+01 -6.67843034e+00 -6.67843034e+00
 -6.67843034e+00 -1.17953519e+00 -2.43075397e-01 -2.43075397e-01
 -2.43075397e-01  9.32189278e-01  6.27229662e+00  2.58024627e+01
  9.12544730e+01  2.95036710e+02  9.27952072e+02  3.18385167e+03
  1.26671753e+04  4.12636701e+04  1.05290458e+05  2.30462426e+05
  4.56269072e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6757545289834  E_coul = 198.6850405280239
cycle= 5 E= -507.990714000959  delta_E= -1.41e-08  |g|= 4.5e-06  |ddm|= 0.000627
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.03184e-06
diis-c [-6.81946567e-13  5.17597093e-07 -4.69196678e-04  6.46934322e-03
 -7.52973183e-02  1.06929665e+00]
  HOMO = -0.243077586327161  LUMO = 0.93218865709149
  mo_energy =
[-1.20327286e+02 -1.23814814e+01 -6.67843483e+00 -6.67843483e+00
 -6.67843483e+00 -1.17953671e+00 -2.43077586e-01 -2.43077586e-01
 -2.43077586e-01  9.32188657e-01  6.27229338e+00  2.58024585e+01
  9.12544683e+01  2.95036705e+02  9.27952066e+02  3.18385166e+03
  1.26671753e+04  4.12636701e+04  1.05290458e+05  2.30462426e+05
  4.56269072e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6757435230217  E_coul = 198.68502952205853
cycle= 6 E= -507.990714000963  delta_E= -3.69e-12  |g|= 9.1e-08  |ddm|= 1.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757435230217  E_coul = 198.68502952205853
  HOMO = -0.243077628479359  LUMO = 0.932188632871175
  mo_energy =
[-1.20327286e+02 -1.23814815e+01 -6.67843492e+00 -6.67843492e+00
 -6.67843492e+00 -1.17953673e+00 -2.43077628e-01 -2.43077628e-01
 -2.43077628e-01  9.32188633e-01  6.27229331e+00  2.58024585e+01
  9.12544682e+01  2.95036705e+02  9.27952066e+02  3.18385166e+03
  1.26671753e+04  4.12636701e+04  1.05290458e+05  2.30462426e+05
  4.56269072e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6757433346303  E_coul = 198.68502933366705
Extra cycle  E= -507.990714000963  delta_E= -1.14e-13  |g|= 1.19e-08  |ddm|= 2.06e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.34279124e-01 6.15015296e-01 2.12996016e+00 1.17616812e+05
 4.58023790e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104161e+04 3.67546942e+04 7.30185731e+03
 1.83757533e+04 1.44705283e+03 4.17697876e+02 1.48060700e+02
 6.06594321e+01 2.71188373e+01 9.74490116e+00 8.60422765e+00
 4.92746469e-01]
E = -507.99071400096324
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234279123723       1
[INPUT] 0    0    [1    /1   ]  0.615015295565       1
[INPUT] 0    0    [1    /1   ]  2.12996016277        1
[INPUT] 0    0    [1    /1   ]  117616.812338        1
[INPUT] 0    0    [1    /1   ]  4.58023790327        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069941        1
[INPUT] 0    0    [1    /1   ]  294042.030836        1
[INPUT] 0    0    [1    /1   ]  147020.990985        1
[INPUT] 0    0    [1    /1   ]  73510.4161364        1
[INPUT] 0    0    [1    /1   ]  36754.6941714        1
[INPUT] 0    0    [1    /1   ]  7301.85730827        1
[INPUT] 0    0    [1    /1   ]  18375.7532844        1
[INPUT] 0    0    [1    /1   ]  1447.0528347         1
[INPUT] 0    0    [1    /1   ]  417.697875601        1
[INPUT] 0    0    [1    /1   ]  148.060699973        1
[INPUT] 0    0    [1    /1   ]  60.659432109         1
[INPUT] 0    0    [1    /1   ]  27.1188373328        1
[INPUT] 0    0    [1    /1   ]  9.74490115592        1
[INPUT] 1    0    [1    /1   ]  8.60422765412        1
[INPUT] 1    0    [1    /1   ]  0.492746468828       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23427912372293874, 1.0]], [0, [0.6150152955648832, 1.0]], [0, [2.1299601627745006, 1.0]], [0, [117616.81233774865, 1.0]], [0, [4.580237903272363, 1.0]], [0, [1176168.1426097697, 1.0]], [0, [588084.0699407072, 1.0]], [0, [294042.0308358548, 1.0]], [0, [147020.9909851806, 1.0]], [0, [73510.4161363687, 1.0]], [0, [36754.69417143036, 1.0]], [0, [7301.857308269701, 1.0]], [0, [18375.753284438568, 1.0]], [0, [1447.0528346968442, 1.0]], [0, [417.697875600753, 1.0]], [0, [148.06069997280918, 1.0]], [0, [60.65943210895404, 1.0]], [0, [27.11883733276076, 1.0]], [0, [9.744901155920852, 1.0]], [1, [8.604227654119379, 1.0]], [1, [0.4927464688283363, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23427912]
bas 1, expnt(s) = [0.6150153]
bas 2, expnt(s) = [2.12996016]
bas 3, expnt(s) = [117616.81233775]
bas 4, expnt(s) = [4.5802379]
bas 5, expnt(s) = [1176168.14260977]
bas 6, expnt(s) = [588084.06994071]
bas 7, expnt(s) = [294042.03083585]
bas 8, expnt(s) = [147020.99098518]
bas 9, expnt(s) = [73510.41613637]
bas 10, expnt(s) = [36754.69417143]
bas 11, expnt(s) = [7301.85730827]
bas 12, expnt(s) = [18375.75328444]
bas 13, expnt(s) = [1447.0528347]
bas 14, expnt(s) = [417.6978756]
bas 15, expnt(s) = [148.06069997]
bas 16, expnt(s) = [60.65943211]
bas 17, expnt(s) = [27.11883733]
bas 18, expnt(s) = [9.74490116]
bas 19, expnt(s) = [8.60422765]
bas 20, expnt(s) = [0.49274647]
CPU time:      1508.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34279124e-01 8.50775975e-01 6.15015296e-01 1.75460540e+00
 2.12996016e+00 4.45444535e+00 1.17616812e+05 1.60460107e+04
 4.58023790e+00 7.91008320e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104161e+04 1.12791581e+04
 3.67546942e+04 6.70655722e+03 7.30185731e+03 1.99567598e+03
 1.83757533e+04 3.98748340e+03 1.44705283e+03 5.92759217e+02
 4.17697876e+02 2.33432717e+02 1.48060700e+02 1.07237054e+02
 6.06594321e+01 5.49147207e+01 2.71188373e+01 3.00239843e+01
 9.74490116e+00 1.39347154e+01 8.60422765e+00 4.29906744e+01
 4.92746469e-01 1.20438072e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336061067140644
cond(S) = 913147.7930864175
E1 = -689.5951924399299  E_coul = 184.97043876897638
init E= -504.624753670954
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672199297404712  LUMO = 0.57959578857278
  mo_energy =
[-1.21709965e+02 -1.33864291e+01 -7.62367287e+00 -7.62367287e+00
 -7.62367287e+00 -1.65753146e+00 -6.72199297e-01 -6.72199297e-01
 -6.72199297e-01  5.79595789e-01  5.64401387e+00  2.48841862e+01
  9.00620419e+01  2.93698129e+02  9.26593589e+02  3.18256731e+03
  1.26660079e+04  4.12625739e+04  1.05289401e+05  2.30461394e+05
  4.56268058e+05  8.45214025e+05  1.52838520e+06  2.85064510e+06
  5.80852277e+06]
E1 = -707.7524794841785  E_coul = 199.7798059635702
cycle= 1 E= -507.972673520608  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.761462
diis-c [-0.57982459  1.        ]
  HOMO = -0.217680066813513  LUMO = 0.937269934724722
  mo_energy =
[-1.20200464e+02 -1.23049912e+01 -6.59420274e+00 -6.59420274e+00
 -6.59420274e+00 -1.16332306e+00 -2.17680067e-01 -2.17680067e-01
 -2.17680067e-01  9.37269935e-01  6.30857173e+00  2.58704667e+01
  9.13499528e+01  2.95153080e+02  9.28084750e+02  3.18399938e+03
  1.26673337e+04  4.12638325e+04  1.05290623e+05  2.30462591e+05
  4.56269238e+05  8.45215192e+05  1.52838636e+06  2.85064625e+06
  5.80852391e+06]
E1 = -706.7996021844133  E_coul = 198.8091537186554
cycle= 2 E= -507.990448465758  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.404
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0335795
diis-c [-0.00112604 -0.00163939  1.00163939]
  HOMO = -0.239774092976584  LUMO = 0.933067259913265
  mo_energy =
[-1.20315112e+02 -1.23725471e+01 -6.66901430e+00 -6.66901430e+00
 -6.66901430e+00 -1.17753542e+00 -2.39774093e-01 -2.39774093e-01
 -2.39774093e-01  9.33067260e-01  6.27713279e+00  2.58104810e+01
  9.12646323e+01  2.95048228e+02  9.27964483e+02  3.18386480e+03
  1.26671889e+04  4.12636838e+04  1.05290472e+05  2.30462440e+05
  4.56269086e+05  8.45215040e+05  1.52838621e+06  2.85064610e+06
  5.80852376e+06]
E1 = -706.691737895196  E_coul = 198.7010289198349
cycle= 3 E= -507.990708975361  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00362414
diis-c [-3.01418731e-06  1.10693456e-04 -1.04986715e-01  1.10487602e+00]
  HOMO = -0.24292125837801  LUMO = 0.932238639677088
  mo_energy =
[-1.20326909e+02 -1.23811195e+01 -6.67807546e+00 -6.67807546e+00
 -6.67807546e+00 -1.17944213e+00 -2.42921258e-01 -2.42921258e-01
 -2.42921258e-01  9.32238640e-01  6.27252516e+00  2.58027879e+01
  9.12548314e+01  2.95037079e+02  9.27952446e+02  3.18385205e+03
  1.26671757e+04  4.12636704e+04  1.05290459e+05  2.30462427e+05
  4.56269073e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6764935741191  E_coul = 198.6857795872775
cycle= 4 E= -507.990713986842  delta_E= -5.01e-06  |g|= 0.000234  |ddm|= 0.01
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017006
diis-c [-4.17934942e-10 -8.86590170e-06  6.94352645e-03 -1.00571736e-01
  1.09363708e+00]
  HOMO = -0.243075396946958  LUMO = 0.932189277515607
  mo_energy =
[-1.20327281e+02 -1.23814770e+01 -6.67843034e+00 -6.67843034e+00
 -6.67843034e+00 -1.17953519e+00 -2.43075397e-01 -2.43075397e-01
 -2.43075397e-01  9.32189278e-01  6.27229662e+00  2.58024627e+01
  9.12544730e+01  2.95036710e+02  9.27952072e+02  3.18385167e+03
  1.26671753e+04  4.12636701e+04  1.05290458e+05  2.30462426e+05
  4.56269072e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6757545289834  E_coul = 198.6850405280239
cycle= 5 E= -507.990714000959  delta_E= -1.41e-08  |g|= 4.5e-06  |ddm|= 0.000627
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.03184e-06
diis-c [-6.81946567e-13  5.17597093e-07 -4.69196678e-04  6.46934322e-03
 -7.52973183e-02  1.06929665e+00]
  HOMO = -0.243077586327161  LUMO = 0.93218865709149
  mo_energy =
[-1.20327286e+02 -1.23814814e+01 -6.67843483e+00 -6.67843483e+00
 -6.67843483e+00 -1.17953671e+00 -2.43077586e-01 -2.43077586e-01
 -2.43077586e-01  9.32188657e-01  6.27229338e+00  2.58024585e+01
  9.12544683e+01  2.95036705e+02  9.27952066e+02  3.18385166e+03
  1.26671753e+04  4.12636701e+04  1.05290458e+05  2.30462426e+05
  4.56269072e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6757435230217  E_coul = 198.68502952205853
cycle= 6 E= -507.990714000963  delta_E= -3.69e-12  |g|= 9.1e-08  |ddm|= 1.22e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757435230217  E_coul = 198.68502952205853
  HOMO = -0.243077628479359  LUMO = 0.932188632871175
  mo_energy =
[-1.20327286e+02 -1.23814815e+01 -6.67843492e+00 -6.67843492e+00
 -6.67843492e+00 -1.17953673e+00 -2.43077628e-01 -2.43077628e-01
 -2.43077628e-01  9.32188633e-01  6.27229331e+00  2.58024585e+01
  9.12544682e+01  2.95036705e+02  9.27952066e+02  3.18385166e+03
  1.26671753e+04  4.12636701e+04  1.05290458e+05  2.30462426e+05
  4.56269072e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6757433346303  E_coul = 198.68502933366705
Extra cycle  E= -507.990714000963  delta_E= -1.14e-13  |g|= 1.19e-08  |ddm|= 2.06e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913147.7930864175
E1 = -706.6757433346303  E_coul = 198.68502933366705
init E= -507.990714000963
    CPU time for initialize scf      5.81 sec, wall time      0.25 sec
  HOMO = -0.243077634534177  LUMO = 0.932188631333902
  mo_energy =
[-1.20327286e+02 -1.23814815e+01 -6.67843493e+00 -6.67843493e+00
 -6.67843493e+00 -1.17953673e+00 -2.43077635e-01 -2.43077635e-01
 -2.43077635e-01  9.32188631e-01  6.27229331e+00  2.58024584e+01
  9.12544682e+01  2.95036705e+02  9.27952066e+02  3.18385166e+03
  1.26671753e+04  4.12636701e+04  1.05290458e+05  2.30462426e+05
  4.56269072e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6757433050752  E_coul = 198.6850293041122
cycle= 1 E= -507.990714000963  delta_E= 1.71e-13  |g|= 3.29e-09  |ddm|= 2.71e-08
    CPU time for cycle= 1      0.34 sec, wall time      0.03 sec
E1 = -706.6757433050752  E_coul = 198.6850293041122
  HOMO = -0.243077635444504  LUMO = 0.932188629426326
  mo_energy =
[-1.20327286e+02 -1.23814815e+01 -6.67843493e+00 -6.67843493e+00
 -6.67843493e+00 -1.17953673e+00 -2.43077635e-01 -2.43077635e-01
 -2.43077635e-01  9.32188629e-01  6.27229331e+00  2.58024584e+01
  9.12544682e+01  2.95036705e+02  9.27952066e+02  3.18385166e+03
  1.26671753e+04  4.12636701e+04  1.05290458e+05  2.30462426e+05
  4.56269072e+05  8.45215026e+05  1.52838619e+06  2.85064608e+06
  5.80852374e+06]
E1 = -706.6757433006351  E_coul = 198.6850292996723
Extra cycle  E= -507.990714000963  delta_E= 2.84e-13  |g|= 1.87e-09  |ddm|= 3.1e-09
    CPU time for scf_cycle      6.30 sec, wall time      0.42 sec
exp = [2.34279124e-01 6.15015296e-01 2.12996016e+00 1.17616812e+05
 4.58023790e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104161e+04 3.67546942e+04 7.30185731e+03
 1.83757533e+04 1.44705283e+03 4.17697876e+02 1.48060700e+02
 6.06594321e+01 2.71188373e+01 9.74490116e+00 8.60422765e+00
 4.92746469e-01]
grad_E = [ 8.47717910e-04 -5.35190974e-04 -1.31188178e-04  6.00815592e-09
  1.24053129e-04  3.98316795e-11  1.72378216e-10  9.32000026e-10
  3.68161717e-09  1.53720630e-08  8.02452266e-08  5.07084941e-06
  1.96093928e-07 -3.98195725e-05  1.63054992e-05 -7.47843778e-05
  1.92976373e-05  4.88693883e-05 -2.31105496e-05 -3.01978954e-05
 -1.93070103e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234430209888       1
[INPUT] 0    0    [1    /1   ]  0.615376578412       1
[INPUT] 0    0    [1    /1   ]  2.12541308865        1
[INPUT] 0    0    [1    /1   ]  117616.812362        1
[INPUT] 0    0    [1    /1   ]  4.54991156063        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069941        1
[INPUT] 0    0    [1    /1   ]  294042.03084         1
[INPUT] 0    0    [1    /1   ]  147020.991           1
[INPUT] 0    0    [1    /1   ]  73510.4161992        1
[INPUT] 0    0    [1    /1   ]  36754.6944992        1
[INPUT] 0    0    [1    /1   ]  7301.87797178        1
[INPUT] 0    0    [1    /1   ]  18375.7540881        1
[INPUT] 0    0    [1    /1   ]  1446.89612519        1
[INPUT] 0    0    [1    /1   ]  417.681118666        1
[INPUT] 0    0    [1    /1   ]  148.056228353        1
[INPUT] 0    0    [1    /1   ]  60.5414431113        1
[INPUT] 0    0    [1    /1   ]  27.0180558901        1
[INPUT] 0    0    [1    /1   ]  9.684478087          1
[INPUT] 1    0    [1    /1   ]  8.60423506579        1
[INPUT] 1    0    [1    /1   ]  0.49274588246        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2344302098876261, 1.0]], [0, [0.6153765784116645, 1.0]], [0, [2.125413088645689, 1.0]], [0, [117616.81236230582, 1.0]], [0, [4.549911560630302, 1.0]], [0, [1176168.1426099336, 1.0]], [0, [588084.0699414128, 1.0]], [0, [294042.0308396638, 1.0]], [0, [147020.99100023013, 1.0]], [0, [73510.41619921352, 1.0]], [0, [36754.69449921743, 1.0]], [0, [7301.8779717791795, 1.0]], [0, [18375.7540881379, 1.0]], [0, [1446.896125185508, 1.0]], [0, [417.68111866556893, 1.0]], [0, [148.05622835279345, 1.0]], [0, [60.541443111326515, 1.0]], [0, [27.01805589005115, 1.0]], [0, [9.684478087004583, 1.0]], [1, [8.604235065788181, 1.0]], [1, [0.49274588246032186, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23443021]
bas 1, expnt(s) = [0.61537658]
bas 2, expnt(s) = [2.12541309]
bas 3, expnt(s) = [117616.81236231]
bas 4, expnt(s) = [4.54991156]
bas 5, expnt(s) = [1176168.14260993]
bas 6, expnt(s) = [588084.06994141]
bas 7, expnt(s) = [294042.03083966]
bas 8, expnt(s) = [147020.99100023]
bas 9, expnt(s) = [73510.41619921]
bas 10, expnt(s) = [36754.69449922]
bas 11, expnt(s) = [7301.87797178]
bas 12, expnt(s) = [18375.75408814]
bas 13, expnt(s) = [1446.89612519]
bas 14, expnt(s) = [417.68111867]
bas 15, expnt(s) = [148.05622835]
bas 16, expnt(s) = [60.54144311]
bas 17, expnt(s) = [27.01805589]
bas 18, expnt(s) = [9.68447809]
bas 19, expnt(s) = [8.60423507]
bas 20, expnt(s) = [0.49274588]
CPU time:      1523.05
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34430210e-01 8.51187440e-01 6.15376578e-01 1.75537838e+00
 2.12541309e+00 4.44731137e+00 1.17616812e+05 1.60460107e+04
 4.54991156e+00 7.87077034e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104162e+04 1.12791581e+04
 3.67546945e+04 6.70655726e+03 7.30187797e+03 1.99568022e+03
 1.83757541e+04 3.98748353e+03 1.44689613e+03 5.92711071e+02
 4.17681119e+02 2.33425693e+02 1.48056228e+02 1.07234625e+02
 6.05414431e+01 5.48345900e+01 2.70180559e+01 2.99402620e+01
 9.68447809e+00 1.38698636e+01 8.60423507e+00 4.29907207e+01
 4.92745882e-01 1.20437893e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336061638436952
cond(S) = 913123.2860846745
E1 = -689.5955636510789  E_coul = 184.97053843061263
init E= -504.625025220466
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672196082116688  LUMO = 0.580026994479383
  mo_energy =
[-1.21709951e+02 -1.33864212e+01 -7.62366575e+00 -7.62366575e+00
 -7.62366575e+00 -1.65753694e+00 -6.72196082e-01 -6.72196082e-01
 -6.72196082e-01  5.80026994e-01  5.62376005e+00  2.47233832e+01
  8.95570816e+01  2.92762251e+02  9.25404995e+02  3.18121328e+03
  1.26644656e+04  4.12610305e+04  1.05287904e+05  2.30459939e+05
  4.56266634e+05  8.45212625e+05  1.52838383e+06  2.85064375e+06
  5.80852146e+06]
E1 = -707.7527483687844  E_coul = 199.7800760514304
cycle= 1 E= -507.972672317354  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.761296
diis-c [-0.57957207  1.        ]
  HOMO = -0.217677456314199  LUMO = 0.937667655345063
  mo_energy =
[-1.20200428e+02 -1.23049680e+01 -6.59417937e+00 -6.59417937e+00
 -6.59417937e+00 -1.16332563e+00 -2.17677456e-01 -2.17677456e-01
 -2.17677456e-01  9.37667655e-01  6.28690728e+00  2.57076224e+01
  9.08440729e+01  2.94217087e+02  9.26896189e+02  3.18264537e+03
  1.26657915e+04  4.12622892e+04  1.05289126e+05  2.30461136e+05
  4.56267814e+05  8.45213792e+05  1.52838498e+06  2.85064490e+06
  5.80852259e+06]
E1 = -706.7997425658588  E_coul = 198.8092921894674
cycle= 2 E= -507.990450376391  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.404
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0335781
diis-c [-0.00112588 -0.00167333  1.00167333]
  HOMO = -0.239775763342662  LUMO = 0.933468707777283
  mo_energy =
[-1.20315092e+02 -1.23725364e+01 -6.66900371e+00 -6.66900371e+00
 -6.66900371e+00 -1.17754086e+00 -2.39775763e-01 -2.39775763e-01
 -2.39775763e-01  9.33468708e-01  6.25556603e+00  2.56477819e+01
  9.07588278e+01  2.94112241e+02  9.26775906e+02  3.18251077e+03
  1.26656466e+04  4.12621405e+04  1.05288976e+05  2.30460985e+05
  4.56267662e+05  8.45213640e+05  1.52838483e+06  2.85064475e+06
  5.80852244e+06]
E1 = -706.6918836390768  E_coul = 198.70117283082362
cycle= 3 E= -507.990710808253  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00362332
diis-c [-3.01600282e-06  1.13146972e-04 -1.04952571e-01  1.10483942e+00]
  HOMO = -0.242921644535141  LUMO = 0.932641108811092
  mo_energy =
[-1.20326884e+02 -1.23811056e+01 -6.67806147e+00 -6.67806147e+00
 -6.67806147e+00 -1.17944673e+00 -2.42921645e-01 -2.42921645e-01
 -2.42921645e-01  9.32641109e-01  6.25097347e+00  2.56401066e+01
  9.07490375e+01  2.94101098e+02  9.26763873e+02  3.18249803e+03
  1.26656334e+04  4.12621271e+04  1.05288962e+05  2.30460972e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.6766494427978  E_coul = 198.68593362987937
cycle= 4 E= -507.990715812918  delta_E= -5e-06  |g|= 0.000234  |ddm|= 0.01
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170003
diis-c [-4.17905714e-10 -8.87847833e-06  6.93424000e-03 -1.00496943e-01
  1.09357158e+00]
  HOMO = -0.243075649322661  LUMO = 0.932591819553216
  mo_energy =
[-1.20327256e+02 -1.23814628e+01 -6.67841605e+00 -6.67841605e+00
 -6.67841605e+00 -1.17953972e+00 -2.43075649e-01 -2.43075649e-01
 -2.43075649e-01  9.32591820e-01  6.25074568e+00  2.56397821e+01
  9.07486795e+01  2.94100729e+02  9.26763499e+02  3.18249765e+03
  1.26656330e+04  4.12621267e+04  1.05288962e+05  2.30460971e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.6759112709681  E_coul = 198.68519544395656
cycle= 5 E= -507.990715827012  delta_E= -1.41e-08  |g|= 4.52e-06  |ddm|= 0.000627
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.03401e-06
diis-c [-6.84008867e-13  5.18461956e-07 -4.70190138e-04  6.48811551e-03
 -7.55484514e-02  1.06953001e+00]
  HOMO = -0.2430778417845  LUMO = 0.932591196750395
  mo_energy =
[-1.20327262e+02 -1.23814672e+01 -6.67842054e+00 -6.67842054e+00
 -6.67842054e+00 -1.17954124e+00 -2.43077842e-01 -2.43077842e-01
 -2.43077842e-01  9.32591197e-01  6.25074244e+00  2.56397779e+01
  9.07486748e+01  2.94100724e+02  9.26763494e+02  3.18249764e+03
  1.26656330e+04  4.12621267e+04  1.05288962e+05  2.30460971e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.6759002496133  E_coul = 198.68518442259702
cycle= 6 E= -507.990715827016  delta_E= -4.77e-12  |g|= 9.04e-08  |ddm|= 1.23e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759002496133  E_coul = 198.68518442259702
  HOMO = -0.243077884227642  LUMO = 0.932591171807003
  mo_energy =
[-1.20327262e+02 -1.23814673e+01 -6.67842062e+00 -6.67842062e+00
 -6.67842062e+00 -1.17954126e+00 -2.43077884e-01 -2.43077884e-01
 -2.43077884e-01  9.32591172e-01  6.25074238e+00  2.56397778e+01
  9.07486747e+01  2.94100724e+02  9.26763494e+02  3.18249764e+03
  1.26656330e+04  4.12621267e+04  1.05288962e+05  2.30460971e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.675900061242  E_coul = 198.6851842342261
Extra cycle  E= -507.990715827016  delta_E= 3.41e-13  |g|= 1.13e-08  |ddm|= 2.06e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.34430210e-01 6.15376578e-01 2.12541309e+00 1.17616812e+05
 4.54991156e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104162e+04 3.67546945e+04 7.30187797e+03
 1.83757541e+04 1.44689613e+03 4.17681119e+02 1.48056228e+02
 6.05414431e+01 2.70180559e+01 9.68447809e+00 8.60423507e+00
 4.92745882e-01]
E = -507.99071582701595
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234430209888       1
[INPUT] 0    0    [1    /1   ]  0.615376578412       1
[INPUT] 0    0    [1    /1   ]  2.12541308865        1
[INPUT] 0    0    [1    /1   ]  117616.812362        1
[INPUT] 0    0    [1    /1   ]  4.54991156063        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069941        1
[INPUT] 0    0    [1    /1   ]  294042.03084         1
[INPUT] 0    0    [1    /1   ]  147020.991           1
[INPUT] 0    0    [1    /1   ]  73510.4161992        1
[INPUT] 0    0    [1    /1   ]  36754.6944992        1
[INPUT] 0    0    [1    /1   ]  7301.87797178        1
[INPUT] 0    0    [1    /1   ]  18375.7540881        1
[INPUT] 0    0    [1    /1   ]  1446.89612519        1
[INPUT] 0    0    [1    /1   ]  417.681118666        1
[INPUT] 0    0    [1    /1   ]  148.056228353        1
[INPUT] 0    0    [1    /1   ]  60.5414431113        1
[INPUT] 0    0    [1    /1   ]  27.0180558901        1
[INPUT] 0    0    [1    /1   ]  9.684478087          1
[INPUT] 1    0    [1    /1   ]  8.60423506579        1
[INPUT] 1    0    [1    /1   ]  0.49274588246        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2344302098876261, 1.0]], [0, [0.6153765784116645, 1.0]], [0, [2.125413088645689, 1.0]], [0, [117616.81236230582, 1.0]], [0, [4.549911560630302, 1.0]], [0, [1176168.1426099336, 1.0]], [0, [588084.0699414128, 1.0]], [0, [294042.0308396638, 1.0]], [0, [147020.99100023013, 1.0]], [0, [73510.41619921352, 1.0]], [0, [36754.69449921743, 1.0]], [0, [7301.8779717791795, 1.0]], [0, [18375.7540881379, 1.0]], [0, [1446.896125185508, 1.0]], [0, [417.68111866556893, 1.0]], [0, [148.05622835279345, 1.0]], [0, [60.541443111326515, 1.0]], [0, [27.01805589005115, 1.0]], [0, [9.684478087004583, 1.0]], [1, [8.604235065788181, 1.0]], [1, [0.49274588246032186, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23443021]
bas 1, expnt(s) = [0.61537658]
bas 2, expnt(s) = [2.12541309]
bas 3, expnt(s) = [117616.81236231]
bas 4, expnt(s) = [4.54991156]
bas 5, expnt(s) = [1176168.14260993]
bas 6, expnt(s) = [588084.06994141]
bas 7, expnt(s) = [294042.03083966]
bas 8, expnt(s) = [147020.99100023]
bas 9, expnt(s) = [73510.41619921]
bas 10, expnt(s) = [36754.69449922]
bas 11, expnt(s) = [7301.87797178]
bas 12, expnt(s) = [18375.75408814]
bas 13, expnt(s) = [1446.89612519]
bas 14, expnt(s) = [417.68111867]
bas 15, expnt(s) = [148.05622835]
bas 16, expnt(s) = [60.54144311]
bas 17, expnt(s) = [27.01805589]
bas 18, expnt(s) = [9.68447809]
bas 19, expnt(s) = [8.60423507]
bas 20, expnt(s) = [0.49274588]
CPU time:      1525.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34430210e-01 8.51187440e-01 6.15376578e-01 1.75537838e+00
 2.12541309e+00 4.44731137e+00 1.17616812e+05 1.60460107e+04
 4.54991156e+00 7.87077034e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104162e+04 1.12791581e+04
 3.67546945e+04 6.70655726e+03 7.30187797e+03 1.99568022e+03
 1.83757541e+04 3.98748353e+03 1.44689613e+03 5.92711071e+02
 4.17681119e+02 2.33425693e+02 1.48056228e+02 1.07234625e+02
 6.05414431e+01 5.48345900e+01 2.70180559e+01 2.99402620e+01
 9.68447809e+00 1.38698636e+01 8.60423507e+00 4.29907207e+01
 4.92745882e-01 1.20437893e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336061638436952
cond(S) = 913123.2860846745
E1 = -689.5955636510789  E_coul = 184.97053843061263
init E= -504.625025220466
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672196082116688  LUMO = 0.580026994479383
  mo_energy =
[-1.21709951e+02 -1.33864212e+01 -7.62366575e+00 -7.62366575e+00
 -7.62366575e+00 -1.65753694e+00 -6.72196082e-01 -6.72196082e-01
 -6.72196082e-01  5.80026994e-01  5.62376005e+00  2.47233832e+01
  8.95570816e+01  2.92762251e+02  9.25404995e+02  3.18121328e+03
  1.26644656e+04  4.12610305e+04  1.05287904e+05  2.30459939e+05
  4.56266634e+05  8.45212625e+05  1.52838383e+06  2.85064375e+06
  5.80852146e+06]
E1 = -707.7527483687844  E_coul = 199.7800760514304
cycle= 1 E= -507.972672317354  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.761296
diis-c [-0.57957207  1.        ]
  HOMO = -0.217677456314199  LUMO = 0.937667655345063
  mo_energy =
[-1.20200428e+02 -1.23049680e+01 -6.59417937e+00 -6.59417937e+00
 -6.59417937e+00 -1.16332563e+00 -2.17677456e-01 -2.17677456e-01
 -2.17677456e-01  9.37667655e-01  6.28690728e+00  2.57076224e+01
  9.08440729e+01  2.94217087e+02  9.26896189e+02  3.18264537e+03
  1.26657915e+04  4.12622892e+04  1.05289126e+05  2.30461136e+05
  4.56267814e+05  8.45213792e+05  1.52838498e+06  2.85064490e+06
  5.80852259e+06]
E1 = -706.7997425658588  E_coul = 198.8092921894674
cycle= 2 E= -507.990450376391  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.404
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0335781
diis-c [-0.00112588 -0.00167333  1.00167333]
  HOMO = -0.239775763342662  LUMO = 0.933468707777283
  mo_energy =
[-1.20315092e+02 -1.23725364e+01 -6.66900371e+00 -6.66900371e+00
 -6.66900371e+00 -1.17754086e+00 -2.39775763e-01 -2.39775763e-01
 -2.39775763e-01  9.33468708e-01  6.25556603e+00  2.56477819e+01
  9.07588278e+01  2.94112241e+02  9.26775906e+02  3.18251077e+03
  1.26656466e+04  4.12621405e+04  1.05288976e+05  2.30460985e+05
  4.56267662e+05  8.45213640e+05  1.52838483e+06  2.85064475e+06
  5.80852244e+06]
E1 = -706.6918836390768  E_coul = 198.70117283082362
cycle= 3 E= -507.990710808253  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00362332
diis-c [-3.01600282e-06  1.13146972e-04 -1.04952571e-01  1.10483942e+00]
  HOMO = -0.242921644535141  LUMO = 0.932641108811092
  mo_energy =
[-1.20326884e+02 -1.23811056e+01 -6.67806147e+00 -6.67806147e+00
 -6.67806147e+00 -1.17944673e+00 -2.42921645e-01 -2.42921645e-01
 -2.42921645e-01  9.32641109e-01  6.25097347e+00  2.56401066e+01
  9.07490375e+01  2.94101098e+02  9.26763873e+02  3.18249803e+03
  1.26656334e+04  4.12621271e+04  1.05288962e+05  2.30460972e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.6766494427978  E_coul = 198.68593362987937
cycle= 4 E= -507.990715812918  delta_E= -5e-06  |g|= 0.000234  |ddm|= 0.01
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170003
diis-c [-4.17905714e-10 -8.87847833e-06  6.93424000e-03 -1.00496943e-01
  1.09357158e+00]
  HOMO = -0.243075649322661  LUMO = 0.932591819553216
  mo_energy =
[-1.20327256e+02 -1.23814628e+01 -6.67841605e+00 -6.67841605e+00
 -6.67841605e+00 -1.17953972e+00 -2.43075649e-01 -2.43075649e-01
 -2.43075649e-01  9.32591820e-01  6.25074568e+00  2.56397821e+01
  9.07486795e+01  2.94100729e+02  9.26763499e+02  3.18249765e+03
  1.26656330e+04  4.12621267e+04  1.05288962e+05  2.30460971e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.6759112709681  E_coul = 198.68519544395656
cycle= 5 E= -507.990715827012  delta_E= -1.41e-08  |g|= 4.52e-06  |ddm|= 0.000627
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.03401e-06
diis-c [-6.84008867e-13  5.18461956e-07 -4.70190138e-04  6.48811551e-03
 -7.55484514e-02  1.06953001e+00]
  HOMO = -0.2430778417845  LUMO = 0.932591196750395
  mo_energy =
[-1.20327262e+02 -1.23814672e+01 -6.67842054e+00 -6.67842054e+00
 -6.67842054e+00 -1.17954124e+00 -2.43077842e-01 -2.43077842e-01
 -2.43077842e-01  9.32591197e-01  6.25074244e+00  2.56397779e+01
  9.07486748e+01  2.94100724e+02  9.26763494e+02  3.18249764e+03
  1.26656330e+04  4.12621267e+04  1.05288962e+05  2.30460971e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.6759002496133  E_coul = 198.68518442259702
cycle= 6 E= -507.990715827016  delta_E= -4.77e-12  |g|= 9.04e-08  |ddm|= 1.23e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759002496133  E_coul = 198.68518442259702
  HOMO = -0.243077884227642  LUMO = 0.932591171807003
  mo_energy =
[-1.20327262e+02 -1.23814673e+01 -6.67842062e+00 -6.67842062e+00
 -6.67842062e+00 -1.17954126e+00 -2.43077884e-01 -2.43077884e-01
 -2.43077884e-01  9.32591172e-01  6.25074238e+00  2.56397778e+01
  9.07486747e+01  2.94100724e+02  9.26763494e+02  3.18249764e+03
  1.26656330e+04  4.12621267e+04  1.05288962e+05  2.30460971e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.675900061242  E_coul = 198.6851842342261
Extra cycle  E= -507.990715827016  delta_E= 3.41e-13  |g|= 1.13e-08  |ddm|= 2.06e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913123.2860846745
E1 = -706.675900061242  E_coul = 198.6851842342261
init E= -507.990715827016
    CPU time for initialize scf      5.64 sec, wall time      0.24 sec
  HOMO = -0.243077890280997  LUMO = 0.932591169370488
  mo_energy =
[-1.20327262e+02 -1.23814673e+01 -6.67842064e+00 -6.67842064e+00
 -6.67842064e+00 -1.17954127e+00 -2.43077890e-01 -2.43077890e-01
 -2.43077890e-01  9.32591169e-01  6.25074237e+00  2.56397778e+01
  9.07486747e+01  2.94100724e+02  9.26763494e+02  3.18249764e+03
  1.26656330e+04  4.12621267e+04  1.05288962e+05  2.30460971e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.6759000327561  E_coul = 198.68518420574023
cycle= 1 E= -507.990715827016  delta_E= 1.14e-13  |g|= 2.03e-09  |ddm|= 2.65e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6759000327561  E_coul = 198.68518420574023
  HOMO = -0.243077891157477  LUMO = 0.93259117065264
  mo_energy =
[-1.20327262e+02 -1.23814673e+01 -6.67842064e+00 -6.67842064e+00
 -6.67842064e+00 -1.17954127e+00 -2.43077891e-01 -2.43077891e-01
 -2.43077891e-01  9.32591171e-01  6.25074237e+00  2.56397778e+01
  9.07486747e+01  2.94100724e+02  9.26763494e+02  3.18249764e+03
  1.26656330e+04  4.12621267e+04  1.05288962e+05  2.30460971e+05
  4.56267649e+05  8.45213626e+05  1.52838481e+06  2.85064473e+06
  5.80852243e+06]
E1 = -706.6759000292747  E_coul = 198.68518420225877
Extra cycle  E= -507.990715827016  delta_E= -5.68e-14  |g|= 2.89e-09  |ddm|= 3.68e-09
    CPU time for scf_cycle      6.15 sec, wall time      0.41 sec
exp = [2.34430210e-01 6.15376578e-01 2.12541309e+00 1.17616812e+05
 4.54991156e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104162e+04 3.67546945e+04 7.30187797e+03
 1.83757541e+04 1.44689613e+03 4.17681119e+02 1.48056228e+02
 6.05414431e+01 2.70180559e+01 9.68447809e+00 8.60423507e+00
 4.92745882e-01]
grad_E = [ 5.52590874e-04 -3.06032862e-04 -4.84562448e-05  6.00628531e-09
  6.14509465e-05  3.98106671e-11  1.72316989e-10  9.31713250e-10
  3.68045946e-09  1.53671612e-08  8.02211625e-08  5.06867287e-06
  1.96018551e-07 -3.96074480e-05  1.39826395e-05 -6.62765539e-05
  6.20158389e-06  5.75739194e-05 -1.33690333e-05 -2.15572721e-05
 -1.50228259e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:36:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233931397237       1
[INPUT] 0    0    [1    /1   ]  0.613940109589       1
[INPUT] 0    0    [1    /1   ]  2.09772595366        1
[INPUT] 0    0    [1    /1   ]  117616.81239         1
[INPUT] 0    0    [1    /1   ]  4.47775290832        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069942        1
[INPUT] 0    0    [1    /1   ]  294042.030844        1
[INPUT] 0    0    [1    /1   ]  147020.991017        1
[INPUT] 0    0    [1    /1   ]  73510.4162695        1
[INPUT] 0    0    [1    /1   ]  36754.6948661        1
[INPUT] 0    0    [1    /1   ]  7301.90109807        1
[INPUT] 0    0    [1    /1   ]  18375.7549877        1
[INPUT] 0    0    [1    /1   ]  1446.72061552        1
[INPUT] 0    0    [1    /1   ]  417.663748609        1
[INPUT] 0    0    [1    /1   ]  148.044654644        1
[INPUT] 0    0    [1    /1   ]  60.4299141698        1
[INPUT] 0    0    [1    /1   ]  26.8898989108        1
[INPUT] 0    0    [1    /1   ]  9.55394904489        1
[INPUT] 1    0    [1    /1   ]  8.60423868556        1
[INPUT] 1    0    [1    /1   ]  0.492746319519       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2339313972365395, 1.0]], [0, [0.6139401095892711, 1.0]], [0, [2.097725953656881, 1.0]], [0, [117616.81238979008, 1.0]], [0, [4.4777529083233745, 1.0]], [0, [1176168.142610117, 1.0]], [0, [588084.0699422024, 1.0]], [0, [294042.03084392677, 1.0]], [0, [147020.9910170735, 1.0]], [0, [73510.41626954939, 1.0]], [0, [36754.694866071666, 1.0]], [0, [7301.901098073829, 1.0]], [0, [18375.754987674532, 1.0]], [0, [1446.720615524262, 1.0]], [0, [417.6637486093067, 1.0]], [0, [148.04465464370512, 1.0]], [0, [60.42991416983752, 1.0]], [0, [26.889898910760838, 1.0]], [0, [9.553949044890373, 1.0]], [1, [8.604238685561839, 1.0]], [1, [0.4927463195190512, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2339314]
bas 1, expnt(s) = [0.61394011]
bas 2, expnt(s) = [2.09772595]
bas 3, expnt(s) = [117616.81238979]
bas 4, expnt(s) = [4.47775291]
bas 5, expnt(s) = [1176168.14261012]
bas 6, expnt(s) = [588084.0699422]
bas 7, expnt(s) = [294042.03084393]
bas 8, expnt(s) = [147020.99101707]
bas 9, expnt(s) = [73510.41626955]
bas 10, expnt(s) = [36754.69486607]
bas 11, expnt(s) = [7301.90109807]
bas 12, expnt(s) = [18375.75498767]
bas 13, expnt(s) = [1446.72061552]
bas 14, expnt(s) = [417.66374861]
bas 15, expnt(s) = [148.04465464]
bas 16, expnt(s) = [60.42991417]
bas 17, expnt(s) = [26.88989891]
bas 18, expnt(s) = [9.55394904]
bas 19, expnt(s) = [8.60423869]
bas 20, expnt(s) = [0.49274632]
CPU time:      1540.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33931397e-01 8.49828732e-01 6.13940110e-01 1.75230431e+00
 2.09772595e+00 4.40378987e+00 1.17616812e+05 1.60460107e+04
 4.47775291e+00 7.77696452e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546949e+04 6.70655731e+03 7.30190110e+03 1.99568496e+03
 1.83757550e+04 3.98748367e+03 1.44672062e+03 5.92657148e+02
 4.17663749e+02 2.33418412e+02 1.48044655e+02 1.07228338e+02
 6.04299142e+01 5.47588107e+01 2.68898989e+01 2.98336851e+01
 9.55394904e+00 1.37294208e+01 8.60423869e+00 4.29907433e+01
 4.92746320e-01 1.20438026e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336064859069364
cond(S) = 913081.4277727002
E1 = -689.5958013196935  E_coul = 184.97067999282336
init E= -504.62512132687
    CPU time for initialize scf      7.08 sec, wall time      0.35 sec
  HOMO = -0.672191291132222  LUMO = 0.576265642529716
  mo_energy =
[-1.21709935e+02 -1.33864070e+01 -7.62365552e+00 -7.62365552e+00
 -7.62365552e+00 -1.65754282e+00 -6.72191291e-01 -6.72191291e-01
 -6.72191291e-01  5.76265643e-01  5.53911848e+00  2.42905590e+01
  8.85146129e+01  2.91186500e+02  9.23584699e+02  3.17925695e+03
  1.26623506e+04  4.12589429e+04  1.05285884e+05  2.30457975e+05
  4.56264712e+05  8.45210735e+05  1.52838197e+06  2.85064193e+06
  5.80851968e+06]
E1 = -707.7531101485931  E_coul = 199.78044365679926
cycle= 1 E= -507.972666491794  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.61 sec, wall time      0.03 sec
diis-norm(errvec)=0.760998
diis-c [-0.57911734  1.        ]
  HOMO = -0.217671510793938  LUMO = 0.932852832576205
  mo_energy =
[-1.20200388e+02 -1.23049344e+01 -6.59414839e+00 -6.59414839e+00
 -6.59414839e+00 -1.16332679e+00 -2.17671511e-01 -2.17671511e-01
 -2.17671511e-01  9.32852833e-01  6.19777453e+00  2.52702368e+01
  8.98002303e+01  2.92641285e+02  9.25075960e+02  3.18068909e+03
  1.26636765e+04  4.12602016e+04  1.05287106e+05  2.30459172e+05
  4.56265892e+05  8.45211901e+05  1.52838312e+06  2.85064308e+06
  5.80852082e+06]
E1 = -706.7997784435385  E_coul = 198.80932715829303
cycle= 2 E= -507.990451285245  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.403
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0336535
diis-c [-0.00113077 -0.00176171  1.00176171]
  HOMO = -0.239780979935861  LUMO = 0.928703281035446
  mo_energy =
[-1.20315092e+02 -1.23725338e+01 -6.66900512e+00 -6.66900512e+00
 -6.66900512e+00 -1.17754976e+00 -2.39780980e-01 -2.39780980e-01
 -2.39780980e-01  9.28703281e-01  6.16678242e+00  2.52107362e+01
  8.97150937e+01  2.92536419e+02  9.24955630e+02  3.18055444e+03
  1.26635316e+04  4.12600529e+04  1.05286956e+05  2.30459021e+05
  4.56265740e+05  8.45211749e+05  1.52838297e+06  2.85064293e+06
  5.80852067e+06]
E1 = -706.6918549006987  E_coul = 198.70114298041133
cycle= 3 E= -507.990711920287  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00363755
diis-c [-3.03451405e-06  1.13990705e-04 -1.05183231e-01  1.10506924e+00]
  HOMO = -0.242928145844381  LUMO = 0.927883088741312
  mo_energy =
[-1.20326882e+02 -1.23811038e+01 -6.67806319e+00 -6.67806319e+00
 -6.67806319e+00 -1.17945650e+00 -2.42928146e-01 -2.42928146e-01
 -2.42928146e-01  9.27883089e-01  6.16223432e+00  2.52030956e+01
  8.97053149e+01  2.92525279e+02  9.24943600e+02  3.18054170e+03
  1.26635184e+04  4.12600395e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211736e+05  1.52838296e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6766115684071  E_coul = 198.68589463650193
cycle= 4 E= -507.990716931905  delta_E= -5.01e-06  |g|= 0.000234  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170209
diis-c [-4.29334406e-10 -8.92139018e-06  6.92972845e-03 -1.00246999e-01
  1.09332619e+00]
  HOMO = -0.243081694540861  LUMO = 0.927834239721747
  mo_energy =
[-1.20327252e+02 -1.23814592e+01 -6.67841577e+00 -6.67841577e+00
 -6.67841577e+00 -1.17954924e+00 -2.43081695e-01 -2.43081695e-01
 -2.43081695e-01  9.27834240e-01  6.16200911e+00  2.52027735e+01
  8.97049592e+01  2.92524913e+02  9.24943229e+02  3.18054132e+03
  1.26635180e+04  4.12600391e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211735e+05  1.52838295e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6758753707695  E_coul = 198.68515842475958
cycle= 5 E= -507.99071694601  delta_E= -1.41e-08  |g|= 4.65e-06  |ddm|= 0.000631
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.08379e-06
diis-c [-7.05268369e-13  5.28908503e-07 -4.79203418e-04  6.60193122e-03
 -7.70619203e-02  1.07093866e+00]
  HOMO = -0.243083933307012  LUMO = 0.927833605443696
  mo_energy =
[-1.20327257e+02 -1.23814637e+01 -6.67842033e+00 -6.67842033e+00
 -6.67842033e+00 -1.17955079e+00 -2.43083933e-01 -2.43083933e-01
 -2.43083933e-01  9.27833605e-01  6.16200583e+00  2.52027693e+01
  8.97049544e+01  2.92524908e+02  9.24943223e+02  3.18054132e+03
  1.26635180e+04  4.12600391e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211735e+05  1.52838295e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6758641116103  E_coul = 198.68514716559577
cycle= 6 E= -507.990716946015  delta_E= -4.6e-12  |g|= 9.09e-08  |ddm|= 1.27e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6758641116103  E_coul = 198.68514716559577
  HOMO = -0.243083975766238  LUMO = 0.927833580549159
  mo_energy =
[-1.20327257e+02 -1.23814638e+01 -6.67842042e+00 -6.67842042e+00
 -6.67842042e+00 -1.17955081e+00 -2.43083976e-01 -2.43083976e-01
 -2.43083976e-01  9.27833581e-01  6.16200576e+00  2.52027692e+01
  8.97049544e+01  2.92524908e+02  9.24943223e+02  3.18054132e+03
  1.26635180e+04  4.12600391e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211735e+05  1.52838295e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6758639207981  E_coul = 198.6851469747838
Extra cycle  E= -507.990716946014  delta_E= 2.84e-13  |g|= 1.11e-08  |ddm|= 2.1e-07
    CPU time for scf_cycle      7.89 sec, wall time      0.57 sec
exp = [2.33931397e-01 6.13940110e-01 2.09772595e+00 1.17616812e+05
 4.47775291e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546949e+04 7.30190110e+03
 1.83757550e+04 1.44672062e+03 4.17663749e+02 1.48044655e+02
 6.04299142e+01 2.68898989e+01 9.55394904e+00 8.60423869e+00
 4.92746320e-01]
E = -507.99071694601423
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:00 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233931397237       1
[INPUT] 0    0    [1    /1   ]  0.613940109589       1
[INPUT] 0    0    [1    /1   ]  2.09772595366        1
[INPUT] 0    0    [1    /1   ]  117616.81239         1
[INPUT] 0    0    [1    /1   ]  4.47775290832        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069942        1
[INPUT] 0    0    [1    /1   ]  294042.030844        1
[INPUT] 0    0    [1    /1   ]  147020.991017        1
[INPUT] 0    0    [1    /1   ]  73510.4162695        1
[INPUT] 0    0    [1    /1   ]  36754.6948661        1
[INPUT] 0    0    [1    /1   ]  7301.90109807        1
[INPUT] 0    0    [1    /1   ]  18375.7549877        1
[INPUT] 0    0    [1    /1   ]  1446.72061552        1
[INPUT] 0    0    [1    /1   ]  417.663748609        1
[INPUT] 0    0    [1    /1   ]  148.044654644        1
[INPUT] 0    0    [1    /1   ]  60.4299141698        1
[INPUT] 0    0    [1    /1   ]  26.8898989108        1
[INPUT] 0    0    [1    /1   ]  9.55394904489        1
[INPUT] 1    0    [1    /1   ]  8.60423868556        1
[INPUT] 1    0    [1    /1   ]  0.492746319519       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2339313972365395, 1.0]], [0, [0.6139401095892711, 1.0]], [0, [2.097725953656881, 1.0]], [0, [117616.81238979008, 1.0]], [0, [4.4777529083233745, 1.0]], [0, [1176168.142610117, 1.0]], [0, [588084.0699422024, 1.0]], [0, [294042.03084392677, 1.0]], [0, [147020.9910170735, 1.0]], [0, [73510.41626954939, 1.0]], [0, [36754.694866071666, 1.0]], [0, [7301.901098073829, 1.0]], [0, [18375.754987674532, 1.0]], [0, [1446.720615524262, 1.0]], [0, [417.6637486093067, 1.0]], [0, [148.04465464370512, 1.0]], [0, [60.42991416983752, 1.0]], [0, [26.889898910760838, 1.0]], [0, [9.553949044890373, 1.0]], [1, [8.604238685561839, 1.0]], [1, [0.4927463195190512, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2339314]
bas 1, expnt(s) = [0.61394011]
bas 2, expnt(s) = [2.09772595]
bas 3, expnt(s) = [117616.81238979]
bas 4, expnt(s) = [4.47775291]
bas 5, expnt(s) = [1176168.14261012]
bas 6, expnt(s) = [588084.0699422]
bas 7, expnt(s) = [294042.03084393]
bas 8, expnt(s) = [147020.99101707]
bas 9, expnt(s) = [73510.41626955]
bas 10, expnt(s) = [36754.69486607]
bas 11, expnt(s) = [7301.90109807]
bas 12, expnt(s) = [18375.75498767]
bas 13, expnt(s) = [1446.72061552]
bas 14, expnt(s) = [417.66374861]
bas 15, expnt(s) = [148.04465464]
bas 16, expnt(s) = [60.42991417]
bas 17, expnt(s) = [26.88989891]
bas 18, expnt(s) = [9.55394904]
bas 19, expnt(s) = [8.60423869]
bas 20, expnt(s) = [0.49274632]
CPU time:      1548.66
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33931397e-01 8.49828732e-01 6.13940110e-01 1.75230431e+00
 2.09772595e+00 4.40378987e+00 1.17616812e+05 1.60460107e+04
 4.47775291e+00 7.77696452e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546949e+04 6.70655731e+03 7.30190110e+03 1.99568496e+03
 1.83757550e+04 3.98748367e+03 1.44672062e+03 5.92657148e+02
 4.17663749e+02 2.33418412e+02 1.48044655e+02 1.07228338e+02
 6.04299142e+01 5.47588107e+01 2.68898989e+01 2.98336851e+01
 9.55394904e+00 1.37294208e+01 8.60423869e+00 4.29907433e+01
 4.92746320e-01 1.20438026e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336064859069364
cond(S) = 913081.4277727002
E1 = -689.5958013196935  E_coul = 184.97067999282336
init E= -504.62512132687
    CPU time for initialize scf      0.85 sec, wall time      0.08 sec
  HOMO = -0.672191291132222  LUMO = 0.576265642529716
  mo_energy =
[-1.21709935e+02 -1.33864070e+01 -7.62365552e+00 -7.62365552e+00
 -7.62365552e+00 -1.65754282e+00 -6.72191291e-01 -6.72191291e-01
 -6.72191291e-01  5.76265643e-01  5.53911848e+00  2.42905590e+01
  8.85146129e+01  2.91186500e+02  9.23584699e+02  3.17925695e+03
  1.26623506e+04  4.12589429e+04  1.05285884e+05  2.30457975e+05
  4.56264712e+05  8.45210735e+05  1.52838197e+06  2.85064193e+06
  5.80851968e+06]
E1 = -707.7531101485931  E_coul = 199.78044365679926
cycle= 1 E= -507.972666491794  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.53 sec, wall time      0.03 sec
diis-norm(errvec)=0.760998
diis-c [-0.57911734  1.        ]
  HOMO = -0.217671510793938  LUMO = 0.932852832576205
  mo_energy =
[-1.20200388e+02 -1.23049344e+01 -6.59414839e+00 -6.59414839e+00
 -6.59414839e+00 -1.16332679e+00 -2.17671511e-01 -2.17671511e-01
 -2.17671511e-01  9.32852833e-01  6.19777453e+00  2.52702368e+01
  8.98002303e+01  2.92641285e+02  9.25075960e+02  3.18068909e+03
  1.26636765e+04  4.12602016e+04  1.05287106e+05  2.30459172e+05
  4.56265892e+05  8.45211901e+05  1.52838312e+06  2.85064308e+06
  5.80852082e+06]
E1 = -706.7997784435385  E_coul = 198.80932715829303
cycle= 2 E= -507.990451285245  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.403
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0336535
diis-c [-0.00113077 -0.00176171  1.00176171]
  HOMO = -0.239780979935861  LUMO = 0.928703281035446
  mo_energy =
[-1.20315092e+02 -1.23725338e+01 -6.66900512e+00 -6.66900512e+00
 -6.66900512e+00 -1.17754976e+00 -2.39780980e-01 -2.39780980e-01
 -2.39780980e-01  9.28703281e-01  6.16678242e+00  2.52107362e+01
  8.97150937e+01  2.92536419e+02  9.24955630e+02  3.18055444e+03
  1.26635316e+04  4.12600529e+04  1.05286956e+05  2.30459021e+05
  4.56265740e+05  8.45211749e+05  1.52838297e+06  2.85064293e+06
  5.80852067e+06]
E1 = -706.6918549006987  E_coul = 198.70114298041133
cycle= 3 E= -507.990711920287  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00363755
diis-c [-3.03451405e-06  1.13990705e-04 -1.05183231e-01  1.10506924e+00]
  HOMO = -0.242928145844381  LUMO = 0.927883088741312
  mo_energy =
[-1.20326882e+02 -1.23811038e+01 -6.67806319e+00 -6.67806319e+00
 -6.67806319e+00 -1.17945650e+00 -2.42928146e-01 -2.42928146e-01
 -2.42928146e-01  9.27883089e-01  6.16223432e+00  2.52030956e+01
  8.97053149e+01  2.92525279e+02  9.24943600e+02  3.18054170e+03
  1.26635184e+04  4.12600395e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211736e+05  1.52838296e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6766115684071  E_coul = 198.68589463650193
cycle= 4 E= -507.990716931905  delta_E= -5.01e-06  |g|= 0.000234  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170209
diis-c [-4.29334406e-10 -8.92139018e-06  6.92972845e-03 -1.00246999e-01
  1.09332619e+00]
  HOMO = -0.243081694540861  LUMO = 0.927834239721747
  mo_energy =
[-1.20327252e+02 -1.23814592e+01 -6.67841577e+00 -6.67841577e+00
 -6.67841577e+00 -1.17954924e+00 -2.43081695e-01 -2.43081695e-01
 -2.43081695e-01  9.27834240e-01  6.16200911e+00  2.52027735e+01
  8.97049592e+01  2.92524913e+02  9.24943229e+02  3.18054132e+03
  1.26635180e+04  4.12600391e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211735e+05  1.52838295e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6758753707695  E_coul = 198.68515842475958
cycle= 5 E= -507.99071694601  delta_E= -1.41e-08  |g|= 4.65e-06  |ddm|= 0.000631
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.08379e-06
diis-c [-7.05268369e-13  5.28908503e-07 -4.79203418e-04  6.60193122e-03
 -7.70619203e-02  1.07093866e+00]
  HOMO = -0.243083933307012  LUMO = 0.927833605443696
  mo_energy =
[-1.20327257e+02 -1.23814637e+01 -6.67842033e+00 -6.67842033e+00
 -6.67842033e+00 -1.17955079e+00 -2.43083933e-01 -2.43083933e-01
 -2.43083933e-01  9.27833605e-01  6.16200583e+00  2.52027693e+01
  8.97049544e+01  2.92524908e+02  9.24943223e+02  3.18054132e+03
  1.26635180e+04  4.12600391e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211735e+05  1.52838295e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6758641116103  E_coul = 198.68514716559577
cycle= 6 E= -507.990716946015  delta_E= -4.6e-12  |g|= 9.09e-08  |ddm|= 1.27e-05
    CPU time for cycle= 6      0.05 sec, wall time      0.07 sec
E1 = -706.6758641116103  E_coul = 198.68514716559577
  HOMO = -0.243083975766238  LUMO = 0.927833580549159
  mo_energy =
[-1.20327257e+02 -1.23814638e+01 -6.67842042e+00 -6.67842042e+00
 -6.67842042e+00 -1.17955081e+00 -2.43083976e-01 -2.43083976e-01
 -2.43083976e-01  9.27833581e-01  6.16200576e+00  2.52027692e+01
  8.97049544e+01  2.92524908e+02  9.24943223e+02  3.18054132e+03
  1.26635180e+04  4.12600391e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211735e+05  1.52838295e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6758639207981  E_coul = 198.6851469747838
Extra cycle  E= -507.990716946014  delta_E= 2.84e-13  |g|= 1.11e-08  |ddm|= 2.1e-07
    CPU time for scf_cycle      1.61 sec, wall time      0.36 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913081.4277727002
E1 = -706.6758639207981  E_coul = 198.6851469747838
init E= -507.990716946014
    CPU time for initialize scf      6.63 sec, wall time      0.28 sec
  HOMO = -0.243083981888098  LUMO = 0.927833579914715
  mo_energy =
[-1.20327257e+02 -1.23814638e+01 -6.67842043e+00 -6.67842043e+00
 -6.67842043e+00 -1.17955081e+00 -2.43083982e-01 -2.43083982e-01
 -2.43083982e-01  9.27833580e-01  6.16200575e+00  2.52027692e+01
  8.97049543e+01  2.92524908e+02  9.24943223e+02  3.18054132e+03
  1.26635180e+04  4.12600391e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211735e+05  1.52838295e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.6758638905285  E_coul = 198.68514694451443
cycle= 1 E= -507.990716946014  delta_E= 1.71e-13  |g|= 1.92e-09  |ddm|= 2.78e-08
    CPU time for cycle= 1      0.28 sec, wall time      0.03 sec
E1 = -706.6758638905285  E_coul = 198.68514694451443
  HOMO = -0.243083982824419  LUMO = 0.927833578818001
  mo_energy =
[-1.20327257e+02 -1.23814638e+01 -6.67842043e+00 -6.67842043e+00
 -6.67842043e+00 -1.17955081e+00 -2.43083983e-01 -2.43083983e-01
 -2.43083983e-01  9.27833579e-01  6.16200575e+00  2.52027692e+01
  8.97049543e+01  2.92524908e+02  9.24943223e+02  3.18054132e+03
  1.26635180e+04  4.12600391e+04  1.05286942e+05  2.30459007e+05
  4.56265726e+05  8.45211735e+05  1.52838295e+06  2.85064291e+06
  5.80852065e+06]
E1 = -706.675863886194  E_coul = 198.6851469401801
Extra cycle  E= -507.990716946014  delta_E= 1.71e-13  |g|= 1.67e-09  |ddm|= 3.73e-09
    CPU time for scf_cycle      7.07 sec, wall time      0.47 sec
exp = [2.33931397e-01 6.13940110e-01 2.09772595e+00 1.17616812e+05
 4.47775291e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546949e+04 7.30190110e+03
 1.83757550e+04 1.44672062e+03 4.17663749e+02 1.48044655e+02
 6.04299142e+01 2.68898989e+01 9.55394904e+00 8.60423869e+00
 4.92746320e-01]
grad_E = [ 1.38909596e-04 -9.66331714e-05 -4.92169565e-06  6.00888619e-09
  3.46423891e-05  3.98399454e-11  1.72402380e-10  9.32112450e-10
  3.68207112e-09  1.53739741e-08  8.02536466e-08  5.07007540e-06
  1.96127897e-07 -3.95351986e-05  1.28099165e-05 -6.20990442e-05
  1.76587241e-06  5.89967032e-05 -1.50855286e-05 -2.00132066e-05
 -1.20445136e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233558109751       1
[INPUT] 0    0    [1    /1   ]  0.612630371147       1
[INPUT] 0    0    [1    /1   ]  2.06879142689        1
[INPUT] 0    0    [1    /1   ]  117616.812403        1
[INPUT] 0    0    [1    /1   ]  4.41519552317        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991025        1
[INPUT] 0    0    [1    /1   ]  73510.416304         1
[INPUT] 0    0    [1    /1   ]  36754.6950457        1
[INPUT] 0    0    [1    /1   ]  7301.91242479        1
[INPUT] 0    0    [1    /1   ]  18375.7554283        1
[INPUT] 0    0    [1    /1   ]  1446.63459675        1
[INPUT] 0    0    [1    /1   ]  417.655906407        1
[INPUT] 0    0    [1    /1   ]  148.035682808        1
[INPUT] 0    0    [1    /1   ]  60.3866041404        1
[INPUT] 0    0    [1    /1   ]  26.8186553281        1
[INPUT] 0    0    [1    /1   ]  9.45118532968        1
[INPUT] 1    0    [1    /1   ]  8.60425163106        1
[INPUT] 1    0    [1    /1   ]  0.492747385085       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2335581097509248, 1.0]], [0, [0.6126303711465624, 1.0]], [0, [2.0687914268935015, 1.0]], [0, [117616.81240325137, 1.0]], [0, [4.41519552316524, 1.0]], [0, [1176168.142610207, 1.0]], [0, [588084.0699425892, 1.0]], [0, [294042.0308460147, 1.0]], [0, [147020.9910253231, 1.0]], [0, [73510.41630399878, 1.0]], [0, [36754.69504574852, 1.0]], [0, [7301.9124247894915, 1.0]], [0, [18375.755428272434, 1.0]], [0, [1446.6345967498842, 1.0]], [0, [417.65590640673645, 1.0]], [0, [148.03568280750184, 1.0]], [0, [60.386604140448625, 1.0]], [0, [26.818655328135126, 1.0]], [0, [9.451185329682938, 1.0]], [1, [8.604251631060716, 1.0]], [1, [0.49274738508532, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23355811]
bas 1, expnt(s) = [0.61263037]
bas 2, expnt(s) = [2.06879143]
bas 3, expnt(s) = [117616.81240325]
bas 4, expnt(s) = [4.41519552]
bas 5, expnt(s) = [1176168.14261021]
bas 6, expnt(s) = [588084.06994259]
bas 7, expnt(s) = [294042.03084601]
bas 8, expnt(s) = [147020.99102532]
bas 9, expnt(s) = [73510.416304]
bas 10, expnt(s) = [36754.69504575]
bas 11, expnt(s) = [7301.91242479]
bas 12, expnt(s) = [18375.75542827]
bas 13, expnt(s) = [1446.63459675]
bas 14, expnt(s) = [417.65590641]
bas 15, expnt(s) = [148.03568281]
bas 16, expnt(s) = [60.38660414]
bas 17, expnt(s) = [26.81865533]
bas 18, expnt(s) = [9.45118533]
bas 19, expnt(s) = [8.60425163]
bas 20, expnt(s) = [0.49274739]
CPU time:      1564.75
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33558110e-01 8.48811467e-01 6.12630371e-01 1.74949988e+00
 2.06879143e+00 4.35815383e+00 1.17616812e+05 1.60460107e+04
 4.41519552e+00 7.69533410e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655734e+03 7.30191242e+03 1.99568728e+03
 1.83757554e+04 3.98748375e+03 1.44663460e+03 5.92630719e+02
 4.17655906e+02 2.33415125e+02 1.48035683e+02 1.07223464e+02
 6.03866041e+01 5.47293739e+01 2.68186553e+01 2.97743832e+01
 9.45118533e+00 1.36185144e+01 8.60425163e+00 4.29908242e+01
 4.92747385e-01 1.20438352e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336065640494702
cond(S) = 913051.7345742903
E1 = -689.5959345785403  E_coul = 184.97085348328432
init E= -504.625081095256
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672187477506023  LUMO = 0.572954994754665
  mo_energy =
[-1.21709912e+02 -1.33863896e+01 -7.62364301e+00 -7.62364301e+00
 -7.62364301e+00 -1.65754777e+00 -6.72187478e-01 -6.72187478e-01
 -6.72187478e-01  5.72954995e-01  5.45988528e+00  2.39126030e+01
  8.76917224e+01  2.90071648e+02  9.22375485e+02  3.17801314e+03
  1.26610627e+04  4.12576870e+04  1.05284671e+05  2.30456795e+05
  4.56263557e+05  8.45209599e+05  1.52838085e+06  2.85064084e+06
  5.80851862e+06]
E1 = -707.7534979037774  E_coul = 199.7808355061548
cycle= 1 E= -507.972662397623  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.760751
diis-c [-0.57874155  1.        ]
  HOMO = -0.21766411355225  LUMO = 0.928569012138176
  mo_energy =
[-1.20200343e+02 -1.23048997e+01 -6.59411736e+00 -6.59411736e+00
 -6.59411736e+00 -1.16332553e+00 -2.17664114e-01 -2.17664114e-01
 -2.17664114e-01  9.28569012e-01  6.11436322e+00  2.48884719e+01
  8.89764551e+01  2.91526472e+02  9.23866810e+02  3.17944531e+03
  1.26623886e+04  4.12589458e+04  1.05285893e+05  2.30457992e+05
  4.56264737e+05  8.45210766e+05  1.52838200e+06  2.85064198e+06
  5.80851976e+06]
E1 = -706.7999507018022  E_coul = 198.80949905529008
cycle= 2 E= -507.990451646512  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.402
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0337344
diis-c [-0.00113608 -0.00183043  1.00183043]
  HOMO = -0.239780211405127  LUMO = 0.924466607666623
  mo_energy =
[-1.20315077e+02 -1.23725206e+01 -6.66899689e+00 -6.66899689e+00
 -6.66899689e+00 -1.17755297e+00 -2.39780211e-01 -2.39780211e-01
 -2.39780211e-01  9.24466608e-01  6.08370409e+00  2.48292664e+01
  8.88913926e+01  2.91421583e+02  9.23746444e+02  3.17931063e+03
  1.26622437e+04  4.12587970e+04  1.05285742e+05  2.30457841e+05
  4.56264585e+05  8.45210614e+05  1.52838185e+06  2.85064183e+06
  5.80851960e+06]
E1 = -706.691987494135  E_coul = 198.70127509091913
cycle= 3 E= -507.990712403216  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00365283
diis-c [-3.05128010e-06  1.13299767e-04 -1.05444064e-01  1.10533076e+00]
  HOMO = -0.242928270738574  LUMO = 0.923653512742494
  mo_energy =
[-1.20326866e+02 -1.23810911e+01 -6.67805513e+00 -6.67805513e+00
 -6.67805513e+00 -1.17946030e+00 -2.42928271e-01 -2.42928271e-01
 -2.42928271e-01  9.23653513e-01  6.07919833e+00  2.48216559e+01
  8.88816218e+01  2.91410444e+02  9.23734415e+02  3.17929789e+03
  1.26622305e+04  4.12587836e+04  1.05285729e+05  2.30457828e+05
  4.56264572e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6767370969068  E_coul = 198.68601967637562
cycle= 4 E= -507.990717420531  delta_E= -5.02e-06  |g|= 0.000234  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170309
diis-c [-4.40415581e-10 -8.95619195e-06  6.92795246e-03 -9.99717823e-02
  1.09305279e+00]
  HOMO = -0.243081210065914  LUMO = 0.923605123202825
  mo_energy =
[-1.20327232e+02 -1.23814442e+01 -6.67840532e+00 -6.67840532e+00
 -6.67840532e+00 -1.17955270e+00 -2.43081210e-01 -2.43081210e-01
 -2.43081210e-01  9.23605123e-01  6.07897580e+00  2.48213365e+01
  8.88812689e+01  2.91410082e+02  9.23734047e+02  3.17929752e+03
  1.26622301e+04  4.12587832e+04  1.05285729e+05  2.30457827e+05
  4.56264571e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6760036192727  E_coul = 198.68528618465095
cycle= 5 E= -507.990717434622  delta_E= -1.41e-08  |g|= 4.77e-06  |ddm|= 0.000634
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.1312e-06
diis-c [-7.23446797e-13  5.39748848e-07 -4.88431353e-04  6.71322642e-03
 -7.85489924e-02  1.07232366e+00]
  HOMO = -0.243083494435536  LUMO = 0.923604471158358
  mo_energy =
[-1.20327237e+02 -1.23814488e+01 -6.67840996e+00 -6.67840996e+00
 -6.67840996e+00 -1.17955428e+00 -2.43083494e-01 -2.43083494e-01
 -2.43083494e-01  9.23604471e-01  6.07897247e+00  2.48213322e+01
  8.88812640e+01  2.91410077e+02  9.23734042e+02  3.17929751e+03
  1.26622301e+04  4.12587832e+04  1.05285729e+05  2.30457827e+05
  4.56264571e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6759921315307  E_coul = 198.68527469690426
cycle= 6 E= -507.990717434627  delta_E= -4.77e-12  |g|= 9.22e-08  |ddm|= 1.32e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759921315307  E_coul = 198.68527469690426
  HOMO = -0.243083536959455  LUMO = 0.923604448236568
  mo_energy =
[-1.20327237e+02 -1.23814489e+01 -6.67841004e+00 -6.67841004e+00
 -6.67841004e+00 -1.17955430e+00 -2.43083537e-01 -2.43083537e-01
 -2.43083537e-01  9.23604448e-01  6.07897241e+00  2.48213321e+01
  8.88812640e+01  2.91410077e+02  9.23734042e+02  3.17929751e+03
  1.26622301e+04  4.12587832e+04  1.05285729e+05  2.30457827e+05
  4.56264571e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6759919391563  E_coul = 198.68527450453
Extra cycle  E= -507.990717434626  delta_E= 1.71e-13  |g|= 1.13e-08  |ddm|= 2.14e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.33558110e-01 6.12630371e-01 2.06879143e+00 1.17616812e+05
 4.41519552e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191242e+03
 1.83757554e+04 1.44663460e+03 4.17655906e+02 1.48035683e+02
 6.03866041e+01 2.68186553e+01 9.45118533e+00 8.60425163e+00
 4.92747385e-01]
E = -507.99071743462633
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:09 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233558109751       1
[INPUT] 0    0    [1    /1   ]  0.612630371147       1
[INPUT] 0    0    [1    /1   ]  2.06879142689        1
[INPUT] 0    0    [1    /1   ]  117616.812403        1
[INPUT] 0    0    [1    /1   ]  4.41519552317        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991025        1
[INPUT] 0    0    [1    /1   ]  73510.416304         1
[INPUT] 0    0    [1    /1   ]  36754.6950457        1
[INPUT] 0    0    [1    /1   ]  7301.91242479        1
[INPUT] 0    0    [1    /1   ]  18375.7554283        1
[INPUT] 0    0    [1    /1   ]  1446.63459675        1
[INPUT] 0    0    [1    /1   ]  417.655906407        1
[INPUT] 0    0    [1    /1   ]  148.035682808        1
[INPUT] 0    0    [1    /1   ]  60.3866041404        1
[INPUT] 0    0    [1    /1   ]  26.8186553281        1
[INPUT] 0    0    [1    /1   ]  9.45118532968        1
[INPUT] 1    0    [1    /1   ]  8.60425163106        1
[INPUT] 1    0    [1    /1   ]  0.492747385085       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2335581097509248, 1.0]], [0, [0.6126303711465624, 1.0]], [0, [2.0687914268935015, 1.0]], [0, [117616.81240325137, 1.0]], [0, [4.41519552316524, 1.0]], [0, [1176168.142610207, 1.0]], [0, [588084.0699425892, 1.0]], [0, [294042.0308460147, 1.0]], [0, [147020.9910253231, 1.0]], [0, [73510.41630399878, 1.0]], [0, [36754.69504574852, 1.0]], [0, [7301.9124247894915, 1.0]], [0, [18375.755428272434, 1.0]], [0, [1446.6345967498842, 1.0]], [0, [417.65590640673645, 1.0]], [0, [148.03568280750184, 1.0]], [0, [60.386604140448625, 1.0]], [0, [26.818655328135126, 1.0]], [0, [9.451185329682938, 1.0]], [1, [8.604251631060716, 1.0]], [1, [0.49274738508532, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23355811]
bas 1, expnt(s) = [0.61263037]
bas 2, expnt(s) = [2.06879143]
bas 3, expnt(s) = [117616.81240325]
bas 4, expnt(s) = [4.41519552]
bas 5, expnt(s) = [1176168.14261021]
bas 6, expnt(s) = [588084.06994259]
bas 7, expnt(s) = [294042.03084601]
bas 8, expnt(s) = [147020.99102532]
bas 9, expnt(s) = [73510.416304]
bas 10, expnt(s) = [36754.69504575]
bas 11, expnt(s) = [7301.91242479]
bas 12, expnt(s) = [18375.75542827]
bas 13, expnt(s) = [1446.63459675]
bas 14, expnt(s) = [417.65590641]
bas 15, expnt(s) = [148.03568281]
bas 16, expnt(s) = [60.38660414]
bas 17, expnt(s) = [26.81865533]
bas 18, expnt(s) = [9.45118533]
bas 19, expnt(s) = [8.60425163]
bas 20, expnt(s) = [0.49274739]
CPU time:      1566.87
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33558110e-01 8.48811467e-01 6.12630371e-01 1.74949988e+00
 2.06879143e+00 4.35815383e+00 1.17616812e+05 1.60460107e+04
 4.41519552e+00 7.69533410e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655734e+03 7.30191242e+03 1.99568728e+03
 1.83757554e+04 3.98748375e+03 1.44663460e+03 5.92630719e+02
 4.17655906e+02 2.33415125e+02 1.48035683e+02 1.07223464e+02
 6.03866041e+01 5.47293739e+01 2.68186553e+01 2.97743832e+01
 9.45118533e+00 1.36185144e+01 8.60425163e+00 4.29908242e+01
 4.92747385e-01 1.20438352e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336065640494702
cond(S) = 913051.7345742903
E1 = -689.5959345785403  E_coul = 184.97085348328432
init E= -504.625081095256
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672187477506023  LUMO = 0.572954994754665
  mo_energy =
[-1.21709912e+02 -1.33863896e+01 -7.62364301e+00 -7.62364301e+00
 -7.62364301e+00 -1.65754777e+00 -6.72187478e-01 -6.72187478e-01
 -6.72187478e-01  5.72954995e-01  5.45988528e+00  2.39126030e+01
  8.76917224e+01  2.90071648e+02  9.22375485e+02  3.17801314e+03
  1.26610627e+04  4.12576870e+04  1.05284671e+05  2.30456795e+05
  4.56263557e+05  8.45209599e+05  1.52838085e+06  2.85064084e+06
  5.80851862e+06]
E1 = -707.7534979037774  E_coul = 199.7808355061548
cycle= 1 E= -507.972662397623  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.760751
diis-c [-0.57874155  1.        ]
  HOMO = -0.21766411355225  LUMO = 0.928569012138176
  mo_energy =
[-1.20200343e+02 -1.23048997e+01 -6.59411736e+00 -6.59411736e+00
 -6.59411736e+00 -1.16332553e+00 -2.17664114e-01 -2.17664114e-01
 -2.17664114e-01  9.28569012e-01  6.11436322e+00  2.48884719e+01
  8.89764551e+01  2.91526472e+02  9.23866810e+02  3.17944531e+03
  1.26623886e+04  4.12589458e+04  1.05285893e+05  2.30457992e+05
  4.56264737e+05  8.45210766e+05  1.52838200e+06  2.85064198e+06
  5.80851976e+06]
E1 = -706.7999507018022  E_coul = 198.80949905529008
cycle= 2 E= -507.990451646512  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.402
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0337344
diis-c [-0.00113608 -0.00183043  1.00183043]
  HOMO = -0.239780211405127  LUMO = 0.924466607666623
  mo_energy =
[-1.20315077e+02 -1.23725206e+01 -6.66899689e+00 -6.66899689e+00
 -6.66899689e+00 -1.17755297e+00 -2.39780211e-01 -2.39780211e-01
 -2.39780211e-01  9.24466608e-01  6.08370409e+00  2.48292664e+01
  8.88913926e+01  2.91421583e+02  9.23746444e+02  3.17931063e+03
  1.26622437e+04  4.12587970e+04  1.05285742e+05  2.30457841e+05
  4.56264585e+05  8.45210614e+05  1.52838185e+06  2.85064183e+06
  5.80851960e+06]
E1 = -706.691987494135  E_coul = 198.70127509091913
cycle= 3 E= -507.990712403216  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00365283
diis-c [-3.05128010e-06  1.13299767e-04 -1.05444064e-01  1.10533076e+00]
  HOMO = -0.242928270738574  LUMO = 0.923653512742494
  mo_energy =
[-1.20326866e+02 -1.23810911e+01 -6.67805513e+00 -6.67805513e+00
 -6.67805513e+00 -1.17946030e+00 -2.42928271e-01 -2.42928271e-01
 -2.42928271e-01  9.23653513e-01  6.07919833e+00  2.48216559e+01
  8.88816218e+01  2.91410444e+02  9.23734415e+02  3.17929789e+03
  1.26622305e+04  4.12587836e+04  1.05285729e+05  2.30457828e+05
  4.56264572e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6767370969068  E_coul = 198.68601967637562
cycle= 4 E= -507.990717420531  delta_E= -5.02e-06  |g|= 0.000234  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170309
diis-c [-4.40415581e-10 -8.95619195e-06  6.92795246e-03 -9.99717823e-02
  1.09305279e+00]
  HOMO = -0.243081210065914  LUMO = 0.923605123202825
  mo_energy =
[-1.20327232e+02 -1.23814442e+01 -6.67840532e+00 -6.67840532e+00
 -6.67840532e+00 -1.17955270e+00 -2.43081210e-01 -2.43081210e-01
 -2.43081210e-01  9.23605123e-01  6.07897580e+00  2.48213365e+01
  8.88812689e+01  2.91410082e+02  9.23734047e+02  3.17929752e+03
  1.26622301e+04  4.12587832e+04  1.05285729e+05  2.30457827e+05
  4.56264571e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6760036192727  E_coul = 198.68528618465095
cycle= 5 E= -507.990717434622  delta_E= -1.41e-08  |g|= 4.77e-06  |ddm|= 0.000634
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.1312e-06
diis-c [-7.23446797e-13  5.39748848e-07 -4.88431353e-04  6.71322642e-03
 -7.85489924e-02  1.07232366e+00]
  HOMO = -0.243083494435536  LUMO = 0.923604471158358
  mo_energy =
[-1.20327237e+02 -1.23814488e+01 -6.67840996e+00 -6.67840996e+00
 -6.67840996e+00 -1.17955428e+00 -2.43083494e-01 -2.43083494e-01
 -2.43083494e-01  9.23604471e-01  6.07897247e+00  2.48213322e+01
  8.88812640e+01  2.91410077e+02  9.23734042e+02  3.17929751e+03
  1.26622301e+04  4.12587832e+04  1.05285729e+05  2.30457827e+05
  4.56264571e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6759921315307  E_coul = 198.68527469690426
cycle= 6 E= -507.990717434627  delta_E= -4.77e-12  |g|= 9.22e-08  |ddm|= 1.32e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759921315307  E_coul = 198.68527469690426
  HOMO = -0.243083536959455  LUMO = 0.923604448236568
  mo_energy =
[-1.20327237e+02 -1.23814489e+01 -6.67841004e+00 -6.67841004e+00
 -6.67841004e+00 -1.17955430e+00 -2.43083537e-01 -2.43083537e-01
 -2.43083537e-01  9.23604448e-01  6.07897241e+00  2.48213321e+01
  8.88812640e+01  2.91410077e+02  9.23734042e+02  3.17929751e+03
  1.26622301e+04  4.12587832e+04  1.05285729e+05  2.30457827e+05
  4.56264571e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6759919391563  E_coul = 198.68527450453
Extra cycle  E= -507.990717434626  delta_E= 1.71e-13  |g|= 1.13e-08  |ddm|= 2.14e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913051.7345742903
E1 = -706.6759919391563  E_coul = 198.68527450453
init E= -507.990717434626
    CPU time for initialize scf      5.91 sec, wall time      0.25 sec
  HOMO = -0.243083543153126  LUMO = 0.92360444606834
  mo_energy =
[-1.20327237e+02 -1.23814489e+01 -6.67841006e+00 -6.67841006e+00
 -6.67841006e+00 -1.17955431e+00 -2.43083543e-01 -2.43083543e-01
 -2.43083543e-01  9.23604446e-01  6.07897240e+00  2.48213321e+01
  8.88812639e+01  2.91410077e+02  9.23734042e+02  3.17929751e+03
  1.26622301e+04  4.12587832e+04  1.05285729e+05  2.30457827e+05
  4.56264571e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6759919083686  E_coul = 198.6852744737421
cycle= 1 E= -507.990717434627  delta_E= -1.71e-13  |g|= 2.38e-09  |ddm|= 2.81e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6759919083686  E_coul = 198.6852744737421
  HOMO = -0.243083544089159  LUMO = 0.923604446635486
  mo_energy =
[-1.20327237e+02 -1.23814489e+01 -6.67841006e+00 -6.67841006e+00
 -6.67841006e+00 -1.17955431e+00 -2.43083544e-01 -2.43083544e-01
 -2.43083544e-01  9.23604447e-01  6.07897240e+00  2.48213321e+01
  8.88812639e+01  2.91410077e+02  9.23734042e+02  3.17929751e+03
  1.26622301e+04  4.12587832e+04  1.05285729e+05  2.30457827e+05
  4.56264571e+05  8.45210600e+05  1.52838184e+06  2.85064182e+06
  5.80851959e+06]
E1 = -706.6759919039796  E_coul = 198.68527446935371
Extra cycle  E= -507.990717434626  delta_E= 6.25e-13  |g|= 1.91e-09  |ddm|= 4.37e-09
    CPU time for scf_cycle      6.38 sec, wall time      0.43 sec
exp = [2.33558110e-01 6.12630371e-01 2.06879143e+00 1.17616812e+05
 4.41519552e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191242e+03
 1.83757554e+04 1.44663460e+03 4.17655906e+02 1.48035683e+02
 6.03866041e+01 2.68186553e+01 9.45118533e+00 8.60425163e+00
 4.92747385e-01]
grad_E = [ 6.15068310e-05 -1.97427834e-05  1.00878669e-05  6.01263724e-09
  2.36195031e-05  3.98821387e-11  1.72525420e-10  9.32687983e-10
  3.68439465e-09  1.53838008e-08  8.03009097e-08  5.07278776e-06
  1.96283675e-07 -3.95870424e-05  1.29872660e-05 -6.28598950e-05
  4.77022513e-06  5.62543994e-05 -1.81861452e-05 -1.15954452e-05
 -7.75431860e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233225869941       1
[INPUT] 0    0    [1    /1   ]  0.61174532631        1
[INPUT] 0    0    [1    /1   ]  2.04927696672        1
[INPUT] 0    0    [1    /1   ]  117616.812405        1
[INPUT] 0    0    [1    /1   ]  4.38316586343        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991026        1
[INPUT] 0    0    [1    /1   ]  73510.4163077        1
[INPUT] 0    0    [1    /1   ]  36754.6950649        1
[INPUT] 0    0    [1    /1   ]  7301.91362972        1
[INPUT] 0    0    [1    /1   ]  18375.7554752        1
[INPUT] 0    0    [1    /1   ]  1446.62540483        1
[INPUT] 0    0    [1    /1   ]  417.655538269        1
[INPUT] 0    0    [1    /1   ]  148.032398664        1
[INPUT] 0    0    [1    /1   ]  60.3901744778        1
[INPUT] 0    0    [1    /1   ]  26.805071926         1
[INPUT] 0    0    [1    /1   ]  9.41296804293        1
[INPUT] 1    0    [1    /1   ]  8.60426223222        1
[INPUT] 1    0    [1    /1   ]  0.492749232848       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23322586994135036, 1.0]], [0, [0.6117453263104767, 1.0]], [0, [2.0492769667220645, 1.0]], [0, [117616.8124046835, 1.0]], [0, [4.383165863431711, 1.0]], [0, [1176168.1426102165, 1.0]], [0, [588084.0699426304, 1.0]], [0, [294042.0308462368, 1.0]], [0, [147020.9910262008, 1.0]], [0, [73510.41630766392, 1.0]], [0, [36754.69506486281, 1.0]], [0, [7301.913629717349, 1.0]], [0, [18375.755475163143, 1.0]], [0, [1446.6254048321935, 1.0]], [0, [417.6555382691543, 1.0]], [0, [148.0323986636197, 1.0]], [0, [60.39017447780623, 1.0]], [0, [26.805071925954223, 1.0]], [0, [9.412968042934985, 1.0]], [1, [8.604262232220039, 1.0]], [1, [0.4927492328480783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23322587]
bas 1, expnt(s) = [0.61174533]
bas 2, expnt(s) = [2.04927697]
bas 3, expnt(s) = [117616.81240468]
bas 4, expnt(s) = [4.38316586]
bas 5, expnt(s) = [1176168.14261022]
bas 6, expnt(s) = [588084.06994263]
bas 7, expnt(s) = [294042.03084624]
bas 8, expnt(s) = [147020.9910262]
bas 9, expnt(s) = [73510.41630766]
bas 10, expnt(s) = [36754.69506486]
bas 11, expnt(s) = [7301.91362972]
bas 12, expnt(s) = [18375.75547516]
bas 13, expnt(s) = [1446.62540483]
bas 14, expnt(s) = [417.65553827]
bas 15, expnt(s) = [148.03239866]
bas 16, expnt(s) = [60.39017448]
bas 17, expnt(s) = [26.80507193]
bas 18, expnt(s) = [9.41296804]
bas 19, expnt(s) = [8.60426223]
bas 20, expnt(s) = [0.49274923]
CPU time:      1582.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33225870e-01 8.47905721e-01 6.11745326e-01 1.74760396e+00
 2.04927697e+00 4.32728519e+00 1.17616812e+05 1.60460107e+04
 4.38316586e+00 7.65342716e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546951e+04 6.70655734e+03 7.30191363e+03 1.99568753e+03
 1.83757555e+04 3.98748375e+03 1.44662540e+03 5.92627895e+02
 4.17655538e+02 2.33414971e+02 1.48032399e+02 1.07221680e+02
 6.03901745e+01 5.47318008e+01 2.68050719e+01 2.97630721e+01
 9.41296804e+00 1.35771921e+01 8.60426223e+00 4.29908904e+01
 4.92749233e-01 1.20438916e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336065322925684
cond(S) = 913040.2299513713
E1 = -689.5960623436126  E_coul = 184.9710155392239
init E= -504.625046804389
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672183779733339  LUMO = 0.570558713155703
  mo_energy =
[-1.21709892e+02 -1.33863742e+01 -7.62363153e+00 -7.62363153e+00
 -7.62363153e+00 -1.65754829e+00 -6.72183780e-01 -6.72183780e-01
 -6.72183780e-01  5.70558713e-01  5.41188941e+00  2.37170584e+01
  8.73326428e+01  2.89661358e+02  9.21977372e+02  3.17763853e+03
  1.26607119e+04  4.12573554e+04  1.05284352e+05  2.30456485e+05
  4.56263253e+05  8.45209300e+05  1.52838055e+06  2.85064055e+06
  5.80851834e+06]
E1 = -707.7537738312086  E_coul = 199.78111472203602
cycle= 1 E= -507.972659109173  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.760683
diis-c [-0.57863875  1.        ]
  HOMO = -0.21765791963271  LUMO = 0.925516621025507
  mo_energy =
[-1.20200310e+02 -1.23048760e+01 -6.59409671e+00 -6.59409671e+00
 -6.59409671e+00 -1.16332279e+00 -2.17657920e-01 -2.17657920e-01
 -2.17657920e-01  9.25516621e-01  6.06396688e+00  2.46911924e+01
  8.86171498e+01  2.91116247e+02  9.23468733e+02  3.17907071e+03
  1.26620378e+04  4.12586142e+04  1.05285574e+05  2.30457682e+05
  4.56264434e+05  8.45210467e+05  1.52838171e+06  2.85064170e+06
  5.80851948e+06]
E1 = -706.8000589001686  E_coul = 198.80960705212337
cycle= 2 E= -507.990451848045  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0338019
diis-c [-0.00114055 -0.00186969  1.00186969]
  HOMO = -0.239779368017707  LUMO = 0.921444711099954
  mo_energy =
[-1.20315066e+02 -1.23725123e+01 -6.66899255e+00 -6.66899255e+00
 -6.66899255e+00 -1.17755385e+00 -2.39779368e-01 -2.39779368e-01
 -2.39779368e-01  9.21444711e-01  6.03350131e+00  2.46321240e+01
  8.85321013e+01  2.91011336e+02  9.23348342e+02  3.17893600e+03
  1.26618929e+04  4.12584653e+04  1.05285423e+05  2.30457531e+05
  4.56264282e+05  8.45210315e+05  1.52838156e+06  2.85064154e+06
  5.80851932e+06]
E1 = -706.6920603420887  E_coul = 198.70134761335768
cycle= 3 E= -507.990712728731  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00366509
diis-c [-3.06349665e-06  1.11724874e-04 -1.05648440e-01  1.10553672e+00]
  HOMO = -0.242928670888616  LUMO = 0.92063606683435
  mo_energy =
[-1.20326855e+02 -1.23810845e+01 -6.67805243e+00 -6.67805243e+00
 -6.67805243e+00 -1.17946200e+00 -2.42928671e-01 -2.42928671e-01
 -2.42928671e-01  9.20636067e-01  6.02901946e+00  2.46245266e+01
  8.85223315e+01  2.91000196e+02  9.23336312e+02  3.17892326e+03
  1.26618797e+04  4.12584520e+04  1.05285410e+05  2.30457518e+05
  4.56264268e+05  8.45210302e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6768014888552  E_coul = 198.68608373696898
cycle= 4 E= -507.990717751886  delta_E= -5.02e-06  |g|= 0.000234  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170392
diis-c [-4.48231381e-10 -8.98519392e-06  6.92982732e-03 -9.97846818e-02
  1.09286384e+00]
  HOMO = -0.243081167548483  LUMO = 0.920587981321999
  mo_energy =
[-1.20327219e+02 -1.23814361e+01 -6.67840089e+00 -6.67840089e+00
 -6.67840089e+00 -1.17955415e+00 -2.43081168e-01 -2.43081168e-01
 -2.43081168e-01  9.20587981e-01  6.02879861e+00  2.46242090e+01
  8.85219805e+01  2.90999835e+02  9.23335947e+02  3.17892289e+03
  1.26618793e+04  4.12584516e+04  1.05285410e+05  2.30457517e+05
  4.56264268e+05  8.45210301e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6760699655066  E_coul = 198.68535219954396
cycle= 5 E= -507.990717765963  delta_E= -1.41e-08  |g|= 4.85e-06  |ddm|= 0.000637
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.16419e-06
diis-c [-7.40595098e-13  5.38073799e-07 -4.93230140e-04  6.76568028e-03
 -7.93390052e-02  1.07306602e+00]
  HOMO = -0.243083482209011  LUMO = 0.920587324505727
  mo_energy =
[-1.20327224e+02 -1.23814407e+01 -6.67840557e+00 -6.67840557e+00
 -6.67840557e+00 -1.17955575e+00 -2.43083482e-01 -2.43083482e-01
 -2.43083482e-01  9.20587325e-01  6.02879526e+00  2.46242047e+01
  8.85219756e+01  2.90999830e+02  9.23335941e+02  3.17892289e+03
  1.26618793e+04  4.12584516e+04  1.05285410e+05  2.30457517e+05
  4.56264268e+05  8.45210301e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6760583140622  E_coul = 198.68534054809416
cycle= 6 E= -507.990717765968  delta_E= -5.4e-12  |g|= 9.09e-08  |ddm|= 1.35e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6760583140622  E_coul = 198.68534054809416
  HOMO = -0.243083524930365  LUMO = 0.920587300233777
  mo_energy =
[-1.20327224e+02 -1.23814408e+01 -6.67840566e+00 -6.67840566e+00
 -6.67840566e+00 -1.17955577e+00 -2.43083525e-01 -2.43083525e-01
 -2.43083525e-01  9.20587300e-01  6.02879519e+00  2.46242046e+01
  8.85219756e+01  2.90999830e+02  9.23335941e+02  3.17892289e+03
  1.26618793e+04  4.12584516e+04  1.05285410e+05  2.30457517e+05
  4.56264268e+05  8.45210301e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6760581251722  E_coul = 198.6853403592043
Extra cycle  E= -507.990717765968  delta_E= 1.71e-13  |g|= 1.08e-08  |ddm|= 2.12e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
exp = [2.33225870e-01 6.11745326e-01 2.04927697e+00 1.17616812e+05
 4.38316586e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546951e+04 7.30191363e+03
 1.83757555e+04 1.44662540e+03 4.17655538e+02 1.48032399e+02
 6.03901745e+01 2.68050719e+01 9.41296804e+00 8.60426223e+00
 4.92749233e-01]
E = -507.9907177659679
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233225869941       1
[INPUT] 0    0    [1    /1   ]  0.61174532631        1
[INPUT] 0    0    [1    /1   ]  2.04927696672        1
[INPUT] 0    0    [1    /1   ]  117616.812405        1
[INPUT] 0    0    [1    /1   ]  4.38316586343        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991026        1
[INPUT] 0    0    [1    /1   ]  73510.4163077        1
[INPUT] 0    0    [1    /1   ]  36754.6950649        1
[INPUT] 0    0    [1    /1   ]  7301.91362972        1
[INPUT] 0    0    [1    /1   ]  18375.7554752        1
[INPUT] 0    0    [1    /1   ]  1446.62540483        1
[INPUT] 0    0    [1    /1   ]  417.655538269        1
[INPUT] 0    0    [1    /1   ]  148.032398664        1
[INPUT] 0    0    [1    /1   ]  60.3901744778        1
[INPUT] 0    0    [1    /1   ]  26.805071926         1
[INPUT] 0    0    [1    /1   ]  9.41296804293        1
[INPUT] 1    0    [1    /1   ]  8.60426223222        1
[INPUT] 1    0    [1    /1   ]  0.492749232848       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23322586994135036, 1.0]], [0, [0.6117453263104767, 1.0]], [0, [2.0492769667220645, 1.0]], [0, [117616.8124046835, 1.0]], [0, [4.383165863431711, 1.0]], [0, [1176168.1426102165, 1.0]], [0, [588084.0699426304, 1.0]], [0, [294042.0308462368, 1.0]], [0, [147020.9910262008, 1.0]], [0, [73510.41630766392, 1.0]], [0, [36754.69506486281, 1.0]], [0, [7301.913629717349, 1.0]], [0, [18375.755475163143, 1.0]], [0, [1446.6254048321935, 1.0]], [0, [417.6555382691543, 1.0]], [0, [148.0323986636197, 1.0]], [0, [60.39017447780623, 1.0]], [0, [26.805071925954223, 1.0]], [0, [9.412968042934985, 1.0]], [1, [8.604262232220039, 1.0]], [1, [0.4927492328480783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23322587]
bas 1, expnt(s) = [0.61174533]
bas 2, expnt(s) = [2.04927697]
bas 3, expnt(s) = [117616.81240468]
bas 4, expnt(s) = [4.38316586]
bas 5, expnt(s) = [1176168.14261022]
bas 6, expnt(s) = [588084.06994263]
bas 7, expnt(s) = [294042.03084624]
bas 8, expnt(s) = [147020.9910262]
bas 9, expnt(s) = [73510.41630766]
bas 10, expnt(s) = [36754.69506486]
bas 11, expnt(s) = [7301.91362972]
bas 12, expnt(s) = [18375.75547516]
bas 13, expnt(s) = [1446.62540483]
bas 14, expnt(s) = [417.65553827]
bas 15, expnt(s) = [148.03239866]
bas 16, expnt(s) = [60.39017448]
bas 17, expnt(s) = [26.80507193]
bas 18, expnt(s) = [9.41296804]
bas 19, expnt(s) = [8.60426223]
bas 20, expnt(s) = [0.49274923]
CPU time:      1584.09
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33225870e-01 8.47905721e-01 6.11745326e-01 1.74760396e+00
 2.04927697e+00 4.32728519e+00 1.17616812e+05 1.60460107e+04
 4.38316586e+00 7.65342716e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546951e+04 6.70655734e+03 7.30191363e+03 1.99568753e+03
 1.83757555e+04 3.98748375e+03 1.44662540e+03 5.92627895e+02
 4.17655538e+02 2.33414971e+02 1.48032399e+02 1.07221680e+02
 6.03901745e+01 5.47318008e+01 2.68050719e+01 2.97630721e+01
 9.41296804e+00 1.35771921e+01 8.60426223e+00 4.29908904e+01
 4.92749233e-01 1.20438916e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336065322925684
cond(S) = 913040.2299513713
E1 = -689.5960623436126  E_coul = 184.9710155392239
init E= -504.625046804389
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672183779733339  LUMO = 0.570558713155703
  mo_energy =
[-1.21709892e+02 -1.33863742e+01 -7.62363153e+00 -7.62363153e+00
 -7.62363153e+00 -1.65754829e+00 -6.72183780e-01 -6.72183780e-01
 -6.72183780e-01  5.70558713e-01  5.41188941e+00  2.37170584e+01
  8.73326428e+01  2.89661358e+02  9.21977372e+02  3.17763853e+03
  1.26607119e+04  4.12573554e+04  1.05284352e+05  2.30456485e+05
  4.56263253e+05  8.45209300e+05  1.52838055e+06  2.85064055e+06
  5.80851834e+06]
E1 = -707.7537738312086  E_coul = 199.78111472203602
cycle= 1 E= -507.972659109173  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.760683
diis-c [-0.57863875  1.        ]
  HOMO = -0.21765791963271  LUMO = 0.925516621025507
  mo_energy =
[-1.20200310e+02 -1.23048760e+01 -6.59409671e+00 -6.59409671e+00
 -6.59409671e+00 -1.16332279e+00 -2.17657920e-01 -2.17657920e-01
 -2.17657920e-01  9.25516621e-01  6.06396688e+00  2.46911924e+01
  8.86171498e+01  2.91116247e+02  9.23468733e+02  3.17907071e+03
  1.26620378e+04  4.12586142e+04  1.05285574e+05  2.30457682e+05
  4.56264434e+05  8.45210467e+05  1.52838171e+06  2.85064170e+06
  5.80851948e+06]
E1 = -706.8000589001686  E_coul = 198.80960705212337
cycle= 2 E= -507.990451848045  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0338019
diis-c [-0.00114055 -0.00186969  1.00186969]
  HOMO = -0.239779368017707  LUMO = 0.921444711099954
  mo_energy =
[-1.20315066e+02 -1.23725123e+01 -6.66899255e+00 -6.66899255e+00
 -6.66899255e+00 -1.17755385e+00 -2.39779368e-01 -2.39779368e-01
 -2.39779368e-01  9.21444711e-01  6.03350131e+00  2.46321240e+01
  8.85321013e+01  2.91011336e+02  9.23348342e+02  3.17893600e+03
  1.26618929e+04  4.12584653e+04  1.05285423e+05  2.30457531e+05
  4.56264282e+05  8.45210315e+05  1.52838156e+06  2.85064154e+06
  5.80851932e+06]
E1 = -706.6920603420887  E_coul = 198.70134761335768
cycle= 3 E= -507.990712728731  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.06
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00366509
diis-c [-3.06349665e-06  1.11724874e-04 -1.05648440e-01  1.10553672e+00]
  HOMO = -0.242928670888616  LUMO = 0.92063606683435
  mo_energy =
[-1.20326855e+02 -1.23810845e+01 -6.67805243e+00 -6.67805243e+00
 -6.67805243e+00 -1.17946200e+00 -2.42928671e-01 -2.42928671e-01
 -2.42928671e-01  9.20636067e-01  6.02901946e+00  2.46245266e+01
  8.85223315e+01  2.91000196e+02  9.23336312e+02  3.17892326e+03
  1.26618797e+04  4.12584520e+04  1.05285410e+05  2.30457518e+05
  4.56264268e+05  8.45210302e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6768014888552  E_coul = 198.68608373696898
cycle= 4 E= -507.990717751886  delta_E= -5.02e-06  |g|= 0.000234  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170392
diis-c [-4.48231381e-10 -8.98519392e-06  6.92982732e-03 -9.97846818e-02
  1.09286384e+00]
  HOMO = -0.243081167548483  LUMO = 0.920587981321999
  mo_energy =
[-1.20327219e+02 -1.23814361e+01 -6.67840089e+00 -6.67840089e+00
 -6.67840089e+00 -1.17955415e+00 -2.43081168e-01 -2.43081168e-01
 -2.43081168e-01  9.20587981e-01  6.02879861e+00  2.46242090e+01
  8.85219805e+01  2.90999835e+02  9.23335947e+02  3.17892289e+03
  1.26618793e+04  4.12584516e+04  1.05285410e+05  2.30457517e+05
  4.56264268e+05  8.45210301e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6760699655066  E_coul = 198.68535219954396
cycle= 5 E= -507.990717765963  delta_E= -1.41e-08  |g|= 4.85e-06  |ddm|= 0.000637
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.16419e-06
diis-c [-7.40595098e-13  5.38073799e-07 -4.93230140e-04  6.76568028e-03
 -7.93390052e-02  1.07306602e+00]
  HOMO = -0.243083482209011  LUMO = 0.920587324505727
  mo_energy =
[-1.20327224e+02 -1.23814407e+01 -6.67840557e+00 -6.67840557e+00
 -6.67840557e+00 -1.17955575e+00 -2.43083482e-01 -2.43083482e-01
 -2.43083482e-01  9.20587325e-01  6.02879526e+00  2.46242047e+01
  8.85219756e+01  2.90999830e+02  9.23335941e+02  3.17892289e+03
  1.26618793e+04  4.12584516e+04  1.05285410e+05  2.30457517e+05
  4.56264268e+05  8.45210301e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6760583140622  E_coul = 198.68534054809416
cycle= 6 E= -507.990717765968  delta_E= -5.4e-12  |g|= 9.09e-08  |ddm|= 1.35e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6760583140622  E_coul = 198.68534054809416
  HOMO = -0.243083524930365  LUMO = 0.920587300233777
  mo_energy =
[-1.20327224e+02 -1.23814408e+01 -6.67840566e+00 -6.67840566e+00
 -6.67840566e+00 -1.17955577e+00 -2.43083525e-01 -2.43083525e-01
 -2.43083525e-01  9.20587300e-01  6.02879519e+00  2.46242046e+01
  8.85219756e+01  2.90999830e+02  9.23335941e+02  3.17892289e+03
  1.26618793e+04  4.12584516e+04  1.05285410e+05  2.30457517e+05
  4.56264268e+05  8.45210301e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6760581251722  E_coul = 198.6853403592043
Extra cycle  E= -507.990717765968  delta_E= 1.71e-13  |g|= 1.08e-08  |ddm|= 2.12e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913040.2299513713
E1 = -706.6760581251722  E_coul = 198.6853403592043
init E= -507.990717765968
    CPU time for initialize scf      5.76 sec, wall time      0.24 sec
  HOMO = -0.243083531032377  LUMO = 0.920587296747284
  mo_energy =
[-1.20327225e+02 -1.23814408e+01 -6.67840567e+00 -6.67840567e+00
 -6.67840567e+00 -1.17955577e+00 -2.43083531e-01 -2.43083531e-01
 -2.43083531e-01  9.20587297e-01  6.02879518e+00  2.46242046e+01
  8.85219755e+01  2.90999830e+02  9.23335941e+02  3.17892289e+03
  1.26618793e+04  4.12584516e+04  1.05285410e+05  2.30457517e+05
  4.56264268e+05  8.45210301e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.676058099176  E_coul = 198.6853403332082
cycle= 1 E= -507.990717765968  delta_E= 5.68e-14  |g|= 2.12e-09  |ddm|= 2.5e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.676058099176  E_coul = 198.6853403332082
  HOMO = -0.24308353184127  LUMO = 0.920587297288462
  mo_energy =
[-1.20327225e+02 -1.23814408e+01 -6.67840567e+00 -6.67840567e+00
 -6.67840567e+00 -1.17955577e+00 -2.43083532e-01 -2.43083532e-01
 -2.43083532e-01  9.20587297e-01  6.02879518e+00  2.46242046e+01
  8.85219755e+01  2.90999830e+02  9.23335941e+02  3.17892289e+03
  1.26618793e+04  4.12584516e+04  1.05285410e+05  2.30457517e+05
  4.56264268e+05  8.45210301e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6760580936029  E_coul = 198.68534032763498
Extra cycle  E= -507.990717765968  delta_E= -1.14e-13  |g|= 1.52e-09  |ddm|= 4.59e-09
    CPU time for scf_cycle      6.27 sec, wall time      0.41 sec
exp = [2.33225870e-01 6.11745326e-01 2.04927697e+00 1.17616812e+05
 4.38316586e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546951e+04 7.30191363e+03
 1.83757555e+04 1.44662540e+03 4.17655538e+02 1.48032399e+02
 6.03901745e+01 2.68050719e+01 9.41296804e+00 8.60426223e+00
 4.92749233e-01]
grad_E = [-7.20635014e-05  2.93911628e-05  1.40152184e-05  6.01464479e-09
  1.06931651e-05  3.99047155e-11  1.72591244e-10  9.32995969e-10
  3.68563801e-09  1.53890602e-08  8.03262966e-08  5.07439118e-06
  1.96366609e-07 -3.96489574e-05  1.34836751e-05 -6.46378735e-05
  7.71464521e-06  5.51958812e-05 -1.41105679e-05 -5.21023376e-06
 -3.03237431e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233070177969       1
[INPUT] 0    0    [1    /1   ]  0.611286110363       1
[INPUT] 0    0    [1    /1   ]  2.02921425308        1
[INPUT] 0    0    [1    /1   ]  117616.812402        1
[INPUT] 0    0    [1    /1   ]  4.35954330121        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991025        1
[INPUT] 0    0    [1    /1   ]  73510.4163013        1
[INPUT] 0    0    [1    /1   ]  36754.6950315        1
[INPUT] 0    0    [1    /1   ]  7301.91152615        1
[INPUT] 0    0    [1    /1   ]  18375.7553934        1
[INPUT] 0    0    [1    /1   ]  1446.64133489        1
[INPUT] 0    0    [1    /1   ]  417.657496089        1
[INPUT] 0    0    [1    /1   ]  148.031522617        1
[INPUT] 0    0    [1    /1   ]  60.4075096248        1
[INPUT] 0    0    [1    /1   ]  26.811582882         1
[INPUT] 0    0    [1    /1   ]  9.40132925032        1
[INPUT] 1    0    [1    /1   ]  8.60427664049        1
[INPUT] 1    0    [1    /1   ]  0.492751027335       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2330701779685828, 1.0]], [0, [0.6112861103631492, 1.0]], [0, [2.0292142530825075, 1.0]], [0, [117616.81240218368, 1.0]], [0, [4.359543301207017, 1.0]], [0, [1176168.1426101997, 1.0]], [0, [588084.0699425585, 1.0]], [0, [294042.0308458491, 1.0]], [0, [147020.99102466882, 1.0]], [0, [73510.41630126667, 1.0]], [0, [36754.695031494535, 1.0]], [0, [7301.9115261542665, 1.0]], [0, [18375.755393361585, 1.0]], [0, [1446.6413348930805, 1.0]], [0, [417.6574960888471, 1.0]], [0, [148.03152261732416, 1.0]], [0, [60.4075096248464, 1.0]], [0, [26.811582881999374, 1.0]], [0, [9.401329250316412, 1.0]], [1, [8.60427664048691, 1.0]], [1, [0.49275102733531084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23307018]
bas 1, expnt(s) = [0.61128611]
bas 2, expnt(s) = [2.02921425]
bas 3, expnt(s) = [117616.81240218]
bas 4, expnt(s) = [4.3595433]
bas 5, expnt(s) = [1176168.1426102]
bas 6, expnt(s) = [588084.06994256]
bas 7, expnt(s) = [294042.03084585]
bas 8, expnt(s) = [147020.99102467]
bas 9, expnt(s) = [73510.41630127]
bas 10, expnt(s) = [36754.69503149]
bas 11, expnt(s) = [7301.91152615]
bas 12, expnt(s) = [18375.75539336]
bas 13, expnt(s) = [1446.64133489]
bas 14, expnt(s) = [417.65749609]
bas 15, expnt(s) = [148.03152262]
bas 16, expnt(s) = [60.40750962]
bas 17, expnt(s) = [26.81158288]
bas 18, expnt(s) = [9.40132925]
bas 19, expnt(s) = [8.60427664]
bas 20, expnt(s) = [0.49275103]
CPU time:      1599.12
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33070178e-01 8.47481165e-01 6.11286110e-01 1.74661997e+00
 2.02921425e+00 4.29547259e+00 1.17616812e+05 1.60460107e+04
 4.35954330e+00 7.62247083e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655734e+03 7.30191153e+03 1.99568710e+03
 1.83757554e+04 3.98748374e+03 1.44664133e+03 5.92632790e+02
 4.17657496e+02 2.33415792e+02 1.48031523e+02 1.07221204e+02
 6.04075096e+01 5.47435835e+01 2.68115829e+01 2.97684941e+01
 9.40132925e+00 1.35645994e+01 8.60427664e+00 4.29909804e+01
 4.92751027e-01 1.20439464e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336063588466263
cond(S) = 913034.4452929607
E1 = -689.5962122741879  E_coul = 184.9711881033826
init E= -504.625024170805
    CPU time for initialize scf      1.55 sec, wall time      0.11 sec
  HOMO = -0.672180789546688  LUMO = 0.569008284026665
  mo_energy =
[-1.21709868e+02 -1.33863580e+01 -7.62361897e+00 -7.62361897e+00
 -7.62361897e+00 -1.65754896e+00 -6.72180790e-01 -6.72180790e-01
 -6.72180790e-01  5.69008284e-01  5.37024486e+00  2.35713281e+01
  8.71236790e+01  2.89485154e+02  9.21848464e+02  3.17755179e+03
  1.26606708e+04  4.12573290e+04  1.05284328e+05  2.30456462e+05
  4.56263231e+05  8.45209278e+05  1.52838053e+06  2.85064053e+06
  5.80851832e+06]
E1 = -707.7540628780494  E_coul = 199.78140584434172
cycle= 1 E= -507.972657033708  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.60 sec, wall time      0.03 sec
diis-norm(errvec)=0.760668
diis-c [-0.57861576  1.        ]
  HOMO = -0.217651737871652  LUMO = 0.923469205370284
  mo_energy =
[-1.20200273e+02 -1.23048525e+01 -6.59407566e+00 -6.59407566e+00
 -6.59407566e+00 -1.16331952e+00 -2.17651738e-01 -2.17651738e-01
 -2.17651738e-01  9.23469205e-01  6.02025541e+00  2.45444080e+01
  8.84082182e+01  2.90940127e+02  9.23339857e+02  3.17898400e+03
  1.26619967e+04  4.12585878e+04  1.05285550e+05  2.30457659e+05
  4.56264411e+05  8.45210445e+05  1.52838169e+06  2.85064167e+06
  5.80851945e+06]
E1 = -706.8002471702035  E_coul = 198.80979511092332
cycle= 2 E= -507.99045205928  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.033873
diis-c [-0.0011453  -0.00190023  1.00190023]
  HOMO = -0.239775549096538  LUMO = 0.919422052907476
  mo_energy =
[-1.20315044e+02 -1.23724987e+01 -6.66898238e+00 -6.66898238e+00
 -6.66898238e+00 -1.17755199e+00 -2.39775549e-01 -2.39775549e-01
 -2.39775549e-01  9.19422053e-01  5.98995991e+00  2.44854321e+01
  8.83231643e+01  2.90835195e+02  9.23219448e+02  3.17884927e+03
  1.26618518e+04  4.12584389e+04  1.05285400e+05  2.30457508e+05
  4.56264259e+05  8.45210293e+05  1.52838154e+06  2.85064152e+06
  5.80851930e+06]
E1 = -706.6922391258279  E_coul = 198.70152616430198
cycle= 3 E= -507.990712961526  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00367725
diis-c [-3.07417339e-06  1.09507990e-04 -1.05841973e-01  1.10573247e+00]
  HOMO = -0.242925226190075  LUMO = 0.918617149331835
  mo_energy =
[-1.20326833e+02 -1.23810713e+01 -6.67804247e+00 -6.67804247e+00
 -6.67804247e+00 -1.17946037e+00 -2.42925226e-01 -2.42925226e-01
 -2.42925226e-01  9.18617149e-01  5.98549981e+00  2.44778444e+01
  8.83133951e+01  2.90824055e+02  9.23207418e+02  3.17883653e+03
  1.26618386e+04  4.12584256e+04  1.05285386e+05  2.30457495e+05
  4.56264246e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6769776630595  E_coul = 198.6862596764384
cycle= 4 E= -507.990717986621  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170381
diis-c [-4.54645810e-10 -9.00543089e-06  6.93126128e-03 -9.95769254e-02
  1.09265467e+00]
  HOMO = -0.243077157080734  LUMO = 0.918569359682166
  mo_energy =
[-1.20327194e+02 -1.23814210e+01 -6.67838897e+00 -6.67838897e+00
 -6.67838897e+00 -1.17955219e+00 -2.43077157e-01 -2.43077157e-01
 -2.43077157e-01  9.18569360e-01  5.98528069e+00  2.44775287e+01
  8.83130463e+01  2.90823697e+02  9.23207056e+02  3.17883617e+03
  1.26618382e+04  4.12584252e+04  1.05285386e+05  2.30457494e+05
  4.56264245e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6762488020639  E_coul = 198.68553080140907
cycle= 5 E= -507.990718000655  delta_E= -1.4e-08  |g|= 4.92e-06  |ddm|= 0.000638
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.19227e-06
diis-c [-7.52922559e-13  5.38555355e-07 -4.98383906e-04  6.82079137e-03
 -8.01355454e-02  1.07381260e+00]
  HOMO = -0.243079497771068  LUMO = 0.918568696383879
  mo_energy =
[-1.20327200e+02 -1.23814257e+01 -6.67839369e+00 -6.67839369e+00
 -6.67839369e+00 -1.17955381e+00 -2.43079498e-01 -2.43079498e-01
 -2.43079498e-01  9.18568696e-01  5.98527731e+00  2.44775243e+01
  8.83130414e+01  2.90823692e+02  9.23207050e+02  3.17883616e+03
  1.26618382e+04  4.12584252e+04  1.05285386e+05  2.30457494e+05
  4.56264245e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6762370169745  E_coul = 198.68551901631466
cycle= 6 E= -507.99071800066  delta_E= -5e-12  |g|= 9.17e-08  |ddm|= 1.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6762370169745  E_coul = 198.68551901631466
  HOMO = -0.24307954059799  LUMO = 0.9185686715884
  mo_energy =
[-1.20327200e+02 -1.23814257e+01 -6.67839378e+00 -6.67839378e+00
 -6.67839378e+00 -1.17955383e+00 -2.43079541e-01 -2.43079541e-01
 -2.43079541e-01  9.18568672e-01  5.98527724e+00  2.44775242e+01
  8.83130413e+01  2.90823692e+02  9.23207050e+02  3.17883616e+03
  1.26618382e+04  4.12584252e+04  1.05285386e+05  2.30457494e+05
  4.56264245e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.676236824292  E_coul = 198.6855188236322
Extra cycle  E= -507.99071800066  delta_E= 5.68e-14  |g|= 1.08e-08  |ddm|= 2.15e-07
    CPU time for scf_cycle      2.35 sec, wall time      0.33 sec
exp = [2.33070178e-01 6.11286110e-01 2.02921425e+00 1.17616812e+05
 4.35954330e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191153e+03
 1.83757554e+04 1.44664133e+03 4.17657496e+02 1.48031523e+02
 6.04075096e+01 2.68115829e+01 9.40132925e+00 8.60427664e+00
 4.92751027e-01]
E = -507.9907180006598
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233070177969       1
[INPUT] 0    0    [1    /1   ]  0.611286110363       1
[INPUT] 0    0    [1    /1   ]  2.02921425308        1
[INPUT] 0    0    [1    /1   ]  117616.812402        1
[INPUT] 0    0    [1    /1   ]  4.35954330121        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991025        1
[INPUT] 0    0    [1    /1   ]  73510.4163013        1
[INPUT] 0    0    [1    /1   ]  36754.6950315        1
[INPUT] 0    0    [1    /1   ]  7301.91152615        1
[INPUT] 0    0    [1    /1   ]  18375.7553934        1
[INPUT] 0    0    [1    /1   ]  1446.64133489        1
[INPUT] 0    0    [1    /1   ]  417.657496089        1
[INPUT] 0    0    [1    /1   ]  148.031522617        1
[INPUT] 0    0    [1    /1   ]  60.4075096248        1
[INPUT] 0    0    [1    /1   ]  26.811582882         1
[INPUT] 0    0    [1    /1   ]  9.40132925032        1
[INPUT] 1    0    [1    /1   ]  8.60427664049        1
[INPUT] 1    0    [1    /1   ]  0.492751027335       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2330701779685828, 1.0]], [0, [0.6112861103631492, 1.0]], [0, [2.0292142530825075, 1.0]], [0, [117616.81240218368, 1.0]], [0, [4.359543301207017, 1.0]], [0, [1176168.1426101997, 1.0]], [0, [588084.0699425585, 1.0]], [0, [294042.0308458491, 1.0]], [0, [147020.99102466882, 1.0]], [0, [73510.41630126667, 1.0]], [0, [36754.695031494535, 1.0]], [0, [7301.9115261542665, 1.0]], [0, [18375.755393361585, 1.0]], [0, [1446.6413348930805, 1.0]], [0, [417.6574960888471, 1.0]], [0, [148.03152261732416, 1.0]], [0, [60.4075096248464, 1.0]], [0, [26.811582881999374, 1.0]], [0, [9.401329250316412, 1.0]], [1, [8.60427664048691, 1.0]], [1, [0.49275102733531084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23307018]
bas 1, expnt(s) = [0.61128611]
bas 2, expnt(s) = [2.02921425]
bas 3, expnt(s) = [117616.81240218]
bas 4, expnt(s) = [4.3595433]
bas 5, expnt(s) = [1176168.1426102]
bas 6, expnt(s) = [588084.06994256]
bas 7, expnt(s) = [294042.03084585]
bas 8, expnt(s) = [147020.99102467]
bas 9, expnt(s) = [73510.41630127]
bas 10, expnt(s) = [36754.69503149]
bas 11, expnt(s) = [7301.91152615]
bas 12, expnt(s) = [18375.75539336]
bas 13, expnt(s) = [1446.64133489]
bas 14, expnt(s) = [417.65749609]
bas 15, expnt(s) = [148.03152262]
bas 16, expnt(s) = [60.40750962]
bas 17, expnt(s) = [26.81158288]
bas 18, expnt(s) = [9.40132925]
bas 19, expnt(s) = [8.60427664]
bas 20, expnt(s) = [0.49275103]
CPU time:      1602.04
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33070178e-01 8.47481165e-01 6.11286110e-01 1.74661997e+00
 2.02921425e+00 4.29547259e+00 1.17616812e+05 1.60460107e+04
 4.35954330e+00 7.62247083e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655734e+03 7.30191153e+03 1.99568710e+03
 1.83757554e+04 3.98748374e+03 1.44664133e+03 5.92632790e+02
 4.17657496e+02 2.33415792e+02 1.48031523e+02 1.07221204e+02
 6.04075096e+01 5.47435835e+01 2.68115829e+01 2.97684941e+01
 9.40132925e+00 1.35645994e+01 8.60427664e+00 4.29909804e+01
 4.92751027e-01 1.20439464e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336063588466263
cond(S) = 913034.4452929607
E1 = -689.5962122741879  E_coul = 184.9711881033826
init E= -504.625024170805
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672180789546688  LUMO = 0.569008284026665
  mo_energy =
[-1.21709868e+02 -1.33863580e+01 -7.62361897e+00 -7.62361897e+00
 -7.62361897e+00 -1.65754896e+00 -6.72180790e-01 -6.72180790e-01
 -6.72180790e-01  5.69008284e-01  5.37024486e+00  2.35713281e+01
  8.71236790e+01  2.89485154e+02  9.21848464e+02  3.17755179e+03
  1.26606708e+04  4.12573290e+04  1.05284328e+05  2.30456462e+05
  4.56263231e+05  8.45209278e+05  1.52838053e+06  2.85064053e+06
  5.80851832e+06]
E1 = -707.7540628780494  E_coul = 199.78140584434172
cycle= 1 E= -507.972657033708  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.760668
diis-c [-0.57861576  1.        ]
  HOMO = -0.217651737871652  LUMO = 0.923469205370284
  mo_energy =
[-1.20200273e+02 -1.23048525e+01 -6.59407566e+00 -6.59407566e+00
 -6.59407566e+00 -1.16331952e+00 -2.17651738e-01 -2.17651738e-01
 -2.17651738e-01  9.23469205e-01  6.02025541e+00  2.45444080e+01
  8.84082182e+01  2.90940127e+02  9.23339857e+02  3.17898400e+03
  1.26619967e+04  4.12585878e+04  1.05285550e+05  2.30457659e+05
  4.56264411e+05  8.45210445e+05  1.52838169e+06  2.85064167e+06
  5.80851945e+06]
E1 = -706.8002471702035  E_coul = 198.80979511092332
cycle= 2 E= -507.99045205928  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.033873
diis-c [-0.0011453  -0.00190023  1.00190023]
  HOMO = -0.239775549096538  LUMO = 0.919422052907476
  mo_energy =
[-1.20315044e+02 -1.23724987e+01 -6.66898238e+00 -6.66898238e+00
 -6.66898238e+00 -1.17755199e+00 -2.39775549e-01 -2.39775549e-01
 -2.39775549e-01  9.19422053e-01  5.98995991e+00  2.44854321e+01
  8.83231643e+01  2.90835195e+02  9.23219448e+02  3.17884927e+03
  1.26618518e+04  4.12584389e+04  1.05285400e+05  2.30457508e+05
  4.56264259e+05  8.45210293e+05  1.52838154e+06  2.85064152e+06
  5.80851930e+06]
E1 = -706.6922391258279  E_coul = 198.70152616430198
cycle= 3 E= -507.990712961526  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00367725
diis-c [-3.07417339e-06  1.09507990e-04 -1.05841973e-01  1.10573247e+00]
  HOMO = -0.242925226190075  LUMO = 0.918617149331835
  mo_energy =
[-1.20326833e+02 -1.23810713e+01 -6.67804247e+00 -6.67804247e+00
 -6.67804247e+00 -1.17946037e+00 -2.42925226e-01 -2.42925226e-01
 -2.42925226e-01  9.18617149e-01  5.98549981e+00  2.44778444e+01
  8.83133951e+01  2.90824055e+02  9.23207418e+02  3.17883653e+03
  1.26618386e+04  4.12584256e+04  1.05285386e+05  2.30457495e+05
  4.56264246e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6769776630595  E_coul = 198.6862596764384
cycle= 4 E= -507.990717986621  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170381
diis-c [-4.54645810e-10 -9.00543089e-06  6.93126128e-03 -9.95769254e-02
  1.09265467e+00]
  HOMO = -0.243077157080734  LUMO = 0.918569359682166
  mo_energy =
[-1.20327194e+02 -1.23814210e+01 -6.67838897e+00 -6.67838897e+00
 -6.67838897e+00 -1.17955219e+00 -2.43077157e-01 -2.43077157e-01
 -2.43077157e-01  9.18569360e-01  5.98528069e+00  2.44775287e+01
  8.83130463e+01  2.90823697e+02  9.23207056e+02  3.17883617e+03
  1.26618382e+04  4.12584252e+04  1.05285386e+05  2.30457494e+05
  4.56264245e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6762488020639  E_coul = 198.68553080140907
cycle= 5 E= -507.990718000655  delta_E= -1.4e-08  |g|= 4.92e-06  |ddm|= 0.000638
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.19227e-06
diis-c [-7.52922559e-13  5.38555355e-07 -4.98383906e-04  6.82079137e-03
 -8.01355454e-02  1.07381260e+00]
  HOMO = -0.243079497771068  LUMO = 0.918568696383879
  mo_energy =
[-1.20327200e+02 -1.23814257e+01 -6.67839369e+00 -6.67839369e+00
 -6.67839369e+00 -1.17955381e+00 -2.43079498e-01 -2.43079498e-01
 -2.43079498e-01  9.18568696e-01  5.98527731e+00  2.44775243e+01
  8.83130414e+01  2.90823692e+02  9.23207050e+02  3.17883616e+03
  1.26618382e+04  4.12584252e+04  1.05285386e+05  2.30457494e+05
  4.56264245e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6762370169745  E_coul = 198.68551901631466
cycle= 6 E= -507.99071800066  delta_E= -5e-12  |g|= 9.17e-08  |ddm|= 1.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6762370169745  E_coul = 198.68551901631466
  HOMO = -0.24307954059799  LUMO = 0.9185686715884
  mo_energy =
[-1.20327200e+02 -1.23814257e+01 -6.67839378e+00 -6.67839378e+00
 -6.67839378e+00 -1.17955383e+00 -2.43079541e-01 -2.43079541e-01
 -2.43079541e-01  9.18568672e-01  5.98527724e+00  2.44775242e+01
  8.83130413e+01  2.90823692e+02  9.23207050e+02  3.17883616e+03
  1.26618382e+04  4.12584252e+04  1.05285386e+05  2.30457494e+05
  4.56264245e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.676236824292  E_coul = 198.6855188236322
Extra cycle  E= -507.99071800066  delta_E= 5.68e-14  |g|= 1.08e-08  |ddm|= 2.15e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913034.4452929607
E1 = -706.676236824292  E_coul = 198.6855188236322
init E= -507.99071800066
    CPU time for initialize scf      5.73 sec, wall time      0.24 sec
  HOMO = -0.24307954679469  LUMO = 0.91856866769121
  mo_energy =
[-1.20327200e+02 -1.23814258e+01 -6.67839379e+00 -6.67839379e+00
 -6.67839379e+00 -1.17955383e+00 -2.43079547e-01 -2.43079547e-01
 -2.43079547e-01  9.18568668e-01  5.98527723e+00  2.44775242e+01
  8.83130413e+01  2.90823692e+02  9.23207050e+02  3.17883616e+03
  1.26618382e+04  4.12584252e+04  1.05285386e+05  2.30457494e+05
  4.56264245e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6762367976044  E_coul = 198.68551879694434
cycle= 1 E= -507.99071800066  delta_E= -2.27e-13  |g|= 2.79e-09  |ddm|= 2.61e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6762367976044  E_coul = 198.68551879694434
  HOMO = -0.243079547623595  LUMO = 0.91856866818998
  mo_energy =
[-1.20327200e+02 -1.23814258e+01 -6.67839380e+00 -6.67839380e+00
 -6.67839380e+00 -1.17955383e+00 -2.43079548e-01 -2.43079548e-01
 -2.43079548e-01  9.18568668e-01  5.98527723e+00  2.44775242e+01
  8.83130413e+01  2.90823692e+02  9.23207050e+02  3.17883616e+03
  1.26618382e+04  4.12584252e+04  1.05285386e+05  2.30457494e+05
  4.56264245e+05  8.45210279e+05  1.52838152e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6762367935023  E_coul = 198.68551879284266
Extra cycle  E= -507.99071800066  delta_E= 3.98e-13  |g|= 1.15e-09  |ddm|= 3.27e-09
    CPU time for scf_cycle      6.24 sec, wall time      0.41 sec
exp = [2.33070178e-01 6.11286110e-01 2.02921425e+00 1.17616812e+05
 4.35954330e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191153e+03
 1.83757554e+04 1.44664133e+03 4.17657496e+02 1.48031523e+02
 6.04075096e+01 2.68115829e+01 9.40132925e+00 8.60427664e+00
 4.92751027e-01]
grad_E = [-9.57804632e-06  1.50312555e-05  1.02897500e-05  6.01555842e-09
 -7.47899216e-06  3.99149895e-11  1.72621181e-10  9.33136122e-10
  3.68620373e-09  1.53914537e-08  8.03379014e-08  5.07520347e-06
  1.96404092e-07 -3.96954805e-05  1.39166832e-05 -6.60501322e-05
  8.98318510e-06  5.64947878e-05 -3.60943559e-06  5.23749971e-06
  2.16458889e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:33 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233023978746       1
[INPUT] 0    0    [1    /1   ]  0.611233753838       1
[INPUT] 0    0    [1    /1   ]  2.02821633514        1
[INPUT] 0    0    [1    /1   ]  117616.812402        1
[INPUT] 0    0    [1    /1   ]  4.36052589624        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991025        1
[INPUT] 0    0    [1    /1   ]  73510.4163016        1
[INPUT] 0    0    [1    /1   ]  36754.6950331        1
[INPUT] 0    0    [1    /1   ]  7301.91163049        1
[INPUT] 0    0    [1    /1   ]  18375.7553974        1
[INPUT] 0    0    [1    /1   ]  1446.64055416        1
[INPUT] 0    0    [1    /1   ]  417.657286896        1
[INPUT] 0    0    [1    /1   ]  148.032069529        1
[INPUT] 0    0    [1    /1   ]  60.405347151         1
[INPUT] 0    0    [1    /1   ]  26.8122106924        1
[INPUT] 0    0    [1    /1   ]  9.40575824316        1
[INPUT] 1    0    [1    /1   ]  8.60427244758        1
[INPUT] 1    0    [1    /1   ]  0.492750906775       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23302397874621314, 1.0]], [0, [0.6112337538380411, 1.0]], [0, [2.02821633513896, 1.0]], [0, [117616.81240230768, 1.0]], [0, [4.360525896237672, 1.0]], [0, [1176168.1426102007, 1.0]], [0, [588084.0699425621, 1.0]], [0, [294042.0308458683, 1.0]], [0, [147020.9910247448, 1.0]], [0, [73510.41630158399, 1.0]], [0, [36754.69503314988, 1.0]], [0, [7301.911630491677, 1.0]], [0, [18375.755397417473, 1.0]], [0, [1446.640554157218, 1.0]], [0, [417.6572868959452, 1.0]], [0, [148.03206952875865, 1.0]], [0, [60.40534715101046, 1.0]], [0, [26.81221069236865, 1.0]], [0, [9.405758243160959, 1.0]], [1, [8.60427244757585, 1.0]], [1, [0.49275090677541544, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23302398]
bas 1, expnt(s) = [0.61123375]
bas 2, expnt(s) = [2.02821634]
bas 3, expnt(s) = [117616.81240231]
bas 4, expnt(s) = [4.3605259]
bas 5, expnt(s) = [1176168.1426102]
bas 6, expnt(s) = [588084.06994256]
bas 7, expnt(s) = [294042.03084587]
bas 8, expnt(s) = [147020.99102474]
bas 9, expnt(s) = [73510.41630158]
bas 10, expnt(s) = [36754.69503315]
bas 11, expnt(s) = [7301.91163049]
bas 12, expnt(s) = [18375.75539742]
bas 13, expnt(s) = [1446.64055416]
bas 14, expnt(s) = [417.6572869]
bas 15, expnt(s) = [148.03206953]
bas 16, expnt(s) = [60.40534715]
bas 17, expnt(s) = [26.81221069]
bas 18, expnt(s) = [9.40575824]
bas 19, expnt(s) = [8.60427245]
bas 20, expnt(s) = [0.49275091]
CPU time:      1617.10
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33023979e-01 8.47355171e-01 6.11233754e-01 1.74650777e+00
 2.02821634e+00 4.29388819e+00 1.17616812e+05 1.60460107e+04
 4.36052590e+00 7.62375931e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655734e+03 7.30191163e+03 1.99568712e+03
 1.83757554e+04 3.98748374e+03 1.44664055e+03 5.92632550e+02
 4.17657287e+02 2.33415704e+02 1.48032070e+02 1.07221501e+02
 6.04053472e+01 5.47421137e+01 2.68122107e+01 2.97690168e+01
 9.40575824e+00 1.35693918e+01 8.60427245e+00 4.29909542e+01
 4.92750907e-01 1.20439428e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336064103531783
cond(S) = 913034.6399264791
E1 = -689.5962004803173  E_coul = 184.97116715557573
init E= -504.625033324742
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.67218089771776  LUMO = 0.568812441493472
  mo_energy =
[-1.21709873e+02 -1.33863598e+01 -7.62362035e+00 -7.62362035e+00
 -7.62362035e+00 -1.65754869e+00 -6.72180898e-01 -6.72180898e-01
 -6.72180898e-01  5.68812441e-01  5.36891404e+00  2.35740173e+01
  8.71371421e+01  2.89500731e+02  9.21861604e+02  3.17756228e+03
  1.26606783e+04  4.12573354e+04  1.05284334e+05  2.30456468e+05
  4.56263237e+05  8.45209284e+05  1.52838054e+06  2.85064053e+06
  5.80851832e+06]
E1 = -707.7540265628281  E_coul = 199.78136983455155
cycle= 1 E= -507.972656728277  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.760684
diis-c [-0.57864043  1.        ]
  HOMO = -0.217652368942383  LUMO = 0.923234525923546
  mo_energy =
[-1.20200279e+02 -1.23048554e+01 -6.59407822e+00 -6.59407822e+00
 -6.59407822e+00 -1.16331984e+00 -2.17652369e-01 -2.17652369e-01
 -2.17652369e-01  9.23234526e-01  6.01889911e+00  2.45471825e+01
  8.84217082e+01  2.90955702e+02  9.23352994e+02  3.17899448e+03
  1.26620042e+04  4.12585941e+04  1.05285556e+05  2.30457665e+05
  4.56264417e+05  8.45210451e+05  1.52838169e+06  2.85064168e+06
  5.80851946e+06]
E1 = -706.8001955318823  E_coul = 198.8097434754092
cycle= 2 E= -507.990452056473  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0338799
diis-c [-0.00114576 -0.00190307  1.00190307]
  HOMO = -0.239776751751501  LUMO = 0.919188786203781
  mo_energy =
[-1.20315051e+02 -1.23725029e+01 -6.66898630e+00 -6.66898630e+00
 -6.66898630e+00 -1.17755270e+00 -2.39776752e-01 -2.39776752e-01
 -2.39776752e-01  9.19188786e-01  5.98860611e+00  2.44882000e+01
  8.83366503e+01  2.90850769e+02  9.23232584e+02  3.17885976e+03
  1.26618593e+04  4.12584453e+04  1.05285406e+05  2.30457514e+05
  4.56264265e+05  8.45210299e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6921824822753  E_coul = 198.70146950309112
cycle= 3 E= -507.990712979184  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00367833
diis-c [-3.07529639e-06  1.09277605e-04 -1.05856119e-01  1.10574684e+00]
  HOMO = -0.242926622035975  LUMO = 0.918384054980426
  mo_energy =
[-1.20326841e+02 -1.23810758e+01 -6.67804671e+00 -6.67804671e+00
 -6.67804671e+00 -1.17946121e+00 -2.42926622e-01 -2.42926622e-01
 -2.42926622e-01  9.18384055e-01  5.98414617e+00  2.44806115e+01
  8.83268806e+01  2.90839628e+02  9.23220554e+02  3.17884702e+03
  1.26618461e+04  4.12584319e+04  1.05285392e+05  2.30457501e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.676919718668  E_coul = 198.68620171356687
cycle= 4 E= -507.990718005101  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170401
diis-c [-4.55207012e-10 -9.00629257e-06  6.93161371e-03 -9.95675993e-02
  1.09264499e+00]
  HOMO = -0.243078534307551  LUMO = 0.918336281769066
  mo_energy =
[-1.20327201e+02 -1.23814255e+01 -6.67839312e+00 -6.67839312e+00
 -6.67839312e+00 -1.17955302e+00 -2.43078534e-01 -2.43078534e-01
 -2.43078534e-01  9.18336282e-01  5.98392708e+00  2.44802958e+01
  8.83265319e+01  2.90839270e+02  9.23220192e+02  3.17884665e+03
  1.26618457e+04  4.12584316e+04  1.05285392e+05  2.30457500e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6761909138794  E_coul = 198.68547289474483
cycle= 5 E= -507.990718019135  delta_E= -1.4e-08  |g|= 4.92e-06  |ddm|= 0.000638
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.19402e-06
diis-c [-7.50844445e-13  5.46041587e-07 -4.99002151e-04  6.82787866e-03
 -8.02190368e-02  1.07388961e+00]
  HOMO = -0.243080876881765  LUMO = 0.918335613970731
  mo_energy =
[-1.20327207e+02 -1.23814301e+01 -6.67839785e+00 -6.67839785e+00
 -6.67839785e+00 -1.17955464e+00 -2.43080877e-01 -2.43080877e-01
 -2.43080877e-01  9.18335614e-01  5.98392370e+00  2.44802914e+01
  8.83265270e+01  2.90839265e+02  9.23220186e+02  3.17884664e+03
  1.26618457e+04  4.12584315e+04  1.05285392e+05  2.30457500e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6761791274549  E_coul = 198.68546110831429
cycle= 6 E= -507.990718019141  delta_E= -6.14e-12  |g|= 9.16e-08  |ddm|= 1.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6761791274549  E_coul = 198.68546110831429
  HOMO = -0.243080919521799  LUMO = 0.918335590695066
  mo_energy =
[-1.20327207e+02 -1.23814302e+01 -6.67839793e+00 -6.67839793e+00
 -6.67839793e+00 -1.17955466e+00 -2.43080920e-01 -2.43080920e-01
 -2.43080920e-01  9.18335591e-01  5.98392363e+00  2.44802914e+01
  8.83265269e+01  2.90839265e+02  9.23220186e+02  3.17884664e+03
  1.26618457e+04  4.12584315e+04  1.05285392e+05  2.30457500e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6761789371973  E_coul = 198.68546091805712
Extra cycle  E= -507.99071801914  delta_E= 5.12e-13  |g|= 1.12e-08  |ddm|= 2.14e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.33023979e-01 6.11233754e-01 2.02821634e+00 1.17616812e+05
 4.36052590e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191163e+03
 1.83757554e+04 1.44664055e+03 4.17657287e+02 1.48032070e+02
 6.04053472e+01 2.68122107e+01 9.40575824e+00 8.60427245e+00
 4.92750907e-01]
E = -507.99071801914016
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233023978746       1
[INPUT] 0    0    [1    /1   ]  0.611233753838       1
[INPUT] 0    0    [1    /1   ]  2.02821633514        1
[INPUT] 0    0    [1    /1   ]  117616.812402        1
[INPUT] 0    0    [1    /1   ]  4.36052589624        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991025        1
[INPUT] 0    0    [1    /1   ]  73510.4163016        1
[INPUT] 0    0    [1    /1   ]  36754.6950331        1
[INPUT] 0    0    [1    /1   ]  7301.91163049        1
[INPUT] 0    0    [1    /1   ]  18375.7553974        1
[INPUT] 0    0    [1    /1   ]  1446.64055416        1
[INPUT] 0    0    [1    /1   ]  417.657286896        1
[INPUT] 0    0    [1    /1   ]  148.032069529        1
[INPUT] 0    0    [1    /1   ]  60.405347151         1
[INPUT] 0    0    [1    /1   ]  26.8122106924        1
[INPUT] 0    0    [1    /1   ]  9.40575824316        1
[INPUT] 1    0    [1    /1   ]  8.60427244758        1
[INPUT] 1    0    [1    /1   ]  0.492750906775       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23302397874621314, 1.0]], [0, [0.6112337538380411, 1.0]], [0, [2.02821633513896, 1.0]], [0, [117616.81240230768, 1.0]], [0, [4.360525896237672, 1.0]], [0, [1176168.1426102007, 1.0]], [0, [588084.0699425621, 1.0]], [0, [294042.0308458683, 1.0]], [0, [147020.9910247448, 1.0]], [0, [73510.41630158399, 1.0]], [0, [36754.69503314988, 1.0]], [0, [7301.911630491677, 1.0]], [0, [18375.755397417473, 1.0]], [0, [1446.640554157218, 1.0]], [0, [417.6572868959452, 1.0]], [0, [148.03206952875865, 1.0]], [0, [60.40534715101046, 1.0]], [0, [26.81221069236865, 1.0]], [0, [9.405758243160959, 1.0]], [1, [8.60427244757585, 1.0]], [1, [0.49275090677541544, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23302398]
bas 1, expnt(s) = [0.61123375]
bas 2, expnt(s) = [2.02821634]
bas 3, expnt(s) = [117616.81240231]
bas 4, expnt(s) = [4.3605259]
bas 5, expnt(s) = [1176168.1426102]
bas 6, expnt(s) = [588084.06994256]
bas 7, expnt(s) = [294042.03084587]
bas 8, expnt(s) = [147020.99102474]
bas 9, expnt(s) = [73510.41630158]
bas 10, expnt(s) = [36754.69503315]
bas 11, expnt(s) = [7301.91163049]
bas 12, expnt(s) = [18375.75539742]
bas 13, expnt(s) = [1446.64055416]
bas 14, expnt(s) = [417.6572869]
bas 15, expnt(s) = [148.03206953]
bas 16, expnt(s) = [60.40534715]
bas 17, expnt(s) = [26.81221069]
bas 18, expnt(s) = [9.40575824]
bas 19, expnt(s) = [8.60427245]
bas 20, expnt(s) = [0.49275091]
CPU time:      1619.11
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33023979e-01 8.47355171e-01 6.11233754e-01 1.74650777e+00
 2.02821634e+00 4.29388819e+00 1.17616812e+05 1.60460107e+04
 4.36052590e+00 7.62375931e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655734e+03 7.30191163e+03 1.99568712e+03
 1.83757554e+04 3.98748374e+03 1.44664055e+03 5.92632550e+02
 4.17657287e+02 2.33415704e+02 1.48032070e+02 1.07221501e+02
 6.04053472e+01 5.47421137e+01 2.68122107e+01 2.97690168e+01
 9.40575824e+00 1.35693918e+01 8.60427245e+00 4.29909542e+01
 4.92750907e-01 1.20439428e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336064103531783
cond(S) = 913034.6399264791
E1 = -689.5962004803173  E_coul = 184.97116715557573
init E= -504.625033324742
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.67218089771776  LUMO = 0.568812441493472
  mo_energy =
[-1.21709873e+02 -1.33863598e+01 -7.62362035e+00 -7.62362035e+00
 -7.62362035e+00 -1.65754869e+00 -6.72180898e-01 -6.72180898e-01
 -6.72180898e-01  5.68812441e-01  5.36891404e+00  2.35740173e+01
  8.71371421e+01  2.89500731e+02  9.21861604e+02  3.17756228e+03
  1.26606783e+04  4.12573354e+04  1.05284334e+05  2.30456468e+05
  4.56263237e+05  8.45209284e+05  1.52838054e+06  2.85064053e+06
  5.80851832e+06]
E1 = -707.7540265628281  E_coul = 199.78136983455155
cycle= 1 E= -507.972656728277  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.760684
diis-c [-0.57864043  1.        ]
  HOMO = -0.217652368942383  LUMO = 0.923234525923546
  mo_energy =
[-1.20200279e+02 -1.23048554e+01 -6.59407822e+00 -6.59407822e+00
 -6.59407822e+00 -1.16331984e+00 -2.17652369e-01 -2.17652369e-01
 -2.17652369e-01  9.23234526e-01  6.01889911e+00  2.45471825e+01
  8.84217082e+01  2.90955702e+02  9.23352994e+02  3.17899448e+03
  1.26620042e+04  4.12585941e+04  1.05285556e+05  2.30457665e+05
  4.56264417e+05  8.45210451e+05  1.52838169e+06  2.85064168e+06
  5.80851946e+06]
E1 = -706.8001955318823  E_coul = 198.8097434754092
cycle= 2 E= -507.990452056473  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0338799
diis-c [-0.00114576 -0.00190307  1.00190307]
  HOMO = -0.239776751751501  LUMO = 0.919188786203781
  mo_energy =
[-1.20315051e+02 -1.23725029e+01 -6.66898630e+00 -6.66898630e+00
 -6.66898630e+00 -1.17755270e+00 -2.39776752e-01 -2.39776752e-01
 -2.39776752e-01  9.19188786e-01  5.98860611e+00  2.44882000e+01
  8.83366503e+01  2.90850769e+02  9.23232584e+02  3.17885976e+03
  1.26618593e+04  4.12584453e+04  1.05285406e+05  2.30457514e+05
  4.56264265e+05  8.45210299e+05  1.52838154e+06  2.85064153e+06
  5.80851931e+06]
E1 = -706.6921824822753  E_coul = 198.70146950309112
cycle= 3 E= -507.990712979184  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00367833
diis-c [-3.07529639e-06  1.09277605e-04 -1.05856119e-01  1.10574684e+00]
  HOMO = -0.242926622035975  LUMO = 0.918384054980426
  mo_energy =
[-1.20326841e+02 -1.23810758e+01 -6.67804671e+00 -6.67804671e+00
 -6.67804671e+00 -1.17946121e+00 -2.42926622e-01 -2.42926622e-01
 -2.42926622e-01  9.18384055e-01  5.98414617e+00  2.44806115e+01
  8.83268806e+01  2.90839628e+02  9.23220554e+02  3.17884702e+03
  1.26618461e+04  4.12584319e+04  1.05285392e+05  2.30457501e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.676919718668  E_coul = 198.68620171356687
cycle= 4 E= -507.990718005101  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170401
diis-c [-4.55207012e-10 -9.00629257e-06  6.93161371e-03 -9.95675993e-02
  1.09264499e+00]
  HOMO = -0.243078534307551  LUMO = 0.918336281769066
  mo_energy =
[-1.20327201e+02 -1.23814255e+01 -6.67839312e+00 -6.67839312e+00
 -6.67839312e+00 -1.17955302e+00 -2.43078534e-01 -2.43078534e-01
 -2.43078534e-01  9.18336282e-01  5.98392708e+00  2.44802958e+01
  8.83265319e+01  2.90839270e+02  9.23220192e+02  3.17884665e+03
  1.26618457e+04  4.12584316e+04  1.05285392e+05  2.30457500e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6761909138794  E_coul = 198.68547289474483
cycle= 5 E= -507.990718019135  delta_E= -1.4e-08  |g|= 4.92e-06  |ddm|= 0.000638
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.19402e-06
diis-c [-7.50844445e-13  5.46041587e-07 -4.99002151e-04  6.82787866e-03
 -8.02190368e-02  1.07388961e+00]
  HOMO = -0.243080876881765  LUMO = 0.918335613970731
  mo_energy =
[-1.20327207e+02 -1.23814301e+01 -6.67839785e+00 -6.67839785e+00
 -6.67839785e+00 -1.17955464e+00 -2.43080877e-01 -2.43080877e-01
 -2.43080877e-01  9.18335614e-01  5.98392370e+00  2.44802914e+01
  8.83265270e+01  2.90839265e+02  9.23220186e+02  3.17884664e+03
  1.26618457e+04  4.12584315e+04  1.05285392e+05  2.30457500e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6761791274549  E_coul = 198.68546110831429
cycle= 6 E= -507.990718019141  delta_E= -6.14e-12  |g|= 9.16e-08  |ddm|= 1.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6761791274549  E_coul = 198.68546110831429
  HOMO = -0.243080919521799  LUMO = 0.918335590695066
  mo_energy =
[-1.20327207e+02 -1.23814302e+01 -6.67839793e+00 -6.67839793e+00
 -6.67839793e+00 -1.17955466e+00 -2.43080920e-01 -2.43080920e-01
 -2.43080920e-01  9.18335591e-01  5.98392363e+00  2.44802914e+01
  8.83265269e+01  2.90839265e+02  9.23220186e+02  3.17884664e+03
  1.26618457e+04  4.12584315e+04  1.05285392e+05  2.30457500e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6761789371973  E_coul = 198.68546091805712
Extra cycle  E= -507.99071801914  delta_E= 5.12e-13  |g|= 1.12e-08  |ddm|= 2.14e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913034.6399264791
E1 = -706.6761789371973  E_coul = 198.68546091805712
init E= -507.99071801914
    CPU time for initialize scf      5.95 sec, wall time      0.25 sec
  HOMO = -0.243080925669749  LUMO = 0.918335585962885
  mo_energy =
[-1.20327207e+02 -1.23814302e+01 -6.67839795e+00 -6.67839795e+00
 -6.67839795e+00 -1.17955466e+00 -2.43080926e-01 -2.43080926e-01
 -2.43080926e-01  9.18335586e-01  5.98392362e+00  2.44802913e+01
  8.83265269e+01  2.90839265e+02  9.23220186e+02  3.17884664e+03
  1.26618457e+04  4.12584315e+04  1.05285392e+05  2.30457500e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6761789112117  E_coul = 198.6854608920716
cycle= 1 E= -507.99071801914  delta_E= 1.14e-13  |g|= 2.75e-09  |ddm|= 2.54e-08
    CPU time for cycle= 1      0.32 sec, wall time      0.03 sec
E1 = -706.6761789112117  E_coul = 198.6854608920716
  HOMO = -0.243080926472672  LUMO = 0.918335586847329
  mo_energy =
[-1.20327207e+02 -1.23814302e+01 -6.67839795e+00 -6.67839795e+00
 -6.67839795e+00 -1.17955466e+00 -2.43080926e-01 -2.43080926e-01
 -2.43080926e-01  9.18335587e-01  5.98392362e+00  2.44802913e+01
  8.83265269e+01  2.90839265e+02  9.23220186e+02  3.17884664e+03
  1.26618457e+04  4.12584315e+04  1.05285392e+05  2.30457500e+05
  4.56264251e+05  8.45210285e+05  1.52838153e+06  2.85064151e+06
  5.80851929e+06]
E1 = -706.6761789022873  E_coul = 198.68546088314739
Extra cycle  E= -507.99071801914  delta_E= 5.68e-14  |g|= 2.59e-09  |ddm|= 6.91e-09
    CPU time for scf_cycle      6.41 sec, wall time      0.42 sec
exp = [2.33023979e-01 6.11233754e-01 2.02821634e+00 1.17616812e+05
 4.36052590e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191163e+03
 1.83757554e+04 1.44664055e+03 4.17657287e+02 1.48032070e+02
 6.04053472e+01 2.68122107e+01 9.40575824e+00 8.60427245e+00
 4.92750907e-01]
grad_E = [-3.96822271e-05  1.46994281e-05  4.72135083e-06  6.01513802e-09
 -4.32469589e-06  3.99102629e-11  1.72607398e-10  9.33071632e-10
  3.68594337e-09  1.53903523e-08  8.03325785e-08  5.07485643e-06
  1.96386752e-07 -3.96799069e-05  1.37789975e-05 -6.55229112e-05
  7.96333354e-06  5.73246403e-05 -3.42378972e-06  1.84855822e-06
  1.30455582e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233018814979       1
[INPUT] 0    0    [1    /1   ]  0.611211142318       1
[INPUT] 0    0    [1    /1   ]  2.0263917544         1
[INPUT] 0    0    [1    /1   ]  117616.812403        1
[INPUT] 0    0    [1    /1   ]  4.35984551678        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991025        1
[INPUT] 0    0    [1    /1   ]  73510.4163044        1
[INPUT] 0    0    [1    /1   ]  36754.6950478        1
[INPUT] 0    0    [1    /1   ]  7301.91255628        1
[INPUT] 0    0    [1    /1   ]  18375.7554334        1
[INPUT] 0    0    [1    /1   ]  1446.6335379         1
[INPUT] 0    0    [1    /1   ]  417.656464189        1
[INPUT] 0    0    [1    /1   ]  148.032206454        1
[INPUT] 0    0    [1    /1   ]  60.3991631689        1
[INPUT] 0    0    [1    /1   ]  26.8081679028        1
[INPUT] 0    0    [1    /1   ]  9.40730503123        1
[INPUT] 1    0    [1    /1   ]  8.60426825803        1
[INPUT] 1    0    [1    /1   ]  0.492750454923       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2330188149789669, 1.0]], [0, [0.6112111423180774, 1.0]], [0, [2.0263917544002066, 1.0]], [0, [117616.81240340795, 1.0]], [0, [4.359845516776578, 1.0]], [0, [1176168.1426102081, 1.0]], [0, [588084.0699425938, 1.0]], [0, [294042.03084603895, 1.0]], [0, [147020.9910254191, 1.0]], [0, [73510.41630439973, 1.0]], [0, [36754.69504783618, 1.0]], [0, [7301.9125562815525, 1.0]], [0, [18375.75543342743, 1.0]], [0, [1446.6335379031032, 1.0]], [0, [417.6564641887433, 1.0]], [0, [148.03220645357976, 1.0]], [0, [60.39916316885768, 1.0]], [0, [26.808167902769156, 1.0]], [0, [9.407305031234138, 1.0]], [1, [8.604268258028124, 1.0]], [1, [0.492750454922686, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23301881]
bas 1, expnt(s) = [0.61121114]
bas 2, expnt(s) = [2.02639175]
bas 3, expnt(s) = [117616.81240341]
bas 4, expnt(s) = [4.35984552]
bas 5, expnt(s) = [1176168.14261021]
bas 6, expnt(s) = [588084.06994259]
bas 7, expnt(s) = [294042.03084604]
bas 8, expnt(s) = [147020.99102542]
bas 9, expnt(s) = [73510.4163044]
bas 10, expnt(s) = [36754.69504784]
bas 11, expnt(s) = [7301.91255628]
bas 12, expnt(s) = [18375.75543343]
bas 13, expnt(s) = [1446.6335379]
bas 14, expnt(s) = [417.65646419]
bas 15, expnt(s) = [148.03220645]
bas 16, expnt(s) = [60.39916317]
bas 17, expnt(s) = [26.8081679]
bas 18, expnt(s) = [9.40730503]
bas 19, expnt(s) = [8.60426826]
bas 20, expnt(s) = [0.49275045]
CPU time:      1634.24
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33018815e-01 8.47341088e-01 6.11211142e-01 1.74645931e+00
 2.02639175e+00 4.29099078e+00 1.17616812e+05 1.60460107e+04
 4.35984552e+00 7.62286713e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655734e+03 7.30191256e+03 1.99568731e+03
 1.83757554e+04 3.98748375e+03 1.44663354e+03 5.92630394e+02
 4.17656464e+02 2.33415359e+02 1.48032206e+02 1.07221575e+02
 6.03991632e+01 5.47379105e+01 2.68081679e+01 2.97656503e+01
 9.40730503e+00 1.35710654e+01 8.60426826e+00 4.29909280e+01
 4.92750455e-01 1.20439290e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336064652241447
cond(S) = 913033.6697154902
E1 = -689.5961709762012  E_coul = 184.9711344196326
init E= -504.625036556569
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672181509249299  LUMO = 0.568714843561304
  mo_energy =
[-1.21709878e+02 -1.33863623e+01 -7.62362242e+00 -7.62362242e+00
 -7.62362242e+00 -1.65754928e+00 -6.72181509e-01 -6.72181509e-01
 -6.72181509e-01  5.68714844e-01  5.36589419e+00  2.35665478e+01
  8.71237976e+01  2.89471753e+02  9.21820853e+02  3.17751302e+03
  1.26606193e+04  4.12572756e+04  1.05284276e+05  2.30456412e+05
  4.56263181e+05  8.45209229e+05  1.52838048e+06  2.85064048e+06
  5.80851827e+06]
E1 = -707.753987017646  E_coul = 199.7813301999092
cycle= 1 E= -507.972656817737  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.760685
diis-c [-0.57864229  1.        ]
  HOMO = -0.217653316974876  LUMO = 0.92310154498578
  mo_energy =
[-1.20200284e+02 -1.23048586e+01 -6.59408078e+00 -6.59408078e+00
 -6.59408078e+00 -1.16332056e+00 -2.17653317e-01 -2.17653317e-01
 -2.17653317e-01  9.23101545e-01  6.01573920e+00  2.45396810e+01
  8.84083494e+01  2.90926719e+02  9.23312244e+02  3.17894523e+03
  1.26619452e+04  4.12585344e+04  1.05285498e+05  2.30457609e+05
  4.56264361e+05  8.45210396e+05  1.52838164e+06  2.85064163e+06
  5.80851941e+06]
E1 = -706.8001588332801  E_coul = 198.8097067485339
cycle= 2 E= -507.990452084746  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0338872
diis-c [-0.00114625 -0.00190728  1.00190728]
  HOMO = -0.239777486603769  LUMO = 0.919057686425243
  mo_energy =
[-1.20315057e+02 -1.23725062e+01 -6.66898908e+00 -6.66898908e+00
 -6.66898908e+00 -1.17755326e+00 -2.39777487e-01 -2.39777487e-01
 -2.39777487e-01  9.19057686e-01  5.98545848e+00  2.44807026e+01
  8.83232928e+01  2.90821786e+02  9.23191833e+02  3.17881050e+03
  1.26618003e+04  4.12583855e+04  1.05285348e+05  2.30457458e+05
  4.56264210e+05  8.45210244e+05  1.52838149e+06  2.85064148e+06
  5.80851926e+06]
E1 = -706.6921469200464  E_coul = 198.7014339177386
cycle= 3 E= -507.990713002308  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00367942
diis-c [-3.07635949e-06  1.09097882e-04 -1.05869785e-01  1.10576069e+00]
  HOMO = -0.242927268205886  LUMO = 0.918253254502041
  mo_energy =
[-1.20326846e+02 -1.23810788e+01 -6.67804921e+00 -6.67804921e+00
 -6.67804921e+00 -1.17946171e+00 -2.42927268e-01 -2.42927268e-01
 -2.42927268e-01  9.18253255e-01  5.98100022e+00  2.44731147e+01
  8.83135236e+01  2.90810646e+02  9.23179803e+02  3.17879776e+03
  1.26617871e+04  4.12583721e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210231e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.676884486841  E_coul = 198.68616645872956
cycle= 4 E= -507.990718028111  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170406
diis-c [-4.55640795e-10 -9.01818111e-06  6.93179166e-03 -9.95518196e-02
  1.09262905e+00]
  HOMO = -0.243079129732006  LUMO = 0.918205505628557
  mo_energy =
[-1.20327207e+02 -1.23814284e+01 -6.67839545e+00 -6.67839545e+00
 -6.67839545e+00 -1.17955349e+00 -2.43079130e-01 -2.43079130e-01
 -2.43079130e-01  9.18205506e-01  5.98078127e+00  2.44727992e+01
  8.83131750e+01  2.90810289e+02  9.23179441e+02  3.17879740e+03
  1.26617867e+04  4.12583718e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210230e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.6761559227803  E_coul = 198.6854378806387
cycle= 5 E= -507.990718042142  delta_E= -1.4e-08  |g|= 4.92e-06  |ddm|= 0.000639
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.19623e-06
diis-c [-7.53458655e-13  5.42610690e-07 -4.99258782e-04  6.83024328e-03
 -8.02592645e-02  1.07392774e+00]
  HOMO = -0.243081474153671  LUMO = 0.918204839579125
  mo_energy =
[-1.20327212e+02 -1.23814330e+01 -6.67840018e+00 -6.67840018e+00
 -6.67840018e+00 -1.17955511e+00 -2.43081474e-01 -2.43081474e-01
 -2.43081474e-01  9.18204840e-01  5.98077788e+00  2.44727948e+01
  8.83131701e+01  2.90810283e+02  9.23179436e+02  3.17879739e+03
  1.26617867e+04  4.12583718e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210230e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.6761441193356  E_coul = 198.68542607718928
cycle= 6 E= -507.990718042146  delta_E= -4.77e-12  |g|= 9.14e-08  |ddm|= 1.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6761441193356  E_coul = 198.68542607718928
  HOMO = -0.243081516987527  LUMO = 0.918204813038539
  mo_energy =
[-1.20327212e+02 -1.23814331e+01 -6.67840027e+00 -6.67840027e+00
 -6.67840027e+00 -1.17955512e+00 -2.43081517e-01 -2.43081517e-01
 -2.43081517e-01  9.18204813e-01  5.98077781e+00  2.44727947e+01
  8.83131700e+01  2.90810283e+02  9.23179436e+02  3.17879739e+03
  1.26617867e+04  4.12583718e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210230e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.6761439339574  E_coul = 198.68542589181115
Extra cycle  E= -507.990718042146  delta_E= 1.14e-13  |g|= 1.19e-08  |ddm|= 2.11e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.30 sec
exp = [2.33018815e-01 6.11211142e-01 2.02639175e+00 1.17616812e+05
 4.35984552e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191256e+03
 1.83757554e+04 1.44663354e+03 4.17656464e+02 1.48032206e+02
 6.03991632e+01 2.68081679e+01 9.40730503e+00 8.60426826e+00
 4.92750455e-01]
E = -507.9907180421462
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.233018814979       1
[INPUT] 0    0    [1    /1   ]  0.611211142318       1
[INPUT] 0    0    [1    /1   ]  2.0263917544         1
[INPUT] 0    0    [1    /1   ]  117616.812403        1
[INPUT] 0    0    [1    /1   ]  4.35984551678        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991025        1
[INPUT] 0    0    [1    /1   ]  73510.4163044        1
[INPUT] 0    0    [1    /1   ]  36754.6950478        1
[INPUT] 0    0    [1    /1   ]  7301.91255628        1
[INPUT] 0    0    [1    /1   ]  18375.7554334        1
[INPUT] 0    0    [1    /1   ]  1446.6335379         1
[INPUT] 0    0    [1    /1   ]  417.656464189        1
[INPUT] 0    0    [1    /1   ]  148.032206454        1
[INPUT] 0    0    [1    /1   ]  60.3991631689        1
[INPUT] 0    0    [1    /1   ]  26.8081679028        1
[INPUT] 0    0    [1    /1   ]  9.40730503123        1
[INPUT] 1    0    [1    /1   ]  8.60426825803        1
[INPUT] 1    0    [1    /1   ]  0.492750454923       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2330188149789669, 1.0]], [0, [0.6112111423180774, 1.0]], [0, [2.0263917544002066, 1.0]], [0, [117616.81240340795, 1.0]], [0, [4.359845516776578, 1.0]], [0, [1176168.1426102081, 1.0]], [0, [588084.0699425938, 1.0]], [0, [294042.03084603895, 1.0]], [0, [147020.9910254191, 1.0]], [0, [73510.41630439973, 1.0]], [0, [36754.69504783618, 1.0]], [0, [7301.9125562815525, 1.0]], [0, [18375.75543342743, 1.0]], [0, [1446.6335379031032, 1.0]], [0, [417.6564641887433, 1.0]], [0, [148.03220645357976, 1.0]], [0, [60.39916316885768, 1.0]], [0, [26.808167902769156, 1.0]], [0, [9.407305031234138, 1.0]], [1, [8.604268258028124, 1.0]], [1, [0.492750454922686, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23301881]
bas 1, expnt(s) = [0.61121114]
bas 2, expnt(s) = [2.02639175]
bas 3, expnt(s) = [117616.81240341]
bas 4, expnt(s) = [4.35984552]
bas 5, expnt(s) = [1176168.14261021]
bas 6, expnt(s) = [588084.06994259]
bas 7, expnt(s) = [294042.03084604]
bas 8, expnt(s) = [147020.99102542]
bas 9, expnt(s) = [73510.4163044]
bas 10, expnt(s) = [36754.69504784]
bas 11, expnt(s) = [7301.91255628]
bas 12, expnt(s) = [18375.75543343]
bas 13, expnt(s) = [1446.6335379]
bas 14, expnt(s) = [417.65646419]
bas 15, expnt(s) = [148.03220645]
bas 16, expnt(s) = [60.39916317]
bas 17, expnt(s) = [26.8081679]
bas 18, expnt(s) = [9.40730503]
bas 19, expnt(s) = [8.60426826]
bas 20, expnt(s) = [0.49275045]
CPU time:      1636.28
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.33018815e-01 8.47341088e-01 6.11211142e-01 1.74645931e+00
 2.02639175e+00 4.29099078e+00 1.17616812e+05 1.60460107e+04
 4.35984552e+00 7.62286713e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655734e+03 7.30191256e+03 1.99568731e+03
 1.83757554e+04 3.98748375e+03 1.44663354e+03 5.92630394e+02
 4.17656464e+02 2.33415359e+02 1.48032206e+02 1.07221575e+02
 6.03991632e+01 5.47379105e+01 2.68081679e+01 2.97656503e+01
 9.40730503e+00 1.35710654e+01 8.60426826e+00 4.29909280e+01
 4.92750455e-01 1.20439290e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336064652241447
cond(S) = 913033.6697154902
E1 = -689.5961709762012  E_coul = 184.9711344196326
init E= -504.625036556569
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672181509249299  LUMO = 0.568714843561304
  mo_energy =
[-1.21709878e+02 -1.33863623e+01 -7.62362242e+00 -7.62362242e+00
 -7.62362242e+00 -1.65754928e+00 -6.72181509e-01 -6.72181509e-01
 -6.72181509e-01  5.68714844e-01  5.36589419e+00  2.35665478e+01
  8.71237976e+01  2.89471753e+02  9.21820853e+02  3.17751302e+03
  1.26606193e+04  4.12572756e+04  1.05284276e+05  2.30456412e+05
  4.56263181e+05  8.45209229e+05  1.52838048e+06  2.85064048e+06
  5.80851827e+06]
E1 = -707.753987017646  E_coul = 199.7813301999092
cycle= 1 E= -507.972656817737  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.760685
diis-c [-0.57864229  1.        ]
  HOMO = -0.217653316974876  LUMO = 0.92310154498578
  mo_energy =
[-1.20200284e+02 -1.23048586e+01 -6.59408078e+00 -6.59408078e+00
 -6.59408078e+00 -1.16332056e+00 -2.17653317e-01 -2.17653317e-01
 -2.17653317e-01  9.23101545e-01  6.01573920e+00  2.45396810e+01
  8.84083494e+01  2.90926719e+02  9.23312244e+02  3.17894523e+03
  1.26619452e+04  4.12585344e+04  1.05285498e+05  2.30457609e+05
  4.56264361e+05  8.45210396e+05  1.52838164e+06  2.85064163e+06
  5.80851941e+06]
E1 = -706.8001588332801  E_coul = 198.8097067485339
cycle= 2 E= -507.990452084746  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.05 sec, wall time      0.04 sec
diis-norm(errvec)=0.0338872
diis-c [-0.00114625 -0.00190728  1.00190728]
  HOMO = -0.239777486603769  LUMO = 0.919057686425243
  mo_energy =
[-1.20315057e+02 -1.23725062e+01 -6.66898908e+00 -6.66898908e+00
 -6.66898908e+00 -1.17755326e+00 -2.39777487e-01 -2.39777487e-01
 -2.39777487e-01  9.19057686e-01  5.98545848e+00  2.44807026e+01
  8.83232928e+01  2.90821786e+02  9.23191833e+02  3.17881050e+03
  1.26618003e+04  4.12583855e+04  1.05285348e+05  2.30457458e+05
  4.56264210e+05  8.45210244e+05  1.52838149e+06  2.85064148e+06
  5.80851926e+06]
E1 = -706.6921469200464  E_coul = 198.7014339177386
cycle= 3 E= -507.990713002308  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=0.00367942
diis-c [-3.07635949e-06  1.09097882e-04 -1.05869785e-01  1.10576069e+00]
  HOMO = -0.242927268205886  LUMO = 0.918253254502041
  mo_energy =
[-1.20326846e+02 -1.23810788e+01 -6.67804921e+00 -6.67804921e+00
 -6.67804921e+00 -1.17946171e+00 -2.42927268e-01 -2.42927268e-01
 -2.42927268e-01  9.18253255e-01  5.98100022e+00  2.44731147e+01
  8.83135236e+01  2.90810646e+02  9.23179803e+02  3.17879776e+03
  1.26617871e+04  4.12583721e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210231e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.676884486841  E_coul = 198.68616645872956
cycle= 4 E= -507.990718028111  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170406
diis-c [-4.55640795e-10 -9.01818111e-06  6.93179166e-03 -9.95518196e-02
  1.09262905e+00]
  HOMO = -0.243079129732006  LUMO = 0.918205505628557
  mo_energy =
[-1.20327207e+02 -1.23814284e+01 -6.67839545e+00 -6.67839545e+00
 -6.67839545e+00 -1.17955349e+00 -2.43079130e-01 -2.43079130e-01
 -2.43079130e-01  9.18205506e-01  5.98078127e+00  2.44727992e+01
  8.83131750e+01  2.90810289e+02  9.23179441e+02  3.17879740e+03
  1.26617867e+04  4.12583718e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210230e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.6761559227803  E_coul = 198.6854378806387
cycle= 5 E= -507.990718042142  delta_E= -1.4e-08  |g|= 4.92e-06  |ddm|= 0.000639
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.19623e-06
diis-c [-7.53458655e-13  5.42610690e-07 -4.99258782e-04  6.83024328e-03
 -8.02592645e-02  1.07392774e+00]
  HOMO = -0.243081474153671  LUMO = 0.918204839579125
  mo_energy =
[-1.20327212e+02 -1.23814330e+01 -6.67840018e+00 -6.67840018e+00
 -6.67840018e+00 -1.17955511e+00 -2.43081474e-01 -2.43081474e-01
 -2.43081474e-01  9.18204840e-01  5.98077788e+00  2.44727948e+01
  8.83131701e+01  2.90810283e+02  9.23179436e+02  3.17879739e+03
  1.26617867e+04  4.12583718e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210230e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.6761441193356  E_coul = 198.68542607718928
cycle= 6 E= -507.990718042146  delta_E= -4.77e-12  |g|= 9.14e-08  |ddm|= 1.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6761441193356  E_coul = 198.68542607718928
  HOMO = -0.243081516987527  LUMO = 0.918204813038539
  mo_energy =
[-1.20327212e+02 -1.23814331e+01 -6.67840027e+00 -6.67840027e+00
 -6.67840027e+00 -1.17955512e+00 -2.43081517e-01 -2.43081517e-01
 -2.43081517e-01  9.18204813e-01  5.98077781e+00  2.44727947e+01
  8.83131700e+01  2.90810283e+02  9.23179436e+02  3.17879739e+03
  1.26617867e+04  4.12583718e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210230e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.6761439339574  E_coul = 198.68542589181115
Extra cycle  E= -507.990718042146  delta_E= 1.14e-13  |g|= 1.19e-08  |ddm|= 2.11e-07
    CPU time for scf_cycle      1.57 sec, wall time      0.31 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913033.6697154902
E1 = -706.6761439339574  E_coul = 198.68542589181115
init E= -507.990718042146
    CPU time for initialize scf      6.06 sec, wall time      0.26 sec
  HOMO = -0.243081522996222  LUMO = 0.918204810175691
  mo_energy =
[-1.20327212e+02 -1.23814331e+01 -6.67840028e+00 -6.67840028e+00
 -6.67840028e+00 -1.17955513e+00 -2.43081523e-01 -2.43081523e-01
 -2.43081523e-01  9.18204810e-01  5.98077781e+00  2.44727947e+01
  8.83131700e+01  2.90810283e+02  9.23179436e+02  3.17879739e+03
  1.26617867e+04  4.12583718e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210230e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.676143903802  E_coul = 198.68542586165538
cycle= 1 E= -507.990718042147  delta_E= -3.41e-13  |g|= 3.41e-09  |ddm|= 2.74e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.676143903802  E_coul = 198.68542586165538
  HOMO = -0.243081523904756  LUMO = 0.918204813976972
  mo_energy =
[-1.20327212e+02 -1.23814331e+01 -6.67840028e+00 -6.67840028e+00
 -6.67840028e+00 -1.17955513e+00 -2.43081524e-01 -2.43081524e-01
 -2.43081524e-01  9.18204814e-01  5.98077780e+00  2.44727947e+01
  8.83131700e+01  2.90810283e+02  9.23179436e+02  3.17879739e+03
  1.26617867e+04  4.12583718e+04  1.05285334e+05  2.30457444e+05
  4.56264196e+05  8.45210230e+05  1.52838147e+06  2.85064146e+06
  5.80851924e+06]
E1 = -706.6761438941471  E_coul = 198.68542585200046
Extra cycle  E= -507.990718042147  delta_E= -1.14e-13  |g|= 2.12e-09  |ddm|= 9.05e-09
    CPU time for scf_cycle      6.56 sec, wall time      0.43 sec
exp = [2.33018815e-01 6.11211142e-01 2.02639175e+00 1.17616812e+05
 4.35984552e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191256e+03
 1.83757554e+04 1.44663354e+03 4.17656464e+02 1.48032206e+02
 6.03991632e+01 2.68081679e+01 9.40730503e+00 8.60426826e+00
 4.92750455e-01]
grad_E = [-1.10770965e-06 -2.50894738e-06 -1.76854977e-06  6.01483934e-09
 -9.54005355e-08  3.99069059e-11  1.72597610e-10  9.33025822e-10
  3.68575843e-09  1.53895697e-08  8.03287809e-08  5.07458329e-06
  1.96374508e-07 -3.96628458e-05  1.36101863e-05 -6.48998358e-05
  6.93859405e-06  5.79680742e-05 -3.69479676e-06 -1.18661464e-06
 -1.16776107e-06]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232955677467       1
[INPUT] 0    0    [1    /1   ]  0.611043934396       1
[INPUT] 0    0    [1    /1   ]  2.02308250448        1
[INPUT] 0    0    [1    /1   ]  117616.812405        1
[INPUT] 0    0    [1    /1   ]  4.3573149232         1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991027        1
[INPUT] 0    0    [1    /1   ]  73510.4163097        1
[INPUT] 0    0    [1    /1   ]  36754.6950756        1
[INPUT] 0    0    [1    /1   ]  7301.9143081         1
[INPUT] 0    0    [1    /1   ]  18375.7555016        1
[INPUT] 0    0    [1    /1   ]  1446.62025741        1
[INPUT] 0    0    [1    /1   ]  417.654941507        1
[INPUT] 0    0    [1    /1   ]  148.032249931        1
[INPUT] 0    0    [1    /1   ]  60.3885489635        1
[INPUT] 0    0    [1    /1   ]  26.7993632437        1
[INPUT] 0    0    [1    /1   ]  9.40659984325        1
[INPUT] 1    0    [1    /1   ]  8.60426046727        1
[INPUT] 1    0    [1    /1   ]  0.492749783699       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23295567746685106, 1.0]], [0, [0.6110439343958088, 1.0]], [0, [2.023082504483922, 1.0]], [0, [117616.81240548998, 1.0]], [0, [4.357314923202444, 1.0]], [0, [1176168.142610222, 1.0]], [0, [588084.0699426536, 1.0]], [0, [294042.0308463619, 1.0]], [0, [147020.99102669503, 1.0]], [0, [73510.41630972794, 1.0]], [0, [36754.695075626616, 1.0]], [0, [7301.91430809831, 1.0]], [0, [18375.755501572283, 1.0]], [0, [1446.620257408229, 1.0]], [0, [417.65494150684367, 1.0]], [0, [148.03224993070944, 1.0]], [0, [60.388548963453694, 1.0]], [0, [26.799363243687218, 1.0]], [0, [9.40659984325342, 1.0]], [1, [8.604260467268771, 1.0]], [1, [0.49274978369869465, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23295568]
bas 1, expnt(s) = [0.61104393]
bas 2, expnt(s) = [2.0230825]
bas 3, expnt(s) = [117616.81240549]
bas 4, expnt(s) = [4.35731492]
bas 5, expnt(s) = [1176168.14261022]
bas 6, expnt(s) = [588084.06994265]
bas 7, expnt(s) = [294042.03084636]
bas 8, expnt(s) = [147020.9910267]
bas 9, expnt(s) = [73510.41630973]
bas 10, expnt(s) = [36754.69507563]
bas 11, expnt(s) = [7301.9143081]
bas 12, expnt(s) = [18375.75550157]
bas 13, expnt(s) = [1446.62025741]
bas 14, expnt(s) = [417.65494151]
bas 15, expnt(s) = [148.03224993]
bas 16, expnt(s) = [60.38854896]
bas 17, expnt(s) = [26.79936324]
bas 18, expnt(s) = [9.40659984]
bas 19, expnt(s) = [8.60426047]
bas 20, expnt(s) = [0.49274978]
CPU time:      1651.55
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32955677e-01 8.47168889e-01 6.11043934e-01 1.74610096e+00
 2.02308250e+00 4.28573407e+00 1.17616812e+05 1.60460107e+04
 4.35731492e+00 7.61954848e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546951e+04 6.70655734e+03 7.30191431e+03 1.99568767e+03
 1.83757555e+04 3.98748376e+03 1.44662026e+03 5.92626314e+02
 4.17654942e+02 2.33414721e+02 1.48032250e+02 1.07221599e+02
 6.03885490e+01 5.47306959e+01 2.67993632e+01 2.97583180e+01
 9.40659984e+00 1.35703024e+01 8.60426047e+00 4.29908794e+01
 4.92749784e-01 1.20439084e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336065856511496
cond(S) = 913031.3476073047
E1 = -689.5961173798561  E_coul = 184.9710798805211
init E= -504.625037499335
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672182350371611  LUMO = 0.568285501972535
  mo_energy =
[-1.21709887e+02 -1.33863665e+01 -7.62362591e+00 -7.62362591e+00
 -7.62362591e+00 -1.65755013e+00 -6.72182350e-01 -6.72182350e-01
 -6.72182350e-01  5.68285502e-01  5.35900751e+00  2.35453573e+01
  8.70805814e+01  2.89395308e+02  9.21723470e+02  3.17740158e+03
  1.26604916e+04  4.12571476e+04  1.05284152e+05  2.30456291e+05
  4.56263063e+05  8.45209113e+05  1.52838037e+06  2.85064037e+06
  5.80851816e+06]
E1 = -707.7539198045338  E_coul = 199.78126315494137
cycle= 1 E= -507.972656649592  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.760683
diis-c [-0.57863902  1.        ]
  HOMO = -0.217654777003447  LUMO = 0.92256165167258
  mo_energy =
[-1.20200294e+02 -1.23048637e+01 -6.59408513e+00 -6.59408513e+00
 -6.59408513e+00 -1.16332174e+00 -2.17654777e-01 -2.17654777e-01
 -2.17654777e-01  9.22561652e-01  6.00853912e+00  2.45183401e+01
  8.83650824e+01  2.90850265e+02  9.23214861e+02  3.17883378e+03
  1.26618175e+04  4.12584063e+04  1.05285374e+05  2.30457488e+05
  4.56264243e+05  8.45210280e+05  1.52838153e+06  2.85064152e+06
  5.80851930e+06]
E1 = -706.8000794202325  E_coul = 198.809627306277
cycle= 2 E= -507.990452113955  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0339014
diis-c [-0.00114719 -0.00191657  1.00191657]
  HOMO = -0.239779335166125  LUMO = 0.918522830581491
  mo_energy =
[-1.20315069e+02 -1.23725129e+01 -6.66899516e+00 -6.66899516e+00
 -6.66899516e+00 -1.17755471e+00 -2.39779335e-01 -2.39779335e-01
 -2.39779335e-01  9.18522831e-01  5.97828513e+00  2.44593748e+01
  8.82800294e+01  2.90745332e+02  9.23094448e+02  3.17869906e+03
  1.26616725e+04  4.12582575e+04  1.05285224e+05  2.30457337e+05
  4.56264092e+05  8.45210128e+05  1.52838137e+06  2.85064136e+06
  5.80851915e+06]
E1 = -706.6920622796666  E_coul = 198.70134922749102
cycle= 3 E= -507.990713052176  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00368173
diis-c [-3.07882815e-06  1.08778253e-04 -1.05901797e-01  1.10579302e+00]
  HOMO = -0.242929239750643  LUMO = 0.917719135941992
  mo_energy =
[-1.20326858e+02 -1.23810856e+01 -6.67805530e+00 -6.67805530e+00
 -6.67805530e+00 -1.17946325e+00 -2.42929240e-01 -2.42929240e-01
 -2.42929240e-01  9.17719136e-01  5.97383018e+00  2.44517882e+01
  8.82702607e+01  2.90734192e+02  9.23082418e+02  3.17868632e+03
  1.26616593e+04  4.12582441e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210115e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6767985407184  E_coul = 198.6860804617024
cycle= 4 E= -507.990718079016  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170436
diis-c [-4.57147982e-10 -9.01493356e-06  6.93182528e-03 -9.95213664e-02
  1.09259856e+00]
  HOMO = -0.243081032916139  LUMO = 0.917671431689164
  mo_energy =
[-1.20327219e+02 -1.23814349e+01 -6.67840126e+00 -6.67840126e+00
 -6.67840126e+00 -1.17955499e+00 -2.43081033e-01 -2.43081033e-01
 -2.43081033e-01  9.17671432e-01  5.97361147e+00  2.44514729e+01
  8.82699124e+01  2.90733835e+02  9.23082057e+02  3.17868595e+03
  1.26616590e+04  4.12582437e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210114e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6760702599227  E_coul = 198.68535216687758
cycle= 5 E= -507.990718093045  delta_E= -1.4e-08  |g|= 4.94e-06  |ddm|= 0.000639
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.20307e-06
diis-c [-7.55440272e-13  5.47669528e-07 -5.00224630e-04  6.84053021e-03
 -8.04083765e-02  1.07406752e+00]
  HOMO = -0.243083382817177  LUMO = 0.917670765288803
  mo_energy =
[-1.20327224e+02 -1.23814395e+01 -6.67840600e+00 -6.67840600e+00
 -6.67840600e+00 -1.17955661e+00 -2.43083383e-01 -2.43083383e-01
 -2.43083383e-01  9.17670765e-01  5.97360808e+00  2.44514686e+01
  8.82699075e+01  2.90733829e+02  9.23082051e+02  3.17868594e+03
  1.26616589e+04  4.12582437e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210114e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6760584307813  E_coul = 198.68534033773102
cycle= 6 E= -507.99071809305  delta_E= -5.17e-12  |g|= 9.18e-08  |ddm|= 1.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6760584307813  E_coul = 198.68534033773102
  HOMO = -0.243083425485469  LUMO = 0.917670738518602
  mo_energy =
[-1.20327224e+02 -1.23814396e+01 -6.67840609e+00 -6.67840609e+00
 -6.67840609e+00 -1.17955663e+00 -2.43083425e-01 -2.43083425e-01
 -2.43083425e-01  9.17670739e-01  5.97360801e+00  2.44514685e+01
  8.82699074e+01  2.90733829e+02  9.23082051e+02  3.17868594e+03
  1.26616589e+04  4.12582437e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210114e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6760582432174  E_coul = 198.6853401501666
Extra cycle  E= -507.990718093051  delta_E= -5.68e-13  |g|= 1.22e-08  |ddm|= 2.12e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
exp = [2.32955677e-01 6.11043934e-01 2.02308250e+00 1.17616812e+05
 4.35731492e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546951e+04 7.30191431e+03
 1.83757555e+04 1.44662026e+03 4.17654942e+02 1.48032250e+02
 6.03885490e+01 2.67993632e+01 9.40659984e+00 8.60426047e+00
 4.92749784e-01]
E = -507.9907180930508
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232955677467       1
[INPUT] 0    0    [1    /1   ]  0.611043934396       1
[INPUT] 0    0    [1    /1   ]  2.02308250448        1
[INPUT] 0    0    [1    /1   ]  117616.812405        1
[INPUT] 0    0    [1    /1   ]  4.3573149232         1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991027        1
[INPUT] 0    0    [1    /1   ]  73510.4163097        1
[INPUT] 0    0    [1    /1   ]  36754.6950756        1
[INPUT] 0    0    [1    /1   ]  7301.9143081         1
[INPUT] 0    0    [1    /1   ]  18375.7555016        1
[INPUT] 0    0    [1    /1   ]  1446.62025741        1
[INPUT] 0    0    [1    /1   ]  417.654941507        1
[INPUT] 0    0    [1    /1   ]  148.032249931        1
[INPUT] 0    0    [1    /1   ]  60.3885489635        1
[INPUT] 0    0    [1    /1   ]  26.7993632437        1
[INPUT] 0    0    [1    /1   ]  9.40659984325        1
[INPUT] 1    0    [1    /1   ]  8.60426046727        1
[INPUT] 1    0    [1    /1   ]  0.492749783699       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23295567746685106, 1.0]], [0, [0.6110439343958088, 1.0]], [0, [2.023082504483922, 1.0]], [0, [117616.81240548998, 1.0]], [0, [4.357314923202444, 1.0]], [0, [1176168.142610222, 1.0]], [0, [588084.0699426536, 1.0]], [0, [294042.0308463619, 1.0]], [0, [147020.99102669503, 1.0]], [0, [73510.41630972794, 1.0]], [0, [36754.695075626616, 1.0]], [0, [7301.91430809831, 1.0]], [0, [18375.755501572283, 1.0]], [0, [1446.620257408229, 1.0]], [0, [417.65494150684367, 1.0]], [0, [148.03224993070944, 1.0]], [0, [60.388548963453694, 1.0]], [0, [26.799363243687218, 1.0]], [0, [9.40659984325342, 1.0]], [1, [8.604260467268771, 1.0]], [1, [0.49274978369869465, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23295568]
bas 1, expnt(s) = [0.61104393]
bas 2, expnt(s) = [2.0230825]
bas 3, expnt(s) = [117616.81240549]
bas 4, expnt(s) = [4.35731492]
bas 5, expnt(s) = [1176168.14261022]
bas 6, expnt(s) = [588084.06994265]
bas 7, expnt(s) = [294042.03084636]
bas 8, expnt(s) = [147020.9910267]
bas 9, expnt(s) = [73510.41630973]
bas 10, expnt(s) = [36754.69507563]
bas 11, expnt(s) = [7301.9143081]
bas 12, expnt(s) = [18375.75550157]
bas 13, expnt(s) = [1446.62025741]
bas 14, expnt(s) = [417.65494151]
bas 15, expnt(s) = [148.03224993]
bas 16, expnt(s) = [60.38854896]
bas 17, expnt(s) = [26.79936324]
bas 18, expnt(s) = [9.40659984]
bas 19, expnt(s) = [8.60426047]
bas 20, expnt(s) = [0.49274978]
CPU time:      1653.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32955677e-01 8.47168889e-01 6.11043934e-01 1.74610096e+00
 2.02308250e+00 4.28573407e+00 1.17616812e+05 1.60460107e+04
 4.35731492e+00 7.61954848e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546951e+04 6.70655734e+03 7.30191431e+03 1.99568767e+03
 1.83757555e+04 3.98748376e+03 1.44662026e+03 5.92626314e+02
 4.17654942e+02 2.33414721e+02 1.48032250e+02 1.07221599e+02
 6.03885490e+01 5.47306959e+01 2.67993632e+01 2.97583180e+01
 9.40659984e+00 1.35703024e+01 8.60426047e+00 4.29908794e+01
 4.92749784e-01 1.20439084e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336065856511496
cond(S) = 913031.3476073047
E1 = -689.5961173798561  E_coul = 184.9710798805211
init E= -504.625037499335
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672182350371611  LUMO = 0.568285501972535
  mo_energy =
[-1.21709887e+02 -1.33863665e+01 -7.62362591e+00 -7.62362591e+00
 -7.62362591e+00 -1.65755013e+00 -6.72182350e-01 -6.72182350e-01
 -6.72182350e-01  5.68285502e-01  5.35900751e+00  2.35453573e+01
  8.70805814e+01  2.89395308e+02  9.21723470e+02  3.17740158e+03
  1.26604916e+04  4.12571476e+04  1.05284152e+05  2.30456291e+05
  4.56263063e+05  8.45209113e+05  1.52838037e+06  2.85064037e+06
  5.80851816e+06]
E1 = -707.7539198045338  E_coul = 199.78126315494137
cycle= 1 E= -507.972656649592  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.760683
diis-c [-0.57863902  1.        ]
  HOMO = -0.217654777003447  LUMO = 0.92256165167258
  mo_energy =
[-1.20200294e+02 -1.23048637e+01 -6.59408513e+00 -6.59408513e+00
 -6.59408513e+00 -1.16332174e+00 -2.17654777e-01 -2.17654777e-01
 -2.17654777e-01  9.22561652e-01  6.00853912e+00  2.45183401e+01
  8.83650824e+01  2.90850265e+02  9.23214861e+02  3.17883378e+03
  1.26618175e+04  4.12584063e+04  1.05285374e+05  2.30457488e+05
  4.56264243e+05  8.45210280e+05  1.52838153e+06  2.85064152e+06
  5.80851930e+06]
E1 = -706.8000794202325  E_coul = 198.809627306277
cycle= 2 E= -507.990452113955  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0339014
diis-c [-0.00114719 -0.00191657  1.00191657]
  HOMO = -0.239779335166125  LUMO = 0.918522830581491
  mo_energy =
[-1.20315069e+02 -1.23725129e+01 -6.66899516e+00 -6.66899516e+00
 -6.66899516e+00 -1.17755471e+00 -2.39779335e-01 -2.39779335e-01
 -2.39779335e-01  9.18522831e-01  5.97828513e+00  2.44593748e+01
  8.82800294e+01  2.90745332e+02  9.23094448e+02  3.17869906e+03
  1.26616725e+04  4.12582575e+04  1.05285224e+05  2.30457337e+05
  4.56264092e+05  8.45210128e+05  1.52838137e+06  2.85064136e+06
  5.80851915e+06]
E1 = -706.6920622796666  E_coul = 198.70134922749102
cycle= 3 E= -507.990713052176  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00368173
diis-c [-3.07882815e-06  1.08778253e-04 -1.05901797e-01  1.10579302e+00]
  HOMO = -0.242929239750643  LUMO = 0.917719135941992
  mo_energy =
[-1.20326858e+02 -1.23810856e+01 -6.67805530e+00 -6.67805530e+00
 -6.67805530e+00 -1.17946325e+00 -2.42929240e-01 -2.42929240e-01
 -2.42929240e-01  9.17719136e-01  5.97383018e+00  2.44517882e+01
  8.82702607e+01  2.90734192e+02  9.23082418e+02  3.17868632e+03
  1.26616593e+04  4.12582441e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210115e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6767985407184  E_coul = 198.6860804617024
cycle= 4 E= -507.990718079016  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170436
diis-c [-4.57147982e-10 -9.01493356e-06  6.93182528e-03 -9.95213664e-02
  1.09259856e+00]
  HOMO = -0.243081032916139  LUMO = 0.917671431689164
  mo_energy =
[-1.20327219e+02 -1.23814349e+01 -6.67840126e+00 -6.67840126e+00
 -6.67840126e+00 -1.17955499e+00 -2.43081033e-01 -2.43081033e-01
 -2.43081033e-01  9.17671432e-01  5.97361147e+00  2.44514729e+01
  8.82699124e+01  2.90733835e+02  9.23082057e+02  3.17868595e+03
  1.26616590e+04  4.12582437e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210114e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6760702599227  E_coul = 198.68535216687758
cycle= 5 E= -507.990718093045  delta_E= -1.4e-08  |g|= 4.94e-06  |ddm|= 0.000639
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.20307e-06
diis-c [-7.55440272e-13  5.47669528e-07 -5.00224630e-04  6.84053021e-03
 -8.04083765e-02  1.07406752e+00]
  HOMO = -0.243083382817177  LUMO = 0.917670765288803
  mo_energy =
[-1.20327224e+02 -1.23814395e+01 -6.67840600e+00 -6.67840600e+00
 -6.67840600e+00 -1.17955661e+00 -2.43083383e-01 -2.43083383e-01
 -2.43083383e-01  9.17670765e-01  5.97360808e+00  2.44514686e+01
  8.82699075e+01  2.90733829e+02  9.23082051e+02  3.17868594e+03
  1.26616589e+04  4.12582437e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210114e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6760584307813  E_coul = 198.68534033773102
cycle= 6 E= -507.99071809305  delta_E= -5.17e-12  |g|= 9.18e-08  |ddm|= 1.38e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6760584307813  E_coul = 198.68534033773102
  HOMO = -0.243083425485469  LUMO = 0.917670738518602
  mo_energy =
[-1.20327224e+02 -1.23814396e+01 -6.67840609e+00 -6.67840609e+00
 -6.67840609e+00 -1.17955663e+00 -2.43083425e-01 -2.43083425e-01
 -2.43083425e-01  9.17670739e-01  5.97360801e+00  2.44514685e+01
  8.82699074e+01  2.90733829e+02  9.23082051e+02  3.17868594e+03
  1.26616589e+04  4.12582437e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210114e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6760582432174  E_coul = 198.6853401501666
Extra cycle  E= -507.990718093051  delta_E= -5.68e-13  |g|= 1.22e-08  |ddm|= 2.12e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913031.3476073047
E1 = -706.6760582432174  E_coul = 198.6853401501666
init E= -507.990718093051
    CPU time for initialize scf      5.77 sec, wall time      0.24 sec
  HOMO = -0.243083431538438  LUMO = 0.9176707364338
  mo_energy =
[-1.20327224e+02 -1.23814396e+01 -6.67840610e+00 -6.67840610e+00
 -6.67840610e+00 -1.17955663e+00 -2.43083432e-01 -2.43083432e-01
 -2.43083432e-01  9.17670736e-01  5.97360800e+00  2.44514685e+01
  8.82699074e+01  2.90733829e+02  9.23082051e+02  3.17868594e+03
  1.26616589e+04  4.12582437e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210114e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6760582156035  E_coul = 198.6853401225532
cycle= 1 E= -507.99071809305  delta_E= 5.68e-13  |g|= 2.93e-09  |ddm|= 2.67e-08
    CPU time for cycle= 1      0.34 sec, wall time      0.03 sec
E1 = -706.6760582156035  E_coul = 198.6853401225532
  HOMO = -0.24308343240015  LUMO = 0.917670739491796
  mo_energy =
[-1.20327224e+02 -1.23814396e+01 -6.67840610e+00 -6.67840610e+00
 -6.67840610e+00 -1.17955663e+00 -2.43083432e-01 -2.43083432e-01
 -2.43083432e-01  9.17670739e-01  5.97360800e+00  2.44514685e+01
  8.82699074e+01  2.90733829e+02  9.23082051e+02  3.17868594e+03
  1.26616589e+04  4.12582437e+04  1.05285210e+05  2.30457323e+05
  4.56264078e+05  8.45210114e+05  1.52838136e+06  2.85064135e+06
  5.80851913e+06]
E1 = -706.6760582051501  E_coul = 198.68534011209985
Extra cycle  E= -507.99071809305  delta_E= 5.68e-14  |g|= 1.15e-09  |ddm|= 8.06e-09
    CPU time for scf_cycle      6.27 sec, wall time      0.43 sec
exp = [2.32955677e-01 6.11043934e-01 2.02308250e+00 1.17616812e+05
 4.35731492e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546951e+04 7.30191431e+03
 1.83757555e+04 1.44662026e+03 4.17654942e+02 1.48032250e+02
 6.03885490e+01 2.67993632e+01 9.40659984e+00 8.60426047e+00
 4.92749784e-01]
grad_E = [ 2.00682749e-05 -2.10411105e-05 -1.10860730e-05  6.01455076e-09
  6.75167169e-06  3.99036636e-11  1.72588158e-10  9.32981569e-10
  3.68557978e-09  1.53888136e-08  8.03250957e-08  5.07429287e-06
  1.96362754e-07 -3.96404213e-05  1.33782100e-05 -6.40677471e-05
  5.70808219e-06  5.85844480e-05 -4.52070653e-06 -7.15488656e-06
 -2.53522991e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232853530008       1
[INPUT] 0    0    [1    /1   ]  0.610720802745       1
[INPUT] 0    0    [1    /1   ]  2.01664512651        1
[INPUT] 0    0    [1    /1   ]  117616.812409        1
[INPUT] 0    0    [1    /1   ]  4.35141928398        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030847        1
[INPUT] 0    0    [1    /1   ]  147020.991029        1
[INPUT] 0    0    [1    /1   ]  73510.4163188        1
[INPUT] 0    0    [1    /1   ]  36754.6951232        1
[INPUT] 0    0    [1    /1   ]  7301.9173062         1
[INPUT] 0    0    [1    /1   ]  18375.7556182        1
[INPUT] 0    0    [1    /1   ]  1446.59753694        1
[INPUT] 0    0    [1    /1   ]  417.652198477        1
[INPUT] 0    0    [1    /1   ]  148.032754186        1
[INPUT] 0    0    [1    /1   ]  60.3707974893        1
[INPUT] 0    0    [1    /1   ]  26.7828372383        1
[INPUT] 0    0    [1    /1   ]  9.40253820902        1
[INPUT] 1    0    [1    /1   ]  8.60424824993        1
[INPUT] 1    0    [1    /1   ]  0.492748584917       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23285353000758605, 1.0]], [0, [0.6107208027452594, 1.0]], [0, [2.0166451265124237, 1.0]], [0, [117616.81240905341, 1.0]], [0, [4.351419283975702, 1.0]], [0, [1176168.1426102458, 1.0]], [0, [588084.069942756, 1.0]], [0, [294042.03084691457, 1.0]], [0, [147020.99102887884, 1.0]], [0, [73510.41631884727, 1.0]], [0, [36754.695123189675, 1.0]], [0, [7301.917306203417, 1.0]], [0, [18375.755618209332, 1.0]], [0, [1446.5975369420269, 1.0]], [0, [417.6521984768872, 1.0]], [0, [148.0327541861012, 1.0]], [0, [60.37079748933605, 1.0]], [0, [26.78283723833576, 1.0]], [0, [9.402538209022653, 1.0]], [1, [8.604248249927062, 1.0]], [1, [0.49274858491744483, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23285353]
bas 1, expnt(s) = [0.6107208]
bas 2, expnt(s) = [2.01664513]
bas 3, expnt(s) = [117616.81240905]
bas 4, expnt(s) = [4.35141928]
bas 5, expnt(s) = [1176168.14261025]
bas 6, expnt(s) = [588084.06994276]
bas 7, expnt(s) = [294042.03084691]
bas 8, expnt(s) = [147020.99102888]
bas 9, expnt(s) = [73510.41631885]
bas 10, expnt(s) = [36754.69512319]
bas 11, expnt(s) = [7301.9173062]
bas 12, expnt(s) = [18375.75561821]
bas 13, expnt(s) = [1446.59753694]
bas 14, expnt(s) = [417.65219848]
bas 15, expnt(s) = [148.03275419]
bas 16, expnt(s) = [60.37079749]
bas 17, expnt(s) = [26.78283724]
bas 18, expnt(s) = [9.40253821]
bas 19, expnt(s) = [8.60424825]
bas 20, expnt(s) = [0.49274858]
CPU time:      1668.60
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32853530e-01 8.46890271e-01 6.10720803e-01 1.74540839e+00
 2.01664513e+00 4.27550221e+00 1.17616812e+05 1.60460107e+04
 4.35141928e+00 7.61181498e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546951e+04 6.70655735e+03 7.30191731e+03 1.99568828e+03
 1.83757556e+04 3.98748378e+03 1.44659754e+03 5.92619333e+02
 4.17652198e+02 2.33413571e+02 1.48032754e+02 1.07221873e+02
 6.03707975e+01 5.47186292e+01 2.67828372e+01 2.97445540e+01
 9.40253821e+00 1.35659076e+01 8.60424825e+00 4.29908031e+01
 4.92748585e-01 1.20438718e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33606784048558
cond(S) = 913026.7760370299
E1 = -689.5960198178432  E_coul = 184.97098905746992
init E= -504.625030760373
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672183946521987  LUMO = 0.567503374058791
  mo_energy =
[-1.21709901e+02 -1.33863733e+01 -7.62363168e+00 -7.62363168e+00
 -7.62363168e+00 -1.65755195e+00 -6.72183947e-01 -6.72183947e-01
 -6.72183947e-01  5.67503374e-01  5.34524235e+00  2.34992606e+01
  8.69858328e+01  2.89239544e+02  9.21533333e+02  3.17718988e+03
  1.26602544e+04  4.12569113e+04  1.05283923e+05  2.30456068e+05
  4.56262845e+05  8.45208899e+05  1.52838016e+06  2.85064016e+06
  5.80851796e+06]
E1 = -707.7538158484491  E_coul = 199.781159277012
cycle= 1 E= -507.972656571437  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.760668
diis-c [-0.5786154  1.       ]
  HOMO = -0.217657117831161  LUMO = 0.921569926655035
  mo_energy =
[-1.20200309e+02 -1.23048716e+01 -6.59409172e+00 -6.59409172e+00
 -6.59409172e+00 -1.16332374e+00 -2.17657118e-01 -2.17657118e-01
 -2.17657118e-01  9.21569927e-01  5.99412612e+00  2.44718837e+01
  8.82702269e+01  2.90694489e+02  9.23024727e+02  3.17862208e+03
  1.26615803e+04  4.12581700e+04  1.05285145e+05  2.30457265e+05
  4.56264025e+05  8.45210066e+05  1.52838132e+06  2.85064131e+06
  5.80851910e+06]
E1 = -706.7999615842002  E_coul = 198.80950936602778
cycle= 2 E= -507.990452218172  delta_E= -0.0178  |g|= 0.0351  |ddm|=  0.4
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0339272
diis-c [-0.0011489 -0.0019336  1.0019336]
  HOMO = -0.239782031118959  LUMO = 0.917540931621103
  mo_energy =
[-1.20315088e+02 -1.23725231e+01 -6.66900435e+00 -6.66900435e+00
 -6.66900435e+00 -1.17755696e+00 -2.39782031e-01 -2.39782031e-01
 -2.39782031e-01  9.17540932e-01  5.96392741e+00  2.44129495e+01
  8.81851829e+01  2.90589555e+02  9.22904309e+02  3.17848735e+03
  1.26614354e+04  4.12580212e+04  1.05284995e+05  2.30457114e+05
  4.56263874e+05  8.45209914e+05  1.52838116e+06  2.85064116e+06
  5.80851895e+06]
E1 = -706.6919370756752  E_coul = 198.7012238900368
cycle= 3 E= -507.990713185638  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00368598
diis-c [-3.08327718e-06  1.08197935e-04 -1.05962713e-01  1.10585452e+00]
  HOMO = -0.24293207999224  LUMO = 0.916738688031788
  mo_energy =
[-1.20326877e+02 -1.23810957e+01 -6.67806434e+00 -6.67806434e+00
 -6.67806434e+00 -1.17946560e+00 -2.42932080e-01 -2.42932080e-01
 -2.42932080e-01  9.16738688e-01  5.95947940e+00  2.44053662e+01
  8.81754153e+01  2.90578415e+02  9.22892280e+02  3.17847461e+03
  1.26614222e+04  4.12580078e+04  1.05284981e+05  2.30457101e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.676671375493  E_coul = 198.68595316132266
cycle= 4 E= -507.99071821417  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170484
diis-c [-4.59857467e-10 -9.02752301e-06  6.93225845e-03 -9.94648767e-02
  1.09254165e+00]
  HOMO = -0.243083734476347  LUMO = 0.916691082961639
  mo_energy =
[-1.20327236e+02 -1.23814445e+01 -6.67840975e+00 -6.67840975e+00
 -6.67840975e+00 -1.17955726e+00 -2.43083734e-01 -2.43083734e-01
 -2.43083734e-01  9.16691083e-01  5.95926118e+00  2.44050515e+01
  8.81750677e+01  2.90578059e+02  9.22891919e+02  3.17847424e+03
  1.26614218e+04  4.12580074e+04  1.05284981e+05  2.30457100e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.6759436702854  E_coul = 198.6852254420878
cycle= 5 E= -507.990718228198  delta_E= -1.4e-08  |g|= 4.96e-06  |ddm|= 0.00064
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.2132e-06
diis-c [-7.61105459e-13  5.43004668e-07 -5.01764320e-04  6.85802999e-03
 -8.06620599e-02  1.07430525e+00]
  HOMO = -0.243086094486759  LUMO = 0.916690412672641
  mo_energy =
[-1.20327242e+02 -1.23814491e+01 -6.67841451e+00 -6.67841451e+00
 -6.67841451e+00 -1.17955889e+00 -2.43086094e-01 -2.43086094e-01
 -2.43086094e-01  9.16690413e-01  5.95925777e+00  2.44050471e+01
  8.81750627e+01  2.90578054e+02  9.22891914e+02  3.17847424e+03
  1.26614218e+04  4.12580074e+04  1.05284981e+05  2.30457100e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.6759317892577  E_coul = 198.68521356105515
cycle= 6 E= -507.990718228203  delta_E= -4.95e-12  |g|= 9.22e-08  |ddm|= 1.39e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759317892577  E_coul = 198.68521356105515
  HOMO = -0.243086137247431  LUMO = 0.916690386889623
  mo_energy =
[-1.20327242e+02 -1.23814492e+01 -6.67841459e+00 -6.67841459e+00
 -6.67841459e+00 -1.17955891e+00 -2.43086137e-01 -2.43086137e-01
 -2.43086137e-01  9.16690387e-01  5.95925771e+00  2.44050470e+01
  8.81750626e+01  2.90578054e+02  9.22891914e+02  3.17847424e+03
  1.26614218e+04  4.12580074e+04  1.05284981e+05  2.30457100e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.6759315984732  E_coul = 198.6852133702702
Extra cycle  E= -507.990718228203  delta_E= -5.12e-13  |g|= 1.15e-08  |ddm|= 2.15e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.32853530e-01 6.10720803e-01 2.01664513e+00 1.17616812e+05
 4.35141928e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546951e+04 7.30191731e+03
 1.83757556e+04 1.44659754e+03 4.17652198e+02 1.48032754e+02
 6.03707975e+01 2.67828372e+01 9.40253821e+00 8.60424825e+00
 4.92748585e-01]
E = -507.99071822820304
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:37:59 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232853530008       1
[INPUT] 0    0    [1    /1   ]  0.610720802745       1
[INPUT] 0    0    [1    /1   ]  2.01664512651        1
[INPUT] 0    0    [1    /1   ]  117616.812409        1
[INPUT] 0    0    [1    /1   ]  4.35141928398        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030847        1
[INPUT] 0    0    [1    /1   ]  147020.991029        1
[INPUT] 0    0    [1    /1   ]  73510.4163188        1
[INPUT] 0    0    [1    /1   ]  36754.6951232        1
[INPUT] 0    0    [1    /1   ]  7301.9173062         1
[INPUT] 0    0    [1    /1   ]  18375.7556182        1
[INPUT] 0    0    [1    /1   ]  1446.59753694        1
[INPUT] 0    0    [1    /1   ]  417.652198477        1
[INPUT] 0    0    [1    /1   ]  148.032754186        1
[INPUT] 0    0    [1    /1   ]  60.3707974893        1
[INPUT] 0    0    [1    /1   ]  26.7828372383        1
[INPUT] 0    0    [1    /1   ]  9.40253820902        1
[INPUT] 1    0    [1    /1   ]  8.60424824993        1
[INPUT] 1    0    [1    /1   ]  0.492748584917       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23285353000758605, 1.0]], [0, [0.6107208027452594, 1.0]], [0, [2.0166451265124237, 1.0]], [0, [117616.81240905341, 1.0]], [0, [4.351419283975702, 1.0]], [0, [1176168.1426102458, 1.0]], [0, [588084.069942756, 1.0]], [0, [294042.03084691457, 1.0]], [0, [147020.99102887884, 1.0]], [0, [73510.41631884727, 1.0]], [0, [36754.695123189675, 1.0]], [0, [7301.917306203417, 1.0]], [0, [18375.755618209332, 1.0]], [0, [1446.5975369420269, 1.0]], [0, [417.6521984768872, 1.0]], [0, [148.0327541861012, 1.0]], [0, [60.37079748933605, 1.0]], [0, [26.78283723833576, 1.0]], [0, [9.402538209022653, 1.0]], [1, [8.604248249927062, 1.0]], [1, [0.49274858491744483, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23285353]
bas 1, expnt(s) = [0.6107208]
bas 2, expnt(s) = [2.01664513]
bas 3, expnt(s) = [117616.81240905]
bas 4, expnt(s) = [4.35141928]
bas 5, expnt(s) = [1176168.14261025]
bas 6, expnt(s) = [588084.06994276]
bas 7, expnt(s) = [294042.03084691]
bas 8, expnt(s) = [147020.99102888]
bas 9, expnt(s) = [73510.41631885]
bas 10, expnt(s) = [36754.69512319]
bas 11, expnt(s) = [7301.9173062]
bas 12, expnt(s) = [18375.75561821]
bas 13, expnt(s) = [1446.59753694]
bas 14, expnt(s) = [417.65219848]
bas 15, expnt(s) = [148.03275419]
bas 16, expnt(s) = [60.37079749]
bas 17, expnt(s) = [26.78283724]
bas 18, expnt(s) = [9.40253821]
bas 19, expnt(s) = [8.60424825]
bas 20, expnt(s) = [0.49274858]
CPU time:      1670.64
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32853530e-01 8.46890271e-01 6.10720803e-01 1.74540839e+00
 2.01664513e+00 4.27550221e+00 1.17616812e+05 1.60460107e+04
 4.35141928e+00 7.61181498e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546951e+04 6.70655735e+03 7.30191731e+03 1.99568828e+03
 1.83757556e+04 3.98748378e+03 1.44659754e+03 5.92619333e+02
 4.17652198e+02 2.33413571e+02 1.48032754e+02 1.07221873e+02
 6.03707975e+01 5.47186292e+01 2.67828372e+01 2.97445540e+01
 9.40253821e+00 1.35659076e+01 8.60424825e+00 4.29908031e+01
 4.92748585e-01 1.20438718e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33606784048558
cond(S) = 913026.7760370299
E1 = -689.5960198178432  E_coul = 184.97098905746992
init E= -504.625030760373
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672183946521987  LUMO = 0.567503374058791
  mo_energy =
[-1.21709901e+02 -1.33863733e+01 -7.62363168e+00 -7.62363168e+00
 -7.62363168e+00 -1.65755195e+00 -6.72183947e-01 -6.72183947e-01
 -6.72183947e-01  5.67503374e-01  5.34524235e+00  2.34992606e+01
  8.69858328e+01  2.89239544e+02  9.21533333e+02  3.17718988e+03
  1.26602544e+04  4.12569113e+04  1.05283923e+05  2.30456068e+05
  4.56262845e+05  8.45208899e+05  1.52838016e+06  2.85064016e+06
  5.80851796e+06]
E1 = -707.7538158484491  E_coul = 199.781159277012
cycle= 1 E= -507.972656571437  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.760668
diis-c [-0.5786154  1.       ]
  HOMO = -0.217657117831161  LUMO = 0.921569926655035
  mo_energy =
[-1.20200309e+02 -1.23048716e+01 -6.59409172e+00 -6.59409172e+00
 -6.59409172e+00 -1.16332374e+00 -2.17657118e-01 -2.17657118e-01
 -2.17657118e-01  9.21569927e-01  5.99412612e+00  2.44718837e+01
  8.82702269e+01  2.90694489e+02  9.23024727e+02  3.17862208e+03
  1.26615803e+04  4.12581700e+04  1.05285145e+05  2.30457265e+05
  4.56264025e+05  8.45210066e+05  1.52838132e+06  2.85064131e+06
  5.80851910e+06]
E1 = -706.7999615842002  E_coul = 198.80950936602778
cycle= 2 E= -507.990452218172  delta_E= -0.0178  |g|= 0.0351  |ddm|=  0.4
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0339272
diis-c [-0.0011489 -0.0019336  1.0019336]
  HOMO = -0.239782031118959  LUMO = 0.917540931621103
  mo_energy =
[-1.20315088e+02 -1.23725231e+01 -6.66900435e+00 -6.66900435e+00
 -6.66900435e+00 -1.17755696e+00 -2.39782031e-01 -2.39782031e-01
 -2.39782031e-01  9.17540932e-01  5.96392741e+00  2.44129495e+01
  8.81851829e+01  2.90589555e+02  9.22904309e+02  3.17848735e+03
  1.26614354e+04  4.12580212e+04  1.05284995e+05  2.30457114e+05
  4.56263874e+05  8.45209914e+05  1.52838116e+06  2.85064116e+06
  5.80851895e+06]
E1 = -706.6919370756752  E_coul = 198.7012238900368
cycle= 3 E= -507.990713185638  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00368598
diis-c [-3.08327718e-06  1.08197935e-04 -1.05962713e-01  1.10585452e+00]
  HOMO = -0.24293207999224  LUMO = 0.916738688031788
  mo_energy =
[-1.20326877e+02 -1.23810957e+01 -6.67806434e+00 -6.67806434e+00
 -6.67806434e+00 -1.17946560e+00 -2.42932080e-01 -2.42932080e-01
 -2.42932080e-01  9.16738688e-01  5.95947940e+00  2.44053662e+01
  8.81754153e+01  2.90578415e+02  9.22892280e+02  3.17847461e+03
  1.26614222e+04  4.12580078e+04  1.05284981e+05  2.30457101e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.676671375493  E_coul = 198.68595316132266
cycle= 4 E= -507.99071821417  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170484
diis-c [-4.59857467e-10 -9.02752301e-06  6.93225845e-03 -9.94648767e-02
  1.09254165e+00]
  HOMO = -0.243083734476347  LUMO = 0.916691082961639
  mo_energy =
[-1.20327236e+02 -1.23814445e+01 -6.67840975e+00 -6.67840975e+00
 -6.67840975e+00 -1.17955726e+00 -2.43083734e-01 -2.43083734e-01
 -2.43083734e-01  9.16691083e-01  5.95926118e+00  2.44050515e+01
  8.81750677e+01  2.90578059e+02  9.22891919e+02  3.17847424e+03
  1.26614218e+04  4.12580074e+04  1.05284981e+05  2.30457100e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.6759436702854  E_coul = 198.6852254420878
cycle= 5 E= -507.990718228198  delta_E= -1.4e-08  |g|= 4.96e-06  |ddm|= 0.00064
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.2132e-06
diis-c [-7.61105459e-13  5.43004668e-07 -5.01764320e-04  6.85802999e-03
 -8.06620599e-02  1.07430525e+00]
  HOMO = -0.243086094486759  LUMO = 0.916690412672641
  mo_energy =
[-1.20327242e+02 -1.23814491e+01 -6.67841451e+00 -6.67841451e+00
 -6.67841451e+00 -1.17955889e+00 -2.43086094e-01 -2.43086094e-01
 -2.43086094e-01  9.16690413e-01  5.95925777e+00  2.44050471e+01
  8.81750627e+01  2.90578054e+02  9.22891914e+02  3.17847424e+03
  1.26614218e+04  4.12580074e+04  1.05284981e+05  2.30457100e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.6759317892577  E_coul = 198.68521356105515
cycle= 6 E= -507.990718228203  delta_E= -4.95e-12  |g|= 9.22e-08  |ddm|= 1.39e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6759317892577  E_coul = 198.68521356105515
  HOMO = -0.243086137247431  LUMO = 0.916690386889623
  mo_energy =
[-1.20327242e+02 -1.23814492e+01 -6.67841459e+00 -6.67841459e+00
 -6.67841459e+00 -1.17955891e+00 -2.43086137e-01 -2.43086137e-01
 -2.43086137e-01  9.16690387e-01  5.95925771e+00  2.44050470e+01
  8.81750626e+01  2.90578054e+02  9.22891914e+02  3.17847424e+03
  1.26614218e+04  4.12580074e+04  1.05284981e+05  2.30457100e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.6759315984732  E_coul = 198.6852133702702
Extra cycle  E= -507.990718228203  delta_E= -5.12e-13  |g|= 1.15e-08  |ddm|= 2.15e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913026.7760370299
E1 = -706.6759315984732  E_coul = 198.6852133702702
init E= -507.990718228203
    CPU time for initialize scf      5.76 sec, wall time      0.24 sec
  HOMO = -0.243086143394619  LUMO = 0.916690384781686
  mo_energy =
[-1.20327242e+02 -1.23814492e+01 -6.67841461e+00 -6.67841461e+00
 -6.67841461e+00 -1.17955891e+00 -2.43086143e-01 -2.43086143e-01
 -2.43086143e-01  9.16690385e-01  5.95925770e+00  2.44050470e+01
  8.81750626e+01  2.90578054e+02  9.22891914e+02  3.17847424e+03
  1.26614218e+04  4.12580074e+04  1.05284981e+05  2.30457100e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.6759315703891  E_coul = 198.68521334218642
cycle= 1 E= -507.990718228203  delta_E= 3.41e-13  |g|= 2.19e-09  |ddm|= 2.76e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.6759315703891  E_coul = 198.68521334218642
  HOMO = -0.243086144274034  LUMO = 0.916690383425014
  mo_energy =
[-1.20327242e+02 -1.23814492e+01 -6.67841461e+00 -6.67841461e+00
 -6.67841461e+00 -1.17955891e+00 -2.43086144e-01 -2.43086144e-01
 -2.43086144e-01  9.16690383e-01  5.95925770e+00  2.44050470e+01
  8.81750626e+01  2.90578054e+02  9.22891914e+02  3.17847424e+03
  1.26614218e+04  4.12580074e+04  1.05284981e+05  2.30457100e+05
  4.56263860e+05  8.45209900e+05  1.52838115e+06  2.85064114e+06
  5.80851893e+06]
E1 = -706.6759315661948  E_coul = 198.68521333799208
Extra cycle  E= -507.990718228203  delta_E=    0  |g|= 1.74e-09  |ddm|= 3.45e-09
    CPU time for scf_cycle      6.25 sec, wall time      0.42 sec
exp = [2.32853530e-01 6.10720803e-01 2.01664513e+00 1.17616812e+05
 4.35141928e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546951e+04 7.30191731e+03
 1.83757556e+04 1.44659754e+03 4.17652198e+02 1.48032754e+02
 6.03707975e+01 2.67828372e+01 9.40253821e+00 8.60424825e+00
 4.92748585e-01]
grad_E = [ 9.29693989e-05 -6.36286858e-05 -2.76022826e-05  6.01413945e-09
  1.94983014e-05  3.98990424e-11  1.72574688e-10  9.32918497e-10
  3.68532516e-09  1.53877359e-08  8.03198342e-08  5.07386417e-06
  1.96346048e-07 -3.96052739e-05  1.30151690e-05 -6.28096703e-05
  4.00868185e-06  5.92591358e-05 -6.38883347e-06 -1.64285988e-05
 -6.71895949e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232633993048       1
[INPUT] 0    0    [1    /1   ]  0.610037481092       1
[INPUT] 0    0    [1    /1   ]  2.00440622718        1
[INPUT] 0    0    [1    /1   ]  117616.812415        1
[INPUT] 0    0    [1    /1   ]  4.33822986174        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030848        1
[INPUT] 0    0    [1    /1   ]  147020.991032        1
[INPUT] 0    0    [1    /1   ]  73510.4163337        1
[INPUT] 0    0    [1    /1   ]  36754.6952005        1
[INPUT] 0    0    [1    /1   ]  7301.92218022        1
[INPUT] 0    0    [1    /1   ]  18375.7558079        1
[INPUT] 0    0    [1    /1   ]  1446.56062793        1
[INPUT] 0    0    [1    /1   ]  417.647317072        1
[INPUT] 0    0    [1    /1   ]  148.034985521        1
[INPUT] 0    0    [1    /1   ]  60.3421836981        1
[INPUT] 0    0    [1    /1   ]  26.7529244137        1
[INPUT] 0    0    [1    /1   ]  9.3898827515         1
[INPUT] 1    0    [1    /1   ]  8.60422918982        1
[INPUT] 1    0    [1    /1   ]  0.492746771197       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23263399304801657, 1.0]], [0, [0.6100374810924707, 1.0]], [0, [2.0044062271837952, 1.0]], [0, [117616.8124148469, 1.0]], [0, [4.338229861743526, 1.0]], [0, [1176168.1426102845, 1.0]], [0, [588084.0699429224, 1.0]], [0, [294042.0308478132, 1.0]], [0, [147020.99103242933, 1.0]], [0, [73510.41633367378, 1.0]], [0, [36754.695200517446, 1.0]], [0, [7301.922180221885, 1.0]], [0, [18375.755807854257, 1.0]], [0, [1446.5606279250903, 1.0]], [0, [417.6473170721576, 1.0]], [0, [148.0349855213939, 1.0]], [0, [60.34218369808897, 1.0]], [0, [26.752924413669202, 1.0]], [0, [9.389882751502853, 1.0]], [1, [8.604229189823227, 1.0]], [1, [0.49274677119704324, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23263399]
bas 1, expnt(s) = [0.61003748]
bas 2, expnt(s) = [2.00440623]
bas 3, expnt(s) = [117616.81241485]
bas 4, expnt(s) = [4.33822986]
bas 5, expnt(s) = [1176168.14261028]
bas 6, expnt(s) = [588084.06994292]
bas 7, expnt(s) = [294042.03084781]
bas 8, expnt(s) = [147020.99103243]
bas 9, expnt(s) = [73510.41633367]
bas 10, expnt(s) = [36754.69520052]
bas 11, expnt(s) = [7301.92218022]
bas 12, expnt(s) = [18375.75580785]
bas 13, expnt(s) = [1446.56062793]
bas 14, expnt(s) = [417.64731707]
bas 15, expnt(s) = [148.03498552]
bas 16, expnt(s) = [60.3421837]
bas 17, expnt(s) = [26.75292441]
bas 18, expnt(s) = [9.38988275]
bas 19, expnt(s) = [8.60422919]
bas 20, expnt(s) = [0.49274677]
CPU time:      1685.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32633993e-01 8.46291357e-01 6.10037481e-01 1.74394351e+00
 2.00440623e+00 4.25602658e+00 1.17616812e+05 1.60460107e+04
 4.33822986e+00 7.59450450e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546952e+04 6.70655736e+03 7.30192218e+03 1.99568928e+03
 1.83757558e+04 3.98748381e+03 1.44656063e+03 5.92607993e+02
 4.17647317e+02 2.33411525e+02 1.48034986e+02 1.07223085e+02
 6.03421837e+01 5.46991769e+01 2.67529244e+01 2.97196350e+01
 9.38988275e+00 1.35522109e+01 8.60422919e+00 4.29906840e+01
 4.92746771e-01 1.20438164e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3360712032784
cond(S) = 913017.967343028
E1 = -689.5958709617137  E_coul = 184.9708540394269
init E= -504.625016922287
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672186236815735  LUMO = 0.565884427977738
  mo_energy =
[-1.21709923e+02 -1.33863830e+01 -7.62364016e+00 -7.62364016e+00
 -7.62364016e+00 -1.65755507e+00 -6.72186237e-01 -6.72186237e-01
 -6.72186237e-01  5.65884428e-01  5.31774318e+00  2.34016154e+01
  8.67851997e+01  2.88930346e+02  9.21171428e+02  3.17679859e+03
  1.26598273e+04  4.12564885e+04  1.05283514e+05  2.30455670e+05
  4.56262456e+05  8.45208516e+05  1.52837978e+06  2.85063979e+06
  5.80851760e+06]
E1 = -707.7536710500892  E_coul = 199.78101486935785
cycle= 1 E= -507.972656180731  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.760625
diis-c [-0.57855088  1.        ]
  HOMO = -0.217660374810103  LUMO = 0.919524621782132
  mo_energy =
[-1.20200331e+02 -1.23048822e+01 -6.59410058e+00 -6.59410058e+00
 -6.59410058e+00 -1.16332683e+00 -2.17660375e-01 -2.17660375e-01
 -2.17660375e-01  9.19524622e-01  5.96531358e+00  2.43734277e+01
  8.80693779e+01  2.90385278e+02  9.22662831e+02  3.17823079e+03
  1.26611532e+04  4.12577473e+04  1.05284736e+05  2.30456868e+05
  4.56263636e+05  8.45209683e+05  1.52838094e+06  2.85064094e+06
  5.80851874e+06]
E1 = -706.799775270323  E_coul = 198.80932278702684
cycle= 2 E= -507.990452483296  delta_E= -0.0178  |g|= 0.0351  |ddm|=  0.4
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0339756
diis-c [-0.00115212 -0.00196581  1.00196581]
  HOMO = -0.239786583064912  LUMO = 0.915515340032452
  mo_energy =
[-1.20315119e+02 -1.23725391e+01 -6.66901922e+00 -6.66901922e+00
 -6.66901922e+00 -1.17756096e+00 -2.39786583e-01 -2.39786583e-01
 -2.39786583e-01  9.15515340e-01  5.93522582e+00  2.43145616e+01
  8.79843515e+01  2.90280339e+02  9.22542403e+02  3.17809605e+03
  1.26610082e+04  4.12575984e+04  1.05284585e+05  2.30456716e+05
  4.56263484e+05  8.45209531e+05  1.52838079e+06  2.85064079e+06
  5.80851859e+06]
E1 = -706.6917326964211  E_coul = 198.70101917453064
cycle= 3 E= -507.99071352189  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0036942
diis-c [-3.09184059e-06  1.07076072e-04 -1.06085269e-01  1.10597819e+00]
  HOMO = -0.242937093828843  LUMO = 0.914715996911402
  mo_energy =
[-1.20326907e+02 -1.23811120e+01 -6.67807930e+00 -6.67807930e+00
 -6.67807930e+00 -1.17946991e+00 -2.42937094e-01 -2.42937094e-01
 -2.42937094e-01  9.14715997e-01  5.93079159e+00  2.43069852e+01
  8.79745858e+01  2.90269201e+02  9.22530375e+02  3.17808331e+03
  1.26609950e+04  4.12575851e+04  1.05284572e+05  2.30456703e+05
  4.56263471e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6764621755592  E_coul = 198.68574362127808
cycle= 4 E= -507.990718554281  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170577
diis-c [-4.65328096e-10 -9.04619020e-06  6.93344670e-03 -9.93567230e-02
  1.09243232e+00]
  HOMO = -0.243088488280575  LUMO = 0.914668577419798
  mo_energy =
[-1.20327265e+02 -1.23814598e+01 -6.67842367e+00 -6.67842367e+00
 -6.67842367e+00 -1.17956142e+00 -2.43088488e-01 -2.43088488e-01
 -2.43088488e-01  9.14668577e-01  5.93057432e+00  2.43066714e+01
  8.79742394e+01  2.90268846e+02  9.22530016e+02  3.17808295e+03
  1.26609947e+04  4.12575847e+04  1.05284572e+05  2.30456702e+05
  4.56263470e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6757355469754  E_coul = 198.68501697866841
cycle= 5 E= -507.990718568307  delta_E= -1.4e-08  |g|= 5.01e-06  |ddm|= 0.000642
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.23566e-06
diis-c [-7.66790901e-13  5.54471842e-07 -5.05943462e-04  6.90571254e-03
 -8.13000130e-02  1.07489969e+00]
  HOMO = -0.243090868428308  LUMO = 0.914667900770378
  mo_energy =
[-1.20327271e+02 -1.23814645e+01 -6.67842846e+00 -6.67842846e+00
 -6.67842846e+00 -1.17956307e+00 -2.43090868e-01 -2.43090868e-01
 -2.43090868e-01  9.14667901e-01  5.93057090e+00  2.43066670e+01
  8.79742344e+01  2.90268841e+02  9.22530010e+02  3.17808294e+03
  1.26609947e+04  4.12575847e+04  1.05284572e+05  2.30456702e+05
  4.56263470e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6757235597545  E_coul = 198.68500499144233
cycle= 6 E= -507.990718568312  delta_E= -5.17e-12  |g|= 9.12e-08  |ddm|= 1.41e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757235597545  E_coul = 198.68500499144233
  HOMO = -0.243090911165219  LUMO = 0.914667875244956
  mo_energy =
[-1.20327271e+02 -1.23814646e+01 -6.67842854e+00 -6.67842854e+00
 -6.67842854e+00 -1.17956309e+00 -2.43090911e-01 -2.43090911e-01
 -2.43090911e-01  9.14667875e-01  5.93057083e+00  2.43066669e+01
  8.79742343e+01  2.90268840e+02  9.22530010e+02  3.17808294e+03
  1.26609947e+04  4.12575847e+04  1.05284572e+05  2.30456702e+05
  4.56263470e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6757233739055  E_coul = 198.68500480559365
Extra cycle  E= -507.990718568312  delta_E= 2.84e-13  |g|= 1.15e-08  |ddm|= 2.13e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
exp = [2.32633993e-01 6.10037481e-01 2.00440623e+00 1.17616812e+05
 4.33822986e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546952e+04 7.30192218e+03
 1.83757558e+04 1.44656063e+03 4.17647317e+02 1.48034986e+02
 6.03421837e+01 2.67529244e+01 9.38988275e+00 8.60422919e+00
 4.92746771e-01]
E = -507.9907185683119
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:08 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232633993048       1
[INPUT] 0    0    [1    /1   ]  0.610037481092       1
[INPUT] 0    0    [1    /1   ]  2.00440622718        1
[INPUT] 0    0    [1    /1   ]  117616.812415        1
[INPUT] 0    0    [1    /1   ]  4.33822986174        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030848        1
[INPUT] 0    0    [1    /1   ]  147020.991032        1
[INPUT] 0    0    [1    /1   ]  73510.4163337        1
[INPUT] 0    0    [1    /1   ]  36754.6952005        1
[INPUT] 0    0    [1    /1   ]  7301.92218022        1
[INPUT] 0    0    [1    /1   ]  18375.7558079        1
[INPUT] 0    0    [1    /1   ]  1446.56062793        1
[INPUT] 0    0    [1    /1   ]  417.647317072        1
[INPUT] 0    0    [1    /1   ]  148.034985521        1
[INPUT] 0    0    [1    /1   ]  60.3421836981        1
[INPUT] 0    0    [1    /1   ]  26.7529244137        1
[INPUT] 0    0    [1    /1   ]  9.3898827515         1
[INPUT] 1    0    [1    /1   ]  8.60422918982        1
[INPUT] 1    0    [1    /1   ]  0.492746771197       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23263399304801657, 1.0]], [0, [0.6100374810924707, 1.0]], [0, [2.0044062271837952, 1.0]], [0, [117616.8124148469, 1.0]], [0, [4.338229861743526, 1.0]], [0, [1176168.1426102845, 1.0]], [0, [588084.0699429224, 1.0]], [0, [294042.0308478132, 1.0]], [0, [147020.99103242933, 1.0]], [0, [73510.41633367378, 1.0]], [0, [36754.695200517446, 1.0]], [0, [7301.922180221885, 1.0]], [0, [18375.755807854257, 1.0]], [0, [1446.5606279250903, 1.0]], [0, [417.6473170721576, 1.0]], [0, [148.0349855213939, 1.0]], [0, [60.34218369808897, 1.0]], [0, [26.752924413669202, 1.0]], [0, [9.389882751502853, 1.0]], [1, [8.604229189823227, 1.0]], [1, [0.49274677119704324, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23263399]
bas 1, expnt(s) = [0.61003748]
bas 2, expnt(s) = [2.00440623]
bas 3, expnt(s) = [117616.81241485]
bas 4, expnt(s) = [4.33822986]
bas 5, expnt(s) = [1176168.14261028]
bas 6, expnt(s) = [588084.06994292]
bas 7, expnt(s) = [294042.03084781]
bas 8, expnt(s) = [147020.99103243]
bas 9, expnt(s) = [73510.41633367]
bas 10, expnt(s) = [36754.69520052]
bas 11, expnt(s) = [7301.92218022]
bas 12, expnt(s) = [18375.75580785]
bas 13, expnt(s) = [1446.56062793]
bas 14, expnt(s) = [417.64731707]
bas 15, expnt(s) = [148.03498552]
bas 16, expnt(s) = [60.3421837]
bas 17, expnt(s) = [26.75292441]
bas 18, expnt(s) = [9.38988275]
bas 19, expnt(s) = [8.60422919]
bas 20, expnt(s) = [0.49274677]
CPU time:      1687.97
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32633993e-01 8.46291357e-01 6.10037481e-01 1.74394351e+00
 2.00440623e+00 4.25602658e+00 1.17616812e+05 1.60460107e+04
 4.33822986e+00 7.59450450e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546952e+04 6.70655736e+03 7.30192218e+03 1.99568928e+03
 1.83757558e+04 3.98748381e+03 1.44656063e+03 5.92607993e+02
 4.17647317e+02 2.33411525e+02 1.48034986e+02 1.07223085e+02
 6.03421837e+01 5.46991769e+01 2.67529244e+01 2.97196350e+01
 9.38988275e+00 1.35522109e+01 8.60422919e+00 4.29906840e+01
 4.92746771e-01 1.20438164e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.3360712032784
cond(S) = 913017.967343028
E1 = -689.5958709617137  E_coul = 184.9708540394269
init E= -504.625016922287
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672186236815735  LUMO = 0.565884427977738
  mo_energy =
[-1.21709923e+02 -1.33863830e+01 -7.62364016e+00 -7.62364016e+00
 -7.62364016e+00 -1.65755507e+00 -6.72186237e-01 -6.72186237e-01
 -6.72186237e-01  5.65884428e-01  5.31774318e+00  2.34016154e+01
  8.67851997e+01  2.88930346e+02  9.21171428e+02  3.17679859e+03
  1.26598273e+04  4.12564885e+04  1.05283514e+05  2.30455670e+05
  4.56262456e+05  8.45208516e+05  1.52837978e+06  2.85063979e+06
  5.80851760e+06]
E1 = -707.7536710500892  E_coul = 199.78101486935785
cycle= 1 E= -507.972656180731  delta_E= -3.35  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.760625
diis-c [-0.57855088  1.        ]
  HOMO = -0.217660374810103  LUMO = 0.919524621782132
  mo_energy =
[-1.20200331e+02 -1.23048822e+01 -6.59410058e+00 -6.59410058e+00
 -6.59410058e+00 -1.16332683e+00 -2.17660375e-01 -2.17660375e-01
 -2.17660375e-01  9.19524622e-01  5.96531358e+00  2.43734277e+01
  8.80693779e+01  2.90385278e+02  9.22662831e+02  3.17823079e+03
  1.26611532e+04  4.12577473e+04  1.05284736e+05  2.30456868e+05
  4.56263636e+05  8.45209683e+05  1.52838094e+06  2.85064094e+06
  5.80851874e+06]
E1 = -706.799775270323  E_coul = 198.80932278702684
cycle= 2 E= -507.990452483296  delta_E= -0.0178  |g|= 0.0351  |ddm|=  0.4
    CPU time for cycle= 2      0.08 sec, wall time      0.03 sec
diis-norm(errvec)=0.0339756
diis-c [-0.00115212 -0.00196581  1.00196581]
  HOMO = -0.239786583064912  LUMO = 0.915515340032452
  mo_energy =
[-1.20315119e+02 -1.23725391e+01 -6.66901922e+00 -6.66901922e+00
 -6.66901922e+00 -1.17756096e+00 -2.39786583e-01 -2.39786583e-01
 -2.39786583e-01  9.15515340e-01  5.93522582e+00  2.43145616e+01
  8.79843515e+01  2.90280339e+02  9.22542403e+02  3.17809605e+03
  1.26610082e+04  4.12575984e+04  1.05284585e+05  2.30456716e+05
  4.56263484e+05  8.45209531e+05  1.52838079e+06  2.85064079e+06
  5.80851859e+06]
E1 = -706.6917326964211  E_coul = 198.70101917453064
cycle= 3 E= -507.99071352189  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0036942
diis-c [-3.09184059e-06  1.07076072e-04 -1.06085269e-01  1.10597819e+00]
  HOMO = -0.242937093828843  LUMO = 0.914715996911402
  mo_energy =
[-1.20326907e+02 -1.23811120e+01 -6.67807930e+00 -6.67807930e+00
 -6.67807930e+00 -1.17946991e+00 -2.42937094e-01 -2.42937094e-01
 -2.42937094e-01  9.14715997e-01  5.93079159e+00  2.43069852e+01
  8.79745858e+01  2.90269201e+02  9.22530375e+02  3.17808331e+03
  1.26609950e+04  4.12575851e+04  1.05284572e+05  2.30456703e+05
  4.56263471e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6764621755592  E_coul = 198.68574362127808
cycle= 4 E= -507.990718554281  delta_E= -5.03e-06  |g|= 0.000233  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170577
diis-c [-4.65328096e-10 -9.04619020e-06  6.93344670e-03 -9.93567230e-02
  1.09243232e+00]
  HOMO = -0.243088488280575  LUMO = 0.914668577419798
  mo_energy =
[-1.20327265e+02 -1.23814598e+01 -6.67842367e+00 -6.67842367e+00
 -6.67842367e+00 -1.17956142e+00 -2.43088488e-01 -2.43088488e-01
 -2.43088488e-01  9.14668577e-01  5.93057432e+00  2.43066714e+01
  8.79742394e+01  2.90268846e+02  9.22530016e+02  3.17808295e+03
  1.26609947e+04  4.12575847e+04  1.05284572e+05  2.30456702e+05
  4.56263470e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6757355469754  E_coul = 198.68501697866841
cycle= 5 E= -507.990718568307  delta_E= -1.4e-08  |g|= 5.01e-06  |ddm|= 0.000642
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.23566e-06
diis-c [-7.66790901e-13  5.54471842e-07 -5.05943462e-04  6.90571254e-03
 -8.13000130e-02  1.07489969e+00]
  HOMO = -0.243090868428308  LUMO = 0.914667900770378
  mo_energy =
[-1.20327271e+02 -1.23814645e+01 -6.67842846e+00 -6.67842846e+00
 -6.67842846e+00 -1.17956307e+00 -2.43090868e-01 -2.43090868e-01
 -2.43090868e-01  9.14667901e-01  5.93057090e+00  2.43066670e+01
  8.79742344e+01  2.90268841e+02  9.22530010e+02  3.17808294e+03
  1.26609947e+04  4.12575847e+04  1.05284572e+05  2.30456702e+05
  4.56263470e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6757235597545  E_coul = 198.68500499144233
cycle= 6 E= -507.990718568312  delta_E= -5.17e-12  |g|= 9.12e-08  |ddm|= 1.41e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6757235597545  E_coul = 198.68500499144233
  HOMO = -0.243090911165219  LUMO = 0.914667875244956
  mo_energy =
[-1.20327271e+02 -1.23814646e+01 -6.67842854e+00 -6.67842854e+00
 -6.67842854e+00 -1.17956309e+00 -2.43090911e-01 -2.43090911e-01
 -2.43090911e-01  9.14667875e-01  5.93057083e+00  2.43066669e+01
  8.79742343e+01  2.90268840e+02  9.22530010e+02  3.17808294e+03
  1.26609947e+04  4.12575847e+04  1.05284572e+05  2.30456702e+05
  4.56263470e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6757233739055  E_coul = 198.68500480559365
Extra cycle  E= -507.990718568312  delta_E= 2.84e-13  |g|= 1.15e-08  |ddm|= 2.13e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913017.967343028
E1 = -706.6757233739055  E_coul = 198.68500480559365
init E= -507.990718568312
    CPU time for initialize scf      5.65 sec, wall time      0.24 sec
  HOMO = -0.243090917196878  LUMO = 0.91466787352218
  mo_energy =
[-1.20327271e+02 -1.23814646e+01 -6.67842856e+00 -6.67842856e+00
 -6.67842856e+00 -1.17956309e+00 -2.43090917e-01 -2.43090917e-01
 -2.43090917e-01  9.14667874e-01  5.93057083e+00  2.43066669e+01
  8.79742343e+01  2.90268840e+02  9.22530010e+02  3.17808294e+03
  1.26609947e+04  4.12575847e+04  1.05284572e+05  2.30456702e+05
  4.56263470e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6757233435554  E_coul = 198.68500477524364
cycle= 1 E= -507.990718568312  delta_E= 1.14e-13  |g|= 1.79e-09  |ddm|= 2.87e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6757233435554  E_coul = 198.68500477524364
  HOMO = -0.243090918129924  LUMO = 0.914667873128949
  mo_energy =
[-1.20327271e+02 -1.23814646e+01 -6.67842856e+00 -6.67842856e+00
 -6.67842856e+00 -1.17956309e+00 -2.43090918e-01 -2.43090918e-01
 -2.43090918e-01  9.14667873e-01  5.93057082e+00  2.43066669e+01
  8.79742343e+01  2.90268840e+02  9.22530010e+02  3.17808294e+03
  1.26609947e+04  4.12575847e+04  1.05284572e+05  2.30456702e+05
  4.56263470e+05  8.45209517e+05  1.52838077e+06  2.85064077e+06
  5.80851857e+06]
E1 = -706.6757233389368  E_coul = 198.68500477062474
Extra cycle  E= -507.990718568312  delta_E= -2.84e-13  |g|= 1.85e-09  |ddm|= 4.09e-09
    CPU time for scf_cycle      6.17 sec, wall time      0.40 sec
exp = [2.32633993e-01 6.10037481e-01 2.00440623e+00 1.17616812e+05
 4.33822986e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546952e+04 7.30192218e+03
 1.83757558e+04 1.44656063e+03 4.17647317e+02 1.48034986e+02
 6.03421837e+01 2.67529244e+01 9.38988275e+00 8.60422919e+00
 4.92746771e-01]
grad_E = [ 1.87975981e-04 -1.26007328e-04 -5.27629166e-05  6.01344217e-09
  3.94983697e-05  3.98912064e-11  1.72551854e-10  9.32811567e-10
  3.68489351e-09  1.53859090e-08  8.03109191e-08  5.07314585e-06
  1.96317714e-07 -3.95479112e-05  1.24375496e-05 -6.08966851e-05
  1.67717437e-06  5.99790472e-05 -9.58352281e-06 -3.10811899e-05
 -1.32522164e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:16 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232210335779       1
[INPUT] 0    0    [1    /1   ]  0.608666206236       1
[INPUT] 0    0    [1    /1   ]  1.97981938882        1
[INPUT] 0    0    [1    /1   ]  117616.812424        1
[INPUT] 0    0    [1    /1   ]  4.30871088716        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030849        1
[INPUT] 0    0    [1    /1   ]  147020.991038        1
[INPUT] 0    0    [1    /1   ]  73510.4163567        1
[INPUT] 0    0    [1    /1   ]  36754.6953206        1
[INPUT] 0    0    [1    /1   ]  7301.92975012        1
[INPUT] 0    0    [1    /1   ]  18375.7561025        1
[INPUT] 0    0    [1    /1   ]  1446.50339396        1
[INPUT] 0    0    [1    /1   ]  417.638397073        1
[INPUT] 0    0    [1    /1   ]  148.04307189         1
[INPUT] 0    0    [1    /1   ]  60.2969719597        1
[INPUT] 0    0    [1    /1   ]  26.6987102167        1
[INPUT] 0    0    [1    /1   ]  9.35711396143        1
[INPUT] 1    0    [1    /1   ]  8.6042006612         1
[INPUT] 1    0    [1    /1   ]  0.492743956643       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23221033577933894, 1.0]], [0, [0.6086662062363652, 1.0]], [0, [1.9798193888170408, 1.0]], [0, [117616.81242384612, 1.0]], [0, [4.30871088715693, 1.0]], [0, [1176168.1426103446, 1.0]], [0, [588084.069943181, 1.0]], [0, [294042.030849209, 1.0]], [0, [147020.99103794445, 1.0]], [0, [73510.4163567045, 1.0]], [0, [36754.695320629544, 1.0]], [0, [7301.929750124467, 1.0]], [0, [18375.756102473446, 1.0]], [0, [1446.503393963792, 1.0]], [0, [417.638397072976, 1.0]], [0, [148.04307189017166, 1.0]], [0, [60.29697195966456, 1.0]], [0, [26.698710216739073, 1.0]], [0, [9.357113961427165, 1.0]], [1, [8.60420066119564, 1.0]], [1, [0.49274395664275755, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23221034]
bas 1, expnt(s) = [0.60866621]
bas 2, expnt(s) = [1.97981939]
bas 3, expnt(s) = [117616.81242385]
bas 4, expnt(s) = [4.30871089]
bas 5, expnt(s) = [1176168.14261034]
bas 6, expnt(s) = [588084.06994318]
bas 7, expnt(s) = [294042.03084921]
bas 8, expnt(s) = [147020.99103794]
bas 9, expnt(s) = [73510.4163567]
bas 10, expnt(s) = [36754.69532063]
bas 11, expnt(s) = [7301.92975012]
bas 12, expnt(s) = [18375.75610247]
bas 13, expnt(s) = [1446.50339396]
bas 14, expnt(s) = [417.63839707]
bas 15, expnt(s) = [148.04307189]
bas 16, expnt(s) = [60.29697196]
bas 17, expnt(s) = [26.69871022]
bas 18, expnt(s) = [9.35711396]
bas 19, expnt(s) = [8.60420066]
bas 20, expnt(s) = [0.49274396]
CPU time:      1702.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32210336e-01 8.45135188e-01 6.08666206e-01 1.74100259e+00
 1.97981939e+00 4.21681166e+00 1.17616812e+05 1.60460107e+04
 4.30871089e+00 7.55571451e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104164e+04 1.12791582e+04
 3.67546953e+04 6.70655738e+03 7.30192975e+03 1.99569083e+03
 1.83757561e+04 3.98748386e+03 1.44650339e+03 5.92590407e+02
 4.17638397e+02 2.33407786e+02 1.48043072e+02 1.07227478e+02
 6.02969720e+01 5.46684363e+01 2.66987102e+01 2.96744539e+01
 9.35711396e+00 1.35167245e+01 8.60420066e+00 4.29905058e+01
 4.92743957e-01 1.20437304e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336076750195236
cond(S) = 913000.8323690358
E1 = -689.5956546044301  E_coul = 184.9706621466489
init E= -504.624992457781
    CPU time for initialize scf      4.35 sec, wall time      0.23 sec
  HOMO = -0.672189485401399  LUMO = 0.562667523637939
  mo_energy =
[-1.21709955e+02 -1.33863959e+01 -7.62365188e+00 -7.62365188e+00
 -7.62365188e+00 -1.65756100e+00 -6.72189485e-01 -6.72189485e-01
 -6.72189485e-01  5.62667524e-01  5.26127824e+00  2.31915227e+01
  8.63582923e+01  2.88311502e+02  9.20478470e+02  3.17607431e+03
  1.26590610e+04  4.12557366e+04  1.05282787e+05  2.30454963e+05
  4.56261764e+05  8.45207836e+05  1.52837911e+06  2.85063914e+06
  5.80851696e+06]
E1 = -707.7534975239173  E_coul = 199.78084217847316
cycle= 1 E= -507.972655345444  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.760508
diis-c [-0.57837316  1.        ]
  HOMO = -0.217664493444837  LUMO = 0.91544700714059
  mo_energy =
[-1.20200360e+02 -1.23048939e+01 -6.59411015e+00 -6.59411015e+00
 -6.59411015e+00 -1.16333162e+00 -2.17664493e-01 -2.17664493e-01
 -2.17664493e-01  9.15447007e-01  5.90608642e+00  2.41615164e+01
  8.76420400e+01  2.89766429e+02  9.21969897e+02  3.17750652e+03
  1.26603869e+04  4.12569954e+04  1.05284009e+05  2.30456161e+05
  4.56262944e+05  8.45209003e+05  1.52838027e+06  2.85064028e+06
  5.80851810e+06]
E1 = -706.7995086357422  E_coul = 198.8090554097217
cycle= 2 E= -507.99045322602  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.399
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0340706
diis-c [-0.00115844 -0.00202755  1.00202755]
  HOMO = -0.239793648276069  LUMO = 0.911477658151446
  mo_energy =
[-1.20315166e+02 -1.23725622e+01 -6.66904133e+00 -6.66904133e+00
 -6.66904133e+00 -1.17756781e+00 -2.39793648e-01 -2.39793648e-01
 -2.39793648e-01  9.11477658e-01  5.87623046e+00  2.41028017e+01
  8.75570494e+01  2.89661480e+02  9.21849448e+02  3.17737176e+03
  1.26602419e+04  4.12568465e+04  1.05283858e+05  2.30456009e+05
  4.56262792e+05  8.45208850e+05  1.52838012e+06  2.85064013e+06
  5.80851795e+06]
E1 = -706.69143062416  E_coul = 198.7007162229983
cycle= 3 E= -507.990714401162  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00371067
diis-c [-3.10843099e-06  1.04754536e-04 -1.06339989e-01  1.10623523e+00]
  HOMO = -0.242945137588087  LUMO = 0.91068419765593
  mo_energy =
[-1.20326953e+02 -1.23811358e+01 -6.67810185e+00 -6.67810185e+00
 -6.67810185e+00 -1.17947742e+00 -2.42945138e-01 -2.42945138e-01
 -2.42945138e-01  9.10684198e-01  5.87182507e+00  2.40952403e+01
  8.75472876e+01  2.89650342e+02  9.21837421e+02  3.17735902e+03
  1.26602287e+04  4.12568331e+04  1.05283845e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851794e+06]
E1 = -706.6761505573782  E_coul = 198.68543111632752
cycle= 4 E= -507.990719441051  delta_E= -5.04e-06  |g|= 0.000233  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017073
diis-c [-4.76221219e-10 -9.08685577e-06  6.93590851e-03 -9.91297951e-02
  1.09220297e+00]
  HOMO = -0.243095974423452  LUMO = 0.910637163369397
  mo_energy =
[-1.20327308e+02 -1.23814816e+01 -6.67844401e+00 -6.67844401e+00
 -6.67844401e+00 -1.17956862e+00 -2.43095974e-01 -2.43095974e-01
 -2.43095974e-01  9.10637163e-01  5.87160981e+00  2.40949287e+01
  8.75469437e+01  2.89649990e+02  9.21837065e+02  3.17735866e+03
  1.26602283e+04  4.12568328e+04  1.05283844e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851793e+06]
E1 = -706.6754262788531  E_coul = 198.6847068237851
cycle= 5 E= -507.990719455068  delta_E= -1.4e-08  |g|= 5.12e-06  |ddm|= 0.000645
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.28038e-06
diis-c [-7.87822959e-13  5.55394404e-07 -5.12606301e-04  6.97869707e-03
 -8.23693555e-02  1.07590271e+00]
  HOMO = -0.243098394561324  LUMO = 0.910636477773938
  mo_energy =
[-1.20327313e+02 -1.23814864e+01 -6.67844887e+00 -6.67844887e+00
 -6.67844887e+00 -1.17957029e+00 -2.43098395e-01 -2.43098395e-01
 -2.43098395e-01  9.10636478e-01  5.87160634e+00  2.40949242e+01
  8.75469386e+01  2.89649985e+02  9.21837059e+02  3.17735866e+03
  1.26602283e+04  4.12568327e+04  1.05283844e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851793e+06]
E1 = -706.6754140838158  E_coul = 198.68469462874265
cycle= 6 E= -507.990719455073  delta_E= -5.06e-12  |g|= 9.18e-08  |ddm|= 1.45e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6754140838158  E_coul = 198.68469462874265
  HOMO = -0.243098437208269  LUMO = 0.910636453435513
  mo_energy =
[-1.20327313e+02 -1.23814865e+01 -6.67844896e+00 -6.67844896e+00
 -6.67844896e+00 -1.17957031e+00 -2.43098437e-01 -2.43098437e-01
 -2.43098437e-01  9.10636453e-01  5.87160627e+00  2.40949241e+01
  8.75469385e+01  2.89649985e+02  9.21837059e+02  3.17735866e+03
  1.26602283e+04  4.12568327e+04  1.05283844e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851793e+06]
E1 = -706.6754138933869  E_coul = 198.68469443831424
Extra cycle  E= -507.990719455073  delta_E= 4.55e-13  |g|= 1.1e-08  |ddm|= 2.17e-07
    CPU time for scf_cycle      5.14 sec, wall time      0.45 sec
exp = [2.32210336e-01 6.08666206e-01 1.97981939e+00 1.17616812e+05
 4.30871089e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104164e+04 3.67546953e+04 7.30192975e+03
 1.83757561e+04 1.44650339e+03 4.17638397e+02 1.48043072e+02
 6.02969720e+01 2.66987102e+01 9.35711396e+00 8.60420066e+00
 4.92743957e-01]
E = -507.9907194550727
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:17 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.232210335779       1
[INPUT] 0    0    [1    /1   ]  0.608666206236       1
[INPUT] 0    0    [1    /1   ]  1.97981938882        1
[INPUT] 0    0    [1    /1   ]  117616.812424        1
[INPUT] 0    0    [1    /1   ]  4.30871088716        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030849        1
[INPUT] 0    0    [1    /1   ]  147020.991038        1
[INPUT] 0    0    [1    /1   ]  73510.4163567        1
[INPUT] 0    0    [1    /1   ]  36754.6953206        1
[INPUT] 0    0    [1    /1   ]  7301.92975012        1
[INPUT] 0    0    [1    /1   ]  18375.7561025        1
[INPUT] 0    0    [1    /1   ]  1446.50339396        1
[INPUT] 0    0    [1    /1   ]  417.638397073        1
[INPUT] 0    0    [1    /1   ]  148.04307189         1
[INPUT] 0    0    [1    /1   ]  60.2969719597        1
[INPUT] 0    0    [1    /1   ]  26.6987102167        1
[INPUT] 0    0    [1    /1   ]  9.35711396143        1
[INPUT] 1    0    [1    /1   ]  8.6042006612         1
[INPUT] 1    0    [1    /1   ]  0.492743956643       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23221033577933894, 1.0]], [0, [0.6086662062363652, 1.0]], [0, [1.9798193888170408, 1.0]], [0, [117616.81242384612, 1.0]], [0, [4.30871088715693, 1.0]], [0, [1176168.1426103446, 1.0]], [0, [588084.069943181, 1.0]], [0, [294042.030849209, 1.0]], [0, [147020.99103794445, 1.0]], [0, [73510.4163567045, 1.0]], [0, [36754.695320629544, 1.0]], [0, [7301.929750124467, 1.0]], [0, [18375.756102473446, 1.0]], [0, [1446.503393963792, 1.0]], [0, [417.638397072976, 1.0]], [0, [148.04307189017166, 1.0]], [0, [60.29697195966456, 1.0]], [0, [26.698710216739073, 1.0]], [0, [9.357113961427165, 1.0]], [1, [8.60420066119564, 1.0]], [1, [0.49274395664275755, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23221034]
bas 1, expnt(s) = [0.60866621]
bas 2, expnt(s) = [1.97981939]
bas 3, expnt(s) = [117616.81242385]
bas 4, expnt(s) = [4.30871089]
bas 5, expnt(s) = [1176168.14261034]
bas 6, expnt(s) = [588084.06994318]
bas 7, expnt(s) = [294042.03084921]
bas 8, expnt(s) = [147020.99103794]
bas 9, expnt(s) = [73510.4163567]
bas 10, expnt(s) = [36754.69532063]
bas 11, expnt(s) = [7301.92975012]
bas 12, expnt(s) = [18375.75610247]
bas 13, expnt(s) = [1446.50339396]
bas 14, expnt(s) = [417.63839707]
bas 15, expnt(s) = [148.04307189]
bas 16, expnt(s) = [60.29697196]
bas 17, expnt(s) = [26.69871022]
bas 18, expnt(s) = [9.35711396]
bas 19, expnt(s) = [8.60420066]
bas 20, expnt(s) = [0.49274396]
CPU time:      1708.83
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32210336e-01 8.45135188e-01 6.08666206e-01 1.74100259e+00
 1.97981939e+00 4.21681166e+00 1.17616812e+05 1.60460107e+04
 4.30871089e+00 7.55571451e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104164e+04 1.12791582e+04
 3.67546953e+04 6.70655738e+03 7.30192975e+03 1.99569083e+03
 1.83757561e+04 3.98748386e+03 1.44650339e+03 5.92590407e+02
 4.17638397e+02 2.33407786e+02 1.48043072e+02 1.07227478e+02
 6.02969720e+01 5.46684363e+01 2.66987102e+01 2.96744539e+01
 9.35711396e+00 1.35167245e+01 8.60420066e+00 4.29905058e+01
 4.92743957e-01 1.20437304e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336076750195236
cond(S) = 913000.8323690358
E1 = -689.5956546044301  E_coul = 184.9706621466489
init E= -504.624992457781
    CPU time for initialize scf      2.51 sec, wall time      0.15 sec
  HOMO = -0.672189485401399  LUMO = 0.562667523637939
  mo_energy =
[-1.21709955e+02 -1.33863959e+01 -7.62365188e+00 -7.62365188e+00
 -7.62365188e+00 -1.65756100e+00 -6.72189485e-01 -6.72189485e-01
 -6.72189485e-01  5.62667524e-01  5.26127824e+00  2.31915227e+01
  8.63582923e+01  2.88311502e+02  9.20478470e+02  3.17607431e+03
  1.26590610e+04  4.12557366e+04  1.05282787e+05  2.30454963e+05
  4.56261764e+05  8.45207836e+05  1.52837911e+06  2.85063914e+06
  5.80851696e+06]
E1 = -707.7534975239173  E_coul = 199.78084217847316
cycle= 1 E= -507.972655345444  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.760508
diis-c [-0.57837316  1.        ]
  HOMO = -0.217664493444837  LUMO = 0.91544700714059
  mo_energy =
[-1.20200360e+02 -1.23048939e+01 -6.59411015e+00 -6.59411015e+00
 -6.59411015e+00 -1.16333162e+00 -2.17664493e-01 -2.17664493e-01
 -2.17664493e-01  9.15447007e-01  5.90608642e+00  2.41615164e+01
  8.76420400e+01  2.89766429e+02  9.21969897e+02  3.17750652e+03
  1.26603869e+04  4.12569954e+04  1.05284009e+05  2.30456161e+05
  4.56262944e+05  8.45209003e+05  1.52838027e+06  2.85064028e+06
  5.80851810e+06]
E1 = -706.7995086357422  E_coul = 198.8090554097217
cycle= 2 E= -507.99045322602  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.399
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0340706
diis-c [-0.00115844 -0.00202755  1.00202755]
  HOMO = -0.239793648276069  LUMO = 0.911477658151446
  mo_energy =
[-1.20315166e+02 -1.23725622e+01 -6.66904133e+00 -6.66904133e+00
 -6.66904133e+00 -1.17756781e+00 -2.39793648e-01 -2.39793648e-01
 -2.39793648e-01  9.11477658e-01  5.87623046e+00  2.41028017e+01
  8.75570494e+01  2.89661480e+02  9.21849448e+02  3.17737176e+03
  1.26602419e+04  4.12568465e+04  1.05283858e+05  2.30456009e+05
  4.56262792e+05  8.45208850e+05  1.52838012e+06  2.85064013e+06
  5.80851795e+06]
E1 = -706.69143062416  E_coul = 198.7007162229983
cycle= 3 E= -507.990714401162  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0603
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00371067
diis-c [-3.10843099e-06  1.04754536e-04 -1.06339989e-01  1.10623523e+00]
  HOMO = -0.242945137588087  LUMO = 0.91068419765593
  mo_energy =
[-1.20326953e+02 -1.23811358e+01 -6.67810185e+00 -6.67810185e+00
 -6.67810185e+00 -1.17947742e+00 -2.42945138e-01 -2.42945138e-01
 -2.42945138e-01  9.10684198e-01  5.87182507e+00  2.40952403e+01
  8.75472876e+01  2.89650342e+02  9.21837421e+02  3.17735902e+03
  1.26602287e+04  4.12568331e+04  1.05283845e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851794e+06]
E1 = -706.6761505573782  E_coul = 198.68543111632752
cycle= 4 E= -507.990719441051  delta_E= -5.04e-06  |g|= 0.000233  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017073
diis-c [-4.76221219e-10 -9.08685577e-06  6.93590851e-03 -9.91297951e-02
  1.09220297e+00]
  HOMO = -0.243095974423452  LUMO = 0.910637163369397
  mo_energy =
[-1.20327308e+02 -1.23814816e+01 -6.67844401e+00 -6.67844401e+00
 -6.67844401e+00 -1.17956862e+00 -2.43095974e-01 -2.43095974e-01
 -2.43095974e-01  9.10637163e-01  5.87160981e+00  2.40949287e+01
  8.75469437e+01  2.89649990e+02  9.21837065e+02  3.17735866e+03
  1.26602283e+04  4.12568328e+04  1.05283844e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851793e+06]
E1 = -706.6754262788531  E_coul = 198.6847068237851
cycle= 5 E= -507.990719455068  delta_E= -1.4e-08  |g|= 5.12e-06  |ddm|= 0.000645
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.28038e-06
diis-c [-7.87822959e-13  5.55394404e-07 -5.12606301e-04  6.97869707e-03
 -8.23693555e-02  1.07590271e+00]
  HOMO = -0.243098394561324  LUMO = 0.910636477773938
  mo_energy =
[-1.20327313e+02 -1.23814864e+01 -6.67844887e+00 -6.67844887e+00
 -6.67844887e+00 -1.17957029e+00 -2.43098395e-01 -2.43098395e-01
 -2.43098395e-01  9.10636478e-01  5.87160634e+00  2.40949242e+01
  8.75469386e+01  2.89649985e+02  9.21837059e+02  3.17735866e+03
  1.26602283e+04  4.12568327e+04  1.05283844e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851793e+06]
E1 = -706.6754140838158  E_coul = 198.68469462874265
cycle= 6 E= -507.990719455073  delta_E= -5.06e-12  |g|= 9.18e-08  |ddm|= 1.45e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6754140838158  E_coul = 198.68469462874265
  HOMO = -0.243098437208269  LUMO = 0.910636453435513
  mo_energy =
[-1.20327313e+02 -1.23814865e+01 -6.67844896e+00 -6.67844896e+00
 -6.67844896e+00 -1.17957031e+00 -2.43098437e-01 -2.43098437e-01
 -2.43098437e-01  9.10636453e-01  5.87160627e+00  2.40949241e+01
  8.75469385e+01  2.89649985e+02  9.21837059e+02  3.17735866e+03
  1.26602283e+04  4.12568327e+04  1.05283844e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851793e+06]
E1 = -706.6754138933869  E_coul = 198.68469443831424
Extra cycle  E= -507.990719455073  delta_E= 4.55e-13  |g|= 1.1e-08  |ddm|= 2.17e-07
    CPU time for scf_cycle      3.35 sec, wall time      0.37 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913000.8323690358
E1 = -706.6754138933869  E_coul = 198.68469443831424
init E= -507.990719455073
    CPU time for initialize scf      5.84 sec, wall time      0.25 sec
  HOMO = -0.243098443363149  LUMO = 0.910636452062747
  mo_energy =
[-1.20327313e+02 -1.23814865e+01 -6.67844897e+00 -6.67844897e+00
 -6.67844897e+00 -1.17957031e+00 -2.43098443e-01 -2.43098443e-01
 -2.43098443e-01  9.10636452e-01  5.87160626e+00  2.40949241e+01
  8.75469385e+01  2.89649984e+02  9.21837059e+02  3.17735866e+03
  1.26602283e+04  4.12568327e+04  1.05283844e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851793e+06]
E1 = -706.67541386181  E_coul = 198.6846944067367
cycle= 1 E= -507.990719455073  delta_E= -5.68e-13  |g|= 1.35e-09  |ddm|= 2.99e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.67541386181  E_coul = 198.6846944067367
  HOMO = -0.243098444331314  LUMO = 0.910636450219991
  mo_energy =
[-1.20327313e+02 -1.23814865e+01 -6.67844897e+00 -6.67844897e+00
 -6.67844897e+00 -1.17957031e+00 -2.43098444e-01 -2.43098444e-01
 -2.43098444e-01  9.10636450e-01  5.87160626e+00  2.40949241e+01
  8.75469385e+01  2.89649984e+02  9.21837059e+02  3.17735866e+03
  1.26602283e+04  4.12568327e+04  1.05283844e+05  2.30455996e+05
  4.56262779e+05  8.45208837e+05  1.52838010e+06  2.85064012e+06
  5.80851793e+06]
E1 = -706.6754138615453  E_coul = 198.68469440647195
Extra cycle  E= -507.990719455073  delta_E= -5.68e-14  |g|= 1.37e-09  |ddm|= 1.3e-09
    CPU time for scf_cycle      6.36 sec, wall time      0.42 sec
exp = [2.32210336e-01 6.08666206e-01 1.97981939e+00 1.17616812e+05
 4.30871089e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104164e+04 3.67546953e+04 7.30192975e+03
 1.83757561e+04 1.44650339e+03 4.17638397e+02 1.48043072e+02
 6.02969720e+01 2.66987102e+01 9.35711396e+00 8.60420066e+00
 4.92743957e-01]
grad_E = [ 3.45630295e-04 -2.23622112e-04 -9.01358155e-05  6.01189806e-09
  6.96492996e-05  3.98738458e-11  1.72501271e-10  9.32574736e-10
  3.68393751e-09  1.53818635e-08  8.02912387e-08  5.07165898e-06
  1.96254694e-07 -3.94448291e-05  1.14613441e-05 -5.78679663e-05
 -1.55687800e-06  6.07177661e-05 -1.45522921e-05 -5.30368707e-05
 -2.32504941e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:25 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.231296076024       1
[INPUT] 0    0    [1    /1   ]  0.605673269622       1
[INPUT] 0    0    [1    /1   ]  1.92633976949        1
[INPUT] 0    0    [1    /1   ]  117616.812437        1
[INPUT] 0    0    [1    /1   ]  4.23867705396        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069944        1
[INPUT] 0    0    [1    /1   ]  294042.030851        1
[INPUT] 0    0    [1    /1   ]  147020.991046        1
[INPUT] 0    0    [1    /1   ]  73510.416391         1
[INPUT] 0    0    [1    /1   ]  36754.6954993        1
[INPUT] 0    0    [1    /1   ]  7301.9410107         1
[INPUT] 0    0    [1    /1   ]  18375.756541         1
[INPUT] 0    0    [1    /1   ]  1446.41851777        1
[INPUT] 0    0    [1    /1   ]  417.621257139        1
[INPUT] 0    0    [1    /1   ]  148.068521648        1
[INPUT] 0    0    [1    /1   ]  60.2268103536        1
[INPUT] 0    0    [1    /1   ]  26.596661242         1
[INPUT] 0    0    [1    /1   ]  9.27196477778        1
[INPUT] 1    0    [1    /1   ]  8.60415960086        1
[INPUT] 1    0    [1    /1   ]  0.49273988801        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23129607602367086, 1.0]], [0, [0.6056732696221808, 1.0]], [0, [1.926339769491911, 1.0]], [0, [117616.81243723641, 1.0]], [0, [4.238677053962792, 1.0]], [0, [1176168.142610434, 1.0]], [0, [588084.0699435659, 1.0]], [0, [294042.03085128585, 1.0]], [0, [147020.99104615068, 1.0]], [0, [73510.41639097354, 1.0]], [0, [36754.69549933966, 1.0]], [0, [7301.941010703977, 1.0]], [0, [18375.756540955354, 1.0]], [0, [1446.41851777488, 1.0]], [0, [417.62125713897956, 1.0]], [0, [148.06852164761102, 1.0]], [0, [60.226810353635, 1.0]], [0, [26.596661242020385, 1.0]], [0, [9.271964777775423, 1.0]], [1, [8.604159600861973, 1.0]], [1, [0.4927398880102131, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23129608]
bas 1, expnt(s) = [0.60567327]
bas 2, expnt(s) = [1.92633977]
bas 3, expnt(s) = [117616.81243724]
bas 4, expnt(s) = [4.23867705]
bas 5, expnt(s) = [1176168.14261043]
bas 6, expnt(s) = [588084.06994357]
bas 7, expnt(s) = [294042.03085129]
bas 8, expnt(s) = [147020.99104615]
bas 9, expnt(s) = [73510.41639097]
bas 10, expnt(s) = [36754.69549934]
bas 11, expnt(s) = [7301.9410107]
bas 12, expnt(s) = [18375.75654096]
bas 13, expnt(s) = [1446.41851777]
bas 14, expnt(s) = [417.62125714]
bas 15, expnt(s) = [148.06852165]
bas 16, expnt(s) = [60.22681035]
bas 17, expnt(s) = [26.59666124]
bas 18, expnt(s) = [9.27196478]
bas 19, expnt(s) = [8.6041596]
bas 20, expnt(s) = [0.49273989]
CPU time:      1725.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.31296076e-01 8.42638354e-01 6.05673270e-01 1.73457798e+00
 1.92633977e+00 4.13109034e+00 1.17616812e+05 1.60460107e+04
 4.23867705e+00 7.46341809e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104164e+04 1.12791582e+04
 3.67546955e+04 6.70655740e+03 7.30194101e+03 1.99569314e+03
 1.83757565e+04 3.98748393e+03 1.44641852e+03 5.92564329e+02
 4.17621257e+02 2.33400602e+02 1.48068522e+02 1.07241302e+02
 6.02268104e+01 5.46207201e+01 2.65966612e+01 2.95893460e+01
 9.27196478e+00 1.34243682e+01 8.60415960e+00 4.29902494e+01
 4.92739888e-01 1.20436061e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608625513774
cond(S) = 912965.431955845
E1 = -689.595411082768  E_coul = 184.97043832265342
init E= -504.624972760115
    CPU time for initialize scf      3.58 sec, wall time      0.19 sec
  HOMO = -0.672192571781641  LUMO = 0.555654845245141
  mo_energy =
[-1.21709997e+02 -1.33864074e+01 -7.62366449e+00 -7.62366449e+00
 -7.62366449e+00 -1.65757286e+00 -6.72192572e-01 -6.72192572e-01
 -6.72192572e-01  5.55654845e-01  5.13640078e+00  2.27083361e+01
  8.53912989e+01  2.86994425e+02  9.19073941e+02  3.17466425e+03
  1.26576272e+04  4.12543459e+04  1.05281444e+05  2.30453658e+05
  4.56260486e+05  8.45206579e+05  1.52837788e+06  2.85063793e+06
  5.80851578e+06]
E1 = -707.7533952457613  E_coul = 199.78074253456924
cycle= 1 E= -507.972652711192  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.56 sec, wall time      0.03 sec
diis-norm(errvec)=0.760169
diis-c [-0.57785663  1.        ]
  HOMO = -0.217667579734015  LUMO = 0.906532686038506
  mo_energy =
[-1.20200387e+02 -1.23048965e+01 -6.59411161e+00 -6.59411161e+00
 -6.59411161e+00 -1.16333890e+00 -2.17667580e-01 -2.17667580e-01
 -2.17667580e-01  9.06532686e-01  5.77492465e+00  2.36739819e+01
  8.66741451e+01  2.88449395e+02  9.20565436e+02  3.17609650e+03
  1.26589531e+04  4.12556047e+04  1.05282666e+05  2.30454855e+05
  4.56261667e+05  8.45207746e+05  1.52837903e+06  2.85063907e+06
  5.80851692e+06]
E1 = -706.7991545587137  E_coul = 198.80869933336407
cycle= 2 E= -507.99045522535  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.397
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0342771
diis-c [-0.00117225 -0.00215507  1.00215507]
  HOMO = -0.239805165340323  LUMO = 0.902651111900722
  mo_energy =
[-1.20315234e+02 -1.23725929e+01 -6.66907302e+00 -6.66907302e+00
 -6.66907302e+00 -1.17758097e+00 -2.39805165e-01 -2.39805165e-01
 -2.39805165e-01  9.02651112e-01  5.74559189e+00  2.36156255e+01
  8.65892295e+01  2.88344415e+02  9.20444938e+02  3.17596168e+03
  1.26588081e+04  4.12554557e+04  1.05282516e+05  2.30454704e+05
  4.56261515e+05  8.45207594e+05  1.52837888e+06  2.85063892e+06
  5.80851677e+06]
E1 = -706.6909960697614  E_coul = 198.70027936829183
cycle= 3 E= -507.99071670147  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00374745
diis-c [-3.14351696e-06  9.90781831e-05 -1.06931772e-01  1.10683269e+00]
  HOMO = -0.242959177689725  LUMO = 0.901870634460592
  mo_energy =
[-1.20327020e+02 -1.23811692e+01 -6.67813561e+00 -6.67813561e+00
 -6.67813561e+00 -1.17949227e+00 -2.42959178e-01 -2.42959178e-01
 -2.42959178e-01  9.01870634e-01  5.74125160e+00  2.36080991e+01
  8.65794747e+01  2.88333277e+02  9.20432911e+02  3.17594895e+03
  1.26587949e+04  4.12554424e+04  1.05282502e+05  2.30454691e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.6756942658832  E_coul = 198.68497250831808
cycle= 4 E= -507.990721757565  delta_E= -5.06e-06  |g|= 0.000232  |ddm|= 0.0103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017096
diis-c [-5.00319651e-10 -9.17539992e-06  6.94225062e-03 -9.85992001e-02
  1.09166612e+00]
  HOMO = -0.243108669538854  LUMO = 0.901824477118526
  mo_energy =
[-1.20327368e+02 -1.23815102e+01 -6.67847262e+00 -6.67847262e+00
 -6.67847262e+00 -1.17958270e+00 -2.43108670e-01 -2.43108670e-01
 -2.43108670e-01  9.01824477e-01  5.74104095e+00  2.36077924e+01
  8.65791366e+01  2.88332932e+02  9.20432563e+02  3.17594860e+03
  1.26587945e+04  4.12554420e+04  1.05282502e+05  2.30454690e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.674975785266  E_coul = 198.68425401372164
cycle= 5 E= -507.990721771544  delta_E= -1.4e-08  |g|= 5.35e-06  |ddm|= 0.000652
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.37777e-06
diis-c [-8.26255094e-13  5.69130554e-07 -5.28652068e-04  7.15208174e-03
 -8.48648902e-02  1.07824089e+00]
  HOMO = -0.243111175988368  LUMO = 0.901823767115141
  mo_energy =
[-1.20327374e+02 -1.23815151e+01 -6.67847762e+00 -6.67847762e+00
 -6.67847762e+00 -1.17958443e+00 -2.43111176e-01 -2.43111176e-01
 -2.43111176e-01  9.01823767e-01  5.74103740e+00  2.36077878e+01
  8.65791314e+01  2.88332926e+02  9.20432557e+02  3.17594859e+03
  1.26587945e+04  4.12554420e+04  1.05282502e+05  2.30454690e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.6749631370743  E_coul = 198.6842413655236
cycle= 6 E= -507.990721771551  delta_E= -6.37e-12  |g|= 9.2e-08  |ddm|= 1.54e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6749631370743  E_coul = 198.6842413655236
  HOMO = -0.243111218634162  LUMO = 0.901823741138588
  mo_energy =
[-1.20327374e+02 -1.23815152e+01 -6.67847770e+00 -6.67847770e+00
 -6.67847770e+00 -1.17958445e+00 -2.43111219e-01 -2.43111219e-01
 -2.43111219e-01  9.01823741e-01  5.74103733e+00  2.36077877e+01
  8.65791313e+01  2.88332926e+02  9.20432557e+02  3.17594859e+03
  1.26587945e+04  4.12554420e+04  1.05282502e+05  2.30454690e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.6749629505363  E_coul = 198.6842411789857
Extra cycle  E= -507.990721771551  delta_E= 1.71e-13  |g|= 1.21e-08  |ddm|= 2.16e-07
    CPU time for scf_cycle      4.34 sec, wall time      0.41 sec
exp = [2.31296076e-01 6.05673270e-01 1.92633977e+00 1.17616812e+05
 4.23867705e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104164e+04 3.67546955e+04 7.30194101e+03
 1.83757565e+04 1.44641852e+03 4.17621257e+02 1.48068522e+02
 6.02268104e+01 2.65966612e+01 9.27196478e+00 8.60415960e+00
 4.92739888e-01]
E = -507.99072177155057
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:26 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.231296076024       1
[INPUT] 0    0    [1    /1   ]  0.605673269622       1
[INPUT] 0    0    [1    /1   ]  1.92633976949        1
[INPUT] 0    0    [1    /1   ]  117616.812437        1
[INPUT] 0    0    [1    /1   ]  4.23867705396        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069944        1
[INPUT] 0    0    [1    /1   ]  294042.030851        1
[INPUT] 0    0    [1    /1   ]  147020.991046        1
[INPUT] 0    0    [1    /1   ]  73510.416391         1
[INPUT] 0    0    [1    /1   ]  36754.6954993        1
[INPUT] 0    0    [1    /1   ]  7301.9410107         1
[INPUT] 0    0    [1    /1   ]  18375.756541         1
[INPUT] 0    0    [1    /1   ]  1446.41851777        1
[INPUT] 0    0    [1    /1   ]  417.621257139        1
[INPUT] 0    0    [1    /1   ]  148.068521648        1
[INPUT] 0    0    [1    /1   ]  60.2268103536        1
[INPUT] 0    0    [1    /1   ]  26.596661242         1
[INPUT] 0    0    [1    /1   ]  9.27196477778        1
[INPUT] 1    0    [1    /1   ]  8.60415960086        1
[INPUT] 1    0    [1    /1   ]  0.49273988801        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23129607602367086, 1.0]], [0, [0.6056732696221808, 1.0]], [0, [1.926339769491911, 1.0]], [0, [117616.81243723641, 1.0]], [0, [4.238677053962792, 1.0]], [0, [1176168.142610434, 1.0]], [0, [588084.0699435659, 1.0]], [0, [294042.03085128585, 1.0]], [0, [147020.99104615068, 1.0]], [0, [73510.41639097354, 1.0]], [0, [36754.69549933966, 1.0]], [0, [7301.941010703977, 1.0]], [0, [18375.756540955354, 1.0]], [0, [1446.41851777488, 1.0]], [0, [417.62125713897956, 1.0]], [0, [148.06852164761102, 1.0]], [0, [60.226810353635, 1.0]], [0, [26.596661242020385, 1.0]], [0, [9.271964777775423, 1.0]], [1, [8.604159600861973, 1.0]], [1, [0.4927398880102131, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23129608]
bas 1, expnt(s) = [0.60567327]
bas 2, expnt(s) = [1.92633977]
bas 3, expnt(s) = [117616.81243724]
bas 4, expnt(s) = [4.23867705]
bas 5, expnt(s) = [1176168.14261043]
bas 6, expnt(s) = [588084.06994357]
bas 7, expnt(s) = [294042.03085129]
bas 8, expnt(s) = [147020.99104615]
bas 9, expnt(s) = [73510.41639097]
bas 10, expnt(s) = [36754.69549934]
bas 11, expnt(s) = [7301.9410107]
bas 12, expnt(s) = [18375.75654096]
bas 13, expnt(s) = [1446.41851777]
bas 14, expnt(s) = [417.62125714]
bas 15, expnt(s) = [148.06852165]
bas 16, expnt(s) = [60.22681035]
bas 17, expnt(s) = [26.59666124]
bas 18, expnt(s) = [9.27196478]
bas 19, expnt(s) = [8.6041596]
bas 20, expnt(s) = [0.49273989]
CPU time:      1730.99
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.31296076e-01 8.42638354e-01 6.05673270e-01 1.73457798e+00
 1.92633977e+00 4.13109034e+00 1.17616812e+05 1.60460107e+04
 4.23867705e+00 7.46341809e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104164e+04 1.12791582e+04
 3.67546955e+04 6.70655740e+03 7.30194101e+03 1.99569314e+03
 1.83757565e+04 3.98748393e+03 1.44641852e+03 5.92564329e+02
 4.17621257e+02 2.33400602e+02 1.48068522e+02 1.07241302e+02
 6.02268104e+01 5.46207201e+01 2.65966612e+01 2.95893460e+01
 9.27196478e+00 1.34243682e+01 8.60415960e+00 4.29902494e+01
 4.92739888e-01 1.20436061e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33608625513774
cond(S) = 912965.431955845
E1 = -689.595411082768  E_coul = 184.97043832265342
init E= -504.624972760115
    CPU time for initialize scf      0.76 sec, wall time      0.07 sec
  HOMO = -0.672192571781641  LUMO = 0.555654845245141
  mo_energy =
[-1.21709997e+02 -1.33864074e+01 -7.62366449e+00 -7.62366449e+00
 -7.62366449e+00 -1.65757286e+00 -6.72192572e-01 -6.72192572e-01
 -6.72192572e-01  5.55654845e-01  5.13640078e+00  2.27083361e+01
  8.53912989e+01  2.86994425e+02  9.19073941e+02  3.17466425e+03
  1.26576272e+04  4.12543459e+04  1.05281444e+05  2.30453658e+05
  4.56260486e+05  8.45206579e+05  1.52837788e+06  2.85063793e+06
  5.80851578e+06]
E1 = -707.7533952457613  E_coul = 199.78074253456924
cycle= 1 E= -507.972652711192  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.59 sec, wall time      0.03 sec
diis-norm(errvec)=0.760169
diis-c [-0.57785663  1.        ]
  HOMO = -0.217667579734015  LUMO = 0.906532686038506
  mo_energy =
[-1.20200387e+02 -1.23048965e+01 -6.59411161e+00 -6.59411161e+00
 -6.59411161e+00 -1.16333890e+00 -2.17667580e-01 -2.17667580e-01
 -2.17667580e-01  9.06532686e-01  5.77492465e+00  2.36739819e+01
  8.66741451e+01  2.88449395e+02  9.20565436e+02  3.17609650e+03
  1.26589531e+04  4.12556047e+04  1.05282666e+05  2.30454855e+05
  4.56261667e+05  8.45207746e+05  1.52837903e+06  2.85063907e+06
  5.80851692e+06]
E1 = -706.7991545587137  E_coul = 198.80869933336407
cycle= 2 E= -507.99045522535  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.397
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0342771
diis-c [-0.00117225 -0.00215507  1.00215507]
  HOMO = -0.239805165340323  LUMO = 0.902651111900722
  mo_energy =
[-1.20315234e+02 -1.23725929e+01 -6.66907302e+00 -6.66907302e+00
 -6.66907302e+00 -1.17758097e+00 -2.39805165e-01 -2.39805165e-01
 -2.39805165e-01  9.02651112e-01  5.74559189e+00  2.36156255e+01
  8.65892295e+01  2.88344415e+02  9.20444938e+02  3.17596168e+03
  1.26588081e+04  4.12554557e+04  1.05282516e+05  2.30454704e+05
  4.56261515e+05  8.45207594e+05  1.52837888e+06  2.85063892e+06
  5.80851677e+06]
E1 = -706.6909960697614  E_coul = 198.70027936829183
cycle= 3 E= -507.99071670147  delta_E= -0.000261  |g|= 0.00437  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00374745
diis-c [-3.14351696e-06  9.90781831e-05 -1.06931772e-01  1.10683269e+00]
  HOMO = -0.242959177689725  LUMO = 0.901870634460592
  mo_energy =
[-1.20327020e+02 -1.23811692e+01 -6.67813561e+00 -6.67813561e+00
 -6.67813561e+00 -1.17949227e+00 -2.42959178e-01 -2.42959178e-01
 -2.42959178e-01  9.01870634e-01  5.74125160e+00  2.36080991e+01
  8.65794747e+01  2.88333277e+02  9.20432911e+02  3.17594895e+03
  1.26587949e+04  4.12554424e+04  1.05282502e+05  2.30454691e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.6756942658832  E_coul = 198.68497250831808
cycle= 4 E= -507.990721757565  delta_E= -5.06e-06  |g|= 0.000232  |ddm|= 0.0103
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00017096
diis-c [-5.00319651e-10 -9.17539992e-06  6.94225062e-03 -9.85992001e-02
  1.09166612e+00]
  HOMO = -0.243108669538854  LUMO = 0.901824477118526
  mo_energy =
[-1.20327368e+02 -1.23815102e+01 -6.67847262e+00 -6.67847262e+00
 -6.67847262e+00 -1.17958270e+00 -2.43108670e-01 -2.43108670e-01
 -2.43108670e-01  9.01824477e-01  5.74104095e+00  2.36077924e+01
  8.65791366e+01  2.88332932e+02  9.20432563e+02  3.17594860e+03
  1.26587945e+04  4.12554420e+04  1.05282502e+05  2.30454690e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.674975785266  E_coul = 198.68425401372164
cycle= 5 E= -507.990721771544  delta_E= -1.4e-08  |g|= 5.35e-06  |ddm|= 0.000652
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.37777e-06
diis-c [-8.26255094e-13  5.69130554e-07 -5.28652068e-04  7.15208174e-03
 -8.48648902e-02  1.07824089e+00]
  HOMO = -0.243111175988368  LUMO = 0.901823767115141
  mo_energy =
[-1.20327374e+02 -1.23815151e+01 -6.67847762e+00 -6.67847762e+00
 -6.67847762e+00 -1.17958443e+00 -2.43111176e-01 -2.43111176e-01
 -2.43111176e-01  9.01823767e-01  5.74103740e+00  2.36077878e+01
  8.65791314e+01  2.88332926e+02  9.20432557e+02  3.17594859e+03
  1.26587945e+04  4.12554420e+04  1.05282502e+05  2.30454690e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.6749631370743  E_coul = 198.6842413655236
cycle= 6 E= -507.990721771551  delta_E= -6.37e-12  |g|= 9.2e-08  |ddm|= 1.54e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6749631370743  E_coul = 198.6842413655236
  HOMO = -0.243111218634162  LUMO = 0.901823741138588
  mo_energy =
[-1.20327374e+02 -1.23815152e+01 -6.67847770e+00 -6.67847770e+00
 -6.67847770e+00 -1.17958445e+00 -2.43111219e-01 -2.43111219e-01
 -2.43111219e-01  9.01823741e-01  5.74103733e+00  2.36077877e+01
  8.65791313e+01  2.88332926e+02  9.20432557e+02  3.17594859e+03
  1.26587945e+04  4.12554420e+04  1.05282502e+05  2.30454690e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.6749629505363  E_coul = 198.6842411789857
Extra cycle  E= -507.990721771551  delta_E= 1.71e-13  |g|= 1.21e-08  |ddm|= 2.16e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912965.431955845
E1 = -706.6749629505363  E_coul = 198.6842411789857
init E= -507.990721771551
    CPU time for initialize scf      5.80 sec, wall time      0.24 sec
  HOMO = -0.243111224683705  LUMO = 0.901823739007344
  mo_energy =
[-1.20327374e+02 -1.23815152e+01 -6.67847772e+00 -6.67847772e+00
 -6.67847772e+00 -1.17958445e+00 -2.43111225e-01 -2.43111225e-01
 -2.43111225e-01  9.01823739e-01  5.74103732e+00  2.36077877e+01
  8.65791313e+01  2.88332926e+02  9.20432557e+02  3.17594859e+03
  1.26587945e+04  4.12554420e+04  1.05282502e+05  2.30454690e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.6749629223959  E_coul = 198.6842411508457
cycle= 1 E= -507.99072177155  delta_E= 3.41e-13  |g|= 2.96e-09  |ddm|= 2.82e-08
    CPU time for cycle= 1      0.30 sec, wall time      0.03 sec
E1 = -706.6749629223959  E_coul = 198.6842411508457
  HOMO = -0.24311122556555  LUMO = 0.901823741275105
  mo_energy =
[-1.20327374e+02 -1.23815152e+01 -6.67847772e+00 -6.67847772e+00
 -6.67847772e+00 -1.17958445e+00 -2.43111226e-01 -2.43111226e-01
 -2.43111226e-01  9.01823741e-01  5.74103732e+00  2.36077877e+01
  8.65791313e+01  2.88332926e+02  9.20432557e+02  3.17594859e+03
  1.26587945e+04  4.12554420e+04  1.05282502e+05  2.30454690e+05
  4.56261501e+05  8.45207580e+05  1.52837887e+06  2.85063891e+06
  5.80851676e+06]
E1 = -706.6749629135693  E_coul = 198.68424114201886
Extra cycle  E= -507.99072177155  delta_E= -1.71e-13  |g|= 1.77e-09  |ddm|= 7.59e-09
    CPU time for scf_cycle      6.25 sec, wall time      0.41 sec
exp = [2.31296076e-01 6.05673270e-01 1.92633977e+00 1.17616812e+05
 4.23867705e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104164e+04 3.67546955e+04 7.30194101e+03
 1.83757565e+04 1.44641852e+03 4.17621257e+02 1.48068522e+02
 6.02268104e+01 2.65966612e+01 9.27196478e+00 8.60415960e+00
 4.92739888e-01]
grad_E = [ 5.02430536e-04 -3.26525255e-04 -1.31687546e-04  6.00806805e-09
  1.01283489e-04  3.98307663e-11  1.72375767e-10  9.31987220e-10
  3.68156597e-09  1.53718297e-08  8.02425660e-08  5.06820988e-06
  1.96097736e-07 -3.92438159e-05  9.71549722e-06 -5.29259491e-05
 -5.87001838e-06  6.14699660e-05 -1.91474590e-05 -8.47608327e-05
 -3.69907456e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:34 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229315690739       1
[INPUT] 0    0    [1    /1   ]  0.598982004183       1
[INPUT] 0    0    [1    /1   ]  1.80823629398        1
[INPUT] 0    0    [1    /1   ]  117616.812449        1
[INPUT] 0    0    [1    /1   ]  4.08093546437        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069944        1
[INPUT] 0    0    [1    /1   ]  294042.030853        1
[INPUT] 0    0    [1    /1   ]  147020.991054        1
[INPUT] 0    0    [1    /1   ]  73510.4164221        1
[INPUT] 0    0    [1    /1   ]  36754.6956613        1
[INPUT] 0    0    [1    /1   ]  7301.95120908        1
[INPUT] 0    0    [1    /1   ]  18375.756939         1
[INPUT] 0    0    [1    /1   ]  1446.34275948        1
[INPUT] 0    0    [1    /1   ]  417.589372377        1
[INPUT] 0    0    [1    /1   ]  148.14889362         1
[INPUT] 0    0    [1    /1   ]  60.1448398777        1
[INPUT] 0    0    [1    /1   ]  26.4204232879        1
[INPUT] 0    0    [1    /1   ]  9.07008136574        1
[INPUT] 1    0    [1    /1   ]  8.60411121897        1
[INPUT] 1    0    [1    /1   ]  0.492734789474       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2293156907390639, 1.0]], [0, [0.5989820041834614, 1.0]], [0, [1.8082362939836056, 1.0]], [0, [117616.81244937828, 1.0]], [0, [4.080935464366514, 1.0]], [0, [1176168.1426105152, 1.0]], [0, [588084.069943915, 1.0]], [0, [294042.03085316904, 1.0]], [0, [147020.99105359215, 1.0]], [0, [73510.41642205037, 1.0]], [0, [36754.695661348946, 1.0]], [0, [7301.951209082726, 1.0]], [0, [18375.75693898624, 1.0]], [0, [1446.3427594800037, 1.0]], [0, [417.5893723769081, 1.0]], [0, [148.14889362044823, 1.0]], [0, [60.14483987766361, 1.0]], [0, [26.42042328787642, 1.0]], [0, [9.070081365735483, 1.0]], [1, [8.604111218971271, 1.0]], [1, [0.49273478947411453, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22931569]
bas 1, expnt(s) = [0.598982]
bas 2, expnt(s) = [1.80823629]
bas 3, expnt(s) = [117616.81244938]
bas 4, expnt(s) = [4.08093546]
bas 5, expnt(s) = [1176168.14261052]
bas 6, expnt(s) = [588084.06994392]
bas 7, expnt(s) = [294042.03085317]
bas 8, expnt(s) = [147020.99105359]
bas 9, expnt(s) = [73510.41642205]
bas 10, expnt(s) = [36754.69566135]
bas 11, expnt(s) = [7301.95120908]
bas 12, expnt(s) = [18375.75693899]
bas 13, expnt(s) = [1446.34275948]
bas 14, expnt(s) = [417.58937238]
bas 15, expnt(s) = [148.14889362]
bas 16, expnt(s) = [60.14483988]
bas 17, expnt(s) = [26.42042329]
bas 18, expnt(s) = [9.07008137]
bas 19, expnt(s) = [8.60411122]
bas 20, expnt(s) = [0.49273479]
CPU time:      1746.08
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29315691e-01 8.37221463e-01 5.98982004e-01 1.72018579e+00
 1.80823629e+00 3.93963884e+00 1.17616812e+05 1.60460107e+04
 4.08093546e+00 7.25412140e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104164e+04 1.12791582e+04
 3.67546957e+04 6.70655742e+03 7.30195121e+03 1.99569523e+03
 1.83757569e+04 3.98748399e+03 1.44634276e+03 5.92541051e+02
 4.17589372e+02 2.33387237e+02 1.48148894e+02 1.07284958e+02
 6.01448399e+01 5.45649553e+01 2.64204233e+01 2.94421725e+01
 9.07008137e+00 1.32045441e+01 8.60411122e+00 4.29899472e+01
 4.92734789e-01 1.20434503e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33610225638921
cond(S) = 912896.4318270074
E1 = -689.5953814799461  E_coul = 184.97034394615804
init E= -504.625037533788
    CPU time for initialize scf      1.24 sec, wall time      0.09 sec
  HOMO = -0.672190384122612  LUMO = 0.540145953394844
  mo_energy =
[-1.21710034e+02 -1.33863990e+01 -7.62366581e+00 -7.62366581e+00
 -7.62366581e+00 -1.65759686e+00 -6.72190384e-01 -6.72190384e-01
 -6.72190384e-01  5.40145953e-01  4.86234010e+00  2.16250334e+01
  8.32824511e+01  2.84326921e+02  9.16412280e+02  3.17215230e+03
  1.26552382e+04  4.12520759e+04  1.05279260e+05  2.30451534e+05
  4.56258407e+05  8.45204534e+05  1.52837587e+06  2.85063596e+06
  5.80851387e+06]
E1 = -707.75368542761  E_coul = 199.78103971193707
cycle= 1 E= -507.972645715673  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.759096
diis-c [-0.57622646  1.        ]
  HOMO = -0.217662486259736  LUMO = 0.886734715742158
  mo_energy =
[-1.20200379e+02 -1.23048588e+01 -6.59407952e+00 -6.59407952e+00
 -6.59407952e+00 -1.16334925e+00 -2.17662486e-01 -2.17662486e-01
 -2.17662486e-01  8.86734716e-01  5.48651928e+00  2.25805539e+01
  8.45635595e+01  2.85782117e+02  9.17903947e+02  3.17358462e+03
  1.26565641e+04  4.12533347e+04  1.05280481e+05  2.30452731e+05
  4.56259587e+05  8.45205701e+05  1.52837702e+06  2.85063710e+06
  5.80851500e+06]
E1 = -706.7988224842169  E_coul = 198.80836218095797
cycle= 2 E= -507.990460303259  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.392
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347483
diis-c [-0.00120411 -0.00241298  1.00241298]
  HOMO = -0.239822555927664  LUMO = 0.883048862209884
  mo_energy =
[-1.20315317e+02 -1.23726201e+01 -6.66910967e+00 -6.66910967e+00
 -6.66910967e+00 -1.17760707e+00 -2.39822556e-01 -2.39822556e-01
 -2.39822556e-01  8.83048862e-01  5.45837730e+00  2.25230353e+01
  8.44787917e+01  2.85677051e+02  9.17783339e+02  3.17344970e+03
  1.26564190e+04  4.12531857e+04  1.05280331e+05  2.30452580e+05
  4.56259435e+05  8.45205548e+05  1.52837687e+06  2.85063695e+06
  5.80851485e+06]
E1 = -706.6904852653331  E_coul = 198.6997628318739
cycle= 3 E= -507.990722433459  delta_E= -0.000262  |g|= 0.00437  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00383426
diis-c [-3.21722536e-06  8.27739323e-05 -1.08395949e-01  1.10831318e+00]
  HOMO = -0.242983275592182  LUMO = 0.882297546985979
  mo_energy =
[-1.20327106e+02 -1.23812053e+01 -6.67818028e+00 -6.67818028e+00
 -6.67818028e+00 -1.17952282e+00 -2.42983276e-01 -2.42983276e-01
 -2.42983276e-01  8.82297547e-01  5.45418535e+00  2.25155888e+01
  8.44690475e+01  2.85665909e+02  9.17771309e+02  3.17343696e+03
  1.26564058e+04  4.12531723e+04  1.05280317e+05  2.30452566e+05
  4.56259422e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.6751323832104  E_coul = 198.68440485833145
cycle= 4 E= -507.990727524879  delta_E= -5.09e-06  |g|= 0.00023  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000171074
diis-c [-5.55089316e-10 -9.37719744e-06  6.96231385e-03 -9.72933557e-02
  1.09034042e+00]
  HOMO = -0.243129218632759  LUMO = 0.882253446797669
  mo_energy =
[-1.20327436e+02 -1.23815343e+01 -6.67850430e+00 -6.67850430e+00
 -6.67850430e+00 -1.17961120e+00 -2.43129219e-01 -2.43129219e-01
 -2.43129219e-01  8.82253447e-01  5.45398566e+00  2.25152944e+01
  8.44687238e+01  2.85665581e+02  9.17770979e+02  3.17343663e+03
  1.26564055e+04  4.12531720e+04  1.05280317e+05  2.30452566e+05
  4.56259421e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.6744296252564  E_coul = 198.68370208655932
cycle= 5 E= -507.990727538697  delta_E= -1.38e-08  |g|= 5.88e-06  |ddm|= 0.000668
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.59764e-06
diis-c [-9.16043660e-13  5.94339557e-07 -5.63387304e-04  7.49779278e-03
 -9.01542710e-02  1.08321927e+00]
  HOMO = -0.243131909307002  LUMO = 0.882252687470673
  mo_energy =
[-1.20327442e+02 -1.23815395e+01 -6.67850957e+00 -6.67850957e+00
 -6.67850957e+00 -1.17961305e+00 -2.43131909e-01 -2.43131909e-01
 -2.43131909e-01  8.82252687e-01  5.45398194e+00  2.25152895e+01
  8.44687184e+01  2.85665575e+02  9.17770973e+02  3.17343662e+03
  1.26564055e+04  4.12531719e+04  1.05280317e+05  2.30452566e+05
  4.56259421e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.674416000426  E_coul = 198.6836884617213
cycle= 6 E= -507.990727538705  delta_E= -7.67e-12  |g|= 9.22e-08  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.674416000426  E_coul = 198.6836884617213
  HOMO = -0.243131951753989  LUMO = 0.882252661721172
  mo_energy =
[-1.20327442e+02 -1.23815396e+01 -6.67850966e+00 -6.67850966e+00
 -6.67850966e+00 -1.17961307e+00 -2.43131952e-01 -2.43131952e-01
 -2.43131952e-01  8.82252662e-01  5.45398187e+00  2.25152894e+01
  8.44687183e+01  2.85665575e+02  9.17770973e+02  3.17343662e+03
  1.26564055e+04  4.12531719e+04  1.05280317e+05  2.30452566e+05
  4.56259421e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.674415817781  E_coul = 198.68368827907614
Extra cycle  E= -507.990727538705  delta_E= -1.14e-13  |g|= 1.24e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      2.09 sec, wall time      0.31 sec
exp = [2.29315691e-01 5.98982004e-01 1.80823629e+00 1.17616812e+05
 4.08093546e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104164e+04 3.67546957e+04 7.30195121e+03
 1.83757569e+04 1.44634276e+03 4.17589372e+02 1.48148894e+02
 6.01448399e+01 2.64204233e+01 9.07008137e+00 8.60411122e+00
 4.92734789e-01]
E = -507.99072753870485
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:35 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.229315690739       1
[INPUT] 0    0    [1    /1   ]  0.598982004183       1
[INPUT] 0    0    [1    /1   ]  1.80823629398        1
[INPUT] 0    0    [1    /1   ]  117616.812449        1
[INPUT] 0    0    [1    /1   ]  4.08093546437        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069944        1
[INPUT] 0    0    [1    /1   ]  294042.030853        1
[INPUT] 0    0    [1    /1   ]  147020.991054        1
[INPUT] 0    0    [1    /1   ]  73510.4164221        1
[INPUT] 0    0    [1    /1   ]  36754.6956613        1
[INPUT] 0    0    [1    /1   ]  7301.95120908        1
[INPUT] 0    0    [1    /1   ]  18375.756939         1
[INPUT] 0    0    [1    /1   ]  1446.34275948        1
[INPUT] 0    0    [1    /1   ]  417.589372377        1
[INPUT] 0    0    [1    /1   ]  148.14889362         1
[INPUT] 0    0    [1    /1   ]  60.1448398777        1
[INPUT] 0    0    [1    /1   ]  26.4204232879        1
[INPUT] 0    0    [1    /1   ]  9.07008136574        1
[INPUT] 1    0    [1    /1   ]  8.60411121897        1
[INPUT] 1    0    [1    /1   ]  0.492734789474       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2293156907390639, 1.0]], [0, [0.5989820041834614, 1.0]], [0, [1.8082362939836056, 1.0]], [0, [117616.81244937828, 1.0]], [0, [4.080935464366514, 1.0]], [0, [1176168.1426105152, 1.0]], [0, [588084.069943915, 1.0]], [0, [294042.03085316904, 1.0]], [0, [147020.99105359215, 1.0]], [0, [73510.41642205037, 1.0]], [0, [36754.695661348946, 1.0]], [0, [7301.951209082726, 1.0]], [0, [18375.75693898624, 1.0]], [0, [1446.3427594800037, 1.0]], [0, [417.5893723769081, 1.0]], [0, [148.14889362044823, 1.0]], [0, [60.14483987766361, 1.0]], [0, [26.42042328787642, 1.0]], [0, [9.070081365735483, 1.0]], [1, [8.604111218971271, 1.0]], [1, [0.49273478947411453, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22931569]
bas 1, expnt(s) = [0.598982]
bas 2, expnt(s) = [1.80823629]
bas 3, expnt(s) = [117616.81244938]
bas 4, expnt(s) = [4.08093546]
bas 5, expnt(s) = [1176168.14261052]
bas 6, expnt(s) = [588084.06994392]
bas 7, expnt(s) = [294042.03085317]
bas 8, expnt(s) = [147020.99105359]
bas 9, expnt(s) = [73510.41642205]
bas 10, expnt(s) = [36754.69566135]
bas 11, expnt(s) = [7301.95120908]
bas 12, expnt(s) = [18375.75693899]
bas 13, expnt(s) = [1446.34275948]
bas 14, expnt(s) = [417.58937238]
bas 15, expnt(s) = [148.14889362]
bas 16, expnt(s) = [60.14483988]
bas 17, expnt(s) = [26.42042329]
bas 18, expnt(s) = [9.07008137]
bas 19, expnt(s) = [8.60411122]
bas 20, expnt(s) = [0.49273479]
CPU time:      1748.68
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.29315691e-01 8.37221463e-01 5.98982004e-01 1.72018579e+00
 1.80823629e+00 3.93963884e+00 1.17616812e+05 1.60460107e+04
 4.08093546e+00 7.25412140e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104164e+04 1.12791582e+04
 3.67546957e+04 6.70655742e+03 7.30195121e+03 1.99569523e+03
 1.83757569e+04 3.98748399e+03 1.44634276e+03 5.92541051e+02
 4.17589372e+02 2.33387237e+02 1.48148894e+02 1.07284958e+02
 6.01448399e+01 5.45649553e+01 2.64204233e+01 2.94421725e+01
 9.07008137e+00 1.32045441e+01 8.60411122e+00 4.29899472e+01
 4.92734789e-01 1.20434503e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33610225638921
cond(S) = 912896.4318270074
E1 = -689.5953814799461  E_coul = 184.97034394615804
init E= -504.625037533788
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672190384122612  LUMO = 0.540145953394844
  mo_energy =
[-1.21710034e+02 -1.33863990e+01 -7.62366581e+00 -7.62366581e+00
 -7.62366581e+00 -1.65759686e+00 -6.72190384e-01 -6.72190384e-01
 -6.72190384e-01  5.40145953e-01  4.86234010e+00  2.16250334e+01
  8.32824511e+01  2.84326921e+02  9.16412280e+02  3.17215230e+03
  1.26552382e+04  4.12520759e+04  1.05279260e+05  2.30451534e+05
  4.56258407e+05  8.45204534e+05  1.52837587e+06  2.85063596e+06
  5.80851387e+06]
E1 = -707.75368542761  E_coul = 199.78103971193707
cycle= 1 E= -507.972645715673  delta_E= -3.35  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.759096
diis-c [-0.57622646  1.        ]
  HOMO = -0.217662486259736  LUMO = 0.886734715742158
  mo_energy =
[-1.20200379e+02 -1.23048588e+01 -6.59407952e+00 -6.59407952e+00
 -6.59407952e+00 -1.16334925e+00 -2.17662486e-01 -2.17662486e-01
 -2.17662486e-01  8.86734716e-01  5.48651928e+00  2.25805539e+01
  8.45635595e+01  2.85782117e+02  9.17903947e+02  3.17358462e+03
  1.26565641e+04  4.12533347e+04  1.05280481e+05  2.30452731e+05
  4.56259587e+05  8.45205701e+05  1.52837702e+06  2.85063710e+06
  5.80851500e+06]
E1 = -706.7988224842169  E_coul = 198.80836218095797
cycle= 2 E= -507.990460303259  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.392
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0347483
diis-c [-0.00120411 -0.00241298  1.00241298]
  HOMO = -0.239822555927664  LUMO = 0.883048862209884
  mo_energy =
[-1.20315317e+02 -1.23726201e+01 -6.66910967e+00 -6.66910967e+00
 -6.66910967e+00 -1.17760707e+00 -2.39822556e-01 -2.39822556e-01
 -2.39822556e-01  8.83048862e-01  5.45837730e+00  2.25230353e+01
  8.44787917e+01  2.85677051e+02  9.17783339e+02  3.17344970e+03
  1.26564190e+04  4.12531857e+04  1.05280331e+05  2.30452580e+05
  4.56259435e+05  8.45205548e+05  1.52837687e+06  2.85063695e+06
  5.80851485e+06]
E1 = -706.6904852653331  E_coul = 198.6997628318739
cycle= 3 E= -507.990722433459  delta_E= -0.000262  |g|= 0.00437  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00383426
diis-c [-3.21722536e-06  8.27739323e-05 -1.08395949e-01  1.10831318e+00]
  HOMO = -0.242983275592182  LUMO = 0.882297546985979
  mo_energy =
[-1.20327106e+02 -1.23812053e+01 -6.67818028e+00 -6.67818028e+00
 -6.67818028e+00 -1.17952282e+00 -2.42983276e-01 -2.42983276e-01
 -2.42983276e-01  8.82297547e-01  5.45418535e+00  2.25155888e+01
  8.44690475e+01  2.85665909e+02  9.17771309e+02  3.17343696e+03
  1.26564058e+04  4.12531723e+04  1.05280317e+05  2.30452566e+05
  4.56259422e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.6751323832104  E_coul = 198.68440485833145
cycle= 4 E= -507.990727524879  delta_E= -5.09e-06  |g|= 0.00023  |ddm|= 0.0105
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000171074
diis-c [-5.55089316e-10 -9.37719744e-06  6.96231385e-03 -9.72933557e-02
  1.09034042e+00]
  HOMO = -0.243129218632759  LUMO = 0.882253446797669
  mo_energy =
[-1.20327436e+02 -1.23815343e+01 -6.67850430e+00 -6.67850430e+00
 -6.67850430e+00 -1.17961120e+00 -2.43129219e-01 -2.43129219e-01
 -2.43129219e-01  8.82253447e-01  5.45398566e+00  2.25152944e+01
  8.44687238e+01  2.85665581e+02  9.17770979e+02  3.17343663e+03
  1.26564055e+04  4.12531720e+04  1.05280317e+05  2.30452566e+05
  4.56259421e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.6744296252564  E_coul = 198.68370208655932
cycle= 5 E= -507.990727538697  delta_E= -1.38e-08  |g|= 5.88e-06  |ddm|= 0.000668
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.59764e-06
diis-c [-9.16043660e-13  5.94339557e-07 -5.63387304e-04  7.49779278e-03
 -9.01542710e-02  1.08321927e+00]
  HOMO = -0.243131909307002  LUMO = 0.882252687470673
  mo_energy =
[-1.20327442e+02 -1.23815395e+01 -6.67850957e+00 -6.67850957e+00
 -6.67850957e+00 -1.17961305e+00 -2.43131909e-01 -2.43131909e-01
 -2.43131909e-01  8.82252687e-01  5.45398194e+00  2.25152895e+01
  8.44687184e+01  2.85665575e+02  9.17770973e+02  3.17343662e+03
  1.26564055e+04  4.12531719e+04  1.05280317e+05  2.30452566e+05
  4.56259421e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.674416000426  E_coul = 198.6836884617213
cycle= 6 E= -507.990727538705  delta_E= -7.67e-12  |g|= 9.22e-08  |ddm|= 1.77e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.674416000426  E_coul = 198.6836884617213
  HOMO = -0.243131951753989  LUMO = 0.882252661721172
  mo_energy =
[-1.20327442e+02 -1.23815396e+01 -6.67850966e+00 -6.67850966e+00
 -6.67850966e+00 -1.17961307e+00 -2.43131952e-01 -2.43131952e-01
 -2.43131952e-01  8.82252662e-01  5.45398187e+00  2.25152894e+01
  8.44687183e+01  2.85665575e+02  9.17770973e+02  3.17343662e+03
  1.26564055e+04  4.12531719e+04  1.05280317e+05  2.30452566e+05
  4.56259421e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.674415817781  E_coul = 198.68368827907614
Extra cycle  E= -507.990727538705  delta_E= -1.14e-13  |g|= 1.24e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912896.4318270074
E1 = -706.674415817781  E_coul = 198.68368827907614
init E= -507.990727538705
    CPU time for initialize scf      5.61 sec, wall time      0.24 sec
  HOMO = -0.243131957735391  LUMO = 0.882252662332591
  mo_energy =
[-1.20327442e+02 -1.23815396e+01 -6.67850967e+00 -6.67850967e+00
 -6.67850967e+00 -1.17961307e+00 -2.43131958e-01 -2.43131958e-01
 -2.43131958e-01  8.82252662e-01  5.45398187e+00  2.25152894e+01
  8.44687183e+01  2.85665575e+02  9.17770973e+02  3.17343662e+03
  1.26564055e+04  4.12531719e+04  1.05280317e+05  2.30452566e+05
  4.56259421e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.674415782917  E_coul = 198.6836882442127
cycle= 1 E= -507.990727538704  delta_E= 5.68e-13  |g|= 1.71e-09  |ddm|= 3.42e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.674415782917  E_coul = 198.6836882442127
  HOMO = -0.243131958806418  LUMO = 0.882252660698578
  mo_energy =
[-1.20327442e+02 -1.23815396e+01 -6.67850967e+00 -6.67850967e+00
 -6.67850967e+00 -1.17961307e+00 -2.43131959e-01 -2.43131959e-01
 -2.43131959e-01  8.82252661e-01  5.45398186e+00  2.25152894e+01
  8.44687183e+01  2.85665575e+02  9.17770973e+02  3.17343662e+03
  1.26564055e+04  4.12531719e+04  1.05280317e+05  2.30452566e+05
  4.56259421e+05  8.45205535e+05  1.52837685e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.6744157820494  E_coul = 198.683688243345
Extra cycle  E= -507.990727538704  delta_E= -1.71e-13  |g|= 1.6e-09  |ddm|= 1.44e-09
    CPU time for scf_cycle      6.12 sec, wall time      0.40 sec
exp = [2.29315691e-01 5.98982004e-01 1.80823629e+00 1.17616812e+05
 4.08093546e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104164e+04 3.67546957e+04 7.30195121e+03
 1.83757569e+04 1.44634276e+03 4.17589372e+02 1.48148894e+02
 6.01448399e+01 2.64204233e+01 9.07008137e+00 8.60411122e+00
 4.92734789e-01]
grad_E = [ 4.16980097e-04 -2.77514500e-04 -1.33715260e-04  5.99710170e-09
  7.62341077e-05  3.97073592e-11  1.72016311e-10  9.30304750e-10
  3.67477480e-09  1.53431018e-08  8.01036112e-08  5.05902127e-06
  1.95646468e-07 -3.88240001e-05  6.57934434e-06 -4.54595183e-05
 -9.56562990e-06  6.16355262e-05 -1.01723332e-05 -1.22225766e-04
 -5.04787507e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:42 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.226259671931       1
[INPUT] 0    0    [1    /1   ]  0.587678237508       1
[INPUT] 0    0    [1    /1   ]  1.64225724659        1
[INPUT] 0    0    [1    /1   ]  117616.812401        1
[INPUT] 0    0    [1    /1   ]  3.91378994106        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991024        1
[INPUT] 0    0    [1    /1   ]  73510.4162977        1
[INPUT] 0    0    [1    /1   ]  36754.6950126        1
[INPUT] 0    0    [1    /1   ]  7301.91027008        1
[INPUT] 0    0    [1    /1   ]  18375.7553502        1
[INPUT] 0    0    [1    /1   ]  1446.65816475        1
[INPUT] 0    0    [1    /1   ]  417.551399335        1
[INPUT] 0    0    [1    /1   ]  148.412120753        1
[INPUT] 0    0    [1    /1   ]  60.2419803226        1
[INPUT] 0    0    [1    /1   ]  26.3217144439        1
[INPUT] 0    0    [1    /1   ]  8.84872099185        1
[INPUT] 1    0    [1    /1   ]  8.60405728898        1
[INPUT] 1    0    [1    /1   ]  0.49272760314        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2262596719310214, 1.0]], [0, [0.5876782375078881, 1.0]], [0, [1.64225724658628, 1.0]], [0, [117616.81240078426, 1.0]], [0, [3.9137899410584502, 1.0]], [0, [1176168.1426101916, 1.0]], [0, [588084.0699425195, 1.0]], [0, [294042.0308456315, 1.0]], [0, [147020.99102381317, 1.0]], [0, [73510.41629770299, 1.0]], [0, [36754.69501257107, 1.0]], [0, [7301.910270083202, 1.0]], [0, [18375.75535024723, 1.0]], [0, [1446.6581647500386, 1.0]], [0, [417.55139933493217, 1.0]], [0, [148.41212075283005, 1.0]], [0, [60.241980322572054, 1.0]], [0, [26.32171444390103, 1.0]], [0, [8.848720991852971, 1.0]], [1, [8.604057288982819, 1.0]], [1, [0.4927276031399883, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22625967]
bas 1, expnt(s) = [0.58767824]
bas 2, expnt(s) = [1.64225725]
bas 3, expnt(s) = [117616.81240078]
bas 4, expnt(s) = [3.91378994]
bas 5, expnt(s) = [1176168.14261019]
bas 6, expnt(s) = [588084.06994252]
bas 7, expnt(s) = [294042.03084563]
bas 8, expnt(s) = [147020.99102381]
bas 9, expnt(s) = [73510.4162977]
bas 10, expnt(s) = [36754.69501257]
bas 11, expnt(s) = [7301.91027008]
bas 12, expnt(s) = [18375.75535025]
bas 13, expnt(s) = [1446.65816475]
bas 14, expnt(s) = [417.55139933]
bas 15, expnt(s) = [148.41212075]
bas 16, expnt(s) = [60.24198032]
bas 17, expnt(s) = [26.32171444]
bas 18, expnt(s) = [8.84872099]
bas 19, expnt(s) = [8.60405729]
bas 20, expnt(s) = [0.4927276]
CPU time:      1763.63
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.26259672e-01 8.28839403e-01 5.87678238e-01 1.69578087e+00
 1.64225725e+00 3.66518512e+00 1.17616812e+05 1.60460107e+04
 3.91378994e+00 7.03012681e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655733e+03 7.30191027e+03 1.99568684e+03
 1.83757554e+04 3.98748373e+03 1.44665816e+03 5.92637961e+02
 4.17551399e+02 2.33371320e+02 1.48412121e+02 1.07427892e+02
 6.02419803e+01 5.46310382e+01 2.63217144e+01 2.93596351e+01
 8.84872099e+00 1.29621010e+01 8.60405729e+00 4.29896104e+01
 4.92727603e-01 1.20432308e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336121752211643
cond(S) = 912845.4698423697
E1 = -689.5951115838001  E_coul = 184.97018798047878
init E= -504.624923603321
    CPU time for initialize scf      0.75 sec, wall time      0.07 sec
  HOMO = -0.672191553225463  LUMO = 0.516227504161867
  mo_energy =
[-1.21710091e+02 -1.33863852e+01 -7.62366891e+00 -7.62366891e+00
 -7.62366891e+00 -1.65762668e+00 -6.72191553e-01 -6.72191553e-01
 -6.72191553e-01  5.16227504e-01  4.49635525e+00  2.02965026e+01
  8.09879515e+01  2.82018422e+02  9.14793691e+02  3.17131497e+03
  1.26551819e+04  4.12522494e+04  1.05279459e+05  2.30451728e+05
  4.56258595e+05  8.45204718e+05  1.52837605e+06  2.85063613e+06
  5.80851404e+06]
E1 = -707.7539848545575  E_coul = 199.78133653849565
cycle= 1 E= -507.972648316062  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.756824
diis-c [-0.57278236  1.        ]
  HOMO = -0.217656355047898  LUMO = 0.856294637141119
  mo_energy =
[-1.20200389e+02 -1.23048147e+01 -6.59404615e+00 -6.59404615e+00
 -6.59404615e+00 -1.16335900e+00 -2.17656355e-01 -2.17656355e-01
 -2.17656355e-01  8.56294637e-01  5.10116433e+00  2.12401853e+01
  8.22680668e+01  2.83474206e+02  9.16285580e+02  3.17274737e+03
  1.26565080e+04  4.12535083e+04  1.05280680e+05  2.30452925e+05
  4.56259775e+05  8.45205885e+05  1.52837720e+06  2.85063728e+06
  5.80851518e+06]
E1 = -706.7986228125507  E_coul = 198.8081512918163
cycle= 2 E= -507.990471520734  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.381
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.035452
diis-c [-0.0012527 -0.0026995  1.0026995]
  HOMO = -0.239836545664627  LUMO = 0.852898552777303
  mo_energy =
[-1.20315406e+02 -1.23726336e+01 -6.66913722e+00 -6.66913722e+00
 -6.66913722e+00 -1.17763126e+00 -2.39836546e-01 -2.39836546e-01
 -2.39836546e-01  8.52898553e-01  5.07467590e+00  2.11837123e+01
  8.21834147e+01  2.83369022e+02  9.16164861e+02  3.17261235e+03
  1.26563627e+04  4.12533591e+04  1.05280530e+05  2.30452774e+05
  4.56259623e+05  8.45205732e+05  1.52837705e+06  2.85063713e+06
  5.80851502e+06]
E1 = -706.6900605387737  E_coul = 198.69932596444298
cycle= 3 E= -507.990734574331  delta_E= -0.000263  |g|= 0.00437  |ddm|= 0.0608
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00397177
diis-c [-3.31101237e-06  4.62042384e-05 -1.10863490e-01  1.11081729e+00]
  HOMO = -0.243009261739132  LUMO = 0.852190534025534
  mo_energy =
[-1.20327213e+02 -1.23812388e+01 -6.67822720e+00 -6.67822720e+00
 -6.67822720e+00 -1.17955495e+00 -2.43009262e-01 -2.43009262e-01
 -2.43009262e-01  8.52190534e-01  5.07068683e+00  2.11763568e+01
  8.21736662e+01  2.83357859e+02  9.16152813e+02  3.17259960e+03
  1.26563495e+04  4.12533458e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6746160431595  E_coul = 198.68387631548904
cycle= 4 E= -507.99073972767  delta_E= -5.15e-06  |g|= 0.000227  |ddm|= 0.0108
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170655
diis-c [-6.41878368e-10 -9.71768628e-06  7.02268172e-03 -9.53587041e-02
  1.08834574e+00]
  HOMO = -0.243149190439817  LUMO = 0.852149530459011
  mo_energy =
[-1.20327513e+02 -1.23815479e+01 -6.67852975e+00 -6.67852975e+00
 -6.67852975e+00 -1.17963981e+00 -2.43149190e-01 -2.43149190e-01
 -2.43149190e-01  8.52149530e-01  5.07050305e+00  2.11760815e+01
  8.21733662e+01  2.83357559e+02  9.16152514e+02  3.17259930e+03
  1.26563492e+04  4.12533455e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6739398185601  E_coul = 198.6832000773662
cycle= 5 E= -507.990739741194  delta_E= -1.35e-08  |g|= 6.67e-06  |ddm|= 0.000694
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.93361e-06
diis-c [-1.05207244e-12  6.25355222e-07 -6.14227532e-04  7.93686199e-03
 -9.73871138e-02  1.09006385e+00]
  HOMO = -0.243152129307521  LUMO = 0.852148715023799
  mo_energy =
[-1.20327519e+02 -1.23815535e+01 -6.67853537e+00 -6.67853537e+00
 -6.67853537e+00 -1.17964183e+00 -2.43152129e-01 -2.43152129e-01
 -2.43152129e-01  8.52148715e-01  5.07049912e+00  2.11760763e+01
  8.21733604e+01  2.83357552e+02  9.16152507e+02  3.17259929e+03
  1.26563492e+04  4.12533455e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6739248291861  E_coul = 198.68318508798245
cycle= 6 E= -507.990739741204  delta_E= -9.78e-12  |g|= 9.11e-08  |ddm|= 2.13e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6739248291861  E_coul = 198.68318508798245
  HOMO = -0.243152170751567  LUMO = 0.852148689215258
  mo_energy =
[-1.20327519e+02 -1.23815535e+01 -6.67853545e+00 -6.67853545e+00
 -6.67853545e+00 -1.17964184e+00 -2.43152171e-01 -2.43152171e-01
 -2.43152171e-01  8.52148689e-01  5.07049906e+00  2.11760762e+01
  8.21733604e+01  2.83357552e+02  9.16152507e+02  3.17259929e+03
  1.26563492e+04  4.12533455e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6739246506687  E_coul = 198.68318490946544
Extra cycle  E= -507.990739741203  delta_E= 4.55e-13  |g|= 1.17e-08  |ddm|= 2.31e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
exp = [2.26259672e-01 5.87678238e-01 1.64225725e+00 1.17616812e+05
 3.91378994e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191027e+03
 1.83757554e+04 1.44665816e+03 4.17551399e+02 1.48412121e+02
 6.02419803e+01 2.63217144e+01 8.84872099e+00 8.60405729e+00
 4.92727603e-01]
E = -507.99073974120324
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:43 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.226259671931       1
[INPUT] 0    0    [1    /1   ]  0.587678237508       1
[INPUT] 0    0    [1    /1   ]  1.64225724659        1
[INPUT] 0    0    [1    /1   ]  117616.812401        1
[INPUT] 0    0    [1    /1   ]  3.91378994106        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069943        1
[INPUT] 0    0    [1    /1   ]  294042.030846        1
[INPUT] 0    0    [1    /1   ]  147020.991024        1
[INPUT] 0    0    [1    /1   ]  73510.4162977        1
[INPUT] 0    0    [1    /1   ]  36754.6950126        1
[INPUT] 0    0    [1    /1   ]  7301.91027008        1
[INPUT] 0    0    [1    /1   ]  18375.7553502        1
[INPUT] 0    0    [1    /1   ]  1446.65816475        1
[INPUT] 0    0    [1    /1   ]  417.551399335        1
[INPUT] 0    0    [1    /1   ]  148.412120753        1
[INPUT] 0    0    [1    /1   ]  60.2419803226        1
[INPUT] 0    0    [1    /1   ]  26.3217144439        1
[INPUT] 0    0    [1    /1   ]  8.84872099185        1
[INPUT] 1    0    [1    /1   ]  8.60405728898        1
[INPUT] 1    0    [1    /1   ]  0.49272760314        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2262596719310214, 1.0]], [0, [0.5876782375078881, 1.0]], [0, [1.64225724658628, 1.0]], [0, [117616.81240078426, 1.0]], [0, [3.9137899410584502, 1.0]], [0, [1176168.1426101916, 1.0]], [0, [588084.0699425195, 1.0]], [0, [294042.0308456315, 1.0]], [0, [147020.99102381317, 1.0]], [0, [73510.41629770299, 1.0]], [0, [36754.69501257107, 1.0]], [0, [7301.910270083202, 1.0]], [0, [18375.75535024723, 1.0]], [0, [1446.6581647500386, 1.0]], [0, [417.55139933493217, 1.0]], [0, [148.41212075283005, 1.0]], [0, [60.241980322572054, 1.0]], [0, [26.32171444390103, 1.0]], [0, [8.848720991852971, 1.0]], [1, [8.604057288982819, 1.0]], [1, [0.4927276031399883, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22625967]
bas 1, expnt(s) = [0.58767824]
bas 2, expnt(s) = [1.64225725]
bas 3, expnt(s) = [117616.81240078]
bas 4, expnt(s) = [3.91378994]
bas 5, expnt(s) = [1176168.14261019]
bas 6, expnt(s) = [588084.06994252]
bas 7, expnt(s) = [294042.03084563]
bas 8, expnt(s) = [147020.99102381]
bas 9, expnt(s) = [73510.4162977]
bas 10, expnt(s) = [36754.69501257]
bas 11, expnt(s) = [7301.91027008]
bas 12, expnt(s) = [18375.75535025]
bas 13, expnt(s) = [1446.65816475]
bas 14, expnt(s) = [417.55139933]
bas 15, expnt(s) = [148.41212075]
bas 16, expnt(s) = [60.24198032]
bas 17, expnt(s) = [26.32171444]
bas 18, expnt(s) = [8.84872099]
bas 19, expnt(s) = [8.60405729]
bas 20, expnt(s) = [0.4927276]
CPU time:      1765.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.26259672e-01 8.28839403e-01 5.87678238e-01 1.69578087e+00
 1.64225725e+00 3.66518512e+00 1.17616812e+05 1.60460107e+04
 3.91378994e+00 7.03012681e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546950e+04 6.70655733e+03 7.30191027e+03 1.99568684e+03
 1.83757554e+04 3.98748373e+03 1.44665816e+03 5.92637961e+02
 4.17551399e+02 2.33371320e+02 1.48412121e+02 1.07427892e+02
 6.02419803e+01 5.46310382e+01 2.63217144e+01 2.93596351e+01
 8.84872099e+00 1.29621010e+01 8.60405729e+00 4.29896104e+01
 4.92727603e-01 1.20432308e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336121752211643
cond(S) = 912845.4698423697
E1 = -689.5951115838001  E_coul = 184.97018798047878
init E= -504.624923603321
    CPU time for initialize scf      1.03 sec, wall time      0.08 sec
  HOMO = -0.672191553225463  LUMO = 0.516227504161867
  mo_energy =
[-1.21710091e+02 -1.33863852e+01 -7.62366891e+00 -7.62366891e+00
 -7.62366891e+00 -1.65762668e+00 -6.72191553e-01 -6.72191553e-01
 -6.72191553e-01  5.16227504e-01  4.49635525e+00  2.02965026e+01
  8.09879515e+01  2.82018422e+02  9.14793691e+02  3.17131497e+03
  1.26551819e+04  4.12522494e+04  1.05279459e+05  2.30451728e+05
  4.56258595e+05  8.45204718e+05  1.52837605e+06  2.85063613e+06
  5.80851404e+06]
E1 = -707.7539848545575  E_coul = 199.78133653849565
cycle= 1 E= -507.972648316062  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.56 sec, wall time      0.03 sec
diis-norm(errvec)=0.756824
diis-c [-0.57278236  1.        ]
  HOMO = -0.217656355047898  LUMO = 0.856294637141119
  mo_energy =
[-1.20200389e+02 -1.23048147e+01 -6.59404615e+00 -6.59404615e+00
 -6.59404615e+00 -1.16335900e+00 -2.17656355e-01 -2.17656355e-01
 -2.17656355e-01  8.56294637e-01  5.10116433e+00  2.12401853e+01
  8.22680668e+01  2.83474206e+02  9.16285580e+02  3.17274737e+03
  1.26565080e+04  4.12535083e+04  1.05280680e+05  2.30452925e+05
  4.56259775e+05  8.45205885e+05  1.52837720e+06  2.85063728e+06
  5.80851518e+06]
E1 = -706.7986228125507  E_coul = 198.8081512918163
cycle= 2 E= -507.990471520734  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.381
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.035452
diis-c [-0.0012527 -0.0026995  1.0026995]
  HOMO = -0.239836545664627  LUMO = 0.852898552777303
  mo_energy =
[-1.20315406e+02 -1.23726336e+01 -6.66913722e+00 -6.66913722e+00
 -6.66913722e+00 -1.17763126e+00 -2.39836546e-01 -2.39836546e-01
 -2.39836546e-01  8.52898553e-01  5.07467590e+00  2.11837123e+01
  8.21834147e+01  2.83369022e+02  9.16164861e+02  3.17261235e+03
  1.26563627e+04  4.12533591e+04  1.05280530e+05  2.30452774e+05
  4.56259623e+05  8.45205732e+05  1.52837705e+06  2.85063713e+06
  5.80851502e+06]
E1 = -706.6900605387737  E_coul = 198.69932596444298
cycle= 3 E= -507.990734574331  delta_E= -0.000263  |g|= 0.00437  |ddm|= 0.0608
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00397177
diis-c [-3.31101237e-06  4.62042384e-05 -1.10863490e-01  1.11081729e+00]
  HOMO = -0.243009261739132  LUMO = 0.852190534025534
  mo_energy =
[-1.20327213e+02 -1.23812388e+01 -6.67822720e+00 -6.67822720e+00
 -6.67822720e+00 -1.17955495e+00 -2.43009262e-01 -2.43009262e-01
 -2.43009262e-01  8.52190534e-01  5.07068683e+00  2.11763568e+01
  8.21736662e+01  2.83357859e+02  9.16152813e+02  3.17259960e+03
  1.26563495e+04  4.12533458e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6746160431595  E_coul = 198.68387631548904
cycle= 4 E= -507.99073972767  delta_E= -5.15e-06  |g|= 0.000227  |ddm|= 0.0108
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170655
diis-c [-6.41878368e-10 -9.71768628e-06  7.02268172e-03 -9.53587041e-02
  1.08834574e+00]
  HOMO = -0.243149190439817  LUMO = 0.852149530459011
  mo_energy =
[-1.20327513e+02 -1.23815479e+01 -6.67852975e+00 -6.67852975e+00
 -6.67852975e+00 -1.17963981e+00 -2.43149190e-01 -2.43149190e-01
 -2.43149190e-01  8.52149530e-01  5.07050305e+00  2.11760815e+01
  8.21733662e+01  2.83357559e+02  9.16152514e+02  3.17259930e+03
  1.26563492e+04  4.12533455e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6739398185601  E_coul = 198.6832000773662
cycle= 5 E= -507.990739741194  delta_E= -1.35e-08  |g|= 6.67e-06  |ddm|= 0.000694
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=2.93361e-06
diis-c [-1.05207244e-12  6.25355222e-07 -6.14227532e-04  7.93686199e-03
 -9.73871138e-02  1.09006385e+00]
  HOMO = -0.243152129307521  LUMO = 0.852148715023799
  mo_energy =
[-1.20327519e+02 -1.23815535e+01 -6.67853537e+00 -6.67853537e+00
 -6.67853537e+00 -1.17964183e+00 -2.43152129e-01 -2.43152129e-01
 -2.43152129e-01  8.52148715e-01  5.07049912e+00  2.11760763e+01
  8.21733604e+01  2.83357552e+02  9.16152507e+02  3.17259929e+03
  1.26563492e+04  4.12533455e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6739248291861  E_coul = 198.68318508798245
cycle= 6 E= -507.990739741204  delta_E= -9.78e-12  |g|= 9.11e-08  |ddm|= 2.13e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.6739248291861  E_coul = 198.68318508798245
  HOMO = -0.243152170751567  LUMO = 0.852148689215258
  mo_energy =
[-1.20327519e+02 -1.23815535e+01 -6.67853545e+00 -6.67853545e+00
 -6.67853545e+00 -1.17964184e+00 -2.43152171e-01 -2.43152171e-01
 -2.43152171e-01  8.52148689e-01  5.07049906e+00  2.11760762e+01
  8.21733604e+01  2.83357552e+02  9.16152507e+02  3.17259929e+03
  1.26563492e+04  4.12533455e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6739246506687  E_coul = 198.68318490946544
Extra cycle  E= -507.990739741203  delta_E= 4.55e-13  |g|= 1.17e-08  |ddm|= 2.31e-07
    CPU time for scf_cycle      1.80 sec, wall time      0.32 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912845.4698423697
E1 = -706.6739246506687  E_coul = 198.68318490946544
init E= -507.990739741203
    CPU time for initialize scf     10.17 sec, wall time      0.46 sec
  HOMO = -0.243152176637691  LUMO = 0.852148687820833
  mo_energy =
[-1.20327519e+02 -1.23815536e+01 -6.67853546e+00 -6.67853546e+00
 -6.67853546e+00 -1.17964185e+00 -2.43152177e-01 -2.43152177e-01
 -2.43152177e-01  8.52148688e-01  5.07049905e+00  2.11760762e+01
  8.21733603e+01  2.83357552e+02  9.16152507e+02  3.17259929e+03
  1.26563492e+04  4.12533455e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6739246229895  E_coul = 198.68318488178633
cycle= 1 E= -507.990739741203  delta_E= 1.14e-13  |g|= 2.05e-09  |ddm|= 3.13e-08
    CPU time for cycle= 1      0.38 sec, wall time      0.03 sec
E1 = -706.6739246229895  E_coul = 198.68318488178633
  HOMO = -0.243152177521899  LUMO = 0.852148688322667
  mo_energy =
[-1.20327519e+02 -1.23815536e+01 -6.67853546e+00 -6.67853546e+00
 -6.67853546e+00 -1.17964185e+00 -2.43152178e-01 -2.43152178e-01
 -2.43152178e-01  8.52148688e-01  5.07049905e+00  2.11760762e+01
  8.21733603e+01  2.83357552e+02  9.16152507e+02  3.17259929e+03
  1.26563492e+04  4.12533455e+04  1.05280516e+05  2.30452760e+05
  4.56259610e+05  8.45205719e+05  1.52837704e+06  2.85063711e+06
  5.80851501e+06]
E1 = -706.6739246161536  E_coul = 198.68318487495017
Extra cycle  E= -507.990739741203  delta_E= -3.41e-13  |g|= 2.07e-09  |ddm|= 4.96e-09
    CPU time for scf_cycle     10.72 sec, wall time      0.63 sec
exp = [2.26259672e-01 5.87678238e-01 1.64225725e+00 1.17616812e+05
 3.91378994e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546950e+04 7.30191027e+03
 1.83757554e+04 1.44665816e+03 4.17551399e+02 1.48412121e+02
 6.02419803e+01 2.63217144e+01 8.84872099e+00 8.60405729e+00
 4.92727603e-01]
grad_E = [ 1.15287965e-03 -6.76295381e-04 -2.75686481e-04  5.95817516e-09
  2.69734791e-04  3.92689857e-11  1.70740127e-10  9.24331386e-10
  3.65066623e-09  1.52411375e-08  7.96117092e-08  5.02871610e-06
  1.94038775e-07 -3.78514324e-05  1.26564906e-06 -3.74569770e-05
 -3.07426186e-06  5.02374897e-05 -6.53037599e-05 -1.62062869e-04
 -7.30421625e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:51 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.219968443892       1
[INPUT] 0    0    [1    /1   ]  0.565644328827       1
[INPUT] 0    0    [1    /1   ]  1.29472208081        1
[INPUT] 0    0    [1    /1   ]  117616.812347        1
[INPUT] 0    0    [1    /1   ]  3.48452914203        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069941        1
[INPUT] 0    0    [1    /1   ]  294042.030837        1
[INPUT] 0    0    [1    /1   ]  147020.990991        1
[INPUT] 0    0    [1    /1   ]  73510.4161612        1
[INPUT] 0    0    [1    /1   ]  36754.6943           1
[INPUT] 0    0    [1    /1   ]  7301.86528649        1
[INPUT] 0    0    [1    /1   ]  18375.7536065        1
[INPUT] 0    0    [1    /1   ]  1447.00694158        1
[INPUT] 0    0    [1    /1   ]  417.476856662        1
[INPUT] 0    0    [1    /1   ]  148.815181857        1
[INPUT] 0    0    [1    /1   ]  60.3246926194        1
[INPUT] 0    0    [1    /1   ]  26.0306468178        1
[INPUT] 0    0    [1    /1   ]  8.30824323289        1
[INPUT] 1    0    [1    /1   ]  8.6041091231         1
[INPUT] 1    0    [1    /1   ]  0.492731842024       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21996844389249315, 1.0]], [0, [0.5656443288272737, 1.0]], [0, [1.294722080805752, 1.0]], [0, [117616.81234741978, 1.0]], [0, [3.484529142034888, 1.0]], [0, [1176168.1426098368, 1.0]], [0, [588084.0699409875, 1.0]], [0, [294042.03083735384, 1.0]], [0, [147020.9909911115, 1.0]], [0, [73510.41616115447, 1.0]], [0, [36754.69430001997, 1.0]], [0, [7301.8652864936485, 1.0]], [0, [18375.753606457863, 1.0]], [0, [1447.0069415818004, 1.0]], [0, [417.4768566619988, 1.0]], [0, [148.81518185710857, 1.0]], [0, [60.32469261944492, 1.0]], [0, [26.03064681784928, 1.0]], [0, [8.3082432328915, 1.0]], [1, [8.604109123097711, 1.0]], [1, [0.49273184202421577, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21996844]
bas 1, expnt(s) = [0.56564433]
bas 2, expnt(s) = [1.29472208]
bas 3, expnt(s) = [117616.81234742]
bas 4, expnt(s) = [3.48452914]
bas 5, expnt(s) = [1176168.14260984]
bas 6, expnt(s) = [588084.06994099]
bas 7, expnt(s) = [294042.03083735]
bas 8, expnt(s) = [147020.99099111]
bas 9, expnt(s) = [73510.41616115]
bas 10, expnt(s) = [36754.69430002]
bas 11, expnt(s) = [7301.86528649]
bas 12, expnt(s) = [18375.75360646]
bas 13, expnt(s) = [1447.00694158]
bas 14, expnt(s) = [417.47685666]
bas 15, expnt(s) = [148.81518186]
bas 16, expnt(s) = [60.32469262]
bas 17, expnt(s) = [26.03064682]
bas 18, expnt(s) = [8.30824323]
bas 19, expnt(s) = [8.60410912]
bas 20, expnt(s) = [0.49273184]
CPU time:      1785.88
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.19968444e-01 8.11493996e-01 5.65644329e-01 1.64786869e+00
 1.29472208e+00 3.06653157e+00 1.17616812e+05 1.60460107e+04
 3.48452914e+00 6.44351880e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104162e+04 1.12791581e+04
 3.67546943e+04 6.70655724e+03 7.30186529e+03 1.99567762e+03
 1.83757536e+04 3.98748345e+03 1.44700694e+03 5.92745117e+02
 4.17476857e+02 2.33340072e+02 1.48815182e+02 1.07646634e+02
 6.03246926e+01 5.46872849e+01 2.60306468e+01 2.91158011e+01
 8.30824323e+00 1.23636564e+01 8.60410912e+00 4.29899341e+01
 4.92731842e-01 1.20433603e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336157682701472
cond(S) = 912707.1844666521
E1 = -689.5990902005399  E_coul = 184.97204696048956
init E= -504.62704324005
    CPU time for initialize scf      7.72 sec, wall time      0.40 sec
  HOMO = -0.672115576803873  LUMO = 0.465765099169447
  mo_energy =
[-1.21709919e+02 -1.33861518e+01 -7.62354101e+00 -7.62354101e+00
 -7.62354101e+00 -1.65762043e+00 -6.72115577e-01 -6.72115577e-01
 -6.72115577e-01  4.65765099e-01  3.72807411e+00  1.72363812e+01
  7.54097880e+01  2.75962721e+02  9.09741724e+02  3.16748997e+03
  1.26525572e+04  4.12500658e+04  1.05277401e+05  2.30449728e+05
  4.56256635e+05  8.45202789e+05  1.52837415e+06  2.85063427e+06
  5.80851223e+06]
E1 = -707.7543718788639  E_coul = 199.78187023957724
cycle= 1 E= -507.972501639287  delta_E= -3.35  |g|= 0.452  |ddm|= 0.465
    CPU time for cycle= 1      0.08 sec, wall time      0.04 sec
diis-norm(errvec)=0.748824
diis-c [-0.56073671  1.        ]
  HOMO = -0.21760271253324  LUMO = 0.791029401531724
  mo_energy =
[-1.20200363e+02 -1.23046846e+01 -6.59404421e+00 -6.59404421e+00
 -6.59404421e+00 -1.16336001e+00 -2.17602713e-01 -2.17602713e-01
 -2.17602713e-01  7.91029402e-01  4.28609871e+00  1.81476346e+01
  7.66866219e+01  2.77419493e+02  9.11233869e+02  3.16892230e+03
  1.26538831e+04  4.12513246e+04  1.05278622e+05  2.30450926e+05
  4.56257815e+05  8.45203955e+05  1.52837530e+06  2.85063542e+06
  5.80851336e+06]
E1 = -706.7970330436715  E_coul = 198.80666410357696
cycle= 2 E= -507.990368940095  delta_E= -0.0179  |g|= 0.0352  |ddm|= 0.349
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0369307
diis-c [-0.00135844 -0.00312834  1.00312834]
  HOMO = -0.239884953619033  LUMO = 0.788253230546835
  mo_energy =
[-1.20315578e+02 -1.23726641e+01 -6.66929880e+00 -6.66929880e+00
 -6.66929880e+00 -1.17770429e+00 -2.39884954e-01 -2.39884954e-01
 -2.39884954e-01  7.88253231e-01  4.26347309e+00  1.80939866e+01
  7.66023144e+01  2.77314045e+02  9.11112889e+02  3.16878705e+03
  1.26537377e+04  4.12511752e+04  1.05278471e+05  2.30450774e+05
  4.56257663e+05  8.45203803e+05  1.52837515e+06  2.85063527e+06
  5.80851321e+06]
E1 = -706.6878863161093  E_coul = 198.697252038355
cycle= 3 E= -507.990634277754  delta_E= -0.000265  |g|= 0.00438  |ddm|= 0.0594
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00428974
diis-c [-3.45095151e-06 -6.05590066e-05 -1.16955236e-01  1.11701579e+00]
  HOMO = -0.243096136422206  LUMO = 0.787641197893186
  mo_energy =
[-1.20327463e+02 -1.23813407e+01 -6.67846055e+00 -6.67846055e+00
 -6.67846055e+00 -1.17965305e+00 -2.43096136e-01 -2.43096136e-01
 -2.43096136e-01  7.87641198e-01  4.25996907e+00  1.80868701e+01
  7.65925337e+01  2.77302801e+02  9.11100760e+02  3.16877422e+03
  1.26537244e+04  4.12511618e+04  1.05278458e+05  2.30450760e+05
  4.56257649e+05  8.45203789e+05  1.52837514e+06  2.85063525e+06
  5.80851320e+06]
E1 = -706.672219188056  E_coul = 198.6815796328719
cycle= 4 E= -507.990639555184  delta_E= -5.28e-06  |g|= 0.000217  |ddm|= 0.0113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000166835
diis-c [-8.19442038e-10 -1.06234149e-05  7.20691808e-03 -9.08426201e-02
  1.08364633e+00]
  HOMO = -0.243219669891031  LUMO = 0.787607191416122
  mo_energy =
[-1.20327687e+02 -1.23815985e+01 -6.67870804e+00 -6.67870804e+00
 -6.67870804e+00 -1.17972816e+00 -2.43219670e-01 -2.43219670e-01
 -2.43219670e-01  7.87607191e-01  4.25982246e+00  1.80866420e+01
  7.65922938e+01  2.77302571e+02  9.11100538e+02  3.16877401e+03
  1.26537241e+04  4.12511616e+04  1.05278458e+05  2.30450760e+05
  4.56257649e+05  8.45203789e+05  1.52837514e+06  2.85063525e+06
  5.80851320e+06]
E1 = -706.6716189938096  E_coul = 198.68097942622424
cycle= 5 E= -507.990639567585  delta_E= -1.24e-08  |g|= 8.31e-06  |ddm|= 0.000762
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.61578e-06
diis-c [-1.34600462e-12  6.96066284e-07 -7.24132995e-04  8.68039523e-03
 -1.11591539e-01  1.10363458e+00]
  HOMO = -0.243222919604109  LUMO = 0.787606317008306
  mo_energy =
[-1.20327693e+02 -1.23816042e+01 -6.67871377e+00 -6.67871377e+00
 -6.67871377e+00 -1.17973042e+00 -2.43222920e-01 -2.43222920e-01
 -2.43222920e-01  7.87606317e-01  4.25981844e+00  1.80866367e+01
  7.65922879e+01  2.77302565e+02  9.11100532e+02  3.16877400e+03
  1.26537241e+04  4.12511616e+04  1.05278458e+05  2.30450760e+05
  4.56257649e+05  8.45203789e+05  1.52837514e+06  2.85063525e+06
  5.80851320e+06]
E1 = -706.6716021396487  E_coul = 198.680962572048
cycle= 6 E= -507.990639567601  delta_E= -1.53e-11  |g|= 8.71e-08  |ddm|= 3.17e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.6716021396487  E_coul = 198.680962572048
  HOMO = -0.243222956822326  LUMO = 0.787606294058384
  mo_energy =
[-1.20327693e+02 -1.23816043e+01 -6.67871383e+00 -6.67871383e+00
 -6.67871383e+00 -1.17973043e+00 -2.43222957e-01 -2.43222957e-01
 -2.43222957e-01  7.87606294e-01  4.25981839e+00  1.80866366e+01
  7.65922879e+01  2.77302565e+02  9.11100532e+02  3.16877400e+03
  1.26537241e+04  4.12511616e+04  1.05278458e+05  2.30450760e+05
  4.56257649e+05  8.45203789e+05  1.52837514e+06  2.85063525e+06
  5.80851320e+06]
E1 = -706.6716019832041  E_coul = 198.68096241560335
Extra cycle  E= -507.990639567601  delta_E= -5.68e-14  |g|= 1.02e-08  |ddm|= 2.48e-07
    CPU time for scf_cycle      8.00 sec, wall time      0.64 sec
exp = [2.19968444e-01 5.65644329e-01 1.29472208e+00 1.17616812e+05
 3.48452914e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104162e+04 3.67546943e+04 7.30186529e+03
 1.83757536e+04 1.44700694e+03 4.17476857e+02 1.48815182e+02
 6.03246926e+01 2.60306468e+01 8.30824323e+00 8.60410912e+00
 4.92731842e-01]
E = -507.9906395676008
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:53 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.225630549127       1
[INPUT] 0    0    [1    /1   ]  0.58547484664        1
[INPUT] 0    0    [1    /1   ]  1.60750373001        1
[INPUT] 0    0    [1    /1   ]  117616.812395        1
[INPUT] 0    0    [1    /1   ]  3.87086386116        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069942        1
[INPUT] 0    0    [1    /1   ]  294042.030845        1
[INPUT] 0    0    [1    /1   ]  147020.991021        1
[INPUT] 0    0    [1    /1   ]  73510.416284         1
[INPUT] 0    0    [1    /1   ]  36754.6949413        1
[INPUT] 0    0    [1    /1   ]  7301.90577172        1
[INPUT] 0    0    [1    /1   ]  18375.7551759        1
[INPUT] 0    0    [1    /1   ]  1446.69304243        1
[INPUT] 0    0    [1    /1   ]  417.543945068        1
[INPUT] 0    0    [1    /1   ]  148.452426863        1
[INPUT] 0    0    [1    /1   ]  60.2502515523        1
[INPUT] 0    0    [1    /1   ]  26.2926076813        1
[INPUT] 0    0    [1    /1   ]  8.79467321596        1
[INPUT] 1    0    [1    /1   ]  8.60406247239        1
[INPUT] 1    0    [1    /1   ]  0.492728027028       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22563054912716857, 1.0]], [0, [0.5854748466398266, 1.0]], [0, [1.607503730008227, 1.0]], [0, [117616.8123954478, 1.0]], [0, [3.870863861156094, 1.0]], [0, [1176168.1426101562, 1.0]], [0, [588084.0699423663, 1.0]], [0, [294042.0308448037, 1.0]], [0, [147020.991020543, 1.0]], [0, [73510.41628404814, 1.0]], [0, [36754.69494131596, 1.0]], [0, [7301.905771724247, 1.0]], [0, [18375.755175868293, 1.0]], [0, [1446.6930424332147, 1.0]], [0, [417.54394506763884, 1.0]], [0, [148.4524268632579, 1.0]], [0, [60.25025155225934, 1.0]], [0, [26.292607681295856, 1.0]], [0, [8.794673215956823, 1.0]], [1, [8.604062472394308, 1.0]], [1, [0.49272802702841106, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22563055]
bas 1, expnt(s) = [0.58547485]
bas 2, expnt(s) = [1.60750373]
bas 3, expnt(s) = [117616.81239545]
bas 4, expnt(s) = [3.87086386]
bas 5, expnt(s) = [1176168.14261016]
bas 6, expnt(s) = [588084.06994237]
bas 7, expnt(s) = [294042.0308448]
bas 8, expnt(s) = [147020.99102054]
bas 9, expnt(s) = [73510.41628405]
bas 10, expnt(s) = [36754.69494132]
bas 11, expnt(s) = [7301.90577172]
bas 12, expnt(s) = [18375.75517587]
bas 13, expnt(s) = [1446.69304243]
bas 14, expnt(s) = [417.54394507]
bas 15, expnt(s) = [148.45242686]
bas 16, expnt(s) = [60.25025155]
bas 17, expnt(s) = [26.29260768]
bas 18, expnt(s) = [8.79467322]
bas 19, expnt(s) = [8.60406247]
bas 20, expnt(s) = [0.49272803]
CPU time:      1794.98
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.25630549e-01 8.27110339e-01 5.85474847e-01 1.69101011e+00
 1.60750373e+00 3.60685776e+00 1.17616812e+05 1.60460107e+04
 3.87086386e+00 6.97221783e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546949e+04 6.70655733e+03 7.30190577e+03 1.99568592e+03
 1.83757552e+04 3.98748370e+03 1.44669304e+03 5.92648676e+02
 4.17543945e+02 2.33368195e+02 1.48452427e+02 1.07449773e+02
 6.02502516e+01 5.46366638e+01 2.62926077e+01 2.93352822e+01
 8.79467322e+00 1.29026764e+01 8.60406247e+00 4.29896428e+01
 4.92728027e-01 1.20432437e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33612460375006
cond(S) = 912831.2713452169
E1 = -689.5954144691523  E_coul = 184.97035977667318
init E= -504.625054692479
    CPU time for initialize scf      7.33 sec, wall time      0.36 sec
  HOMO = -0.672185687271808  LUMO = 0.511313616716052
  mo_energy =
[-1.21710075e+02 -1.33863658e+01 -7.62365628e+00 -7.62365628e+00
 -7.62365628e+00 -1.65763136e+00 -6.72185687e-01 -6.72185687e-01
 -6.72185687e-01  5.11313617e-01  4.41820783e+00  1.99911905e+01
  8.04336311e+01  2.81412928e+02  9.14286844e+02  3.17093054e+03
  1.26549176e+04  4.12520293e+04  1.05279251e+05  2.30451526e+05
  4.56258398e+05  8.45204523e+05  1.52837585e+06  2.85063595e+06
  5.80851386e+06]
E1 = -707.7542467185405  E_coul = 199.78160125654477
cycle= 1 E= -507.972645461996  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.51 sec, wall time      0.03 sec
diis-norm(errvec)=0.75624
diis-c [-0.57189907  1.        ]
  HOMO = -0.217649305716883  LUMO = 0.849987161112824
  mo_energy =
[-1.20200363e+02 -1.23047884e+01 -6.59402647e+00 -6.59402647e+00
 -6.59402647e+00 -1.16335948e+00 -2.17649306e-01 -2.17649306e-01
 -2.17649306e-01  8.49987161e-01  5.01858296e+00  2.09318744e+01
  8.17134305e+01  2.82868828e+02  9.15778784e+02  3.17236296e+03
  1.26562437e+04  4.12532882e+04  1.05280473e+05  2.30452724e+05
  4.56259578e+05  8.45205690e+05  1.52837701e+06  2.85063709e+06
  5.80851499e+06]
E1 = -706.7986774310061  E_coul = 198.80820444545532
cycle= 2 E= -507.990472985551  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.379
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.035604
diis-c [-0.00126333 -0.00275789  1.00275789]
  HOMO = -0.239838527277738  LUMO = 0.846651534375841
  mo_energy =
[-1.20315404e+02 -1.23726262e+01 -6.66913702e+00 -6.66913702e+00
 -6.66913702e+00 -1.17763812e+00 -2.39838527e-01 -2.39838527e-01
 -2.39838527e-01  8.46651534e-01  4.99246301e+00  2.08756577e+01
  8.16288080e+01  2.82763614e+02  9.15658034e+02  3.17222791e+03
  1.26560984e+04  4.12531391e+04  1.05280322e+05  2.30452572e+05
  4.56259426e+05  8.45205538e+05  1.52837686e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.6900577797413  E_coul = 198.69932152751474
cycle= 3 E= -507.990736252227  delta_E= -0.000263  |g|= 0.00437  |ddm|= 0.0607
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00400212
diis-c [-3.32924414e-06  3.77822773e-05 -1.11415157e-01  1.11137737e+00]
  HOMO = -0.243014324770237  LUMO = 0.845952698655213
  mo_energy =
[-1.20327216e+02 -1.23812369e+01 -6.67823234e+00 -6.67823234e+00
 -6.67823234e+00 -1.17956383e+00 -2.43014325e-01 -2.43014325e-01
 -2.43014325e-01  8.45952699e-01  4.98851986e+00  2.08683247e+01
  8.16190582e+01  2.82752446e+02  9.15645981e+02  3.17221515e+03
  1.26560852e+04  4.12531257e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.6745937150472  E_coul = 198.68385229775294
cycle= 4 E= -507.990741417294  delta_E= -5.17e-06  |g|= 0.000226  |ddm|= 0.0109
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170431
diis-c [-6.59720336e-10 -9.80409565e-06  7.03587735e-03 -9.49111886e-02
  1.08788512e+00]
  HOMO = -0.243152810324681  LUMO = 0.845912375561971
  mo_energy =
[-1.20327509e+02 -1.23815413e+01 -6.67852992e+00 -6.67852992e+00
 -6.67852992e+00 -1.17964784e+00 -2.43152810e-01 -2.43152810e-01
 -2.43152810e-01  8.45912376e-01  4.98833968e+00  2.08680537e+01
  8.16187637e+01  2.82752152e+02  9.15645689e+02  3.17221486e+03
  1.26560849e+04  4.12531254e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.673924074581  E_coul = 198.6831826438545
cycle= 5 E= -507.990741430727  delta_E= -1.34e-08  |g|= 6.83e-06  |ddm|= 0.000699
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.00234e-06
diis-c [-1.08013816e-12  6.28915855e-07 -6.24819954e-04  8.02072855e-03
 -9.88747474e-02  1.09147821e+00]
  HOMO = -0.24315579419702  LUMO = 0.845911549044252
  mo_energy =
[-1.20327516e+02 -1.23815469e+01 -6.67853558e+00 -6.67853558e+00
 -6.67853558e+00 -1.17964989e+00 -2.43155794e-01 -2.43155794e-01
 -2.43155794e-01  8.45911549e-01  4.98833572e+00  2.08680485e+01
  8.16187578e+01  2.82752145e+02  9.15645682e+02  3.17221486e+03
  1.26560849e+04  4.12531254e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.6739088384653  E_coul = 198.68316740772872
cycle= 6 E= -507.990741430737  delta_E= -1.01e-11  |g|= 9.14e-08  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.6739088384653  E_coul = 198.68316740772872
  HOMO = -0.243155835295152  LUMO = 0.845911524013242
  mo_energy =
[-1.20327516e+02 -1.23815470e+01 -6.67853566e+00 -6.67853566e+00
 -6.67853566e+00 -1.17964991e+00 -2.43155835e-01 -2.43155835e-01
 -2.43155835e-01  8.45911524e-01  4.98833566e+00  2.08680484e+01
  8.16187578e+01  2.82752145e+02  9.15645682e+02  3.17221486e+03
  1.26560849e+04  4.12531254e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.6739086605531  E_coul = 198.6831672298166
Extra cycle  E= -507.990741430737  delta_E= 5.68e-14  |g|= 1.18e-08  |ddm|= 2.33e-07
    CPU time for scf_cycle      8.07 sec, wall time      0.60 sec
exp = [2.25630549e-01 5.85474847e-01 1.60750373e+00 1.17616812e+05
 3.87086386e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546949e+04 7.30190577e+03
 1.83757552e+04 1.44669304e+03 4.17543945e+02 1.48452427e+02
 6.02502516e+01 2.62926077e+01 8.79467322e+00 8.60406247e+00
 4.92728027e-01]
E = -507.99074143073653
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:38:55 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.225630549127       1
[INPUT] 0    0    [1    /1   ]  0.58547484664        1
[INPUT] 0    0    [1    /1   ]  1.60750373001        1
[INPUT] 0    0    [1    /1   ]  117616.812395        1
[INPUT] 0    0    [1    /1   ]  3.87086386116        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069942        1
[INPUT] 0    0    [1    /1   ]  294042.030845        1
[INPUT] 0    0    [1    /1   ]  147020.991021        1
[INPUT] 0    0    [1    /1   ]  73510.416284         1
[INPUT] 0    0    [1    /1   ]  36754.6949413        1
[INPUT] 0    0    [1    /1   ]  7301.90577172        1
[INPUT] 0    0    [1    /1   ]  18375.7551759        1
[INPUT] 0    0    [1    /1   ]  1446.69304243        1
[INPUT] 0    0    [1    /1   ]  417.543945068        1
[INPUT] 0    0    [1    /1   ]  148.452426863        1
[INPUT] 0    0    [1    /1   ]  60.2502515523        1
[INPUT] 0    0    [1    /1   ]  26.2926076813        1
[INPUT] 0    0    [1    /1   ]  8.79467321596        1
[INPUT] 1    0    [1    /1   ]  8.60406247239        1
[INPUT] 1    0    [1    /1   ]  0.492728027028       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22563054912716857, 1.0]], [0, [0.5854748466398266, 1.0]], [0, [1.607503730008227, 1.0]], [0, [117616.8123954478, 1.0]], [0, [3.870863861156094, 1.0]], [0, [1176168.1426101562, 1.0]], [0, [588084.0699423663, 1.0]], [0, [294042.0308448037, 1.0]], [0, [147020.991020543, 1.0]], [0, [73510.41628404814, 1.0]], [0, [36754.69494131596, 1.0]], [0, [7301.905771724247, 1.0]], [0, [18375.755175868293, 1.0]], [0, [1446.6930424332147, 1.0]], [0, [417.54394506763884, 1.0]], [0, [148.4524268632579, 1.0]], [0, [60.25025155225934, 1.0]], [0, [26.292607681295856, 1.0]], [0, [8.794673215956823, 1.0]], [1, [8.604062472394308, 1.0]], [1, [0.49272802702841106, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22563055]
bas 1, expnt(s) = [0.58547485]
bas 2, expnt(s) = [1.60750373]
bas 3, expnt(s) = [117616.81239545]
bas 4, expnt(s) = [3.87086386]
bas 5, expnt(s) = [1176168.14261016]
bas 6, expnt(s) = [588084.06994237]
bas 7, expnt(s) = [294042.0308448]
bas 8, expnt(s) = [147020.99102054]
bas 9, expnt(s) = [73510.41628405]
bas 10, expnt(s) = [36754.69494132]
bas 11, expnt(s) = [7301.90577172]
bas 12, expnt(s) = [18375.75517587]
bas 13, expnt(s) = [1446.69304243]
bas 14, expnt(s) = [417.54394507]
bas 15, expnt(s) = [148.45242686]
bas 16, expnt(s) = [60.25025155]
bas 17, expnt(s) = [26.29260768]
bas 18, expnt(s) = [8.79467322]
bas 19, expnt(s) = [8.60406247]
bas 20, expnt(s) = [0.49272803]
CPU time:      1803.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.25630549e-01 8.27110339e-01 5.85474847e-01 1.69101011e+00
 1.60750373e+00 3.60685776e+00 1.17616812e+05 1.60460107e+04
 3.87086386e+00 6.97221783e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104163e+04 1.12791581e+04
 3.67546949e+04 6.70655733e+03 7.30190577e+03 1.99568592e+03
 1.83757552e+04 3.98748370e+03 1.44669304e+03 5.92648676e+02
 4.17543945e+02 2.33368195e+02 1.48452427e+02 1.07449773e+02
 6.02502516e+01 5.46366638e+01 2.62926077e+01 2.93352822e+01
 8.79467322e+00 1.29026764e+01 8.60406247e+00 4.29896428e+01
 4.92728027e-01 1.20432437e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33612460375006
cond(S) = 912831.2713452169
E1 = -689.5954144691523  E_coul = 184.97035977667318
init E= -504.625054692479
    CPU time for initialize scf      8.07 sec, wall time      0.39 sec
  HOMO = -0.672185687271808  LUMO = 0.511313616716052
  mo_energy =
[-1.21710075e+02 -1.33863658e+01 -7.62365628e+00 -7.62365628e+00
 -7.62365628e+00 -1.65763136e+00 -6.72185687e-01 -6.72185687e-01
 -6.72185687e-01  5.11313617e-01  4.41820783e+00  1.99911905e+01
  8.04336311e+01  2.81412928e+02  9.14286844e+02  3.17093054e+03
  1.26549176e+04  4.12520293e+04  1.05279251e+05  2.30451526e+05
  4.56258398e+05  8.45204523e+05  1.52837585e+06  2.85063595e+06
  5.80851386e+06]
E1 = -707.7542467185405  E_coul = 199.78160125654477
cycle= 1 E= -507.972645461996  delta_E= -3.35  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.45 sec, wall time      0.03 sec
diis-norm(errvec)=0.75624
diis-c [-0.57189907  1.        ]
  HOMO = -0.217649305716883  LUMO = 0.849987161112824
  mo_energy =
[-1.20200363e+02 -1.23047884e+01 -6.59402647e+00 -6.59402647e+00
 -6.59402647e+00 -1.16335948e+00 -2.17649306e-01 -2.17649306e-01
 -2.17649306e-01  8.49987161e-01  5.01858296e+00  2.09318744e+01
  8.17134305e+01  2.82868828e+02  9.15778784e+02  3.17236296e+03
  1.26562437e+04  4.12532882e+04  1.05280473e+05  2.30452724e+05
  4.56259578e+05  8.45205690e+05  1.52837701e+06  2.85063709e+06
  5.80851499e+06]
E1 = -706.7986774310061  E_coul = 198.80820444545532
cycle= 2 E= -507.990472985551  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.379
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.035604
diis-c [-0.00126333 -0.00275789  1.00275789]
  HOMO = -0.239838527277738  LUMO = 0.846651534375841
  mo_energy =
[-1.20315404e+02 -1.23726262e+01 -6.66913702e+00 -6.66913702e+00
 -6.66913702e+00 -1.17763812e+00 -2.39838527e-01 -2.39838527e-01
 -2.39838527e-01  8.46651534e-01  4.99246301e+00  2.08756577e+01
  8.16288080e+01  2.82763614e+02  9.15658034e+02  3.17222791e+03
  1.26560984e+04  4.12531391e+04  1.05280322e+05  2.30452572e+05
  4.56259426e+05  8.45205538e+05  1.52837686e+06  2.85063694e+06
  5.80851484e+06]
E1 = -706.6900577797413  E_coul = 198.69932152751474
cycle= 3 E= -507.990736252227  delta_E= -0.000263  |g|= 0.00437  |ddm|= 0.0607
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00400212
diis-c [-3.32924414e-06  3.77822773e-05 -1.11415157e-01  1.11137737e+00]
  HOMO = -0.243014324770237  LUMO = 0.845952698655213
  mo_energy =
[-1.20327216e+02 -1.23812369e+01 -6.67823234e+00 -6.67823234e+00
 -6.67823234e+00 -1.17956383e+00 -2.43014325e-01 -2.43014325e-01
 -2.43014325e-01  8.45952699e-01  4.98851986e+00  2.08683247e+01
  8.16190582e+01  2.82752446e+02  9.15645981e+02  3.17221515e+03
  1.26560852e+04  4.12531257e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.6745937150472  E_coul = 198.68385229775294
cycle= 4 E= -507.990741417294  delta_E= -5.17e-06  |g|= 0.000226  |ddm|= 0.0109
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000170431
diis-c [-6.59720336e-10 -9.80409565e-06  7.03587735e-03 -9.49111886e-02
  1.08788512e+00]
  HOMO = -0.243152810324681  LUMO = 0.845912375561971
  mo_energy =
[-1.20327509e+02 -1.23815413e+01 -6.67852992e+00 -6.67852992e+00
 -6.67852992e+00 -1.17964784e+00 -2.43152810e-01 -2.43152810e-01
 -2.43152810e-01  8.45912376e-01  4.98833968e+00  2.08680537e+01
  8.16187637e+01  2.82752152e+02  9.15645689e+02  3.17221486e+03
  1.26560849e+04  4.12531254e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.673924074581  E_coul = 198.6831826438545
cycle= 5 E= -507.990741430727  delta_E= -1.34e-08  |g|= 6.83e-06  |ddm|= 0.000699
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.00234e-06
diis-c [-1.08013816e-12  6.28915855e-07 -6.24819954e-04  8.02072855e-03
 -9.88747474e-02  1.09147821e+00]
  HOMO = -0.24315579419702  LUMO = 0.845911549044252
  mo_energy =
[-1.20327516e+02 -1.23815469e+01 -6.67853558e+00 -6.67853558e+00
 -6.67853558e+00 -1.17964989e+00 -2.43155794e-01 -2.43155794e-01
 -2.43155794e-01  8.45911549e-01  4.98833572e+00  2.08680485e+01
  8.16187578e+01  2.82752145e+02  9.15645682e+02  3.17221486e+03
  1.26560849e+04  4.12531254e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.6739088384653  E_coul = 198.68316740772872
cycle= 6 E= -507.990741430737  delta_E= -1.01e-11  |g|= 9.14e-08  |ddm|= 2.22e-05
    CPU time for cycle= 6      0.04 sec, wall time      0.04 sec
E1 = -706.6739088384653  E_coul = 198.68316740772872
  HOMO = -0.243155835295152  LUMO = 0.845911524013242
  mo_energy =
[-1.20327516e+02 -1.23815470e+01 -6.67853566e+00 -6.67853566e+00
 -6.67853566e+00 -1.17964991e+00 -2.43155835e-01 -2.43155835e-01
 -2.43155835e-01  8.45911524e-01  4.98833566e+00  2.08680484e+01
  8.16187578e+01  2.82752145e+02  9.15645682e+02  3.17221486e+03
  1.26560849e+04  4.12531254e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.6739086605531  E_coul = 198.6831672298166
Extra cycle  E= -507.990741430737  delta_E= 5.68e-14  |g|= 1.18e-08  |ddm|= 2.33e-07
    CPU time for scf_cycle      8.74 sec, wall time      0.63 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912831.2713452169
E1 = -706.6739086605531  E_coul = 198.6831672298166
init E= -507.990741430737
    CPU time for initialize scf     15.85 sec, wall time      0.70 sec
  HOMO = -0.243155841169481  LUMO = 0.84591152364863
  mo_energy =
[-1.20327516e+02 -1.23815470e+01 -6.67853567e+00 -6.67853567e+00
 -6.67853567e+00 -1.17964991e+00 -2.43155841e-01 -2.43155841e-01
 -2.43155841e-01  8.45911524e-01  4.98833565e+00  2.08680484e+01
  8.16187577e+01  2.82752145e+02  9.15645682e+02  3.17221486e+03
  1.26560849e+04  4.12531254e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.6739086308356  E_coul = 198.68316720009935
cycle= 1 E= -507.990741430736  delta_E= 2.27e-13  |g|= 3.6e-09  |ddm|= 3.23e-08
    CPU time for cycle= 1      0.04 sec, wall time      0.04 sec
E1 = -706.6739086308356  E_coul = 198.68316720009935
  HOMO = -0.243155842109017  LUMO = 0.845911522697744
  mo_energy =
[-1.20327516e+02 -1.23815470e+01 -6.67853568e+00 -6.67853568e+00
 -6.67853568e+00 -1.17964991e+00 -2.43155842e-01 -2.43155842e-01
 -2.43155842e-01  8.45911523e-01  4.98833565e+00  2.08680484e+01
  8.16187577e+01  2.82752145e+02  9.15645682e+02  3.17221486e+03
  1.26560849e+04  4.12531254e+04  1.05280309e+05  2.30452559e+05
  4.56259412e+05  8.45205524e+05  1.52837684e+06  2.85063693e+06
  5.80851483e+06]
E1 = -706.6739086250655  E_coul = 198.6831671943294
Extra cycle  E= -507.990741430736  delta_E= 2.27e-13  |g|= 1.36e-09  |ddm|= 6.12e-09
    CPU time for scf_cycle     16.06 sec, wall time      0.91 sec
exp = [2.25630549e-01 5.85474847e-01 1.60750373e+00 1.17616812e+05
 3.87086386e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104163e+04 3.67546949e+04 7.30190577e+03
 1.83757552e+04 1.44669304e+03 4.17543945e+02 1.48452427e+02
 6.02502516e+01 2.62926077e+01 8.79467322e+00 8.60406247e+00
 4.92728027e-01]
grad_E = [ 8.27977199e-04 -4.82086596e-04 -2.31826891e-04  5.95260321e-09
  1.83047862e-04  3.92062063e-11  1.70557473e-10  9.23476307e-10
  3.64721543e-09  1.52265429e-08  7.95412677e-08  5.02433635e-06
  1.93808864e-07 -3.77037707e-05  4.25840232e-07 -3.61112739e-05
 -2.70753980e-06  5.08001814e-05 -4.24053856e-05 -1.58725958e-04
 -6.92311590e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:04 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.221874249555       1
[INPUT] 0    0    [1    /1   ]  0.571543576175       1
[INPUT] 0    0    [1    /1   ]  1.43565505295        1
[INPUT] 0    0    [1    /1   ]  117616.812287        1
[INPUT] 0    0    [1    /1   ]  3.71481705908        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069939        1
[INPUT] 0    0    [1    /1   ]  294042.030828        1
[INPUT] 0    0    [1    /1   ]  147020.990954        1
[INPUT] 0    0    [1    /1   ]  73510.4160054        1
[INPUT] 0    0    [1    /1   ]  36754.6934875        1
[INPUT] 0    0    [1    /1   ]  7301.814066          1
[INPUT] 0    0    [1    /1   ]  18375.7516143        1
[INPUT] 0    0    [1    /1   ]  1447.39603645        1
[INPUT] 0    0    [1    /1   ]  417.510401801        1
[INPUT] 0    0    [1    /1   ]  148.859707005        1
[INPUT] 0    0    [1    /1   ]  60.546721097         1
[INPUT] 0    0    [1    /1   ]  26.3109841311        1
[INPUT] 0    0    [1    /1   ]  8.61827458074        1
[INPUT] 1    0    [1    /1   ]  8.60418273526        1
[INPUT] 1    0    [1    /1   ]  0.492739206103       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22187424955495547, 1.0]], [0, [0.5715435761748702, 1.0]], [0, [1.4356550529527434, 1.0]], [0, [117616.81228654983, 1.0]], [0, [3.7148170590788645, 1.0]], [0, [1176168.1426094305, 1.0]], [0, [588084.0699392387, 1.0]], [0, [294042.0308279125, 1.0]], [0, [147020.99095380816, 1.0]], [0, [73510.41600538045, 1.0]], [0, [36754.693487536846, 1.0]], [0, [7301.814065997159, 1.0]], [0, [18375.751614272176, 1.0]], [0, [1447.3960364493532, 1.0]], [0, [417.5104018007295, 1.0]], [0, [148.85970700544718, 1.0]], [0, [60.54672109695698, 1.0]], [0, [26.31098413110807, 1.0]], [0, [8.618274580736822, 1.0]], [1, [8.604182735257888, 1.0]], [1, [0.4927392061028909, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22187425]
bas 1, expnt(s) = [0.57154358]
bas 2, expnt(s) = [1.43565505]
bas 3, expnt(s) = [117616.81228655]
bas 4, expnt(s) = [3.71481706]
bas 5, expnt(s) = [1176168.14260943]
bas 6, expnt(s) = [588084.06993924]
bas 7, expnt(s) = [294042.03082791]
bas 8, expnt(s) = [147020.99095381]
bas 9, expnt(s) = [73510.41600538]
bas 10, expnt(s) = [36754.69348754]
bas 11, expnt(s) = [7301.814066]
bas 12, expnt(s) = [18375.75161427]
bas 13, expnt(s) = [1447.39603645]
bas 14, expnt(s) = [417.5104018]
bas 15, expnt(s) = [148.85970701]
bas 16, expnt(s) = [60.5467211]
bas 17, expnt(s) = [26.31098413]
bas 18, expnt(s) = [8.61827458]
bas 19, expnt(s) = [8.60418274]
bas 20, expnt(s) = [0.49273921]
CPU time:      1836.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.21874250e-01 8.16761391e-01 5.71543576e-01 1.66074149e+00
 1.43565505e+00 3.31361923e+00 1.17616812e+05 1.60460107e+04
 3.71481706e+00 6.76033314e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104160e+04 1.12791581e+04
 3.67546935e+04 6.70655713e+03 7.30181407e+03 1.99566712e+03
 1.83757516e+04 3.98748312e+03 1.44739604e+03 5.92864653e+02
 4.17510402e+02 2.33354134e+02 1.48859707e+02 1.07670789e+02
 6.05467211e+01 5.48381754e+01 2.63109841e+01 2.93506581e+01
 8.61827458e+00 1.27080896e+01 8.60418274e+00 4.29903939e+01
 4.92739206e-01 1.20435853e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33612363438146
cond(S) = 912815.5931865873
E1 = -689.5974075815905  E_coul = 184.97180091697518
init E= -504.625606664615
    CPU time for initialize scf      0.73 sec, wall time      0.07 sec
  HOMO = -0.672155021576166  LUMO = 0.483283829374641
  mo_energy =
[-1.21709905e+02 -1.33862158e+01 -7.62355284e+00 -7.62355284e+00
 -7.62355284e+00 -1.65763863e+00 -6.72155022e-01 -6.72155022e-01
 -6.72155022e-01  4.83283829e-01  4.04064135e+00  1.86938632e+01
  7.84932282e+01  2.80139062e+02  9.14347739e+02  3.17232650e+03
  1.26576819e+04  4.12550966e+04  1.05282265e+05  2.30454458e+05
  4.56261264e+05  8.45207341e+05  1.52837863e+06  2.85063866e+06
  5.80851650e+06]
E1 = -707.7561864756836  E_coul = 199.7835442690758
cycle= 1 E= -507.972642206608  delta_E= -3.35  |g|= 0.452  |ddm|= 0.485
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.752768
diis-c [-0.56665972  1.        ]
  HOMO = -0.217597226899859  LUMO = 0.814279117011188
  mo_energy =
[-1.20200144e+02 -1.23046118e+01 -6.59389469e+00 -6.59389469e+00
 -6.59389469e+00 -1.16333829e+00 -2.17597227e-01 -2.17597227e-01
 -2.17597227e-01  8.14279117e-01  4.61994217e+00  1.96232861e+01
  7.97732848e+01  2.81595860e+02  9.15839915e+02  3.17375899e+03
  1.26590080e+04  4.12563556e+04  1.05283487e+05  2.30455656e+05
  4.56262445e+05  8.45208508e+05  1.52837978e+06  2.85063981e+06
  5.80851764e+06]
E1 = -706.7999747992473  E_coul = 198.8094923448435
cycle= 2 E= -507.990482454404  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.364
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0363631
diis-c [-0.00131737 -0.00295532  1.00295532]
  HOMO = -0.239818163551034  LUMO = 0.811266242379896
  mo_energy =
[-1.20315258e+02 -1.23725077e+01 -6.66906456e+00 -6.66906456e+00
 -6.66906456e+00 -1.17763959e+00 -2.39818164e-01 -2.39818164e-01
 -2.39818164e-01  8.11266242e-01  4.59562467e+00  1.95681211e+01
  7.96886795e+01  2.81490490e+02  9.15719057e+02  3.17362385e+03
  1.26588626e+04  4.12562063e+04  1.05283336e+05  2.30455504e+05
  4.56262292e+05  8.45208356e+05  1.52837963e+06  2.85063965e+06
  5.80851748e+06]
E1 = -706.6910787793445  E_coul = 198.7003318824257
cycle= 3 E= -507.990746896919  delta_E= -0.000264  |g|= 0.00438  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00416337
diis-c [-3.40721001e-06 -1.77142215e-05 -1.14484443e-01  1.11450216e+00]
  HOMO = -0.243012827584558  LUMO = 0.810616479798842
  mo_energy =
[-1.20327110e+02 -1.23811546e+01 -6.67819638e+00 -6.67819638e+00
 -6.67819638e+00 -1.17957766e+00 -2.43012828e-01 -2.43012828e-01
 -2.43012828e-01  8.10616480e-01  4.59190184e+00  1.95608676e+01
  7.96788991e+01  2.81479277e+02  9.15706962e+02  3.17361106e+03
  1.26588494e+04  4.12561929e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.675488087511  E_coul = 198.68473594596904
cycle= 4 E= -507.990752141542  delta_E= -5.24e-06  |g|= 0.000222  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169149
diis-c [-7.63862464e-10 -1.02695495e-05  7.14198181e-03 -9.28338423e-02
  1.08570213e+00]
  HOMO = -0.243143712067635  LUMO = 0.810579615758693
  mo_energy =
[-1.20327367e+02 -1.23814346e+01 -6.67846754e+00 -6.67846754e+00
 -6.67846754e+00 -1.17965716e+00 -2.43143712e-01 -2.43143712e-01
 -2.43143712e-01  8.10579616e-01  4.59173914e+00  1.95606189e+01
  7.96786335e+01  2.81479017e+02  9.15706707e+02  3.17361081e+03
  1.26588491e+04  4.12561926e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.6748524224894  E_coul = 198.68410026791108
cycle= 5 E= -507.990752154578  delta_E= -1.3e-08  |g|= 7.72e-06  |ddm|= 0.000733
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.38533e-06
diis-c [-1.23534010e-12  6.69433554e-07 -6.83355142e-04  8.44613786e-03
 -1.06434683e-01  1.09867123e+00]
  HOMO = -0.243146905963703  LUMO = 0.810578748021932
  mo_energy =
[-1.20327373e+02 -1.23814404e+01 -6.67847339e+00 -6.67847339e+00
 -6.67847339e+00 -1.17965937e+00 -2.43146906e-01 -2.43146906e-01
 -2.43146906e-01  8.10578748e-01  4.59173504e+00  1.95606135e+01
  7.96786275e+01  2.81479011e+02  9.15706701e+02  3.17361080e+03
  1.26588491e+04  4.12561926e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.6748359457299  E_coul = 198.68408379113825
cycle= 6 E= -507.990752154592  delta_E= -1.33e-11  |g|= 8.72e-08  |ddm|= 2.71e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6748359457299  E_coul = 198.68408379113825
  HOMO = -0.243146944924843  LUMO = 0.810578723217451
  mo_energy =
[-1.20327373e+02 -1.23814404e+01 -6.67847346e+00 -6.67847346e+00
 -6.67847346e+00 -1.17965938e+00 -2.43146945e-01 -2.43146945e-01
 -2.43146945e-01  8.10578723e-01  4.59173498e+00  1.95606134e+01
  7.96786274e+01  2.81479011e+02  9.15706701e+02  3.17361080e+03
  1.26588491e+04  4.12561926e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.6748357837289  E_coul = 198.68408362913743
Extra cycle  E= -507.990752154591  delta_E= 1.71e-13  |g|= 1.08e-08  |ddm|= 2.32e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.30 sec
exp = [2.21874250e-01 5.71543576e-01 1.43565505e+00 1.17616812e+05
 3.71481706e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104160e+04 3.67546935e+04 7.30181407e+03
 1.83757516e+04 1.44739604e+03 4.17510402e+02 1.48859707e+02
 6.05467211e+01 2.63109841e+01 8.61827458e+00 8.60418274e+00
 4.92739206e-01]
E = -507.99075215459146
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.221874249555       1
[INPUT] 0    0    [1    /1   ]  0.571543576175       1
[INPUT] 0    0    [1    /1   ]  1.43565505295        1
[INPUT] 0    0    [1    /1   ]  117616.812287        1
[INPUT] 0    0    [1    /1   ]  3.71481705908        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069939        1
[INPUT] 0    0    [1    /1   ]  294042.030828        1
[INPUT] 0    0    [1    /1   ]  147020.990954        1
[INPUT] 0    0    [1    /1   ]  73510.4160054        1
[INPUT] 0    0    [1    /1   ]  36754.6934875        1
[INPUT] 0    0    [1    /1   ]  7301.814066          1
[INPUT] 0    0    [1    /1   ]  18375.7516143        1
[INPUT] 0    0    [1    /1   ]  1447.39603645        1
[INPUT] 0    0    [1    /1   ]  417.510401801        1
[INPUT] 0    0    [1    /1   ]  148.859707005        1
[INPUT] 0    0    [1    /1   ]  60.546721097         1
[INPUT] 0    0    [1    /1   ]  26.3109841311        1
[INPUT] 0    0    [1    /1   ]  8.61827458074        1
[INPUT] 1    0    [1    /1   ]  8.60418273526        1
[INPUT] 1    0    [1    /1   ]  0.492739206103       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22187424955495547, 1.0]], [0, [0.5715435761748702, 1.0]], [0, [1.4356550529527434, 1.0]], [0, [117616.81228654983, 1.0]], [0, [3.7148170590788645, 1.0]], [0, [1176168.1426094305, 1.0]], [0, [588084.0699392387, 1.0]], [0, [294042.0308279125, 1.0]], [0, [147020.99095380816, 1.0]], [0, [73510.41600538045, 1.0]], [0, [36754.693487536846, 1.0]], [0, [7301.814065997159, 1.0]], [0, [18375.751614272176, 1.0]], [0, [1447.3960364493532, 1.0]], [0, [417.5104018007295, 1.0]], [0, [148.85970700544718, 1.0]], [0, [60.54672109695698, 1.0]], [0, [26.31098413110807, 1.0]], [0, [8.618274580736822, 1.0]], [1, [8.604182735257888, 1.0]], [1, [0.4927392061028909, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22187425]
bas 1, expnt(s) = [0.57154358]
bas 2, expnt(s) = [1.43565505]
bas 3, expnt(s) = [117616.81228655]
bas 4, expnt(s) = [3.71481706]
bas 5, expnt(s) = [1176168.14260943]
bas 6, expnt(s) = [588084.06993924]
bas 7, expnt(s) = [294042.03082791]
bas 8, expnt(s) = [147020.99095381]
bas 9, expnt(s) = [73510.41600538]
bas 10, expnt(s) = [36754.69348754]
bas 11, expnt(s) = [7301.814066]
bas 12, expnt(s) = [18375.75161427]
bas 13, expnt(s) = [1447.39603645]
bas 14, expnt(s) = [417.5104018]
bas 15, expnt(s) = [148.85970701]
bas 16, expnt(s) = [60.5467211]
bas 17, expnt(s) = [26.31098413]
bas 18, expnt(s) = [8.61827458]
bas 19, expnt(s) = [8.60418274]
bas 20, expnt(s) = [0.49273921]
CPU time:      1838.72
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.21874250e-01 8.16761391e-01 5.71543576e-01 1.66074149e+00
 1.43565505e+00 3.31361923e+00 1.17616812e+05 1.60460107e+04
 3.71481706e+00 6.76033314e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104160e+04 1.12791581e+04
 3.67546935e+04 6.70655713e+03 7.30181407e+03 1.99566712e+03
 1.83757516e+04 3.98748312e+03 1.44739604e+03 5.92864653e+02
 4.17510402e+02 2.33354134e+02 1.48859707e+02 1.07670789e+02
 6.05467211e+01 5.48381754e+01 2.63109841e+01 2.93506581e+01
 8.61827458e+00 1.27080896e+01 8.60418274e+00 4.29903939e+01
 4.92739206e-01 1.20435853e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33612363438146
cond(S) = 912815.5931865873
E1 = -689.5974075815905  E_coul = 184.97180091697518
init E= -504.625606664615
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672155021576166  LUMO = 0.483283829374641
  mo_energy =
[-1.21709905e+02 -1.33862158e+01 -7.62355284e+00 -7.62355284e+00
 -7.62355284e+00 -1.65763863e+00 -6.72155022e-01 -6.72155022e-01
 -6.72155022e-01  4.83283829e-01  4.04064135e+00  1.86938632e+01
  7.84932282e+01  2.80139062e+02  9.14347739e+02  3.17232650e+03
  1.26576819e+04  4.12550966e+04  1.05282265e+05  2.30454458e+05
  4.56261264e+05  8.45207341e+05  1.52837863e+06  2.85063866e+06
  5.80851650e+06]
E1 = -707.7561864756836  E_coul = 199.7835442690758
cycle= 1 E= -507.972642206608  delta_E= -3.35  |g|= 0.452  |ddm|= 0.485
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.752768
diis-c [-0.56665972  1.        ]
  HOMO = -0.217597226899859  LUMO = 0.814279117011188
  mo_energy =
[-1.20200144e+02 -1.23046118e+01 -6.59389469e+00 -6.59389469e+00
 -6.59389469e+00 -1.16333829e+00 -2.17597227e-01 -2.17597227e-01
 -2.17597227e-01  8.14279117e-01  4.61994217e+00  1.96232861e+01
  7.97732848e+01  2.81595860e+02  9.15839915e+02  3.17375899e+03
  1.26590080e+04  4.12563556e+04  1.05283487e+05  2.30455656e+05
  4.56262445e+05  8.45208508e+05  1.52837978e+06  2.85063981e+06
  5.80851764e+06]
E1 = -706.7999747992473  E_coul = 198.8094923448435
cycle= 2 E= -507.990482454404  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.364
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0363631
diis-c [-0.00131737 -0.00295532  1.00295532]
  HOMO = -0.239818163551034  LUMO = 0.811266242379896
  mo_energy =
[-1.20315258e+02 -1.23725077e+01 -6.66906456e+00 -6.66906456e+00
 -6.66906456e+00 -1.17763959e+00 -2.39818164e-01 -2.39818164e-01
 -2.39818164e-01  8.11266242e-01  4.59562467e+00  1.95681211e+01
  7.96886795e+01  2.81490490e+02  9.15719057e+02  3.17362385e+03
  1.26588626e+04  4.12562063e+04  1.05283336e+05  2.30455504e+05
  4.56262292e+05  8.45208356e+05  1.52837963e+06  2.85063965e+06
  5.80851748e+06]
E1 = -706.6910787793445  E_coul = 198.7003318824257
cycle= 3 E= -507.990746896919  delta_E= -0.000264  |g|= 0.00438  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00416337
diis-c [-3.40721001e-06 -1.77142215e-05 -1.14484443e-01  1.11450216e+00]
  HOMO = -0.243012827584558  LUMO = 0.810616479798842
  mo_energy =
[-1.20327110e+02 -1.23811546e+01 -6.67819638e+00 -6.67819638e+00
 -6.67819638e+00 -1.17957766e+00 -2.43012828e-01 -2.43012828e-01
 -2.43012828e-01  8.10616480e-01  4.59190184e+00  1.95608676e+01
  7.96788991e+01  2.81479277e+02  9.15706962e+02  3.17361106e+03
  1.26588494e+04  4.12561929e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.675488087511  E_coul = 198.68473594596904
cycle= 4 E= -507.990752141542  delta_E= -5.24e-06  |g|= 0.000222  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169149
diis-c [-7.63862464e-10 -1.02695495e-05  7.14198181e-03 -9.28338423e-02
  1.08570213e+00]
  HOMO = -0.243143712067635  LUMO = 0.810579615758693
  mo_energy =
[-1.20327367e+02 -1.23814346e+01 -6.67846754e+00 -6.67846754e+00
 -6.67846754e+00 -1.17965716e+00 -2.43143712e-01 -2.43143712e-01
 -2.43143712e-01  8.10579616e-01  4.59173914e+00  1.95606189e+01
  7.96786335e+01  2.81479017e+02  9.15706707e+02  3.17361081e+03
  1.26588491e+04  4.12561926e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.6748524224894  E_coul = 198.68410026791108
cycle= 5 E= -507.990752154578  delta_E= -1.3e-08  |g|= 7.72e-06  |ddm|= 0.000733
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.38533e-06
diis-c [-1.23534010e-12  6.69433554e-07 -6.83355142e-04  8.44613786e-03
 -1.06434683e-01  1.09867123e+00]
  HOMO = -0.243146905963703  LUMO = 0.810578748021932
  mo_energy =
[-1.20327373e+02 -1.23814404e+01 -6.67847339e+00 -6.67847339e+00
 -6.67847339e+00 -1.17965937e+00 -2.43146906e-01 -2.43146906e-01
 -2.43146906e-01  8.10578748e-01  4.59173504e+00  1.95606135e+01
  7.96786275e+01  2.81479011e+02  9.15706701e+02  3.17361080e+03
  1.26588491e+04  4.12561926e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.6748359457299  E_coul = 198.68408379113825
cycle= 6 E= -507.990752154592  delta_E= -1.33e-11  |g|= 8.72e-08  |ddm|= 2.71e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6748359457299  E_coul = 198.68408379113825
  HOMO = -0.243146944924843  LUMO = 0.810578723217451
  mo_energy =
[-1.20327373e+02 -1.23814404e+01 -6.67847346e+00 -6.67847346e+00
 -6.67847346e+00 -1.17965938e+00 -2.43146945e-01 -2.43146945e-01
 -2.43146945e-01  8.10578723e-01  4.59173498e+00  1.95606134e+01
  7.96786274e+01  2.81479011e+02  9.15706701e+02  3.17361080e+03
  1.26588491e+04  4.12561926e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.6748357837289  E_coul = 198.68408362913743
Extra cycle  E= -507.990752154591  delta_E= 1.71e-13  |g|= 1.08e-08  |ddm|= 2.32e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912815.5931865873
E1 = -706.6748357837289  E_coul = 198.68408362913743
init E= -507.990752154591
    CPU time for initialize scf      5.74 sec, wall time      0.24 sec
  HOMO = -0.243146950364998  LUMO = 0.810578720423079
  mo_energy =
[-1.20327373e+02 -1.23814405e+01 -6.67847347e+00 -6.67847347e+00
 -6.67847347e+00 -1.17965939e+00 -2.43146950e-01 -2.43146950e-01
 -2.43146950e-01  8.10578720e-01  4.59173498e+00  1.95606134e+01
  7.96786274e+01  2.81479011e+02  9.15706701e+02  3.17361080e+03
  1.26588491e+04  4.12561926e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.6748357608892  E_coul = 198.6840836062974
cycle= 1 E= -507.990752154592  delta_E= -3.41e-13  |g|= 2.47e-09  |ddm|= 3.03e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6748357608892  E_coul = 198.6840836062974
  HOMO = -0.243146951113437  LUMO = 0.810578720502531
  mo_energy =
[-1.20327373e+02 -1.23814405e+01 -6.67847347e+00 -6.67847347e+00
 -6.67847347e+00 -1.17965939e+00 -2.43146951e-01 -2.43146951e-01
 -2.43146951e-01  8.10578721e-01  4.59173498e+00  1.95606134e+01
  7.96786274e+01  2.81479011e+02  9.15706701e+02  3.17361080e+03
  1.26588491e+04  4.12561926e+04  1.05283323e+05  2.30455490e+05
  4.56262279e+05  8.45208342e+05  1.52837961e+06  2.85063964e+06
  5.80851747e+06]
E1 = -706.6748357567357  E_coul = 198.68408360214372
Extra cycle  E= -507.990752154592  delta_E= -1.71e-13  |g|= 1.7e-09  |ddm|= 4.33e-09
    CPU time for scf_cycle      6.25 sec, wall time      0.41 sec
exp = [2.21874250e-01 5.71543576e-01 1.43565505e+00 1.17616812e+05
 3.71481706e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104160e+04 3.67546935e+04 7.30181407e+03
 1.83757516e+04 1.44739604e+03 4.17510402e+02 1.48859707e+02
 6.05467211e+01 2.63109841e+01 8.61827458e+00 8.60418274e+00
 4.92739206e-01]
grad_E = [ 3.72245214e-04 -2.29433277e-04 -1.97737009e-04  5.89207347e-09
 -5.05424865e-05  3.85236949e-11  1.68573295e-10  9.14185881e-10
  3.60972782e-09  1.50680111e-08  7.87766635e-08  4.97796691e-06
  1.91309295e-07 -3.63729365e-05 -5.81331740e-06 -2.92539306e-05
  5.53394660e-06  4.81207971e-05  4.42358057e-05 -7.09617612e-05
 -3.50292137e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:12 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.220763226725       1
[INPUT] 0    0    [1    /1   ]  0.566855933199       1
[INPUT] 0    0    [1    /1   ]  1.42899712015        1
[INPUT] 0    0    [1    /1   ]  117616.812199        1
[INPUT] 0    0    [1    /1   ]  3.72817367125        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069937        1
[INPUT] 0    0    [1    /1   ]  294042.030814        1
[INPUT] 0    0    [1    /1   ]  147020.9909          1
[INPUT] 0    0    [1    /1   ]  73510.415781         1
[INPUT] 0    0    [1    /1   ]  36754.692317         1
[INPUT] 0    0    [1    /1   ]  7301.74024123        1
[INPUT] 0    0    [1    /1   ]  18375.7487461        1
[INPUT] 0    0    [1    /1   ]  1447.96089656        1
[INPUT] 0    0    [1    /1   ]  417.499734889        1
[INPUT] 0    0    [1    /1   ]  149.13118394         1
[INPUT] 0    0    [1    /1   ]  60.7920933042        1
[INPUT] 0    0    [1    /1   ]  26.4266324594        1
[INPUT] 0    0    [1    /1   ]  8.60660418674        1
[INPUT] 1    0    [1    /1   ]  8.6042815889         1
[INPUT] 1    0    [1    /1   ]  0.492748923298       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2207632267250081, 1.0]], [0, [0.5668559331986489, 1.0]], [0, [1.4289971201498768, 1.0]], [0, [117616.81219886866, 1.0]], [0, [3.7281736712497358, 1.0]], [0, [1176168.1426088458, 1.0]], [0, [588084.0699367202, 1.0]], [0, [294042.03081431234, 1.0]], [0, [147020.990900075, 1.0]], [0, [73510.41578100267, 1.0]], [0, [36754.692317047295, 1.0]], [0, [7301.740241229329, 1.0]], [0, [18375.748746066198, 1.0]], [0, [1447.960896557988, 1.0]], [0, [417.4997348892745, 1.0]], [0, [149.1311839399038, 1.0]], [0, [60.79209330424692, 1.0]], [0, [26.426632459419046, 1.0]], [0, [8.606604186737433, 1.0]], [1, [8.604281588895736, 1.0]], [1, [0.49274892329843106, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22076323]
bas 1, expnt(s) = [0.56685593]
bas 2, expnt(s) = [1.42899712]
bas 3, expnt(s) = [117616.81219887]
bas 4, expnt(s) = [3.72817367]
bas 5, expnt(s) = [1176168.14260885]
bas 6, expnt(s) = [588084.06993672]
bas 7, expnt(s) = [294042.03081431]
bas 8, expnt(s) = [147020.99090008]
bas 9, expnt(s) = [73510.415781]
bas 10, expnt(s) = [36754.69231705]
bas 11, expnt(s) = [7301.74024123]
bas 12, expnt(s) = [18375.74874607]
bas 13, expnt(s) = [1447.96089656]
bas 14, expnt(s) = [417.49973489]
bas 15, expnt(s) = [149.13118394]
bas 16, expnt(s) = [60.7920933]
bas 17, expnt(s) = [26.42663246]
bas 18, expnt(s) = [8.60660419]
bas 19, expnt(s) = [8.60428159]
bas 20, expnt(s) = [0.49274892]
CPU time:      1853.65
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20763227e-01 8.13692052e-01 5.66855933e-01 1.65051527e+00
 1.42899712e+00 3.30208721e+00 1.17616812e+05 1.60460107e+04
 3.72817367e+00 6.77855502e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104158e+04 1.12791581e+04
 3.67546923e+04 6.70655697e+03 7.30174024e+03 1.99565199e+03
 1.83757487e+04 3.98748266e+03 1.44796090e+03 5.93038173e+02
 4.17499735e+02 2.33349663e+02 1.49131184e+02 1.07818025e+02
 6.07920933e+01 5.50047693e+01 2.64266325e+01 2.94473618e+01
 8.60660419e+00 1.26951810e+01 8.60428159e+00 4.29910113e+01
 4.92748923e-01 1.20438822e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33610868473571
cond(S) = 912855.1401693336
E1 = -689.5976792258192  E_coul = 184.97236719198563
init E= -504.625312033834
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672155273937922  LUMO = 0.47710387747555
  mo_energy =
[-1.21709814e+02 -1.33861646e+01 -7.62351431e+00 -7.62351431e+00
 -7.62351431e+00 -1.65763000e+00 -6.72155274e-01 -6.72155274e-01
 -6.72155274e-01  4.77103877e-01  4.01295033e+00  1.86712428e+01
  7.86880793e+01  2.81095138e+02  9.16237961e+02  3.17508735e+03
  1.26613521e+04  4.12589047e+04  1.05285976e+05  2.30458066e+05
  4.56264794e+05  8.45210811e+05  1.52838204e+06  2.85064200e+06
  5.80851975e+06]
E1 = -707.75732260146  E_coul = 199.78466118506904
cycle= 1 E= -507.972661416391  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.752597
diis-c [-0.56640188  1.        ]
  HOMO = -0.217575363131955  LUMO = 0.806861126681851
  mo_energy =
[-1.20200010e+02 -1.23045248e+01 -6.59381480e+00 -6.59381480e+00
 -6.59381480e+00 -1.16331295e+00 -2.17575363e-01 -2.17575363e-01
 -2.17575363e-01  8.06861127e-01  4.59156273e+00  1.96012262e+01
  7.99691395e+01  2.82552333e+02  9.17730205e+02  3.17651987e+03
  1.26626782e+04  4.12601637e+04  1.05287198e+05  2.30459264e+05
  4.56265974e+05  8.45211978e+05  1.52838319e+06  2.85064315e+06
  5.80852089e+06]
E1 = -706.8013065520914  E_coul = 198.81081071998915
cycle= 2 E= -507.990495832102  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.363
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0364035
diis-c [-0.00132034 -0.0029454   1.0029454 ]
  HOMO = -0.239787463307765  LUMO = 0.803894572658504
  mo_energy =
[-1.20315106e+02 -1.23724070e+01 -6.66897073e+00 -6.66897073e+00
 -6.66897073e+00 -1.17760833e+00 -2.39787463e-01 -2.39787463e-01
 -2.39787463e-01  8.03894573e-01  4.56734938e+00  1.95460461e+01
  7.98844683e+01  2.82446928e+02  9.17609354e+02  3.17638475e+03
  1.26625329e+04  4.12600145e+04  1.05287047e+05  2.30459112e+05
  4.56265822e+05  8.45211826e+05  1.52838304e+06  2.85064300e+06
  5.80852074e+06]
E1 = -706.692360000261  E_coul = 198.70159941137413
cycle= 3 E= -507.990760588887  delta_E= -0.000265  |g|= 0.00438  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00417647
diis-c [-3.41352919e-06 -2.44043041e-05 -1.14796555e-01  1.11482096e+00]
  HOMO = -0.24298563174328  LUMO = 0.80325140283261
  mo_energy =
[-1.20326968e+02 -1.23810616e+01 -6.67811052e+00 -6.67811052e+00
 -6.67811052e+00 -1.17954870e+00 -2.42985632e-01 -2.42985632e-01
 -2.42985632e-01  8.03251403e-01  4.56363405e+00  1.95387831e+01
  7.98746734e+01  2.82435702e+02  9.17597248e+02  3.17637195e+03
  1.26625196e+04  4.12600010e+04  1.05287033e+05  2.30459099e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6767330801756  E_coul = 198.6859672175303
cycle= 4 E= -507.990765862645  delta_E= -5.27e-06  |g|= 0.000223  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016958
diis-c [-7.88970004e-10 -1.03280525e-05  7.17190507e-03 -9.29356697e-02
  1.08577409e+00]
  HOMO = -0.243116526062693  LUMO = 0.803214775052933
  mo_energy =
[-1.20327223e+02 -1.23813408e+01 -6.67838077e+00 -6.67838077e+00
 -6.67838077e+00 -1.17962823e+00 -2.43116526e-01 -2.43116526e-01
 -2.43116526e-01  8.03214775e-01  4.56347160e+00  1.95385348e+01
  7.98744089e+01  2.82435444e+02  9.17596995e+02  3.17637170e+03
  1.26625194e+04  4.12600008e+04  1.05287033e+05  2.30459098e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6760960295211  E_coul = 198.685330153677
cycle= 5 E= -507.990765875844  delta_E= -1.32e-08  |g|= 7.86e-06  |ddm|= 0.000738
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.45726e-06
diis-c [-1.25803908e-12  6.72155905e-07 -6.91353489e-04  8.51696013e-03
 -1.07331620e-01  1.09950534e+00]
  HOMO = -0.243119766285526  LUMO = 0.803213903212269
  mo_energy =
[-1.20327229e+02 -1.23813466e+01 -6.67838668e+00 -6.67838668e+00
 -6.67838668e+00 -1.17963047e+00 -2.43119766e-01 -2.43119766e-01
 -2.43119766e-01  8.03213903e-01  4.56346745e+00  1.95385293e+01
  7.98744028e+01  2.82435437e+02  9.17596988e+02  3.17637169e+03
  1.26625193e+04  4.12600008e+04  1.05287033e+05  2.30459098e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6760792521208  E_coul = 198.68531337626314
cycle= 6 E= -507.990765875858  delta_E= -1.35e-11  |g|= 8.66e-08  |ddm|= 2.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6760792521208  E_coul = 198.68531337626314
  HOMO = -0.243119804915899  LUMO = 0.803213878511489
  mo_energy =
[-1.20327229e+02 -1.23813467e+01 -6.67838676e+00 -6.67838676e+00
 -6.67838676e+00 -1.17963048e+00 -2.43119805e-01 -2.43119805e-01
 -2.43119805e-01  8.03213879e-01  4.56346739e+00  1.95385292e+01
  7.98744028e+01  2.82435437e+02  9.17596988e+02  3.17637169e+03
  1.26625193e+04  4.12600008e+04  1.05287033e+05  2.30459098e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6760790912963  E_coul = 198.6853132154388
Extra cycle  E= -507.990765875858  delta_E= 1.14e-13  |g|= 1.08e-08  |ddm|= 2.3e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.20763227e-01 5.66855933e-01 1.42899712e+00 1.17616812e+05
 3.72817367e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104158e+04 3.67546923e+04 7.30174024e+03
 1.83757487e+04 1.44796090e+03 4.17499735e+02 1.49131184e+02
 6.07920933e+01 2.64266325e+01 8.60660419e+00 8.60428159e+00
 4.92748923e-01]
E = -507.9907658758575
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:13 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.220763226725       1
[INPUT] 0    0    [1    /1   ]  0.566855933199       1
[INPUT] 0    0    [1    /1   ]  1.42899712015        1
[INPUT] 0    0    [1    /1   ]  117616.812199        1
[INPUT] 0    0    [1    /1   ]  3.72817367125        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069937        1
[INPUT] 0    0    [1    /1   ]  294042.030814        1
[INPUT] 0    0    [1    /1   ]  147020.9909          1
[INPUT] 0    0    [1    /1   ]  73510.415781         1
[INPUT] 0    0    [1    /1   ]  36754.692317         1
[INPUT] 0    0    [1    /1   ]  7301.74024123        1
[INPUT] 0    0    [1    /1   ]  18375.7487461        1
[INPUT] 0    0    [1    /1   ]  1447.96089656        1
[INPUT] 0    0    [1    /1   ]  417.499734889        1
[INPUT] 0    0    [1    /1   ]  149.13118394         1
[INPUT] 0    0    [1    /1   ]  60.7920933042        1
[INPUT] 0    0    [1    /1   ]  26.4266324594        1
[INPUT] 0    0    [1    /1   ]  8.60660418674        1
[INPUT] 1    0    [1    /1   ]  8.6042815889         1
[INPUT] 1    0    [1    /1   ]  0.492748923298       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2207632267250081, 1.0]], [0, [0.5668559331986489, 1.0]], [0, [1.4289971201498768, 1.0]], [0, [117616.81219886866, 1.0]], [0, [3.7281736712497358, 1.0]], [0, [1176168.1426088458, 1.0]], [0, [588084.0699367202, 1.0]], [0, [294042.03081431234, 1.0]], [0, [147020.990900075, 1.0]], [0, [73510.41578100267, 1.0]], [0, [36754.692317047295, 1.0]], [0, [7301.740241229329, 1.0]], [0, [18375.748746066198, 1.0]], [0, [1447.960896557988, 1.0]], [0, [417.4997348892745, 1.0]], [0, [149.1311839399038, 1.0]], [0, [60.79209330424692, 1.0]], [0, [26.426632459419046, 1.0]], [0, [8.606604186737433, 1.0]], [1, [8.604281588895736, 1.0]], [1, [0.49274892329843106, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22076323]
bas 1, expnt(s) = [0.56685593]
bas 2, expnt(s) = [1.42899712]
bas 3, expnt(s) = [117616.81219887]
bas 4, expnt(s) = [3.72817367]
bas 5, expnt(s) = [1176168.14260885]
bas 6, expnt(s) = [588084.06993672]
bas 7, expnt(s) = [294042.03081431]
bas 8, expnt(s) = [147020.99090008]
bas 9, expnt(s) = [73510.415781]
bas 10, expnt(s) = [36754.69231705]
bas 11, expnt(s) = [7301.74024123]
bas 12, expnt(s) = [18375.74874607]
bas 13, expnt(s) = [1447.96089656]
bas 14, expnt(s) = [417.49973489]
bas 15, expnt(s) = [149.13118394]
bas 16, expnt(s) = [60.7920933]
bas 17, expnt(s) = [26.42663246]
bas 18, expnt(s) = [8.60660419]
bas 19, expnt(s) = [8.60428159]
bas 20, expnt(s) = [0.49274892]
CPU time:      1855.89
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20763227e-01 8.13692052e-01 5.66855933e-01 1.65051527e+00
 1.42899712e+00 3.30208721e+00 1.17616812e+05 1.60460107e+04
 3.72817367e+00 6.77855502e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104158e+04 1.12791581e+04
 3.67546923e+04 6.70655697e+03 7.30174024e+03 1.99565199e+03
 1.83757487e+04 3.98748266e+03 1.44796090e+03 5.93038173e+02
 4.17499735e+02 2.33349663e+02 1.49131184e+02 1.07818025e+02
 6.07920933e+01 5.50047693e+01 2.64266325e+01 2.94473618e+01
 8.60660419e+00 1.26951810e+01 8.60428159e+00 4.29910113e+01
 4.92748923e-01 1.20438822e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33610868473571
cond(S) = 912855.1401693336
E1 = -689.5976792258192  E_coul = 184.97236719198563
init E= -504.625312033834
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672155273937922  LUMO = 0.47710387747555
  mo_energy =
[-1.21709814e+02 -1.33861646e+01 -7.62351431e+00 -7.62351431e+00
 -7.62351431e+00 -1.65763000e+00 -6.72155274e-01 -6.72155274e-01
 -6.72155274e-01  4.77103877e-01  4.01295033e+00  1.86712428e+01
  7.86880793e+01  2.81095138e+02  9.16237961e+02  3.17508735e+03
  1.26613521e+04  4.12589047e+04  1.05285976e+05  2.30458066e+05
  4.56264794e+05  8.45210811e+05  1.52838204e+06  2.85064200e+06
  5.80851975e+06]
E1 = -707.75732260146  E_coul = 199.78466118506904
cycle= 1 E= -507.972661416391  delta_E= -3.35  |g|= 0.452  |ddm|= 0.49
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.752597
diis-c [-0.56640188  1.        ]
  HOMO = -0.217575363131955  LUMO = 0.806861126681851
  mo_energy =
[-1.20200010e+02 -1.23045248e+01 -6.59381480e+00 -6.59381480e+00
 -6.59381480e+00 -1.16331295e+00 -2.17575363e-01 -2.17575363e-01
 -2.17575363e-01  8.06861127e-01  4.59156273e+00  1.96012262e+01
  7.99691395e+01  2.82552333e+02  9.17730205e+02  3.17651987e+03
  1.26626782e+04  4.12601637e+04  1.05287198e+05  2.30459264e+05
  4.56265974e+05  8.45211978e+05  1.52838319e+06  2.85064315e+06
  5.80852089e+06]
E1 = -706.8013065520914  E_coul = 198.81081071998915
cycle= 2 E= -507.990495832102  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.363
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0364035
diis-c [-0.00132034 -0.0029454   1.0029454 ]
  HOMO = -0.239787463307765  LUMO = 0.803894572658504
  mo_energy =
[-1.20315106e+02 -1.23724070e+01 -6.66897073e+00 -6.66897073e+00
 -6.66897073e+00 -1.17760833e+00 -2.39787463e-01 -2.39787463e-01
 -2.39787463e-01  8.03894573e-01  4.56734938e+00  1.95460461e+01
  7.98844683e+01  2.82446928e+02  9.17609354e+02  3.17638475e+03
  1.26625329e+04  4.12600145e+04  1.05287047e+05  2.30459112e+05
  4.56265822e+05  8.45211826e+05  1.52838304e+06  2.85064300e+06
  5.80852074e+06]
E1 = -706.692360000261  E_coul = 198.70159941137413
cycle= 3 E= -507.990760588887  delta_E= -0.000265  |g|= 0.00438  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00417647
diis-c [-3.41352919e-06 -2.44043041e-05 -1.14796555e-01  1.11482096e+00]
  HOMO = -0.24298563174328  LUMO = 0.80325140283261
  mo_energy =
[-1.20326968e+02 -1.23810616e+01 -6.67811052e+00 -6.67811052e+00
 -6.67811052e+00 -1.17954870e+00 -2.42985632e-01 -2.42985632e-01
 -2.42985632e-01  8.03251403e-01  4.56363405e+00  1.95387831e+01
  7.98746734e+01  2.82435702e+02  9.17597248e+02  3.17637195e+03
  1.26625196e+04  4.12600010e+04  1.05287033e+05  2.30459099e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6767330801756  E_coul = 198.6859672175303
cycle= 4 E= -507.990765862645  delta_E= -5.27e-06  |g|= 0.000223  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016958
diis-c [-7.88970004e-10 -1.03280525e-05  7.17190507e-03 -9.29356697e-02
  1.08577409e+00]
  HOMO = -0.243116526062693  LUMO = 0.803214775052933
  mo_energy =
[-1.20327223e+02 -1.23813408e+01 -6.67838077e+00 -6.67838077e+00
 -6.67838077e+00 -1.17962823e+00 -2.43116526e-01 -2.43116526e-01
 -2.43116526e-01  8.03214775e-01  4.56347160e+00  1.95385348e+01
  7.98744089e+01  2.82435444e+02  9.17596995e+02  3.17637170e+03
  1.26625194e+04  4.12600008e+04  1.05287033e+05  2.30459098e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6760960295211  E_coul = 198.685330153677
cycle= 5 E= -507.990765875844  delta_E= -1.32e-08  |g|= 7.86e-06  |ddm|= 0.000738
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.45726e-06
diis-c [-1.25803908e-12  6.72155905e-07 -6.91353489e-04  8.51696013e-03
 -1.07331620e-01  1.09950534e+00]
  HOMO = -0.243119766285526  LUMO = 0.803213903212269
  mo_energy =
[-1.20327229e+02 -1.23813466e+01 -6.67838668e+00 -6.67838668e+00
 -6.67838668e+00 -1.17963047e+00 -2.43119766e-01 -2.43119766e-01
 -2.43119766e-01  8.03213903e-01  4.56346745e+00  1.95385293e+01
  7.98744028e+01  2.82435437e+02  9.17596988e+02  3.17637169e+03
  1.26625193e+04  4.12600008e+04  1.05287033e+05  2.30459098e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6760792521208  E_coul = 198.68531337626314
cycle= 6 E= -507.990765875858  delta_E= -1.35e-11  |g|= 8.66e-08  |ddm|= 2.76e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6760792521208  E_coul = 198.68531337626314
  HOMO = -0.243119804915899  LUMO = 0.803213878511489
  mo_energy =
[-1.20327229e+02 -1.23813467e+01 -6.67838676e+00 -6.67838676e+00
 -6.67838676e+00 -1.17963048e+00 -2.43119805e-01 -2.43119805e-01
 -2.43119805e-01  8.03213879e-01  4.56346739e+00  1.95385292e+01
  7.98744028e+01  2.82435437e+02  9.17596988e+02  3.17637169e+03
  1.26625193e+04  4.12600008e+04  1.05287033e+05  2.30459098e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6760790912963  E_coul = 198.6853132154388
Extra cycle  E= -507.990765875858  delta_E= 1.14e-13  |g|= 1.08e-08  |ddm|= 2.3e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912855.1401693336
E1 = -706.6760790912963  E_coul = 198.6853132154388
init E= -507.990765875858
    CPU time for initialize scf      5.66 sec, wall time      0.24 sec
  HOMO = -0.243119810316145  LUMO = 0.803213876788554
  mo_energy =
[-1.20327229e+02 -1.23813467e+01 -6.67838677e+00 -6.67838677e+00
 -6.67838677e+00 -1.17963049e+00 -2.43119810e-01 -2.43119810e-01
 -2.43119810e-01  8.03213877e-01  4.56346739e+00  1.95385292e+01
  7.98744027e+01  2.82435437e+02  9.17596988e+02  3.17637169e+03
  1.26625193e+04  4.12600008e+04  1.05287033e+05  2.30459098e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.6760790648402  E_coul = 198.68531318898283
cycle= 1 E= -507.990765875857  delta_E= 1.14e-13  |g|= 2.17e-09  |ddm|= 3.16e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.6760790648402  E_coul = 198.68531318898283
  HOMO = -0.24311981115565  LUMO = 0.8032138755293
  mo_energy =
[-1.20327229e+02 -1.23813467e+01 -6.67838677e+00 -6.67838677e+00
 -6.67838677e+00 -1.17963049e+00 -2.43119811e-01 -2.43119811e-01
 -2.43119811e-01  8.03213876e-01  4.56346739e+00  1.95385292e+01
  7.98744027e+01  2.82435437e+02  9.17596988e+02  3.17637169e+03
  1.26625193e+04  4.12600008e+04  1.05287033e+05  2.30459098e+05
  4.56265809e+05  8.45211812e+05  1.52838303e+06  2.85064298e+06
  5.80852072e+06]
E1 = -706.676079061175  E_coul = 198.68531318531782
Extra cycle  E= -507.990765875857  delta_E= 2.27e-13  |g|= 1.59e-09  |ddm|= 4.39e-09
    CPU time for scf_cycle      6.15 sec, wall time      0.41 sec
exp = [2.20763227e-01 5.66855933e-01 1.42899712e+00 1.17616812e+05
 3.72817367e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104158e+04 3.67546923e+04 7.30174024e+03
 1.83757487e+04 1.44796090e+03 4.17499735e+02 1.49131184e+02
 6.07920933e+01 2.64266325e+01 8.60660419e+00 8.60428159e+00
 4.92748923e-01]
grad_E = [ 1.76878023e-03 -1.15124350e-03 -3.86501088e-04  5.84926463e-09
  4.62722105e-04  3.80403590e-11  1.67170332e-10  9.07613820e-10
  3.58321630e-09  1.49559078e-08  7.82358687e-08  4.94534121e-06
  1.89543112e-07 -3.54777817e-05 -9.78300958e-06 -2.51653119e-05
  1.39758939e-05  3.29231257e-05 -1.22587232e-04  4.20117664e-06
 -1.60556143e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:21 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.219620839313       1
[INPUT] 0    0    [1    /1   ]  0.561419219165       1
[INPUT] 0    0    [1    /1   ]  1.39739779037        1
[INPUT] 0    0    [1    /1   ]  117616.812083        1
[INPUT] 0    0    [1    /1   ]  3.7056126728         1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069933        1
[INPUT] 0    0    [1    /1   ]  294042.030796        1
[INPUT] 0    0    [1    /1   ]  147020.990829        1
[INPUT] 0    0    [1    /1   ]  73510.4154833        1
[INPUT] 0    0    [1    /1   ]  36754.6907639        1
[INPUT] 0    0    [1    /1   ]  7301.64227491        1
[INPUT] 0    0    [1    /1   ]  18375.7449407        1
[INPUT] 0    0    [1    /1   ]  1448.71120403        1
[INPUT] 0    0    [1    /1   ]  417.474124007        1
[INPUT] 0    0    [1    /1   ]  149.532151373        1
[INPUT] 0    0    [1    /1   ]  61.1020884855        1
[INPUT] 0    0    [1    /1   ]  26.5157380601        1
[INPUT] 0    0    [1    /1   ]  8.57783994934        1
[INPUT] 1    0    [1    /1   ]  8.60432237524        1
[INPUT] 1    0    [1    /1   ]  0.492749585246       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21962083931254164, 1.0]], [0, [0.5614192191645211, 1.0]], [0, [1.3973977903658694, 1.0]], [0, [117616.8120825261, 1.0]], [0, [3.705612672799779, 1.0]], [0, [1176168.1426080705, 1.0]], [0, [588084.0699333786, 1.0]], [0, [294042.03079626645, 1.0]], [0, [147020.99082877772, 1.0]], [0, [73510.41548328228, 1.0]], [0, [36754.690763913044, 1.0]], [0, [7301.642274913275, 1.0]], [0, [18375.744940662225, 1.0]], [0, [1448.7112040269194, 1.0]], [0, [417.47412400683834, 1.0]], [0, [149.53215137276646, 1.0]], [0, [61.10208848547729, 1.0]], [0, [26.515738060055117, 1.0]], [0, [8.577839949343351, 1.0]], [1, [8.604322375244811, 1.0]], [1, [0.49274958524634815, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21962084]
bas 1, expnt(s) = [0.56141922]
bas 2, expnt(s) = [1.39739779]
bas 3, expnt(s) = [117616.81208253]
bas 4, expnt(s) = [3.70561267]
bas 5, expnt(s) = [1176168.14260807]
bas 6, expnt(s) = [588084.06993338]
bas 7, expnt(s) = [294042.03079627]
bas 8, expnt(s) = [147020.99082878]
bas 9, expnt(s) = [73510.41548328]
bas 10, expnt(s) = [36754.69076391]
bas 11, expnt(s) = [7301.64227491]
bas 12, expnt(s) = [18375.74494066]
bas 13, expnt(s) = [1448.71120403]
bas 14, expnt(s) = [417.47412401]
bas 15, expnt(s) = [149.53215137]
bas 16, expnt(s) = [61.10208849]
bas 17, expnt(s) = [26.51573806]
bas 18, expnt(s) = [8.57783995]
bas 19, expnt(s) = [8.60432238]
bas 20, expnt(s) = [0.49274959]
CPU time:      1871.01
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.19620839e-01 8.10532035e-01 5.61419219e-01 1.63862841e+00
 1.39739779e+00 3.24717028e+00 1.17616812e+05 1.60460107e+04
 3.70561267e+00 6.74776643e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104155e+04 1.12791581e+04
 3.67546908e+04 6.70655675e+03 7.30164227e+03 1.99563190e+03
 1.83757449e+04 3.98748204e+03 1.44871120e+03 5.93268635e+02
 4.17474124e+02 2.33338927e+02 1.49532151e+02 1.08035369e+02
 6.11020885e+01 5.52149986e+01 2.65157381e+01 2.95217987e+01
 8.57783995e+00 1.26633461e+01 8.60432238e+00 4.29912660e+01
 4.92749585e-01 1.20439024e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33610789342474
cond(S) = 912896.2551148515
E1 = -689.5981463658466  E_coul = 184.97259382109968
init E= -504.625552544747
    CPU time for initialize scf      0.74 sec, wall time      0.07 sec
  HOMO = -0.672156791833566  LUMO = 0.469012394369858
  mo_energy =
[-1.21709787e+02 -1.33861350e+01 -7.62349613e+00 -7.62349613e+00
 -7.62349613e+00 -1.65763516e+00 -6.72156792e-01 -6.72156792e-01
 -6.72156792e-01  4.69012394e-01  3.93384097e+00  1.84411665e+01
  7.85493092e+01  2.81839213e+02  9.18245467e+02  3.17831297e+03
  1.26658361e+04  4.12636004e+04  1.05290556e+05  2.30462521e+05
  4.56269152e+05  8.45215096e+05  1.52838625e+06  2.85064613e+06
  5.80852377e+06]
E1 = -707.7577920461958  E_coul = 199.78511122421068
cycle= 1 E= -507.972680821985  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.751863
diis-c [-0.56529799  1.        ]
  HOMO = -0.217567488927664  LUMO = 0.796736099300772
  mo_energy =
[-1.20199965e+02 -1.23044825e+01 -6.59378157e+00 -6.59378157e+00
 -6.59378157e+00 -1.16330704e+00 -2.17567489e-01 -2.17567489e-01
 -2.17567489e-01  7.96736099e-01  4.50831690e+00  1.93696291e+01
  7.98313007e+01  2.83296921e+02  9.19737785e+02  3.17974550e+03
  1.26671623e+04  4.12648594e+04  1.05291778e+05  2.30463719e+05
  4.56270332e+05  8.45216263e+05  1.52838741e+06  2.85064728e+06
  5.80852491e+06]
E1 = -706.8018585218775  E_coul = 198.8113460671088
cycle= 2 E= -507.990512454769  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.36
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.036538
diis-c [-0.00133013 -0.00295646  1.00295646]
  HOMO = -0.239777172917044  LUMO = 0.793850681291468
  mo_energy =
[-1.20315054e+02 -1.23723595e+01 -6.66893198e+00 -6.66893198e+00
 -6.66893198e+00 -1.17760115e+00 -2.39777173e-01 -2.39777173e-01
 -2.39777173e-01  7.93850681e-01  4.48448387e+00  1.93146250e+01
  7.97465741e+01  2.83191455e+02  9.19616923e+02  3.17961039e+03
  1.26670170e+04  4.12647102e+04  1.05291628e+05  2.30463567e+05
  4.56270180e+05  8.45216110e+05  1.52838726e+06  2.85064713e+06
  5.80852476e+06]
E1 = -706.6928584516596  E_coul = 198.7020809471074
cycle= 3 E= -507.990777504552  delta_E= -0.000265  |g|= 0.00439  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00420918
diis-c [-3.42459918e-06 -3.85642476e-05 -1.15481045e-01  1.11551961e+00]
  HOMO = -0.242980027827401  LUMO = 0.79321994865274
  mo_energy =
[-1.20326928e+02 -1.23810240e+01 -6.67808195e+00 -6.67808195e+00
 -6.67808195e+00 -1.17954465e+00 -2.42980028e-01 -2.42980028e-01
 -2.42980028e-01  7.93219949e-01  4.48081310e+00  1.93073710e+01
  7.97367640e+01  2.83180213e+02  9.19604803e+02  3.17959757e+03
  1.26670037e+04  4.12646968e+04  1.05291614e+05  2.30463553e+05
  4.56270167e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.6771928136918  E_coul = 198.68641000731358
cycle= 4 E= -507.990782806378  delta_E= -5.3e-06  |g|= 0.000223  |ddm|= 0.0113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169502
diis-c [-8.22131691e-10 -1.04242061e-05  7.21010003e-03 -9.26778069e-02
  1.08547813e+00]
  HOMO = -0.243109594675363  LUMO = 0.793184036417901
  mo_energy =
[-1.20327176e+02 -1.23812985e+01 -6.67834716e+00 -6.67834716e+00
 -6.67834716e+00 -1.17962340e+00 -2.43109595e-01 -2.43109595e-01
 -2.43109595e-01  7.93184036e-01  4.48065375e+00  1.93071267e+01
  7.97365051e+01  2.83179961e+02  9.19604558e+02  3.17959733e+03
  1.26670035e+04  4.12646965e+04  1.05291614e+05  2.30463553e+05
  4.56270166e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.6765609799131  E_coul = 198.68577816030958
cycle= 5 E= -507.990782819604  delta_E= -1.32e-08  |g|= 8.1e-06  |ddm|= 0.000748
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.56401e-06
diis-c [-1.29586014e-12  6.80470944e-07 -7.06007363e-04  8.62682942e-03
 -1.09104830e-01  1.10118333e+00]
  HOMO = -0.243112890920016  LUMO = 0.793183156091236
  mo_energy =
[-1.20327182e+02 -1.23813044e+01 -6.67835313e+00 -6.67835313e+00
 -6.67835313e+00 -1.17962568e+00 -2.43112891e-01 -2.43112891e-01
 -2.43112891e-01  7.93183156e-01  4.48064956e+00  1.93071211e+01
  7.97364989e+01  2.83179955e+02  9.19604551e+02  3.17959732e+03
  1.26670035e+04  4.12646965e+04  1.05291614e+05  2.30463553e+05
  4.56270166e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.676543847011  E_coul = 198.68576102739314
cycle= 6 E= -507.990782819618  delta_E= -1.43e-11  |g|= 8.5e-08  |ddm|= 2.89e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.676543847011  E_coul = 198.68576102739314
  HOMO = -0.243112928944657  LUMO = 0.793183129101964
  mo_energy =
[-1.20327182e+02 -1.23813045e+01 -6.67835320e+00 -6.67835320e+00
 -6.67835320e+00 -1.17962569e+00 -2.43112929e-01 -2.43112929e-01
 -2.43112929e-01  7.93183129e-01  4.48064950e+00  1.93071211e+01
  7.97364989e+01  2.83179955e+02  9.19604551e+02  3.17959732e+03
  1.26670035e+04  4.12646965e+04  1.05291614e+05  2.30463553e+05
  4.56270166e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.6765436948318  E_coul = 198.68576087521384
Extra cycle  E= -507.990782819618  delta_E= -1.14e-13  |g|= 1.18e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
exp = [2.19620839e-01 5.61419219e-01 1.39739779e+00 1.17616812e+05
 3.70561267e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104155e+04 3.67546908e+04 7.30164227e+03
 1.83757449e+04 1.44871120e+03 4.17474124e+02 1.49532151e+02
 6.11020885e+01 2.65157381e+01 8.57783995e+00 8.60432238e+00
 4.92749585e-01]
E = -507.99078281961795
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:22 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.219620839313       1
[INPUT] 0    0    [1    /1   ]  0.561419219165       1
[INPUT] 0    0    [1    /1   ]  1.39739779037        1
[INPUT] 0    0    [1    /1   ]  117616.812083        1
[INPUT] 0    0    [1    /1   ]  3.7056126728         1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069933        1
[INPUT] 0    0    [1    /1   ]  294042.030796        1
[INPUT] 0    0    [1    /1   ]  147020.990829        1
[INPUT] 0    0    [1    /1   ]  73510.4154833        1
[INPUT] 0    0    [1    /1   ]  36754.6907639        1
[INPUT] 0    0    [1    /1   ]  7301.64227491        1
[INPUT] 0    0    [1    /1   ]  18375.7449407        1
[INPUT] 0    0    [1    /1   ]  1448.71120403        1
[INPUT] 0    0    [1    /1   ]  417.474124007        1
[INPUT] 0    0    [1    /1   ]  149.532151373        1
[INPUT] 0    0    [1    /1   ]  61.1020884855        1
[INPUT] 0    0    [1    /1   ]  26.5157380601        1
[INPUT] 0    0    [1    /1   ]  8.57783994934        1
[INPUT] 1    0    [1    /1   ]  8.60432237524        1
[INPUT] 1    0    [1    /1   ]  0.492749585246       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.21962083931254164, 1.0]], [0, [0.5614192191645211, 1.0]], [0, [1.3973977903658694, 1.0]], [0, [117616.8120825261, 1.0]], [0, [3.705612672799779, 1.0]], [0, [1176168.1426080705, 1.0]], [0, [588084.0699333786, 1.0]], [0, [294042.03079626645, 1.0]], [0, [147020.99082877772, 1.0]], [0, [73510.41548328228, 1.0]], [0, [36754.690763913044, 1.0]], [0, [7301.642274913275, 1.0]], [0, [18375.744940662225, 1.0]], [0, [1448.7112040269194, 1.0]], [0, [417.47412400683834, 1.0]], [0, [149.53215137276646, 1.0]], [0, [61.10208848547729, 1.0]], [0, [26.515738060055117, 1.0]], [0, [8.577839949343351, 1.0]], [1, [8.604322375244811, 1.0]], [1, [0.49274958524634815, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.21962084]
bas 1, expnt(s) = [0.56141922]
bas 2, expnt(s) = [1.39739779]
bas 3, expnt(s) = [117616.81208253]
bas 4, expnt(s) = [3.70561267]
bas 5, expnt(s) = [1176168.14260807]
bas 6, expnt(s) = [588084.06993338]
bas 7, expnt(s) = [294042.03079627]
bas 8, expnt(s) = [147020.99082878]
bas 9, expnt(s) = [73510.41548328]
bas 10, expnt(s) = [36754.69076391]
bas 11, expnt(s) = [7301.64227491]
bas 12, expnt(s) = [18375.74494066]
bas 13, expnt(s) = [1448.71120403]
bas 14, expnt(s) = [417.47412401]
bas 15, expnt(s) = [149.53215137]
bas 16, expnt(s) = [61.10208849]
bas 17, expnt(s) = [26.51573806]
bas 18, expnt(s) = [8.57783995]
bas 19, expnt(s) = [8.60432238]
bas 20, expnt(s) = [0.49274959]
CPU time:      1873.15
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.19620839e-01 8.10532035e-01 5.61419219e-01 1.63862841e+00
 1.39739779e+00 3.24717028e+00 1.17616812e+05 1.60460107e+04
 3.70561267e+00 6.74776643e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104155e+04 1.12791581e+04
 3.67546908e+04 6.70655675e+03 7.30164227e+03 1.99563190e+03
 1.83757449e+04 3.98748204e+03 1.44871120e+03 5.93268635e+02
 4.17474124e+02 2.33338927e+02 1.49532151e+02 1.08035369e+02
 6.11020885e+01 5.52149986e+01 2.65157381e+01 2.95217987e+01
 8.57783995e+00 1.26633461e+01 8.60432238e+00 4.29912660e+01
 4.92749585e-01 1.20439024e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33610789342474
cond(S) = 912896.2551148515
E1 = -689.5981463658466  E_coul = 184.97259382109968
init E= -504.625552544747
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672156791833566  LUMO = 0.469012394369858
  mo_energy =
[-1.21709787e+02 -1.33861350e+01 -7.62349613e+00 -7.62349613e+00
 -7.62349613e+00 -1.65763516e+00 -6.72156792e-01 -6.72156792e-01
 -6.72156792e-01  4.69012394e-01  3.93384097e+00  1.84411665e+01
  7.85493092e+01  2.81839213e+02  9.18245467e+02  3.17831297e+03
  1.26658361e+04  4.12636004e+04  1.05290556e+05  2.30462521e+05
  4.56269152e+05  8.45215096e+05  1.52838625e+06  2.85064613e+06
  5.80852377e+06]
E1 = -707.7577920461958  E_coul = 199.78511122421068
cycle= 1 E= -507.972680821985  delta_E= -3.35  |g|= 0.452  |ddm|= 0.491
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.751863
diis-c [-0.56529799  1.        ]
  HOMO = -0.217567488927664  LUMO = 0.796736099300772
  mo_energy =
[-1.20199965e+02 -1.23044825e+01 -6.59378157e+00 -6.59378157e+00
 -6.59378157e+00 -1.16330704e+00 -2.17567489e-01 -2.17567489e-01
 -2.17567489e-01  7.96736099e-01  4.50831690e+00  1.93696291e+01
  7.98313007e+01  2.83296921e+02  9.19737785e+02  3.17974550e+03
  1.26671623e+04  4.12648594e+04  1.05291778e+05  2.30463719e+05
  4.56270332e+05  8.45216263e+05  1.52838741e+06  2.85064728e+06
  5.80852491e+06]
E1 = -706.8018585218775  E_coul = 198.8113460671088
cycle= 2 E= -507.990512454769  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.36
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.036538
diis-c [-0.00133013 -0.00295646  1.00295646]
  HOMO = -0.239777172917044  LUMO = 0.793850681291468
  mo_energy =
[-1.20315054e+02 -1.23723595e+01 -6.66893198e+00 -6.66893198e+00
 -6.66893198e+00 -1.17760115e+00 -2.39777173e-01 -2.39777173e-01
 -2.39777173e-01  7.93850681e-01  4.48448387e+00  1.93146250e+01
  7.97465741e+01  2.83191455e+02  9.19616923e+02  3.17961039e+03
  1.26670170e+04  4.12647102e+04  1.05291628e+05  2.30463567e+05
  4.56270180e+05  8.45216110e+05  1.52838726e+06  2.85064713e+06
  5.80852476e+06]
E1 = -706.6928584516596  E_coul = 198.7020809471074
cycle= 3 E= -507.990777504552  delta_E= -0.000265  |g|= 0.00439  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00420918
diis-c [-3.42459918e-06 -3.85642476e-05 -1.15481045e-01  1.11551961e+00]
  HOMO = -0.242980027827401  LUMO = 0.79321994865274
  mo_energy =
[-1.20326928e+02 -1.23810240e+01 -6.67808195e+00 -6.67808195e+00
 -6.67808195e+00 -1.17954465e+00 -2.42980028e-01 -2.42980028e-01
 -2.42980028e-01  7.93219949e-01  4.48081310e+00  1.93073710e+01
  7.97367640e+01  2.83180213e+02  9.19604803e+02  3.17959757e+03
  1.26670037e+04  4.12646968e+04  1.05291614e+05  2.30463553e+05
  4.56270167e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.6771928136918  E_coul = 198.68641000731358
cycle= 4 E= -507.990782806378  delta_E= -5.3e-06  |g|= 0.000223  |ddm|= 0.0113
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169502
diis-c [-8.22131691e-10 -1.04242061e-05  7.21010003e-03 -9.26778069e-02
  1.08547813e+00]
  HOMO = -0.243109594675363  LUMO = 0.793184036417901
  mo_energy =
[-1.20327176e+02 -1.23812985e+01 -6.67834716e+00 -6.67834716e+00
 -6.67834716e+00 -1.17962340e+00 -2.43109595e-01 -2.43109595e-01
 -2.43109595e-01  7.93184036e-01  4.48065375e+00  1.93071267e+01
  7.97365051e+01  2.83179961e+02  9.19604558e+02  3.17959733e+03
  1.26670035e+04  4.12646965e+04  1.05291614e+05  2.30463553e+05
  4.56270166e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.6765609799131  E_coul = 198.68577816030958
cycle= 5 E= -507.990782819604  delta_E= -1.32e-08  |g|= 8.1e-06  |ddm|= 0.000748
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.56401e-06
diis-c [-1.29586014e-12  6.80470944e-07 -7.06007363e-04  8.62682942e-03
 -1.09104830e-01  1.10118333e+00]
  HOMO = -0.243112890920016  LUMO = 0.793183156091236
  mo_energy =
[-1.20327182e+02 -1.23813044e+01 -6.67835313e+00 -6.67835313e+00
 -6.67835313e+00 -1.17962568e+00 -2.43112891e-01 -2.43112891e-01
 -2.43112891e-01  7.93183156e-01  4.48064956e+00  1.93071211e+01
  7.97364989e+01  2.83179955e+02  9.19604551e+02  3.17959732e+03
  1.26670035e+04  4.12646965e+04  1.05291614e+05  2.30463553e+05
  4.56270166e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.676543847011  E_coul = 198.68576102739314
cycle= 6 E= -507.990782819618  delta_E= -1.43e-11  |g|= 8.5e-08  |ddm|= 2.89e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.676543847011  E_coul = 198.68576102739314
  HOMO = -0.243112928944657  LUMO = 0.793183129101964
  mo_energy =
[-1.20327182e+02 -1.23813045e+01 -6.67835320e+00 -6.67835320e+00
 -6.67835320e+00 -1.17962569e+00 -2.43112929e-01 -2.43112929e-01
 -2.43112929e-01  7.93183129e-01  4.48064950e+00  1.93071211e+01
  7.97364989e+01  2.83179955e+02  9.19604551e+02  3.17959732e+03
  1.26670035e+04  4.12646965e+04  1.05291614e+05  2.30463553e+05
  4.56270166e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.6765436948318  E_coul = 198.68576087521384
Extra cycle  E= -507.990782819618  delta_E= -1.14e-13  |g|= 1.18e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 912896.2551148515
E1 = -706.6765436948318  E_coul = 198.68576087521384
init E= -507.990782819618
    CPU time for initialize scf      8.91 sec, wall time      0.39 sec
  HOMO = -0.24311293407762  LUMO = 0.793183128956235
  mo_energy =
[-1.20327182e+02 -1.23813045e+01 -6.67835321e+00 -6.67835321e+00
 -6.67835321e+00 -1.17962569e+00 -2.43112934e-01 -2.43112934e-01
 -2.43112934e-01  7.93183129e-01  4.48064950e+00  1.93071211e+01
  7.97364989e+01  2.83179955e+02  9.19604551e+02  3.17959732e+03
  1.26670035e+04  4.12646965e+04  1.05291614e+05  2.30463553e+05
  4.56270166e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.6765436655307  E_coul = 198.68576084591277
cycle= 1 E= -507.990782819618  delta_E=    0  |g|= 2.13e-09  |ddm|= 3.59e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6765436655307  E_coul = 198.68576084591277
  HOMO = -0.243112935005032  LUMO = 0.793183128791078
  mo_energy =
[-1.20327182e+02 -1.23813045e+01 -6.67835322e+00 -6.67835322e+00
 -6.67835322e+00 -1.17962569e+00 -2.43112935e-01 -2.43112935e-01
 -2.43112935e-01  7.93183129e-01  4.48064949e+00  1.93071211e+01
  7.97364989e+01  2.83179955e+02  9.19604551e+02  3.17959732e+03
  1.26670035e+04  4.12646965e+04  1.05291614e+05  2.30463553e+05
  4.56270166e+05  8.45216097e+05  1.52838724e+06  2.85064711e+06
  5.80852474e+06]
E1 = -706.6765436593649  E_coul = 198.68576083974676
Extra cycle  E= -507.990782819618  delta_E= -2.27e-13  |g|= 1.89e-09  |ddm|= 5.42e-09
    CPU time for scf_cycle      9.44 sec, wall time      0.56 sec
exp = [2.19620839e-01 5.61419219e-01 1.39739779e+00 1.17616812e+05
 3.70561267e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104155e+04 3.67546908e+04 7.30164227e+03
 1.83757449e+04 1.44871120e+03 4.17474124e+02 1.49532151e+02
 6.11020885e+01 2.65157381e+01 8.57783995e+00 8.60432238e+00
 4.92749585e-01]
grad_E = [ 2.58392839e-03 -1.59862307e-03 -4.21559413e-04  5.78778784e-09
  5.65637605e-04  3.73454486e-11  1.65155970e-10  8.98174206e-10
  3.54514556e-09  1.47949364e-08  7.74588915e-08  4.89815697e-06
  1.87010118e-07 -3.41331096e-05 -1.60880168e-05 -1.72972634e-05
  1.99804334e-05  2.18040839e-05 -1.51522036e-04  3.75820991e-05
 -1.51273205e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:30 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.220037052548       1
[INPUT] 0    0    [1    /1   ]  0.560437529523       1
[INPUT] 0    0    [1    /1   ]  1.43108554862        1
[INPUT] 0    0    [1    /1   ]  117616.811754        1
[INPUT] 0    0    [1    /1   ]  3.74119292274        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069924        1
[INPUT] 0    0    [1    /1   ]  294042.030745        1
[INPUT] 0    0    [1    /1   ]  147020.990627        1
[INPUT] 0    0    [1    /1   ]  73510.4146424        1
[INPUT] 0    0    [1    /1   ]  36754.6863772        1
[INPUT] 0    0    [1    /1   ]  7301.36559226        1
[INPUT] 0    0    [1    /1   ]  18375.7341916        1
[INPUT] 0    0    [1    /1   ]  1450.82839131        1
[INPUT] 0    0    [1    /1   ]  417.429739823        1
[INPUT] 0    0    [1    /1   ]  150.565910363        1
[INPUT] 0    0    [1    /1   ]  62.0164199483        1
[INPUT] 0    0    [1    /1   ]  26.9078428148        1
[INPUT] 0    0    [1    /1   ]  8.6415254135         1
[INPUT] 1    0    [1    /1   ]  8.60428751124        1
[INPUT] 1    0    [1    /1   ]  0.492738709808       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22003705254776815, 1.0]], [0, [0.560437529522734, 1.0]], [0, [1.4310855486199865, 1.0]], [0, [117616.81175391878, 1.0]], [0, [3.741192922743147, 1.0]], [0, [1176168.14260588, 1.0]], [0, [588084.0699239399, 1.0]], [0, [294042.03074529633, 1.0]], [0, [147020.99062739935, 1.0]], [0, [73510.41464237183, 1.0]], [0, [36754.68637718353, 1.0]], [0, [7301.365592263094, 1.0]], [0, [18375.734191617412, 1.0]], [0, [1450.8283913141183, 1.0]], [0, [417.42973982252744, 1.0]], [0, [150.5659103634523, 1.0]], [0, [62.01641994827482, 1.0]], [0, [26.907842814828662, 1.0]], [0, [8.641525413503084, 1.0]], [1, [8.60428751124042, 1.0]], [1, [0.49273870980784373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22003705]
bas 1, expnt(s) = [0.56043753]
bas 2, expnt(s) = [1.43108555]
bas 3, expnt(s) = [117616.81175392]
bas 4, expnt(s) = [3.74119292]
bas 5, expnt(s) = [1176168.14260588]
bas 6, expnt(s) = [588084.06992394]
bas 7, expnt(s) = [294042.0307453]
bas 8, expnt(s) = [147020.9906274]
bas 9, expnt(s) = [73510.41464237]
bas 10, expnt(s) = [36754.68637718]
bas 11, expnt(s) = [7301.36559226]
bas 12, expnt(s) = [18375.73419162]
bas 13, expnt(s) = [1450.82839131]
bas 14, expnt(s) = [417.42973982]
bas 15, expnt(s) = [150.56591036]
bas 16, expnt(s) = [62.01641995]
bas 17, expnt(s) = [26.90784281]
bas 18, expnt(s) = [8.64152541]
bas 19, expnt(s) = [8.60428751]
bas 20, expnt(s) = [0.49273871]
CPU time:      1891.41
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20037053e-01 8.11683819e-01 5.60437530e-01 1.63647898e+00
 1.43108555e+00 3.30570596e+00 1.17616812e+05 1.60460107e+04
 3.74119292e+00 6.79630096e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104146e+04 1.12791580e+04
 3.67546864e+04 6.70655615e+03 7.30136559e+03 1.99557519e+03
 1.83757342e+04 3.98748029e+03 1.45082839e+03 5.93918781e+02
 4.17429740e+02 2.33320321e+02 1.50565910e+02 1.08595046e+02
 6.20164199e+01 5.58335244e+01 2.69078428e+01 2.98486151e+01
 8.64152541e+00 1.27337944e+01 8.60428751e+00 4.29910483e+01
 4.92738710e-01 1.20435701e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336113218378298
cond(S) = 913064.2287651224
E1 = -689.5983435511123  E_coul = 184.97181983128453
init E= -504.626523719828
    CPU time for initialize scf      7.88 sec, wall time      0.38 sec
  HOMO = -0.672186242081744  LUMO = 0.47138082822693
  mo_energy =
[-1.21709900e+02 -1.33861935e+01 -7.62354363e+00 -7.62354363e+00
 -7.62354363e+00 -1.65764857e+00 -6.72186242e-01 -6.72186242e-01
 -6.72186242e-01  4.71380828e-01  3.99618266e+00  1.87510468e+01
  7.98722105e+01  2.85979421e+02  9.25823585e+02  3.18911925e+03
  1.26800021e+04  4.12782564e+04  1.05304831e+05  2.30476403e+05
  4.56282733e+05  8.45228449e+05  1.52839939e+06  2.85065900e+06
  5.80853630e+06]
E1 = -707.7570321369506  E_coul = 199.78428860181546
cycle= 1 E= -507.972743535135  delta_E= -3.35  |g|= 0.452  |ddm|= 0.495
    CPU time for cycle= 1      0.57 sec, wall time      0.03 sec
diis-norm(errvec)=0.752886
diis-c [-0.56683687  1.        ]
  HOMO = -0.217595533322767  LUMO = 0.800027704610969
  mo_energy =
[-1.20200082e+02 -1.23045481e+01 -6.59383445e+00 -6.59383445e+00
 -6.59383445e+00 -1.16331835e+00 -2.17595533e-01 -2.17595533e-01
 -2.17595533e-01  8.00027705e-01  4.57504060e+00  1.96839122e+01
  8.11576882e+01  2.87438236e+02  9.27315939e+02  3.19055174e+03
  1.26813283e+04  4.12795154e+04  1.05306053e+05  2.30477601e+05
  4.56283914e+05  8.45229616e+05  1.52840054e+06  2.85066015e+06
  5.80853744e+06]
E1 = -706.8016334650489  E_coul = 198.81107096303228
cycle= 2 E= -507.990562502017  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.363
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0363656
diis-c [-0.00131798 -0.00282075  1.00282075]
  HOMO = -0.239778799110724  LUMO = 0.797104486852669
  mo_energy =
[-1.20315115e+02 -1.23723788e+01 -6.66893767e+00 -6.66893767e+00
 -6.66893767e+00 -1.17759446e+00 -2.39778799e-01 -2.39778799e-01
 -2.39778799e-01  7.97104487e-01  4.55088220e+00  1.96285830e+01
  8.10726815e+01  2.87332647e+02  9.27195099e+02  3.19041669e+03
  1.26811830e+04  4.12793663e+04  1.05305903e+05  2.30477449e+05
  4.56283762e+05  8.45229464e+05  1.52840039e+06  2.85065999e+06
  5.80853728e+06]
E1 = -706.6927172462757  E_coul = 198.70188991662118
cycle= 3 E= -507.990827329655  delta_E= -0.000265  |g|= 0.00439  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00417864
diis-c [-3.40050090e-06 -3.36596092e-05 -1.15050547e-01  1.11508421e+00]
  HOMO = -0.242979692131691  LUMO = 0.796467391266372
  mo_energy =
[-1.20326993e+02 -1.23810421e+01 -6.67808728e+00 -6.67808728e+00
 -6.67808728e+00 -1.17953679e+00 -2.42979692e-01 -2.42979692e-01
 -2.42979692e-01  7.96467391e-01  4.54716575e+00  1.96212939e+01
  8.10628461e+01  2.87321391e+02  9.27182973e+02  3.19040387e+03
  1.26811697e+04  4.12793528e+04  1.05305889e+05  2.30477436e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6770537910244  E_coul = 198.6862211552333
cycle= 4 E= -507.990832635791  delta_E= -5.31e-06  |g|= 0.000225  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169797
diis-c [-8.15177298e-10 -1.02743891e-05  7.21671870e-03 -9.32237200e-02
  1.08601728e+00]
  HOMO = -0.243110970420402  LUMO = 0.796430895313516
  mo_energy =
[-1.20327247e+02 -1.23813216e+01 -6.67835776e+00 -6.67835776e+00
 -6.67835776e+00 -1.17961656e+00 -2.43110970e-01 -2.43110970e-01
 -2.43110970e-01  7.96430895e-01  4.54700277e+00  1.96210449e+01
  8.10625816e+01  2.87321133e+02  9.27182721e+02  3.19040362e+03
  1.26811695e+04  4.12793526e+04  1.05305889e+05  2.30477435e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6764132673853  E_coul = 198.68558061816458
cycle= 5 E= -507.990832649221  delta_E= -1.34e-08  |g|= 8.01e-06  |ddm|= 0.000743
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.5278e-06
diis-c [-1.27196680e-12  6.74961905e-07 -6.99556448e-04  8.58968683e-03
 -1.08116294e-01  1.10022549e+00]
  HOMO = -0.243114271921269  LUMO = 0.796430014540139
  mo_energy =
[-1.20327254e+02 -1.23813276e+01 -6.67836379e+00 -6.67836379e+00
 -6.67836379e+00 -1.17961884e+00 -2.43114272e-01 -2.43114272e-01
 -2.43114272e-01  7.96430015e-01  4.54699854e+00  1.96210393e+01
  8.10625754e+01  2.87321127e+02  9.27182714e+02  3.19040361e+03
  1.26811695e+04  4.12793526e+04  1.05305889e+05  2.30477435e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6763961128129  E_coul = 198.68556346357806
cycle= 6 E= -507.990832649235  delta_E= -1.4e-11  |g|= 8.44e-08  |ddm|= 2.81e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6763961128129  E_coul = 198.68556346357806
  HOMO = -0.243114310283829  LUMO = 0.796429987859817
  mo_energy =
[-1.20327254e+02 -1.23813277e+01 -6.67836387e+00 -6.67836387e+00
 -6.67836387e+00 -1.17961885e+00 -2.43114310e-01 -2.43114310e-01
 -2.43114310e-01  7.96429988e-01  4.54699849e+00  1.96210392e+01
  8.10625753e+01  2.87321126e+02  9.27182714e+02  3.19040361e+03
  1.26811695e+04  4.12793526e+04  1.05305889e+05  2.30477435e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6763959565277  E_coul = 198.6855633072923
Extra cycle  E= -507.990832649235  delta_E= -5.68e-13  |g|= 1.07e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      8.68 sec, wall time      0.61 sec
exp = [2.20037053e-01 5.60437530e-01 1.43108555e+00 1.17616812e+05
 3.74119292e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104146e+04 3.67546864e+04 7.30136559e+03
 1.83757342e+04 1.45082839e+03 4.17429740e+02 1.50565910e+02
 6.20164199e+01 2.69078428e+01 8.64152541e+00 8.60428751e+00
 4.92738710e-01]
E = -507.99083264923536
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.220037052548       1
[INPUT] 0    0    [1    /1   ]  0.560437529523       1
[INPUT] 0    0    [1    /1   ]  1.43108554862        1
[INPUT] 0    0    [1    /1   ]  117616.811754        1
[INPUT] 0    0    [1    /1   ]  3.74119292274        1
[INPUT] 0    0    [1    /1   ]  1176168.14261        1
[INPUT] 0    0    [1    /1   ]  588084.069924        1
[INPUT] 0    0    [1    /1   ]  294042.030745        1
[INPUT] 0    0    [1    /1   ]  147020.990627        1
[INPUT] 0    0    [1    /1   ]  73510.4146424        1
[INPUT] 0    0    [1    /1   ]  36754.6863772        1
[INPUT] 0    0    [1    /1   ]  7301.36559226        1
[INPUT] 0    0    [1    /1   ]  18375.7341916        1
[INPUT] 0    0    [1    /1   ]  1450.82839131        1
[INPUT] 0    0    [1    /1   ]  417.429739823        1
[INPUT] 0    0    [1    /1   ]  150.565910363        1
[INPUT] 0    0    [1    /1   ]  62.0164199483        1
[INPUT] 0    0    [1    /1   ]  26.9078428148        1
[INPUT] 0    0    [1    /1   ]  8.6415254135         1
[INPUT] 1    0    [1    /1   ]  8.60428751124        1
[INPUT] 1    0    [1    /1   ]  0.492738709808       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.22003705254776815, 1.0]], [0, [0.560437529522734, 1.0]], [0, [1.4310855486199865, 1.0]], [0, [117616.81175391878, 1.0]], [0, [3.741192922743147, 1.0]], [0, [1176168.14260588, 1.0]], [0, [588084.0699239399, 1.0]], [0, [294042.03074529633, 1.0]], [0, [147020.99062739935, 1.0]], [0, [73510.41464237183, 1.0]], [0, [36754.68637718353, 1.0]], [0, [7301.365592263094, 1.0]], [0, [18375.734191617412, 1.0]], [0, [1450.8283913141183, 1.0]], [0, [417.42973982252744, 1.0]], [0, [150.5659103634523, 1.0]], [0, [62.01641994827482, 1.0]], [0, [26.907842814828662, 1.0]], [0, [8.641525413503084, 1.0]], [1, [8.60428751124042, 1.0]], [1, [0.49273870980784373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.22003705]
bas 1, expnt(s) = [0.56043753]
bas 2, expnt(s) = [1.43108555]
bas 3, expnt(s) = [117616.81175392]
bas 4, expnt(s) = [3.74119292]
bas 5, expnt(s) = [1176168.14260588]
bas 6, expnt(s) = [588084.06992394]
bas 7, expnt(s) = [294042.0307453]
bas 8, expnt(s) = [147020.9906274]
bas 9, expnt(s) = [73510.41464237]
bas 10, expnt(s) = [36754.68637718]
bas 11, expnt(s) = [7301.36559226]
bas 12, expnt(s) = [18375.73419162]
bas 13, expnt(s) = [1450.82839131]
bas 14, expnt(s) = [417.42973982]
bas 15, expnt(s) = [150.56591036]
bas 16, expnt(s) = [62.01641995]
bas 17, expnt(s) = [26.90784281]
bas 18, expnt(s) = [8.64152541]
bas 19, expnt(s) = [8.60428751]
bas 20, expnt(s) = [0.49273871]
CPU time:      1900.74
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.20037053e-01 8.11683819e-01 5.60437530e-01 1.63647898e+00
 1.43108555e+00 3.30570596e+00 1.17616812e+05 1.60460107e+04
 3.74119292e+00 6.79630096e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020991e+05 1.89692226e+04 7.35104146e+04 1.12791580e+04
 3.67546864e+04 6.70655615e+03 7.30136559e+03 1.99557519e+03
 1.83757342e+04 3.98748029e+03 1.45082839e+03 5.93918781e+02
 4.17429740e+02 2.33320321e+02 1.50565910e+02 1.08595046e+02
 6.20164199e+01 5.58335244e+01 2.69078428e+01 2.98486151e+01
 8.64152541e+00 1.27337944e+01 8.60428751e+00 4.29910483e+01
 4.92738710e-01 1.20435701e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336113218378298
cond(S) = 913064.2287651224
E1 = -689.5983435511123  E_coul = 184.97181983128453
init E= -504.626523719828
    CPU time for initialize scf      7.54 sec, wall time      0.37 sec
  HOMO = -0.672186242081744  LUMO = 0.47138082822693
  mo_energy =
[-1.21709900e+02 -1.33861935e+01 -7.62354363e+00 -7.62354363e+00
 -7.62354363e+00 -1.65764857e+00 -6.72186242e-01 -6.72186242e-01
 -6.72186242e-01  4.71380828e-01  3.99618266e+00  1.87510468e+01
  7.98722105e+01  2.85979421e+02  9.25823585e+02  3.18911925e+03
  1.26800021e+04  4.12782564e+04  1.05304831e+05  2.30476403e+05
  4.56282733e+05  8.45228449e+05  1.52839939e+06  2.85065900e+06
  5.80853630e+06]
E1 = -707.7570321369506  E_coul = 199.78428860181546
cycle= 1 E= -507.972743535135  delta_E= -3.35  |g|= 0.452  |ddm|= 0.495
    CPU time for cycle= 1      0.54 sec, wall time      0.03 sec
diis-norm(errvec)=0.752886
diis-c [-0.56683687  1.        ]
  HOMO = -0.217595533322767  LUMO = 0.800027704610969
  mo_energy =
[-1.20200082e+02 -1.23045481e+01 -6.59383445e+00 -6.59383445e+00
 -6.59383445e+00 -1.16331835e+00 -2.17595533e-01 -2.17595533e-01
 -2.17595533e-01  8.00027705e-01  4.57504060e+00  1.96839122e+01
  8.11576882e+01  2.87438236e+02  9.27315939e+02  3.19055174e+03
  1.26813283e+04  4.12795154e+04  1.05306053e+05  2.30477601e+05
  4.56283914e+05  8.45229616e+05  1.52840054e+06  2.85066015e+06
  5.80853744e+06]
E1 = -706.8016334650489  E_coul = 198.81107096303228
cycle= 2 E= -507.990562502017  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.363
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0363656
diis-c [-0.00131798 -0.00282075  1.00282075]
  HOMO = -0.239778799110724  LUMO = 0.797104486852669
  mo_energy =
[-1.20315115e+02 -1.23723788e+01 -6.66893767e+00 -6.66893767e+00
 -6.66893767e+00 -1.17759446e+00 -2.39778799e-01 -2.39778799e-01
 -2.39778799e-01  7.97104487e-01  4.55088220e+00  1.96285830e+01
  8.10726815e+01  2.87332647e+02  9.27195099e+02  3.19041669e+03
  1.26811830e+04  4.12793663e+04  1.05305903e+05  2.30477449e+05
  4.56283762e+05  8.45229464e+05  1.52840039e+06  2.85065999e+06
  5.80853728e+06]
E1 = -706.6927172462757  E_coul = 198.70188991662118
cycle= 3 E= -507.990827329655  delta_E= -0.000265  |g|= 0.00439  |ddm|= 0.0604
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00417864
diis-c [-3.40050090e-06 -3.36596092e-05 -1.15050547e-01  1.11508421e+00]
  HOMO = -0.242979692131691  LUMO = 0.796467391266372
  mo_energy =
[-1.20326993e+02 -1.23810421e+01 -6.67808728e+00 -6.67808728e+00
 -6.67808728e+00 -1.17953679e+00 -2.42979692e-01 -2.42979692e-01
 -2.42979692e-01  7.96467391e-01  4.54716575e+00  1.96212939e+01
  8.10628461e+01  2.87321391e+02  9.27182973e+02  3.19040387e+03
  1.26811697e+04  4.12793528e+04  1.05305889e+05  2.30477436e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6770537910244  E_coul = 198.6862211552333
cycle= 4 E= -507.990832635791  delta_E= -5.31e-06  |g|= 0.000225  |ddm|= 0.0112
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169797
diis-c [-8.15177298e-10 -1.02743891e-05  7.21671870e-03 -9.32237200e-02
  1.08601728e+00]
  HOMO = -0.243110970420402  LUMO = 0.796430895313516
  mo_energy =
[-1.20327247e+02 -1.23813216e+01 -6.67835776e+00 -6.67835776e+00
 -6.67835776e+00 -1.17961656e+00 -2.43110970e-01 -2.43110970e-01
 -2.43110970e-01  7.96430895e-01  4.54700277e+00  1.96210449e+01
  8.10625816e+01  2.87321133e+02  9.27182721e+02  3.19040362e+03
  1.26811695e+04  4.12793526e+04  1.05305889e+05  2.30477435e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6764132673853  E_coul = 198.68558061816458
cycle= 5 E= -507.990832649221  delta_E= -1.34e-08  |g|= 8.01e-06  |ddm|= 0.000743
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=3.5278e-06
diis-c [-1.27196680e-12  6.74961905e-07 -6.99556448e-04  8.58968683e-03
 -1.08116294e-01  1.10022549e+00]
  HOMO = -0.243114271921269  LUMO = 0.796430014540139
  mo_energy =
[-1.20327254e+02 -1.23813276e+01 -6.67836379e+00 -6.67836379e+00
 -6.67836379e+00 -1.17961884e+00 -2.43114272e-01 -2.43114272e-01
 -2.43114272e-01  7.96430015e-01  4.54699854e+00  1.96210393e+01
  8.10625754e+01  2.87321127e+02  9.27182714e+02  3.19040361e+03
  1.26811695e+04  4.12793526e+04  1.05305889e+05  2.30477435e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6763961128129  E_coul = 198.68556346357806
cycle= 6 E= -507.990832649235  delta_E= -1.4e-11  |g|= 8.44e-08  |ddm|= 2.81e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6763961128129  E_coul = 198.68556346357806
  HOMO = -0.243114310283829  LUMO = 0.796429987859817
  mo_energy =
[-1.20327254e+02 -1.23813277e+01 -6.67836387e+00 -6.67836387e+00
 -6.67836387e+00 -1.17961885e+00 -2.43114310e-01 -2.43114310e-01
 -2.43114310e-01  7.96429988e-01  4.54699849e+00  1.96210392e+01
  8.10625753e+01  2.87321126e+02  9.27182714e+02  3.19040361e+03
  1.26811695e+04  4.12793526e+04  1.05305889e+05  2.30477435e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6763959565277  E_coul = 198.6855633072923
Extra cycle  E= -507.990832649235  delta_E= -5.68e-13  |g|= 1.07e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      8.32 sec, wall time      0.60 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913064.2287651224
E1 = -706.6763959565277  E_coul = 198.6855633072923
init E= -507.990832649235
    CPU time for initialize scf     13.65 sec, wall time      0.59 sec
  HOMO = -0.243114315523721  LUMO = 0.796429986064162
  mo_energy =
[-1.20327254e+02 -1.23813277e+01 -6.67836388e+00 -6.67836388e+00
 -6.67836388e+00 -1.17961886e+00 -2.43114316e-01 -2.43114316e-01
 -2.43114316e-01  7.96429986e-01  4.54699848e+00  1.96210392e+01
  8.10625753e+01  2.87321126e+02  9.27182714e+02  3.19040361e+03
  1.26811695e+04  4.12793526e+04  1.05305889e+05  2.30477435e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6763959309586  E_coul = 198.68556328172392
cycle= 1 E= -507.990832649235  delta_E= 6.82e-13  |g|= 2.45e-09  |ddm|= 3.09e-08
    CPU time for cycle= 1      0.34 sec, wall time      0.03 sec
E1 = -706.6763959309586  E_coul = 198.68556328172392
  HOMO = -0.243114316337116  LUMO = 0.796429985835333
  mo_energy =
[-1.20327254e+02 -1.23813277e+01 -6.67836388e+00 -6.67836388e+00
 -6.67836388e+00 -1.17961886e+00 -2.43114316e-01 -2.43114316e-01
 -2.43114316e-01  7.96429986e-01  4.54699848e+00  1.96210392e+01
  8.10625753e+01  2.87321126e+02  9.27182714e+02  3.19040361e+03
  1.26811695e+04  4.12793526e+04  1.05305889e+05  2.30477435e+05
  4.56283748e+05  8.45229450e+05  1.52840038e+06  2.85065998e+06
  5.80853727e+06]
E1 = -706.6763959254217  E_coul = 198.6855632761866
Extra cycle  E= -507.990832649235  delta_E= -4.55e-13  |g|= 2.87e-09  |ddm|= 4.79e-09
    CPU time for scf_cycle     14.14 sec, wall time      0.77 sec
exp = [2.20037053e-01 5.60437530e-01 1.43108555e+00 1.17616812e+05
 3.74119292e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020991e+05 7.35104146e+04 3.67546864e+04 7.30136559e+03
 1.83757342e+04 1.45082839e+03 4.17429740e+02 1.50565910e+02
 6.20164199e+01 2.69078428e+01 8.64152541e+00 8.60428751e+00
 4.92738710e-01]
grad_E = [ 4.56375573e-03 -2.61759727e-03 -4.29897602e-04  5.62774788e-09
  6.06158695e-04  3.55315217e-11  1.59914377e-10  8.73589672e-10
  3.44604667e-09  1.43760003e-08  7.54352472e-08  4.77535338e-06
  1.80431157e-07 -3.07179316e-05 -3.16611052e-05  3.66925814e-06
  1.89242635e-05  1.65787423e-05 -1.46464277e-04  1.77628871e-05
 -4.91869272e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:39 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.227165804396       1
[INPUT] 0    0    [1    /1   ]  0.585872879747       1
[INPUT] 0    0    [1    /1   ]  1.7068073901         1
[INPUT] 0    0    [1    /1   ]  117616.81124         1
[INPUT] 0    0    [1    /1   ]  3.97343461025        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069909        1
[INPUT] 0    0    [1    /1   ]  294042.030666        1
[INPUT] 0    0    [1    /1   ]  147020.990312        1
[INPUT] 0    0    [1    /1   ]  73510.4133273        1
[INPUT] 0    0    [1    /1   ]  36754.6795168        1
[INPUT] 0    0    [1    /1   ]  7300.93290936        1
[INPUT] 0    0    [1    /1   ]  18375.7173805        1
[INPUT] 0    0    [1    /1   ]  1454.13726122        1
[INPUT] 0    0    [1    /1   ]  417.389683583        1
[INPUT] 0    0    [1    /1   ]  152.079011022        1
[INPUT] 0    0    [1    /1   ]  63.489761424         1
[INPUT] 0    0    [1    /1   ]  27.6520513796        1
[INPUT] 0    0    [1    /1   ]  8.94866716554        1
[INPUT] 1    0    [1    /1   ]  8.60416980354        1
[INPUT] 1    0    [1    /1   ]  0.492722122736       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2271658043963144, 1.0]], [0, [0.5858728797474144, 1.0]], [0, [1.7068073901000946, 1.0]], [0, [117616.81124000998, 1.0]], [0, [3.9734346102538254, 1.0]], [0, [1176168.142602454, 1.0]], [0, [588084.0699091784, 1.0]], [0, [294042.0306655844, 1.0]], [0, [147020.99031246334, 1.0]], [0, [73510.41332726795, 1.0]], [0, [36754.67951684297, 1.0]], [0, [7300.932909355998, 1.0]], [0, [18375.71738050089, 1.0]], [0, [1454.1372612222697, 1.0]], [0, [417.3896835831551, 1.0]], [0, [152.07901102180105, 1.0]], [0, [63.48976142399704, 1.0]], [0, [27.652051379601005, 1.0]], [0, [8.948667165543148, 1.0]], [1, [8.604169803538058, 1.0]], [1, [0.49272212273610255, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2271658]
bas 1, expnt(s) = [0.58587288]
bas 2, expnt(s) = [1.70680739]
bas 3, expnt(s) = [117616.81124001]
bas 4, expnt(s) = [3.97343461]
bas 5, expnt(s) = [1176168.14260245]
bas 6, expnt(s) = [588084.06990918]
bas 7, expnt(s) = [294042.03066558]
bas 8, expnt(s) = [147020.99031246]
bas 9, expnt(s) = [73510.41332727]
bas 10, expnt(s) = [36754.67951684]
bas 11, expnt(s) = [7300.93290936]
bas 12, expnt(s) = [18375.7173805]
bas 13, expnt(s) = [1454.13726122]
bas 14, expnt(s) = [417.38968358]
bas 15, expnt(s) = [152.07901102]
bas 16, expnt(s) = [63.48976142]
bas 17, expnt(s) = [27.65205138]
bas 18, expnt(s) = [8.94866717]
bas 19, expnt(s) = [8.6041698]
bas 20, expnt(s) = [0.49272212]
CPU time:      1930.47
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.27165804e-01 8.31327682e-01 5.85872880e-01 1.69187226e+00
 1.70680739e+00 3.77270989e+00 1.17616811e+05 1.60460106e+04
 3.97343461e+00 7.11032705e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692226e+04 7.35104133e+04 1.12791578e+04
 3.67546795e+04 6.70655521e+03 7.30093291e+03 1.99548649e+03
 1.83757174e+04 3.98747755e+03 1.45413726e+03 5.94934394e+02
 4.17389684e+02 2.33303529e+02 1.52079011e+02 1.09412511e+02
 6.34897614e+01 5.68254385e+01 2.76520514e+01 3.04656565e+01
 8.94866717e+00 1.30717517e+01 8.60416980e+00 4.29903131e+01
 4.92722123e-01 1.20430633e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336113099184637
cond(S) = 913413.5224745463
E1 = -689.5989466127672  E_coul = 184.96998381811505
init E= -504.628962794652
    CPU time for initialize scf      0.73 sec, wall time      0.07 sec
  HOMO = -0.672226811902042  LUMO = 0.520594257220219
  mo_energy =
[-1.21710148e+02 -1.33863912e+01 -7.62367795e+00 -7.62367795e+00
 -7.62367795e+00 -1.65763737e+00 -6.72226812e-01 -6.72226812e-01
 -6.72226812e-01  5.20594257e-01  4.61896845e+00  2.09120516e+01
  8.46896299e+01  2.95496034e+02  9.40494386e+02  3.20855353e+03
  1.27044068e+04  4.13032695e+04  1.05329165e+05  2.30500067e+05
  4.56305887e+05  8.45251214e+05  1.52842178e+06  2.85068094e+06
  5.80855765e+06]
E1 = -707.7540277955848  E_coul = 199.7811634734823
cycle= 1 E= -507.972864322102  delta_E= -3.34  |g|= 0.452  |ddm|= 0.494
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.758011
diis-c [-0.57457992  1.        ]
  HOMO = -0.217669394102844  LUMO = 0.862240268084685
  mo_energy =
[-1.20200467e+02 -1.23048279e+01 -6.59406512e+00 -6.59406512e+00
 -6.59406512e+00 -1.16335451e+00 -2.17669394e-01 -2.17669394e-01
 -2.17669394e-01  8.62240268e-01  5.23156738e+00  2.18650830e+01
  8.59810721e+01  2.96955871e+02  9.41986466e+02  3.20998578e+03
  1.27057329e+04  4.13045284e+04  1.05330387e+05  2.30501265e+05
  4.56307067e+05  8.45252381e+05  1.52842294e+06  2.85068208e+06
  5.80855879e+06]
E1 = -706.799818035515  E_coul = 198.8091569804442
cycle= 2 E= -507.990661055071  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350407
diis-c [-0.00122505 -0.00221436  1.00221436]
  HOMO = -0.239796643076875  LUMO = 0.858777694293461
  mo_energy =
[-1.20315329e+02 -1.23725308e+01 -6.66903530e+00 -6.66903530e+00
 -6.66903530e+00 -1.17759076e+00 -2.39796643e-01 -2.39796643e-01
 -2.39796643e-01  8.58777694e-01  5.20451140e+00  2.18079770e+01
  8.58955150e+01  2.96850203e+02  9.41865771e+02  3.20985092e+03
  1.27055878e+04  4.13043795e+04  1.05330237e+05  2.30501113e+05
  4.56306915e+05  8.45252229e+05  1.52842278e+06  2.85068193e+06
  5.80855864e+06]
E1 = -706.6914348230735  E_coul = 198.70051110946218
cycle= 3 E= -507.990923713611  delta_E= -0.000263  |g|= 0.00438  |ddm|= 0.0608
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00391823
diis-c [-3.23396283e-06  4.04193924e-05 -1.10549786e-01  1.11050937e+00]
  HOMO = -0.242972374948295  LUMO = 0.858057771954661
  mo_energy =
[-1.20327173e+02 -1.23811526e+01 -6.67814515e+00 -6.67814515e+00
 -6.67814515e+00 -1.17951654e+00 -2.42972375e-01 -2.42972375e-01
 -2.42972375e-01  8.58057772e-01  5.20043531e+00  2.18005375e+01
  8.58856655e+01  2.96838968e+02  9.41853676e+02  3.20983813e+03
  1.27055745e+04  4.13043661e+04  1.05330223e+05  2.30501100e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6759640897611  E_coul = 198.68503520167673
cycle= 4 E= -507.990928888084  delta_E= -5.17e-06  |g|= 0.000229  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169957
diis-c [-6.22837502e-10 -9.42488192e-06  7.07761383e-03 -9.62857938e-02
  1.08921760e+00]
  HOMO = -0.243114378705331  LUMO = 0.858015832161962
  mo_energy =
[-1.20327481e+02 -1.23814679e+01 -6.67845435e+00 -6.67845435e+00
 -6.67845435e+00 -1.17960260e+00 -2.43114379e-01 -2.43114379e-01
 -2.43114379e-01  8.58015832e-01  5.20024572e+00  2.18002556e+01
  8.58853581e+01  2.96838659e+02  9.41853368e+02  3.20983782e+03
  1.27055742e+04  4.13043657e+04  1.05330223e+05  2.30501099e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6752773036508  E_coul = 198.684348401816
cycle= 5 E= -507.990928901835  delta_E= -1.38e-08  |g|= 6.48e-06  |ddm|= 0.000686
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.8483e-06
diis-c [-9.98951470e-13  6.06566305e-07 -6.04680984e-04  7.82979761e-03
 -9.53075822e-02  1.08808186e+00]
  HOMO = -0.243117275988934  LUMO = 0.858015029363862
  mo_energy =
[-1.20327487e+02 -1.23814735e+01 -6.67845994e+00 -6.67845994e+00
 -6.67845994e+00 -1.17960460e+00 -2.43117276e-01 -2.43117276e-01
 -2.43117276e-01  8.58015029e-01  5.20024179e+00  2.18002504e+01
  8.58853523e+01  2.96838653e+02  9.41853361e+02  3.20983781e+03
  1.27055742e+04  4.13043657e+04  1.05330223e+05  2.30501099e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6752625245635  E_coul = 198.68433362272
cycle= 6 E= -507.990928901844  delta_E= -8.75e-12  |g|= 9.11e-08  |ddm|= 2.02e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6752625245635  E_coul = 198.68433362272
  HOMO = -0.243117317518327  LUMO = 0.85801500313184
  mo_energy =
[-1.20327487e+02 -1.23814736e+01 -6.67846002e+00 -6.67846002e+00
 -6.67846002e+00 -1.17960461e+00 -2.43117318e-01 -2.43117318e-01
 -2.43117318e-01  8.58015003e-01  5.20024173e+00  2.18002503e+01
  8.58853522e+01  2.96838653e+02  9.41853361e+02  3.20983781e+03
  1.27055742e+04  4.13043657e+04  1.05330223e+05  2.30501099e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6752623430215  E_coul = 198.6843334411781
Extra cycle  E= -507.990928901843  delta_E= 1.14e-13  |g|= 1.16e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.29 sec
exp = [2.27165804e-01 5.85872880e-01 1.70680739e+00 1.17616811e+05
 3.97343461e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104133e+04 3.67546795e+04 7.30093291e+03
 1.83757174e+04 1.45413726e+03 4.17389684e+02 1.52079011e+02
 6.34897614e+01 2.76520514e+01 8.94866717e+00 8.60416980e+00
 4.92722123e-01]
E = -507.9909289018434
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.227165804396       1
[INPUT] 0    0    [1    /1   ]  0.585872879747       1
[INPUT] 0    0    [1    /1   ]  1.7068073901         1
[INPUT] 0    0    [1    /1   ]  117616.81124         1
[INPUT] 0    0    [1    /1   ]  3.97343461025        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069909        1
[INPUT] 0    0    [1    /1   ]  294042.030666        1
[INPUT] 0    0    [1    /1   ]  147020.990312        1
[INPUT] 0    0    [1    /1   ]  73510.4133273        1
[INPUT] 0    0    [1    /1   ]  36754.6795168        1
[INPUT] 0    0    [1    /1   ]  7300.93290936        1
[INPUT] 0    0    [1    /1   ]  18375.7173805        1
[INPUT] 0    0    [1    /1   ]  1454.13726122        1
[INPUT] 0    0    [1    /1   ]  417.389683583        1
[INPUT] 0    0    [1    /1   ]  152.079011022        1
[INPUT] 0    0    [1    /1   ]  63.489761424         1
[INPUT] 0    0    [1    /1   ]  27.6520513796        1
[INPUT] 0    0    [1    /1   ]  8.94866716554        1
[INPUT] 1    0    [1    /1   ]  8.60416980354        1
[INPUT] 1    0    [1    /1   ]  0.492722122736       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2271658043963144, 1.0]], [0, [0.5858728797474144, 1.0]], [0, [1.7068073901000946, 1.0]], [0, [117616.81124000998, 1.0]], [0, [3.9734346102538254, 1.0]], [0, [1176168.142602454, 1.0]], [0, [588084.0699091784, 1.0]], [0, [294042.0306655844, 1.0]], [0, [147020.99031246334, 1.0]], [0, [73510.41332726795, 1.0]], [0, [36754.67951684297, 1.0]], [0, [7300.932909355998, 1.0]], [0, [18375.71738050089, 1.0]], [0, [1454.1372612222697, 1.0]], [0, [417.3896835831551, 1.0]], [0, [152.07901102180105, 1.0]], [0, [63.48976142399704, 1.0]], [0, [27.652051379601005, 1.0]], [0, [8.948667165543148, 1.0]], [1, [8.604169803538058, 1.0]], [1, [0.49272212273610255, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2271658]
bas 1, expnt(s) = [0.58587288]
bas 2, expnt(s) = [1.70680739]
bas 3, expnt(s) = [117616.81124001]
bas 4, expnt(s) = [3.97343461]
bas 5, expnt(s) = [1176168.14260245]
bas 6, expnt(s) = [588084.06990918]
bas 7, expnt(s) = [294042.03066558]
bas 8, expnt(s) = [147020.99031246]
bas 9, expnt(s) = [73510.41332727]
bas 10, expnt(s) = [36754.67951684]
bas 11, expnt(s) = [7300.93290936]
bas 12, expnt(s) = [18375.7173805]
bas 13, expnt(s) = [1454.13726122]
bas 14, expnt(s) = [417.38968358]
bas 15, expnt(s) = [152.07901102]
bas 16, expnt(s) = [63.48976142]
bas 17, expnt(s) = [27.65205138]
bas 18, expnt(s) = [8.94866717]
bas 19, expnt(s) = [8.6041698]
bas 20, expnt(s) = [0.49272212]
CPU time:      1932.71
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.27165804e-01 8.31327682e-01 5.85872880e-01 1.69187226e+00
 1.70680739e+00 3.77270989e+00 1.17616811e+05 1.60460106e+04
 3.97343461e+00 7.11032705e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692226e+04 7.35104133e+04 1.12791578e+04
 3.67546795e+04 6.70655521e+03 7.30093291e+03 1.99548649e+03
 1.83757174e+04 3.98747755e+03 1.45413726e+03 5.94934394e+02
 4.17389684e+02 2.33303529e+02 1.52079011e+02 1.09412511e+02
 6.34897614e+01 5.68254385e+01 2.76520514e+01 3.04656565e+01
 8.94866717e+00 1.30717517e+01 8.60416980e+00 4.29903131e+01
 4.92722123e-01 1.20430633e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336113099184637
cond(S) = 913413.5224745463
E1 = -689.5989466127672  E_coul = 184.96998381811505
init E= -504.628962794652
    CPU time for initialize scf      0.74 sec, wall time      0.07 sec
  HOMO = -0.672226811902042  LUMO = 0.520594257220219
  mo_energy =
[-1.21710148e+02 -1.33863912e+01 -7.62367795e+00 -7.62367795e+00
 -7.62367795e+00 -1.65763737e+00 -6.72226812e-01 -6.72226812e-01
 -6.72226812e-01  5.20594257e-01  4.61896845e+00  2.09120516e+01
  8.46896299e+01  2.95496034e+02  9.40494386e+02  3.20855353e+03
  1.27044068e+04  4.13032695e+04  1.05329165e+05  2.30500067e+05
  4.56305887e+05  8.45251214e+05  1.52842178e+06  2.85068094e+06
  5.80855765e+06]
E1 = -707.7540277955848  E_coul = 199.7811634734823
cycle= 1 E= -507.972864322102  delta_E= -3.34  |g|= 0.452  |ddm|= 0.494
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.758011
diis-c [-0.57457992  1.        ]
  HOMO = -0.217669394102844  LUMO = 0.862240268084685
  mo_energy =
[-1.20200467e+02 -1.23048279e+01 -6.59406512e+00 -6.59406512e+00
 -6.59406512e+00 -1.16335451e+00 -2.17669394e-01 -2.17669394e-01
 -2.17669394e-01  8.62240268e-01  5.23156738e+00  2.18650830e+01
  8.59810721e+01  2.96955871e+02  9.41986466e+02  3.20998578e+03
  1.27057329e+04  4.13045284e+04  1.05330387e+05  2.30501265e+05
  4.56307067e+05  8.45252381e+05  1.52842294e+06  2.85068208e+06
  5.80855879e+06]
E1 = -706.799818035515  E_coul = 198.8091569804442
cycle= 2 E= -507.990661055071  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.387
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0350407
diis-c [-0.00122505 -0.00221436  1.00221436]
  HOMO = -0.239796643076875  LUMO = 0.858777694293461
  mo_energy =
[-1.20315329e+02 -1.23725308e+01 -6.66903530e+00 -6.66903530e+00
 -6.66903530e+00 -1.17759076e+00 -2.39796643e-01 -2.39796643e-01
 -2.39796643e-01  8.58777694e-01  5.20451140e+00  2.18079770e+01
  8.58955150e+01  2.96850203e+02  9.41865771e+02  3.20985092e+03
  1.27055878e+04  4.13043795e+04  1.05330237e+05  2.30501113e+05
  4.56306915e+05  8.45252229e+05  1.52842278e+06  2.85068193e+06
  5.80855864e+06]
E1 = -706.6914348230735  E_coul = 198.70051110946218
cycle= 3 E= -507.990923713611  delta_E= -0.000263  |g|= 0.00438  |ddm|= 0.0608
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00391823
diis-c [-3.23396283e-06  4.04193924e-05 -1.10549786e-01  1.11050937e+00]
  HOMO = -0.242972374948295  LUMO = 0.858057771954661
  mo_energy =
[-1.20327173e+02 -1.23811526e+01 -6.67814515e+00 -6.67814515e+00
 -6.67814515e+00 -1.17951654e+00 -2.42972375e-01 -2.42972375e-01
 -2.42972375e-01  8.58057772e-01  5.20043531e+00  2.18005375e+01
  8.58856655e+01  2.96838968e+02  9.41853676e+02  3.20983813e+03
  1.27055745e+04  4.13043661e+04  1.05330223e+05  2.30501100e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6759640897611  E_coul = 198.68503520167673
cycle= 4 E= -507.990928888084  delta_E= -5.17e-06  |g|= 0.000229  |ddm|= 0.0107
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169957
diis-c [-6.22837502e-10 -9.42488192e-06  7.07761383e-03 -9.62857938e-02
  1.08921760e+00]
  HOMO = -0.243114378705331  LUMO = 0.858015832161962
  mo_energy =
[-1.20327481e+02 -1.23814679e+01 -6.67845435e+00 -6.67845435e+00
 -6.67845435e+00 -1.17960260e+00 -2.43114379e-01 -2.43114379e-01
 -2.43114379e-01  8.58015832e-01  5.20024572e+00  2.18002556e+01
  8.58853581e+01  2.96838659e+02  9.41853368e+02  3.20983782e+03
  1.27055742e+04  4.13043657e+04  1.05330223e+05  2.30501099e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6752773036508  E_coul = 198.684348401816
cycle= 5 E= -507.990928901835  delta_E= -1.38e-08  |g|= 6.48e-06  |ddm|= 0.000686
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.8483e-06
diis-c [-9.98951470e-13  6.06566305e-07 -6.04680984e-04  7.82979761e-03
 -9.53075822e-02  1.08808186e+00]
  HOMO = -0.243117275988934  LUMO = 0.858015029363862
  mo_energy =
[-1.20327487e+02 -1.23814735e+01 -6.67845994e+00 -6.67845994e+00
 -6.67845994e+00 -1.17960460e+00 -2.43117276e-01 -2.43117276e-01
 -2.43117276e-01  8.58015029e-01  5.20024179e+00  2.18002504e+01
  8.58853523e+01  2.96838653e+02  9.41853361e+02  3.20983781e+03
  1.27055742e+04  4.13043657e+04  1.05330223e+05  2.30501099e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6752625245635  E_coul = 198.68433362272
cycle= 6 E= -507.990928901844  delta_E= -8.75e-12  |g|= 9.11e-08  |ddm|= 2.02e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6752625245635  E_coul = 198.68433362272
  HOMO = -0.243117317518327  LUMO = 0.85801500313184
  mo_energy =
[-1.20327487e+02 -1.23814736e+01 -6.67846002e+00 -6.67846002e+00
 -6.67846002e+00 -1.17960461e+00 -2.43117318e-01 -2.43117318e-01
 -2.43117318e-01  8.58015003e-01  5.20024173e+00  2.18002503e+01
  8.58853522e+01  2.96838653e+02  9.41853361e+02  3.20983781e+03
  1.27055742e+04  4.13043657e+04  1.05330223e+05  2.30501099e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6752623430215  E_coul = 198.6843334411781
Extra cycle  E= -507.990928901843  delta_E= 1.14e-13  |g|= 1.16e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.59 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913413.5224745463
E1 = -706.6752623430215  E_coul = 198.6843334411781
init E= -507.990928901843
    CPU time for initialize scf      5.70 sec, wall time      0.24 sec
  HOMO = -0.24311732345588  LUMO = 0.858015001993977
  mo_energy =
[-1.20327487e+02 -1.23814736e+01 -6.67846004e+00 -6.67846004e+00
 -6.67846004e+00 -1.17960462e+00 -2.43117323e-01 -2.43117323e-01
 -2.43117323e-01  8.58015002e-01  5.20024172e+00  2.18002503e+01
  8.58853522e+01  2.96838653e+02  9.41853361e+02  3.20983781e+03
  1.27055742e+04  4.13043657e+04  1.05330223e+05  2.30501099e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6752623122188  E_coul = 198.68433341037547
cycle= 1 E= -507.990928901843  delta_E= 5.68e-14  |g|= 2.23e-09  |ddm|= 3.23e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6752623122188  E_coul = 198.68433341037547
  HOMO = -0.243117324414675  LUMO = 0.858015002022949
  mo_energy =
[-1.20327487e+02 -1.23814736e+01 -6.67846004e+00 -6.67846004e+00
 -6.67846004e+00 -1.17960462e+00 -2.43117324e-01 -2.43117324e-01
 -2.43117324e-01  8.58015002e-01  5.20024172e+00  2.18002503e+01
  8.58853522e+01  2.96838652e+02  9.41853361e+02  3.20983781e+03
  1.27055742e+04  4.13043657e+04  1.05330223e+05  2.30501099e+05
  4.56306902e+05  8.45252215e+05  1.52842277e+06  2.85068192e+06
  5.80855862e+06]
E1 = -706.6752623088656  E_coul = 198.6843334070223
Extra cycle  E= -507.990928901843  delta_E= 5.68e-14  |g|= 8.95e-10  |ddm|= 3.74e-09
    CPU time for scf_cycle      6.20 sec, wall time      0.41 sec
exp = [2.27165804e-01 5.85872880e-01 1.70680739e+00 1.17616811e+05
 3.97343461e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104133e+04 3.67546795e+04 7.30093291e+03
 1.83757174e+04 1.45413726e+03 4.17389684e+02 1.52079011e+02
 6.34897614e+01 2.76520514e+01 8.94866717e+00 8.60416980e+00
 4.92722123e-01]
grad_E = [ 4.54130528e-03 -2.18360553e-03 -2.00761200e-04  5.39815356e-09
  1.47873280e-04  3.29163481e-11  1.52401037e-10  8.38292079e-10
  3.30390369e-09  1.37752947e-08  7.25291829e-08  4.59869076e-06
  1.71034913e-07 -2.59338477e-05 -5.24610835e-05  3.12381917e-05
  5.98058184e-06  2.21453237e-05 -4.20214542e-05 -6.99733380e-05
 -9.77004107e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.263756237992       1
[INPUT] 0    0    [1    /1   ]  0.725364150276       1
[INPUT] 0    0    [1    /1   ]  3.20132532871        1
[INPUT] 0    0    [1    /1   ]  117616.809535        1
[INPUT] 0    0    [1    /1   ]  5.48887195317        1
[INPUT] 0    0    [1    /1   ]  1176168.14259        1
[INPUT] 0    0    [1    /1   ]  588084.06986         1
[INPUT] 0    0    [1    /1   ]  294042.030401        1
[INPUT] 0    0    [1    /1   ]  147020.989268        1
[INPUT] 0    0    [1    /1   ]  73510.4089648        1
[INPUT] 0    0    [1    /1   ]  36754.65676          1
[INPUT] 0    0    [1    /1   ]  7299.49772815        1
[INPUT] 0    0    [1    /1   ]  18375.6616107        1
[INPUT] 0    0    [1    /1   ]  1465.0999802         1
[INPUT] 0    0    [1    /1   ]  417.43485111         1
[INPUT] 0    0    [1    /1   ]  156.465150391        1
[INPUT] 0    0    [1    /1   ]  68.6999903839        1
[INPUT] 0    0    [1    /1   ]  30.8386805968        1
[INPUT] 0    0    [1    /1   ]  11.2421155954        1
[INPUT] 1    0    [1    /1   ]  8.60393810539        1
[INPUT] 1    0    [1    /1   ]  0.492706725879       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2637562379916832, 1.0]], [0, [0.7253641502757586, 1.0]], [0, [3.2013253287149523, 1.0]], [0, [117616.8095352656, 1.0]], [0, [5.48887195316808, 1.0]], [0, [1176168.1425910871, 1.0]], [0, [588084.06986021, 1.0]], [0, [294042.0304011635, 1.0]], [0, [147020.98926775114, 1.0]], [0, [73510.40896476549, 1.0]], [0, [36754.65675998263, 1.0]], [0, [7299.497728145661, 1.0]], [0, [18375.661610738, 1.0]], [0, [1465.0999801954108, 1.0]], [0, [417.4348511100269, 1.0]], [0, [156.46515039141048, 1.0]], [0, [68.69999038385647, 1.0]], [0, [30.838680596842, 1.0]], [0, [11.242115595420215, 1.0]], [1, [8.603938105385884, 1.0]], [1, [0.4927067258787248, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.26375624]
bas 1, expnt(s) = [0.72536415]
bas 2, expnt(s) = [3.20132533]
bas 3, expnt(s) = [117616.80953527]
bas 4, expnt(s) = [5.48887195]
bas 5, expnt(s) = [1176168.14259109]
bas 6, expnt(s) = [588084.06986021]
bas 7, expnt(s) = [294042.03040116]
bas 8, expnt(s) = [147020.98926775]
bas 9, expnt(s) = [73510.40896477]
bas 10, expnt(s) = [36754.65675998]
bas 11, expnt(s) = [7299.49772815]
bas 12, expnt(s) = [18375.66161074]
bas 13, expnt(s) = [1465.0999802]
bas 14, expnt(s) = [417.43485111]
bas 15, expnt(s) = [156.46515039]
bas 16, expnt(s) = [68.69999038]
bas 17, expnt(s) = [30.8386806]
bas 18, expnt(s) = [11.2421156]
bas 19, expnt(s) = [8.60393811]
bas 20, expnt(s) = [0.49270673]
CPU time:      1947.57
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.63756238e-01 9.29858957e-01 7.25364150e-01 1.98578438e+00
 3.20132533e+00 6.04661591e+00 1.17616810e+05 1.60460104e+04
 5.48887195e+00 9.05998229e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042030e+05 3.19023066e+04
 1.47020989e+05 1.89692225e+04 7.35104090e+04 1.12791573e+04
 3.67546568e+04 6.70655210e+03 7.29949773e+03 1.99519229e+03
 1.83756616e+04 3.98746848e+03 1.46509998e+03 5.98295135e+02
 4.17434851e+02 2.33322463e+02 1.56465150e+02 1.11770769e+02
 6.86999904e+01 6.02882297e+01 3.08386806e+01 3.30625896e+01
 1.12421156e+01 1.55114022e+01 8.60393811e+00 4.29888660e+01
 4.92706726e-01 1.20425929e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33569015533389
cond(S) = 914987.1674377206
E1 = -689.5926769083754  E_coul = 184.97384524402852
init E= -504.618831664347
    CPU time for initialize scf      0.77 sec, wall time      0.07 sec
  HOMO = -0.672091468962608  LUMO = 0.809615828411733
  mo_energy =
[-1.21709908e+02 -1.33848549e+01 -7.62332318e+00 -7.62332318e+00
 -7.62332318e+00 -1.65683623e+00 -6.72091469e-01 -6.72091469e-01
 -6.72091469e-01  8.09615828e-01  8.40484175e+00  3.38225411e+01
  1.11614984e+02  3.40230239e+02  1.00178718e+03  3.28462409e+03
  1.27957713e+04  4.13959630e+04  1.05419229e+05  2.30587657e+05
  4.56391598e+05  8.45335494e+05  1.52850469e+06  2.85076216e+06
  5.80863672e+06]
E1 = -707.7566174365816  E_coul = 199.7880930867761
cycle= 1 E= -507.968524349805  delta_E= -3.35  |g|= 0.452  |ddm|= 0.709
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.758739
diis-c [-0.57568521  1.        ]
  HOMO = -0.21828996549843  LUMO = 1.21478735904692
  mo_energy =
[-1.20198082e+02 -1.23029249e+01 -6.59310004e+00 -6.59310004e+00
 -6.59310004e+00 -1.16316663e+00 -2.18289965e-01 -2.18289965e-01
 -2.18289965e-01  1.21478736e+00  9.16439959e+00  3.48724070e+01
  1.12933972e+02  3.41694698e+02  1.00328068e+03  3.28605879e+03
  1.27971004e+04  4.13972252e+04  1.05420454e+05  2.30588857e+05
  4.56392781e+05  8.45336664e+05  1.52850584e+06  2.85076331e+06
  5.80863786e+06]
E1 = -706.7967246381281  E_coul = 198.81017146627445
cycle= 2 E= -507.986553171854  delta_E= -0.018  |g|= 0.0349  |ddm|= 0.41
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0309622
diis-c [-9.57747785e-04  1.25809244e-03  9.98741908e-01]
  HOMO = -0.24050471873122  LUMO = 1.20826624743968
  mo_energy =
[-1.20313032e+02 -1.23708848e+01 -6.66826993e+00 -6.66826993e+00
 -6.66826993e+00 -1.17744132e+00 -2.40504719e-01 -2.40504719e-01
 -2.40504719e-01  1.20826625e+00  9.12416410e+00  3.48066888e+01
  1.12845295e+02  3.41588207e+02  1.00315989e+03  3.28592395e+03
  1.27969554e+04  4.13970763e+04  1.05420303e+05  2.30588706e+05
  4.56392629e+05  8.45336512e+05  1.52850569e+06  2.85076316e+06
  5.80863770e+06]
E1 = -706.6924972759466  E_coul = 198.7057016138107
cycle= 3 E= -507.986795662136  delta_E= -0.000242  |g|= 0.00423  |ddm|= 0.0555
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00317908
diis-c [-2.30111623e-06  1.06387978e-04 -9.92940490e-02  1.09918766e+00]
  HOMO = -0.243532082053855  LUMO = 1.20715299446901
  mo_energy =
[-1.20324801e+02 -1.23793376e+01 -6.67722584e+00 -6.67722584e+00
 -6.67722584e+00 -1.17926670e+00 -2.43532082e-01 -2.43532082e-01
 -2.43532082e-01  1.20715299e+00  9.11868324e+00  3.47986121e+01
  1.12835348e+02  3.41577017e+02  1.00314786e+03  3.28591118e+03
  1.27969421e+04  4.13970628e+04  1.05420290e+05  2.30588692e+05
  4.56392616e+05  8.45336498e+05  1.52850568e+06  2.85076314e+06
  5.80863769e+06]
E1 = -706.6784289518209  E_coul = 198.69162916136872
cycle= 4 E= -507.986799790452  delta_E= -4.13e-06  |g|= 0.000196  |ddm|= 0.00847
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000142922
diis-c [-1.33692472e-10 -6.92106338e-06  6.67507026e-03 -9.85791054e-02
  1.09191096e+00]
  HOMO = -0.243667566711634  LUMO = 1.20709681621401
  mo_energy =
[-1.20325169e+02 -1.23796755e+01 -6.67756407e+00 -6.67756407e+00
 -6.67756407e+00 -1.17934738e+00 -2.43667567e-01 -2.43667567e-01
 -2.43667567e-01  1.20709682e+00  9.11844168e+00  3.47982949e+01
  1.12835000e+02  3.41576655e+02  1.00314748e+03  3.28591081e+03
  1.27969417e+04  4.13970624e+04  1.05420290e+05  2.30588692e+05
  4.56392615e+05  8.45336498e+05  1.52850568e+06  2.85076314e+06
  5.80863769e+06]
E1 = -706.6778093902677  E_coul = 198.69100959118168
cycle= 5 E= -507.986799799086  delta_E= -8.63e-09  |g|= 1.1e-06  |ddm|= 0.000444
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=5.54564e-07
diis-c [-7.17361707e-14  1.86742142e-07 -1.25757430e-04  1.69461607e-03
 -1.99180998e-02  1.01834905e+00]
  HOMO = -0.243668142007006  LUMO = 1.20709669126294
  mo_energy =
[-1.20325171e+02 -1.23796768e+01 -6.67756540e+00 -6.67756540e+00
 -6.67756540e+00 -1.17934785e+00 -2.43668142e-01 -2.43668142e-01
 -2.43668142e-01  1.20709669e+00  9.11844071e+00  3.47982937e+01
  1.12834998e+02  3.41576654e+02  1.00314748e+03  3.28591080e+03
  1.27969417e+04  4.13970624e+04  1.05420290e+05  2.30588692e+05
  4.56392615e+05  8.45336498e+05  1.52850568e+06  2.85076314e+06
  5.80863769e+06]
E1 = -706.6778066641314  E_coul = 198.6910068650449
cycle= 6 E= -507.986799799086  delta_E= -4.55e-13  |g|= 4.37e-08  |ddm|= 2.6e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6778066641314  E_coul = 198.6910068650449
  HOMO = -0.243668161159252  LUMO = 1.20709668163438
  mo_energy =
[-1.20325171e+02 -1.23796768e+01 -6.67756543e+00 -6.67756543e+00
 -6.67756543e+00 -1.17934786e+00 -2.43668161e-01 -2.43668161e-01
 -2.43668161e-01  1.20709668e+00  9.11844067e+00  3.47982937e+01
  1.12834998e+02  3.41576654e+02  1.00314748e+03  3.28591080e+03
  1.27969417e+04  4.13970624e+04  1.05420290e+05  2.30588692e+05
  4.56392615e+05  8.45336498e+05  1.52850568e+06  2.85076314e+06
  5.80863769e+06]
E1 = -706.6778065790033  E_coul = 198.69100677991693
Extra cycle  E= -507.986799799086  delta_E= 1.14e-13  |g|= 5.15e-09  |ddm|= 9.37e-08
    CPU time for scf_cycle      1.60 sec, wall time      0.30 sec
exp = [2.63756238e-01 7.25364150e-01 3.20132533e+00 1.17616810e+05
 5.48887195e+00 1.17616814e+06 5.88084070e+05 2.94042030e+05
 1.47020989e+05 7.35104090e+04 3.67546568e+04 7.29949773e+03
 1.83756616e+04 1.46509998e+03 4.17434851e+02 1.56465150e+02
 6.86999904e+01 3.08386806e+01 1.12421156e+01 8.60393811e+00
 4.92706726e-01]
E = -507.9867997990864
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.230824847756       1
[INPUT] 0    0    [1    /1   ]  0.5998220068         1
[INPUT] 0    0    [1    /1   ]  1.85625918396        1
[INPUT] 0    0    [1    /1   ]  117616.81107         1
[INPUT] 0    0    [1    /1   ]  4.12497834455        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069904        1
[INPUT] 0    0    [1    /1   ]  294042.030639        1
[INPUT] 0    0    [1    /1   ]  147020.990208        1
[INPUT] 0    0    [1    /1   ]  73510.412891         1
[INPUT] 0    0    [1    /1   ]  36754.6772412        1
[INPUT] 0    0    [1    /1   ]  7300.78939123        1
[INPUT] 0    0    [1    /1   ]  18375.7118035        1
[INPUT] 0    0    [1    /1   ]  1455.23353312        1
[INPUT] 0    0    [1    /1   ]  417.394200336        1
[INPUT] 0    0    [1    /1   ]  152.517624959        1
[INPUT] 0    0    [1    /1   ]  64.01078432          1
[INPUT] 0    0    [1    /1   ]  27.9707143013        1
[INPUT] 0    0    [1    /1   ]  9.17801200853        1
[INPUT] 1    0    [1    /1   ]  8.60414663372        1
[INPUT] 1    0    [1    /1   ]  0.49272058305        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23082484775585127, 1.0]], [0, [0.5998220068002489, 1.0]], [0, [1.8562591839615803, 1.0]], [0, [117616.81106953554, 1.0]], [0, [4.124978344545251, 1.0]], [0, [1176168.1426013173, 1.0]], [0, [588084.0699042815, 1.0]], [0, [294042.03063914226, 1.0]], [0, [147020.99020799212, 1.0]], [0, [73510.4128910177, 1.0]], [0, [36754.67724115693, 1.0]], [0, [7300.789391234965, 1.0]], [0, [18375.711803524602, 1.0]], [0, [1455.2335331195839, 1.0]], [0, [417.39420033584224, 1.0]], [0, [152.51762495876198, 1.0]], [0, [64.01078431998299, 1.0]], [0, [27.970714301325103, 1.0]], [0, [9.178012008530855, 1.0]], [1, [8.604146633722841, 1.0]], [1, [0.49272058305036476, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23082485]
bas 1, expnt(s) = [0.59982201]
bas 2, expnt(s) = [1.85625918]
bas 3, expnt(s) = [117616.81106954]
bas 4, expnt(s) = [4.12497834]
bas 5, expnt(s) = [1176168.14260132]
bas 6, expnt(s) = [588084.06990428]
bas 7, expnt(s) = [294042.03063914]
bas 8, expnt(s) = [147020.99020799]
bas 9, expnt(s) = [73510.41289102]
bas 10, expnt(s) = [36754.67724116]
bas 11, expnt(s) = [7300.78939123]
bas 12, expnt(s) = [18375.71180352]
bas 13, expnt(s) = [1455.23353312]
bas 14, expnt(s) = [417.39420034]
bas 15, expnt(s) = [152.51762496]
bas 16, expnt(s) = [64.01078432]
bas 17, expnt(s) = [27.9707143]
bas 18, expnt(s) = [9.17801201]
bas 19, expnt(s) = [8.60414663]
bas 20, expnt(s) = [0.49272058]
CPU time:      1949.76
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30824848e-01 8.41350472e-01 5.99822007e-01 1.72199474e+00
 1.85625918e+00 4.01785247e+00 1.17616811e+05 1.60460106e+04
 4.12497834e+00 7.31275930e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692226e+04 7.35104129e+04 1.12791578e+04
 3.67546772e+04 6.70655490e+03 7.30078939e+03 1.99545707e+03
 1.83757118e+04 3.98747665e+03 1.45523353e+03 5.95270752e+02
 4.17394200e+02 2.33305422e+02 1.52517625e+02 1.09649094e+02
 6.40107843e+01 5.71748305e+01 2.79707143e+01 3.07285942e+01
 9.17801201e+00 1.33222166e+01 8.60414663e+00 4.29901684e+01
 4.92720583e-01 1.20430163e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336105410087104
cond(S) = 913563.7798326506
E1 = -689.5999145599785  E_coul = 184.96974926611588
init E= -504.630165293863
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.67222371536867  LUMO = 0.547187202144209
  mo_energy =
[-1.21710191e+02 -1.33864352e+01 -7.62369986e+00 -7.62369986e+00
 -7.62369986e+00 -1.65762189e+00 -6.72223715e-01 -6.72223715e-01
 -6.72223715e-01  5.47187202e-01  4.97197045e+00  2.21977723e+01
  8.74047098e+01  2.99990421e+02  9.46628133e+02  3.21613751e+03
  1.27135118e+04  4.13125045e+04  1.05338137e+05  2.30508792e+05
  4.56314424e+05  8.45259609e+05  1.52843004e+06  2.85068903e+06
  5.80856553e+06]
E1 = -707.7532507344089  E_coul = 199.78035264059466
cycle= 1 E= -507.972898093814  delta_E= -3.34  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.75979
diis-c [-0.57728013  1.        ]
  HOMO = -0.217688804504873  LUMO = 0.895581162072342
  mo_energy =
[-1.20200548e+02 -1.23049065e+01 -6.59412912e+00 -6.59412912e+00
 -6.59412912e+00 -1.16336560e+00 -2.17688805e-01 -2.17688805e-01
 -2.17688805e-01  8.95581162e-01  5.60236913e+00  2.31626418e+01
  8.86989156e+01  3.01450467e+02  9.48120065e+02  3.21756968e+03
  1.27148378e+04  4.13137634e+04  1.05339359e+05  2.30509989e+05
  4.56315605e+05  8.45260776e+05  1.52843119e+06  2.85069017e+06
  5.80856667e+06]
E1 = -706.7993854195248  E_coul = 198.80869438810132
cycle= 2 E= -507.990691031423  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0343811
diis-c [-0.00118007 -0.00186303  1.00186303]
  HOMO = -0.239801570262987  LUMO = 0.891823102144593
  mo_energy =
[-1.20315333e+02 -1.23725587e+01 -6.66904414e+00 -6.66904414e+00
 -6.66904414e+00 -1.17759123e+00 -2.39801570e-01 -2.39801570e-01
 -2.39801570e-01  8.91823102e-01  5.57376977e+00  2.31045176e+01
  8.86130868e+01  3.01344798e+02  9.47999449e+02  3.21743492e+03
  1.27146928e+04  4.13136145e+04  1.05339208e+05  2.30509838e+05
  4.56315453e+05  8.45260624e+05  1.52843104e+06  2.85069002e+06
  5.80856651e+06]
E1 = -706.6912857950806  E_coul = 198.7003333294697
cycle= 3 E= -507.990952465611  delta_E= -0.000261  |g|= 0.00438  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00379367
diis-c [-3.13418408e-06  6.87595277e-05 -1.08429261e-01  1.10836050e+00]
  HOMO = -0.242965639613402  LUMO = 0.89105944018923
  mo_energy =
[-1.20327167e+02 -1.23811637e+01 -6.67813828e+00 -6.67813828e+00
 -6.67813828e+00 -1.17950926e+00 -2.42965640e-01 -2.42965640e-01
 -2.42965640e-01  8.91059440e-01  5.56950659e+00  2.30969889e+01
  8.86032261e+01  3.01333569e+02  9.47987363e+02  3.21742213e+03
  1.27146795e+04  4.13136011e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.675919053115  E_coul = 198.68496149023935
cycle= 4 E= -507.990957562876  delta_E= -5.1e-06  |g|= 0.00023  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169264
diis-c [-5.29548469e-10 -9.07695010e-06  7.02137161e-03 -9.77513110e-02
  1.09073902e+00]
  HOMO = -0.243111907505031  LUMO = 0.891014747725191
  mo_energy =
[-1.20327499e+02 -1.23814944e+01 -6.67846426e+00 -6.67846426e+00
 -6.67846426e+00 -1.17959776e+00 -2.43111908e-01 -2.43111908e-01
 -2.43111908e-01  8.91014748e-01  5.56930384e+00  2.30966918e+01
  8.86028998e+01  3.01333238e+02  9.47987030e+02  3.21742180e+03
  1.27146792e+04  4.13136008e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.675215093929  E_coul = 198.6842575173102
cycle= 5 E= -507.990957576619  delta_E= -1.37e-08  |g|= 5.67e-06  |ddm|= 0.000659
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.5011e-06
diis-c [-8.65139258e-13  5.70703507e-07 -5.53799029e-04  7.34258017e-03
 -8.79308796e-02  1.08114153e+00]
  HOMO = -0.243114528159599  LUMO = 0.891014008203936
  mo_energy =
[-1.20327505e+02 -1.23814995e+01 -6.67846944e+00 -6.67846944e+00
 -6.67846944e+00 -1.17959957e+00 -2.43114528e-01 -2.43114528e-01
 -2.43114528e-01  8.91014008e-01  5.56930018e+00  2.30966870e+01
  8.86028944e+01  3.01333232e+02  9.47987024e+02  3.21742179e+03
  1.27146792e+04  4.13136008e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.6752018394124  E_coul = 198.6842442627868
cycle= 6 E= -507.990957576626  delta_E= -6.76e-12  |g|= 9.27e-08  |ddm|= 1.67e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6752018394124  E_coul = 198.6842442627868
  HOMO = -0.243114570459928  LUMO = 0.891013984584736
  mo_energy =
[-1.20327505e+02 -1.23814996e+01 -6.67846952e+00 -6.67846952e+00
 -6.67846952e+00 -1.17959959e+00 -2.43114570e-01 -2.43114570e-01
 -2.43114570e-01  8.91013985e-01  5.56930011e+00  2.30966869e+01
  8.86028943e+01  3.01333232e+02  9.47987024e+02  3.21742179e+03
  1.27146792e+04  4.13136008e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.675201647957  E_coul = 198.6842440713311
Extra cycle  E= -507.990957576626  delta_E= -3.41e-13  |g|= 1.11e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.30824848e-01 5.99822007e-01 1.85625918e+00 1.17616811e+05
 4.12497834e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104129e+04 3.67546772e+04 7.30078939e+03
 1.83757118e+04 1.45523353e+03 4.17394200e+02 1.52517625e+02
 6.40107843e+01 2.79707143e+01 9.17801201e+00 8.60414663e+00
 4.92720583e-01]
E = -507.9909575766259
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:50 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.230824847756       1
[INPUT] 0    0    [1    /1   ]  0.5998220068         1
[INPUT] 0    0    [1    /1   ]  1.85625918396        1
[INPUT] 0    0    [1    /1   ]  117616.81107         1
[INPUT] 0    0    [1    /1   ]  4.12497834455        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069904        1
[INPUT] 0    0    [1    /1   ]  294042.030639        1
[INPUT] 0    0    [1    /1   ]  147020.990208        1
[INPUT] 0    0    [1    /1   ]  73510.412891         1
[INPUT] 0    0    [1    /1   ]  36754.6772412        1
[INPUT] 0    0    [1    /1   ]  7300.78939123        1
[INPUT] 0    0    [1    /1   ]  18375.7118035        1
[INPUT] 0    0    [1    /1   ]  1455.23353312        1
[INPUT] 0    0    [1    /1   ]  417.394200336        1
[INPUT] 0    0    [1    /1   ]  152.517624959        1
[INPUT] 0    0    [1    /1   ]  64.01078432          1
[INPUT] 0    0    [1    /1   ]  27.9707143013        1
[INPUT] 0    0    [1    /1   ]  9.17801200853        1
[INPUT] 1    0    [1    /1   ]  8.60414663372        1
[INPUT] 1    0    [1    /1   ]  0.49272058305        1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23082484775585127, 1.0]], [0, [0.5998220068002489, 1.0]], [0, [1.8562591839615803, 1.0]], [0, [117616.81106953554, 1.0]], [0, [4.124978344545251, 1.0]], [0, [1176168.1426013173, 1.0]], [0, [588084.0699042815, 1.0]], [0, [294042.03063914226, 1.0]], [0, [147020.99020799212, 1.0]], [0, [73510.4128910177, 1.0]], [0, [36754.67724115693, 1.0]], [0, [7300.789391234965, 1.0]], [0, [18375.711803524602, 1.0]], [0, [1455.2335331195839, 1.0]], [0, [417.39420033584224, 1.0]], [0, [152.51762495876198, 1.0]], [0, [64.01078431998299, 1.0]], [0, [27.970714301325103, 1.0]], [0, [9.178012008530855, 1.0]], [1, [8.604146633722841, 1.0]], [1, [0.49272058305036476, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23082485]
bas 1, expnt(s) = [0.59982201]
bas 2, expnt(s) = [1.85625918]
bas 3, expnt(s) = [117616.81106954]
bas 4, expnt(s) = [4.12497834]
bas 5, expnt(s) = [1176168.14260132]
bas 6, expnt(s) = [588084.06990428]
bas 7, expnt(s) = [294042.03063914]
bas 8, expnt(s) = [147020.99020799]
bas 9, expnt(s) = [73510.41289102]
bas 10, expnt(s) = [36754.67724116]
bas 11, expnt(s) = [7300.78939123]
bas 12, expnt(s) = [18375.71180352]
bas 13, expnt(s) = [1455.23353312]
bas 14, expnt(s) = [417.39420034]
bas 15, expnt(s) = [152.51762496]
bas 16, expnt(s) = [64.01078432]
bas 17, expnt(s) = [27.9707143]
bas 18, expnt(s) = [9.17801201]
bas 19, expnt(s) = [8.60414663]
bas 20, expnt(s) = [0.49272058]
CPU time:      1951.90
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.30824848e-01 8.41350472e-01 5.99822007e-01 1.72199474e+00
 1.85625918e+00 4.01785247e+00 1.17616811e+05 1.60460106e+04
 4.12497834e+00 7.31275930e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692226e+04 7.35104129e+04 1.12791578e+04
 3.67546772e+04 6.70655490e+03 7.30078939e+03 1.99545707e+03
 1.83757118e+04 3.98747665e+03 1.45523353e+03 5.95270752e+02
 4.17394200e+02 2.33305422e+02 1.52517625e+02 1.09649094e+02
 6.40107843e+01 5.71748305e+01 2.79707143e+01 3.07285942e+01
 9.17801201e+00 1.33222166e+01 8.60414663e+00 4.29901684e+01
 4.92720583e-01 1.20430163e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336105410087104
cond(S) = 913563.7798326506
E1 = -689.5999145599785  E_coul = 184.96974926611588
init E= -504.630165293863
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.67222371536867  LUMO = 0.547187202144209
  mo_energy =
[-1.21710191e+02 -1.33864352e+01 -7.62369986e+00 -7.62369986e+00
 -7.62369986e+00 -1.65762189e+00 -6.72223715e-01 -6.72223715e-01
 -6.72223715e-01  5.47187202e-01  4.97197045e+00  2.21977723e+01
  8.74047098e+01  2.99990421e+02  9.46628133e+02  3.21613751e+03
  1.27135118e+04  4.13125045e+04  1.05338137e+05  2.30508792e+05
  4.56314424e+05  8.45259609e+05  1.52843004e+06  2.85068903e+06
  5.80856553e+06]
E1 = -707.7532507344089  E_coul = 199.78035264059466
cycle= 1 E= -507.972898093814  delta_E= -3.34  |g|= 0.452  |ddm|= 0.489
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.75979
diis-c [-0.57728013  1.        ]
  HOMO = -0.217688804504873  LUMO = 0.895581162072342
  mo_energy =
[-1.20200548e+02 -1.23049065e+01 -6.59412912e+00 -6.59412912e+00
 -6.59412912e+00 -1.16336560e+00 -2.17688805e-01 -2.17688805e-01
 -2.17688805e-01  8.95581162e-01  5.60236913e+00  2.31626418e+01
  8.86989156e+01  3.01450467e+02  9.48120065e+02  3.21756968e+03
  1.27148378e+04  4.13137634e+04  1.05339359e+05  2.30509989e+05
  4.56315605e+05  8.45260776e+05  1.52843119e+06  2.85069017e+06
  5.80856667e+06]
E1 = -706.7993854195248  E_coul = 198.80869438810132
cycle= 2 E= -507.990691031423  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.395
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0343811
diis-c [-0.00118007 -0.00186303  1.00186303]
  HOMO = -0.239801570262987  LUMO = 0.891823102144593
  mo_energy =
[-1.20315333e+02 -1.23725587e+01 -6.66904414e+00 -6.66904414e+00
 -6.66904414e+00 -1.17759123e+00 -2.39801570e-01 -2.39801570e-01
 -2.39801570e-01  8.91823102e-01  5.57376977e+00  2.31045176e+01
  8.86130868e+01  3.01344798e+02  9.47999449e+02  3.21743492e+03
  1.27146928e+04  4.13136145e+04  1.05339208e+05  2.30509838e+05
  4.56315453e+05  8.45260624e+05  1.52843104e+06  2.85069002e+06
  5.80856651e+06]
E1 = -706.6912857950806  E_coul = 198.7003333294697
cycle= 3 E= -507.990952465611  delta_E= -0.000261  |g|= 0.00438  |ddm|= 0.0606
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00379367
diis-c [-3.13418408e-06  6.87595277e-05 -1.08429261e-01  1.10836050e+00]
  HOMO = -0.242965639613402  LUMO = 0.89105944018923
  mo_energy =
[-1.20327167e+02 -1.23811637e+01 -6.67813828e+00 -6.67813828e+00
 -6.67813828e+00 -1.17950926e+00 -2.42965640e-01 -2.42965640e-01
 -2.42965640e-01  8.91059440e-01  5.56950659e+00  2.30969889e+01
  8.86032261e+01  3.01333569e+02  9.47987363e+02  3.21742213e+03
  1.27146795e+04  4.13136011e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.675919053115  E_coul = 198.68496149023935
cycle= 4 E= -507.990957562876  delta_E= -5.1e-06  |g|= 0.00023  |ddm|= 0.0104
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000169264
diis-c [-5.29548469e-10 -9.07695010e-06  7.02137161e-03 -9.77513110e-02
  1.09073902e+00]
  HOMO = -0.243111907505031  LUMO = 0.891014747725191
  mo_energy =
[-1.20327499e+02 -1.23814944e+01 -6.67846426e+00 -6.67846426e+00
 -6.67846426e+00 -1.17959776e+00 -2.43111908e-01 -2.43111908e-01
 -2.43111908e-01  8.91014748e-01  5.56930384e+00  2.30966918e+01
  8.86028998e+01  3.01333238e+02  9.47987030e+02  3.21742180e+03
  1.27146792e+04  4.13136008e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.675215093929  E_coul = 198.6842575173102
cycle= 5 E= -507.990957576619  delta_E= -1.37e-08  |g|= 5.67e-06  |ddm|= 0.000659
    CPU time for cycle= 5      0.04 sec, wall time      0.04 sec
diis-norm(errvec)=2.5011e-06
diis-c [-8.65139258e-13  5.70703507e-07 -5.53799029e-04  7.34258017e-03
 -8.79308796e-02  1.08114153e+00]
  HOMO = -0.243114528159599  LUMO = 0.891014008203936
  mo_energy =
[-1.20327505e+02 -1.23814995e+01 -6.67846944e+00 -6.67846944e+00
 -6.67846944e+00 -1.17959957e+00 -2.43114528e-01 -2.43114528e-01
 -2.43114528e-01  8.91014008e-01  5.56930018e+00  2.30966870e+01
  8.86028944e+01  3.01333232e+02  9.47987024e+02  3.21742179e+03
  1.27146792e+04  4.13136008e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.6752018394124  E_coul = 198.6842442627868
cycle= 6 E= -507.990957576626  delta_E= -6.76e-12  |g|= 9.27e-08  |ddm|= 1.67e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6752018394124  E_coul = 198.6842442627868
  HOMO = -0.243114570459928  LUMO = 0.891013984584736
  mo_energy =
[-1.20327505e+02 -1.23814996e+01 -6.67846952e+00 -6.67846952e+00
 -6.67846952e+00 -1.17959959e+00 -2.43114570e-01 -2.43114570e-01
 -2.43114570e-01  8.91013985e-01  5.56930011e+00  2.30966869e+01
  8.86028943e+01  3.01333232e+02  9.47987024e+02  3.21742179e+03
  1.27146792e+04  4.13136008e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.675201647957  E_coul = 198.6842440713311
Extra cycle  E= -507.990957576626  delta_E= -3.41e-13  |g|= 1.11e-08  |ddm|= 2.26e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913563.7798326506
E1 = -706.675201647957  E_coul = 198.6842440713311
init E= -507.990957576626
    CPU time for initialize scf      5.81 sec, wall time      0.25 sec
  HOMO = -0.243114576668026  LUMO = 0.8910139818765
  mo_energy =
[-1.20327505e+02 -1.23814996e+01 -6.67846954e+00 -6.67846954e+00
 -6.67846954e+00 -1.17959959e+00 -2.43114577e-01 -2.43114577e-01
 -2.43114577e-01  8.91013982e-01  5.56930011e+00  2.30966869e+01
  8.86028943e+01  3.01333232e+02  9.47987024e+02  3.21742179e+03
  1.27146792e+04  4.13136008e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.6752016212718  E_coul = 198.68424404464605
cycle= 1 E= -507.990957576626  delta_E= 1.71e-13  |g|= 1.9e-09  |ddm|= 2.77e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6752016212718  E_coul = 198.68424404464605
  HOMO = -0.243114577513806  LUMO = 0.89101398199297
  mo_energy =
[-1.20327505e+02 -1.23814996e+01 -6.67846954e+00 -6.67846954e+00
 -6.67846954e+00 -1.17959959e+00 -2.43114578e-01 -2.43114578e-01
 -2.43114578e-01  8.91013982e-01  5.56930011e+00  2.30966869e+01
  8.86028943e+01  3.01333232e+02  9.47987024e+02  3.21742179e+03
  1.27146792e+04  4.13136008e+04  1.05339195e+05  2.30509824e+05
  4.56315439e+05  8.45260610e+05  1.52843103e+06  2.85069001e+06
  5.80856650e+06]
E1 = -706.6752016176058  E_coul = 198.68424404098008
Extra cycle  E= -507.990957576626  delta_E= -5.68e-14  |g|= 1.27e-09  |ddm|= 3.29e-09
    CPU time for scf_cycle      6.32 sec, wall time      0.42 sec
exp = [2.30824848e-01 5.99822007e-01 1.85625918e+00 1.17616811e+05
 4.12497834e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104129e+04 3.67546772e+04 7.30078939e+03
 1.83757118e+04 1.45523353e+03 4.17394200e+02 1.52517625e+02
 6.40107843e+01 2.79707143e+01 9.17801201e+00 8.60414663e+00
 4.92720583e-01]
grad_E = [ 2.88062459e-03 -1.12849302e-03  6.09743116e-05  5.33147819e-09
 -2.38145179e-04  3.21539437e-11  1.50220456e-10  8.28035026e-10
  3.26262983e-09  1.36009144e-08  7.16847666e-08  4.54756530e-06
  1.68314669e-07 -2.46329087e-05 -5.76139105e-05  3.76742700e-05
 -3.18895548e-06  3.58669486e-05  6.97351683e-05 -8.08676359e-05
 -8.76165292e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.235010196988       1
[INPUT] 0    0    [1    /1   ]  0.620025839272       1
[INPUT] 0    0    [1    /1   ]  2.04103336476        1
[INPUT] 0    0    [1    /1   ]  117616.810805        1
[INPUT] 0    0    [1    /1   ]  4.36346987389        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069897        1
[INPUT] 0    0    [1    /1   ]  294042.030598        1
[INPUT] 0    0    [1    /1   ]  147020.990046        1
[INPUT] 0    0    [1    /1   ]  73510.4122148        1
[INPUT] 0    0    [1    /1   ]  36754.6737137        1
[INPUT] 0    0    [1    /1   ]  7300.5669415         1
[INPUT] 0    0    [1    /1   ]  18375.7031586        1
[INPUT] 0    0    [1    /1   ]  1456.93133391        1
[INPUT] 0    0    [1    /1   ]  417.420410684        1
[INPUT] 0    0    [1    /1   ]  153.126747332        1
[INPUT] 0    0    [1    /1   ]  64.8806951161        1
[INPUT] 0    0    [1    /1   ]  28.5124118541        1
[INPUT] 0    0    [1    /1   ]  9.55094118626        1
[INPUT] 1    0    [1    /1   ]  8.60417727644        1
[INPUT] 1    0    [1    /1   ]  0.492739044962       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23501019698752557, 1.0]], [0, [0.6200258392720976, 1.0]], [0, [2.041033364759414, 1.0]], [0, [117616.81080529082, 1.0]], [0, [4.363469873885476, 1.0]], [0, [1176168.1425995552, 1.0]], [0, [588084.069896691, 1.0]], [0, [294042.03059815563, 1.0]], [0, [147020.99004605578, 1.0]], [0, [73510.412214804, 1.0]], [0, [36754.67371374689, 1.0]], [0, [7300.566941501612, 1.0]], [0, [18375.703158608063, 1.0]], [0, [1456.9313339103244, 1.0]], [0, [417.4204106842622, 1.0]], [0, [153.12674733151394, 1.0]], [0, [64.88069511605522, 1.0]], [0, [28.512411854066354, 1.0]], [0, [9.55094118626133, 1.0]], [1, [8.60417727644146, 1.0]], [1, [0.49273904496231297, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2350102]
bas 1, expnt(s) = [0.62002584]
bas 2, expnt(s) = [2.04103336]
bas 3, expnt(s) = [117616.81080529]
bas 4, expnt(s) = [4.36346987]
bas 5, expnt(s) = [1176168.14259956]
bas 6, expnt(s) = [588084.06989669]
bas 7, expnt(s) = [294042.03059816]
bas 8, expnt(s) = [147020.99004606]
bas 9, expnt(s) = [73510.4122148]
bas 10, expnt(s) = [36754.67371375]
bas 11, expnt(s) = [7300.5669415]
bas 12, expnt(s) = [18375.70315861]
bas 13, expnt(s) = [1456.93133391]
bas 14, expnt(s) = [417.42041068]
bas 15, expnt(s) = [153.12674733]
bas 16, expnt(s) = [64.88069512]
bas 17, expnt(s) = [28.51241185]
bas 18, expnt(s) = [9.55094119]
bas 19, expnt(s) = [8.60417728]
bas 20, expnt(s) = [0.49273904]
CPU time:      1967.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.35010197e-01 8.52766349e-01 6.20025839e-01 1.76531563e+00
 2.04103336e+00 4.31422312e+00 1.17616811e+05 1.60460106e+04
 4.36346987e+00 7.62761933e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104122e+04 1.12791577e+04
 3.67546737e+04 6.70655442e+03 7.30056694e+03 1.99541147e+03
 1.83757032e+04 3.98747524e+03 1.45693133e+03 5.95791547e+02
 4.17420411e+02 2.33316410e+02 1.53126747e+02 1.09977367e+02
 6.48806951e+01 5.77566034e+01 2.85124119e+01 3.11738536e+01
 9.55094119e+00 1.37261788e+01 8.60417728e+00 4.29903598e+01
 4.92739045e-01 1.20435803e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336075823007054
cond(S) = 913795.8019823179
E1 = -689.6026678315496  E_coul = 184.9709018069745
init E= -504.631766024575
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672170247348492  LUMO = 0.582143690051708
  mo_energy =
[-1.21710097e+02 -1.33863703e+01 -7.62363271e+00 -7.62363271e+00
 -7.62363271e+00 -1.65755687e+00 -6.72170247e-01 -6.72170247e-01
 -6.72170247e-01  5.82143690e-01  5.45133384e+00  2.40349847e+01
  9.15393918e+01  3.07059843e+02  9.56278295e+02  3.22802399e+03
  1.27277471e+04  4.13269351e+04  1.05352156e+05  2.30522425e+05
  4.56327765e+05  8.45272726e+05  1.52844294e+06  2.85070167e+06
  5.80857783e+06]
E1 = -707.753803681663  E_coul = 199.78091568168082
cycle= 1 E= -507.972887999982  delta_E= -3.34  |g|= 0.452  |ddm|= 0.479
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.761437
diis-c [-0.57978666  1.        ]
  HOMO = -0.217681778739861  LUMO = 0.939174598620299
  mo_energy =
[-1.20200452e+02 -1.23048676e+01 -6.59409383e+00 -6.59409383e+00
 -6.59409383e+00 -1.16335105e+00 -2.17681779e-01 -2.17681779e-01
 -2.17681779e-01  9.39174599e-01  6.10462159e+00  2.50168869e+01
  9.28383647e+01  3.08520409e+02  9.57770089e+02  3.22945612e+03
  1.27290731e+04  4.13281940e+04  1.05353377e+05  2.30523622e+05
  4.56328945e+05  8.45273893e+05  1.52844410e+06  2.85070282e+06
  5.80857897e+06]
E1 = -706.7993316529486  E_coul = 198.80862939553927
cycle= 2 E= -507.990702257409  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0336951
diis-c [-0.00113425 -0.00139116  1.00139116]
  HOMO = -0.23981495837382  LUMO = 0.935017139581724
  mo_energy =
[-1.20315224e+02 -1.23725302e+01 -6.66901348e+00 -6.66901348e+00
 -6.66901348e+00 -1.17758930e+00 -2.39814958e-01 -2.39814958e-01
 -2.39814958e-01  9.35017140e-01  6.07399220e+00  2.49572798e+01
  9.27520042e+01  3.08414625e+02  9.57649488e+02  3.22932139e+03
  1.27289282e+04  4.13280452e+04  1.05353227e+05  2.30523471e+05
  4.56328793e+05  8.45273741e+05  1.52844395e+06  2.85070266e+06
  5.80857882e+06]
E1 = -706.6915273864738  E_coul = 198.7005651782068
cycle= 3 E= -507.990962208267  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.0598
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00366616
diis-c [-3.00970018e-06  9.01630007e-05 -1.06307343e-01  1.10621718e+00]
  HOMO = -0.242968913216005  LUMO = 0.934195639497711
  mo_energy =
[-1.20327061e+02 -1.23811265e+01 -6.67810106e+00 -6.67810106e+00
 -6.67810106e+00 -1.17950024e+00 -2.42968913e-01 -2.42968913e-01
 -2.42968913e-01  9.34195639e-01  6.06948653e+00  2.49496163e+01
  9.27421063e+01  3.08403387e+02  9.57637395e+02  3.22930859e+03
  1.27289149e+04  4.13280317e+04  1.05353213e+05  2.30523457e+05
  4.56328780e+05  8.45273728e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6762869593216  E_coul = 198.68531976026506
cycle= 4 E= -507.990967199057  delta_E= -4.99e-06  |g|= 0.000229  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016726
diis-c [-4.21367652e-10 -8.69836738e-06  6.96496353e-03 -9.90022685e-02
  1.09204600e+00]
  HOMO = -0.243118075182948  LUMO = 0.934147858268094
  mo_energy =
[-1.20327415e+02 -1.23814702e+01 -6.67844135e+00 -6.67844135e+00
 -6.67844135e+00 -1.17959029e+00 -2.43118075e-01 -2.43118075e-01
 -2.43118075e-01  9.34147858e-01  6.06926982e+00  2.49493050e+01
  9.27417633e+01  3.08403036e+02  9.57637041e+02  3.22930823e+03
  1.27289146e+04  4.13280314e+04  1.05353213e+05  2.30523457e+05
  4.56328779e+05  8.45273727e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6755742044951  E_coul = 198.6846069920774
cycle= 5 E= -507.990967212418  delta_E= -1.34e-08  |g|= 4.68e-06  |ddm|= 0.00062
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.07722e-06
diis-c [-7.01787458e-13  5.14750779e-07 -4.85992164e-04  6.57759153e-03
 -7.75802350e-02  1.07148812e+00]
  HOMO = -0.243120305706799  LUMO = 0.93414721893236
  mo_energy =
[-1.20327420e+02 -1.23814747e+01 -6.67844587e+00 -6.67844587e+00
 -6.67844587e+00 -1.17959184e+00 -2.43120306e-01 -2.43120306e-01
 -2.43120306e-01  9.34147219e-01  6.06926658e+00  2.49493008e+01
  9.27417585e+01  3.08403031e+02  9.57637035e+02  3.22930823e+03
  1.27289146e+04  4.13280314e+04  1.05353213e+05  2.30523457e+05
  4.56328779e+05  8.45273727e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6755630405763  E_coul = 198.68459582815385
cycle= 6 E= -507.990967212422  delta_E= -4.77e-12  |g|= 9.32e-08  |ddm|= 1.3e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6755630405763  E_coul = 198.68459582815385
  HOMO = -0.243120348279057  LUMO = 0.934147195839418
  mo_energy =
[-1.20327420e+02 -1.23814748e+01 -6.67844595e+00 -6.67844595e+00
 -6.67844595e+00 -1.17959186e+00 -2.43120348e-01 -2.43120348e-01
 -2.43120348e-01  9.34147196e-01  6.06926651e+00  2.49493008e+01
  9.27417585e+01  3.08403031e+02  9.57637035e+02  3.22930823e+03
  1.27289146e+04  4.13280314e+04  1.05353213e+05  2.30523457e+05
  4.56328779e+05  8.45273727e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6755628476944  E_coul = 198.6845956352726
Extra cycle  E= -507.990967212422  delta_E= 5.68e-13  |g|= 1.14e-08  |ddm|= 2.17e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
exp = [2.35010197e-01 6.20025839e-01 2.04103336e+00 1.17616811e+05
 4.36346987e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104122e+04 3.67546737e+04 7.30056694e+03
 1.83757032e+04 1.45693133e+03 4.17420411e+02 1.53126747e+02
 6.48806951e+01 2.85124119e+01 9.55094119e+00 8.60417728e+00
 4.92739045e-01]
E = -507.9909672124219
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:39:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.235010196988       1
[INPUT] 0    0    [1    /1   ]  0.620025839272       1
[INPUT] 0    0    [1    /1   ]  2.04103336476        1
[INPUT] 0    0    [1    /1   ]  117616.810805        1
[INPUT] 0    0    [1    /1   ]  4.36346987389        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069897        1
[INPUT] 0    0    [1    /1   ]  294042.030598        1
[INPUT] 0    0    [1    /1   ]  147020.990046        1
[INPUT] 0    0    [1    /1   ]  73510.4122148        1
[INPUT] 0    0    [1    /1   ]  36754.6737137        1
[INPUT] 0    0    [1    /1   ]  7300.5669415         1
[INPUT] 0    0    [1    /1   ]  18375.7031586        1
[INPUT] 0    0    [1    /1   ]  1456.93133391        1
[INPUT] 0    0    [1    /1   ]  417.420410684        1
[INPUT] 0    0    [1    /1   ]  153.126747332        1
[INPUT] 0    0    [1    /1   ]  64.8806951161        1
[INPUT] 0    0    [1    /1   ]  28.5124118541        1
[INPUT] 0    0    [1    /1   ]  9.55094118626        1
[INPUT] 1    0    [1    /1   ]  8.60417727644        1
[INPUT] 1    0    [1    /1   ]  0.492739044962       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23501019698752557, 1.0]], [0, [0.6200258392720976, 1.0]], [0, [2.041033364759414, 1.0]], [0, [117616.81080529082, 1.0]], [0, [4.363469873885476, 1.0]], [0, [1176168.1425995552, 1.0]], [0, [588084.069896691, 1.0]], [0, [294042.03059815563, 1.0]], [0, [147020.99004605578, 1.0]], [0, [73510.412214804, 1.0]], [0, [36754.67371374689, 1.0]], [0, [7300.566941501612, 1.0]], [0, [18375.703158608063, 1.0]], [0, [1456.9313339103244, 1.0]], [0, [417.4204106842622, 1.0]], [0, [153.12674733151394, 1.0]], [0, [64.88069511605522, 1.0]], [0, [28.512411854066354, 1.0]], [0, [9.55094118626133, 1.0]], [1, [8.60417727644146, 1.0]], [1, [0.49273904496231297, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.2350102]
bas 1, expnt(s) = [0.62002584]
bas 2, expnt(s) = [2.04103336]
bas 3, expnt(s) = [117616.81080529]
bas 4, expnt(s) = [4.36346987]
bas 5, expnt(s) = [1176168.14259956]
bas 6, expnt(s) = [588084.06989669]
bas 7, expnt(s) = [294042.03059816]
bas 8, expnt(s) = [147020.99004606]
bas 9, expnt(s) = [73510.4122148]
bas 10, expnt(s) = [36754.67371375]
bas 11, expnt(s) = [7300.5669415]
bas 12, expnt(s) = [18375.70315861]
bas 13, expnt(s) = [1456.93133391]
bas 14, expnt(s) = [417.42041068]
bas 15, expnt(s) = [153.12674733]
bas 16, expnt(s) = [64.88069512]
bas 17, expnt(s) = [28.51241185]
bas 18, expnt(s) = [9.55094119]
bas 19, expnt(s) = [8.60417728]
bas 20, expnt(s) = [0.49273904]
CPU time:      1969.13
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.35010197e-01 8.52766349e-01 6.20025839e-01 1.76531563e+00
 2.04103336e+00 4.31422312e+00 1.17616811e+05 1.60460106e+04
 4.36346987e+00 7.62761933e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104122e+04 1.12791577e+04
 3.67546737e+04 6.70655442e+03 7.30056694e+03 1.99541147e+03
 1.83757032e+04 3.98747524e+03 1.45693133e+03 5.95791547e+02
 4.17420411e+02 2.33316410e+02 1.53126747e+02 1.09977367e+02
 6.48806951e+01 5.77566034e+01 2.85124119e+01 3.11738536e+01
 9.55094119e+00 1.37261788e+01 8.60417728e+00 4.29903598e+01
 4.92739045e-01 1.20435803e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336075823007054
cond(S) = 913795.8019823179
E1 = -689.6026678315496  E_coul = 184.9709018069745
init E= -504.631766024575
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672170247348492  LUMO = 0.582143690051708
  mo_energy =
[-1.21710097e+02 -1.33863703e+01 -7.62363271e+00 -7.62363271e+00
 -7.62363271e+00 -1.65755687e+00 -6.72170247e-01 -6.72170247e-01
 -6.72170247e-01  5.82143690e-01  5.45133384e+00  2.40349847e+01
  9.15393918e+01  3.07059843e+02  9.56278295e+02  3.22802399e+03
  1.27277471e+04  4.13269351e+04  1.05352156e+05  2.30522425e+05
  4.56327765e+05  8.45272726e+05  1.52844294e+06  2.85070167e+06
  5.80857783e+06]
E1 = -707.753803681663  E_coul = 199.78091568168082
cycle= 1 E= -507.972887999982  delta_E= -3.34  |g|= 0.452  |ddm|= 0.479
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.761437
diis-c [-0.57978666  1.        ]
  HOMO = -0.217681778739861  LUMO = 0.939174598620299
  mo_energy =
[-1.20200452e+02 -1.23048676e+01 -6.59409383e+00 -6.59409383e+00
 -6.59409383e+00 -1.16335105e+00 -2.17681779e-01 -2.17681779e-01
 -2.17681779e-01  9.39174599e-01  6.10462159e+00  2.50168869e+01
  9.28383647e+01  3.08520409e+02  9.57770089e+02  3.22945612e+03
  1.27290731e+04  4.13281940e+04  1.05353377e+05  2.30523622e+05
  4.56328945e+05  8.45273893e+05  1.52844410e+06  2.85070282e+06
  5.80857897e+06]
E1 = -706.7993316529486  E_coul = 198.80862939553927
cycle= 2 E= -507.990702257409  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.401
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0336951
diis-c [-0.00113425 -0.00139116  1.00139116]
  HOMO = -0.23981495837382  LUMO = 0.935017139581724
  mo_energy =
[-1.20315224e+02 -1.23725302e+01 -6.66901348e+00 -6.66901348e+00
 -6.66901348e+00 -1.17758930e+00 -2.39814958e-01 -2.39814958e-01
 -2.39814958e-01  9.35017140e-01  6.07399220e+00  2.49572798e+01
  9.27520042e+01  3.08414625e+02  9.57649488e+02  3.22932139e+03
  1.27289282e+04  4.13280452e+04  1.05353227e+05  2.30523471e+05
  4.56328793e+05  8.45273741e+05  1.52844395e+06  2.85070266e+06
  5.80857882e+06]
E1 = -706.6915273864738  E_coul = 198.7005651782068
cycle= 3 E= -507.990962208267  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.0598
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00366616
diis-c [-3.00970018e-06  9.01630007e-05 -1.06307343e-01  1.10621718e+00]
  HOMO = -0.242968913216005  LUMO = 0.934195639497711
  mo_energy =
[-1.20327061e+02 -1.23811265e+01 -6.67810106e+00 -6.67810106e+00
 -6.67810106e+00 -1.17950024e+00 -2.42968913e-01 -2.42968913e-01
 -2.42968913e-01  9.34195639e-01  6.06948653e+00  2.49496163e+01
  9.27421063e+01  3.08403387e+02  9.57637395e+02  3.22930859e+03
  1.27289149e+04  4.13280317e+04  1.05353213e+05  2.30523457e+05
  4.56328780e+05  8.45273728e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6762869593216  E_coul = 198.68531976026506
cycle= 4 E= -507.990967199057  delta_E= -4.99e-06  |g|= 0.000229  |ddm|= 0.0101
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016726
diis-c [-4.21367652e-10 -8.69836738e-06  6.96496353e-03 -9.90022685e-02
  1.09204600e+00]
  HOMO = -0.243118075182948  LUMO = 0.934147858268094
  mo_energy =
[-1.20327415e+02 -1.23814702e+01 -6.67844135e+00 -6.67844135e+00
 -6.67844135e+00 -1.17959029e+00 -2.43118075e-01 -2.43118075e-01
 -2.43118075e-01  9.34147858e-01  6.06926982e+00  2.49493050e+01
  9.27417633e+01  3.08403036e+02  9.57637041e+02  3.22930823e+03
  1.27289146e+04  4.13280314e+04  1.05353213e+05  2.30523457e+05
  4.56328779e+05  8.45273727e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6755742044951  E_coul = 198.6846069920774
cycle= 5 E= -507.990967212418  delta_E= -1.34e-08  |g|= 4.68e-06  |ddm|= 0.00062
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.07722e-06
diis-c [-7.01787458e-13  5.14750779e-07 -4.85992164e-04  6.57759153e-03
 -7.75802350e-02  1.07148812e+00]
  HOMO = -0.243120305706799  LUMO = 0.93414721893236
  mo_energy =
[-1.20327420e+02 -1.23814747e+01 -6.67844587e+00 -6.67844587e+00
 -6.67844587e+00 -1.17959184e+00 -2.43120306e-01 -2.43120306e-01
 -2.43120306e-01  9.34147219e-01  6.06926658e+00  2.49493008e+01
  9.27417585e+01  3.08403031e+02  9.57637035e+02  3.22930823e+03
  1.27289146e+04  4.13280314e+04  1.05353213e+05  2.30523457e+05
  4.56328779e+05  8.45273727e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6755630405763  E_coul = 198.68459582815385
cycle= 6 E= -507.990967212422  delta_E= -4.77e-12  |g|= 9.32e-08  |ddm|= 1.3e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6755630405763  E_coul = 198.68459582815385
  HOMO = -0.243120348279057  LUMO = 0.934147195839418
  mo_energy =
[-1.20327420e+02 -1.23814748e+01 -6.67844595e+00 -6.67844595e+00
 -6.67844595e+00 -1.17959186e+00 -2.43120348e-01 -2.43120348e-01
 -2.43120348e-01  9.34147196e-01  6.06926651e+00  2.49493008e+01
  9.27417585e+01  3.08403031e+02  9.57637035e+02  3.22930823e+03
  1.27289146e+04  4.13280314e+04  1.05353213e+05  2.30523457e+05
  4.56328779e+05  8.45273727e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6755628476944  E_coul = 198.6845956352726
Extra cycle  E= -507.990967212422  delta_E= 5.68e-13  |g|= 1.14e-08  |ddm|= 2.17e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913795.8019823179
E1 = -706.6755628476944  E_coul = 198.6845956352726
init E= -507.990967212422
    CPU time for initialize scf      5.64 sec, wall time      0.24 sec
  HOMO = -0.24312035449385  LUMO = 0.934147194774714
  mo_energy =
[-1.20327420e+02 -1.23814748e+01 -6.67844597e+00 -6.67844597e+00
 -6.67844597e+00 -1.17959186e+00 -2.43120354e-01 -2.43120354e-01
 -2.43120354e-01  9.34147195e-01  6.06926650e+00  2.49493007e+01
  9.27417584e+01  3.08403031e+02  9.57637035e+02  3.22930823e+03
  1.27289146e+04  4.13280314e+04  1.05353213e+05  2.30523457e+05
  4.56328779e+05  8.45273727e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6755628145896  E_coul = 198.68459560216746
cycle= 1 E= -507.990967212422  delta_E= -2.84e-13  |g|= 1.69e-09  |ddm|= 3.08e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6755628145896  E_coul = 198.68459560216746
  HOMO = -0.243120355503664  LUMO = 0.934147193276484
  mo_energy =
[-1.20327420e+02 -1.23814748e+01 -6.67844597e+00 -6.67844597e+00
 -6.67844597e+00 -1.17959186e+00 -2.43120356e-01 -2.43120356e-01
 -2.43120356e-01  9.34147193e-01  6.06926650e+00  2.49493007e+01
  9.27417584e+01  3.08403031e+02  9.57637035e+02  3.22930823e+03
  1.27289146e+04  4.13280314e+04  1.05353213e+05  2.30523457e+05
  4.56328779e+05  8.45273727e+05  1.52844393e+06  2.85070265e+06
  5.80857880e+06]
E1 = -706.6755628138372  E_coul = 198.68459560141528
Extra cycle  E= -507.990967212422  delta_E= 1.71e-13  |g|= 1.54e-09  |ddm|= 1.01e-09
    CPU time for scf_cycle      6.15 sec, wall time      0.41 sec
exp = [2.35010197e-01 6.20025839e-01 2.04103336e+00 1.17616811e+05
 4.36346987e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104122e+04 3.67546737e+04 7.30056694e+03
 1.83757032e+04 1.45693133e+03 4.17420411e+02 1.53126747e+02
 6.48806951e+01 2.85124119e+01 9.55094119e+00 8.60417728e+00
 4.92739045e-01]
grad_E = [-2.98138747e-03  1.59010027e-03  4.93759521e-04  5.24333478e-09
 -6.41952546e-04  3.11438204e-11  1.47338692e-10  8.14470369e-10
  3.20806985e-09  1.33704396e-08  7.05684793e-08  4.48074614e-06
  1.64723250e-07 -2.31274115e-05 -6.19643947e-05  3.78682473e-05
 -1.89554640e-06  4.41862592e-05  1.66472030e-04 -5.63087181e-05
 -1.86975879e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:06 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234215779748       1
[INPUT] 0    0    [1    /1   ]  0.61770135691        1
[INPUT] 0    0    [1    /1   ]  1.96391379203        1
[INPUT] 0    0    [1    /1   ]  117616.810818        1
[INPUT] 0    0    [1    /1   ]  4.33134813537        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069897        1
[INPUT] 0    0    [1    /1   ]  294042.0306          1
[INPUT] 0    0    [1    /1   ]  147020.990054        1
[INPUT] 0    0    [1    /1   ]  73510.4122467        1
[INPUT] 0    0    [1    /1   ]  36754.67388          1
[INPUT] 0    0    [1    /1   ]  7300.57743451        1
[INPUT] 0    0    [1    /1   ]  18375.7035659        1
[INPUT] 0    0    [1    /1   ]  1456.85017776        1
[INPUT] 0    0    [1    /1   ]  417.433779538        1
[INPUT] 0    0    [1    /1   ]  153.044002088        1
[INPUT] 0    0    [1    /1   ]  64.8904757743        1
[INPUT] 0    0    [1    /1   ]  28.5194330129        1
[INPUT] 0    0    [1    /1   ]  9.53912595833        1
[INPUT] 1    0    [1    /1   ]  8.60424460958        1
[INPUT] 1    0    [1    /1   ]  0.492748723737       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23421577974770613, 1.0]], [0, [0.6177013569103303, 1.0]], [0, [1.9639137920263372, 1.0]], [0, [117616.81081774556, 1.0]], [0, [4.331348135366994, 1.0]], [0, [1176168.142599638, 1.0]], [0, [588084.0698970486, 1.0]], [0, [294042.0306000875, 1.0]], [0, [147020.99005368823, 1.0]], [0, [73510.41224667492, 1.0]], [0, [36754.673880025104, 1.0]], [0, [7300.577434509165, 1.0]], [0, [18375.703565866836, 1.0]], [0, [1456.850177757727, 1.0]], [0, [417.43377953759943, 1.0]], [0, [153.04400208804995, 1.0]], [0, [64.89047577426095, 1.0]], [0, [28.519433012902844, 1.0]], [0, [9.539125958333216, 1.0]], [1, [8.604244609577364, 1.0]], [1, [0.49274872373729656, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23421578]
bas 1, expnt(s) = [0.61770136]
bas 2, expnt(s) = [1.96391379]
bas 3, expnt(s) = [117616.81081775]
bas 4, expnt(s) = [4.33134814]
bas 5, expnt(s) = [1176168.14259964]
bas 6, expnt(s) = [588084.06989705]
bas 7, expnt(s) = [294042.03060009]
bas 8, expnt(s) = [147020.99005369]
bas 9, expnt(s) = [73510.41224667]
bas 10, expnt(s) = [36754.67388003]
bas 11, expnt(s) = [7300.57743451]
bas 12, expnt(s) = [18375.70356587]
bas 13, expnt(s) = [1456.85017776]
bas 14, expnt(s) = [417.43377954]
bas 15, expnt(s) = [153.04400209]
bas 16, expnt(s) = [64.89047577]
bas 17, expnt(s) = [28.51943301]
bas 18, expnt(s) = [9.53912596]
bas 19, expnt(s) = [8.60424461]
bas 20, expnt(s) = [0.49274872]
CPU time:      1983.91
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34215780e-01 8.50603446e-01 6.17701357e-01 1.76034966e+00
 1.96391379e+00 4.19137809e+00 1.17616811e+05 1.60460106e+04
 4.33134814e+00 7.58546735e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104122e+04 1.12791577e+04
 3.67546739e+04 6.70655444e+03 7.30057743e+03 1.99541362e+03
 1.83757036e+04 3.98747531e+03 1.45685018e+03 5.95766656e+02
 4.17433780e+02 2.33322014e+02 1.53044002e+02 1.09932792e+02
 6.48904758e+01 5.77631333e+01 2.85194330e+01 3.11796108e+01
 9.53912596e+00 1.37134416e+01 8.60424461e+00 4.29907803e+01
 4.92748724e-01 1.20438761e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33606462751713
cond(S) = 913772.861313202
E1 = -689.6026442221739  E_coul = 184.97145478264056
init E= -504.631189439533
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672165913858291  LUMO = 0.575074156783227
  mo_energy =
[-1.21710014e+02 -1.33863234e+01 -7.62359425e+00 -7.62359425e+00
 -7.62359425e+00 -1.65754675e+00 -6.72165914e-01 -6.72165914e-01
 -6.72165914e-01  5.75074157e-01  5.31025416e+00  2.36375506e+01
  9.10286324e+01  3.06545253e+02  9.55688496e+02  3.22733506e+03
  1.27269637e+04  4.13261509e+04  1.05351395e+05  2.30521685e+05
  4.56327041e+05  8.45272015e+05  1.52844224e+06  2.85070098e+06
  5.80857717e+06]
E1 = -707.7545040882553  E_coul = 199.78160308716224
cycle= 1 E= -507.972901001093  delta_E= -3.34  |g|= 0.452  |ddm|= 0.481
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.761179
diis-c [-0.57939339  1.        ]
  HOMO = -0.217659614482089  LUMO = 0.93008979946366
  mo_energy =
[-1.20200373e+02 -1.23048213e+01 -6.59405266e+00 -6.59405266e+00
 -6.59405266e+00 -1.16332873e+00 -2.17659614e-01 -2.17659614e-01
 -2.17659614e-01  9.30089799e-01  5.95711876e+00  2.46173365e+01
  9.23277999e+01  3.08005953e+02  9.57180323e+02  3.22876717e+03
  1.27282897e+04  4.13274098e+04  1.05352617e+05  2.30522883e+05
  4.56328221e+05  8.45273182e+05  1.52844340e+06  2.85070213e+06
  5.80857830e+06]
E1 = -706.8000916266602  E_coul = 198.80937788505085
cycle= 2 E= -507.990713741609  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.398
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.03399
diis-c [-0.001154   -0.00151193  1.00151193]
  HOMO = -0.239787421740297  LUMO = 0.926032760887564
  mo_energy =
[-1.20315165e+02 -1.23724884e+01 -6.66898046e+00 -6.66898046e+00
 -6.66898046e+00 -1.17756220e+00 -2.39787422e-01 -2.39787422e-01
 -2.39787422e-01  9.26032761e-01  5.92705706e+00  2.45579582e+01
  9.22414347e+01  3.07900144e+02  9.57059698e+02  3.22863242e+03
  1.27281447e+04  4.13272610e+04  1.05352467e+05  2.30522731e+05
  4.56328069e+05  8.45273030e+05  1.52844325e+06  2.85070198e+06
  5.80857815e+06]
E1 = -706.6922676714703  E_coul = 198.70129384884942
cycle= 3 E= -507.990973822621  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00371741
diis-c [-3.05235433e-06  7.78524744e-05 -1.07135655e-01  1.10705780e+00]
  HOMO = -0.242942795584528  LUMO = 0.925225964494141
  mo_energy =
[-1.20327000e+02 -1.23810853e+01 -6.67806817e+00 -6.67806817e+00
 -6.67806817e+00 -1.17947403e+00 -2.42942796e-01 -2.42942796e-01
 -2.42942796e-01  9.25225964e-01  5.92262165e+00  2.45503171e+01
  9.22315380e+01  3.07888907e+02  9.57047609e+02  3.22861962e+03
  1.27281315e+04  4.13272476e+04  1.05352453e+05  2.30522718e+05
  4.56328056e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6770085667638  E_coul = 198.68602973772585
cycle= 4 E= -507.990978829038  delta_E= -5.01e-06  |g|= 0.000227  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000167353
diis-c [-4.46315647e-10 -8.79763101e-06  6.98019759e-03 -9.82584447e-02
  1.09128704e+00]
  HOMO = -0.243089794120541  LUMO = 0.925179312066813
  mo_energy =
[-1.20327342e+02 -1.23814219e+01 -6.67840072e+00 -6.67840072e+00
 -6.67840072e+00 -1.17956281e+00 -2.43089794e-01 -2.43089794e-01
 -2.43089794e-01  9.25179312e-01  5.92241088e+00  2.45500126e+01
  9.22312037e+01  3.07888566e+02  9.57047265e+02  3.22861928e+03
  1.27281311e+04  4.13272472e+04  1.05352453e+05  2.30522718e+05
  4.56328055e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6763054467892  E_coul = 198.68532660452266
cycle= 5 E= -507.990978842267  delta_E= -1.32e-08  |g|= 4.93e-06  |ddm|= 0.000628
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.18705e-06
diis-c [-7.44994881e-13  5.29252458e-07 -5.05631986e-04  6.77509401e-03
 -8.04898621e-02  1.07421987e+00]
  HOMO = -0.243092124786009  LUMO = 0.925178645371789
  mo_energy =
[-1.20327348e+02 -1.23814265e+01 -6.67840541e+00 -6.67840541e+00
 -6.67840541e+00 -1.17956443e+00 -2.43092125e-01 -2.43092125e-01
 -2.43092125e-01  9.25178645e-01  5.92240754e+00  2.45500083e+01
  9.22311988e+01  3.07888561e+02  9.57047260e+02  3.22861927e+03
  1.27281311e+04  4.13272472e+04  1.05352453e+05  2.30522718e+05
  4.56328055e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6762937632126  E_coul = 198.6853149209413
cycle= 6 E= -507.990978842271  delta_E= -4.66e-12  |g|= 9.36e-08  |ddm|= 1.39e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6762937632126  E_coul = 198.6853149209413
  HOMO = -0.243092167548633  LUMO = 0.925178621235912
  mo_energy =
[-1.20327348e+02 -1.23814266e+01 -6.67840549e+00 -6.67840549e+00
 -6.67840549e+00 -1.17956445e+00 -2.43092168e-01 -2.43092168e-01
 -2.43092168e-01  9.25178621e-01  5.92240747e+00  2.45500082e+01
  9.22311987e+01  3.07888561e+02  9.57047260e+02  3.22861927e+03
  1.27281311e+04  4.13272472e+04  1.05352453e+05  2.30522718e+05
  4.56328055e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6762935690508  E_coul = 198.68531472677955
Extra cycle  E= -507.990978842271  delta_E=    0  |g|= 1.11e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      1.56 sec, wall time      0.30 sec
exp = [2.34215780e-01 6.17701357e-01 1.96391379e+00 1.17616811e+05
 4.33134814e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104122e+04 3.67546739e+04 7.30057743e+03
 1.83757036e+04 1.45685018e+03 4.17433780e+02 1.53044002e+02
 6.48904758e+01 2.85194330e+01 9.53912596e+00 8.60424461e+00
 4.92748724e-01]
E = -507.99097884227126
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:07 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.234215779748       1
[INPUT] 0    0    [1    /1   ]  0.61770135691        1
[INPUT] 0    0    [1    /1   ]  1.96391379203        1
[INPUT] 0    0    [1    /1   ]  117616.810818        1
[INPUT] 0    0    [1    /1   ]  4.33134813537        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069897        1
[INPUT] 0    0    [1    /1   ]  294042.0306          1
[INPUT] 0    0    [1    /1   ]  147020.990054        1
[INPUT] 0    0    [1    /1   ]  73510.4122467        1
[INPUT] 0    0    [1    /1   ]  36754.67388          1
[INPUT] 0    0    [1    /1   ]  7300.57743451        1
[INPUT] 0    0    [1    /1   ]  18375.7035659        1
[INPUT] 0    0    [1    /1   ]  1456.85017776        1
[INPUT] 0    0    [1    /1   ]  417.433779538        1
[INPUT] 0    0    [1    /1   ]  153.044002088        1
[INPUT] 0    0    [1    /1   ]  64.8904757743        1
[INPUT] 0    0    [1    /1   ]  28.5194330129        1
[INPUT] 0    0    [1    /1   ]  9.53912595833        1
[INPUT] 1    0    [1    /1   ]  8.60424460958        1
[INPUT] 1    0    [1    /1   ]  0.492748723737       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23421577974770613, 1.0]], [0, [0.6177013569103303, 1.0]], [0, [1.9639137920263372, 1.0]], [0, [117616.81081774556, 1.0]], [0, [4.331348135366994, 1.0]], [0, [1176168.142599638, 1.0]], [0, [588084.0698970486, 1.0]], [0, [294042.0306000875, 1.0]], [0, [147020.99005368823, 1.0]], [0, [73510.41224667492, 1.0]], [0, [36754.673880025104, 1.0]], [0, [7300.577434509165, 1.0]], [0, [18375.703565866836, 1.0]], [0, [1456.850177757727, 1.0]], [0, [417.43377953759943, 1.0]], [0, [153.04400208804995, 1.0]], [0, [64.89047577426095, 1.0]], [0, [28.519433012902844, 1.0]], [0, [9.539125958333216, 1.0]], [1, [8.604244609577364, 1.0]], [1, [0.49274872373729656, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23421578]
bas 1, expnt(s) = [0.61770136]
bas 2, expnt(s) = [1.96391379]
bas 3, expnt(s) = [117616.81081775]
bas 4, expnt(s) = [4.33134814]
bas 5, expnt(s) = [1176168.14259964]
bas 6, expnt(s) = [588084.06989705]
bas 7, expnt(s) = [294042.03060009]
bas 8, expnt(s) = [147020.99005369]
bas 9, expnt(s) = [73510.41224667]
bas 10, expnt(s) = [36754.67388003]
bas 11, expnt(s) = [7300.57743451]
bas 12, expnt(s) = [18375.70356587]
bas 13, expnt(s) = [1456.85017776]
bas 14, expnt(s) = [417.43377954]
bas 15, expnt(s) = [153.04400209]
bas 16, expnt(s) = [64.89047577]
bas 17, expnt(s) = [28.51943301]
bas 18, expnt(s) = [9.53912596]
bas 19, expnt(s) = [8.60424461]
bas 20, expnt(s) = [0.49274872]
CPU time:      1986.07
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34215780e-01 8.50603446e-01 6.17701357e-01 1.76034966e+00
 1.96391379e+00 4.19137809e+00 1.17616811e+05 1.60460106e+04
 4.33134814e+00 7.58546735e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104122e+04 1.12791577e+04
 3.67546739e+04 6.70655444e+03 7.30057743e+03 1.99541362e+03
 1.83757036e+04 3.98747531e+03 1.45685018e+03 5.95766656e+02
 4.17433780e+02 2.33322014e+02 1.53044002e+02 1.09932792e+02
 6.48904758e+01 5.77631333e+01 2.85194330e+01 3.11796108e+01
 9.53912596e+00 1.37134416e+01 8.60424461e+00 4.29907803e+01
 4.92748724e-01 1.20438761e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33606462751713
cond(S) = 913772.861313202
E1 = -689.6026442221739  E_coul = 184.97145478264056
init E= -504.631189439533
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672165913858291  LUMO = 0.575074156783227
  mo_energy =
[-1.21710014e+02 -1.33863234e+01 -7.62359425e+00 -7.62359425e+00
 -7.62359425e+00 -1.65754675e+00 -6.72165914e-01 -6.72165914e-01
 -6.72165914e-01  5.75074157e-01  5.31025416e+00  2.36375506e+01
  9.10286324e+01  3.06545253e+02  9.55688496e+02  3.22733506e+03
  1.27269637e+04  4.13261509e+04  1.05351395e+05  2.30521685e+05
  4.56327041e+05  8.45272015e+05  1.52844224e+06  2.85070098e+06
  5.80857717e+06]
E1 = -707.7545040882553  E_coul = 199.78160308716224
cycle= 1 E= -507.972901001093  delta_E= -3.34  |g|= 0.452  |ddm|= 0.481
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.761179
diis-c [-0.57939339  1.        ]
  HOMO = -0.217659614482089  LUMO = 0.93008979946366
  mo_energy =
[-1.20200373e+02 -1.23048213e+01 -6.59405266e+00 -6.59405266e+00
 -6.59405266e+00 -1.16332873e+00 -2.17659614e-01 -2.17659614e-01
 -2.17659614e-01  9.30089799e-01  5.95711876e+00  2.46173365e+01
  9.23277999e+01  3.08005953e+02  9.57180323e+02  3.22876717e+03
  1.27282897e+04  4.13274098e+04  1.05352617e+05  2.30522883e+05
  4.56328221e+05  8.45273182e+05  1.52844340e+06  2.85070213e+06
  5.80857830e+06]
E1 = -706.8000916266602  E_coul = 198.80937788505085
cycle= 2 E= -507.990713741609  delta_E= -0.0178  |g|= 0.0351  |ddm|= 0.398
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.03399
diis-c [-0.001154   -0.00151193  1.00151193]
  HOMO = -0.239787421740297  LUMO = 0.926032760887564
  mo_energy =
[-1.20315165e+02 -1.23724884e+01 -6.66898046e+00 -6.66898046e+00
 -6.66898046e+00 -1.17756220e+00 -2.39787422e-01 -2.39787422e-01
 -2.39787422e-01  9.26032761e-01  5.92705706e+00  2.45579582e+01
  9.22414347e+01  3.07900144e+02  9.57059698e+02  3.22863242e+03
  1.27281447e+04  4.13272610e+04  1.05352467e+05  2.30522731e+05
  4.56328069e+05  8.45273030e+05  1.52844325e+06  2.85070198e+06
  5.80857815e+06]
E1 = -706.6922676714703  E_coul = 198.70129384884942
cycle= 3 E= -507.990973822621  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.0602
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00371741
diis-c [-3.05235433e-06  7.78524744e-05 -1.07135655e-01  1.10705780e+00]
  HOMO = -0.242942795584528  LUMO = 0.925225964494141
  mo_energy =
[-1.20327000e+02 -1.23810853e+01 -6.67806817e+00 -6.67806817e+00
 -6.67806817e+00 -1.17947403e+00 -2.42942796e-01 -2.42942796e-01
 -2.42942796e-01  9.25225964e-01  5.92262165e+00  2.45503171e+01
  9.22315380e+01  3.07888907e+02  9.57047609e+02  3.22861962e+03
  1.27281315e+04  4.13272476e+04  1.05352453e+05  2.30522718e+05
  4.56328056e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6770085667638  E_coul = 198.68602973772585
cycle= 4 E= -507.990978829038  delta_E= -5.01e-06  |g|= 0.000227  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000167353
diis-c [-4.46315647e-10 -8.79763101e-06  6.98019759e-03 -9.82584447e-02
  1.09128704e+00]
  HOMO = -0.243089794120541  LUMO = 0.925179312066813
  mo_energy =
[-1.20327342e+02 -1.23814219e+01 -6.67840072e+00 -6.67840072e+00
 -6.67840072e+00 -1.17956281e+00 -2.43089794e-01 -2.43089794e-01
 -2.43089794e-01  9.25179312e-01  5.92241088e+00  2.45500126e+01
  9.22312037e+01  3.07888566e+02  9.57047265e+02  3.22861928e+03
  1.27281311e+04  4.13272472e+04  1.05352453e+05  2.30522718e+05
  4.56328055e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6763054467892  E_coul = 198.68532660452266
cycle= 5 E= -507.990978842267  delta_E= -1.32e-08  |g|= 4.93e-06  |ddm|= 0.000628
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.18705e-06
diis-c [-7.44994881e-13  5.29252458e-07 -5.05631986e-04  6.77509401e-03
 -8.04898621e-02  1.07421987e+00]
  HOMO = -0.243092124786009  LUMO = 0.925178645371789
  mo_energy =
[-1.20327348e+02 -1.23814265e+01 -6.67840541e+00 -6.67840541e+00
 -6.67840541e+00 -1.17956443e+00 -2.43092125e-01 -2.43092125e-01
 -2.43092125e-01  9.25178645e-01  5.92240754e+00  2.45500083e+01
  9.22311988e+01  3.07888561e+02  9.57047260e+02  3.22861927e+03
  1.27281311e+04  4.13272472e+04  1.05352453e+05  2.30522718e+05
  4.56328055e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6762937632126  E_coul = 198.6853149209413
cycle= 6 E= -507.990978842271  delta_E= -4.66e-12  |g|= 9.36e-08  |ddm|= 1.39e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6762937632126  E_coul = 198.6853149209413
  HOMO = -0.243092167548633  LUMO = 0.925178621235912
  mo_energy =
[-1.20327348e+02 -1.23814266e+01 -6.67840549e+00 -6.67840549e+00
 -6.67840549e+00 -1.17956445e+00 -2.43092168e-01 -2.43092168e-01
 -2.43092168e-01  9.25178621e-01  5.92240747e+00  2.45500082e+01
  9.22311987e+01  3.07888561e+02  9.57047260e+02  3.22861927e+03
  1.27281311e+04  4.13272472e+04  1.05352453e+05  2.30522718e+05
  4.56328055e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6762935690508  E_coul = 198.68531472677955
Extra cycle  E= -507.990978842271  delta_E=    0  |g|= 1.11e-08  |ddm|= 2.22e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913772.861313202
E1 = -706.6762935690508  E_coul = 198.68531472677955
init E= -507.990978842271
    CPU time for initialize scf      5.77 sec, wall time      0.24 sec
  HOMO = -0.243092173806694  LUMO = 0.92517861848238
  mo_energy =
[-1.20327348e+02 -1.23814266e+01 -6.67840551e+00 -6.67840551e+00
 -6.67840551e+00 -1.17956445e+00 -2.43092174e-01 -2.43092174e-01
 -2.43092174e-01  9.25178618e-01  5.92240746e+00  2.45500082e+01
  9.22311987e+01  3.07888561e+02  9.57047260e+02  3.22861927e+03
  1.27281311e+04  4.13272472e+04  1.05352453e+05  2.30522718e+05
  4.56328055e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6762935435797  E_coul = 198.68531470130804
cycle= 1 E= -507.990978842272  delta_E= -4.55e-13  |g|= 2.6e-09  |ddm|= 2.56e-08
    CPU time for cycle= 1      0.35 sec, wall time      0.03 sec
E1 = -706.6762935435797  E_coul = 198.68531470130804
  HOMO = -0.243092174615276  LUMO = 0.925178618119277
  mo_energy =
[-1.20327348e+02 -1.23814266e+01 -6.67840551e+00 -6.67840551e+00
 -6.67840551e+00 -1.17956445e+00 -2.43092175e-01 -2.43092175e-01
 -2.43092175e-01  9.25178618e-01  5.92240746e+00  2.45500082e+01
  9.22311987e+01  3.07888561e+02  9.57047260e+02  3.22861927e+03
  1.27281311e+04  4.13272472e+04  1.05352453e+05  2.30522718e+05
  4.56328055e+05  8.45273016e+05  1.52844323e+06  2.85070196e+06
  5.80857814e+06]
E1 = -706.6762935393974  E_coul = 198.68531469712565
Extra cycle  E= -507.990978842272  delta_E= -5.68e-14  |g|= 1.72e-09  |ddm|= 3.77e-09
    CPU time for scf_cycle      6.27 sec, wall time      0.42 sec
exp = [2.34215780e-01 6.17701357e-01 1.96391379e+00 1.17616811e+05
 4.33134814e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104122e+04 3.67546739e+04 7.30057743e+03
 1.83757036e+04 1.45685018e+03 4.17433780e+02 1.53044002e+02
 6.48904758e+01 2.85194330e+01 9.53912596e+00 8.60424461e+00
 4.92748724e-01]
grad_E = [-1.39861824e-03  7.92041133e-04  1.01946417e-04  5.25921176e-09
 -2.99382556e-04  3.13259154e-11  1.47857564e-10  8.16913809e-10
  3.21789611e-09  1.34119520e-08  7.07701590e-08  4.49374681e-06
  1.65366992e-07 -2.36170645e-05 -5.86711153e-05  2.89342493e-05
  1.34126711e-05  2.69123381e-05  9.05047512e-05 -1.73343611e-05
  8.12302977e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:14 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.235187714923       1
[INPUT] 0    0    [1    /1   ]  0.620619665442       1
[INPUT] 0    0    [1    /1   ]  1.99408026776        1
[INPUT] 0    0    [1    /1   ]  117616.810774        1
[INPUT] 0    0    [1    /1   ]  4.39346214214        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069896        1
[INPUT] 0    0    [1    /1   ]  294042.030593        1
[INPUT] 0    0    [1    /1   ]  147020.990027        1
[INPUT] 0    0    [1    /1   ]  73510.4121358        1
[INPUT] 0    0    [1    /1   ]  36754.6733017        1
[INPUT] 0    0    [1    /1   ]  7300.54097203        1
[INPUT] 0    0    [1    /1   ]  18375.7021481        1
[INPUT] 0    0    [1    /1   ]  1457.12729845        1
[INPUT] 0    0    [1    /1   ]  417.454603963        1
[INPUT] 0    0    [1    /1   ]  153.083988885        1
[INPUT] 0    0    [1    /1   ]  65.0755993492        1
[INPUT] 0    0    [1    /1   ]  28.6643691038        1
[INPUT] 0    0    [1    /1   ]  9.63963014359        1
[INPUT] 1    0    [1    /1   ]  8.60426703439        1
[INPUT] 1    0    [1    /1   ]  0.492750036569       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23518771492287993, 1.0]], [0, [0.6206196654422711, 1.0]], [0, [1.9940802677586544, 1.0]], [0, [117616.81077441965, 1.0]], [0, [4.393462142135622, 1.0]], [0, [1176168.142599349, 1.0]], [0, [588084.0698958039, 1.0]], [0, [294042.0305933673, 1.0]], [0, [147020.9900271367, 1.0]], [0, [73510.41213579997, 1.0]], [0, [36754.67330169596, 1.0]], [0, [7300.54097202618, 1.0]], [0, [18375.702148114375, 1.0]], [0, [1457.1272984502375, 1.0]], [0, [417.45460396333254, 1.0]], [0, [153.08398888504436, 1.0]], [0, [65.0755993491895, 1.0]], [0, [28.664369103841683, 1.0]], [0, [9.639630143588288, 1.0]], [1, [8.60426703438532, 1.0]], [1, [0.4927500365689384, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23518771]
bas 1, expnt(s) = [0.62061967]
bas 2, expnt(s) = [1.99408027]
bas 3, expnt(s) = [117616.81077442]
bas 4, expnt(s) = [4.39346214]
bas 5, expnt(s) = [1176168.14259935]
bas 6, expnt(s) = [588084.0698958]
bas 7, expnt(s) = [294042.03059337]
bas 8, expnt(s) = [147020.99002714]
bas 9, expnt(s) = [73510.4121358]
bas 10, expnt(s) = [36754.6733017]
bas 11, expnt(s) = [7300.54097203]
bas 12, expnt(s) = [18375.70214811]
bas 13, expnt(s) = [1457.12729845]
bas 14, expnt(s) = [417.45460396]
bas 15, expnt(s) = [153.08398889]
bas 16, expnt(s) = [65.07559935]
bas 17, expnt(s) = [28.6643691]
bas 18, expnt(s) = [9.63963014]
bas 19, expnt(s) = [8.60426703]
bas 20, expnt(s) = [0.49275004]
CPU time:      2001.03
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.35187715e-01 8.53249414e-01 6.20619665e-01 1.76658352e+00
 1.99408027e+00 4.23957186e+00 1.17616811e+05 1.60460106e+04
 4.39346214e+00 7.66690692e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104121e+04 1.12791577e+04
 3.67546733e+04 6.70655436e+03 7.30054097e+03 1.99540615e+03
 1.83757021e+04 3.98747507e+03 1.45712730e+03 5.95851648e+02
 4.17454604e+02 2.33330744e+02 1.53083989e+02 1.09954334e+02
 6.50755993e+01 5.78866820e+01 2.86643691e+01 3.12983768e+01
 9.63963014e+00 1.38216631e+01 8.60426703e+00 4.29909204e+01
 4.92750037e-01 1.20439162e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336056612921194
cond(S) = 913820.1233793665
E1 = -689.6026529386479  E_coul = 184.97153057217855
init E= -504.631122366469
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672166492474192  LUMO = 0.581431492272296
  mo_energy =
[-1.21709999e+02 -1.33863225e+01 -7.62359003e+00 -7.62359003e+00
 -7.62359003e+00 -1.65753955e+00 -6.72166492e-01 -6.72166492e-01
 -6.72166492e-01  5.81431492e-01  5.40045742e+00  2.40420648e+01
  9.20153907e+01  3.08179776e+02  9.57744599e+02  3.22970323e+03
  1.27296700e+04  4.13288625e+04  1.05354025e+05  2.30524243e+05
  4.56329544e+05  8.45274476e+05  1.52844466e+06  2.85070336e+06
  5.80857947e+06]
E1 = -707.7544838629918  E_coul = 199.78157126396232
cycle= 1 E= -507.97291259903  delta_E= -3.34  |g|= 0.452  |ddm|= 0.482
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.76145
diis-c [-0.579806  1.      ]
  HOMO = -0.217661187493977  LUMO = 0.937974516571132
  mo_energy =
[-1.20200369e+02 -1.23048293e+01 -6.59405777e+00 -6.59405777e+00
 -6.59405777e+00 -1.16332464e+00 -2.17661187e-01 -2.17661187e-01
 -2.17661187e-01  9.37974517e-01  6.05181765e+00  2.50259370e+01
  9.33157997e+01  3.09640581e+02  9.59236384e+02  3.23113532e+03
  1.27309960e+04  4.13301214e+04  1.05355247e+05  2.30525440e+05
  4.56330724e+05  8.45275643e+05  1.52844582e+06  2.85070450e+06
  5.80858061e+06]
E1 = -706.8003987071863  E_coul = 198.80967927870032
cycle= 2 E= -507.990719428486  delta_E= -0.0178  |g|= 0.0351  |ddm|=  0.4
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.033871
diis-c [-0.0011461  -0.00140892  1.00140892]
  HOMO = -0.239775680462756  LUMO = 0.933850672420068
  mo_energy =
[-1.20315120e+02 -1.23724652e+01 -6.66895324e+00 -6.66895324e+00
 -6.66895324e+00 -1.17754844e+00 -2.39775680e-01 -2.39775680e-01
 -2.39775680e-01  9.33850672e-01  6.02139295e+00  2.49662487e+01
  9.32293363e+01  3.09534785e+02  9.59115802e+02  3.23100061e+03
  1.27308511e+04  4.13299726e+04  1.05355096e+05  2.30525289e+05
  4.56330572e+05  8.45275491e+05  1.52844567e+06  2.85070435e+06
  5.80858046e+06]
E1 = -706.6926941925734  E_coul = 198.70171514551086
cycle= 3 E= -507.990979047063  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00369531
diis-c [-3.02750316e-06  7.94662322e-05 -1.06780090e-01  1.10670062e+00]
  HOMO = -0.242927265549215  LUMO = 0.933034410922809
  mo_energy =
[-1.20326952e+02 -1.23810570e+01 -6.67803621e+00 -6.67803621e+00
 -6.67803621e+00 -1.17945775e+00 -2.42927266e-01 -2.42927266e-01
 -2.42927266e-01  9.33034411e-01  6.01691425e+00  2.49585797e+01
  9.32194336e+01  3.09523549e+02  9.59103715e+02  3.23098782e+03
  1.27308378e+04  4.13299591e+04  1.05355083e+05  2.30525275e+05
  4.56330559e+05  8.45275477e+05  1.52844565e+06  2.85070434e+06
  5.80858045e+06]
E1 = -706.6774633000897  E_coul = 198.6864792662873
cycle= 4 E= -507.990984033802  delta_E= -4.99e-06  |g|= 0.000227  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016695
diis-c [-4.29512706e-10 -8.72349323e-06  6.97610814e-03 -9.85063153e-02
  1.09153893e+00]
  HOMO = -0.243074675370308  LUMO = 0.932987245954806
  mo_energy =
[-1.20327298e+02 -1.23813956e+01 -6.67837102e+00 -6.67837102e+00
 -6.67837102e+00 -1.17954675e+00 -2.43074675e-01 -2.43074675e-01
 -2.43074675e-01  9.32987246e-01  6.01670100e+00  2.49582728e+01
  9.32190966e+01  3.09523205e+02  9.59103368e+02  3.23098747e+03
  1.27308374e+04  4.13299588e+04  1.05355083e+05  2.30525275e+05
  4.56330558e+05  8.45275477e+05  1.52844565e+06  2.85070433e+06
  5.80858045e+06]
E1 = -706.6767588476487  E_coul = 198.68577480067506
cycle= 5 E= -507.990984046974  delta_E= -1.32e-08  |g|= 4.77e-06  |ddm|= 0.000623
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.1189e-06
diis-c [-7.19027035e-13  5.13869720e-07 -4.93559812e-04  6.63302197e-03
 -7.86010347e-02  1.07246106e+00]
  HOMO = -0.243076944480868  LUMO = 0.932986595536972
  mo_energy =
[-1.20327304e+02 -1.23814001e+01 -6.67837560e+00 -6.67837560e+00
 -6.67837560e+00 -1.17954832e+00 -2.43076944e-01 -2.43076944e-01
 -2.43076944e-01  9.32986596e-01  6.01669772e+00  2.49582686e+01
  9.32190918e+01  3.09523200e+02  9.59103362e+02  3.23098746e+03
  1.27308374e+04  4.13299588e+04  1.05355083e+05  2.30525275e+05
  4.56330558e+05  8.45275477e+05  1.52844565e+06  2.85070433e+06
  5.80858045e+06]
E1 = -706.676747490027  E_coul = 198.685763443049
cycle= 6 E= -507.990984046978  delta_E= -4.32e-12  |g|= 9.35e-08  |ddm|= 1.33e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.676747490027  E_coul = 198.685763443049
  HOMO = -0.243076987285545  LUMO = 0.932986569983069
  mo_energy =
[-1.20327304e+02 -1.23814002e+01 -6.67837569e+00 -6.67837569e+00
 -6.67837569e+00 -1.17954834e+00 -2.43076987e-01 -2.43076987e-01
 -2.43076987e-01  9.32986570e-01  6.01669766e+00  2.49582685e+01
  9.32190917e+01  3.09523200e+02  9.59103362e+02  3.23098746e+03
  1.27308374e+04  4.13299588e+04  1.05355083e+05  2.30525275e+05
  4.56330558e+05  8.45275477e+05  1.52844565e+06  2.85070433e+06
  5.80858045e+06]
E1 = -706.676747298668  E_coul = 198.68576325168974
Extra cycle  E= -507.990984046978  delta_E= -3.41e-13  |g|= 1.19e-08  |ddm|= 2.18e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.35187715e-01 6.20619665e-01 1.99408027e+00 1.17616811e+05
 4.39346214e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104121e+04 3.67546733e+04 7.30054097e+03
 1.83757021e+04 1.45712730e+03 4.17454604e+02 1.53083989e+02
 6.50755993e+01 2.86643691e+01 9.63963014e+00 8.60426703e+00
 4.92750037e-01]
E = -507.99098404697827
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:15 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.235187714923       1
[INPUT] 0    0    [1    /1   ]  0.620619665442       1
[INPUT] 0    0    [1    /1   ]  1.99408026776        1
[INPUT] 0    0    [1    /1   ]  117616.810774        1
[INPUT] 0    0    [1    /1   ]  4.39346214214        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069896        1
[INPUT] 0    0    [1    /1   ]  294042.030593        1
[INPUT] 0    0    [1    /1   ]  147020.990027        1
[INPUT] 0    0    [1    /1   ]  73510.4121358        1
[INPUT] 0    0    [1    /1   ]  36754.6733017        1
[INPUT] 0    0    [1    /1   ]  7300.54097203        1
[INPUT] 0    0    [1    /1   ]  18375.7021481        1
[INPUT] 0    0    [1    /1   ]  1457.12729845        1
[INPUT] 0    0    [1    /1   ]  417.454603963        1
[INPUT] 0    0    [1    /1   ]  153.083988885        1
[INPUT] 0    0    [1    /1   ]  65.0755993492        1
[INPUT] 0    0    [1    /1   ]  28.6643691038        1
[INPUT] 0    0    [1    /1   ]  9.63963014359        1
[INPUT] 1    0    [1    /1   ]  8.60426703439        1
[INPUT] 1    0    [1    /1   ]  0.492750036569       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23518771492287993, 1.0]], [0, [0.6206196654422711, 1.0]], [0, [1.9940802677586544, 1.0]], [0, [117616.81077441965, 1.0]], [0, [4.393462142135622, 1.0]], [0, [1176168.142599349, 1.0]], [0, [588084.0698958039, 1.0]], [0, [294042.0305933673, 1.0]], [0, [147020.9900271367, 1.0]], [0, [73510.41213579997, 1.0]], [0, [36754.67330169596, 1.0]], [0, [7300.54097202618, 1.0]], [0, [18375.702148114375, 1.0]], [0, [1457.1272984502375, 1.0]], [0, [417.45460396333254, 1.0]], [0, [153.08398888504436, 1.0]], [0, [65.0755993491895, 1.0]], [0, [28.664369103841683, 1.0]], [0, [9.639630143588288, 1.0]], [1, [8.60426703438532, 1.0]], [1, [0.4927500365689384, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23518771]
bas 1, expnt(s) = [0.62061967]
bas 2, expnt(s) = [1.99408027]
bas 3, expnt(s) = [117616.81077442]
bas 4, expnt(s) = [4.39346214]
bas 5, expnt(s) = [1176168.14259935]
bas 6, expnt(s) = [588084.0698958]
bas 7, expnt(s) = [294042.03059337]
bas 8, expnt(s) = [147020.99002714]
bas 9, expnt(s) = [73510.4121358]
bas 10, expnt(s) = [36754.6733017]
bas 11, expnt(s) = [7300.54097203]
bas 12, expnt(s) = [18375.70214811]
bas 13, expnt(s) = [1457.12729845]
bas 14, expnt(s) = [417.45460396]
bas 15, expnt(s) = [153.08398889]
bas 16, expnt(s) = [65.07559935]
bas 17, expnt(s) = [28.6643691]
bas 18, expnt(s) = [9.63963014]
bas 19, expnt(s) = [8.60426703]
bas 20, expnt(s) = [0.49275004]
CPU time:      2003.18
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.35187715e-01 8.53249414e-01 6.20619665e-01 1.76658352e+00
 1.99408027e+00 4.23957186e+00 1.17616811e+05 1.60460106e+04
 4.39346214e+00 7.66690692e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104121e+04 1.12791577e+04
 3.67546733e+04 6.70655436e+03 7.30054097e+03 1.99540615e+03
 1.83757021e+04 3.98747507e+03 1.45712730e+03 5.95851648e+02
 4.17454604e+02 2.33330744e+02 1.53083989e+02 1.09954334e+02
 6.50755993e+01 5.78866820e+01 2.86643691e+01 3.12983768e+01
 9.63963014e+00 1.38216631e+01 8.60426703e+00 4.29909204e+01
 4.92750037e-01 1.20439162e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336056612921194
cond(S) = 913820.1233793665
E1 = -689.6026529386479  E_coul = 184.97153057217855
init E= -504.631122366469
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672166492474192  LUMO = 0.581431492272296
  mo_energy =
[-1.21709999e+02 -1.33863225e+01 -7.62359003e+00 -7.62359003e+00
 -7.62359003e+00 -1.65753955e+00 -6.72166492e-01 -6.72166492e-01
 -6.72166492e-01  5.81431492e-01  5.40045742e+00  2.40420648e+01
  9.20153907e+01  3.08179776e+02  9.57744599e+02  3.22970323e+03
  1.27296700e+04  4.13288625e+04  1.05354025e+05  2.30524243e+05
  4.56329544e+05  8.45274476e+05  1.52844466e+06  2.85070336e+06
  5.80857947e+06]
E1 = -707.7544838629918  E_coul = 199.78157126396232
cycle= 1 E= -507.97291259903  delta_E= -3.34  |g|= 0.452  |ddm|= 0.482
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.76145
diis-c [-0.579806  1.      ]
  HOMO = -0.217661187493977  LUMO = 0.937974516571132
  mo_energy =
[-1.20200369e+02 -1.23048293e+01 -6.59405777e+00 -6.59405777e+00
 -6.59405777e+00 -1.16332464e+00 -2.17661187e-01 -2.17661187e-01
 -2.17661187e-01  9.37974517e-01  6.05181765e+00  2.50259370e+01
  9.33157997e+01  3.09640581e+02  9.59236384e+02  3.23113532e+03
  1.27309960e+04  4.13301214e+04  1.05355247e+05  2.30525440e+05
  4.56330724e+05  8.45275643e+05  1.52844582e+06  2.85070450e+06
  5.80858061e+06]
E1 = -706.8003987071863  E_coul = 198.80967927870032
cycle= 2 E= -507.990719428486  delta_E= -0.0178  |g|= 0.0351  |ddm|=  0.4
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.033871
diis-c [-0.0011461  -0.00140892  1.00140892]
  HOMO = -0.239775680462756  LUMO = 0.933850672420068
  mo_energy =
[-1.20315120e+02 -1.23724652e+01 -6.66895324e+00 -6.66895324e+00
 -6.66895324e+00 -1.17754844e+00 -2.39775680e-01 -2.39775680e-01
 -2.39775680e-01  9.33850672e-01  6.02139295e+00  2.49662487e+01
  9.32293363e+01  3.09534785e+02  9.59115802e+02  3.23100061e+03
  1.27308511e+04  4.13299726e+04  1.05355096e+05  2.30525289e+05
  4.56330572e+05  8.45275491e+05  1.52844567e+06  2.85070435e+06
  5.80858046e+06]
E1 = -706.6926941925734  E_coul = 198.70171514551086
cycle= 3 E= -507.990979047063  delta_E= -0.00026  |g|= 0.00437  |ddm|= 0.0601
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00369531
diis-c [-3.02750316e-06  7.94662322e-05 -1.06780090e-01  1.10670062e+00]
  HOMO = -0.242927265549215  LUMO = 0.933034410922809
  mo_energy =
[-1.20326952e+02 -1.23810570e+01 -6.67803621e+00 -6.67803621e+00
 -6.67803621e+00 -1.17945775e+00 -2.42927266e-01 -2.42927266e-01
 -2.42927266e-01  9.33034411e-01  6.01691425e+00  2.49585797e+01
  9.32194336e+01  3.09523549e+02  9.59103715e+02  3.23098782e+03
  1.27308378e+04  4.13299591e+04  1.05355083e+05  2.30525275e+05
  4.56330559e+05  8.45275477e+05  1.52844565e+06  2.85070434e+06
  5.80858045e+06]
E1 = -706.6774633000897  E_coul = 198.6864792662873
cycle= 4 E= -507.990984033802  delta_E= -4.99e-06  |g|= 0.000227  |ddm|= 0.0102
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00016695
diis-c [-4.29512706e-10 -8.72349323e-06  6.97610814e-03 -9.85063153e-02
  1.09153893e+00]
  HOMO = -0.243074675370308  LUMO = 0.932987245954806
  mo_energy =
[-1.20327298e+02 -1.23813956e+01 -6.67837102e+00 -6.67837102e+00
 -6.67837102e+00 -1.17954675e+00 -2.43074675e-01 -2.43074675e-01
 -2.43074675e-01  9.32987246e-01  6.01670100e+00  2.49582728e+01
  9.32190966e+01  3.09523205e+02  9.59103368e+02  3.23098747e+03
  1.27308374e+04  4.13299588e+04  1.05355083e+05  2.30525275e+05
  4.56330558e+05  8.45275477e+05  1.52844565e+06  2.85070433e+06
  5.80858045e+06]
E1 = -706.6767588476487  E_coul = 198.68577480067506
cycle= 5 E= -507.990984046974  delta_E= -1.32e-08  |g|= 4.77e-06  |ddm|= 0.000623
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=2.1189e-06
diis-c [-7.19027035e-13  5.13869720e-07 -4.93559812e-04  6.63302197e-03
 -7.86010347e-02  1.07246106e+00]
  HOMO = -0.243076944480868  LUMO = 0.932986595536972
  mo_energy =
[-1.20327304e+02 -1.23814001e+01 -6.67837560e+00 -6.67837560e+00
 -6.67837560e+00 -1.17954832e+00 -2.43076944e-01 -2.43076944e-01
 -2.43076944e-01  9.32986596e-01  6.01669772e+00  2.49582686e+01
  9.32190918e+01  3.09523200e+02  9.59103362e+02  3.23098746e+03
  1.27308374e+04  4.13299588e+04  1.05355083e+05  2.30525275e+05
  4.56330558e+05  8.45275477e+05  1.52844565e+06  2.85070433e+06
  5.80858045e+06]
E1 = -706.676747490027  E_coul = 198.685763443049
cycle= 6 E= -507.990984046978  delta_E= -4.32e-12  |g|= 9.35e-08  |ddm|= 1.33e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.676747490027  E_coul = 198.685763443049
  HOMO = -0.243076987285545  LUMO = 0.932986569983069
  mo_energy =
[-1.20327304e+02 -1.23814002e+01 -6.67837569e+00 -6.67837569e+00
 -6.67837569e+00 -1.17954834e+00 -2.43076987e-01 -2.43076987e-01
 -2.43076987e-01  9.32986570e-01  6.01669766e+00  2.49582685e+01
  9.32190917e+01  3.09523200e+02  9.59103362e+02  3.23098746e+03
  1.27308374e+04  4.13299588e+04  1.05355083e+05  2.30525275e+05
  4.56330558e+05  8.45275477e+05  1.52844565e+06  2.85070433e+06
  5.80858045e+06]
E1 = -706.676747298668  E_coul = 198.68576325168974
Extra cycle  E= -507.990984046978  delta_E= -3.41e-13  |g|= 1.19e-08  |ddm|= 2.18e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 913820.1233793665
E1 = -706.676747298668  E_coul = 198.68576325168974
init E= -507.990984046978
    CPU time for initialize scf      7.45 sec, wall time      0.31 sec
  HOMO = -0.243076993456852  LUMO = 0.932986569674765
  mo_energy =
[-1.20327304e+02 -1.23814002e+01 -6.67837570e+00 -6.67837570e+00
 -6.67837570e+00 -1.17954834e+00 -2.43076993e-01 -2.43076993e-01
 -2.43076993e-01  9.32986570e-01  6.01669765e+00  2.49582685e+01
  9.32190917e+01  3.09523200e+02  9.59103362e+02  3.23098746e+03
  1.27308374e+04  4.13299588e+04  1.05355083e+05  2.30525275e+05
  4.56330558e+05  8.45275477e+05  1.52844565e+06  2.85070433e+06
  5.80858045e+06]
E1 = -706.6767472671798  E_coul = 198.68576322020138
cycle= 1 E= -507.990984046978  delta_E= -2.27e-13  |g|= 1.77e-09  |ddm|= 2.96e-08
    CPU time for cycle= 1      0.16 sec, wall time      0.03 sec
E1 = -706.6767472671798  E_coul = 198.68576322020138
  HOMO = -0.243076994428901  LUMO = 0.932986569548937
  mo_energy =
[-1.20327304e+02 -1.23814002e+01 -6.67837571e+00 -6.67837571e+00
 -6.67837571e+00 -1.17954834e+00 -2.43076994e-01 -2.43076994e-01
 -2.43076994e-01  9.32986570e-01  6.01669764e+00  2.49582685e+01
  9.32190917e+01  3.09523200e+02  9.59103362e+02  3.23098746e+03
  1.27308374e+04  4.13299588e+04  1.05355083e+05  2.30525275e+05
  4.56330558e+05  8.45275477e+05  1.52844565e+06  2.85070433e+06
  5.80858045e+06]
E1 = -706.6767472621027  E_coul = 198.68576321512396
Extra cycle  E= -507.990984046979  delta_E= -2.27e-13  |g|= 1.79e-09  |ddm|= 4.93e-09
    CPU time for scf_cycle      7.76 sec, wall time      0.49 sec
exp = [2.35187715e-01 6.20619665e-01 1.99408027e+00 1.17616811e+05
 4.39346214e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104121e+04 3.67546733e+04 7.30054097e+03
 1.83757021e+04 1.45712730e+03 4.17454604e+02 1.53083989e+02
 6.50755993e+01 2.86643691e+01 9.63963014e+00 8.60426703e+00
 4.92750037e-01]
grad_E = [-9.79083523e-04  6.76170737e-04  6.09929071e-05  5.25430319e-09
 -2.45629461e-04  3.12695829e-11  1.47696989e-10  8.16158104e-10
  3.21485695e-09  1.33991192e-08  7.07084258e-08  4.49076287e-06
  1.65165011e-07 -2.36997179e-05 -5.71304565e-05  2.34560578e-05
  2.06475006e-05  2.18964597e-05  7.76135452e-05  2.03317406e-06
  1.42310212e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:23 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.237584175552       1
[INPUT] 0    0    [1    /1   ]  0.628310592538       1
[INPUT] 0    0    [1    /1   ]  2.16843395723        1
[INPUT] 0    0    [1    /1   ]  117616.810591        1
[INPUT] 0    0    [1    /1   ]  4.68813785422        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069891        1
[INPUT] 0    0    [1    /1   ]  294042.030565        1
[INPUT] 0    0    [1    /1   ]  147020.989914        1
[INPUT] 0    0    [1    /1   ]  73510.4116653        1
[INPUT] 0    0    [1    /1   ]  36754.6708474        1
[INPUT] 0    0    [1    /1   ]  7300.38622736        1
[INPUT] 0    0    [1    /1   ]  18375.6961315        1
[INPUT] 0    0    [1    /1   ]  1458.30395647        1
[INPUT] 0    0    [1    /1   ]  417.535091148        1
[INPUT] 0    0    [1    /1   ]  153.283567642        1
[INPUT] 0    0    [1    /1   ]  65.8292805104        1
[INPUT] 0    0    [1    /1   ]  29.2665070276        1
[INPUT] 0    0    [1    /1   ]  10.0738817671        1
[INPUT] 1    0    [1    /1   ]  8.60428107378        1
[INPUT] 1    0    [1    /1   ]  0.492750714681       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23758417555235803, 1.0]], [0, [0.6283105925376702, 1.0]], [0, [2.16843395722662, 1.0]], [0, [117616.81059055211, 1.0]], [0, [4.688137854219008, 1.0]], [0, [1176168.1425981221, 1.0]], [0, [588084.0698905217, 1.0]], [0, [294042.03056484804, 1.0]], [0, [147020.98991445676, 1.0]], [0, [73510.41166526683, 1.0]], [0, [36754.670847358844, 1.0]], [0, [7300.386227358843, 1.0]], [0, [18375.69613152849, 1.0]], [0, [1458.3039564688163, 1.0]], [0, [417.5350911478605, 1.0]], [0, [153.28356764239857, 1.0]], [0, [65.82928051038667, 1.0]], [0, [29.2665070275981, 1.0]], [0, [10.073881767053376, 1.0]], [1, [8.604281073775514, 1.0]], [1, [0.4927507146805191, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23758418]
bas 1, expnt(s) = [0.62831059]
bas 2, expnt(s) = [2.16843396]
bas 3, expnt(s) = [117616.81059055]
bas 4, expnt(s) = [4.68813785]
bas 5, expnt(s) = [1176168.14259812]
bas 6, expnt(s) = [588084.06989052]
bas 7, expnt(s) = [294042.03056485]
bas 8, expnt(s) = [147020.98991446]
bas 9, expnt(s) = [73510.41166527]
bas 10, expnt(s) = [36754.67084736]
bas 11, expnt(s) = [7300.38622736]
bas 12, expnt(s) = [18375.69613153]
bas 13, expnt(s) = [1458.30395647]
bas 14, expnt(s) = [417.53509115]
bas 15, expnt(s) = [153.28356764]
bas 16, expnt(s) = [65.82928051]
bas 17, expnt(s) = [29.26650703]
bas 18, expnt(s) = [10.07388177]
bas 19, expnt(s) = [8.60428107]
bas 20, expnt(s) = [0.49275071]
CPU time:      2019.70
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.37584176e-01 8.59761824e-01 6.28310593e-01 1.78297728e+00
 2.16843396e+00 4.51465610e+00 1.17616811e+05 1.60460105e+04
 4.68813785e+00 8.04943327e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104117e+04 1.12791576e+04
 3.67546708e+04 6.70655403e+03 7.30038623e+03 1.99537443e+03
 1.83756961e+04 3.98747410e+03 1.45830396e+03 5.96212483e+02
 4.17535091e+02 2.33364483e+02 1.53283568e+02 1.10061829e+02
 6.58292805e+01 5.83887739e+01 2.92665070e+01 3.17901951e+01
 1.00738818e+01 1.42860663e+01 8.60428107e+00 4.29910081e+01
 4.92750715e-01 1.20439369e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336042716825986
cond(S) = 914031.9476106621
E1 = -689.6025626943402  E_coul = 184.97134655755474
init E= -504.631216136785
    CPU time for initialize scf      0.71 sec, wall time      0.07 sec
  HOMO = -0.672169420161435  LUMO = 0.601814737635931
  mo_energy =
[-1.21710022e+02 -1.33863599e+01 -7.62360882e+00 -7.62360882e+00
 -7.62360882e+00 -1.65751134e+00 -6.72169420e-01 -6.72169420e-01
 -6.72169420e-01  6.01814738e-01  5.84846185e+00  2.59977436e+01
  9.64928655e+01  3.15343007e+02  9.66673859e+02  3.23995012e+03
  1.27413313e+04  4.13405339e+04  1.05365344e+05  2.30535249e+05
  4.56340315e+05  8.45285068e+05  1.52845508e+06  2.85071356e+06
  5.80858941e+06]
E1 = -707.7536367663049  E_coul = 199.7806902872648
cycle= 1 E= -507.97294647904  delta_E= -3.34  |g|= 0.452  |ddm|= 0.482
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.762574
diis-c [-0.58151862  1.        ]
  HOMO = -0.21767998124891  LUMO = 0.964095287168665
  mo_energy =
[-1.20200458e+02 -1.23049145e+01 -6.59413142e+00 -6.59413142e+00
 -6.59413142e+00 -1.16332208e+00 -2.17679981e-01 -2.17679981e-01
 -2.17679981e-01  9.64095287e-01  6.52216567e+00  2.69996615e+01
  9.77982744e+01  3.16804145e+02  9.68165416e+02  3.24138207e+03
  1.27426572e+04  4.13417928e+04  1.05366565e+05  2.30536447e+05
  4.56341495e+05  8.45286235e+05  1.52845624e+06  2.85071471e+06
  5.80859055e+06]
E1 = -706.800443417769  E_coul = 198.80970748847446
cycle= 2 E= -507.990735929294  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.405
    CPU time for cycle= 2      0.04 sec, wall time      0.03 sec
diis-norm(errvec)=0.0333141
diis-c [-1.10929842e-03 -9.56606434e-04  1.00095661e+00]
  HOMO = -0.239766642379637  LUMO = 0.959692752029307
  mo_energy =
[-1.20315060e+02 -1.23724505e+01 -6.66891850e+00 -6.66891850e+00
 -6.66891850e+00 -1.17752726e+00 -2.39766642e-01 -2.39766642e-01
 -2.39766642e-01  9.59692752e-01  6.48993153e+00  2.69385445e+01
  9.77113839e+01  3.16698390e+02  9.68045000e+02  3.24124755e+03
  1.27425125e+04  4.13416442e+04  1.05366415e+05  2.30536296e+05
  4.56341344e+05  8.45286083e+05  1.52845609e+06  2.85071456e+06
  5.80859040e+06]
E1 = -706.6929723600311  E_coul = 198.70197762898184
cycle= 3 E= -507.990994731049  delta_E= -0.000259  |g|= 0.00437  |ddm|= 0.0597
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00359773
diis-c [-2.92044059e-06  8.67921641e-05 -1.05280297e-01  1.10519351e+00]
  HOMO = -0.242913561119102  LUMO = 0.95883510939765
  mo_energy =
[-1.20326907e+02 -1.23810427e+01 -6.67800428e+00 -6.67800428e+00
 -6.67800428e+00 -1.17943340e+00 -2.42913561e-01 -2.42913561e-01
 -2.42913561e-01  9.58835109e-01  6.48522371e+00  2.69307289e+01
  9.77014325e+01  3.16687136e+02  9.68032898e+02  3.24123473e+03
  1.27424992e+04  4.13416307e+04  1.05366402e+05  2.30536282e+05
  4.56341330e+05  8.45286070e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6777878501202  E_coul = 198.68678817143552
cycle= 4 E= -507.990999678685  delta_E= -4.95e-06  |g|= 0.000229  |ddm|= 0.00992
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165952
diis-c [-3.67379293e-10 -8.45542268e-06  6.98167076e-03 -1.00022127e-01
  1.09304891e+00]
  HOMO = -0.243064298544637  LUMO = 0.958785373409561
  mo_energy =
[-1.20327272e+02 -1.23813938e+01 -6.67835258e+00 -6.67835258e+00
 -6.67835258e+00 -1.17952426e+00 -2.43064299e-01 -2.43064299e-01
 -2.43064299e-01  9.58785373e-01  6.48499616e+00  2.69304076e+01
  9.77010798e+01  3.16686774e+02  9.68032531e+02  3.24123436e+03
  1.27424988e+04  4.13416303e+04  1.05366401e+05  2.30536282e+05
  4.56341330e+05  8.45286069e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6770689920033  E_coul = 198.68606930011012
cycle= 5 E= -507.990999691893  delta_E= -1.32e-08  |g|= 4.08e-06  |ddm|= 0.0006
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.84215e-06
diis-c [-5.98531798e-13  4.72919191e-07 -4.41881086e-04  6.01824913e-03
 -7.02580810e-02  1.06468124e+00]
  HOMO = -0.243066301472378  LUMO = 0.958784801592356
  mo_energy =
[-1.20327277e+02 -1.23813979e+01 -6.67835673e+00 -6.67835673e+00
 -6.67835673e+00 -1.17952566e+00 -2.43066301e-01 -2.43066301e-01
 -2.43066301e-01  9.58784802e-01  6.48499316e+00  2.69304038e+01
  9.77010755e+01  3.16686769e+02  9.68032526e+02  3.24123436e+03
  1.27424988e+04  4.13416303e+04  1.05366401e+05  2.30536282e+05
  4.56341330e+05  8.45286069e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6770589918552  E_coul = 198.68605929995877
cycle= 6 E= -507.990999691896  delta_E= -3.3e-12  |g|= 9.12e-08  |ddm|= 1.08e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6770589918552  E_coul = 198.68605929995877
  HOMO = -0.243066343419813  LUMO = 0.958784776530786
  mo_energy =
[-1.20327277e+02 -1.23813980e+01 -6.67835681e+00 -6.67835681e+00
 -6.67835681e+00 -1.17952568e+00 -2.43066343e-01 -2.43066343e-01
 -2.43066343e-01  9.58784777e-01  6.48499309e+00  2.69304037e+01
  9.77010754e+01  3.16686769e+02  9.68032526e+02  3.24123436e+03
  1.27424988e+04  4.13416303e+04  1.05366401e+05  2.30536282e+05
  4.56341330e+05  8.45286069e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6770588050831  E_coul = 198.6860591131863
Extra cycle  E= -507.990999691897  delta_E= -3.41e-13  |g|= 1.22e-08  |ddm|= 2.03e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.37584176e-01 6.28310593e-01 2.16843396e+00 1.17616811e+05
 4.68813785e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104117e+04 3.67546708e+04 7.30038623e+03
 1.83756961e+04 1.45830396e+03 4.17535091e+02 1.53283568e+02
 6.58292805e+01 2.92665070e+01 1.00738818e+01 8.60428107e+00
 4.92750715e-01]
E = -507.99099969189683
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:24 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.237584175552       1
[INPUT] 0    0    [1    /1   ]  0.628310592538       1
[INPUT] 0    0    [1    /1   ]  2.16843395723        1
[INPUT] 0    0    [1    /1   ]  117616.810591        1
[INPUT] 0    0    [1    /1   ]  4.68813785422        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069891        1
[INPUT] 0    0    [1    /1   ]  294042.030565        1
[INPUT] 0    0    [1    /1   ]  147020.989914        1
[INPUT] 0    0    [1    /1   ]  73510.4116653        1
[INPUT] 0    0    [1    /1   ]  36754.6708474        1
[INPUT] 0    0    [1    /1   ]  7300.38622736        1
[INPUT] 0    0    [1    /1   ]  18375.6961315        1
[INPUT] 0    0    [1    /1   ]  1458.30395647        1
[INPUT] 0    0    [1    /1   ]  417.535091148        1
[INPUT] 0    0    [1    /1   ]  153.283567642        1
[INPUT] 0    0    [1    /1   ]  65.8292805104        1
[INPUT] 0    0    [1    /1   ]  29.2665070276        1
[INPUT] 0    0    [1    /1   ]  10.0738817671        1
[INPUT] 1    0    [1    /1   ]  8.60428107378        1
[INPUT] 1    0    [1    /1   ]  0.492750714681       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23758417555235803, 1.0]], [0, [0.6283105925376702, 1.0]], [0, [2.16843395722662, 1.0]], [0, [117616.81059055211, 1.0]], [0, [4.688137854219008, 1.0]], [0, [1176168.1425981221, 1.0]], [0, [588084.0698905217, 1.0]], [0, [294042.03056484804, 1.0]], [0, [147020.98991445676, 1.0]], [0, [73510.41166526683, 1.0]], [0, [36754.670847358844, 1.0]], [0, [7300.386227358843, 1.0]], [0, [18375.69613152849, 1.0]], [0, [1458.3039564688163, 1.0]], [0, [417.5350911478605, 1.0]], [0, [153.28356764239857, 1.0]], [0, [65.82928051038667, 1.0]], [0, [29.2665070275981, 1.0]], [0, [10.073881767053376, 1.0]], [1, [8.604281073775514, 1.0]], [1, [0.4927507146805191, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23758418]
bas 1, expnt(s) = [0.62831059]
bas 2, expnt(s) = [2.16843396]
bas 3, expnt(s) = [117616.81059055]
bas 4, expnt(s) = [4.68813785]
bas 5, expnt(s) = [1176168.14259812]
bas 6, expnt(s) = [588084.06989052]
bas 7, expnt(s) = [294042.03056485]
bas 8, expnt(s) = [147020.98991446]
bas 9, expnt(s) = [73510.41166527]
bas 10, expnt(s) = [36754.67084736]
bas 11, expnt(s) = [7300.38622736]
bas 12, expnt(s) = [18375.69613153]
bas 13, expnt(s) = [1458.30395647]
bas 14, expnt(s) = [417.53509115]
bas 15, expnt(s) = [153.28356764]
bas 16, expnt(s) = [65.82928051]
bas 17, expnt(s) = [29.26650703]
bas 18, expnt(s) = [10.07388177]
bas 19, expnt(s) = [8.60428107]
bas 20, expnt(s) = [0.49275071]
CPU time:      2021.84
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.37584176e-01 8.59761824e-01 6.28310593e-01 1.78297728e+00
 2.16843396e+00 4.51465610e+00 1.17616811e+05 1.60460105e+04
 4.68813785e+00 8.04943327e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104117e+04 1.12791576e+04
 3.67546708e+04 6.70655403e+03 7.30038623e+03 1.99537443e+03
 1.83756961e+04 3.98747410e+03 1.45830396e+03 5.96212483e+02
 4.17535091e+02 2.33364483e+02 1.53283568e+02 1.10061829e+02
 6.58292805e+01 5.83887739e+01 2.92665070e+01 3.17901951e+01
 1.00738818e+01 1.42860663e+01 8.60428107e+00 4.29910081e+01
 4.92750715e-01 1.20439369e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336042716825986
cond(S) = 914031.9476106621
E1 = -689.6025626943402  E_coul = 184.97134655755474
init E= -504.631216136785
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672169420161435  LUMO = 0.601814737635931
  mo_energy =
[-1.21710022e+02 -1.33863599e+01 -7.62360882e+00 -7.62360882e+00
 -7.62360882e+00 -1.65751134e+00 -6.72169420e-01 -6.72169420e-01
 -6.72169420e-01  6.01814738e-01  5.84846185e+00  2.59977436e+01
  9.64928655e+01  3.15343007e+02  9.66673859e+02  3.23995012e+03
  1.27413313e+04  4.13405339e+04  1.05365344e+05  2.30535249e+05
  4.56340315e+05  8.45285068e+05  1.52845508e+06  2.85071356e+06
  5.80858941e+06]
E1 = -707.7536367663049  E_coul = 199.7806902872648
cycle= 1 E= -507.97294647904  delta_E= -3.34  |g|= 0.452  |ddm|= 0.482
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.762574
diis-c [-0.58151862  1.        ]
  HOMO = -0.21767998124891  LUMO = 0.964095287168665
  mo_energy =
[-1.20200458e+02 -1.23049145e+01 -6.59413142e+00 -6.59413142e+00
 -6.59413142e+00 -1.16332208e+00 -2.17679981e-01 -2.17679981e-01
 -2.17679981e-01  9.64095287e-01  6.52216567e+00  2.69996615e+01
  9.77982744e+01  3.16804145e+02  9.68165416e+02  3.24138207e+03
  1.27426572e+04  4.13417928e+04  1.05366565e+05  2.30536447e+05
  4.56341495e+05  8.45286235e+05  1.52845624e+06  2.85071471e+06
  5.80859055e+06]
E1 = -706.800443417769  E_coul = 198.80970748847446
cycle= 2 E= -507.990735929294  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.405
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0333141
diis-c [-1.10929842e-03 -9.56606434e-04  1.00095661e+00]
  HOMO = -0.239766642379637  LUMO = 0.959692752029307
  mo_energy =
[-1.20315060e+02 -1.23724505e+01 -6.66891850e+00 -6.66891850e+00
 -6.66891850e+00 -1.17752726e+00 -2.39766642e-01 -2.39766642e-01
 -2.39766642e-01  9.59692752e-01  6.48993153e+00  2.69385445e+01
  9.77113839e+01  3.16698390e+02  9.68045000e+02  3.24124755e+03
  1.27425125e+04  4.13416442e+04  1.05366415e+05  2.30536296e+05
  4.56341344e+05  8.45286083e+05  1.52845609e+06  2.85071456e+06
  5.80859040e+06]
E1 = -706.6929723600311  E_coul = 198.70197762898184
cycle= 3 E= -507.990994731049  delta_E= -0.000259  |g|= 0.00437  |ddm|= 0.0597
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00359773
diis-c [-2.92044059e-06  8.67921641e-05 -1.05280297e-01  1.10519351e+00]
  HOMO = -0.242913561119102  LUMO = 0.95883510939765
  mo_energy =
[-1.20326907e+02 -1.23810427e+01 -6.67800428e+00 -6.67800428e+00
 -6.67800428e+00 -1.17943340e+00 -2.42913561e-01 -2.42913561e-01
 -2.42913561e-01  9.58835109e-01  6.48522371e+00  2.69307289e+01
  9.77014325e+01  3.16687136e+02  9.68032898e+02  3.24123473e+03
  1.27424992e+04  4.13416307e+04  1.05366402e+05  2.30536282e+05
  4.56341330e+05  8.45286070e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6777878501202  E_coul = 198.68678817143552
cycle= 4 E= -507.990999678685  delta_E= -4.95e-06  |g|= 0.000229  |ddm|= 0.00992
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165952
diis-c [-3.67379293e-10 -8.45542268e-06  6.98167076e-03 -1.00022127e-01
  1.09304891e+00]
  HOMO = -0.243064298544637  LUMO = 0.958785373409561
  mo_energy =
[-1.20327272e+02 -1.23813938e+01 -6.67835258e+00 -6.67835258e+00
 -6.67835258e+00 -1.17952426e+00 -2.43064299e-01 -2.43064299e-01
 -2.43064299e-01  9.58785373e-01  6.48499616e+00  2.69304076e+01
  9.77010798e+01  3.16686774e+02  9.68032531e+02  3.24123436e+03
  1.27424988e+04  4.13416303e+04  1.05366401e+05  2.30536282e+05
  4.56341330e+05  8.45286069e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6770689920033  E_coul = 198.68606930011012
cycle= 5 E= -507.990999691893  delta_E= -1.32e-08  |g|= 4.08e-06  |ddm|= 0.0006
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.84215e-06
diis-c [-5.98531798e-13  4.72919191e-07 -4.41881086e-04  6.01824913e-03
 -7.02580810e-02  1.06468124e+00]
  HOMO = -0.243066301472378  LUMO = 0.958784801592356
  mo_energy =
[-1.20327277e+02 -1.23813979e+01 -6.67835673e+00 -6.67835673e+00
 -6.67835673e+00 -1.17952566e+00 -2.43066301e-01 -2.43066301e-01
 -2.43066301e-01  9.58784802e-01  6.48499316e+00  2.69304038e+01
  9.77010755e+01  3.16686769e+02  9.68032526e+02  3.24123436e+03
  1.27424988e+04  4.13416303e+04  1.05366401e+05  2.30536282e+05
  4.56341330e+05  8.45286069e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6770589918552  E_coul = 198.68605929995877
cycle= 6 E= -507.990999691896  delta_E= -3.3e-12  |g|= 9.12e-08  |ddm|= 1.08e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6770589918552  E_coul = 198.68605929995877
  HOMO = -0.243066343419813  LUMO = 0.958784776530786
  mo_energy =
[-1.20327277e+02 -1.23813980e+01 -6.67835681e+00 -6.67835681e+00
 -6.67835681e+00 -1.17952568e+00 -2.43066343e-01 -2.43066343e-01
 -2.43066343e-01  9.58784777e-01  6.48499309e+00  2.69304037e+01
  9.77010754e+01  3.16686769e+02  9.68032526e+02  3.24123436e+03
  1.27424988e+04  4.13416303e+04  1.05366401e+05  2.30536282e+05
  4.56341330e+05  8.45286069e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6770588050831  E_coul = 198.6860591131863
Extra cycle  E= -507.990999691897  delta_E= -3.41e-13  |g|= 1.22e-08  |ddm|= 2.03e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 914031.9476106621
E1 = -706.6770588050831  E_coul = 198.6860591131863
init E= -507.990999691897
    CPU time for initialize scf      5.88 sec, wall time      0.25 sec
  HOMO = -0.243066349409319  LUMO = 0.958784776523903
  mo_energy =
[-1.20327277e+02 -1.23813980e+01 -6.67835683e+00 -6.67835683e+00
 -6.67835683e+00 -1.17952568e+00 -2.43066349e-01 -2.43066349e-01
 -2.43066349e-01  9.58784777e-01  6.48499308e+00  2.69304037e+01
  9.77010754e+01  3.16686769e+02  9.68032526e+02  3.24123436e+03
  1.27424988e+04  4.13416303e+04  1.05366401e+05  2.30536282e+05
  4.56341330e+05  8.45286069e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.677058772617  E_coul = 198.68605908072016
cycle= 1 E= -507.990999691897  delta_E=    0  |g|= 2.06e-09  |ddm|= 2.86e-08
    CPU time for cycle= 1      0.15 sec, wall time      0.03 sec
E1 = -706.677058772617  E_coul = 198.68605908072016
  HOMO = -0.243066350394454  LUMO = 0.958784776547102
  mo_energy =
[-1.20327277e+02 -1.23813980e+01 -6.67835683e+00 -6.67835683e+00
 -6.67835683e+00 -1.17952568e+00 -2.43066350e-01 -2.43066350e-01
 -2.43066350e-01  9.58784777e-01  6.48499308e+00  2.69304037e+01
  9.77010754e+01  3.16686769e+02  9.68032526e+02  3.24123436e+03
  1.27424988e+04  4.13416303e+04  1.05366401e+05  2.30536282e+05
  4.56341330e+05  8.45286069e+05  1.52845607e+06  2.85071454e+06
  5.80859038e+06]
E1 = -706.6770587655432  E_coul = 198.68605907364667
Extra cycle  E= -507.990999691896  delta_E= 3.41e-13  |g|= 1.56e-09  |ddm|= 5.99e-09
    CPU time for scf_cycle      6.17 sec, wall time      0.42 sec
exp = [2.37584176e-01 6.28310593e-01 2.16843396e+00 1.17616811e+05
 4.68813785e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104117e+04 3.67546708e+04 7.30038623e+03
 1.83756961e+04 1.45830396e+03 4.17535091e+02 1.53283568e+02
 6.58292805e+01 2.92665070e+01 1.00738818e+01 8.60428107e+00
 4.92750715e-01]
grad_E = [-1.56164840e-03  9.23607729e-04  2.01626162e-04  5.22514456e-09
 -2.57846224e-04  3.09348609e-11  1.46743514e-10  8.11669120e-10
  3.19680597e-09  1.33228894e-08  7.03404960e-08  4.47106753e-06
  1.63971277e-07 -2.37451698e-05 -5.29267578e-05  7.47000549e-06
  4.00848427e-05  9.18696909e-06  6.46713876e-05  2.22680627e-05
  2.50702185e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:31 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.23758065477        1
[INPUT] 0    0    [1    /1   ]  0.627717199119       1
[INPUT] 0    0    [1    /1   ]  2.22824438646        1
[INPUT] 0    0    [1    /1   ]  117616.810495        1
[INPUT] 0    0    [1    /1   ]  4.82736301502        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069888        1
[INPUT] 0    0    [1    /1   ]  294042.03055         1
[INPUT] 0    0    [1    /1   ]  147020.989856        1
[INPUT] 0    0    [1    /1   ]  73510.4114196        1
[INPUT] 0    0    [1    /1   ]  36754.6695661        1
[INPUT] 0    0    [1    /1   ]  7300.30544363        1
[INPUT] 0    0    [1    /1   ]  18375.6929909        1
[INPUT] 0    0    [1    /1   ]  1458.91885745        1
[INPUT] 0    0    [1    /1   ]  417.568453291        1
[INPUT] 0    0    [1    /1   ]  153.420072336        1
[INPUT] 0    0    [1    /1   ]  66.1921936261        1
[INPUT] 0    0    [1    /1   ]  29.565090395         1
[INPUT] 0    0    [1    /1   ]  10.2837236099        1
[INPUT] 1    0    [1    /1   ]  8.60427829928        1
[INPUT] 1    0    [1    /1   ]  0.492750058361       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2375806547702828, 1.0]], [0, [0.6277171991193586, 1.0]], [0, [2.2282443864553483, 1.0]], [0, [117616.81049457069, 1.0]], [0, [4.827363015017947, 1.0]], [0, [1176168.1425974818, 1.0]], [0, [588084.0698877644, 1.0]], [0, [294042.0305499606, 1.0]], [0, [147020.98985563635, 1.0]], [0, [73510.41141964274, 1.0]], [0, [36754.669566149, 1.0]], [0, [7300.305443633064, 1.0]], [0, [18375.69299090843, 1.0]], [0, [1458.9188574545237, 1.0]], [0, [417.56845329060894, 1.0]], [0, [153.42007233576743, 1.0]], [0, [66.19219362613703, 1.0]], [0, [29.565090395010074, 1.0]], [0, [10.283723609877004, 1.0]], [1, [8.60427829928336, 1.0]], [1, [0.49275005836089175, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23758065]
bas 1, expnt(s) = [0.6277172]
bas 2, expnt(s) = [2.22824439]
bas 3, expnt(s) = [117616.81049457]
bas 4, expnt(s) = [4.82736302]
bas 5, expnt(s) = [1176168.14259748]
bas 6, expnt(s) = [588084.06988776]
bas 7, expnt(s) = [294042.03054996]
bas 8, expnt(s) = [147020.98985564]
bas 9, expnt(s) = [73510.41141964]
bas 10, expnt(s) = [36754.66956615]
bas 11, expnt(s) = [7300.30544363]
bas 12, expnt(s) = [18375.69299091]
bas 13, expnt(s) = [1458.91885745]
bas 14, expnt(s) = [417.56845329]
bas 15, expnt(s) = [153.42007234]
bas 16, expnt(s) = [66.19219363]
bas 17, expnt(s) = [29.5650904]
bas 18, expnt(s) = [10.28372361]
bas 19, expnt(s) = [8.6042783]
bas 20, expnt(s) = [0.49275006]
CPU time:      2036.67
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.37580655e-01 8.59752269e-01 6.27717199e-01 1.78171422e+00
 2.22824439e+00 4.60773124e+00 1.17616810e+05 1.60460105e+04
 4.82736302e+00 8.22806082e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104114e+04 1.12791576e+04
 3.67546696e+04 6.70655385e+03 7.30030544e+03 1.99535787e+03
 1.83756930e+04 3.98747358e+03 1.45891886e+03 5.96401020e+02
 4.17568453e+02 2.33378468e+02 1.53420072e+02 1.10135331e+02
 6.61921936e+01 5.86300284e+01 2.95650904e+01 3.20331342e+01
 1.02837236e+01 1.45086773e+01 8.60427830e+00 4.29909907e+01
 4.92750058e-01 1.20439168e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336041836574342
cond(S) = 914131.9767153807
E1 = -689.6021325377976  E_coul = 184.97100938455628
init E= -504.631123153241
    CPU time for initialize scf      1.12 sec, wall time      0.09 sec
  HOMO = -0.672181037789221  LUMO = 0.603856315774222
  mo_energy =
[-1.21710057e+02 -1.33863939e+01 -7.62363429e+00 -7.62363429e+00
 -7.62363429e+00 -1.65750006e+00 -6.72181038e-01 -6.72181038e-01
 -6.72181038e-01  6.03856316e-01  6.00843389e+00  2.68234113e+01
  9.85183088e+01  3.18707842e+02  9.70980059e+02  3.24498903e+03
  1.27471457e+04  4.13463742e+04  1.05371010e+05  2.30540760e+05
  4.56345708e+05  8.45290371e+05  1.52846030e+06  2.85071867e+06
  5.80859439e+06]
E1 = -707.7528406986356  E_coul = 199.77987321733121
cycle= 1 E= -507.972967481304  delta_E= -3.34  |g|= 0.452  |ddm|= 0.484
    CPU time for cycle= 1      0.58 sec, wall time      0.03 sec
diis-norm(errvec)=0.762998
diis-c [-0.58216636  1.        ]
  HOMO = -0.217689744333727  LUMO = 0.967270618110242
  mo_energy =
[-1.20200559e+02 -1.23049890e+01 -6.59420180e+00 -6.59420180e+00
 -6.59420180e+00 -1.16331892e+00 -2.17689744e-01 -2.17689744e-01
 -2.17689744e-01  9.67270618e-01  6.69074104e+00  2.78332493e+01
  9.98261663e+01  3.20169174e+02  9.72471490e+02  3.24642089e+03
  1.27484716e+04  4.13476330e+04  1.05372232e+05  2.30541957e+05
  4.56346888e+05  8.45291538e+05  1.52846145e+06  2.85071982e+06
  5.80859552e+06]
E1 = -706.8002487811635  E_coul = 198.8095061885081
cycle= 2 E= -507.990742592655  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.407
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.033175
diis-c [-1.10021229e-03 -7.95920308e-04  1.00079592e+00]
  HOMO = -0.239760741254053  LUMO = 0.962804211383103
  mo_energy =
[-1.20315077e+02 -1.23724664e+01 -6.66892643e+00 -6.66892643e+00
 -6.66892643e+00 -1.17751433e+00 -2.39760741e-01 -2.39760741e-01
 -2.39760741e-01  9.62804211e-01  6.65785944e+00  2.77715391e+01
  9.97390854e+01  3.20063445e+02  9.72351164e+02  3.24628646e+03
  1.27483269e+04  4.13474845e+04  1.05372082e+05  2.30541807e+05
  4.56346737e+05  8.45291386e+05  1.52846130e+06  2.85071967e+06
  5.80859537e+06]
E1 = -706.6927790847951  E_coul = 198.7017775115675
cycle= 3 E= -507.991001573228  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0597
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00357571
diis-c [-2.89152825e-06  8.39155893e-05 -1.05002842e-01  1.10491893e+00]
  HOMO = -0.242910713200386  LUMO = 0.961935735739532
  mo_energy =
[-1.20326939e+02 -1.23810675e+01 -6.67802199e+00 -6.67802199e+00
 -6.67802199e+00 -1.17942248e+00 -2.42910713e-01 -2.42910713e-01
 -2.42910713e-01  9.61935736e-01  6.65306176e+00  2.77636533e+01
  9.97291025e+01  3.20052173e+02  9.72339045e+02  3.24627362e+03
  1.27483136e+04  4.13474710e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291373e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6775708508997  E_coul = 198.68656431569985
cycle= 4 E= -507.9910065352  delta_E= -4.96e-06  |g|= 0.00023  |ddm|= 0.00988
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165999
diis-c [-3.55016374e-10 -8.38991991e-06  7.00600203e-03 -1.00631992e-01
  1.09363438e+00]
  HOMO = -0.243062854662664  LUMO = 0.96188520544101
  mo_energy =
[-1.20327310e+02 -1.23814229e+01 -6.67837496e+00 -6.67837496e+00
 -6.67837496e+00 -1.17951414e+00 -2.43062855e-01 -2.43062855e-01
 -2.43062855e-01  9.61885205e-01  6.65282857e+00  2.77633266e+01
  9.97287445e+01  3.20051806e+02  9.72338672e+02  3.24627325e+03
  1.27483132e+04  4.13474706e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291372e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6768447448304  E_coul = 198.68583819629225
cycle= 5 E= -507.991006548538  delta_E= -1.33e-08  |g|= 3.9e-06  |ddm|= 0.000596
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.77714e-06
diis-c [-5.66488878e-13  4.59189289e-07 -4.27718410e-04  5.83650360e-03
 -6.77828681e-02  1.06237362e+00]
  HOMO = -0.243064791867216  LUMO = 0.961884657390239
  mo_energy =
[-1.20327315e+02 -1.23814269e+01 -6.67837901e+00 -6.67837901e+00
 -6.67837901e+00 -1.17951549e+00 -2.43064792e-01 -2.43064792e-01
 -2.43064792e-01  9.61884657e-01  6.65282563e+00  2.77633228e+01
  9.97287402e+01  3.20051801e+02  9.72338667e+02  3.24627324e+03
  1.27483132e+04  4.13474706e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291372e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6768350538703  E_coul = 198.68582850532937
cycle= 6 E= -507.991006548541  delta_E= -2.73e-12  |g|= 8.9e-08  |ddm|= 1.02e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6768350538703  E_coul = 198.68582850532937
  HOMO = -0.243064833318724  LUMO = 0.961884633766654
  mo_energy =
[-1.20327315e+02 -1.23814270e+01 -6.67837909e+00 -6.67837909e+00
 -6.67837909e+00 -1.17951551e+00 -2.43064833e-01 -2.43064833e-01
 -2.43064833e-01  9.61884634e-01  6.65282557e+00  2.77633228e+01
  9.97287401e+01  3.20051801e+02  9.72338667e+02  3.24627324e+03
  1.27483132e+04  4.13474706e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291372e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6768348693425  E_coul = 198.68582832080133
Extra cycle  E= -507.991006548541  delta_E= -3.41e-13  |g|= 1.15e-08  |ddm|= 1.96e-07
    CPU time for scf_cycle      1.89 sec, wall time      0.31 sec
exp = [2.37580655e-01 6.27717199e-01 2.22824439e+00 1.17616810e+05
 4.82736302e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104114e+04 3.67546696e+04 7.30030544e+03
 1.83756930e+04 1.45891886e+03 4.17568453e+02 1.53420072e+02
 6.61921936e+01 2.95650904e+01 1.02837236e+01 8.60427830e+00
 4.92750058e-01]
E = -507.99100654854124
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:32 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.23758065477        1
[INPUT] 0    0    [1    /1   ]  0.627717199119       1
[INPUT] 0    0    [1    /1   ]  2.22824438646        1
[INPUT] 0    0    [1    /1   ]  117616.810495        1
[INPUT] 0    0    [1    /1   ]  4.82736301502        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069888        1
[INPUT] 0    0    [1    /1   ]  294042.03055         1
[INPUT] 0    0    [1    /1   ]  147020.989856        1
[INPUT] 0    0    [1    /1   ]  73510.4114196        1
[INPUT] 0    0    [1    /1   ]  36754.6695661        1
[INPUT] 0    0    [1    /1   ]  7300.30544363        1
[INPUT] 0    0    [1    /1   ]  18375.6929909        1
[INPUT] 0    0    [1    /1   ]  1458.91885745        1
[INPUT] 0    0    [1    /1   ]  417.568453291        1
[INPUT] 0    0    [1    /1   ]  153.420072336        1
[INPUT] 0    0    [1    /1   ]  66.1921936261        1
[INPUT] 0    0    [1    /1   ]  29.565090395         1
[INPUT] 0    0    [1    /1   ]  10.2837236099        1
[INPUT] 1    0    [1    /1   ]  8.60427829928        1
[INPUT] 1    0    [1    /1   ]  0.492750058361       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2375806547702828, 1.0]], [0, [0.6277171991193586, 1.0]], [0, [2.2282443864553483, 1.0]], [0, [117616.81049457069, 1.0]], [0, [4.827363015017947, 1.0]], [0, [1176168.1425974818, 1.0]], [0, [588084.0698877644, 1.0]], [0, [294042.0305499606, 1.0]], [0, [147020.98985563635, 1.0]], [0, [73510.41141964274, 1.0]], [0, [36754.669566149, 1.0]], [0, [7300.305443633064, 1.0]], [0, [18375.69299090843, 1.0]], [0, [1458.9188574545237, 1.0]], [0, [417.56845329060894, 1.0]], [0, [153.42007233576743, 1.0]], [0, [66.19219362613703, 1.0]], [0, [29.565090395010074, 1.0]], [0, [10.283723609877004, 1.0]], [1, [8.60427829928336, 1.0]], [1, [0.49275005836089175, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23758065]
bas 1, expnt(s) = [0.6277172]
bas 2, expnt(s) = [2.22824439]
bas 3, expnt(s) = [117616.81049457]
bas 4, expnt(s) = [4.82736302]
bas 5, expnt(s) = [1176168.14259748]
bas 6, expnt(s) = [588084.06988776]
bas 7, expnt(s) = [294042.03054996]
bas 8, expnt(s) = [147020.98985564]
bas 9, expnt(s) = [73510.41141964]
bas 10, expnt(s) = [36754.66956615]
bas 11, expnt(s) = [7300.30544363]
bas 12, expnt(s) = [18375.69299091]
bas 13, expnt(s) = [1458.91885745]
bas 14, expnt(s) = [417.56845329]
bas 15, expnt(s) = [153.42007234]
bas 16, expnt(s) = [66.19219363]
bas 17, expnt(s) = [29.5650904]
bas 18, expnt(s) = [10.28372361]
bas 19, expnt(s) = [8.6042783]
bas 20, expnt(s) = [0.49275006]
CPU time:      2039.17
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.37580655e-01 8.59752269e-01 6.27717199e-01 1.78171422e+00
 2.22824439e+00 4.60773124e+00 1.17616810e+05 1.60460105e+04
 4.82736302e+00 8.22806082e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104114e+04 1.12791576e+04
 3.67546696e+04 6.70655385e+03 7.30030544e+03 1.99535787e+03
 1.83756930e+04 3.98747358e+03 1.45891886e+03 5.96401020e+02
 4.17568453e+02 2.33378468e+02 1.53420072e+02 1.10135331e+02
 6.61921936e+01 5.86300284e+01 2.95650904e+01 3.20331342e+01
 1.02837236e+01 1.45086773e+01 8.60427830e+00 4.29909907e+01
 4.92750058e-01 1.20439168e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336041836574342
cond(S) = 914131.9767153807
E1 = -689.6021325377976  E_coul = 184.97100938455628
init E= -504.631123153241
    CPU time for initialize scf      0.73 sec, wall time      0.07 sec
  HOMO = -0.672181037789221  LUMO = 0.603856315774222
  mo_energy =
[-1.21710057e+02 -1.33863939e+01 -7.62363429e+00 -7.62363429e+00
 -7.62363429e+00 -1.65750006e+00 -6.72181038e-01 -6.72181038e-01
 -6.72181038e-01  6.03856316e-01  6.00843389e+00  2.68234113e+01
  9.85183088e+01  3.18707842e+02  9.70980059e+02  3.24498903e+03
  1.27471457e+04  4.13463742e+04  1.05371010e+05  2.30540760e+05
  4.56345708e+05  8.45290371e+05  1.52846030e+06  2.85071867e+06
  5.80859439e+06]
E1 = -707.7528406986356  E_coul = 199.77987321733121
cycle= 1 E= -507.972967481304  delta_E= -3.34  |g|= 0.452  |ddm|= 0.484
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.762998
diis-c [-0.58216636  1.        ]
  HOMO = -0.217689744333727  LUMO = 0.967270618110242
  mo_energy =
[-1.20200559e+02 -1.23049890e+01 -6.59420180e+00 -6.59420180e+00
 -6.59420180e+00 -1.16331892e+00 -2.17689744e-01 -2.17689744e-01
 -2.17689744e-01  9.67270618e-01  6.69074104e+00  2.78332493e+01
  9.98261663e+01  3.20169174e+02  9.72471490e+02  3.24642089e+03
  1.27484716e+04  4.13476330e+04  1.05372232e+05  2.30541957e+05
  4.56346888e+05  8.45291538e+05  1.52846145e+06  2.85071982e+06
  5.80859552e+06]
E1 = -706.8002487811635  E_coul = 198.8095061885081
cycle= 2 E= -507.990742592655  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.407
    CPU time for cycle= 2      0.03 sec, wall time      0.04 sec
diis-norm(errvec)=0.033175
diis-c [-1.10021229e-03 -7.95920308e-04  1.00079592e+00]
  HOMO = -0.239760741254053  LUMO = 0.962804211383103
  mo_energy =
[-1.20315077e+02 -1.23724664e+01 -6.66892643e+00 -6.66892643e+00
 -6.66892643e+00 -1.17751433e+00 -2.39760741e-01 -2.39760741e-01
 -2.39760741e-01  9.62804211e-01  6.65785944e+00  2.77715391e+01
  9.97390854e+01  3.20063445e+02  9.72351164e+02  3.24628646e+03
  1.27483269e+04  4.13474845e+04  1.05372082e+05  2.30541807e+05
  4.56346737e+05  8.45291386e+05  1.52846130e+06  2.85071967e+06
  5.80859537e+06]
E1 = -706.6927790847951  E_coul = 198.7017775115675
cycle= 3 E= -507.991001573228  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0597
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00357571
diis-c [-2.89152825e-06  8.39155893e-05 -1.05002842e-01  1.10491893e+00]
  HOMO = -0.242910713200386  LUMO = 0.961935735739532
  mo_energy =
[-1.20326939e+02 -1.23810675e+01 -6.67802199e+00 -6.67802199e+00
 -6.67802199e+00 -1.17942248e+00 -2.42910713e-01 -2.42910713e-01
 -2.42910713e-01  9.61935736e-01  6.65306176e+00  2.77636533e+01
  9.97291025e+01  3.20052173e+02  9.72339045e+02  3.24627362e+03
  1.27483136e+04  4.13474710e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291373e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6775708508997  E_coul = 198.68656431569985
cycle= 4 E= -507.9910065352  delta_E= -4.96e-06  |g|= 0.00023  |ddm|= 0.00988
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165999
diis-c [-3.55016374e-10 -8.38991991e-06  7.00600203e-03 -1.00631992e-01
  1.09363438e+00]
  HOMO = -0.243062854662664  LUMO = 0.96188520544101
  mo_energy =
[-1.20327310e+02 -1.23814229e+01 -6.67837496e+00 -6.67837496e+00
 -6.67837496e+00 -1.17951414e+00 -2.43062855e-01 -2.43062855e-01
 -2.43062855e-01  9.61885205e-01  6.65282857e+00  2.77633266e+01
  9.97287445e+01  3.20051806e+02  9.72338672e+02  3.24627325e+03
  1.27483132e+04  4.13474706e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291372e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6768447448304  E_coul = 198.68583819629225
cycle= 5 E= -507.991006548538  delta_E= -1.33e-08  |g|= 3.9e-06  |ddm|= 0.000596
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.77714e-06
diis-c [-5.66488878e-13  4.59189289e-07 -4.27718410e-04  5.83650360e-03
 -6.77828681e-02  1.06237362e+00]
  HOMO = -0.243064791867216  LUMO = 0.961884657390239
  mo_energy =
[-1.20327315e+02 -1.23814269e+01 -6.67837901e+00 -6.67837901e+00
 -6.67837901e+00 -1.17951549e+00 -2.43064792e-01 -2.43064792e-01
 -2.43064792e-01  9.61884657e-01  6.65282563e+00  2.77633228e+01
  9.97287402e+01  3.20051801e+02  9.72338667e+02  3.24627324e+03
  1.27483132e+04  4.13474706e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291372e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6768350538703  E_coul = 198.68582850532937
cycle= 6 E= -507.991006548541  delta_E= -2.73e-12  |g|= 8.9e-08  |ddm|= 1.02e-05
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6768350538703  E_coul = 198.68582850532937
  HOMO = -0.243064833318724  LUMO = 0.961884633766654
  mo_energy =
[-1.20327315e+02 -1.23814270e+01 -6.67837909e+00 -6.67837909e+00
 -6.67837909e+00 -1.17951551e+00 -2.43064833e-01 -2.43064833e-01
 -2.43064833e-01  9.61884634e-01  6.65282557e+00  2.77633228e+01
  9.97287401e+01  3.20051801e+02  9.72338667e+02  3.24627324e+03
  1.27483132e+04  4.13474706e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291372e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6768348693425  E_coul = 198.68582832080133
Extra cycle  E= -507.991006548541  delta_E= -3.41e-13  |g|= 1.15e-08  |ddm|= 1.96e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.30 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 914131.9767153807
E1 = -706.6768348693425  E_coul = 198.68582832080133
init E= -507.991006548541
    CPU time for initialize scf      5.73 sec, wall time      0.24 sec
  HOMO = -0.243064839224933  LUMO = 0.961884633375472
  mo_energy =
[-1.20327315e+02 -1.23814270e+01 -6.67837910e+00 -6.67837910e+00
 -6.67837910e+00 -1.17951551e+00 -2.43064839e-01 -2.43064839e-01
 -2.43064839e-01  9.61884633e-01  6.65282555e+00  2.77633227e+01
  9.97287401e+01  3.20051801e+02  9.72338667e+02  3.24627324e+03
  1.27483132e+04  4.13474706e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291372e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.676834837634  E_coul = 198.68582828909308
cycle= 1 E= -507.991006548541  delta_E= 2.84e-13  |g|= 1.95e-09  |ddm|= 2.79e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.676834837634  E_coul = 198.68582828909308
  HOMO = -0.243064840187159  LUMO = 0.961884631813339
  mo_energy =
[-1.20327315e+02 -1.23814270e+01 -6.67837910e+00 -6.67837910e+00
 -6.67837910e+00 -1.17951552e+00 -2.43064840e-01 -2.43064840e-01
 -2.43064840e-01  9.61884632e-01  6.65282555e+00  2.77633227e+01
  9.97287401e+01  3.20051801e+02  9.72338667e+02  3.24627324e+03
  1.27483132e+04  4.13474706e+04  1.05372068e+05  2.30541793e+05
  4.56346723e+05  8.45291372e+05  1.52846129e+06  2.85071965e+06
  5.80859536e+06]
E1 = -706.6768348350724  E_coul = 198.68582828653135
Extra cycle  E= -507.991006548541  delta_E= -1.71e-13  |g|= 1.63e-09  |ddm|= 1.85e-09
    CPU time for scf_cycle      6.24 sec, wall time      0.41 sec
exp = [2.37580655e-01 6.27717199e-01 2.22824439e+00 1.17616810e+05
 4.82736302e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104114e+04 3.67546696e+04 7.30030544e+03
 1.83756930e+04 1.45891886e+03 4.17568453e+02 1.53420072e+02
 6.61921936e+01 2.95650904e+01 1.02837236e+01 8.60427830e+00
 4.92750058e-01]
grad_E = [-9.25479597e-04  4.57619484e-04  9.76991422e-05  5.20248124e-09
 -1.35222782e-04  3.06745566e-11  1.46002762e-10  8.08179937e-10
  3.18277796e-09  1.32636443e-08  7.00537223e-08  4.45449973e-06
  1.63047804e-07 -2.34998207e-05 -5.27286264e-05  4.79586455e-06
  4.27731909e-05  6.11316556e-06  3.36766780e-05  1.98804226e-05
  1.19152333e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:40 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238828293619       1
[INPUT] 0    0    [1    /1   ]  0.6304224813         1
[INPUT] 0    0    [1    /1   ]  2.31918324377        1
[INPUT] 0    0    [1    /1   ]  117616.810354        1
[INPUT] 0    0    [1    /1   ]  5.02692828674        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069884        1
[INPUT] 0    0    [1    /1   ]  294042.030528        1
[INPUT] 0    0    [1    /1   ]  147020.98977         1
[INPUT] 0    0    [1    /1   ]  73510.4110605        1
[INPUT] 0    0    [1    /1   ]  36754.667693         1
[INPUT] 0    0    [1    /1   ]  7300.18732496        1
[INPUT] 0    0    [1    /1   ]  18375.6883998        1
[INPUT] 0    0    [1    /1   ]  1459.81940592        1
[INPUT] 0    0    [1    /1   ]  417.596158207        1
[INPUT] 0    0    [1    /1   ]  153.696821831        1
[INPUT] 0    0    [1    /1   ]  66.6637143397        1
[INPUT] 0    0    [1    /1   ]  29.9309526956        1
[INPUT] 0    0    [1    /1   ]  10.5880830777        1
[INPUT] 1    0    [1    /1   ]  8.60428377804        1
[INPUT] 1    0    [1    /1   ]  0.492749077508       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2388282936187377, 1.0]], [0, [0.6304224812995842, 1.0]], [0, [2.319183243773465, 1.0]], [0, [117616.81035424721, 1.0]], [0, [5.026928286743204, 1.0]], [0, [1176168.1425965459, 1.0]], [0, [588084.0698837334, 1.0]], [0, [294042.0305281953, 1.0]], [0, [147020.98976964207, 1.0]], [0, [73510.41106054668, 1.0]], [0, [36754.667692998, 1.0]], [0, [7300.187324963173, 1.0]], [0, [18375.688399807113, 1.0]], [0, [1459.8194059169248, 1.0]], [0, [417.5961582065379, 1.0]], [0, [153.69682183099513, 1.0]], [0, [66.66371433972499, 1.0]], [0, [29.930952695575908, 1.0]], [0, [10.588083077729163, 1.0]], [1, [8.604283778042673, 1.0]], [1, [0.492749077508105, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23882829]
bas 1, expnt(s) = [0.63042248]
bas 2, expnt(s) = [2.31918324]
bas 3, expnt(s) = [117616.81035425]
bas 4, expnt(s) = [5.02692829]
bas 5, expnt(s) = [1176168.14259655]
bas 6, expnt(s) = [588084.06988373]
bas 7, expnt(s) = [294042.0305282]
bas 8, expnt(s) = [147020.98976964]
bas 9, expnt(s) = [73510.41106055]
bas 10, expnt(s) = [36754.667693]
bas 11, expnt(s) = [7300.18732496]
bas 12, expnt(s) = [18375.68839981]
bas 13, expnt(s) = [1459.81940592]
bas 14, expnt(s) = [417.59615821]
bas 15, expnt(s) = [153.69682183]
bas 16, expnt(s) = [66.66371434]
bas 17, expnt(s) = [29.9309527]
bas 18, expnt(s) = [10.58808308]
bas 19, expnt(s) = [8.60428378]
bas 20, expnt(s) = [0.49274908]
CPU time:      2054.06
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38828294e-01 8.63136249e-01 6.30422481e-01 1.78747013e+00
 2.31918324e+00 4.74806136e+00 1.17616810e+05 1.60460105e+04
 5.02692829e+00 8.48187839e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104111e+04 1.12791575e+04
 3.67546677e+04 6.70655360e+03 7.30018732e+03 1.99533365e+03
 1.83756884e+04 3.98747284e+03 1.45981941e+03 5.96677105e+02
 4.17596158e+02 2.33390081e+02 1.53696822e+02 1.10284300e+02
 6.66637143e+01 5.89429890e+01 2.99309527e+01 3.23299795e+01
 1.05880831e+01 1.48295519e+01 8.60428378e+00 4.29910250e+01
 4.92749078e-01 1.20438869e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336032883418287
cond(S) = 914276.6896605276
E1 = -689.6020777069215  E_coul = 184.97074889516125
init E= -504.63132881176
    CPU time for initialize scf      0.70 sec, wall time      0.07 sec
  HOMO = -0.672188697021294  LUMO = 0.613322986182339
  mo_energy =
[-1.21710084e+02 -1.33864239e+01 -7.62365565e+00 -7.62365565e+00
 -7.62365565e+00 -1.65748888e+00 -6.72188697e-01 -6.72188697e-01
 -6.72188697e-01  6.13322986e-01  6.27095407e+00  2.80514044e+01
  1.01371724e+02  3.23337540e+02  9.76972256e+02  3.25209914e+03
  1.27554198e+04  4.13547030e+04  1.05379094e+05  2.30548622e+05
  4.56353401e+05  8.45297936e+05  1.52846774e+06  2.85072597e+06
  5.80860148e+06]
E1 = -707.7521390130903  E_coul = 199.77914738410243
cycle= 1 E= -507.972991628988  delta_E= -3.34  |g|= 0.452  |ddm|= 0.486
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.763453
diis-c [-0.58286064  1.        ]
  HOMO = -0.217699075608414  LUMO = 0.97948285978741
  mo_energy =
[-1.20200644e+02 -1.23050550e+01 -6.59426484e+00 -6.59426484e+00
 -6.59426484e+00 -1.16331660e+00 -2.17699076e-01 -2.17699076e-01
 -2.17699076e-01  9.79482860e-01  6.96589843e+00  2.90720320e+01
  1.02682726e+02  3.24799113e+02  9.78463539e+02  3.25353089e+03
  1.27567455e+04  4.13559617e+04  1.05380315e+05  2.30549819e+05
  4.56354581e+05  8.45299103e+05  1.52846890e+06  2.85072711e+06
  5.80860262e+06]
E1 = -706.8004532544628  E_coul = 198.8097057291497
cycle= 2 E= -507.990747525313  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.41
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329479
diis-c [-1.08539073e-03 -5.49807255e-04  1.00054981e+00]
  HOMO = -0.239744955991748  LUMO = 0.974881432854836
  mo_energy =
[-1.20315038e+02 -1.23724455e+01 -6.66889614e+00 -6.66889614e+00
 -6.66889614e+00 -1.17749546e+00 -2.39744956e-01 -2.39744956e-01
 -2.39744956e-01  9.74881433e-01  6.93204234e+00  2.90095152e+01
  1.02595413e+02  3.24693434e+02  9.78343344e+02  3.25339661e+03
  1.27566010e+04  4.13558134e+04  1.05380165e+05  2.30549668e+05
  4.56354430e+05  8.45298951e+05  1.52846874e+06  2.85072696e+06
  5.80860247e+06]
E1 = -706.6931256292747  E_coul = 198.70211954404633
cycle= 3 E= -507.991006085228  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0596
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00353649
diis-c [-2.83764896e-06  8.16361932e-05 -1.04452197e-01  1.10437056e+00]
  HOMO = -0.242893101645857  LUMO = 0.973992740673485
  mo_energy =
[-1.20326909e+02 -1.23810481e+01 -6.67799450e+00 -6.67799450e+00
 -6.67799450e+00 -1.17940239e+00 -2.42893102e-01 -2.42893102e-01
 -2.42893102e-01  9.73992741e-01  6.92711940e+00  2.90015437e+01
  1.02585399e+02  3.24682150e+02  9.78331215e+02  3.25338376e+03
  1.27565877e+04  4.13557999e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298938e+05  1.52846873e+06  2.85072695e+06
  5.80860246e+06]
E1 = -706.6779328088564  E_coul = 198.68692177643933
cycle= 4 E= -507.991011032417  delta_E= -4.95e-06  |g|= 0.00023  |ddm|= 0.0098
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165269
diis-c [-3.27237611e-10 -8.25737747e-06  7.02131181e-03 -1.01291684e-01
  1.09427863e+00]
  HOMO = -0.24304637819652  LUMO = 0.97394105409781
  mo_energy =
[-1.20327287e+02 -1.23814084e+01 -6.67835271e+00 -6.67835271e+00
 -6.67835271e+00 -1.17949465e+00 -2.43046378e-01 -2.43046378e-01
 -2.43046378e-01  9.73941054e-01  6.92687918e+00  2.90012107e+01
  1.02585035e+02  3.24681776e+02  9.78330835e+02  3.25338338e+03
  1.27565873e+04  4.13557995e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298937e+05  1.52846873e+06  2.85072694e+06
  5.80860245e+06]
E1 = -706.6772016749379  E_coul = 198.68619062921474
cycle= 5 E= -507.991011045723  delta_E= -1.33e-08  |g|= 3.57e-06  |ddm|= 0.000586
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.64713e-06
diis-c [-5.05201368e-13  4.40081886e-07 -4.00354021e-04  5.47876978e-03
 -6.32414885e-02  1.05816263e+00]
  HOMO = -0.243048184248642  LUMO = 0.97394054798227
  mo_energy =
[-1.20327292e+02 -1.23814121e+01 -6.67835654e+00 -6.67835654e+00
 -6.67835654e+00 -1.17949592e+00 -2.43048184e-01 -2.43048184e-01
 -2.43048184e-01  9.73940548e-01  6.92687638e+00  2.90012071e+01
  1.02585030e+02  3.24681772e+02  9.78330830e+02  3.25338337e+03
  1.27565873e+04  4.13557995e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298937e+05  1.52846873e+06  2.85072694e+06
  5.80860245e+06]
E1 = -706.6771926395004  E_coul = 198.68618159377462
cycle= 6 E= -507.991011045726  delta_E= -2.56e-12  |g|= 8.62e-08  |ddm|= 9.1e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6771926395004  E_coul = 198.68618159377462
  HOMO = -0.243048224976931  LUMO = 0.97394052382613
  mo_energy =
[-1.20327292e+02 -1.23814122e+01 -6.67835662e+00 -6.67835662e+00
 -6.67835662e+00 -1.17949594e+00 -2.43048225e-01 -2.43048225e-01
 -2.43048225e-01  9.73940524e-01  6.92687632e+00  2.90012070e+01
  1.02585030e+02  3.24681771e+02  9.78330830e+02  3.25338337e+03
  1.27565873e+04  4.13557995e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298937e+05  1.52846873e+06  2.85072694e+06
  5.80860245e+06]
E1 = -706.6771924588227  E_coul = 198.68618141309702
Extra cycle  E= -507.991011045726  delta_E= 1.14e-13  |g|= 1.08e-08  |ddm|= 1.86e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.28 sec
exp = [2.38828294e-01 6.30422481e-01 2.31918324e+00 1.17616810e+05
 5.02692829e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104111e+04 3.67546677e+04 7.30018732e+03
 1.83756884e+04 1.45981941e+03 4.17596158e+02 1.53696822e+02
 6.66637143e+01 2.99309527e+01 1.05880831e+01 8.60428378e+00
 4.92749078e-01]
E = -507.99101104572566
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:41 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238828293619       1
[INPUT] 0    0    [1    /1   ]  0.6304224813         1
[INPUT] 0    0    [1    /1   ]  2.31918324377        1
[INPUT] 0    0    [1    /1   ]  117616.810354        1
[INPUT] 0    0    [1    /1   ]  5.02692828674        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069884        1
[INPUT] 0    0    [1    /1   ]  294042.030528        1
[INPUT] 0    0    [1    /1   ]  147020.98977         1
[INPUT] 0    0    [1    /1   ]  73510.4110605        1
[INPUT] 0    0    [1    /1   ]  36754.667693         1
[INPUT] 0    0    [1    /1   ]  7300.18732496        1
[INPUT] 0    0    [1    /1   ]  18375.6883998        1
[INPUT] 0    0    [1    /1   ]  1459.81940592        1
[INPUT] 0    0    [1    /1   ]  417.596158207        1
[INPUT] 0    0    [1    /1   ]  153.696821831        1
[INPUT] 0    0    [1    /1   ]  66.6637143397        1
[INPUT] 0    0    [1    /1   ]  29.9309526956        1
[INPUT] 0    0    [1    /1   ]  10.5880830777        1
[INPUT] 1    0    [1    /1   ]  8.60428377804        1
[INPUT] 1    0    [1    /1   ]  0.492749077508       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.2388282936187377, 1.0]], [0, [0.6304224812995842, 1.0]], [0, [2.319183243773465, 1.0]], [0, [117616.81035424721, 1.0]], [0, [5.026928286743204, 1.0]], [0, [1176168.1425965459, 1.0]], [0, [588084.0698837334, 1.0]], [0, [294042.0305281953, 1.0]], [0, [147020.98976964207, 1.0]], [0, [73510.41106054668, 1.0]], [0, [36754.667692998, 1.0]], [0, [7300.187324963173, 1.0]], [0, [18375.688399807113, 1.0]], [0, [1459.8194059169248, 1.0]], [0, [417.5961582065379, 1.0]], [0, [153.69682183099513, 1.0]], [0, [66.66371433972499, 1.0]], [0, [29.930952695575908, 1.0]], [0, [10.588083077729163, 1.0]], [1, [8.604283778042673, 1.0]], [1, [0.492749077508105, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23882829]
bas 1, expnt(s) = [0.63042248]
bas 2, expnt(s) = [2.31918324]
bas 3, expnt(s) = [117616.81035425]
bas 4, expnt(s) = [5.02692829]
bas 5, expnt(s) = [1176168.14259655]
bas 6, expnt(s) = [588084.06988373]
bas 7, expnt(s) = [294042.0305282]
bas 8, expnt(s) = [147020.98976964]
bas 9, expnt(s) = [73510.41106055]
bas 10, expnt(s) = [36754.667693]
bas 11, expnt(s) = [7300.18732496]
bas 12, expnt(s) = [18375.68839981]
bas 13, expnt(s) = [1459.81940592]
bas 14, expnt(s) = [417.59615821]
bas 15, expnt(s) = [153.69682183]
bas 16, expnt(s) = [66.66371434]
bas 17, expnt(s) = [29.9309527]
bas 18, expnt(s) = [10.58808308]
bas 19, expnt(s) = [8.60428378]
bas 20, expnt(s) = [0.49274908]
CPU time:      2056.19
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38828294e-01 8.63136249e-01 6.30422481e-01 1.78747013e+00
 2.31918324e+00 4.74806136e+00 1.17616810e+05 1.60460105e+04
 5.02692829e+00 8.48187839e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104111e+04 1.12791575e+04
 3.67546677e+04 6.70655360e+03 7.30018732e+03 1.99533365e+03
 1.83756884e+04 3.98747284e+03 1.45981941e+03 5.96677105e+02
 4.17596158e+02 2.33390081e+02 1.53696822e+02 1.10284300e+02
 6.66637143e+01 5.89429890e+01 2.99309527e+01 3.23299795e+01
 1.05880831e+01 1.48295519e+01 8.60428378e+00 4.29910250e+01
 4.92749078e-01 1.20438869e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336032883418287
cond(S) = 914276.6896605276
E1 = -689.6020777069215  E_coul = 184.97074889516125
init E= -504.63132881176
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672188697021294  LUMO = 0.613322986182339
  mo_energy =
[-1.21710084e+02 -1.33864239e+01 -7.62365565e+00 -7.62365565e+00
 -7.62365565e+00 -1.65748888e+00 -6.72188697e-01 -6.72188697e-01
 -6.72188697e-01  6.13322986e-01  6.27095407e+00  2.80514044e+01
  1.01371724e+02  3.23337540e+02  9.76972256e+02  3.25209914e+03
  1.27554198e+04  4.13547030e+04  1.05379094e+05  2.30548622e+05
  4.56353401e+05  8.45297936e+05  1.52846774e+06  2.85072597e+06
  5.80860148e+06]
E1 = -707.7521390130903  E_coul = 199.77914738410243
cycle= 1 E= -507.972991628988  delta_E= -3.34  |g|= 0.452  |ddm|= 0.486
    CPU time for cycle= 1      0.62 sec, wall time      0.03 sec
diis-norm(errvec)=0.763453
diis-c [-0.58286064  1.        ]
  HOMO = -0.217699075608414  LUMO = 0.97948285978741
  mo_energy =
[-1.20200644e+02 -1.23050550e+01 -6.59426484e+00 -6.59426484e+00
 -6.59426484e+00 -1.16331660e+00 -2.17699076e-01 -2.17699076e-01
 -2.17699076e-01  9.79482860e-01  6.96589843e+00  2.90720320e+01
  1.02682726e+02  3.24799113e+02  9.78463539e+02  3.25353089e+03
  1.27567455e+04  4.13559617e+04  1.05380315e+05  2.30549819e+05
  4.56354581e+05  8.45299103e+05  1.52846890e+06  2.85072711e+06
  5.80860262e+06]
E1 = -706.8004532544628  E_coul = 198.8097057291497
cycle= 2 E= -507.990747525313  delta_E= -0.0178  |g|= 0.035  |ddm|= 0.41
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329479
diis-c [-1.08539073e-03 -5.49807255e-04  1.00054981e+00]
  HOMO = -0.239744955991748  LUMO = 0.974881432854836
  mo_energy =
[-1.20315038e+02 -1.23724455e+01 -6.66889614e+00 -6.66889614e+00
 -6.66889614e+00 -1.17749546e+00 -2.39744956e-01 -2.39744956e-01
 -2.39744956e-01  9.74881433e-01  6.93204234e+00  2.90095152e+01
  1.02595413e+02  3.24693434e+02  9.78343344e+02  3.25339661e+03
  1.27566010e+04  4.13558134e+04  1.05380165e+05  2.30549668e+05
  4.56354430e+05  8.45298951e+05  1.52846874e+06  2.85072696e+06
  5.80860247e+06]
E1 = -706.6931256292747  E_coul = 198.70211954404633
cycle= 3 E= -507.991006085228  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0596
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00353649
diis-c [-2.83764896e-06  8.16361932e-05 -1.04452197e-01  1.10437056e+00]
  HOMO = -0.242893101645857  LUMO = 0.973992740673485
  mo_energy =
[-1.20326909e+02 -1.23810481e+01 -6.67799450e+00 -6.67799450e+00
 -6.67799450e+00 -1.17940239e+00 -2.42893102e-01 -2.42893102e-01
 -2.42893102e-01  9.73992741e-01  6.92711940e+00  2.90015437e+01
  1.02585399e+02  3.24682150e+02  9.78331215e+02  3.25338376e+03
  1.27565877e+04  4.13557999e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298938e+05  1.52846873e+06  2.85072695e+06
  5.80860246e+06]
E1 = -706.6779328088564  E_coul = 198.68692177643933
cycle= 4 E= -507.991011032417  delta_E= -4.95e-06  |g|= 0.00023  |ddm|= 0.0098
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165269
diis-c [-3.27237611e-10 -8.25737747e-06  7.02131181e-03 -1.01291684e-01
  1.09427863e+00]
  HOMO = -0.24304637819652  LUMO = 0.97394105409781
  mo_energy =
[-1.20327287e+02 -1.23814084e+01 -6.67835271e+00 -6.67835271e+00
 -6.67835271e+00 -1.17949465e+00 -2.43046378e-01 -2.43046378e-01
 -2.43046378e-01  9.73941054e-01  6.92687918e+00  2.90012107e+01
  1.02585035e+02  3.24681776e+02  9.78330835e+02  3.25338338e+03
  1.27565873e+04  4.13557995e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298937e+05  1.52846873e+06  2.85072694e+06
  5.80860245e+06]
E1 = -706.6772016749379  E_coul = 198.68619062921474
cycle= 5 E= -507.991011045723  delta_E= -1.33e-08  |g|= 3.57e-06  |ddm|= 0.000586
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.64713e-06
diis-c [-5.05201368e-13  4.40081886e-07 -4.00354021e-04  5.47876978e-03
 -6.32414885e-02  1.05816263e+00]
  HOMO = -0.243048184248642  LUMO = 0.97394054798227
  mo_energy =
[-1.20327292e+02 -1.23814121e+01 -6.67835654e+00 -6.67835654e+00
 -6.67835654e+00 -1.17949592e+00 -2.43048184e-01 -2.43048184e-01
 -2.43048184e-01  9.73940548e-01  6.92687638e+00  2.90012071e+01
  1.02585030e+02  3.24681772e+02  9.78330830e+02  3.25338337e+03
  1.27565873e+04  4.13557995e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298937e+05  1.52846873e+06  2.85072694e+06
  5.80860245e+06]
E1 = -706.6771926395004  E_coul = 198.68618159377462
cycle= 6 E= -507.991011045726  delta_E= -2.56e-12  |g|= 8.62e-08  |ddm|= 9.1e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6771926395004  E_coul = 198.68618159377462
  HOMO = -0.243048224976931  LUMO = 0.97394052382613
  mo_energy =
[-1.20327292e+02 -1.23814122e+01 -6.67835662e+00 -6.67835662e+00
 -6.67835662e+00 -1.17949594e+00 -2.43048225e-01 -2.43048225e-01
 -2.43048225e-01  9.73940524e-01  6.92687632e+00  2.90012070e+01
  1.02585030e+02  3.24681771e+02  9.78330830e+02  3.25338337e+03
  1.27565873e+04  4.13557995e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298937e+05  1.52846873e+06  2.85072694e+06
  5.80860245e+06]
E1 = -706.6771924588227  E_coul = 198.68618141309702
Extra cycle  E= -507.991011045726  delta_E= 1.14e-13  |g|= 1.08e-08  |ddm|= 1.86e-07
    CPU time for scf_cycle      1.53 sec, wall time      0.28 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 914276.6896605276
E1 = -706.6771924588227  E_coul = 198.68618141309702
init E= -507.991011045726
    CPU time for initialize scf      6.12 sec, wall time      0.26 sec
  HOMO = -0.243048230729212  LUMO = 0.973940521309402
  mo_energy =
[-1.20327292e+02 -1.23814122e+01 -6.67835664e+00 -6.67835664e+00
 -6.67835664e+00 -1.17949594e+00 -2.43048231e-01 -2.43048231e-01
 -2.43048231e-01  9.73940521e-01  6.92687631e+00  2.90012070e+01
  1.02585030e+02  3.24681771e+02  9.78330830e+02  3.25338337e+03
  1.27565873e+04  4.13557995e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298937e+05  1.52846873e+06  2.85072694e+06
  5.80860245e+06]
E1 = -706.6771924316208  E_coul = 198.68618138589477
cycle= 1 E= -507.991011045726  delta_E= -3.98e-13  |g|= 2.22e-09  |ddm|= 2.35e-08
    CPU time for cycle= 1      0.34 sec, wall time      0.03 sec
E1 = -706.6771924316208  E_coul = 198.68618138589477
  HOMO = -0.243048231554466  LUMO = 0.973940522164855
  mo_energy =
[-1.20327292e+02 -1.23814122e+01 -6.67835664e+00 -6.67835664e+00
 -6.67835664e+00 -1.17949594e+00 -2.43048232e-01 -2.43048232e-01
 -2.43048232e-01  9.73940522e-01  6.92687631e+00  2.90012070e+01
  1.02585030e+02  3.24681771e+02  9.78330830e+02  3.25338337e+03
  1.27565873e+04  4.13557995e+04  1.05380152e+05  2.30549654e+05
  4.56354416e+05  8.45298937e+05  1.52846873e+06  2.85072694e+06
  5.80860245e+06]
E1 = -706.6771924240146  E_coul = 198.6861813782883
Extra cycle  E= -507.991011045726  delta_E= -2.27e-13  |g|= 1.25e-09  |ddm|= 5.73e-09
    CPU time for scf_cycle      6.60 sec, wall time      0.43 sec
exp = [2.38828294e-01 6.30422481e-01 2.31918324e+00 1.17616810e+05
 5.02692829e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104111e+04 3.67546677e+04 7.30018732e+03
 1.83756884e+04 1.45981941e+03 4.17596158e+02 1.53696822e+02
 6.66637143e+01 2.99309527e+01 1.05880831e+01 8.60428378e+00
 4.92749078e-01]
grad_E = [-3.84212516e-04  2.55934151e-04  1.09286801e-04  5.15771430e-09
 -8.19120448e-05  3.01599361e-11  1.44539965e-10  8.01287063e-10
  3.15507083e-09  1.31466268e-08  6.94863803e-08  4.42046467e-06
  1.61228974e-07 -2.27336685e-05 -5.52226394e-05  7.37601623e-06
  4.00346090e-05  4.76208292e-06  1.42964692e-05  2.99736869e-05
  1.46232343e-04]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:48 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238574867729       1
[INPUT] 0    0    [1    /1   ]  0.62910628209        1
[INPUT] 0    0    [1    /1   ]  2.32903102078        1
[INPUT] 0    0    [1    /1   ]  117616.810311        1
[INPUT] 0    0    [1    /1   ]  5.09204564675        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069882        1
[INPUT] 0    0    [1    /1   ]  294042.030522        1
[INPUT] 0    0    [1    /1   ]  147020.989743        1
[INPUT] 0    0    [1    /1   ]  73510.4109502        1
[INPUT] 0    0    [1    /1   ]  36754.6671173        1
[INPUT] 0    0    [1    /1   ]  7300.15101435        1
[INPUT] 0    0    [1    /1   ]  18375.6869888        1
[INPUT] 0    0    [1    /1   ]  1460.0969551         1
[INPUT] 0    0    [1    /1   ]  417.594703809        1
[INPUT] 0    0    [1    /1   ]  153.819757576        1
[INPUT] 0    0    [1    /1   ]  66.7689954757        1
[INPUT] 0    0    [1    /1   ]  30.0273185829        1
[INPUT] 0    0    [1    /1   ]  10.6975067026        1
[INPUT] 1    0    [1    /1   ]  8.6042595977         1
[INPUT] 1    0    [1    /1   ]  0.492746866266       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23857486772863146, 1.0]], [0, [0.6291062820896728, 1.0]], [0, [2.329031020782674, 1.0]], [0, [117616.81031111747, 1.0]], [0, [5.09204564674661, 1.0]], [0, [1176168.1425962583, 1.0]], [0, [588084.0698824945, 1.0]], [0, [294042.0305215055, 1.0]], [0, [147020.98974321102, 1.0]], [0, [73510.41095017611, 1.0]], [0, [36754.667117253026, 1.0]], [0, [7300.1510143489495, 1.0]], [0, [18375.6869888419, 1.0]], [0, [1460.0969550997843, 1.0]], [0, [417.59470380886484, 1.0]], [0, [153.81975757646234, 1.0]], [0, [66.7689954756762, 1.0]], [0, [30.0273185829101, 1.0]], [0, [10.69750670255372, 1.0]], [1, [8.604259597701754, 1.0]], [1, [0.49274686626567493, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23857487]
bas 1, expnt(s) = [0.62910628]
bas 2, expnt(s) = [2.32903102]
bas 3, expnt(s) = [117616.81031112]
bas 4, expnt(s) = [5.09204565]
bas 5, expnt(s) = [1176168.14259626]
bas 6, expnt(s) = [588084.06988249]
bas 7, expnt(s) = [294042.03052151]
bas 8, expnt(s) = [147020.98974321]
bas 9, expnt(s) = [73510.41095018]
bas 10, expnt(s) = [36754.66711725]
bas 11, expnt(s) = [7300.15101435]
bas 12, expnt(s) = [18375.68698884]
bas 13, expnt(s) = [1460.0969551]
bas 14, expnt(s) = [417.59470381]
bas 15, expnt(s) = [153.81975758]
bas 16, expnt(s) = [66.76899548]
bas 17, expnt(s) = [30.02731858]
bas 18, expnt(s) = [10.6975067]
bas 19, expnt(s) = [8.6042596]
bas 20, expnt(s) = [0.49274687]
CPU time:      2071.54
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38574868e-01 8.62449238e-01 6.29106282e-01 1.78467048e+00
 2.32903102e+00 4.76317435e+00 1.17616810e+05 1.60460105e+04
 5.09204565e+00 8.56414951e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104110e+04 1.12791575e+04
 3.67546671e+04 6.70655352e+03 7.30015101e+03 1.99532621e+03
 1.83756870e+04 3.98747261e+03 1.46009696e+03 5.96762185e+02
 4.17594704e+02 2.33389472e+02 1.53819758e+02 1.10350452e+02
 6.67689955e+01 5.90127911e+01 3.00273186e+01 3.24080155e+01
 1.06975067e+01 1.49443472e+01 8.60425960e+00 4.29908739e+01
 4.92746866e-01 1.20438193e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336035159410816
cond(S) = 914317.4812144903
E1 = -689.6015322687975  E_coul = 184.97030356973443
init E= -504.631228699063
    CPU time for initialize scf      0.78 sec, wall time      0.07 sec
  HOMO = -0.672202057858425  LUMO = 0.611962046396113
  mo_energy =
[-1.21710138e+02 -1.33864615e+01 -7.62368735e+00 -7.62368735e+00
 -7.62368735e+00 -1.65748145e+00 -6.72202058e-01 -6.72202058e-01
 -6.72202058e-01  6.11962046e-01  6.31465942e+00  2.83732188e+01
  1.02188031e+02  3.24650450e+02  9.78697789e+02  3.25418575e+03
  1.27578752e+04  4.13571818e+04  1.05381501e+05  2.30550962e+05
  4.56355692e+05  8.45300189e+05  1.52846996e+06  2.85072814e+06
  5.80860360e+06]
E1 = -707.7512013129538  E_coul = 199.7781976712942
cycle= 1 E= -507.97300364166  delta_E= -3.34  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.763701
diis-c [-0.58323874  1.        ]
  HOMO = -0.217710280648238  LUMO = 0.978074382238088
  mo_energy =
[-1.20200769e+02 -1.23051365e+01 -6.59434377e+00 -6.59434377e+00
 -6.59434377e+00 -1.16331514e+00 -2.17710281e-01 -2.17710281e-01
 -2.17710281e-01  9.78074382e-01  7.01235515e+00  2.93971188e+01
  1.03499976e+02  3.26112045e+02  9.80188976e+02  3.25561741e+03
  1.27592009e+04  4.13584404e+04  1.05382722e+05  2.30552159e+05
  4.56356872e+05  8.45301355e+05  1.52847111e+06  2.85072928e+06
  5.80860473e+06]
E1 = -706.8000074542279  E_coul = 198.80925968422446
cycle= 2 E= -507.990747770003  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.411
    CPU time for cycle= 2      0.05 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329541
diis-c [-1.08581862e-03 -5.18152533e-04  1.00051815e+00]
  HOMO = -0.239741888190555  LUMO = 0.973472453296894
  mo_energy =
[-1.20315112e+02 -1.23724863e+01 -6.66893360e+00 -6.66893360e+00
 -6.66893360e+00 -1.17748449e+00 -2.39741888e-01 -2.39741888e-01
 -2.39741888e-01  9.73472453e-01  6.97832585e+00  2.93343825e+01
  1.03412605e+02  3.26006396e+02  9.80068833e+02  3.25548318e+03
  1.27590565e+04  4.13582921e+04  1.05382572e+05  2.30552009e+05
  4.56356721e+05  8.45301204e+05  1.52847096e+06  2.85072913e+06
  5.80860458e+06]
E1 = -706.6926775193709  E_coul = 198.70167103732092
cycle= 3 E= -507.99100648205  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0597
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00353748
diis-c [-2.83638715e-06  7.84270409e-05 -1.04475149e-01  1.10439672e+00]
  HOMO = -0.242891432330326  LUMO = 0.97258283604537
  mo_energy =
[-1.20326987e+02 -1.23810915e+01 -6.67803476e+00 -6.67803476e+00
 -6.67803476e+00 -1.17939236e+00 -2.42891432e-01 -2.42891432e-01
 -2.42891432e-01  9.72582836e-01  6.97337621e+00  2.93263842e+01
  1.03402581e+02  3.25995107e+02  9.80056699e+02  3.25547033e+03
  1.27590431e+04  4.13582786e+04  1.05382559e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.6774671125586  E_coul = 198.6864556697392
cycle= 4 E= -507.991011442819  delta_E= -4.96e-06  |g|= 0.00023  |ddm|= 0.00982
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165527
diis-c [-3.27602488e-10 -8.25775068e-06  7.03666414e-03 -1.01481604e-01
  1.09445320e+00]
  HOMO = -0.243045133669254  LUMO = 0.972531003163133
  mo_energy =
[-1.20327367e+02 -1.23814528e+01 -6.67839404e+00 -6.67839404e+00
 -6.67839404e+00 -1.17948488e+00 -2.43045134e-01 -2.43045134e-01
 -2.43045134e-01  9.72531003e-01  6.97313431e+00  2.93260496e+01
  1.03402215e+02  3.25994731e+02  9.80056318e+02  3.25546994e+03
  1.27590427e+04  4.13582782e+04  1.05382558e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.6767333013622  E_coul = 198.68572184515597
cycle= 5 E= -507.991011456206  delta_E= -1.34e-08  |g|= 3.55e-06  |ddm|= 0.000587
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.64473e-06
diis-c [-5.02916360e-13  4.36696653e-07 -3.97899931e-04  5.44093654e-03
 -6.27381781e-02  1.05769470e+00]
  HOMO = -0.243046936450547  LUMO = 0.972530500718641
  mo_energy =
[-1.20327372e+02 -1.23814565e+01 -6.67839788e+00 -6.67839788e+00
 -6.67839788e+00 -1.17948614e+00 -2.43046936e-01 -2.43046936e-01
 -2.43046936e-01  9.72530501e-01  6.97313151e+00  2.93260460e+01
  1.03402211e+02  3.25994727e+02  9.80056313e+02  3.25546994e+03
  1.27590427e+04  4.13582782e+04  1.05382558e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.6767242723607  E_coul = 198.68571281615183
cycle= 6 E= -507.991011456209  delta_E= -2.61e-12  |g|= 8.66e-08  |ddm|= 9.02e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767242723607  E_coul = 198.68571281615183
  HOMO = -0.243046976892818  LUMO = 0.972530478237992
  mo_energy =
[-1.20327372e+02 -1.23814566e+01 -6.67839796e+00 -6.67839796e+00
 -6.67839796e+00 -1.17948616e+00 -2.43046977e-01 -2.43046977e-01
 -2.43046977e-01  9.72530478e-01  6.97313144e+00  2.93260459e+01
  1.03402211e+02  3.25994727e+02  9.80056313e+02  3.25546994e+03
  1.27590427e+04  4.13582782e+04  1.05382558e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.676724090374  E_coul = 198.68571263416453
Extra cycle  E= -507.991011456209  delta_E= -6.25e-13  |g|= 1.11e-08  |ddm|= 1.87e-07
    CPU time for scf_cycle      1.62 sec, wall time      0.29 sec
exp = [2.38574868e-01 6.29106282e-01 2.32903102e+00 1.17616810e+05
 5.09204565e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104110e+04 3.67546671e+04 7.30015101e+03
 1.83756870e+04 1.46009696e+03 4.17594704e+02 1.53819758e+02
 6.67689955e+01 3.00273186e+01 1.06975067e+01 8.60425960e+00
 4.92746866e-01]
E = -507.9910114562095
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:49 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238574867729       1
[INPUT] 0    0    [1    /1   ]  0.62910628209        1
[INPUT] 0    0    [1    /1   ]  2.32903102078        1
[INPUT] 0    0    [1    /1   ]  117616.810311        1
[INPUT] 0    0    [1    /1   ]  5.09204564675        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069882        1
[INPUT] 0    0    [1    /1   ]  294042.030522        1
[INPUT] 0    0    [1    /1   ]  147020.989743        1
[INPUT] 0    0    [1    /1   ]  73510.4109502        1
[INPUT] 0    0    [1    /1   ]  36754.6671173        1
[INPUT] 0    0    [1    /1   ]  7300.15101435        1
[INPUT] 0    0    [1    /1   ]  18375.6869888        1
[INPUT] 0    0    [1    /1   ]  1460.0969551         1
[INPUT] 0    0    [1    /1   ]  417.594703809        1
[INPUT] 0    0    [1    /1   ]  153.819757576        1
[INPUT] 0    0    [1    /1   ]  66.7689954757        1
[INPUT] 0    0    [1    /1   ]  30.0273185829        1
[INPUT] 0    0    [1    /1   ]  10.6975067026        1
[INPUT] 1    0    [1    /1   ]  8.6042595977         1
[INPUT] 1    0    [1    /1   ]  0.492746866266       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23857486772863146, 1.0]], [0, [0.6291062820896728, 1.0]], [0, [2.329031020782674, 1.0]], [0, [117616.81031111747, 1.0]], [0, [5.09204564674661, 1.0]], [0, [1176168.1425962583, 1.0]], [0, [588084.0698824945, 1.0]], [0, [294042.0305215055, 1.0]], [0, [147020.98974321102, 1.0]], [0, [73510.41095017611, 1.0]], [0, [36754.667117253026, 1.0]], [0, [7300.1510143489495, 1.0]], [0, [18375.6869888419, 1.0]], [0, [1460.0969550997843, 1.0]], [0, [417.59470380886484, 1.0]], [0, [153.81975757646234, 1.0]], [0, [66.7689954756762, 1.0]], [0, [30.0273185829101, 1.0]], [0, [10.69750670255372, 1.0]], [1, [8.604259597701754, 1.0]], [1, [0.49274686626567493, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23857487]
bas 1, expnt(s) = [0.62910628]
bas 2, expnt(s) = [2.32903102]
bas 3, expnt(s) = [117616.81031112]
bas 4, expnt(s) = [5.09204565]
bas 5, expnt(s) = [1176168.14259626]
bas 6, expnt(s) = [588084.06988249]
bas 7, expnt(s) = [294042.03052151]
bas 8, expnt(s) = [147020.98974321]
bas 9, expnt(s) = [73510.41095018]
bas 10, expnt(s) = [36754.66711725]
bas 11, expnt(s) = [7300.15101435]
bas 12, expnt(s) = [18375.68698884]
bas 13, expnt(s) = [1460.0969551]
bas 14, expnt(s) = [417.59470381]
bas 15, expnt(s) = [153.81975758]
bas 16, expnt(s) = [66.76899548]
bas 17, expnt(s) = [30.02731858]
bas 18, expnt(s) = [10.6975067]
bas 19, expnt(s) = [8.6042596]
bas 20, expnt(s) = [0.49274687]
CPU time:      2073.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38574868e-01 8.62449238e-01 6.29106282e-01 1.78467048e+00
 2.32903102e+00 4.76317435e+00 1.17616810e+05 1.60460105e+04
 5.09204565e+00 8.56414951e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104110e+04 1.12791575e+04
 3.67546671e+04 6.70655352e+03 7.30015101e+03 1.99532621e+03
 1.83756870e+04 3.98747261e+03 1.46009696e+03 5.96762185e+02
 4.17594704e+02 2.33389472e+02 1.53819758e+02 1.10350452e+02
 6.67689955e+01 5.90127911e+01 3.00273186e+01 3.24080155e+01
 1.06975067e+01 1.49443472e+01 8.60425960e+00 4.29908739e+01
 4.92746866e-01 1.20438193e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.336035159410816
cond(S) = 914317.4812144903
E1 = -689.6015322687975  E_coul = 184.97030356973443
init E= -504.631228699063
    CPU time for initialize scf      0.86 sec, wall time      0.07 sec
  HOMO = -0.672202057858425  LUMO = 0.611962046396113
  mo_energy =
[-1.21710138e+02 -1.33864615e+01 -7.62368735e+00 -7.62368735e+00
 -7.62368735e+00 -1.65748145e+00 -6.72202058e-01 -6.72202058e-01
 -6.72202058e-01  6.11962046e-01  6.31465942e+00  2.83732188e+01
  1.02188031e+02  3.24650450e+02  9.78697789e+02  3.25418575e+03
  1.27578752e+04  4.13571818e+04  1.05381501e+05  2.30550962e+05
  4.56355692e+05  8.45300189e+05  1.52846996e+06  2.85072814e+06
  5.80860360e+06]
E1 = -707.7512013129538  E_coul = 199.7781976712942
cycle= 1 E= -507.97300364166  delta_E= -3.34  |g|= 0.452  |ddm|= 0.488
    CPU time for cycle= 1      0.58 sec, wall time      0.03 sec
diis-norm(errvec)=0.763701
diis-c [-0.58323874  1.        ]
  HOMO = -0.217710280648238  LUMO = 0.978074382238088
  mo_energy =
[-1.20200769e+02 -1.23051365e+01 -6.59434377e+00 -6.59434377e+00
 -6.59434377e+00 -1.16331514e+00 -2.17710281e-01 -2.17710281e-01
 -2.17710281e-01  9.78074382e-01  7.01235515e+00  2.93971188e+01
  1.03499976e+02  3.26112045e+02  9.80188976e+02  3.25561741e+03
  1.27592009e+04  4.13584404e+04  1.05382722e+05  2.30552159e+05
  4.56356872e+05  8.45301355e+05  1.52847111e+06  2.85072928e+06
  5.80860473e+06]
E1 = -706.8000074542279  E_coul = 198.80925968422446
cycle= 2 E= -507.990747770003  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.411
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.0329541
diis-c [-1.08581862e-03 -5.18152533e-04  1.00051815e+00]
  HOMO = -0.239741888190555  LUMO = 0.973472453296894
  mo_energy =
[-1.20315112e+02 -1.23724863e+01 -6.66893360e+00 -6.66893360e+00
 -6.66893360e+00 -1.17748449e+00 -2.39741888e-01 -2.39741888e-01
 -2.39741888e-01  9.73472453e-01  6.97832585e+00  2.93343825e+01
  1.03412605e+02  3.26006396e+02  9.80068833e+02  3.25548318e+03
  1.27590565e+04  4.13582921e+04  1.05382572e+05  2.30552009e+05
  4.56356721e+05  8.45301204e+05  1.52847096e+06  2.85072913e+06
  5.80860458e+06]
E1 = -706.6926775193709  E_coul = 198.70167103732092
cycle= 3 E= -507.99100648205  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0597
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00353748
diis-c [-2.83638715e-06  7.84270409e-05 -1.04475149e-01  1.10439672e+00]
  HOMO = -0.242891432330326  LUMO = 0.97258283604537
  mo_energy =
[-1.20326987e+02 -1.23810915e+01 -6.67803476e+00 -6.67803476e+00
 -6.67803476e+00 -1.17939236e+00 -2.42891432e-01 -2.42891432e-01
 -2.42891432e-01  9.72582836e-01  6.97337621e+00  2.93263842e+01
  1.03402581e+02  3.25995107e+02  9.80056699e+02  3.25547033e+03
  1.27590431e+04  4.13582786e+04  1.05382559e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.6774671125586  E_coul = 198.6864556697392
cycle= 4 E= -507.991011442819  delta_E= -4.96e-06  |g|= 0.00023  |ddm|= 0.00982
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165527
diis-c [-3.27602488e-10 -8.25775068e-06  7.03666414e-03 -1.01481604e-01
  1.09445320e+00]
  HOMO = -0.243045133669254  LUMO = 0.972531003163133
  mo_energy =
[-1.20327367e+02 -1.23814528e+01 -6.67839404e+00 -6.67839404e+00
 -6.67839404e+00 -1.17948488e+00 -2.43045134e-01 -2.43045134e-01
 -2.43045134e-01  9.72531003e-01  6.97313431e+00  2.93260496e+01
  1.03402215e+02  3.25994731e+02  9.80056318e+02  3.25546994e+03
  1.27590427e+04  4.13582782e+04  1.05382558e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.6767333013622  E_coul = 198.68572184515597
cycle= 5 E= -507.991011456206  delta_E= -1.34e-08  |g|= 3.55e-06  |ddm|= 0.000587
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.64473e-06
diis-c [-5.02916360e-13  4.36696653e-07 -3.97899931e-04  5.44093654e-03
 -6.27381781e-02  1.05769470e+00]
  HOMO = -0.243046936450547  LUMO = 0.972530500718641
  mo_energy =
[-1.20327372e+02 -1.23814565e+01 -6.67839788e+00 -6.67839788e+00
 -6.67839788e+00 -1.17948614e+00 -2.43046936e-01 -2.43046936e-01
 -2.43046936e-01  9.72530501e-01  6.97313151e+00  2.93260460e+01
  1.03402211e+02  3.25994727e+02  9.80056313e+02  3.25546994e+03
  1.27590427e+04  4.13582782e+04  1.05382558e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.6767242723607  E_coul = 198.68571281615183
cycle= 6 E= -507.991011456209  delta_E= -2.61e-12  |g|= 8.66e-08  |ddm|= 9.02e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767242723607  E_coul = 198.68571281615183
  HOMO = -0.243046976892818  LUMO = 0.972530478237992
  mo_energy =
[-1.20327372e+02 -1.23814566e+01 -6.67839796e+00 -6.67839796e+00
 -6.67839796e+00 -1.17948616e+00 -2.43046977e-01 -2.43046977e-01
 -2.43046977e-01  9.72530478e-01  6.97313144e+00  2.93260459e+01
  1.03402211e+02  3.25994727e+02  9.80056313e+02  3.25546994e+03
  1.27590427e+04  4.13582782e+04  1.05382558e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.676724090374  E_coul = 198.68571263416453
Extra cycle  E= -507.991011456209  delta_E= -6.25e-13  |g|= 1.11e-08  |ddm|= 1.87e-07
    CPU time for scf_cycle      1.62 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 914317.4812144903
E1 = -706.676724090374  E_coul = 198.68571263416453
init E= -507.991011456209
    CPU time for initialize scf      5.73 sec, wall time      0.24 sec
  HOMO = -0.243046982682558  LUMO = 0.972530476789511
  mo_energy =
[-1.20327372e+02 -1.23814566e+01 -6.67839797e+00 -6.67839797e+00
 -6.67839797e+00 -1.17948616e+00 -2.43046983e-01 -2.43046983e-01
 -2.43046983e-01  9.72530477e-01  6.97313143e+00  2.93260459e+01
  1.03402211e+02  3.25994727e+02  9.80056313e+02  3.25546994e+03
  1.27590427e+04  4.13582782e+04  1.05382558e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.6767240614395  E_coul = 198.68571260523052
cycle= 1 E= -507.991011456209  delta_E= 5.12e-13  |g|= 2.57e-09  |ddm|= 2.43e-08
    CPU time for cycle= 1      0.37 sec, wall time      0.03 sec
E1 = -706.6767240614395  E_coul = 198.68571260523052
  HOMO = -0.24304698355554  LUMO = 0.972530476447939
  mo_energy =
[-1.20327372e+02 -1.23814566e+01 -6.67839798e+00 -6.67839798e+00
 -6.67839798e+00 -1.17948617e+00 -2.43046984e-01 -2.43046984e-01
 -2.43046984e-01  9.72530476e-01  6.97313143e+00  2.93260459e+01
  1.03402211e+02  3.25994727e+02  9.80056313e+02  3.25546994e+03
  1.27590427e+04  4.13582782e+04  1.05382558e+05  2.30551995e+05
  4.56356707e+05  8.45301190e+05  1.52847095e+06  2.85072912e+06
  5.80860457e+06]
E1 = -706.6767240562949  E_coul = 198.68571260008642
Extra cycle  E= -507.991011456209  delta_E= 4.55e-13  |g|= 1.2e-09  |ddm|= 3.99e-09
    CPU time for scf_cycle      6.25 sec, wall time      0.41 sec
exp = [2.38574868e-01 6.29106282e-01 2.32903102e+00 1.17616810e+05
 5.09204565e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104110e+04 3.67546671e+04 7.30015101e+03
 1.83756870e+04 1.46009696e+03 4.17594704e+02 1.53819758e+02
 6.67689955e+01 3.00273186e+01 1.06975067e+01 8.60425960e+00
 4.92746866e-01]
grad_E = [ 7.63811448e-04 -3.86346775e-04 -1.84666279e-04  5.13661773e-09
  1.12112536e-04  2.99172284e-11  1.43850862e-10  7.98038388e-10
  3.14201502e-09  1.30914874e-08  6.92185880e-08  4.40379742e-06
  1.60374503e-07 -2.22365030e-05 -5.78458382e-05  1.28020306e-05
  3.42094546e-05  4.04638104e-06 -1.95045117e-05  4.72577513e-06
 -7.13335144e-05]
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:57 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238969551596       1
[INPUT] 0    0    [1    /1   ]  0.630408701853       1
[INPUT] 0    0    [1    /1   ]  2.35869669205        1
[INPUT] 0    0    [1    /1   ]  117616.810291        1
[INPUT] 0    0    [1    /1   ]  5.13616444358        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069882        1
[INPUT] 0    0    [1    /1   ]  294042.030518        1
[INPUT] 0    0    [1    /1   ]  147020.989731        1
[INPUT] 0    0    [1    /1   ]  73510.4108975        1
[INPUT] 0    0    [1    /1   ]  36754.6668422        1
[INPUT] 0    0    [1    /1   ]  7300.13367392        1
[INPUT] 0    0    [1    /1   ]  18375.6863147        1
[INPUT] 0    0    [1    /1   ]  1460.2289877         1
[INPUT] 0    0    [1    /1   ]  417.601411385        1
[INPUT] 0    0    [1    /1   ]  153.851441583        1
[INPUT] 0    0    [1    /1   ]  66.8385341498        1
[INPUT] 0    0    [1    /1   ]  30.0987887735        1
[INPUT] 0    0    [1    /1   ]  10.7626278143        1
[INPUT] 1    0    [1    /1   ]  8.60424964171        1
[INPUT] 1    0    [1    /1   ]  0.492745858099       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23896955159581984, 1.0]], [0, [0.6304087018528475, 1.0]], [0, [2.3586966920470505, 1.0]], [0, [117616.8102905146, 1.0]], [0, [5.136164443584302, 1.0]], [0, [1176168.142596121, 1.0]], [0, [588084.0698819027, 1.0]], [0, [294042.03051830985, 1.0]], [0, [147020.9897305849, 1.0]], [0, [73510.41089745155, 1.0]], [0, [36754.66684223684, 1.0]], [0, [7300.133673924221, 1.0]], [0, [18375.686314671264, 1.0]], [0, [1460.2289876972197, 1.0]], [0, [417.60141138534084, 1.0]], [0, [153.8514415829603, 1.0]], [0, [66.83853414979794, 1.0]], [0, [30.098788773506467, 1.0]], [0, [10.762627814281123, 1.0]], [1, [8.604249641712116, 1.0]], [1, [0.4927458580985347, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23896955]
bas 1, expnt(s) = [0.6304087]
bas 2, expnt(s) = [2.35869669]
bas 3, expnt(s) = [117616.81029051]
bas 4, expnt(s) = [5.13616444]
bas 5, expnt(s) = [1176168.14259612]
bas 6, expnt(s) = [588084.0698819]
bas 7, expnt(s) = [294042.03051831]
bas 8, expnt(s) = [147020.98973058]
bas 9, expnt(s) = [73510.41089745]
bas 10, expnt(s) = [36754.66684224]
bas 11, expnt(s) = [7300.13367392]
bas 12, expnt(s) = [18375.68631467]
bas 13, expnt(s) = [1460.2289877]
bas 14, expnt(s) = [417.60141139]
bas 15, expnt(s) = [153.85144158]
bas 16, expnt(s) = [66.83853415]
bas 17, expnt(s) = [30.09878877]
bas 18, expnt(s) = [10.76262781]
bas 19, expnt(s) = [8.60424964]
bas 20, expnt(s) = [0.49274586]
CPU time:      2088.77
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38969552e-01 8.63519105e-01 6.30408702e-01 1.78744083e+00
 2.35869669e+00 4.80860493e+00 1.17616810e+05 1.60460105e+04
 5.13616444e+00 8.61974095e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104109e+04 1.12791575e+04
 3.67546668e+04 6.70655348e+03 7.30013367e+03 1.99532266e+03
 1.83756863e+04 3.98747250e+03 1.46022899e+03 5.96802658e+02
 4.17601411e+02 2.33392283e+02 1.53851442e+02 1.10367499e+02
 6.68385341e+01 5.90588807e+01 3.00987888e+01 3.24658508e+01
 1.07626278e+01 1.50125258e+01 8.60424964e+00 4.29908118e+01
 4.92745858e-01 1.20437885e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33603496723559
cond(S) = 914346.6863166527
E1 = -689.6017403545643  E_coul = 184.97029391979837
init E= -504.631446434766
    CPU time for initialize scf      0.69 sec, wall time      0.07 sec
  HOMO = -0.672198622994737  LUMO = 0.615301447880044
  mo_energy =
[-1.21710146e+02 -1.33864644e+01 -7.62368848e+00 -7.62368848e+00
 -7.62368848e+00 -1.65748282e+00 -6.72198623e-01 -6.72198623e-01
 -6.72198623e-01  6.15301448e-01  6.39218130e+00  2.86818099e+01
  1.02830054e+02  3.25594123e+02  9.79830207e+02  3.25545721e+03
  1.27592918e+04  4.13585918e+04  1.05382867e+05  2.30552291e+05
  4.56356992e+05  8.45301468e+05  1.52847121e+06  2.85072937e+06
  5.80860480e+06]
E1 = -707.7512142415549  E_coul = 199.7782096557514
cycle= 1 E= -507.973004585803  delta_E= -3.34  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.64 sec, wall time      0.03 sec
diis-norm(errvec)=0.76376
diis-c [-0.5833297  1.       ]
  HOMO = -0.21771246927175  LUMO = 0.982313109305018
  mo_energy =
[-1.20200765e+02 -1.23051341e+01 -6.59434018e+00 -6.59434018e+00
 -6.59434018e+00 -1.16331980e+00 -2.17712469e-01 -2.17712469e-01
 -2.17712469e-01  9.82313109e-01  7.09323736e+00  2.97080253e+01
  1.04142580e+02  3.27055749e+02  9.81321383e+02  3.25688888e+03
  1.27606175e+04  4.13598504e+04  1.05384089e+05  2.30553488e+05
  4.56358172e+05  8.45302634e+05  1.52847237e+06  2.85073051e+06
  5.80860593e+06]
E1 = -706.8000286834371  E_coul = 198.80927967099973
cycle= 2 E= -507.990749012437  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.411
    CPU time for cycle= 2      0.06 sec, wall time      0.03 sec
diis-norm(errvec)=0.032881
diis-c [-1.08103886e-03 -4.50527330e-04  1.00045053e+00]
  HOMO = -0.23974644173603  LUMO = 0.977665174814592
  mo_energy =
[-1.20315093e+02 -1.23724781e+01 -6.66892189e+00 -6.66892189e+00
 -6.66892189e+00 -1.17749122e+00 -2.39746442e-01 -2.39746442e-01
 -2.39746442e-01  9.77665175e-01  7.05892830e+00  2.96450982e+01
  1.04055156e+02  3.26950105e+02  9.81201258e+02  3.25675467e+03
  1.27604731e+04  4.13597021e+04  1.05383939e+05  2.30553337e+05
  4.56358021e+05  8.45302483e+05  1.52847222e+06  2.85073036e+06
  5.80860578e+06]
E1 = -706.6927201111739  E_coul = 198.70171249058956
cycle= 3 E= -507.991007620584  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0596
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00352495
diis-c [-2.81954732e-06  7.88059326e-05 -1.04300339e-01  1.10422153e+00]
  HOMO = -0.242895903672365  LUMO = 0.976768873892229
  mo_energy =
[-1.20326972e+02 -1.23810849e+01 -6.67802504e+00 -6.67802504e+00
 -6.67802504e+00 -1.17939903e+00 -2.42895904e-01 -2.42895904e-01
 -2.42895904e-01  9.76768874e-01  7.05394387e+00  2.96370798e+01
  1.04045124e+02  3.26938812e+02  9.81189121e+02  3.25674181e+03
  1.27604597e+04  4.13596886e+04  1.05383925e+05  2.30553324e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6775165959112  E_coul = 198.68650402263896
cycle= 4 E= -507.991012573272  delta_E= -4.95e-06  |g|= 0.00023  |ddm|= 0.00978
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165191
diis-c [-3.18360176e-10 -8.21819423e-06  7.03620947e-03 -1.01620242e-01
  1.09459225e+00]
  HOMO = -0.243049831942521  LUMO = 0.97671670466876
  mo_energy =
[-1.20327354e+02 -1.23814475e+01 -6.67838568e+00 -6.67838568e+00
 -6.67838568e+00 -1.17949165e+00 -2.43049832e-01 -2.43049832e-01
 -2.43049832e-01  9.76716705e-01  7.05370016e+00  2.96367436e+01
  1.04044757e+02  3.26938434e+02  9.81188737e+02  3.25674143e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767820810257  E_coul = 198.68576949440964
cycle= 5 E= -507.991012586616  delta_E= -1.33e-08  |g|= 3.45e-06  |ddm|= 0.000583
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.60152e-06
diis-c [-4.85127977e-13  4.26386584e-07 -3.88431878e-04  5.31666723e-03
 -6.12242769e-02  1.05629562e+00]
  HOMO = -0.243051590184924  LUMO = 0.976716215707292
  mo_energy =
[-1.20327358e+02 -1.23814511e+01 -6.67838943e+00 -6.67838943e+00
 -6.67838943e+00 -1.17949289e+00 -2.43051590e-01 -2.43051590e-01
 -2.43051590e-01  9.76716216e-01  7.05369741e+00  2.96367401e+01
  1.04044753e+02  3.26938430e+02  9.81188733e+02  3.25674142e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767732767966  E_coul = 198.68576069017837
cycle= 6 E= -507.991012586618  delta_E= -2.1e-12  |g|= 8.56e-08  |ddm|= 8.7e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767732767966  E_coul = 198.68576069017837
  HOMO = -0.243051630441929  LUMO = 0.976716195332942
  mo_energy =
[-1.20327358e+02 -1.23814512e+01 -6.67838951e+00 -6.67838951e+00
 -6.67838951e+00 -1.17949291e+00 -2.43051630e-01 -2.43051630e-01
 -2.43051630e-01  9.76716195e-01  7.05369734e+00  2.96367400e+01
  1.04044753e+02  3.26938430e+02  9.81188733e+02  3.25674142e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767730908487  E_coul = 198.68576050423053
Extra cycle  E= -507.991012586618  delta_E= 5.68e-14  |g|= 9.65e-09  |ddm|= 1.87e-07
    CPU time for scf_cycle      1.55 sec, wall time      0.29 sec
exp = [2.38969552e-01 6.30408702e-01 2.35869669e+00 1.17616810e+05
 5.13616444e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104109e+04 3.67546668e+04 7.30013367e+03
 1.83756863e+04 1.46022899e+03 4.17601411e+02 1.53851442e+02
 6.68385341e+01 3.00987888e+01 1.07626278e+01 8.60424964e+00
 4.92745858e-01]
E = -507.9910125866181
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:40:58 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238969551596       1
[INPUT] 0    0    [1    /1   ]  0.630408701853       1
[INPUT] 0    0    [1    /1   ]  2.35869669205        1
[INPUT] 0    0    [1    /1   ]  117616.810291        1
[INPUT] 0    0    [1    /1   ]  5.13616444358        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069882        1
[INPUT] 0    0    [1    /1   ]  294042.030518        1
[INPUT] 0    0    [1    /1   ]  147020.989731        1
[INPUT] 0    0    [1    /1   ]  73510.4108975        1
[INPUT] 0    0    [1    /1   ]  36754.6668422        1
[INPUT] 0    0    [1    /1   ]  7300.13367392        1
[INPUT] 0    0    [1    /1   ]  18375.6863147        1
[INPUT] 0    0    [1    /1   ]  1460.2289877         1
[INPUT] 0    0    [1    /1   ]  417.601411385        1
[INPUT] 0    0    [1    /1   ]  153.851441583        1
[INPUT] 0    0    [1    /1   ]  66.8385341498        1
[INPUT] 0    0    [1    /1   ]  30.0987887735        1
[INPUT] 0    0    [1    /1   ]  10.7626278143        1
[INPUT] 1    0    [1    /1   ]  8.60424964171        1
[INPUT] 1    0    [1    /1   ]  0.492745858099       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23896955159581984, 1.0]], [0, [0.6304087018528475, 1.0]], [0, [2.3586966920470505, 1.0]], [0, [117616.8102905146, 1.0]], [0, [5.136164443584302, 1.0]], [0, [1176168.142596121, 1.0]], [0, [588084.0698819027, 1.0]], [0, [294042.03051830985, 1.0]], [0, [147020.9897305849, 1.0]], [0, [73510.41089745155, 1.0]], [0, [36754.66684223684, 1.0]], [0, [7300.133673924221, 1.0]], [0, [18375.686314671264, 1.0]], [0, [1460.2289876972197, 1.0]], [0, [417.60141138534084, 1.0]], [0, [153.8514415829603, 1.0]], [0, [66.83853414979794, 1.0]], [0, [30.098788773506467, 1.0]], [0, [10.762627814281123, 1.0]], [1, [8.604249641712116, 1.0]], [1, [0.4927458580985347, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23896955]
bas 1, expnt(s) = [0.6304087]
bas 2, expnt(s) = [2.35869669]
bas 3, expnt(s) = [117616.81029051]
bas 4, expnt(s) = [5.13616444]
bas 5, expnt(s) = [1176168.14259612]
bas 6, expnt(s) = [588084.0698819]
bas 7, expnt(s) = [294042.03051831]
bas 8, expnt(s) = [147020.98973058]
bas 9, expnt(s) = [73510.41089745]
bas 10, expnt(s) = [36754.66684224]
bas 11, expnt(s) = [7300.13367392]
bas 12, expnt(s) = [18375.68631467]
bas 13, expnt(s) = [1460.2289877]
bas 14, expnt(s) = [417.60141139]
bas 15, expnt(s) = [153.85144158]
bas 16, expnt(s) = [66.83853415]
bas 17, expnt(s) = [30.09878877]
bas 18, expnt(s) = [10.76262781]
bas 19, expnt(s) = [8.60424964]
bas 20, expnt(s) = [0.49274586]
CPU time:      2090.93
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38969552e-01 8.63519105e-01 6.30408702e-01 1.78744083e+00
 2.35869669e+00 4.80860493e+00 1.17616810e+05 1.60460105e+04
 5.13616444e+00 8.61974095e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104109e+04 1.12791575e+04
 3.67546668e+04 6.70655348e+03 7.30013367e+03 1.99532266e+03
 1.83756863e+04 3.98747250e+03 1.46022899e+03 5.96802658e+02
 4.17601411e+02 2.33392283e+02 1.53851442e+02 1.10367499e+02
 6.68385341e+01 5.90588807e+01 3.00987888e+01 3.24658508e+01
 1.07626278e+01 1.50125258e+01 8.60424964e+00 4.29908118e+01
 4.92745858e-01 1.20437885e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33603496723559
cond(S) = 914346.6863166527
E1 = -689.6017403545643  E_coul = 184.97029391979837
init E= -504.631446434766
    CPU time for initialize scf      0.68 sec, wall time      0.07 sec
  HOMO = -0.672198622994737  LUMO = 0.615301447880044
  mo_energy =
[-1.21710146e+02 -1.33864644e+01 -7.62368848e+00 -7.62368848e+00
 -7.62368848e+00 -1.65748282e+00 -6.72198623e-01 -6.72198623e-01
 -6.72198623e-01  6.15301448e-01  6.39218130e+00  2.86818099e+01
  1.02830054e+02  3.25594123e+02  9.79830207e+02  3.25545721e+03
  1.27592918e+04  4.13585918e+04  1.05382867e+05  2.30552291e+05
  4.56356992e+05  8.45301468e+05  1.52847121e+06  2.85072937e+06
  5.80860480e+06]
E1 = -707.7512142415549  E_coul = 199.7782096557514
cycle= 1 E= -507.973004585803  delta_E= -3.34  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.63 sec, wall time      0.03 sec
diis-norm(errvec)=0.76376
diis-c [-0.5833297  1.       ]
  HOMO = -0.21771246927175  LUMO = 0.982313109305018
  mo_energy =
[-1.20200765e+02 -1.23051341e+01 -6.59434018e+00 -6.59434018e+00
 -6.59434018e+00 -1.16331980e+00 -2.17712469e-01 -2.17712469e-01
 -2.17712469e-01  9.82313109e-01  7.09323736e+00  2.97080253e+01
  1.04142580e+02  3.27055749e+02  9.81321383e+02  3.25688888e+03
  1.27606175e+04  4.13598504e+04  1.05384089e+05  2.30553488e+05
  4.56358172e+05  8.45302634e+05  1.52847237e+06  2.85073051e+06
  5.80860593e+06]
E1 = -706.8000286834371  E_coul = 198.80927967099973
cycle= 2 E= -507.990749012437  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.411
    CPU time for cycle= 2      0.07 sec, wall time      0.03 sec
diis-norm(errvec)=0.032881
diis-c [-1.08103886e-03 -4.50527330e-04  1.00045053e+00]
  HOMO = -0.23974644173603  LUMO = 0.977665174814592
  mo_energy =
[-1.20315093e+02 -1.23724781e+01 -6.66892189e+00 -6.66892189e+00
 -6.66892189e+00 -1.17749122e+00 -2.39746442e-01 -2.39746442e-01
 -2.39746442e-01  9.77665175e-01  7.05892830e+00  2.96450982e+01
  1.04055156e+02  3.26950105e+02  9.81201258e+02  3.25675467e+03
  1.27604731e+04  4.13597021e+04  1.05383939e+05  2.30553337e+05
  4.56358021e+05  8.45302483e+05  1.52847222e+06  2.85073036e+06
  5.80860578e+06]
E1 = -706.6927201111739  E_coul = 198.70171249058956
cycle= 3 E= -507.991007620584  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0596
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00352495
diis-c [-2.81954732e-06  7.88059326e-05 -1.04300339e-01  1.10422153e+00]
  HOMO = -0.242895903672365  LUMO = 0.976768873892229
  mo_energy =
[-1.20326972e+02 -1.23810849e+01 -6.67802504e+00 -6.67802504e+00
 -6.67802504e+00 -1.17939903e+00 -2.42895904e-01 -2.42895904e-01
 -2.42895904e-01  9.76768874e-01  7.05394387e+00  2.96370798e+01
  1.04045124e+02  3.26938812e+02  9.81189121e+02  3.25674181e+03
  1.27604597e+04  4.13596886e+04  1.05383925e+05  2.30553324e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6775165959112  E_coul = 198.68650402263896
cycle= 4 E= -507.991012573272  delta_E= -4.95e-06  |g|= 0.00023  |ddm|= 0.00978
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165191
diis-c [-3.18360176e-10 -8.21819423e-06  7.03620947e-03 -1.01620242e-01
  1.09459225e+00]
  HOMO = -0.243049831942521  LUMO = 0.97671670466876
  mo_energy =
[-1.20327354e+02 -1.23814475e+01 -6.67838568e+00 -6.67838568e+00
 -6.67838568e+00 -1.17949165e+00 -2.43049832e-01 -2.43049832e-01
 -2.43049832e-01  9.76716705e-01  7.05370016e+00  2.96367436e+01
  1.04044757e+02  3.26938434e+02  9.81188737e+02  3.25674143e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767820810257  E_coul = 198.68576949440964
cycle= 5 E= -507.991012586616  delta_E= -1.33e-08  |g|= 3.45e-06  |ddm|= 0.000583
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.60152e-06
diis-c [-4.85127977e-13  4.26386584e-07 -3.88431878e-04  5.31666723e-03
 -6.12242769e-02  1.05629562e+00]
  HOMO = -0.243051590184924  LUMO = 0.976716215707292
  mo_energy =
[-1.20327358e+02 -1.23814511e+01 -6.67838943e+00 -6.67838943e+00
 -6.67838943e+00 -1.17949289e+00 -2.43051590e-01 -2.43051590e-01
 -2.43051590e-01  9.76716216e-01  7.05369741e+00  2.96367401e+01
  1.04044753e+02  3.26938430e+02  9.81188733e+02  3.25674142e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767732767966  E_coul = 198.68576069017837
cycle= 6 E= -507.991012586618  delta_E= -2.1e-12  |g|= 8.56e-08  |ddm|= 8.7e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767732767966  E_coul = 198.68576069017837
  HOMO = -0.243051630441929  LUMO = 0.976716195332942
  mo_energy =
[-1.20327358e+02 -1.23814512e+01 -6.67838951e+00 -6.67838951e+00
 -6.67838951e+00 -1.17949291e+00 -2.43051630e-01 -2.43051630e-01
 -2.43051630e-01  9.76716195e-01  7.05369734e+00  2.96367400e+01
  1.04044753e+02  3.26938430e+02  9.81188733e+02  3.25674142e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767730908487  E_coul = 198.68576050423053
Extra cycle  E= -507.991012586618  delta_E= 5.68e-14  |g|= 9.65e-09  |ddm|= 1.87e-07
    CPU time for scf_cycle      1.54 sec, wall time      0.29 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 914346.6863166527
E1 = -706.6767730908487  E_coul = 198.68576050423053
init E= -507.991012586618
    CPU time for initialize scf      5.69 sec, wall time      0.24 sec
  HOMO = -0.243051636328421  LUMO = 0.976716191688112
  mo_energy =
[-1.20327358e+02 -1.23814512e+01 -6.67838953e+00 -6.67838953e+00
 -6.67838953e+00 -1.17949291e+00 -2.43051636e-01 -2.43051636e-01
 -2.43051636e-01  9.76716192e-01  7.05369734e+00  2.96367400e+01
  1.04044753e+02  3.26938430e+02  9.81188733e+02  3.25674142e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767730660915  E_coul = 198.68576047947323
cycle= 1 E= -507.991012586618  delta_E= -1.71e-13  |g|= 1.68e-09  |ddm|= 2.17e-08
    CPU time for cycle= 1      0.36 sec, wall time      0.03 sec
E1 = -706.6767730660915  E_coul = 198.68576047947323
  HOMO = -0.243051637088151  LUMO = 0.976716192227437
  mo_energy =
[-1.20327358e+02 -1.23814512e+01 -6.67838953e+00 -6.67838953e+00
 -6.67838953e+00 -1.17949291e+00 -2.43051637e-01 -2.43051637e-01
 -2.43051637e-01  9.76716192e-01  7.05369733e+00  2.96367400e+01
  1.04044753e+02  3.26938430e+02  9.81188733e+02  3.25674142e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.676773060186  E_coul = 198.6857604735676
Extra cycle  E= -507.991012586618  delta_E= -5.68e-14  |g|= 1.61e-09  |ddm|= 4.28e-09
    CPU time for scf_cycle      6.19 sec, wall time      0.41 sec
exp = [2.38969552e-01 6.30408702e-01 2.35869669e+00 1.17616810e+05
 5.13616444e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104109e+04 3.67546668e+04 7.30013367e+03
 1.83756863e+04 1.46022899e+03 4.17601411e+02 1.53851442e+02
 6.68385341e+01 3.00987888e+01 1.07626278e+01 8.60424964e+00
 4.92745858e-01]
grad_E = [ 1.56613880e-05 -1.74145815e-05  6.77892361e-06  5.12985578e-09
  8.80551379e-06  2.98393899e-11  1.43629942e-10  7.96997057e-10
  3.13783011e-09  1.30738138e-08  6.91328523e-08  4.39861504e-06
  1.60100099e-07 -2.21109797e-05 -5.84100251e-05  1.42424547e-05
  3.04315775e-05  1.00020381e-05 -5.10795380e-06  3.69197681e-06
  4.36669791e-06]
 message: Iteration limit reached
 success: False
  status: 9
     fun: -507.9910125866181
       x: [ 2.390e-01  6.304e-01 ...  8.604e+00  4.927e-01]
     nit: 100
     jac: [ 1.566e-05 -1.741e-05 ...  3.692e-06  4.367e-06]
    nfev: 106
    njev: 100
#INFO: **** input file is /home/nike/basis-set-optimization/018_Ar/input.py ****
#!/usr/bin/env python

import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ar  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ar 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ar': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exps = np.zeros((21, 2))
#exps[:, 0] = decaying_nums(5)
exps_old = np.array([2.4939369593029800e-01,6.4965930406921546e-01,1.1761681288988463e+05,3.0340079600687115e+00,1.1761681426134550e+06,5.8808406995657098e+05,2.9404203092149430e+05,1.4702099132355020e+05,7.3510417549359685e+04,3.6754701541204631e+04,7.3023218969695617e+03,1.8375771355655528e+04,1.4435257178422494e+03,4.1736195585201131e+02,1.4778394782889714e+02,5.8452975712341704e+01,2.4557639103353178e+01,7.5771495121088490e+00,8.6041045003554437e+00,4.9269916590491081e-01])
exps[1:, 0] = exps_old[:]
#exps[0, 0] = np.max(exps_old) * 2
exps[0, 0] = np.min(exps_old) * 0.1

basis = "19s2p"

minimize_energy(basis, exps)


#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='bc12048.int.ets1.calculquebec.ca', release='3.10.0-1160.76.1.el7.x86_64', version='#1 SMP Wed Aug 10 16:21:17 UTC 2022', machine='x86_64')  Threads 24
Python 3.10.2 (main, Feb  4 2022, 19:11:32) [GCC 9.3.0]
numpy 1.24.2  scipy 1.10.1
Date: Fri Mar 17 02:41:05 2023
PySCF version 2.1.1+ad
PySCF path  /localscratch/nike.35635013.0/ENV/lib/python3.10/site-packages/pyscf

[ENV] PYSCF_MAX_MEMORY 32000
[ENV] PYSCF_CONFIG_FILE /home/nike/.pyscfad_conf.py
[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 32000
[CONFIG] TMPDIR = /tmp
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /home/nike/.pyscfad_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 32000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 18
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ar     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ar
[INPUT] 0    0    [1    /1   ]  0.238969551596       1
[INPUT] 0    0    [1    /1   ]  0.630408701853       1
[INPUT] 0    0    [1    /1   ]  2.35869669205        1
[INPUT] 0    0    [1    /1   ]  117616.810291        1
[INPUT] 0    0    [1    /1   ]  5.13616444358        1
[INPUT] 0    0    [1    /1   ]  1176168.1426         1
[INPUT] 0    0    [1    /1   ]  588084.069882        1
[INPUT] 0    0    [1    /1   ]  294042.030518        1
[INPUT] 0    0    [1    /1   ]  147020.989731        1
[INPUT] 0    0    [1    /1   ]  73510.4108975        1
[INPUT] 0    0    [1    /1   ]  36754.6668422        1
[INPUT] 0    0    [1    /1   ]  7300.13367392        1
[INPUT] 0    0    [1    /1   ]  18375.6863147        1
[INPUT] 0    0    [1    /1   ]  1460.2289877         1
[INPUT] 0    0    [1    /1   ]  417.601411385        1
[INPUT] 0    0    [1    /1   ]  153.851441583        1
[INPUT] 0    0    [1    /1   ]  66.8385341498        1
[INPUT] 0    0    [1    /1   ]  30.0987887735        1
[INPUT] 0    0    [1    /1   ]  10.7626278143        1
[INPUT] 1    0    [1    /1   ]  8.60424964171        1
[INPUT] 1    0    [1    /1   ]  0.492745858099       1

nuclear repulsion = 0
number of shells = 21
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ar': [[0, [0.23896955159581984, 1.0]], [0, [0.6304087018528475, 1.0]], [0, [2.3586966920470505, 1.0]], [0, [117616.8102905146, 1.0]], [0, [5.136164443584302, 1.0]], [0, [1176168.142596121, 1.0]], [0, [588084.0698819027, 1.0]], [0, [294042.03051830985, 1.0]], [0, [147020.9897305849, 1.0]], [0, [73510.41089745155, 1.0]], [0, [36754.66684223684, 1.0]], [0, [7300.133673924221, 1.0]], [0, [18375.686314671264, 1.0]], [0, [1460.2289876972197, 1.0]], [0, [417.60141138534084, 1.0]], [0, [153.8514415829603, 1.0]], [0, [66.83853414979794, 1.0]], [0, [30.098788773506467, 1.0]], [0, [10.762627814281123, 1.0]], [1, [8.604249641712116, 1.0]], [1, [0.4927458580985347, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.23896955]
bas 1, expnt(s) = [0.6304087]
bas 2, expnt(s) = [2.35869669]
bas 3, expnt(s) = [117616.81029051]
bas 4, expnt(s) = [5.13616444]
bas 5, expnt(s) = [1176168.14259612]
bas 6, expnt(s) = [588084.0698819]
bas 7, expnt(s) = [294042.03051831]
bas 8, expnt(s) = [147020.98973058]
bas 9, expnt(s) = [73510.41089745]
bas 10, expnt(s) = [36754.66684224]
bas 11, expnt(s) = [7300.13367392]
bas 12, expnt(s) = [18375.68631467]
bas 13, expnt(s) = [1460.2289877]
bas 14, expnt(s) = [417.60141139]
bas 15, expnt(s) = [153.85144158]
bas 16, expnt(s) = [66.83853415]
bas 17, expnt(s) = [30.09878877]
bas 18, expnt(s) = [10.76262781]
bas 19, expnt(s) = [8.60424964]
bas 20, expnt(s) = [0.49274586]
CPU time:      2106.00
arg.atm = [[18 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  0  1  1  0 46 47  0]
 [ 0  0  1  1  0 48 49  0]
 [ 0  0  1  1  0 50 51  0]
 [ 0  0  1  1  0 52 53  0]
 [ 0  0  1  1  0 54 55  0]
 [ 0  0  1  1  0 56 57  0]
 [ 0  0  1  1  0 58 59  0]
 [ 0  0  1  1  0 60 61  0]
 [ 0  1  1  1  0 62 63  0]
 [ 0  1  1  1  0 64 65  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38969552e-01 8.63519105e-01 6.30408702e-01 1.78744083e+00
 2.35869669e+00 4.80860493e+00 1.17616810e+05 1.60460105e+04
 5.13616444e+00 8.61974095e+00 1.17616814e+06 9.02333504e+04
 5.88084070e+05 5.36530711e+04 2.94042031e+05 3.19023066e+04
 1.47020990e+05 1.89692225e+04 7.35104109e+04 1.12791575e+04
 3.67546668e+04 6.70655348e+03 7.30013367e+03 1.99532266e+03
 1.83756863e+04 3.98747250e+03 1.46022899e+03 5.96802658e+02
 4.17601411e+02 2.33392283e+02 1.53851442e+02 1.10367499e+02
 6.68385341e+01 5.90588807e+01 3.00987888e+01 3.24658508e+01
 1.07626278e+01 1.50125258e+01 8.60424964e+00 4.29908118e+01
 4.92745858e-01 1.20437885e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 17.33603496723559
cond(S) = 914346.6863166527
E1 = -689.6017403545643  E_coul = 184.97029391979837
init E= -504.631446434766
    CPU time for initialize scf      0.72 sec, wall time      0.07 sec
  HOMO = -0.672198622994737  LUMO = 0.615301447880044
  mo_energy =
[-1.21710146e+02 -1.33864644e+01 -7.62368848e+00 -7.62368848e+00
 -7.62368848e+00 -1.65748282e+00 -6.72198623e-01 -6.72198623e-01
 -6.72198623e-01  6.15301448e-01  6.39218130e+00  2.86818099e+01
  1.02830054e+02  3.25594123e+02  9.79830207e+02  3.25545721e+03
  1.27592918e+04  4.13585918e+04  1.05382867e+05  2.30552291e+05
  4.56356992e+05  8.45301468e+05  1.52847121e+06  2.85072937e+06
  5.80860480e+06]
E1 = -707.7512142415549  E_coul = 199.7782096557514
cycle= 1 E= -507.973004585803  delta_E= -3.34  |g|= 0.452  |ddm|= 0.487
    CPU time for cycle= 1      0.65 sec, wall time      0.03 sec
diis-norm(errvec)=0.76376
diis-c [-0.5833297  1.       ]
  HOMO = -0.21771246927175  LUMO = 0.982313109305018
  mo_energy =
[-1.20200765e+02 -1.23051341e+01 -6.59434018e+00 -6.59434018e+00
 -6.59434018e+00 -1.16331980e+00 -2.17712469e-01 -2.17712469e-01
 -2.17712469e-01  9.82313109e-01  7.09323736e+00  2.97080253e+01
  1.04142580e+02  3.27055749e+02  9.81321383e+02  3.25688888e+03
  1.27606175e+04  4.13598504e+04  1.05384089e+05  2.30553488e+05
  4.56358172e+05  8.45302634e+05  1.52847237e+06  2.85073051e+06
  5.80860593e+06]
E1 = -706.8000286834371  E_coul = 198.80927967099973
cycle= 2 E= -507.990749012437  delta_E= -0.0177  |g|= 0.035  |ddm|= 0.411
    CPU time for cycle= 2      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.032881
diis-c [-1.08103886e-03 -4.50527330e-04  1.00045053e+00]
  HOMO = -0.23974644173603  LUMO = 0.977665174814592
  mo_energy =
[-1.20315093e+02 -1.23724781e+01 -6.66892189e+00 -6.66892189e+00
 -6.66892189e+00 -1.17749122e+00 -2.39746442e-01 -2.39746442e-01
 -2.39746442e-01  9.77665175e-01  7.05892830e+00  2.96450982e+01
  1.04055156e+02  3.26950105e+02  9.81201258e+02  3.25675467e+03
  1.27604731e+04  4.13597021e+04  1.05383939e+05  2.30553337e+05
  4.56358021e+05  8.45302483e+05  1.52847222e+06  2.85073036e+06
  5.80860578e+06]
E1 = -706.6927201111739  E_coul = 198.70171249058956
cycle= 3 E= -507.991007620584  delta_E= -0.000259  |g|= 0.00438  |ddm|= 0.0596
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00352495
diis-c [-2.81954732e-06  7.88059326e-05 -1.04300339e-01  1.10422153e+00]
  HOMO = -0.242895903672365  LUMO = 0.976768873892229
  mo_energy =
[-1.20326972e+02 -1.23810849e+01 -6.67802504e+00 -6.67802504e+00
 -6.67802504e+00 -1.17939903e+00 -2.42895904e-01 -2.42895904e-01
 -2.42895904e-01  9.76768874e-01  7.05394387e+00  2.96370798e+01
  1.04045124e+02  3.26938812e+02  9.81189121e+02  3.25674181e+03
  1.27604597e+04  4.13596886e+04  1.05383925e+05  2.30553324e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6775165959112  E_coul = 198.68650402263896
cycle= 4 E= -507.991012573272  delta_E= -4.95e-06  |g|= 0.00023  |ddm|= 0.00978
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000165191
diis-c [-3.18360176e-10 -8.21819423e-06  7.03620947e-03 -1.01620242e-01
  1.09459225e+00]
  HOMO = -0.243049831942521  LUMO = 0.97671670466876
  mo_energy =
[-1.20327354e+02 -1.23814475e+01 -6.67838568e+00 -6.67838568e+00
 -6.67838568e+00 -1.17949165e+00 -2.43049832e-01 -2.43049832e-01
 -2.43049832e-01  9.76716705e-01  7.05370016e+00  2.96367436e+01
  1.04044757e+02  3.26938434e+02  9.81188737e+02  3.25674143e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767820810257  E_coul = 198.68576949440964
cycle= 5 E= -507.991012586616  delta_E= -1.33e-08  |g|= 3.45e-06  |ddm|= 0.000583
    CPU time for cycle= 5      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=1.60152e-06
diis-c [-4.85127977e-13  4.26386584e-07 -3.88431878e-04  5.31666723e-03
 -6.12242769e-02  1.05629562e+00]
  HOMO = -0.243051590184924  LUMO = 0.976716215707292
  mo_energy =
[-1.20327358e+02 -1.23814511e+01 -6.67838943e+00 -6.67838943e+00
 -6.67838943e+00 -1.17949289e+00 -2.43051590e-01 -2.43051590e-01
 -2.43051590e-01  9.76716216e-01  7.05369741e+00  2.96367401e+01
  1.04044753e+02  3.26938430e+02  9.81188733e+02  3.25674142e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767732767966  E_coul = 198.68576069017837
cycle= 6 E= -507.991012586618  delta_E= -2.1e-12  |g|= 8.56e-08  |ddm|= 8.7e-06
    CPU time for cycle= 6      0.03 sec, wall time      0.03 sec
E1 = -706.6767732767966  E_coul = 198.68576069017837
  HOMO = -0.243051630441929  LUMO = 0.976716195332942
  mo_energy =
[-1.20327358e+02 -1.23814512e+01 -6.67838951e+00 -6.67838951e+00
 -6.67838951e+00 -1.17949291e+00 -2.43051630e-01 -2.43051630e-01
 -2.43051630e-01  9.76716195e-01  7.05369734e+00  2.96367400e+01
  1.04044753e+02  3.26938430e+02  9.81188733e+02  3.25674142e+03
  1.27604593e+04  4.13596882e+04  1.05383925e+05  2.30553323e+05
  4.56358007e+05  8.45302469e+05  1.52847220e+06  2.85073035e+06
  5.80860577e+06]
E1 = -706.6767730908487  E_coul = 198.68576050423053
Extra cycle  E= -507.991012586618  delta_E= 5.68e-14  |g|= 9.65e-09  |ddm|= 1.87e-07
    CPU time for scf_cycle      1.57 sec, wall time      0.29 sec
exp = [2.38969552e-01 6.30408702e-01 2.35869669e+00 1.17616810e+05
 5.13616444e+00 1.17616814e+06 5.88084070e+05 2.94042031e+05
 1.47020990e+05 7.35104109e+04 3.67546668e+04 7.30013367e+03
 1.83756863e+04 1.46022899e+03 4.17601411e+02 1.53851442e+02
 6.68385341e+01 3.00987888e+01 1.07626278e+01 8.60424964e+00
 4.92745858e-01]
E = -507.9910125866181
E = -507.9910125866181
exp = [2.3896955159581984e-01,6.3040870185284748e-01,2.3586966920470505e+00,1.1761681029051459e+05,5.1361644435843017e+00,1.1761681425961209e+06,5.8808406988190266e+05,2.9404203051830985e+05,1.4702098973058490e+05,7.3510410897451555e+04,3.6754666842236838e+04,7.3001336739242206e+03,1.8375686314671264e+04,1.4602289876972197e+03,4.1760141138534084e+02,1.5385144158296029e+02,6.6838534149797937e+01,3.0098788773506467e+01,1.0762627814281123e+01,8.6042496417121157e+00,4.9274585809853472e-01]
